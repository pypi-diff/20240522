# Comparing `tmp/batorch-1.0.53.tar.gz` & `tmp/batorch-1.0.54.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "batorch-1.0.53.tar", last modified: Sun Mar 31 01:38:48 2024, max compression
+gzip compressed data, was "batorch-1.0.54.tar", last modified: Wed May 22 09:35:24 2024, max compression
```

## Comparing `batorch-1.0.53.tar` & `batorch-1.0.54.tar`

### file list

```diff
@@ -1,41 +1,41 @@
-drwxr-xr-x   0 admin      (501) staff       (20)        0 2024-03-31 01:38:48.723554 batorch-1.0.53/
--rw-r--r--   0 admin      (501) staff       (20)       99 2024-03-31 01:38:48.000000 batorch-1.0.53/MANIFEST.in
--rw-r--r--   0 admin      (501) staff       (20)      378 2024-03-31 01:38:48.723340 batorch-1.0.53/PKG-INFO
--rw-r--r--   0 admin      (501) staff       (20)     3509 2024-03-31 01:38:48.000000 batorch-1.0.53/README.md
-drwxr-xr-x   0 admin      (501) staff       (20)        0 2024-03-31 01:38:48.708809 batorch-1.0.53/batorch/
--rw-r--r--   0 admin      (501) staff       (20)     3873 2024-03-31 01:38:48.000000 batorch-1.0.53/batorch/__init__.py
--rw-r--r--   0 admin      (501) staff       (20)     7923 2024-03-31 01:38:48.000000 batorch-1.0.53/batorch/device.py
--rw-r--r--   0 admin      (501) staff       (20)    21541 2024-03-31 01:38:48.000000 batorch-1.0.53/batorch/optimizer.py
--rw-r--r--   0 admin      (501) staff       (20)   239831 2024-03-31 01:38:48.000000 batorch-1.0.53/batorch/tensor.py
--rw-r--r--   0 admin      (501) staff       (20)    49911 2024-03-31 01:38:48.000000 batorch-1.0.53/batorch/tensorfunc.py
-drwxr-xr-x   0 admin      (501) staff       (20)        0 2024-03-31 01:38:48.709565 batorch-1.0.53/batorch.egg-info/
--rw-r--r--   0 admin      (501) staff       (20)      378 2024-03-31 01:38:48.000000 batorch-1.0.53/batorch.egg-info/PKG-INFO
--rw-r--r--   0 admin      (501) staff       (20)      955 2024-03-31 01:38:48.000000 batorch-1.0.53/batorch.egg-info/SOURCES.txt
--rw-r--r--   0 admin      (501) staff       (20)        1 2024-03-31 01:38:48.000000 batorch-1.0.53/batorch.egg-info/dependency_links.txt
--rw-r--r--   0 admin      (501) staff       (20)       39 2024-03-31 01:38:48.000000 batorch-1.0.53/batorch.egg-info/requires.txt
--rw-r--r--   0 admin      (501) staff       (20)       20 2024-03-31 01:38:48.000000 batorch-1.0.53/batorch.egg-info/top_level.txt
-drwxr-xr-x   0 admin      (501) staff       (20)        0 2024-03-31 01:38:48.715903 batorch-1.0.53/micomputing/
--rw-r--r--   0 admin      (501) staff       (20)     3077 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/__init__.py
--rw-r--r--   0 admin      (501) staff       (20)    60518 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/data.py
--rw-r--r--   0 admin      (501) staff       (20)    39911 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/funcs.py
--rw-r--r--   0 admin      (501) staff       (20)    54665 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/metrics.py
--rwxr-xr-x   0 admin      (501) staff       (20)    33404 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/micfunctions.so
--rw-r--r--   0 admin      (501) staff       (20)    23653 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/network.py
--rw-r--r--   0 admin      (501) staff       (20)    24832 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/plot.py
--rw-r--r--   0 admin      (501) staff       (20)    44391 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/stdio.py
--rw-r--r--   0 admin      (501) staff       (20)     1183 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/test_dismap.py
--rw-r--r--   0 admin      (501) staff       (20)   157221 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/trans.py
-drwxr-xr-x   0 admin      (501) staff       (20)        0 2024-03-31 01:38:48.718217 batorch-1.0.53/micomputing/zxhtools/
--rw-r--r--   0 admin      (501) staff       (20)     7454 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/zxhtools/TRS.py
-drwxr-xr-x   0 admin      (501) staff       (20)        0 2024-03-31 01:38:48.722251 batorch-1.0.53/micomputing/zxhtools/__pycache__/
--rw-r--r--   0 admin      (501) staff       (20)     6173 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/zxhtools/__pycache__/AFF.cpython-39.pyc
--rw-r--r--   0 admin      (501) staff       (20)     6173 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/zxhtools/__pycache__/FFD.cpython-39.pyc
--rw-r--r--   0 admin      (501) staff       (20)    19178 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/zxhtools/__pycache__/TRS.cpython-311.pyc
--rw-r--r--   0 admin      (501) staff       (20)     9153 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/zxhtools/__pycache__/TRS.cpython-37.pyc
--rw-r--r--   0 admin      (501) staff       (20)     8988 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/zxhtools/__pycache__/TRS.cpython-39.pyc
--rw-r--r--   0 admin      (501) staff       (20)    17706 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/zxhtools/__pycache__/exec.cpython-311.pyc
--rw-r--r--   0 admin      (501) staff       (20)     8071 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/zxhtools/exec.py
--rw-r--r--   0 admin      (501) staff       (20)      507 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/zxhtools/image2.AFF
--rw-r--r--   0 admin      (501) staff       (20)    21032 2024-03-31 01:38:48.000000 batorch-1.0.53/micomputing/zxhtools/image2.FFD
--rw-r--r--   0 admin      (501) staff       (20)       38 2024-03-31 01:38:48.723612 batorch-1.0.53/setup.cfg
--rw-r--r--   0 admin      (501) staff       (20)      642 2024-03-31 01:38:48.000000 batorch-1.0.53/setup_batorch.py
+drwxr-xr-x   0 admin      (501) staff       (20)        0 2024-05-22 09:35:24.293632 batorch-1.0.54/
+-rw-r--r--   0 admin      (501) staff       (20)       99 2024-05-22 09:35:23.000000 batorch-1.0.54/MANIFEST.in
+-rw-r--r--   0 admin      (501) staff       (20)      378 2024-05-22 09:35:24.293511 batorch-1.0.54/PKG-INFO
+-rw-r--r--   0 admin      (501) staff       (20)     3509 2024-05-22 09:35:24.000000 batorch-1.0.54/README.md
+drwxr-xr-x   0 admin      (501) staff       (20)        0 2024-05-22 09:35:24.289470 batorch-1.0.54/batorch/
+-rw-r--r--   0 admin      (501) staff       (20)     3986 2024-05-22 09:35:24.000000 batorch-1.0.54/batorch/__init__.py
+-rw-r--r--   0 admin      (501) staff       (20)     7923 2024-05-22 09:35:24.000000 batorch-1.0.54/batorch/device.py
+-rw-r--r--   0 admin      (501) staff       (20)    21541 2024-05-22 09:35:24.000000 batorch-1.0.54/batorch/optimizer.py
+-rw-r--r--   0 admin      (501) staff       (20)   240554 2024-05-22 09:35:24.000000 batorch-1.0.54/batorch/tensor.py
+-rw-r--r--   0 admin      (501) staff       (20)    57951 2024-05-22 09:35:24.000000 batorch-1.0.54/batorch/tensorfunc.py
+drwxr-xr-x   0 admin      (501) staff       (20)        0 2024-05-22 09:35:24.290198 batorch-1.0.54/batorch.egg-info/
+-rw-r--r--   0 admin      (501) staff       (20)      378 2024-05-22 09:35:24.000000 batorch-1.0.54/batorch.egg-info/PKG-INFO
+-rw-r--r--   0 admin      (501) staff       (20)      955 2024-05-22 09:35:24.000000 batorch-1.0.54/batorch.egg-info/SOURCES.txt
+-rw-r--r--   0 admin      (501) staff       (20)        1 2024-05-22 09:35:24.000000 batorch-1.0.54/batorch.egg-info/dependency_links.txt
+-rw-r--r--   0 admin      (501) staff       (20)       62 2024-05-22 09:35:24.000000 batorch-1.0.54/batorch.egg-info/requires.txt
+-rw-r--r--   0 admin      (501) staff       (20)       20 2024-05-22 09:35:24.000000 batorch-1.0.54/batorch.egg-info/top_level.txt
+drwxr-xr-x   0 admin      (501) staff       (20)        0 2024-05-22 09:35:24.291730 batorch-1.0.54/micomputing/
+-rw-r--r--   0 admin      (501) staff       (20)     3142 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/__init__.py
+-rw-r--r--   0 admin      (501) staff       (20)    63800 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/data.py
+-rw-r--r--   0 admin      (501) staff       (20)    39911 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/funcs.py
+-rw-r--r--   0 admin      (501) staff       (20)    54643 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/metrics.py
+-rwxr-xr-x   0 admin      (501) staff       (20)    33404 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/micfunctions.so
+-rw-r--r--   0 admin      (501) staff       (20)    35063 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/network.py
+-rw-r--r--   0 admin      (501) staff       (20)    29982 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/plot.py
+-rw-r--r--   0 admin      (501) staff       (20)    44425 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/stdio.py
+-rw-r--r--   0 admin      (501) staff       (20)     1183 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/test_dismap.py
+-rw-r--r--   0 admin      (501) staff       (20)   160592 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/trans.py
+drwxr-xr-x   0 admin      (501) staff       (20)        0 2024-05-22 09:35:24.292420 batorch-1.0.54/micomputing/zxhtools/
+-rw-r--r--   0 admin      (501) staff       (20)     7454 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/zxhtools/TRS.py
+drwxr-xr-x   0 admin      (501) staff       (20)        0 2024-05-22 09:35:24.293318 batorch-1.0.54/micomputing/zxhtools/__pycache__/
+-rw-r--r--   0 admin      (501) staff       (20)     6173 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/zxhtools/__pycache__/AFF.cpython-39.pyc
+-rw-r--r--   0 admin      (501) staff       (20)     6173 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/zxhtools/__pycache__/FFD.cpython-39.pyc
+-rw-r--r--   0 admin      (501) staff       (20)    19178 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/zxhtools/__pycache__/TRS.cpython-311.pyc
+-rw-r--r--   0 admin      (501) staff       (20)     9153 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/zxhtools/__pycache__/TRS.cpython-37.pyc
+-rw-r--r--   0 admin      (501) staff       (20)     8988 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/zxhtools/__pycache__/TRS.cpython-39.pyc
+-rw-r--r--   0 admin      (501) staff       (20)    17706 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/zxhtools/__pycache__/exec.cpython-311.pyc
+-rw-r--r--   0 admin      (501) staff       (20)     8071 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/zxhtools/exec.py
+-rw-r--r--   0 admin      (501) staff       (20)      507 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/zxhtools/image2.AFF
+-rw-r--r--   0 admin      (501) staff       (20)    21032 2024-05-22 09:35:23.000000 batorch-1.0.54/micomputing/zxhtools/image2.FFD
+-rw-r--r--   0 admin      (501) staff       (20)       38 2024-05-22 09:35:24.293675 batorch-1.0.54/setup.cfg
+-rw-r--r--   0 admin      (501) staff       (20)      674 2024-05-22 09:35:24.000000 batorch-1.0.54/setup_batorch.py
```

### Comparing `batorch-1.0.53/README.md` & `batorch-1.0.54/README.md`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/batorch/__init__.py` & `batorch-1.0.54/batorch/__init__.py`

 * *Files 3% similar despite different names*

```diff
@@ -2,22 +2,22 @@
 from pycamia import info_manager
 
 __info__ = info_manager(
     project = 'PyCAMIA',
     package = 'batorch',
     author = 'Yuncheng Zhou',
     create = '2021-12',
-    version = '1.0.52',
+    version = '1.0.53',
     contact = 'bertiezhou@163.com',
     keywords = ['torch', 'batch', 'batched data'],
     description = "'batorch' is an extension of package torch, for tensors with batch dimensions. ",
-    requires = ['pycamia', 'torch', 'pynvml', 'matplotlib', 'psutil'],
+    requires = ['pycamia', 'torch', 'pynvml', 'matplotlib', 'psutil', 'numpy', 'pyoverload', 'sympy'],
     update = '2023-07-10 15:53:47'
 ).check()
-__version__ = '1.0.52'
+__version__ = '1.0.53'
 
 import torch
 distributed = torch.distributed
 autograd = torch.autograd
 random = torch.random
 optim = torch.optim
 utils = torch.utils
@@ -29,26 +29,29 @@
     from .device import MPS
 if hasattr(torch, 'cuda') and torch.cuda.is_available():
     from .device import GPU, GPUs
 
 from .device import free_memory_amount, all_memory_amount, AutoDevice
 from .tensor import get_cpu_memory_used, get_gpu_memory_used, collect_memory, turn_on_autodevice, turn_off_autodevice, set_device, get_device, to_device, new_dim, exist_dim, del_dim, iter_dim, linalg_dim, inverse, inv, diag, diagflat, diagonal, trace, tr, add, sub, mul, div, pow, fmod, log, ln, log2, log10, exp, sqrt, abs, sign, sin, cos, tan, cot, sec, csc, asin, arcsin, acos, arccos, atan, arctan, matmul, mm, bmm, smm, floor_divide, true_divide, equal, addmm, addbmm, saddmm, addcmul, clamp, floor, ceil, round, any, all, unique, isnan, isinf, unsqueeze, squeeze, flatten, transpose, t, permute, standard_shape, duplicate, amplify, repeated, repeat, gather, flip, detach, quantile, val_range, sum, prod, mean, std, cumsum, cumprod, min, max, median, cummin, cummax, argmin, argmax, split, sample, pick, eig, matpow, matexp, matlog, rank, matnorm, det, matrix_power, matrix_exp, matrix_log, matrix_rank, matrix_norm, Size, FakeSize, func_dim_size, func_dim, broadcast, remove_dim, add_dim, Tensor, expand, expand_as, expand_to, complex, tensor, as_tensor, to_bttensor, empty, full, ones, zeros, empty_like, full_like, ones_like, zeros_like, tensor_like, rand, randn, rand_like, randn_like, randperm, arange, where, reshape, cat, stack, meshgrid, eye, eye_like, batch_arange, feature_arange, channel_arange, sequence_arange, batch_tensor, feature_tensor, channel_tensor, sequence_tensor, time_tensor, series_tensor, randint, randint_like, dtype, device, bfloat16, bool, cdouble, cfloat, chalf, complex128, complex32, complex64, double, half, float, float16, float32, float64, int, int16, int32, int64, int8, qint32, qint8, quint2x4, quint4x2, quint8, long, short, uint8, manual_seed #*
 # from . import nn
-from .tensorfunc import batorch_wrapper, conv, crop_as, decimal, divide, dot, equals, gaussian_kernel, image_grid, imagegrid, mask_center, one_hot, pad, permute_space, normalize01, grad_image, Jacobian, up_scale, down_scale, upper_matrix, upper_triangular_matrix, lower_matrix, lower_triangular_matrix, skew_symmetric, cross_matrix, skew_symmetric_params, uncross_matrix, norm, norm2, Fnorm, Fnorm2, frobenius_norm, meannorm, meannorm2, mean_norm, mean_norm2, summary, display #*
+from .tensorfunc import batorch_wrapper, conv, crop_as, decimal, divide, dot, equals, gaussian_kernel, image_grid, imagegrid, mask_center, one_hot, pad, permute_space, normalize01, input_shape, grad_image, Jacobian, up_scale, down_scale, upper_matrix, upper_triangular_matrix, lower_matrix, lower_triangular_matrix, skew_symmetric, cross_matrix, skew_symmetric_params, uncross_matrix, norm, norm2, Fnorm, Fnorm2, frobenius_norm, meannorm, meannorm2, mean_norm, mean_norm2, summary, display #*
 from .optimizer import CSGD, CADAM, Optimization, train, test #*
 _user_replace = globals()
 # from .tensor import __all__ # do not expand
 # force_recover = ['tensor']
 # for obj in __all__:
 #     if obj not in globals() or obj in force_recover:
 #         exec(f"from .tensor import {obj}")
 # from . import nn
 # globals().update(_user_replace)
 
+save = torch.save
+load = torch.load
 no_grad = torch.no_grad
+enable_grad = torch.enable_grad
 
 import math
 e = to_device(tensor(math.e))
 nan = to_device(tensor(math.nan))
 inf = to_device(tensor(math.inf))
 pi = to_device(tensor(math.pi))
 eps = to_device(tensor(1e-5))
```

### Comparing `batorch-1.0.53/batorch/device.py` & `batorch-1.0.54/batorch/device.py`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/batorch/optimizer.py` & `batorch-1.0.54/batorch/optimizer.py`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/batorch/tensor.py` & `batorch-1.0.54/batorch/tensor.py`

 * *Files 0% similar despite different names*

```diff
@@ -3801,11190 +3801,11235 @@
 0000ed80: 6c66 2c20 2a70 6572 6d75 7461 7469 6f6e  lf, *permutation
 0000ed90: 2920 2320 7375 7070 7265 7373 3a20 7370  ) # suppress: sp
 0000eda0: 6563 6961 6c5f 6672 6f6d 0a0a 6465 6620  ecial_from..def 
 0000edb0: 6475 706c 6963 6174 6528 7365 6c66 3a20  duplicate(self: 
 0000edc0: 2754 656e 736f 7227 2c20 6e75 6d3d 322c  'Tensor', num=2,
 0000edd0: 2064 696d 3a20 6e65 775f 6469 6d5b 315d   dim: new_dim[1]
 0000ede0: 3d7b 7d29 3a0a 2020 2020 2222 220a 2020  ={}):.    """.  
-0000edf0: 2020 4475 706c 6963 6174 6520 6120 7465    Duplicate a te
-0000ee00: 6e73 6f72 2062 7920 606e 756d 6020 7469  nsor by `num` ti
-0000ee10: 6d65 7320 616e 6420 7374 6163 6b20 7468  mes and stack th
-0000ee20: 656d 2061 7320 6120 6e65 7720 7465 6e73  em as a new tens
-0000ee30: 6f72 2e20 0a0a 2020 2020 4172 6773 3a0a  or. ..    Args:.
-0000ee40: 2020 2020 2020 2020 6e75 6d20 2869 6e74          num (int
-0000ee50: 2c20 6f70 7469 6f6e 616c 293a 2054 6865  , optional): The
-0000ee60: 206e 756d 6265 7220 6f66 2064 7570 6c69   number of dupli
-0000ee70: 6361 7469 6f6e 732e 2044 6566 6175 6c74  cations. Default
-0000ee80: 7320 746f 2032 2e20 0a20 2020 2020 2020  s to 2. .       
-0000ee90: 2064 696d 2028 696e 742f 6e65 775f 6469   dim (int/new_di
-0000eea0: 6d2c 206f 7074 696f 6e61 6c29 3a20 5468  m, optional): Th
-0000eeb0: 6520 6469 6d65 6e73 696f 6e20 746f 2073  e dimension to s
-0000eec0: 7461 636b 2061 6c6f 6e67 2e20 4465 6661  tack along. Defa
-0000eed0: 756c 7473 2074 6f20 6261 7463 682e 0a20  ults to batch.. 
-0000eee0: 2020 2022 2222 0a20 2020 2072 6574 7572     """.    retur
-0000eef0: 6e20 7365 6c66 2e75 6e73 7175 6565 7a65  n self.unsqueeze
-0000ef00: 2864 696d 292e 7265 7065 6174 2828 312c  (dim).repeat((1,
-0000ef10: 2920 2a20 6469 6d5b 305d 202b 2028 6e75  ) * dim[0] + (nu
-0000ef20: 6d2c 2920 2b20 2831 2c29 202a 2028 7365  m,) + (1,) * (se
-0000ef30: 6c66 2e6e 6469 6d20 2d20 6469 6d5b 305d  lf.ndim - dim[0]
-0000ef40: 2929 2e73 7065 6369 616c 5f66 726f 6d28  )).special_from(
-0000ef50: 6469 6d29 0a0a 6465 6620 616d 706c 6966  dim)..def amplif
-0000ef60: 7928 7365 6c66 3a20 2754 656e 736f 7227  y(self: 'Tensor'
-0000ef70: 2c20 6e75 6d3d 322c 2064 696d 3a20 6578  , num=2, dim: ex
-0000ef80: 6973 745f 6469 6d5b 315d 3d7b 7d29 3a0a  ist_dim[1]={}):.
-0000ef90: 2020 2020 2222 220a 2020 2020 416d 706c      """.    Ampl
-0000efa0: 6966 7920 6120 6469 6d65 6e73 696f 6e20  ify a dimension 
-0000efb0: 6f66 2061 2074 656e 736f 7220 6279 2065  of a tensor by e
-0000efc0: 6e6c 6172 6769 6e67 2077 6974 6820 6475  nlarging with du
-0000efd0: 706c 6963 6174 696f 6e73 3a20 616d 706c  plications: ampl
-0000efe0: 6966 7969 6e67 205b 612c 2062 2c20 635d  ifying [a, b, c]
-0000eff0: 2077 6974 6820 6e75 6d62 6572 2032 2072   with number 2 r
-0000f000: 6573 756c 7473 2069 6e20 5b61 2c20 612c  esults in [a, a,
-0000f010: 2062 2c20 622c 2063 2c20 635d 2e0a 2020   b, b, c, c]..  
-0000f020: 2020 4e6f 7465 2074 6861 7420 6f6e 6520    Note that one 
-0000f030: 7368 6f75 6c64 2075 7365 2027 7265 7065  should use 'repe
-0000f040: 6174 6564 2720 2866 6f72 206f 6e65 2064  ated' (for one d
-0000f050: 696d 656e 7369 6f6e 2920 6f72 2027 7265  imension) or 're
-0000f060: 7065 6174 2720 2866 6f72 2061 6c6c 2064  peat' (for all d
-0000f070: 696d 656e 7369 6f6e 7329 2074 6f20 6475  imensions) to du
-0000f080: 706c 6963 6174 6520 7468 6520 7768 6f6c  plicate the whol
-0000f090: 6520 7465 6e73 6f72 2061 6e64 200a 2020  e tensor and .  
-0000f0a0: 2020 2020 2020 636f 6e63 6174 656e 6174        concatenat
-0000f0b0: 6520 7468 6520 6475 706c 6963 6174 696f  e the duplicatio
-0000f0c0: 6e73 2074 6f67 6574 6865 7220 285b 612c  ns together ([a,
-0000f0d0: 2062 2c20 635d 203d 3e20 5b61 2c20 622c   b, c] => [a, b,
-0000f0e0: 2063 2c20 612c 2062 2c20 635d 292e 200a   c, a, b, c]). .
-0000f0f0: 2020 2020 0a20 2020 2041 7267 733a 200a      .    Args: .
-0000f100: 2020 2020 2020 2020 6e75 6d20 2869 6e74          num (int
-0000f110: 2c20 6f70 7469 6f6e 616c 293a 2054 6865  , optional): The
-0000f120: 206e 756d 6265 7220 6f66 2064 7570 6c69   number of dupli
-0000f130: 6361 7469 6f6e 732e 2044 6566 6175 6c74  cations. Default
-0000f140: 7320 746f 2032 2e20 0a20 2020 2020 2020  s to 2. .       
-0000f150: 2064 696d 2028 696e 742f 6e65 775f 6469   dim (int/new_di
-0000f160: 6d2c 206f 7074 696f 6e61 6c29 3a20 5468  m, optional): Th
-0000f170: 6520 6469 6d65 6e73 696f 6e20 746f 2073  e dimension to s
-0000f180: 7461 636b 2061 6c6f 6e67 2e20 4465 6661  tack along. Defa
-0000f190: 756c 7473 2074 6f20 6261 7463 682e 0a20  ults to batch.. 
-0000f1a0: 2020 2022 2222 0a20 2020 2064 696d 203d     """.    dim =
-0000f1b0: 2064 696d 5b30 5d0a 2020 2020 7769 7468   dim[0].    with
-0000f1c0: 2073 656c 662e 6869 6465 5f73 7065 6369   self.hide_speci
-0000f1d0: 616c 2829 3a0a 2020 2020 2020 2020 6f75  al():.        ou
-0000f1e0: 7470 7574 203d 2073 656c 662e 6475 706c  tput = self.dupl
-0000f1f0: 6963 6174 6528 6e75 6d2c 2064 696d 2b31  icate(num, dim+1
-0000f200: 292e 666c 6174 7465 6e28 6469 6d2c 2064  ).flatten(dim, d
-0000f210: 696d 202b 2031 290a 2020 2020 7265 7475  im + 1).    retu
-0000f220: 726e 206f 7574 7075 742e 7370 6563 6961  rn output.specia
-0000f230: 6c5f 6672 6f6d 2873 656c 6629 0a0a 6465  l_from(self)..de
-0000f240: 6620 7265 7065 6174 6564 2873 656c 663a  f repeated(self:
-0000f250: 2027 5465 6e73 6f72 272c 206e 756d 3d32   'Tensor', num=2
-0000f260: 2c20 6469 6d3a 2065 7869 7374 5f64 696d  , dim: exist_dim
-0000f270: 5b31 5d3d 7b7d 293a 0a20 2020 2022 2222  [1]={}):.    """
-0000f280: 0a20 2020 2052 6570 6561 7420 6120 7465  .    Repeat a te
-0000f290: 6e73 6f72 2062 7920 606e 756d 6020 7469  nsor by `num` ti
-0000f2a0: 6d65 7320 616c 6f6e 6720 6f6e 6520 6469  mes along one di
-0000f2b0: 6d65 6e73 696f 6e20 6064 696d 6020 2875  mension `dim` (u
-0000f2c0: 7365 2027 7265 7065 6174 2720 666f 7220  se 'repeat' for 
-0000f2d0: 6d75 6c74 6970 6c65 2064 696d 656e 7369  multiple dimensi
-0000f2e0: 6f6e 7329 2061 6e64 2063 6f6e 6361 7465  ons) and concate
-0000f2f0: 6e61 7465 2074 6865 6d20 6173 2061 206e  nate them as a n
-0000f300: 6577 2074 656e 736f 722e 0a20 2020 204e  ew tensor..    N
-0000f310: 6f74 6520 7468 6174 2072 6570 6561 7469  ote that repeati
-0000f320: 6e67 205b 612c 2062 2c20 635d 2077 6974  ng [a, b, c] wit
-0000f330: 6820 6e75 6d62 6572 2032 2072 6573 756c  h number 2 resul
-0000f340: 7473 2069 6e20 5b61 2c20 622c 2063 2c20  ts in [a, b, c, 
-0000f350: 612c 2062 2c20 635d 2e0a 2020 2020 2020  a, b, c]..      
-0000f360: 2020 4f6e 6520 7368 6f75 6c64 2075 7365    One should use
-0000f370: 2027 616d 706c 6966 7927 2074 6f20 616d   'amplify' to am
-0000f380: 706c 6966 7920 746f 205b 612c 2061 2c20  plify to [a, a, 
-0000f390: 622c 2062 2c20 632c 2063 5d2e 0a20 2020  b, b, c, c]..   
-0000f3a0: 200a 2020 2020 4172 6773 3a20 0a20 2020   .    Args: .   
-0000f3b0: 2020 2020 206e 756d 2028 696e 742c 206f       num (int, o
-0000f3c0: 7074 696f 6e61 6c29 3a20 5468 6520 6e75  ptional): The nu
-0000f3d0: 6d62 6572 206f 6620 6475 706c 6963 6174  mber of duplicat
-0000f3e0: 696f 6e73 2e20 4465 6661 756c 7473 2074  ions. Defaults t
-0000f3f0: 6f20 322e 200a 2020 2020 2020 2020 6469  o 2. .        di
-0000f400: 6d20 2869 6e74 2f6e 6577 5f64 696d 2c20  m (int/new_dim, 
-0000f410: 6f70 7469 6f6e 616c 293a 2054 6865 2064  optional): The d
-0000f420: 696d 656e 7369 6f6e 2074 6f20 7374 6163  imension to stac
-0000f430: 6b20 616c 6f6e 672e 2044 6566 6175 6c74  k along. Default
-0000f440: 7320 746f 2062 6174 6368 2e0a 2020 2020  s to batch..    
-0000f450: 2222 220a 2020 2020 6469 6d20 3d20 6469  """.    dim = di
-0000f460: 6d5b 305d 0a20 2020 2077 6974 6820 7365  m[0].    with se
-0000f470: 6c66 2e68 6964 655f 7370 6563 6961 6c28  lf.hide_special(
-0000f480: 293a 0a20 2020 2020 2020 206f 7574 7075  ):.        outpu
-0000f490: 7420 3d20 7365 6c66 2e64 7570 6c69 6361  t = self.duplica
-0000f4a0: 7465 286e 756d 2c20 6469 6d29 2e66 6c61  te(num, dim).fla
-0000f4b0: 7474 656e 2864 696d 2c20 6469 6d20 2b20  tten(dim, dim + 
-0000f4c0: 3129 0a20 2020 2072 6574 7572 6e20 6f75  1).    return ou
-0000f4d0: 7470 7574 2e73 7065 6369 616c 5f66 726f  tput.special_fro
-0000f4e0: 6d28 7365 6c66 290a 0a64 6566 2072 6570  m(self)..def rep
-0000f4f0: 6561 7428 7365 6c66 3a20 2754 656e 736f  eat(self: 'Tenso
-0000f500: 7227 2c20 2a73 697a 653a 2027 5369 7a65  r', *size: 'Size
-0000f510: 2729 3a0a 2020 2020 7769 7468 2074 6f72  '):.    with tor
-0000f520: 6368 2e5f 432e 4469 7361 626c 6554 6f72  ch._C.DisableTor
-0000f530: 6368 4675 6e63 7469 6f6e 2829 3a0a 2020  chFunction():.  
-0000f540: 2020 2020 2020 7265 7475 726e 2074 6f72        return tor
-0000f550: 6368 5f73 7570 6572 2873 656c 662c 2027  ch_super(self, '
-0000f560: 7265 7065 6174 2729 282a 7369 7a65 292e  repeat')(*size).
-0000f570: 6173 5f73 7562 636c 6173 7328 5465 6e73  as_subclass(Tens
-0000f580: 6f72 292e 7370 6563 6961 6c5f 6672 6f6d  or).special_from
-0000f590: 2873 656c 6629 2e75 7064 6174 655f 7370  (self).update_sp
-0000f5a0: 6563 6961 6c5f 6672 6f6d 2873 697a 6529  ecial_from(size)
-0000f5b0: 0a0a 2320 7265 7361 6d70 6c65 7273 0a64  ..# resamplers.d
-0000f5c0: 6566 2067 6174 6865 7228 7365 6c66 3a20  ef gather(self: 
-0000f5d0: 2754 656e 736f 7227 2c20 6469 6d3a 2065  'Tensor', dim: e
-0000f5e0: 7869 7374 5f64 696d 5b31 5d2c 2069 6e64  xist_dim[1], ind
-0000f5f0: 6578 2c20 2a2c 2073 7061 7273 655f 6772  ex, *, sparse_gr
-0000f600: 6164 3d46 616c 7365 2c20 6f75 743d 4e6f  ad=False, out=No
-0000f610: 6e65 293a 202e 2e2e 0a64 6566 2066 6c69  ne): ....def fli
-0000f620: 7028 7365 6c66 3a20 2754 656e 736f 7227  p(self: 'Tensor'
-0000f630: 2c20 2a64 696d 733a 2065 7869 7374 5f64  , *dims: exist_d
-0000f640: 696d 293a 202e 2e2e 0a0a 2320 7072 6f70  im): .....# prop
-0000f650: 6572 7469 6573 0a64 6566 2064 6574 6163  erties.def detac
-0000f660: 6828 7365 6c66 3a20 2754 656e 736f 7227  h(self: 'Tensor'
-0000f670: 293a 202e 2e2e 0a64 6566 2071 7561 6e74  ): ....def quant
-0000f680: 696c 6528 7365 6c66 3a20 2754 656e 736f  ile(self: 'Tenso
-0000f690: 7227 2c20 713a 2027 5465 6e73 6f72 272c  r', q: 'Tensor',
-0000f6a0: 2064 696d 3d4e 6f6e 652c 206b 6565 7064   dim=None, keepd
-0000f6b0: 696d 3d46 616c 7365 2c20 2a2c 2069 6e74  im=False, *, int
-0000f6c0: 6572 706f 6c61 7469 6f6e 3d27 6c69 6e65  erpolation='line
-0000f6d0: 6172 2729 3a0a 2020 2020 6e5f 6469 6d5f  ar'):.    n_dim_
-0000f6e0: 636f 756e 7420 3d20 4e6f 6e65 0a20 2020  count = None.   
-0000f6f0: 2069 6620 6469 6d20 6973 206e 6f74 204e   if dim is not N
-0000f700: 6f6e 653a 0a20 2020 2020 2020 2064 696d  one:.        dim
-0000f710: 203d 2065 7869 7374 5f64 696d 2873 656c   = exist_dim(sel
-0000f720: 662c 2064 696d 290a 2020 2020 2020 2020  f, dim).        
-0000f730: 6966 206c 656e 2864 696d 2920 3e20 313a  if len(dim) > 1:
-0000f740: 2073 656c 6620 3d20 7365 6c66 2e66 6c61   self = self.fla
-0000f750: 7474 656e 2864 696d 293b 206e 5f64 696d  tten(dim); n_dim
-0000f760: 5f63 6f75 6e74 203d 206c 656e 2864 696d  _count = len(dim
-0000f770: 290a 2020 2020 2020 2020 7265 665f 7368  ).        ref_sh
-0000f780: 6170 652c 205f 2c20 5f20 3d20 7369 7a65  ape, _, _ = size
-0000f790: 5f6d 6170 7069 6e67 5f6f 705b 2771 7561  _mapping_op['qua
-0000f7a0: 6e74 696c 6527 5d28 7365 6c66 2e73 6861  ntile'](self.sha
-0000f7b0: 7065 2c20 715f 7368 6170 652c 2064 696d  pe, q_shape, dim
-0000f7c0: 5b3a 315d 2c20 6b65 6570 6469 6d3d 6b65  [:1], keepdim=ke
-0000f7d0: 6570 6469 6d29 0a20 2020 2077 6974 6820  epdim).    with 
-0000f7e0: 746f 7263 682e 5f43 2e44 6973 6162 6c65  torch._C.Disable
-0000f7f0: 546f 7263 6846 756e 6374 696f 6e28 293a  TorchFunction():
-0000f800: 0a20 2020 2020 2020 2069 6620 6469 6d20  .        if dim 
-0000f810: 6973 204e 6f6e 653a 2072 6573 203d 2074  is None: res = t
-0000f820: 6f72 6368 2e71 7561 6e74 696c 6528 7365  orch.quantile(se
-0000f830: 6c66 2c20 712c 206b 6565 7064 696d 3d6b  lf, q, keepdim=k
-0000f840: 6565 7064 696d 2c69 6e74 6572 706f 6c61  eepdim,interpola
-0000f850: 7469 6f6e 3d69 6e74 6572 706f 6c61 7469  tion=interpolati
-0000f860: 6f6e 292e 6173 5f73 7562 636c 6173 7328  on).as_subclass(
-0000f870: 5465 6e73 6f72 292e 7370 6563 6961 6c5f  Tensor).special_
-0000f880: 6672 6f6d 2871 293b 2064 696d 203d 205b  from(q); dim = [
-0000f890: 696e 745f 2871 2e6e 5f64 696d 203e 2030  int_(q.n_dim > 0
-0000f8a0: 295d 0a20 2020 2020 2020 2065 6c73 653a  )].        else:
-0000f8b0: 2072 6573 203d 2074 6f72 6368 2e71 7561   res = torch.qua
-0000f8c0: 6e74 696c 6528 7365 6c66 2c20 712c 2064  ntile(self, q, d
-0000f8d0: 696d 5b30 5d2c 206b 6565 7064 696d 3d6b  im[0], keepdim=k
-0000f8e0: 6565 7064 696d 2c69 6e74 6572 706f 6c61  eepdim,interpola
-0000f8f0: 7469 6f6e 3d69 6e74 6572 706f 6c61 7469  tion=interpolati
-0000f900: 6f6e 292e 6173 5f73 7562 636c 6173 7328  on).as_subclass(
-0000f910: 5465 6e73 6f72 292e 7370 6563 6961 6c5f  Tensor).special_
-0000f920: 6672 6f6d 2872 6566 5f73 6861 7065 290a  from(ref_shape).
-0000f930: 2020 2020 6966 206b 6565 7064 696d 3a0a      if keepdim:.
-0000f940: 2020 2020 2020 2020 6420 3d20 6469 6d5b          d = dim[
-0000f950: 305d 202b 2069 6e74 5f28 712e 6e5f 6469  0] + int_(q.n_di
-0000f960: 6d20 3e20 3029 0a20 2020 2020 2020 2072  m > 0).        r
-0000f970: 6574 7572 6e20 7265 732e 7370 6c69 745f  eturn res.split_
-0000f980: 6469 6d28 642c 2072 6573 2e73 6861 7065  dim(d, res.shape
-0000f990: 5b64 3a64 2b31 5d20 2a20 6e5f 6469 6d5f  [d:d+1] * n_dim_
-0000f9a0: 636f 756e 7429 0a20 2020 2065 6c73 653a  count).    else:
-0000f9b0: 2072 6574 7572 6e20 7265 730a 6465 6620   return res.def 
-0000f9c0: 7661 6c5f 7261 6e67 6528 7365 6c66 2c20  val_range(self, 
-0000f9d0: 6469 6d3a 2065 7869 7374 5f64 696d 3d4e  dim: exist_dim=N
-0000f9e0: 6f6e 6529 3a0a 2020 2020 2222 220a 2020  one):.    """.  
-0000f9f0: 2020 436f 6d70 7574 6520 7468 6520 7261    Compute the ra
-0000fa00: 6e67 6520 696e 2064 696d 656e 7369 6f6e  nge in dimension
-0000fa10: 7320 6064 696d 602c 2072 6573 756c 7469  s `dim`, resulti
-0000fa20: 6e67 2069 6e20 6120 7371 7565 657a 6520  ng in a squeeze 
-0000fa30: 6f66 2074 6865 7365 2064 696d 656e 7369  of these dimensi
-0000fa40: 6f6e 7320 0a20 2020 2020 2020 2074 6f20  ons .        to 
-0000fa50: 6120 736f 6c65 2066 756e 6374 696f 6e61  a sole functiona
-0000fa60: 6c20 6469 6d65 6e73 696f 6e20 6f66 2032  l dimension of 2
-0000fa70: 2c20 692e 652e 2074 6865 206d 696e 696d  , i.e. the minim
-0000fa80: 616c 2061 6e64 206d 6178 696d 616c 2076  al and maximal v
-0000fa90: 616c 7565 732e 200a 0a20 2020 2041 7267  alues. ..    Arg
-0000faa0: 733a 2064 696d 2028 696e 742f 6578 6973  s: dim (int/exis
-0000fab0: 745f 6469 6d2c 206f 7074 696f 6e61 6c29  t_dim, optional)
-0000fac0: 3a20 5468 6520 6469 6d65 6e73 696f 6e73  : The dimensions
-0000fad0: 2074 6f20 6669 6e64 2072 616e 6765 2e20   to find range. 
-0000fae0: 4465 6661 756c 7473 2074 6f20 4e6f 6e65  Defaults to None
-0000faf0: 2e0a 2020 2020 4f75 7470 7574 3a20 2828  ..    Output: ((
-0000fb00: 3229 2c20 2e2e 2e5b 7369 7a65 2077 6974  2), ...[size wit
-0000fb10: 686f 7574 2074 6865 2073 7065 6369 6669  hout the specifi
-0000fb20: 6564 2064 696d 6e73 696f 6e73 5d29 0a20  ed dimnsions]). 
-0000fb30: 2020 2022 2222 0a20 2020 2072 6574 7572     """.    retur
-0000fb40: 6e20 7374 6163 6b28 7365 6c66 2e6d 696e  n stack(self.min
-0000fb50: 2864 696d 292c 2073 656c 662e 6d61 7828  (dim), self.max(
-0000fb60: 6469 6d29 2c20 3029 2e77 6974 685f 6675  dim), 0).with_fu
-0000fb70: 6e63 5f64 696d 2830 2920 2320 7375 7070  nc_dim(0) # supp
-0000fb80: 7265 7373 3a20 7370 6563 6961 6c5f 6672  ress: special_fr
-0000fb90: 6f6d 0a0a 2320 7265 6475 6374 696f 6e73  om..# reductions
-0000fba0: 0a64 6566 2073 756d 2869 6e70 7574 3a20  .def sum(input: 
-0000fbb0: 2754 656e 736f 7227 2c20 2a64 696d 3a20  'Tensor', *dim: 
-0000fbc0: 6465 6c5f 6469 6d5b 3a5d 2c20 6b65 6570  del_dim[:], keep
-0000fbd0: 6469 6d3d 4661 6c73 652c 2064 7479 7065  dim=False, dtype
-0000fbe0: 3d4e 6f6e 6529 3a20 2e2e 2e0a 6465 6620  =None): ....def 
-0000fbf0: 7072 6f64 2869 6e70 7574 3a20 2754 656e  prod(input: 'Ten
-0000fc00: 736f 7227 2c20 6469 6d3a 2064 656c 5f64  sor', dim: del_d
-0000fc10: 696d 5b2e 2e2e 5d3d 4e6f 6e65 2c20 6b65  im[...]=None, ke
-0000fc20: 6570 6469 6d3d 4661 6c73 652c 2064 7479  epdim=False, dty
-0000fc30: 7065 3d4e 6f6e 6529 3a20 2e2e 2e0a 6465  pe=None): ....de
-0000fc40: 6620 6d65 616e 2869 6e70 7574 3a20 2754  f mean(input: 'T
-0000fc50: 656e 736f 7227 2c20 2a64 696d 3a20 6465  ensor', *dim: de
-0000fc60: 6c5f 6469 6d5b 3a5d 2c20 6b65 6570 6469  l_dim[:], keepdi
-0000fc70: 6d3d 4661 6c73 652c 2064 7479 7065 3d4e  m=False, dtype=N
-0000fc80: 6f6e 6529 3a20 2e2e 2e0a 6465 6620 7374  one): ....def st
-0000fc90: 6428 696e 7075 743a 2027 5465 6e73 6f72  d(input: 'Tensor
-0000fca0: 272c 202a 6469 6d3a 2064 656c 5f64 696d  ', *dim: del_dim
-0000fcb0: 5b3a 5d2c 2063 6f72 7265 6374 696f 6e3d  [:], correction=
-0000fcc0: 312c 206b 6565 7064 696d 3d46 616c 7365  1, keepdim=False
-0000fcd0: 293a 202e 2e2e 0a64 6566 2063 756d 7375  ): ....def cumsu
-0000fce0: 6d28 696e 7075 743a 2027 5465 6e73 6f72  m(input: 'Tensor
-0000fcf0: 272c 2064 696d 3a20 6465 6c5f 6469 6d5b  ', dim: del_dim[
-0000fd00: 315d 2c20 6474 7970 653d 4e6f 6e65 2c20  1], dtype=None, 
-0000fd10: 6f75 743d 4e6f 6e65 293a 202e 2e2e 0a64  out=None): ....d
-0000fd20: 6566 2063 756d 7072 6f64 2869 6e70 7574  ef cumprod(input
-0000fd30: 3a20 2754 656e 736f 7227 2c20 6469 6d3a  : 'Tensor', dim:
-0000fd40: 2064 656c 5f64 696d 5b31 5d2c 2064 7479   del_dim[1], dty
-0000fd50: 7065 3d4e 6f6e 652c 206f 7574 3d4e 6f6e  pe=None, out=Non
-0000fd60: 6529 3a20 2e2e 2e0a 0a64 6566 205f 5f69  e): .....def __i
-0000fd70: 6e64 6578 6564 5f72 6564 7563 655f 5f28  ndexed_reduce__(
-0000fd80: 6675 6e63 5f6e 616d 652c 2073 656c 663a  func_name, self:
-0000fd90: 2027 5465 6e73 6f72 272c 202a 6469 6d2c   'Tensor', *dim,
-0000fda0: 206b 6565 7064 696d 3d4e 6f6e 652c 206f   keepdim=None, o
-0000fdb0: 7574 3d4e 6f6e 652c 2072 6574 5f69 6e64  ut=None, ret_ind
-0000fdc0: 6578 5f6f 6e6c 793d 4661 6c73 6529 3a0a  ex_only=False):.
-0000fdd0: 2020 2020 6966 206c 656e 2864 696d 2920      if len(dim) 
-0000fde0: 3d3d 2031 2061 6e64 2069 7369 6e73 7461  == 1 and isinsta
-0000fdf0: 6e63 6528 6469 6d5b 305d 2c20 746f 7263  nce(dim[0], torc
-0000fe00: 682e 5465 6e73 6f72 293a 0a20 2020 2020  h.Tensor):.     
-0000fe10: 2020 206f 7468 6572 203d 2064 696d 5b30     other = dim[0
-0000fe20: 5d0a 2020 2020 2020 2020 6f74 6865 7220  ].        other 
-0000fe30: 3d20 6f74 6865 722e 6173 5f73 7562 636c  = other.as_subcl
-0000fe40: 6173 7328 5465 6e73 6f72 292e 7370 6563  ass(Tensor).spec
-0000fe50: 6961 6c5f 6672 6f6d 286f 7468 6572 2e73  ial_from(other.s
-0000fe60: 6861 7065 2920 6966 206e 6f74 2069 7369  hape) if not isi
-0000fe70: 6e73 7461 6e63 6528 6f74 6865 722c 2054  nstance(other, T
-0000fe80: 656e 736f 7229 2065 6c73 6520 6f74 6865  ensor) else othe
-0000fe90: 720a 2020 2020 2020 2020 7365 6c66 5f73  r.        self_s
-0000fea0: 6861 7065 203d 2053 697a 6528 7365 6c66  hape = Size(self
-0000feb0: 2e73 6861 7065 293b 206f 7468 6572 5f73  .shape); other_s
-0000fec0: 6861 7065 203d 2053 697a 6528 6f74 6865  hape = Size(othe
-0000fed0: 722e 7368 6170 6529 0a20 2020 2020 2020  r.shape).       
-0000fee0: 2072 6566 5f73 6861 7065 2c20 7365 6c66   ref_shape, self
-0000fef0: 5f73 6861 7065 2c20 6f74 6865 725f 7368  _shape, other_sh
-0000ff00: 6170 6520 3d20 7369 7a65 5f6d 6170 7069  ape = size_mappi
-0000ff10: 6e67 5f6f 705b 6675 6e63 5f6e 616d 655d  ng_op[func_name]
-0000ff20: 2873 656c 665f 7368 6170 652c 206f 7468  (self_shape, oth
-0000ff30: 6572 5f73 6861 7065 290a 2020 2020 2020  er_shape).      
-0000ff40: 2020 7769 7468 2074 6f72 6368 2e5f 432e    with torch._C.
-0000ff50: 4469 7361 626c 6554 6f72 6368 4675 6e63  DisableTorchFunc
-0000ff60: 7469 6f6e 2829 3a0a 2020 2020 2020 2020  tion():.        
-0000ff70: 2020 2020 7265 7475 726e 2074 6f72 6368      return torch
-0000ff80: 5f73 7570 6572 2873 656c 662c 2066 756e  _super(self, fun
-0000ff90: 635f 6e61 6d65 2928 6f74 6865 722c 202a  c_name)(other, *
-0000ffa0: 2a28 6469 6374 286f 7574 3d6f 7574 2920  *(dict(out=out) 
-0000ffb0: 6966 206c 6f63 616c 7328 292e 6765 7428  if locals().get(
-0000ffc0: 276f 7574 272c 204e 6f6e 6529 2069 7320  'out', None) is 
-0000ffd0: 6e6f 7420 4e6f 6e65 2065 6c73 6520 7b7d  not None else {}
-0000ffe0: 2929 2e61 735f 7375 6263 6c61 7373 2854  )).as_subclass(T
-0000fff0: 656e 736f 7229 2e73 7065 6369 616c 5f66  ensor).special_f
-00010000: 726f 6d28 7265 665f 7368 6170 6529 0a20  rom(ref_shape). 
-00010010: 2020 2064 696d 203d 2064 656c 5f64 696d     dim = del_dim
-00010020: 2873 656c 662c 202a 6469 6d29 0a20 2020  (self, *dim).   
-00010030: 2069 6e64 6963 6573 203d 204e 6f6e 650a   indices = None.
-00010040: 2020 2020 6e75 6d5f 6469 6d20 3d20 300a      num_dim = 0.
-00010050: 2020 2020 696e 6974 5f73 6861 7065 203d      init_shape =
-00010060: 2073 656c 662e 7368 6170 650a 2020 2020   self.shape.    
-00010070: 7769 7468 2074 6f72 6368 2e5f 432e 4469  with torch._C.Di
-00010080: 7361 626c 6554 6f72 6368 4675 6e63 7469  sableTorchFuncti
-00010090: 6f6e 2829 3a0a 2020 2020 2020 2020 666f  on():.        fo
-000100a0: 7220 6420 696e 2064 696d 5b3a 3a2d 315d  r d in dim[::-1]
-000100b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000100c0: 7375 6c74 203d 2074 6f72 6368 5f73 7570  sult = torch_sup
-000100d0: 6572 2873 656c 662c 2066 756e 635f 6e61  er(self, func_na
-000100e0: 6d65 2928 642c 202a 2a64 6963 7428 6b65  me)(d, **dict(ke
-000100f0: 6570 6469 6d3d 6b65 6570 6469 6d29 2069  epdim=keepdim) i
-00010100: 6620 6b65 6570 6469 6d20 6973 206e 6f74  f keepdim is not
-00010110: 204e 6f6e 6520 656c 7365 207b 7d29 0a20   None else {}). 
-00010120: 2020 2020 2020 2020 2020 2073 656c 6620             self 
-00010130: 3d20 7265 7375 6c74 2e76 616c 7565 730a  = result.values.
-00010140: 2020 2020 2020 2020 2020 2020 7265 735f              res_
-00010150: 696e 6469 6365 7320 3d20 7265 7375 6c74  indices = result
-00010160: 2e69 6e64 6963 6573 2e61 735f 7375 6263  .indices.as_subc
-00010170: 6c61 7373 2854 656e 736f 7229 2e69 6e69  lass(Tensor).ini
-00010180: 745f 7370 6563 6961 6c28 290a 2020 2020  t_special().    
-00010190: 2020 2020 2020 2020 6966 2069 6e64 6963          if indic
-000101a0: 6573 2069 7320 4e6f 6e65 3a20 696e 6469  es is None: indi
-000101b0: 6365 7320 3d20 7265 735f 696e 6469 6365  ces = res_indice
-000101c0: 732e 756e 7371 7565 657a 6528 302c 2073  s.unsqueeze(0, s
-000101d0: 7a5f 6675 6e63 5f64 696d 3d31 290a 2020  z_func_dim=1).  
-000101e0: 2020 2020 2020 2020 2020 656c 6966 206b            elif k
-000101f0: 6565 7064 696d 206f 7220 6b65 6570 6469  eepdim or keepdi
-00010200: 6d20 6973 204e 6f6e 653a 2069 6e64 6963  m is None: indic
-00010210: 6573 203d 2063 6174 2872 6573 5f69 6e64  es = cat(res_ind
-00010220: 6963 6573 2e75 6e73 7175 6565 7a65 2830  ices.unsqueeze(0
-00010230: 2c20 737a 5f66 756e 635f 6469 6d3d 3129  , sz_func_dim=1)
-00010240: 2c20 696e 6469 6365 732e 6761 7468 6572  , indices.gather
-00010250: 2864 2b31 2c20 7265 735f 696e 6469 6365  (d+1, res_indice
-00010260: 732e 6475 706c 6963 6174 6528 6e75 6d5f  s.duplicate(num_
-00010270: 6469 6d2c 2030 2c20 737a 5f66 756e 635f  dim, 0, sz_func_
-00010280: 6469 6d3d 3129 292c 2030 290a 2020 2020  dim=1)), 0).    
-00010290: 2020 2020 2020 2020 656c 7365 3a20 696e          else: in
-000102a0: 6469 6365 7320 3d20 6361 7428 7265 735f  dices = cat(res_
-000102b0: 696e 6469 6365 732e 756e 7371 7565 657a  indices.unsqueez
-000102c0: 6528 302c 2073 7a5f 6675 6e63 5f64 696d  e(0, sz_func_dim
-000102d0: 3d31 292c 2069 6e64 6963 6573 2e67 6174  =1), indices.gat
-000102e0: 6865 7228 642b 312c 2072 6573 5f69 6e64  her(d+1, res_ind
-000102f0: 6963 6573 2e75 6e73 7175 6565 7a65 2864  ices.unsqueeze(d
-00010300: 292e 6475 706c 6963 6174 6528 6e75 6d5f  ).duplicate(num_
-00010310: 6469 6d2c 2030 2c20 737a 5f66 756e 635f  dim, 0, sz_func_
-00010320: 6469 6d3d 3129 292e 7371 7565 657a 655f  dim=1)).squeeze_
-00010330: 2864 2b31 292c 2030 290a 2020 2020 2020  (d+1), 0).      
-00010340: 2020 2020 2020 6e75 6d5f 6469 6d20 2b3d        num_dim +=
-00010350: 2031 0a20 2020 2069 6620 6b65 6570 6469   1.    if keepdi
-00010360: 6d20 6973 2046 616c 7365 3a20 6375 725f  m is False: cur_
-00010370: 7368 6170 6520 3d20 7265 6d6f 7665 5f64  shape = remove_d
-00010380: 696d 2869 6e69 745f 7368 6170 652c 2064  im(init_shape, d
-00010390: 696d 290a 2020 2020 656c 7365 3a20 6375  im).    else: cu
-000103a0: 725f 7368 6170 6520 3d20 696e 6974 5f73  r_shape = init_s
-000103b0: 6861 7065 0a20 2020 2069 6620 7265 745f  hape.    if ret_
-000103c0: 696e 6465 785f 6f6e 6c79 3a0a 2020 2020  index_only:.    
-000103d0: 2020 2020 696e 6469 6365 7320 3d20 696e      indices = in
-000103e0: 6469 6365 732e 7370 6563 6961 6c5f 6672  dices.special_fr
-000103f0: 6f6d 2866 756e 635f 6469 6d20 2b20 6375  om(func_dim + cu
-00010400: 725f 7368 6170 6529 2069 6620 696e 6469  r_shape) if indi
-00010410: 6365 7320 6973 206e 6f74 204e 6f6e 6520  ces is not None 
-00010420: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
-00010430: 2020 6966 206c 656e 2864 696d 2920 3d3d    if len(dim) ==
-00010440: 2031 3a20 696e 6469 6365 732e 7371 7565   1: indices.sque
-00010450: 657a 655f 2830 290a 2020 2020 2020 2020  eze_(0).        
-00010460: 696e 6469 6365 732e 696e 6469 6365 7320  indices.indices 
-00010470: 3d20 696e 6469 6365 730a 2020 2020 2020  = indices.      
-00010480: 2020 696e 6469 6365 732e 7661 6c75 6573    indices.values
-00010490: 203d 2073 656c 662e 6173 5f73 7562 636c   = self.as_subcl
-000104a0: 6173 7328 5465 6e73 6f72 292e 7370 6563  ass(Tensor).spec
-000104b0: 6961 6c5f 6672 6f6d 2863 7572 5f73 6861  ial_from(cur_sha
-000104c0: 7065 290a 2020 2020 2020 2020 6966 206f  pe).        if o
-000104d0: 7574 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ut is not None:.
-000104e0: 2020 2020 2020 2020 2020 2020 6f75 742e              out.
-000104f0: 7a65 726f 5f28 292e 6164 645f 2869 6e64  zero_().add_(ind
-00010500: 6963 6573 290a 2020 2020 2020 2020 7265  ices).        re
-00010510: 7475 726e 2069 6e64 6963 6573 0a20 2020  turn indices.   
-00010520: 2065 6c73 653a 0a20 2020 2020 2020 2073   else:.        s
-00010530: 656c 6620 3d20 7365 6c66 2e61 735f 7375  elf = self.as_su
-00010540: 6263 6c61 7373 2854 656e 736f 7229 2e73  bclass(Tensor).s
-00010550: 7065 6369 616c 5f66 726f 6d28 6375 725f  pecial_from(cur_
-00010560: 7368 6170 6529 0a20 2020 2020 2020 2073  shape).        s
-00010570: 656c 662e 696e 6469 6365 7320 3d20 696e  elf.indices = in
-00010580: 6469 6365 732e 7370 6563 6961 6c5f 6672  dices.special_fr
-00010590: 6f6d 2866 756e 635f 6469 6d20 2b20 6375  om(func_dim + cu
-000105a0: 725f 7368 6170 6529 2069 6620 696e 6469  r_shape) if indi
-000105b0: 6365 7320 6973 206e 6f74 204e 6f6e 6520  ces is not None 
-000105c0: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
-000105d0: 2020 6966 206c 656e 2864 696d 2920 3d3d    if len(dim) ==
-000105e0: 2031 3a20 7365 6c66 2e69 6e64 6963 6573   1: self.indices
-000105f0: 2e73 7175 6565 7a65 5f28 3029 0a20 2020  .squeeze_(0).   
-00010600: 2020 2020 2023 2069 6e64 6963 6573 5f74       # indices_t
-00010610: 7570 6c65 203d 2069 6e64 6963 6573 2e73  uple = indices.s
-00010620: 7065 6369 616c 5f66 726f 6d28 6375 725f  pecial_from(cur_
-00010630: 7368 6170 6520 2b20 2831 2c29 292e 7370  shape + (1,)).sp
-00010640: 6c69 7428 6469 6d3d 2d31 2c20 7371 7565  lit(dim=-1, sque
-00010650: 657a 6564 696d 3d54 7275 6529 0a20 2020  ezedim=True).   
-00010660: 2020 2020 2023 2073 656c 662e 696e 6469       # self.indi
-00010670: 6365 7320 3d20 696e 6469 6365 735f 7475  ces = indices_tu
-00010680: 706c 6520 6966 206c 656e 2864 696d 2920  ple if len(dim) 
-00010690: 3e20 3120 656c 7365 2069 6e64 6963 6573  > 1 else indices
-000106a0: 5f74 7570 6c65 5b30 5d0a 2020 2020 2020  _tuple[0].      
-000106b0: 2020 7365 6c66 2e76 616c 7565 7320 3d20    self.values = 
-000106c0: 7365 6c66 0a20 2020 2020 2020 2069 6620  self.        if 
-000106d0: 6f75 7420 6973 206e 6f74 204e 6f6e 653a  out is not None:
-000106e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000106f0: 6973 696e 7374 616e 6365 286f 7574 2c20  isinstance(out, 
-00010700: 7475 706c 6529 3a0a 2020 2020 2020 2020  tuple):.        
-00010710: 2020 2020 2020 2020 6f75 745b 305d 2e7a          out[0].z
-00010720: 6572 6f5f 2829 2e61 6464 5f28 7365 6c66  ero_().add_(self
-00010730: 2e76 616c 7565 7329 0a20 2020 2020 2020  .values).       
-00010740: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-00010750: 6f75 7429 203e 2031 3a20 6f75 745b 315d  out) > 1: out[1]
-00010760: 2e7a 6572 6f5f 2829 2e61 6464 5f28 7365  .zero_().add_(se
-00010770: 6c66 2e69 6e64 6963 6573 290a 2020 2020  lf.indices).    
-00010780: 2020 2020 2020 2020 656c 7365 3a20 6f75          else: ou
-00010790: 742e 7a65 726f 5f28 292e 6164 645f 2873  t.zero_().add_(s
-000107a0: 656c 662e 7661 6c75 6573 290a 2020 2020  elf.values).    
-000107b0: 2020 2020 7265 7475 726e 2073 656c 660a      return self.
-000107c0: 0a64 6566 206d 696e 2869 6e70 7574 3a20  .def min(input: 
-000107d0: 2754 656e 736f 7227 2c20 2a64 696d 2c20  'Tensor', *dim, 
-000107e0: 6b65 6570 6469 6d3d 4661 6c73 652c 206f  keepdim=False, o
-000107f0: 7574 3d4e 6f6e 6529 3a0a 2020 2020 7265  ut=None):.    re
-00010800: 7475 726e 205f 5f69 6e64 6578 6564 5f72  turn __indexed_r
-00010810: 6564 7563 655f 5f28 276d 696e 272c 2069  educe__('min', i
-00010820: 6e70 7574 2c20 2a64 696d 2c20 6b65 6570  nput, *dim, keep
-00010830: 6469 6d3d 6b65 6570 6469 6d2c 202a 2a64  dim=keepdim, **d
-00010840: 6963 7428 6f75 743d 6f75 7429 2069 6620  ict(out=out) if 
-00010850: 6c6f 6361 6c73 2829 2e67 6574 2827 6f75  locals().get('ou
-00010860: 7427 2c20 4e6f 6e65 2920 6973 206e 6f74  t', None) is not
-00010870: 204e 6f6e 6520 656c 7365 207b 7d29 2023   None else {}) #
-00010880: 2073 7570 7072 6573 733a 2073 7065 6369   suppress: speci
-00010890: 616c 5f66 726f 6d0a 6465 6620 6d61 7828  al_from.def max(
-000108a0: 696e 7075 743a 2027 5465 6e73 6f72 272c  input: 'Tensor',
-000108b0: 202a 6469 6d2c 206b 6565 7064 696d 3d46   *dim, keepdim=F
-000108c0: 616c 7365 2c20 6f75 743d 4e6f 6e65 293a  alse, out=None):
-000108d0: 0a20 2020 2072 6574 7572 6e20 5f5f 696e  .    return __in
-000108e0: 6465 7865 645f 7265 6475 6365 5f5f 2827  dexed_reduce__('
-000108f0: 6d61 7827 2c20 696e 7075 742c 202a 6469  max', input, *di
-00010900: 6d2c 206b 6565 7064 696d 3d6b 6565 7064  m, keepdim=keepd
-00010910: 696d 2c20 2a2a 6469 6374 286f 7574 3d6f  im, **dict(out=o
-00010920: 7574 2920 6966 206c 6f63 616c 7328 292e  ut) if locals().
-00010930: 6765 7428 276f 7574 272c 204e 6f6e 6529  get('out', None)
-00010940: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
-00010950: 6520 7b7d 2920 2320 7375 7070 7265 7373  e {}) # suppress
-00010960: 3a20 7370 6563 6961 6c5f 6672 6f6d 0a64  : special_from.d
-00010970: 6566 206d 6564 6961 6e28 696e 7075 743a  ef median(input:
-00010980: 2027 5465 6e73 6f72 272c 202a 6469 6d2c   'Tensor', *dim,
-00010990: 206b 6565 7064 696d 3d46 616c 7365 2c20   keepdim=False, 
-000109a0: 6f75 743d 4e6f 6e65 293a 0a20 2020 2072  out=None):.    r
-000109b0: 6574 7572 6e20 5f5f 696e 6465 7865 645f  eturn __indexed_
-000109c0: 7265 6475 6365 5f5f 2827 6d65 6469 616e  reduce__('median
-000109d0: 272c 2069 6e70 7574 2c20 2a64 696d 2c20  ', input, *dim, 
-000109e0: 6b65 6570 6469 6d3d 6b65 6570 6469 6d2c  keepdim=keepdim,
-000109f0: 202a 2a64 6963 7428 6f75 743d 6f75 7429   **dict(out=out)
-00010a00: 2069 6620 6c6f 6361 6c73 2829 2e67 6574   if locals().get
-00010a10: 2827 6f75 7427 2c20 4e6f 6e65 2920 6973  ('out', None) is
-00010a20: 206e 6f74 204e 6f6e 6520 656c 7365 207b   not None else {
-00010a30: 7d29 2023 2073 7570 7072 6573 733a 2073  }) # suppress: s
-00010a40: 7065 6369 616c 5f66 726f 6d0a 6465 6620  pecial_from.def 
-00010a50: 6375 6d6d 696e 2869 6e70 7574 3a20 2754  cummin(input: 'T
-00010a60: 656e 736f 7227 2c20 6469 6d3a 2065 7869  ensor', dim: exi
-00010a70: 7374 5f64 696d 5b31 5d3d 4e6f 6e65 2c20  st_dim[1]=None, 
-00010a80: 2a2c 206f 7574 3d4e 6f6e 6529 3a0a 2020  *, out=None):.  
-00010a90: 2020 7265 7475 726e 205f 5f69 6e64 6578    return __index
-00010aa0: 6564 5f72 6564 7563 655f 5f28 2763 756d  ed_reduce__('cum
-00010ab0: 6d69 6e27 2c20 696e 7075 742c 202a 6469  min', input, *di
-00010ac0: 6d2c 202a 2a64 6963 7428 6f75 743d 6f75  m, **dict(out=ou
-00010ad0: 7429 2069 6620 6c6f 6361 6c73 2829 2e67  t) if locals().g
-00010ae0: 6574 2827 6f75 7427 2c20 4e6f 6e65 2920  et('out', None) 
-00010af0: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
-00010b00: 207b 7d29 2023 2073 7570 7072 6573 733a   {}) # suppress:
-00010b10: 2073 7065 6369 616c 5f66 726f 6d0a 6465   special_from.de
-00010b20: 6620 6375 6d6d 6178 2869 6e70 7574 3a20  f cummax(input: 
-00010b30: 2754 656e 736f 7227 2c20 6469 6d3a 2065  'Tensor', dim: e
-00010b40: 7869 7374 5f64 696d 5b31 5d3d 4e6f 6e65  xist_dim[1]=None
-00010b50: 2c20 2a2c 206f 7574 3d4e 6f6e 6529 3a0a  , *, out=None):.
-00010b60: 2020 2020 7265 7475 726e 205f 5f69 6e64      return __ind
-00010b70: 6578 6564 5f72 6564 7563 655f 5f28 2763  exed_reduce__('c
-00010b80: 756d 6d61 7827 2c20 696e 7075 742c 202a  ummax', input, *
-00010b90: 6469 6d2c 202a 2a64 6963 7428 6f75 743d  dim, **dict(out=
-00010ba0: 6f75 7429 2069 6620 6c6f 6361 6c73 2829  out) if locals()
-00010bb0: 2e67 6574 2827 6f75 7427 2c20 4e6f 6e65  .get('out', None
-00010bc0: 2920 6973 206e 6f74 204e 6f6e 6520 656c  ) is not None el
-00010bd0: 7365 207b 7d29 2023 2073 7570 7072 6573  se {}) # suppres
-00010be0: 733a 2073 7065 6369 616c 5f66 726f 6d0a  s: special_from.
-00010bf0: 6465 6620 6172 676d 696e 2869 6e70 7574  def argmin(input
-00010c00: 3a20 2754 656e 736f 7227 2c20 2a64 696d  : 'Tensor', *dim
-00010c10: 2c20 6b65 6570 6469 6d3d 4661 6c73 6529  , keepdim=False)
-00010c20: 3a0a 2020 2020 7265 7475 726e 205f 5f69  :.    return __i
-00010c30: 6e64 6578 6564 5f72 6564 7563 655f 5f28  ndexed_reduce__(
-00010c40: 276d 696e 272c 2069 6e70 7574 2c20 2a64  'min', input, *d
-00010c50: 696d 2c20 6b65 6570 6469 6d3d 6b65 6570  im, keepdim=keep
-00010c60: 6469 6d2c 2072 6574 5f69 6e64 6578 5f6f  dim, ret_index_o
-00010c70: 6e6c 793d 5472 7565 2920 2320 7375 7070  nly=True) # supp
-00010c80: 7265 7373 3a20 7370 6563 6961 6c5f 6672  ress: special_fr
-00010c90: 6f6d 0a64 6566 2061 7267 6d61 7828 696e  om.def argmax(in
-00010ca0: 7075 743a 2027 5465 6e73 6f72 272c 202a  put: 'Tensor', *
-00010cb0: 6469 6d2c 206b 6565 7064 696d 3d46 616c  dim, keepdim=Fal
-00010cc0: 7365 293a 0a20 2020 2072 6574 7572 6e20  se):.    return 
-00010cd0: 5f5f 696e 6465 7865 645f 7265 6475 6365  __indexed_reduce
-00010ce0: 5f5f 2827 6d61 7827 2c20 696e 7075 742c  __('max', input,
-00010cf0: 202a 6469 6d2c 206b 6565 7064 696d 3d6b   *dim, keepdim=k
-00010d00: 6565 7064 696d 2c20 7265 745f 696e 6465  eepdim, ret_inde
-00010d10: 785f 6f6e 6c79 3d54 7275 6529 2023 2073  x_only=True) # s
-00010d20: 7570 7072 6573 733a 2073 7065 6369 616c  uppress: special
-00010d30: 5f66 726f 6d0a 0a23 2073 6c69 6369 6e67  _from..# slicing
-00010d40: 2066 756e 6374 696f 6e73 0a64 6566 2073   functions.def s
-00010d50: 706c 6974 2873 656c 662c 2073 706c 6974  plit(self, split
-00010d60: 5f73 697a 653a 2069 6e74 3d31 2c20 6469  _size: int=1, di
-00010d70: 6d3a 2065 7869 7374 5f64 696d 5b31 5d20  m: exist_dim[1] 
-00010d80: 3d20 7b7d 2c20 7371 7565 657a 6564 696d  = {}, squeezedim
-00010d90: 3d46 616c 7365 293a 0a20 2020 2022 2222  =False):.    """
-00010da0: 0a20 2020 2073 706c 6974 2873 656c 662c  .    split(self,
-00010db0: 2073 706c 6974 5f73 697a 653a 2069 6e74   split_size: int
-00010dc0: 3d31 2c20 6469 6d3a 2065 7869 7374 5f64  =1, dim: exist_d
-00010dd0: 696d 203d 207b 7d29 202d 3e20 5465 6e73  im = {}) -> Tens
-00010de0: 6f72 0a20 2020 2053 706c 6974 2061 2074  or.    Split a t
-00010df0: 656e 736f 7220 696e 746f 2061 2074 7570  ensor into a tup
-00010e00: 6c65 206f 6620 7465 6e73 6f72 732c 2061  le of tensors, a
-00010e10: 6c6f 6e67 2060 6469 6d60 2c20 7769 7468  long `dim`, with
-00010e20: 2073 706c 6974 5f73 697a 6520 666f 7220   split_size for 
-00010e30: 6561 6368 2074 656e 736f 722e 0a0a 2020  each tensor...  
-00010e40: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-00010e50: 7370 6c69 745f 7369 7a65 2028 696e 7420  split_size (int 
-00010e60: 6f72 206c 6973 742c 206f 7074 696f 6e61  or list, optiona
-00010e70: 6c29 3a20 5468 6520 7370 6c69 7420 7369  l): The split si
-00010e80: 7a65 2066 6f72 2065 6163 6820 7465 6e73  ze for each tens
-00010e90: 6f72 2c20 7573 696e 6720 6120 6c69 7374  or, using a list
-00010ea0: 206f 6620 696e 7465 6765 7273 2061 6464   of integers add
-00010eb0: 696e 6720 7570 2074 6f20 7369 7a65 2074  ing up to size t
-00010ec0: 6f20 7370 6c69 7420 7468 6520 6469 6d65  o split the dime
-00010ed0: 6e73 696f 6e20 6163 636f 7264 696e 676c  nsion accordingl
-00010ee0: 792e 2044 6566 6175 6c74 7320 746f 2031  y. Defaults to 1
-00010ef0: 2e0a 2020 2020 2020 2020 6469 6d20 2869  ..        dim (i
-00010f00: 6e74 2f65 7869 7374 5f64 696d 2c20 6f70  nt/exist_dim, op
-00010f10: 7469 6f6e 616c 293a 2054 6865 2064 696d  tional): The dim
-00010f20: 656e 7369 6f6e 2074 6f20 7370 6c69 7420  ension to split 
-00010f30: 616c 6f6e 672e 2044 6566 6175 6c74 7320  along. Defaults 
-00010f40: 746f 2062 6174 6368 2e0a 2020 2020 2222  to batch..    ""
-00010f50: 220a 2020 2020 6469 6d20 3d20 6469 6d5b  ".    dim = dim[
-00010f60: 305d 0a20 2020 2077 6974 6820 746f 7263  0].    with torc
-00010f70: 682e 5f43 2e44 6973 6162 6c65 546f 7263  h._C.DisableTorc
-00010f80: 6846 756e 6374 696f 6e28 293a 0a20 2020  hFunction():.   
-00010f90: 2020 2020 2069 6620 7371 7565 657a 6564       if squeezed
-00010fa0: 696d 3a0a 2020 2020 2020 2020 2020 2020  im:.            
-00010fb0: 6176 6f75 6368 2873 706c 6974 5f73 697a  avouch(split_siz
-00010fc0: 6520 3d3d 2031 206f 7220 616c 6c5f 2873  e == 1 or all_(s
-00010fd0: 203d 3d20 3120 666f 7220 7320 696e 2073   == 1 for s in s
-00010fe0: 706c 6974 5f73 697a 6529 2c20 5479 7065  plit_size), Type
-00010ff0: 4572 726f 7228 224b 6579 776f 7264 2061  Error("Keyword a
-00011000: 7267 756d 656e 7420 2773 7175 6565 7a65  rgument 'squeeze
-00011010: 6469 6d27 2069 7320 6f6e 6c79 2061 6374  dim' is only act
-00011020: 6976 6520 666f 7220 2773 706c 6974 5f73  ive for 'split_s
-00011030: 697a 653d 3127 2069 6e20 6274 2e54 656e  ize=1' in bt.Ten
-00011040: 736f 722e 7370 6c69 742e 2022 2929 0a20  sor.split. ")). 
-00011050: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00011060: 6e20 7475 706c 6528 782e 6173 5f73 7562  n tuple(x.as_sub
-00011070: 636c 6173 7328 5465 6e73 6f72 292e 7370  class(Tensor).sp
-00011080: 6563 6961 6c5f 6672 6f6d 2873 656c 6629  ecial_from(self)
-00011090: 2e73 7175 6565 7a65 5f28 6469 6d29 2066  .squeeze_(dim) f
-000110a0: 6f72 2078 2069 6e20 746f 7263 685f 7375  or x in torch_su
-000110b0: 7065 7228 7365 6c66 2c20 2773 706c 6974  per(self, 'split
-000110c0: 2729 2873 706c 6974 5f73 697a 652c 2064  ')(split_size, d
-000110d0: 696d 2929 0a20 2020 2020 2020 2065 6c73  im)).        els
-000110e0: 653a 2072 6574 7572 6e20 7475 706c 6528  e: return tuple(
-000110f0: 782e 6173 5f73 7562 636c 6173 7328 5465  x.as_subclass(Te
-00011100: 6e73 6f72 292e 7370 6563 6961 6c5f 6672  nsor).special_fr
-00011110: 6f6d 2873 656c 6629 2066 6f72 2078 2069  om(self) for x i
-00011120: 6e20 746f 7263 685f 7375 7065 7228 7365  n torch_super(se
-00011130: 6c66 2c20 2773 706c 6974 2729 2873 706c  lf, 'split')(spl
-00011140: 6974 5f73 697a 652c 2064 696d 2929 0a0a  it_size, dim))..
-00011150: 6465 6620 7361 6d70 6c65 2873 656c 662c  def sample(self,
-00011160: 206e 756d 6265 723a 2069 6e74 203d 2031   number: int = 1
-00011170: 2c20 6469 6d3a 2065 7869 7374 5f64 696d  , dim: exist_dim
-00011180: 203d 207b 7d2c 2072 616e 646f 6d3a 2062   = {}, random: b
-00011190: 6f6f 6c20 3d20 5472 7565 293a 0a20 2020  ool = True):.   
-000111a0: 2022 2222 0a20 2020 2073 616d 706c 6528   """.    sample(
-000111b0: 7365 6c66 2c20 6e75 6d62 6465 723a 2069  self, numbder: i
-000111c0: 6e74 203d 2031 2c20 6469 6d3a 2069 6e74  nt = 1, dim: int
-000111d0: 203d 2073 656c 662e 6261 7463 685f 6469   = self.batch_di
-000111e0: 6d65 6e73 696f 6e2c 2072 616e 646f 6d3a  mension, random:
-000111f0: 2062 6f6f 6c20 3d20 5472 7565 2920 2d3e   bool = True) ->
-00011200: 2054 656e 736f 720a 0a20 2020 2053 616d   Tensor..    Sam
-00011210: 706c 6520 606e 756d 6265 7260 206f 6620  ple `number` of 
-00011220: 736c 6963 6573 2066 726f 6d20 6120 6769  slices from a gi
-00011230: 7665 6e20 6469 6d65 6e73 696f 6e2e 0a20  ven dimension.. 
-00011240: 2020 200a 2020 2020 4172 6773 3a0a 2020     .    Args:.  
-00011250: 2020 2020 2020 6e75 6d62 6572 2028 696e        number (in
-00011260: 742c 206f 7074 696f 6e61 6c29 3a20 7468  t, optional): th
-00011270: 6520 6e75 6d62 6572 206f 6620 736c 6963  e number of slic
-00011280: 6573 2e20 4465 6661 756c 7473 2074 6f20  es. Defaults to 
-00011290: 6031 602e 0a20 2020 2020 2020 2064 696d  `1`..        dim
-000112a0: 2028 696e 742f 6578 6973 745f 6469 6d2c   (int/exist_dim,
-000112b0: 206b 6579 776f 7264 2061 7267 756d 656e   keyword argumen
-000112c0: 7429 3a20 7468 6520 6469 6d65 6e73 696f  t): the dimensio
-000112d0: 6e20 746f 2073 6c69 6365 206f 7220 7365  n to slice or se
-000112e0: 6c65 6374 2e20 4465 6661 756c 7473 2074  lect. Defaults t
-000112f0: 6f20 6261 7463 6820 6469 6d65 6e73 696f  o batch dimensio
-00011300: 6e2e 0a20 2020 2020 2020 2072 616e 646f  n..        rando
-00011310: 6d20 2862 6f6f 6c2c 206f 7074 696f 6e61  m (bool, optiona
-00011320: 6c29 3a20 7768 6574 6865 7220 746f 2072  l): whether to r
-00011330: 616e 646f 6d6c 7920 7069 636b 2074 6865  andomly pick the
-00011340: 2073 6c69 6365 7320 6f72 206e 6f74 2e20   slices or not. 
-00011350: 4465 6661 756c 7473 2074 6f20 5472 7565  Defaults to True
-00011360: 2e0a 2020 2020 0a20 2020 204e 6f74 653a  ..    .    Note:
-00011370: 0a20 2020 2020 2020 2055 7369 6e67 2060  .        Using `
-00011380: 7361 6d70 6c65 286e 756d 2c20 6469 6d29  sample(num, dim)
-00011390: 6020 666f 7220 6461 7461 206f 6620 7369  ` for data of si
-000113a0: 7a65 2028 6e5f 312c 206e 5f32 2c20 2e2e  ze (n_1, n_2, ..
-000113b0: 2e2c 206e 5f72 2920 776f 756c 6420 7265  ., n_r) would re
-000113c0: 7375 6c74 2069 6e0a 2020 2020 2020 2020  sult in.        
-000113d0: 2020 2020 6120 7465 6e73 6f72 206f 6620      a tensor of 
-000113e0: 7369 7a65 2028 6e5f 312c 206e 5f32 2c20  size (n_1, n_2, 
-000113f0: 2e2e 2e2c 206e 5f7b 6469 6d2d 317d 2c20  ..., n_{dim-1}, 
-00011400: 6e75 6d2c 206e 5f7b 6469 6d2b 317d 2c20  num, n_{dim+1}, 
-00011410: 2e2e 2e2c 206e 5f72 290a 2020 2020 0a20  ..., n_r).    . 
-00011420: 2020 2045 7861 6d70 6c65 733a 3a0a 2020     Examples::.  
-00011430: 2020 2020 2020 3e3e 3e20 6461 7461 2e73        >>> data.s
-00011440: 6861 7065 0a20 2020 2020 2020 2062 6174  hape.        bat
-00011450: 6f72 6368 2e53 697a 6528 5b34 2c20 335d  orch.Size([4, 3]
-00011460: 2c20 352c 2036 290a 2020 2020 2020 2020  , 5, 6).        
-00011470: 3e3e 3e20 6461 7461 2e73 616d 706c 6528  >>> data.sample(
-00011480: 312c 2032 2c20 7261 6e64 6f6d 3d46 616c  1, 2, random=Fal
-00011490: 7365 292e 7368 6170 650a 2020 2020 2020  se).shape.      
-000114a0: 2020 6261 746f 7263 682e 5369 7a65 285b    batorch.Size([
-000114b0: 342c 2033 5d2c 2031 2c20 3629 0a20 2020  4, 3], 1, 6).   
-000114c0: 2020 2020 203e 3e3e 2023 2054 6865 2061       >>> # The a
-000114d0: 626f 7665 2069 7320 6571 7569 7661 6c61  bove is equivala
-000114e0: 6e74 2074 6f20 6461 7461 5b3a 2c20 3a2c  nt to data[:, :,
-000114f0: 203a 312c 202e 2e2e 5d2e 7368 6170 652e   :1, ...].shape.
-00011500: 0a20 2020 2020 2020 203e 3e3e 2064 6174  .        >>> dat
-00011510: 612e 7361 6d70 6c65 2837 2c20 5b5d 2c20  a.sample(7, [], 
-00011520: 7261 6e64 6f6d 3d46 616c 7365 292e 7368  random=False).sh
-00011530: 6170 650a 2020 2020 2020 2020 6261 746f  ape.        bato
-00011540: 7263 682e 5369 7a65 2837 2c20 352c 2036  rch.Size(7, 5, 6
-00011550: 290a 2020 2020 2020 2020 3e3e 3e20 2320  ).        >>> # 
-00011560: 5468 6520 6162 6f76 6520 6973 2065 7175  The above is equ
-00011570: 6976 616c 616e 7420 746f 2064 6174 612e  ivalant to data.
-00011580: 666c 6174 7465 6e28 302c 2031 295b 3a37  flatten(0, 1)[:7
-00011590: 5d2e 7368 6170 652e 0a20 2020 2022 2222  ].shape..    """
-000115a0: 0a20 2020 2069 6620 6c65 6e28 6469 6d29  .    if len(dim)
-000115b0: 203e 2031 3a20 7365 6c66 203d 2073 656c   > 1: self = sel
-000115c0: 662e 6d65 7267 655f 6469 6d73 282a 6469  f.merge_dims(*di
-000115d0: 6d2c 2074 6172 6765 743d 6469 6d5b 305d  m, target=dim[0]
-000115e0: 290a 2020 2020 7361 6d70 6c65 5f69 6e64  ).    sample_ind
-000115f0: 6963 6573 203d 205b 736c 6963 6528 4e6f  ices = [slice(No
-00011600: 6e65 295d 202a 2073 656c 662e 6e5f 6469  ne)] * self.n_di
-00011610: 6d0a 2020 2020 6469 6d20 3d20 6469 6d5b  m.    dim = dim[
-00011620: 305d 0a20 2020 2069 6620 7261 6e64 6f6d  0].    if random
-00011630: 3a0a 2020 2020 2020 2020 696d 706f 7274  :.        import
-00011640: 2072 616e 646f 6d0a 2020 2020 2020 2020   random.        
-00011650: 6e5f 746f 7461 6c20 3d20 7365 6c66 2e73  n_total = self.s
-00011660: 697a 6528 6469 6d29 0a20 2020 2020 2020  ize(dim).       
-00011670: 206e 5f72 6f75 6e64 203d 206e 756d 6265   n_round = numbe
-00011680: 7220 2f2f 206e 5f74 6f74 616c 0a20 2020  r // n_total.   
-00011690: 2020 2020 206e 5f72 656d 6169 6e20 3d20       n_remain = 
-000116a0: 6e75 6d62 6572 2025 206e 5f74 6f74 616c  number % n_total
-000116b0: 0a20 2020 2020 2020 2073 616d 706c 6573  .        samples
-000116c0: 203d 2063 6174 2872 616e 6470 6572 6d28   = cat(randperm(
-000116d0: 7b6e 5f72 6f75 6e64 7d2c 206e 5f74 6f74  {n_round}, n_tot
-000116e0: 616c 2c20 6465 7669 6365 3d73 656c 662e  al, device=self.
-000116f0: 6465 7669 6365 292e 666c 6174 7465 6e28  device).flatten(
-00011700: 292e 7669 6577 282d 3129 2c20 7465 6e73  ).view(-1), tens
-00011710: 6f72 2872 616e 646f 6d2e 7361 6d70 6c65  or(random.sample
-00011720: 2872 616e 6765 5f28 6e5f 746f 7461 6c29  (range_(n_total)
-00011730: 2c20 6b20 3d20 6e5f 7265 6d61 696e 292c  , k = n_remain),
-00011740: 2064 6576 6963 653d 7365 6c66 2e64 6576   device=self.dev
-00011750: 6963 6529 2c20 3029 0a20 2020 2065 6c73  ice), 0).    els
-00011760: 653a 0a20 2020 2020 2020 2061 766f 7563  e:.        avouc
-00011770: 6828 6e75 6d62 6572 203c 3d20 7365 6c66  h(number <= self
-00011780: 2e73 697a 6528 6469 6d29 2c20 5479 7065  .size(dim), Type
-00011790: 4572 726f 7228 6622 546f 6f20 6d61 6e79  Error(f"Too many
-000117a0: 2065 6c65 6d65 6e74 7320 6e65 6564 6564   elements needed
-000117b0: 2074 6f20 6265 2073 616d 706c 6564 2066   to be sampled f
-000117c0: 726f 6d20 6469 6d65 6e73 696f 6e20 7b64  rom dimension {d
-000117d0: 696d 7d22 2929 0a20 2020 2020 2020 2073  im}")).        s
-000117e0: 616d 706c 6573 203d 2074 656e 736f 7228  amples = tensor(
-000117f0: 7261 6e67 655f 286e 756d 6265 7229 290a  range_(number)).
-00011800: 2020 2020 7361 6d70 6c65 5f69 6e64 6963      sample_indic
-00011810: 6573 5b64 696d 5d20 3d20 7361 6d70 6c65  es[dim] = sample
-00011820: 732e 7370 6563 6961 6c5f 6672 6f6d 2873  s.special_from(s
-00011830: 656c 662e 7368 6170 655b 6469 6d3a 6469  elf.shape[dim:di
-00011840: 6d2b 315d 290a 2020 2020 7265 7475 726e  m+1]).    return
-00011850: 2073 656c 665b 7475 706c 6528 7361 6d70   self[tuple(samp
-00011860: 6c65 5f69 6e64 6963 6573 295d 2023 2073  le_indices)] # s
-00011870: 7570 7072 6573 733a 2073 7065 6369 616c  uppress: special
-00011880: 5f66 726f 6d0a 0a64 6566 2070 6963 6b28  _from..def pick(
-00011890: 7365 6c66 2c20 696e 6465 783a 2069 6e74  self, index: int
-000118a0: 203d 204e 6f6e 652c 2064 696d 3a20 6578   = None, dim: ex
-000118b0: 6973 745f 6469 6d20 3d20 7b7d 2c20 7261  ist_dim = {}, ra
-000118c0: 6e64 6f6d 3a20 626f 6f6c 203d 2046 616c  ndom: bool = Fal
-000118d0: 7365 293a 0a20 2020 2022 2222 0a20 2020  se):.    """.   
-000118e0: 2070 6963 6b28 7365 6c66 2c20 696e 6465   pick(self, inde
-000118f0: 783a 2069 6e74 203d 2030 2c20 6469 6d3a  x: int = 0, dim:
-00011900: 2069 6e74 203d 2073 656c 662e 6261 7463   int = self.batc
-00011910: 685f 6469 6d65 6e73 696f 6e2c 2072 616e  h_dimension, ran
-00011920: 646f 6d3a 2062 6f6f 6c20 3d20 4661 6c73  dom: bool = Fals
-00011930: 6529 202d 3e20 5465 6e73 6f72 0a0a 2020  e) -> Tensor..  
-00011940: 2020 5069 636b 206f 6e65 2073 6c69 6365    Pick one slice
-00011950: 206f 6e20 6469 6d65 6e73 696f 6e20 6064   on dimension `d
-00011960: 696d 6020 666f 7220 6269 6720 7465 6e73  im` for big tens
-00011970: 6f72 732e 200a 2020 2020 0a20 2020 2041  ors. .    .    A
-00011980: 7267 733a 0a20 2020 2020 2020 2069 6e64  rgs:.        ind
-00011990: 6578 2028 696e 742c 206f 7074 696f 6e61  ex (int, optiona
-000119a0: 6c29 3a20 7468 6520 736c 6963 6520 696e  l): the slice in
-000119b0: 6465 7820 746f 2070 6963 6b2e 2044 6566  dex to pick. Def
-000119c0: 6175 6c74 7320 746f 2060 4e6f 6e65 602e  aults to `None`.
-000119d0: 0a20 2020 2020 2020 2064 696d 2028 696e  .        dim (in
-000119e0: 742f 6578 6973 745f 6469 6d2c 206b 6579  t/exist_dim, key
-000119f0: 776f 7264 2061 7267 756d 656e 7429 3a20  word argument): 
-00011a00: 7468 6520 6469 6d65 6e73 696f 6e20 746f  the dimension to
-00011a10: 2073 6c69 6365 206f 7220 7365 6c65 6374   slice or select
-00011a20: 2e20 4465 6661 756c 7473 2074 6f20 6261  . Defaults to ba
-00011a30: 7463 6820 6469 6d65 6e73 696f 6e2e 0a20  tch dimension.. 
-00011a40: 2020 2020 2020 2072 616e 646f 6d20 2862         random (b
-00011a50: 6f6f 6c2c 206f 7074 696f 6e61 6c29 3a20  ool, optional): 
-00011a60: 7768 6574 6865 7220 746f 2072 616e 646f  whether to rando
-00011a70: 6d6c 7920 7069 636b 2074 6865 2073 6c69  mly pick the sli
-00011a80: 6365 206f 7220 6e6f 742e 2044 6566 6175  ce or not. Defau
-00011a90: 6c74 7320 746f 2046 616c 7365 2e0a 2020  lts to False..  
-00011aa0: 2020 0a20 2020 204e 6f74 653a 0a20 2020    .    Note:.   
-00011ab0: 2020 2020 2055 7369 6e67 2060 7069 636b       Using `pick
-00011ac0: 2869 6e64 6578 2c20 6469 6d29 6020 666f  (index, dim)` fo
-00011ad0: 7220 6461 7461 206f 6620 7369 7a65 2028  r data of size (
-00011ae0: 6e5f 312c 206e 5f32 2c20 2e2e 2e2c 206e  n_1, n_2, ..., n
-00011af0: 5f72 2920 776f 756c 6420 7265 7375 6c74  _r) would result
-00011b00: 2069 6e0a 2020 2020 2020 2020 2020 2020   in.            
-00011b10: 6120 7465 6e73 6f72 206f 6620 7369 7a65  a tensor of size
-00011b20: 2028 6e5f 312c 206e 5f32 2c20 2e2e 2e2c   (n_1, n_2, ...,
-00011b30: 206e 5f7b 6469 6d2d 317d 2c20 6e5f 7b64   n_{dim-1}, n_{d
-00011b40: 696d 2b31 7d2c 202e 2e2e 2c20 6e5f 7229  im+1}, ..., n_r)
-00011b50: 0a20 2020 200a 2020 2020 4578 616d 706c  .    .    Exampl
-00011b60: 6573 3a3a 0a20 2020 2020 2020 203e 3e3e  es::.        >>>
-00011b70: 2064 6174 612e 7368 6170 650a 2020 2020   data.shape.    
-00011b80: 2020 2020 6261 746f 7263 682e 5369 7a65      batorch.Size
-00011b90: 2834 2c20 332c 2035 2c20 3629 0a20 2020  (4, 3, 5, 6).   
-00011ba0: 2020 2020 203e 3e3e 2064 6174 612e 7069       >>> data.pi
-00011bb0: 636b 282d 312c 2032 2c20 7261 6e64 6f6d  ck(-1, 2, random
-00011bc0: 3d46 616c 7365 292e 7368 6170 650a 2020  =False).shape.  
-00011bd0: 2020 2020 2020 6261 746f 7263 682e 5369        batorch.Si
-00011be0: 7a65 2834 2c20 332c 2036 290a 2020 2020  ze(4, 3, 6).    
-00011bf0: 2020 2020 3e3e 3e20 2320 5468 6520 6162      >>> # The ab
-00011c00: 6f76 6520 6973 2065 7175 6976 616c 616e  ove is equivalan
-00011c10: 7420 746f 2064 6174 615b 3a2c 203a 2c20  t to data[:, :, 
-00011c20: 342c 202e 2e2e 5d2e 7368 6170 652e 0a20  4, ...].shape.. 
-00011c30: 2020 2022 2222 0a20 2020 2069 6620 6c65     """.    if le
-00011c40: 6e28 6469 6d29 203e 2031 3a20 7365 6c66  n(dim) > 1: self
-00011c50: 203d 2073 656c 662e 6d65 7267 655f 6469   = self.merge_di
-00011c60: 6d73 282a 6469 6d2c 2074 6172 6765 743d  ms(*dim, target=
-00011c70: 6469 6d5b 305d 290a 2020 2020 6469 6d20  dim[0]).    dim 
-00011c80: 3d20 6469 6d5b 305d 0a20 2020 2069 6620  = dim[0].    if 
-00011c90: 7261 6e64 6f6d 3a0a 2020 2020 2020 2020  random:.        
-00011ca0: 6176 6f75 6368 2869 6e64 6578 2069 7320  avouch(index is 
-00011cb0: 4e6f 6e65 2c20 2227 696e 6465 7827 2073  None, "'index' s
-00011cc0: 686f 756c 6420 6265 204e 6f6e 6520 6966  hould be None if
-00011cd0: 2072 616e 646f 6d20 7069 636b 2069 7320   random pick is 
-00011ce0: 656e 6162 6c65 642e 2055 7365 206b 6579  enabled. Use key
-00011cf0: 776f 7264 2061 7267 756d 656e 7420 2764  word argument 'd
-00011d00: 696d 3d78 7827 2074 6f20 6964 656e 7469  im=xx' to identi
-00011d10: 6679 2074 6865 2064 696d 656e 7369 6f6e  fy the dimension
-00011d20: 2e22 290a 2020 2020 2020 2020 696d 706f  .").        impo
-00011d30: 7274 2072 616e 646f 6d0a 2020 2020 2020  rt random.      
-00011d40: 2020 696e 6465 7820 3d20 7261 6e64 6f6d    index = random
-00011d50: 2e72 616e 6469 6e74 2830 2c20 7365 6c66  .randint(0, self
-00011d60: 2e73 697a 6528 6469 6d29 2d31 290a 2020  .size(dim)-1).  
-00011d70: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00011d80: 6176 6f75 6368 2869 7369 6e73 7461 6e63  avouch(isinstanc
-00011d90: 6528 696e 6465 782c 2069 6e74 5f29 2061  e(index, int_) a
-00011da0: 6e64 202d 7365 6c66 2e73 697a 6528 6469  nd -self.size(di
-00011db0: 6d29 203c 3d20 696e 6465 7820 3c20 7365  m) <= index < se
-00011dc0: 6c66 2e73 697a 6528 6469 6d29 2c20 5479  lf.size(dim), Ty
-00011dd0: 7065 4572 726f 7228 6622 496e 7661 6c69  peError(f"Invali
-00011de0: 6420 696e 6465 7820 666f 7220 7069 636b  d index for pick
-00011df0: 696e 6720 6672 6f6d 2064 696d 656e 7369  ing from dimensi
-00011e00: 6f6e 207b 6469 6d7d 3a20 7b69 6e64 6578  on {dim}: {index
-00011e10: 7d2e 2022 2929 0a20 2020 2072 6574 7572  }. ")).    retur
-00011e20: 6e20 7365 6c66 5b28 736c 6963 6528 4e6f  n self[(slice(No
-00011e30: 6e65 292c 2920 2a20 6469 6d20 2b20 2869  ne),) * dim + (i
-00011e40: 6e64 6578 2c29 5d20 2320 7375 7070 7265  ndex,)] # suppre
-00011e50: 7373 3a20 7370 6563 6961 6c5f 6672 6f6d  ss: special_from
-00011e60: 0a0a 6465 6620 6569 6728 696e 7075 743a  ..def eig(input:
-00011e70: 2027 5465 6e73 6f72 272c 2064 696d 3a20   'Tensor', dim: 
-00011e80: 6c69 6e61 6c67 5f64 696d 5b32 5d3d 4e6f  linalg_dim[2]=No
-00011e90: 6e65 2c20 6f75 743d 4e6f 6e65 293a 0a20  ne, out=None):. 
-00011ea0: 2020 2022 2222 0a20 2020 2046 696e 6420     """.    Find 
-00011eb0: 6569 6765 6e20 7661 6c75 6573 2061 6e64  eigen values and
-00011ec0: 2076 6563 746f 7273 2066 6f72 206d 6174   vectors for mat
-00011ed0: 7269 7820 6069 6e70 7574 603a 2028 666f  rix `input`: (fo
-00011ee0: 7220 7468 6520 6669 7273 7420 6176 6169  r the first avai
-00011ef0: 6c61 626c 6520 636f 6e64 6974 696f 6e29  lable condition)
-00011f00: 3a0a 2020 2020 2831 2920 696e 2066 6561  :.    (1) in fea
-00011f10: 7475 7265 2064 696d 656e 7369 6f6e 7320  ture dimensions 
-00011f20: 6966 206d 6f72 6520 7468 616e 2032 4420  if more than 2D 
-00011f30: 6973 2061 7661 696c 6162 6c65 3b20 0a20  is available; . 
-00011f40: 2020 2028 3229 2069 6e20 7370 6163 6520     (2) in space 
-00011f50: 6469 6d65 6e73 696f 6e73 2069 6620 6d6f  dimensions if mo
-00011f60: 7265 2074 6861 6e20 3244 2069 7320 6176  re than 2D is av
-00011f70: 6169 6c61 626c 653b 200a 2020 2020 2833  ailable; .    (3
-00011f80: 2920 696e 2073 6571 7565 6e63 6520 6469  ) in sequence di
-00011f90: 6d65 6e73 696f 6e73 2069 6620 6d6f 7265  mensions if more
-00011fa0: 2074 6861 6e20 3244 2069 7320 6176 6169   than 2D is avai
-00011fb0: 6c61 626c 652e 200a 2020 2020 2222 220a  lable. .    """.
-00011fc0: 2020 2020 7769 7468 2069 6e70 7574 2e68      with input.h
-00011fd0: 6964 655f 7370 6563 6961 6c28 292c 2074  ide_special(), t
-00011fe0: 6f72 6368 2e5f 432e 4469 7361 626c 6554  orch._C.DisableT
-00011ff0: 6f72 6368 4675 6e63 7469 6f6e 2829 3a0a  orchFunction():.
-00012000: 2020 2020 2020 2020 4120 3d20 696e 7075          A = inpu
-00012010: 742e 6d6f 7665 5f64 696d 2864 696d 2c20  t.move_dim(dim, 
-00012020: 2d31 292e 666c 6174 7465 6e28 302c 202d  -1).flatten(0, -
-00012030: 3329 0a20 2020 2020 2020 2069 6620 746f  3).        if to
-00012040: 7263 682e 5f5f 7665 7273 696f 6e5f 5f20  rch.__version__ 
-00012050: 3e3d 2056 6572 7369 6f6e 2827 312e 3130  >= Version('1.10
-00012060: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00012070: 4c2c 2056 203d 2074 6f72 6368 2e6c 696e  L, V = torch.lin
-00012080: 616c 672e 6569 6728 4129 0a20 2020 2020  alg.eig(A).     
-00012090: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000120a0: 2020 2020 204b 2c20 5020 3d20 746f 7263       K, P = torc
-000120b0: 682e 6569 6728 412c 2065 6967 656e 7665  h.eig(A, eigenve
-000120c0: 6374 6f72 733d 5472 7565 290a 2020 2020  ctors=True).    
-000120d0: 2020 2020 2020 2020 4c20 3d20 746f 7263          L = torc
-000120e0: 682e 636f 6d70 6c65 7828 4b5b 3a2c 2030  h.complex(K[:, 0
-000120f0: 5d2c 204b 5b3a 2c20 315d 290a 2020 2020  ], K[:, 1]).    
-00012100: 2020 2020 2020 2020 5672 203d 2074 6f72          Vr = tor
-00012110: 6368 2e77 6865 7265 2828 4b5b 3a2c 2031  ch.where((K[:, 1
-00012120: 5d20 3c20 3029 2e72 6573 6861 7065 2828  ] < 0).reshape((
-00012130: 312c 202d 3129 292c 2074 6f72 6368 2e63  1, -1)), torch.c
-00012140: 6174 2828 505b 3a2c 203a 315d 2c20 505b  at((P[:, :1], P[
-00012150: 3a2c 203a 2d31 5d29 2c20 3129 2c20 5029  :, :-1]), 1), P)
-00012160: 0a20 2020 2020 2020 2020 2020 2056 6920  .            Vi 
-00012170: 3d20 284b 5b3a 2c20 315d 203e 2030 292e  = (K[:, 1] > 0).
-00012180: 7265 7368 6170 6528 2831 2c20 2d31 2929  reshape((1, -1))
-00012190: 202a 2074 6f72 6368 2e63 6174 2828 505b   * torch.cat((P[
-000121a0: 3a2c 2031 3a5d 2c20 505b 3a2c 202d 313a  :, 1:], P[:, -1:
-000121b0: 5d29 2c20 3129 202d 2028 4b5b 3a2c 2031  ]), 1) - (K[:, 1
-000121c0: 5d20 3c20 3029 2e72 6573 6861 7065 2828  ] < 0).reshape((
-000121d0: 312c 202d 3129 2920 2a20 500a 2020 2020  1, -1)) * P.    
-000121e0: 2020 2020 2020 2020 5620 3d20 746f 7263          V = torc
-000121f0: 682e 636f 6d70 6c65 7828 5672 2c20 5669  h.complex(Vr, Vi
-00012200: 290a 2020 2020 2020 2020 4c20 3d20 4c2e  ).        L = L.
-00012210: 6173 5f73 7562 636c 6173 7328 5465 6e73  as_subclass(Tens
-00012220: 6f72 292e 696e 6974 5f73 7065 6369 616c  or).init_special
-00012230: 2829 0a20 2020 2020 2020 2056 203d 2056  ().        V = V
-00012240: 2e61 735f 7375 6263 6c61 7373 2854 656e  .as_subclass(Ten
-00012250: 736f 7229 2e69 6e69 745f 7370 6563 6961  sor).init_specia
-00012260: 6c28 290a 2020 2020 6469 6d5f 7479 7065  l().    dim_type
-00012270: 203d 2069 6e70 7574 2e73 6861 7065 5b64   = input.shape[d
-00012280: 696d 5b30 5d3a 6469 6d5b 305d 2b31 5d0a  im[0]:dim[0]+1].
-00012290: 2020 2020 4c20 3d20 4c2e 7370 6c69 745f      L = L.split_
-000122a0: 6469 6d28 302c 2072 656d 6f76 655f 6469  dim(0, remove_di
-000122b0: 6d28 696e 7075 742e 7368 6170 652c 2064  m(input.shape, d
-000122c0: 696d 2929 0a20 2020 2056 203d 2056 2e73  im)).    V = V.s
-000122d0: 706c 6974 5f64 696d 2830 2c20 7265 6d6f  plit_dim(0, remo
-000122e0: 7665 5f64 696d 2869 6e70 7574 2e73 6861  ve_dim(input.sha
-000122f0: 7065 2c20 6469 6d29 290a 2020 2020 4c20  pe, dim)).    L 
-00012300: 3d20 4c2e 6d6f 7665 5f64 696d 282d 312c  = L.move_dim(-1,
-00012310: 2064 696d 5b30 5d29 2e61 6464 5f73 7065   dim[0]).add_spe
-00012320: 6369 616c 5f64 696d 2864 696d 5b30 5d2c  cial_dim(dim[0],
-00012330: 2064 696d 5f74 7970 6529 0a20 2020 2056   dim_type).    V
-00012340: 203d 2056 2e6d 6f76 655f 6469 6d28 5b2d   = V.move_dim([-
-00012350: 322c 202d 315d 2c20 6469 6d29 2e61 6464  2, -1], dim).add
-00012360: 5f73 7065 6369 616c 5f64 696d 2864 696d  _special_dim(dim
-00012370: 5b30 5d2c 2064 696d 5f74 7970 6529 2e61  [0], dim_type).a
-00012380: 6464 5f73 7065 6369 616c 5f64 696d 2864  dd_special_dim(d
-00012390: 696d 5b30 5d2b 312c 2064 696d 5f74 7970  im[0]+1, dim_typ
-000123a0: 6529 0a20 2020 2072 6574 7572 6e20 4c2c  e).    return L,
-000123b0: 2056 2023 2073 7570 7072 6573 733a 2073   V # suppress: s
-000123c0: 7065 6369 616c 5f66 726f 6d0a 0a64 6566  pecial_from..def
-000123d0: 206d 6174 6d75 6c28 696e 7075 743a 2027   matmul(input: '
-000123e0: 5465 6e73 6f72 272c 206f 7468 6572 3a20  Tensor', other: 
-000123f0: 2754 656e 736f 7227 2c20 2a2c 2064 696d  'Tensor', *, dim
-00012400: 313d 4e6f 6e65 2c20 6469 6d32 3d4e 6f6e  1=None, dim2=Non
-00012410: 652c 206f 7574 3d4e 6f6e 6529 3a0a 2020  e, out=None):.  
-00012420: 2020 2222 2270 6572 666f 726d 206d 6174    """perform mat
-00012430: 6d75 6c20 666f 7220 7468 6520 6265 7374  mul for the best
-00012440: 206c 696e 6561 7220 6469 6d65 6e73 696f   linear dimensio
-00012450: 6e73 2c20 6a75 7374 6c69 6b65 206f 7468  ns, justlike oth
-00012460: 6572 206d 6174 2a2a 2066 756e 6374 696f  er mat** functio
-00012470: 6e73 2064 6f2e 2022 2222 0a20 2020 2069  ns do. """.    i
-00012480: 6620 696e 7075 742e 6861 735f 6665 6174  f input.has_feat
-00012490: 7572 6520 616e 6420 6f74 6865 722e 6861  ure and other.ha
-000124a0: 735f 6665 6174 7572 653a 0a20 2020 2020  s_feature:.     
-000124b0: 2020 2064 696d 3120 3d20 6578 6973 745f     dim1 = exist_
-000124c0: 6469 6d28 696e 7075 742c 205b 5d29 0a20  dim(input, []). 
-000124d0: 2020 2020 2020 2064 696d 3220 3d20 6578         dim2 = ex
-000124e0: 6973 745f 6469 6d28 6f74 6865 722c 205b  ist_dim(other, [
-000124f0: 5d29 0a20 2020 2065 6c69 6620 696e 7075  ]).    elif inpu
-00012500: 742e 6861 735f 7370 6163 6520 616e 6420  t.has_space and 
-00012510: 6f74 6865 722e 6861 735f 7370 6163 653a  other.has_space:
-00012520: 0a20 2020 2020 2020 2064 696d 3120 3d20  .        dim1 = 
-00012530: 6578 6973 745f 6469 6d28 696e 7075 742c  exist_dim(input,
-00012540: 202e 2e2e 290a 2020 2020 2020 2020 6469   ...).        di
-00012550: 6d32 203d 2065 7869 7374 5f64 696d 286f  m2 = exist_dim(o
-00012560: 7468 6572 2c20 2e2e 2e29 0a20 2020 2065  ther, ...).    e
-00012570: 6c69 6620 696e 7075 742e 6861 735f 7365  lif input.has_se
-00012580: 7175 656e 6365 2061 6e64 206f 7468 6572  quence and other
-00012590: 2e68 6173 5f73 6571 7565 6e63 653a 0a20  .has_sequence:. 
-000125a0: 2020 2020 2020 2064 696d 3120 3d20 6578         dim1 = ex
-000125b0: 6973 745f 6469 6d28 696e 7075 742c 2027  ist_dim(input, '
-000125c0: 2729 0a20 2020 2020 2020 2064 696d 3220  ').        dim2 
-000125d0: 3d20 6578 6973 745f 6469 6d28 6f74 6865  = exist_dim(othe
-000125e0: 722c 2027 2729 0a20 2020 2065 6c73 653a  r, '').    else:
-000125f0: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
-00012600: 2866 2243 616e 6e6f 7420 7065 7266 6f72  (f"Cannot perfor
-00012610: 6d20 6d61 746d 756c 2061 6c69 676e 6d65  m matmul alignme
-00012620: 6e74 2066 6f72 2073 6861 7065 7320 7b69  nt for shapes {i
-00012630: 6e70 7574 5f73 6861 7065 7d20 616e 6420  nput_shape} and 
-00012640: 7b6f 7468 6572 5f73 6861 7065 7d2e 2022  {other_shape}. "
-00012650: 290a 2020 2020 6469 6d31 203d 2064 696d  ).    dim1 = dim
-00012660: 315b 2d32 3a5d 0a20 2020 2064 696d 3220  1[-2:].    dim2 
-00012670: 3d20 6469 6d32 5b2d 323a 5d0a 2020 2020  = dim2[-2:].    
-00012680: 7369 7a65 203d 2032 2069 6620 6c65 6e28  size = 2 if len(
-00012690: 6469 6d31 2920 3d3d 206c 656e 2864 696d  dim1) == len(dim
-000126a0: 3229 2065 6c73 6520 310a 2020 2020 696e  2) else 1.    in
-000126b0: 7075 7420 3d20 696e 7075 742e 6d6f 7665  put = input.move
-000126c0: 5f64 696d 2864 696d 312c 202d 3129 0a20  _dim(dim1, -1). 
-000126d0: 2020 206f 7468 6572 203d 206f 7468 6572     other = other
-000126e0: 2e6d 6f76 655f 6469 6d28 6469 6d32 2c20  .move_dim(dim2, 
-000126f0: 2d31 290a 2020 2020 7265 7475 726e 2028  -1).    return (
-00012700: 696e 7075 7420 4020 6f74 6865 7229 2e6d  input @ other).m
-00012710: 6f76 6564 696d 286c 6973 7428 7261 6e67  ovedim(list(rang
-00012720: 655f 282d 7369 7a65 2c20 3029 292c 2064  e_(-size, 0)), d
-00012730: 696d 325b 305d 2920 2320 7375 7070 7265  im2[0]) # suppre
-00012740: 7373 3a20 7370 6563 6961 6c5f 6672 6f6d  ss: special_from
-00012750: 0a0a 6465 6620 6d61 7470 6f77 2869 6e70  ..def matpow(inp
-00012760: 7574 3a20 2754 656e 736f 7227 2c20 6b2c  ut: 'Tensor', k,
-00012770: 202a 2c20 6469 6d3a 206c 696e 616c 675f   *, dim: linalg_
-00012780: 6469 6d5b 325d 3d4e 6f6e 6529 3a0a 2020  dim[2]=None):.  
-00012790: 2020 2222 2272 6574 7572 6e20 6120 6d61    """return a ma
-000127a0: 7472 6978 2070 6f77 6572 206f 6620 415e  trix power of A^
-000127b0: 6b2e 2222 220a 2020 2020 4c2c 2056 203d  k.""".    L, V =
-000127c0: 2065 6967 2869 6e70 7574 2c20 6469 6d3d   eig(input, dim=
-000127d0: 6469 6d29 0a20 2020 204c 203d 204c 2e6d  dim).    L = L.m
-000127e0: 6f76 655f 6469 6d28 6469 6d5b 305d 2c20  ove_dim(dim[0], 
-000127f0: 2d31 290a 2020 2020 5620 3d20 562e 6d6f  -1).    V = V.mo
-00012800: 7665 5f64 696d 2864 696d 2c20 2d31 290a  ve_dim(dim, -1).
-00012810: 2020 2020 4c5f 6b20 3d20 7768 6572 6528      L_k = where(
-00012820: 284c 2e72 6561 6c20 3c20 3029 2026 2028  (L.real < 0) & (
-00012830: 4c2e 696d 6167 2e61 6273 2829 203c 2031  L.imag.abs() < 1
-00012840: 652d 3629 2c20 2d63 6f6d 706c 6578 2828  e-6), -complex((
-00012850: 2d4c 2e72 6561 6c29 202a 2a20 6b2c 204c  -L.real) ** k, L
-00012860: 2e69 6d61 6729 2c20 4c20 2a2a 206b 290a  .imag), L ** k).
-00012870: 2020 2020 5220 3d20 5620 4020 6469 6167      R = V @ diag
-00012880: 284c 5f6b 2c20 6469 6d3d 2d31 2920 4020  (L_k, dim=-1) @ 
-00012890: 562e 696e 7628 290a 2020 2020 6966 2052  V.inv().    if R
-000128a0: 2e69 735f 636f 6d70 6c65 7828 2920 616e  .is_complex() an
-000128b0: 6420 6e6f 7420 696e 7075 742e 6973 5f63  d not input.is_c
-000128c0: 6f6d 706c 6578 2829 3a20 5220 3d20 522e  omplex(): R = R.
-000128d0: 7265 616c 0a20 2020 2072 6574 7572 6e20  real.    return 
-000128e0: 522e 6d6f 7665 5f64 696d 285b 2d32 2c20  R.move_dim([-2, 
-000128f0: 2d31 5d2c 2064 696d 292e 7479 7065 2869  -1], dim).type(i
-00012900: 6e70 7574 2e64 7479 7065 2920 2320 7375  nput.dtype) # su
-00012910: 7070 7265 7373 3a20 7370 6563 6961 6c5f  ppress: special_
-00012920: 6672 6f6d 0a0a 6465 6620 6d61 7465 7870  from..def matexp
-00012930: 2869 6e70 7574 3a20 2754 656e 736f 7227  (input: 'Tensor'
-00012940: 2c20 2a2c 2064 696d 3a20 6c69 6e61 6c67  , *, dim: linalg
-00012950: 5f64 696d 5b32 5d3d 4e6f 6e65 293a 0a20  _dim[2]=None):. 
-00012960: 2020 2022 2222 7265 7475 726e 2061 206d     """return a m
-00012970: 6174 7269 7820 6578 706f 6e65 6e74 6961  atrix exponentia
-00012980: 6c20 6f66 2065 5e41 2e22 2222 0a20 2020  l of e^A.""".   
-00012990: 204c 2c20 5620 3d20 6569 6728 696e 7075   L, V = eig(inpu
-000129a0: 742c 2064 696d 3d64 696d 290a 2020 2020  t, dim=dim).    
-000129b0: 4c20 3d20 4c2e 6d6f 7665 5f64 696d 2864  L = L.move_dim(d
-000129c0: 696d 5b30 5d2c 202d 3129 0a20 2020 2056  im[0], -1).    V
-000129d0: 203d 2056 2e6d 6f76 655f 6469 6d28 6469   = V.move_dim(di
-000129e0: 6d2c 202d 3129 0a20 2020 2052 203d 2056  m, -1).    R = V
-000129f0: 2040 2064 6961 6728 6578 7028 4c29 2c20   @ diag(exp(L), 
-00012a00: 6469 6d3d 2d31 2920 4020 562e 696e 7628  dim=-1) @ V.inv(
-00012a10: 290a 2020 2020 6966 2052 2e69 735f 636f  ).    if R.is_co
-00012a20: 6d70 6c65 7828 2920 616e 6420 6e6f 7420  mplex() and not 
-00012a30: 696e 7075 742e 6973 5f63 6f6d 706c 6578  input.is_complex
-00012a40: 2829 3a20 5220 3d20 522e 7265 616c 0a20  (): R = R.real. 
-00012a50: 2020 2072 6574 7572 6e20 522e 6d6f 7665     return R.move
-00012a60: 5f64 696d 285b 2d32 2c20 2d31 5d2c 2064  _dim([-2, -1], d
-00012a70: 696d 292e 7479 7065 2869 6e70 7574 2e64  im).type(input.d
-00012a80: 7479 7065 2920 2320 7375 7070 7265 7373  type) # suppress
-00012a90: 3a20 7370 6563 6961 6c5f 6672 6f6d 0a0a  : special_from..
-00012aa0: 6465 6620 6d61 746c 6f67 2869 6e70 7574  def matlog(input
-00012ab0: 3a20 2754 656e 736f 7227 2c20 2a2c 2064  : 'Tensor', *, d
-00012ac0: 696d 3a20 6c69 6e61 6c67 5f64 696d 5b32  im: linalg_dim[2
-00012ad0: 5d3d 4e6f 6e65 293a 0a20 2020 2022 2222  ]=None):.    """
-00012ae0: 7265 7475 726e 2061 206d 6174 7269 7820  return a matrix 
-00012af0: 6578 706f 6e65 6e74 6961 6c20 6f66 2065  exponential of e
-00012b00: 5e41 2e22 2222 0a20 2020 204c 2c20 5620  ^A.""".    L, V 
-00012b10: 3d20 6569 6728 696e 7075 742c 2064 696d  = eig(input, dim
-00012b20: 3d64 696d 290a 2020 2020 4c20 3d20 4c2e  =dim).    L = L.
-00012b30: 6d6f 7665 5f64 696d 2864 696d 5b30 5d2c  move_dim(dim[0],
-00012b40: 202d 3129 0a20 2020 2056 203d 2056 2e6d   -1).    V = V.m
-00012b50: 6f76 655f 6469 6d28 6469 6d2c 202d 3129  ove_dim(dim, -1)
-00012b60: 0a20 2020 2052 203d 2056 2040 2064 6961  .    R = V @ dia
-00012b70: 6728 6c6f 6728 4c29 2c20 6469 6d3d 2d31  g(log(L), dim=-1
-00012b80: 2920 4020 562e 696e 7628 290a 2020 2020  ) @ V.inv().    
-00012b90: 6966 2052 2e69 735f 636f 6d70 6c65 7828  if R.is_complex(
-00012ba0: 2920 616e 6420 6e6f 7420 696e 7075 742e  ) and not input.
-00012bb0: 6973 5f63 6f6d 706c 6578 2829 3a20 5220  is_complex(): R 
-00012bc0: 3d20 522e 7265 616c 0a20 2020 2072 6574  = R.real.    ret
-00012bd0: 7572 6e20 522e 6d6f 7665 5f64 696d 285b  urn R.move_dim([
-00012be0: 2d32 2c20 2d31 5d2c 2064 696d 292e 7479  -2, -1], dim).ty
-00012bf0: 7065 2869 6e70 7574 2e64 7479 7065 2920  pe(input.dtype) 
-00012c00: 2320 7375 7070 7265 7373 3a20 7370 6563  # suppress: spec
-00012c10: 6961 6c5f 6672 6f6d 0a0a 6465 6620 7261  ial_from..def ra
-00012c20: 6e6b 2869 6e70 7574 3a20 2754 656e 736f  nk(input: 'Tenso
-00012c30: 7227 2c20 2a2c 2061 746f 6c3d 4e6f 6e65  r', *, atol=None
-00012c40: 2c20 7274 6f6c 3d4e 6f6e 652c 2068 6572  , rtol=None, her
-00012c50: 6d69 7469 616e 3d46 616c 7365 2c20 6469  mitian=False, di
-00012c60: 6d3a 206c 696e 616c 675f 6469 6d5b 325d  m: linalg_dim[2]
-00012c70: 3d4e 6f6e 652c 206f 7574 3d4e 6f6e 6529  =None, out=None)
-00012c80: 3a0a 2020 2020 4120 3d20 696e 7075 742e  :.    A = input.
-00012c90: 6d6f 7665 5f64 696d 2864 696d 2c20 2d31  move_dim(dim, -1
-00012ca0: 290a 2020 2020 7769 7468 2074 6f72 6368  ).    with torch
-00012cb0: 2e5f 432e 4469 7361 626c 6554 6f72 6368  ._C.DisableTorch
-00012cc0: 4675 6e63 7469 6f6e 2829 3a0a 2020 2020  Function():.    
-00012cd0: 2020 2020 7265 7475 726e 2074 6f72 6368      return torch
-00012ce0: 2e6c 696e 616c 672e 6d61 7472 6978 5f72  .linalg.matrix_r
-00012cf0: 616e 6b28 412c 2061 746f 6c3d 6174 6f6c  ank(A, atol=atol
-00012d00: 2c20 7274 6f6c 3d72 746f 6c2c 2068 6572  , rtol=rtol, her
-00012d10: 6d69 7469 616e 3d68 6572 6d69 7469 616e  mitian=hermitian
-00012d20: 2c20 2a2a 6469 6374 286f 7574 3d6f 7574  , **dict(out=out
-00012d30: 2920 6966 206c 6f63 616c 7328 292e 6765  ) if locals().ge
-00012d40: 7428 276f 7574 272c 204e 6f6e 6529 2069  t('out', None) i
-00012d50: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
-00012d60: 7b7d 292e 6173 5f73 7562 636c 6173 7328  {}).as_subclass(
-00012d70: 5465 6e73 6f72 292e 7370 6563 6961 6c5f  Tensor).special_
-00012d80: 6672 6f6d 2841 2e73 6861 7065 5b3a 2d32  from(A.shape[:-2
-00012d90: 5d29 0a0a 6465 6620 6d61 746e 6f72 6d28  ])..def matnorm(
-00012da0: 696e 7075 743a 2027 5465 6e73 6f72 272c  input: 'Tensor',
-00012db0: 206f 7264 3d27 6672 6f27 2c20 6469 6d3a   ord='fro', dim:
-00012dc0: 206c 696e 616c 675f 6469 6d5b 325d 3d4e   linalg_dim[2]=N
-00012dd0: 6f6e 652c 206b 6565 7064 696d 3d46 616c  one, keepdim=Fal
-00012de0: 7365 2c20 2a2c 2064 7479 7065 3d4e 6f6e  se, *, dtype=Non
-00012df0: 652c 206f 7574 3d4e 6f6e 6529 3a0a 2020  e, out=None):.  
-00012e00: 2020 4120 3d20 696e 7075 742e 6d6f 7665    A = input.move
-00012e10: 5f64 696d 2864 696d 2c20 2d31 290a 2020  _dim(dim, -1).  
-00012e20: 2020 7769 7468 2074 6f72 6368 2e5f 432e    with torch._C.
-00012e30: 4469 7361 626c 6554 6f72 6368 4675 6e63  DisableTorchFunc
-00012e40: 7469 6f6e 2829 3a0a 2020 2020 2020 2020  tion():.        
-00012e50: 7265 7475 726e 2074 6f72 6368 2e6c 696e  return torch.lin
-00012e60: 616c 672e 6d61 7472 6978 5f6e 6f72 6d28  alg.matrix_norm(
-00012e70: 412c 206f 7264 3d6f 7264 2c20 6469 6d3d  A, ord=ord, dim=
-00012e80: 6469 6d2c 206b 6565 7064 696d 3d6b 6565  dim, keepdim=kee
-00012e90: 7064 696d 2c20 6474 7970 653d 6474 7970  pdim, dtype=dtyp
-00012ea0: 652c 202a 2a64 6963 7428 6f75 743d 6f75  e, **dict(out=ou
-00012eb0: 7429 2069 6620 6c6f 6361 6c73 2829 2e67  t) if locals().g
-00012ec0: 6574 2827 6f75 7427 2c20 4e6f 6e65 2920  et('out', None) 
-00012ed0: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
-00012ee0: 207b 7d29 2e61 735f 7375 6263 6c61 7373   {}).as_subclass
-00012ef0: 2854 656e 736f 7229 2e73 7065 6369 616c  (Tensor).special
-00012f00: 5f66 726f 6d28 412e 7368 6170 6520 6966  _from(A.shape if
-00012f10: 206b 6565 7064 696d 2065 6c73 6520 412e   keepdim else A.
-00012f20: 7368 6170 655b 3a2d 325d 290a 0a62 6977  shape[:-2])..biw
-00012f30: 6179 5f66 756e 6374 696f 6e73 203d 205b  ay_functions = [
-00012f40: 6620 666f 7220 6620 696e 206c 6f63 616c  f for f in local
-00012f50: 7328 2920 6966 2066 206e 6f74 2069 6e20  s() if f not in 
-00012f60: 6261 7369 635f 6c6f 6361 6c73 5d0a 0a63  basic_locals]..c
-00012f70: 6c61 7373 2053 697a 6528 7475 706c 6529  lass Size(tuple)
-00012f80: 3a0a 0a20 2020 2040 636c 6173 736d 6574  :..    @classmet
-00012f90: 686f 640a 2020 2020 6465 6620 5f5f 6e65  hod.    def __ne
-00012fa0: 775f 7261 775f 5f28 636c 732c 2073 6861  w_raw__(cls, sha
-00012fb0: 7065 2c20 737a 5f66 756e 635f 6469 6d3a  pe, sz_func_dim:
-00012fc0: 2069 6e74 203d 2030 2c20 737a 5f62 6174   int = 0, sz_bat
-00012fd0: 6368 5f64 696d 3a20 696e 7420 3d20 302c  ch_dim: int = 0,
-00012fe0: 2073 7a5f 6665 6174 7572 655f 6469 6d3a   sz_feature_dim:
-00012ff0: 2069 6e74 203d 2030 2c20 737a 5f73 6571   int = 0, sz_seq
-00013000: 7565 6e63 655f 6469 6d3a 2069 6e74 203d  uence_dim: int =
-00013010: 2030 293a 0a20 2020 2020 2020 2022 2222   0):.        """
-00013020: 0a20 2020 2020 2020 2054 6865 2072 6177  .        The raw
-00013030: 2063 6f6e 7374 7275 6374 696f 6e20 6675   construction fu
-00013040: 6e63 7469 6f6e 2064 6566 696e 6564 2062  nction defined b
-00013050: 7920 7468 6520 696e 6e65 7220 7061 7261  y the inner para
-00013060: 6d65 7465 7273 2e0a 0a20 2020 2020 2020  meters...       
-00013070: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
-00013080: 2020 2073 6861 7065 2028 7475 706c 6520     shape (tuple 
-00013090: 6f66 2069 6e74 7329 3a20 5468 6520 7261  of ints): The ra
-000130a0: 7720 7475 706c 6520 7374 7275 6374 7572  w tuple structur
-000130b0: 652e 200a 2020 2020 2020 2020 2020 2020  e. .            
-000130c0: 737a 5f66 756e 635f 6469 6d20 2869 6e74  sz_func_dim (int
-000130d0: 2c20 6f70 7469 6f6e 616c 293a 2041 6e20  , optional): An 
-000130e0: 696e 6e65 7220 7061 7261 6d65 7465 7220  inner parameter 
-000130f0: 666f 7220 6675 6e63 7469 6f6e 616c 2064  for functional d
-00013100: 696d 656e 7369 6f6e 2c20 6974 2063 616e  imension, it can
-00013110: 206f 6e6c 7920 6265 2030 2c20 312c 206f   only be 0, 1, o
-00013120: 7220 2d31 2e20 4465 6661 756c 7473 2074  r -1. Defaults t
-00013130: 6f20 302e 0a20 2020 2020 2020 2020 2020  o 0..           
-00013140: 2073 7a5f 6261 7463 685f 6469 6d20 2869   sz_batch_dim (i
-00013150: 6e74 2c20 6f70 7469 6f6e 616c 293a 2041  nt, optional): A
-00013160: 6e20 696e 6e65 7220 7061 7261 6d65 7465  n inner paramete
-00013170: 7220 666f 7220 6261 7463 6820 6469 6d65  r for batch dime
-00013180: 6e73 696f 6e2c 2069 7420 6361 6e20 6f6e  nsion, it can on
-00013190: 6c79 2062 6520 302c 2031 2c20 6f72 202d  ly be 0, 1, or -
-000131a0: 312e 2044 6566 6175 6c74 7320 746f 2030  1. Defaults to 0
-000131b0: 2e0a 2020 2020 2020 2020 2020 2020 737a  ..            sz
-000131c0: 5f66 6561 7475 7265 5f64 696d 2028 696e  _feature_dim (in
-000131d0: 742c 206f 7074 696f 6e61 6c29 3a20 416e  t, optional): An
-000131e0: 2069 6e6e 6572 2070 6172 616d 6574 6572   inner parameter
-000131f0: 2066 6f72 2066 6561 7475 7265 2064 696d   for feature dim
-00013200: 656e 7369 6f6e 732c 2062 6569 6e67 2070  ensions, being p
-00013210: 6f73 6974 6976 6520 7768 656e 2074 6865  ositive when the
-00013220: 7920 6172 6520 696e 2066 726f 6e74 206f  y are in front o
-00013230: 6620 7468 6520 7370 6163 652d 7365 7175  f the space-sequ
-00013240: 656e 6365 2064 696d 656e 7369 6f6e 732e  ence dimensions.
-00013250: 2044 6566 6175 6c74 7320 746f 2030 2e0a   Defaults to 0..
-00013260: 2020 2020 2020 2020 2020 2020 737a 5f73              sz_s
-00013270: 6571 7565 6e63 655f 6469 6d20 2869 6e74  equence_dim (int
-00013280: 2c20 6f70 7469 6f6e 616c 293a 2041 6e20  , optional): An 
-00013290: 696e 6e65 7220 7061 7261 6d65 7465 7220  inner parameter 
-000132a0: 666f 7220 7365 7175 656e 6365 2064 696d  for sequence dim
-000132b0: 656e 7369 6f6e 732c 2062 6569 6e67 2070  ensions, being p
-000132c0: 6f73 6974 6976 6520 7768 656e 2074 6865  ositive when the
-000132d0: 7920 6172 6520 696e 2066 726f 6e74 206f  y are in front o
-000132e0: 6620 7468 6520 7370 6163 6520 6469 6d65  f the space dime
-000132f0: 6e73 696f 6e73 2e20 4465 6661 756c 7473  nsions. Defaults
-00013300: 2074 6f20 302e 0a20 2020 2020 2020 2022   to 0..        "
-00013310: 2222 0a20 2020 2020 2020 2061 766f 7563  "".        avouc
-00013320: 6828 6973 696e 7374 616e 6365 2873 6861  h(isinstance(sha
-00013330: 7065 2c20 7475 706c 6529 2061 6e64 2061  pe, tuple) and a
-00013340: 6c6c 5f28 6973 696e 7374 616e 6365 2873  ll_(isinstance(s
-00013350: 2c20 6e75 6d5f 2920 666f 7220 7320 696e  , num_) for s in
-00013360: 2073 6861 7065 292c 2054 7970 6545 7272   shape), TypeErr
-00013370: 6f72 2866 2249 6e76 616c 6964 2027 7368  or(f"Invalid 'sh
-00013380: 6170 6520 3d20 7b73 6861 7065 7d27 2066  ape = {shape}' f
-00013390: 6f72 2062 742e 5369 7a65 2c20 7368 6f75  or bt.Size, shou
-000133a0: 6c64 2062 6520 6120 7475 706c 652e 2022  ld be a tuple. "
-000133b0: 2929 0a20 2020 2020 2020 2061 766f 7563  )).        avouc
-000133c0: 6828 737a 5f66 756e 635f 6469 6d20 696e  h(sz_func_dim in
-000133d0: 2028 302c 2031 2c20 2d31 292c 2054 7970   (0, 1, -1), Typ
-000133e0: 6545 7272 6f72 2866 2249 6e76 616c 6964  eError(f"Invalid
-000133f0: 2027 737a 5f66 756e 635f 6469 6d20 3d20   'sz_func_dim = 
-00013400: 7b73 7a5f 6675 6e63 5f64 696d 7d27 2066  {sz_func_dim}' f
-00013410: 6f72 2062 742e 5369 7a65 2c20 7368 6f75  or bt.Size, shou
-00013420: 6c64 2062 6520 302c 2031 2c20 6f72 202d  ld be 0, 1, or -
-00013430: 312e 2022 2929 0a20 2020 2020 2020 2061  1. ")).        a
-00013440: 766f 7563 6828 737a 5f62 6174 6368 5f64  vouch(sz_batch_d
-00013450: 696d 2069 6e20 2830 2c20 312c 202d 3129  im in (0, 1, -1)
-00013460: 2c20 5479 7065 4572 726f 7228 6622 496e  , TypeError(f"In
-00013470: 7661 6c69 6420 2773 7a5f 6261 7463 685f  valid 'sz_batch_
-00013480: 6469 6d20 3d20 7b73 7a5f 6261 7463 685f  dim = {sz_batch_
-00013490: 6469 6d7d 2720 666f 7220 6274 2e53 697a  dim}' for bt.Siz
-000134a0: 652c 2073 686f 756c 6420 6265 2030 2c20  e, should be 0, 
-000134b0: 312c 206f 7220 2d31 2e20 2229 290a 2020  1, or -1. ")).  
-000134c0: 2020 2020 2020 6176 6f75 6368 2869 7369        avouch(isi
-000134d0: 6e73 7461 6e63 6528 737a 5f66 6561 7475  nstance(sz_featu
-000134e0: 7265 5f64 696d 2c20 696e 745f 292c 2054  re_dim, int_), T
-000134f0: 7970 6545 7272 6f72 2866 2249 6e76 616c  ypeError(f"Inval
-00013500: 6964 2027 737a 5f66 6561 7475 7265 5f64  id 'sz_feature_d
-00013510: 696d 203d 207b 737a 5f66 6561 7475 7265  im = {sz_feature
-00013520: 5f64 696d 7d27 2066 6f72 2062 742e 5369  _dim}' for bt.Si
-00013530: 7a65 2c20 7368 6f75 6c64 2062 6520 616e  ze, should be an
-00013540: 2069 6e74 6567 6572 2e20 2229 290a 2020   integer. ")).  
-00013550: 2020 2020 2020 6176 6f75 6368 2869 7369        avouch(isi
-00013560: 6e73 7461 6e63 6528 737a 5f73 6571 7565  nstance(sz_seque
-00013570: 6e63 655f 6469 6d2c 2069 6e74 5f29 2c20  nce_dim, int_), 
-00013580: 5479 7065 4572 726f 7228 6622 496e 7661  TypeError(f"Inva
-00013590: 6c69 6420 2773 7a5f 7365 7175 656e 6365  lid 'sz_sequence
-000135a0: 5f64 696d 203d 207b 737a 5f73 6571 7565  _dim = {sz_seque
-000135b0: 6e63 655f 6469 6d7d 2720 666f 7220 6274  nce_dim}' for bt
-000135c0: 2e53 697a 652c 2073 686f 756c 6420 6265  .Size, should be
-000135d0: 2061 6e20 696e 7465 6765 722e 2022 2929   an integer. "))
-000135e0: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
-000135f0: 6c65 6e28 7368 6170 6529 203e 3d20 6162  len(shape) >= ab
-00013600: 735f 2873 7a5f 6675 6e63 5f64 696d 2920  s_(sz_func_dim) 
-00013610: 2b20 6162 735f 2873 7a5f 6261 7463 685f  + abs_(sz_batch_
-00013620: 6469 6d29 202b 2061 6273 5f28 737a 5f66  dim) + abs_(sz_f
-00013630: 6561 7475 7265 5f64 696d 2920 2b20 6162  eature_dim) + ab
-00013640: 735f 2873 7a5f 7365 7175 656e 6365 5f64  s_(sz_sequence_d
-00013650: 696d 292c 2054 7970 6545 7272 6f72 2866  im), TypeError(f
-00013660: 2254 6f6f 206d 616e 7920 7370 6563 6961  "Too many specia
-00013670: 6c20 6469 6d65 6e73 696f 6e73 2066 6f72  l dimensions for
-00013680: 2073 6861 7065 206f 6620 6c65 6e67 7468   shape of length
-00013690: 207b 6c65 6e28 7368 6170 6529 7d3a 2073   {len(shape)}: s
-000136a0: 7a5f 6675 6e63 5f64 696d 203d 207b 737a  z_func_dim = {sz
-000136b0: 5f66 756e 635f 6469 6d7d 2c20 737a 5f62  _func_dim}, sz_b
-000136c0: 6174 6368 5f64 696d 203d 207b 737a 5f62  atch_dim = {sz_b
-000136d0: 6174 6368 5f64 696d 7d2c 2073 7a5f 6665  atch_dim}, sz_fe
-000136e0: 6174 7572 655f 6469 6d20 3d20 7b73 7a5f  ature_dim = {sz_
-000136f0: 6665 6174 7572 655f 6469 6d7d 2c20 737a  feature_dim}, sz
-00013700: 5f73 6571 7565 6e63 655f 6469 6d20 3d20  _sequence_dim = 
-00013710: 7b73 7a5f 7365 7175 656e 6365 5f64 696d  {sz_sequence_dim
-00013720: 7d2e 2022 2929 0a20 2020 2020 2020 2073  }. ")).        s
-00013730: 656c 6620 3d20 7375 7065 7228 292e 5f5f  elf = super().__
-00013740: 6e65 775f 5f28 636c 732c 2073 6861 7065  new__(cls, shape
-00013750: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
-00013760: 7a5f 6675 6e63 5f64 696d 203d 2073 7a5f  z_func_dim = sz_
-00013770: 6675 6e63 5f64 696d 0a20 2020 2020 2020  func_dim.       
-00013780: 2073 656c 662e 737a 5f62 6174 6368 5f64   self.sz_batch_d
-00013790: 696d 203d 2073 7a5f 6261 7463 685f 6469  im = sz_batch_di
-000137a0: 6d0a 2020 2020 2020 2020 7365 6c66 2e73  m.        self.s
-000137b0: 7a5f 6665 6174 7572 655f 6469 6d20 3d20  z_feature_dim = 
-000137c0: 737a 5f66 6561 7475 7265 5f64 696d 0a20  sz_feature_dim. 
-000137d0: 2020 2020 2020 2073 656c 662e 737a 5f73         self.sz_s
-000137e0: 6571 7565 6e63 655f 6469 6d20 3d20 737a  equence_dim = sz
-000137f0: 5f73 6571 7565 6e63 655f 6469 6d0a 2020  _sequence_dim.  
-00013800: 2020 2020 2020 7365 6c66 2e6e 5f64 696d        self.n_dim
-00013810: 203d 2073 656c 662e 6e64 696d 203d 206c   = self.ndim = l
-00013820: 656e 2873 6861 7065 290a 2020 2020 2020  en(shape).      
-00013830: 2020 7265 7475 726e 2073 656c 660a 0a20    return self.. 
-00013840: 2020 2040 636c 6173 736d 6574 686f 640a     @classmethod.
-00013850: 2020 2020 6465 6620 5f5f 6e65 775f 7369      def __new_si
-00013860: 7a65 5f5f 2863 6c73 2c20 7369 7a65 2c20  ze__(cls, size, 
-00013870: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-00013880: 2020 2022 2222 5468 6520 636f 6e73 7472     """The constr
-00013890: 7563 7469 6f6e 2066 756e 6374 696f 6e20  uction function 
-000138a0: 666f 7220 6120 6274 2e53 697a 6520 6f62  for a bt.Size ob
-000138b0: 6a65 6374 2e20 2222 220a 2020 2020 2020  ject. """.      
-000138c0: 2020 6176 6f75 6368 2869 7369 6e73 7461    avouch(isinsta
-000138d0: 6e63 6528 7369 7a65 2c20 5369 7a65 292c  nce(size, Size),
-000138e0: 2054 7970 6545 7272 6f72 2866 2249 6e76   TypeError(f"Inv
-000138f0: 616c 6964 2027 7369 7a65 203d 207b 7369  alid 'size = {si
-00013900: 7a65 7d27 2066 6f72 2062 742e 5369 7a65  ze}' for bt.Size
-00013910: 2c20 7368 6f75 6c64 2062 6520 6120 6274  , should be a bt
-00013920: 2e53 697a 6520 6f62 6a65 6374 2e20 2229  .Size object. ")
-00013930: 290a 2020 2020 2020 2020 6b77 6172 6773  ).        kwargs
-00013940: 2e73 6574 6465 6661 756c 7428 2273 7a5f  .setdefault("sz_
-00013950: 6675 6e63 5f64 696d 222c 2073 697a 652e  func_dim", size.
-00013960: 737a 5f66 756e 635f 6469 6d29 0a20 2020  sz_func_dim).   
-00013970: 2020 2020 206b 7761 7267 732e 7365 7464       kwargs.setd
-00013980: 6566 6175 6c74 2822 737a 5f62 6174 6368  efault("sz_batch
-00013990: 5f64 696d 222c 2073 697a 652e 737a 5f62  _dim", size.sz_b
-000139a0: 6174 6368 5f64 696d 290a 2020 2020 2020  atch_dim).      
-000139b0: 2020 6b77 6172 6773 2e73 6574 6465 6661    kwargs.setdefa
-000139c0: 756c 7428 2273 7a5f 6665 6174 7572 655f  ult("sz_feature_
-000139d0: 6469 6d22 2c20 7369 7a65 2e73 7a5f 6665  dim", size.sz_fe
-000139e0: 6174 7572 655f 6469 6d29 0a20 2020 2020  ature_dim).     
-000139f0: 2020 206b 7761 7267 732e 7365 7464 6566     kwargs.setdef
-00013a00: 6175 6c74 2822 737a 5f73 6571 7565 6e63  ault("sz_sequenc
-00013a10: 655f 6469 6d22 2c20 7369 7a65 2e73 7a5f  e_dim", size.sz_
-00013a20: 7365 7175 656e 6365 5f64 696d 290a 2020  sequence_dim).  
-00013a30: 2020 2020 2020 7265 7475 726e 2063 6c73        return cls
-00013a40: 2e5f 5f6e 6577 5f72 6177 5f5f 2874 7570  .__new_raw__(tup
-00013a50: 6c65 2873 697a 6529 2c20 2a2a 6b77 6172  le(size), **kwar
-00013a60: 6773 290a 0a20 2020 2040 636c 6173 736d  gs)..    @classm
-00013a70: 6574 686f 640a 2020 2020 6465 6620 5f5f  ethod.    def __
-00013a80: 6e65 775f 7475 706c 655f 5f28 636c 732c  new_tuple__(cls,
-00013a90: 2073 6861 7065 2c20 6675 6e63 5f64 696d   shape, func_dim
-00013aa0: 3a20 2869 6e74 2c20 6e75 6c6c 2920 3d20  : (int, null) = 
-00013ab0: 4e6f 6e65 2c20 6261 7463 685f 6469 6d3a  None, batch_dim:
-00013ac0: 2028 696e 742c 206e 756c 6c29 203d 204e   (int, null) = N
-00013ad0: 6f6e 652c 2063 6861 6e6e 656c 5f64 696d  one, channel_dim
-00013ae0: 3a20 2869 6e74 2c20 6e75 6c6c 2920 3d20  : (int, null) = 
-00013af0: 4e6f 6e65 2c20 7365 7175 656e 6365 5f64  None, sequence_d
-00013b00: 696d 3a20 2869 6e74 2c20 6e75 6c6c 2920  im: (int, null) 
-00013b10: 3d20 4e6f 6e65 2c20 6e5f 6665 6174 7572  = None, n_featur
-00013b20: 655f 6469 6d3a 2069 6e74 203d 204e 6f6e  e_dim: int = Non
-00013b30: 652c 206e 5f73 6571 7565 6e63 655f 6469  e, n_sequence_di
-00013b40: 6d3a 2069 6e74 203d 204e 6f6e 652c 2073  m: int = None, s
-00013b50: 7a5f 6675 6e63 5f64 696d 3a20 696e 7420  z_func_dim: int 
-00013b60: 3d20 4e6f 6e65 2c20 737a 5f62 6174 6368  = None, sz_batch
-00013b70: 5f64 696d 3a20 696e 7420 3d20 4e6f 6e65  _dim: int = None
-00013b80: 2c20 737a 5f66 6561 7475 7265 5f64 696d  , sz_feature_dim
-00013b90: 3a20 696e 7420 3d20 4e6f 6e65 2c20 737a  : int = None, sz
-00013ba0: 5f73 6571 7565 6e63 655f 6469 6d3a 2069  _sequence_dim: i
-00013bb0: 6e74 203d 204e 6f6e 6529 3a0a 2020 2020  nt = None):.    
-00013bc0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00013bd0: 5468 6520 636f 6e73 7472 7563 7469 6f6e  The construction
-00013be0: 2066 756e 6374 696f 6e20 666f 7220 6120   function for a 
-00013bf0: 7475 706c 6520 7769 7468 2072 6561 6461  tuple with reada
-00013c00: 626c 6520 7061 7261 6d65 7465 7273 2e20  ble parameters. 
-00013c10: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
-00013c20: 2020 2020 2020 2020 2020 2020 7368 6170              shap
-00013c30: 6520 2874 7570 6c65 206f 6620 696e 7473  e (tuple of ints
-00013c40: 293a 2074 6865 2072 6177 2074 7570 6c65  ): the raw tuple
-00013c50: 2073 7472 7563 7475 7265 2e20 0a20 2020   structure. .   
-00013c60: 2020 2020 2020 2020 2066 756e 635f 6469           func_di
-00013c70: 6d20 2869 6e74 2c20 6e75 6c6c 2c20 6f70  m (int, null, op
-00013c80: 7469 6f6e 616c 293a 2054 6865 2069 6e64  tional): The ind
-00013c90: 6578 206f 6620 7468 6520 6675 6e63 7469  ex of the functi
-00013ca0: 6f6e 616c 2064 696d 656e 7369 6f6e 2c20  onal dimension, 
-00013cb0: 6861 7669 6e67 2061 2064 6f6d 6169 6e20  having a domain 
-00013cc0: 6f66 2030 206f 7220 6e5f 6469 6d20 2d20  of 0 or n_dim - 
-00013cd0: 312c 2074 6865 2066 6972 7374 206f 7220  1, the first or 
-00013ce0: 6c61 7374 2064 696d 656e 7369 6f6e 2e20  last dimension. 
-00013cf0: 4465 6661 756c 7473 2074 6f20 4e6f 6e65  Defaults to None
-00013d00: 2e0a 2020 2020 2020 2020 2020 2020 6261  ..            ba
-00013d10: 7463 685f 6469 6d20 2869 6e74 2c20 6e75  tch_dim (int, nu
-00013d20: 6c6c 2c20 6f70 7469 6f6e 616c 293a 2054  ll, optional): T
-00013d30: 6865 2069 6e64 6578 206f 6620 7468 6520  he index of the 
-00013d40: 6261 7463 6820 6469 6d65 6e73 696f 6e2c  batch dimension,
-00013d50: 2068 6176 696e 6720 6120 646f 6d61 696e   having a domain
-00013d60: 206f 6620 3020 6f72 206e 5f64 696d 202d   of 0 or n_dim -
-00013d70: 2031 2c20 7468 6520 6669 7273 7420 6f72   1, the first or
-00013d80: 206c 6173 7420 6469 6d65 6e73 696f 6e2e   last dimension.
-00013d90: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
-00013da0: 652e 0a20 2020 2020 2020 2020 2020 2063  e..            c
-00013db0: 6861 6e6e 656c 5f64 696d 2028 696e 742c  hannel_dim (int,
-00013dc0: 206e 756c 6c2c 206f 7074 696f 6e61 6c29   null, optional)
-00013dd0: 3a20 5468 6520 696e 6465 7820 6f66 2074  : The index of t
-00013de0: 6865 2063 6861 6e6e 656c 2064 696d 656e  he channel dimen
-00013df0: 7369 6f6e 2c20 6265 696e 6720 7468 6520  sion, being the 
-00013e00: 6669 7273 7420 6f72 206c 6173 7420 6469  first or last di
-00013e10: 6d65 6e73 696f 6e20 6170 6172 7420 6672  mension apart fr
-00013e20: 6f6d 2074 6865 2062 6174 6368 2064 696d  om the batch dim
-00013e30: 656e 7369 6f6e 2e20 4465 6661 756c 7473  ension. Defaults
-00013e40: 2074 6f20 4e6f 6e65 2e0a 2020 2020 2020   to None..      
-00013e50: 2020 2020 2020 7365 7175 656e 6365 5f64        sequence_d
-00013e60: 696d 2028 696e 742c 206e 756c 6c2c 206f  im (int, null, o
-00013e70: 7074 696f 6e61 6c29 3a20 5468 6520 696e  ptional): The in
-00013e80: 6465 7820 6f66 2074 6865 2073 6571 7565  dex of the seque
-00013e90: 6e63 6520 6469 6d65 6e73 696f 6e2c 2068  nce dimension, h
-00013ea0: 6176 696e 6720 7468 6520 6669 7273 7420  aving the first 
-00013eb0: 6f72 206c 6173 7420 6469 6d65 6e73 696f  or last dimensio
-00013ec0: 6e20 6170 6172 7420 6672 6f6d 2074 6865  n apart from the
-00013ed0: 2062 6174 6368 2061 6e64 2063 6861 6e6e   batch and chann
-00013ee0: 656c 2064 696d 656e 7369 6f6e 2e20 4465  el dimension. De
-00013ef0: 6661 756c 7473 2074 6f20 4e6f 6e65 2e0a  faults to None..
-00013f00: 2020 2020 2020 2020 2020 2020 6e5f 6665              n_fe
-00013f10: 6174 7572 655f 6469 6d20 2869 6e74 2c20  ature_dim (int, 
-00013f20: 6f70 7469 6f6e 616c 293a 2054 6865 206e  optional): The n
-00013f30: 756d 6265 7220 6f66 2066 6561 7475 7265  umber of feature
-00013f40: 2064 696d 656e 7369 6f6e 7320 2874 6f20   dimensions (to 
-00013f50: 7468 6520 6c65 6674 206f 6620 7370 6163  the left of spac
-00013f60: 6520 6469 6d65 6e73 696f 6e73 292c 2063  e dimensions), c
-00013f70: 6f6e 666c 6963 7420 746f 2061 7267 756d  onflict to argum
-00013f80: 656e 7420 2763 6861 6e6e 656c 5f64 696d  ent 'channel_dim
-00013f90: 272e 2044 6566 6175 6c74 7320 746f 204e  '. Defaults to N
-00013fa0: 6f6e 652e 0a20 2020 2020 2020 2020 2020  one..           
-00013fb0: 206e 5f73 6571 7565 6e63 655f 6469 6d20   n_sequence_dim 
-00013fc0: 2869 6e74 2c20 6f70 7469 6f6e 616c 293a  (int, optional):
-00013fd0: 2054 6865 206e 756d 6265 7220 6f66 2073   The number of s
-00013fe0: 6571 7565 6e63 6520 6469 6d65 6e73 696f  equence dimensio
-00013ff0: 6e73 2028 746f 2074 6865 2072 6967 6874  ns (to the right
-00014000: 206f 6620 7370 6163 6520 6469 6d65 6e73   of space dimens
-00014010: 696f 6e73 292c 2063 6f6e 666c 6963 7420  ions), conflict 
-00014020: 746f 2061 7267 756d 656e 7420 2773 6571  to argument 'seq
-00014030: 7565 6e63 655f 6469 6d27 2e20 4465 6661  uence_dim'. Defa
-00014040: 756c 7473 2074 6f20 4e6f 6e65 2e0a 2020  ults to None..  
-00014050: 2020 2020 2020 2020 2020 737a 5f66 756e            sz_fun
-00014060: 635f 6469 6d20 2869 6e74 2c20 6f70 7469  c_dim (int, opti
-00014070: 6f6e 616c 293a 2054 6865 2073 7a20 6e75  onal): The sz nu
-00014080: 6d62 6572 206f 6620 7468 6520 6675 6e63  mber of the func
-00014090: 7469 6f6e 616c 2064 696d 656e 7369 6f6e  tional dimension
-000140a0: 2c20 636f 6e66 6c69 6374 2074 6f20 6172  , conflict to ar
-000140b0: 6775 6d65 6e74 2027 6675 6e63 5f64 696d  gument 'func_dim
-000140c0: 272e 2044 6566 6175 6c74 7320 746f 204e  '. Defaults to N
-000140d0: 6f6e 652e 0a20 2020 2020 2020 2020 2020  one..           
-000140e0: 2073 7a5f 6261 7463 685f 6469 6d20 2869   sz_batch_dim (i
-000140f0: 6e74 2c20 6f70 7469 6f6e 616c 293a 2054  nt, optional): T
-00014100: 6865 2073 7a20 6e75 6d62 6572 206f 6620  he sz number of 
-00014110: 7468 6520 6261 7463 6820 6469 6d65 6e73  the batch dimens
-00014120: 696f 6e2c 2063 6f6e 666c 6963 7420 746f  ion, conflict to
-00014130: 2061 7267 756d 656e 7420 2762 6174 6368   argument 'batch
-00014140: 5f64 696d 272e 2044 6566 6175 6c74 7320  _dim'. Defaults 
-00014150: 746f 204e 6f6e 652e 0a20 2020 2020 2020  to None..       
-00014160: 2020 2020 2073 7a5f 6665 6174 7572 655f       sz_feature_
-00014170: 6469 6d20 2869 6e74 2c20 6f70 7469 6f6e  dim (int, option
-00014180: 616c 293a 2054 6865 2073 7a20 6e75 6d62  al): The sz numb
-00014190: 6572 206f 6620 6665 6174 7572 6520 6469  er of feature di
-000141a0: 6d65 6e73 696f 6e73 2c20 636f 6e66 6c69  mensions, confli
-000141b0: 6374 2074 6f20 6172 6775 6d65 6e74 7320  ct to arguments 
-000141c0: 2763 6861 6e6e 656c 5f64 696d 2720 616e  'channel_dim' an
-000141d0: 6420 276e 5f66 6561 7475 7265 5f64 696d  d 'n_feature_dim
-000141e0: 272e 2044 6566 6175 6c74 7320 746f 204e  '. Defaults to N
-000141f0: 6f6e 652e 0a20 2020 2020 2020 2020 2020  one..           
-00014200: 2073 7a5f 7365 7175 656e 6365 5f64 696d   sz_sequence_dim
-00014210: 2028 696e 742c 206f 7074 696f 6e61 6c29   (int, optional)
-00014220: 3a20 5468 6520 737a 206e 756d 6265 7220  : The sz number 
-00014230: 6f66 2073 6571 7565 6e63 6520 6469 6d65  of sequence dime
-00014240: 6e73 696f 6e73 2c20 636f 6e66 6c69 6374  nsions, conflict
-00014250: 2074 6f20 6172 6775 6d65 6e74 7320 2773   to arguments 's
-00014260: 6571 7565 6e63 655f 6469 6d27 2061 6e64  equence_dim' and
-00014270: 2027 6e5f 7365 7175 656e 6365 5f64 696d   'n_sequence_dim
-00014280: 272e 2044 6566 6175 6c74 7320 746f 204e  '. Defaults to N
-00014290: 6f6e 652e 0a20 2020 2020 2020 2022 2222  one..        """
-000142a0: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
-000142b0: 6973 696e 7374 616e 6365 2873 6861 7065  isinstance(shape
-000142c0: 2c20 7475 706c 6529 2c20 5479 7065 4572  , tuple), TypeEr
-000142d0: 726f 7228 6622 496e 7661 6c69 6420 2773  ror(f"Invalid 's
-000142e0: 6861 7065 203d 207b 7368 6170 657d 2720  hape = {shape}' 
-000142f0: 666f 7220 6274 2e53 697a 652c 2073 686f  for bt.Size, sho
-00014300: 756c 6420 6265 2061 2074 7570 6c65 2e20  uld be a tuple. 
-00014310: 2229 290a 2020 2020 2020 2020 6966 206c  ")).        if l
-00014320: 656e 2873 6861 7065 2920 3e20 3020 616e  en(shape) > 0 an
-00014330: 6420 6e6f 7420 616c 6c5f 2869 7369 6e73  d not all_(isins
-00014340: 7461 6e63 6528 782c 206e 756d 5f29 2066  tance(x, num_) f
-00014350: 6f72 2078 2069 6e20 7368 6170 6529 3a0a  or x in shape):.
-00014360: 2020 2020 2020 2020 2020 2020 7261 775f              raw_
-00014370: 7368 6170 6520 3d20 636c 732e 5f5f 6e65  shape = cls.__ne
-00014380: 775f 7265 7072 5f5f 2873 6861 7065 290a  w_repr__(shape).
-00014390: 2020 2020 2020 2020 2020 2020 7368 6170              shap
-000143a0: 6520 3d20 7475 706c 6528 7261 775f 7368  e = tuple(raw_sh
-000143b0: 6170 6529 0a20 2020 2020 2020 2020 2020  ape).           
-000143c0: 2061 766f 7563 6828 6675 6e63 5f64 696d   avouch(func_dim
-000143d0: 2069 7320 4e6f 6e65 206f 7220 7261 775f   is None or raw_
-000143e0: 7368 6170 652e 737a 5f66 756e 635f 6469  shape.sz_func_di
-000143f0: 6d20 3d3d 2030 2c20 5479 7065 4572 726f  m == 0, TypeErro
-00014400: 7228 6622 496e 7661 6c69 6420 2773 6861  r(f"Invalid 'sha
-00014410: 7065 203d 207b 7368 6170 657d 3b20 6675  pe = {shape}; fu
-00014420: 6e63 5f64 696d 203d 207b 6675 6e63 5f64  nc_dim = {func_d
-00014430: 696d 7d27 2066 6f72 2062 742e 5369 7a65  im}' for bt.Size
-00014440: 2028 636f 6e66 6c69 6374 2069 6e20 6675   (conflict in fu
-00014450: 6e63 2064 696d 656e 7369 6f6e 292e 2229  nc dimension).")
-00014460: 290a 2020 2020 2020 2020 2020 2020 6176  ).            av
-00014470: 6f75 6368 2862 6174 6368 5f64 696d 2069  ouch(batch_dim i
-00014480: 7320 4e6f 6e65 206f 7220 7261 775f 7368  s None or raw_sh
-00014490: 6170 652e 737a 5f62 6174 6368 5f64 696d  ape.sz_batch_dim
-000144a0: 203d 3d20 302c 2054 7970 6545 7272 6f72   == 0, TypeError
-000144b0: 2866 2249 6e76 616c 6964 2027 7368 6170  (f"Invalid 'shap
-000144c0: 6520 3d20 7b73 6861 7065 7d3b 2062 6174  e = {shape}; bat
-000144d0: 6368 5f64 696d 203d 207b 6261 7463 685f  ch_dim = {batch_
-000144e0: 6469 6d7d 2720 666f 7220 6274 2e53 697a  dim}' for bt.Siz
-000144f0: 6520 2863 6f6e 666c 6963 7420 696e 2062  e (conflict in b
-00014500: 6174 6368 2064 696d 656e 7369 6f6e 292e  atch dimension).
-00014510: 2229 290a 2020 2020 2020 2020 2020 2020  ")).            
-00014520: 6176 6f75 6368 2863 6861 6e6e 656c 5f64  avouch(channel_d
-00014530: 696d 2069 7320 4e6f 6e65 2061 6e64 206e  im is None and n
-00014540: 5f66 6561 7475 7265 5f64 696d 2069 7320  _feature_dim is 
-00014550: 4e6f 6e65 206f 7220 7261 775f 7368 6170  None or raw_shap
-00014560: 652e 737a 5f66 6561 7475 7265 5f64 696d  e.sz_feature_dim
-00014570: 203d 3d20 3020 616e 6420 2863 6861 6e6e   == 0 and (chann
-00014580: 656c 5f64 696d 2069 7320 4e6f 6e65 206f  el_dim is None o
-00014590: 7220 6e5f 6665 6174 7572 655f 6469 6d20  r n_feature_dim 
-000145a0: 6973 204e 6f6e 6529 2c20 0a20 2020 2020  is None), .     
-000145b0: 2020 2020 2020 2020 2020 2020 2020 5479                Ty
-000145c0: 7065 4572 726f 7228 6622 496e 7661 6c69  peError(f"Invali
-000145d0: 6420 2773 6861 7065 203d 207b 7368 6170  d 'shape = {shap
-000145e0: 657d 3b20 6368 616e 6e65 6c5f 6469 6d20  e}; channel_dim 
-000145f0: 3d20 7b63 6861 6e6e 656c 5f64 696d 7d3b  = {channel_dim};
-00014600: 206e 5f66 6561 7475 7265 5f64 696d 203d   n_feature_dim =
-00014610: 207b 6e5f 6665 6174 7572 655f 6469 6d7d   {n_feature_dim}
-00014620: 2720 666f 7220 6274 2e53 697a 6520 2863  ' for bt.Size (c
-00014630: 6f6e 666c 6963 7420 696e 2066 6561 7475  onflict in featu
-00014640: 7265 2064 696d 656e 7369 6f6e 7329 2e22  re dimensions)."
-00014650: 2929 0a20 2020 2020 2020 2020 2020 2061  )).            a
-00014660: 766f 7563 6828 7365 7175 656e 6365 5f64  vouch(sequence_d
-00014670: 696d 2069 7320 4e6f 6e65 2061 6e64 206e  im is None and n
-00014680: 5f73 6571 7565 6e63 655f 6469 6d20 6973  _sequence_dim is
-00014690: 204e 6f6e 6520 6f72 2072 6177 5f73 6861   None or raw_sha
-000146a0: 7065 2e73 7a5f 7365 7175 656e 6365 5f64  pe.sz_sequence_d
-000146b0: 696d 203d 3d20 3020 616e 6420 2873 6571  im == 0 and (seq
-000146c0: 7565 6e63 655f 6469 6d20 6973 204e 6f6e  uence_dim is Non
-000146d0: 6520 6f72 206e 5f73 6571 7565 6e63 655f  e or n_sequence_
-000146e0: 6469 6d20 6973 204e 6f6e 6529 2c20 0a20  dim is None), . 
-000146f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014700: 2020 5479 7065 4572 726f 7228 6622 496e    TypeError(f"In
-00014710: 7661 6c69 6420 2773 6861 7065 203d 207b  valid 'shape = {
-00014720: 7368 6170 657d 3b20 7365 7175 656e 6365  shape}; sequence
-00014730: 5f64 696d 203d 207b 7365 7175 656e 6365  _dim = {sequence
-00014740: 5f64 696d 7d3b 206e 5f73 6571 7565 6e63  _dim}; n_sequenc
-00014750: 655f 6469 6d20 3d20 7b6e 5f73 6571 7565  e_dim = {n_seque
-00014760: 6e63 655f 6469 6d7d 2720 666f 7220 6274  nce_dim}' for bt
-00014770: 2e53 697a 6520 2863 6f6e 666c 6963 7420  .Size (conflict 
-00014780: 696e 2073 6571 7565 6e63 6520 6469 6d65  in sequence dime
-00014790: 6e73 696f 6e73 292e 2229 290a 2020 2020  nsions).")).    
-000147a0: 2020 2020 2020 2020 6966 2072 6177 5f73          if raw_s
-000147b0: 6861 7065 2e73 7a5f 6675 6e63 5f64 696d  hape.sz_func_dim
-000147c0: 2021 3d20 303a 0a20 2020 2020 2020 2020   != 0:.         
-000147d0: 2020 2020 2020 2061 766f 7563 6828 737a         avouch(sz
-000147e0: 5f66 756e 635f 6469 6d20 6973 204e 6f6e  _func_dim is Non
-000147f0: 652c 2054 7970 6545 7272 6f72 2822 436f  e, TypeError("Co
-00014800: 6e66 6c69 6374 2061 7267 756d 656e 7473  nflict arguments
-00014810: 2064 7572 696e 6720 7468 6520 6372 6561   during the crea
-00014820: 7469 6f6e 206f 6620 5369 7a65 3a20 737a  tion of Size: sz
-00014830: 5f66 756e 635f 6469 6d22 2929 0a20 2020  _func_dim")).   
-00014840: 2020 2020 2020 2020 2020 2020 2073 7a5f               sz_
-00014850: 6675 6e63 5f64 696d 203d 2072 6177 5f73  func_dim = raw_s
-00014860: 6861 7065 2e73 7a5f 6675 6e63 5f64 696d  hape.sz_func_dim
-00014870: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00014880: 7261 775f 7368 6170 652e 737a 5f62 6174  raw_shape.sz_bat
-00014890: 6368 5f64 696d 2021 3d20 303a 0a20 2020  ch_dim != 0:.   
-000148a0: 2020 2020 2020 2020 2020 2020 2061 766f               avo
-000148b0: 7563 6828 737a 5f62 6174 6368 5f64 696d  uch(sz_batch_dim
-000148c0: 2069 7320 4e6f 6e65 2c20 5479 7065 4572   is None, TypeEr
-000148d0: 726f 7228 2243 6f6e 666c 6963 7420 6172  ror("Conflict ar
-000148e0: 6775 6d65 6e74 7320 6475 7269 6e67 2074  guments during t
-000148f0: 6865 2063 7265 6174 696f 6e20 6f66 2053  he creation of S
-00014900: 697a 653a 2073 7a5f 6261 7463 685f 6469  ize: sz_batch_di
-00014910: 6d22 2929 0a20 2020 2020 2020 2020 2020  m")).           
-00014920: 2020 2020 2073 7a5f 6261 7463 685f 6469       sz_batch_di
-00014930: 6d20 3d20 7261 775f 7368 6170 652e 737a  m = raw_shape.sz
-00014940: 5f62 6174 6368 5f64 696d 0a20 2020 2020  _batch_dim.     
-00014950: 2020 2020 2020 2069 6620 7261 775f 7368         if raw_sh
-00014960: 6170 652e 737a 5f66 6561 7475 7265 5f64  ape.sz_feature_d
-00014970: 696d 2021 3d20 303a 0a20 2020 2020 2020  im != 0:.       
-00014980: 2020 2020 2020 2020 2061 766f 7563 6828           avouch(
-00014990: 737a 5f66 6561 7475 7265 5f64 696d 2069  sz_feature_dim i
-000149a0: 7320 4e6f 6e65 2c20 5479 7065 4572 726f  s None, TypeErro
-000149b0: 7228 2243 6f6e 666c 6963 7420 6172 6775  r("Conflict argu
-000149c0: 6d65 6e74 7320 6475 7269 6e67 2074 6865  ments during the
-000149d0: 2063 7265 6174 696f 6e20 6f66 2053 697a   creation of Siz
-000149e0: 653a 2073 7a5f 6665 6174 7572 655f 6469  e: sz_feature_di
-000149f0: 6d22 2929 0a20 2020 2020 2020 2020 2020  m")).           
-00014a00: 2020 2020 2073 7a5f 6665 6174 7572 655f       sz_feature_
-00014a10: 6469 6d20 3d20 7261 775f 7368 6170 652e  dim = raw_shape.
-00014a20: 737a 5f66 6561 7475 7265 5f64 696d 0a20  sz_feature_dim. 
-00014a30: 2020 2020 2020 2020 2020 2069 6620 7261             if ra
-00014a40: 775f 7368 6170 652e 737a 5f73 6571 7565  w_shape.sz_seque
-00014a50: 6e63 655f 6469 6d20 213d 2030 3a0a 2020  nce_dim != 0:.  
-00014a60: 2020 2020 2020 2020 2020 2020 2020 6176                av
-00014a70: 6f75 6368 2873 7a5f 7365 7175 656e 6365  ouch(sz_sequence
-00014a80: 5f64 696d 2069 7320 4e6f 6e65 2c20 5479  _dim is None, Ty
-00014a90: 7065 4572 726f 7228 2243 6f6e 666c 6963  peError("Conflic
-00014aa0: 7420 6172 6775 6d65 6e74 7320 6475 7269  t arguments duri
-00014ab0: 6e67 2074 6865 2063 7265 6174 696f 6e20  ng the creation 
-00014ac0: 6f66 2053 697a 653a 2073 7a5f 7365 7175  of Size: sz_sequ
-00014ad0: 656e 6365 5f64 696d 2229 290a 2020 2020  ence_dim")).    
-00014ae0: 2020 2020 2020 2020 2020 2020 737a 5f73              sz_s
-00014af0: 6571 7565 6e63 655f 6469 6d20 3d20 7261  equence_dim = ra
-00014b00: 775f 7368 6170 652e 737a 5f73 6571 7565  w_shape.sz_seque
-00014b10: 6e63 655f 6469 6d0a 2020 2020 2020 2020  nce_dim.        
-00014b20: 6966 2073 7a5f 6675 6e63 5f64 696d 2069  if sz_func_dim i
-00014b30: 7320 4e6f 6e65 3a20 737a 5f66 756e 635f  s None: sz_func_
-00014b40: 6469 6d20 3d20 300a 2020 2020 2020 2020  dim = 0.        
-00014b50: 6966 2073 7a5f 6261 7463 685f 6469 6d20  if sz_batch_dim 
-00014b60: 6973 204e 6f6e 653a 2073 7a5f 6261 7463  is None: sz_batc
-00014b70: 685f 6469 6d20 3d20 300a 2020 2020 2020  h_dim = 0.      
-00014b80: 2020 6966 2073 7a5f 6665 6174 7572 655f    if sz_feature_
-00014b90: 6469 6d20 6973 204e 6f6e 653a 2073 7a5f  dim is None: sz_
-00014ba0: 6665 6174 7572 655f 6469 6d20 3d20 300a  feature_dim = 0.
-00014bb0: 2020 2020 2020 2020 6966 2073 7a5f 7365          if sz_se
-00014bc0: 7175 656e 6365 5f64 696d 2069 7320 4e6f  quence_dim is No
-00014bd0: 6e65 3a20 737a 5f73 6571 7565 6e63 655f  ne: sz_sequence_
-00014be0: 6469 6d20 3d20 300a 2020 2020 2020 2020  dim = 0.        
-00014bf0: 6e5f 6469 6d20 3d20 6c65 6e28 7368 6170  n_dim = len(shap
-00014c00: 6529 0a20 2020 2020 2020 2023 2044 6561  e).        # Dea
-00014c10: 6c20 7769 7468 2074 6865 2066 756e 6320  l with the func 
-00014c20: 6469 6d65 6e73 696f 6e0a 2020 2020 2020  dimension.      
-00014c30: 2020 6966 2073 7a5f 6675 6e63 5f64 696d    if sz_func_dim
-00014c40: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-00014c50: 2020 2066 756e 635f 6361 6e64 7320 3d20     func_cands = 
-00014c60: 284e 6f6e 652c 2030 2c20 2d6e 5f64 696d  (None, 0, -n_dim
-00014c70: 2c20 6e5f 6469 6d2d 312c 202d 3129 0a20  , n_dim-1, -1). 
-00014c80: 2020 2020 2020 2020 2020 2061 766f 7563             avouc
-00014c90: 6828 6675 6e63 5f64 696d 2069 6e20 6675  h(func_dim in fu
-00014ca0: 6e63 5f63 616e 6473 2c20 5479 7065 4572  nc_cands, TypeEr
-00014cb0: 726f 7228 6622 496e 7661 6c69 6420 2766  ror(f"Invalid 'f
-00014cc0: 756e 635f 6469 6d20 3d20 7b66 756e 635f  unc_dim = {func_
-00014cd0: 6469 6d7d 2720 666f 7220 6274 2e53 697a  dim}' for bt.Siz
-00014ce0: 652c 2073 686f 756c 6420 6265 204e 6f6e  e, should be Non
-00014cf0: 6520 6f72 207b 6675 6e63 5f63 616e 6473  e or {func_cands
-00014d00: 5b31 5d7d 2028 6265 666f 7265 2074 6865  [1]} (before the
-00014d10: 2073 7061 6365 2d73 6571 7565 6e63 6520   space-sequence 
-00014d20: 6469 6d65 6e73 696f 6e73 292c 206f 7220  dimensions), or 
-00014d30: 7b66 756e 635f 6361 6e64 735b 2d31 5d7d  {func_cands[-1]}
-00014d40: 2028 6166 7465 7220 7468 6520 7370 6163   (after the spac
-00014d50: 652d 7365 7175 656e 6365 2064 696d 656e  e-sequence dimen
-00014d60: 7369 6f6e 7329 2e20 2229 290a 2020 2020  sions). ")).    
-00014d70: 2020 2020 2020 2020 737a 5f66 756e 635f          sz_func_
-00014d80: 6469 6d20 3d20 3020 6966 2066 756e 635f  dim = 0 if func_
-00014d90: 6469 6d20 6973 204e 6f6e 6520 656c 7365  dim is None else
-00014da0: 2028 3120 6966 2066 756e 635f 6469 6d20   (1 if func_dim 
-00014db0: 696e 2028 302c 202d 6e5f 6469 6d29 2065  in (0, -n_dim) e
-00014dc0: 6c73 6520 2d31 290a 2020 2020 2020 2020  lse -1).        
-00014dd0: 2320 4465 616c 2077 6974 6820 7468 6520  # Deal with the 
-00014de0: 6261 7463 6820 6469 6d65 6e73 696f 6e0a  batch dimension.
-00014df0: 2020 2020 2020 2020 6966 2073 7a5f 6261          if sz_ba
-00014e00: 7463 685f 6469 6d20 3d3d 2030 3a0a 2020  tch_dim == 0:.  
-00014e10: 2020 2020 2020 2020 2020 6261 7463 685f            batch_
-00014e20: 6361 6e64 7320 3d20 284e 6f6e 652c 200a  cands = (None, .
-00014e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e40: 2020 2020 2020 2020 2020 206d 6178 5f28             max_(
-00014e50: 737a 5f66 756e 635f 6469 6d2c 2030 292c  sz_func_dim, 0),
-00014e60: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00014e70: 2020 2020 2020 2020 2020 2020 206d 6178               max
-00014e80: 5f28 737a 5f66 756e 635f 6469 6d2c 2030  _(sz_func_dim, 0
-00014e90: 2920 2d20 6e5f 6469 6d2c 200a 2020 2020  ) - n_dim, .    
-00014ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014eb0: 2020 2020 2020 206e 5f64 696d 202d 2031         n_dim - 1
-00014ec0: 202b 206d 696e 5f28 737a 5f66 756e 635f   + min_(sz_func_
-00014ed0: 6469 6d2c 2030 292c 200a 2020 2020 2020  dim, 0), .      
-00014ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ef0: 2020 2020 206d 696e 5f28 737a 5f66 756e       min_(sz_fun
-00014f00: 635f 6469 6d2c 2030 2920 2d20 3129 0a20  c_dim, 0) - 1). 
-00014f10: 2020 2020 2020 2020 2020 2061 766f 7563             avouc
-00014f20: 6828 6261 7463 685f 6469 6d20 696e 2062  h(batch_dim in b
-00014f30: 6174 6368 5f63 616e 6473 2c20 5479 7065  atch_cands, Type
-00014f40: 4572 726f 7228 6622 496e 7661 6c69 6420  Error(f"Invalid 
-00014f50: 2762 6174 6368 5f64 696d 203d 207b 6261  'batch_dim = {ba
-00014f60: 7463 685f 6469 6d7d 2720 666f 7220 6274  tch_dim}' for bt
-00014f70: 2e53 697a 652c 2073 686f 756c 6420 6265  .Size, should be
-00014f80: 204e 6f6e 6520 6f72 207b 6261 7463 685f   None or {batch_
-00014f90: 6361 6e64 735b 315d 7d20 2862 6566 6f72  cands[1]} (befor
-00014fa0: 6520 7468 6520 7370 6163 652d 7365 7175  e the space-sequ
-00014fb0: 656e 6365 2064 696d 656e 7369 6f6e 7329  ence dimensions)
-00014fc0: 2c20 6f72 207b 6261 7463 685f 6361 6e64  , or {batch_cand
-00014fd0: 735b 2d31 5d7d 2028 6166 7465 7220 7468  s[-1]} (after th
-00014fe0: 6520 7370 6163 652d 7365 7175 656e 6365  e space-sequence
-00014ff0: 2064 696d 656e 7369 6f6e 7329 2e20 2229   dimensions). ")
-00015000: 290a 2020 2020 2020 2020 2020 2020 737a  ).            sz
-00015010: 5f62 6174 6368 5f64 696d 203d 2030 2069  _batch_dim = 0 i
-00015020: 6620 6261 7463 685f 6469 6d20 6973 204e  f batch_dim is N
-00015030: 6f6e 6520 656c 7365 2028 3120 6966 2062  one else (1 if b
-00015040: 6174 6368 5f64 696d 2069 6e20 2830 2c20  atch_dim in (0, 
-00015050: 2d6e 5f64 696d 2920 656c 7365 202d 3129  -n_dim) else -1)
-00015060: 0a20 2020 2020 2020 2023 2044 6561 6c20  .        # Deal 
-00015070: 7769 7468 2074 6865 2066 6561 7475 7265  with the feature
-00015080: 2064 696d 656e 7369 6f6e 2873 290a 2020   dimension(s).  
-00015090: 2020 2020 2020 6966 2073 7a5f 6665 6174        if sz_feat
-000150a0: 7572 655f 6469 6d20 3d3d 2030 3a0a 2020  ure_dim == 0:.  
-000150b0: 2020 2020 2020 2020 2020 6966 206e 5f66            if n_f
-000150c0: 6561 7475 7265 5f64 696d 2069 7320 4e6f  eature_dim is No
-000150d0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000150e0: 2020 2020 6368 616e 6e65 6c5f 6361 6e64      channel_cand
-000150f0: 7320 3d20 284e 6f6e 652c 200a 2020 2020  s = (None, .    
-00015100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015110: 2020 2020 2020 2020 2020 2020 206d 6178               max
-00015120: 5f28 737a 5f66 756e 635f 6469 6d2c 2030  _(sz_func_dim, 0
-00015130: 2920 2b20 6d61 785f 2873 7a5f 6261 7463  ) + max_(sz_batc
-00015140: 685f 6469 6d2c 2030 292c 200a 2020 2020  h_dim, 0), .    
-00015150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015160: 2020 2020 2020 2020 2020 2020 206d 6178               max
-00015170: 5f28 737a 5f66 756e 635f 6469 6d2c 2030  _(sz_func_dim, 0
-00015180: 2920 2b20 6d61 785f 2873 7a5f 6261 7463  ) + max_(sz_batc
-00015190: 685f 6469 6d2c 2030 2920 2d20 6e5f 6469  h_dim, 0) - n_di
-000151a0: 6d2c 200a 2020 2020 2020 2020 2020 2020  m, .            
-000151b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151c0: 2020 2020 206e 5f64 696d 202d 2031 202b       n_dim - 1 +
-000151d0: 206d 696e 5f28 737a 5f66 756e 635f 6469   min_(sz_func_di
-000151e0: 6d2c 2030 2920 2b20 6d69 6e5f 2873 7a5f  m, 0) + min_(sz_
-000151f0: 6261 7463 685f 6469 6d2c 2030 292c 200a  batch_dim, 0), .
-00015200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015220: 206d 696e 5f28 737a 5f66 756e 635f 6469   min_(sz_func_di
-00015230: 6d2c 2030 2920 2b20 6d69 6e5f 2873 7a5f  m, 0) + min_(sz_
-00015240: 6261 7463 685f 6469 6d2c 2030 2920 2d20  batch_dim, 0) - 
-00015250: 3129 0a20 2020 2020 2020 2020 2020 2020  1).             
-00015260: 2020 2061 766f 7563 6828 6368 616e 6e65     avouch(channe
-00015270: 6c5f 6469 6d20 696e 2063 6861 6e6e 656c  l_dim in channel
-00015280: 5f63 616e 6473 2c20 5479 7065 4572 726f  _cands, TypeErro
-00015290: 7228 6622 496e 7661 6c69 6420 2763 6861  r(f"Invalid 'cha
-000152a0: 6e6e 656c 5f64 696d 203d 207b 6368 616e  nnel_dim = {chan
-000152b0: 6e65 6c5f 6469 6d7d 2720 666f 7220 6274  nel_dim}' for bt
-000152c0: 2e53 697a 652c 2073 686f 756c 6420 6265  .Size, should be
-000152d0: 204e 6f6e 6520 6f72 207b 6368 616e 6e65   None or {channe
-000152e0: 6c5f 6361 6e64 735b 315d 7d20 2862 6566  l_cands[1]} (bef
-000152f0: 6f72 6520 7468 6520 7370 6163 652d 7365  ore the space-se
-00015300: 7175 656e 6365 2064 696d 656e 7369 6f6e  quence dimension
-00015310: 7329 2c20 6f72 207b 6368 616e 6e65 6c5f  s), or {channel_
-00015320: 6361 6e64 735b 2d31 5d7d 2028 6166 7465  cands[-1]} (afte
-00015330: 7220 7468 6520 7370 6163 652d 7365 7175  r the space-sequ
-00015340: 656e 6365 2064 696d 656e 7369 6f6e 7329  ence dimensions)
-00015350: 2e20 2229 290a 2020 2020 2020 2020 2020  . ")).          
-00015360: 2020 2020 2020 737a 5f66 6561 7475 7265        sz_feature
-00015370: 5f64 696d 203d 2030 2069 6620 6368 616e  _dim = 0 if chan
-00015380: 6e65 6c5f 6469 6d20 6973 204e 6f6e 6520  nel_dim is None 
-00015390: 656c 7365 2028 3120 6966 2063 6861 6e6e  else (1 if chann
-000153a0: 656c 5f64 696d 2069 6e20 6368 616e 6e65  el_dim in channe
-000153b0: 6c5f 6361 6e64 735b 313a 335d 2065 6c73  l_cands[1:3] els
-000153c0: 6520 2d31 290a 2020 2020 2020 2020 2020  e -1).          
-000153d0: 2020 656c 6966 2063 6861 6e6e 656c 5f64    elif channel_d
-000153e0: 696d 2069 7320 6e6f 7420 4e6f 6e65 3a20  im is not None: 
-000153f0: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
-00015400: 2241 7267 756d 656e 7420 2763 6861 6e6e  "Argument 'chann
-00015410: 656c 5f64 696d 2720 6973 2063 6f6e 666c  el_dim' is confl
-00015420: 6963 7420 746f 2027 6e5f 6665 6174 7572  ict to 'n_featur
-00015430: 655f 6469 6d27 2066 6f72 2062 742e 5369  e_dim' for bt.Si
-00015440: 7a65 2c20 7468 6579 2063 616e 6e6f 7420  ze, they cannot 
-00015450: 6265 2061 7373 6967 6e65 6420 7369 6d75  be assigned simu
-00015460: 6c74 616e 656f 7573 6c79 2e20 2229 0a20  ltaneously. "). 
-00015470: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00015480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015490: 2061 766f 7563 6828 6973 696e 7374 616e   avouch(isinstan
-000154a0: 6365 286e 5f66 6561 7475 7265 5f64 696d  ce(n_feature_dim
-000154b0: 2c20 696e 745f 2920 616e 6420 6e5f 6665  , int_) and n_fe
-000154c0: 6174 7572 655f 6469 6d20 3e3d 2030 2c20  ature_dim >= 0, 
-000154d0: 5479 7065 4572 726f 7228 6622 496e 7661  TypeError(f"Inva
-000154e0: 6c69 6420 276e 5f66 6561 7475 7265 5f64  lid 'n_feature_d
-000154f0: 696d 203d 207b 6e5f 6665 6174 7572 655f  im = {n_feature_
-00015500: 6469 6d7d 2720 666f 7220 6274 2e53 697a  dim}' for bt.Siz
-00015510: 652c 2073 686f 756c 6420 6265 2061 6e20  e, should be an 
-00015520: 696e 7465 6765 722e 2022 2929 0a20 2020  integer. ")).   
-00015530: 2020 2020 2020 2020 2020 2020 2073 7a5f               sz_
-00015540: 6665 6174 7572 655f 6469 6d20 3d20 6e5f  feature_dim = n_
-00015550: 6665 6174 7572 655f 6469 6d0a 2020 2020  feature_dim.    
-00015560: 2020 2020 2320 4465 616c 2077 6974 6820      # Deal with 
-00015570: 7468 6520 7365 7175 656e 6365 2064 696d  the sequence dim
-00015580: 656e 7369 6f6e 2873 290a 2020 2020 2020  ension(s).      
-00015590: 2020 6966 2073 7a5f 7365 7175 656e 6365    if sz_sequence
-000155a0: 5f64 696d 203d 3d20 303a 0a20 2020 2020  _dim == 0:.     
-000155b0: 2020 2020 2020 2069 6620 6e5f 7365 7175         if n_sequ
-000155c0: 656e 6365 5f64 696d 2069 7320 4e6f 6e65  ence_dim is None
-000155d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000155e0: 2020 7365 7175 656e 6365 5f63 616e 6473    sequence_cands
-000155f0: 203d 2028 4e6f 6e65 2c20 0a20 2020 2020   = (None, .     
-00015600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015610: 2020 2020 2020 2020 2020 2020 206d 6178               max
-00015620: 5f28 737a 5f66 756e 635f 6469 6d2c 2030  _(sz_func_dim, 0
-00015630: 2920 2b20 6d61 785f 2873 7a5f 6261 7463  ) + max_(sz_batc
-00015640: 685f 6469 6d2c 2030 2920 2b20 6d61 785f  h_dim, 0) + max_
-00015650: 2873 7a5f 6665 6174 7572 655f 6469 6d2c  (sz_feature_dim,
-00015660: 2030 292c 200a 2020 2020 2020 2020 2020   0), .          
-00015670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015680: 2020 2020 2020 2020 6d61 785f 2873 7a5f          max_(sz_
-00015690: 6675 6e63 5f64 696d 2c20 3029 202b 206d  func_dim, 0) + m
-000156a0: 6178 5f28 737a 5f62 6174 6368 5f64 696d  ax_(sz_batch_dim
-000156b0: 2c20 3029 202b 206d 6178 5f28 737a 5f66  , 0) + max_(sz_f
-000156c0: 6561 7475 7265 5f64 696d 2c20 3029 202d  eature_dim, 0) -
-000156d0: 206e 5f64 696d 2c20 0a20 2020 2020 2020   n_dim, .       
-000156e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000156f0: 2020 2020 2020 2020 2020 206e 5f64 696d             n_dim
-00015700: 202d 2031 202b 206d 696e 5f28 737a 5f66   - 1 + min_(sz_f
-00015710: 756e 635f 6469 6d2c 2030 2920 2b20 6d69  unc_dim, 0) + mi
-00015720: 6e5f 2873 7a5f 6261 7463 685f 6469 6d2c  n_(sz_batch_dim,
-00015730: 2030 2920 2b20 6d69 6e5f 2873 7a5f 6665   0) + min_(sz_fe
-00015740: 6174 7572 655f 6469 6d2c 2030 292c 200a  ature_dim, 0), .
-00015750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015770: 2020 6d69 6e5f 2873 7a5f 6675 6e63 5f64    min_(sz_func_d
-00015780: 696d 2c20 3029 202b 206d 696e 5f28 737a  im, 0) + min_(sz
-00015790: 5f62 6174 6368 5f64 696d 2c20 3029 202b  _batch_dim, 0) +
-000157a0: 206d 696e 5f28 737a 5f66 6561 7475 7265   min_(sz_feature
-000157b0: 5f64 696d 2c20 3029 202d 2031 290a 2020  _dim, 0) - 1).  
-000157c0: 2020 2020 2020 2020 2020 2020 2020 6176                av
-000157d0: 6f75 6368 2873 6571 7565 6e63 655f 6469  ouch(sequence_di
-000157e0: 6d20 696e 2073 6571 7565 6e63 655f 6361  m in sequence_ca
-000157f0: 6e64 732c 2054 7970 6545 7272 6f72 2866  nds, TypeError(f
-00015800: 2249 6e76 616c 6964 2027 7365 7175 656e  "Invalid 'sequen
-00015810: 6365 5f64 696d 203d 207b 7365 7175 656e  ce_dim = {sequen
-00015820: 6365 5f64 696d 7d27 2066 6f72 2062 742e  ce_dim}' for bt.
-00015830: 5369 7a65 2c20 7368 6f75 6c64 2062 6520  Size, should be 
-00015840: 6f6e 6520 6f66 204e 6f6e 652c 207b 7365  one of None, {se
-00015850: 7175 656e 6365 5f63 616e 6473 5b31 5d7d  quence_cands[1]}
-00015860: 2028 6265 666f 7265 2074 6865 2073 7061   (before the spa
-00015870: 6365 2064 696d 656e 7369 6f6e 7329 2c20  ce dimensions), 
-00015880: 6f72 207b 7365 7175 656e 6365 5f63 616e  or {sequence_can
-00015890: 6473 5b2d 315d 7d20 2861 6674 6572 2074  ds[-1]} (after t
-000158a0: 6865 2073 7061 6365 2064 696d 656e 7369  he space dimensi
-000158b0: 6f6e 7329 2229 290a 2020 2020 2020 2020  ons)")).        
-000158c0: 2020 2020 2020 2020 737a 5f73 6571 7565          sz_seque
-000158d0: 6e63 655f 6469 6d20 3d20 3020 6966 2073  nce_dim = 0 if s
-000158e0: 6571 7565 6e63 655f 6469 6d20 6973 204e  equence_dim is N
-000158f0: 6f6e 6520 656c 7365 2028 3120 6966 2073  one else (1 if s
-00015900: 6571 7565 6e63 655f 6469 6d20 696e 2073  equence_dim in s
-00015910: 6571 7565 6e63 655f 6361 6e64 735b 313a  equence_cands[1:
-00015920: 335d 2065 6c73 6520 2d31 290a 2020 2020  3] else -1).    
-00015930: 2020 2020 2020 2020 656c 6966 2073 6571          elif seq
-00015940: 7565 6e63 655f 6469 6d20 6973 206e 6f74  uence_dim is not
-00015950: 204e 6f6e 653a 2072 6169 7365 2054 7970   None: raise Typ
-00015960: 6545 7272 6f72 2822 4172 6775 6d65 6e74  eError("Argument
-00015970: 2027 7365 7175 656e 6365 5f64 696d 2720   'sequence_dim' 
-00015980: 6973 2063 6f6e 666c 6963 7420 746f 2027  is conflict to '
-00015990: 6e5f 7365 7175 656e 6365 5f64 696d 2720  n_sequence_dim' 
-000159a0: 666f 7220 6274 2e53 697a 652c 2074 6865  for bt.Size, the
-000159b0: 7920 6361 6e6e 6f74 2062 6520 6173 7369  y cannot be assi
-000159c0: 676e 6564 2073 696d 756c 7461 6e65 6f75  gned simultaneou
-000159d0: 736c 792e 2022 290a 2020 2020 2020 2020  sly. ").        
-000159e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000159f0: 2020 2020 2020 2020 2020 6176 6f75 6368            avouch
-00015a00: 2869 7369 6e73 7461 6e63 6528 6e5f 7365  (isinstance(n_se
-00015a10: 7175 656e 6365 5f64 696d 2c20 696e 745f  quence_dim, int_
-00015a20: 2920 616e 6420 6e5f 7365 7175 656e 6365  ) and n_sequence
-00015a30: 5f64 696d 203e 3d20 302c 2054 7970 6545  _dim >= 0, TypeE
-00015a40: 7272 6f72 2866 2249 6e76 616c 6964 2027  rror(f"Invalid '
-00015a50: 6e5f 7365 7175 656e 6365 5f64 696d 203d  n_sequence_dim =
-00015a60: 207b 6e5f 7365 7175 656e 6365 5f64 696d   {n_sequence_dim
-00015a70: 7d27 2066 6f72 2062 742e 5369 7a65 2c20  }' for bt.Size, 
-00015a80: 7368 6f75 6c64 2062 6520 616e 2069 6e74  should be an int
-00015a90: 6567 6572 2e20 2229 290a 2020 2020 2020  eger. ")).      
-00015aa0: 2020 2020 2020 2020 2020 737a 5f73 6571            sz_seq
-00015ab0: 7565 6e63 655f 6469 6d20 3d20 2d20 6e5f  uence_dim = - n_
-00015ac0: 7365 7175 656e 6365 5f64 696d 0a20 2020  sequence_dim.   
-00015ad0: 2020 2020 2023 2043 6865 636b 2064 696d       # Check dim
-00015ae0: 656e 7369 6f6e 2063 6f6e 7369 7374 656e  ension consisten
-00015af0: 6379 0a20 2020 2020 2020 2061 766f 7563  cy.        avouc
-00015b00: 6828 6162 735f 2873 7a5f 6675 6e63 5f64  h(abs_(sz_func_d
-00015b10: 696d 2920 2b20 6162 735f 2873 7a5f 6261  im) + abs_(sz_ba
-00015b20: 7463 685f 6469 6d29 202b 2061 6273 5f28  tch_dim) + abs_(
-00015b30: 737a 5f66 6561 7475 7265 5f64 696d 2920  sz_feature_dim) 
-00015b40: 2b20 6162 735f 2873 7a5f 7365 7175 656e  + abs_(sz_sequen
-00015b50: 6365 5f64 696d 2920 3c3d 206e 5f64 696d  ce_dim) <= n_dim
-00015b60: 2c20 5479 7065 4572 726f 7228 6622 546f  , TypeError(f"To
-00015b70: 6f20 6d61 6e79 2073 7065 6369 616c 2064  o many special d
-00015b80: 696d 656e 7369 6f6e 7320 666f 7220 7368  imensions for sh
-00015b90: 6170 6520 6f66 206c 656e 6774 6820 7b6e  ape of length {n
-00015ba0: 5f64 696d 7d2e 2022 2929 0a20 2020 2020  _dim}. ")).     
-00015bb0: 2020 2072 6574 7572 6e20 636c 732e 5f5f     return cls.__
-00015bc0: 6e65 775f 7261 775f 5f28 7368 6170 652c  new_raw__(shape,
-00015bd0: 2073 7a5f 6675 6e63 5f64 696d 3d73 7a5f   sz_func_dim=sz_
-00015be0: 6675 6e63 5f64 696d 2c20 737a 5f62 6174  func_dim, sz_bat
-00015bf0: 6368 5f64 696d 3d73 7a5f 6261 7463 685f  ch_dim=sz_batch_
-00015c00: 6469 6d2c 2073 7a5f 6665 6174 7572 655f  dim, sz_feature_
-00015c10: 6469 6d3d 737a 5f66 6561 7475 7265 5f64  dim=sz_feature_d
-00015c20: 696d 2c20 737a 5f73 6571 7565 6e63 655f  im, sz_sequence_
-00015c30: 6469 6d3d 737a 5f73 6571 7565 6e63 655f  dim=sz_sequence_
-00015c40: 6469 6d29 0a0a 2020 2020 4063 6c61 7373  dim)..    @class
-00015c50: 6d65 7468 6f64 0a20 2020 2064 6566 205f  method.    def _
-00015c60: 5f6e 6577 5f72 6570 725f 5f28 636c 732c  _new_repr__(cls,
-00015c70: 2073 6861 7065 293a 0a20 2020 2020 2020   shape):.       
-00015c80: 2022 2222 0a20 2020 2020 2020 2054 6865   """.        The
-00015c90: 2063 6f6e 7374 7275 6374 6f72 2075 7369   constructor usi
-00015ca0: 6e67 2070 7974 686f 6e20 7265 7072 6573  ng python repres
-00015cb0: 656e 7461 7469 6f6e 732e 2049 6e63 6c75  entations. Inclu
-00015cc0: 6469 6e67 3a0a 2020 2020 2020 2020 312e  ding:.        1.
-00015cd0: 2028 6e5f 6675 6e63 2c29 2066 6f72 2066   (n_func,) for f
-00015ce0: 756e 6374 696f 6e61 6c20 6469 6d65 6e73  unctional dimens
-00015cf0: 696f 6e2c 200a 2020 2020 2020 2020 322e  ion, .        2.
-00015d00: 207b 6e5f 6261 7463 687d 2066 6f72 2062   {n_batch} for b
-00015d10: 6174 6368 2064 696d 656e 7369 6f6e 2c20  atch dimension, 
-00015d20: 0a20 2020 2020 2020 2033 2e20 5b6e 5f66  .        3. [n_f
-00015d30: 6561 7475 7265 5d20 666f 7220 6665 6174  eature] for feat
-00015d40: 7572 6520 6469 6d65 6e73 696f 6e73 2c0a  ure dimensions,.
-00015d50: 2020 2020 2020 2020 342e 2027 6e5f 7365          4. 'n_se
-00015d60: 7175 656e 6365 2720 666f 7220 7365 7175  quence' for sequ
-00015d70: 656e 6365 2064 696d 656e 7369 6f6e 732c  ence dimensions,
-00015d80: 0a20 2020 2020 2020 2035 2e20 696e 7465  .        5. inte
-00015d90: 6765 7273 2066 6f72 206f 7264 696e 6172  gers for ordinar
-00015da0: 7920 7370 6163 6520 6469 6d65 6e73 696f  y space dimensio
-00015db0: 6e73 2e20 0a0a 2020 2020 2020 2020 4578  ns. ..        Ex
-00015dc0: 616d 706c 6573 3a3a 0a20 2020 2020 2020  amples::.       
-00015dd0: 2020 2020 203e 3e3e 2073 203d 2062 742e       >>> s = bt.
-00015de0: 5369 7a65 287b 327d 2c20 5b33 5d2c 205b  Size({2}, [3], [
-00015df0: 342c 2035 5d2c 2036 2c20 372c 2027 3827  4, 5], 6, 7, '8'
-00015e00: 290a 2020 2020 2020 2020 2020 2020 3e3e  ).            >>
-00015e10: 3e20 730a 2020 2020 2020 2020 2020 2020  > s.            
-00015e20: 6261 746f 7263 682e 5369 7a65 287b 327d  batorch.Size({2}
-00015e30: 2c20 5b33 2c20 342c 2035 5d2c 2036 2c20  , [3, 4, 5], 6, 
-00015e40: 372c 2027 3827 290a 2020 2020 2020 2020  7, '8').        
-00015e50: 2020 2020 3e3e 3e20 732e 6665 6174 7572      >>> s.featur
-00015e60: 650a 2020 2020 2020 2020 2020 2020 6261  e.            ba
-00015e70: 746f 7263 682e 5369 7a65 285b 332c 2034  torch.Size([3, 4
-00015e80: 2c20 355d 290a 2020 2020 2020 2020 2020  , 5]).          
-00015e90: 2020 3e3e 3e20 732e 7769 7468 5f66 6561    >>> s.with_fea
-00015ea0: 7475 7265 2832 290a 2020 2020 2020 2020  ture(2).        
-00015eb0: 2020 2020 6261 746f 7263 682e 5369 7a65      batorch.Size
-00015ec0: 287b 327d 2c20 5b32 5d2c 2036 2c20 372c  ({2}, [2], 6, 7,
-00015ed0: 2027 3827 290a 2020 2020 2020 2020 2020   '8').          
-00015ee0: 2020 3e3e 3e20 7320 3c3c 2032 2023 2070    >>> s << 2 # p
-00015ef0: 6164 6469 6e67 0a20 2020 2020 2020 2020  adding.         
-00015f00: 2020 2062 6174 6f72 6368 2e53 697a 6528     batorch.Size(
-00015f10: 7b32 7d2c 205b 332c 2034 2c20 355d 2c20  {2}, [3, 4, 5], 
-00015f20: 382c 2039 2c20 2738 2729 0a20 2020 2020  8, 9, '8').     
-00015f30: 2020 2020 2020 203e 3e3e 2073 202a 2a20         >>> s ** 
-00015f40: 3220 2320 7265 7065 6174 2074 6f20 656e  2 # repeat to en
-00015f50: 6c61 7267 650a 2020 2020 2020 2020 2020  large.          
-00015f60: 2020 6261 746f 7263 682e 5369 7a65 287b    batorch.Size({
-00015f70: 327d 2c20 5b33 2c20 342c 2035 5d2c 2031  2}, [3, 4, 5], 1
-00015f80: 322c 2031 342c 2027 3827 290a 2020 2020  2, 14, '8').    
-00015f90: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00015fa0: 737a 5f66 756e 635f 6469 6d20 3d20 300a  sz_func_dim = 0.
-00015fb0: 2020 2020 2020 2020 737a 5f62 6174 6368          sz_batch
-00015fc0: 5f64 696d 203d 2030 0a20 2020 2020 2020  _dim = 0.       
-00015fd0: 2073 7a5f 6665 6174 7572 655f 6469 6d20   sz_feature_dim 
-00015fe0: 3d20 300a 2020 2020 2020 2020 737a 5f73  = 0.        sz_s
-00015ff0: 6571 7565 6e63 655f 6469 6d20 3d20 300a  equence_dim = 0.
-00016000: 2020 2020 2020 2020 7261 775f 7369 7a65          raw_size
-00016010: 203d 205b 5d0a 2020 2020 2020 2020 6375   = [].        cu
-00016020: 6d5f 6920 3d20 300a 2020 2020 2020 2020  m_i = 0.        
-00016030: 656e 6473 5f77 6974 685f 6675 6e63 203d  ends_with_func =
-00016040: 2046 616c 7365 0a20 2020 2020 2020 2065   False.        e
-00016050: 6e64 735f 7769 7468 5f62 6174 6368 203d  nds_with_batch =
-00016060: 2046 616c 7365 0a20 2020 2020 2020 2065   False.        e
-00016070: 6e64 735f 7769 7468 5f66 6561 7475 7265  nds_with_feature
-00016080: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00016090: 2065 6e64 735f 7769 7468 5f73 6571 7565   ends_with_seque
-000160a0: 6e63 6520 3d20 4661 6c73 650a 2020 2020  nce = False.    
-000160b0: 2020 2020 666f 7220 692c 2073 2069 6e20      for i, s in 
-000160c0: 656e 756d 6572 6174 6528 7368 6170 6529  enumerate(shape)
-000160d0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000160e0: 2069 7369 6e73 7461 6e63 6528 732c 2074   isinstance(s, t
-000160f0: 7570 6c65 293a 2023 2066 756e 6374 696f  uple): # functio
-00016100: 6e61 6c20 6469 6d65 6e73 696f 6e0a 2020  nal dimension.  
-00016110: 2020 2020 2020 2020 2020 2020 2020 6176                av
-00016120: 6f75 6368 2873 7a5f 6675 6e63 5f64 696d  ouch(sz_func_dim
-00016130: 203d 3d20 302c 2054 7970 6545 7272 6f72   == 0, TypeError
-00016140: 2866 2249 6e76 616c 6964 2027 7368 6170  (f"Invalid 'shap
-00016150: 6520 3d20 7b73 6861 7065 7d27 2066 6f72  e = {shape}' for
-00016160: 2062 742e 5369 7a65 2028 636f 6e66 6c69   bt.Size (confli
-00016170: 6374 206f 6620 6d75 6c74 6970 6c65 2066  ct of multiple f
-00016180: 756e 6374 696f 6e61 6c20 6469 6d65 6e73  unctional dimens
-00016190: 696f 6e73 292e 2229 290a 2020 2020 2020  ions).")).      
-000161a0: 2020 2020 2020 2020 2020 6176 6f75 6368            avouch
-000161b0: 286c 656e 2873 2920 3d3d 2031 2061 6e64  (len(s) == 1 and
-000161c0: 2069 7369 6e73 7461 6e63 6528 735b 305d   isinstance(s[0]
-000161d0: 2c20 6e75 6d5f 2920 6f72 206c 656e 2873  , num_) or len(s
-000161e0: 2920 3d3d 2030 2c20 5479 7065 4572 726f  ) == 0, TypeErro
-000161f0: 7228 6622 496e 7661 6c69 6420 2773 6861  r(f"Invalid 'sha
-00016200: 7065 203d 207b 7368 6170 657d 2720 666f  pe = {shape}' fo
-00016210: 7220 6274 2e53 697a 6520 286f 6e6c 7920  r bt.Size (only 
-00016220: 2878 2c29 2069 7320 6176 6169 6c61 626c  (x,) is availabl
-00016230: 6520 666f 7220 6675 6e63 7469 6f6e 616c  e for functional
-00016240: 2064 696d 656e 7369 6f6e 292e 2229 290a   dimension).")).
-00016250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016260: 6176 6f75 6368 2869 2069 6e20 2830 2c20  avouch(i in (0, 
-00016270: 6c65 6e28 7368 6170 6529 202d 2031 292c  len(shape) - 1),
-00016280: 2054 7970 6545 7272 6f72 2866 2249 6e76   TypeError(f"Inv
-00016290: 616c 6964 2027 7368 6170 6520 3d20 7b73  alid 'shape = {s
-000162a0: 6861 7065 7d27 2066 6f72 2062 742e 5369  hape}' for bt.Si
-000162b0: 7a65 2028 6675 6e63 7469 6f6e 616c 2064  ze (functional d
-000162c0: 696d 656e 7369 6f6e 2063 616e 206f 6e6c  imension can onl
-000162d0: 7920 6265 2074 6865 2066 6972 7374 2f6c  y be the first/l
-000162e0: 6173 7420 6469 6d65 6e73 696f 6e29 2e22  ast dimension)."
-000162f0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00016300: 2020 2069 6620 6c65 6e28 7329 203d 3d20     if len(s) == 
-00016310: 303a 2072 6177 5f73 697a 652e 6170 7065  0: raw_size.appe
-00016320: 6e64 282d 3129 0a20 2020 2020 2020 2020  nd(-1).         
-00016330: 2020 2020 2020 2065 6c73 653a 2072 6177         else: raw
-00016340: 5f73 697a 652e 6170 7065 6e64 2873 5b30  _size.append(s[0
-00016350: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-00016360: 2020 2069 6620 6920 3d3d 2030 3a0a 2020     if i == 0:.  
-00016370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016380: 2020 737a 5f66 756e 635f 6469 6d20 3d20    sz_func_dim = 
-00016390: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-000163a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000163b0: 2020 2020 2020 2020 2020 2020 737a 5f66              sz_f
-000163c0: 756e 635f 6469 6d20 3d20 2d31 0a20 2020  unc_dim = -1.   
-000163d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163e0: 2065 6e64 735f 7769 7468 5f66 756e 6320   ends_with_func 
-000163f0: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-00016400: 2020 2020 2020 2063 756d 5f69 202b 3d20         cum_i += 
-00016410: 310a 2020 2020 2020 2020 2020 2020 656c  1.            el
-00016420: 6966 2069 7369 6e73 7461 6e63 6528 732c  if isinstance(s,
-00016430: 2028 6469 6374 2c20 7365 7429 293a 2023   (dict, set)): #
-00016440: 2062 6174 6368 2064 696d 656e 7369 6f6e   batch dimension
-00016450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016460: 2061 766f 7563 6828 737a 5f62 6174 6368   avouch(sz_batch
-00016470: 5f64 696d 203d 3d20 302c 2054 7970 6545  _dim == 0, TypeE
-00016480: 7272 6f72 2866 2249 6e76 616c 6964 2027  rror(f"Invalid '
-00016490: 7368 6170 6520 3d20 7b73 6861 7065 7d27  shape = {shape}'
-000164a0: 2066 6f72 2062 742e 5369 7a65 2028 636f   for bt.Size (co
-000164b0: 6e66 6c69 6374 206f 6620 6d75 6c74 6970  nflict of multip
-000164c0: 6c65 2062 6174 6368 2064 696d 656e 7369  le batch dimensi
-000164d0: 6f6e 7329 2e22 2929 0a20 2020 2020 2020  ons).")).       
-000164e0: 2020 2020 2020 2020 2061 766f 7563 6828           avouch(
-000164f0: 6973 696e 7374 616e 6365 2873 2c20 7365  isinstance(s, se
-00016500: 7429 2061 6e64 206c 656e 2873 2920 3d3d  t) and len(s) ==
-00016510: 2031 206f 7220 6c65 6e28 7329 203d 3d20   1 or len(s) == 
-00016520: 302c 2054 7970 6545 7272 6f72 2866 2249  0, TypeError(f"I
-00016530: 6e76 616c 6964 2027 7368 6170 6520 3d20  nvalid 'shape = 
-00016540: 7b73 6861 7065 7d27 2066 6f72 2062 742e  {shape}' for bt.
-00016550: 5369 7a65 2028 6e6f 2064 6963 7420 6974  Size (no dict it
-00016560: 656d 2069 7320 616c 6c6f 7765 642c 206f  em is allowed, o
-00016570: 6e6c 7920 7b7b 787d 7d20 6f72 207b 7b7d  nly {{x}} or {{}
-00016580: 7d20 6172 6520 6176 6169 6c61 626c 6529  } are available)
-00016590: 2e22 2929 0a20 2020 2020 2020 2020 2020  .")).           
-000165a0: 2020 2020 2061 766f 7563 6828 6e6f 7420       avouch(not 
-000165b0: 656e 6473 5f77 6974 685f 6675 6e63 2c20  ends_with_func, 
-000165c0: 5479 7065 4572 726f 7228 6622 496e 7661  TypeError(f"Inva
-000165d0: 6c69 6420 2773 6861 7065 203d 207b 7368  lid 'shape = {sh
-000165e0: 6170 657d 2720 666f 7220 6274 2e53 697a  ape}' for bt.Siz
-000165f0: 6520 2862 6174 6368 2064 696d 656e 7369  e (batch dimensi
-00016600: 6f6e 2063 616e 206f 6e6c 7920 6265 2074  on can only be t
-00016610: 6865 2066 6972 7374 2f6c 6173 7420 6469  he first/last di
-00016620: 6d65 6e73 696f 6e20 6170 6172 7420 6672  mension apart fr
-00016630: 6f6d 2074 6865 2066 756e 6374 696f 6e61  om the functiona
-00016640: 6c20 6469 6d65 6e73 696f 6e29 2e22 2929  l dimension)."))
-00016650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016660: 2061 766f 7563 6828 6920 696e 2028 6d61   avouch(i in (ma
-00016670: 785f 2873 7a5f 6675 6e63 5f64 696d 2c20  x_(sz_func_dim, 
-00016680: 3029 2c20 6c65 6e28 7368 6170 6529 202d  0), len(shape) -
-00016690: 2031 202b 206d 696e 5f28 737a 5f66 756e   1 + min_(sz_fun
-000166a0: 635f 6469 6d2c 2030 2929 2c20 5479 7065  c_dim, 0)), Type
-000166b0: 4572 726f 7228 6622 496e 7661 6c69 6420  Error(f"Invalid 
-000166c0: 2773 6861 7065 203d 207b 7368 6170 657d  'shape = {shape}
-000166d0: 2720 666f 7220 6274 2e53 697a 6520 2862  ' for bt.Size (b
-000166e0: 6174 6368 2064 696d 656e 7369 6f6e 2063  atch dimension c
-000166f0: 616e 206f 6e6c 7920 6265 2074 6865 2066  an only be the f
-00016700: 6972 7374 2f6c 6173 7420 6469 6d65 6e73  irst/last dimens
-00016710: 696f 6e20 6170 6172 7420 6672 6f6d 2074  ion apart from t
-00016720: 6865 2066 756e 6374 696f 6e61 6c20 6469  he functional di
-00016730: 6d65 6e73 696f 6e29 2e22 2929 0a20 2020  mension).")).   
-00016740: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00016750: 6c65 6e28 7329 203d 3d20 303a 2072 6177  len(s) == 0: raw
-00016760: 5f73 697a 652e 6170 7065 6e64 282d 3129  _size.append(-1)
-00016770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016780: 2065 6c73 653a 2078 203d 2073 2e70 6f70   else: x = s.pop
-00016790: 2829 3b20 7261 775f 7369 7a65 2e61 7070  (); raw_size.app
-000167a0: 656e 6428 7829 3b20 7368 6170 655b 695d  end(x); shape[i]
-000167b0: 2e61 6464 2878 290a 2020 2020 2020 2020  .add(x).        
-000167c0: 2020 2020 2020 2020 6966 2069 203d 3d20          if i == 
-000167d0: 6d61 785f 2873 7a5f 6675 6e63 5f64 696d  max_(sz_func_dim
-000167e0: 2c20 3029 3a0a 2020 2020 2020 2020 2020  , 0):.          
-000167f0: 2020 2020 2020 2020 2020 737a 5f62 6174            sz_bat
-00016800: 6368 5f64 696d 203d 2031 0a20 2020 2020  ch_dim = 1.     
-00016810: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00016820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016830: 2020 2020 2073 7a5f 6261 7463 685f 6469       sz_batch_di
-00016840: 6d20 3d20 2d31 0a20 2020 2020 2020 2020  m = -1.         
-00016850: 2020 2020 2020 2020 2020 2065 6e64 735f             ends_
-00016860: 7769 7468 5f62 6174 6368 203d 2054 7275  with_batch = Tru
-00016870: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00016880: 2020 6375 6d5f 6920 2b3d 2031 0a20 2020    cum_i += 1.   
-00016890: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-000168a0: 696e 7374 616e 6365 2873 2c20 6c69 7374  instance(s, list
-000168b0: 293a 2023 2066 6561 7475 7265 2064 696d  ): # feature dim
-000168c0: 656e 7369 6f6e 730a 2020 2020 2020 2020  ensions.        
-000168d0: 2020 2020 2020 2020 6176 6f75 6368 2873          avouch(s
-000168e0: 7a5f 6665 6174 7572 655f 6469 6d20 3c3d  z_feature_dim <=
-000168f0: 2030 206f 7220 6973 696e 7374 616e 6365   0 or isinstance
-00016900: 2873 6861 7065 5b69 2d31 5d2c 2028 7475  (shape[i-1], (tu
-00016910: 706c 652c 2064 6963 742c 2073 6574 2c20  ple, dict, set, 
-00016920: 6c69 7374 2929 2c20 0a20 2020 2020 2020  list)), .       
-00016930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016940: 5479 7065 4572 726f 7228 6622 496e 7661  TypeError(f"Inva
-00016950: 6c69 6420 2773 6861 7065 203d 207b 7368  lid 'shape = {sh
-00016960: 6170 657d 2720 666f 7220 6274 2e53 697a  ape}' for bt.Siz
-00016970: 6520 2866 6561 7475 7265 2064 696d 656e  e (feature dimen
-00016980: 7369 6f6e 7320 7368 6f75 6c64 2062 6520  sions should be 
-00016990: 6e65 6967 6862 6f72 696e 6720 6469 6d65  neighboring dime
-000169a0: 6e73 696f 6e73 292e 2229 290a 2020 2020  nsions).")).    
-000169b0: 2020 2020 2020 2020 2020 2020 6176 6f75              avou
-000169c0: 6368 2861 6c6c 5f28 5b69 7369 6e73 7461  ch(all_([isinsta
-000169d0: 6e63 6528 792c 206e 756d 5f29 2066 6f72  nce(y, num_) for
-000169e0: 2079 2069 6e20 735d 292c 2054 7970 6545   y in s]), TypeE
-000169f0: 7272 6f72 2866 2249 6e76 616c 6964 2027  rror(f"Invalid '
-00016a00: 7368 6170 6520 3d20 7b73 6861 7065 7d27  shape = {shape}'
-00016a10: 2066 6f72 2062 742e 5369 7a65 2028 7265   for bt.Size (re
-00016a20: 7072 6573 656e 7461 7469 6f6e 2066 6f72  presentation for
-00016a30: 2066 6561 7475 7265 2064 696d 656e 7369   feature dimensi
-00016a40: 6f6e 7320 7368 6f75 6c64 2062 6520 6120  ons should be a 
-00016a50: 6c69 7374 206f 6620 696e 7465 6765 7273  list of integers
-00016a60: 292e 2229 290a 2020 2020 2020 2020 2020  ).")).          
-00016a70: 2020 2020 2020 6176 6f75 6368 286e 6f74        avouch(not
-00016a80: 2065 6e64 735f 7769 7468 5f62 6174 6368   ends_with_batch
-00016a90: 2061 6e64 206e 6f74 2065 6e64 735f 7769   and not ends_wi
-00016aa0: 7468 5f66 756e 632c 2054 7970 6545 7272  th_func, TypeErr
-00016ab0: 6f72 2866 2249 6e76 616c 6964 2027 7368  or(f"Invalid 'sh
-00016ac0: 6170 6520 3d20 7b73 6861 7065 7d27 2066  ape = {shape}' f
-00016ad0: 6f72 2062 742e 5369 7a65 2028 6261 7463  or bt.Size (batc
-00016ae0: 6820 6469 6d65 6e73 696f 6e20 6361 6e20  h dimension can 
-00016af0: 6f6e 6c79 2062 6520 7468 6520 6669 7273  only be the firs
-00016b00: 742f 6c61 7374 2064 696d 656e 7369 6f6e  t/last dimension
-00016b10: 2061 7061 7274 2066 726f 6d20 7468 6520   apart from the 
-00016b20: 6675 6e63 7469 6f6e 616c 2064 696d 656e  functional dimen
-00016b30: 7369 6f6e 292e 2229 290a 2020 2020 2020  sion).")).      
-00016b40: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-00016b50: 2873 2920 3d3d 2030 3a20 7261 775f 7369  (s) == 0: raw_si
-00016b60: 7a65 2e61 7070 656e 6428 2d31 293b 206c  ze.append(-1); l
-00016b70: 656e 5f66 6561 7420 3d20 310a 2020 2020  en_feat = 1.    
-00016b80: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00016b90: 3a20 7261 775f 7369 7a65 2e65 7874 656e  : raw_size.exten
-00016ba0: 6428 7329 3b20 6c65 6e5f 6665 6174 203d  d(s); len_feat =
-00016bb0: 206c 656e 2873 290a 2020 2020 2020 2020   len(s).        
-00016bc0: 2020 2020 2020 2020 6966 2073 7a5f 6665          if sz_fe
-00016bd0: 6174 7572 655f 6469 6d20 3d3d 2030 3a0a  ature_dim == 0:.
-00016be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016bf0: 2020 2020 6966 2063 756d 5f69 203d 3d20      if cum_i == 
-00016c00: 6d61 785f 2873 7a5f 6675 6e63 5f64 696d  max_(sz_func_dim
-00016c10: 2c20 3029 202b 206d 6178 5f28 737a 5f62  , 0) + max_(sz_b
-00016c20: 6174 6368 5f64 696d 2c20 3029 3a20 737a  atch_dim, 0): sz
-00016c30: 5f66 6561 7475 7265 5f64 696d 203d 206c  _feature_dim = l
-00016c40: 656e 5f66 6561 740a 2020 2020 2020 2020  en_feat.        
-00016c50: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00016c60: 3a20 737a 5f66 6561 7475 7265 5f64 696d  : sz_feature_dim
-00016c70: 203d 202d 6c65 6e5f 6665 6174 0a20 2020   = -len_feat.   
-00016c80: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-00016c90: 6620 737a 5f66 6561 7475 7265 5f64 696d  f sz_feature_dim
-00016ca0: 203e 2030 3a20 737a 5f66 6561 7475 7265   > 0: sz_feature
-00016cb0: 5f64 696d 202b 3d20 6c65 6e5f 6665 6174  _dim += len_feat
-00016cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016cd0: 2065 6c73 653a 2073 7a5f 6665 6174 7572   else: sz_featur
-00016ce0: 655f 6469 6d20 2d3d 206c 656e 5f66 6561  e_dim -= len_fea
-00016cf0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-00016d00: 2020 6966 2073 7a5f 6665 6174 7572 655f    if sz_feature_
-00016d10: 6469 6d20 3c20 303a 2065 6e64 735f 7769  dim < 0: ends_wi
-00016d20: 7468 5f66 6561 7475 7265 203d 2054 7275  th_feature = Tru
-00016d30: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00016d40: 2020 6375 6d5f 6920 2b3d 206c 656e 5f66    cum_i += len_f
-00016d50: 6561 740a 2020 2020 2020 2020 2020 2020  eat.            
-00016d60: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-00016d70: 732c 2073 7472 293a 2023 2073 6571 7565  s, str): # seque
-00016d80: 6e63 6520 6469 6d65 6e73 696f 6e73 0a20  nce dimensions. 
-00016d90: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00016da0: 5f76 616c 203d 202d 3120 6966 2073 203d  _val = -1 if s =
-00016db0: 3d20 2727 2065 6c73 6520 746f 7563 6828  = '' else touch(
-00016dc0: 6c61 6d62 6461 3a20 6576 616c 2873 2929  lambda: eval(s))
-00016dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016de0: 2061 766f 7563 6828 737a 5f73 6571 7565   avouch(sz_seque
-00016df0: 6e63 655f 6469 6d20 3c3d 2030 206f 7220  nce_dim <= 0 or 
-00016e00: 6973 696e 7374 616e 6365 2873 6861 7065  isinstance(shape
-00016e10: 5b69 2d31 5d2c 2028 7475 706c 652c 2064  [i-1], (tuple, d
-00016e20: 6963 742c 2073 6574 2c20 6c69 7374 2c20  ict, set, list, 
-00016e30: 7374 7229 292c 0a20 2020 2020 2020 2020  str)),.         
-00016e40: 2020 2020 2020 2020 2020 2020 2020 5479                Ty
-00016e50: 7065 4572 726f 7228 6622 496e 7661 6c69  peError(f"Invali
-00016e60: 6420 2773 6861 7065 203d 207b 7368 6170  d 'shape = {shap
-00016e70: 657d 2720 666f 7220 6274 2e53 697a 6520  e}' for bt.Size 
-00016e80: 2873 6571 7565 6e63 6520 6469 6d65 6e73  (sequence dimens
-00016e90: 696f 6e73 2073 686f 756c 6420 6265 206e  ions should be n
-00016ea0: 6569 6768 626f 7269 6e67 2064 696d 656e  eighboring dimen
-00016eb0: 7369 6f6e 7329 2e22 2929 0a20 2020 2020  sions).")).     
-00016ec0: 2020 2020 2020 2020 2020 2061 766f 7563             avouc
-00016ed0: 6828 735f 7661 6c20 6973 206e 6f74 204e  h(s_val is not N
-00016ee0: 6f6e 652c 2054 7970 6545 7272 6f72 2866  one, TypeError(f
-00016ef0: 2249 6e76 616c 6964 2027 7368 6170 6520  "Invalid 'shape 
-00016f00: 3d20 7b73 6861 7065 7d27 2066 6f72 2062  = {shape}' for b
-00016f10: 742e 5369 7a65 2028 7265 7072 6573 656e  t.Size (represen
-00016f20: 7461 7469 6f6e 2066 6f72 2073 6571 7565  tation for seque
-00016f30: 6e63 6520 6469 6d65 6e73 696f 6e73 2073  nce dimensions s
-00016f40: 686f 756c 6420 6265 2061 206c 6973 7420  hould be a list 
-00016f50: 6f66 2069 6e74 6567 6572 7329 2e22 2929  of integers)."))
-00016f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016f70: 2061 766f 7563 6828 6e6f 7420 656e 6473   avouch(not ends
-00016f80: 5f77 6974 685f 6665 6174 7572 6520 616e  _with_feature an
-00016f90: 6420 6e6f 7420 656e 6473 5f77 6974 685f  d not ends_with_
-00016fa0: 6261 7463 6820 616e 6420 6e6f 7420 656e  batch and not en
-00016fb0: 6473 5f77 6974 685f 6675 6e63 2c20 5479  ds_with_func, Ty
-00016fc0: 7065 4572 726f 7228 6622 496e 7661 6c69  peError(f"Invali
-00016fd0: 6420 2773 6861 7065 203d 207b 7368 6170  d 'shape = {shap
-00016fe0: 657d 2720 666f 7220 6274 2e53 697a 6520  e}' for bt.Size 
-00016ff0: 2866 6561 7475 7265 2064 696d 656e 7369  (feature dimensi
-00017000: 6f6e 7320 6361 6e20 6f6e 6c79 2062 6520  ons can only be 
-00017010: 7468 6520 6669 7273 742f 6c61 7374 2064  the first/last d
-00017020: 696d 656e 7369 6f6e 7320 6170 6172 7420  imensions apart 
-00017030: 6672 6f6d 2074 6865 2066 756e 6374 696f  from the functio
-00017040: 6e61 6c2f 6261 7463 6820 6469 6d65 6e73  nal/batch dimens
-00017050: 696f 6e73 292e 2229 290a 2020 2020 2020  ions).")).      
-00017060: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00017070: 2069 7369 6e73 7461 6e63 6528 735f 7661   isinstance(s_va
-00017080: 6c2c 2074 7570 6c65 293a 2073 5f76 616c  l, tuple): s_val
-00017090: 203d 2028 735f 7661 6c2c 290a 2020 2020   = (s_val,).    
-000170a0: 2020 2020 2020 2020 2020 2020 735f 7661              s_va
-000170b0: 6c20 3d20 6c69 7374 2873 5f76 616c 290a  l = list(s_val).
-000170c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000170d0: 6176 6f75 6368 2861 6c6c 5f28 5b69 7369  avouch(all_([isi
-000170e0: 6e73 7461 6e63 6528 792c 206e 756d 5f29  nstance(y, num_)
-000170f0: 2066 6f72 2079 2069 6e20 735f 7661 6c5d   for y in s_val]
-00017100: 292c 2054 7970 6545 7272 6f72 2866 2249  ), TypeError(f"I
-00017110: 6e76 616c 6964 2027 7368 6170 6520 3d20  nvalid 'shape = 
-00017120: 7b73 6861 7065 7d27 2066 6f72 2062 742e  {shape}' for bt.
-00017130: 5369 7a65 2028 7265 7072 6573 656e 7461  Size (representa
-00017140: 7469 6f6e 2066 6f72 2073 6571 7565 6e63  tion for sequenc
-00017150: 6520 6469 6d65 6e73 696f 6e73 2073 686f  e dimensions sho
-00017160: 756c 6420 6265 2061 206c 6973 7420 6f66  uld be a list of
-00017170: 2069 6e74 6567 6572 7329 2e22 2929 0a20   integers).")). 
-00017180: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00017190: 6177 5f73 697a 652e 6578 7465 6e64 2873  aw_size.extend(s
-000171a0: 5f76 616c 293b 206c 656e 5f73 7173 203d  _val); len_sqs =
-000171b0: 206c 656e 2873 5f76 616c 290a 2020 2020   len(s_val).    
-000171c0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-000171d0: 7a5f 7365 7175 656e 6365 5f64 696d 203d  z_sequence_dim =
-000171e0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-000171f0: 2020 2020 2020 2020 2065 6e64 735f 7769           ends_wi
-00017200: 7468 5f73 6571 7565 6e63 6520 3d20 6375  th_sequence = cu
-00017210: 6d5f 6920 3e20 6d61 785f 2873 7a5f 6675  m_i > max_(sz_fu
-00017220: 6e63 5f64 696d 2c20 3029 202b 206d 6178  nc_dim, 0) + max
-00017230: 5f28 737a 5f62 6174 6368 5f64 696d 2c20  _(sz_batch_dim, 
-00017240: 3029 202b 206d 6178 5f28 737a 5f66 6561  0) + max_(sz_fea
-00017250: 7475 7265 5f64 696d 2c20 3029 0a20 2020  ture_dim, 0).   
-00017260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017270: 2073 7a5f 7365 7175 656e 6365 5f64 696d   sz_sequence_dim
-00017280: 203d 202d 6c65 6e5f 7371 730a 2020 2020   = -len_sqs.    
-00017290: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-000172a0: 2073 7a5f 7365 7175 656e 6365 5f64 696d   sz_sequence_dim
-000172b0: 203e 2030 3a20 737a 5f73 6571 7565 6e63   > 0: sz_sequenc
-000172c0: 655f 6469 6d20 2b3d 206c 656e 5f73 7173  e_dim += len_sqs
-000172d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000172e0: 2065 6c73 653a 2073 7a5f 7365 7175 656e   else: sz_sequen
-000172f0: 6365 5f64 696d 202d 3d20 6c65 6e5f 7371  ce_dim -= len_sq
-00017300: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00017310: 2020 6375 6d5f 6920 2b3d 206c 656e 5f73    cum_i += len_s
-00017320: 7173 0a20 2020 2020 2020 2020 2020 2065  qs.            e
-00017330: 6c69 6620 6973 696e 7374 616e 6365 2873  lif isinstance(s
-00017340: 2c20 6e75 6d5f 293a 0a20 2020 2020 2020  , num_):.       
-00017350: 2020 2020 2020 2020 2061 766f 7563 6828           avouch(
-00017360: 6e6f 7420 656e 6473 5f77 6974 685f 7365  not ends_with_se
-00017370: 7175 656e 6365 2061 6e64 206e 6f74 2065  quence and not e
-00017380: 6e64 735f 7769 7468 5f66 6561 7475 7265  nds_with_feature
-00017390: 2061 6e64 206e 6f74 2065 6e64 735f 7769   and not ends_wi
-000173a0: 7468 5f62 6174 6368 2061 6e64 206e 6f74  th_batch and not
-000173b0: 2065 6e64 735f 7769 7468 5f66 756e 632c   ends_with_func,
-000173c0: 2054 7970 6545 7272 6f72 2866 2249 6e76   TypeError(f"Inv
-000173d0: 616c 6964 2027 7368 6170 6520 3d20 7b73  alid 'shape = {s
-000173e0: 6861 7065 7d27 2066 6f72 2062 742e 5369  hape}' for bt.Si
-000173f0: 7a65 2028 7365 7175 656e 6365 2064 696d  ze (sequence dim
-00017400: 656e 7369 6f6e 7320 6361 6e20 6f6e 6c79  ensions can only
-00017410: 2062 6520 7468 6520 6669 7273 742f 6c61   be the first/la
-00017420: 7374 2064 696d 656e 7369 6f6e 7320 6170  st dimensions ap
-00017430: 6172 7420 6672 6f6d 2074 6865 2066 756e  art from the fun
-00017440: 6374 696f 6e61 6c2f 6261 7463 682f 6665  ctional/batch/fe
-00017450: 6174 7572 6520 6469 6d65 6e73 696f 6e73  ature dimensions
-00017460: 292e 2229 290a 2020 2020 2020 2020 2020  ).")).          
-00017470: 2020 2020 2020 6966 2073 7a5f 7365 7175        if sz_sequ
-00017480: 656e 6365 5f64 696d 203c 2030 3a20 737a  ence_dim < 0: sz
-00017490: 5f73 6571 7565 6e63 655f 6469 6d20 3d20  _sequence_dim = 
-000174a0: 2d73 7a5f 7365 7175 656e 6365 5f64 696d  -sz_sequence_dim
-000174b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000174c0: 2072 6177 5f73 697a 652e 6170 7065 6e64   raw_size.append
-000174d0: 2873 290a 2020 2020 2020 2020 2020 2020  (s).            
-000174e0: 2020 2020 6375 6d5f 6920 2b3d 2031 0a20      cum_i += 1. 
-000174f0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00017500: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
-00017510: 2866 2249 6e76 616c 6964 2027 7368 6170  (f"Invalid 'shap
-00017520: 6520 3d20 7b73 6861 7065 7d27 2066 6f72  e = {shape}' for
-00017530: 2062 742e 5369 7a65 2028 6f6e 6c79 2028   bt.Size (only (
-00017540: 782c 2928 6675 6e63 7469 6f6e 616c 2064  x,)(functional d
-00017550: 696d 656e 7369 6f6e 292c 207b 7b78 7d7d  imension), {{x}}
-00017560: 2862 6174 6368 2064 696d 656e 7369 6f6e  (batch dimension
-00017570: 292c 207b 7b7d 7d28 6261 7463 6820 6469  ), {{}}(batch di
-00017580: 6d65 6e73 696f 6e20 7769 7468 2061 7262  mension with arb
-00017590: 6974 7261 7279 2073 697a 6529 2c20 5b78  itrary size), [x
-000175a0: 2c20 792c 202e 2e2e 5d28 6665 6174 7572  , y, ...](featur
-000175b0: 6520 6469 6d65 6e73 696f 6e73 292c 205b  e dimensions), [
-000175c0: 5d28 6665 6174 7572 6520 6469 6d65 6e73  ](feature dimens
-000175d0: 696f 6e20 7769 7468 2061 7262 6974 7261  ion with arbitra
-000175e0: 7279 2073 697a 6529 292c 2027 782c 2079  ry size)), 'x, y
-000175f0: 2c20 2e2e 2e27 2873 6571 7565 6e63 6520  , ...'(sequence 
-00017600: 6469 6d65 6e73 696f 6e73 292c 2061 6e64  dimensions), and
-00017610: 2027 2728 7365 7175 656e 6365 2064 696d   ''(sequence dim
-00017620: 656e 7369 6f6e 2077 6974 6820 6172 6269  ension with arbi
-00017630: 7472 6172 7920 7369 7a65 2920 6172 6520  trary size) are 
-00017640: 616c 6c6f 7765 6420 6173 2073 7065 6369  allowed as speci
-00017650: 616c 2064 696d 656e 7369 6f6e 7320 696e  al dimensions in
-00017660: 2062 742e 5369 7a65 292e 2229 0a0a 2020   bt.Size).")..  
-00017670: 2020 2020 2020 7265 7475 726e 2063 6c73        return cls
-00017680: 2e5f 5f6e 6577 5f72 6177 5f5f 2874 7570  .__new_raw__(tup
-00017690: 6c65 2872 6177 5f73 697a 6529 2c20 737a  le(raw_size), sz
-000176a0: 5f66 756e 635f 6469 6d3d 737a 5f66 756e  _func_dim=sz_fun
-000176b0: 635f 6469 6d2c 2073 7a5f 6261 7463 685f  c_dim, sz_batch_
-000176c0: 6469 6d3d 737a 5f62 6174 6368 5f64 696d  dim=sz_batch_dim
-000176d0: 2c20 737a 5f66 6561 7475 7265 5f64 696d  , sz_feature_dim
-000176e0: 3d73 7a5f 6665 6174 7572 655f 6469 6d2c  =sz_feature_dim,
-000176f0: 2073 7a5f 7365 7175 656e 6365 5f64 696d   sz_sequence_dim
-00017700: 3d73 7a5f 7365 7175 656e 6365 5f64 696d  =sz_sequence_dim
-00017710: 290a 0a20 2020 2064 6566 205f 5f6e 6577  )..    def __new
-00017720: 5f5f 2863 6c73 2c20 2a61 7267 732c 202a  __(cls, *args, *
-00017730: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-00017740: 2020 2222 220a 2020 2020 2020 2020 5468    """.        Th
-00017750: 6520 636f 6e73 7472 7563 7469 6f6e 2066  e construction f
-00017760: 756e 6374 696f 6e20 666f 7220 2762 742e  unction for 'bt.
-00017770: 5369 7a65 272e 200a 0a20 2020 2020 2020  Size'. ..       
-00017780: 2055 7361 6765 733a 0a20 2020 2020 2020   Usages:.       
-00017790: 2020 2020 2062 742e 5369 7a65 2873 6861       bt.Size(sha
-000177a0: 7065 3a20 746f 7263 682e 5465 6e73 6f72  pe: torch.Tensor
-000177b0: 2f62 742e 5465 6e73 6f72 2f62 742e 5369  /bt.Tensor/bt.Si
-000177c0: 7a65 2f67 656e 6572 6174 6f72 2f74 7570  ze/generator/tup
-000177d0: 6c65 2f73 7472 2c20 6261 7463 685f 6469  le/str, batch_di
-000177e0: 6d3d 4661 6c73 652c 206e 5f66 6561 7475  m=False, n_featu
-000177f0: 7265 5f64 696d 3d4e 6f6e 652c 206e 5f73  re_dim=None, n_s
-00017800: 6571 7565 6e63 655f 6469 6d3d 6e5f 7365  equence_dim=n_se
-00017810: 7175 656e 6365 5f64 696d 290a 2020 2020  quence_dim).    
-00017820: 2020 2020 2020 2020 6274 2e53 697a 6528          bt.Size(
-00017830: 2a73 6861 7065 3a20 7079 7468 6f6e 5f72  *shape: python_r
-00017840: 6570 725b 696e 742c 2064 6963 745b 305d  epr[int, dict[0]
-00017850: 2c20 7365 745b 315d 2c20 6c69 7374 5b5d  , set[1], list[]
-00017860: 2c20 7374 725d 2c20 6261 7463 685f 6469  , str], batch_di
-00017870: 6d3d 4661 6c73 652c 206e 5f66 6561 7475  m=False, n_featu
-00017880: 7265 5f64 696d 3d4e 6f6e 652c 206e 5f73  re_dim=None, n_s
-00017890: 6571 7565 6e63 655f 6469 6d3d 6e5f 7365  equence_dim=n_se
-000178a0: 7175 656e 6365 5f64 696d 290a 2020 2020  quence_dim).    
-000178b0: 2020 2020 2020 2020 4f6e 6520 6d61 7920          One may 
-000178c0: 7573 6520 2763 6861 6e6e 656c 5f64 696d  use 'channel_dim
-000178d0: 3d2a 2720 746f 2072 6570 6c61 6365 206e  =*' to replace n
-000178e0: 5f66 6561 7475 7265 5f64 696d 2069 6620  _feature_dim if 
-000178f0: 7468 6572 6520 6973 206f 6e6c 7920 6f6e  there is only on
-00017900: 6520 6665 6174 7572 6520 6469 6d65 6e73  e feature dimens
-00017910: 696f 6e2e 200a 2020 2020 2020 2020 2020  ion. .          
-00017920: 2020 616e 6420 2773 6571 7565 6e63 655f    and 'sequence_
-00017930: 6469 6d3d 2a27 2074 6f20 7265 706c 6163  dim=*' to replac
-00017940: 6520 6e5f 7365 7175 656e 6365 5f64 696d  e n_sequence_dim
-00017950: 2069 6620 7468 6572 6520 6973 206f 6e6c   if there is onl
-00017960: 7920 6f6e 6520 7365 7175 656e 6365 2064  y one sequence d
-00017970: 696d 656e 7369 6f6e 2e20 0a20 2020 2020  imension. .     
-00017980: 2020 200a 2020 2020 2020 2020 5761 726e     .        Warn
-00017990: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-000179a0: 2050 6c65 6173 6520 6265 2063 6172 6566   Please be caref
-000179b0: 756c 2075 7369 6e67 2070 7269 7661 7465  ul using private
-000179c0: 2075 7361 6765 7320 696e 636c 7564 696e   usages includin
-000179d0: 6720 6b65 7977 6f72 6473 2073 7461 7274  g keywords start
-000179e0: 696e 6720 7769 7468 2027 737a 5f27 2073  ing with 'sz_' s
-000179f0: 7563 6820 6173 2027 737a 5f62 6174 6368  uch as 'sz_batch
-00017a00: 5f64 696d 272e 200a 2020 2020 2020 2020  _dim'. .        
-00017a10: 4e6f 7465 2074 6861 7420 6f6e 6520 6361  Note that one ca
-00017a20: 6e6e 6f74 2063 7265 6174 6520 6120 6675  nnot create a fu
-00017a30: 6e63 7469 6f6e 616c 2064 696d 656e 7369  nctional dimensi
-00017a40: 6f6e 2062 7920 7079 7468 6f6e 2072 6570  on by python rep
-00017a50: 7265 7365 6e74 6174 696f 6e73 2c20 706c  resentations, pl
-00017a60: 6561 7365 2075 7365 2061 7267 756d 656e  ease use argumen
-00017a70: 7420 6073 7a5f 6675 6e63 5f64 696d 6020  t `sz_func_dim` 
-00017a80: 696e 7374 6561 642e 200a 0a20 2020 2020  instead. ..     
-00017a90: 2020 2045 7861 6d70 6c65 733a 3a0a 2020     Examples::.  
-00017aa0: 2020 2020 2020 2020 2020 3e3e 3e20 7320            >>> s 
-00017ab0: 3d20 6274 2e53 697a 6528 7b32 7d2c 205b  = bt.Size({2}, [
-00017ac0: 335d 2c20 5b34 2c20 355d 2c20 362c 2037  3], [4, 5], 6, 7
-00017ad0: 2c20 2738 2729 0a20 2020 2020 2020 2020  , '8').         
-00017ae0: 2020 203e 3e3e 2073 0a20 2020 2020 2020     >>> s.       
-00017af0: 2020 2020 2062 6174 6f72 6368 2e53 697a       batorch.Siz
-00017b00: 6528 7b32 7d2c 205b 332c 2034 2c20 355d  e({2}, [3, 4, 5]
-00017b10: 2c20 362c 2037 2c20 2738 2729 0a20 2020  , 6, 7, '8').   
-00017b20: 2020 2020 2020 2020 203e 3e3e 2073 2e66           >>> s.f
-00017b30: 6561 7475 7265 0a20 2020 2020 2020 2020  eature.         
-00017b40: 2020 2062 6174 6f72 6368 2e53 697a 6528     batorch.Size(
-00017b50: 5b33 2c20 342c 2035 5d29 0a20 2020 2020  [3, 4, 5]).     
-00017b60: 2020 2020 2020 203e 3e3e 2073 2e77 6974         >>> s.wit
-00017b70: 685f 6665 6174 7572 6528 3229 0a20 2020  h_feature(2).   
-00017b80: 2020 2020 2020 2020 2062 6174 6f72 6368           batorch
-00017b90: 2e53 697a 6528 7b32 7d2c 205b 325d 2c20  .Size({2}, [2], 
-00017ba0: 362c 2037 2c20 2738 2729 0a20 2020 2020  6, 7, '8').     
-00017bb0: 2020 2020 2020 203e 3e3e 2073 203c 3c20         >>> s << 
-00017bc0: 3220 2320 7061 6464 696e 670a 2020 2020  2 # padding.    
-00017bd0: 2020 2020 2020 2020 6261 746f 7263 682e          batorch.
-00017be0: 5369 7a65 287b 327d 2c20 5b33 2c20 342c  Size({2}, [3, 4,
-00017bf0: 2035 5d2c 2038 2c20 392c 2027 3827 290a   5], 8, 9, '8').
-00017c00: 2020 2020 2020 2020 2020 2020 3e3e 3e20              >>> 
-00017c10: 7320 2a2a 2032 2023 2072 6570 6561 7420  s ** 2 # repeat 
-00017c20: 746f 2065 6e6c 6172 6765 0a20 2020 2020  to enlarge.     
-00017c30: 2020 2020 2020 2062 6174 6f72 6368 2e53         batorch.S
-00017c40: 697a 6528 7b32 7d2c 205b 332c 2034 2c20  ize({2}, [3, 4, 
-00017c50: 355d 2c20 3132 2c20 3134 2c20 2738 2729  5], 12, 14, '8')
-00017c60: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00017c70: 2020 2020 2069 6620 6c65 6e28 6172 6773       if len(args
-00017c80: 2920 3d3d 2031 2061 6e64 2068 6173 6174  ) == 1 and hasat
-00017c90: 7472 2861 7267 735b 305d 2c20 2773 6861  tr(args[0], 'sha
-00017ca0: 7065 2729 3a20 6172 6773 203d 2028 6172  pe'): args = (ar
-00017cb0: 6773 5b30 5d2e 7368 6170 652c 290a 2020  gs[0].shape,).  
-00017cc0: 2020 2020 2020 6966 206c 656e 2861 7267        if len(arg
-00017cd0: 7329 203d 3d20 3120 616e 6420 6973 696e  s) == 1 and isin
-00017ce0: 7374 616e 6365 2861 7267 735b 305d 2c20  stance(args[0], 
-00017cf0: 4765 6e65 7261 746f 7229 3a20 7265 7475  Generator): retu
-00017d00: 726e 2063 6c73 2e5f 5f6e 6577 5f74 7570  rn cls.__new_tup
-00017d10: 6c65 5f5f 2874 7570 6c65 2861 7267 735b  le__(tuple(args[
-00017d20: 305d 292c 202a 2a6b 7761 7267 7329 0a20  0]), **kwargs). 
-00017d30: 2020 2020 2020 2069 6620 6c65 6e28 6172         if len(ar
-00017d40: 6773 2920 3d3d 2031 2061 6e64 2069 7369  gs) == 1 and isi
-00017d50: 6e73 7461 6e63 6528 6172 6773 5b30 5d2c  nstance(args[0],
-00017d60: 2046 616b 6553 697a 6529 3a20 7265 7475   FakeSize): retu
-00017d70: 726e 2063 6c73 2e5f 5f6e 6577 5f72 6177  rn cls.__new_raw
-00017d80: 5f5f 2874 7570 6c65 2861 7267 735b 305d  __(tuple(args[0]
-00017d90: 292c 202a 2a6b 7761 7267 7329 2e73 7065  ), **kwargs).spe
-00017da0: 6369 616c 5f66 726f 6d28 6172 6773 5b30  cial_from(args[0
-00017db0: 5d29 0a20 2020 2020 2020 2069 6620 6c65  ]).        if le
-00017dc0: 6e28 6172 6773 2920 3d3d 2031 2061 6e64  n(args) == 1 and
-00017dd0: 2069 7369 6e73 7461 6e63 6528 6172 6773   isinstance(args
-00017de0: 5b30 5d2c 2053 697a 6529 3a20 7265 7475  [0], Size): retu
-00017df0: 726e 2063 6c73 2e5f 5f6e 6577 5f73 697a  rn cls.__new_siz
-00017e00: 655f 5f28 6172 6773 5b30 5d2c 202a 2a6b  e__(args[0], **k
-00017e10: 7761 7267 7329 0a20 2020 2020 2020 2069  wargs).        i
-00017e20: 6620 6c65 6e28 6172 6773 2920 3d3d 2031  f len(args) == 1
-00017e30: 2061 6e64 2069 7369 6e73 7461 6e63 6528   and isinstance(
-00017e40: 6172 6773 5b30 5d2c 2074 7570 6c65 293a  args[0], tuple):
-00017e50: 2072 6574 7572 6e20 636c 732e 5f5f 6e65   return cls.__ne
-00017e60: 775f 7475 706c 655f 5f28 6172 6773 5b30  w_tuple__(args[0
-00017e70: 5d2c 202a 2a6b 7761 7267 7329 0a20 2020  ], **kwargs).   
-00017e80: 2020 2020 2069 6620 6c65 6e28 6172 6773       if len(args
-00017e90: 2920 3d3d 2031 2061 6e64 2069 7369 6e73  ) == 1 and isins
-00017ea0: 7461 6e63 6528 6172 6773 5b30 5d2c 2073  tance(args[0], s
-00017eb0: 7472 293a 0a20 2020 2020 2020 2020 2020  tr):.           
-00017ec0: 2069 6620 6172 6773 5b30 5d20 3d3d 2027   if args[0] == '
-00017ed0: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-00017ee0: 2020 206b 7761 7267 735b 2773 7a5f 7365     kwargs['sz_se
-00017ef0: 7175 656e 6365 5f64 696d 275d 203d 2031  quence_dim'] = 1
-00017f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017f10: 2072 6574 7572 6e20 636c 732e 5f5f 6e65   return cls.__ne
-00017f20: 775f 7475 706c 655f 5f28 282d 312c 292c  w_tuple__((-1,),
-00017f30: 202a 2a6b 7761 7267 7329 0a20 2020 2020   **kwargs).     
-00017f40: 2020 2020 2020 2069 6620 746f 7563 6828         if touch(
-00017f50: 6c61 6d62 6461 3a20 696e 745f 2861 7267  lambda: int_(arg
-00017f60: 735b 305d 2929 2069 7320 6e6f 7420 4e6f  s[0])) is not No
-00017f70: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00017f80: 2020 2020 6b77 6172 6773 5b27 737a 5f73      kwargs['sz_s
-00017f90: 6571 7565 6e63 655f 6469 6d27 5d20 3d20  equence_dim'] = 
-00017fa0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-00017fb0: 2020 7265 7475 726e 2063 6c73 2e5f 5f6e    return cls.__n
-00017fc0: 6577 5f74 7570 6c65 5f5f 2828 696e 745f  ew_tuple__((int_
-00017fd0: 2861 7267 735b 305d 292c 292c 202a 2a6b  (args[0]),), **k
-00017fe0: 7761 7267 7329 0a20 2020 2020 2020 2020  wargs).         
-00017ff0: 2020 2073 656c 6620 3d20 636c 732e 5f5f     self = cls.__
-00018000: 6e65 775f 7475 706c 655f 5f28 6576 616c  new_tuple__(eval
-00018010: 2861 7267 735b 305d 292c 202a 2a6b 7761  (args[0]), **kwa
-00018020: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
-00018030: 2069 6620 7365 6c66 2e6e 5f73 7065 6369   if self.n_speci
-00018040: 616c 5f64 696d 203e 2030 206f 7220 6172  al_dim > 0 or ar
-00018050: 6773 5b30 5d2e 7374 6172 7473 7769 7468  gs[0].startswith
-00018060: 2827 2827 293a 2072 6574 7572 6e20 7365  ('('): return se
-00018070: 6c66 0a20 2020 2020 2020 2020 2020 2072  lf.            r
-00018080: 6574 7572 6e20 7365 6c66 2e73 7a5f 7365  eturn self.sz_se
-00018090: 7175 656e 6365 5f64 696d 5f28 2d73 656c  quence_dim_(-sel
-000180a0: 662e 6e5f 6469 6d29 0a20 2020 2020 2020  f.n_dim).       
-000180b0: 2072 6574 7572 6e20 636c 732e 5f5f 6e65   return cls.__ne
-000180c0: 775f 7475 706c 655f 5f28 6172 6773 2c20  w_tuple__(args, 
-000180d0: 2a2a 6b77 6172 6773 290a 0a20 2020 2064  **kwargs)..    d
-000180e0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-000180f0: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
-00018100: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
-00018110: 2e73 7a5f 6675 6e63 5f64 696d 203d 2073  .sz_func_dim = s
-00018120: 656c 662e 737a 5f66 756e 635f 6469 6d0a  elf.sz_func_dim.
-00018130: 2020 2020 2020 2020 7365 6c66 2e73 7a5f          self.sz_
-00018140: 6261 7463 685f 6469 6d20 3d20 7365 6c66  batch_dim = self
-00018150: 2e73 7a5f 6261 7463 685f 6469 6d0a 2020  .sz_batch_dim.  
-00018160: 2020 2020 2020 7365 6c66 2e73 7a5f 6665        self.sz_fe
-00018170: 6174 7572 655f 6469 6d20 3d20 7365 6c66  ature_dim = self
-00018180: 2e73 7a5f 6665 6174 7572 655f 6469 6d0a  .sz_feature_dim.
-00018190: 2020 2020 2020 2020 7365 6c66 2e73 7a5f          self.sz_
-000181a0: 7365 7175 656e 6365 5f64 696d 203d 2073  sequence_dim = s
-000181b0: 656c 662e 737a 5f73 6571 7565 6e63 655f  elf.sz_sequence_
-000181c0: 6469 6d0a 2020 2020 2020 2020 7365 6c66  dim.        self
-000181d0: 2e6e 5f64 696d 203d 2073 656c 662e 6e5f  .n_dim = self.n_
-000181e0: 6469 6d0a 2020 2020 2020 2020 7365 6c66  dim.        self
-000181f0: 2e6e 6469 6d20 3d20 7365 6c66 2e6e 5f64  .ndim = self.n_d
-00018200: 696d 0a0a 2020 2020 2323 2066 756e 6374  im..    ## funct
-00018210: 696f 6e61 6c20 6469 6d65 6e73 696f 6e3a  ional dimension:
-00018220: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-00018230: 2020 2064 6566 2068 6173 5f66 756e 6328     def has_func(
-00018240: 7365 6c66 293a 2072 6574 7572 6e20 7365  self): return se
-00018250: 6c66 2e73 7a5f 6675 6e63 5f64 696d 2021  lf.sz_func_dim !
-00018260: 3d20 300a 0a20 2020 2040 616c 6961 7328  = 0..    @alias(
-00018270: 226e 6675 6e63 6469 6d22 290a 2020 2020  "nfuncdim").    
-00018280: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
-00018290: 6620 6e5f 6675 6e63 5f64 696d 2873 656c  f n_func_dim(sel
-000182a0: 6629 3a20 7265 7475 726e 2061 6273 5f28  f): return abs_(
-000182b0: 7365 6c66 2e73 7a5f 6675 6e63 5f64 696d  self.sz_func_dim
-000182c0: 290a 2020 2020 0a20 2020 2040 616c 6961  ).    .    @alia
-000182d0: 7328 2269 735f 6675 6e63 6469 6d22 290a  s("is_funcdim").
-000182e0: 2020 2020 6465 6620 6973 5f66 756e 635f      def is_func_
-000182f0: 6469 6d28 7365 6c66 2c20 6929 3a0a 2020  dim(self, i):.  
-00018300: 2020 2020 2020 6176 6f75 6368 2869 7369        avouch(isi
-00018310: 6e73 7461 6e63 6528 692c 2069 6e74 5f29  nstance(i, int_)
-00018320: 2c20 5479 7065 4572 726f 7228 6622 496e  , TypeError(f"In
-00018330: 7661 6c69 6420 6361 6c6c 2027 6973 5f66  valid call 'is_f
-00018340: 756e 635f 6469 6d28 7b69 7d29 273a 2074  unc_dim({i})': t
-00018350: 6865 2061 7267 756d 656e 7420 6973 206e  he argument is n
-00018360: 6f74 2061 6e20 696e 7465 6765 722e 2022  ot an integer. "
-00018370: 2929 0a20 2020 2020 2020 2069 6620 6e6f  )).        if no
-00018380: 7420 7365 6c66 2e68 6173 5f66 756e 633a  t self.has_func:
-00018390: 2072 6574 7572 6e20 4661 6c73 650a 2020   return False.  
-000183a0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-000183b0: 662e 737a 5f66 756e 635f 6469 6d20 3d3d  f.sz_func_dim ==
-000183c0: 2031 2061 6e64 2069 2069 6e20 2830 2c20   1 and i in (0, 
-000183d0: 2d73 656c 662e 6e5f 6469 6d29 206f 7220  -self.n_dim) or 
-000183e0: 7365 6c66 2e73 7a5f 6675 6e63 5f64 696d  self.sz_func_dim
-000183f0: 203d 3d20 2d31 2061 6e64 2069 2069 6e20   == -1 and i in 
-00018400: 2873 656c 662e 6e5f 6469 6d2d 312c 202d  (self.n_dim-1, -
-00018410: 3129 0a0a 2020 2020 4070 726f 7065 7274  1)..    @propert
-00018420: 790a 2020 2020 6465 6620 6675 6e63 5f64  y.    def func_d
-00018430: 696d 2873 656c 6629 3a0a 2020 2020 2020  im(self):.      
-00018440: 2020 7265 7475 726e 204e 6f6e 6520 6966    return None if
-00018450: 2073 656c 662e 737a 5f66 756e 635f 6469   self.sz_func_di
-00018460: 6d20 3d3d 2030 2065 6c73 6520 2830 2069  m == 0 else (0 i
-00018470: 6620 7365 6c66 2e73 7a5f 6675 6e63 5f64  f self.sz_func_d
-00018480: 696d 203e 2030 2065 6c73 6520 7365 6c66  im > 0 else self
-00018490: 2e6e 5f64 696d 2d31 290a 2020 2020 0a20  .n_dim-1).    . 
-000184a0: 2020 2040 616c 6961 7328 2266 756e 635f     @alias("func_
-000184b0: 6469 6d65 6e73 696f 6e22 290a 2020 2020  dimension").    
-000184c0: 4066 756e 635f 6469 6d2e 7365 7474 6572  @func_dim.setter
-000184d0: 0a20 2020 2064 6566 2066 756e 635f 6469  .    def func_di
-000184e0: 6d28 7365 6c66 2c20 6966 756e 6329 3a0a  m(self, ifunc):.
-000184f0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00018500: 656c 662e 7769 7468 5f66 756e 635f 6469  elf.with_func_di
-00018510: 6d28 6966 756e 6329 0a0a 2020 2020 4061  m(ifunc)..    @a
-00018520: 6c69 6173 2822 6675 6e63 5f64 696d 5f22  lias("func_dim_"
-00018530: 2c20 2266 756e 635f 6469 6d65 6e73 696f  , "func_dimensio
-00018540: 6e5f 2229 0a20 2020 2040 616c 6961 7328  n_").    @alias(
-00018550: 2277 6974 685f 6675 6e63 6469 6d22 290a  "with_funcdim").
-00018560: 2020 2020 6465 6620 7769 7468 5f66 756e      def with_fun
-00018570: 635f 6469 6d28 7365 6c66 2c20 6966 756e  c_dim(self, ifun
-00018580: 633a 2028 696e 742c 2062 6f6f 6c2c 206e  c: (int, bool, n
-00018590: 756c 6c29 293a 0a20 2020 2020 2020 2061  ull)):.        a
-000185a0: 766f 7563 6828 6966 756e 6320 6973 204e  vouch(ifunc is N
-000185b0: 6f6e 6520 6f72 2069 7369 6e73 7461 6e63  one or isinstanc
-000185c0: 6528 6966 756e 632c 2062 6f6f 6c5f 2920  e(ifunc, bool_) 
-000185d0: 6f72 2069 6675 6e63 2069 6e20 2830 2c20  or ifunc in (0, 
-000185e0: 2d73 656c 662e 6e5f 6469 6d2c 2073 656c  -self.n_dim, sel
-000185f0: 662e 6e5f 6469 6d2d 312c 202d 3129 2c20  f.n_dim-1, -1), 
-00018600: 5479 7065 4572 726f 7228 2227 6274 2e53  TypeError("'bt.S
-00018610: 697a 652e 7769 7468 5f66 756e 635f 6469  ize.with_func_di
-00018620: 6d27 206f 6e6c 7920 7461 6b65 7320 696e  m' only takes in
-00018630: 7075 7420 626f 6f6c 206f 7220 696e 7465  put bool or inte
-00018640: 6765 7220 302c 202d 312e 2229 290a 2020  ger 0, -1.")).  
-00018650: 2020 2020 2020 6966 2069 6675 6e63 206f        if ifunc o
-00018660: 7220 6973 696e 7374 616e 6365 2869 6675  r isinstance(ifu
-00018670: 6e63 2c20 696e 745f 293a 0a20 2020 2020  nc, int_):.     
-00018680: 2020 2020 2020 2061 766f 7563 6828 7365         avouch(se
-00018690: 6c66 2e6e 5f62 6174 6368 5f64 696d 202b  lf.n_batch_dim +
-000186a0: 2073 656c 662e 6e5f 6665 6174 7572 655f   self.n_feature_
-000186b0: 6469 6d20 2b20 7365 6c66 2e6e 5f73 6571  dim + self.n_seq
-000186c0: 7565 6e63 655f 6469 6d20 3c20 7365 6c66  uence_dim < self
-000186d0: 2e6e 5f64 696d 2c20 5479 7065 4572 726f  .n_dim, TypeErro
-000186e0: 7228 6622 4361 6e6e 6f74 2073 6574 2066  r(f"Cannot set f
-000186f0: 756e 635f 6469 6d20 666f 7220 7369 7a65  unc_dim for size
-00018700: 207b 7365 6c66 7d20 6f66 206e 6f6e 2d73   {self} of non-s
-00018710: 7065 6369 616c 2064 696d 656e 7369 6f6e  pecial dimension
-00018720: 2030 7b27 2028 7363 616c 6172 2927 2069   0{' (scalar)' i
-00018730: 6620 7365 6c66 2e6e 5f64 696d 203d 3d20  f self.n_dim == 
-00018740: 3020 656c 7365 2027 277d 2e22 2929 0a20  0 else ''}.")). 
-00018750: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00018760: 737a 5f66 756e 635f 6469 6d20 3d20 3120  sz_func_dim = 1 
-00018770: 6966 2069 6675 6e63 2069 6e20 2830 2c20  if ifunc in (0, 
-00018780: 2d73 656c 662e 6e5f 6469 6d2c 2054 7275  -self.n_dim, Tru
-00018790: 6529 2065 6c73 6520 2d31 0a20 2020 2020  e) else -1.     
-000187a0: 2020 2065 6c73 653a 2073 656c 662e 737a     else: self.sz
-000187b0: 5f66 756e 635f 6469 6d20 3d20 300a 2020  _func_dim = 0.  
-000187c0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-000187d0: 660a 0a20 2020 2040 616c 6961 7328 2273  f..    @alias("s
-000187e0: 7a5f 6675 6e63 5f64 696d 5f22 2c20 2277  z_func_dim_", "w
-000187f0: 6974 685f 737a 6675 6e63 6469 6d22 290a  ith_szfuncdim").
-00018800: 2020 2020 6465 6620 7769 7468 5f73 7a5f      def with_sz_
-00018810: 6675 6e63 5f64 696d 2873 656c 662c 206e  func_dim(self, n
-00018820: 6663 6469 6d29 3a0a 2020 2020 2020 2020  fcdim):.        
-00018830: 6176 6f75 6368 286e 6663 6469 6d20 6973  avouch(nfcdim is
-00018840: 204e 6f6e 6520 6f72 2069 7369 6e73 7461   None or isinsta
-00018850: 6e63 6528 6e66 6364 696d 2c20 696e 745f  nce(nfcdim, int_
-00018860: 292c 2054 7970 6545 7272 6f72 2822 2762  ), TypeError("'b
-00018870: 742e 5369 7a65 2e77 6974 685f 737a 5f66  t.Size.with_sz_f
-00018880: 756e 635f 6469 6d27 206f 6e6c 7920 7461  unc_dim' only ta
-00018890: 6b65 7320 696e 7075 7420 6f66 2061 6e20  kes input of an 
-000188a0: 696e 7465 6765 722e 2229 290a 2020 2020  integer.")).    
-000188b0: 2020 2020 6966 206e 6663 6469 6d20 6973      if nfcdim is
-000188c0: 204e 6f6e 653a 2073 656c 662e 737a 5f66   None: self.sz_f
-000188d0: 756e 635f 6469 6d20 3d20 300a 2020 2020  unc_dim = 0.    
-000188e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000188f0: 2020 2020 2020 6176 6f75 6368 2873 656c        avouch(sel
-00018900: 662e 6e5f 6261 7463 685f 6469 6d20 2b20  f.n_batch_dim + 
-00018910: 7365 6c66 2e6e 5f66 6561 7475 7265 5f64  self.n_feature_d
-00018920: 696d 202b 2073 656c 662e 6e5f 7365 7175  im + self.n_sequ
-00018930: 656e 6365 5f64 696d 203c 2073 656c 662e  ence_dim < self.
-00018940: 6e5f 6469 6d2c 2054 7970 6545 7272 6f72  n_dim, TypeError
-00018950: 2866 2243 616e 6e6f 7420 7365 7420 6675  (f"Cannot set fu
-00018960: 6e63 5f64 696d 2066 6f72 2073 697a 6520  nc_dim for size 
-00018970: 7b73 656c 667d 206f 6620 6e6f 6e2d 7370  {self} of non-sp
-00018980: 6563 6961 6c20 6469 6d65 6e73 696f 6e20  ecial dimension 
-00018990: 307b 2720 2873 6361 6c61 7229 2720 6966  0{' (scalar)' if
-000189a0: 2073 656c 662e 6e5f 6469 6d20 3d3d 2030   self.n_dim == 0
-000189b0: 2065 6c73 6520 2727 7d2e 2229 290a 2020   else ''}.")).  
-000189c0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-000189d0: 7a5f 6675 6e63 5f64 696d 203d 206e 6663  z_func_dim = nfc
-000189e0: 6469 6d0a 2020 2020 2020 2020 7265 7475  dim.        retu
-000189f0: 726e 2073 656c 660a 0a20 2020 2040 616c  rn self..    @al
-00018a00: 6961 7328 226e 5f66 756e 635f 6469 6d5f  ias("n_func_dim_
-00018a10: 222c 2022 7769 7468 5f6e 6675 6e63 6469  ", "with_nfuncdi
-00018a20: 6d22 290a 2020 2020 6465 6620 7769 7468  m").    def with
-00018a30: 5f6e 5f66 756e 635f 6469 6d28 7365 6c66  _n_func_dim(self
-00018a40: 2c20 6e66 6364 696d 293a 0a20 2020 2020  , nfcdim):.     
-00018a50: 2020 2061 766f 7563 6828 6e66 6364 696d     avouch(nfcdim
-00018a60: 203e 3d20 302c 2054 7970 6545 7272 6f72   >= 0, TypeError
-00018a70: 2822 2762 742e 5369 7a65 2e77 6974 685f  ("'bt.Size.with_
-00018a80: 6e5f 6675 6e63 5f64 696d 2720 6163 6365  n_func_dim' acce
-00018a90: 7074 206f 6e6c 7920 706f 7369 7469 7665  pt only positive
-00018aa0: 206e 756d 6265 7220 6f66 2064 696d 656e   number of dimen
-00018ab0: 7369 6f6e 7320 2862 6566 6f72 6520 7468  sions (before th
-00018ac0: 6520 7370 6163 6520 6469 6d65 6e73 696f  e space dimensio
-00018ad0: 6e73 292e 2022 2929 0a20 2020 2020 2020  ns). ")).       
-00018ae0: 2072 6574 7572 6e20 7365 6c66 2e77 6974   return self.wit
-00018af0: 685f 737a 5f66 756e 635f 6469 6d28 6e66  h_sz_func_dim(nf
-00018b00: 6364 696d 290a 0a20 2020 2040 616c 6961  cdim)..    @alia
-00018b10: 7328 226e 6675 6e63 222c 2022 6675 6e63  s("nfunc", "func
-00018b20: 5f73 697a 6522 290a 2020 2020 4070 726f  _size").    @pro
-00018b30: 7065 7274 790a 2020 2020 6465 6620 6e5f  perty.    def n_
-00018b40: 6675 6e63 2873 656c 6629 3a0a 2020 2020  func(self):.    
-00018b50: 2020 2020 7265 7475 726e 2073 656c 665b      return self[
-00018b60: 7365 6c66 2e66 756e 635f 6469 6d5d 2069  self.func_dim] i
-00018b70: 6620 7365 6c66 2e68 6173 5f66 756e 6320  f self.has_func 
-00018b80: 656c 7365 204e 6f6e 650a 0a20 2020 2064  else None..    d
-00018b90: 6566 2077 6974 685f 6675 6e63 2873 656c  ef with_func(sel
-00018ba0: 662c 206e 5f66 756e 6329 3a0a 2020 2020  f, n_func):.    
-00018bb0: 2020 2020 6176 6f75 6368 2869 7369 6e73      avouch(isins
-00018bc0: 7461 6e63 6528 6e5f 6675 6e63 2c20 696e  tance(n_func, in
-00018bd0: 745f 292c 2054 7970 6545 7272 6f72 2822  t_), TypeError("
-00018be0: 4675 6e63 2073 697a 6520 7368 6f75 6c64  Func size should
-00018bf0: 2062 6520 616e 2069 6e74 6567 6572 2e20   be an integer. 
-00018c00: 2229 290a 2020 2020 2020 2020 6966 2073  ")).        if s
-00018c10: 656c 662e 737a 5f66 756e 635f 6469 6d20  elf.sz_func_dim 
-00018c20: 3e3d 2030 3a0a 2020 2020 2020 2020 2020  >= 0:.          
-00018c30: 2020 7265 7475 726e 2066 756e 635f 6469    return func_di
-00018c40: 6d5f 7369 7a65 286e 5f66 756e 6329 202b  m_size(n_func) +
-00018c50: 2073 656c 665b 7365 6c66 2e6e 5f66 756e   self[self.n_fun
-00018c60: 635f 6469 6d3a 5d0a 2020 2020 2020 2020  c_dim:].        
-00018c70: 656c 7365 3a20 7265 7475 726e 2073 656c  else: return sel
-00018c80: 665b 3a2d 7365 6c66 2e6e 5f66 756e 635f  f[:-self.n_func_
-00018c90: 6469 6d5d 202b 2066 756e 635f 6469 6d5f  dim] + func_dim_
-00018ca0: 7369 7a65 286e 5f66 756e 6329 0a0a 2020  size(n_func)..  
-00018cb0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00018cc0: 6465 6620 7369 7a65 5f73 7461 7274 2873  def size_start(s
-00018cd0: 656c 6629 3a20 7265 7475 726e 206d 6178  elf): return max
-00018ce0: 5f28 7365 6c66 2e73 7a5f 6675 6e63 5f64  _(self.sz_func_d
-00018cf0: 696d 2c20 3029 0a20 2020 2040 7072 6f70  im, 0).    @prop
-00018d00: 6572 7479 0a20 2020 2064 6566 2073 697a  erty.    def siz
-00018d10: 655f 7374 6f70 2873 656c 6629 3a20 7265  e_stop(self): re
-00018d20: 7475 726e 2073 656c 662e 6e5f 6469 6d20  turn self.n_dim 
-00018d30: 2b20 6d69 6e5f 2873 656c 662e 737a 5f66  + min_(self.sz_f
-00018d40: 756e 635f 6469 6d2c 2030 290a 0a20 2020  unc_dim, 0)..   
-00018d50: 2023 2320 6261 7463 6820 6469 6d65 6e73   ## batch dimens
-00018d60: 696f 6e3a 0a20 2020 2040 7072 6f70 6572  ion:.    @proper
-00018d70: 7479 0a20 2020 2064 6566 2068 6173 5f62  ty.    def has_b
-00018d80: 6174 6368 2873 656c 6629 3a20 7265 7475  atch(self): retu
-00018d90: 726e 2073 656c 662e 737a 5f62 6174 6368  rn self.sz_batch
-00018da0: 5f64 696d 2021 3d20 300a 0a20 2020 2040  _dim != 0..    @
-00018db0: 616c 6961 7328 226e 6261 7463 6864 696d  alias("nbatchdim
-00018dc0: 2229 0a20 2020 2040 7072 6f70 6572 7479  ").    @property
-00018dd0: 0a20 2020 2064 6566 206e 5f62 6174 6368  .    def n_batch
-00018de0: 5f64 696d 2873 656c 6629 3a20 7265 7475  _dim(self): retu
-00018df0: 726e 2061 6273 5f28 7365 6c66 2e73 7a5f  rn abs_(self.sz_
-00018e00: 6261 7463 685f 6469 6d29 0a20 2020 200a  batch_dim).    .
-00018e10: 2020 2020 4061 6c69 6173 2822 6973 5f62      @alias("is_b
-00018e20: 6174 6368 6469 6d22 290a 2020 2020 6465  atchdim").    de
-00018e30: 6620 6973 5f62 6174 6368 5f64 696d 2873  f is_batch_dim(s
-00018e40: 656c 662c 2069 293a 0a20 2020 2020 2020  elf, i):.       
-00018e50: 2061 766f 7563 6828 6973 696e 7374 616e   avouch(isinstan
-00018e60: 6365 2869 2c20 696e 745f 292c 2054 7970  ce(i, int_), Typ
-00018e70: 6545 7272 6f72 2866 2249 6e76 616c 6964  eError(f"Invalid
-00018e80: 2063 616c 6c20 2769 735f 6261 7463 685f   call 'is_batch_
-00018e90: 6469 6d28 7b69 7d29 273a 2074 6865 2061  dim({i})': the a
-00018ea0: 7267 756d 656e 7420 6973 206e 6f74 2061  rgument is not a
-00018eb0: 6e20 696e 7465 6765 722e 2022 2929 0a20  n integer. ")). 
-00018ec0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-00018ed0: 6c66 2e68 6173 5f62 6174 6368 3a20 7265  lf.has_batch: re
-00018ee0: 7475 726e 2046 616c 7365 0a20 2020 2020  turn False.     
-00018ef0: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
-00018f00: 7a5f 6261 7463 685f 6469 6d20 3d3d 2031  z_batch_dim == 1
-00018f10: 2061 6e64 2069 2069 6e20 2873 656c 662e   and i in (self.
-00018f20: 7369 7a65 5f73 7461 7274 2c20 7365 6c66  size_start, self
-00018f30: 2e73 697a 655f 7374 6172 742d 7365 6c66  .size_start-self
-00018f40: 2e6e 5f64 696d 2920 6f72 2073 656c 662e  .n_dim) or self.
-00018f50: 737a 5f62 6174 6368 5f64 696d 203d 3d20  sz_batch_dim == 
-00018f60: 2d31 2061 6e64 2069 2069 6e20 2873 656c  -1 and i in (sel
-00018f70: 662e 7369 7a65 5f73 746f 702d 312c 2073  f.size_stop-1, s
-00018f80: 656c 662e 7369 7a65 5f73 746f 702d 312d  elf.size_stop-1-
-00018f90: 7365 6c66 2e6e 5f64 696d 290a 0a20 2020  self.n_dim)..   
-00018fa0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-00018fb0: 6566 2062 6174 6368 5f64 696d 2873 656c  ef batch_dim(sel
-00018fc0: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
-00018fd0: 726e 204e 6f6e 6520 6966 2073 656c 662e  rn None if self.
-00018fe0: 737a 5f62 6174 6368 5f64 696d 203d 3d20  sz_batch_dim == 
-00018ff0: 3020 656c 7365 2028 7365 6c66 2e73 697a  0 else (self.siz
-00019000: 655f 7374 6172 7420 6966 2073 656c 662e  e_start if self.
-00019010: 737a 5f62 6174 6368 5f64 696d 203e 2030  sz_batch_dim > 0
-00019020: 2065 6c73 6520 7365 6c66 2e73 697a 655f   else self.size_
-00019030: 7374 6f70 2d31 290a 0a20 2020 2040 616c  stop-1)..    @al
-00019040: 6961 7328 2262 6174 6368 5f64 696d 656e  ias("batch_dimen
-00019050: 7369 6f6e 2229 0a20 2020 2040 6261 7463  sion").    @batc
-00019060: 685f 6469 6d2e 7365 7474 6572 0a20 2020  h_dim.setter.   
-00019070: 2064 6566 2062 6174 6368 5f64 696d 2873   def batch_dim(s
-00019080: 656c 662c 2069 6261 7463 6829 3a0a 2020  elf, ibatch):.  
-00019090: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-000190a0: 662e 7769 7468 5f62 6174 6368 5f64 696d  f.with_batch_dim
-000190b0: 2869 6261 7463 6829 0a0a 2020 2020 4061  (ibatch)..    @a
-000190c0: 6c69 6173 2822 6261 7463 685f 6469 6d5f  lias("batch_dim_
-000190d0: 222c 2022 6261 7463 685f 6469 6d65 6e73  ", "batch_dimens
-000190e0: 696f 6e5f 2229 0a20 2020 2040 616c 6961  ion_").    @alia
-000190f0: 7328 2277 6974 685f 6261 7463 6864 696d  s("with_batchdim
-00019100: 2229 0a20 2020 2064 6566 2077 6974 685f  ").    def with_
-00019110: 6261 7463 685f 6469 6d28 7365 6c66 2c20  batch_dim(self, 
-00019120: 6962 6174 6368 3a20 2869 6e74 2c20 626f  ibatch: (int, bo
-00019130: 6f6c 2c20 6e75 6c6c 2929 3a0a 2020 2020  ol, null)):.    
-00019140: 2020 2020 6176 6f75 6368 2869 6261 7463      avouch(ibatc
-00019150: 6820 6973 204e 6f6e 6520 6f72 2069 7369  h is None or isi
-00019160: 6e73 7461 6e63 6528 6962 6174 6368 2c20  nstance(ibatch, 
-00019170: 626f 6f6c 5f29 206f 7220 6962 6174 6368  bool_) or ibatch
-00019180: 2069 6e20 2873 656c 662e 7369 7a65 5f73   in (self.size_s
-00019190: 7461 7274 2c20 7365 6c66 2e73 697a 655f  tart, self.size_
-000191a0: 7374 6172 742d 7365 6c66 2e6e 5f64 696d  start-self.n_dim
-000191b0: 2c20 7365 6c66 2e73 697a 655f 7374 6f70  , self.size_stop
-000191c0: 2d31 2c20 7365 6c66 2e73 697a 655f 7374  -1, self.size_st
-000191d0: 6f70 2d31 2d73 656c 662e 6e5f 6469 6d29  op-1-self.n_dim)
-000191e0: 2c20 5479 7065 4572 726f 7228 6622 2762  , TypeError(f"'b
-000191f0: 742e 5369 7a65 2e77 6974 685f 6261 7463  t.Size.with_batc
-00019200: 685f 6469 6d27 206f 6e6c 7920 7461 6b65  h_dim' only take
-00019210: 7320 696e 7075 7420 626f 6f6c 206f 7220  s input bool or 
-00019220: 696e 7465 6765 7273 207b 7365 6c66 2e73  integers {self.s
-00019230: 697a 655f 7374 6172 747d 2c20 7b73 656c  ize_start}, {sel
-00019240: 662e 7369 7a65 5f73 746f 702d 317d 2e22  f.size_stop-1}."
-00019250: 2929 0a20 2020 2020 2020 2069 6620 6962  )).        if ib
-00019260: 6174 6368 206f 7220 6973 696e 7374 616e  atch or isinstan
-00019270: 6365 2869 6261 7463 682c 2069 6e74 5f29  ce(ibatch, int_)
-00019280: 3a0a 2020 2020 2020 2020 2020 2020 6176  :.            av
-00019290: 6f75 6368 2873 656c 662e 6e5f 6675 6e63  ouch(self.n_func
-000192a0: 5f64 696d 202b 2073 656c 662e 6e5f 6665  _dim + self.n_fe
-000192b0: 6174 7572 655f 6469 6d20 2b20 7365 6c66  ature_dim + self
-000192c0: 2e6e 5f73 6571 7565 6e63 655f 6469 6d20  .n_sequence_dim 
-000192d0: 3c20 7365 6c66 2e6e 5f64 696d 2c20 5479  < self.n_dim, Ty
-000192e0: 7065 4572 726f 7228 6622 4361 6e6e 6f74  peError(f"Cannot
-000192f0: 2073 6574 2062 6174 6368 5f64 696d 2066   set batch_dim f
-00019300: 6f72 2073 697a 6520 7b73 656c 667d 206f  or size {self} o
-00019310: 6620 6e6f 6e2d 7370 6563 6961 6c20 6469  f non-special di
-00019320: 6d65 6e73 696f 6e20 307b 2720 2873 6361  mension 0{' (sca
-00019330: 6c61 7229 2720 6966 2073 656c 662e 6e5f  lar)' if self.n_
-00019340: 6469 6d20 3d3d 2030 2065 6c73 6520 2727  dim == 0 else ''
-00019350: 7d2e 2229 290a 2020 2020 2020 2020 2020  }.")).          
-00019360: 2020 7365 6c66 2e73 7a5f 6261 7463 685f    self.sz_batch_
-00019370: 6469 6d20 3d20 3120 6966 2069 6261 7463  dim = 1 if ibatc
-00019380: 6820 696e 2028 7365 6c66 2e73 697a 655f  h in (self.size_
-00019390: 7374 6172 742c 2073 656c 662e 7369 7a65  start, self.size
-000193a0: 5f73 7461 7274 2d73 656c 662e 6e5f 6469  _start-self.n_di
-000193b0: 6d2c 2054 7275 6529 2065 6c73 6520 2d31  m, True) else -1
-000193c0: 0a20 2020 2020 2020 2065 6c73 653a 2073  .        else: s
-000193d0: 656c 662e 737a 5f62 6174 6368 5f64 696d  elf.sz_batch_dim
-000193e0: 203d 2030 0a20 2020 2020 2020 2072 6574   = 0.        ret
-000193f0: 7572 6e20 7365 6c66 0a0a 2020 2020 4061  urn self..    @a
-00019400: 6c69 6173 2822 737a 5f62 6174 6368 5f64  lias("sz_batch_d
-00019410: 696d 5f22 2c20 2277 6974 685f 737a 6261  im_", "with_szba
-00019420: 7463 6864 696d 2229 0a20 2020 2064 6566  tchdim").    def
-00019430: 2077 6974 685f 737a 5f62 6174 6368 5f64   with_sz_batch_d
-00019440: 696d 2873 656c 662c 206e 6264 696d 293a  im(self, nbdim):
-00019450: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
-00019460: 6e62 6469 6d20 6973 204e 6f6e 6520 6f72  nbdim is None or
-00019470: 2069 7369 6e73 7461 6e63 6528 6e62 6469   isinstance(nbdi
-00019480: 6d2c 2069 6e74 5f29 2c20 5479 7065 4572  m, int_), TypeEr
-00019490: 726f 7228 2227 6274 2e53 697a 652e 7769  ror("'bt.Size.wi
-000194a0: 7468 5f73 7a5f 6261 7463 685f 6469 6d27  th_sz_batch_dim'
-000194b0: 206f 6e6c 7920 7461 6b65 7320 696e 7075   only takes inpu
-000194c0: 7420 6f66 2061 6e20 696e 7465 6765 722e  t of an integer.
-000194d0: 2229 290a 2020 2020 2020 2020 6966 206e  ")).        if n
-000194e0: 6264 696d 2069 7320 4e6f 6e65 3a20 7365  bdim is None: se
-000194f0: 6c66 2e73 7a5f 6261 7463 685f 6469 6d20  lf.sz_batch_dim 
-00019500: 3d20 300a 2020 2020 2020 2020 656c 7365  = 0.        else
-00019510: 3a0a 2020 2020 2020 2020 2020 2020 6176  :.            av
-00019520: 6f75 6368 2873 656c 662e 6e5f 6675 6e63  ouch(self.n_func
-00019530: 5f64 696d 202b 2073 656c 662e 6e5f 6665  _dim + self.n_fe
-00019540: 6174 7572 655f 6469 6d20 2b20 7365 6c66  ature_dim + self
-00019550: 2e6e 5f73 6571 7565 6e63 655f 6469 6d20  .n_sequence_dim 
-00019560: 3c20 7365 6c66 2e6e 5f64 696d 2c20 5479  < self.n_dim, Ty
-00019570: 7065 4572 726f 7228 6622 4361 6e6e 6f74  peError(f"Cannot
-00019580: 2073 6574 2062 6174 6368 5f64 696d 2066   set batch_dim f
-00019590: 6f72 2073 697a 6520 7b73 656c 667d 206f  or size {self} o
-000195a0: 6620 6e6f 6e2d 7370 6563 6961 6c20 6469  f non-special di
-000195b0: 6d65 6e73 696f 6e20 307b 2720 2873 6361  mension 0{' (sca
-000195c0: 6c61 7229 2720 6966 2073 656c 662e 6e5f  lar)' if self.n_
-000195d0: 6469 6d20 3d3d 2030 2065 6c73 6520 2727  dim == 0 else ''
-000195e0: 7d2e 2229 290a 2020 2020 2020 2020 2020  }.")).          
-000195f0: 2020 7365 6c66 2e73 7a5f 6261 7463 685f    self.sz_batch_
-00019600: 6469 6d20 3d20 6e62 6469 6d0a 2020 2020  dim = nbdim.    
-00019610: 2020 2020 7265 7475 726e 2073 656c 660a      return self.
-00019620: 0a20 2020 2040 616c 6961 7328 226e 5f62  .    @alias("n_b
-00019630: 6174 6368 5f64 696d 5f22 2c20 2277 6974  atch_dim_", "wit
-00019640: 685f 6e62 6174 6368 6469 6d22 290a 2020  h_nbatchdim").  
-00019650: 2020 6465 6620 7769 7468 5f6e 5f62 6174    def with_n_bat
-00019660: 6368 5f64 696d 2873 656c 662c 206e 6264  ch_dim(self, nbd
-00019670: 696d 293a 0a20 2020 2020 2020 2061 766f  im):.        avo
-00019680: 7563 6828 6e62 6469 6d20 3e3d 2030 2c20  uch(nbdim >= 0, 
-00019690: 5479 7065 4572 726f 7228 2227 6274 2e53  TypeError("'bt.S
-000196a0: 697a 652e 7769 7468 5f6e 5f62 6174 6368  ize.with_n_batch
-000196b0: 5f64 696d 2720 6163 6365 7074 206f 6e6c  _dim' accept onl
-000196c0: 7920 706f 7369 7469 7665 206e 756d 6265  y positive numbe
-000196d0: 7220 6f66 2064 696d 656e 7369 6f6e 7320  r of dimensions 
-000196e0: 2862 6566 6f72 6520 7468 6520 7370 6163  (before the spac
-000196f0: 6520 6469 6d65 6e73 696f 6e73 292e 2022  e dimensions). "
-00019700: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
-00019710: 6e20 7365 6c66 2e77 6974 685f 737a 5f62  n self.with_sz_b
-00019720: 6174 6368 5f64 696d 286e 6264 696d 290a  atch_dim(nbdim).
-00019730: 0a20 2020 2040 616c 6961 7328 226e 6261  .    @alias("nba
-00019740: 7463 6822 2c20 2262 6174 6368 5f73 697a  tch", "batch_siz
-00019750: 6522 290a 2020 2020 4070 726f 7065 7274  e").    @propert
-00019760: 790a 2020 2020 6465 6620 6e5f 6261 7463  y.    def n_batc
-00019770: 6828 7365 6c66 293a 0a20 2020 2020 2020  h(self):.       
-00019780: 2072 6574 7572 6e20 7365 6c66 5b73 656c   return self[sel
-00019790: 662e 6261 7463 685f 6469 6d5d 2069 6620  f.batch_dim] if 
-000197a0: 7365 6c66 2e68 6173 5f62 6174 6368 2065  self.has_batch e
-000197b0: 6c73 6520 4e6f 6e65 0a0a 2020 2020 6465  lse None..    de
-000197c0: 6620 7769 7468 5f62 6174 6368 2873 656c  f with_batch(sel
-000197d0: 662c 206e 5f62 6174 6368 293a 0a20 2020  f, n_batch):.   
-000197e0: 2020 2020 2061 766f 7563 6828 6973 696e       avouch(isin
-000197f0: 7374 616e 6365 286e 5f62 6174 6368 2c20  stance(n_batch, 
-00019800: 696e 745f 292c 2054 7970 6545 7272 6f72  int_), TypeError
-00019810: 2822 4261 7463 6820 7369 7a65 2073 686f  ("Batch size sho
-00019820: 756c 6420 6265 2061 6e20 696e 7465 6765  uld be an intege
-00019830: 722e 2022 2929 0a20 2020 2020 2020 2069  r. ")).        i
-00019840: 6620 7365 6c66 2e73 7a5f 6261 7463 685f  f self.sz_batch_
-00019850: 6469 6d20 3e20 303a 0a20 2020 2020 2020  dim > 0:.       
-00019860: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00019870: 5b3a 7365 6c66 2e73 697a 655f 7374 6172  [:self.size_star
-00019880: 745d 202b 2053 697a 6528 7b6e 5f62 6174  t] + Size({n_bat
-00019890: 6368 7d29 202b 2073 656c 665b 7365 6c66  ch}) + self[self
-000198a0: 2e73 697a 655f 7374 6172 7420 2b20 7365  .size_start + se
-000198b0: 6c66 2e6e 5f62 6174 6368 5f64 696d 3a5d  lf.n_batch_dim:]
-000198c0: 0a20 2020 2020 2020 2065 6c73 653a 2072  .        else: r
-000198d0: 6574 7572 6e20 7365 6c66 5b3a 7365 6c66  eturn self[:self
-000198e0: 2e73 697a 655f 7374 6f70 2d73 656c 662e  .size_stop-self.
-000198f0: 6e5f 6261 7463 685f 6469 6d5d 202b 2053  n_batch_dim] + S
-00019900: 697a 6528 7b6e 5f62 6174 6368 7d29 202b  ize({n_batch}) +
-00019910: 2073 656c 665b 7365 6c66 2e73 697a 655f   self[self.size_
-00019920: 7374 6f70 3a5d 0a0a 2020 2020 4070 726f  stop:]..    @pro
-00019930: 7065 7274 790a 2020 2020 6465 6620 6e6f  perty.    def no
-00019940: 6e5f 6261 745f 7374 6172 7428 7365 6c66  n_bat_start(self
-00019950: 293a 2072 6574 7572 6e20 6d61 785f 2873  ): return max_(s
-00019960: 656c 662e 737a 5f66 756e 635f 6469 6d2c  elf.sz_func_dim,
-00019970: 2030 2920 2b20 6d61 785f 2873 656c 662e   0) + max_(self.
-00019980: 737a 5f62 6174 6368 5f64 696d 2c20 3029  sz_batch_dim, 0)
-00019990: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-000199a0: 2020 2064 6566 206e 6f6e 5f62 6174 5f73     def non_bat_s
-000199b0: 746f 7028 7365 6c66 293a 2072 6574 7572  top(self): retur
-000199c0: 6e20 7365 6c66 2e6e 5f64 696d 202b 206d  n self.n_dim + m
-000199d0: 696e 5f28 7365 6c66 2e73 7a5f 6675 6e63  in_(self.sz_func
-000199e0: 5f64 696d 2c20 3029 202b 206d 696e 5f28  _dim, 0) + min_(
-000199f0: 7365 6c66 2e73 7a5f 6261 7463 685f 6469  self.sz_batch_di
-00019a00: 6d2c 2030 290a 0a20 2020 2023 2320 6368  m, 0)..    ## ch
-00019a10: 616e 6e65 6c20 6469 6d65 6e73 696f 6e3a  annel dimension:
-00019a20: 200a 2020 2020 4070 726f 7065 7274 790a   .    @property.
-00019a30: 2020 2020 6465 6620 6861 735f 6368 616e      def has_chan
-00019a40: 6e65 6c28 7365 6c66 293a 2072 6574 7572  nel(self): retur
-00019a50: 6e20 7365 6c66 2e73 7a5f 6665 6174 7572  n self.sz_featur
-00019a60: 655f 6469 6d20 696e 2028 312c 202d 3129  e_dim in (1, -1)
-00019a70: 0a0a 2020 2020 4061 6c69 6173 2822 6e63  ..    @alias("nc
-00019a80: 6861 6e6e 656c 6469 6d22 290a 2020 2020  hanneldim").    
-00019a90: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
-00019aa0: 6620 6e5f 6368 616e 6e65 6c5f 6469 6d28  f n_channel_dim(
-00019ab0: 7365 6c66 293a 2072 6574 7572 6e20 696e  self): return in
-00019ac0: 745f 2873 656c 662e 6861 735f 6368 616e  t_(self.has_chan
-00019ad0: 6e65 6c29 0a0a 2020 2020 4061 6c69 6173  nel)..    @alias
-00019ae0: 2822 6973 5f63 6861 6e6e 656c 6469 6d22  ("is_channeldim"
-00019af0: 290a 2020 2020 6465 6620 6973 5f63 6861  ).    def is_cha
-00019b00: 6e6e 656c 5f64 696d 2873 656c 662c 2069  nnel_dim(self, i
-00019b10: 293a 0a20 2020 2020 2020 2061 766f 7563  ):.        avouc
-00019b20: 6828 6973 696e 7374 616e 6365 2869 2c20  h(isinstance(i, 
-00019b30: 696e 745f 292c 2054 7970 6545 7272 6f72  int_), TypeError
-00019b40: 2866 2249 6e76 616c 6964 2063 616c 6c20  (f"Invalid call 
-00019b50: 2769 735f 6368 616e 6e65 6c5f 6469 6d28  'is_channel_dim(
-00019b60: 7b69 7d29 273a 2074 6865 2061 7267 756d  {i})': the argum
-00019b70: 656e 7420 6973 206e 6f74 2061 6e20 696e  ent is not an in
-00019b80: 7465 6765 722e 2022 2929 0a20 2020 2020  teger. ")).     
-00019b90: 2020 2069 6620 6e6f 7420 7365 6c66 2e68     if not self.h
-00019ba0: 6173 5f66 6561 7475 7265 3a20 7265 7475  as_feature: retu
-00019bb0: 726e 2046 616c 7365 0a20 2020 2020 2020  rn False.       
-00019bc0: 2072 6574 7572 6e20 2873 656c 662e 737a   return (self.sz
-00019bd0: 5f66 6561 7475 7265 5f64 696d 203d 3d20  _feature_dim == 
-00019be0: 3120 616e 6420 6920 696e 2028 7365 6c66  1 and i in (self
-00019bf0: 2e6e 6f6e 5f62 6174 5f73 7461 7274 2c20  .non_bat_start, 
-00019c00: 7365 6c66 2e6e 6f6e 5f62 6174 5f73 7461  self.non_bat_sta
-00019c10: 7274 202d 2073 656c 662e 6e5f 6469 6d29  rt - self.n_dim)
-00019c20: 206f 7220 0a20 2020 2020 2020 2020 2020   or .           
-00019c30: 2020 2020 2073 656c 662e 737a 5f66 6561       self.sz_fea
-00019c40: 7475 7265 5f64 696d 203d 3d20 2d31 2061  ture_dim == -1 a
-00019c50: 6e64 2069 2069 6e20 2873 656c 662e 6e6f  nd i in (self.no
-00019c60: 6e5f 6261 745f 7374 6f70 202d 2031 2c20  n_bat_stop - 1, 
-00019c70: 7365 6c66 2e6e 6f6e 5f62 6174 5f73 746f  self.non_bat_sto
-00019c80: 7020 2d20 7365 6c66 2e6e 5f64 696d 202d  p - self.n_dim -
-00019c90: 2031 2929 0a0a 2020 2020 4070 726f 7065   1))..    @prope
-00019ca0: 7274 790a 2020 2020 6465 6620 6368 616e  rty.    def chan
-00019cb0: 6e65 6c5f 6469 6d28 7365 6c66 293a 0a20  nel_dim(self):. 
-00019cc0: 2020 2020 2020 2061 766f 7563 6828 7365         avouch(se
-00019cd0: 6c66 2e73 7a5f 6665 6174 7572 655f 6469  lf.sz_feature_di
-00019ce0: 6d20 696e 2028 312c 202d 3129 2c20 5479  m in (1, -1), Ty
-00019cf0: 7065 4572 726f 7228 6622 4361 6e6e 6f74  peError(f"Cannot
-00019d00: 2067 6574 2063 6861 6e6e 656c 2064 696d   get channel dim
-00019d10: 656e 7369 6f6e 2066 726f 6d20 7369 7a65  ension from size
-00019d20: 2077 6974 6820 7b73 656c 662e 6e5f 6665   with {self.n_fe
-00019d30: 6174 7572 655f 6469 6d7d 2066 6561 7475  ature_dim} featu
-00019d40: 7265 2064 696d 656e 7369 6f6e 732e 2229  re dimensions.")
-00019d50: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00019d60: 2073 656c 662e 6e6f 6e5f 6261 745f 7374   self.non_bat_st
-00019d70: 6172 7420 6966 2073 656c 662e 737a 5f66  art if self.sz_f
-00019d80: 6561 7475 7265 5f64 696d 203e 2030 2065  eature_dim > 0 e
-00019d90: 6c73 6520 7365 6c66 2e6e 6f6e 5f62 6174  lse self.non_bat
-00019da0: 5f73 746f 7020 2d20 310a 0a20 2020 2040  _stop - 1..    @
-00019db0: 616c 6961 7328 2263 6861 6e6e 656c 5f64  alias("channel_d
-00019dc0: 696d 656e 7369 6f6e 2229 0a20 2020 2040  imension").    @
-00019dd0: 6368 616e 6e65 6c5f 6469 6d2e 7365 7474  channel_dim.sett
-00019de0: 6572 0a20 2020 2064 6566 2063 6861 6e6e  er.    def chann
-00019df0: 656c 5f64 696d 2873 656c 662c 2069 6368  el_dim(self, ich
-00019e00: 616e 6e65 6c29 3a0a 2020 2020 2020 2020  annel):.        
-00019e10: 7265 7475 726e 2073 656c 662e 7769 7468  return self.with
-00019e20: 5f63 6861 6e6e 656c 5f64 696d 2869 6368  _channel_dim(ich
-00019e30: 616e 6e65 6c29 0a0a 2020 2020 4061 6c69  annel)..    @ali
-00019e40: 6173 2822 6368 616e 6e65 6c5f 6469 6d5f  as("channel_dim_
-00019e50: 222c 2022 6368 616e 6e65 6c5f 6469 6d65  ", "channel_dime
-00019e60: 6e73 696f 6e5f 2229 0a20 2020 2040 616c  nsion_").    @al
-00019e70: 6961 7328 2277 6974 685f 6368 616e 6e65  ias("with_channe
-00019e80: 6c64 696d 2229 0a20 2020 2064 6566 2077  ldim").    def w
-00019e90: 6974 685f 6368 616e 6e65 6c5f 6469 6d28  ith_channel_dim(
-00019ea0: 7365 6c66 2c20 6963 6861 6e6e 656c 3a20  self, ichannel: 
-00019eb0: 2869 6e74 2c20 6e75 6c6c 2929 3a0a 2020  (int, null)):.  
-00019ec0: 2020 2020 2020 6176 6f75 6368 2869 6368        avouch(ich
-00019ed0: 616e 6e65 6c20 6973 204e 6f6e 6520 6f72  annel is None or
-00019ee0: 2069 6368 616e 6e65 6c20 696e 2028 7365   ichannel in (se
-00019ef0: 6c66 2e6e 6f6e 5f62 6174 5f73 7461 7274  lf.non_bat_start
-00019f00: 2c20 7365 6c66 2e6e 6f6e 5f62 6174 5f73  , self.non_bat_s
-00019f10: 7461 7274 202d 2073 656c 662e 6e5f 6469  tart - self.n_di
-00019f20: 6d2c 2073 656c 662e 6e6f 6e5f 6261 745f  m, self.non_bat_
-00019f30: 7374 6f70 202d 2031 2c20 7365 6c66 2e6e  stop - 1, self.n
-00019f40: 6f6e 5f62 6174 5f73 746f 7020 2d20 7365  on_bat_stop - se
-00019f50: 6c66 2e6e 5f64 696d 202d 2031 292c 200a  lf.n_dim - 1), .
-00019f60: 2020 2020 2020 2020 2020 2020 2020 2054                 T
-00019f70: 7970 6545 7272 6f72 2866 2243 6861 6e6e  ypeError(f"Chann
-00019f80: 656c 2064 696d 656e 7369 6f6e 206f 6620  el dimension of 
-00019f90: 7b73 656c 667d 2073 686f 756c 6420 6265  {self} should be
-00019fa0: 2074 6865 2066 6972 7374 206f 7220 6c61   the first or la
-00019fb0: 7374 2064 696d 656e 7369 6f6e 2061 7061  st dimension apa
-00019fc0: 7274 2066 726f 6d20 7468 6520 6261 7463  rt from the batc
-00019fd0: 6820 6469 6d65 6e73 696f 6e2c 2077 6869  h dimension, whi
-00019fe0: 6368 2061 7265 207b 7365 6c66 2e6e 6f6e  ch are {self.non
-00019ff0: 5f62 6174 5f73 7461 7274 7d20 616e 6420  _bat_start} and 
-0001a000: 7b73 656c 662e 6e6f 6e5f 6261 745f 7374  {self.non_bat_st
-0001a010: 6f70 202d 2031 7d2e 2229 290a 2020 2020  op - 1}.")).    
-0001a020: 2020 2020 6966 2069 6368 616e 6e65 6c20      if ichannel 
-0001a030: 6973 204e 6f6e 653a 2073 656c 662e 737a  is None: self.sz
-0001a040: 5f66 6561 7475 7265 5f64 696d 203d 2030  _feature_dim = 0
-0001a050: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001a060: 2020 2020 2020 2020 2020 2061 766f 7563             avouc
-0001a070: 6828 7365 6c66 2e6e 5f66 756e 635f 6469  h(self.n_func_di
-0001a080: 6d20 2b20 7365 6c66 2e6e 5f62 6174 6368  m + self.n_batch
-0001a090: 5f64 696d 202b 2073 656c 662e 6e5f 7365  _dim + self.n_se
-0001a0a0: 7175 656e 6365 5f64 696d 203c 2073 656c  quence_dim < sel
-0001a0b0: 662e 6e5f 6469 6d2c 2054 7970 6545 7272  f.n_dim, TypeErr
-0001a0c0: 6f72 2866 2243 616e 6e6f 7420 7365 7420  or(f"Cannot set 
-0001a0d0: 6368 616e 6e65 6c5f 6469 6d20 666f 7220  channel_dim for 
-0001a0e0: 7369 7a65 207b 7365 6c66 7d20 6f66 206e  size {self} of n
-0001a0f0: 6f6e 2d73 7065 6369 616c 2064 696d 656e  on-special dimen
-0001a100: 7369 6f6e 2030 2e22 2929 0a20 2020 2020  sion 0.")).     
-0001a110: 2020 2020 2020 2073 656c 662e 737a 5f66         self.sz_f
-0001a120: 6561 7475 7265 5f64 696d 203d 2031 2069  eature_dim = 1 i
-0001a130: 6620 6963 6861 6e6e 656c 2069 6e20 2873  f ichannel in (s
-0001a140: 656c 662e 6e6f 6e5f 6261 745f 7374 6172  elf.non_bat_star
-0001a150: 742c 2073 656c 662e 6e6f 6e5f 6261 745f  t, self.non_bat_
-0001a160: 7374 6172 7420 2d20 7365 6c66 2e6e 5f64  start - self.n_d
-0001a170: 696d 2920 656c 7365 202d 310a 2020 2020  im) else -1.    
-0001a180: 2020 2020 7265 7475 726e 2073 656c 660a      return self.
-0001a190: 0a20 2020 2040 616c 6961 7328 226e 6368  .    @alias("nch
-0001a1a0: 616e 6e65 6c22 2c20 2263 6861 6e6e 656c  annel", "channel
-0001a1b0: 5f73 697a 6522 290a 2020 2020 4070 726f  _size").    @pro
-0001a1c0: 7065 7274 790a 2020 2020 6465 6620 6e5f  perty.    def n_
-0001a1d0: 6368 616e 6e65 6c28 7365 6c66 293a 0a20  channel(self):. 
-0001a1e0: 2020 2020 2020 2061 766f 7563 6828 7365         avouch(se
-0001a1f0: 6c66 2e6e 5f66 6561 7475 7265 5f64 696d  lf.n_feature_dim
-0001a200: 203d 3d20 312c 2054 7970 6545 7272 6f72   == 1, TypeError
-0001a210: 2866 2243 616e 6e6f 7420 6765 7420 6368  (f"Cannot get ch
-0001a220: 616e 6e65 6c20 6469 6d65 6e73 696f 6e20  annel dimension 
-0001a230: 6672 6f6d 2073 697a 6520 7769 7468 207b  from size with {
-0001a240: 7365 6c66 2e6e 5f66 6561 7475 7265 5f64  self.n_feature_d
-0001a250: 696d 7d20 6665 6174 7572 6520 6469 6d65  im} feature dime
-0001a260: 6e73 696f 6e73 2e22 2929 0a20 2020 2020  nsions.")).     
-0001a270: 2020 2072 6574 7572 6e20 7365 6c66 5b73     return self[s
-0001a280: 656c 662e 6368 616e 6e65 6c5f 6469 6d5d  elf.channel_dim]
-0001a290: 0a0a 2020 2020 6465 6620 7769 7468 5f63  ..    def with_c
-0001a2a0: 6861 6e6e 656c 2873 656c 662c 206e 5f63  hannel(self, n_c
-0001a2b0: 6861 6e6e 656c 293a 0a20 2020 2020 2020  hannel):.       
-0001a2c0: 2061 766f 7563 6828 6973 696e 7374 616e   avouch(isinstan
-0001a2d0: 6365 286e 5f63 6861 6e6e 656c 2c20 696e  ce(n_channel, in
-0001a2e0: 745f 292c 2054 7970 6545 7272 6f72 2822  t_), TypeError("
-0001a2f0: 4368 616e 6e65 6c20 7369 7a65 2073 686f  Channel size sho
-0001a300: 756c 6420 6265 2061 6e20 696e 7465 6765  uld be an intege
-0001a310: 722e 2022 2929 0a20 2020 2020 2020 2069  r. ")).        i
-0001a320: 6620 7365 6c66 2e73 7a5f 6665 6174 7572  f self.sz_featur
-0001a330: 655f 6469 6d20 3e20 303a 0a20 2020 2020  e_dim > 0:.     
-0001a340: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0001a350: 6c66 5b3a 7365 6c66 2e6e 6f6e 5f62 6174  lf[:self.non_bat
-0001a360: 5f73 7461 7274 5d20 2b20 5369 7a65 285b  _start] + Size([
-0001a370: 6e5f 6368 616e 6e65 6c5d 2920 2b20 7365  n_channel]) + se
-0001a380: 6c66 5b73 656c 662e 6e6f 6e5f 6261 745f  lf[self.non_bat_
-0001a390: 7374 6172 7420 2b20 7365 6c66 2e6e 5f66  start + self.n_f
-0001a3a0: 6561 7475 7265 5f64 696d 3a5d 0a20 2020  eature_dim:].   
-0001a3b0: 2020 2020 2065 6c73 653a 2072 6574 7572       else: retur
-0001a3c0: 6e20 7365 6c66 5b3a 7365 6c66 2e6e 6f6e  n self[:self.non
-0001a3d0: 5f62 6174 5f73 746f 7020 2d20 7365 6c66  _bat_stop - self
-0001a3e0: 2e6e 5f66 6561 7475 7265 5f64 696d 5d20  .n_feature_dim] 
-0001a3f0: 2b20 5369 7a65 285b 6e5f 6368 616e 6e65  + Size([n_channe
-0001a400: 6c5d 2920 2b20 7365 6c66 5b73 656c 662e  l]) + self[self.
-0001a410: 6e6f 6e5f 6261 745f 7374 6f70 3a5d 0a0a  non_bat_stop:]..
-0001a420: 2020 2020 2323 2066 6561 7475 7265 2064      ## feature d
-0001a430: 696d 656e 7369 6f6e 733a 0a20 2020 2040  imensions:.    @
-0001a440: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-0001a450: 2068 6173 5f66 6561 7475 7265 2873 656c   has_feature(sel
-0001a460: 6629 3a20 7265 7475 726e 2073 656c 662e  f): return self.
-0001a470: 6e5f 6665 6174 7572 655f 6469 6d20 213d  n_feature_dim !=
-0001a480: 2030 0a0a 2020 2020 4061 6c69 6173 2822   0..    @alias("
-0001a490: 6973 5f66 6561 7475 7265 6469 6d22 290a  is_featuredim").
-0001a4a0: 2020 2020 6465 6620 6973 5f66 6561 7475      def is_featu
-0001a4b0: 7265 5f64 696d 2873 656c 662c 2069 293a  re_dim(self, i):
-0001a4c0: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
-0001a4d0: 6973 696e 7374 616e 6365 2869 2c20 696e  isinstance(i, in
-0001a4e0: 745f 292c 2054 7970 6545 7272 6f72 2866  t_), TypeError(f
-0001a4f0: 2249 6e76 616c 6964 2063 616c 6c20 2769  "Invalid call 'i
-0001a500: 735f 6665 6174 7572 655f 6469 6d28 7b69  s_feature_dim({i
-0001a510: 7d29 273a 2074 6865 2061 7267 756d 656e  })': the argumen
-0001a520: 7420 6973 206e 6f74 2061 6e20 696e 7465  t is not an inte
-0001a530: 6765 722e 2022 2929 0a20 2020 2020 2020  ger. ")).       
-0001a540: 2069 6620 6e6f 7420 7365 6c66 2e68 6173   if not self.has
-0001a550: 5f66 6561 7475 7265 3a20 7265 7475 726e  _feature: return
-0001a560: 2046 616c 7365 0a20 2020 2020 2020 2069   False.        i
-0001a570: 6620 6920 3c20 303a 2069 202b 3d20 7365  f i < 0: i += se
-0001a580: 6c66 2e6e 5f64 696d 0a20 2020 2020 2020  lf.n_dim.       
-0001a590: 2072 6574 7572 6e20 7365 6c66 2e66 6561   return self.fea
-0001a5a0: 7475 7265 5f73 7461 7274 203c 3d20 6920  ture_start <= i 
-0001a5b0: 3c20 7365 6c66 2e66 6561 7475 7265 5f73  < self.feature_s
-0001a5c0: 746f 700a 0a20 2020 2040 7072 6f70 6572  top..    @proper
-0001a5d0: 7479 0a20 2020 2064 6566 206e 5f66 6561  ty.    def n_fea
-0001a5e0: 7475 7265 5f64 696d 2873 656c 6629 3a20  ture_dim(self): 
-0001a5f0: 7265 7475 726e 2061 6273 5f28 7365 6c66  return abs_(self
-0001a600: 2e73 7a5f 6665 6174 7572 655f 6469 6d29  .sz_feature_dim)
-0001a610: 0a0a 2020 2020 4061 6c69 6173 2822 6e66  ..    @alias("nf
-0001a620: 6561 7475 7265 6469 6d22 290a 2020 2020  eaturedim").    
-0001a630: 406e 5f66 6561 7475 7265 5f64 696d 2e73  @n_feature_dim.s
-0001a640: 6574 7465 720a 2020 2020 6465 6620 6e5f  etter.    def n_
-0001a650: 6665 6174 7572 655f 6469 6d28 7365 6c66  feature_dim(self
-0001a660: 2c20 6e29 3a20 7265 7475 726e 2073 656c  , n): return sel
-0001a670: 662e 7769 7468 5f6e 5f66 6561 7475 7265  f.with_n_feature
-0001a680: 5f64 696d 286e 290a 0a20 2020 2040 616c  _dim(n)..    @al
-0001a690: 6961 7328 2273 7a5f 6665 6174 7572 655f  ias("sz_feature_
-0001a6a0: 6469 6d5f 222c 2022 7769 7468 5f73 7a66  dim_", "with_szf
-0001a6b0: 6561 7475 7265 6469 6d22 290a 2020 2020  eaturedim").    
-0001a6c0: 6465 6620 7769 7468 5f73 7a5f 6665 6174  def with_sz_feat
-0001a6d0: 7572 655f 6469 6d28 7365 6c66 2c20 6e66  ure_dim(self, nf
-0001a6e0: 6469 6d29 3a0a 2020 2020 2020 2020 6176  dim):.        av
-0001a6f0: 6f75 6368 286e 6664 696d 2069 7320 4e6f  ouch(nfdim is No
-0001a700: 6e65 206f 7220 6973 696e 7374 616e 6365  ne or isinstance
-0001a710: 286e 6664 696d 2c20 696e 745f 292c 2054  (nfdim, int_), T
-0001a720: 7970 6545 7272 6f72 2822 2762 742e 5369  ypeError("'bt.Si
-0001a730: 7a65 2e77 6974 685f 737a 5f66 6561 7475  ze.with_sz_featu
-0001a740: 7265 5f64 696d 2720 6f6e 6c79 2074 616b  re_dim' only tak
-0001a750: 6573 2069 6e70 7574 206f 6620 616e 2069  es input of an i
-0001a760: 6e74 6567 6572 2e22 2929 0a20 2020 2020  nteger.")).     
-0001a770: 2020 2069 6620 6e66 6469 6d20 6973 204e     if nfdim is N
-0001a780: 6f6e 653a 2073 656c 662e 737a 5f66 6561  one: self.sz_fea
-0001a790: 7475 7265 5f64 696d 203d 2030 0a20 2020  ture_dim = 0.   
-0001a7a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001a7b0: 2020 2020 2020 2061 766f 7563 6828 7365         avouch(se
-0001a7c0: 6c66 2e6e 5f66 756e 635f 6469 6d20 2b20  lf.n_func_dim + 
-0001a7d0: 7365 6c66 2e6e 5f62 6174 6368 5f64 696d  self.n_batch_dim
-0001a7e0: 202b 2061 6273 5f28 6e66 6469 6d29 202b   + abs_(nfdim) +
-0001a7f0: 2073 656c 662e 6e5f 7365 7175 656e 6365   self.n_sequence
-0001a800: 5f64 696d 203c 3d20 7365 6c66 2e6e 5f64  _dim <= self.n_d
-0001a810: 696d 2c20 5479 7065 4572 726f 7228 6622  im, TypeError(f"
-0001a820: 4361 6e6e 6f74 2061 7373 6967 6e20 7b61  Cannot assign {a
-0001a830: 6273 5f28 6e66 6469 6d29 7d20 6665 6174  bs_(nfdim)} feat
-0001a840: 7572 6573 2069 6e20 7369 7a65 207b 7365  ures in size {se
-0001a850: 6c66 7d20 7769 7468 206e 6f6e 2d73 7065  lf} with non-spe
-0001a860: 6369 616c 2064 696d 656e 7369 6f6e 206f  cial dimension o
-0001a870: 6620 7b73 656c 662e 6e5f 6469 6d20 2d20  f {self.n_dim - 
-0001a880: 7365 6c66 2e6e 5f66 756e 635f 6469 6d20  self.n_func_dim 
-0001a890: 2d20 7365 6c66 2e6e 5f62 6174 6368 5f64  - self.n_batch_d
-0001a8a0: 696d 202d 2073 656c 662e 6e5f 7365 7175  im - self.n_sequ
-0001a8b0: 656e 6365 5f64 696d 7d2c 206f 7220 7468  ence_dim}, or th
-0001a8c0: 6572 6520 7769 6c6c 2062 6520 636f 6e66  ere will be conf
-0001a8d0: 6c69 6374 2e20 2229 290a 2020 2020 2020  lict. ")).      
-0001a8e0: 2020 2020 2020 7365 6c66 2e73 7a5f 6665        self.sz_fe
-0001a8f0: 6174 7572 655f 6469 6d20 3d20 6e66 6469  ature_dim = nfdi
-0001a900: 6d0a 2020 2020 2020 2020 7265 7475 726e  m.        return
-0001a910: 2073 656c 660a 0a20 2020 2040 616c 6961   self..    @alia
-0001a920: 7328 226e 5f66 6561 7475 7265 5f64 696d  s("n_feature_dim
-0001a930: 5f22 2c20 2277 6974 685f 6e66 6561 7475  _", "with_nfeatu
-0001a940: 7265 6469 6d22 290a 2020 2020 6465 6620  redim").    def 
-0001a950: 7769 7468 5f6e 5f66 6561 7475 7265 5f64  with_n_feature_d
-0001a960: 696d 2873 656c 662c 206e 6664 696d 293a  im(self, nfdim):
-0001a970: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
-0001a980: 6e66 6469 6d20 3e3d 2030 2c20 5479 7065  nfdim >= 0, Type
-0001a990: 4572 726f 7228 2227 6274 2e53 697a 652e  Error("'bt.Size.
-0001a9a0: 7769 7468 5f6e 5f66 6561 7475 7265 5f64  with_n_feature_d
-0001a9b0: 696d 2720 6163 6365 7074 206f 6e6c 7920  im' accept only 
-0001a9c0: 706f 7369 7469 7665 206e 756d 6265 7220  positive number 
-0001a9d0: 6f66 2064 696d 656e 7369 6f6e 7320 2862  of dimensions (b
-0001a9e0: 6566 6f72 6520 7468 6520 7370 6163 6520  efore the space 
-0001a9f0: 6469 6d65 6e73 696f 6e73 292e 2022 2929  dimensions). "))
-0001aa00: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001aa10: 7365 6c66 2e77 6974 685f 737a 5f66 6561  self.with_sz_fea
-0001aa20: 7475 7265 5f64 696d 286e 6664 696d 290a  ture_dim(nfdim).
-0001aa30: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-0001aa40: 2020 2064 6566 2066 6561 7475 7265 5f73     def feature_s
-0001aa50: 7461 7274 2873 656c 6629 3a0a 2020 2020  tart(self):.    
-0001aa60: 2020 2020 6176 6f75 6368 2873 656c 662e      avouch(self.
-0001aa70: 6861 735f 6665 6174 7572 652c 2054 7970  has_feature, Typ
-0001aa80: 6545 7272 6f72 2822 4361 6e6e 6f74 2067  eError("Cannot g
-0001aa90: 6574 2066 6561 7475 7265 2073 7461 7274  et feature start
-0001aaa0: 2066 726f 6d20 7369 7a65 2077 6974 686f   from size witho
-0001aab0: 7574 2066 6561 7475 7265 2064 696d 656e  ut feature dimen
-0001aac0: 7369 6f6e 732e 2229 290a 2020 2020 2020  sions.")).      
-0001aad0: 2020 7265 7475 726e 204e 6f6e 6520 6966    return None if
-0001aae0: 2073 656c 662e 737a 5f66 6561 7475 7265   self.sz_feature
-0001aaf0: 5f64 696d 203d 3d20 3020 656c 7365 2028  _dim == 0 else (
-0001ab00: 7365 6c66 2e6e 6f6e 5f62 6174 5f73 7461  self.non_bat_sta
-0001ab10: 7274 2069 6620 7365 6c66 2e73 7a5f 6665  rt if self.sz_fe
-0001ab20: 6174 7572 655f 6469 6d20 3e20 3020 656c  ature_dim > 0 el
-0001ab30: 7365 2073 656c 662e 6e6f 6e5f 6261 745f  se self.non_bat_
-0001ab40: 7374 6f70 202b 2073 656c 662e 737a 5f66  stop + self.sz_f
-0001ab50: 6561 7475 7265 5f64 696d 290a 0a20 2020  eature_dim)..   
-0001ab60: 2040 6665 6174 7572 655f 7374 6172 742e   @feature_start.
-0001ab70: 7365 7474 6572 0a20 2020 2064 6566 2066  setter.    def f
-0001ab80: 6561 7475 7265 5f73 7461 7274 2873 656c  eature_start(sel
-0001ab90: 662c 2064 696d 293a 0a20 2020 2020 2020  f, dim):.       
-0001aba0: 2061 766f 7563 6828 6469 6d20 6973 204e   avouch(dim is N
-0001abb0: 6f6e 6520 6f72 2069 7369 6e73 7461 6e63  one or isinstanc
-0001abc0: 6528 6469 6d2c 2069 6e74 5f29 2c20 5479  e(dim, int_), Ty
-0001abd0: 7065 4572 726f 7228 6622 4665 6174 7572  peError(f"Featur
-0001abe0: 6520 7374 6172 7420 7368 6f75 6c64 2062  e start should b
-0001abf0: 6520 616e 2069 6e74 6567 6572 2e20 2229  e an integer. ")
-0001ac00: 290a 2020 2020 2020 2020 6966 2064 696d  ).        if dim
-0001ac10: 2069 7320 4e6f 6e65 3a20 7365 6c66 2e73   is None: self.s
-0001ac20: 7a5f 6665 6174 7572 655f 6469 6d20 3d20  z_feature_dim = 
-0001ac30: 303b 2072 6574 7572 6e0a 2020 2020 2020  0; return.      
-0001ac40: 2020 6966 2064 696d 203c 2030 3a20 6469    if dim < 0: di
-0001ac50: 6d20 2b3d 2073 656c 662e 6e5f 6469 6d0a  m += self.n_dim.
-0001ac60: 2020 2020 2020 2020 6176 6f75 6368 2873          avouch(s
-0001ac70: 656c 662e 6e6f 6e5f 6261 745f 7374 6172  elf.non_bat_star
-0001ac80: 7420 3c3d 2064 696d 203c 2073 656c 662e  t <= dim < self.
-0001ac90: 6e6f 6e5f 6261 745f 7374 6f70 2c20 5479  non_bat_stop, Ty
-0001aca0: 7065 4572 726f 7228 6622 4665 6174 7572  peError(f"Featur
-0001acb0: 6520 7374 6172 7420 7368 6f75 6c64 2061  e start should a
-0001acc0: 766f 6964 2074 6865 2062 6174 6368 2064  void the batch d
-0001acd0: 696d 656e 7369 6f6e 732c 2077 6869 6368  imensions, which
-0001ace0: 2069 7320 6265 7477 6565 6e20 7b73 656c   is between {sel
-0001acf0: 662e 6e6f 6e5f 6261 745f 7374 6172 747d  f.non_bat_start}
-0001ad00: 2061 6e64 207b 7365 6c66 2e6e 6f6e 5f62   and {self.non_b
-0001ad10: 6174 5f73 746f 7020 2d20 317d 2c20 6f72  at_stop - 1}, or
-0001ad20: 2074 6865 7265 2077 696c 6c20 6265 2063   there will be c
-0001ad30: 6f6e 666c 6963 742e 2022 2929 0a20 2020  onflict. ")).   
-0001ad40: 2020 2020 2073 656c 662e 737a 5f66 6561       self.sz_fea
-0001ad50: 7475 7265 5f64 696d 203d 2064 696d 202d  ture_dim = dim -
-0001ad60: 2073 656c 662e 6e6f 6e5f 6261 745f 7374   self.non_bat_st
-0001ad70: 6f70 0a0a 2020 2020 4070 726f 7065 7274  op..    @propert
-0001ad80: 790a 2020 2020 6465 6620 6665 6174 7572  y.    def featur
-0001ad90: 655f 7374 6f70 2873 656c 6629 3a0a 2020  e_stop(self):.  
-0001ada0: 2020 2020 2020 6176 6f75 6368 2873 656c        avouch(sel
-0001adb0: 662e 6861 735f 6665 6174 7572 652c 2054  f.has_feature, T
-0001adc0: 7970 6545 7272 6f72 2822 4361 6e6e 6f74  ypeError("Cannot
-0001add0: 2067 6574 2066 6561 7475 7265 2073 7461   get feature sta
-0001ade0: 7274 2066 726f 6d20 7369 7a65 2077 6974  rt from size wit
-0001adf0: 686f 7574 2066 6561 7475 7265 2064 696d  hout feature dim
-0001ae00: 656e 7369 6f6e 732e 2229 290a 2020 2020  ensions.")).    
-0001ae10: 2020 2020 7265 7475 726e 204e 6f6e 6520      return None 
-0001ae20: 6966 2073 656c 662e 737a 5f66 6561 7475  if self.sz_featu
-0001ae30: 7265 5f64 696d 203d 3d20 3020 656c 7365  re_dim == 0 else
-0001ae40: 2028 7365 6c66 2e6e 6f6e 5f62 6174 5f73   (self.non_bat_s
-0001ae50: 7461 7274 202b 2073 656c 662e 737a 5f66  tart + self.sz_f
-0001ae60: 6561 7475 7265 5f64 696d 2069 6620 7365  eature_dim if se
-0001ae70: 6c66 2e73 7a5f 6665 6174 7572 655f 6469  lf.sz_feature_di
-0001ae80: 6d20 3e20 3020 656c 7365 2073 656c 662e  m > 0 else self.
-0001ae90: 6e6f 6e5f 6261 745f 7374 6f70 290a 0a20  non_bat_stop).. 
-0001aea0: 2020 2040 6665 6174 7572 655f 7374 6f70     @feature_stop
-0001aeb0: 2e73 6574 7465 720a 2020 2020 6465 6620  .setter.    def 
-0001aec0: 6665 6174 7572 655f 7374 6f70 2873 656c  feature_stop(sel
-0001aed0: 662c 2064 696d 293a 0a20 2020 2020 2020  f, dim):.       
-0001aee0: 2061 766f 7563 6828 6469 6d20 6973 204e   avouch(dim is N
-0001aef0: 6f6e 6520 6f72 2069 7369 6e73 7461 6e63  one or isinstanc
-0001af00: 6528 6469 6d2c 2069 6e74 5f29 2c20 5479  e(dim, int_), Ty
-0001af10: 7065 4572 726f 7228 6622 4665 6174 7572  peError(f"Featur
-0001af20: 6520 7374 6f70 2073 686f 756c 6420 6265  e stop should be
-0001af30: 2061 6e20 696e 7465 6765 722e 2022 2929   an integer. "))
-0001af40: 0a20 2020 2020 2020 2069 6620 6469 6d20  .        if dim 
-0001af50: 6973 204e 6f6e 653a 2073 656c 662e 737a  is None: self.sz
-0001af60: 5f66 6561 7475 7265 5f64 696d 203d 2030  _feature_dim = 0
-0001af70: 3b20 7265 7475 726e 0a20 2020 2020 2020  ; return.       
-0001af80: 2069 6620 6469 6d20 3c20 303a 2064 696d   if dim < 0: dim
-0001af90: 202b 3d20 7365 6c66 2e6e 5f64 696d 0a20   += self.n_dim. 
-0001afa0: 2020 2020 2020 2061 766f 7563 6828 7365         avouch(se
-0001afb0: 6c66 2e6e 6f6e 5f62 6174 5f73 7461 7274  lf.non_bat_start
-0001afc0: 203c 3d20 6469 6d20 3c20 7365 6c66 2e6e   <= dim < self.n
-0001afd0: 6f6e 5f62 6174 5f73 746f 702c 2054 7970  on_bat_stop, Typ
-0001afe0: 6545 7272 6f72 2866 2246 6561 7475 7265  eError(f"Feature
-0001aff0: 2073 746f 7020 7368 6f75 6c64 2061 766f   stop should avo
-0001b000: 6964 2074 6865 2062 6174 6368 2064 696d  id the batch dim
-0001b010: 656e 7369 6f6e 732c 2077 6869 6368 2069  ensions, which i
-0001b020: 7320 6265 7477 6565 6e20 7b73 656c 662e  s between {self.
-0001b030: 6e6f 6e5f 6261 745f 7374 6172 747d 2061  non_bat_start} a
-0001b040: 6e64 207b 7365 6c66 2e6e 6f6e 5f62 6174  nd {self.non_bat
-0001b050: 5f73 746f 7020 2d20 317d 2c20 6f72 2074  _stop - 1}, or t
-0001b060: 6865 7265 2077 696c 6c20 6265 2063 6f6e  here will be con
-0001b070: 666c 6963 742e 2022 2929 0a20 2020 2020  flict. ")).     
-0001b080: 2020 2073 656c 662e 737a 5f66 6561 7475     self.sz_featu
-0001b090: 7265 5f64 696d 203d 2064 696d 202d 2073  re_dim = dim - s
-0001b0a0: 656c 662e 6e6f 6e5f 6261 745f 7374 6172  elf.non_bat_star
-0001b0b0: 740a 0a20 2020 2040 7072 6f70 6572 7479  t..    @property
-0001b0c0: 0a20 2020 2064 6566 2066 6561 7475 7265  .    def feature
-0001b0d0: 5f72 616e 6765 2873 656c 6629 3a0a 2020  _range(self):.  
-0001b0e0: 2020 2020 2020 7265 7475 726e 2028 7365        return (se
-0001b0f0: 6c66 2e66 6561 7475 7265 5f73 7461 7274  lf.feature_start
-0001b100: 2c20 7365 6c66 2e66 6561 7475 7265 5f73  , self.feature_s
-0001b110: 746f 7029 0a20 2020 200a 2020 2020 4066  top).    .    @f
-0001b120: 6561 7475 7265 5f72 616e 6765 2e73 6574  eature_range.set
-0001b130: 7465 720a 2020 2020 6465 6620 6665 6174  ter.    def feat
-0001b140: 7572 655f 7261 6e67 6528 7365 6c66 2c20  ure_range(self, 
-0001b150: 2a61 7267 7329 3a0a 2020 2020 2020 2020  *args):.        
-0001b160: 6176 6f75 6368 286c 656e 2861 7267 7329  avouch(len(args)
-0001b170: 203d 3d20 3220 6f72 206c 656e 2861 7267   == 2 or len(arg
-0001b180: 7329 203d 3d20 3120 616e 6420 6973 696e  s) == 1 and isin
-0001b190: 7374 616e 6365 2861 7267 735b 305d 2c20  stance(args[0], 
-0001b1a0: 2874 7570 6c65 2c20 6c69 7374 2929 2061  (tuple, list)) a
-0001b1b0: 6e64 206c 656e 2861 7267 735b 305d 2920  nd len(args[0]) 
-0001b1c0: 3d3d 2032 2c20 0a20 2020 2020 2020 2020  == 2, .         
-0001b1d0: 2020 2020 2020 5479 7065 4572 726f 7228        TypeError(
-0001b1e0: 224f 6e6c 7920 7477 6f20 7661 6c75 6573  "Only two values
-0001b1f0: 2061 7265 2061 6c6c 6f77 6564 2069 6e20   are allowed in 
-0001b200: 7468 6520 6173 7369 676e 6d65 6e74 206f  the assignment o
-0001b210: 6620 2766 6561 7475 7265 5f72 616e 6765  f 'feature_range
-0001b220: 272c 2069 6e64 6963 6174 696e 6720 7468  ', indicating th
-0001b230: 6520 7374 6172 7420 616e 6420 656e 6420  e start and end 
-0001b240: 6469 6d65 6e73 696f 6e73 2e20 2229 290a  dimensions. ")).
-0001b250: 2020 2020 2020 2020 6966 206c 656e 2861          if len(a
-0001b260: 7267 7329 203d 3d20 313a 2061 7267 7320  rgs) == 1: args 
-0001b270: 3d20 6172 6773 5b30 5d0a 2020 2020 2020  = args[0].      
-0001b280: 2020 6176 6f75 6368 2861 7267 735b 305d    avouch(args[0]
-0001b290: 203d 3d20 7365 6c66 2e6e 6f6e 5f62 6174   == self.non_bat
-0001b2a0: 5f73 7461 7274 206f 7220 6172 6773 5b31  _start or args[1
-0001b2b0: 5d20 3d3d 2073 656c 662e 6e6f 6e5f 6261  ] == self.non_ba
-0001b2c0: 745f 7374 6f70 2c20 0a20 2020 2020 2020  t_stop, .       
-0001b2d0: 2020 2020 2020 2020 5479 7065 4572 726f          TypeErro
-0001b2e0: 7228 6622 4665 6174 7572 6520 6469 6d65  r(f"Feature dime
-0001b2f0: 6e73 696f 6e73 2061 7265 2074 6865 2066  nsions are the f
-0001b300: 6972 7374 206f 7220 6c61 7374 2064 696d  irst or last dim
-0001b310: 656e 7369 6f6e 7320 2873 7461 7274 696e  ensions (startin
-0001b320: 6720 6672 6f6d 207b 7365 6c66 2e6e 6f6e  g from {self.non
-0001b330: 5f62 6174 5f73 7461 7274 7d20 6f72 2065  _bat_start} or e
-0001b340: 6e64 696e 6720 6174 207b 7365 6c66 2e6e  nding at {self.n
-0001b350: 6f6e 5f62 6174 5f73 746f 707d 292e 2022  on_bat_stop}). "
-0001b360: 2929 0a20 2020 2020 2020 2069 6620 6172  )).        if ar
-0001b370: 6773 5b30 5d20 3d3d 2073 656c 662e 6e6f  gs[0] == self.no
-0001b380: 6e5f 6261 745f 7374 6172 743a 2073 656c  n_bat_start: sel
-0001b390: 662e 6665 6174 7572 655f 7374 6f70 203d  f.feature_stop =
-0001b3a0: 2061 7267 735b 315d 0a20 2020 2020 2020   args[1].       
-0001b3b0: 2065 6c73 653a 2073 656c 662e 6665 6174   else: self.feat
-0001b3c0: 7572 655f 7374 6172 7420 3d20 6172 6773  ure_start = args
-0001b3d0: 5b30 5d0a 0a20 2020 2040 616c 6961 7328  [0]..    @alias(
-0001b3e0: 226e 6665 6174 7572 6522 290a 2020 2020  "nfeature").    
-0001b3f0: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
-0001b400: 6620 6e5f 6665 6174 7572 6528 7365 6c66  f n_feature(self
-0001b410: 293a 0a20 2020 2020 2020 2061 766f 7563  ):.        avouc
-0001b420: 6828 7365 6c66 2e68 6173 5f66 6561 7475  h(self.has_featu
-0001b430: 7265 2c20 5479 7065 4572 726f 7228 6622  re, TypeError(f"
-0001b440: 4361 6e6e 6f74 2067 6574 2066 6561 7475  Cannot get featu
-0001b450: 7265 2064 696d 656e 7369 6f6e 7320 6672  re dimensions fr
-0001b460: 6f6d 2073 697a 6520 7b73 656c 667d 2e22  om size {self}."
-0001b470: 2929 0a20 2020 2020 2020 2070 203d 2031  )).        p = 1
-0001b480: 0a20 2020 2020 2020 2066 6f72 2069 2069  .        for i i
-0001b490: 6e20 7261 6e67 655f 282a 7365 6c66 2e66  n range_(*self.f
-0001b4a0: 6561 7475 7265 5f72 616e 6765 293a 2070  eature_range): p
-0001b4b0: 202a 3d20 7365 6c66 5b69 5d0a 2020 2020   *= self[i].    
-0001b4c0: 2020 2020 7265 7475 726e 2070 0a0a 2020      return p..  
-0001b4d0: 2020 4061 6c69 6173 2822 6665 6174 7572    @alias("featur
-0001b4e0: 655f 7369 7a65 2229 0a20 2020 2040 7072  e_size").    @pr
-0001b4f0: 6f70 6572 7479 0a20 2020 2064 6566 2066  operty.    def f
-0001b500: 6561 7475 7265 2873 656c 6629 3a0a 2020  eature(self):.  
-0001b510: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0001b520: 665b 7365 6c66 2e66 6561 7475 7265 5f73  f[self.feature_s
-0001b530: 7461 7274 3a20 7365 6c66 2e66 6561 7475  tart: self.featu
-0001b540: 7265 5f73 746f 705d 0a0a 2020 2020 6465  re_stop]..    de
-0001b550: 6620 7769 7468 5f66 6561 7475 7265 2873  f with_feature(s
-0001b560: 656c 662c 202a 7369 7a65 293a 0a20 2020  elf, *size):.   
-0001b570: 2020 2020 2069 6620 6c65 6e28 7369 7a65       if len(size
-0001b580: 2920 3d3d 2031 2061 6e64 2069 7369 6e73  ) == 1 and isins
-0001b590: 7461 6e63 6528 7369 7a65 5b30 5d2c 2074  tance(size[0], t
-0001b5a0: 7570 6c65 293a 2073 697a 6520 3d20 7369  uple): size = si
-0001b5b0: 7a65 5b30 5d0a 2020 2020 2020 2020 6176  ze[0].        av
-0001b5c0: 6f75 6368 2861 6c6c 5f28 6973 696e 7374  ouch(all_(isinst
-0001b5d0: 616e 6365 2878 2c20 696e 745f 2920 666f  ance(x, int_) fo
-0001b5e0: 7220 7820 696e 2073 697a 6529 2c20 5479  r x in size), Ty
-0001b5f0: 7065 4572 726f 7228 2266 6561 7475 7265  peError("feature
-0001b600: 2073 697a 6520 7368 6f75 6c64 2062 6520   size should be 
-0001b610: 6120 7475 706c 6520 6f66 2069 6e74 6567  a tuple of integ
-0001b620: 6572 732e 2022 2929 0a20 2020 2020 2020  ers. ")).       
-0001b630: 2069 6620 6e6f 7420 7365 6c66 2e68 6173   if not self.has
-0001b640: 5f66 6561 7475 7265 3a20 7374 6172 7420  _feature: start 
-0001b650: 3d20 7365 6c66 2e6e 6f6e 5f62 6174 5f73  = self.non_bat_s
-0001b660: 7461 7274 3b20 7374 6f70 203d 2073 656c  tart; stop = sel
-0001b670: 662e 6e6f 6e5f 6261 745f 7374 6172 740a  f.non_bat_start.
-0001b680: 2020 2020 2020 2020 656c 7365 3a20 7374          else: st
-0001b690: 6172 7420 3d20 7365 6c66 2e66 6561 7475  art = self.featu
-0001b6a0: 7265 5f73 7461 7274 3b20 7374 6f70 203d  re_start; stop =
-0001b6b0: 2073 656c 662e 6665 6174 7572 655f 7374   self.feature_st
-0001b6c0: 6f70 0a20 2020 2020 2020 2023 2061 766f  op.        # avo
-0001b6d0: 7563 6828 6c65 6e28 7369 7a65 2920 3d3d  uch(len(size) ==
-0001b6e0: 2073 656c 662e 6e5f 6665 6174 7572 655f   self.n_feature_
-0001b6f0: 6469 6d2c 2066 2243 616e 6e6f 7420 7375  dim, f"Cannot su
-0001b700: 6273 7469 7475 7465 2066 6561 7475 7265  bstitute feature
-0001b710: 2069 6e20 7b73 656c 667d 2062 7920 7b73   in {self} by {s
-0001b720: 697a 657d 2061 7320 7468 6569 7220 6469  ize} as their di
-0001b730: 6d65 6e73 696f 6e73 2061 7265 206e 6f74  mensions are not
-0001b740: 2074 6865 2073 616d 652e 2229 0a20 2020   the same.").   
-0001b750: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0001b760: 5b3a 7374 6172 745d 202b 2053 697a 6528  [:start] + Size(
-0001b770: 7369 7a65 2c20 737a 5f66 6561 7475 7265  size, sz_feature
-0001b780: 5f64 696d 3d6c 656e 2873 697a 6529 2920  _dim=len(size)) 
-0001b790: 2b20 7365 6c66 5b73 746f 703a 5d0a 2020  + self[stop:].  
-0001b7a0: 2020 2020 2020 0a20 2020 2040 7072 6f70        .    @prop
-0001b7b0: 6572 7479 0a20 2020 2064 6566 2073 6571  erty.    def seq
-0001b7c0: 5f73 7063 5f73 7461 7274 2873 656c 6629  _spc_start(self)
-0001b7d0: 3a20 7265 7475 726e 206d 6178 5f28 7365  : return max_(se
-0001b7e0: 6c66 2e73 7a5f 6675 6e63 5f64 696d 2c20  lf.sz_func_dim, 
-0001b7f0: 3029 202b 206d 6178 5f28 7365 6c66 2e73  0) + max_(self.s
-0001b800: 7a5f 6261 7463 685f 6469 6d2c 2030 2920  z_batch_dim, 0) 
-0001b810: 2b20 6d61 785f 2873 656c 662e 737a 5f66  + max_(self.sz_f
-0001b820: 6561 7475 7265 5f64 696d 2c20 3029 0a20  eature_dim, 0). 
-0001b830: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-0001b840: 2064 6566 2073 6571 5f73 7063 5f73 746f   def seq_spc_sto
-0001b850: 7028 7365 6c66 293a 2072 6574 7572 6e20  p(self): return 
-0001b860: 7365 6c66 2e6e 5f64 696d 202b 206d 696e  self.n_dim + min
-0001b870: 5f28 7365 6c66 2e73 7a5f 6675 6e63 5f64  _(self.sz_func_d
-0001b880: 696d 2c20 3029 202b 206d 696e 5f28 7365  im, 0) + min_(se
-0001b890: 6c66 2e73 7a5f 6261 7463 685f 6469 6d2c  lf.sz_batch_dim,
-0001b8a0: 2030 2920 2b20 6d69 6e5f 2873 656c 662e   0) + min_(self.
-0001b8b0: 737a 5f66 6561 7475 7265 5f64 696d 2c20  sz_feature_dim, 
-0001b8c0: 3029 0a0a 2020 2020 2323 2073 6571 7565  0)..    ## seque
-0001b8d0: 6e63 6520 6469 6d65 6e73 696f 6e73 3a0a  nce dimensions:.
-0001b8e0: 2020 2020 4061 6c69 6173 2822 6861 735f      @alias("has_
-0001b8f0: 7469 6d65 222c 2022 6861 735f 7365 7269  time", "has_seri
-0001b900: 6573 2229 0a20 2020 2040 7072 6f70 6572  es").    @proper
-0001b910: 7479 0a20 2020 2064 6566 2068 6173 5f73  ty.    def has_s
-0001b920: 6571 7565 6e63 6528 7365 6c66 293a 2072  equence(self): r
-0001b930: 6574 7572 6e20 7365 6c66 2e73 7a5f 7365  eturn self.sz_se
-0001b940: 7175 656e 6365 5f64 696d 2021 3d20 300a  quence_dim != 0.
-0001b950: 0a20 2020 2040 616c 6961 7328 2269 735f  .    @alias("is_
-0001b960: 7469 6d65 6469 6d22 2c20 2269 735f 7365  timedim", "is_se
-0001b970: 7269 6573 6469 6d22 2c20 2269 735f 7365  riesdim", "is_se
-0001b980: 7175 656e 6365 6469 6d22 290a 2020 2020  quencedim").    
-0001b990: 4061 6c69 6173 2822 6973 5f74 696d 655f  @alias("is_time_
-0001b9a0: 6469 6d22 2c20 2269 735f 7365 7269 6573  dim", "is_series
-0001b9b0: 5f64 696d 2229 0a20 2020 2064 6566 2069  _dim").    def i
-0001b9c0: 735f 7365 7175 656e 6365 5f64 696d 2873  s_sequence_dim(s
-0001b9d0: 656c 662c 2069 293a 0a20 2020 2020 2020  elf, i):.       
-0001b9e0: 2061 766f 7563 6828 6973 696e 7374 616e   avouch(isinstan
-0001b9f0: 6365 2869 2c20 696e 745f 292c 2054 7970  ce(i, int_), Typ
-0001ba00: 6545 7272 6f72 2866 2249 6e76 616c 6964  eError(f"Invalid
-0001ba10: 2063 616c 6c20 2769 735f 7365 7175 656e   call 'is_sequen
-0001ba20: 6365 5f64 696d 287b 697d 2927 3a20 7468  ce_dim({i})': th
-0001ba30: 6520 6172 6775 6d65 6e74 2069 7320 6e6f  e argument is no
-0001ba40: 7420 616e 2069 6e74 6567 6572 2e20 2229  t an integer. ")
-0001ba50: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-0001ba60: 2073 656c 662e 6861 735f 7365 7175 656e   self.has_sequen
-0001ba70: 6365 3a20 7265 7475 726e 2046 616c 7365  ce: return False
-0001ba80: 0a20 2020 2020 2020 2069 6620 6920 3c20  .        if i < 
-0001ba90: 303a 2069 202b 3d20 7365 6c66 2e6e 5f64  0: i += self.n_d
-0001baa0: 696d 0a20 2020 2020 2020 2072 6574 7572  im.        retur
-0001bab0: 6e20 7365 6c66 2e73 6571 7565 6e63 655f  n self.sequence_
-0001bac0: 7374 6172 7420 3c3d 2069 203c 2073 656c  start <= i < sel
-0001bad0: 662e 7365 7175 656e 6365 5f73 746f 700a  f.sequence_stop.
-0001bae0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-0001baf0: 2020 2064 6566 206e 5f73 6571 7565 6e63     def n_sequenc
-0001bb00: 655f 6469 6d28 7365 6c66 293a 2072 6574  e_dim(self): ret
-0001bb10: 7572 6e20 6162 735f 2873 656c 662e 737a  urn abs_(self.sz
-0001bb20: 5f73 6571 7565 6e63 655f 6469 6d29 0a0a  _sequence_dim)..
-0001bb30: 2020 2020 4061 6c69 6173 2822 6e74 696d      @alias("ntim
-0001bb40: 6564 696d 222c 2022 6e73 6572 6965 7364  edim", "nseriesd
-0001bb50: 696d 222c 2022 6e73 6571 7565 6e63 6564  im", "nsequenced
-0001bb60: 696d 2229 0a20 2020 2040 616c 6961 7328  im").    @alias(
-0001bb70: 226e 5f74 696d 655f 6469 6d22 2c20 226e  "n_time_dim", "n
-0001bb80: 5f73 6572 6965 735f 6469 6d22 290a 2020  _series_dim").  
-0001bb90: 2020 406e 5f73 6571 7565 6e63 655f 6469    @n_sequence_di
-0001bba0: 6d2e 7365 7474 6572 0a20 2020 2064 6566  m.setter.    def
-0001bbb0: 206e 5f73 6571 7565 6e63 655f 6469 6d28   n_sequence_dim(
-0001bbc0: 7365 6c66 2c20 6e29 3a20 7265 7475 726e  self, n): return
-0001bbd0: 2073 656c 662e 7769 7468 5f6e 5f73 6571   self.with_n_seq
-0001bbe0: 7565 6e63 655f 6469 6d28 6e29 0a0a 2020  uence_dim(n)..  
-0001bbf0: 2020 4061 6c69 6173 2822 737a 5f74 696d    @alias("sz_tim
-0001bc00: 655f 6469 6d5f 222c 2022 737a 5f73 6572  e_dim_", "sz_ser
-0001bc10: 6965 735f 6469 6d5f 222c 2022 737a 5f73  ies_dim_", "sz_s
-0001bc20: 6571 7565 6e63 655f 6469 6d5f 2229 0a20  equence_dim_"). 
-0001bc30: 2020 2040 616c 6961 7328 2277 6974 685f     @alias("with_
-0001bc40: 737a 7469 6d65 6469 6d22 2c20 2277 6974  sztimedim", "wit
-0001bc50: 685f 737a 7365 7269 6573 6469 6d22 2c20  h_szseriesdim", 
-0001bc60: 2277 6974 685f 737a 7365 7175 656e 6365  "with_szsequence
-0001bc70: 6469 6d22 290a 2020 2020 4061 6c69 6173  dim").    @alias
-0001bc80: 2822 7769 7468 5f73 7a5f 7469 6d65 5f64  ("with_sz_time_d
-0001bc90: 696d 222c 2022 7769 7468 5f73 7a5f 7365  im", "with_sz_se
-0001bca0: 7269 6573 5f64 696d 2229 0a20 2020 2064  ries_dim").    d
-0001bcb0: 6566 2077 6974 685f 737a 5f73 6571 7565  ef with_sz_seque
-0001bcc0: 6e63 655f 6469 6d28 7365 6c66 2c20 6e73  nce_dim(self, ns
-0001bcd0: 6469 6d29 3a0a 2020 2020 2020 2020 6176  dim):.        av
-0001bce0: 6f75 6368 286e 7364 696d 2069 7320 4e6f  ouch(nsdim is No
-0001bcf0: 6e65 206f 7220 6973 696e 7374 616e 6365  ne or isinstance
-0001bd00: 286e 7364 696d 2c20 696e 745f 292c 2054  (nsdim, int_), T
-0001bd10: 7970 6545 7272 6f72 2822 2762 742e 5369  ypeError("'bt.Si
-0001bd20: 7a65 2e77 6974 685f 737a 5f73 6571 7565  ze.with_sz_seque
-0001bd30: 6e63 655f 6469 6d27 206f 6e6c 7920 7461  nce_dim' only ta
-0001bd40: 6b65 7320 696e 7075 7420 6f66 2061 6e20  kes input of an 
-0001bd50: 696e 7465 6765 722e 2229 290a 2020 2020  integer.")).    
-0001bd60: 2020 2020 6966 206e 7364 696d 2069 7320      if nsdim is 
-0001bd70: 4e6f 6e65 3a20 7365 6c66 2e73 7a5f 7365  None: self.sz_se
-0001bd80: 7175 656e 6365 5f64 696d 203d 2030 0a20  quence_dim = 0. 
-0001bd90: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001bda0: 2020 2020 2020 2020 2061 766f 7563 6828           avouch(
-0001bdb0: 7365 6c66 2e6e 5f66 756e 635f 6469 6d20  self.n_func_dim 
-0001bdc0: 2b20 7365 6c66 2e6e 5f62 6174 6368 5f64  + self.n_batch_d
-0001bdd0: 696d 202b 2073 656c 662e 6e5f 6665 6174  im + self.n_feat
-0001bde0: 7572 655f 6469 6d20 2b20 6162 735f 286e  ure_dim + abs_(n
-0001bdf0: 7364 696d 2920 3c3d 2073 656c 662e 6e5f  sdim) <= self.n_
-0001be00: 6469 6d2c 2054 7970 6545 7272 6f72 2866  dim, TypeError(f
-0001be10: 2243 616e 6e6f 7420 6173 7369 676e 207b  "Cannot assign {
-0001be20: 6162 735f 286e 7364 696d 297d 2073 6571  abs_(nsdim)} seq
-0001be30: 7565 6e63 6520 6469 6d65 6e73 696f 6e73  uence dimensions
-0001be40: 2069 6e20 7369 7a65 207b 7365 6c66 7d20   in size {self} 
-0001be50: 7769 7468 206e 6f6e 2d73 7065 6369 616c  with non-special
-0001be60: 2064 696d 656e 7369 6f6e 206f 6620 7b73   dimension of {s
-0001be70: 656c 662e 6e5f 6469 6d20 2d20 7365 6c66  elf.n_dim - self
-0001be80: 2e6e 5f66 756e 635f 6469 6d20 2d20 7365  .n_func_dim - se
-0001be90: 6c66 2e6e 5f62 6174 6368 5f64 696d 202d  lf.n_batch_dim -
-0001bea0: 2073 656c 662e 6e5f 6665 6174 7572 655f   self.n_feature_
-0001beb0: 6469 6d7d 2c20 6f72 2074 6865 7265 2077  dim}, or there w
-0001bec0: 696c 6c20 6265 2063 6f6e 666c 6963 742e  ill be conflict.
-0001bed0: 2022 2929 0a20 2020 2020 2020 2020 2020   ")).           
-0001bee0: 2073 656c 662e 737a 5f73 6571 7565 6e63   self.sz_sequenc
-0001bef0: 655f 6469 6d20 3d20 6e73 6469 6d0a 2020  e_dim = nsdim.  
-0001bf00: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0001bf10: 660a 0a20 2020 2040 616c 6961 7328 226e  f..    @alias("n
-0001bf20: 5f74 696d 655f 6469 6d5f 222c 2022 6e5f  _time_dim_", "n_
-0001bf30: 7365 7269 6573 5f64 696d 5f22 2c20 226e  series_dim_", "n
-0001bf40: 5f73 6571 7565 6e63 655f 6469 6d5f 2229  _sequence_dim_")
-0001bf50: 0a20 2020 2040 616c 6961 7328 2277 6974  .    @alias("wit
-0001bf60: 685f 6e74 696d 6564 696d 222c 2022 7769  h_ntimedim", "wi
-0001bf70: 7468 5f6e 7365 7269 6573 6469 6d22 2c20  th_nseriesdim", 
-0001bf80: 2277 6974 685f 6e73 6571 7565 6e63 6564  "with_nsequenced
-0001bf90: 696d 2229 0a20 2020 2040 616c 6961 7328  im").    @alias(
-0001bfa0: 2277 6974 685f 6e5f 7469 6d65 5f64 696d  "with_n_time_dim
-0001bfb0: 222c 2022 7769 7468 5f6e 5f73 6572 6965  ", "with_n_serie
-0001bfc0: 735f 6469 6d22 290a 2020 2020 6465 6620  s_dim").    def 
-0001bfd0: 7769 7468 5f6e 5f73 6571 7565 6e63 655f  with_n_sequence_
-0001bfe0: 6469 6d28 7365 6c66 2c20 6e73 6469 6d29  dim(self, nsdim)
-0001bff0: 3a0a 2020 2020 2020 2020 6176 6f75 6368  :.        avouch
-0001c000: 286e 7364 696d 203e 3d20 302c 2054 7970  (nsdim >= 0, Typ
-0001c010: 6545 7272 6f72 2822 2762 742e 5369 7a65  eError("'bt.Size
-0001c020: 2e77 6974 685f 6e5f 7365 7175 656e 6365  .with_n_sequence
-0001c030: 5f64 696d 2720 6163 6365 7074 206f 6e6c  _dim' accept onl
-0001c040: 7920 706f 7369 7469 7665 206e 756d 6265  y positive numbe
-0001c050: 7220 6f66 2064 696d 656e 7369 6f6e 7320  r of dimensions 
-0001c060: 2862 6566 6f72 6520 7468 6520 7370 6163  (before the spac
-0001c070: 6520 6469 6d65 6e73 696f 6e73 292e 2022  e dimensions). "
-0001c080: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
-0001c090: 6e20 7365 6c66 2e77 6974 685f 737a 5f73  n self.with_sz_s
-0001c0a0: 6571 7565 6e63 655f 6469 6d28 2d6e 7364  equence_dim(-nsd
-0001c0b0: 696d 290a 0a20 2020 2040 616c 6961 7328  im)..    @alias(
-0001c0c0: 2274 696d 655f 6469 6d5f 222c 2022 7365  "time_dim_", "se
-0001c0d0: 7269 6573 5f64 696d 5f22 2c20 2273 6571  ries_dim_", "seq
-0001c0e0: 7565 6e63 655f 6469 6d5f 2229 0a20 2020  uence_dim_").   
-0001c0f0: 2040 616c 6961 7328 2277 6974 685f 7469   @alias("with_ti
-0001c100: 6d65 6469 6d22 2c20 2277 6974 685f 7365  medim", "with_se
-0001c110: 7269 6573 6469 6d22 2c20 2277 6974 685f  riesdim", "with_
-0001c120: 7365 7175 656e 6365 6469 6d22 290a 2020  sequencedim").  
-0001c130: 2020 4061 6c69 6173 2822 7769 7468 5f74    @alias("with_t
-0001c140: 696d 655f 6469 6d22 2c20 2277 6974 685f  ime_dim", "with_
-0001c150: 7365 7269 6573 5f64 696d 2229 0a20 2020  series_dim").   
-0001c160: 2064 6566 2077 6974 685f 7365 7175 656e   def with_sequen
-0001c170: 6365 5f64 696d 2873 656c 662c 2064 696d  ce_dim(self, dim
-0001c180: 293a 0a20 2020 2020 2020 2061 766f 7563  ):.        avouc
-0001c190: 6828 6469 6d20 6973 204e 6f6e 6520 6f72  h(dim is None or
-0001c1a0: 2069 7369 6e73 7461 6e63 6528 6469 6d2c   isinstance(dim,
-0001c1b0: 2028 626f 6f6c 5f2c 2069 6e74 5f29 292c   (bool_, int_)),
-0001c1c0: 2054 7970 6545 7272 6f72 2822 2762 742e   TypeError("'bt.
-0001c1d0: 5369 7a65 2e77 6974 685f 7365 7175 656e  Size.with_sequen
-0001c1e0: 6365 5f64 696d 2720 6f6e 6c79 2074 616b  ce_dim' only tak
-0001c1f0: 6573 2069 6e74 6567 6572 206f 7220 626f  es integer or bo
-0001c200: 6f6c 2e22 2929 0a20 2020 2020 2020 2069  ol.")).        i
-0001c210: 6620 6973 696e 7374 616e 6365 2864 696d  f isinstance(dim
-0001c220: 2c20 626f 6f6c 5f29 3a20 6469 6d20 3d20  , bool_): dim = 
-0001c230: 2d31 2069 6620 6469 6d20 656c 7365 204e  -1 if dim else N
-0001c240: 6f6e 650a 2020 2020 2020 2020 6966 2064  one.        if d
-0001c250: 696d 2069 7320 4e6f 6e65 3a20 7365 6c66  im is None: self
-0001c260: 2e73 7a5f 7365 7175 656e 6365 5f64 696d  .sz_sequence_dim
-0001c270: 203d 2030 3b20 7265 7475 726e 2073 656c   = 0; return sel
-0001c280: 660a 2020 2020 2020 2020 6966 2064 696d  f.        if dim
-0001c290: 203c 2030 3a20 6469 6d20 2b3d 2073 656c   < 0: dim += sel
-0001c2a0: 662e 6e5f 6469 6d0a 2020 2020 2020 2020  f.n_dim.        
-0001c2b0: 6176 6f75 6368 2864 696d 2069 6e20 2873  avouch(dim in (s
-0001c2c0: 656c 662e 7365 715f 7370 635f 7374 6172  elf.seq_spc_star
-0001c2d0: 742c 2073 656c 662e 7365 715f 7370 635f  t, self.seq_spc_
-0001c2e0: 7374 6f70 202d 2031 292c 2054 7970 6545  stop - 1), TypeE
-0001c2f0: 7272 6f72 2866 2253 6571 7565 6e63 6520  rror(f"Sequence 
-0001c300: 6469 6d65 6e73 696f 6e20 6361 6e20 6f6e  dimension can on
-0001c310: 6c79 2062 6520 7468 6520 6669 7273 7420  ly be the first 
-0001c320: 6f72 206c 6173 7420 6469 6d65 6e73 696f  or last dimensio
-0001c330: 6e20 287b 7365 6c66 2e73 6571 5f73 7063  n ({self.seq_spc
-0001c340: 5f73 7461 7274 7d20 6f72 207b 7365 6c66  _start} or {self
-0001c350: 2e73 6571 5f73 7063 5f73 746f 702d 317d  .seq_spc_stop-1}
-0001c360: 2920 6170 6172 7420 6672 6f6d 2062 6174  ) apart from bat
-0001c370: 6368 2061 6e64 2066 6561 7475 7265 2064  ch and feature d
-0001c380: 696d 656e 7369 6f6e 732e 2229 290a 2020  imensions.")).  
-0001c390: 2020 2020 2020 7365 6c66 2e73 7a5f 7365        self.sz_se
-0001c3a0: 7175 656e 6365 5f64 696d 203d 2031 2069  quence_dim = 1 i
-0001c3b0: 6620 6469 6d20 3d3d 2073 656c 662e 7365  f dim == self.se
-0001c3c0: 715f 7370 635f 7374 6172 7420 656c 7365  q_spc_start else
-0001c3d0: 202d 310a 2020 2020 2020 2020 7265 7475   -1.        retu
-0001c3e0: 726e 2073 656c 660a 0a20 2020 2040 7072  rn self..    @pr
-0001c3f0: 6f70 6572 7479 0a20 2020 2064 6566 2073  operty.    def s
-0001c400: 6571 7565 6e63 655f 7374 6172 7428 7365  equence_start(se
-0001c410: 6c66 293a 0a20 2020 2020 2020 2061 766f  lf):.        avo
-0001c420: 7563 6828 7365 6c66 2e68 6173 5f73 6571  uch(self.has_seq
-0001c430: 7565 6e63 652c 2054 7970 6545 7272 6f72  uence, TypeError
-0001c440: 2822 4361 6e6e 6f74 2067 6574 2073 6571  ("Cannot get seq
-0001c450: 7565 6e63 6520 7374 6172 7420 6672 6f6d  uence start from
-0001c460: 2073 697a 6520 7769 7468 6f75 7420 7365   size without se
-0001c470: 7175 656e 6365 2064 696d 656e 7369 6f6e  quence dimension
-0001c480: 732e 2229 290a 2020 2020 2020 2020 7265  s.")).        re
-0001c490: 7475 726e 204e 6f6e 6520 6966 2073 656c  turn None if sel
-0001c4a0: 662e 737a 5f73 6571 7565 6e63 655f 6469  f.sz_sequence_di
-0001c4b0: 6d20 3d3d 2030 2065 6c73 6520 2873 656c  m == 0 else (sel
-0001c4c0: 662e 7365 715f 7370 635f 7374 6172 7420  f.seq_spc_start 
-0001c4d0: 6966 2073 656c 662e 737a 5f73 6571 7565  if self.sz_seque
-0001c4e0: 6e63 655f 6469 6d20 3e20 3020 656c 7365  nce_dim > 0 else
-0001c4f0: 2073 656c 662e 7365 715f 7370 635f 7374   self.seq_spc_st
-0001c500: 6f70 202b 2073 656c 662e 737a 5f73 6571  op + self.sz_seq
-0001c510: 7565 6e63 655f 6469 6d29 0a0a 2020 2020  uence_dim)..    
-0001c520: 4061 6c69 6173 2822 7469 6d65 5f73 7461  @alias("time_sta
-0001c530: 7274 222c 2022 7365 7269 6573 5f73 7461  rt", "series_sta
-0001c540: 7274 2229 0a20 2020 2040 7365 7175 656e  rt").    @sequen
-0001c550: 6365 5f73 7461 7274 2e73 6574 7465 720a  ce_start.setter.
-0001c560: 2020 2020 6465 6620 7365 7175 656e 6365      def sequence
-0001c570: 5f73 7461 7274 2873 656c 662c 2064 696d  _start(self, dim
-0001c580: 293a 0a20 2020 2020 2020 2061 766f 7563  ):.        avouc
-0001c590: 6828 6469 6d20 6973 204e 6f6e 6520 6f72  h(dim is None or
-0001c5a0: 2069 7369 6e73 7461 6e63 6528 6469 6d2c   isinstance(dim,
-0001c5b0: 2069 6e74 5f29 2c20 5479 7065 4572 726f   int_), TypeErro
-0001c5c0: 7228 6622 5365 7175 656e 6365 2073 7461  r(f"Sequence sta
-0001c5d0: 7274 2073 686f 756c 6420 6265 2061 6e20  rt should be an 
-0001c5e0: 696e 7465 6765 722e 2022 2929 0a20 2020  integer. ")).   
-0001c5f0: 2020 2020 2069 6620 6469 6d20 6973 204e       if dim is N
-0001c600: 6f6e 653a 2073 656c 662e 737a 5f73 6571  one: self.sz_seq
-0001c610: 7565 6e63 655f 6469 6d20 3d20 303b 2072  uence_dim = 0; r
-0001c620: 6574 7572 6e0a 2020 2020 2020 2020 6966  eturn.        if
-0001c630: 2064 696d 203c 2030 3a20 6469 6d20 2b3d   dim < 0: dim +=
-0001c640: 2073 656c 662e 6e5f 6469 6d0a 2020 2020   self.n_dim.    
-0001c650: 2020 2020 6176 6f75 6368 2873 656c 662e      avouch(self.
-0001c660: 7365 715f 7370 635f 7374 6172 7420 3c3d  seq_spc_start <=
-0001c670: 2064 696d 203c 2073 656c 662e 7365 715f   dim < self.seq_
-0001c680: 7370 635f 7374 6f70 2c20 5479 7065 4572  spc_stop, TypeEr
-0001c690: 726f 7228 6622 5365 7175 656e 6365 2073  ror(f"Sequence s
-0001c6a0: 7461 7274 2073 686f 756c 6420 6176 6f69  tart should avoi
-0001c6b0: 6420 7468 6520 6261 7463 682f 6665 6174  d the batch/feat
-0001c6c0: 7572 6520 6469 6d65 6e73 696f 6e73 2c20  ure dimensions, 
-0001c6d0: 7768 6963 6820 6973 2062 6574 7765 656e  which is between
-0001c6e0: 207b 7365 6c66 2e73 6571 5f73 7063 5f73   {self.seq_spc_s
-0001c6f0: 7461 7274 7d20 616e 6420 7b73 656c 662e  tart} and {self.
-0001c700: 7365 715f 7370 635f 7374 6f70 202d 2031  seq_spc_stop - 1
-0001c710: 7d2c 206f 7220 7468 6572 6520 7769 6c6c  }, or there will
-0001c720: 2062 6520 636f 6e66 6c69 6374 2e20 2229   be conflict. ")
-0001c730: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
-0001c740: 7a5f 7365 7175 656e 6365 5f64 696d 203d  z_sequence_dim =
-0001c750: 2064 696d 202d 2073 656c 662e 7365 715f   dim - self.seq_
-0001c760: 7370 635f 7374 6f70 0a0a 2020 2020 4070  spc_stop..    @p
-0001c770: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-0001c780: 7365 7175 656e 6365 5f73 746f 7028 7365  sequence_stop(se
-0001c790: 6c66 293a 0a20 2020 2020 2020 2061 766f  lf):.        avo
-0001c7a0: 7563 6828 7365 6c66 2e68 6173 5f73 6571  uch(self.has_seq
-0001c7b0: 7565 6e63 652c 2054 7970 6545 7272 6f72  uence, TypeError
-0001c7c0: 2822 4361 6e6e 6f74 2067 6574 2073 6571  ("Cannot get seq
-0001c7d0: 7565 6e63 6520 7374 6172 7420 6672 6f6d  uence start from
-0001c7e0: 2073 697a 6520 7769 7468 6f75 7420 7365   size without se
-0001c7f0: 7175 656e 6365 2064 696d 656e 7369 6f6e  quence dimension
-0001c800: 732e 2229 290a 2020 2020 2020 2020 7265  s.")).        re
-0001c810: 7475 726e 204e 6f6e 6520 6966 2073 656c  turn None if sel
-0001c820: 662e 737a 5f73 6571 7565 6e63 655f 6469  f.sz_sequence_di
-0001c830: 6d20 3d3d 2030 2065 6c73 6520 2873 656c  m == 0 else (sel
-0001c840: 662e 7365 715f 7370 635f 7374 6172 7420  f.seq_spc_start 
-0001c850: 2b20 7365 6c66 2e73 7a5f 7365 7175 656e  + self.sz_sequen
-0001c860: 6365 5f64 696d 2069 6620 7365 6c66 2e73  ce_dim if self.s
-0001c870: 7a5f 7365 7175 656e 6365 5f64 696d 203e  z_sequence_dim >
-0001c880: 2030 2065 6c73 6520 7365 6c66 2e73 6571   0 else self.seq
-0001c890: 5f73 7063 5f73 746f 7029 0a0a 2020 2020  _spc_stop)..    
-0001c8a0: 4061 6c69 6173 2822 7469 6d65 5f73 746f  @alias("time_sto
-0001c8b0: 7022 2c20 2273 6572 6965 735f 7374 6f70  p", "series_stop
-0001c8c0: 2229 0a20 2020 2040 7365 7175 656e 6365  ").    @sequence
-0001c8d0: 5f73 746f 702e 7365 7474 6572 0a20 2020  _stop.setter.   
-0001c8e0: 2064 6566 2073 6571 7565 6e63 655f 7374   def sequence_st
-0001c8f0: 6f70 2873 656c 662c 2064 696d 293a 0a20  op(self, dim):. 
-0001c900: 2020 2020 2020 2061 766f 7563 6828 6469         avouch(di
-0001c910: 6d20 6973 204e 6f6e 6520 6f72 2069 7369  m is None or isi
-0001c920: 6e73 7461 6e63 6528 6469 6d2c 2069 6e74  nstance(dim, int
-0001c930: 5f29 2c20 5479 7065 4572 726f 7228 6622  _), TypeError(f"
-0001c940: 5365 7175 656e 6365 2073 746f 7020 7368  Sequence stop sh
-0001c950: 6f75 6c64 2062 6520 616e 2069 6e74 6567  ould be an integ
-0001c960: 6572 2e20 2229 290a 2020 2020 2020 2020  er. ")).        
-0001c970: 6966 2064 696d 2069 7320 4e6f 6e65 3a20  if dim is None: 
-0001c980: 7365 6c66 2e73 7a5f 7365 7175 656e 6365  self.sz_sequence
-0001c990: 5f64 696d 203d 2030 3b20 7265 7475 726e  _dim = 0; return
-0001c9a0: 0a20 2020 2020 2020 2069 6620 6469 6d20  .        if dim 
-0001c9b0: 3c20 303a 2064 696d 202b 3d20 7365 6c66  < 0: dim += self
-0001c9c0: 2e6e 5f64 696d 0a20 2020 2020 2020 2061  .n_dim.        a
-0001c9d0: 766f 7563 6828 7365 6c66 2e73 6571 5f73  vouch(self.seq_s
-0001c9e0: 7063 5f73 7461 7274 203c 3d20 6469 6d20  pc_start <= dim 
-0001c9f0: 3c20 7365 6c66 2e73 6571 5f73 7063 5f73  < self.seq_spc_s
-0001ca00: 746f 702c 2054 7970 6545 7272 6f72 2866  top, TypeError(f
-0001ca10: 2253 6571 7565 6e63 6520 7374 6f70 2073  "Sequence stop s
-0001ca20: 686f 756c 6420 6176 6f69 6420 7468 6520  hould avoid the 
-0001ca30: 6261 7463 682f 6665 6174 7572 6520 6469  batch/feature di
-0001ca40: 6d65 6e73 696f 6e73 2c20 7768 6963 6820  mensions, which 
-0001ca50: 6973 2062 6574 7765 656e 207b 7365 6c66  is between {self
-0001ca60: 2e73 6571 5f73 7063 5f73 7461 7274 7d20  .seq_spc_start} 
-0001ca70: 616e 6420 7b73 656c 662e 7365 715f 7370  and {self.seq_sp
-0001ca80: 635f 7374 6f70 202d 2031 7d2c 206f 7220  c_stop - 1}, or 
-0001ca90: 7468 6572 6520 7769 6c6c 2062 6520 636f  there will be co
-0001caa0: 6e66 6c69 6374 2e20 2229 290a 2020 2020  nflict. ")).    
-0001cab0: 2020 2020 7365 6c66 2e73 7a5f 7365 7175      self.sz_sequ
-0001cac0: 656e 6365 5f64 696d 203d 2064 696d 202d  ence_dim = dim -
-0001cad0: 2073 656c 662e 7365 715f 7370 635f 7374   self.seq_spc_st
-0001cae0: 6172 740a 0a20 2020 2040 7072 6f70 6572  art..    @proper
-0001caf0: 7479 0a20 2020 2064 6566 2073 6571 7565  ty.    def seque
-0001cb00: 6e63 655f 7261 6e67 6528 7365 6c66 293a  nce_range(self):
-0001cb10: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001cb20: 2873 656c 662e 7365 7175 656e 6365 5f73  (self.sequence_s
-0001cb30: 7461 7274 2c20 7365 6c66 2e73 6571 7565  tart, self.seque
-0001cb40: 6e63 655f 7374 6f70 290a 2020 2020 0a20  nce_stop).    . 
-0001cb50: 2020 2040 616c 6961 7328 2274 696d 655f     @alias("time_
-0001cb60: 7261 6e67 6522 2c20 2273 6572 6965 735f  range", "series_
-0001cb70: 7261 6e67 6522 290a 2020 2020 4073 6571  range").    @seq
-0001cb80: 7565 6e63 655f 7261 6e67 652e 7365 7474  uence_range.sett
-0001cb90: 6572 0a20 2020 2064 6566 2073 6571 7565  er.    def seque
-0001cba0: 6e63 655f 7261 6e67 6528 7365 6c66 2c20  nce_range(self, 
-0001cbb0: 2a61 7267 7329 3a0a 2020 2020 2020 2020  *args):.        
-0001cbc0: 6176 6f75 6368 286c 656e 2861 7267 7329  avouch(len(args)
-0001cbd0: 203d 3d20 3220 6f72 206c 656e 2861 7267   == 2 or len(arg
-0001cbe0: 7329 203d 3d20 3120 616e 6420 6973 696e  s) == 1 and isin
-0001cbf0: 7374 616e 6365 2861 7267 735b 305d 2c20  stance(args[0], 
-0001cc00: 2874 7570 6c65 2c20 6c69 7374 2929 2061  (tuple, list)) a
-0001cc10: 6e64 206c 656e 2861 7267 735b 305d 2920  nd len(args[0]) 
-0001cc20: 3d3d 2032 2c20 0a20 2020 2020 2020 2020  == 2, .         
-0001cc30: 2020 2020 2020 224f 6e6c 7920 7477 6f20        "Only two 
-0001cc40: 7661 6c75 6573 2061 7265 2061 6c6c 6f77  values are allow
-0001cc50: 6564 2069 6e20 7468 6520 6173 7369 676e  ed in the assign
-0001cc60: 6d65 6e74 206f 6620 2773 6571 7565 6e63  ment of 'sequenc
-0001cc70: 655f 7261 6e67 6527 2c20 696e 6469 6361  e_range', indica
-0001cc80: 7469 6e67 2074 6865 2073 7461 7274 2061  ting the start a
-0001cc90: 6e64 2065 6e64 2064 696d 656e 7369 6f6e  nd end dimension
-0001cca0: 732e 2022 290a 2020 2020 2020 2020 6966  s. ").        if
-0001ccb0: 206c 656e 2861 7267 7329 203d 3d20 313a   len(args) == 1:
-0001ccc0: 2061 7267 7320 3d20 6172 6773 5b30 5d0a   args = args[0].
-0001ccd0: 2020 2020 2020 2020 6176 6f75 6368 2861          avouch(a
-0001cce0: 7267 735b 305d 203d 3d20 7365 6c66 2e73  rgs[0] == self.s
-0001ccf0: 6571 5f73 7063 5f73 7461 7274 206f 7220  eq_spc_start or 
-0001cd00: 6172 6773 5b31 5d20 3d3d 2073 656c 662e  args[1] == self.
-0001cd10: 7365 715f 7370 635f 7374 6f70 2c20 0a20  seq_spc_stop, . 
-0001cd20: 2020 2020 2020 2020 2020 2020 2020 5479                Ty
-0001cd30: 7065 4572 726f 7228 6622 4665 6174 7572  peError(f"Featur
-0001cd40: 6520 6469 6d65 6e73 696f 6e73 2061 7265  e dimensions are
-0001cd50: 2074 6865 2066 6972 7374 206f 7220 6c61   the first or la
-0001cd60: 7374 2064 696d 656e 7369 6f6e 7320 2873  st dimensions (s
-0001cd70: 7461 7274 696e 6720 6672 6f6d 207b 7365  tarting from {se
-0001cd80: 6c66 2e73 6571 5f73 7063 5f73 7461 7274  lf.seq_spc_start
-0001cd90: 7d20 6f72 2065 6e64 696e 6720 6174 207b  } or ending at {
-0001cda0: 7365 6c66 2e73 6571 5f73 7063 5f73 746f  self.seq_spc_sto
-0001cdb0: 707d 292e 2022 2929 0a20 2020 2020 2020  p}). ")).       
-0001cdc0: 2069 6620 6172 6773 5b30 5d20 3d3d 2073   if args[0] == s
-0001cdd0: 656c 662e 7365 715f 7370 635f 7374 6172  elf.seq_spc_star
-0001cde0: 743a 2073 656c 662e 7365 7175 656e 6365  t: self.sequence
-0001cdf0: 5f73 746f 7020 3d20 6172 6773 5b31 5d0a  _stop = args[1].
-0001ce00: 2020 2020 2020 2020 656c 7365 3a20 7365          else: se
-0001ce10: 6c66 2e73 6571 7565 6e63 655f 7374 6172  lf.sequence_star
-0001ce20: 7420 3d20 6172 6773 5b30 5d0a 0a20 2020  t = args[0]..   
-0001ce30: 2040 616c 6961 7328 226e 7469 6d65 222c   @alias("ntime",
-0001ce40: 2022 6e74 696d 656c 696e 6522 2c20 226e   "ntimeline", "n
-0001ce50: 7365 7269 6573 222c 2022 6e73 6571 7565  series", "nseque
-0001ce60: 6e63 6522 290a 2020 2020 4061 6c69 6173  nce").    @alias
-0001ce70: 2822 6e5f 7469 6d65 222c 2022 6e5f 7469  ("n_time", "n_ti
-0001ce80: 6d65 6c69 6e65 222c 2022 6e5f 7365 7269  meline", "n_seri
-0001ce90: 6573 2229 0a20 2020 2040 7072 6f70 6572  es").    @proper
-0001cea0: 7479 0a20 2020 2064 6566 206e 5f73 6571  ty.    def n_seq
-0001ceb0: 7565 6e63 6528 7365 6c66 293a 0a20 2020  uence(self):.   
-0001cec0: 2020 2020 2061 766f 7563 6828 7365 6c66       avouch(self
-0001ced0: 2e68 6173 5f73 6571 7565 6e63 6520 3e20  .has_sequence > 
-0001cee0: 302c 2054 7970 6545 7272 6f72 2866 2243  0, TypeError(f"C
-0001cef0: 616e 6e6f 7420 6765 7420 7365 7175 656e  annot get sequen
-0001cf00: 6365 2064 696d 656e 7369 6f6e 7320 6672  ce dimensions fr
-0001cf10: 6f6d 2073 697a 6520 7b73 656c 667d 2e22  om size {self}."
-0001cf20: 2929 0a20 2020 2020 2020 2070 203d 2031  )).        p = 1
-0001cf30: 0a20 2020 2020 2020 2066 6f72 2069 2069  .        for i i
-0001cf40: 6e20 7261 6e67 655f 282a 7365 6c66 2e73  n range_(*self.s
-0001cf50: 6571 7565 6e63 655f 7261 6e67 6529 3a20  equence_range): 
-0001cf60: 7020 2a3d 2073 656c 665b 695d 0a20 2020  p *= self[i].   
-0001cf70: 2020 2020 2072 6574 7572 6e20 700a 0a20       return p.. 
-0001cf80: 2020 2040 616c 6961 7328 2274 696d 655f     @alias("time_
-0001cf90: 7369 7a65 222c 2022 7365 7269 6573 5f73  size", "series_s
-0001cfa0: 697a 6522 2c20 2273 6571 7565 6e63 655f  ize", "sequence_
-0001cfb0: 7369 7a65 2229 0a20 2020 2040 616c 6961  size").    @alia
-0001cfc0: 7328 2274 696d 6522 2c20 2273 6572 6965  s("time", "serie
-0001cfd0: 7322 290a 2020 2020 4070 726f 7065 7274  s").    @propert
-0001cfe0: 790a 2020 2020 6465 6620 7365 7175 656e  y.    def sequen
-0001cff0: 6365 2873 656c 6629 3a0a 2020 2020 2020  ce(self):.      
-0001d000: 2020 7265 7475 726e 2073 656c 665b 7365    return self[se
-0001d010: 6c66 2e73 6571 7565 6e63 655f 7374 6172  lf.sequence_star
-0001d020: 743a 7365 6c66 2e73 6571 7565 6e63 655f  t:self.sequence_
-0001d030: 7374 6f70 5d0a 0a20 2020 2040 616c 6961  stop]..    @alia
-0001d040: 7328 2277 6974 685f 7469 6d65 222c 2022  s("with_time", "
-0001d050: 7769 7468 5f73 6572 6965 7322 290a 2020  with_series").  
-0001d060: 2020 6465 6620 7769 7468 5f73 6571 7565    def with_seque
-0001d070: 6e63 6528 7365 6c66 2c20 2a73 697a 6529  nce(self, *size)
-0001d080: 3a0a 2020 2020 2020 2020 6966 206c 656e  :.        if len
-0001d090: 2873 697a 6529 203d 3d20 3120 616e 6420  (size) == 1 and 
-0001d0a0: 6973 696e 7374 616e 6365 2873 697a 655b  isinstance(size[
-0001d0b0: 305d 2c20 7475 706c 6529 3a20 7369 7a65  0], tuple): size
-0001d0c0: 203d 2073 697a 655b 305d 0a20 2020 2020   = size[0].     
-0001d0d0: 2020 2061 766f 7563 6828 616c 6c5f 2869     avouch(all_(i
-0001d0e0: 7369 6e73 7461 6e63 6528 782c 2069 6e74  sinstance(x, int
-0001d0f0: 5f29 2066 6f72 2078 2069 6e20 7369 7a65  _) for x in size
-0001d100: 292c 2054 7970 6545 7272 6f72 2822 7365  ), TypeError("se
-0001d110: 7175 656e 6365 2073 697a 6520 7368 6f75  quence size shou
-0001d120: 6c64 2062 6520 6120 7475 706c 6520 6f66  ld be a tuple of
-0001d130: 2069 6e74 6567 6572 732e 2022 2929 0a20   integers. ")). 
-0001d140: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-0001d150: 6c66 2e68 6173 5f73 6571 7565 6e63 653a  lf.has_sequence:
-0001d160: 2073 7461 7274 203d 2073 656c 662e 7365   start = self.se
-0001d170: 715f 7370 635f 7374 6f70 3b20 7374 6f70  q_spc_stop; stop
-0001d180: 203d 2073 656c 662e 7365 715f 7370 635f   = self.seq_spc_
-0001d190: 7374 6f70 0a20 2020 2020 2020 2065 6c73  stop.        els
-0001d1a0: 653a 2073 7461 7274 203d 2073 656c 662e  e: start = self.
-0001d1b0: 7365 7175 656e 6365 5f73 7461 7274 3b20  sequence_start; 
-0001d1c0: 7374 6f70 203d 2073 656c 662e 7365 7175  stop = self.sequ
-0001d1d0: 656e 6365 5f73 746f 700a 2020 2020 2020  ence_stop.      
-0001d1e0: 2020 2320 6176 6f75 6368 286c 656e 2873    # avouch(len(s
-0001d1f0: 697a 6529 203d 3d20 7365 6c66 2e6e 5f73  ize) == self.n_s
-0001d200: 6571 7565 6e63 655f 6469 6d2c 2066 2243  equence_dim, f"C
-0001d210: 616e 6e6f 7420 7375 6273 7469 7475 7465  annot substitute
-0001d220: 2073 6571 7565 6e63 6520 696e 207b 7365   sequence in {se
-0001d230: 6c66 7d20 6279 207b 7369 7a65 7d20 6173  lf} by {size} as
-0001d240: 2074 6865 6972 2064 696d 656e 7369 6f6e   their dimension
-0001d250: 7320 6172 6520 6e6f 7420 7468 6520 7361  s are not the sa
-0001d260: 6d65 2e22 290a 2020 2020 2020 2020 7265  me.").        re
-0001d270: 7475 726e 2073 656c 665b 3a73 7461 7274  turn self[:start
-0001d280: 5d20 2b20 5369 7a65 2873 697a 652c 2073  ] + Size(size, s
-0001d290: 7a5f 7365 7175 656e 6365 5f64 696d 3d6c  z_sequence_dim=l
-0001d2a0: 656e 2873 697a 6529 2920 2b20 7365 6c66  en(size)) + self
-0001d2b0: 5b73 746f 703a 5d0a 0a20 2020 2023 2320  [stop:]..    ## 
-0001d2c0: 7370 6163 6520 6469 6d65 6e73 696f 6e73  space dimensions
-0001d2d0: 3a0a 2020 2020 4070 726f 7065 7274 790a  :.    @property.
-0001d2e0: 2020 2020 6465 6620 6861 735f 7370 6163      def has_spac
-0001d2f0: 6528 7365 6c66 293a 2072 6574 7572 6e20  e(self): return 
-0001d300: 7365 6c66 2e6e 5f73 7061 6365 5f64 696d  self.n_space_dim
-0001d310: 203e 2030 0a20 2020 200a 2020 2020 4061   > 0.    .    @a
-0001d320: 6c69 6173 2822 6973 5f73 7061 6365 6469  lias("is_spacedi
-0001d330: 6d22 290a 2020 2020 6465 6620 6973 5f73  m").    def is_s
-0001d340: 7061 6365 5f64 696d 2873 656c 662c 2069  pace_dim(self, i
-0001d350: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0001d360: 6e20 7365 6c66 2e73 7061 6365 5f73 7461  n self.space_sta
-0001d370: 7274 203c 3d20 6920 3c20 7365 6c66 2e73  rt <= i < self.s
-0001d380: 7061 6365 5f73 746f 700a 0a20 2020 2040  pace_stop..    @
-0001d390: 616c 6961 7328 226e 7370 6163 6564 696d  alias("nspacedim
-0001d3a0: 2229 0a20 2020 2040 7072 6f70 6572 7479  ").    @property
-0001d3b0: 0a20 2020 2064 6566 206e 5f73 7061 6365  .    def n_space
-0001d3c0: 5f64 696d 2873 656c 6629 3a0a 2020 2020  _dim(self):.    
-0001d3d0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0001d3e0: 6e5f 6469 6d20 2d20 7365 6c66 2e6e 5f66  n_dim - self.n_f
-0001d3f0: 756e 635f 6469 6d20 2d20 7365 6c66 2e6e  unc_dim - self.n
-0001d400: 5f62 6174 6368 5f64 696d 202d 2073 656c  _batch_dim - sel
-0001d410: 662e 6e5f 6665 6174 7572 655f 6469 6d20  f.n_feature_dim 
-0001d420: 2d20 7365 6c66 2e6e 5f73 6571 7565 6e63  - self.n_sequenc
-0001d430: 655f 6469 6d0a 2020 2020 0a20 2020 2040  e_dim.    .    @
-0001d440: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-0001d450: 2073 7061 6365 5f73 7461 7274 2873 656c   space_start(sel
-0001d460: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
-0001d470: 726e 206d 6178 5f28 7365 6c66 2e73 7a5f  rn max_(self.sz_
-0001d480: 6675 6e63 5f64 696d 2c20 3029 202b 206d  func_dim, 0) + m
-0001d490: 6178 5f28 7365 6c66 2e73 7a5f 6261 7463  ax_(self.sz_batc
-0001d4a0: 685f 6469 6d2c 2030 2920 2b20 6d61 785f  h_dim, 0) + max_
-0001d4b0: 2873 656c 662e 737a 5f66 6561 7475 7265  (self.sz_feature
-0001d4c0: 5f64 696d 2c20 3029 202b 206d 6178 5f28  _dim, 0) + max_(
-0001d4d0: 7365 6c66 2e73 7a5f 7365 7175 656e 6365  self.sz_sequence
-0001d4e0: 5f64 696d 2c20 3029 0a20 2020 200a 2020  _dim, 0).    .  
-0001d4f0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-0001d500: 6465 6620 7370 6163 655f 7374 6f70 2873  def space_stop(s
-0001d510: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
-0001d520: 7475 726e 2073 656c 662e 6e5f 6469 6d20  turn self.n_dim 
-0001d530: 2b20 6d69 6e5f 2873 656c 662e 737a 5f66  + min_(self.sz_f
-0001d540: 756e 635f 6469 6d2c 2030 2920 2b20 6d69  unc_dim, 0) + mi
-0001d550: 6e5f 2873 656c 662e 737a 5f62 6174 6368  n_(self.sz_batch
-0001d560: 5f64 696d 2c20 3029 202b 206d 696e 5f28  _dim, 0) + min_(
-0001d570: 7365 6c66 2e73 7a5f 6665 6174 7572 655f  self.sz_feature_
-0001d580: 6469 6d2c 2030 2920 2b20 6d69 6e5f 2873  dim, 0) + min_(s
-0001d590: 656c 662e 737a 5f73 6571 7565 6e63 655f  elf.sz_sequence_
-0001d5a0: 6469 6d2c 2030 290a 0a20 2020 2040 7072  dim, 0)..    @pr
-0001d5b0: 6f70 6572 7479 0a20 2020 2064 6566 2073  operty.    def s
-0001d5c0: 7061 6365 5f72 616e 6765 2873 656c 6629  pace_range(self)
-0001d5d0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0001d5e0: 2028 7365 6c66 2e73 7061 6365 5f73 7461   (self.space_sta
-0001d5f0: 7274 2c20 7365 6c66 2e73 7061 6365 5f73  rt, self.space_s
-0001d600: 746f 7029 0a0a 2020 2020 4061 6c69 6173  top)..    @alias
-0001d610: 2822 6e73 7061 6365 2229 0a20 2020 2040  ("nspace").    @
-0001d620: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-0001d630: 206e 5f73 7061 6365 2873 656c 6629 3a0a   n_space(self):.
-0001d640: 2020 2020 2020 2020 6176 6f75 6368 2873          avouch(s
-0001d650: 656c 662e 6861 735f 7370 6163 652c 2054  elf.has_space, T
-0001d660: 7970 6545 7272 6f72 2866 2243 616e 6e6f  ypeError(f"Canno
-0001d670: 7420 6765 7420 7370 6163 6520 6469 6d65  t get space dime
-0001d680: 6e73 696f 6e73 2066 726f 6d20 7369 7a65  nsions from size
-0001d690: 207b 7365 6c66 7d2e 2229 290a 2020 2020   {self}.")).    
-0001d6a0: 2020 2020 7020 3d20 310a 2020 2020 2020      p = 1.      
-0001d6b0: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-0001d6c0: 5f28 2a73 656c 662e 7370 6163 655f 7261  _(*self.space_ra
-0001d6d0: 6e67 6529 3a20 7020 2a3d 2073 656c 665b  nge): p *= self[
-0001d6e0: 695d 0a20 2020 2020 2020 2072 6574 7572  i].        retur
-0001d6f0: 6e20 700a 0a20 2020 2040 616c 6961 7328  n p..    @alias(
-0001d700: 2273 7061 6365 5f73 697a 6522 290a 2020  "space_size").  
-0001d710: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-0001d720: 6465 6620 7370 6163 6528 7365 6c66 293a  def space(self):
-0001d730: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001d740: 7365 6c66 5b73 656c 662e 7370 6163 655f  self[self.space_
-0001d750: 7374 6172 743a 7365 6c66 2e73 7061 6365  start:self.space
-0001d760: 5f73 746f 705d 0a0a 2020 2020 6465 6620  _stop]..    def 
-0001d770: 7769 7468 5f73 7061 6365 2873 656c 662c  with_space(self,
-0001d780: 202a 7369 7a65 293a 0a20 2020 2020 2020   *size):.       
-0001d790: 2069 6620 6c65 6e28 7369 7a65 2920 3d3d   if len(size) ==
-0001d7a0: 2031 2061 6e64 2069 7369 6e73 7461 6e63   1 and isinstanc
-0001d7b0: 6528 7369 7a65 5b30 5d2c 2074 7570 6c65  e(size[0], tuple
-0001d7c0: 293a 2073 697a 6520 3d20 7369 7a65 5b30  ): size = size[0
-0001d7d0: 5d0a 2020 2020 2020 2020 6176 6f75 6368  ].        avouch
-0001d7e0: 2861 6c6c 5f28 6973 696e 7374 616e 6365  (all_(isinstance
-0001d7f0: 2878 2c20 696e 745f 2920 666f 7220 7820  (x, int_) for x 
-0001d800: 696e 2073 697a 6529 2c20 5479 7065 4572  in size), TypeEr
-0001d810: 726f 7228 2273 7061 6365 2073 697a 6520  ror("space size 
-0001d820: 7368 6f75 6c64 2062 6520 6120 7475 706c  should be a tupl
-0001d830: 6520 6f66 2069 6e74 6567 6572 732e 2022  e of integers. "
-0001d840: 2929 0a20 2020 2020 2020 2023 2061 766f  )).        # avo
-0001d850: 7563 6828 6c65 6e28 7369 7a65 2920 3d3d  uch(len(size) ==
-0001d860: 2073 656c 662e 6e5f 7370 6163 655f 6469   self.n_space_di
-0001d870: 6d2c 2066 2243 616e 6e6f 7420 7375 6273  m, f"Cannot subs
-0001d880: 7469 7475 7465 2073 7061 6365 2069 6e20  titute space in 
-0001d890: 7b73 656c 667d 2062 7920 7b73 697a 657d  {self} by {size}
-0001d8a0: 2061 7320 7468 6569 7220 6469 6d65 6e73   as their dimens
-0001d8b0: 696f 6e73 2061 7265 206e 6f74 2074 6865  ions are not the
-0001d8c0: 2073 616d 652e 2229 0a20 2020 2020 2020   same.").       
-0001d8d0: 2072 6574 7572 6e20 7365 6c66 5b3a 7365   return self[:se
-0001d8e0: 6c66 2e73 7061 6365 5f73 7461 7274 5d20  lf.space_start] 
-0001d8f0: 2b20 7369 7a65 202b 2073 656c 665b 7365  + size + self[se
-0001d900: 6c66 2e73 7061 6365 5f73 746f 703a 5d0a  lf.space_stop:].
-0001d910: 0a20 2020 2023 2320 7370 6563 6961 6c20  .    ## special 
-0001d920: 6469 6d65 6e73 696f 6e73 3a0a 2020 2020  dimensions:.    
-0001d930: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
-0001d940: 6620 6861 735f 7370 6563 6961 6c28 7365  f has_special(se
-0001d950: 6c66 293a 2072 6574 7572 6e20 7365 6c66  lf): return self
-0001d960: 2e68 6173 5f66 756e 6320 6f72 2073 656c  .has_func or sel
-0001d970: 662e 6861 735f 6261 7463 6820 6f72 2073  f.has_batch or s
-0001d980: 656c 662e 6861 735f 6665 6174 7572 6520  elf.has_feature 
-0001d990: 6f72 2073 656c 662e 6861 735f 7365 7175  or self.has_sequ
-0001d9a0: 656e 6365 0a0a 2020 2020 4061 6c69 6173  ence..    @alias
-0001d9b0: 2822 6e73 7065 6369 616c 6469 6d22 290a  ("nspecialdim").
-0001d9c0: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-0001d9d0: 2020 6465 6620 6e5f 7370 6563 6961 6c5f    def n_special_
-0001d9e0: 6469 6d28 7365 6c66 293a 0a20 2020 2020  dim(self):.     
-0001d9f0: 2020 2072 6574 7572 6e20 7365 6c66 2e6e     return self.n
-0001da00: 5f66 756e 635f 6469 6d20 2b20 7365 6c66  _func_dim + self
-0001da10: 2e6e 5f62 6174 6368 5f64 696d 202b 2073  .n_batch_dim + s
-0001da20: 656c 662e 6e5f 6665 6174 7572 655f 6469  elf.n_feature_di
-0001da30: 6d20 2b20 7365 6c66 2e6e 5f73 6571 7565  m + self.n_seque
-0001da40: 6e63 655f 6469 6d0a 0a20 2020 2040 7072  nce_dim..    @pr
-0001da50: 6f70 6572 7479 0a20 2020 2064 6566 2073  operty.    def s
-0001da60: 7065 6369 616c 5f64 696d 7328 7365 6c66  pecial_dims(self
-0001da70: 293a 0a20 2020 2020 2020 2073 6469 6d5f  ):.        sdim_
-0001da80: 6c69 7374 203d 2028 285b 5d20 6966 2073  list = (([] if s
-0001da90: 656c 662e 737a 5f66 756e 635f 6469 6d20  elf.sz_func_dim 
-0001daa0: 3d3d 2030 2065 6c73 6520 285b 305d 2069  == 0 else ([0] i
-0001dab0: 6620 7365 6c66 2e73 7a5f 6675 6e63 5f64  f self.sz_func_d
-0001dac0: 696d 203e 2030 2065 6c73 6520 5b73 656c  im > 0 else [sel
-0001dad0: 662e 6e5f 6469 6d2d 315d 2929 202b 200a  f.n_dim-1])) + .
-0001dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001daf0: 2020 2020 2028 5b5d 2069 6620 7365 6c66       ([] if self
-0001db00: 2e73 7a5f 6261 7463 685f 6469 6d20 3d3d  .sz_batch_dim ==
-0001db10: 2030 2065 6c73 6520 285b 7365 6c66 2e73   0 else ([self.s
-0001db20: 697a 655f 7374 6172 745d 2069 6620 7365  ize_start] if se
-0001db30: 6c66 2e73 7a5f 6261 7463 685f 6469 6d20  lf.sz_batch_dim 
-0001db40: 3e20 3020 656c 7365 205b 7365 6c66 2e73  > 0 else [self.s
-0001db50: 697a 655f 7374 6f70 5d29 2920 2b20 0a20  ize_stop])) + . 
-0001db60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001db70: 2020 2020 285b 5d20 6966 2073 656c 662e      ([] if self.
-0001db80: 737a 5f66 6561 7475 7265 5f64 696d 203d  sz_feature_dim =
-0001db90: 3d20 3020 656c 7365 206c 6973 7428 7261  = 0 else list(ra
-0001dba0: 6e67 655f 2873 656c 662e 6665 6174 7572  nge_(self.featur
-0001dbb0: 655f 7374 6172 742c 2073 656c 662e 6665  e_start, self.fe
-0001dbc0: 6174 7572 655f 7374 6f70 2929 2920 2b20  ature_stop))) + 
-0001dbd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001dbe0: 2020 2020 2020 285b 5d20 6966 2073 656c        ([] if sel
-0001dbf0: 662e 737a 5f73 6571 7565 6e63 655f 6469  f.sz_sequence_di
-0001dc00: 6d20 3d3d 2030 2065 6c73 6520 6c69 7374  m == 0 else list
-0001dc10: 2872 616e 6765 5f28 7365 6c66 2e73 6571  (range_(self.seq
-0001dc20: 7565 6e63 655f 7374 6172 742c 2073 656c  uence_start, sel
-0001dc30: 662e 7365 7175 656e 6365 5f73 746f 7029  f.sequence_stop)
-0001dc40: 2929 290a 2020 2020 2020 2020 7364 696d  ))).        sdim
-0001dc50: 5f6c 6973 742e 736f 7274 2829 0a20 2020  _list.sort().   
-0001dc60: 2020 2020 2072 6574 7572 6e20 7364 696d       return sdim
-0001dc70: 5f6c 6973 740a 2020 2020 0a20 2020 2064  _list.    .    d
-0001dc80: 6566 2061 6464 5f73 7065 6369 616c 5f64  ef add_special_d
-0001dc90: 696d 2873 656c 662c 2069 6e64 6578 2c20  im(self, index, 
-0001dca0: 2a72 6566 6572 656e 6365 293a 0a20 2020  *reference):.   
-0001dcb0: 2020 2020 2061 766f 7563 6828 6c65 6e28       avouch(len(
-0001dcc0: 7265 6665 7265 6e63 6529 203d 3d20 312c  reference) == 1,
-0001dcd0: 2054 7970 6545 7272 6f72 2822 4f6e 6c79   TypeError("Only
-0001dce0: 206f 6e65 2064 696d 656e 7369 6f6e 2069   one dimension i
-0001dcf0: 7320 6163 6365 7074 6162 6c65 2066 6f72  s acceptable for
-0001dd00: 2027 6164 645f 7370 6563 6961 6c5f 6469   'add_special_di
-0001dd10: 6d27 2e20 2229 290a 2020 2020 2020 2020  m'. ")).        
-0001dd20: 6176 6f75 6368 282d 7365 6c66 2e6e 5f64  avouch(-self.n_d
-0001dd30: 696d 203c 3d20 696e 6465 7820 3c20 7365  im <= index < se
-0001dd40: 6c66 2e6e 5f64 696d 2c20 5479 7065 4572  lf.n_dim, TypeEr
-0001dd50: 726f 7228 6622 496e 6465 7820 666f 7220  ror(f"Index for 
-0001dd60: 2761 6464 5f73 7065 6369 616c 5f64 696d  'add_special_dim
-0001dd70: 2720 7368 6f75 6c64 2062 6520 7769 7468  ' should be with
-0001dd80: 696e 2074 6865 2074 6f74 616c 2064 696d  in the total dim
-0001dd90: 656e 7369 6f6e 733a 2066 726f 6d20 7b2d  ensions: from {-
-0001dda0: 7365 6c66 2e6e 5f64 696d 7d20 746f 207b  self.n_dim} to {
-0001ddb0: 7365 6c66 2e6e 5f64 696d 2d31 7d2e 2022  self.n_dim-1}. "
-0001ddc0: 2929 0a20 2020 2020 2020 2069 6620 696e  )).        if in
-0001ddd0: 6465 7820 3c20 303a 2069 6e64 6578 202b  dex < 0: index +
-0001dde0: 3d20 7365 6c66 2e6e 5f64 696d 0a20 2020  = self.n_dim.   
-0001ddf0: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
-0001de00: 7374 616e 6365 2872 6566 6572 656e 6365  stance(reference
-0001de10: 5b30 5d2c 2053 697a 6529 3a20 7265 6665  [0], Size): refe
-0001de20: 7265 6e63 6520 3d20 5369 7a65 282a 7265  rence = Size(*re
-0001de30: 6665 7265 6e63 6529 0a20 2020 2020 2020  ference).       
-0001de40: 2065 6c73 653a 2072 6566 6572 656e 6365   else: reference
-0001de50: 203d 2072 6566 6572 656e 6365 5b30 5d0a   = reference[0].
-0001de60: 2020 2020 2020 2020 6966 2072 6566 6572          if refer
-0001de70: 656e 6365 2e68 6173 5f66 756e 633a 0a20  ence.has_func:. 
-0001de80: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001de90: 6e20 7365 6c66 5b3a 696e 6465 785d 202b  n self[:index] +
-0001dea0: 2066 756e 635f 6469 6d5f 7369 7a65 2873   func_dim_size(s
-0001deb0: 656c 665b 696e 6465 785d 2920 2b20 7365  elf[index]) + se
-0001dec0: 6c66 5b69 6e64 6578 2b31 3a5d 0a20 2020  lf[index+1:].   
-0001ded0: 2020 2020 2069 6620 7265 6665 7265 6e63       if referenc
-0001dee0: 652e 6861 735f 6261 7463 683a 0a20 2020  e.has_batch:.   
-0001def0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001df00: 7365 6c66 5b3a 696e 6465 785d 202b 2053  self[:index] + S
-0001df10: 697a 6528 7b73 656c 665b 696e 6465 785d  ize({self[index]
-0001df20: 7d29 202b 2073 656c 665b 696e 6465 782b  }) + self[index+
-0001df30: 313a 5d0a 2020 2020 2020 2020 6966 2072  1:].        if r
-0001df40: 6566 6572 656e 6365 2e68 6173 5f66 6561  eference.has_fea
-0001df50: 7475 7265 3a0a 2020 2020 2020 2020 2020  ture:.          
-0001df60: 2020 6966 2073 656c 662e 6861 735f 6665    if self.has_fe
-0001df70: 6174 7572 653a 2061 766f 7563 6828 7365  ature: avouch(se
-0001df80: 6c66 2e66 6561 7475 7265 5f73 7461 7274  lf.feature_start
-0001df90: 202d 2031 203c 3d20 696e 6465 7820 3c3d   - 1 <= index <=
-0001dfa0: 2073 656c 662e 6665 6174 7572 655f 7374   self.feature_st
-0001dfb0: 6f70 2c20 5479 7065 4572 726f 7228 6622  op, TypeError(f"
-0001dfc0: 4f6e 6c79 2064 696d 656e 7369 6f6e 7320  Only dimensions 
-0001dfd0: 6164 6a61 6365 6e74 2074 6f20 6375 7272  adjacent to curr
-0001dfe0: 656e 7420 6361 6e20 6265 2063 6f6e 7665  ent can be conve
-0001dff0: 7274 6564 2069 6e74 6f20 6665 6174 7572  rted into featur
-0001e000: 6573 2062 7920 2761 6464 5f73 7065 6369  es by 'add_speci
-0001e010: 616c 5f64 696d 273a 2074 7279 696e 6720  al_dim': trying 
-0001e020: 746f 2063 6f6e 7665 7274 207b 696e 6465  to convert {inde
-0001e030: 787d 2d74 6820 6469 6d20 746f 2066 6561  x}-th dim to fea
-0001e040: 7475 7265 2069 6e20 7b73 656c 667d 2e20  ture in {self}. 
-0001e050: 2229 290a 2020 2020 2020 2020 2020 2020  ")).            
-0001e060: 7265 7475 726e 2073 656c 665b 3a69 6e64  return self[:ind
-0001e070: 6578 5d20 2b20 5369 7a65 285b 7365 6c66  ex] + Size([self
-0001e080: 5b69 6e64 6578 5d5d 2920 2b20 7365 6c66  [index]]) + self
-0001e090: 5b69 6e64 6578 2b31 3a5d 0a20 2020 2020  [index+1:].     
-0001e0a0: 2020 2069 6620 7265 6665 7265 6e63 652e     if reference.
-0001e0b0: 6861 735f 7365 7175 656e 6365 3a0a 2020  has_sequence:.  
-0001e0c0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-0001e0d0: 662e 6861 735f 7365 7175 656e 6365 3a20  f.has_sequence: 
-0001e0e0: 6176 6f75 6368 2873 656c 662e 7365 7175  avouch(self.sequ
-0001e0f0: 656e 6365 5f73 7461 7274 202d 2031 203c  ence_start - 1 <
-0001e100: 3d20 696e 6465 7820 3c3d 2073 656c 662e  = index <= self.
-0001e110: 7365 7175 656e 6365 5f73 746f 702c 2054  sequence_stop, T
-0001e120: 7970 6545 7272 6f72 2866 224f 6e6c 7920  ypeError(f"Only 
-0001e130: 6469 6d65 6e73 696f 6e73 2061 646a 6163  dimensions adjac
-0001e140: 656e 7420 746f 2063 7572 7265 6e74 2063  ent to current c
-0001e150: 616e 2062 6520 636f 6e76 6572 7465 6420  an be converted 
-0001e160: 696e 746f 2073 6571 7565 6e63 6573 2062  into sequences b
-0001e170: 7920 2761 6464 5f73 7065 6369 616c 5f64  y 'add_special_d
-0001e180: 696d 273a 2074 7279 696e 6720 746f 2063  im': trying to c
-0001e190: 6f6e 7665 7274 207b 696e 6465 787d 2d74  onvert {index}-t
-0001e1a0: 6820 6469 6d20 746f 2073 6571 7565 6e63  h dim to sequenc
-0001e1b0: 6520 696e 207b 7365 6c66 7d2e 2022 2929  e in {self}. "))
-0001e1c0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001e1d0: 7572 6e20 7365 6c66 5b3a 696e 6465 785d  urn self[:index]
-0001e1e0: 202b 2053 697a 6528 7265 7072 2873 7472   + Size(repr(str
-0001e1f0: 2873 656c 665b 696e 6465 785d 2929 2920  (self[index]))) 
-0001e200: 2b20 7365 6c66 5b69 6e64 6578 2b31 3a5d  + self[index+1:]
-0001e210: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001e220: 7365 6c66 0a20 2020 200a 2020 2020 6465  self.    .    de
-0001e230: 6620 6368 616e 6765 5f73 7065 6369 616c  f change_special
-0001e240: 5f64 696d 2873 656c 662c 2066 726f 6d5f  _dim(self, from_
-0001e250: 6469 6d2c 202a 746f 5f64 696d 293a 0a20  dim, *to_dim):. 
-0001e260: 2020 2020 2020 2066 726f 6d5f 6469 6d20         from_dim 
-0001e270: 3d20 6578 6973 745f 6469 6d28 7365 6c66  = exist_dim(self
-0001e280: 2c20 6672 6f6d 5f64 696d 290a 2020 2020  , from_dim).    
-0001e290: 2020 2020 6176 6f75 6368 286c 656e 2866      avouch(len(f
-0001e2a0: 726f 6d5f 6469 6d29 203d 3d20 312c 2054  rom_dim) == 1, T
-0001e2b0: 7970 6545 7272 6f72 2822 4f6e 6c79 206f  ypeError("Only o
-0001e2c0: 6e65 2027 6672 6f6d 5f64 696d 2720 6973  ne 'from_dim' is
-0001e2d0: 2061 6363 6570 7461 626c 6520 666f 7220   acceptable for 
-0001e2e0: 2763 6861 6e67 655f 7370 6563 6961 6c5f  'change_special_
-0001e2f0: 6469 6d27 2e20 2229 290a 2020 2020 2020  dim'. ")).      
-0001e300: 2020 7265 7475 726e 2073 656c 662e 6164    return self.ad
-0001e310: 645f 7370 6563 6961 6c5f 6469 6d28 6672  d_special_dim(fr
-0001e320: 6f6d 5f64 696d 5b30 5d2c 202a 746f 5f64  om_dim[0], *to_d
-0001e330: 696d 290a 0a20 2020 2064 6566 2073 7065  im)..    def spe
-0001e340: 6369 616c 5f66 726f 6d28 7365 6c66 2c20  cial_from(self, 
-0001e350: 6f74 6865 722c 2061 6c6c 6f77 5f76 6965  other, allow_vie
-0001e360: 773d 4661 6c73 6529 3a0a 2020 2020 2020  w=False):.      
-0001e370: 2020 6176 6f75 6368 2869 7369 6e73 7461    avouch(isinsta
-0001e380: 6e63 6528 6f74 6865 722c 2028 7475 706c  nce(other, (tupl
-0001e390: 652c 2053 697a 652c 2054 656e 736f 7229  e, Size, Tensor)
-0001e3a0: 292c 2054 7970 6545 7272 6f72 2866 2249  ), TypeError(f"I
-0001e3b0: 6e76 616c 6964 2069 6e70 7574 2066 6f72  nvalid input for
-0001e3c0: 2053 697a 652e 7370 6563 6961 6c5f 6672   Size.special_fr
-0001e3d0: 6f6d 3a20 7b74 7970 6528 6f74 6865 7229  om: {type(other)
-0001e3e0: 7d2e 2022 2929 0a20 2020 2020 2020 2069  }. ")).        i
-0001e3f0: 6620 6973 696e 7374 616e 6365 286f 7468  f isinstance(oth
-0001e400: 6572 2c20 5465 6e73 6f72 293a 206f 7468  er, Tensor): oth
-0001e410: 6572 203d 206f 7468 6572 2e73 6861 7065  er = other.shape
-0001e420: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-0001e430: 7374 616e 6365 286f 7468 6572 2c20 5369  stance(other, Si
-0001e440: 7a65 293a 0a20 2020 2020 2020 2020 2020  ze):.           
-0001e450: 2069 6620 7365 6c66 2e6e 5f64 696d 2021   if self.n_dim !
-0001e460: 3d20 6f74 6865 722e 6e5f 6469 6d3a 0a20  = other.n_dim:. 
-0001e470: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001e480: 6620 616c 6c6f 775f 7669 6577 3a20 7265  f allow_view: re
-0001e490: 7475 726e 2073 656c 662e 7669 6577 286f  turn self.view(o
-0001e4a0: 7468 6572 290a 2020 2020 2020 2020 2020  ther).          
-0001e4b0: 2020 2020 2020 7261 6973 6520 5479 7065        raise Type
-0001e4c0: 4572 726f 7228 6622 4469 6d65 6e73 696f  Error(f"Dimensio
-0001e4d0: 6e20 6d69 736d 6174 6368 2077 6865 6e20  n mismatch when 
-0001e4e0: 696e 6865 7269 7469 6e67 2073 7065 6369  inheriting speci
-0001e4f0: 616c 2064 696d 656e 7369 6f6e 733a 2066  al dimensions: f
-0001e500: 726f 6d20 7b6f 7468 6572 2e6e 5f64 696d  rom {other.n_dim
-0001e510: 7d20 746f 207b 7365 6c66 2e6e 5f64 696d  } to {self.n_dim
-0001e520: 7d2e 2022 290a 2020 2020 2020 2020 7365  }. ").        se
-0001e530: 6c66 2e73 7a5f 6675 6e63 5f64 696d 203d  lf.sz_func_dim =
-0001e540: 2067 6574 6174 7472 286f 7468 6572 2c20   getattr(other, 
-0001e550: 2773 7a5f 6675 6e63 5f64 696d 272c 2030  'sz_func_dim', 0
-0001e560: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
-0001e570: 7a5f 6261 7463 685f 6469 6d20 3d20 6765  z_batch_dim = ge
-0001e580: 7461 7474 7228 6f74 6865 722c 2027 737a  tattr(other, 'sz
-0001e590: 5f62 6174 6368 5f64 696d 272c 2030 290a  _batch_dim', 0).
-0001e5a0: 2020 2020 2020 2020 7365 6c66 2e73 7a5f          self.sz_
-0001e5b0: 6665 6174 7572 655f 6469 6d20 3d20 6765  feature_dim = ge
-0001e5c0: 7461 7474 7228 6f74 6865 722c 2027 737a  tattr(other, 'sz
-0001e5d0: 5f66 6561 7475 7265 5f64 696d 272c 2030  _feature_dim', 0
-0001e5e0: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
-0001e5f0: 7a5f 7365 7175 656e 6365 5f64 696d 203d  z_sequence_dim =
-0001e600: 2067 6574 6174 7472 286f 7468 6572 2c20   getattr(other, 
-0001e610: 2773 7a5f 7365 7175 656e 6365 5f64 696d  'sz_sequence_dim
-0001e620: 272c 2030 290a 2020 2020 2020 2020 7265  ', 0).        re
-0001e630: 7475 726e 2073 656c 660a 0a20 2020 2064  turn self..    d
-0001e640: 6566 2075 7064 6174 655f 7370 6563 6961  ef update_specia
-0001e650: 6c5f 6672 6f6d 2873 656c 662c 206f 7468  l_from(self, oth
-0001e660: 6572 293a 0a20 2020 2020 2020 2061 766f  er):.        avo
-0001e670: 7563 6828 6973 696e 7374 616e 6365 286f  uch(isinstance(o
-0001e680: 7468 6572 2c20 2874 7570 6c65 2c20 5369  ther, (tuple, Si
-0001e690: 7a65 2c20 5465 6e73 6f72 2929 2c20 5479  ze, Tensor)), Ty
-0001e6a0: 7065 4572 726f 7228 6622 496e 7661 6c69  peError(f"Invali
-0001e6b0: 6420 696e 7075 7420 666f 7220 5369 7a65  d input for Size
-0001e6c0: 2e73 7065 6369 616c 5f66 726f 6d3a 207b  .special_from: {
-0001e6d0: 7479 7065 286f 7468 6572 297d 2e20 2229  type(other)}. ")
-0001e6e0: 290a 2020 2020 2020 2020 6966 2069 7369  ).        if isi
-0001e6f0: 6e73 7461 6e63 6528 6f74 6865 722c 2054  nstance(other, T
-0001e700: 656e 736f 7229 3a20 6f74 6865 7220 3d20  ensor): other = 
-0001e710: 6f74 6865 722e 7368 6170 650a 2020 2020  other.shape.    
-0001e720: 2020 2020 737a 5f66 756e 635f 6469 6d20      sz_func_dim 
-0001e730: 3d20 6765 7461 7474 7228 6f74 6865 722c  = getattr(other,
-0001e740: 2027 737a 5f66 756e 635f 6469 6d27 2c20   'sz_func_dim', 
-0001e750: 3029 0a20 2020 2020 2020 2069 6620 737a  0).        if sz
-0001e760: 5f66 756e 635f 6469 6d20 213d 2030 3a20  _func_dim != 0: 
-0001e770: 7365 6c66 2e73 7a5f 6675 6e63 5f64 696d  self.sz_func_dim
-0001e780: 203d 2073 7a5f 6675 6e63 5f64 696d 0a20   = sz_func_dim. 
-0001e790: 2020 2020 2020 2073 7a5f 6261 7463 685f         sz_batch_
-0001e7a0: 6469 6d20 3d20 6765 7461 7474 7228 6f74  dim = getattr(ot
-0001e7b0: 6865 722c 2027 737a 5f62 6174 6368 5f64  her, 'sz_batch_d
-0001e7c0: 696d 272c 2030 290a 2020 2020 2020 2020  im', 0).        
-0001e7d0: 6966 2073 7a5f 6261 7463 685f 6469 6d20  if sz_batch_dim 
-0001e7e0: 213d 2030 3a20 7365 6c66 2e73 7a5f 6261  != 0: self.sz_ba
-0001e7f0: 7463 685f 6469 6d20 3d20 737a 5f62 6174  tch_dim = sz_bat
-0001e800: 6368 5f64 696d 0a20 2020 2020 2020 2073  ch_dim.        s
-0001e810: 7a5f 6665 6174 7572 655f 6469 6d20 3d20  z_feature_dim = 
-0001e820: 6765 7461 7474 7228 6f74 6865 722c 2027  getattr(other, '
-0001e830: 737a 5f66 6561 7475 7265 5f64 696d 272c  sz_feature_dim',
-0001e840: 2030 290a 2020 2020 2020 2020 6966 2073   0).        if s
-0001e850: 7a5f 6665 6174 7572 655f 6469 6d20 213d  z_feature_dim !=
-0001e860: 2030 3a20 7365 6c66 2e73 7a5f 6665 6174   0: self.sz_feat
-0001e870: 7572 655f 6469 6d20 3d20 737a 5f66 6561  ure_dim = sz_fea
-0001e880: 7475 7265 5f64 696d 0a20 2020 2020 2020  ture_dim.       
-0001e890: 2073 7a5f 7365 7175 656e 6365 5f64 696d   sz_sequence_dim
-0001e8a0: 203d 2067 6574 6174 7472 286f 7468 6572   = getattr(other
-0001e8b0: 2c20 2773 7a5f 7365 7175 656e 6365 5f64  , 'sz_sequence_d
-0001e8c0: 696d 272c 2030 290a 2020 2020 2020 2020  im', 0).        
-0001e8d0: 6966 2073 7a5f 7365 7175 656e 6365 5f64  if sz_sequence_d
-0001e8e0: 696d 2021 3d20 303a 2073 656c 662e 737a  im != 0: self.sz
-0001e8f0: 5f73 6571 7565 6e63 655f 6469 6d20 3d20  _sequence_dim = 
-0001e900: 737a 5f73 6571 7565 6e63 655f 6469 6d0a  sz_sequence_dim.
-0001e910: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0001e920: 656c 660a 0a20 2020 2064 6566 2069 6e69  elf..    def ini
-0001e930: 745f 7370 6563 6961 6c28 7365 6c66 293a  t_special(self):
-0001e940: 0a20 2020 2020 2020 2073 656c 662e 737a  .        self.sz
-0001e950: 5f66 756e 635f 6469 6d20 3d20 300a 2020  _func_dim = 0.  
-0001e960: 2020 2020 2020 7365 6c66 2e73 7a5f 6261        self.sz_ba
-0001e970: 7463 685f 6469 6d20 3d20 300a 2020 2020  tch_dim = 0.    
-0001e980: 2020 2020 7365 6c66 2e73 7a5f 6665 6174      self.sz_feat
-0001e990: 7572 655f 6469 6d20 3d20 300a 2020 2020  ure_dim = 0.    
-0001e9a0: 2020 2020 7365 6c66 2e73 7a5f 7365 7175      self.sz_sequ
-0001e9b0: 656e 6365 5f64 696d 203d 2030 0a20 2020  ence_dim = 0.   
-0001e9c0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0001e9d0: 0a20 2020 200a 2020 2020 4061 6c69 6173  .    .    @alias
-0001e9e0: 2822 6973 5f73 7065 6369 616c 6469 6d22  ("is_specialdim"
-0001e9f0: 290a 2020 2020 6465 6620 6973 5f73 7065  ).    def is_spe
-0001ea00: 6369 616c 5f64 696d 2873 656c 662c 2069  cial_dim(self, i
-0001ea10: 293a 2072 6574 7572 6e20 7365 6c66 2e69  ): return self.i
-0001ea20: 735f 6675 6e63 5f64 696d 2869 2920 6f72  s_func_dim(i) or
-0001ea30: 2073 656c 662e 6973 5f62 6174 6368 5f64   self.is_batch_d
-0001ea40: 696d 2869 2920 6f72 2073 656c 662e 6973  im(i) or self.is
-0001ea50: 5f66 6561 7475 7265 5f64 696d 2869 2920  _feature_dim(i) 
-0001ea60: 6f72 2073 656c 662e 6973 5f73 6571 7565  or self.is_seque
-0001ea70: 6e63 655f 6469 6d28 6929 0a0a 2020 2020  nce_dim(i)..    
-0001ea80: 2323 2061 6c6c 2064 696d 656e 7369 6f6e  ## all dimension
-0001ea90: 733a 0a20 2020 2040 616c 6961 7328 226e  s:.    @alias("n
-0001eaa0: 656c 6522 290a 2020 2020 4070 726f 7065  ele").    @prope
-0001eab0: 7274 790a 2020 2020 6465 6620 6e5f 656c  rty.    def n_el
-0001eac0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-0001ead0: 2070 203d 2031 0a20 2020 2020 2020 2066   p = 1.        f
-0001eae0: 6f72 2069 2069 6e20 7261 6e67 655f 2873  or i in range_(s
-0001eaf0: 656c 662e 6e5f 6469 6d29 3a20 7020 2a3d  elf.n_dim): p *=
-0001eb00: 2073 656c 665b 695d 0a20 2020 2020 2020   self[i].       
-0001eb10: 2072 6574 7572 6e20 700a 0a20 2020 2040   return p..    @
-0001eb20: 616c 6961 7328 2277 6974 685f 6e65 6c65  alias("with_nele
-0001eb30: 2229 0a20 2020 2064 6566 2077 6974 685f  ").    def with_
-0001eb40: 6e5f 656c 6528 7365 6c66 2c20 6e5f 656c  n_ele(self, n_el
-0001eb50: 6529 3a0a 2020 2020 2020 2020 756e 6420  e):.        und 
-0001eb60: 3d20 5b69 2066 6f72 2069 2c20 7820 696e  = [i for i, x in
-0001eb70: 2065 6e75 6d65 7261 7465 2873 656c 6629   enumerate(self)
-0001eb80: 2069 6620 7820 3c20 305d 0a20 2020 2020   if x < 0].     
-0001eb90: 2020 2069 6620 6c65 6e28 756e 6429 203d     if len(und) =
-0001eba0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-0001ebb0: 2061 766f 7563 6828 6e5f 656c 6520 3d3d   avouch(n_ele ==
-0001ebc0: 2073 656c 662e 6e5f 656c 652c 2054 7970   self.n_ele, Typ
-0001ebd0: 6545 7272 6f72 2866 2243 616e 6e6f 7420  eError(f"Cannot 
-0001ebe0: 7365 7420 6e5f 656c 653d 7b6e 5f65 6c65  set n_ele={n_ele
-0001ebf0: 7d20 666f 7220 7369 7a65 207b 7365 6c66  } for size {self
-0001ec00: 7d20 7769 7468 6f75 7420 756e 6465 7465  } without undete
-0001ec10: 726d 696e 6564 2064 696d 656e 7369 6f6e  rmined dimension
-0001ec20: 732e 2229 290a 2020 2020 2020 2020 2020  s.")).          
-0001ec30: 2020 7265 7475 726e 2073 656c 660a 2020    return self.  
-0001ec40: 2020 2020 2020 6176 6f75 6368 286c 656e        avouch(len
-0001ec50: 2875 6e64 2920 3d3d 2031 2c20 5479 7065  (und) == 1, Type
-0001ec60: 4572 726f 7228 6622 4361 6e6e 6f74 2073  Error(f"Cannot s
-0001ec70: 6574 206e 5f65 6c65 2066 6f72 2073 697a  et n_ele for siz
-0001ec80: 6520 7b73 656c 667d 2077 6974 6820 6d6f  e {self} with mo
-0001ec90: 7265 2074 6861 6e20 6f6e 6520 756e 6465  re than one unde
-0001eca0: 7465 726d 696e 6564 2064 696d 656e 7369  termined dimensi
-0001ecb0: 6f6e 732e 2229 290a 2020 2020 2020 2020  ons.")).        
-0001ecc0: 735f 656c 6520 3d20 2d20 7365 6c66 2e6e  s_ele = - self.n
-0001ecd0: 5f65 6c65 0a20 2020 2020 2020 2061 766f  _ele.        avo
-0001ece0: 7563 6828 6e5f 656c 6520 2520 735f 656c  uch(n_ele % s_el
-0001ecf0: 6520 3d3d 2030 2c20 5479 7065 4572 726f  e == 0, TypeErro
-0001ed00: 7228 6622 4361 6e6e 6f74 2073 6574 206e  r(f"Cannot set n
-0001ed10: 5f65 6c65 3d7b 6e5f 656c 657d 2066 6f72  _ele={n_ele} for
-0001ed20: 2073 697a 6520 7b73 656c 667d 2061 7320   size {self} as 
-0001ed30: 6974 2069 7320 6e6f 7420 6120 6d75 6c74  it is not a mult
-0001ed40: 6970 6c69 6361 7469 6f6e 206f 6620 6375  iplication of cu
-0001ed50: 7272 656e 7420 7369 7a65 207b 735f 656c  rrent size {s_el
-0001ed60: 657d 2e20 2229 290a 2020 2020 2020 2020  e}. ")).        
-0001ed70: 7265 7475 726e 2073 656c 665b 3a75 6e64  return self[:und
-0001ed80: 5b30 5d5d 202b 2053 697a 6528 6e5f 656c  [0]] + Size(n_el
-0001ed90: 6520 2f2f 2073 656c 662e 6e5f 656c 6529  e // self.n_ele)
-0001eda0: 2e73 7065 6369 616c 5f66 726f 6d28 7365  .special_from(se
-0001edb0: 6c66 5b75 6e64 5b30 5d3a 756e 645b 305d  lf[und[0]:und[0]
-0001edc0: 2b31 5d29 202b 2073 656c 665b 756e 645b  +1]) + self[und[
-0001edd0: 305d 2b31 3a5d 0a20 2020 200a 2020 2020  0]+1:].    .    
-0001ede0: 6465 6620 7769 7468 5f64 696d 5f73 697a  def with_dim_siz
-0001edf0: 6528 7365 6c66 2c20 696e 6465 782c 2073  e(self, index, s
-0001ee00: 697a 6529 3a0a 2020 2020 2020 2020 6966  ize):.        if
-0001ee10: 2069 6e64 6578 203c 2030 3a20 696e 6465   index < 0: inde
-0001ee20: 7820 2b3d 2073 656c 662e 6e5f 6469 6d0a  x += self.n_dim.
-0001ee30: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0001ee40: 656c 665b 3a69 6e64 6578 5d20 2b20 5369  elf[:index] + Si
-0001ee50: 7a65 2873 697a 6529 2e73 7065 6369 616c  ze(size).special
-0001ee60: 5f66 726f 6d28 7365 6c66 5b69 6e64 6578  _from(self[index
-0001ee70: 3a69 6e64 6578 2b31 5d29 202b 2073 656c  :index+1]) + sel
-0001ee80: 665b 696e 6465 782b 313a 5d0a 2020 2020  f[index+1:].    
-0001ee90: 0a20 2020 2064 6566 2074 7261 6e73 706f  .    def transpo
-0001eea0: 7365 2873 656c 662c 2069 3a20 696e 745f  se(self, i: int_
-0001eeb0: 2c20 6a3a 696e 745f 293a 0a20 2020 2020  , j:int_):.     
-0001eec0: 2020 2069 6620 6920 3d3d 206a 3a20 7265     if i == j: re
-0001eed0: 7475 726e 2073 656c 660a 2020 2020 2020  turn self.      
-0001eee0: 2020 6966 2069 203e 206a 3a20 692c 206a    if i > j: i, j
-0001eef0: 203d 206a 2c20 690a 2020 2020 2020 2020   = j, i.        
-0001ef00: 6966 2073 656c 662e 6973 5f66 756e 635f  if self.is_func_
-0001ef10: 6469 6d28 6929 3a0a 2020 2020 2020 2020  dim(i):.        
-0001ef20: 2020 2020 6176 6f75 6368 284e 6f6e 652c      avouch(None,
-0001ef30: 2049 6e64 6578 4572 726f 7228 2246 6169   IndexError("Fai
-0001ef40: 6c75 7265 2069 6e20 2762 742e 5369 7a65  lure in 'bt.Size
-0001ef50: 2e74 7261 6e73 706f 7365 273a 2043 616e  .transpose': Can
-0001ef60: 6e6f 7420 6d6f 7665 2074 6865 2066 756e  not move the fun
-0001ef70: 6374 696f 6e61 6c20 6469 6d65 6e73 696f  ctional dimensio
-0001ef80: 6e2e 2022 2929 0a20 2020 2020 2020 2069  n. ")).        i
-0001ef90: 6620 7365 6c66 2e69 735f 6261 7463 685f  f self.is_batch_
-0001efa0: 6469 6d28 6929 3a0a 2020 2020 2020 2020  dim(i):.        
-0001efb0: 2020 2020 6176 6f75 6368 284e 6f6e 652c      avouch(None,
-0001efc0: 2049 6e64 6578 4572 726f 7228 2246 6169   IndexError("Fai
-0001efd0: 6c75 7265 2069 6e20 2762 742e 5369 7a65  lure in 'bt.Size
-0001efe0: 2e74 7261 6e73 706f 7365 273a 2043 616e  .transpose': Can
-0001eff0: 6e6f 7420 6d6f 7665 2074 6865 2062 6174  not move the bat
-0001f000: 6368 2064 696d 656e 7369 6f6e 2e20 2229  ch dimension. ")
-0001f010: 290a 2020 2020 2020 2020 656c 6966 2073  ).        elif s
-0001f020: 656c 662e 6973 5f66 6561 7475 7265 5f64  elf.is_feature_d
-0001f030: 696d 2869 293a 0a20 2020 2020 2020 2020  im(i):.         
-0001f040: 2020 2061 766f 7563 6828 7365 6c66 2e69     avouch(self.i
-0001f050: 735f 6665 6174 7572 655f 6469 6d28 6a29  s_feature_dim(j)
-0001f060: 2c20 496e 6465 7845 7272 6f72 2866 2246  , IndexError(f"F
-0001f070: 6169 6c75 7265 2069 6e20 2762 742e 5369  ailure in 'bt.Si
-0001f080: 7a65 2e74 7261 6e73 706f 7365 273a 2043  ze.transpose': C
-0001f090: 616e 6e6f 7420 6d6f 7665 2066 6561 7475  annot move featu
-0001f0a0: 7265 2064 696d 656e 7369 6f6e 207b 697d  re dimension {i}
-0001f0b0: 206f 7574 206f 6620 7468 6520 6665 6174   out of the feat
-0001f0c0: 7572 6520 7363 6f70 652e 2022 2929 0a20  ure scope. ")). 
-0001f0d0: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
-0001f0e0: 2e69 735f 7370 6163 655f 6469 6d28 6929  .is_space_dim(i)
-0001f0f0: 3a0a 2020 2020 2020 2020 2020 2020 6176  :.            av
-0001f100: 6f75 6368 2873 656c 662e 6973 5f73 7061  ouch(self.is_spa
-0001f110: 6365 5f64 696d 286a 292c 2049 6e64 6578  ce_dim(j), Index
-0001f120: 4572 726f 7228 6622 4661 696c 7572 6520  Error(f"Failure 
-0001f130: 696e 2027 6274 2e53 697a 652e 7472 616e  in 'bt.Size.tran
-0001f140: 7370 6f73 6527 3a20 4361 6e6e 6f74 206d  spose': Cannot m
-0001f150: 6f76 6520 7370 6163 6520 6469 6d65 6e73  ove space dimens
-0001f160: 696f 6e20 7b69 7d20 6f75 7420 6f66 2074  ion {i} out of t
-0001f170: 6865 2073 7061 6365 2073 636f 7065 2e20  he space scope. 
-0001f180: 2229 290a 2020 2020 2020 2020 7265 7475  ")).        retu
-0001f190: 726e 2073 656c 665b 3a69 5d20 2b20 7365  rn self[:i] + se
-0001f1a0: 6c66 5b6a 3a6a 2b31 5d20 2b20 7365 6c66  lf[j:j+1] + self
-0001f1b0: 5b69 2b31 3a6a 5d20 2b20 7365 6c66 5b69  [i+1:j] + self[i
-0001f1c0: 3a69 2b31 5d20 2b20 7365 6c66 5b6a 2b31  :i+1] + self[j+1
-0001f1d0: 3a5d 0a0a 2020 2020 2323 206d 6574 686f  :]..    ## metho
-0001f1e0: 6473 3a0a 2020 2020 4061 6c69 6173 2822  ds:.    @alias("
-0001f1f0: 636c 6f6e 6522 290a 2020 2020 6465 6620  clone").    def 
-0001f200: 636f 7079 2873 656c 6629 3a20 7265 7475  copy(self): retu
-0001f210: 726e 2053 697a 6528 7365 6c66 290a 0a20  rn Size(self).. 
-0001f220: 2020 2040 616c 6961 7328 2272 6177 2229     @alias("raw")
-0001f230: 0a20 2020 2064 6566 2074 7570 6c65 2873  .    def tuple(s
-0001f240: 656c 6629 3a20 7265 7475 726e 2074 7570  elf): return tup
-0001f250: 6c65 2873 656c 6629 0a20 2020 200a 2020  le(self).    .  
-0001f260: 2020 6465 6620 7065 726d 7574 6528 7365    def permute(se
-0001f270: 6c66 2c20 2a64 696d 7329 3a0a 2020 2020  lf, *dims):.    
-0001f280: 2020 2020 6966 206c 656e 2864 696d 7329      if len(dims)
-0001f290: 203d 3d20 3120 616e 6420 6973 696e 7374   == 1 and isinst
-0001f2a0: 616e 6365 2864 696d 735b 305d 2c20 7475  ance(dims[0], tu
-0001f2b0: 706c 6529 3a20 6469 6d73 203d 2064 696d  ple): dims = dim
-0001f2c0: 735b 305d 0a20 2020 2020 2020 2061 766f  s[0].        avo
-0001f2d0: 7563 6828 736f 7274 6564 2864 696d 7329  uch(sorted(dims)
-0001f2e0: 203d 3d20 6c69 7374 2872 616e 6765 5f28   == list(range_(
-0001f2f0: 6c65 6e28 7365 6c66 2929 292c 2054 7970  len(self))), Typ
-0001f300: 6545 7272 6f72 2822 2770 6572 6d75 7465  eError("'permute
-0001f310: 2720 6e65 6564 7320 696e 7075 7420 6469  ' needs input di
-0001f320: 6d65 6e73 696f 6e73 2066 6f72 6d69 6e67  mensions forming
-0001f330: 2061 2070 6572 6d75 7461 7469 6f6e 206f   a permutation o
-0001f340: 6620 302d 286e 2d31 292e 2022 2929 0a20  f 0-(n-1). ")). 
-0001f350: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
-0001f360: 6d5f 285b 7365 6c66 5b64 3a64 2b31 5d20  m_([self[d:d+1] 
-0001f370: 666f 7220 6420 696e 2064 696d 735d 2c20  for d in dims], 
-0001f380: 5369 7a65 2829 2920 2020 200a 0a20 2020  Size())    ..   
-0001f390: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-0001f3a0: 6566 2070 7974 686f 6e5f 7265 7072 2873  ef python_repr(s
-0001f3b0: 656c 6629 3a0a 2020 2020 2020 2020 6966  elf):.        if
-0001f3c0: 2073 656c 662e 6861 735f 7370 6163 653a   self.has_space:
-0001f3d0: 206f 7574 7075 7420 3d20 7475 706c 6528   output = tuple(
-0001f3e0: 7365 6c66 2e73 7061 6365 290a 2020 2020  self.space).    
-0001f3f0: 2020 2020 656c 7365 3a20 6f75 7470 7574      else: output
-0001f400: 203d 2074 7570 6c65 2829 0a20 2020 2020   = tuple().     
-0001f410: 2020 2069 6620 7365 6c66 2e68 6173 5f73     if self.has_s
-0001f420: 6571 7565 6e63 653a 0a20 2020 2020 2020  equence:.       
-0001f430: 2020 2020 2073 6571 7565 6e63 6520 3d20       sequence = 
-0001f440: 7374 7228 6c69 7374 2873 656c 665b 7365  str(list(self[se
-0001f450: 6c66 2e73 6571 7565 6e63 655f 7374 6172  lf.sequence_star
-0001f460: 743a 7365 6c66 2e73 6571 7565 6e63 655f  t:self.sequence_
-0001f470: 7374 6f70 5d29 292e 7374 7269 7028 275b  stop])).strip('[
-0001f480: 5d27 290a 2020 2020 2020 2020 2020 2020  ]').            
-0001f490: 6966 2073 656c 662e 737a 5f73 6571 7565  if self.sz_seque
-0001f4a0: 6e63 655f 6469 6d20 3e20 303a 206f 7574  nce_dim > 0: out
-0001f4b0: 7075 7420 3d20 2873 6571 7565 6e63 652c  put = (sequence,
-0001f4c0: 2920 2b20 6f75 7470 7574 0a20 2020 2020  ) + output.     
-0001f4d0: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
-0001f4e0: 7a5f 7365 7175 656e 6365 5f64 696d 203c  z_sequence_dim <
-0001f4f0: 2030 3a20 6f75 7470 7574 203d 206f 7574   0: output = out
-0001f500: 7075 7420 2b20 2873 6571 7565 6e63 652c  put + (sequence,
-0001f510: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
-0001f520: 662e 6861 735f 6665 6174 7572 653a 0a20  f.has_feature:. 
-0001f530: 2020 2020 2020 2020 2020 2066 6561 7475             featu
-0001f540: 7265 203d 206c 6973 7428 7365 6c66 5b73  re = list(self[s
-0001f550: 656c 662e 6665 6174 7572 655f 7374 6172  elf.feature_star
-0001f560: 743a 2073 656c 662e 6665 6174 7572 655f  t: self.feature_
-0001f570: 7374 6f70 5d29 0a20 2020 2020 2020 2020  stop]).         
-0001f580: 2020 2069 6620 7365 6c66 2e73 7a5f 6665     if self.sz_fe
-0001f590: 6174 7572 655f 6469 6d20 3e20 303a 206f  ature_dim > 0: o
-0001f5a0: 7574 7075 7420 3d20 2866 6561 7475 7265  utput = (feature
-0001f5b0: 2c29 202b 206f 7574 7075 740a 2020 2020  ,) + output.    
-0001f5c0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0001f5d0: 737a 5f66 6561 7475 7265 5f64 696d 203c  sz_feature_dim <
-0001f5e0: 2030 3a20 6f75 7470 7574 203d 206f 7574   0: output = out
-0001f5f0: 7075 7420 2b20 2866 6561 7475 7265 2c29  put + (feature,)
-0001f600: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001f610: 2e68 6173 5f62 6174 6368 3a0a 2020 2020  .has_batch:.    
-0001f620: 2020 2020 2020 2020 6261 7463 6820 3d20          batch = 
-0001f630: 7b73 656c 662e 6e5f 6261 7463 687d 0a20  {self.n_batch}. 
-0001f640: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-0001f650: 6c66 2e73 7a5f 6261 7463 685f 6469 6d20  lf.sz_batch_dim 
-0001f660: 3e20 303a 206f 7574 7075 7420 3d20 2862  > 0: output = (b
-0001f670: 6174 6368 2c29 202b 206f 7574 7075 740a  atch,) + output.
-0001f680: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0001f690: 656c 662e 737a 5f62 6174 6368 5f64 696d  elf.sz_batch_dim
-0001f6a0: 203c 2030 3a20 6f75 7470 7574 203d 206f   < 0: output = o
-0001f6b0: 7574 7075 7420 2b20 2862 6174 6368 2c29  utput + (batch,)
-0001f6c0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001f6d0: 2e68 6173 5f66 756e 633a 0a20 2020 2020  .has_func:.     
-0001f6e0: 2020 2020 2020 2066 756e 6320 3d20 2873         func = (s
-0001f6f0: 656c 662e 6e5f 6675 6e63 2c29 0a20 2020  elf.n_func,).   
-0001f700: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-0001f710: 2e73 7a5f 6675 6e63 5f64 696d 203e 2030  .sz_func_dim > 0
-0001f720: 3a20 6f75 7470 7574 203d 2028 6675 6e63  : output = (func
-0001f730: 2c29 202b 206f 7574 7075 740a 2020 2020  ,) + output.    
-0001f740: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0001f750: 737a 5f66 756e 635f 6469 6d20 3c20 303a  sz_func_dim < 0:
-0001f760: 206f 7574 7075 7420 3d20 6f75 7470 7574   output = output
-0001f770: 202b 2028 6675 6e63 2c29 0a20 2020 2020   + (func,).     
-0001f780: 2020 2072 6574 7572 6e20 6f75 7470 7574     return output
-0001f790: 0a0a 2020 2020 4061 6c69 6173 2822 5f5f  ..    @alias("__
-0001f7a0: 7265 7072 5f5f 2229 0a20 2020 2064 6566  repr__").    def
-0001f7b0: 205f 5f73 7472 5f5f 2873 656c 6629 3a0a   __str__(self):.
-0001f7c0: 2020 2020 2020 2020 7265 7020 3d20 7365          rep = se
-0001f7d0: 6c66 2e70 7974 686f 6e5f 7265 7072 0a20  lf.python_repr. 
-0001f7e0: 2020 2020 2020 2072 6574 7572 6e20 6622         return f"
-0001f7f0: 6261 746f 7263 682e 5369 7a65 7b72 6570  batorch.Size{rep
-0001f800: 7d22 2e72 6570 6c61 6365 2827 2c29 272c  }".replace(',)',
-0001f810: 2027 2927 292e 7265 706c 6163 6528 2745   ')').replace('E
-0001f820: 6c6c 6970 7369 7327 2c20 272e 2e2e 2729  llipsis', '...')
-0001f830: 0a20 2020 200a 2020 2020 2323 206f 7065  .    .    ## ope
-0001f840: 7261 7469 6f6e 733a 0a20 2020 2064 6566  rations:.    def
-0001f850: 205f 5f67 6574 6974 656d 5f5f 2873 656c   __getitem__(sel
-0001f860: 662c 206b 293a 0a20 2020 2020 2020 2069  f, k):.        i
-0001f870: 6620 6973 696e 7374 616e 6365 286b 2c20  f isinstance(k, 
-0001f880: 696e 745f 293a 2072 6574 7572 6e20 7375  int_): return su
-0001f890: 7065 7228 292e 5f5f 6765 7469 7465 6d5f  per().__getitem_
-0001f8a0: 5f28 6b29 0a20 2020 2020 2020 2061 766f  _(k).        avo
-0001f8b0: 7563 6828 6973 696e 7374 616e 6365 286b  uch(isinstance(k
-0001f8c0: 2c20 736c 6963 6529 2c20 5479 7065 4572  , slice), TypeEr
-0001f8d0: 726f 7228 6622 536c 6963 696e 6720 6f66  ror(f"Slicing of
-0001f8e0: 2027 6274 2e53 697a 6527 206f 6e6c 7920   'bt.Size' only 
-0001f8f0: 7461 6b65 7320 696e 7465 6765 7273 206f  takes integers o
-0001f900: 7220 736c 6963 6573 2c20 6e6f 7420 7b6b  r slices, not {k
-0001f910: 7d20 6f66 2074 7970 6520 7b74 7970 6528  } of type {type(
-0001f920: 6b29 7d2e 2022 2929 0a20 2020 2020 2020  k)}. ")).       
-0001f930: 2073 2c20 6520 3d20 6b2e 7374 6172 742c   s, e = k.start,
-0001f940: 206b 2e73 746f 700a 2020 2020 2020 2020   k.stop.        
-0001f950: 6966 2073 2069 7320 4e6f 6e65 3a20 7320  if s is None: s 
-0001f960: 3d20 300a 2020 2020 2020 2020 6966 2065  = 0.        if e
-0001f970: 2069 7320 4e6f 6e65 3a20 6520 3d20 7365   is None: e = se
-0001f980: 6c66 2e6e 5f64 696d 0a20 2020 2020 2020  lf.n_dim.       
-0001f990: 2069 6620 7320 3c20 303a 2073 202b 3d20   if s < 0: s += 
-0001f9a0: 7365 6c66 2e6e 5f64 696d 0a20 2020 2020  self.n_dim.     
-0001f9b0: 2020 2069 6620 6520 3c20 303a 2065 202b     if e < 0: e +
-0001f9c0: 3d20 7365 6c66 2e6e 5f64 696d 0a20 2020  = self.n_dim.   
-0001f9d0: 2020 2020 2069 6620 7365 6c66 2e68 6173       if self.has
-0001f9e0: 5f66 756e 633a 0a20 2020 2020 2020 2020  _func:.         
-0001f9f0: 2020 2073 7a5f 6675 6e63 5f64 696d 203d     sz_func_dim =
-0001fa00: 2073 656c 662e 737a 5f66 756e 635f 6469   self.sz_func_di
-0001fa10: 6d20 6966 2073 203c 3d20 7365 6c66 2e66  m if s <= self.f
-0001fa20: 756e 635f 6469 6d20 616e 6420 6520 3e20  unc_dim and e > 
-0001fa30: 7365 6c66 2e66 756e 635f 6469 6d20 656c  self.func_dim el
-0001fa40: 7365 2028 6d61 785f 286d 696e 5f28 652c  se (max_(min_(e,
-0001fa50: 2073 656c 662e 6675 6e63 5f64 696d 202b   self.func_dim +
-0001fa60: 2031 2920 2d20 732c 2030 2920 6966 2073   1) - s, 0) if s
-0001fa70: 203e 2073 656c 662e 6675 6e63 5f64 696d   > self.func_dim
-0001fa80: 2065 6c73 6520 6d69 6e5f 286d 6178 5f28   else min_(max_(
-0001fa90: 732c 2073 656c 662e 6675 6e63 5f64 696d  s, self.func_dim
-0001faa0: 2920 2d20 652c 2030 2929 0a20 2020 2020  ) - e, 0)).     
-0001fab0: 2020 2065 6c73 653a 2073 7a5f 6675 6e63     else: sz_func
-0001fac0: 5f64 696d 203d 2030 0a20 2020 2020 2020  _dim = 0.       
-0001fad0: 2069 6620 7365 6c66 2e68 6173 5f62 6174   if self.has_bat
-0001fae0: 6368 3a0a 2020 2020 2020 2020 2020 2020  ch:.            
-0001faf0: 737a 5f62 6174 6368 5f64 696d 203d 2073  sz_batch_dim = s
-0001fb00: 656c 662e 737a 5f62 6174 6368 5f64 696d  elf.sz_batch_dim
-0001fb10: 2069 6620 7320 3c3d 2073 656c 662e 6261   if s <= self.ba
-0001fb20: 7463 685f 6469 6d20 616e 6420 6520 3e20  tch_dim and e > 
-0001fb30: 7365 6c66 2e62 6174 6368 5f64 696d 2065  self.batch_dim e
-0001fb40: 6c73 6520 286d 6178 5f28 6d69 6e5f 2865  lse (max_(min_(e
-0001fb50: 2c20 7365 6c66 2e62 6174 6368 5f64 696d  , self.batch_dim
-0001fb60: 202b 2031 2920 2d20 732c 2030 2920 6966   + 1) - s, 0) if
-0001fb70: 2073 203e 2073 656c 662e 6261 7463 685f   s > self.batch_
-0001fb80: 6469 6d20 656c 7365 206d 696e 5f28 6d61  dim else min_(ma
-0001fb90: 785f 2873 2c20 7365 6c66 2e62 6174 6368  x_(s, self.batch
-0001fba0: 5f64 696d 2920 2d20 652c 2030 2929 0a20  _dim) - e, 0)). 
-0001fbb0: 2020 2020 2020 2020 2020 2023 2073 7a5f             # sz_
-0001fbc0: 6261 7463 685f 6469 6d20 3d20 7365 6c66  batch_dim = self
-0001fbd0: 2e6e 6f6e 5f62 6174 5f73 7461 7274 202d  .non_bat_start -
-0001fbe0: 2073 2069 6620 7320 3c20 7365 6c66 2e6e   s if s < self.n
-0001fbf0: 6f6e 5f62 6174 5f73 7461 7274 2065 6c73  on_bat_start els
-0001fc00: 6520 2873 656c 662e 6e6f 6e5f 6261 745f  e (self.non_bat_
-0001fc10: 7374 6f70 202d 2065 2069 6620 7365 6c66  stop - e if self
-0001fc20: 2e6e 6f6e 5f62 6174 5f73 746f 7020 3c20  .non_bat_stop < 
-0001fc30: 6520 656c 7365 2030 290a 2020 2020 2020  e else 0).      
-0001fc40: 2020 656c 7365 3a20 737a 5f62 6174 6368    else: sz_batch
-0001fc50: 5f64 696d 203d 2030 0a20 2020 2020 2020  _dim = 0.       
-0001fc60: 2069 6620 7365 6c66 2e68 6173 5f66 6561   if self.has_fea
-0001fc70: 7475 7265 3a0a 2020 2020 2020 2020 2020  ture:.          
-0001fc80: 2020 737a 5f66 6561 7475 7265 5f64 696d    sz_feature_dim
-0001fc90: 203d 2073 656c 662e 737a 5f66 6561 7475   = self.sz_featu
-0001fca0: 7265 5f64 696d 2069 6620 7320 3c3d 2073  re_dim if s <= s
-0001fcb0: 656c 662e 6665 6174 7572 655f 7374 6172  elf.feature_star
-0001fcc0: 7420 616e 6420 6520 3e3d 2073 656c 662e  t and e >= self.
-0001fcd0: 6665 6174 7572 655f 7374 6f70 2065 6c73  feature_stop els
-0001fce0: 6520 286d 6178 5f28 6d69 6e5f 2865 2c20  e (max_(min_(e, 
-0001fcf0: 7365 6c66 2e66 6561 7475 7265 5f73 746f  self.feature_sto
-0001fd00: 7029 202d 2073 2c20 3029 2069 6620 7320  p) - s, 0) if s 
-0001fd10: 3e20 7365 6c66 2e66 6561 7475 7265 5f73  > self.feature_s
-0001fd20: 7461 7274 2065 6c73 6520 6d69 6e5f 286d  tart else min_(m
-0001fd30: 6178 5f28 732c 2073 656c 662e 6665 6174  ax_(s, self.feat
-0001fd40: 7572 655f 7374 6172 7429 202d 2065 2c20  ure_start) - e, 
-0001fd50: 3029 290a 2020 2020 2020 2020 656c 7365  0)).        else
-0001fd60: 3a20 737a 5f66 6561 7475 7265 5f64 696d  : sz_feature_dim
-0001fd70: 203d 2030 0a20 2020 2020 2020 2069 6620   = 0.        if 
-0001fd80: 7365 6c66 2e68 6173 5f73 6571 7565 6e63  self.has_sequenc
-0001fd90: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-0001fda0: 7a5f 7365 7175 656e 6365 5f64 696d 203d  z_sequence_dim =
-0001fdb0: 2073 656c 662e 737a 5f73 6571 7565 6e63   self.sz_sequenc
-0001fdc0: 655f 6469 6d20 6966 2073 203c 3d20 7365  e_dim if s <= se
-0001fdd0: 6c66 2e73 6571 7565 6e63 655f 7374 6172  lf.sequence_star
-0001fde0: 7420 616e 6420 6520 3e3d 2073 656c 662e  t and e >= self.
-0001fdf0: 7365 7175 656e 6365 5f73 746f 7020 656c  sequence_stop el
-0001fe00: 7365 2028 6d61 785f 286d 696e 5f28 652c  se (max_(min_(e,
-0001fe10: 2073 656c 662e 7365 7175 656e 6365 5f73   self.sequence_s
-0001fe20: 746f 7029 202d 2073 2c20 3029 2069 6620  top) - s, 0) if 
-0001fe30: 7320 3e20 7365 6c66 2e73 6571 7565 6e63  s > self.sequenc
-0001fe40: 655f 7374 6172 7420 656c 7365 206d 696e  e_start else min
-0001fe50: 5f28 6d61 785f 2873 2c20 7365 6c66 2e73  _(max_(s, self.s
-0001fe60: 6571 7565 6e63 655f 7374 6172 7429 202d  equence_start) -
-0001fe70: 2065 2c20 3029 290a 2020 2020 2020 2020   e, 0)).        
-0001fe80: 656c 7365 3a20 737a 5f73 6571 7565 6e63  else: sz_sequenc
-0001fe90: 655f 6469 6d20 3d20 300a 2020 2020 2020  e_dim = 0.      
-0001fea0: 2020 7265 7475 726e 2073 656c 662e 5f5f    return self.__
-0001feb0: 636c 6173 735f 5f2e 5f5f 6e65 775f 7261  class__.__new_ra
-0001fec0: 775f 5f28 7375 7065 7228 292e 5f5f 6765  w__(super().__ge
-0001fed0: 7469 7465 6d5f 5f28 6b29 2c20 737a 5f66  titem__(k), sz_f
-0001fee0: 756e 635f 6469 6d3d 737a 5f66 756e 635f  unc_dim=sz_func_
-0001fef0: 6469 6d2c 2073 7a5f 6261 7463 685f 6469  dim, sz_batch_di
-0001ff00: 6d3d 737a 5f62 6174 6368 5f64 696d 2c20  m=sz_batch_dim, 
-0001ff10: 737a 5f66 6561 7475 7265 5f64 696d 3d73  sz_feature_dim=s
-0001ff20: 7a5f 6665 6174 7572 655f 6469 6d2c 2073  z_feature_dim, s
-0001ff30: 7a5f 7365 7175 656e 6365 5f64 696d 3d73  z_sequence_dim=s
-0001ff40: 7a5f 7365 7175 656e 6365 5f64 696d 290a  z_sequence_dim).
-0001ff50: 2020 2020 0a20 2020 2040 616c 6961 7328      .    @alias(
-0001ff60: 275f 5f69 6164 645f 5f27 290a 2020 2020  '__iadd__').    
-0001ff70: 6465 6620 5f5f 6164 645f 5f28 7365 6c66  def __add__(self
-0001ff80: 2c20 6f74 6865 7229 3a0a 2020 2020 2020  , other):.      
-0001ff90: 2020 6176 6f75 6368 2869 7369 6e73 7461    avouch(isinsta
-0001ffa0: 6e63 6528 6f74 6865 722c 2074 7570 6c65  nce(other, tuple
-0001ffb0: 292c 2054 7970 6545 7272 6f72 2822 5375  ), TypeError("Su
-0001ffc0: 6d6d 6174 696f 6e20 666f 7220 2762 742e  mmation for 'bt.
-0001ffd0: 5369 7a65 2720 6973 2069 6e68 6572 6974  Size' is inherit
-0001ffe0: 6564 2066 726f 6d20 7079 7468 6f6e 206f  ed from python o
-0001fff0: 626a 6563 7420 2774 7570 6c65 2720 746f  bject 'tuple' to
-00020000: 2070 6572 666f 726d 2063 6f6e 6361 7465   perform concate
-00020010: 6e61 7469 6f6e 2c20 706c 6561 7365 2075  nation, please u
-00020020: 7365 2060 7369 7a65 203c 3c28 3e3e 2920  se `size <<(>>) 
-00020030: 3260 2074 6f20 7065 7266 6f72 6d20 656c  2` to perform el
-00020040: 656d 656e 742d 7769 7365 2073 756d 6d61  ement-wise summa
-00020050: 7469 6f6e 2028 7375 6274 7261 6374 696f  tion (subtractio
-00020060: 6e29 2074 6f20 696e 6372 6561 7365 2028  n) to increase (
-00020070: 6465 6372 6561 7365 2920 7468 6520 7369  decrease) the si
-00020080: 7a65 2e20 2229 290a 2020 2020 2020 2020  ze. ")).        
-00020090: 6966 206c 656e 286f 7468 6572 2920 3d3d  if len(other) ==
-000200a0: 2030 3a20 7265 7475 726e 2073 656c 660a   0: return self.
-000200b0: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
-000200c0: 656c 6629 203d 3d20 303a 2072 6574 7572  elf) == 0: retur
-000200d0: 6e20 6f74 6865 720a 2020 2020 2020 2020  n other.        
-000200e0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-000200f0: 6528 6f74 6865 722c 2053 697a 6529 3a20  e(other, Size): 
-00020100: 6f74 6865 7220 3d20 7365 6c66 2e5f 5f63  other = self.__c
-00020110: 6c61 7373 5f5f 2e5f 5f6e 6577 5f72 6177  lass__.__new_raw
-00020120: 5f5f 286f 7468 6572 290a 2020 2020 2020  __(other).      
-00020130: 2020 2320 4465 616c 2077 6974 6820 7468    # Deal with th
-00020140: 6520 6675 6e63 2064 696d 656e 7369 6f6e  e func dimension
-00020150: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00020160: 2e73 7a5f 6675 6e63 5f64 696d 203d 3d20  .sz_func_dim == 
-00020170: 303a 0a20 2020 2020 2020 2020 2020 2069  0:.            i
-00020180: 6620 6f74 6865 722e 737a 5f66 756e 635f  f other.sz_func_
-00020190: 6469 6d20 3c3d 2030 206f 7220 6f74 6865  dim <= 0 or othe
-000201a0: 722e 6e5f 6675 6e63 5f64 696d 203d 3d20  r.n_func_dim == 
-000201b0: 6f74 6865 722e 6e5f 6469 6d3a 2073 7a5f  other.n_dim: sz_
-000201c0: 6675 6e63 5f64 696d 203d 202d 6f74 6865  func_dim = -othe
-000201d0: 722e 6e5f 6675 6e63 5f64 696d 0a20 2020  r.n_func_dim.   
-000201e0: 2020 2020 2020 2020 2065 6c69 6620 7365           elif se
-000201f0: 6c66 2e6e 5f64 696d 203d 3d20 303a 2073  lf.n_dim == 0: s
-00020200: 7a5f 6675 6e63 5f64 696d 203d 206f 7468  z_func_dim = oth
-00020210: 6572 2e6e 5f66 756e 635f 6469 6d0a 2020  er.n_func_dim.  
-00020220: 2020 2020 2020 2020 2020 656c 7365 3a20            else: 
-00020230: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
-00020240: 6622 4572 726f 7220 696e 2063 6f6e 6361  f"Error in conca
-00020250: 7465 6e61 7469 6e67 207b 7365 6c66 7d20  tenating {self} 
-00020260: 616e 6420 7b6f 7468 6572 7d3a 2066 756e  and {other}: fun
-00020270: 6374 696f 6e61 6c20 6469 6d65 6e73 696f  ctional dimensio
-00020280: 6e20 696e 206d 6964 646c 652e 2022 290a  n in middle. ").
-00020290: 2020 2020 2020 2020 656c 6966 206f 7468          elif oth
-000202a0: 6572 2e73 7a5f 6675 6e63 5f64 696d 203d  er.sz_func_dim =
-000202b0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-000202c0: 2069 6620 7365 6c66 2e73 7a5f 6675 6e63   if self.sz_func
-000202d0: 5f64 696d 203e 3d20 3020 6f72 2073 656c  _dim >= 0 or sel
-000202e0: 662e 6e5f 6675 6e63 5f64 696d 203d 3d20  f.n_func_dim == 
-000202f0: 7365 6c66 2e6e 5f64 696d 3a20 737a 5f66  self.n_dim: sz_f
-00020300: 756e 635f 6469 6d20 3d20 7365 6c66 2e6e  unc_dim = self.n
-00020310: 5f66 756e 635f 6469 6d0a 2020 2020 2020  _func_dim.      
-00020320: 2020 2020 2020 656c 6966 206f 7468 6572        elif other
-00020330: 2e6e 5f64 696d 203d 3d20 303a 2073 7a5f  .n_dim == 0: sz_
-00020340: 6675 6e63 5f64 696d 203d 2073 656c 662e  func_dim = self.
-00020350: 737a 5f66 756e 635f 6469 6d0a 2020 2020  sz_func_dim.    
-00020360: 2020 2020 2020 2020 656c 7365 3a20 7261          else: ra
-00020370: 6973 6520 5479 7065 4572 726f 7228 6622  ise TypeError(f"
-00020380: 4572 726f 7220 696e 2063 6f6e 6361 7465  Error in concate
-00020390: 6e61 7469 6e67 207b 7365 6c66 7d20 616e  nating {self} an
-000203a0: 6420 7b6f 7468 6572 7d3a 2066 756e 6374  d {other}: funct
-000203b0: 696f 6e61 6c20 6469 6d65 6e73 696f 6e20  ional dimension 
-000203c0: 696e 206d 6964 646c 652e 2022 290a 2020  in middle. ").  
-000203d0: 2020 2020 2020 656c 7365 3a20 7261 6973        else: rais
-000203e0: 6520 5479 7065 4572 726f 7228 6622 4572  e TypeError(f"Er
-000203f0: 726f 7220 696e 2063 6f6e 6361 7465 6e61  ror in concatena
-00020400: 7469 6e67 207b 7365 6c66 7d20 616e 6420  ting {self} and 
-00020410: 7b6f 7468 6572 7d3a 2063 6f6e 666c 6963  {other}: conflic
-00020420: 7420 696e 2066 756e 6374 696f 6e61 6c20  t in functional 
-00020430: 6469 6d65 6e73 696f 6e2e 2022 290a 2020  dimension. ").  
-00020440: 2020 2020 2020 2320 4465 616c 2077 6974        # Deal wit
-00020450: 6820 7468 6520 6261 7463 6820 6469 6d65  h the batch dime
-00020460: 6e73 696f 6e0a 2020 2020 2020 2020 6966  nsion.        if
-00020470: 2073 656c 662e 737a 5f62 6174 6368 5f64   self.sz_batch_d
-00020480: 696d 203d 3d20 303a 0a20 2020 2020 2020  im == 0:.       
-00020490: 2020 2020 2069 6620 6f74 6865 722e 737a       if other.sz
-000204a0: 5f62 6174 6368 5f64 696d 203c 3d20 3020  _batch_dim <= 0 
-000204b0: 6f72 206f 7468 6572 2e6e 5f62 6174 6368  or other.n_batch
-000204c0: 5f64 696d 203d 3d20 6f74 6865 722e 6e5f  _dim == other.n_
-000204d0: 6469 6d20 2d20 6f74 6865 722e 6e5f 6675  dim - other.n_fu
-000204e0: 6e63 5f64 696d 3a20 737a 5f62 6174 6368  nc_dim: sz_batch
-000204f0: 5f64 696d 203d 202d 6f74 6865 722e 6e5f  _dim = -other.n_
-00020500: 6261 7463 685f 6469 6d0a 2020 2020 2020  batch_dim.      
-00020510: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
-00020520: 6e5f 6469 6d20 2d20 7365 6c66 2e6e 5f66  n_dim - self.n_f
-00020530: 756e 635f 6469 6d20 3d3d 2030 3a20 737a  unc_dim == 0: sz
-00020540: 5f62 6174 6368 5f64 696d 203d 206f 7468  _batch_dim = oth
-00020550: 6572 2e6e 5f62 6174 6368 5f64 696d 0a20  er.n_batch_dim. 
-00020560: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00020570: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
-00020580: 2866 2245 7272 6f72 2069 6e20 636f 6e63  (f"Error in conc
-00020590: 6174 656e 6174 696e 6720 7b73 656c 667d  atenating {self}
-000205a0: 2061 6e64 207b 6f74 6865 727d 3a20 6261   and {other}: ba
-000205b0: 7463 6820 6469 6d65 6e73 696f 6e20 696e  tch dimension in
-000205c0: 206d 6964 646c 652e 2022 290a 2020 2020   middle. ").    
-000205d0: 2020 2020 656c 6966 206f 7468 6572 2e73      elif other.s
-000205e0: 7a5f 6261 7463 685f 6469 6d20 3d3d 2030  z_batch_dim == 0
-000205f0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00020600: 2073 656c 662e 737a 5f62 6174 6368 5f64   self.sz_batch_d
-00020610: 696d 203e 3d20 3020 6f72 2073 656c 662e  im >= 0 or self.
-00020620: 6e5f 6261 7463 685f 6469 6d20 3d3d 2073  n_batch_dim == s
-00020630: 656c 662e 6e5f 6469 6d20 2d20 7365 6c66  elf.n_dim - self
-00020640: 2e6e 5f66 756e 635f 6469 6d3a 2073 7a5f  .n_func_dim: sz_
-00020650: 6261 7463 685f 6469 6d20 3d20 7365 6c66  batch_dim = self
-00020660: 2e6e 5f62 6174 6368 5f64 696d 0a20 2020  .n_batch_dim.   
-00020670: 2020 2020 2020 2020 2065 6c69 6620 6f74           elif ot
-00020680: 6865 722e 6e5f 6469 6d20 2d20 6f74 6865  her.n_dim - othe
-00020690: 722e 6e5f 6675 6e63 5f64 696d 203d 3d20  r.n_func_dim == 
-000206a0: 303a 2073 7a5f 6261 7463 685f 6469 6d20  0: sz_batch_dim 
-000206b0: 3d20 7365 6c66 2e73 7a5f 6261 7463 685f  = self.sz_batch_
-000206c0: 6469 6d0a 2020 2020 2020 2020 2020 2020  dim.            
-000206d0: 656c 7365 3a20 7261 6973 6520 5479 7065  else: raise Type
-000206e0: 4572 726f 7228 6622 4572 726f 7220 696e  Error(f"Error in
-000206f0: 2063 6f6e 6361 7465 6e61 7469 6e67 207b   concatenating {
-00020700: 7365 6c66 7d20 616e 6420 7b6f 7468 6572  self} and {other
-00020710: 7d3a 2062 6174 6368 2064 696d 656e 7369  }: batch dimensi
-00020720: 6f6e 2069 6e20 6d69 6464 6c65 2e20 2229  on in middle. ")
-00020730: 0a20 2020 2020 2020 2065 6c73 653a 2072  .        else: r
-00020740: 6169 7365 2054 7970 6545 7272 6f72 2866  aise TypeError(f
-00020750: 2245 7272 6f72 2069 6e20 636f 6e63 6174  "Error in concat
-00020760: 656e 6174 696e 6720 7b73 656c 667d 2061  enating {self} a
-00020770: 6e64 207b 6f74 6865 727d 3a20 636f 6e66  nd {other}: conf
-00020780: 6c69 6374 2069 6e20 6261 7463 6820 6469  lict in batch di
-00020790: 6d65 6e73 696f 6e2e 2022 290a 2020 2020  mension. ").    
-000207a0: 2020 2020 2320 4465 616c 2077 6974 6820      # Deal with 
-000207b0: 7468 6520 6665 6174 7572 6520 6469 6d65  the feature dime
-000207c0: 6e73 696f 6e73 0a20 2020 2020 2020 2069  nsions.        i
-000207d0: 6620 7365 6c66 2e73 7a5f 6665 6174 7572  f self.sz_featur
-000207e0: 655f 6469 6d20 3d3d 2030 3a0a 2020 2020  e_dim == 0:.    
-000207f0: 2020 2020 2020 2020 6966 206f 7468 6572          if other
-00020800: 2e73 7a5f 6665 6174 7572 655f 6469 6d20  .sz_feature_dim 
-00020810: 3c3d 2030 206f 7220 6f74 6865 722e 6e5f  <= 0 or other.n_
-00020820: 6665 6174 7572 655f 6469 6d20 3d3d 206f  feature_dim == o
-00020830: 7468 6572 2e6e 5f64 696d 202d 206f 7468  ther.n_dim - oth
-00020840: 6572 2e6e 5f66 756e 635f 6469 6d20 2d20  er.n_func_dim - 
-00020850: 6f74 6865 722e 6e5f 6261 7463 685f 6469  other.n_batch_di
-00020860: 6d3a 2073 7a5f 6665 6174 7572 655f 6469  m: sz_feature_di
-00020870: 6d20 3d20 2d6f 7468 6572 2e6e 5f66 6561  m = -other.n_fea
-00020880: 7475 7265 5f64 696d 0a20 2020 2020 2020  ture_dim.       
-00020890: 2020 2020 2065 6c69 6620 7365 6c66 2e6e       elif self.n
-000208a0: 5f73 6571 7565 6e63 655f 6469 6d20 2b20  _sequence_dim + 
-000208b0: 7365 6c66 2e6e 5f73 7061 6365 5f64 696d  self.n_space_dim
-000208c0: 203d 3d20 303a 2073 7a5f 6665 6174 7572   == 0: sz_featur
-000208d0: 655f 6469 6d20 3d20 6f74 6865 722e 737a  e_dim = other.sz
-000208e0: 5f66 6561 7475 7265 5f64 696d 0a20 2020  _feature_dim.   
-000208f0: 2020 2020 2020 2020 2065 6c73 653a 2072           else: r
-00020900: 6169 7365 2054 7970 6545 7272 6f72 2866  aise TypeError(f
-00020910: 2245 7272 6f72 2069 6e20 636f 6e63 6174  "Error in concat
-00020920: 656e 6174 696e 6720 7b73 656c 667d 2061  enating {self} a
-00020930: 6e64 207b 6f74 6865 727d 3a20 6665 6174  nd {other}: feat
-00020940: 7572 6520 6469 6d65 6e73 696f 6e73 2069  ure dimensions i
-00020950: 6e20 6d69 6464 6c65 2e20 2229 0a20 2020  n middle. ").   
-00020960: 2020 2020 2065 6c69 6620 6f74 6865 722e       elif other.
-00020970: 737a 5f66 6561 7475 7265 5f64 696d 203d  sz_feature_dim =
-00020980: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-00020990: 2069 6620 7365 6c66 2e73 7a5f 6665 6174   if self.sz_feat
-000209a0: 7572 655f 6469 6d20 3e3d 2030 206f 7220  ure_dim >= 0 or 
-000209b0: 7365 6c66 2e6e 5f66 6561 7475 7265 5f64  self.n_feature_d
-000209c0: 696d 203d 3d20 7365 6c66 2e6e 5f64 696d  im == self.n_dim
-000209d0: 202d 2073 656c 662e 6e5f 6675 6e63 5f64   - self.n_func_d
-000209e0: 696d 202d 2073 656c 662e 6e5f 6261 7463  im - self.n_batc
-000209f0: 685f 6469 6d3a 2073 7a5f 6665 6174 7572  h_dim: sz_featur
-00020a00: 655f 6469 6d20 3d20 7365 6c66 2e6e 5f66  e_dim = self.n_f
-00020a10: 6561 7475 7265 5f64 696d 0a20 2020 2020  eature_dim.     
-00020a20: 2020 2020 2020 2065 6c69 6620 6f74 6865         elif othe
-00020a30: 722e 6e5f 7365 7175 656e 6365 5f64 696d  r.n_sequence_dim
-00020a40: 202b 206f 7468 6572 2e6e 5f73 7061 6365   + other.n_space
-00020a50: 5f64 696d 203d 3d20 303a 2073 7a5f 6665  _dim == 0: sz_fe
-00020a60: 6174 7572 655f 6469 6d20 3d20 7365 6c66  ature_dim = self
-00020a70: 2e73 7a5f 6665 6174 7572 655f 6469 6d0a  .sz_feature_dim.
-00020a80: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00020a90: 3a20 7261 6973 6520 5479 7065 4572 726f  : raise TypeErro
-00020aa0: 7228 6622 4572 726f 7220 696e 2063 6f6e  r(f"Error in con
-00020ab0: 6361 7465 6e61 7469 6e67 207b 7365 6c66  catenating {self
-00020ac0: 7d20 616e 6420 7b6f 7468 6572 7d3a 2066  } and {other}: f
-00020ad0: 6561 7475 7265 2064 696d 656e 7369 6f6e  eature dimension
-00020ae0: 7320 696e 206d 6964 646c 652e 2022 290a  s in middle. ").
-00020af0: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
-00020b00: 662e 737a 5f66 756e 635f 6469 6d20 3e3d  f.sz_func_dim >=
-00020b10: 2030 2061 6e64 2073 656c 662e 737a 5f62   0 and self.sz_b
-00020b20: 6174 6368 5f64 696d 203e 3d20 3020 616e  atch_dim >= 0 an
-00020b30: 6420 2873 656c 662e 737a 5f66 6561 7475  d (self.sz_featu
-00020b40: 7265 5f64 696d 203c 2030 206f 7220 7365  re_dim < 0 or se
-00020b50: 6c66 2e6e 5f66 756e 635f 6469 6d20 2b20  lf.n_func_dim + 
-00020b60: 7365 6c66 2e6e 5f62 6174 6368 5f64 696d  self.n_batch_dim
-00020b70: 202b 2073 656c 662e 6e5f 6665 6174 7572   + self.n_featur
-00020b80: 655f 6469 6d20 3d3d 2073 656c 662e 6e5f  e_dim == self.n_
-00020b90: 6469 6d29 2061 6e64 205c 0a20 2020 2020  dim) and \.     
-00020ba0: 2020 2020 2020 2020 6f74 6865 722e 737a          other.sz
-00020bb0: 5f66 756e 635f 6469 6d20 3c3d 2030 2061  _func_dim <= 0 a
-00020bc0: 6e64 206f 7468 6572 2e73 7a5f 6261 7463  nd other.sz_batc
-00020bd0: 685f 6469 6d20 3c3d 2030 2061 6e64 2028  h_dim <= 0 and (
-00020be0: 6f74 6865 722e 737a 5f66 6561 7475 7265  other.sz_feature
-00020bf0: 5f64 696d 203e 2030 206f 7220 6f74 6865  _dim > 0 or othe
-00020c00: 722e 6e5f 6675 6e63 5f64 696d 202b 206f  r.n_func_dim + o
-00020c10: 7468 6572 2e6e 5f62 6174 6368 5f64 696d  ther.n_batch_dim
-00020c20: 202b 206f 7468 6572 2e6e 5f66 6561 7475   + other.n_featu
-00020c30: 7265 5f64 696d 203d 3d20 6f74 6865 722e  re_dim == other.
-00020c40: 6e5f 6469 6d29 3a0a 2020 2020 2020 2020  n_dim):.        
-00020c50: 2020 2020 737a 5f66 6561 7475 7265 5f64      sz_feature_d
-00020c60: 696d 203d 205b 2d31 2c20 315d 5b73 656c  im = [-1, 1][sel
-00020c70: 662e 6665 6174 7572 655f 7374 6172 7420  f.feature_start 
-00020c80: 3d3d 2073 656c 662e 6e6f 6e5f 6261 745f  == self.non_bat_
-00020c90: 7374 6172 745d 202a 2028 7365 6c66 2e6e  start] * (self.n
-00020ca0: 5f66 6561 7475 7265 5f64 696d 202b 206f  _feature_dim + o
-00020cb0: 7468 6572 2e6e 5f66 6561 7475 7265 5f64  ther.n_feature_d
-00020cc0: 696d 290a 2020 2020 2020 2020 2320 656c  im).        # el
-00020cd0: 6966 206f 7468 6572 2e6e 5f66 6561 7475  if other.n_featu
-00020ce0: 7265 5f64 696d 203d 3d20 6f74 6865 722e  re_dim == other.
-00020cf0: 6e5f 6469 6d20 616e 6420 7365 6c66 2e73  n_dim and self.s
-00020d00: 7a5f 6665 6174 7572 655f 6469 6d20 3c20  z_feature_dim < 
-00020d10: 303a 0a20 2020 2020 2020 2023 2020 2020  0:.        #    
-00020d20: 2073 7a5f 6665 6174 7572 655f 6469 6d20   sz_feature_dim 
-00020d30: 3d20 7365 6c66 2e73 7a5f 6665 6174 7572  = self.sz_featur
-00020d40: 655f 6469 6d20 2d20 6f74 6865 722e 6e5f  e_dim - other.n_
-00020d50: 6469 6d0a 2020 2020 2020 2020 2320 656c  dim.        # el
-00020d60: 6966 2073 656c 662e 6e5f 6665 6174 7572  if self.n_featur
-00020d70: 655f 6469 6d20 3d3d 2073 656c 662e 6e5f  e_dim == self.n_
-00020d80: 6469 6d20 616e 6420 6f74 6865 722e 737a  dim and other.sz
-00020d90: 5f66 6561 7475 7265 5f64 696d 203e 2030  _feature_dim > 0
-00020da0: 3a0a 2020 2020 2020 2020 2320 2020 2020  :.        #     
-00020db0: 737a 5f66 6561 7475 7265 5f64 696d 203d  sz_feature_dim =
-00020dc0: 206f 7468 6572 2e73 7a5f 6665 6174 7572   other.sz_featur
-00020dd0: 655f 6469 6d20 2b20 7365 6c66 2e6e 5f64  e_dim + self.n_d
-00020de0: 696d 0a20 2020 2020 2020 2065 6c73 653a  im.        else:
-00020df0: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
-00020e00: 2866 2245 7272 6f72 2069 6e20 636f 6e63  (f"Error in conc
-00020e10: 6174 656e 6174 696e 6720 7b73 656c 667d  atenating {self}
-00020e20: 2061 6e64 207b 6f74 6865 727d 3a20 6d75   and {other}: mu
-00020e30: 6c74 6970 6c65 2073 6574 7320 6f66 2066  ltiple sets of f
-00020e40: 6561 7475 7265 2064 696d 656e 7369 6f6e  eature dimension
-00020e50: 732e 2022 290a 2020 2020 2020 2020 2320  s. ").        # 
-00020e60: 4465 616c 2077 6974 6820 7468 6520 7365  Deal with the se
-00020e70: 7175 656e 6365 2064 696d 656e 7369 6f6e  quence dimension
-00020e80: 730a 2020 2020 2020 2020 6966 2073 656c  s.        if sel
-00020e90: 662e 737a 5f73 6571 7565 6e63 655f 6469  f.sz_sequence_di
-00020ea0: 6d20 3d3d 2030 3a0a 2020 2020 2020 2020  m == 0:.        
-00020eb0: 2020 2020 6966 206f 7468 6572 2e73 7a5f      if other.sz_
-00020ec0: 7365 7175 656e 6365 5f64 696d 203c 3d20  sequence_dim <= 
-00020ed0: 3020 6f72 206f 7468 6572 2e6e 5f73 6571  0 or other.n_seq
-00020ee0: 7565 6e63 655f 6469 6d20 3d3d 206f 7468  uence_dim == oth
-00020ef0: 6572 2e6e 5f64 696d 202d 206f 7468 6572  er.n_dim - other
-00020f00: 2e6e 5f66 756e 635f 6469 6d20 2d20 6f74  .n_func_dim - ot
-00020f10: 6865 722e 6e5f 6261 7463 685f 6469 6d20  her.n_batch_dim 
-00020f20: 2d20 6f74 6865 722e 6e5f 6665 6174 7572  - other.n_featur
-00020f30: 655f 6469 6d3a 2073 7a5f 7365 7175 656e  e_dim: sz_sequen
-00020f40: 6365 5f64 696d 203d 202d 6f74 6865 722e  ce_dim = -other.
-00020f50: 6e5f 7365 7175 656e 6365 5f64 696d 0a20  n_sequence_dim. 
-00020f60: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00020f70: 7365 6c66 2e6e 5f73 7061 6365 5f64 696d  self.n_space_dim
-00020f80: 203d 3d20 303a 2073 7a5f 7365 7175 656e   == 0: sz_sequen
-00020f90: 6365 5f64 696d 203d 206f 7468 6572 2e73  ce_dim = other.s
-00020fa0: 7a5f 7365 7175 656e 6365 5f64 696d 0a20  z_sequence_dim. 
-00020fb0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00020fc0: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
-00020fd0: 2866 2245 7272 6f72 2069 6e20 636f 6e63  (f"Error in conc
-00020fe0: 6174 656e 6174 696e 6720 7b73 656c 667d  atenating {self}
-00020ff0: 2061 6e64 207b 6f74 6865 727d 3a20 7365   and {other}: se
-00021000: 7175 656e 6365 2064 696d 656e 7369 6f6e  quence dimension
-00021010: 7320 696e 206d 6964 646c 652e 2022 290a  s in middle. ").
-00021020: 2020 2020 2020 2020 656c 6966 206f 7468          elif oth
-00021030: 6572 2e73 7a5f 7365 7175 656e 6365 5f64  er.sz_sequence_d
-00021040: 696d 203d 3d20 303a 0a20 2020 2020 2020  im == 0:.       
-00021050: 2020 2020 2069 6620 7365 6c66 2e73 7a5f       if self.sz_
-00021060: 7365 7175 656e 6365 5f64 696d 203e 3d20  sequence_dim >= 
-00021070: 3020 6f72 2073 656c 662e 6e5f 7365 7175  0 or self.n_sequ
-00021080: 656e 6365 5f64 696d 203d 3d20 7365 6c66  ence_dim == self
-00021090: 2e6e 5f64 696d 202d 2073 656c 662e 6e5f  .n_dim - self.n_
-000210a0: 6675 6e63 5f64 696d 202d 2073 656c 662e  func_dim - self.
-000210b0: 6e5f 6261 7463 685f 6469 6d20 2d20 7365  n_batch_dim - se
-000210c0: 6c66 2e6e 5f66 6561 7475 7265 5f64 696d  lf.n_feature_dim
-000210d0: 3a20 737a 5f73 6571 7565 6e63 655f 6469  : sz_sequence_di
-000210e0: 6d20 3d20 7365 6c66 2e6e 5f73 6571 7565  m = self.n_seque
-000210f0: 6e63 655f 6469 6d0a 2020 2020 2020 2020  nce_dim.        
-00021100: 2020 2020 656c 6966 206f 7468 6572 2e6e      elif other.n
-00021110: 5f73 7061 6365 5f64 696d 203d 3d20 303a  _space_dim == 0:
-00021120: 2073 7a5f 7365 7175 656e 6365 5f64 696d   sz_sequence_dim
-00021130: 203d 2073 656c 662e 737a 5f73 6571 7565   = self.sz_seque
-00021140: 6e63 655f 6469 6d0a 2020 2020 2020 2020  nce_dim.        
-00021150: 2020 2020 656c 7365 3a20 7261 6973 6520      else: raise 
-00021160: 5479 7065 4572 726f 7228 6622 4572 726f  TypeError(f"Erro
-00021170: 7220 696e 2063 6f6e 6361 7465 6e61 7469  r in concatenati
-00021180: 6e67 207b 7365 6c66 7d20 616e 6420 7b6f  ng {self} and {o
-00021190: 7468 6572 7d3a 2073 6571 7565 6e63 6520  ther}: sequence 
-000211a0: 6469 6d65 6e73 696f 6e73 2069 6e20 6d69  dimensions in mi
-000211b0: 6464 6c65 2e20 2229 0a20 2020 2020 2020  ddle. ").       
-000211c0: 2065 6c69 6620 7365 6c66 2e73 7a5f 6675   elif self.sz_fu
-000211d0: 6e63 5f64 696d 203e 3d20 3020 616e 6420  nc_dim >= 0 and 
-000211e0: 7365 6c66 2e73 7a5f 6261 7463 685f 6469  self.sz_batch_di
-000211f0: 6d20 3e3d 2030 2061 6e64 2073 656c 662e  m >= 0 and self.
-00021200: 737a 5f66 6561 7475 7265 5f64 696d 203e  sz_feature_dim >
-00021210: 3d20 3020 616e 6420 2873 656c 662e 737a  = 0 and (self.sz
-00021220: 5f73 6571 7565 6e63 655f 6469 6d20 3c20  _sequence_dim < 
-00021230: 3020 6f72 2073 656c 662e 6e5f 7370 6163  0 or self.n_spac
-00021240: 655f 6469 6d20 3d3d 2030 2920 616e 6420  e_dim == 0) and 
-00021250: 5c0a 2020 2020 2020 2020 2020 2020 206f  \.             o
-00021260: 7468 6572 2e73 7a5f 6675 6e63 5f64 696d  ther.sz_func_dim
-00021270: 203c 3d20 3020 616e 6420 6f74 6865 722e   <= 0 and other.
-00021280: 737a 5f62 6174 6368 5f64 696d 203c 3d20  sz_batch_dim <= 
-00021290: 3020 616e 6420 6f74 6865 722e 737a 5f66  0 and other.sz_f
-000212a0: 6561 7475 7265 5f64 696d 203c 3d20 3020  eature_dim <= 0 
-000212b0: 616e 6420 286f 7468 6572 2e73 7a5f 7365  and (other.sz_se
-000212c0: 7175 656e 6365 5f64 696d 203e 2030 206f  quence_dim > 0 o
-000212d0: 7220 6f74 6865 722e 6e5f 7370 6163 655f  r other.n_space_
-000212e0: 6469 6d20 3d3d 2030 293a 0a20 2020 2020  dim == 0):.     
-000212f0: 2020 2020 2020 2073 7a5f 7365 7175 656e         sz_sequen
-00021300: 6365 5f64 696d 203d 205b 2d31 2c20 315d  ce_dim = [-1, 1]
-00021310: 5b73 656c 662e 7365 7175 656e 6365 5f73  [self.sequence_s
-00021320: 7461 7274 203d 3d20 7365 6c66 2e73 6571  tart == self.seq
-00021330: 5f73 7063 5f73 7461 7274 5d20 2a20 2873  _spc_start] * (s
-00021340: 656c 662e 6e5f 7365 7175 656e 6365 5f64  elf.n_sequence_d
-00021350: 696d 202b 206f 7468 6572 2e6e 5f73 6571  im + other.n_seq
-00021360: 7565 6e63 655f 6469 6d29 0a20 2020 2020  uence_dim).     
-00021370: 2020 2023 2065 6c69 6620 6f74 6865 722e     # elif other.
-00021380: 6e5f 7365 7175 656e 6365 5f64 696d 203d  n_sequence_dim =
-00021390: 3d20 6f74 6865 722e 6e5f 6469 6d20 616e  = other.n_dim an
-000213a0: 6420 7365 6c66 2e73 7a5f 7365 7175 656e  d self.sz_sequen
-000213b0: 6365 5f64 696d 203c 2030 3a0a 2020 2020  ce_dim < 0:.    
-000213c0: 2020 2020 2320 2020 2020 737a 5f73 6571      #     sz_seq
-000213d0: 7565 6e63 655f 6469 6d20 3d20 7365 6c66  uence_dim = self
-000213e0: 2e73 7a5f 7365 7175 656e 6365 5f64 696d  .sz_sequence_dim
-000213f0: 202d 206f 7468 6572 2e6e 5f64 696d 0a20   - other.n_dim. 
-00021400: 2020 2020 2020 2023 2065 6c69 6620 7365         # elif se
-00021410: 6c66 2e6e 5f73 6571 7565 6e63 655f 6469  lf.n_sequence_di
-00021420: 6d20 3d3d 2073 656c 662e 6e5f 6469 6d20  m == self.n_dim 
-00021430: 616e 6420 6f74 6865 722e 737a 5f73 6571  and other.sz_seq
-00021440: 7565 6e63 655f 6469 6d20 3e20 303a 0a20  uence_dim > 0:. 
-00021450: 2020 2020 2020 2023 2020 2020 2073 7a5f         #     sz_
-00021460: 7365 7175 656e 6365 5f64 696d 203d 206f  sequence_dim = o
-00021470: 7468 6572 2e73 7a5f 7365 7175 656e 6365  ther.sz_sequence
-00021480: 5f64 696d 202b 2073 656c 662e 6e5f 6469  _dim + self.n_di
-00021490: 6d0a 2020 2020 2020 2020 656c 7365 3a20  m.        else: 
-000214a0: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
-000214b0: 6622 4572 726f 7220 696e 2063 6f6e 6361  f"Error in conca
-000214c0: 7465 6e61 7469 6e67 207b 7365 6c66 7d20  tenating {self} 
-000214d0: 616e 6420 7b6f 7468 6572 7d3a 206d 756c  and {other}: mul
-000214e0: 7469 706c 6520 7365 7473 206f 6620 7365  tiple sets of se
-000214f0: 7175 656e 6365 2064 696d 656e 7369 6f6e  quence dimension
-00021500: 732e 2022 290a 2020 2020 2020 2020 7265  s. ").        re
-00021510: 7475 726e 2073 656c 662e 5f5f 636c 6173  turn self.__clas
-00021520: 735f 5f2e 5f5f 6e65 775f 7261 775f 5f28  s__.__new_raw__(
-00021530: 7375 7065 7228 292e 5f5f 6164 645f 5f28  super().__add__(
-00021540: 6f74 6865 7229 2c20 737a 5f66 756e 635f  other), sz_func_
-00021550: 6469 6d3d 737a 5f66 756e 635f 6469 6d2c  dim=sz_func_dim,
-00021560: 2073 7a5f 6261 7463 685f 6469 6d3d 737a   sz_batch_dim=sz
-00021570: 5f62 6174 6368 5f64 696d 2c20 737a 5f66  _batch_dim, sz_f
-00021580: 6561 7475 7265 5f64 696d 3d73 7a5f 6665  eature_dim=sz_fe
-00021590: 6174 7572 655f 6469 6d2c 2073 7a5f 7365  ature_dim, sz_se
-000215a0: 7175 656e 6365 5f64 696d 3d73 7a5f 7365  quence_dim=sz_se
-000215b0: 7175 656e 6365 5f64 696d 290a 2020 2020  quence_dim).    
-000215c0: 2020 2020 0a20 2020 2064 6566 205f 5f72      .    def __r
-000215d0: 6164 645f 5f28 7365 6c66 2c20 6f74 6865  add__(self, othe
-000215e0: 7229 3a0a 2020 2020 2020 2020 6176 6f75  r):.        avou
-000215f0: 6368 2869 7369 6e73 7461 6e63 6528 6f74  ch(isinstance(ot
-00021600: 6865 722c 2074 7570 6c65 292c 2054 7970  her, tuple), Typ
-00021610: 6545 7272 6f72 2822 5375 6d6d 6174 696f  eError("Summatio
-00021620: 6e20 666f 7220 2762 742e 5369 7a65 2720  n for 'bt.Size' 
-00021630: 6973 2069 6e68 6572 6974 6564 2066 726f  is inherited fro
-00021640: 6d20 7079 7468 6f6e 206f 626a 6563 7420  m python object 
-00021650: 2774 7570 6c65 2720 746f 2070 6572 666f  'tuple' to perfo
-00021660: 726d 2063 6f6e 6361 7465 6e61 7469 6f6e  rm concatenation
-00021670: 2c20 706c 6561 7365 2075 7365 2060 7369  , please use `si
-00021680: 7a65 203c 3c28 3e3e 2920 3260 2074 6f20  ze <<(>>) 2` to 
-00021690: 7065 7266 6f72 6d20 656c 656d 656e 742d  perform element-
-000216a0: 7769 7365 2073 756d 6d61 7469 6f6e 2028  wise summation (
-000216b0: 7375 6274 7261 6374 696f 6e29 2074 6f20  subtraction) to 
-000216c0: 696e 6372 6561 7365 2028 6465 6372 6561  increase (decrea
-000216d0: 7365 2920 7468 6520 7369 7a65 2e20 2229  se) the size. ")
-000216e0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-000216f0: 2069 7369 6e73 7461 6e63 6528 6f74 6865   isinstance(othe
-00021700: 722c 2053 697a 6529 3a20 6f74 6865 7220  r, Size): other 
-00021710: 3d20 7365 6c66 2e5f 5f63 6c61 7373 5f5f  = self.__class__
-00021720: 2e5f 5f6e 6577 5f72 6177 5f5f 286f 7468  .__new_raw__(oth
-00021730: 6572 290a 2020 2020 2020 2020 7265 7475  er).        retu
-00021740: 726e 206f 7468 6572 2e5f 5f61 6464 5f5f  rn other.__add__
-00021750: 2873 656c 6629 0a20 2020 200a 2020 2020  (self).    .    
-00021760: 4061 6c69 6173 2827 5f5f 696d 756c 5f5f  @alias('__imul__
-00021770: 272c 2027 5f5f 726d 756c 5f5f 2729 0a20  ', '__rmul__'). 
-00021780: 2020 2064 6566 205f 5f6d 756c 5f5f 2873     def __mul__(s
-00021790: 656c 662c 206f 7468 6572 293a 0a20 2020  elf, other):.   
-000217a0: 2020 2020 2061 766f 7563 6828 6973 696e       avouch(isin
-000217b0: 7374 616e 6365 286f 7468 6572 2c20 696e  stance(other, in
-000217c0: 745f 292c 2054 7970 6545 7272 6f72 2822  t_), TypeError("
-000217d0: 5072 6f64 7563 7469 6f6e 2066 6f72 2027  Production for '
-000217e0: 6274 2e53 697a 6527 2069 7320 696e 6865  bt.Size' is inhe
-000217f0: 7269 7465 6420 6672 6f6d 2070 7974 686f  rited from pytho
-00021800: 6e20 6f62 6a65 6374 2027 7475 706c 6527  n object 'tuple'
-00021810: 2074 6f20 7065 7266 6f72 6d20 6475 706c   to perform dupl
-00021820: 6963 6174 696f 6e2c 2070 6c65 6173 6520  ication, please 
-00021830: 7573 6520 6073 697a 6520 2a2a 282f 2f29  use `size **(//)
-00021840: 2032 6020 746f 2070 6572 666f 726d 2065   2` to perform e
-00021850: 6c65 6d65 6e74 2d77 6973 6520 6d75 6c74  lement-wise mult
-00021860: 6970 6c69 6361 7469 6f6e 2028 6469 7669  iplication (divi
-00021870: 7369 6f6e 2920 746f 2065 6e6c 6172 6765  sion) to enlarge
-00021880: 2028 7368 7269 6e6b 2920 7468 6520 7369   (shrink) the si
-00021890: 7a65 2e20 2229 290a 2020 2020 2020 2020  ze. ")).        
-000218a0: 6966 2073 656c 662e 6e5f 6675 6e63 5f64  if self.n_func_d
-000218b0: 696d 203d 3d20 7365 6c66 2e6e 5f64 696d  im == self.n_dim
-000218c0: 3a0a 2020 2020 2020 2020 2020 2020 6176  :.            av
-000218d0: 6f75 6368 286f 7468 6572 2069 6e20 2830  ouch(other in (0
-000218e0: 2c20 3129 2c20 5479 7065 4572 726f 7228  , 1), TypeError(
-000218f0: 6622 4572 726f 7220 696e 207b 7365 6c66  f"Error in {self
-00021900: 7d20 2a20 7b6f 7468 6572 7d3a 206d 756c  } * {other}: mul
-00021910: 7469 706c 6520 6675 6e63 7469 6f6e 616c  tiple functional
-00021920: 2064 696d 656e 7369 6f6e 732e 2022 2929   dimensions. "))
-00021930: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00021940: 6f74 6865 7220 3d3d 2030 3a20 7265 7475  other == 0: retu
-00021950: 726e 2073 656c 662e 5f5f 636c 6173 735f  rn self.__class_
-00021960: 5f2e 5f5f 6e65 775f 7261 775f 5f28 7475  _.__new_raw__(tu
-00021970: 706c 6528 2929 0a20 2020 2020 2020 2020  ple()).         
-00021980: 2020 2072 6574 7572 6e20 7365 6c66 0a20     return self. 
-00021990: 2020 2020 2020 2069 6620 7365 6c66 2e6e         if self.n
-000219a0: 5f62 6174 6368 5f64 696d 203d 3d20 7365  _batch_dim == se
-000219b0: 6c66 2e6e 5f64 696d 3a0a 2020 2020 2020  lf.n_dim:.      
-000219c0: 2020 2020 2020 6176 6f75 6368 286f 7468        avouch(oth
-000219d0: 6572 2069 6e20 2830 2c20 3129 2c20 5479  er in (0, 1), Ty
-000219e0: 7065 4572 726f 7228 6622 4572 726f 7220  peError(f"Error 
-000219f0: 696e 207b 7365 6c66 7d20 2a20 7b6f 7468  in {self} * {oth
-00021a00: 6572 7d3a 206d 756c 7469 706c 6520 6261  er}: multiple ba
-00021a10: 7463 6820 6469 6d65 6e73 696f 6e73 2e20  tch dimensions. 
-00021a20: 2229 290a 2020 2020 2020 2020 2020 2020  ")).            
-00021a30: 6966 206f 7468 6572 203d 3d20 303a 2072  if other == 0: r
-00021a40: 6574 7572 6e20 7365 6c66 2e5f 5f63 6c61  eturn self.__cla
-00021a50: 7373 5f5f 2e5f 5f6e 6577 5f72 6177 5f5f  ss__.__new_raw__
-00021a60: 2874 7570 6c65 2829 290a 2020 2020 2020  (tuple()).      
-00021a70: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00021a80: 660a 2020 2020 2020 2020 6966 2073 656c  f.        if sel
-00021a90: 662e 6e5f 6665 6174 7572 655f 6469 6d20  f.n_feature_dim 
-00021aa0: 3d3d 2073 656c 662e 6e5f 6469 6d3a 0a20  == self.n_dim:. 
-00021ab0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00021ac0: 6e20 7365 6c66 2e5f 5f63 6c61 7373 5f5f  n self.__class__
-00021ad0: 2e5f 5f6e 6577 5f72 6177 5f5f 2873 7570  .__new_raw__(sup
-00021ae0: 6572 2829 2e5f 5f6d 756c 5f5f 286f 7468  er().__mul__(oth
-00021af0: 6572 292c 2073 7a5f 6665 6174 7572 655f  er), sz_feature_
-00021b00: 6469 6d3d 7365 6c66 2e6e 5f64 696d 202a  dim=self.n_dim *
-00021b10: 206f 7468 6572 290a 2020 2020 2020 2020   other).        
-00021b20: 6966 2073 656c 662e 6e5f 7365 7175 656e  if self.n_sequen
-00021b30: 6365 5f64 696d 203d 3d20 7365 6c66 2e6e  ce_dim == self.n
-00021b40: 5f64 696d 3a0a 2020 2020 2020 2020 2020  _dim:.          
-00021b50: 2020 7265 7475 726e 2073 656c 662e 5f5f    return self.__
-00021b60: 636c 6173 735f 5f2e 5f5f 6e65 775f 7261  class__.__new_ra
-00021b70: 775f 5f28 7375 7065 7228 292e 5f5f 6d75  w__(super().__mu
-00021b80: 6c5f 5f28 6f74 6865 7229 2c20 737a 5f73  l__(other), sz_s
-00021b90: 6571 7565 6e63 655f 6469 6d3d 7365 6c66  equence_dim=self
-00021ba0: 2e6e 5f64 696d 202a 206f 7468 6572 290a  .n_dim * other).
-00021bb0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00021bc0: 6e5f 7370 6163 655f 6469 6d20 3e20 303a  n_space_dim > 0:
-00021bd0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00021be0: 7572 6e20 7365 6c66 2e77 6974 685f 7370  urn self.with_sp
-00021bf0: 6163 6528 7365 6c66 2e73 7061 6365 2e74  ace(self.space.t
-00021c00: 7570 6c65 2829 202a 206f 7468 6572 290a  uple() * other).
-00021c10: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00021c20: 6e5f 7365 7175 656e 6365 5f64 696d 203e  n_sequence_dim >
-00021c30: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00021c40: 7265 7475 726e 2073 656c 662e 7769 7468  return self.with
-00021c50: 5f73 6571 7565 6e63 6528 7365 6c66 2e73  _sequence(self.s
-00021c60: 6571 7565 6e63 652e 7475 706c 6528 2920  equence.tuple() 
-00021c70: 2a20 6f74 6865 7229 0a20 2020 2020 2020  * other).       
-00021c80: 2061 766f 7563 6828 7365 6c66 2e6e 5f66   avouch(self.n_f
-00021c90: 6561 7475 7265 5f64 696d 203e 2030 2c20  eature_dim > 0, 
-00021ca0: 5275 6e74 696d 6545 7272 6f72 2866 2253  RuntimeError(f"S
-00021cb0: 697a 6520 7b73 656c 667d 2065 6e63 6f75  ize {self} encou
-00021cc0: 6e74 6572 7320 616e 2069 6e6e 6572 2070  nters an inner p
-00021cd0: 726f 626c 656d 3a20 6e5f 7370 6163 655f  roblem: n_space_
-00021ce0: 6469 6d20 2b20 6e5f 7365 7175 656e 6365  dim + n_sequence
-00021cf0: 5f64 696d 202b 206e 5f66 6561 7475 7265  _dim + n_feature
-00021d00: 5f64 696d 202b 206e 5f62 6174 6368 5f64  _dim + n_batch_d
-00021d10: 696d 202b 206e 5f66 756e 635f 6469 6d20  im + n_func_dim 
-00021d20: 213d 206e 5f64 696d 2e20 2229 290a 2020  != n_dim. ")).  
-00021d30: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00021d40: 662e 7769 7468 5f66 6561 7475 7265 2873  f.with_feature(s
-00021d50: 656c 662e 6665 6174 7572 652e 7475 706c  elf.feature.tupl
-00021d60: 6528 2920 2a20 6f74 6865 7229 0a20 2020  e() * other).   
-00021d70: 200a 2020 2020 2323 2065 6c65 6d65 6e74   .    ## element
-00021d80: 2d77 6973 6520 6f70 6572 6174 696f 6e73  -wise operations
-00021d90: 3a0a 2020 2020 4073 7461 7469 636d 6574  :.    @staticmet
-00021da0: 686f 640a 2020 2020 6465 6620 5f5f 6f70  hod.    def __op
-00021db0: 5f5f 2873 656c 662c 206f 7468 6572 2c20  __(self, other, 
-00021dc0: 2a2c 206f 7065 7261 7469 6f6e 2c20 6964  *, operation, id
-00021dd0: 656e 7469 7479 293a 0a20 2020 2020 2020  entity):.       
-00021de0: 2061 766f 7563 6828 6973 696e 7374 616e   avouch(isinstan
-00021df0: 6365 2873 656c 662c 2053 697a 6529 2c20  ce(self, Size), 
-00021e00: 5275 6e74 696d 6545 7272 6f72 2822 496e  RuntimeError("In
-00021e10: 6e65 7220 7072 6f62 6c65 6d3a 2069 6620  ner problem: if 
-00021e20: 2762 742e 5369 7a65 2e5f 5f6f 705f 5f27  'bt.Size.__op__'
-00021e30: 2069 7320 6e6f 7420 6361 6c6c 6564 206d   is not called m
-00021e40: 616e 7561 6c6c 792c 2070 6c65 6173 6520  anually, please 
-00021e50: 636f 6e74 6163 7420 7468 6520 6465 7665  contact the deve
-00021e60: 6c6f 7065 7273 2077 6974 6820 4572 726f  lopers with Erro
-00021e70: 7220 436f 6465 3a20 4235 3236 2229 290a  r Code: B526")).
-00021e80: 2020 2020 2020 2020 6176 6f75 6368 2869          avouch(i
-00021e90: 7369 6e73 7461 6e63 6528 6f74 6865 722c  sinstance(other,
-00021ea0: 2028 6e75 6d5f 2c20 7475 706c 6529 292c   (num_, tuple)),
-00021eb0: 2054 7970 6545 7272 6f72 2866 2245 6c65   TypeError(f"Ele
-00021ec0: 6d65 6e74 2d77 6973 6520 6f70 6572 6174  ment-wise operat
-00021ed0: 696f 6e73 2061 7265 206f 6e6c 7920 7573  ions are only us
-00021ee0: 6564 2066 6f72 206e 756d 6265 7273 206f  ed for numbers o
-00021ef0: 7220 7475 706c 6573 2c20 6e6f 7420 7b74  r tuples, not {t
-00021f00: 7970 6528 6f74 6865 7229 7d2e 2229 290a  ype(other)}.")).
-00021f10: 2020 2020 2020 2020 6f70 203d 206c 616d          op = lam
-00021f20: 6264 6120 782c 2079 3a20 286d 6178 5f28  bda x, y: (max_(
-00021f30: 696e 745f 286f 7065 7261 7469 6f6e 2878  int_(operation(x
-00021f40: 2c20 7929 292c 2030 2920 6966 2078 203e  , y)), 0) if x >
-00021f50: 3d20 3020 656c 7365 202d 3129 2069 6620  = 0 else -1) if 
-00021f60: 6964 656e 7469 7479 203d 3d20 3020 6f72  identity == 0 or
-00021f70: 2079 203e 3d20 3020 656c 7365 202d 310a   y >= 0 else -1.
-00021f80: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00021f90: 7461 6e63 6528 6f74 6865 722c 206e 756d  tance(other, num
-00021fa0: 5f29 3a20 7265 7475 726e 2073 656c 662e  _): return self.
-00021fb0: 7769 7468 5f73 7061 6365 2874 7570 6c65  with_space(tuple
-00021fc0: 286f 7028 782c 206f 7468 6572 2920 666f  (op(x, other) fo
-00021fd0: 7220 7820 696e 2073 656c 662e 7370 6163  r x in self.spac
-00021fe0: 6529 290a 2020 2020 2020 2020 6f74 6865  e)).        othe
-00021ff0: 725f 6675 6e63 203d 2069 6465 6e74 6974  r_func = identit
-00022000: 790a 2020 2020 2020 2020 6f74 6865 725f  y.        other_
-00022010: 6261 7463 6820 3d20 6964 656e 7469 7479  batch = identity
-00022020: 0a20 2020 2020 2020 206f 7468 6572 5f66  .        other_f
-00022030: 6561 7475 7265 203d 2028 6964 656e 7469  eature = (identi
-00022040: 7479 2c29 0a20 2020 2020 2020 206f 7468  ty,).        oth
-00022050: 6572 5f73 6571 7565 6e63 6520 3d20 2869  er_sequence = (i
-00022060: 6465 6e74 6974 792c 290a 2020 2020 2020  dentity,).      
-00022070: 2020 6f74 6865 725f 7370 6163 6520 3d20    other_space = 
-00022080: 2869 6465 6e74 6974 792c 290a 2020 2020  (identity,).    
-00022090: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-000220a0: 6528 6f74 6865 722c 2053 697a 6529 3a0a  e(other, Size):.
-000220b0: 2020 2020 2020 2020 2020 2020 6966 206f              if o
-000220c0: 7468 6572 2e68 6173 5f66 756e 633a 206f  ther.has_func: o
-000220d0: 7468 6572 5f66 756e 6320 3d20 6f74 6865  ther_func = othe
-000220e0: 722e 6e5f 6675 6e63 0a20 2020 2020 2020  r.n_func.       
-000220f0: 2020 2020 2069 6620 6f74 6865 722e 6861       if other.ha
-00022100: 735f 6261 7463 683a 206f 7468 6572 5f62  s_batch: other_b
-00022110: 6174 6368 203d 206f 7468 6572 2e6e 5f62  atch = other.n_b
-00022120: 6174 6368 0a20 2020 2020 2020 2020 2020  atch.           
-00022130: 2069 6620 6f74 6865 722e 6861 735f 6665   if other.has_fe
-00022140: 6174 7572 653a 206f 7468 6572 5f66 6561  ature: other_fea
-00022150: 7475 7265 203d 206f 7468 6572 2e66 6561  ture = other.fea
-00022160: 7475 7265 0a20 2020 2020 2020 2020 2020  ture.           
-00022170: 2069 6620 6f74 6865 722e 6861 735f 7365   if other.has_se
-00022180: 7175 656e 6365 3a20 6f74 6865 725f 7365  quence: other_se
-00022190: 7175 656e 6365 203d 206f 7468 6572 2e73  quence = other.s
-000221a0: 6571 7565 6e63 650a 2020 2020 2020 2020  equence.        
-000221b0: 2020 2020 6966 206f 7468 6572 2e68 6173      if other.has
-000221c0: 5f73 7061 6365 3a20 6f74 6865 725f 7370  _space: other_sp
-000221d0: 6163 6520 3d20 6f74 6865 722e 7370 6163  ace = other.spac
-000221e0: 650a 2020 2020 2020 2020 656c 6966 2069  e.        elif i
-000221f0: 7369 6e73 7461 6e63 6528 6f74 6865 722c  sinstance(other,
-00022200: 2074 7570 6c65 293a 206f 7468 6572 5f73   tuple): other_s
-00022210: 7061 6365 203d 206f 7468 6572 0a20 2020  pace = other.   
-00022220: 2020 2020 2065 6c73 653a 2072 6169 7365       else: raise
-00022230: 2054 7970 6545 7272 6f72 2866 2243 616e   TypeError(f"Can
-00022240: 6e6f 7420 7065 7266 6f72 6d20 656c 656d  not perform elem
-00022250: 656e 742d 7769 7365 206f 7065 7261 7469  ent-wise operati
-00022260: 6f6e 2062 6574 7765 656e 2074 7970 6573  on between types
-00022270: 207b 7479 7065 2873 656c 6629 7d20 616e   {type(self)} an
-00022280: 6420 7b74 7970 6528 6f74 6865 7229 7d2e  d {type(other)}.
-00022290: 2022 290a 2020 2020 2020 2020 7365 6c66   ").        self
-000222a0: 5f66 6561 7475 7265 203d 2074 7570 6c65  _feature = tuple
-000222b0: 2829 0a20 2020 2020 2020 2073 656c 665f  ().        self_
-000222c0: 7365 7175 656e 6365 203d 2074 7570 6c65  sequence = tuple
-000222d0: 2829 0a20 2020 2020 2020 2073 656c 665f  ().        self_
-000222e0: 7370 6163 6520 3d20 7475 706c 6528 290a  space = tuple().
-000222f0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00022300: 6861 735f 6665 6174 7572 653a 2073 656c  has_feature: sel
-00022310: 665f 6665 6174 7572 6520 3d20 7365 6c66  f_feature = self
-00022320: 2e66 6561 7475 7265 0a20 2020 2020 2020  .feature.       
-00022330: 2069 6620 7365 6c66 2e68 6173 5f73 6571   if self.has_seq
-00022340: 7565 6e63 653a 2073 656c 665f 7365 7175  uence: self_sequ
-00022350: 656e 6365 203d 2073 656c 662e 7365 7175  ence = self.sequ
-00022360: 656e 6365 0a20 2020 2020 2020 2069 6620  ence.        if 
-00022370: 7365 6c66 2e68 6173 5f73 7061 6365 3a20  self.has_space: 
-00022380: 7365 6c66 5f73 7061 6365 203d 2073 656c  self_space = sel
-00022390: 662e 7370 6163 650a 2020 2020 2020 2020  f.space.        
-000223a0: 6966 206c 656e 286f 7468 6572 5f66 6561  if len(other_fea
-000223b0: 7475 7265 2920 3d3d 2031 3a20 6f74 6865  ture) == 1: othe
-000223c0: 725f 6665 6174 7572 6520 2a3d 2073 656c  r_feature *= sel
-000223d0: 662e 6e5f 6665 6174 7572 655f 6469 6d0a  f.n_feature_dim.
-000223e0: 2020 2020 2020 2020 656c 6966 206c 656e          elif len
-000223f0: 2873 656c 665f 6665 6174 7572 6529 203d  (self_feature) =
-00022400: 3d20 313a 2073 656c 665f 6665 6174 7572  = 1: self_featur
-00022410: 6520 2a3d 206c 656e 286f 7468 6572 5f66  e *= len(other_f
-00022420: 6561 7475 7265 290a 2020 2020 2020 2020  eature).        
-00022430: 6966 206c 656e 286f 7468 6572 5f73 6571  if len(other_seq
-00022440: 7565 6e63 6529 203d 3d20 313a 206f 7468  uence) == 1: oth
-00022450: 6572 5f73 6571 7565 6e63 6520 2a3d 2073  er_sequence *= s
-00022460: 656c 662e 6e5f 7365 7175 656e 6365 5f64  elf.n_sequence_d
-00022470: 696d 0a20 2020 2020 2020 2065 6c69 6620  im.        elif 
-00022480: 6c65 6e28 7365 6c66 5f73 6571 7565 6e63  len(self_sequenc
-00022490: 6529 203d 3d20 313a 2073 656c 665f 7365  e) == 1: self_se
-000224a0: 7175 656e 6365 202a 3d20 6c65 6e28 6f74  quence *= len(ot
-000224b0: 6865 725f 7365 7175 656e 6365 290a 2020  her_sequence).  
-000224c0: 2020 2020 2020 6966 206c 656e 286f 7468        if len(oth
-000224d0: 6572 5f73 7061 6365 2920 3d3d 2031 3a20  er_space) == 1: 
-000224e0: 6f74 6865 725f 7370 6163 6520 2a3d 2073  other_space *= s
-000224f0: 656c 662e 6e5f 7370 6163 655f 6469 6d0a  elf.n_space_dim.
-00022500: 2020 2020 2020 2020 656c 6966 206c 656e          elif len
-00022510: 2873 656c 665f 7370 6163 6529 203d 3d20  (self_space) == 
-00022520: 313a 2073 656c 665f 7370 6163 6520 2a3d  1: self_space *=
-00022530: 206c 656e 286f 7468 6572 5f73 7061 6365   len(other_space
-00022540: 290a 2020 2020 2020 2020 6176 6f75 6368  ).        avouch
-00022550: 2869 7369 6e73 7461 6e63 6528 6f74 6865  (isinstance(othe
-00022560: 725f 6675 6e63 2c20 6e75 6d5f 292c 2054  r_func, num_), T
-00022570: 7970 6545 7272 6f72 2866 2249 6e76 616c  ypeError(f"Inval
-00022580: 6964 206f 7065 7261 7469 6f6e 2062 6574  id operation bet
-00022590: 7765 656e 207b 7365 6c66 7d20 616e 6420  ween {self} and 
-000225a0: 7b6f 7468 6572 7d3a 2063 6f6e 666c 6963  {other}: conflic
-000225b0: 7420 696e 2066 756e 6374 696f 6e61 6c20  t in functional 
-000225c0: 6469 6d65 6e73 696f 6e2e 2022 2929 0a20  dimension. ")). 
-000225d0: 2020 2020 2020 2061 766f 7563 6828 6973         avouch(is
-000225e0: 696e 7374 616e 6365 286f 7468 6572 5f62  instance(other_b
-000225f0: 6174 6368 2c20 6e75 6d5f 292c 2054 7970  atch, num_), Typ
-00022600: 6545 7272 6f72 2866 2249 6e76 616c 6964  eError(f"Invalid
-00022610: 206f 7065 7261 7469 6f6e 2062 6574 7765   operation betwe
-00022620: 656e 207b 7365 6c66 7d20 616e 6420 7b6f  en {self} and {o
-00022630: 7468 6572 7d3a 2063 6f6e 666c 6963 7420  ther}: conflict 
-00022640: 696e 2062 6174 6368 2064 696d 656e 7369  in batch dimensi
-00022650: 6f6e 2e20 2229 290a 2020 2020 2020 2020  on. ")).        
-00022660: 6176 6f75 6368 2869 7369 6e73 7461 6e63  avouch(isinstanc
-00022670: 6528 6f74 6865 725f 6665 6174 7572 652c  e(other_feature,
-00022680: 2074 7570 6c65 2920 616e 6420 6c65 6e28   tuple) and len(
-00022690: 6f74 6865 725f 6665 6174 7572 6529 203d  other_feature) =
-000226a0: 3d20 7365 6c66 2e6e 5f66 6561 7475 7265  = self.n_feature
-000226b0: 5f64 696d 2c20 5479 7065 4572 726f 7228  _dim, TypeError(
-000226c0: 6622 496e 7661 6c69 6420 6f70 6572 6174  f"Invalid operat
-000226d0: 696f 6e20 6265 7477 6565 6e20 7b73 656c  ion between {sel
-000226e0: 667d 2061 6e64 207b 6f74 6865 727d 3a20  f} and {other}: 
-000226f0: 636f 6e66 6c69 6374 2069 6e20 6665 6174  conflict in feat
-00022700: 7572 6520 7369 7a65 2e20 2229 290a 2020  ure size. ")).  
-00022710: 2020 2020 2020 6176 6f75 6368 2869 7369        avouch(isi
-00022720: 6e73 7461 6e63 6528 6f74 6865 725f 7365  nstance(other_se
-00022730: 7175 656e 6365 2c20 7475 706c 6529 2061  quence, tuple) a
-00022740: 6e64 206c 656e 286f 7468 6572 5f73 6571  nd len(other_seq
-00022750: 7565 6e63 6529 203d 3d20 7365 6c66 2e6e  uence) == self.n
-00022760: 5f73 6571 7565 6e63 655f 6469 6d2c 2054  _sequence_dim, T
-00022770: 7970 6545 7272 6f72 2866 2249 6e76 616c  ypeError(f"Inval
-00022780: 6964 206f 7065 7261 7469 6f6e 2062 6574  id operation bet
-00022790: 7765 656e 207b 7365 6c66 7d20 616e 6420  ween {self} and 
-000227a0: 7b6f 7468 6572 7d3a 2063 6f6e 666c 6963  {other}: conflic
-000227b0: 7420 696e 2073 6571 7565 6e63 6520 7369  t in sequence si
-000227c0: 7a65 2e20 2229 290a 2020 2020 2020 2020  ze. ")).        
-000227d0: 6176 6f75 6368 2869 7369 6e73 7461 6e63  avouch(isinstanc
-000227e0: 6528 6f74 6865 725f 7370 6163 652c 2074  e(other_space, t
-000227f0: 7570 6c65 2920 616e 6420 6c65 6e28 6f74  uple) and len(ot
-00022800: 6865 725f 7370 6163 6529 203d 3d20 7365  her_space) == se
-00022810: 6c66 2e6e 5f73 7061 6365 5f64 696d 2c20  lf.n_space_dim, 
-00022820: 5479 7065 4572 726f 7228 6622 496e 7661  TypeError(f"Inva
-00022830: 6c69 6420 6f70 6572 6174 696f 6e20 6265  lid operation be
-00022840: 7477 6565 6e20 7b73 656c 667d 2061 6e64  tween {self} and
-00022850: 207b 6f74 6865 727d 3a20 636f 6e66 6c69   {other}: confli
-00022860: 6374 2069 6e20 7370 6163 6520 7369 7a65  ct in space size
-00022870: 2e20 2229 290a 2020 2020 2020 2020 6966  . ")).        if
-00022880: 2073 656c 662e 6861 735f 6675 6e63 3a20   self.has_func: 
-00022890: 7365 6c66 203d 2073 656c 662e 7769 7468  self = self.with
-000228a0: 5f66 756e 6328 6f70 2873 656c 662e 6e5f  _func(op(self.n_
-000228b0: 6675 6e63 2c20 6f74 6865 725f 6675 6e63  func, other_func
-000228c0: 2929 0a20 2020 2020 2020 2069 6620 7365  )).        if se
-000228d0: 6c66 2e68 6173 5f62 6174 6368 3a20 7365  lf.has_batch: se
-000228e0: 6c66 203d 2073 656c 662e 7769 7468 5f62  lf = self.with_b
-000228f0: 6174 6368 286f 7028 7365 6c66 2e6e 5f62  atch(op(self.n_b
-00022900: 6174 6368 2c20 6f74 6865 725f 6261 7463  atch, other_batc
-00022910: 6829 290a 2020 2020 2020 2020 6966 2073  h)).        if s
-00022920: 656c 662e 6861 735f 6665 6174 7572 653a  elf.has_feature:
-00022930: 2073 656c 6620 3d20 7365 6c66 2e77 6974   self = self.wit
-00022940: 685f 6665 6174 7572 6528 7475 706c 6528  h_feature(tuple(
-00022950: 6f70 2878 2c20 7929 2066 6f72 2078 2c20  op(x, y) for x, 
-00022960: 7920 696e 207a 6970 2873 656c 665f 6665  y in zip(self_fe
-00022970: 6174 7572 652c 206f 7468 6572 5f66 6561  ature, other_fea
-00022980: 7475 7265 2929 290a 2020 2020 2020 2020  ture))).        
-00022990: 6966 2073 656c 662e 6861 735f 7365 7175  if self.has_sequ
-000229a0: 656e 6365 3a20 7365 6c66 203d 2073 656c  ence: self = sel
-000229b0: 662e 7769 7468 5f73 6571 7565 6e63 6528  f.with_sequence(
-000229c0: 7475 706c 6528 6f70 2878 2c20 7929 2066  tuple(op(x, y) f
-000229d0: 6f72 2078 2c20 7920 696e 207a 6970 2873  or x, y in zip(s
-000229e0: 656c 665f 7365 7175 656e 6365 2c20 6f74  elf_sequence, ot
-000229f0: 6865 725f 7365 7175 656e 6365 2929 290a  her_sequence))).
-00022a00: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00022a10: 6861 735f 7370 6163 653a 2073 656c 6620  has_space: self 
-00022a20: 3d20 7365 6c66 2e77 6974 685f 7370 6163  = self.with_spac
-00022a30: 6528 7475 706c 6528 6f70 2878 2c20 7929  e(tuple(op(x, y)
-00022a40: 2066 6f72 2078 2c20 7920 696e 207a 6970   for x, y in zip
-00022a50: 2873 656c 665f 7370 6163 652c 206f 7468  (self_space, oth
-00022a60: 6572 5f73 7061 6365 2929 290a 2020 2020  er_space))).    
-00022a70: 2020 2020 7265 7475 726e 2073 656c 660a      return self.
-00022a80: 0a20 2020 2040 616c 6961 7328 275f 5f69  .    @alias('__i
-00022a90: 6c73 6869 6674 5f5f 272c 2027 5f5f 726c  lshift__', '__rl
-00022aa0: 7368 6966 745f 5f27 290a 2020 2020 6465  shift__').    de
-00022ab0: 6620 5f5f 6c73 6869 6674 5f5f 2873 656c  f __lshift__(sel
-00022ac0: 662c 206f 7468 6572 293a 2072 6574 7572  f, other): retur
-00022ad0: 6e20 5369 7a65 2e5f 5f6f 705f 5f28 7365  n Size.__op__(se
-00022ae0: 6c66 2c20 6f74 6865 722c 206f 7065 7261  lf, other, opera
-00022af0: 7469 6f6e 3d6c 616d 6264 6120 782c 2079  tion=lambda x, y
-00022b00: 3a20 7820 2b20 792c 2069 6465 6e74 6974  : x + y, identit
-00022b10: 793d 3029 0a20 2020 2040 616c 6961 7328  y=0).    @alias(
-00022b20: 275f 5f69 7273 6869 6674 5f5f 2729 0a20  '__irshift__'). 
-00022b30: 2020 2064 6566 205f 5f72 7368 6966 745f     def __rshift_
-00022b40: 5f28 7365 6c66 2c20 6f74 6865 7229 3a20  _(self, other): 
-00022b50: 7265 7475 726e 2053 697a 652e 5f5f 6f70  return Size.__op
-00022b60: 5f5f 2873 656c 662c 206f 7468 6572 2c20  __(self, other, 
-00022b70: 6f70 6572 6174 696f 6e3d 6c61 6d62 6461  operation=lambda
-00022b80: 2078 2c20 793a 2078 202d 2079 2c20 6964   x, y: x - y, id
-00022b90: 656e 7469 7479 3d30 290a 2020 2020 6465  entity=0).    de
-00022ba0: 6620 5f5f 7272 7368 6966 745f 5f28 7365  f __rrshift__(se
-00022bb0: 6c66 2c20 6f74 6865 7229 3a20 7265 7475  lf, other): retu
-00022bc0: 726e 2053 697a 652e 5f5f 6f70 5f5f 2873  rn Size.__op__(s
-00022bd0: 656c 662c 206f 7468 6572 2c20 6f70 6572  elf, other, oper
-00022be0: 6174 696f 6e3d 6c61 6d62 6461 2078 2c20  ation=lambda x, 
-00022bf0: 793a 2079 202d 2078 2c20 6964 656e 7469  y: y - x, identi
-00022c00: 7479 3d30 290a 2020 2020 4061 6c69 6173  ty=0).    @alias
-00022c10: 2827 5f5f 6970 6f77 5f5f 272c 2027 5f5f  ('__ipow__', '__
-00022c20: 7270 6f77 5f5f 2729 0a20 2020 2064 6566  rpow__').    def
-00022c30: 205f 5f70 6f77 5f5f 2873 656c 662c 206f   __pow__(self, o
-00022c40: 7468 6572 293a 2072 6574 7572 6e20 5369  ther): return Si
-00022c50: 7a65 2e5f 5f6f 705f 5f28 7365 6c66 2c20  ze.__op__(self, 
-00022c60: 6f74 6865 722c 206f 7065 7261 7469 6f6e  other, operation
-00022c70: 3d6c 616d 6264 6120 782c 2079 3a20 7820  =lambda x, y: x 
-00022c80: 2a20 792c 2069 6465 6e74 6974 793d 3129  * y, identity=1)
-00022c90: 0a20 2020 2040 616c 6961 7328 275f 5f69  .    @alias('__i
-00022ca0: 666c 6f6f 7264 6976 5f5f 2729 0a20 2020  floordiv__').   
-00022cb0: 2064 6566 205f 5f66 6c6f 6f72 6469 765f   def __floordiv_
-00022cc0: 5f28 7365 6c66 2c20 6f74 6865 7229 3a20  _(self, other): 
-00022cd0: 7265 7475 726e 2053 697a 652e 5f5f 6f70  return Size.__op
-00022ce0: 5f5f 2873 656c 662c 206f 7468 6572 2c20  __(self, other, 
-00022cf0: 6f70 6572 6174 696f 6e3d 6c61 6d62 6461  operation=lambda
-00022d00: 2078 2c20 793a 2078 202f 2f20 792c 2069   x, y: x // y, i
-00022d10: 6465 6e74 6974 793d 3129 0a20 2020 2064  dentity=1).    d
-00022d20: 6566 205f 5f72 666c 6f6f 7264 6976 5f5f  ef __rfloordiv__
-00022d30: 2873 656c 662c 206f 7468 6572 293a 2072  (self, other): r
-00022d40: 6574 7572 6e20 5369 7a65 2e5f 5f6f 705f  eturn Size.__op_
-00022d50: 5f28 6f74 6865 722c 2073 656c 662c 206f  _(other, self, o
-00022d60: 7065 7261 7469 6f6e 3d6c 616d 6264 6120  peration=lambda 
-00022d70: 782c 2079 3a20 7920 2f2f 2078 2c20 6964  x, y: y // x, id
-00022d80: 656e 7469 7479 3d31 290a 2020 2020 0a20  entity=1).    . 
-00022d90: 2020 2064 6566 205f 5f78 6f72 5f5f 2873     def __xor__(s
-00022da0: 656c 662c 206f 7468 6572 293a 0a20 2020  elf, other):.   
-00022db0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00022dc0: 2041 205e 2042 2072 6574 7572 6e73 2041   A ^ B returns A
-00022dd0: 5f20 616e 6420 425f 206f 6620 7468 6520  _ and B_ of the 
-00022de0: 7361 6d65 206e 756d 6265 7220 6f66 2064  same number of d
-00022df0: 696d 656e 7369 6f6e 732c 2067 6976 656e  imensions, given
-00022e00: 2074 6861 7420 415f 2068 6173 2074 6865   that A_ has the
-00022e10: 2073 616d 6520 746f 7461 6c20 656c 656d   same total elem
-00022e20: 656e 7420 746f 2041 2061 6e64 2042 5f20  ent to A and B_ 
-00022e30: 6861 7320 7468 6520 7361 6d65 2074 6f74  has the same tot
-00022e40: 616c 2065 6c65 6d65 6e74 2074 6f20 422e  al element to B.
-00022e50: 200a 2020 2020 2020 2020 4f6e 6520 6361   .        One ca
-00022e60: 6e20 6578 7061 6e64 2074 6f20 7465 6e73  n expand to tens
-00022e70: 6f72 7320 6f66 2073 697a 6573 2041 2061  ors of sizes A a
-00022e80: 6e64 2042 2074 6f20 415f 2061 6e64 2042  nd B to A_ and B
-00022e90: 5f20 736f 2074 6861 7420 7079 746f 7263  _ so that pytorc
-00022ea0: 6820 6361 6e20 6561 7369 6c79 2068 616e  h can easily han
-00022eb0: 646c 6520 6361 6c63 756c 6174 696f 6e73  dle calculations
-00022ec0: 2e20 0a20 2020 2020 2020 2022 2222 0a20  . .        """. 
-00022ed0: 2020 2020 2020 2061 766f 7563 6828 6973         avouch(is
-00022ee0: 696e 7374 616e 6365 2873 656c 662c 2053  instance(self, S
-00022ef0: 697a 6529 2061 6e64 2069 7369 6e73 7461  ize) and isinsta
-00022f00: 6e63 6528 6f74 6865 722c 2074 7570 6c65  nce(other, tuple
-00022f10: 292c 2054 7970 6545 7272 6f72 2822 786f  ), TypeError("xo
-00022f20: 7220 666f 7220 6274 2e53 697a 6520 6f6e  r for bt.Size on
-00022f30: 6c79 2061 6363 6570 7420 7477 6f20 7475  ly accept two tu
-00022f40: 706c 6573 2e22 2929 0a20 2020 2020 2020  ples.")).       
-00022f50: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
-00022f60: 6365 286f 7468 6572 2c20 5369 7a65 293a  ce(other, Size):
-00022f70: 206f 7468 6572 203d 2073 656c 662e 5f5f   other = self.__
-00022f80: 636c 6173 735f 5f2e 5f5f 6e65 775f 7261  class__.__new_ra
-00022f90: 775f 5f28 6f74 6865 7229 0a20 2020 2020  w__(other).     
-00022fa0: 2020 2023 2044 6561 6c20 7769 7468 2066     # Deal with f
-00022fb0: 756e 6320 6469 6d65 6e73 696f 6e73 0a20  unc dimensions. 
-00022fc0: 2020 2020 2020 2073 7761 7020 3d20 4661         swap = Fa
-00022fd0: 6c73 6520 2320 7377 6170 2074 6f20 656e  lse # swap to en
-00022fe0: 7375 7265 2074 6861 7420 7661 7269 6162  sure that variab
-00022ff0: 6c65 2027 7365 6c66 2720 6861 7320 6d6f  le 'self' has mo
-00023000: 7265 2061 6e64 2072 6563 6f76 6572 2077  re and recover w
-00023010: 6865 6e20 646f 6e65 0a20 2020 2020 2020  hen done.       
-00023020: 2069 6620 6e6f 7420 7365 6c66 2e68 6173   if not self.has
-00023030: 5f66 756e 6320 616e 6420 6f74 6865 722e  _func and other.
-00023040: 6861 735f 6675 6e63 3a20 7365 6c66 2c20  has_func: self, 
-00023050: 6f74 6865 7220 3d20 6f74 6865 722c 2073  other = other, s
-00023060: 656c 663b 2073 7761 7020 3d20 5472 7565  elf; swap = True
-00023070: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00023080: 2e68 6173 5f66 756e 6320 616e 6420 6e6f  .has_func and no
-00023090: 7420 6f74 6865 722e 6861 735f 6675 6e63  t other.has_func
-000230a0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000230b0: 2073 656c 662e 737a 5f66 756e 635f 6469   self.sz_func_di
-000230c0: 6d20 3e20 303a 206f 7468 6572 203d 2053  m > 0: other = S
-000230d0: 697a 6528 3129 2e77 6974 685f 6675 6e63  ize(1).with_func
-000230e0: 5f64 696d 2854 7275 6529 202b 206f 7468  _dim(True) + oth
-000230f0: 6572 0a20 2020 2020 2020 2020 2020 2065  er.            e
-00023100: 6c73 653a 206f 7468 6572 203d 206f 7468  lse: other = oth
-00023110: 6572 202b 2053 697a 6528 3129 2e77 6974  er + Size(1).wit
-00023120: 685f 6675 6e63 5f64 696d 2854 7275 6529  h_func_dim(True)
-00023130: 0a20 2020 2020 2020 2020 2020 206f 7468  .            oth
-00023140: 6572 2e73 7a5f 6675 6e63 5f64 696d 203d  er.sz_func_dim =
-00023150: 2073 656c 662e 737a 5f66 756e 635f 6469   self.sz_func_di
-00023160: 6d0a 2020 2020 2020 2020 6966 2073 7761  m.        if swa
-00023170: 703a 2073 656c 662c 206f 7468 6572 203d  p: self, other =
-00023180: 206f 7468 6572 2c20 7365 6c66 0a20 2020   other, self.   
-00023190: 2020 2020 2069 6620 7365 6c66 2e68 6173       if self.has
-000231a0: 5f66 756e 6320 616e 6420 6f74 6865 722e  _func and other.
-000231b0: 6861 735f 6675 6e63 3a0a 2020 2020 2020  has_func:.      
-000231c0: 2020 2020 2020 6176 6f75 6368 2873 656c        avouch(sel
-000231d0: 662e 737a 5f66 756e 635f 6469 6d20 2a20  f.sz_func_dim * 
-000231e0: 6f74 6865 722e 737a 5f66 756e 635f 6469  other.sz_func_di
-000231f0: 6d20 3e20 3020 6f72 2073 656c 662e 6e5f  m > 0 or self.n_
-00023200: 6675 6e63 5f64 696d 203d 3d20 7365 6c66  func_dim == self
-00023210: 2e6e 5f64 696d 206f 7220 6f74 6865 722e  .n_dim or other.
-00023220: 6e5f 6675 6e63 5f64 696d 203d 3d20 6f74  n_func_dim == ot
-00023230: 6865 722e 6e5f 6469 6d2c 0a20 2020 2020  her.n_dim,.     
-00023240: 2020 2020 2020 2020 2020 2020 2020 5479                Ty
-00023250: 7065 4572 726f 7228 6622 436f 6e66 6c69  peError(f"Confli
-00023260: 6374 206f 6363 7572 7265 6420 696e 2075  ct occurred in u
-00023270: 6e69 6679 696e 6720 7369 7a65 7320 7b73  nifying sizes {s
-00023280: 656c 667d 2061 6e64 207b 6f74 6865 727d  elf} and {other}
-00023290: 3a20 6d69 736d 6174 6368 6564 206f 7264  : mismatched ord
-000232a0: 6572 2062 6574 7765 656e 2066 756e 6374  er between funct
-000232b0: 696f 6e61 6c20 6469 6d65 6e73 696f 6e20  ional dimension 
-000232c0: 616e 6420 6f74 6865 7273 2e20 2229 290a  and others. ")).
-000232d0: 2020 2020 2020 2020 2320 4465 616c 2077          # Deal w
-000232e0: 6974 6820 6261 7463 6820 6469 6d65 6e73  ith batch dimens
-000232f0: 696f 6e73 0a20 2020 2020 2020 2073 7761  ions.        swa
-00023300: 7020 3d20 4661 6c73 6520 2320 7377 6170  p = False # swap
-00023310: 2074 6f20 656e 7375 7265 2074 6861 7420   to ensure that 
-00023320: 7661 7269 6162 6c65 2027 7365 6c66 2720  variable 'self' 
-00023330: 6861 7320 6d6f 7265 2061 6e64 2072 6563  has more and rec
-00023340: 6f76 6572 2077 6865 6e20 646f 6e65 0a20  over when done. 
-00023350: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-00023360: 6c66 2e68 6173 5f62 6174 6368 2061 6e64  lf.has_batch and
-00023370: 206f 7468 6572 2e68 6173 5f62 6174 6368   other.has_batch
-00023380: 3a20 7365 6c66 2c20 6f74 6865 7220 3d20  : self, other = 
-00023390: 6f74 6865 722c 2073 656c 663b 2073 7761  other, self; swa
-000233a0: 7020 3d20 5472 7565 0a20 2020 2020 2020  p = True.       
-000233b0: 2069 6620 7365 6c66 2e68 6173 5f62 6174   if self.has_bat
-000233c0: 6368 2061 6e64 206e 6f74 206f 7468 6572  ch and not other
-000233d0: 2e68 6173 5f62 6174 6368 3a0a 2020 2020  .has_batch:.    
-000233e0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000233f0: 737a 5f62 6174 6368 5f64 696d 203e 2030  sz_batch_dim > 0
-00023400: 3a20 6f74 6865 7220 3d20 6f74 6865 725b  : other = other[
-00023410: 3a6f 7468 6572 2e73 697a 655f 7374 6172  :other.size_star
-00023420: 745d 202b 2053 697a 6528 7b31 7d29 202b  t] + Size({1}) +
-00023430: 206f 7468 6572 5b6f 7468 6572 2e73 697a   other[other.siz
-00023440: 655f 7374 6172 743a 5d0a 2020 2020 2020  e_start:].      
-00023450: 2020 2020 2020 656c 7365 3a20 6f74 6865        else: othe
-00023460: 7220 3d20 6f74 6865 725b 3a6f 7468 6572  r = other[:other
-00023470: 2e73 697a 655f 7374 6f70 5d20 2b20 5369  .size_stop] + Si
-00023480: 7a65 287b 317d 2920 2b20 6f74 6865 725b  ze({1}) + other[
-00023490: 6f74 6865 722e 7369 7a65 5f73 746f 703a  other.size_stop:
-000234a0: 5d0a 2020 2020 2020 2020 2020 2020 6f74  ].            ot
-000234b0: 6865 722e 737a 5f62 6174 6368 5f64 696d  her.sz_batch_dim
-000234c0: 203d 2073 656c 662e 737a 5f62 6174 6368   = self.sz_batch
-000234d0: 5f64 696d 0a20 2020 2020 2020 2069 6620  _dim.        if 
-000234e0: 7377 6170 3a20 7365 6c66 2c20 6f74 6865  swap: self, othe
-000234f0: 7220 3d20 6f74 6865 722c 2073 656c 660a  r = other, self.
-00023500: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00023510: 6861 735f 6261 7463 6820 616e 6420 6f74  has_batch and ot
-00023520: 6865 722e 6861 735f 6261 7463 683a 0a20  her.has_batch:. 
-00023530: 2020 2020 2020 2020 2020 2061 766f 7563             avouc
-00023540: 6828 7365 6c66 2e73 7a5f 6261 7463 685f  h(self.sz_batch_
-00023550: 6469 6d20 2a20 6f74 6865 722e 737a 5f62  dim * other.sz_b
-00023560: 6174 6368 5f64 696d 203e 2030 206f 7220  atch_dim > 0 or 
-00023570: 7365 6c66 2e6e 5f62 6174 6368 5f64 696d  self.n_batch_dim
-00023580: 203d 3d20 7365 6c66 2e6e 5f64 696d 202d   == self.n_dim -
-00023590: 2073 656c 662e 6e5f 6675 6e63 5f64 696d   self.n_func_dim
-000235a0: 206f 7220 6f74 6865 722e 6e5f 6261 7463   or other.n_batc
-000235b0: 685f 6469 6d20 3d3d 206f 7468 6572 2e6e  h_dim == other.n
-000235c0: 5f64 696d 202d 206f 7468 6572 2e6e 5f66  _dim - other.n_f
-000235d0: 756e 635f 6469 6d2c 0a20 2020 2020 2020  unc_dim,.       
-000235e0: 2020 2020 2020 2020 2020 2020 5479 7065              Type
-000235f0: 4572 726f 7228 6622 436f 6e66 6c69 6374  Error(f"Conflict
-00023600: 206f 6363 7572 7265 6420 696e 2075 6e69   occurred in uni
-00023610: 6679 696e 6720 7369 7a65 7320 7b73 656c  fying sizes {sel
-00023620: 667d 2061 6e64 207b 6f74 6865 727d 3a20  f} and {other}: 
-00023630: 6d69 736d 6174 6368 6564 206f 7264 6572  mismatched order
-00023640: 2062 6574 7765 656e 2062 6174 6368 2064   between batch d
-00023650: 696d 656e 7369 6f6e 2061 6e64 206f 7468  imension and oth
-00023660: 6572 732e 2022 2929 0a20 2020 2020 2020  ers. ")).       
-00023670: 2023 2044 6561 6c20 7769 7468 2066 6561   # Deal with fea
-00023680: 7475 7265 2064 696d 656e 7369 6f6e 730a  ture dimensions.
-00023690: 2020 2020 2020 2020 7377 6170 203d 2046          swap = F
-000236a0: 616c 7365 2023 2073 7761 7020 746f 2065  alse # swap to e
-000236b0: 6e73 7572 6520 7468 6174 2076 6172 6961  nsure that varia
-000236c0: 626c 6520 2773 656c 6627 2068 6173 206d  ble 'self' has m
-000236d0: 6f72 6520 616e 6420 7265 636f 7665 7220  ore and recover 
-000236e0: 7768 656e 2064 6f6e 650a 2020 2020 2020  when done.      
-000236f0: 2020 6966 206e 6f74 2073 656c 662e 6861    if not self.ha
-00023700: 735f 6665 6174 7572 6520 616e 6420 6f74  s_feature and ot
-00023710: 6865 722e 6861 735f 6665 6174 7572 653a  her.has_feature:
-00023720: 2073 656c 662c 206f 7468 6572 203d 206f   self, other = o
-00023730: 7468 6572 2c20 7365 6c66 3b20 7377 6170  ther, self; swap
-00023740: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00023750: 6966 2073 656c 662e 6861 735f 6665 6174  if self.has_feat
-00023760: 7572 6520 616e 6420 6e6f 7420 6f74 6865  ure and not othe
-00023770: 722e 6861 735f 6665 6174 7572 653a 0a20  r.has_feature:. 
-00023780: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00023790: 6c66 2e73 7a5f 6665 6174 7572 655f 6469  lf.sz_feature_di
-000237a0: 6d20 3e20 303a 206f 7468 6572 203d 206f  m > 0: other = o
-000237b0: 7468 6572 5b3a 6f74 6865 722e 6e6f 6e5f  ther[:other.non_
-000237c0: 6261 745f 7374 6172 745d 202b 2053 697a  bat_start] + Siz
-000237d0: 6528 5b31 5d20 2a20 7365 6c66 2e6e 5f66  e([1] * self.n_f
-000237e0: 6561 7475 7265 5f64 696d 2920 2b20 6f74  eature_dim) + ot
-000237f0: 6865 725b 6f74 6865 722e 6e6f 6e5f 6261  her[other.non_ba
-00023800: 745f 7374 6172 743a 5d0a 2020 2020 2020  t_start:].      
-00023810: 2020 2020 2020 656c 7365 3a20 6f74 6865        else: othe
-00023820: 7220 3d20 6f74 6865 725b 3a6f 7468 6572  r = other[:other
-00023830: 2e6e 6f6e 5f62 6174 5f73 746f 705d 202b  .non_bat_stop] +
-00023840: 2053 697a 6528 5b31 5d20 2a20 7365 6c66   Size([1] * self
-00023850: 2e6e 5f66 6561 7475 7265 5f64 696d 2920  .n_feature_dim) 
-00023860: 2b20 6f74 6865 725b 6f74 6865 722e 6e6f  + other[other.no
-00023870: 6e5f 6261 745f 7374 6f70 3a5d 0a20 2020  n_bat_stop:].   
-00023880: 2020 2020 2020 2020 206f 7468 6572 2e73           other.s
-00023890: 7a5f 6665 6174 7572 655f 6469 6d20 3d20  z_feature_dim = 
-000238a0: 7365 6c66 2e73 7a5f 6665 6174 7572 655f  self.sz_feature_
-000238b0: 6469 6d0a 2020 2020 2020 2020 6966 2073  dim.        if s
-000238c0: 7761 703a 2073 656c 662c 206f 7468 6572  wap: self, other
-000238d0: 203d 206f 7468 6572 2c20 7365 6c66 0a20   = other, self. 
-000238e0: 2020 2020 2020 2069 6620 7365 6c66 2e68         if self.h
-000238f0: 6173 5f66 6561 7475 7265 2061 6e64 206f  as_feature and o
-00023900: 7468 6572 2e68 6173 5f66 6561 7475 7265  ther.has_feature
-00023910: 3a0a 2020 2020 2020 2020 2020 2020 6176  :.            av
-00023920: 6f75 6368 2873 656c 662e 737a 5f66 6561  ouch(self.sz_fea
-00023930: 7475 7265 5f64 696d 202a 206f 7468 6572  ture_dim * other
-00023940: 2e73 7a5f 6665 6174 7572 655f 6469 6d20  .sz_feature_dim 
-00023950: 3e20 3020 6f72 2073 656c 662e 6e5f 6665  > 0 or self.n_fe
-00023960: 6174 7572 655f 6469 6d20 3d3d 2073 656c  ature_dim == sel
-00023970: 662e 6e5f 6469 6d20 2d20 7365 6c66 2e6e  f.n_dim - self.n
-00023980: 5f66 756e 635f 6469 6d20 2d20 7365 6c66  _func_dim - self
-00023990: 2e6e 5f62 6174 6368 5f64 696d 206f 7220  .n_batch_dim or 
-000239a0: 6f74 6865 722e 6e5f 6665 6174 7572 655f  other.n_feature_
-000239b0: 6469 6d20 3d3d 206f 7468 6572 2e6e 5f64  dim == other.n_d
-000239c0: 696d 202d 206f 7468 6572 2e6e 5f66 756e  im - other.n_fun
-000239d0: 635f 6469 6d20 2d20 6f74 6865 722e 6e5f  c_dim - other.n_
-000239e0: 6261 7463 685f 6469 6d2c 0a20 2020 2020  batch_dim,.     
-000239f0: 2020 2020 2020 2020 2020 2020 2020 5479                Ty
-00023a00: 7065 4572 726f 7228 6622 436f 6e66 6c69  peError(f"Confli
-00023a10: 6374 206f 6363 7572 7265 6420 696e 2075  ct occurred in u
-00023a20: 6e69 6679 696e 6720 7369 7a65 7320 7b73  nifying sizes {s
-00023a30: 656c 667d 2061 6e64 207b 6f74 6865 727d  elf} and {other}
-00023a40: 3a20 6d69 736d 6174 6368 6564 206f 7264  : mismatched ord
-00023a50: 6572 2062 6574 7765 656e 2066 6561 7475  er between featu
-00023a60: 7265 2064 696d 656e 7369 6f6e 7320 616e  re dimensions an
-00023a70: 6420 7365 7175 656e 6365 2f73 7061 6365  d sequence/space
-00023a80: 2064 696d 656e 7369 6f6e 732e 2022 2929   dimensions. "))
-00023a90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00023aa0: 7365 6c66 2e6e 5f66 6561 7475 7265 5f64  self.n_feature_d
-00023ab0: 696d 203e 206f 7468 6572 2e6e 5f66 6561  im > other.n_fea
-00023ac0: 7475 7265 5f64 696d 3a20 6f74 6865 7220  ture_dim: other 
-00023ad0: 3d20 6f74 6865 722e 7769 7468 5f66 6561  = other.with_fea
-00023ae0: 7475 7265 2828 312c 2920 2a20 2873 656c  ture((1,) * (sel
-00023af0: 662e 6e5f 6665 6174 7572 655f 6469 6d20  f.n_feature_dim 
-00023b00: 2d20 6f74 6865 722e 6e5f 6665 6174 7572  - other.n_featur
-00023b10: 655f 6469 6d29 202b 206f 7468 6572 2e66  e_dim) + other.f
-00023b20: 6561 7475 7265 2e74 7570 6c65 2829 290a  eature.tuple()).
-00023b30: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00023b40: 3a20 7365 6c66 203d 2073 656c 662e 7769  : self = self.wi
-00023b50: 7468 5f66 6561 7475 7265 2828 312c 2920  th_feature((1,) 
-00023b60: 2a20 286f 7468 6572 2e6e 5f66 6561 7475  * (other.n_featu
-00023b70: 7265 5f64 696d 202d 2073 656c 662e 6e5f  re_dim - self.n_
-00023b80: 6665 6174 7572 655f 6469 6d29 202b 2073  feature_dim) + s
-00023b90: 656c 662e 6665 6174 7572 652e 7475 706c  elf.feature.tupl
-00023ba0: 6528 2929 0a20 2020 2020 2020 2023 2044  e()).        # D
-00023bb0: 6561 6c20 7769 7468 2073 6571 7565 6e63  eal with sequenc
-00023bc0: 6520 6469 6d65 6e73 696f 6e73 0a20 2020  e dimensions.   
-00023bd0: 2020 2020 2073 7761 7020 3d20 4661 6c73       swap = Fals
-00023be0: 6520 2320 7377 6170 2074 6f20 656e 7375  e # swap to ensu
-00023bf0: 7265 2074 6861 7420 7661 7269 6162 6c65  re that variable
-00023c00: 2027 7365 6c66 2720 6861 7320 6d6f 7265   'self' has more
-00023c10: 2061 6e64 2072 6563 6f76 6572 2077 6865   and recover whe
-00023c20: 6e20 646f 6e65 0a20 2020 2020 2020 2069  n done.        i
-00023c30: 6620 6e6f 7420 7365 6c66 2e68 6173 5f73  f not self.has_s
-00023c40: 6571 7565 6e63 6520 616e 6420 6f74 6865  equence and othe
-00023c50: 722e 6861 735f 7365 7175 656e 6365 3a20  r.has_sequence: 
-00023c60: 7365 6c66 2c20 6f74 6865 7220 3d20 6f74  self, other = ot
-00023c70: 6865 722c 2073 656c 663b 2073 7761 7020  her, self; swap 
-00023c80: 3d20 5472 7565 0a20 2020 2020 2020 2069  = True.        i
-00023c90: 6620 7365 6c66 2e68 6173 5f73 6571 7565  f self.has_seque
-00023ca0: 6e63 6520 616e 6420 6e6f 7420 6f74 6865  nce and not othe
-00023cb0: 722e 6861 735f 7365 7175 656e 6365 3a0a  r.has_sequence:.
-00023cc0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00023cd0: 656c 662e 737a 5f73 6571 7565 6e63 655f  elf.sz_sequence_
-00023ce0: 6469 6d20 3e20 303a 206f 7468 6572 203d  dim > 0: other =
-00023cf0: 206f 7468 6572 5b3a 6f74 6865 722e 7365   other[:other.se
-00023d00: 715f 7370 635f 7374 6172 745d 202b 2053  q_spc_start] + S
-00023d10: 697a 6528 2827 3127 2c29 202a 2073 656c  ize(('1',) * sel
-00023d20: 662e 6e5f 7365 7175 656e 6365 5f64 696d  f.n_sequence_dim
-00023d30: 2920 2b20 6f74 6865 725b 6f74 6865 722e  ) + other[other.
-00023d40: 7365 715f 7370 635f 7374 6172 743a 5d0a  seq_spc_start:].
-00023d50: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00023d60: 3a20 6f74 6865 7220 3d20 6f74 6865 725b  : other = other[
-00023d70: 3a6f 7468 6572 2e73 6571 5f73 7063 5f73  :other.seq_spc_s
-00023d80: 746f 705d 202b 2053 697a 6528 2827 3127  top] + Size(('1'
-00023d90: 2c29 202a 2073 656c 662e 6e5f 7365 7175  ,) * self.n_sequ
-00023da0: 656e 6365 5f64 696d 2920 2b20 6f74 6865  ence_dim) + othe
-00023db0: 725b 6f74 6865 722e 7365 715f 7370 635f  r[other.seq_spc_
-00023dc0: 7374 6f70 3a5d 0a20 2020 2020 2020 2020  stop:].         
-00023dd0: 2020 206f 7468 6572 2e73 7a5f 7365 7175     other.sz_sequ
-00023de0: 656e 6365 5f64 696d 203d 2073 656c 662e  ence_dim = self.
-00023df0: 737a 5f73 6571 7565 6e63 655f 6469 6d0a  sz_sequence_dim.
-00023e00: 2020 2020 2020 2020 6966 2073 7761 703a          if swap:
-00023e10: 2073 656c 662c 206f 7468 6572 203d 206f   self, other = o
-00023e20: 7468 6572 2c20 7365 6c66 0a20 2020 2020  ther, self.     
-00023e30: 2020 2069 6620 7365 6c66 2e68 6173 5f73     if self.has_s
-00023e40: 6571 7565 6e63 6520 616e 6420 6f74 6865  equence and othe
-00023e50: 722e 6861 735f 7365 7175 656e 6365 3a0a  r.has_sequence:.
-00023e60: 2020 2020 2020 2020 2020 2020 6176 6f75              avou
-00023e70: 6368 2873 656c 662e 737a 5f73 6571 7565  ch(self.sz_seque
-00023e80: 6e63 655f 6469 6d20 2a20 6f74 6865 722e  nce_dim * other.
-00023e90: 737a 5f73 6571 7565 6e63 655f 6469 6d20  sz_sequence_dim 
-00023ea0: 3e20 3020 6f72 2073 656c 662e 6e5f 7365  > 0 or self.n_se
-00023eb0: 7175 656e 6365 5f64 696d 203d 3d20 7365  quence_dim == se
-00023ec0: 6c66 2e6e 5f64 696d 202d 2073 656c 662e  lf.n_dim - self.
-00023ed0: 6e5f 6675 6e63 5f64 696d 202d 2073 656c  n_func_dim - sel
-00023ee0: 662e 6e5f 6261 7463 685f 6469 6d20 2d20  f.n_batch_dim - 
-00023ef0: 7365 6c66 2e6e 5f66 6561 7475 7265 5f64  self.n_feature_d
-00023f00: 696d 206f 7220 6f74 6865 722e 6e5f 7365  im or other.n_se
-00023f10: 7175 656e 6365 5f64 696d 203d 3d20 6f74  quence_dim == ot
-00023f20: 6865 722e 6e5f 6469 6d20 2d20 6f74 6865  her.n_dim - othe
-00023f30: 722e 6e5f 6675 6e63 5f64 696d 202d 206f  r.n_func_dim - o
-00023f40: 7468 6572 2e6e 5f62 6174 6368 5f64 696d  ther.n_batch_dim
-00023f50: 202d 2073 656c 662e 6e5f 6665 6174 7572   - self.n_featur
-00023f60: 655f 6469 6d2c 0a20 2020 2020 2020 2020  e_dim,.         
-00023f70: 2020 2020 2020 2020 2020 5479 7065 4572            TypeEr
-00023f80: 726f 7228 6622 436f 6e66 6c69 6374 206f  ror(f"Conflict o
-00023f90: 6363 7572 7265 6420 696e 2075 6e69 6679  ccurred in unify
-00023fa0: 696e 6720 7369 7a65 7320 7b73 656c 667d  ing sizes {self}
-00023fb0: 2061 6e64 207b 6f74 6865 727d 3a20 6d69   and {other}: mi
-00023fc0: 736d 6174 6368 6564 206f 7264 6572 2062  smatched order b
-00023fd0: 6574 7765 656e 2073 6571 7565 6e63 6520  etween sequence 
-00023fe0: 6469 6d65 6e73 696f 6e73 2061 6e64 2073  dimensions and s
-00023ff0: 7061 6365 2064 696d 656e 7369 6f6e 732e  pace dimensions.
-00024000: 2022 2929 0a20 2020 2020 2020 2020 2020   ")).           
-00024010: 2069 6620 7365 6c66 2e6e 5f73 6571 7565   if self.n_seque
-00024020: 6e63 655f 6469 6d20 3e20 6f74 6865 722e  nce_dim > other.
-00024030: 6e5f 7365 7175 656e 6365 5f64 696d 3a20  n_sequence_dim: 
-00024040: 6f74 6865 7220 3d20 6f74 6865 722e 7769  other = other.wi
-00024050: 7468 5f73 6571 7565 6e63 6528 2831 2c29  th_sequence((1,)
-00024060: 202a 2028 7365 6c66 2e6e 5f73 6571 7565   * (self.n_seque
-00024070: 6e63 655f 6469 6d20 2d20 6f74 6865 722e  nce_dim - other.
-00024080: 6e5f 7365 7175 656e 6365 5f64 696d 2920  n_sequence_dim) 
-00024090: 2b20 6f74 6865 722e 7365 7175 656e 6365  + other.sequence
-000240a0: 2e74 7570 6c65 2829 290a 2020 2020 2020  .tuple()).      
-000240b0: 2020 2020 2020 656c 7365 3a20 7365 6c66        else: self
-000240c0: 203d 2073 656c 662e 7769 7468 5f73 6571   = self.with_seq
-000240d0: 7565 6e63 6528 2831 2c29 202a 2028 6f74  uence((1,) * (ot
-000240e0: 6865 722e 6e5f 7365 7175 656e 6365 5f64  her.n_sequence_d
-000240f0: 696d 202d 2073 656c 662e 6e5f 7365 7175  im - self.n_sequ
-00024100: 656e 6365 5f64 696d 2920 2b20 7365 6c66  ence_dim) + self
-00024110: 2e73 6571 7565 6e63 652e 7475 706c 6528  .sequence.tuple(
-00024120: 2929 0a20 2020 2020 2020 2023 2044 6561  )).        # Dea
-00024130: 6c20 7769 7468 2073 7061 6365 2064 696d  l with space dim
-00024140: 656e 7369 6f6e 730a 2020 2020 2020 2020  ensions.        
-00024150: 7377 6170 203d 2046 616c 7365 2023 2073  swap = False # s
-00024160: 7761 7020 746f 2065 6e73 7572 6520 7468  wap to ensure th
-00024170: 6174 2076 6172 6961 626c 6520 2773 656c  at variable 'sel
-00024180: 6627 2068 6173 206d 6f72 6520 616e 6420  f' has more and 
-00024190: 7265 636f 7665 7220 7768 656e 2064 6f6e  recover when don
-000241a0: 650a 2020 2020 2020 2020 6966 206e 6f74  e.        if not
-000241b0: 2073 656c 662e 6861 735f 7370 6163 6520   self.has_space 
-000241c0: 616e 6420 6f74 6865 722e 6861 735f 7370  and other.has_sp
-000241d0: 6163 653a 2073 656c 662c 206f 7468 6572  ace: self, other
-000241e0: 203d 206f 7468 6572 2c20 7365 6c66 3b20   = other, self; 
-000241f0: 7377 6170 203d 2054 7275 650a 2020 2020  swap = True.    
-00024200: 2020 2020 6966 2073 656c 662e 6861 735f      if self.has_
-00024210: 7370 6163 6520 616e 6420 6e6f 7420 6f74  space and not ot
-00024220: 6865 722e 6861 735f 7370 6163 653a 0a20  her.has_space:. 
-00024230: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00024240: 6c66 2e73 7a5f 7365 7175 656e 6365 5f64  lf.sz_sequence_d
-00024250: 696d 202a 206f 7468 6572 2e73 7a5f 7365  im * other.sz_se
-00024260: 7175 656e 6365 5f64 696d 203c 2030 3a20  quence_dim < 0: 
-00024270: 6f74 6865 722e 737a 5f73 6571 7565 6e63  other.sz_sequenc
-00024280: 655f 6469 6d20 3d20 7365 6c66 2e73 7a5f  e_dim = self.sz_
-00024290: 7365 7175 656e 6365 5f64 696d 0a20 2020  sequence_dim.   
-000242a0: 2020 2020 2020 2020 2065 6c69 6620 6f74           elif ot
-000242b0: 6865 722e 737a 5f73 6571 7565 6e63 655f  her.sz_sequence_
-000242c0: 6469 6d20 3d3d 2030 3a0a 2020 2020 2020  dim == 0:.      
-000242d0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-000242e0: 662e 737a 5f66 6561 7475 7265 5f64 696d  f.sz_feature_dim
-000242f0: 202a 206f 7468 6572 2e73 7a5f 6665 6174   * other.sz_feat
-00024300: 7572 655f 6469 6d20 3c20 303a 206f 7468  ure_dim < 0: oth
-00024310: 6572 2e73 7a5f 6665 6174 7572 655f 6469  er.sz_feature_di
-00024320: 6d20 3d20 7365 6c66 2e73 7a5f 6665 6174  m = self.sz_feat
-00024330: 7572 655f 6469 6d0a 2020 2020 2020 2020  ure_dim.        
-00024340: 2020 2020 2020 2020 656c 6966 206f 7468          elif oth
-00024350: 6572 2e73 7a5f 6665 6174 7572 655f 6469  er.sz_feature_di
-00024360: 6d20 3d3d 2030 3a0a 2020 2020 2020 2020  m == 0:.        
-00024370: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00024380: 656c 662e 737a 5f62 6174 6368 5f64 696d  elf.sz_batch_dim
-00024390: 202a 206f 7468 6572 2e73 7a5f 6261 7463   * other.sz_batc
-000243a0: 685f 6469 6d20 3c20 303a 206f 7468 6572  h_dim < 0: other
-000243b0: 2e73 7a5f 6261 7463 685f 6469 6d20 3d20  .sz_batch_dim = 
-000243c0: 7365 6c66 2e73 7a5f 6261 7463 685f 6469  self.sz_batch_di
-000243d0: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
-000243e0: 2020 2020 2020 656c 6966 206f 7468 6572        elif other
-000243f0: 2e73 7a5f 6261 7463 685f 6469 6d20 3d3d  .sz_batch_dim ==
-00024400: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00024410: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00024420: 656c 662e 737a 5f66 756e 635f 6469 6d20  elf.sz_func_dim 
-00024430: 2a20 6f74 6865 722e 737a 5f66 756e 635f  * other.sz_func_
-00024440: 6469 6d20 3c20 303a 0a20 2020 2020 2020  dim < 0:.       
-00024450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024460: 2020 2020 206f 7468 6572 2e73 7a5f 6675       other.sz_fu
-00024470: 6e63 5f64 696d 203d 2073 656c 662e 737a  nc_dim = self.sz
-00024480: 5f66 756e 635f 6469 6d0a 2020 2020 2020  _func_dim.      
-00024490: 2020 2020 2020 6f74 6865 7220 3d20 6f74        other = ot
-000244a0: 6865 725b 3a6f 7468 6572 2e73 7061 6365  her[:other.space
-000244b0: 5f73 7461 7274 5d20 2b20 5369 7a65 2828  _start] + Size((
-000244c0: 312c 2920 2a20 7365 6c66 2e6e 5f73 7061  1,) * self.n_spa
-000244d0: 6365 5f64 696d 2920 2b20 6f74 6865 725b  ce_dim) + other[
-000244e0: 6f74 6865 722e 7370 6163 655f 7374 6172  other.space_star
-000244f0: 743a 5d0a 2020 2020 2020 2020 6966 2073  t:].        if s
-00024500: 7761 703a 2073 656c 662c 206f 7468 6572  wap: self, other
-00024510: 203d 206f 7468 6572 2c20 7365 6c66 0a20   = other, self. 
-00024520: 2020 2020 2020 2069 6620 7365 6c66 2e68         if self.h
-00024530: 6173 5f73 7061 6365 2061 6e64 206f 7468  as_space and oth
-00024540: 6572 2e68 6173 5f73 7061 6365 3a0a 2020  er.has_space:.  
-00024550: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00024560: 662e 6e5f 7370 6163 655f 6469 6d20 3e20  f.n_space_dim > 
-00024570: 6f74 6865 722e 6e5f 7370 6163 655f 6469  other.n_space_di
-00024580: 6d3a 206f 7468 6572 203d 206f 7468 6572  m: other = other
-00024590: 2e77 6974 685f 7370 6163 6528 2831 2c29  .with_space((1,)
-000245a0: 202a 2028 7365 6c66 2e6e 5f73 7061 6365   * (self.n_space
-000245b0: 5f64 696d 202d 206f 7468 6572 2e6e 5f73  _dim - other.n_s
-000245c0: 7061 6365 5f64 696d 2920 2b20 6f74 6865  pace_dim) + othe
-000245d0: 722e 7370 6163 652e 7475 706c 6528 2929  r.space.tuple())
-000245e0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-000245f0: 653a 2073 656c 6620 3d20 7365 6c66 2e77  e: self = self.w
-00024600: 6974 685f 7370 6163 6528 2831 2c29 202a  ith_space((1,) *
-00024610: 2028 6f74 6865 722e 6e5f 7370 6163 655f   (other.n_space_
-00024620: 6469 6d20 2d20 7365 6c66 2e6e 5f73 7061  dim - self.n_spa
-00024630: 6365 5f64 696d 2920 2b20 7365 6c66 2e73  ce_dim) + self.s
-00024640: 7061 6365 2e74 7570 6c65 2829 290a 2020  pace.tuple()).  
-00024650: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00024660: 662c 206f 7468 6572 0a20 2020 200a 6675  f, other.    .fu
-00024670: 6e63 5f64 696d 5f73 697a 6520 3d20 6c61  nc_dim_size = la
-00024680: 6d62 6461 2069 3a20 5369 7a65 2e5f 5f6e  mbda i: Size.__n
-00024690: 6577 5f72 6177 5f5f 2828 692c 292c 2073  ew_raw__((i,), s
-000246a0: 7a5f 6675 6e63 5f64 696d 3d31 290a 6675  z_func_dim=1).fu
-000246b0: 6e63 5f64 696d 203d 2066 756e 635f 6469  nc_dim = func_di
-000246c0: 6d5f 7369 7a65 2831 290a 2020 2020 0a63  m_size(1).    .c
-000246d0: 6c61 7373 2046 616b 6553 697a 6528 7475  lass FakeSize(tu
-000246e0: 706c 6529 3a0a 2020 2020 6465 6620 5f5f  ple):.    def __
-000246f0: 6e65 775f 5f28 636c 732c 2072 6177 5f74  new__(cls, raw_t
-00024700: 7570 6c65 2c20 737a 5f66 756e 635f 6469  uple, sz_func_di
-00024710: 6d20 3d20 302c 2073 7a5f 6261 7463 685f  m = 0, sz_batch_
-00024720: 6469 6d20 3d20 302c 2073 7a5f 6665 6174  dim = 0, sz_feat
-00024730: 7572 655f 6469 6d20 3d20 302c 2073 7a5f  ure_dim = 0, sz_
-00024740: 7365 7175 656e 6365 5f64 696d 203d 2030  sequence_dim = 0
-00024750: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-00024760: 2020 2020 2020 2043 7265 6174 6520 6120         Create a 
-00024770: 4661 6b65 5369 7a65 2077 6974 686f 7574  FakeSize without
-00024780: 206e 5f64 696d 2061 6e64 2063 6865 636b   n_dim and check
-00024790: 7320 696e 766f 6c76 696e 6720 6e5f 6469  s involving n_di
-000247a0: 6d20 616e 6420 7370 6563 6961 6c2d 6469  m and special-di
-000247b0: 6d20 636f 6e66 6c69 6374 732e 200a 2020  m conflicts. .  
-000247c0: 2020 2020 2020 5448 4953 2049 5320 5052        THIS IS PR
-000247d0: 4956 4154 4520 464f 5220 4261 546f 7263  IVATE FOR BaTorc
-000247e0: 6820 322e 302c 2070 6c65 6173 6520 646f  h 2.0, please do
-000247f0: 6e6f 7420 7573 6520 7468 6973 2069 6620  not use this if 
-00024800: 796f 7520 6172 6520 6e6f 7420 6661 6d69  you are not fami
-00024810: 6c69 6172 2077 6974 6820 6973 2e20 0a20  liar with is. . 
-00024820: 2020 2020 2020 2054 6869 7320 6973 2064         This is d
-00024830: 6573 6967 6e65 6420 696e 2074 6865 2066  esigned in the f
-00024840: 6972 7374 2070 6c61 6365 2066 6f72 2074  irst place for t
-00024850: 6865 2064 696d 656e 7369 6f6e 206d 616e  he dimension man
-00024860: 6970 756c 6174 696f 6e73 2077 6974 6820  ipulations with 
-00024870: 6120 7475 706c 6520 6f66 200a 2020 2020  a tuple of .    
-00024880: 2020 2020 2020 2020 696e 7465 6765 7273          integers
-00024890: 2069 7320 7072 6f76 6964 6564 2061 6c6f   is provided alo
-000248a0: 6e67 2077 6974 6820 7370 6563 6961 6c20  ng with special 
-000248b0: 6469 6d65 6e73 696f 6e20 696e 666f 726d  dimension inform
-000248c0: 6174 696f 6e2e 200a 2020 2020 2020 2020  ation. .        
-000248d0: 0a20 2020 2020 2020 2045 7861 6d70 6c65  .        Example
-000248e0: 733a 3a0a 2020 2020 2020 2020 2020 2020  s::.            
-000248f0: 3e3e 3e20 6274 2e53 697a 6528 322c 332c  >>> bt.Size(2,3,
-00024900: 3429 2e73 7065 6369 616c 5f66 726f 6d28  4).special_from(
-00024910: 6274 2e46 616b 6553 697a 6528 2831 302c  bt.FakeSize((10,
-00024920: 2031 3029 2c20 737a 5f62 6174 6368 5f64   10), sz_batch_d
-00024930: 696d 3d31 2929 0a20 2020 2020 2020 2020  im=1)).         
-00024940: 2020 2062 6174 6f72 6368 2e53 697a 6528     batorch.Size(
-00024950: 7b32 7d2c 2033 2c20 3429 0a20 2020 2020  {2}, 3, 4).     
-00024960: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-00024970: 6620 7261 775f 7475 706c 6520 6973 204e  f raw_tuple is N
-00024980: 6f6e 653a 2072 6574 7572 6e20 4e6f 6e65  one: return None
-00024990: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-000249a0: 7374 616e 6365 2872 6177 5f74 7570 6c65  stance(raw_tuple
-000249b0: 2c20 5369 7a65 293a 0a20 2020 2020 2020  , Size):.       
-000249c0: 2020 2020 2073 656c 6620 3d20 7375 7065       self = supe
-000249d0: 7228 292e 5f5f 6e65 775f 5f28 636c 732c  r().__new__(cls,
-000249e0: 2072 6177 5f74 7570 6c65 2e74 7570 6c65   raw_tuple.tuple
-000249f0: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
-00024a00: 7365 6c66 2e73 7a5f 6675 6e63 5f64 696d  self.sz_func_dim
-00024a10: 203d 2072 6177 5f74 7570 6c65 2e73 7a5f   = raw_tuple.sz_
-00024a20: 6675 6e63 5f64 696d 0a20 2020 2020 2020  func_dim.       
-00024a30: 2020 2020 2073 656c 662e 737a 5f62 6174       self.sz_bat
-00024a40: 6368 5f64 696d 203d 2072 6177 5f74 7570  ch_dim = raw_tup
-00024a50: 6c65 2e73 7a5f 6261 7463 685f 6469 6d0a  le.sz_batch_dim.
-00024a60: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00024a70: 2e73 7a5f 6665 6174 7572 655f 6469 6d20  .sz_feature_dim 
-00024a80: 3d20 7261 775f 7475 706c 652e 737a 5f66  = raw_tuple.sz_f
-00024a90: 6561 7475 7265 5f64 696d 0a20 2020 2020  eature_dim.     
-00024aa0: 2020 2020 2020 2073 656c 662e 737a 5f73         self.sz_s
-00024ab0: 6571 7565 6e63 655f 6469 6d20 3d20 7261  equence_dim = ra
-00024ac0: 775f 7475 706c 652e 737a 5f73 6571 7565  w_tuple.sz_seque
-00024ad0: 6e63 655f 6469 6d0a 2020 2020 2020 2020  nce_dim.        
-00024ae0: 2020 2020 7265 7475 726e 2073 656c 660a      return self.
-00024af0: 2020 2020 2020 2020 7365 6c66 203d 2073          self = s
-00024b00: 7570 6572 2829 2e5f 5f6e 6577 5f5f 2863  uper().__new__(c
-00024b10: 6c73 2c20 7261 775f 7475 706c 6529 0a20  ls, raw_tuple). 
-00024b20: 2020 2020 2020 2073 656c 662e 737a 5f66         self.sz_f
-00024b30: 756e 635f 6469 6d20 3d20 737a 5f66 756e  unc_dim = sz_fun
-00024b40: 635f 6469 6d0a 2020 2020 2020 2020 7365  c_dim.        se
-00024b50: 6c66 2e73 7a5f 6261 7463 685f 6469 6d20  lf.sz_batch_dim 
-00024b60: 3d20 737a 5f62 6174 6368 5f64 696d 0a20  = sz_batch_dim. 
-00024b70: 2020 2020 2020 2073 656c 662e 737a 5f66         self.sz_f
-00024b80: 6561 7475 7265 5f64 696d 203d 2073 7a5f  eature_dim = sz_
-00024b90: 6665 6174 7572 655f 6469 6d0a 2020 2020  feature_dim.    
-00024ba0: 2020 2020 7365 6c66 2e73 7a5f 7365 7175      self.sz_sequ
-00024bb0: 656e 6365 5f64 696d 203d 2073 7a5f 7365  ence_dim = sz_se
-00024bc0: 7175 656e 6365 5f64 696d 0a20 2020 2020  quence_dim.     
-00024bd0: 2020 2072 6574 7572 6e20 7365 6c66 0a20     return self. 
-00024be0: 2020 2064 6566 205f 5f72 6570 725f 5f28     def __repr__(
-00024bf0: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
-00024c00: 6574 7572 6e20 2746 616b 6553 697a 6527  eturn 'FakeSize'
-00024c10: 202b 2073 7570 6572 2829 2e5f 5f72 6570   + super().__rep
-00024c20: 725f 5f28 292e 7273 7472 6970 2827 2c29  r__().rstrip(',)
-00024c30: 2729 202b 2066 222c 2073 7a5f 6675 6e63  ') + f", sz_func
-00024c40: 5f64 696d 3d7b 7365 6c66 2e73 7a5f 6675  _dim={self.sz_fu
-00024c50: 6e63 5f64 696d 7d2c 2073 7a5f 6261 7463  nc_dim}, sz_batc
-00024c60: 685f 6469 6d3d 7b73 656c 662e 737a 5f62  h_dim={self.sz_b
-00024c70: 6174 6368 5f64 696d 7d2c 2073 7a5f 6665  atch_dim}, sz_fe
-00024c80: 6174 7572 655f 6469 6d3d 7b73 656c 662e  ature_dim={self.
-00024c90: 737a 5f66 6561 7475 7265 5f64 696d 7d2c  sz_feature_dim},
-00024ca0: 2073 7a5f 7365 7175 656e 6365 5f64 696d   sz_sequence_dim
-00024cb0: 3d7b 7365 6c66 2e73 7a5f 7365 7175 656e  ={self.sz_sequen
-00024cc0: 6365 5f64 696d 7d29 220a 2020 2020 6465  ce_dim})".    de
-00024cd0: 6620 5f5f 6765 7469 7465 6d5f 5f28 7365  f __getitem__(se
-00024ce0: 6c66 2c20 2a61 7267 7329 3a0a 2020 2020  lf, *args):.    
-00024cf0: 2020 2020 6966 206c 656e 2861 7267 7329      if len(args)
-00024d00: 203d 3d20 3120 616e 6420 6973 696e 7374   == 1 and isinst
-00024d10: 616e 6365 2861 7267 735b 305d 2c20 696e  ance(args[0], in
-00024d20: 745f 293a 2072 6574 7572 6e20 7375 7065  t_): return supe
-00024d30: 7228 292e 5f5f 6765 7469 7465 6d5f 5f28  r().__getitem__(
-00024d40: 2a61 7267 7329 0a20 2020 2020 2020 2072  *args).        r
-00024d50: 6574 7572 6e20 4661 6b65 5369 7a65 2873  eturn FakeSize(s
-00024d60: 7570 6572 2829 2e5f 5f67 6574 6974 656d  uper().__getitem
-00024d70: 5f5f 282a 6172 6773 292c 2073 7a5f 6675  __(*args), sz_fu
-00024d80: 6e63 5f64 696d 203d 2073 656c 662e 737a  nc_dim = self.sz
-00024d90: 5f66 756e 635f 6469 6d2c 2073 7a5f 6261  _func_dim, sz_ba
-00024da0: 7463 685f 6469 6d20 3d20 7365 6c66 2e73  tch_dim = self.s
-00024db0: 7a5f 6261 7463 685f 6469 6d2c 2073 7a5f  z_batch_dim, sz_
-00024dc0: 6665 6174 7572 655f 6469 6d20 3d20 7365  feature_dim = se
-00024dd0: 6c66 2e73 7a5f 6665 6174 7572 655f 6469  lf.sz_feature_di
-00024de0: 6d2c 2073 7a5f 7365 7175 656e 6365 5f64  m, sz_sequence_d
-00024df0: 696d 203d 2073 656c 662e 737a 5f73 6571  im = self.sz_seq
-00024e00: 7565 6e63 655f 6469 6d29 0a20 2020 2040  uence_dim).    @
-00024e10: 616c 6961 7328 275f 5f69 6164 645f 5f27  alias('__iadd__'
-00024e20: 290a 2020 2020 6465 6620 5f5f 6164 645f  ).    def __add_
-00024e30: 5f28 7365 6c66 2c20 6f74 6865 7229 3a0a  _(self, other):.
-00024e40: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-00024e50: 616b 6553 697a 6528 7375 7065 7228 292e  akeSize(super().
-00024e60: 5f5f 6164 645f 5f28 7475 706c 6528 6f74  __add__(tuple(ot
-00024e70: 6865 7229 292c 2073 7a5f 6675 6e63 5f64  her)), sz_func_d
-00024e80: 696d 203d 2073 656c 662e 737a 5f66 756e  im = self.sz_fun
-00024e90: 635f 6469 6d2c 2073 7a5f 6261 7463 685f  c_dim, sz_batch_
-00024ea0: 6469 6d20 3d20 7365 6c66 2e73 7a5f 6261  dim = self.sz_ba
-00024eb0: 7463 685f 6469 6d2c 2073 7a5f 6665 6174  tch_dim, sz_feat
-00024ec0: 7572 655f 6469 6d20 3d20 7365 6c66 2e73  ure_dim = self.s
-00024ed0: 7a5f 6665 6174 7572 655f 6469 6d2c 2073  z_feature_dim, s
-00024ee0: 7a5f 7365 7175 656e 6365 5f64 696d 203d  z_sequence_dim =
-00024ef0: 2073 656c 662e 737a 5f73 6571 7565 6e63   self.sz_sequenc
-00024f00: 655f 6469 6d29 0a20 2020 2064 6566 205f  e_dim).    def _
-00024f10: 5f72 6164 645f 5f28 7365 6c66 2c20 6f74  _radd__(self, ot
-00024f20: 6865 7229 3a0a 2020 2020 2020 2020 7265  her):.        re
-00024f30: 7475 726e 2046 616b 6553 697a 6528 7475  turn FakeSize(tu
-00024f40: 706c 6528 6f74 6865 7229 202b 2074 7570  ple(other) + tup
-00024f50: 6c65 2873 656c 6629 2c20 0a20 2020 2020  le(self), .     
-00024f60: 2020 2020 2020 2073 7a5f 6675 6e63 5f64         sz_func_d
-00024f70: 696d 203d 2067 6574 6174 7472 286f 7468  im = getattr(oth
-00024f80: 6572 2c20 2773 7a5f 6675 6e63 5f64 696d  er, 'sz_func_dim
-00024f90: 272c 2073 656c 662e 737a 5f66 756e 635f  ', self.sz_func_
-00024fa0: 6469 6d29 2c20 0a20 2020 2020 2020 2020  dim), .         
-00024fb0: 2020 2073 7a5f 6261 7463 685f 6469 6d20     sz_batch_dim 
-00024fc0: 3d20 6765 7461 7474 7228 6f74 6865 722c  = getattr(other,
-00024fd0: 2027 737a 5f62 6174 6368 5f64 696d 272c   'sz_batch_dim',
-00024fe0: 2073 656c 662e 737a 5f62 6174 6368 5f64   self.sz_batch_d
-00024ff0: 696d 292c 200a 2020 2020 2020 2020 2020  im), .          
-00025000: 2020 737a 5f66 6561 7475 7265 5f64 696d    sz_feature_dim
-00025010: 203d 2067 6574 6174 7472 286f 7468 6572   = getattr(other
-00025020: 2c20 2773 7a5f 6665 6174 7572 655f 6469  , 'sz_feature_di
-00025030: 6d27 2c20 7365 6c66 2e73 7a5f 6665 6174  m', self.sz_feat
-00025040: 7572 655f 6469 6d29 2c20 0a20 2020 2020  ure_dim), .     
-00025050: 2020 2020 2020 2073 7a5f 7365 7175 656e         sz_sequen
-00025060: 6365 5f64 696d 203d 2067 6574 6174 7472  ce_dim = getattr
-00025070: 286f 7468 6572 2c20 2773 7a5f 7365 7175  (other, 'sz_sequ
-00025080: 656e 6365 5f64 696d 272c 2073 656c 662e  ence_dim', self.
-00025090: 737a 5f73 6571 7565 6e63 655f 6469 6d29  sz_sequence_dim)
-000250a0: 0a20 2020 2020 2020 2029 0a0a 6465 6620  .        )..def 
-000250b0: 6272 6f61 6463 6173 7428 2a73 697a 6573  broadcast(*sizes
-000250c0: 2c20 7769 7468 5f73 697a 655f 7570 6461  , with_size_upda
-000250d0: 7465 733d 4661 6c73 6529 3a0a 2020 2020  tes=False):.    
-000250e0: 6966 206c 656e 2873 697a 6573 2920 3d3d  if len(sizes) ==
-000250f0: 2030 3a0a 2020 2020 2020 2020 6272 6f61   0:.        broa
-00025100: 6463 6173 7465 6420 3d20 5369 7a65 2829  dcasted = Size()
-00025110: 0a20 2020 2020 2020 2069 6620 7769 7468  .        if with
-00025120: 5f73 697a 655f 7570 6461 7465 733a 2062  _size_updates: b
-00025130: 726f 6164 6361 7374 6564 2e75 7064 6174  roadcasted.updat
-00025140: 6564 5f73 697a 6573 203d 205b 5d0a 2020  ed_sizes = [].  
-00025150: 2020 656c 6966 206c 656e 2873 697a 6573    elif len(sizes
-00025160: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
-00025170: 6272 6f61 6463 6173 7465 6420 3d20 7369  broadcasted = si
-00025180: 7a65 735b 305d 0a20 2020 2020 2020 2069  zes[0].        i
-00025190: 6620 7769 7468 5f73 697a 655f 7570 6461  f with_size_upda
-000251a0: 7465 733a 2062 726f 6164 6361 7374 6564  tes: broadcasted
-000251b0: 2e75 7064 6174 6564 5f73 697a 6573 203d  .updated_sizes =
-000251c0: 205b 7369 7a65 735b 305d 5d0a 2020 2020   [sizes[0]].    
-000251d0: 656c 7365 3a0a 2020 2020 2020 2020 782c  else:.        x,
-000251e0: 2079 203d 2073 697a 6573 5b30 5d20 5e20   y = sizes[0] ^ 
-000251f0: 7369 7a65 735b 315d 0a20 2020 2020 2020  sizes[1].       
-00025200: 2062 726f 6164 6361 7374 6564 203d 2053   broadcasted = S
-00025210: 697a 6528 6d61 785f 2875 2c20 7629 2066  ize(max_(u, v) f
-00025220: 6f72 2075 2c20 7620 696e 207a 6970 2878  or u, v in zip(x
-00025230: 2c20 7929 292e 7370 6563 6961 6c5f 6672  , y)).special_fr
-00025240: 6f6d 2879 290a 2020 2020 2020 2020 7570  om(y).        up
-00025250: 6461 7465 645f 7369 7a65 7320 3d20 5b78  dated_sizes = [x
-00025260: 2c20 795d 0a20 2020 2020 2020 2066 6f72  , y].        for
-00025270: 207a 2069 6e20 7369 7a65 735b 323a 5d3a   z in sizes[2:]:
-00025280: 0a20 2020 2020 2020 2020 2020 2078 2c20  .            x, 
-00025290: 7920 3d20 6272 6f61 6463 6173 7465 6420  y = broadcasted 
-000252a0: 5e20 7a0a 2020 2020 2020 2020 2020 2020  ^ z.            
-000252b0: 6272 6f61 6463 6173 7465 6420 3d20 5369  broadcasted = Si
-000252c0: 7a65 286d 6178 5f28 752c 2076 2920 666f  ze(max_(u, v) fo
-000252d0: 7220 752c 2076 2069 6e20 7a69 7028 782c  r u, v in zip(x,
-000252e0: 2079 2929 2e73 7065 6369 616c 5f66 726f   y)).special_fro
-000252f0: 6d28 7929 0a20 2020 2020 2020 2020 2020  m(y).           
-00025300: 2075 7064 6174 6564 5f73 697a 6573 2e61   updated_sizes.a
-00025310: 7070 656e 6428 7929 0a20 2020 2020 2020  ppend(y).       
-00025320: 2069 6620 7769 7468 5f73 697a 655f 7570   if with_size_up
-00025330: 6461 7465 733a 2062 726f 6164 6361 7374  dates: broadcast
-00025340: 6564 2e75 7064 6174 6564 5f73 697a 6573  ed.updated_sizes
-00025350: 203d 2075 7064 6174 6564 5f73 697a 6573   = updated_sizes
-00025360: 0a20 2020 2072 6574 7572 6e20 6272 6f61  .    return broa
-00025370: 6463 6173 7465 640a 0a64 6566 2072 656d  dcasted..def rem
-00025380: 6f76 655f 6469 6d28 7369 7a65 2c20 6c69  ove_dim(size, li
-00025390: 7374 5f6f 665f 7265 6d6f 7661 6c73 293a  st_of_removals):
-000253a0: 0a20 2020 2069 6620 6e6f 7420 6973 696e  .    if not isin
-000253b0: 7374 616e 6365 286c 6973 745f 6f66 5f72  stance(list_of_r
-000253c0: 656d 6f76 616c 732c 206c 6973 7429 3a20  emovals, list): 
-000253d0: 6c69 7374 5f6f 665f 7265 6d6f 7661 6c73  list_of_removals
-000253e0: 203d 206c 6973 7428 6c69 7374 5f6f 665f   = list(list_of_
-000253f0: 7265 6d6f 7661 6c73 290a 2020 2020 6c69  removals).    li
-00025400: 7374 5f6f 665f 7265 6d6f 7661 6c73 2e73  st_of_removals.s
-00025410: 6f72 7428 290a 2020 2020 7265 7475 726e  ort().    return
-00025420: 2073 756d 5f28 5b73 697a 655b 736c 6963   sum_([size[slic
-00025430: 6528 7820 2b20 312c 2079 295d 2066 6f72  e(x + 1, y)] for
-00025440: 2078 2c20 7920 696e 207a 6970 285b 2d31   x, y in zip([-1
-00025450: 5d20 2b20 6c69 7374 5f6f 665f 7265 6d6f  ] + list_of_remo
-00025460: 7661 6c73 2c20 6c69 7374 5f6f 665f 7265  vals, list_of_re
-00025470: 6d6f 7661 6c73 202b 205b 4e6f 6e65 5d29  movals + [None])
-00025480: 5d2c 2053 697a 6528 2929 0a0a 6465 6620  ], Size())..def 
-00025490: 6164 645f 6469 6d28 7369 7a65 2c20 6c69  add_dim(size, li
-000254a0: 7374 5f6f 665f 6164 6473 293a 0a20 2020  st_of_adds):.   
-000254b0: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
-000254c0: 6365 286c 6973 745f 6f66 5f61 6464 732c  ce(list_of_adds,
-000254d0: 206c 6973 7429 3a20 6c69 7374 5f6f 665f   list): list_of_
-000254e0: 6164 6473 203d 206c 6973 7428 6c69 7374  adds = list(list
-000254f0: 5f6f 665f 6164 6473 290a 2020 2020 666f  _of_adds).    fo
-00025500: 7220 6920 696e 206c 6973 745f 6f66 5f61  r i in list_of_a
-00025510: 6464 733a 2073 697a 6520 3d20 7369 7a65  dds: size = size
-00025520: 5b3a 695d 202b 2028 312c 2920 2b20 7369  [:i] + (1,) + si
-00025530: 7a65 5b69 3a5d 0a20 2020 2072 6574 7572  ze[i:].    retur
-00025540: 6e20 7369 7a65 0a0a 636c 6173 7320 5465  n size..class Te
-00025550: 6e73 6f72 2874 6f72 6368 2e54 656e 736f  nsor(torch.Tenso
-00025560: 7229 3a0a 2020 2020 0a20 2020 2040 7374  r):.    .    @st
-00025570: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
-00025580: 6566 205f 6d61 6b65 5f73 7562 636c 6173  ef _make_subclas
-00025590: 7328 636c 732c 200a 2020 2020 2020 2020  s(cls, .        
-000255a0: 746f 7263 685f 7465 6e73 6f72 2c20 7265  torch_tensor, re
-000255b0: 7175 6972 6573 5f67 7261 643d 4e6f 6e65  quires_grad=None
-000255c0: 2c20 6465 7669 6365 3d4e 6f6e 652c 200a  , device=None, .
-000255d0: 2020 2020 2020 2020 7769 7468 5f66 756e          with_fun
-000255e0: 633d 4e6f 6e65 2c20 6675 6e63 5f64 696d  c=None, func_dim
-000255f0: 3d76 6f69 642c 2073 7a5f 6675 6e63 5f64  =void, sz_func_d
-00025600: 696d 3d4e 6f6e 652c 0a20 2020 2020 2020  im=None,.       
-00025610: 2077 6974 685f 6261 7463 683d 4e6f 6e65   with_batch=None
-00025620: 2c20 6261 7463 685f 6469 6d3d 766f 6964  , batch_dim=void
-00025630: 2c20 737a 5f62 6174 6368 5f64 696d 3d4e  , sz_batch_dim=N
-00025640: 6f6e 652c 0a20 2020 2020 2020 2077 6974  one,.        wit
-00025650: 685f 6368 616e 6e65 6c3d 4e6f 6e65 2c20  h_channel=None, 
-00025660: 6368 616e 6e65 6c5f 6469 6d3d 766f 6964  channel_dim=void
-00025670: 2c20 6e5f 6665 6174 7572 655f 6469 6d3d  , n_feature_dim=
-00025680: 4e6f 6e65 2c0a 2020 2020 2020 2020 7769  None,.        wi
-00025690: 7468 5f66 6561 7475 7265 3d4e 6f6e 652c  th_feature=None,
-000256a0: 2066 6561 7475 7265 5f64 696d 3d76 6f69   feature_dim=voi
-000256b0: 642c 2073 7a5f 6665 6174 7572 655f 6469  d, sz_feature_di
-000256c0: 6d3d 4e6f 6e65 2c0a 2020 2020 2020 2020  m=None,.        
-000256d0: 7769 7468 5f73 6571 7565 6e63 653d 4e6f  with_sequence=No
-000256e0: 6e65 2c20 7365 7175 656e 6365 5f64 696d  ne, sequence_dim
-000256f0: 3d76 6f69 642c 206e 5f73 6571 7565 6e63  =void, n_sequenc
-00025700: 655f 6469 6d3d 4e6f 6e65 2c0a 2020 2020  e_dim=None,.    
-00025710: 2020 2020 737a 5f73 6571 7565 6e63 655f      sz_sequence_
-00025720: 6469 6d3d 4e6f 6e65 2c20 7265 665f 7369  dim=None, ref_si
-00025730: 7a65 3d4e 6f6e 650a 2020 2020 293a 0a20  ze=None.    ):. 
-00025740: 2020 2020 2020 2023 2046 6972 7374 206d         # First m
-00025750: 6f76 6520 7468 6520 6461 7461 2074 6f20  ove the data to 
-00025760: 6465 7669 6365 2c20 656c 696d 696e 6174  device, eliminat
-00025770: 696e 6720 6172 6775 6d65 6e74 2027 6465  ing argument 'de
-00025780: 7669 6365 270a 2020 2020 2020 2020 6966  vice'.        if
-00025790: 2064 6576 6963 6520 6973 206e 6f74 204e   device is not N
-000257a0: 6f6e 6520 616e 6420 746f 7263 685f 7465  one and torch_te
-000257b0: 6e73 6f72 2e64 6576 6963 6520 213d 2064  nsor.device != d
-000257c0: 6576 6963 653a 0a20 2020 2020 2020 2020  evice:.         
-000257d0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-000257e0: 2864 6576 6963 652c 2041 7574 6f44 6576  (device, AutoDev
-000257f0: 6963 6529 3a20 6465 7669 6365 203d 2064  ice): device = d
-00025800: 6576 6963 652e 6d61 696e 5f64 6576 6963  evice.main_devic
-00025810: 650a 2020 2020 2020 2020 2020 2020 746f  e.            to
-00025820: 7263 685f 7465 6e73 6f72 203d 2074 6f72  rch_tensor = tor
-00025830: 6368 5f74 656e 736f 722e 746f 2864 6576  ch_tensor.to(dev
-00025840: 6963 6529 0a20 2020 2020 2020 2069 6620  ice).        if 
-00025850: 7265 7175 6972 6573 5f67 7261 6420 6973  requires_grad is
-00025860: 204e 6f6e 653a 2072 6571 7569 7265 735f   None: requires_
-00025870: 6772 6164 203d 2074 6f72 6368 5f74 656e  grad = torch_ten
-00025880: 736f 722e 7265 7175 6972 6573 5f67 7261  sor.requires_gra
-00025890: 640a 2020 2020 2020 2020 2320 4372 6561  d.        # Crea
-000258a0: 7465 2074 6865 2072 6573 756c 7469 6e67  te the resulting
-000258b0: 2074 656e 736f 720a 2020 2020 2020 2020   tensor.        
-000258c0: 6966 2074 6f72 6368 5f74 656e 736f 722e  if torch_tensor.
-000258d0: 5f5f 636c 6173 735f 5f20 3d3d 2063 6c73  __class__ == cls
-000258e0: 3a20 7365 6c66 203d 2074 6f72 6368 5f74  : self = torch_t
-000258f0: 656e 736f 722e 636c 6f6e 6528 290a 2020  ensor.clone().  
-00025900: 2020 2020 2020 656c 7365 3a20 7365 6c66        else: self
-00025910: 203d 2074 6f72 6368 2e54 656e 736f 722e   = torch.Tensor.
-00025920: 5f6d 616b 655f 7375 6263 6c61 7373 2863  _make_subclass(c
-00025930: 6c73 2c20 746f 7263 685f 7465 6e73 6f72  ls, torch_tensor
-00025940: 2c20 7265 7175 6972 6573 5f67 7261 6429  , requires_grad)
-00025950: 0a20 2020 2020 2020 2023 2043 6f6d 7072  .        # Compr
-00025960: 6573 7320 7468 6520 636f 6e74 726f 6c6c  ess the controll
-00025970: 6572 2061 7267 756d 656e 7473 2069 6e74  er arguments int
-00025980: 6f20 737a 206e 756d 6265 7273 0a20 2020  o sz numbers.   
-00025990: 2020 2020 206e 5f64 696d 203d 2073 656c       n_dim = sel
-000259a0: 662e 6e64 696d 0a20 2020 2020 2020 2069  f.ndim.        i
-000259b0: 6620 6e6f 7420 6861 7361 7474 7228 7365  f not hasattr(se
-000259c0: 6c66 2c20 2773 7a5f 6675 6e63 5f64 696d  lf, 'sz_func_dim
-000259d0: 2729 3a20 7365 6c66 2e73 7a5f 6675 6e63  '): self.sz_func
-000259e0: 5f64 696d 203d 2030 0a20 2020 2020 2020  _dim = 0.       
-000259f0: 2069 6620 6e6f 7420 6861 7361 7474 7228   if not hasattr(
-00025a00: 7365 6c66 2c20 2773 7a5f 6261 7463 685f  self, 'sz_batch_
-00025a10: 6469 6d27 293a 2073 656c 662e 737a 5f62  dim'): self.sz_b
-00025a20: 6174 6368 5f64 696d 203d 2030 0a20 2020  atch_dim = 0.   
-00025a30: 2020 2020 2069 6620 6e6f 7420 6861 7361       if not hasa
-00025a40: 7474 7228 7365 6c66 2c20 2773 7a5f 6665  ttr(self, 'sz_fe
-00025a50: 6174 7572 655f 6469 6d27 293a 2073 656c  ature_dim'): sel
-00025a60: 662e 737a 5f66 6561 7475 7265 5f64 696d  f.sz_feature_dim
-00025a70: 203d 2030 0a20 2020 2020 2020 2069 6620   = 0.        if 
-00025a80: 6e6f 7420 6861 7361 7474 7228 7365 6c66  not hasattr(self
-00025a90: 2c20 2773 7a5f 7365 7175 656e 6365 5f64  , 'sz_sequence_d
-00025aa0: 696d 2729 3a20 7365 6c66 2e73 7a5f 7365  im'): self.sz_se
-00025ab0: 7175 656e 6365 5f64 696d 203d 2030 0a20  quence_dim = 0. 
-00025ac0: 2020 2020 2020 2061 766f 7563 6828 7375         avouch(su
-00025ad0: 6d5f 285b 7769 7468 5f66 756e 6320 6973  m_([with_func is
-00025ae0: 206e 6f74 204e 6f6e 652c 2066 756e 635f   not None, func_
-00025af0: 6469 6d20 213d 2076 6f69 642c 2073 7a5f  dim != void, sz_
-00025b00: 6675 6e63 5f64 696d 2069 7320 6e6f 7420  func_dim is not 
-00025b10: 4e6f 6e65 2c20 7265 665f 7369 7a65 2069  None, ref_size i
-00025b20: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2072  s not None and r
-00025b30: 6566 5f73 697a 652e 737a 5f66 756e 635f  ef_size.sz_func_
-00025b40: 6469 6d20 213d 2030 5d29 203c 3d20 312c  dim != 0]) <= 1,
-00025b50: 2022 4f6e 6c79 206f 6e65 2069 6e70 7574   "Only one input
-00025b60: 2069 7320 6163 6365 7074 6564 2069 6e20   is accepted in 
-00025b70: 2777 6974 685f 6675 6e63 272c 2027 6675  'with_func', 'fu
-00025b80: 6e63 5f64 696d 272c 2027 737a 5f66 756e  nc_dim', 'sz_fun
-00025b90: 635f 6469 6d27 2061 6e64 2027 7265 665f  c_dim' and 'ref_
-00025ba0: 7369 7a65 272e 2022 290a 2020 2020 2020  size'. ").      
-00025bb0: 2020 6176 6f75 6368 2873 756d 5f28 5b77    avouch(sum_([w
-00025bc0: 6974 685f 6261 7463 6820 6973 206e 6f74  ith_batch is not
-00025bd0: 204e 6f6e 652c 2062 6174 6368 5f64 696d   None, batch_dim
-00025be0: 2021 3d20 766f 6964 2c20 737a 5f62 6174   != void, sz_bat
-00025bf0: 6368 5f64 696d 2069 7320 6e6f 7420 4e6f  ch_dim is not No
-00025c00: 6e65 2c20 7265 665f 7369 7a65 2069 7320  ne, ref_size is 
-00025c10: 6e6f 7420 4e6f 6e65 2061 6e64 2072 6566  not None and ref
-00025c20: 5f73 697a 652e 737a 5f62 6174 6368 5f64  _size.sz_batch_d
-00025c30: 696d 2021 3d20 305d 2920 3c3d 2031 2c20  im != 0]) <= 1, 
-00025c40: 224f 6e6c 7920 6f6e 6520 696e 7075 7420  "Only one input 
-00025c50: 6973 2061 6363 6570 7465 6420 696e 2027  is accepted in '
-00025c60: 7769 7468 5f62 6174 6368 272c 2027 6261  with_batch', 'ba
-00025c70: 7463 685f 6469 6d27 2c20 2773 7a5f 6261  tch_dim', 'sz_ba
-00025c80: 7463 685f 6469 6d27 2061 6e64 2027 7265  tch_dim' and 're
-00025c90: 665f 7369 7a65 272e 2022 290a 2020 2020  f_size'. ").    
-00025ca0: 2020 2020 6176 6f75 6368 2873 756d 5f28      avouch(sum_(
-00025cb0: 5b77 6974 685f 6368 616e 6e65 6c20 6973  [with_channel is
-00025cc0: 206e 6f74 204e 6f6e 652c 2077 6974 685f   not None, with_
-00025cd0: 6665 6174 7572 6520 6973 206e 6f74 204e  feature is not N
-00025ce0: 6f6e 652c 2063 6861 6e6e 656c 5f64 696d  one, channel_dim
-00025cf0: 2021 3d20 766f 6964 2c20 6665 6174 7572   != void, featur
-00025d00: 655f 6469 6d20 213d 2076 6f69 642c 206e  e_dim != void, n
-00025d10: 5f66 6561 7475 7265 5f64 696d 2069 7320  _feature_dim is 
-00025d20: 6e6f 7420 4e6f 6e65 2c20 737a 5f66 6561  not None, sz_fea
-00025d30: 7475 7265 5f64 696d 2069 7320 6e6f 7420  ture_dim is not 
-00025d40: 4e6f 6e65 2c20 7265 665f 7369 7a65 2069  None, ref_size i
-00025d50: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2072  s not None and r
-00025d60: 6566 5f73 697a 652e 737a 5f66 6561 7475  ef_size.sz_featu
-00025d70: 7265 5f64 696d 2021 3d20 305d 2920 3c3d  re_dim != 0]) <=
-00025d80: 2031 2c20 224f 6e6c 7920 6f6e 6520 696e   1, "Only one in
-00025d90: 7075 7420 6973 2061 6363 6570 7465 6420  put is accepted 
-00025da0: 696e 2027 7769 7468 5f63 6861 6e6e 656c  in 'with_channel
-00025db0: 272c 2027 7769 7468 5f66 6561 7475 7265  ', 'with_feature
-00025dc0: 272c 2027 6368 616e 6e65 6c5f 6469 6d27  ', 'channel_dim'
-00025dd0: 2c20 2766 6561 7475 7265 5f64 696d 272c  , 'feature_dim',
-00025de0: 2027 6e5f 6665 6174 7572 655f 6469 6d27   'n_feature_dim'
-00025df0: 2c20 2773 7a5f 6665 6174 7572 655f 6469  , 'sz_feature_di
-00025e00: 6d27 2c20 616e 6420 2772 6566 5f73 697a  m', and 'ref_siz
-00025e10: 6527 2e20 2229 0a20 2020 2020 2020 2061  e'. ").        a
-00025e20: 766f 7563 6828 7375 6d5f 285b 7769 7468  vouch(sum_([with
-00025e30: 5f73 6571 7565 6e63 6520 6973 206e 6f74  _sequence is not
-00025e40: 204e 6f6e 652c 2073 6571 7565 6e63 655f   None, sequence_
-00025e50: 6469 6d20 213d 2076 6f69 642c 206e 5f73  dim != void, n_s
-00025e60: 6571 7565 6e63 655f 6469 6d20 6973 206e  equence_dim is n
-00025e70: 6f74 204e 6f6e 652c 2073 7a5f 7365 7175  ot None, sz_sequ
-00025e80: 656e 6365 5f64 696d 2069 7320 6e6f 7420  ence_dim is not 
-00025e90: 4e6f 6e65 2c20 7265 665f 7369 7a65 2069  None, ref_size i
-00025ea0: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2072  s not None and r
-00025eb0: 6566 5f73 697a 652e 737a 5f73 6571 7565  ef_size.sz_seque
-00025ec0: 6e63 655f 6469 6d20 213d 2030 5d29 203c  nce_dim != 0]) <
-00025ed0: 3d20 312c 2022 4f6e 6c79 206f 6e65 2069  = 1, "Only one i
-00025ee0: 6e70 7574 2069 7320 6163 6365 7074 6564  nput is accepted
-00025ef0: 2069 6e20 2777 6974 685f 7365 7175 656e   in 'with_sequen
-00025f00: 6365 272c 2027 7365 7175 656e 6365 5f64  ce', 'sequence_d
-00025f10: 696d 272c 2027 6e5f 7365 7175 656e 6365  im', 'n_sequence
-00025f20: 5f64 696d 272c 2027 737a 5f73 6571 7565  _dim', 'sz_seque
-00025f30: 6e63 655f 6469 6d27 2c20 616e 6420 2772  nce_dim', and 'r
-00025f40: 6566 5f73 697a 6527 2e20 2229 0a20 2020  ef_size'. ").   
-00025f50: 2020 2020 2069 6620 7769 7468 5f66 756e       if with_fun
-00025f60: 6320 6973 206e 6f74 204e 6f6e 653a 2073  c is not None: s
-00025f70: 656c 662e 737a 5f66 756e 635f 6469 6d20  elf.sz_func_dim 
-00025f80: 3d20 696e 745f 2877 6974 685f 6675 6e63  = int_(with_func
-00025f90: 290a 2020 2020 2020 2020 656c 6966 2066  ).        elif f
-00025fa0: 756e 635f 6469 6d20 213d 2076 6f69 643a  unc_dim != void:
-00025fb0: 0a20 2020 2020 2020 2020 2020 2063 616e  .            can
-00025fc0: 6473 203d 2028 302c 202d 6e5f 6469 6d2c  ds = (0, -n_dim,
-00025fd0: 206e 5f64 696d 2d31 2c20 2d31 290a 2020   n_dim-1, -1).  
-00025fe0: 2020 2020 2020 2020 2020 6176 6f75 6368            avouch
-00025ff0: 2866 756e 635f 6469 6d20 696e 2063 616e  (func_dim in can
-00026000: 6473 2c20 5479 7065 4572 726f 7228 6622  ds, TypeError(f"
-00026010: 2766 756e 635f 6469 6d27 2066 6f72 2074  'func_dim' for t
-00026020: 656e 736f 7220 7368 6f75 6c64 2062 6520  ensor should be 
-00026030: 6f6e 6520 6f66 207b 6361 6e64 735b 305d  one of {cands[0]
-00026040: 7d20 616e 6420 7b63 616e 6473 5b2d 315d  } and {cands[-1]
-00026050: 7d2e 2022 2929 0a20 2020 2020 2020 2020  }. ")).         
-00026060: 2020 2073 656c 662e 737a 5f66 756e 635f     self.sz_func_
-00026070: 6469 6d20 3d20 3120 6966 2066 756e 635f  dim = 1 if func_
-00026080: 6469 6d20 696e 2063 616e 6473 5b3a 325d  dim in cands[:2]
-00026090: 2065 6c73 6520 2d31 0a20 2020 2020 2020   else -1.       
-000260a0: 2065 6c69 6620 737a 5f66 756e 635f 6469   elif sz_func_di
-000260b0: 6d20 6973 206e 6f74 204e 6f6e 653a 0a20  m is not None:. 
-000260c0: 2020 2020 2020 2020 2020 2061 766f 7563             avouc
-000260d0: 6828 737a 5f66 756e 635f 6469 6d20 696e  h(sz_func_dim in
-000260e0: 2028 302c 2031 2c20 2d31 292c 2054 7970   (0, 1, -1), Typ
-000260f0: 6545 7272 6f72 2822 2773 7a5f 6675 6e63  eError("'sz_func
-00026100: 5f64 696d 2720 666f 7220 7465 6e73 6f72  _dim' for tensor
-00026110: 2073 686f 756c 6420 6265 206f 6e65 206f   should be one o
-00026120: 6620 2830 2c20 312c 202d 3129 2e20 2229  f (0, 1, -1). ")
-00026130: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00026140: 6c66 2e73 7a5f 6675 6e63 5f64 696d 203d  lf.sz_func_dim =
-00026150: 2073 7a5f 6675 6e63 5f64 696d 0a20 2020   sz_func_dim.   
-00026160: 2020 2020 2065 6c69 6620 7265 665f 7369       elif ref_si
-00026170: 7a65 2069 7320 6e6f 7420 4e6f 6e65 2061  ze is not None a
-00026180: 6e64 2072 6566 5f73 697a 652e 737a 5f66  nd ref_size.sz_f
-00026190: 756e 635f 6469 6d20 213d 2030 3a20 7365  unc_dim != 0: se
-000261a0: 6c66 2e73 7a5f 6675 6e63 5f64 696d 203d  lf.sz_func_dim =
-000261b0: 2072 6566 5f73 697a 652e 737a 5f66 756e   ref_size.sz_fun
-000261c0: 635f 6469 6d0a 2020 2020 2020 2020 6966  c_dim.        if
-000261d0: 2077 6974 685f 6261 7463 6820 6973 206e   with_batch is n
-000261e0: 6f74 204e 6f6e 653a 2073 656c 662e 737a  ot None: self.sz
-000261f0: 5f62 6174 6368 5f64 696d 203d 2069 6e74  _batch_dim = int
-00026200: 5f28 7769 7468 5f62 6174 6368 290a 2020  _(with_batch).  
-00026210: 2020 2020 2020 656c 6966 2062 6174 6368        elif batch
-00026220: 5f64 696d 2021 3d20 766f 6964 3a0a 2020  _dim != void:.  
-00026230: 2020 2020 2020 2020 2020 6361 6e64 7320            cands 
-00026240: 3d20 286d 6178 5f28 7365 6c66 2e73 7a5f  = (max_(self.sz_
-00026250: 6675 6e63 5f64 696d 2c20 3029 2c20 6d61  func_dim, 0), ma
-00026260: 785f 2873 656c 662e 737a 5f66 756e 635f  x_(self.sz_func_
-00026270: 6469 6d2c 2030 292d 6e5f 6469 6d2c 206e  dim, 0)-n_dim, n
-00026280: 5f64 696d 2d31 2b6d 696e 5f28 7365 6c66  _dim-1+min_(self
-00026290: 2e73 7a5f 6675 6e63 5f64 696d 2c20 3029  .sz_func_dim, 0)
-000262a0: 2c20 2d31 2b6d 696e 5f28 7365 6c66 2e73  , -1+min_(self.s
-000262b0: 7a5f 6675 6e63 5f64 696d 2c20 3029 290a  z_func_dim, 0)).
-000262c0: 2020 2020 2020 2020 2020 2020 6176 6f75              avou
-000262d0: 6368 2862 6174 6368 5f64 696d 2069 6e20  ch(batch_dim in 
-000262e0: 6361 6e64 732c 2054 7970 6545 7272 6f72  cands, TypeError
-000262f0: 2866 2227 6261 7463 685f 6469 6d27 2066  (f"'batch_dim' f
-00026300: 6f72 2074 656e 736f 7220 7368 6f75 6c64  or tensor should
-00026310: 2062 6520 6f6e 6520 6f66 207b 6361 6e64   be one of {cand
-00026320: 735b 305d 7d20 616e 6420 7b63 616e 6473  s[0]} and {cands
-00026330: 5b2d 315d 7d2e 2022 2929 0a20 2020 2020  [-1]}. ")).     
-00026340: 2020 2020 2020 2073 656c 662e 737a 5f62         self.sz_b
-00026350: 6174 6368 5f64 696d 203d 2031 2069 6620  atch_dim = 1 if 
-00026360: 6261 7463 685f 6469 6d20 696e 2063 616e  batch_dim in can
-00026370: 6473 5b3a 325d 2065 6c73 6520 2d31 0a20  ds[:2] else -1. 
-00026380: 2020 2020 2020 2065 6c69 6620 737a 5f62         elif sz_b
-00026390: 6174 6368 5f64 696d 2069 7320 6e6f 7420  atch_dim is not 
-000263a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000263b0: 2020 6176 6f75 6368 2873 7a5f 6261 7463    avouch(sz_batc
-000263c0: 685f 6469 6d20 696e 2028 302c 2031 2c20  h_dim in (0, 1, 
-000263d0: 2d31 292c 2054 7970 6545 7272 6f72 2822  -1), TypeError("
-000263e0: 2773 7a5f 6261 7463 685f 6469 6d27 2066  'sz_batch_dim' f
-000263f0: 6f72 2074 656e 736f 7220 7368 6f75 6c64  or tensor should
-00026400: 2062 6520 6f6e 6520 6f66 2028 302c 2031   be one of (0, 1
-00026410: 2c20 2d31 292e 2022 2929 0a20 2020 2020  , -1). ")).     
-00026420: 2020 2020 2020 2073 656c 662e 737a 5f62         self.sz_b
-00026430: 6174 6368 5f64 696d 203d 2073 7a5f 6261  atch_dim = sz_ba
-00026440: 7463 685f 6469 6d0a 2020 2020 2020 2020  tch_dim.        
-00026450: 656c 6966 2072 6566 5f73 697a 6520 6973  elif ref_size is
-00026460: 206e 6f74 204e 6f6e 6520 616e 6420 7265   not None and re
-00026470: 665f 7369 7a65 2e73 7a5f 6261 7463 685f  f_size.sz_batch_
-00026480: 6469 6d20 213d 2030 3a20 7365 6c66 2e73  dim != 0: self.s
-00026490: 7a5f 6261 7463 685f 6469 6d20 3d20 7265  z_batch_dim = re
-000264a0: 665f 7369 7a65 2e73 7a5f 6261 7463 685f  f_size.sz_batch_
-000264b0: 6469 6d0a 2020 2020 2020 2020 6966 2077  dim.        if w
-000264c0: 6974 685f 6368 616e 6e65 6c20 6973 206e  ith_channel is n
-000264d0: 6f74 204e 6f6e 653a 2073 656c 662e 737a  ot None: self.sz
-000264e0: 5f66 6561 7475 7265 5f64 696d 203d 2069  _feature_dim = i
-000264f0: 6e74 5f28 7769 7468 5f63 6861 6e6e 656c  nt_(with_channel
-00026500: 290a 2020 2020 2020 2020 656c 6966 2077  ).        elif w
-00026510: 6974 685f 6665 6174 7572 6520 6973 206e  ith_feature is n
-00026520: 6f74 204e 6f6e 653a 2073 656c 662e 737a  ot None: self.sz
-00026530: 5f66 6561 7475 7265 5f64 696d 203d 2069  _feature_dim = i
-00026540: 6e74 5f28 7769 7468 5f66 6561 7475 7265  nt_(with_feature
-00026550: 290a 2020 2020 2020 2020 656c 6966 2063  ).        elif c
-00026560: 6861 6e6e 656c 5f64 696d 2021 3d20 766f  hannel_dim != vo
-00026570: 6964 3a0a 2020 2020 2020 2020 2020 2020  id:.            
-00026580: 6361 6e64 7320 3d20 286d 6178 5f28 7365  cands = (max_(se
-00026590: 6c66 2e73 7a5f 6675 6e63 5f64 696d 2c20  lf.sz_func_dim, 
-000265a0: 3029 2b6d 6178 5f28 7365 6c66 2e73 7a5f  0)+max_(self.sz_
-000265b0: 6261 7463 685f 6469 6d2c 2030 292c 200a  batch_dim, 0), .
-000265c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000265d0: 2020 2020 206d 6178 5f28 7365 6c66 2e73       max_(self.s
-000265e0: 7a5f 6675 6e63 5f64 696d 2c20 3029 2b6d  z_func_dim, 0)+m
-000265f0: 6178 5f28 7365 6c66 2e73 7a5f 6261 7463  ax_(self.sz_batc
-00026600: 685f 6469 6d2c 2030 292d 6e5f 6469 6d2c  h_dim, 0)-n_dim,
-00026610: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00026620: 2020 2020 2020 206e 5f64 696d 2d31 2b6d         n_dim-1+m
-00026630: 696e 5f28 7365 6c66 2e73 7a5f 6675 6e63  in_(self.sz_func
-00026640: 5f64 696d 2c20 3029 2b6d 696e 5f28 7365  _dim, 0)+min_(se
-00026650: 6c66 2e73 7a5f 6261 7463 685f 6469 6d2c  lf.sz_batch_dim,
-00026660: 2030 292c 200a 2020 2020 2020 2020 2020   0), .          
-00026670: 2020 2020 2020 2020 2020 202d 312b 6d69             -1+mi
-00026680: 6e5f 2873 656c 662e 737a 5f66 756e 635f  n_(self.sz_func_
-00026690: 6469 6d2c 2030 292b 6d69 6e5f 2873 656c  dim, 0)+min_(sel
-000266a0: 662e 737a 5f62 6174 6368 5f64 696d 2c20  f.sz_batch_dim, 
-000266b0: 3029 290a 2020 2020 2020 2020 2020 2020  0)).            
-000266c0: 6176 6f75 6368 2863 6861 6e6e 656c 5f64  avouch(channel_d
-000266d0: 696d 2069 6e20 6361 6e64 732c 2054 7970  im in cands, Typ
-000266e0: 6545 7272 6f72 2866 2227 6368 616e 6e65  eError(f"'channe
-000266f0: 6c5f 6469 6d27 2066 6f72 2074 656e 736f  l_dim' for tenso
-00026700: 7220 7368 6f75 6c64 2062 6520 6f6e 6520  r should be one 
-00026710: 6f66 207b 6361 6e64 735b 305d 7d20 616e  of {cands[0]} an
-00026720: 6420 7b63 616e 6473 5b2d 315d 7d2e 2022  d {cands[-1]}. "
-00026730: 2929 0a20 2020 2020 2020 2020 2020 2073  )).            s
-00026740: 656c 662e 737a 5f66 6561 7475 7265 5f64  elf.sz_feature_d
-00026750: 696d 203d 2031 2069 6620 6368 616e 6e65  im = 1 if channe
-00026760: 6c5f 6469 6d20 696e 2063 616e 6473 5b3a  l_dim in cands[:
-00026770: 325d 2065 6c73 6520 2d31 0a20 2020 2020  2] else -1.     
-00026780: 2020 2065 6c69 6620 6665 6174 7572 655f     elif feature_
-00026790: 6469 6d20 213d 2076 6f69 643a 0a20 2020  dim != void:.   
-000267a0: 2020 2020 2020 2020 2063 616e 6473 203d           cands =
-000267b0: 2028 6d61 785f 2873 656c 662e 737a 5f66   (max_(self.sz_f
-000267c0: 756e 635f 6469 6d2c 2030 292b 6d61 785f  unc_dim, 0)+max_
-000267d0: 2873 656c 662e 737a 5f62 6174 6368 5f64  (self.sz_batch_d
-000267e0: 696d 2c20 3029 2c20 0a20 2020 2020 2020  im, 0), .       
-000267f0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00026800: 785f 2873 656c 662e 737a 5f66 756e 635f  x_(self.sz_func_
-00026810: 6469 6d2c 2030 292b 6d61 785f 2873 656c  dim, 0)+max_(sel
-00026820: 662e 737a 5f62 6174 6368 5f64 696d 2c20  f.sz_batch_dim, 
-00026830: 3029 2d6e 5f64 696d 2c20 0a20 2020 2020  0)-n_dim, .     
-00026840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026850: 6e5f 6469 6d2d 312b 6d69 6e5f 2873 656c  n_dim-1+min_(sel
-00026860: 662e 737a 5f66 756e 635f 6469 6d2c 2030  f.sz_func_dim, 0
-00026870: 292b 6d69 6e5f 2873 656c 662e 737a 5f62  )+min_(self.sz_b
-00026880: 6174 6368 5f64 696d 2c20 3029 2c20 0a20  atch_dim, 0), . 
-00026890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000268a0: 2020 2020 2d31 2b6d 696e 5f28 7365 6c66      -1+min_(self
-000268b0: 2e73 7a5f 6675 6e63 5f64 696d 2c20 3029  .sz_func_dim, 0)
-000268c0: 2b6d 696e 5f28 7365 6c66 2e73 7a5f 6261  +min_(self.sz_ba
-000268d0: 7463 685f 6469 6d2c 2030 2929 0a20 2020  tch_dim, 0)).   
-000268e0: 2020 2020 2020 2020 2061 766f 7563 6828           avouch(
-000268f0: 6665 6174 7572 655f 6469 6d20 696e 2063  feature_dim in c
-00026900: 616e 6473 2c20 5479 7065 4572 726f 7228  ands, TypeError(
-00026910: 6622 2766 6561 7475 7265 5f64 696d 2720  f"'feature_dim' 
-00026920: 666f 7220 7465 6e73 6f72 2073 686f 756c  for tensor shoul
-00026930: 6420 6265 206f 6e65 206f 6620 7b63 616e  d be one of {can
-00026940: 6473 5b30 5d7d 2061 6e64 207b 6361 6e64  ds[0]} and {cand
-00026950: 735b 2d31 5d7d 2e20 2229 290a 2020 2020  s[-1]}. ")).    
-00026960: 2020 2020 2020 2020 7365 6c66 2e73 7a5f          self.sz_
-00026970: 6665 6174 7572 655f 6469 6d20 3d20 3120  feature_dim = 1 
-00026980: 6966 2066 6561 7475 7265 5f64 696d 2069  if feature_dim i
-00026990: 6e20 6361 6e64 735b 3a32 5d20 656c 7365  n cands[:2] else
-000269a0: 202d 310a 2020 2020 2020 2020 656c 6966   -1.        elif
-000269b0: 206e 5f66 6561 7475 7265 5f64 696d 2069   n_feature_dim i
-000269c0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-000269d0: 2020 2020 2020 2020 6176 6f75 6368 2869          avouch(i
-000269e0: 7369 6e73 7461 6e63 6528 6e5f 6665 6174  sinstance(n_feat
-000269f0: 7572 655f 6469 6d2c 2069 6e74 5f29 2061  ure_dim, int_) a
-00026a00: 6e64 206e 5f66 6561 7475 7265 5f64 696d  nd n_feature_dim
-00026a10: 203e 3d20 302c 2054 7970 6545 7272 6f72   >= 0, TypeError
-00026a20: 2866 2227 6e5f 6665 6174 7572 655f 6469  (f"'n_feature_di
-00026a30: 6d27 2066 6f72 2074 656e 736f 7220 7368  m' for tensor sh
-00026a40: 6f75 6c64 2062 6520 6e6f 6e2d 6e65 6761  ould be non-nega
-00026a50: 7469 7665 2069 6e74 6567 6572 2c20 6e6f  tive integer, no
-00026a60: 7420 7b6e 5f66 6561 7475 7265 5f64 696d  t {n_feature_dim
-00026a70: 7d2e 2022 2929 0a20 2020 2020 2020 2020  }. ")).         
-00026a80: 2020 2073 656c 662e 737a 5f66 6561 7475     self.sz_featu
-00026a90: 7265 5f64 696d 203d 206e 5f66 6561 7475  re_dim = n_featu
-00026aa0: 7265 5f64 696d 0a20 2020 2020 2020 2065  re_dim.        e
-00026ab0: 6c69 6620 737a 5f66 6561 7475 7265 5f64  lif sz_feature_d
-00026ac0: 696d 2069 7320 6e6f 7420 4e6f 6e65 3a0a  im is not None:.
-00026ad0: 2020 2020 2020 2020 2020 2020 6176 6f75              avou
-00026ae0: 6368 2869 7369 6e73 7461 6e63 6528 737a  ch(isinstance(sz
-00026af0: 5f66 6561 7475 7265 5f64 696d 2c20 696e  _feature_dim, in
-00026b00: 745f 292c 2054 7970 6545 7272 6f72 2866  t_), TypeError(f
-00026b10: 2227 737a 5f66 6561 7475 7265 5f64 696d  "'sz_feature_dim
-00026b20: 2720 666f 7220 7465 6e73 6f72 2073 686f  ' for tensor sho
-00026b30: 756c 6420 6265 2061 6e20 696e 7465 6765  uld be an intege
-00026b40: 722c 206e 6f74 207b 737a 5f66 6561 7475  r, not {sz_featu
-00026b50: 7265 5f64 696d 7d2e 2022 2929 0a20 2020  re_dim}. ")).   
-00026b60: 2020 2020 2020 2020 2073 656c 662e 737a           self.sz
-00026b70: 5f66 6561 7475 7265 5f64 696d 203d 2073  _feature_dim = s
-00026b80: 7a5f 6665 6174 7572 655f 6469 6d0a 2020  z_feature_dim.  
-00026b90: 2020 2020 2020 656c 6966 2072 6566 5f73        elif ref_s
-00026ba0: 697a 6520 6973 206e 6f74 204e 6f6e 6520  ize is not None 
-00026bb0: 616e 6420 7265 665f 7369 7a65 2e73 7a5f  and ref_size.sz_
-00026bc0: 6665 6174 7572 655f 6469 6d20 213d 2030  feature_dim != 0
-00026bd0: 3a20 7365 6c66 2e73 7a5f 6665 6174 7572  : self.sz_featur
-00026be0: 655f 6469 6d20 3d20 7265 665f 7369 7a65  e_dim = ref_size
-00026bf0: 2e73 7a5f 6665 6174 7572 655f 6469 6d0a  .sz_feature_dim.
-00026c00: 2020 2020 2020 2020 6966 2077 6974 685f          if with_
-00026c10: 7365 7175 656e 6365 2069 7320 6e6f 7420  sequence is not 
-00026c20: 4e6f 6e65 3a20 7365 6c66 2e73 7a5f 7365  None: self.sz_se
-00026c30: 7175 656e 6365 5f64 696d 203d 2069 6e74  quence_dim = int
-00026c40: 5f28 7769 7468 5f73 6571 7565 6e63 6529  _(with_sequence)
-00026c50: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
-00026c60: 7175 656e 6365 5f64 696d 2021 3d20 766f  quence_dim != vo
-00026c70: 6964 3a0a 2020 2020 2020 2020 2020 2020  id:.            
-00026c80: 6361 6e64 7320 3d20 286d 6178 5f28 7365  cands = (max_(se
-00026c90: 6c66 2e73 7a5f 6675 6e63 5f64 696d 2c20  lf.sz_func_dim, 
-00026ca0: 3029 2b6d 6178 5f28 7365 6c66 2e73 7a5f  0)+max_(self.sz_
-00026cb0: 6261 7463 685f 6469 6d2c 2030 292b 6d61  batch_dim, 0)+ma
-00026cc0: 785f 2873 656c 662e 737a 5f66 6561 7475  x_(self.sz_featu
-00026cd0: 7265 5f64 696d 2c20 3029 2c20 0a20 2020  re_dim, 0), .   
-00026ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026cf0: 2020 6d61 785f 2873 656c 662e 737a 5f66    max_(self.sz_f
-00026d00: 756e 635f 6469 6d2c 2030 292b 6d61 785f  unc_dim, 0)+max_
-00026d10: 2873 656c 662e 737a 5f62 6174 6368 5f64  (self.sz_batch_d
-00026d20: 696d 2c20 3029 2b6d 6178 5f28 7365 6c66  im, 0)+max_(self
-00026d30: 2e73 7a5f 6665 6174 7572 655f 6469 6d2c  .sz_feature_dim,
-00026d40: 2030 292d 6e5f 6469 6d2c 200a 2020 2020   0)-n_dim, .    
-00026d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026d60: 206e 5f64 696d 2d31 2b6d 696e 5f28 7365   n_dim-1+min_(se
-00026d70: 6c66 2e73 7a5f 6675 6e63 5f64 696d 2c20  lf.sz_func_dim, 
-00026d80: 3029 2b6d 696e 5f28 7365 6c66 2e73 7a5f  0)+min_(self.sz_
-00026d90: 6261 7463 685f 6469 6d2c 2030 292b 6d69  batch_dim, 0)+mi
-00026da0: 6e5f 2873 656c 662e 737a 5f66 6561 7475  n_(self.sz_featu
-00026db0: 7265 5f64 696d 2c20 3029 2c20 0a20 2020  re_dim, 0), .   
-00026dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026dd0: 2020 2d31 2b6d 696e 5f28 7365 6c66 2e73    -1+min_(self.s
-00026de0: 7a5f 6675 6e63 5f64 696d 2c20 3029 2b6d  z_func_dim, 0)+m
-00026df0: 696e 5f28 7365 6c66 2e73 7a5f 6261 7463  in_(self.sz_batc
-00026e00: 685f 6469 6d2c 2030 292b 6d69 6e5f 2873  h_dim, 0)+min_(s
-00026e10: 656c 662e 737a 5f66 6561 7475 7265 5f64  elf.sz_feature_d
-00026e20: 696d 2c20 3029 290a 2020 2020 2020 2020  im, 0)).        
-00026e30: 2020 2020 6176 6f75 6368 2873 6571 7565      avouch(seque
-00026e40: 6e63 655f 6469 6d20 696e 2063 616e 6473  nce_dim in cands
-00026e50: 2c20 5479 7065 4572 726f 7228 6622 2773  , TypeError(f"'s
-00026e60: 6571 7565 6e63 655f 6469 6d27 2066 6f72  equence_dim' for
-00026e70: 2074 656e 736f 7220 7368 6f75 6c64 2062   tensor should b
-00026e80: 6520 6f6e 6520 6f66 207b 6361 6e64 735b  e one of {cands[
-00026e90: 305d 7d20 616e 6420 7b63 616e 6473 5b2d  0]} and {cands[-
-00026ea0: 315d 7d2e 2022 2929 0a20 2020 2020 2020  1]}. ")).       
-00026eb0: 2020 2020 2073 656c 662e 737a 5f73 6571       self.sz_seq
-00026ec0: 7565 6e63 655f 6469 6d20 3d20 3120 6966  uence_dim = 1 if
-00026ed0: 2073 6571 7565 6e63 655f 6469 6d20 696e   sequence_dim in
-00026ee0: 2063 616e 6473 5b3a 325d 2065 6c73 6520   cands[:2] else 
-00026ef0: 2d31 0a20 2020 2020 2020 2065 6c69 6620  -1.        elif 
-00026f00: 6e5f 7365 7175 656e 6365 5f64 696d 2069  n_sequence_dim i
-00026f10: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00026f20: 2020 2020 2020 2020 6176 6f75 6368 2869          avouch(i
-00026f30: 7369 6e73 7461 6e63 6528 6e5f 7365 7175  sinstance(n_sequ
-00026f40: 656e 6365 5f64 696d 2c20 696e 745f 2920  ence_dim, int_) 
-00026f50: 616e 6420 6e5f 7365 7175 656e 6365 5f64  and n_sequence_d
-00026f60: 696d 203e 3d20 302c 2054 7970 6545 7272  im >= 0, TypeErr
-00026f70: 6f72 2866 2227 6e5f 7365 7175 656e 6365  or(f"'n_sequence
-00026f80: 5f64 696d 2720 666f 7220 7465 6e73 6f72  _dim' for tensor
-00026f90: 2073 686f 756c 6420 6265 206e 6f6e 2d6e   should be non-n
-00026fa0: 6567 6174 6976 6520 696e 7465 6765 722c  egative integer,
-00026fb0: 206e 6f74 207b 6e5f 7365 7175 656e 6365   not {n_sequence
-00026fc0: 5f64 696d 7d2e 2022 2929 0a20 2020 2020  _dim}. ")).     
-00026fd0: 2020 2020 2020 2073 656c 662e 737a 5f73         self.sz_s
-00026fe0: 6571 7565 6e63 655f 6469 6d20 3d20 2d6e  equence_dim = -n
-00026ff0: 5f73 6571 7565 6e63 655f 6469 6d0a 2020  _sequence_dim.  
-00027000: 2020 2020 2020 656c 6966 2073 7a5f 7365        elif sz_se
-00027010: 7175 656e 6365 5f64 696d 2069 7320 6e6f  quence_dim is no
-00027020: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00027030: 2020 2020 6176 6f75 6368 2869 7369 6e73      avouch(isins
-00027040: 7461 6e63 6528 737a 5f73 6571 7565 6e63  tance(sz_sequenc
-00027050: 655f 6469 6d2c 2069 6e74 5f29 2c20 5479  e_dim, int_), Ty
-00027060: 7065 4572 726f 7228 6622 2773 7a5f 7365  peError(f"'sz_se
-00027070: 7175 656e 6365 5f64 696d 2720 666f 7220  quence_dim' for 
-00027080: 7465 6e73 6f72 2073 686f 756c 6420 6265  tensor should be
-00027090: 2061 6e20 696e 7465 6765 722c 206e 6f74   an integer, not
-000270a0: 207b 737a 5f73 6571 7565 6e63 655f 6469   {sz_sequence_di
-000270b0: 6d7d 2e20 2229 290a 2020 2020 2020 2020  m}. ")).        
-000270c0: 2020 2020 7365 6c66 2e73 7a5f 7365 7175      self.sz_sequ
-000270d0: 656e 6365 5f64 696d 203d 2073 7a5f 7365  ence_dim = sz_se
-000270e0: 7175 656e 6365 5f64 696d 0a20 2020 2020  quence_dim.     
-000270f0: 2020 2065 6c69 6620 7265 665f 7369 7a65     elif ref_size
-00027100: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
-00027110: 2072 6566 5f73 697a 652e 737a 5f73 6571   ref_size.sz_seq
-00027120: 7565 6e63 655f 6469 6d20 213d 2030 3a20  uence_dim != 0: 
-00027130: 7365 6c66 2e73 7a5f 7365 7175 656e 6365  self.sz_sequence
-00027140: 5f64 696d 203d 2072 6566 5f73 697a 652e  _dim = ref_size.
-00027150: 737a 5f73 6571 7565 6e63 655f 6469 6d0a  sz_sequence_dim.
-00027160: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00027170: 656c 660a 2020 2020 0a20 2020 2040 636f  elf.    .    @co
-00027180: 6c6c 6563 745f 6d65 6d6f 7279 0a20 2020  llect_memory.   
-00027190: 2064 6566 205f 5f6e 6577 5f5f 2863 6c73   def __new__(cls
-000271a0: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
-000271b0: 7329 3a0a 2020 2020 2020 2020 2222 2262  s):.        """b
-000271c0: 742e 5465 6e73 6f72 0a20 2020 2020 2020  t.Tensor.       
-000271d0: 2055 7361 6765 733a 0a20 2020 2020 2020   Usages:.       
-000271e0: 2020 2020 2062 742e 5465 6e73 6f72 2874       bt.Tensor(t
-000271f0: 656e 736f 723a 2074 7570 6c65 2f6c 6973  ensor: tuple/lis
-00027200: 742f 746f 7263 682e 5465 6e73 6f72 2f62  t/torch.Tensor/b
-00027210: 742e 5465 6e73 6f72 2f28 7465 6e73 6f72  t.Tensor/(tensor
-00027220: 2077 6974 6820 2773 6861 7065 2729 2f28   with 'shape')/(
-00027230: 7465 6e73 6f72 2077 6974 6820 6d65 7468  tensor with meth
-00027240: 6f64 2027 5f5f 7465 6e73 6f72 5f5f 2729  od '__tensor__')
-00027250: 2c20 7265 7175 6972 6573 5f67 7261 643d  , requires_grad=
-00027260: 4e6f 6e65 2c20 6465 7669 6365 3d4e 6f6e  None, device=Non
-00027270: 652c 202a 2a6b 7761 7267 7329 0a20 2020  e, **kwargs).   
-00027280: 2020 2020 2020 2020 2062 742e 5465 6e73           bt.Tens
-00027290: 6f72 2873 6861 7065 3a20 7475 706c 652c  or(shape: tuple,
-000272a0: 2072 6571 7569 7265 735f 6772 6164 3d4e   requires_grad=N
-000272b0: 6f6e 652c 2064 6576 6963 653d 4e6f 6e65  one, device=None
-000272c0: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
-000272d0: 2020 2020 2020 2020 6274 2e54 656e 736f          bt.Tenso
-000272e0: 7228 2a73 6861 7065 3a20 696e 742c 2072  r(*shape: int, r
-000272f0: 6571 7569 7265 735f 6772 6164 3d4e 6f6e  equires_grad=Non
-00027300: 652c 2064 6576 6963 653d 4e6f 6e65 2c20  e, device=None, 
-00027310: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
-00027320: 2020 2020 2020 0a20 2020 2020 2020 2041        .        A
-00027330: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
-00027340: 2074 656e 736f 7220 2874 7570 6c65 206f   tensor (tuple o
-00027350: 7220 6c69 7374 206f 7220 5465 6e73 6f72  r list or Tensor
-00027360: 293a 2043 7265 6174 6520 6672 6f6d 2061  ): Create from a
-00027370: 2074 656e 736f 7220 6f72 2069 7465 7261   tensor or itera
-00027380: 7469 7665 206f 626a 6563 742e 200a 2020  tive object. .  
-00027390: 2020 2020 2020 2020 2020 7368 6170 6520            shape 
-000273a0: 2874 7570 6c65 206f 7220 2a74 7570 6c65  (tuple or *tuple
-000273b0: 293a 2043 7265 6174 6520 6120 7465 6e73  ): Create a tens
-000273c0: 6f72 206d 656d 6f72 7920 6672 6f6d 2061  or memory from a
-000273d0: 2073 6861 7065 2074 7570 6c65 2e20 0a20   shape tuple. . 
-000273e0: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
-000273f0: 7267 7320 696e 636c 7564 6573 3a0a 2020  rgs includes:.  
-00027400: 2020 2020 2020 2020 2020 2020 2020 6675                fu
-00027410: 6e63 2063 6f6e 7472 6f6c 6c65 7273 3a0a  nc controllers:.
-00027420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027430: 2020 2020 7769 7468 5f66 756e 6320 2862      with_func (b
-00027440: 6f6f 6c29 3a20 5768 6574 6865 7220 7468  ool): Whether th
-00027450: 6520 7465 6e73 6f72 2068 6173 2061 2066  e tensor has a f
-00027460: 756e 6374 696f 6e61 6c20 6469 6d65 6e73  unctional dimens
-00027470: 696f 6e2c 2061 7420 7468 6520 6669 7273  ion, at the firs
-00027480: 7420 6469 6d65 6e73 696f 6e2e 2044 6566  t dimension. Def
-00027490: 6175 6c74 7320 746f 2046 616c 7365 2e20  aults to False. 
-000274a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000274b0: 2020 2020 2066 756e 635f 6469 6d20 2869       func_dim (i
-000274c0: 6e74 3a30 2f6e 5f64 696d 2d31 206f 7220  nt:0/n_dim-1 or 
-000274d0: 4e6f 6e65 293a 2054 6865 2066 756e 6374  None): The funct
-000274e0: 696f 6e61 6c20 6469 6d65 6e73 696f 6e20  ional dimension 
-000274f0: 696e 6465 7820 2830 206f 7220 2d31 206f  index (0 or -1 o
-00027500: 6e6c 792c 2061 7320 7468 6520 6675 6e63  nly, as the func
-00027510: 7469 6f6e 616c 2064 696d 656e 7369 6f6e  tional dimension
-00027520: 2063 616e 206f 6e6c 7920 6265 2074 6865   can only be the
-00027530: 2066 6972 7374 2f6c 6173 7420 6469 6d65   first/last dime
-00027540: 6e73 696f 6e29 206f 6620 7468 6520 7465  nsion) of the te
-00027550: 6e73 6f72 2e20 4465 6661 756c 7473 2074  nsor. Defaults t
-00027560: 6f20 4e6f 6e65 2e0a 2020 2020 2020 2020  o None..        
-00027570: 2020 2020 2020 2020 2020 2020 737a 5f66              sz_f
-00027580: 756e 635f 6469 6d20 2869 6e74 293a 2054  unc_dim (int): T
-00027590: 6865 2073 7a20 6e75 6d62 6572 206f 6620  he sz number of 
-000275a0: 6675 6e63 7469 6f6e 616c 2064 696d 656e  functional dimen
-000275b0: 7369 6f6e 3a20 3020 666f 7220 6e6f 2066  sion: 0 for no f
-000275c0: 756e 6374 696f 6e61 6c20 6469 6d65 6e73  unctional dimens
-000275d0: 696f 6e2c 2031 2066 6f72 206f 6e65 2066  ion, 1 for one f
-000275e0: 756e 6320 6f6e 2074 6865 206c 6566 742c  unc on the left,
-000275f0: 2061 6e64 202d 3120 666f 7220 6f6e 6520   and -1 for one 
-00027600: 6f6e 2074 6865 2072 6967 6874 2e20 4465  on the right. De
-00027610: 6661 756c 7473 2074 6f20 302e 200a 2020  faults to 0. .  
-00027620: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-00027630: 7463 6820 636f 6e74 726f 6c6c 6572 733a  tch controllers:
-00027640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027650: 2020 2020 2077 6974 685f 6261 7463 6820       with_batch 
-00027660: 2862 6f6f 6c29 3a20 5768 6574 6865 7220  (bool): Whether 
-00027670: 7468 6520 7465 6e73 6f72 2068 6173 2061  the tensor has a
-00027680: 2062 6174 6368 2064 696d 656e 7369 6f6e   batch dimension
-00027690: 2c20 6174 2074 6865 2066 6972 7374 2064  , at the first d
-000276a0: 696d 656e 7369 6f6e 2028 6170 6172 7420  imension (apart 
-000276b0: 6672 6f6d 2066 756e 6374 696f 6e61 6c20  from functional 
-000276c0: 6469 6d65 6e73 696f 6e29 2e20 4465 6661  dimension). Defa
-000276d0: 756c 7473 2074 6f20 4661 6c73 652e 200a  ults to False. .
-000276e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000276f0: 2020 2020 6261 7463 685f 6469 6d20 2869      batch_dim (i
-00027700: 6e74 206f 7220 4e6f 6e65 293a 2054 6865  nt or None): The
-00027710: 2062 6174 6368 2064 696d 656e 7369 6f6e   batch dimension
-00027720: 2069 6e64 6578 2028 7468 6520 6669 7273   index (the firs
-00027730: 742f 6c61 7374 2064 696d 656e 7369 6f6e  t/last dimension
-00027740: 2061 7061 7274 2066 726f 6d20 6675 6e63   apart from func
-00027750: 7469 6f6e 616c 2064 696d 656e 7369 6f6e  tional dimension
-00027760: 2920 6f66 2074 6865 2074 656e 736f 722e  ) of the tensor.
-00027770: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
-00027780: 652e 0a20 2020 2020 2020 2020 2020 2020  e..             
-00027790: 2020 2020 2020 2073 7a5f 6261 7463 685f         sz_batch_
-000277a0: 6469 6d20 2869 6e74 293a 2054 6865 2073  dim (int): The s
-000277b0: 7a20 6e75 6d62 6572 206f 6620 6261 7463  z number of batc
-000277c0: 6820 6469 6d65 6e73 696f 6e3a 2030 2066  h dimension: 0 f
-000277d0: 6f72 206e 6f20 6261 7463 6820 6469 6d65  or no batch dime
-000277e0: 6e73 696f 6e2c 2031 2066 6f72 206f 6e65  nsion, 1 for one
-000277f0: 2062 6174 6368 206f 6e20 7468 6520 6c65   batch on the le
-00027800: 6674 2c20 616e 6420 2d31 2066 6f72 206f  ft, and -1 for o
-00027810: 6e65 206f 6e20 7468 6520 7269 6768 742e  ne on the right.
-00027820: 2044 6566 6175 6c74 7320 746f 2030 2e20   Defaults to 0. 
-00027830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027840: 2066 6561 7475 7265 2063 6f6e 7472 6f6c   feature control
-00027850: 6c65 7273 3a0a 2020 2020 2020 2020 2020  lers:.          
-00027860: 2020 2020 2020 2020 2020 7769 7468 5f63            with_c
-00027870: 6861 6e6e 656c 2028 626f 6f6c 293a 2057  hannel (bool): W
-00027880: 6865 7468 6572 2074 6865 2074 656e 736f  hether the tenso
-00027890: 7220 6861 7320 6120 6368 616e 6e65 6c20  r has a channel 
-000278a0: 6469 6d65 6e73 696f 6e2c 2061 7420 7468  dimension, at th
-000278b0: 6520 6669 7273 7420 6469 6d65 6e73 696f  e first dimensio
-000278c0: 6e20 6170 6172 7420 6672 6f6d 2062 6174  n apart from bat
-000278d0: 6368 2e20 4465 6661 756c 7473 2074 6f20  ch. Defaults to 
-000278e0: 4661 6c73 652e 200a 2020 2020 2020 2020  False. .        
-000278f0: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00027900: 5f66 6561 7475 7265 2028 626f 6f6c 293a  _feature (bool):
-00027910: 2057 6865 7468 6572 2074 6865 2074 656e   Whether the ten
-00027920: 736f 7220 6861 7320 6120 6665 6174 7572  sor has a featur
-00027930: 6520 6469 6d65 6e73 696f 6e2c 2061 7420  e dimension, at 
-00027940: 7468 6520 6669 7273 7420 6469 6d65 6e73  the first dimens
-00027950: 696f 6e20 6170 6172 7420 6672 6f6d 2062  ion apart from b
-00027960: 6174 6368 2e20 4465 6661 756c 7473 2074  atch. Defaults t
-00027970: 6f20 4661 6c73 652e 200a 2020 2020 2020  o False. .      
-00027980: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00027990: 616e 6e65 6c5f 6469 6d20 2869 6e74 206f  annel_dim (int o
-000279a0: 7220 4e6f 6e65 293a 2054 6865 2063 6861  r None): The cha
-000279b0: 6e6e 656c 2064 696d 656e 7369 6f6e 2069  nnel dimension i
-000279c0: 6e64 6578 2028 7468 6520 6669 7273 742f  ndex (the first/
-000279d0: 6c61 7374 2064 696d 656e 7369 6f6e 2061  last dimension a
-000279e0: 7061 7274 2066 726f 6d20 6261 7463 6829  part from batch)
-000279f0: 206f 6620 7468 6520 7465 6e73 6f72 2e20   of the tensor. 
-00027a00: 4465 6661 756c 7473 2074 6f20 4e6f 6e65  Defaults to None
-00027a10: 2e20 0a20 2020 2020 2020 2020 2020 2020  . .             
-00027a20: 2020 2020 2020 2066 6561 7475 7265 5f64         feature_d
-00027a30: 696d 2028 696e 7420 6f72 204e 6f6e 6529  im (int or None)
-00027a40: 3a20 5468 6520 6665 6174 7572 6520 6469  : The feature di
-00027a50: 6d65 6e73 696f 6e20 696e 6465 7820 2874  mension index (t
-00027a60: 6865 2066 6972 7374 2f6c 6173 7420 6469  he first/last di
-00027a70: 6d65 6e73 696f 6e20 6170 6172 7420 6672  mension apart fr
-00027a80: 6f6d 2062 6174 6368 2920 6f66 2074 6865  om batch) of the
-00027a90: 2074 656e 736f 722e 2044 6566 6175 6c74   tensor. Default
-00027aa0: 7320 746f 204e 6f6e 652e 200a 2020 2020  s to None. .    
-00027ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027ac0: 6e5f 6665 6174 7572 655f 6469 6d20 2869  n_feature_dim (i
-00027ad0: 6e74 2b29 3a20 5468 6520 6e75 6d62 6572  nt+): The number
-00027ae0: 206f 6620 6665 6174 7572 6520 6469 6d65   of feature dime
-00027af0: 6e73 696f 6e73 2c20 6f6e 2074 6865 206c  nsions, on the l
-00027b00: 6566 7420 7061 7274 206f 6620 7468 6520  eft part of the 
-00027b10: 7369 7a65 2e20 4465 6661 756c 7473 2074  size. Defaults t
-00027b20: 6f20 302e 200a 2020 2020 2020 2020 2020  o 0. .          
-00027b30: 2020 2020 2020 2020 2020 737a 5f66 6561            sz_fea
-00027b40: 7475 7265 5f64 696d 2028 696e 7429 3a20  ture_dim (int): 
-00027b50: 5468 6520 737a 206e 756d 6265 7220 6f66  The sz number of
-00027b60: 2066 6561 7475 7265 2064 696d 656e 7369   feature dimensi
-00027b70: 6f6e 733a 2030 2066 6f72 206e 6f20 6665  ons: 0 for no fe
-00027b80: 6174 7572 6573 2c20 706f 7369 7469 7665  atures, positive
-00027b90: 2066 6f72 2066 6561 7475 7265 7320 6f6e   for features on
-00027ba0: 2074 6865 206c 6566 742c 2061 6e64 206e   the left, and n
-00027bb0: 6567 6174 6976 6520 666f 7220 6665 6174  egative for feat
-00027bc0: 7572 6573 206f 6e20 7468 6520 7269 6768  ures on the righ
-00027bd0: 742e 2044 6566 6175 6c74 7320 746f 2030  t. Defaults to 0
-00027be0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00027bf0: 2020 7365 7175 656e 6365 2063 6f6e 7472    sequence contr
-00027c00: 6f6c 6c65 7273 3a0a 2020 2020 2020 2020  ollers:.        
-00027c10: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00027c20: 5f73 6571 7565 6e63 6520 2862 6f6f 6c29  _sequence (bool)
-00027c30: 3a20 5768 6574 6865 7220 7468 6520 7465  : Whether the te
-00027c40: 6e73 6f72 2068 6173 206f 6e65 2073 6571  nsor has one seq
-00027c50: 7565 6e63 6520 6469 6d65 6e73 696f 6e2c  uence dimension,
-00027c60: 2061 7420 7468 6520 6669 7273 7420 6469   at the first di
-00027c70: 6d65 6e73 696f 6e20 6170 6172 7420 6672  mension apart fr
-00027c80: 6f6d 2062 6174 6368 2061 6e64 2066 6561  om batch and fea
-00027c90: 7475 7265 2e20 4465 6661 756c 7473 2074  ture. Defaults t
-00027ca0: 6f20 4661 6c73 652e 200a 2020 2020 2020  o False. .      
-00027cb0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00027cc0: 7175 656e 6365 5f64 696d 2028 696e 7420  quence_dim (int 
-00027cd0: 6f72 204e 6f6e 6529 3a20 5468 6520 7365  or None): The se
-00027ce0: 7175 656e 6365 2064 696d 656e 7369 6f6e  quence dimension
-00027cf0: 2069 6e64 6578 2028 7468 6520 6669 7273   index (the firs
-00027d00: 742f 6c61 7374 2064 696d 656e 7369 6f6e  t/last dimension
-00027d10: 2061 7061 7274 2066 726f 6d20 6261 7463   apart from batc
-00027d20: 6820 616e 6420 6665 6174 7572 6529 206f  h and feature) o
-00027d30: 6620 7468 6520 7465 6e73 6f72 2e20 4465  f the tensor. De
-00027d40: 6661 756c 7473 2074 6f20 4e6f 6e65 2e20  faults to None. 
-00027d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027d60: 2020 2020 206e 5f73 6571 7565 6e63 655f       n_sequence_
-00027d70: 6469 6d20 2869 6e74 2b29 3a20 5468 6520  dim (int+): The 
-00027d80: 6e75 6d62 6572 206f 6620 7365 7175 656e  number of sequen
-00027d90: 6365 2064 696d 656e 7369 6f6e 732c 206f  ce dimensions, o
-00027da0: 6e20 7468 6520 6c65 6674 2070 6172 7420  n the left part 
-00027db0: 6f66 2074 6865 2073 697a 652e 2044 6566  of the size. Def
-00027dc0: 6175 6c74 7320 746f 2030 2e20 0a20 2020  aults to 0. .   
-00027dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027de0: 2073 7a5f 7365 7175 656e 6365 5f64 696d   sz_sequence_dim
-00027df0: 2028 696e 7429 3a20 5468 6520 737a 206e   (int): The sz n
-00027e00: 756d 6265 7220 6f66 2073 6571 7565 6e63  umber of sequenc
-00027e10: 6520 6469 6d65 6e73 696f 6e73 3a20 3020  e dimensions: 0 
-00027e20: 666f 7220 6e6f 2073 6571 7565 6e63 6573  for no sequences
-00027e30: 2c20 706f 7369 7469 7665 2066 6f72 2073  , positive for s
-00027e40: 6571 7565 6e63 6573 206f 6e20 7468 6520  equences on the 
-00027e50: 6c65 6674 2c20 616e 6420 6e65 6761 7469  left, and negati
-00027e60: 7665 2066 6f72 2073 6571 7565 6e63 6573  ve for sequences
-00027e70: 206f 6e20 7468 6520 7269 6768 742e 2044   on the right. D
-00027e80: 6566 6175 6c74 7320 746f 2030 2e0a 2020  efaults to 0..  
-00027e90: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00027ea0: 2020 6966 206c 656e 2861 7267 7329 203e    if len(args) >
-00027eb0: 3d20 3120 616e 6420 6973 696e 7374 616e  = 1 and isinstan
-00027ec0: 6365 2861 7267 735b 305d 2c20 746f 7263  ce(args[0], torc
-00027ed0: 682e 5465 6e73 6f72 293a 2072 6574 7572  h.Tensor): retur
-00027ee0: 6e20 5465 6e73 6f72 2e5f 6d61 6b65 5f73  n Tensor._make_s
-00027ef0: 7562 636c 6173 7328 636c 732c 202a 6172  ubclass(cls, *ar
-00027f00: 6773 2c20 2a2a 6b77 6172 6773 290a 2020  gs, **kwargs).  
-00027f10: 2020 2020 2020 6966 206c 656e 2861 7267        if len(arg
-00027f20: 7329 203e 3d20 3120 616e 6420 6861 7361  s) >= 1 and hasa
-00027f30: 7474 7228 6172 6773 5b30 5d2c 2027 5f5f  ttr(args[0], '__
-00027f40: 7465 6e73 6f72 5f5f 2729 3a20 7265 7475  tensor__'): retu
-00027f50: 726e 2054 656e 736f 722e 5f6d 616b 655f  rn Tensor._make_
-00027f60: 7375 6263 6c61 7373 2863 6c73 2c20 6172  subclass(cls, ar
-00027f70: 6773 5b30 5d2e 5f5f 7465 6e73 6f72 5f5f  gs[0].__tensor__
-00027f80: 2829 2c20 2a61 7267 735b 313a 5d2c 202a  (), *args[1:], *
-00027f90: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
-00027fa0: 2064 6576 6963 6520 3d20 6b77 6172 6773   device = kwargs
-00027fb0: 2e70 6f70 2827 6465 7669 6365 272c 205f  .pop('device', _
-00027fc0: 6465 7669 6365 290a 2020 2020 2020 2020  device).        
-00027fd0: 6966 2069 7369 6e73 7461 6e63 6528 6465  if isinstance(de
-00027fe0: 7669 6365 2c20 4175 746f 4465 7669 6365  vice, AutoDevice
-00027ff0: 293a 2064 6576 6963 6520 3d20 6465 7669  ): device = devi
-00028000: 6365 2e6d 6169 6e5f 6465 7669 6365 0a20  ce.main_device. 
-00028010: 2020 2020 2020 2069 6620 6c65 6e28 6172         if len(ar
-00028020: 6773 2920 3e3d 2031 2061 6e64 2068 6173  gs) >= 1 and has
-00028030: 6174 7472 2861 7267 735b 305d 2c20 2773  attr(args[0], 's
-00028040: 6861 7065 2729 206f 7220 6973 696e 7374  hape') or isinst
-00028050: 616e 6365 2861 7267 735b 305d 2c20 286c  ance(args[0], (l
-00028060: 6973 742c 2074 7570 6c65 2929 3a20 7265  ist, tuple)): re
-00028070: 7475 726e 2054 656e 736f 722e 5f6d 616b  turn Tensor._mak
-00028080: 655f 7375 6263 6c61 7373 2863 6c73 2c20  e_subclass(cls, 
-00028090: 746f 7263 682e 7465 6e73 6f72 2861 7267  torch.tensor(arg
-000280a0: 735b 305d 2c20 7265 7175 6972 6573 5f67  s[0], requires_g
-000280b0: 7261 643d 4661 6c73 652c 2064 6576 6963  rad=False, devic
-000280c0: 653d 6465 7669 6365 292c 202a 6172 6773  e=device), *args
-000280d0: 5b31 3a5d 2c20 2a2a 6b77 6172 6773 290a  [1:], **kwargs).
-000280e0: 2020 2020 2020 2020 7368 6170 6520 3d20          shape = 
-000280f0: 5369 7a65 282a 6172 6773 290a 2020 2020  Size(*args).    
-00028100: 2020 2020 6966 2073 6861 7065 2e68 6173      if shape.has
-00028110: 5f73 7065 6369 616c 3a0a 2020 2020 2020  _special:.      
-00028120: 2020 2020 2020 6966 2073 6861 7065 2e73        if shape.s
-00028130: 7a5f 6675 6e63 5f64 696d 2021 3d20 303a  z_func_dim != 0:
-00028140: 206b 7761 7267 732e 7365 7464 6566 6175   kwargs.setdefau
-00028150: 6c74 2827 737a 5f66 756e 635f 6469 6d27  lt('sz_func_dim'
-00028160: 2c20 7368 6170 652e 737a 5f66 756e 635f  , shape.sz_func_
-00028170: 6469 6d29 0a20 2020 2020 2020 2020 2020  dim).           
-00028180: 2069 6620 7368 6170 652e 737a 5f62 6174   if shape.sz_bat
-00028190: 6368 5f64 696d 2021 3d20 303a 206b 7761  ch_dim != 0: kwa
-000281a0: 7267 732e 7365 7464 6566 6175 6c74 2827  rgs.setdefault('
-000281b0: 737a 5f62 6174 6368 5f64 696d 272c 2073  sz_batch_dim', s
-000281c0: 6861 7065 2e73 7a5f 6261 7463 685f 6469  hape.sz_batch_di
-000281d0: 6d29 0a20 2020 2020 2020 2020 2020 2069  m).            i
-000281e0: 6620 7368 6170 652e 737a 5f66 6561 7475  f shape.sz_featu
-000281f0: 7265 5f64 696d 2021 3d20 303a 206b 7761  re_dim != 0: kwa
-00028200: 7267 732e 7365 7464 6566 6175 6c74 2827  rgs.setdefault('
-00028210: 737a 5f66 6561 7475 7265 5f64 696d 272c  sz_feature_dim',
-00028220: 2073 6861 7065 2e73 7a5f 6665 6174 7572   shape.sz_featur
-00028230: 655f 6469 6d29 0a20 2020 2020 2020 2020  e_dim).         
-00028240: 2020 2069 6620 7368 6170 652e 737a 5f73     if shape.sz_s
-00028250: 6571 7565 6e63 655f 6469 6d20 213d 2030  equence_dim != 0
-00028260: 3a20 6b77 6172 6773 2e73 6574 6465 6661  : kwargs.setdefa
-00028270: 756c 7428 2773 7a5f 7365 7175 656e 6365  ult('sz_sequence
-00028280: 5f64 696d 272c 2073 6861 7065 2e73 7a5f  _dim', shape.sz_
-00028290: 7365 7175 656e 6365 5f64 696d 290a 2020  sequence_dim).  
-000282a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000282b0: 2054 656e 736f 722e 5f6d 616b 655f 7375   Tensor._make_su
-000282c0: 6263 6c61 7373 2863 6c73 2c20 7375 7065  bclass(cls, supe
-000282d0: 7228 292e 5f5f 6e65 775f 5f28 746f 7263  r().__new__(torc
-000282e0: 682e 5465 6e73 6f72 2c20 2a73 6861 7065  h.Tensor, *shape
-000282f0: 2e74 7570 6c65 2829 2c20 6465 7669 6365  .tuple(), device
-00028300: 3d64 6576 6963 6529 2c20 2a2a 6b77 6172  =device), **kwar
-00028310: 6773 290a 2020 2020 2020 2020 7265 7475  gs).        retu
-00028320: 726e 2054 656e 736f 722e 5f6d 616b 655f  rn Tensor._make_
-00028330: 7375 6263 6c61 7373 2863 6c73 2c20 7375  subclass(cls, su
-00028340: 7065 7228 292e 5f5f 6e65 775f 5f28 746f  per().__new__(to
-00028350: 7263 682e 5465 6e73 6f72 2c20 2a61 7267  rch.Tensor, *arg
-00028360: 732c 2064 6576 6963 653d 6465 7669 6365  s, device=device
-00028370: 292c 202a 2a6b 7761 7267 7329 0a0a 2020  ), **kwargs)..  
-00028380: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-00028390: 656c 662c 202a 6172 6773 2c20 2a2a 6b77  elf, *args, **kw
-000283a0: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
-000283b0: 656c 662e 737a 5f66 756e 635f 6469 6d20  elf.sz_func_dim 
-000283c0: 3d20 7365 6c66 2e73 7a5f 6675 6e63 5f64  = self.sz_func_d
-000283d0: 696d 0a20 2020 2020 2020 2073 656c 662e  im.        self.
-000283e0: 737a 5f62 6174 6368 5f64 696d 203d 2073  sz_batch_dim = s
-000283f0: 656c 662e 737a 5f62 6174 6368 5f64 696d  elf.sz_batch_dim
-00028400: 0a20 2020 2020 2020 2073 656c 662e 737a  .        self.sz
-00028410: 5f66 6561 7475 7265 5f64 696d 203d 2073  _feature_dim = s
-00028420: 656c 662e 737a 5f66 6561 7475 7265 5f64  elf.sz_feature_d
-00028430: 696d 0a20 2020 2020 2020 2073 656c 662e  im.        self.
-00028440: 737a 5f73 6571 7565 6e63 655f 6469 6d20  sz_sequence_dim 
-00028450: 3d20 7365 6c66 2e73 7a5f 7365 7175 656e  = self.sz_sequen
-00028460: 6365 5f64 696d 0a20 2020 200a 2020 2020  ce_dim.    .    
-00028470: 2320 496e 6865 7269 7420 616c 6c20 7468  # Inherit all th
-00028480: 6520 7072 6f70 6572 7469 6573 2066 6f72  e properties for
-00028490: 2073 7065 6369 616c 2064 696d 656e 7369   special dimensi
-000284a0: 6f6e 7320 6672 6f6d 2027 6274 2e53 697a  ons from 'bt.Siz
-000284b0: 6527 2e20 0a20 2020 2068 6173 5f66 756e  e'. .    has_fun
-000284c0: 6320 3d20 7072 6f70 6572 7479 2853 697a  c = property(Siz
-000284d0: 652e 6861 735f 6675 6e63 2e66 6765 7429  e.has_func.fget)
-000284e0: 0a20 2020 206e 6675 6e63 6469 6d20 3d20  .    nfuncdim = 
-000284f0: 6e5f 6675 6e63 5f64 696d 203d 2070 726f  n_func_dim = pro
-00028500: 7065 7274 7928 5369 7a65 2e6e 5f66 756e  perty(Size.n_fun
-00028510: 635f 6469 6d2e 6667 6574 290a 2020 2020  c_dim.fget).    
-00028520: 6973 5f66 756e 6364 696d 203d 2069 735f  is_funcdim = is_
-00028530: 6675 6e63 5f64 696d 203d 2053 697a 652e  func_dim = Size.
-00028540: 6973 5f66 756e 635f 6469 6d0a 2020 2020  is_func_dim.    
-00028550: 737a 5f66 756e 635f 6469 6d5f 203d 2077  sz_func_dim_ = w
-00028560: 6974 685f 737a 6675 6e63 6469 6d20 3d20  ith_szfuncdim = 
-00028570: 7769 7468 5f73 7a5f 6675 6e63 5f64 696d  with_sz_func_dim
-00028580: 203d 2053 697a 652e 7769 7468 5f73 7a5f   = Size.with_sz_
-00028590: 6675 6e63 5f64 696d 0a20 2020 206e 5f66  func_dim.    n_f
-000285a0: 756e 635f 6469 6d5f 203d 2077 6974 685f  unc_dim_ = with_
-000285b0: 6e66 756e 6364 696d 203d 2077 6974 685f  nfuncdim = with_
-000285c0: 6e5f 6675 6e63 5f64 696d 203d 2053 697a  n_func_dim = Siz
-000285d0: 652e 7769 7468 5f6e 5f66 756e 635f 6469  e.with_n_func_di
-000285e0: 6d0a 2020 2020 6675 6e63 5f64 696d 656e  m.    func_dimen
-000285f0: 7369 6f6e 203d 2066 756e 635f 6469 6d20  sion = func_dim 
-00028600: 3d20 7072 6f70 6572 7479 2853 697a 652e  = property(Size.
-00028610: 6675 6e63 5f64 696d 2e66 6765 7429 2e73  func_dim.fget).s
-00028620: 6574 7465 7228 5369 7a65 2e66 756e 635f  etter(Size.func_
-00028630: 6469 6d2e 6673 6574 290a 2020 2020 6675  dim.fset).    fu
-00028640: 6e63 5f64 696d 5f20 3d20 6675 6e63 5f64  nc_dim_ = func_d
-00028650: 696d 656e 7369 6f6e 5f20 3d20 5c0a 2020  imension_ = \.  
-00028660: 2020 7769 7468 5f66 756e 6364 696d 203d    with_funcdim =
-00028670: 2077 6974 685f 6675 6e63 5f64 696d 203d   with_func_dim =
-00028680: 2053 697a 652e 7769 7468 5f66 756e 635f   Size.with_func_
-00028690: 6469 6d0a 2020 2020 6e66 756e 6320 3d20  dim.    nfunc = 
-000286a0: 6675 6e63 5f73 697a 6520 3d20 6e5f 6675  func_size = n_fu
-000286b0: 6e63 203d 2070 726f 7065 7274 7928 6c61  nc = property(la
-000286c0: 6d62 6461 2073 656c 663a 2053 697a 652e  mbda self: Size.
-000286d0: 6e5f 6675 6e63 2e66 6765 7428 7365 6c66  n_func.fget(self
-000286e0: 2e73 6861 7065 2929 0a20 2020 2073 697a  .shape)).    siz
-000286f0: 655f 7374 6172 7420 3d20 7072 6f70 6572  e_start = proper
-00028700: 7479 2853 697a 652e 7369 7a65 5f73 7461  ty(Size.size_sta
-00028710: 7274 2e66 6765 7429 0a20 2020 2073 697a  rt.fget).    siz
-00028720: 655f 7374 6f70 203d 2070 726f 7065 7274  e_stop = propert
-00028730: 7928 5369 7a65 2e73 697a 655f 7374 6f70  y(Size.size_stop
-00028740: 2e66 6765 7429 0a0a 2020 2020 6861 735f  .fget)..    has_
-00028750: 6261 7463 6820 3d20 7072 6f70 6572 7479  batch = property
-00028760: 2853 697a 652e 6861 735f 6261 7463 682e  (Size.has_batch.
-00028770: 6667 6574 290a 2020 2020 6e62 6174 6368  fget).    nbatch
-00028780: 6469 6d20 3d20 6e5f 6261 7463 685f 6469  dim = n_batch_di
-00028790: 6d20 3d20 7072 6f70 6572 7479 2853 697a  m = property(Siz
-000287a0: 652e 6e5f 6261 7463 685f 6469 6d2e 6667  e.n_batch_dim.fg
-000287b0: 6574 290a 2020 2020 6973 5f62 6174 6368  et).    is_batch
-000287c0: 6469 6d20 3d20 6973 5f62 6174 6368 5f64  dim = is_batch_d
-000287d0: 696d 203d 2053 697a 652e 6973 5f62 6174  im = Size.is_bat
-000287e0: 6368 5f64 696d 0a20 2020 2073 7a5f 6261  ch_dim.    sz_ba
-000287f0: 7463 685f 6469 6d5f 203d 2077 6974 685f  tch_dim_ = with_
-00028800: 737a 6261 7463 6864 696d 203d 2077 6974  szbatchdim = wit
-00028810: 685f 737a 5f62 6174 6368 5f64 696d 203d  h_sz_batch_dim =
-00028820: 2053 697a 652e 7769 7468 5f73 7a5f 6261   Size.with_sz_ba
-00028830: 7463 685f 6469 6d0a 2020 2020 6e5f 6261  tch_dim.    n_ba
-00028840: 7463 685f 6469 6d5f 203d 2077 6974 685f  tch_dim_ = with_
-00028850: 6e62 6174 6368 6469 6d20 3d20 7769 7468  nbatchdim = with
-00028860: 5f6e 5f62 6174 6368 5f64 696d 203d 2053  _n_batch_dim = S
-00028870: 697a 652e 7769 7468 5f6e 5f62 6174 6368  ize.with_n_batch
-00028880: 5f64 696d 0a20 2020 2062 6174 6368 5f64  _dim.    batch_d
-00028890: 696d 656e 7369 6f6e 203d 2062 6174 6368  imension = batch
-000288a0: 5f64 696d 203d 2070 726f 7065 7274 7928  _dim = property(
-000288b0: 5369 7a65 2e62 6174 6368 5f64 696d 2e66  Size.batch_dim.f
-000288c0: 6765 7429 2e73 6574 7465 7228 5369 7a65  get).setter(Size
-000288d0: 2e62 6174 6368 5f64 696d 2e66 7365 7429  .batch_dim.fset)
-000288e0: 0a20 2020 2062 6174 6368 5f64 696d 5f20  .    batch_dim_ 
-000288f0: 3d20 6261 7463 685f 6469 6d65 6e73 696f  = batch_dimensio
-00028900: 6e5f 203d 205c 0a20 2020 2077 6974 685f  n_ = \.    with_
-00028910: 6261 7463 6864 696d 203d 2077 6974 685f  batchdim = with_
-00028920: 6261 7463 685f 6469 6d20 3d20 5369 7a65  batch_dim = Size
-00028930: 2e77 6974 685f 6261 7463 685f 6469 6d0a  .with_batch_dim.
-00028940: 2020 2020 6e62 6174 6368 203d 2062 6174      nbatch = bat
-00028950: 6368 5f73 697a 6520 3d20 6e5f 6261 7463  ch_size = n_batc
-00028960: 6820 3d20 7072 6f70 6572 7479 286c 616d  h = property(lam
-00028970: 6264 6120 7365 6c66 3a20 5369 7a65 2e6e  bda self: Size.n
-00028980: 5f62 6174 6368 2e66 6765 7428 7365 6c66  _batch.fget(self
-00028990: 2e73 6861 7065 2929 0a20 2020 206e 6f6e  .shape)).    non
-000289a0: 5f62 6174 5f73 7461 7274 203d 2070 726f  _bat_start = pro
-000289b0: 7065 7274 7928 5369 7a65 2e6e 6f6e 5f62  perty(Size.non_b
-000289c0: 6174 5f73 7461 7274 2e66 6765 7429 0a20  at_start.fget). 
-000289d0: 2020 206e 6f6e 5f62 6174 5f73 746f 7020     non_bat_stop 
-000289e0: 3d20 7072 6f70 6572 7479 2853 697a 652e  = property(Size.
-000289f0: 6e6f 6e5f 6261 745f 7374 6f70 2e66 6765  non_bat_stop.fge
-00028a00: 7429 0a0a 2020 2020 6861 735f 6368 616e  t)..    has_chan
-00028a10: 6e65 6c20 3d20 7072 6f70 6572 7479 2853  nel = property(S
-00028a20: 697a 652e 6861 735f 6368 616e 6e65 6c2e  ize.has_channel.
-00028a30: 6667 6574 290a 2020 2020 6e63 6861 6e6e  fget).    nchann
-00028a40: 656c 6469 6d20 3d20 6e5f 6368 616e 6e65  eldim = n_channe
-00028a50: 6c5f 6469 6d20 3d20 7072 6f70 6572 7479  l_dim = property
-00028a60: 2853 697a 652e 6e5f 6368 616e 6e65 6c5f  (Size.n_channel_
-00028a70: 6469 6d2e 6667 6574 290a 2020 2020 6973  dim.fget).    is
-00028a80: 5f63 6861 6e6e 656c 6469 6d20 3d20 6973  _channeldim = is
-00028a90: 5f63 6861 6e6e 656c 5f64 696d 203d 2053  _channel_dim = S
-00028aa0: 697a 652e 6973 5f63 6861 6e6e 656c 5f64  ize.is_channel_d
-00028ab0: 696d 0a20 2020 2063 6861 6e6e 656c 5f64  im.    channel_d
-00028ac0: 696d 656e 7369 6f6e 203d 2063 6861 6e6e  imension = chann
-00028ad0: 656c 5f64 696d 203d 2070 726f 7065 7274  el_dim = propert
-00028ae0: 7928 5369 7a65 2e63 6861 6e6e 656c 5f64  y(Size.channel_d
-00028af0: 696d 2e66 6765 7429 2e73 6574 7465 7228  im.fget).setter(
-00028b00: 5369 7a65 2e63 6861 6e6e 656c 5f64 696d  Size.channel_dim
-00028b10: 2e66 7365 7429 0a20 2020 2063 6861 6e6e  .fset).    chann
-00028b20: 656c 5f64 696d 5f20 3d20 6368 616e 6e65  el_dim_ = channe
-00028b30: 6c5f 6469 6d65 6e73 696f 6e5f 203d 205c  l_dimension_ = \
-00028b40: 0a20 2020 2077 6974 685f 6368 616e 6e65  .    with_channe
-00028b50: 6c64 696d 203d 2077 6974 685f 6368 616e  ldim = with_chan
-00028b60: 6e65 6c5f 6469 6d20 3d20 5369 7a65 2e77  nel_dim = Size.w
-00028b70: 6974 685f 6368 616e 6e65 6c5f 6469 6d0a  ith_channel_dim.
-00028b80: 2020 2020 6e63 6861 6e6e 656c 203d 2063      nchannel = c
-00028b90: 6861 6e6e 656c 5f73 697a 6520 3d20 6e5f  hannel_size = n_
-00028ba0: 6368 616e 6e65 6c20 3d20 7072 6f70 6572  channel = proper
-00028bb0: 7479 286c 616d 6264 6120 7365 6c66 3a20  ty(lambda self: 
-00028bc0: 5369 7a65 2e6e 5f63 6861 6e6e 656c 2e66  Size.n_channel.f
-00028bd0: 6765 7428 7365 6c66 2e73 6861 7065 2929  get(self.shape))
-00028be0: 0a20 2020 200a 2020 2020 6861 735f 6665  .    .    has_fe
-00028bf0: 6174 7572 6520 3d20 7072 6f70 6572 7479  ature = property
-00028c00: 2853 697a 652e 6861 735f 6665 6174 7572  (Size.has_featur
-00028c10: 652e 6667 6574 290a 2020 2020 6973 5f66  e.fget).    is_f
-00028c20: 6561 7475 7265 6469 6d20 3d20 6973 5f66  eaturedim = is_f
-00028c30: 6561 7475 7265 5f64 696d 203d 2053 697a  eature_dim = Siz
-00028c40: 652e 6973 5f66 6561 7475 7265 5f64 696d  e.is_feature_dim
-00028c50: 0a20 2020 206e 6665 6174 7572 6564 696d  .    nfeaturedim
-00028c60: 203d 206e 5f66 6561 7475 7265 5f64 696d   = n_feature_dim
-00028c70: 203d 2070 726f 7065 7274 7928 5369 7a65   = property(Size
-00028c80: 2e6e 5f66 6561 7475 7265 5f64 696d 2e66  .n_feature_dim.f
-00028c90: 6765 7429 2e73 6574 7465 7228 5369 7a65  get).setter(Size
-00028ca0: 2e6e 5f66 6561 7475 7265 5f64 696d 2e66  .n_feature_dim.f
-00028cb0: 7365 7429 0a20 2020 2073 7a5f 6665 6174  set).    sz_feat
-00028cc0: 7572 655f 6469 6d5f 203d 2077 6974 685f  ure_dim_ = with_
-00028cd0: 737a 6665 6174 7572 6564 696d 203d 2077  szfeaturedim = w
-00028ce0: 6974 685f 737a 5f66 6561 7475 7265 5f64  ith_sz_feature_d
-00028cf0: 696d 203d 2053 697a 652e 7769 7468 5f73  im = Size.with_s
-00028d00: 7a5f 6665 6174 7572 655f 6469 6d0a 2020  z_feature_dim.  
-00028d10: 2020 6e5f 6665 6174 7572 655f 6469 6d5f    n_feature_dim_
-00028d20: 203d 2077 6974 685f 6e66 6561 7475 7265   = with_nfeature
-00028d30: 6469 6d20 3d20 7769 7468 5f6e 5f66 6561  dim = with_n_fea
-00028d40: 7475 7265 5f64 696d 203d 2053 697a 652e  ture_dim = Size.
-00028d50: 7769 7468 5f6e 5f66 6561 7475 7265 5f64  with_n_feature_d
-00028d60: 696d 0a20 2020 2066 6561 7475 7265 5f73  im.    feature_s
-00028d70: 7461 7274 203d 2070 726f 7065 7274 7928  tart = property(
-00028d80: 5369 7a65 2e66 6561 7475 7265 5f73 7461  Size.feature_sta
-00028d90: 7274 2e66 6765 7429 2e73 6574 7465 7228  rt.fget).setter(
-00028da0: 5369 7a65 2e66 6561 7475 7265 5f73 7461  Size.feature_sta
-00028db0: 7274 2e66 7365 7429 0a20 2020 2066 6561  rt.fset).    fea
-00028dc0: 7475 7265 5f73 746f 7020 3d20 7072 6f70  ture_stop = prop
-00028dd0: 6572 7479 2853 697a 652e 6665 6174 7572  erty(Size.featur
-00028de0: 655f 7374 6f70 2e66 6765 7429 2e73 6574  e_stop.fget).set
-00028df0: 7465 7228 5369 7a65 2e66 6561 7475 7265  ter(Size.feature
-00028e00: 5f73 746f 702e 6673 6574 290a 2020 2020  _stop.fset).    
-00028e10: 6665 6174 7572 655f 7261 6e67 6520 3d20  feature_range = 
-00028e20: 7072 6f70 6572 7479 2853 697a 652e 6665  property(Size.fe
-00028e30: 6174 7572 655f 7261 6e67 652e 6667 6574  ature_range.fget
-00028e40: 292e 7365 7474 6572 2853 697a 652e 6665  ).setter(Size.fe
-00028e50: 6174 7572 655f 7261 6e67 652e 6673 6574  ature_range.fset
-00028e60: 290a 2020 2020 6e66 6561 7475 7265 203d  ).    nfeature =
-00028e70: 206e 5f66 6561 7475 7265 203d 2070 726f   n_feature = pro
-00028e80: 7065 7274 7928 6c61 6d62 6461 2073 656c  perty(lambda sel
-00028e90: 663a 2053 697a 652e 6e5f 6665 6174 7572  f: Size.n_featur
-00028ea0: 652e 6667 6574 2873 656c 662e 7368 6170  e.fget(self.shap
-00028eb0: 6529 290a 2020 2020 6665 6174 7572 655f  e)).    feature_
-00028ec0: 7369 7a65 203d 2066 6561 7475 7265 203d  size = feature =
-00028ed0: 2070 726f 7065 7274 7928 6c61 6d62 6461   property(lambda
-00028ee0: 2073 656c 663a 2053 697a 652e 6665 6174   self: Size.feat
-00028ef0: 7572 652e 6667 6574 2873 656c 662e 7368  ure.fget(self.sh
-00028f00: 6170 6529 290a 2020 2020 7365 715f 7370  ape)).    seq_sp
-00028f10: 635f 7374 6172 7420 3d20 7072 6f70 6572  c_start = proper
-00028f20: 7479 2853 697a 652e 7365 715f 7370 635f  ty(Size.seq_spc_
-00028f30: 7374 6172 742e 6667 6574 290a 2020 2020  start.fget).    
-00028f40: 7365 715f 7370 635f 7374 6f70 203d 2070  seq_spc_stop = p
-00028f50: 726f 7065 7274 7928 5369 7a65 2e73 6571  roperty(Size.seq
-00028f60: 5f73 7063 5f73 746f 702e 6667 6574 290a  _spc_stop.fget).
-00028f70: 0a20 2020 2068 6173 5f74 696d 6520 3d20  .    has_time = 
-00028f80: 6861 735f 7365 7269 6573 203d 2068 6173  has_series = has
-00028f90: 5f73 6571 7565 6e63 6520 3d20 7072 6f70  _sequence = prop
-00028fa0: 6572 7479 2853 697a 652e 6861 735f 7365  erty(Size.has_se
-00028fb0: 7175 656e 6365 2e66 6765 7429 0a20 2020  quence.fget).   
-00028fc0: 2069 735f 7469 6d65 6469 6d20 3d20 6973   is_timedim = is
-00028fd0: 5f73 6572 6965 7364 696d 203d 2069 735f  _seriesdim = is_
-00028fe0: 7365 7175 656e 6365 6469 6d20 3d20 5c0a  sequencedim = \.
-00028ff0: 2020 2020 6973 5f74 696d 655f 6469 6d20      is_time_dim 
-00029000: 3d20 6973 5f73 6572 6965 735f 6469 6d20  = is_series_dim 
-00029010: 3d20 6973 5f73 6571 7565 6e63 655f 6469  = is_sequence_di
-00029020: 6d20 3d20 5369 7a65 2e69 735f 7365 7175  m = Size.is_sequ
-00029030: 656e 6365 5f64 696d 0a20 2020 206e 7469  ence_dim.    nti
-00029040: 6d65 6469 6d20 3d20 6e73 6572 6965 7364  medim = nseriesd
-00029050: 696d 203d 206e 7365 7175 656e 6365 6469  im = nsequencedi
-00029060: 6d20 3d20 5c0a 2020 2020 6e5f 7469 6d65  m = \.    n_time
-00029070: 5f64 696d 203d 206e 5f73 6572 6965 735f  _dim = n_series_
-00029080: 6469 6d20 3d20 6e5f 7365 7175 656e 6365  dim = n_sequence
-00029090: 5f64 696d 203d 2070 726f 7065 7274 7928  _dim = property(
-000290a0: 5369 7a65 2e6e 5f73 6571 7565 6e63 655f  Size.n_sequence_
-000290b0: 6469 6d2e 6667 6574 292e 7365 7474 6572  dim.fget).setter
-000290c0: 2853 697a 652e 6e5f 7365 7175 656e 6365  (Size.n_sequence
-000290d0: 5f64 696d 2e66 7365 7429 0a20 2020 2073  _dim.fset).    s
-000290e0: 7a5f 7469 6d65 5f64 696d 5f20 3d20 737a  z_time_dim_ = sz
-000290f0: 5f73 6572 6965 735f 6469 6d5f 203d 2073  _series_dim_ = s
-00029100: 7a5f 7365 7175 656e 6365 5f64 696d 5f20  z_sequence_dim_ 
-00029110: 3d20 5c0a 2020 2020 7769 7468 5f73 7a74  = \.    with_szt
-00029120: 696d 6564 696d 203d 2077 6974 685f 737a  imedim = with_sz
-00029130: 7365 7269 6573 6469 6d20 3d20 7769 7468  seriesdim = with
-00029140: 5f73 7a73 6571 7565 6e63 6564 696d 203d  _szsequencedim =
-00029150: 205c 0a20 2020 2077 6974 685f 737a 5f74   \.    with_sz_t
-00029160: 696d 655f 6469 6d20 3d20 7769 7468 5f73  ime_dim = with_s
-00029170: 7a5f 7365 7269 6573 5f64 696d 203d 2077  z_series_dim = w
-00029180: 6974 685f 737a 5f73 6571 7565 6e63 655f  ith_sz_sequence_
-00029190: 6469 6d20 3d20 5369 7a65 2e77 6974 685f  dim = Size.with_
-000291a0: 737a 5f73 6571 7565 6e63 655f 6469 6d0a  sz_sequence_dim.
-000291b0: 2020 2020 6e5f 7469 6d65 5f64 696d 5f20      n_time_dim_ 
-000291c0: 3d20 6e5f 7365 7269 6573 5f64 696d 5f20  = n_series_dim_ 
-000291d0: 3d20 6e5f 7365 7175 656e 6365 5f64 696d  = n_sequence_dim
-000291e0: 5f20 3d20 5c0a 2020 2020 7769 7468 5f6e  _ = \.    with_n
-000291f0: 7469 6d65 6469 6d20 3d20 7769 7468 5f6e  timedim = with_n
-00029200: 7365 7269 6573 6469 6d20 3d20 7769 7468  seriesdim = with
-00029210: 5f6e 7365 7175 656e 6365 6469 6d20 3d20  _nsequencedim = 
-00029220: 5c0a 2020 2020 7769 7468 5f6e 5f74 696d  \.    with_n_tim
-00029230: 655f 6469 6d20 3d20 7769 7468 5f6e 5f73  e_dim = with_n_s
-00029240: 6572 6965 735f 6469 6d20 3d20 7769 7468  eries_dim = with
-00029250: 5f6e 5f73 6571 7565 6e63 655f 6469 6d20  _n_sequence_dim 
-00029260: 3d20 5369 7a65 2e77 6974 685f 6e5f 7365  = Size.with_n_se
-00029270: 7175 656e 6365 5f64 696d 0a20 2020 2074  quence_dim.    t
-00029280: 696d 655f 6469 6d5f 203d 2073 6572 6965  ime_dim_ = serie
-00029290: 735f 6469 6d5f 203d 2073 6571 7565 6e63  s_dim_ = sequenc
-000292a0: 655f 6469 6d5f 203d 205c 0a20 2020 2077  e_dim_ = \.    w
-000292b0: 6974 685f 7469 6d65 6469 6d20 3d20 7769  ith_timedim = wi
-000292c0: 7468 5f73 6572 6965 7364 696d 203d 2077  th_seriesdim = w
-000292d0: 6974 685f 7365 7175 656e 6365 6469 6d20  ith_sequencedim 
-000292e0: 3d20 5c0a 2020 2020 7769 7468 5f74 696d  = \.    with_tim
-000292f0: 655f 6469 6d20 3d20 7769 7468 5f73 6572  e_dim = with_ser
-00029300: 6965 735f 6469 6d20 3d20 7769 7468 5f73  ies_dim = with_s
-00029310: 6571 7565 6e63 655f 6469 6d20 3d20 5369  equence_dim = Si
-00029320: 7a65 2e77 6974 685f 7365 7175 656e 6365  ze.with_sequence
-00029330: 5f64 696d 0a20 2020 2074 696d 655f 7374  _dim.    time_st
-00029340: 6172 7420 3d20 7365 7269 6573 5f73 7461  art = series_sta
-00029350: 7274 203d 2073 6571 7565 6e63 655f 7374  rt = sequence_st
-00029360: 6172 7420 3d20 7072 6f70 6572 7479 2853  art = property(S
-00029370: 697a 652e 7365 7175 656e 6365 5f73 7461  ize.sequence_sta
-00029380: 7274 2e66 6765 7429 2e73 6574 7465 7228  rt.fget).setter(
-00029390: 5369 7a65 2e73 6571 7565 6e63 655f 7374  Size.sequence_st
-000293a0: 6172 742e 6673 6574 290a 2020 2020 7469  art.fset).    ti
-000293b0: 6d65 5f73 746f 7020 3d20 7365 7269 6573  me_stop = series
-000293c0: 5f73 746f 7020 3d20 7365 7175 656e 6365  _stop = sequence
-000293d0: 5f73 746f 7020 3d20 7072 6f70 6572 7479  _stop = property
-000293e0: 2853 697a 652e 7365 7175 656e 6365 5f73  (Size.sequence_s
-000293f0: 746f 702e 6667 6574 292e 7365 7474 6572  top.fget).setter
-00029400: 2853 697a 652e 7365 7175 656e 6365 5f73  (Size.sequence_s
-00029410: 746f 702e 6673 6574 290a 2020 2020 7469  top.fset).    ti
-00029420: 6d65 5f72 616e 6765 203d 2073 6572 6965  me_range = serie
-00029430: 735f 7261 6e67 6520 3d20 7365 7175 656e  s_range = sequen
-00029440: 6365 5f72 616e 6765 203d 2070 726f 7065  ce_range = prope
-00029450: 7274 7928 5369 7a65 2e73 6571 7565 6e63  rty(Size.sequenc
-00029460: 655f 7261 6e67 652e 6667 6574 292e 7365  e_range.fget).se
-00029470: 7474 6572 2853 697a 652e 7365 7175 656e  tter(Size.sequen
-00029480: 6365 5f72 616e 6765 2e66 7365 7429 0a20  ce_range.fset). 
-00029490: 2020 206e 7469 6d65 203d 206e 7469 6d65     ntime = ntime
-000294a0: 6c69 6e65 203d 206e 7365 7269 6573 203d  line = nseries =
-000294b0: 206e 7365 7175 656e 6365 203d 205c 0a20   nsequence = \. 
-000294c0: 2020 206e 5f74 696d 6520 3d20 6e5f 7469     n_time = n_ti
-000294d0: 6d65 6c69 6e65 203d 206e 5f73 6572 6965  meline = n_serie
-000294e0: 7320 3d20 6e5f 7365 7175 656e 6365 203d  s = n_sequence =
-000294f0: 2070 726f 7065 7274 7928 6c61 6d62 6461   property(lambda
-00029500: 2073 656c 663a 2053 697a 652e 6e5f 7365   self: Size.n_se
-00029510: 7175 656e 6365 2e66 6765 7428 7365 6c66  quence.fget(self
-00029520: 2e73 6861 7065 2929 0a20 2020 2074 696d  .shape)).    tim
-00029530: 655f 7369 7a65 203d 2073 6572 6965 735f  e_size = series_
-00029540: 7369 7a65 203d 2073 6571 7565 6e63 655f  size = sequence_
-00029550: 7369 7a65 203d 205c 0a20 2020 2074 696d  size = \.    tim
-00029560: 6520 3d20 7365 7269 6573 203d 2073 6571  e = series = seq
-00029570: 7565 6e63 6520 3d20 7072 6f70 6572 7479  uence = property
-00029580: 286c 616d 6264 6120 7365 6c66 3a20 5369  (lambda self: Si
-00029590: 7a65 2e73 6571 7565 6e63 652e 6667 6574  ze.sequence.fget
-000295a0: 2873 656c 662e 7368 6170 6529 290a 2020  (self.shape)).  
-000295b0: 2020 0a20 2020 2068 6173 5f73 7061 6365    .    has_space
-000295c0: 203d 2070 726f 7065 7274 7928 5369 7a65   = property(Size
-000295d0: 2e68 6173 5f73 7061 6365 2e66 6765 7429  .has_space.fget)
-000295e0: 0a20 2020 2069 735f 7370 6163 6564 696d  .    is_spacedim
-000295f0: 203d 2069 735f 7370 6163 655f 6469 6d20   = is_space_dim 
-00029600: 3d20 5369 7a65 2e69 735f 7370 6163 655f  = Size.is_space_
-00029610: 6469 6d0a 2020 2020 6e73 7061 6365 6469  dim.    nspacedi
-00029620: 6d20 3d20 6e5f 7370 6163 655f 6469 6d20  m = n_space_dim 
-00029630: 3d20 7072 6f70 6572 7479 2853 697a 652e  = property(Size.
-00029640: 6e5f 7370 6163 655f 6469 6d2e 6667 6574  n_space_dim.fget
-00029650: 290a 2020 2020 7370 6163 655f 7374 6172  ).    space_star
-00029660: 7420 3d20 7072 6f70 6572 7479 2853 697a  t = property(Siz
-00029670: 652e 7370 6163 655f 7374 6172 742e 6667  e.space_start.fg
-00029680: 6574 290a 2020 2020 7370 6163 655f 7374  et).    space_st
-00029690: 6f70 203d 2070 726f 7065 7274 7928 5369  op = property(Si
-000296a0: 7a65 2e73 7061 6365 5f73 746f 702e 6667  ze.space_stop.fg
-000296b0: 6574 290a 2020 2020 7370 6163 655f 7261  et).    space_ra
-000296c0: 6e67 6520 3d20 7072 6f70 6572 7479 2853  nge = property(S
-000296d0: 697a 652e 7370 6163 655f 7261 6e67 652e  ize.space_range.
-000296e0: 6667 6574 290a 2020 2020 6e73 7061 6365  fget).    nspace
-000296f0: 203d 206e 5f73 7061 6365 203d 2070 726f   = n_space = pro
-00029700: 7065 7274 7928 6c61 6d62 6461 2073 656c  perty(lambda sel
-00029710: 663a 2053 697a 652e 6e5f 7370 6163 652e  f: Size.n_space.
-00029720: 6667 6574 2873 656c 662e 7368 6170 6529  fget(self.shape)
-00029730: 290a 2020 2020 7370 6163 655f 7369 7a65  ).    space_size
-00029740: 203d 2073 7061 6365 203d 2070 726f 7065   = space = prope
-00029750: 7274 7928 6c61 6d62 6461 2073 656c 663a  rty(lambda self:
-00029760: 2053 697a 652e 7370 6163 652e 6667 6574   Size.space.fget
-00029770: 2873 656c 662e 7368 6170 6529 290a 0a20  (self.shape)).. 
-00029780: 2020 2068 6173 5f73 7065 6369 616c 203d     has_special =
-00029790: 2070 726f 7065 7274 7928 5369 7a65 2e68   property(Size.h
-000297a0: 6173 5f73 7065 6369 616c 2e66 6765 7429  as_special.fget)
-000297b0: 0a20 2020 206e 7370 6563 6961 6c64 696d  .    nspecialdim
-000297c0: 203d 206e 5f73 7065 6369 616c 5f64 696d   = n_special_dim
-000297d0: 203d 2070 726f 7065 7274 7928 5369 7a65   = property(Size
-000297e0: 2e6e 7370 6563 6961 6c64 696d 2e66 6765  .nspecialdim.fge
-000297f0: 7429 0a20 2020 2073 7065 6369 616c 5f64  t).    special_d
-00029800: 696d 7320 3d20 7072 6f70 6572 7479 2853  ims = property(S
-00029810: 697a 652e 7370 6563 6961 6c5f 6469 6d73  ize.special_dims
-00029820: 2e66 6765 7429 0a20 2020 2064 6566 2061  .fget).    def a
-00029830: 6464 5f73 7065 6369 616c 5f64 696d 2873  dd_special_dim(s
-00029840: 656c 662c 202a 6172 6773 2c20 2a2a 6b77  elf, *args, **kw
-00029850: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
-00029860: 656c 662e 7368 6170 6520 3d20 5369 7a65  elf.shape = Size
-00029870: 2e61 6464 5f73 7065 6369 616c 5f64 696d  .add_special_dim
-00029880: 2873 656c 662e 7368 6170 652c 202a 6172  (self.shape, *ar
-00029890: 6773 2c20 2a2a 6b77 6172 6773 290a 2020  gs, **kwargs).  
-000298a0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-000298b0: 660a 2020 2020 6465 6620 6368 616e 6765  f.    def change
-000298c0: 5f73 7065 6369 616c 5f64 696d 2873 656c  _special_dim(sel
-000298d0: 662c 202a 6172 6773 2c20 2a2a 6b77 6172  f, *args, **kwar
-000298e0: 6773 293a 0a20 2020 2020 2020 2073 656c  gs):.        sel
-000298f0: 662e 7368 6170 6520 3d20 5369 7a65 2e63  f.shape = Size.c
-00029900: 6861 6e67 655f 7370 6563 6961 6c5f 6469  hange_special_di
-00029910: 6d28 7365 6c66 2e73 6861 7065 2c20 2a61  m(self.shape, *a
-00029920: 7267 732c 202a 2a6b 7761 7267 7329 0a20  rgs, **kwargs). 
-00029930: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00029940: 6c66 0a20 2020 2073 7065 6369 616c 5f66  lf.    special_f
-00029950: 726f 6d20 3d20 5369 7a65 2e73 7065 6369  rom = Size.speci
-00029960: 616c 5f66 726f 6d0a 2020 2020 7570 6461  al_from.    upda
-00029970: 7465 5f73 7065 6369 616c 5f66 726f 6d20  te_special_from 
-00029980: 3d20 5369 7a65 2e75 7064 6174 655f 7370  = Size.update_sp
-00029990: 6563 6961 6c5f 6672 6f6d 0a20 2020 2069  ecial_from.    i
-000299a0: 6e69 745f 7370 6563 6961 6c20 3d20 5369  nit_special = Si
-000299b0: 7a65 2e69 6e69 745f 7370 6563 6961 6c0a  ze.init_special.
-000299c0: 2020 2020 6973 5f73 7065 6369 616c 6469      is_specialdi
-000299d0: 6d20 3d20 6973 5f73 7065 6369 616c 5f64  m = is_special_d
-000299e0: 696d 203d 2053 697a 652e 6973 5f73 7065  im = Size.is_spe
-000299f0: 6369 616c 5f64 696d 0a20 2020 206e 656c  cial_dim.    nel
-00029a00: 6520 3d20 6e5f 656c 6520 3d20 7072 6f70  e = n_ele = prop
-00029a10: 6572 7479 286c 616d 6264 6120 7365 6c66  erty(lambda self
-00029a20: 3a20 5369 7a65 2e6e 5f65 6c65 2e66 6765  : Size.n_ele.fge
-00029a30: 7428 7365 6c66 2e73 6861 7065 2929 0a20  t(self.shape)). 
-00029a40: 2020 206e 6469 6d20 3d20 6e5f 6469 6d20     ndim = n_dim 
-00029a50: 3d20 7072 6f70 6572 7479 286c 616d 6264  = property(lambd
-00029a60: 6120 7365 6c66 3a20 7375 7065 7228 292e  a self: super().
-00029a70: 6e64 696d 290a 2020 2020 7079 7468 6f6e  ndim).    python
-00029a80: 5f72 6570 7220 3d20 7072 6f70 6572 7479  _repr = property
-00029a90: 286c 616d 6264 6120 7365 6c66 3a20 7365  (lambda self: se
-00029aa0: 6c66 2e73 6861 7065 2e70 7974 686f 6e5f  lf.shape.python_
-00029ab0: 7265 7072 290a 2020 2020 0a20 2020 2064  repr).    .    d
-00029ac0: 6566 2068 6964 655f 7370 6563 6961 6c28  ef hide_special(
-00029ad0: 7365 6c66 293a 0a20 2020 2020 2020 2063  self):.        c
-00029ae0: 6c61 7373 2068 6964 655f 7370 6563 6961  lass hide_specia
-00029af0: 6c5f 6f70 6572 6174 6f72 3a0a 2020 2020  l_operator:.    
-00029b00: 2020 2020 2020 2020 6465 6620 5f5f 696e          def __in
-00029b10: 6974 5f5f 2873 656c 662c 2074 6869 7329  it__(self, this)
-00029b20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00029b30: 2020 7365 6c66 2e74 6869 7320 3d20 7468    self.this = th
-00029b40: 6973 0a20 2020 2020 2020 2020 2020 2064  is.            d
-00029b50: 6566 205f 5f65 6e74 6572 5f5f 2873 656c  ef __enter__(sel
-00029b60: 6629 3a0a 2020 2020 2020 2020 2020 2020  f):.            
-00029b70: 2020 2020 7365 6c66 2e73 7a5f 6675 6e63      self.sz_func
-00029b80: 5f64 696d 203d 2073 656c 662e 7468 6973  _dim = self.this
-00029b90: 2e73 7a5f 6675 6e63 5f64 696d 0a20 2020  .sz_func_dim.   
-00029ba0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00029bb0: 662e 737a 5f62 6174 6368 5f64 696d 203d  f.sz_batch_dim =
-00029bc0: 2073 656c 662e 7468 6973 2e73 7a5f 6261   self.this.sz_ba
-00029bd0: 7463 685f 6469 6d0a 2020 2020 2020 2020  tch_dim.        
-00029be0: 2020 2020 2020 2020 7365 6c66 2e73 7a5f          self.sz_
-00029bf0: 6665 6174 7572 655f 6469 6d20 3d20 7365  feature_dim = se
-00029c00: 6c66 2e74 6869 732e 737a 5f66 6561 7475  lf.this.sz_featu
-00029c10: 7265 5f64 696d 0a20 2020 2020 2020 2020  re_dim.         
-00029c20: 2020 2020 2020 2073 656c 662e 737a 5f73         self.sz_s
-00029c30: 6571 7565 6e63 655f 6469 6d20 3d20 7365  equence_dim = se
-00029c40: 6c66 2e74 6869 732e 737a 5f73 6571 7565  lf.this.sz_seque
-00029c50: 6e63 655f 6469 6d0a 2020 2020 2020 2020  nce_dim.        
-00029c60: 2020 2020 2020 2020 7365 6c66 2e74 6869          self.thi
-00029c70: 732e 696e 6974 5f73 7065 6369 616c 2829  s.init_special()
-00029c80: 0a20 2020 2020 2020 2020 2020 2064 6566  .            def
-00029c90: 205f 5f65 7869 745f 5f28 7365 6c66 2c20   __exit__(self, 
-00029ca0: 6578 635f 7479 7065 2c20 6578 635f 7661  exc_type, exc_va
-00029cb0: 6c75 652c 2074 7261 6365 6261 636b 293a  lue, traceback):
-00029cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029cd0: 2073 656c 662e 7468 6973 2e73 7a5f 6675   self.this.sz_fu
-00029ce0: 6e63 5f64 696d 203d 2073 656c 662e 737a  nc_dim = self.sz
-00029cf0: 5f66 756e 635f 6469 6d0a 2020 2020 2020  _func_dim.      
-00029d00: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
-00029d10: 6869 732e 737a 5f62 6174 6368 5f64 696d  his.sz_batch_dim
-00029d20: 203d 2073 656c 662e 737a 5f62 6174 6368   = self.sz_batch
-00029d30: 5f64 696d 0a20 2020 2020 2020 2020 2020  _dim.           
-00029d40: 2020 2020 2073 656c 662e 7468 6973 2e73       self.this.s
-00029d50: 7a5f 6665 6174 7572 655f 6469 6d20 3d20  z_feature_dim = 
-00029d60: 7365 6c66 2e73 7a5f 6665 6174 7572 655f  self.sz_feature_
-00029d70: 6469 6d0a 2020 2020 2020 2020 2020 2020  dim.            
-00029d80: 2020 2020 7365 6c66 2e74 6869 732e 737a      self.this.sz
-00029d90: 5f73 6571 7565 6e63 655f 6469 6d20 3d20  _sequence_dim = 
-00029da0: 7365 6c66 2e73 7a5f 7365 7175 656e 6365  self.sz_sequence
-00029db0: 5f64 696d 0a20 2020 2020 2020 2072 6574  _dim.        ret
-00029dc0: 7572 6e20 6869 6465 5f73 7065 6369 616c  urn hide_special
-00029dd0: 5f6f 7065 7261 746f 7228 7365 6c66 290a  _operator(self).
-00029de0: 2020 2020 0a20 2020 2064 6566 206e 756d      .    def num
-00029df0: 656c 2873 656c 662c 202a 6469 6d3a 2065  el(self, *dim: e
-00029e00: 7869 7374 5f64 696d 293a 0a20 2020 2020  xist_dim):.     
-00029e10: 2020 2064 696d 203d 2065 7869 7374 5f64     dim = exist_d
-00029e20: 696d 2873 656c 662c 202a 6469 6d29 0a20  im(self, *dim). 
-00029e30: 2020 2020 2020 2069 6620 6c65 6e28 6469         if len(di
-00029e40: 6d29 203e 2031 3a20 7265 7475 726e 2070  m) > 1: return p
-00029e50: 726f 645f 2873 656c 662e 7369 7a65 282a  rod_(self.size(*
-00029e60: 6469 6d29 290a 2020 2020 2020 2020 656c  dim)).        el
-00029e70: 6966 206c 656e 2864 696d 2920 3e20 303a  if len(dim) > 0:
-00029e80: 2072 6574 7572 6e20 7365 6c66 2e73 697a   return self.siz
-00029e90: 6528 6469 6d5b 305d 290a 2020 2020 2020  e(dim[0]).      
-00029ea0: 2020 7265 7475 726e 2031 0a20 2020 2064    return 1.    d
-00029eb0: 6566 2064 696d 2873 656c 6629 3a20 7265  ef dim(self): re
-00029ec0: 7475 726e 2073 7570 6572 2829 2e64 696d  turn super().dim
-00029ed0: 2829 0a0a 2020 2020 2320 4765 7420 616e  ()..    # Get an
-00029ee0: 6420 6173 7369 676e 2074 6865 2073 6861  d assign the sha
-00029ef0: 7065 2070 726f 7065 7274 792e 2054 6865  pe property. The
-00029f00: 2061 7373 6967 6e6d 656e 7420 6973 206f   assignment is o
-00029f10: 6e6c 7920 6163 6365 7373 6962 6c65 2066  nly accessible f
-00029f20: 6f72 2073 7065 6369 616c 2064 696d 656e  or special dimen
-00029f30: 7369 6f6e 732e 2041 7373 6967 6e69 6e67  sions. Assigning
-00029f40: 2069 6e63 6f6e 7369 7374 656e 7420 7368   inconsistent sh
-00029f50: 6170 6520 776f 756c 6420 7265 7375 6c74  ape would result
-00029f60: 2069 6e20 616e 2065 7272 6f72 2e20 0a20   in an error. . 
-00029f70: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-00029f80: 2064 6566 2073 6861 7065 2873 656c 6629   def shape(self)
-00029f90: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
-00029fa0: 2068 6173 6174 7472 2873 656c 662c 2027   hasattr(self, '
-00029fb0: 737a 5f66 756e 635f 6469 6d27 293a 0a20  sz_func_dim'):. 
-00029fc0: 2020 2020 2020 2020 2020 2070 7966 696c             pyfil
-00029fd0: 652c 206c 696e 656e 6f2c 206c 696e 6520  e, lineno, line 
-00029fe0: 3d20 6765 745f 7265 6665 7265 6e63 655f  = get_reference_
-00029ff0: 6c69 6e65 2873 6561 7263 685f 6d6f 7265  line(search_more
-0002a000: 3d54 7275 652c 2077 6974 685f 6c69 6e65  =True, with_line
-0002a010: 5f69 6e66 6f3d 5472 7565 290a 2020 2020  _info=True).    
-0002a020: 2020 2020 2020 2020 7261 6973 6520 4174          raise At
-0002a030: 7472 6962 7574 6545 7272 6f72 2866 2247  tributeError(f"G
-0002a040: 6574 7469 6e67 2062 6174 6f72 6368 2073  etting batorch s
-0002a050: 6861 7065 2066 726f 6d20 616e 2075 6e69  hape from an uni
-0002a060: 6e69 7469 616c 697a 6564 2054 656e 736f  nitialized Tenso
-0002a070: 7220 6f62 6a65 6374 206f 6620 7369 7a65  r object of size
-0002a080: 207b 7375 7065 7228 292e 7368 6170 657d   {super().shape}
-0002a090: 2c20 696e 206c 696e 6520 7b6c 696e 656e  , in line {linen
-0002a0a0: 6f7d 2c20 7b70 7966 696c 657d 3a20 5c6e  o}, {pyfile}: \n
-0002a0b0: 7b6c 696e 657d 2229 0a20 2020 2020 2020  {line}").       
-0002a0c0: 2072 6574 7572 6e20 5369 7a65 2e5f 5f6e   return Size.__n
-0002a0d0: 6577 5f72 6177 5f5f 2873 7570 6572 2829  ew_raw__(super()
-0002a0e0: 2e73 6861 7065 2c20 737a 5f66 756e 635f  .shape, sz_func_
-0002a0f0: 6469 6d3d 7365 6c66 2e73 7a5f 6675 6e63  dim=self.sz_func
-0002a100: 5f64 696d 2c20 737a 5f62 6174 6368 5f64  _dim, sz_batch_d
-0002a110: 696d 3d73 656c 662e 737a 5f62 6174 6368  im=self.sz_batch
-0002a120: 5f64 696d 2c20 737a 5f66 6561 7475 7265  _dim, sz_feature
-0002a130: 5f64 696d 3d73 656c 662e 737a 5f66 6561  _dim=self.sz_fea
-0002a140: 7475 7265 5f64 696d 2c20 737a 5f73 6571  ture_dim, sz_seq
-0002a150: 7565 6e63 655f 6469 6d3d 7365 6c66 2e73  uence_dim=self.s
-0002a160: 7a5f 7365 7175 656e 6365 5f64 696d 290a  z_sequence_dim).
-0002a170: 2020 2020 0a20 2020 2040 7368 6170 652e      .    @shape.
-0002a180: 7365 7474 6572 0a20 2020 2064 6566 2073  setter.    def s
-0002a190: 6861 7065 2873 656c 662c 202a 7829 3a20  hape(self, *x): 
-0002a1a0: 7265 7475 726e 2073 656c 662e 7769 7468  return self.with
-0002a1b0: 5f73 6861 7065 282a 7829 0a0a 2020 2020  _shape(*x)..    
-0002a1c0: 6465 6620 7369 7a65 2873 656c 662c 202a  def size(self, *
-0002a1d0: 6469 6d3a 2065 7869 7374 5f64 696d 293a  dim: exist_dim):
-0002a1e0: 0a20 2020 2020 2020 2064 696d 203d 2065  .        dim = e
-0002a1f0: 7869 7374 5f64 696d 2873 656c 662c 2064  xist_dim(self, d
-0002a200: 696d 290a 2020 2020 2020 2020 7769 7468  im).        with
-0002a210: 2074 6f72 6368 2e5f 432e 4469 7361 626c   torch._C.Disabl
-0002a220: 6554 6f72 6368 4675 6e63 7469 6f6e 2829  eTorchFunction()
-0002a230: 3a0a 2020 2020 2020 2020 2020 2020 7369  :.            si
-0002a240: 7a65 7320 3d20 7475 706c 6528 746f 7263  zes = tuple(torc
-0002a250: 685f 7375 7065 7228 7365 6c66 2c20 2773  h_super(self, 's
-0002a260: 697a 6527 2928 6429 2066 6f72 2064 2069  ize')(d) for d i
-0002a270: 6e20 6469 6d29 0a20 2020 2020 2020 2069  n dim).        i
-0002a280: 6620 6c65 6e28 6469 6d29 203e 2031 3a20  f len(dim) > 1: 
-0002a290: 7265 7475 726e 2073 697a 6573 0a20 2020  return sizes.   
-0002a2a0: 2020 2020 2065 6c73 653a 2072 6574 7572       else: retur
-0002a2b0: 6e20 7369 7a65 735b 305d 0a20 2020 200a  n sizes[0].    .
-0002a2c0: 2020 2020 6465 6620 7769 7468 5f73 6861      def with_sha
-0002a2d0: 7065 2873 656c 662c 202a 7829 3a0a 2020  pe(self, *x):.  
-0002a2e0: 2020 2020 2020 7820 3d20 6172 675f 6578        x = arg_ex
-0002a2f0: 7472 6163 7428 7829 0a20 2020 2020 2020  tract(x).       
-0002a300: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
-0002a310: 2c20 5465 6e73 6f72 293a 2078 203d 2078  , Tensor): x = x
-0002a320: 2e73 6861 7065 0a20 2020 2020 2020 2069  .shape.        i
-0002a330: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-0002a340: 2878 2c20 5369 7a65 293a 2078 203d 2053  (x, Size): x = S
-0002a350: 697a 6528 7829 0a20 2020 2020 2020 2077  ize(x).        w
-0002a360: 6974 6820 746f 7263 682e 5f43 2e44 6973  ith torch._C.Dis
-0002a370: 6162 6c65 546f 7263 6846 756e 6374 696f  ableTorchFunctio
-0002a380: 6e28 293a 0a20 2020 2020 2020 2020 2020  n():.           
-0002a390: 2061 766f 7563 6828 616c 6c5f 2875 203d   avouch(all_(u =
-0002a3a0: 3d20 7620 6f72 2076 203d 3d20 2d31 2066  = v or v == -1 f
-0002a3b0: 6f72 2075 2c20 7620 696e 207a 6970 2873  or u, v in zip(s
-0002a3c0: 7570 6572 2829 2e73 6861 7065 2c20 782e  uper().shape, x.
-0002a3d0: 7475 706c 6528 2929 292c 2066 2243 616e  tuple())), f"Can
-0002a3e0: 6e6f 7420 6173 7369 676e 2073 6861 7065  not assign shape
-0002a3f0: 207b 787d 2074 6f20 7465 6e73 6f72 2077   {x} to tensor w
-0002a400: 6974 6820 6461 7461 2073 6861 7065 207b  ith data shape {
-0002a410: 7475 706c 6528 7375 7065 7228 292e 7368  tuple(super().sh
-0002a420: 6170 6529 7d2c 2064 7565 2074 6f20 756e  ape)}, due to un
-0002a430: 6571 7561 6c20 7369 7a65 732e 2022 290a  equal sizes. ").
-0002a440: 2020 2020 2020 2020 7365 6c66 2e73 7065          self.spe
-0002a450: 6369 616c 5f66 726f 6d28 7829 0a20 2020  cial_from(x).   
-0002a460: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0002a470: 0a20 2020 200a 2020 2020 2320 436f 6e74  .    .    # Cont
-0002a480: 726f 6c20 7468 6520 736c 6963 696e 6720  rol the slicing 
-0002a490: 7379 7374 656d 2e20 0a20 2020 2064 6566  system. .    def
-0002a4a0: 205f 5f67 6574 6974 656d 5f5f 2873 656c   __getitem__(sel
-0002a4b0: 662c 2069 6e64 6963 6573 293a 0a20 2020  f, indices):.   
-0002a4c0: 2020 2020 2073 6861 7065 7320 3d20 5b5d       shapes = []
-0002a4d0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-0002a4e0: 7374 616e 6365 2869 6e64 6963 6573 2c20  stance(indices, 
-0002a4f0: 2873 6c69 6365 2c20 746f 7263 682e 5465  (slice, torch.Te
-0002a500: 6e73 6f72 2929 206f 7220 696e 6469 6365  nsor)) or indice
-0002a510: 7320 6973 202e 2e2e 3a20 696e 6469 6365  s is ...: indice
-0002a520: 7320 3d20 2869 6e64 6963 6573 2c29 0a20  s = (indices,). 
-0002a530: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0002a540: 616e 6365 2869 6e64 6963 6573 2c20 7475  ance(indices, tu
-0002a550: 706c 6529 3a0a 2020 2020 2020 2020 2020  ple):.          
-0002a560: 2020 7371 7565 657a 655f 6469 6d73 203d    squeeze_dims =
-0002a570: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-0002a580: 756e 7371 7565 657a 655f 6469 6d73 203d  unsqueeze_dims =
-0002a590: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-0002a5a0: 6f66 6673 6574 203d 2030 0a20 2020 2020  offset = 0.     
-0002a5b0: 2020 2020 2020 2066 6f72 2069 2c20 7820         for i, x 
-0002a5c0: 696e 2065 6e75 6d65 7261 7465 2869 6e64  in enumerate(ind
-0002a5d0: 6963 6573 293a 0a20 2020 2020 2020 2020  ices):.         
-0002a5e0: 2020 2020 2020 2069 202b 3d20 6f66 6673         i += offs
-0002a5f0: 6574 0a20 2020 2020 2020 2020 2020 2020  et.             
-0002a600: 2020 2069 6620 7820 6973 202e 2e2e 3a20     if x is ...: 
-0002a610: 6f66 6673 6574 202b 3d20 7365 6c66 2e6e  offset += self.n
-0002a620: 5f64 696d 202d 206c 656e 2869 6e64 6963  _dim - len(indic
-0002a630: 6573 293b 2063 6f6e 7469 6e75 650a 2020  es); continue.  
-0002a640: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0002a650: 2069 7369 6e73 7461 6e63 6528 782c 2069   isinstance(x, i
-0002a660: 6e74 5f29 3a20 7371 7565 657a 655f 6469  nt_): squeeze_di
-0002a670: 6d73 2e61 7070 656e 6428 6929 3b20 636f  ms.append(i); co
-0002a680: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
-0002a690: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0002a6a0: 616e 6365 2878 2c20 736c 6963 6529 3a20  ance(x, slice): 
-0002a6b0: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-0002a6c0: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-0002a6d0: 7374 616e 6365 2878 2c20 746f 7263 682e  stance(x, torch.
-0002a6e0: 5465 6e73 6f72 293a 0a20 2020 2020 2020  Tensor):.       
-0002a6f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0002a700: 6973 7375 6263 6c61 7373 2878 2e64 7479  issubclass(x.dty
-0002a710: 7065 2c20 6474 7970 655f 2862 6f6f 6c29  pe, dtype_(bool)
-0002a720: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0002a730: 2020 2020 2020 2020 2020 2061 766f 7563             avouc
-0002a740: 6828 7365 6c66 2e73 6861 7065 5b69 3a69  h(self.shape[i:i
-0002a750: 2b78 2e6e 5f64 696d 5d20 3d3d 2078 2e73  +x.n_dim] == x.s
-0002a760: 6861 7065 2c20 5479 7065 4572 726f 7228  hape, TypeError(
-0002a770: 2242 6f6f 6c20 696e 6469 6365 7320 666f  "Bool indices fo
-0002a780: 7220 7465 6e73 6f72 2073 686f 756c 6420  r tensor should 
-0002a790: 6265 206f 6620 6578 6163 7420 7361 6d65  be of exact same
-0002a7a0: 2073 697a 6520 6173 2074 6865 2069 6e70   size as the inp
-0002a7b0: 7574 2074 656e 736f 722e 2022 2929 0a20  ut tensor. ")). 
-0002a7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a7d0: 2020 2020 2020 206f 6666 7365 7420 2b3d         offset +=
-0002a7e0: 2078 2e6e 5f64 696d 0a20 2020 2020 2020   x.n_dim.       
-0002a7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a800: 2075 6e73 7175 6565 7a65 5f64 696d 732e   unsqueeze_dims.
-0002a810: 6170 7065 6e64 2828 6920 2b20 6c65 6e28  append((i + len(
-0002a820: 756e 7371 7565 657a 655f 6469 6d73 2920  unsqueeze_dims) 
-0002a830: 2d20 6c65 6e28 7371 7565 657a 655f 6469  - len(squeeze_di
-0002a840: 6d73 292c 2078 2e73 6861 7065 5b3a 315d  ms), x.shape[:1]
-0002a850: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-0002a860: 2020 2020 2020 2020 2020 2073 7175 6565             squee
-0002a870: 7a65 5f64 696d 732e 6578 7465 6e64 2872  ze_dims.extend(r
-0002a880: 616e 6765 5f28 692c 2069 202b 2078 2e6e  ange_(i, i + x.n
-0002a890: 5f64 696d 2929 0a20 2020 2020 2020 2020  _dim)).         
-0002a8a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002a8b0: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-0002a8c0: 2020 2020 2020 2020 2020 2020 7368 6170              shap
-0002a8d0: 6573 2e61 7070 656e 6428 782e 7368 6170  es.append(x.shap
-0002a8e0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-0002a8f0: 2020 2065 6c73 653a 2073 6861 7065 732e     else: shapes.
-0002a900: 6170 7065 6e64 2854 656e 736f 7228 7829  append(Tensor(x)
-0002a910: 2e73 6861 7065 290a 2020 2020 2020 2020  .shape).        
-0002a920: 2020 2020 2020 2020 7371 7565 657a 655f          squeeze_
-0002a930: 6469 6d73 2e61 7070 656e 6428 6929 0a20  dims.append(i). 
-0002a940: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
-0002a950: 7374 616e 6365 2869 6e64 6963 6573 2c20  stance(indices, 
-0002a960: 696e 745f 293a 2073 7175 6565 7a65 5f64  int_): squeeze_d
-0002a970: 696d 7320 3d20 5b30 5d3b 2075 6e73 7175  ims = [0]; unsqu
-0002a980: 6565 7a65 5f64 696d 7320 3d20 5b5d 0a20  eeze_dims = []. 
-0002a990: 2020 2020 2020 2065 6c73 653a 2072 6169         else: rai
-0002a9a0: 7365 2054 7970 6545 7272 6f72 2866 2249  se TypeError(f"I
-0002a9b0: 6e76 616c 6964 2069 6e64 6963 6573 203d  nvalid indices =
-0002a9c0: 207b 696e 6469 6365 737d 2066 6f72 2074   {indices} for t
-0002a9d0: 656e 736f 7220 696e 6465 7869 6e67 2e20  ensor indexing. 
-0002a9e0: 2229 0a20 2020 2020 2020 2069 6620 7371  ").        if sq
-0002a9f0: 7565 657a 655f 6469 6d73 2061 6e64 2061  ueeze_dims and a
-0002aa00: 6c6c 5f28 7920 2d20 7820 3d3d 2031 2066  ll_(y - x == 1 f
-0002aa10: 6f72 2078 2c20 7920 696e 207a 6970 2873  or x, y in zip(s
-0002aa20: 7175 6565 7a65 5f64 696d 735b 3a2d 315d  queeze_dims[:-1]
-0002aa30: 2c20 7371 7565 657a 655f 6469 6d73 5b31  , squeeze_dims[1
-0002aa40: 3a5d 2929 3a0a 2020 2020 2020 2020 2020  :])):.          
-0002aa50: 2020 6e65 775f 7368 6170 6520 3d20 7365    new_shape = se
-0002aa60: 6c66 2e73 6861 7065 5b3a 7371 7565 657a  lf.shape[:squeez
-0002aa70: 655f 6469 6d73 5b30 5d5d 202b 2062 726f  e_dims[0]] + bro
-0002aa80: 6164 6361 7374 282a 7368 6170 6573 2920  adcast(*shapes) 
-0002aa90: 2b20 7365 6c66 2e73 6861 7065 5b73 7175  + self.shape[squ
-0002aaa0: 6565 7a65 5f64 696d 735b 2d31 5d2b 313a  eeze_dims[-1]+1:
-0002aab0: 5d0a 2020 2020 2020 2020 656c 7365 3a20  ].        else: 
-0002aac0: 6e65 775f 7368 6170 6520 3d20 6272 6f61  new_shape = broa
-0002aad0: 6463 6173 7428 2a73 6861 7065 7329 202b  dcast(*shapes) +
-0002aae0: 2072 656d 6f76 655f 6469 6d28 7365 6c66   remove_dim(self
-0002aaf0: 2e73 6861 7065 2c20 7371 7565 657a 655f  .shape, squeeze_
-0002ab00: 6469 6d73 290a 2020 2020 2020 2020 666f  dims).        fo
-0002ab10: 7220 692c 2078 2069 6e20 756e 7371 7565  r i, x in unsque
-0002ab20: 657a 655f 6469 6d73 3a0a 2020 2020 2020  eze_dims:.      
-0002ab30: 2020 2020 2020 6e65 775f 7368 6170 6520        new_shape 
-0002ab40: 3d20 6e65 775f 7368 6170 655b 3a69 5d20  = new_shape[:i] 
-0002ab50: 2b20 7820 2b20 6e65 775f 7368 6170 655b  + x + new_shape[
-0002ab60: 693a 5d0a 2020 2020 2020 2020 7769 7468  i:].        with
-0002ab70: 2074 6f72 6368 2e5f 432e 4469 7361 626c   torch._C.Disabl
-0002ab80: 6554 6f72 6368 4675 6e63 7469 6f6e 2829  eTorchFunction()
-0002ab90: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0002aba0: 7475 726e 2074 6f72 6368 2e54 656e 736f  turn torch.Tenso
-0002abb0: 722e 5f5f 6765 7469 7465 6d5f 5f28 7365  r.__getitem__(se
-0002abc0: 6c66 2c20 696e 6469 6365 7329 2e61 735f  lf, indices).as_
-0002abd0: 7375 6263 6c61 7373 2854 656e 736f 7229  subclass(Tensor)
-0002abe0: 2e73 7065 6369 616c 5f66 726f 6d28 6e65  .special_from(ne
-0002abf0: 775f 7368 6170 6529 2e67 7261 645f 666e  w_shape).grad_fn
-0002ac00: 5f6e 616d 655f 2822 696e 6465 7869 6e67  _name_("indexing
-0002ac10: 2229 0a20 2020 2020 2020 2020 2020 2023  ").            #
-0002ac20: 2072 6574 7572 6e20 5465 6e73 6f72 2e5f   return Tensor._
-0002ac30: 6d61 6b65 5f73 7562 636c 6173 7328 5465  make_subclass(Te
-0002ac40: 6e73 6f72 2c20 7375 7065 7228 292e 5f5f  nsor, super().__
-0002ac50: 6765 7469 7465 6d5f 5f28 696e 6469 6365  getitem__(indice
-0002ac60: 7329 2e61 735f 7375 6263 6c61 7373 2874  s).as_subclass(t
-0002ac70: 6f72 6368 2e54 656e 736f 7229 2c20 7265  orch.Tensor), re
-0002ac80: 665f 7369 7a65 3d6e 6577 5f73 6861 7065  f_size=new_shape
-0002ac90: 292e 6772 6164 5f66 6e5f 6e61 6d65 5f28  ).grad_fn_name_(
-0002aca0: 2269 6e64 6578 696e 6722 290a 2020 2020  "indexing").    
-0002acb0: 0a20 2020 2064 6566 205f 5f69 7465 725f  .    def __iter_
-0002acc0: 5f28 7365 6c66 293a 0a20 2020 2020 2020  _(self):.       
-0002acd0: 2066 6f72 2069 2069 6e20 7261 6e67 655f   for i in range_
-0002ace0: 2873 656c 662e 7369 7a65 2830 2929 3a0a  (self.size(0)):.
-0002acf0: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
-0002ad00: 6420 7365 6c66 5b69 5d0a 2020 2020 2020  d self[i].      
-0002ad10: 2020 0a20 2020 2023 204d 616e 6970 756c    .    # Manipul
-0002ad20: 6174 6520 6469 6d65 6e73 696f 6e73 2e0a  ate dimensions..
-0002ad30: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-0002ad40: 2020 6465 6620 5428 7365 6c66 3a20 2754    def T(self: 'T
-0002ad50: 656e 736f 7227 2c20 6469 6d3a 206c 696e  ensor', dim: lin
-0002ad60: 616c 675f 6469 6d5b 313a 5d3d 4e6f 6e65  alg_dim[1:]=None
-0002ad70: 293a 0a20 2020 2020 2020 2073 6861 7065  ):.        shape
-0002ad80: 203d 2073 656c 662e 7368 6170 650a 2020   = self.shape.  
-0002ad90: 2020 2020 2020 6469 6d20 3d20 6c69 6e61        dim = lina
-0002ada0: 6c67 5f64 696d 5b31 3a5d 2873 656c 662e  lg_dim[1:](self.
-0002adb0: 7368 6170 652c 2064 696d 290a 2020 2020  shape, dim).    
-0002adc0: 2020 2020 6469 6d5f 6f72 6465 7220 3d20      dim_order = 
-0002add0: 5b69 2069 6620 6920 6e6f 7420 696e 2064  [i if i not in d
-0002ade0: 696d 2065 6c73 6520 6469 6d5b 2d64 696d  im else dim[-dim
-0002adf0: 2e69 6e64 6578 2869 2920 2d20 315d 2066  .index(i) - 1] f
-0002ae00: 6f72 2069 2069 6e20 7261 6e67 655f 2873  or i in range_(s
-0002ae10: 656c 662e 6e5f 6469 6d29 5d0a 2020 2020  elf.n_dim)].    
-0002ae20: 2020 2020 756e 7371 5f64 696d 203d 2073      unsq_dim = s
-0002ae30: 656c 662e 7368 6170 655b 6469 6d5b 305d  elf.shape[dim[0]
-0002ae40: 3a64 696d 5b30 5d2b 315d 2e77 6974 685f  :dim[0]+1].with_
-0002ae50: 6469 6d5f 7369 7a65 2830 2c20 6469 6d5b  dim_size(0, dim[
-0002ae60: 305d 292e 7079 7468 6f6e 5f72 6570 720a  0]).python_repr.
-0002ae70: 2020 2020 2020 2020 6966 206c 656e 2864          if len(d
-0002ae80: 696d 2920 3d3d 2031 3a20 7265 7475 726e  im) == 1: return
-0002ae90: 2073 656c 662e 7065 726d 7574 6528 2a64   self.permute(*d
-0002aea0: 696d 5f6f 7264 6572 292e 756e 7371 7565  im_order).unsque
-0002aeb0: 657a 6528 756e 7371 5f64 696d 292e 6772  eze(unsq_dim).gr
-0002aec0: 6164 5f66 6e5f 6e61 6d65 5f28 2774 7261  ad_fn_name_('tra
-0002aed0: 6e73 706f 7365 2729 0a20 2020 2020 2020  nspose').       
-0002aee0: 2072 6574 7572 6e20 7365 6c66 2e70 6572   return self.per
-0002aef0: 6d75 7465 282a 6469 6d5f 6f72 6465 7229  mute(*dim_order)
-0002af00: 2e67 7261 645f 666e 5f6e 616d 655f 2827  .grad_fn_name_('
-0002af10: 7472 616e 7370 6f73 6527 290a 2020 2020  transpose').    
-0002af20: 0a20 2020 2064 6566 2074 5f28 7365 6c66  .    def t_(self
-0002af30: 3a20 2754 656e 736f 7227 2c20 6469 6d3a  : 'Tensor', dim:
-0002af40: 206c 696e 616c 675f 6469 6d5b 313a 5d3d   linalg_dim[1:]=
-0002af50: 4e6f 6e65 293a 0a20 2020 2020 2020 2073  None):.        s
-0002af60: 6861 7065 203d 2073 656c 662e 7368 6170  hape = self.shap
-0002af70: 650a 2020 2020 2020 2020 6469 6d20 3d20  e.        dim = 
-0002af80: 6c69 6e61 6c67 5f64 696d 5b31 3a5d 2873  linalg_dim[1:](s
-0002af90: 656c 662e 7368 6170 652c 2064 696d 290a  elf.shape, dim).
-0002afa0: 2020 2020 2020 2020 6469 6d5f 6f72 6465          dim_orde
-0002afb0: 7220 3d20 5b69 2069 6620 6920 6e6f 7420  r = [i if i not 
-0002afc0: 696e 2064 696d 2065 6c73 6520 6469 6d5b  in dim else dim[
-0002afd0: 2d64 696d 2e69 6e64 6578 2869 2920 2d20  -dim.index(i) - 
-0002afe0: 315d 2066 6f72 2069 2069 6e20 7261 6e67  1] for i in rang
-0002aff0: 655f 2873 656c 662e 6e5f 6469 6d29 5d0a  e_(self.n_dim)].
-0002b000: 2020 2020 2020 2020 756e 7371 5f64 696d          unsq_dim
-0002b010: 203d 2073 656c 662e 7368 6170 655b 6469   = self.shape[di
-0002b020: 6d5b 305d 3a64 696d 5b30 5d2b 315d 2e77  m[0]:dim[0]+1].w
-0002b030: 6974 685f 6469 6d5f 7369 7a65 2830 2c20  ith_dim_size(0, 
-0002b040: 6469 6d5b 305d 292e 7079 7468 6f6e 5f72  dim[0]).python_r
-0002b050: 6570 720a 2020 2020 2020 2020 6966 206c  epr.        if l
-0002b060: 656e 2864 696d 2920 3d3d 2031 3a20 7265  en(dim) == 1: re
-0002b070: 7475 726e 2073 656c 662e 7065 726d 7574  turn self.permut
-0002b080: 6528 2a64 696d 5f6f 7264 6572 292e 756e  e(*dim_order).un
-0002b090: 7371 7565 657a 6528 756e 7371 5f64 696d  squeeze(unsq_dim
-0002b0a0: 292e 6772 6164 5f66 6e5f 6e61 6d65 5f28  ).grad_fn_name_(
-0002b0b0: 2774 7261 6e73 706f 7365 2729 0a20 2020  'transpose').   
-0002b0c0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0002b0d0: 2e70 6572 6d75 7465 5f28 2a64 696d 5f6f  .permute_(*dim_o
-0002b0e0: 7264 6572 292e 6772 6164 5f66 6e5f 6e61  rder).grad_fn_na
-0002b0f0: 6d65 5f28 2774 7261 6e73 706f 7365 5f27  me_('transpose_'
-0002b100: 290a 2020 2020 0a20 2020 2064 6566 2070  ).    .    def p
-0002b110: 6572 6d75 7465 5f28 7365 6c66 3a20 2754  ermute_(self: 'T
-0002b120: 656e 736f 7227 2c20 2a64 696d 733a 2065  ensor', *dims: e
-0002b130: 7869 7374 5f64 696d 293a 0a20 2020 2020  xist_dim):.     
-0002b140: 2020 2064 696d 7320 3d20 6578 6973 745f     dims = exist_
-0002b150: 6469 6d28 7365 6c66 2c20 2a64 696d 7329  dim(self, *dims)
-0002b160: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
-0002b170: 6c65 6e28 6469 6d73 2920 3d3d 2073 656c  len(dims) == sel
-0002b180: 662e 6e64 696d 2c20 5275 6e74 696d 6545  f.ndim, RuntimeE
-0002b190: 7272 6f72 2866 2270 6572 6d75 7465 5f28  rror(f"permute_(
-0002b1a0: 7370 6172 7365 5f63 6f6f 293a 206e 756d  sparse_coo): num
-0002b1b0: 6265 7220 6f66 2064 696d 656e 7369 6f6e  ber of dimension
-0002b1c0: 7320 696e 2074 6865 2074 656e 736f 7220  s in the tensor 
-0002b1d0: 696e 7075 7420 646f 6573 206e 6f74 206d  input does not m
-0002b1e0: 6174 6368 2074 6865 206c 656e 6774 6820  atch the length 
-0002b1f0: 6f66 2074 6865 2064 6573 6972 6564 206f  of the desired o
-0002b200: 7264 6572 696e 6720 6f66 2064 696d 656e  rdering of dimen
-0002b210: 7369 6f6e 7320 692e 652e 2069 6e70 7574  sions i.e. input
-0002b220: 2e64 696d 2829 203d 207b 7365 6c66 2e6e  .dim() = {self.n
-0002b230: 5f64 696d 7d20 6973 206e 6f74 2065 7175  _dim} is not equ
-0002b240: 616c 2074 6f20 6c65 6e28 6469 6d73 2920  al to len(dims) 
-0002b250: 3d20 7b6c 656e 2864 696d 7329 7d22 2929  = {len(dims)}"))
-0002b260: 0a20 2020 2020 2020 2063 7572 5f6f 7264  .        cur_ord
-0002b270: 6572 203d 206c 6973 7428 7261 6e67 655f  er = list(range_
-0002b280: 2873 656c 662e 6e64 696d 2929 0a20 2020  (self.ndim)).   
-0002b290: 2020 2020 2073 7065 6369 616c 5f73 6861       special_sha
-0002b2a0: 7065 203d 2073 656c 662e 7368 6170 650a  pe = self.shape.
-0002b2b0: 2020 2020 2020 2020 7365 6c66 2e69 6e69          self.ini
-0002b2c0: 745f 7370 6563 6961 6c28 290a 2020 2020  t_special().    
-0002b2d0: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-0002b2e0: 6765 5f28 6c65 6e28 6375 725f 6f72 6465  ge_(len(cur_orde
-0002b2f0: 7229 293a 0a20 2020 2020 2020 2020 2020  r)):.           
-0002b300: 206a 203d 2063 7572 5f6f 7264 6572 2e69   j = cur_order.i
-0002b310: 6e64 6578 2864 696d 735b 695d 290a 2020  ndex(dims[i]).  
-0002b320: 2020 2020 2020 2020 2020 6966 206a 203d            if j =
-0002b330: 3d20 693a 2063 6f6e 7469 6e75 650a 2020  = i: continue.  
-0002b340: 2020 2020 2020 2020 2020 6375 725f 6f72            cur_or
-0002b350: 6465 725b 695d 2c20 6375 725f 6f72 6465  der[i], cur_orde
-0002b360: 725b 6a5d 203d 2063 7572 5f6f 7264 6572  r[j] = cur_order
-0002b370: 5b6a 5d2c 2063 7572 5f6f 7264 6572 5b69  [j], cur_order[i
-0002b380: 5d0a 2020 2020 2020 2020 2020 2020 7365  ].            se
-0002b390: 6c66 2e74 7261 6e73 706f 7365 5f28 692c  lf.transpose_(i,
-0002b3a0: 206a 290a 2020 2020 2020 2020 7265 7475   j).        retu
-0002b3b0: 726e 2073 656c 662e 7370 6563 6961 6c5f  rn self.special_
-0002b3c0: 6672 6f6d 2873 7065 6369 616c 5f73 6861  from(special_sha
-0002b3d0: 7065 2e70 6572 6d75 7465 282a 6469 6d73  pe.permute(*dims
-0002b3e0: 2929 2e67 7261 645f 666e 5f6e 616d 655f  )).grad_fn_name_
-0002b3f0: 2827 7065 726d 7574 655f 2729 0a0a 2020  ('permute_')..  
-0002b400: 2020 4061 6c69 6173 2822 6d6f 7665 6469    @alias("movedi
-0002b410: 6d22 290a 2020 2020 6465 6620 6d6f 7665  m").    def move
-0002b420: 5f64 696d 2873 656c 662c 2064 696d 313a  _dim(self, dim1:
-0002b430: 2064 656c 5f64 696d 2c20 6469 6d32 3a20   del_dim, dim2: 
-0002b440: 6578 6973 745f 6469 6d29 3a0a 2020 2020  exist_dim):.    
-0002b450: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0002b460: 6d6f 7665 6469 6d28 7365 6c66 2c20 6469  movedim(self, di
-0002b470: 6d31 2c20 6469 6d32 2920 2d3e 2054 656e  m1, dim2) -> Ten
-0002b480: 736f 720a 0a20 2020 2020 2020 206d 6f76  sor..        mov
-0002b490: 6520 6469 6d31 2074 6f20 6469 6d32 2028  e dim1 to dim2 (
-0002b4a0: 7370 6563 6966 6965 6420 696e 2074 6865  specified in the
-0002b4b0: 2074 6172 6765 7469 6e67 2073 697a 6529   targeting size)
-0002b4c0: 0a20 2020 2020 2020 2064 6174 6120 6f66  .        data of
-0002b4d0: 2073 697a 6520 2832 2c20 332c 2034 2c20   size (2, 3, 4, 
-0002b4e0: 3529 2063 616e 2062 6520 7472 616e 7366  5) can be transf
-0002b4f0: 6f72 6d20 746f 2028 322c 2034 2c20 352c  orm to (2, 4, 5,
-0002b500: 2033 2920 6279 2064 6174 612e 6d6f 7665   3) by data.move
-0002b510: 6469 6d28 312c 202d 3129 206f 7220 6461  dim(1, -1) or da
-0002b520: 7461 2e6d 6f76 6564 696d 2831 2c20 3329  ta.movedim(1, 3)
-0002b530: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0002b540: 2020 2020 2072 6566 5f73 6861 7065 203d       ref_shape =
-0002b550: 2053 697a 6528 6469 6d32 290a 2020 2020   Size(dim2).    
-0002b560: 2020 2020 6469 6d31 203d 2064 656c 5f64      dim1 = del_d
-0002b570: 696d 2873 656c 662e 7368 6170 652c 2064  im(self.shape, d
-0002b580: 696d 3129 0a20 2020 2020 2020 2064 696d  im1).        dim
-0002b590: 3220 3d20 6578 6973 745f 6469 6d28 7365  2 = exist_dim(se
-0002b5a0: 6c66 2e73 6861 7065 2c20 6469 6d32 290a  lf.shape, dim2).
-0002b5b0: 2020 2020 2020 2020 6176 6f75 6368 286c          avouch(l
-0002b5c0: 656e 2864 696d 3129 203d 3d20 6c65 6e28  en(dim1) == len(
-0002b5d0: 6469 6d32 2920 6f72 206c 656e 2864 696d  dim2) or len(dim
-0002b5e0: 3229 3d3d 2031 2c20 2254 656e 736f 722e  2)== 1, "Tensor.
-0002b5f0: 6d6f 7665 5f64 696d 206f 6e6c 7920 7461  move_dim only ta
-0002b600: 6b65 7320 6469 6d65 6e73 696f 6e20 6f66  kes dimension of
-0002b610: 2073 616d 6520 7369 7a65 206f 7220 6f6e   same size or on
-0002b620: 6520 7461 7267 6574 2064 696d 2e22 290a  e target dim.").
-0002b630: 2020 2020 2020 2020 6966 206c 656e 2864          if len(d
-0002b640: 696d 3229 203d 3d20 313a 0a20 2020 2020  im2) == 1:.     
-0002b650: 2020 2020 2020 2064 3220 3d20 6469 6d32         d2 = dim2
-0002b660: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-0002b670: 6966 2061 6c6c 5f28 6420 3e20 6432 2066  if all_(d > d2 f
-0002b680: 6f72 2064 2069 6e20 6469 6d31 293a 0a20  or d in dim1):. 
-0002b690: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0002b6a0: 696d 656e 7369 6f6e 7320 3d20 6c69 7374  imensions = list
-0002b6b0: 2872 616e 6765 5f28 6432 2929 202b 206c  (range_(d2)) + l
-0002b6c0: 6973 7428 6469 6d31 2920 2b20 5b69 2066  ist(dim1) + [i f
-0002b6d0: 6f72 2069 2069 6e20 7261 6e67 655f 2864  or i in range_(d
-0002b6e0: 322c 2073 656c 662e 6e5f 6469 6d29 2069  2, self.n_dim) i
-0002b6f0: 6620 6920 6e6f 7420 696e 2064 696d 315d  f i not in dim1]
-0002b700: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0002b710: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002b720: 2020 2064 696d 656e 7369 6f6e 7320 3d20     dimensions = 
-0002b730: 5b69 2066 6f72 2069 2069 6e20 7261 6e67  [i for i in rang
-0002b740: 655f 2864 322b 3129 2069 6620 6920 6e6f  e_(d2+1) if i no
-0002b750: 7420 696e 2064 696d 315d 202b 206c 6973  t in dim1] + lis
-0002b760: 7428 6469 6d31 2920 2b20 5b69 2066 6f72  t(dim1) + [i for
-0002b770: 2069 2069 6e20 7261 6e67 655f 2864 322b   i in range_(d2+
-0002b780: 312c 2073 656c 662e 6e5f 6469 6d29 2069  1, self.n_dim) i
-0002b790: 6620 6920 6e6f 7420 696e 2064 696d 315d  f i not in dim1]
-0002b7a0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-0002b7b0: 203d 2073 656c 662e 7065 726d 7574 6528   = self.permute(
-0002b7c0: 2a64 696d 656e 7369 6f6e 7329 2e61 6464  *dimensions).add
-0002b7d0: 5f73 7065 6369 616c 5f64 696d 2864 322c  _special_dim(d2,
-0002b7e0: 2064 696d 3229 0a20 2020 2020 2020 2065   dim2).        e
-0002b7f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0002b800: 2064 696d 656e 7369 6f6e 7320 3d20 5b30   dimensions = [0
-0002b810: 5d20 2a20 7365 6c66 2e6e 5f64 696d 0a20  ] * self.n_dim. 
-0002b820: 2020 2020 2020 2020 2020 2061 7373 6967             assig
-0002b830: 6e65 6420 3d20 5b46 616c 7365 5d20 2a20  ned = [False] * 
-0002b840: 7365 6c66 2e6e 5f64 696d 0a20 2020 2020  self.n_dim.     
-0002b850: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-0002b860: 6469 6d31 3a0a 2020 2020 2020 2020 2020  dim1:.          
-0002b870: 2020 2020 2020 6a20 3d20 6469 6d32 5b64        j = dim2[d
-0002b880: 696d 312e 696e 6465 7828 6929 5d0a 2020  im1.index(i)].  
-0002b890: 2020 2020 2020 2020 2020 2020 2020 6469                di
-0002b8a0: 6d65 6e73 696f 6e73 5b6a 5d20 3d20 690a  mensions[j] = i.
-0002b8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b8c0: 6173 7369 676e 6564 5b6a 5d20 3d20 5472  assigned[j] = Tr
-0002b8d0: 7565 0a20 2020 2020 2020 2020 2020 2066  ue.            f
-0002b8e0: 6f72 2069 2069 6e20 7261 6e67 655f 2873  or i in range_(s
-0002b8f0: 656c 662e 6e5f 6469 6d29 3a0a 2020 2020  elf.n_dim):.    
-0002b900: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0002b910: 2069 6e20 6469 6d31 3a20 636f 6e74 696e   in dim1: contin
-0002b920: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-0002b930: 2020 206a 203d 2061 7373 6967 6e65 642e     j = assigned.
-0002b940: 696e 6465 7828 4661 6c73 6529 0a20 2020  index(False).   
-0002b950: 2020 2020 2020 2020 2020 2020 2064 696d               dim
-0002b960: 656e 7369 6f6e 735b 6a5d 203d 2069 0a20  ensions[j] = i. 
-0002b970: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0002b980: 7373 6967 6e65 645b 6a5d 203d 2054 7275  ssigned[j] = Tru
-0002b990: 650a 2020 2020 2020 2020 2020 2020 6176  e.            av
-0002b9a0: 6f75 6368 2861 6c6c 5f28 6173 7369 676e  ouch(all_(assign
-0002b9b0: 6564 292c 2052 756e 7469 6d65 4572 726f  ed), RuntimeErro
-0002b9c0: 7228 6622 4e6f 7420 7065 726d 7574 6520  r(f"Not permute 
-0002b9d0: 666f 7220 6469 6d65 6e73 696f 6e20 6d6f  for dimension mo
-0002b9e0: 7665 2069 6620 6469 6d31 3d7b 6469 6d31  ve if dim1={dim1
-0002b9f0: 7d20 616e 6420 6469 6d32 3d7b 6469 6d32  } and dim2={dim2
-0002ba00: 7d2e 2022 2929 0a20 2020 2020 2020 2020  }. ")).         
-0002ba10: 2020 2072 6573 203d 2073 656c 662e 7065     res = self.pe
-0002ba20: 726d 7574 6528 2a64 696d 656e 7369 6f6e  rmute(*dimension
-0002ba30: 7329 0a20 2020 2020 2020 2020 2020 2066  s).            f
-0002ba40: 6f72 2069 2069 6e20 7261 6e67 655f 286c  or i in range_(l
-0002ba50: 656e 2864 696d 3229 293a 0a20 2020 2020  en(dim2)):.     
-0002ba60: 2020 2020 2020 2020 2020 2072 6573 2e61             res.a
-0002ba70: 6464 5f73 7065 6369 616c 5f64 696d 2864  dd_special_dim(d
-0002ba80: 696d 325b 695d 2c20 6469 6d32 5b69 3a69  im2[i], dim2[i:i
-0002ba90: 2b31 5d29 0a20 2020 2020 2020 2072 6574  +1]).        ret
-0002baa0: 7572 6e20 7265 732e 6772 6164 5f66 6e5f  urn res.grad_fn_
-0002bab0: 6e61 6d65 5f28 276d 6f76 655f 6469 6d27  name_('move_dim'
-0002bac0: 290a 2020 2020 2020 2020 2020 2020 0a20  ).            . 
-0002bad0: 2020 2020 2020 2023 2064 3120 3d20 6469         # d1 = di
-0002bae0: 6d31 5b30 5d0a 2020 2020 2020 2020 2320  m1[0].        # 
-0002baf0: 6432 203d 2064 696d 325b 305d 0a0a 2020  d2 = dim2[0]..  
-0002bb00: 2020 2020 2020 2320 6966 2064 3120 3c20        # if d1 < 
-0002bb10: 6432 3a20 7265 7475 726e 2073 656c 662e  d2: return self.
-0002bb20: 7065 726d 7574 6528 2a72 616e 6765 2864  permute(*range(d
-0002bb30: 3129 2c20 2a72 616e 6765 2864 312b 312c  1), *range(d1+1,
-0002bb40: 2064 322b 3129 2c20 6431 2c20 2a72 616e   d2+1), d1, *ran
-0002bb50: 6765 2864 322b 312c 2073 656c 662e 6e5f  ge(d2+1, self.n_
-0002bb60: 6469 6d29 292e 6164 645f 7370 6563 6961  dim)).add_specia
-0002bb70: 6c5f 6469 6d28 6432 2c20 6469 6d32 290a  l_dim(d2, dim2).
-0002bb80: 2020 2020 2020 2020 2320 656c 6966 2064          # elif d
-0002bb90: 3120 3e20 6432 3a20 7265 7475 726e 2073  1 > d2: return s
-0002bba0: 656c 662e 7065 726d 7574 6528 2a72 616e  elf.permute(*ran
-0002bbb0: 6765 2864 3229 2c20 6431 2c20 2a72 616e  ge(d2), d1, *ran
-0002bbc0: 6765 2864 322c 2064 3129 2c20 2a72 616e  ge(d2, d1), *ran
-0002bbd0: 6765 2864 312b 312c 2073 656c 662e 6e5f  ge(d1+1, self.n_
-0002bbe0: 6469 6d29 292e 6164 645f 7370 6563 6961  dim)).add_specia
-0002bbf0: 6c5f 6469 6d28 6432 2c20 6469 6d32 290a  l_dim(d2, dim2).
-0002bc00: 2020 2020 2020 2020 2320 7265 7475 726e          # return
-0002bc10: 2073 656c 662e 6164 645f 7370 6563 6961   self.add_specia
-0002bc20: 6c5f 6469 6d28 6432 2c20 6469 6d32 292e  l_dim(d2, dim2).
-0002bc30: 6772 6164 5f66 6e5f 6e61 6d65 5f28 276d  grad_fn_name_('m
-0002bc40: 6f76 655f 6469 6d27 290a 0a20 2020 2040  ove_dim')..    @
-0002bc50: 616c 6961 7328 226d 6f76 6564 696d 5f22  alias("movedim_"
-0002bc60: 290a 2020 2020 6465 6620 6d6f 7665 5f64  ).    def move_d
-0002bc70: 696d 5f28 7365 6c66 2c20 6469 6d31 3a20  im_(self, dim1: 
-0002bc80: 6465 6c5f 6469 6d2c 2064 696d 323a 2065  del_dim, dim2: e
-0002bc90: 7869 7374 5f64 696d 293a 0a20 2020 2020  xist_dim):.     
-0002bca0: 2020 2022 2222 0a20 2020 2020 2020 2049     """.        I
-0002bcb0: 6e2d 706c 6163 6520 6f70 6572 6174 696f  n-place operatio
-0002bcc0: 6e20 666f 7220 6d6f 7665 6469 6d0a 2020  n for movedim.  
-0002bcd0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0002bce0: 2020 6469 6d31 203d 2064 656c 5f64 696d    dim1 = del_dim
-0002bcf0: 2873 656c 662e 7368 6170 652c 2064 696d  (self.shape, dim
-0002bd00: 3129 0a20 2020 2020 2020 2064 696d 3220  1).        dim2 
-0002bd10: 3d20 6578 6973 745f 6469 6d28 7365 6c66  = exist_dim(self
-0002bd20: 2e73 6861 7065 2c20 6469 6d32 290a 2020  .shape, dim2).  
-0002bd30: 2020 2020 2020 6176 6f75 6368 286c 656e        avouch(len
-0002bd40: 2864 696d 3129 203d 3d20 6c65 6e28 6469  (dim1) == len(di
-0002bd50: 6d32 2920 3d3d 2031 2c20 2254 656e 736f  m2) == 1, "Tenso
-0002bd60: 722e 6d6f 7665 5f64 696d 206f 6e6c 7920  r.move_dim only 
-0002bd70: 7461 6b65 7320 696e 7465 6765 7273 2061  takes integers a
-0002bd80: 7320 696e 7075 7473 2e22 290a 2020 2020  s inputs.").    
-0002bd90: 2020 2020 6431 203d 2064 696d 315b 305d      d1 = dim1[0]
-0002bda0: 0a20 2020 2020 2020 2064 3220 3d20 6469  .        d2 = di
-0002bdb0: 6d32 5b30 5d0a 0a20 2020 2020 2020 2069  m2[0]..        i
-0002bdc0: 6620 6431 203c 2064 323a 2072 6574 7572  f d1 < d2: retur
-0002bdd0: 6e20 7365 6c66 2e70 6572 6d75 7465 5f28  n self.permute_(
-0002bde0: 2a72 616e 6765 2864 3129 2c20 2a72 616e  *range(d1), *ran
-0002bdf0: 6765 2864 312b 312c 2064 322b 3129 2c20  ge(d1+1, d2+1), 
-0002be00: 6431 2c20 2a72 616e 6765 2864 322b 312c  d1, *range(d2+1,
-0002be10: 2073 656c 662e 6e5f 6469 6d29 292e 6164   self.n_dim)).ad
-0002be20: 645f 7370 6563 6961 6c5f 6469 6d28 6432  d_special_dim(d2
-0002be30: 2c20 6469 6d32 290a 2020 2020 2020 2020  , dim2).        
-0002be40: 656c 6966 2064 3120 3e20 6432 3a20 7265  elif d1 > d2: re
-0002be50: 7475 726e 2073 656c 662e 7065 726d 7574  turn self.permut
-0002be60: 655f 282a 7261 6e67 6528 6432 292c 2064  e_(*range(d2), d
-0002be70: 312c 202a 7261 6e67 6528 6432 2c20 6431  1, *range(d2, d1
-0002be80: 292c 202a 7261 6e67 6528 6431 2b31 2c20  ), *range(d1+1, 
-0002be90: 7365 6c66 2e6e 5f64 696d 2929 2e61 6464  self.n_dim)).add
-0002bea0: 5f73 7065 6369 616c 5f64 696d 2864 322c  _special_dim(d2,
-0002beb0: 2064 696d 3229 0a20 2020 2020 2020 2072   dim2).        r
-0002bec0: 6574 7572 6e20 7365 6c66 2e61 6464 5f73  eturn self.add_s
-0002bed0: 7065 6369 616c 5f64 696d 2864 322c 2064  pecial_dim(d2, d
-0002bee0: 696d 3229 2e67 7261 645f 666e 5f6e 616d  im2).grad_fn_nam
-0002bef0: 655f 2827 6d6f 7665 5f64 696d 5f27 290a  e_('move_dim_').
-0002bf00: 0a20 2020 2040 616c 6961 7328 226a 6f69  .    @alias("joi
-0002bf10: 6e64 696d 7322 2c20 226a 6f69 6e5f 6469  ndims", "join_di
-0002bf20: 6d73 222c 2022 6d65 7267 6564 696d 7322  ms", "mergedims"
-0002bf30: 290a 2020 2020 6465 6620 6d65 7267 655f  ).    def merge_
-0002bf40: 6469 6d73 2873 656c 662c 202a 6469 6d73  dims(self, *dims
-0002bf50: 3a20 6578 6973 745f 6469 6d2c 2074 6172  : exist_dim, tar
-0002bf60: 6765 743a 206e 6577 5f64 696d 3d4e 6f6e  get: new_dim=Non
-0002bf70: 6529 3a0a 2020 2020 2020 2020 2222 220a  e):.        """.
-0002bf80: 2020 2020 2020 2020 6d65 7267 6564 696d          mergedim
-0002bf90: 7328 7365 6c66 2c20 2a73 6f75 7263 652c  s(self, *source,
-0002bfa0: 2074 6172 6765 7429 202d 3e20 5465 6e73   target) -> Tens
-0002bfb0: 6f72 0a0a 2020 2020 2020 2020 6d65 7267  or..        merg
-0002bfc0: 6520 6469 6d73 2069 6e74 6f20 6f6e 6520  e dims into one 
-0002bfd0: 6469 6d65 6e73 696f 6e3a 2074 6172 6765  dimension: targe
-0002bfe0: 7420 2874 6865 206c 6173 7420 6172 6775  t (the last argu
-0002bff0: 6d65 6e74 290a 2020 2020 2020 2020 6461  ment).        da
-0002c000: 7461 206f 6620 7369 7a65 2028 322c 2033  ta of size (2, 3
-0002c010: 2c20 342c 2035 2920 6361 6e20 6265 2074  , 4, 5) can be t
-0002c020: 7261 6e73 666f 726d 2074 6f20 2832 342c  ransform to (24,
-0002c030: 2035 2920 7769 7468 2061 2043 6172 7465   5) with a Carte
-0002c040: 7369 616e 206f 6620 3320 7820 3220 7820  sian of 3 x 2 x 
-0002c050: 3420 6279 3a0a 2020 2020 2020 2020 2020  4 by:.          
-0002c060: 2020 6461 7461 2e6d 6572 6765 6469 6d73    data.mergedims
-0002c070: 285b 312c 2030 2c20 325d 2c20 7461 7267  ([1, 0, 2], targ
-0002c080: 6574 3d30 2920 2f20 6461 7461 2e6d 6572  et=0) / data.mer
-0002c090: 6765 6469 6d73 2831 2c20 302c 2032 2c20  gedims(1, 0, 2, 
-0002c0a0: 7461 7267 6574 3d30 290a 2020 2020 2020  target=0).      
-0002c0b0: 2020 4e6f 7465 2074 6861 7420 6f6e 6520    Note that one 
-0002c0c0: 6361 6e20 6f6e 6c79 206f 6d69 7420 7468  can only omit th
-0002c0d0: 6520 7461 7267 6574 2064 696d 656e 7369  e target dimensi
-0002c0e0: 6f6e 2069 6620 6e6f 206f 7264 6572 206f  on if no order o
-0002c0f0: 6620 6469 6d65 6e73 696f 6e20 6973 2063  f dimension is c
-0002c100: 6861 6e67 6564 2e20 0a20 2020 2020 2020  hanged. .       
-0002c110: 2020 2020 2074 6865 2061 7574 6f6d 6174       the automat
-0002c120: 6963 616c 6c79 2063 686f 7365 6e20 7461  ically chosen ta
-0002c130: 7267 6574 2069 7320 7468 6520 6e65 7720  rget is the new 
-0002c140: 706f 7369 7469 6f6e 206f 6620 7468 6520  position of the 
-0002c150: 6c61 7374 2064 696d 656e 7369 6f6e 206f  last dimension o
-0002c160: 6e65 2067 6976 6573 2e20 0a20 2020 2020  ne gives. .     
-0002c170: 2020 2020 2020 2065 2e67 2e20 6461 7461         e.g. data
-0002c180: 2e6d 6572 6765 6469 6d73 2831 2c20 302c  .mergedims(1, 0,
-0002c190: 2033 2920 7265 7375 6c74 2069 6e20 2834   3) result in (4
-0002c1a0: 2c20 3330 2920 616e 6420 6974 2066 6f6c  , 30) and it fol
-0002c1b0: 6c6f 7773 2061 2043 6172 7465 7369 616e  lows a Cartesian
-0002c1c0: 206f 6620 3220 7820 3320 7820 352e 0a20   of 2 x 3 x 5.. 
-0002c1d0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0002c1e0: 2020 2069 6e70 7574 5f64 696d 7320 3d20     input_dims = 
-0002c1f0: 6469 6d73 0a20 2020 2020 2020 2064 696d  dims.        dim
-0002c200: 7320 3d20 6578 6973 745f 6469 6d28 7365  s = exist_dim(se
-0002c210: 6c66 2e73 6861 7065 2c20 2a64 696d 7329  lf.shape, *dims)
-0002c220: 0a20 2020 2020 2020 2069 6620 7461 7267  .        if targ
-0002c230: 6574 2069 7320 4e6f 6e65 3a0a 2020 2020  et is None:.    
-0002c240: 2020 2020 2020 2020 7461 7267 6574 5f72          target_r
-0002c250: 6570 7220 3d20 5369 7a65 2864 696d 735b  epr = Size(dims[
-0002c260: 2d31 5d20 2d20 7375 6d5f 285b 3120 6966  -1] - sum_([1 if
-0002c270: 2064 203c 2064 696d 735b 2d31 5d20 656c   d < dims[-1] el
-0002c280: 7365 2030 2066 6f72 2064 2069 6e20 6469  se 0 for d in di
-0002c290: 6d73 5b3a 2d31 5d5d 2929 2e75 7064 6174  ms[:-1]])).updat
-0002c2a0: 655f 7370 6563 6961 6c5f 6672 6f6d 2853  e_special_from(S
-0002c2b0: 697a 6528 696e 7075 745f 6469 6d73 5b2d  ize(input_dims[-
-0002c2c0: 315d 2929 2e70 7974 686f 6e5f 7265 7072  1])).python_repr
-0002c2d0: 0a20 2020 2020 2020 2020 2020 2064 696d  .            dim
-0002c2e0: 7320 3d20 736f 7274 6564 2864 696d 7329  s = sorted(dims)
-0002c2f0: 0a20 2020 2020 2020 2065 6c73 653a 2074  .        else: t
-0002c300: 6172 6765 745f 7265 7072 203d 2028 7461  arget_repr = (ta
-0002c310: 7267 6574 2c29 0a20 2020 2020 2020 2074  rget,).        t
-0002c320: 6172 6765 7420 3d20 6e65 775f 6469 6d28  arget = new_dim(
-0002c330: 7265 6d6f 7665 5f64 696d 2873 656c 662e  remove_dim(self.
-0002c340: 7368 6170 652c 2064 696d 7329 2c20 2a74  shape, dims), *t
-0002c350: 6172 6765 745f 7265 7072 290a 2020 2020  arget_repr).    
-0002c360: 2020 2020 6176 6f75 6368 286c 656e 2864      avouch(len(d
-0002c370: 696d 7329 203e 3d20 322c 2066 2250 6c65  ims) >= 2, f"Ple
-0002c380: 6173 6520 696e 7075 7420 6174 206c 6561  ase input at lea
-0002c390: 7374 2074 776f 2064 696d 7320 746f 2062  st two dims to b
-0002c3a0: 6520 6d65 7267 6564 2066 6f72 206d 6574  e merged for met
-0002c3b0: 686f 6420 276d 6572 6765 6469 6d73 272c  hod 'mergedims',
-0002c3c0: 206e 6f74 207b 6469 6d73 7d2e 2022 290a   not {dims}. ").
-0002c3d0: 2020 2020 2020 2020 6176 6f75 6368 286c          avouch(l
-0002c3e0: 656e 2874 6172 6765 7429 203d 3d20 312c  en(target) == 1,
-0002c3f0: 2066 2241 7420 6d6f 7374 206f 6e65 2027   f"At most one '
-0002c400: 7461 7267 6574 2720 6172 6775 6d65 6e74  target' argument
-0002c410: 2069 7320 616c 6c6f 7765 6420 666f 7220   is allowed for 
-0002c420: 6d65 7468 6f64 2027 6d65 7267 6564 696d  method 'mergedim
-0002c430: 7327 2c20 6e6f 7420 7b74 6172 6765 745f  s', not {target_
-0002c440: 7265 7072 7d2e 2022 290a 0a20 2020 2020  repr}. ")..     
-0002c450: 2020 2072 6573 203d 2073 656c 662e 636c     res = self.cl
-0002c460: 6f6e 6528 290a 2020 2020 2020 2020 6f74  one().        ot
-0002c470: 6865 725f 6469 6d73 203d 205b 6920 666f  her_dims = [i fo
-0002c480: 7220 6920 696e 2072 616e 6765 5f28 7365  r i in range_(se
-0002c490: 6c66 2e6e 5f64 696d 2920 6966 2069 206e  lf.n_dim) if i n
-0002c4a0: 6f74 2069 6e20 6469 6d73 5d0a 2020 2020  ot in dims].    
-0002c4b0: 2020 2020 6f75 745f 6469 6d73 203d 206f      out_dims = o
-0002c4c0: 7468 6572 5f64 696d 735b 3a74 6172 6765  ther_dims[:targe
-0002c4d0: 745b 305d 5d20 2b20 6469 6d73 202b 206f  t[0]] + dims + o
-0002c4e0: 7468 6572 5f64 696d 735b 7461 7267 6574  ther_dims[target
-0002c4f0: 5b30 5d3a 5d0a 2020 2020 2020 2020 7072  [0]:].        pr
-0002c500: 6576 5f73 6861 7065 203d 2072 6573 2e73  ev_shape = res.s
-0002c510: 6861 7065 0a20 2020 2020 2020 2077 6974  hape.        wit
-0002c520: 6820 7265 732e 6869 6465 5f73 7065 6369  h res.hide_speci
-0002c530: 616c 2829 3a0a 2020 2020 2020 2020 2020  al():.          
-0002c540: 2020 7265 732e 7065 726d 7574 655f 286f    res.permute_(o
-0002c550: 7574 5f64 696d 7329 0a20 2020 2020 2020  ut_dims).       
-0002c560: 2020 2020 2072 6573 203d 2072 6573 2e66       res = res.f
-0002c570: 6c61 7474 656e 2874 6172 6765 745b 305d  latten(target[0]
-0002c580: 2c20 7461 7267 6574 5b30 5d20 2b20 6c65  , target[0] + le
-0002c590: 6e28 6469 6d73 2920 2d20 3129 0a20 2020  n(dims) - 1).   
-0002c5a0: 2020 2020 2070 6f73 745f 7368 6170 6520       post_shape 
-0002c5b0: 3d20 7375 6d5f 2828 7072 6576 5f73 6861  = sum_((prev_sha
-0002c5c0: 7065 5b69 3a69 2b31 5d20 666f 7220 6920  pe[i:i+1] for i 
-0002c5d0: 696e 206f 7468 6572 5f64 696d 735b 3a74  in other_dims[:t
-0002c5e0: 6172 6765 745b 305d 5d29 2c20 5369 7a65  arget[0]]), Size
-0002c5f0: 2829 290a 2020 2020 2020 2020 706f 7374  ()).        post
-0002c600: 5f73 6861 7065 202b 3d20 7265 732e 7368  _shape += res.sh
-0002c610: 6170 652e 7370 6563 6961 6c5f 6672 6f6d  ape.special_from
-0002c620: 2874 6172 6765 7429 5b74 6172 6765 745b  (target)[target[
-0002c630: 305d 3a74 6172 6765 745b 305d 2b31 5d0a  0]:target[0]+1].
-0002c640: 2020 2020 2020 2020 706f 7374 5f73 6861          post_sha
-0002c650: 7065 202b 3d20 7375 6d5f 2828 7072 6576  pe += sum_((prev
-0002c660: 5f73 6861 7065 5b69 3a69 2b31 5d20 666f  _shape[i:i+1] fo
-0002c670: 7220 6920 696e 206f 7468 6572 5f64 696d  r i in other_dim
-0002c680: 735b 7461 7267 6574 5b30 5d3a 5d29 2c20  s[target[0]:]), 
-0002c690: 5369 7a65 2829 290a 2020 2020 2020 2020  Size()).        
-0002c6a0: 7265 7475 726e 2072 6573 2e73 7065 6369  return res.speci
-0002c6b0: 616c 5f66 726f 6d28 706f 7374 5f73 6861  al_from(post_sha
-0002c6c0: 7065 292e 6772 6164 5f66 6e5f 6e61 6d65  pe).grad_fn_name
-0002c6d0: 5f28 276d 6572 6765 5f64 696d 7327 290a  _('merge_dims').
-0002c6e0: 0a20 2020 2040 616c 6961 7328 2273 706c  .    @alias("spl
-0002c6f0: 6974 6469 6d22 290a 2020 2020 6465 6620  itdim").    def 
-0002c700: 7370 6c69 745f 6469 6d28 7365 6c66 2c20  split_dim(self, 
-0002c710: 736f 7572 6365 3a20 6465 6c5f 6469 6d2c  source: del_dim,
-0002c720: 202a 7369 7a65 3a20 5369 7a65 293a 0a20   *size: Size):. 
-0002c730: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0002c740: 2020 2073 706c 6974 6469 6d28 7365 6c66     splitdim(self
-0002c750: 2c20 736f 7572 6365 2c20 2a74 6172 6765  , source, *targe
-0002c760: 745f 7369 7a65 2920 2d3e 2054 656e 736f  t_size) -> Tenso
-0002c770: 720a 0a20 2020 2020 2020 2073 706c 6974  r..        split
-0002c780: 206f 6e65 2064 696d 656e 7369 6f6e 2073   one dimension s
-0002c790: 6f75 7263 6520 696e 746f 206d 756c 7469  ource into multi
-0002c7a0: 706c 6520 6469 6d65 6e73 696f 6e73 3a20  ple dimensions: 
-0002c7b0: 7461 7267 6574 0a20 2020 2020 2020 2064  target.        d
-0002c7c0: 6174 6120 6f66 2073 697a 6520 2832 2c20  ata of size (2, 
-0002c7d0: 342c 2035 2920 6361 6e20 6265 2074 7261  4, 5) can be tra
-0002c7e0: 6e73 666f 726d 2074 6f20 2832 2c20 322c  nsform to (2, 2,
-0002c7f0: 2032 2c20 3529 2077 6974 6820 6461 7461   2, 5) with data
-0002c800: 2e73 706c 6974 6469 6d28 312c 2032 2c20  .splitdim(1, 2, 
-0002c810: 3229 2e0a 2020 2020 2020 2020 4e6f 7465  2)..        Note
-0002c820: 2074 6861 7420 6261 7463 6820 7265 7072   that batch repr
-0002c830: 6573 656e 7461 7469 6f6e 7320 666f 7220  esentations for 
-0002c840: 736f 7572 6365 2061 6e64 2074 6172 6765  source and targe
-0002c850: 7420 6172 6520 6469 6666 6572 656e 740a  t are different.
-0002c860: 2020 2020 2020 2020 2020 2020 2873 706c              (spl
-0002c870: 6974 6469 6d28 5b31 5d2c 205b 325d 2c20  itdim([1], [2], 
-0002c880: 3229 206d 6561 6e73 2073 706c 6974 2074  2) means split t
-0002c890: 6865 2062 6174 6368 6469 6d20 6174 2069  he batchdim at i
-0002c8a0: 6e64 6578 2031 2069 6e74 6f20 6120 7369  ndex 1 into a si
-0002c8b0: 7a65 206f 6620 285b 325d 2c20 3229 2c20  ze of ([2], 2), 
-0002c8c0: 7768 6963 6820 6973 2032 7832 2077 6974  which is 2x2 wit
-0002c8d0: 6820 6261 7463 6864 696d 2061 7420 696e  h batchdim at in
-0002c8e0: 6465 7820 3029 2e0a 2020 2020 2020 2020  dex 0)..        
-0002c8f0: 2020 2020 4f6e 6520 6361 6e20 7573 6520      One can use 
-0002c900: 2d31 2066 6f72 2061 7262 6974 7261 7279  -1 for arbitrary
-0002c910: 2073 697a 652e 200a 2020 2020 2020 2020   size. .        
-0002c920: 2222 220a 2020 2020 2020 2020 7369 7a65  """.        size
-0002c930: 203d 2053 697a 6528 2a73 697a 6529 0a20   = Size(*size). 
-0002c940: 2020 2020 2020 2073 6f75 7263 6520 3d20         source = 
-0002c950: 6465 6c5f 6469 6d28 7365 6c66 2c20 736f  del_dim(self, so
-0002c960: 7572 6365 290a 2020 2020 2020 2020 2320  urce).        # 
-0002c970: 6176 6f75 6368 286c 656e 2873 697a 6529  avouch(len(size)
-0002c980: 203e 3d20 322c 2066 2250 6c65 6173 6520   >= 2, f"Please 
-0002c990: 696e 7075 7420 616e 2061 742d 6c65 6173  input an at-leas
-0002c9a0: 742d 7477 6f2d 6469 6d2d 7368 6170 6520  t-two-dim-shape 
-0002c9b0: 746f 2073 706c 6974 2064 696d 656e 7369  to split dimensi
-0002c9c0: 6f6e 207b 736f 7572 6365 7d20 696e 746f  on {source} into
-0002c9d0: 2069 6e20 6d65 7468 6f64 2027 7370 6c69   in method 'spli
-0002c9e0: 7464 696d 272c 206e 6f74 207b 7369 7a65  tdim', not {size
-0002c9f0: 7d2e 2022 290a 2020 2020 2020 2020 6966  }. ").        if
-0002ca00: 206c 656e 2873 6f75 7263 6529 203e 2031   len(source) > 1
-0002ca10: 3a20 7365 6c66 203d 2073 656c 662e 6d65  : self = self.me
-0002ca20: 7267 655f 6469 6d73 282a 736f 7572 6365  rge_dims(*source
-0002ca30: 2c20 7461 7267 6574 3d73 6f75 7263 655b  , target=source[
-0002ca40: 305d 290a 0a20 2020 2020 2020 206e 6577  0])..        new
-0002ca50: 5f73 697a 6520 3d20 7365 6c66 2e73 6861  _size = self.sha
-0002ca60: 7065 5b3a 736f 7572 6365 5b30 5d5d 202b  pe[:source[0]] +
-0002ca70: 2073 697a 652e 7769 7468 5f6e 5f65 6c65   size.with_n_ele
-0002ca80: 2873 656c 662e 7368 6170 655b 736f 7572  (self.shape[sour
-0002ca90: 6365 5b30 5d5d 2920 2b20 7365 6c66 2e73  ce[0]]) + self.s
-0002caa0: 6861 7065 5b73 6f75 7263 655b 305d 202b  hape[source[0] +
-0002cab0: 2031 3a5d 0a20 2020 2020 2020 2072 6574   1:].        ret
-0002cac0: 7572 6e20 7365 6c66 2e76 6965 7728 6e65  urn self.view(ne
-0002cad0: 775f 7369 7a65 292e 6772 6164 5f66 6e5f  w_size).grad_fn_
-0002cae0: 6e61 6d65 5f28 2773 706c 6974 5f64 696d  name_('split_dim
-0002caf0: 2729 0a20 2020 200a 2020 2020 6465 6620  ').    .    def 
-0002cb00: 6578 7061 6e64 2873 656c 662c 202a 7369  expand(self, *si
-0002cb10: 7a65 733a 2053 697a 6529 3a0a 2020 2020  zes: Size):.    
-0002cb20: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0002cb30: 6578 7061 6e64 5f74 6f28 2a73 697a 6573  expand_to(*sizes
-0002cb40: 292e 6772 6164 5f66 6e5f 6e61 6d65 5f28  ).grad_fn_name_(
-0002cb50: 2765 7870 616e 6427 290a 0a20 2020 2064  'expand')..    d
-0002cb60: 6566 2065 7870 616e 645f 6173 2873 656c  ef expand_as(sel
-0002cb70: 662c 206f 7468 6572 3a20 2754 656e 736f  f, other: 'Tenso
-0002cb80: 7227 293a 0a20 2020 2020 2020 2072 6574  r'):.        ret
-0002cb90: 7572 6e20 7365 6c66 2e65 7870 616e 645f  urn self.expand_
-0002cba0: 746f 286f 7468 6572 292e 6772 6164 5f66  to(other).grad_f
-0002cbb0: 6e5f 6e61 6d65 5f28 2765 7870 616e 645f  n_name_('expand_
-0002cbc0: 6173 2729 0a20 2020 2020 2020 200a 2020  as').        .  
-0002cbd0: 2020 6465 6620 6578 7061 6e64 5f74 6f28    def expand_to(
-0002cbe0: 7365 6c66 2c20 2a74 6172 6765 742c 2061  self, *target, a
-0002cbf0: 7373 6967 6e5f 746f 5f64 696d 733a 2065  ssign_to_dims: e
-0002cc00: 7869 7374 5f64 696d 3d4e 6f6e 652c 2064  xist_dim=None, d
-0002cc10: 696d 735f 616c 6c6f 775f 6d69 736d 6174  ims_allow_mismat
-0002cc20: 6368 3a20 6578 6973 745f 6469 6d3d 4e6f  ch: exist_dim=No
-0002cc30: 6e65 293a 0a20 2020 2020 2020 2069 6620  ne):.        if 
-0002cc40: 6c65 6e28 7461 7267 6574 2920 3d3d 2031  len(target) == 1
-0002cc50: 2061 6e64 2069 7369 6e73 7461 6e63 6528   and isinstance(
-0002cc60: 7461 7267 6574 5b30 5d2c 2074 6f72 6368  target[0], torch
-0002cc70: 2e54 656e 736f 7229 3a20 7461 7267 6574  .Tensor): target
-0002cc80: 203d 2074 6172 6765 745b 305d 2e73 6861   = target[0].sha
-0002cc90: 7065 0a20 2020 2020 2020 2061 766f 7563  pe.        avouc
-0002cca0: 6828 6973 696e 7374 616e 6365 2874 6172  h(isinstance(tar
-0002ccb0: 6765 742c 2074 7570 6c65 292c 2054 7970  get, tuple), Typ
-0002ccc0: 6545 7272 6f72 2866 2249 6e76 616c 6964  eError(f"Invalid
-0002ccd0: 2069 6e70 7574 2066 6f72 2062 742e 5465   input for bt.Te
-0002cce0: 6e73 6f72 2e65 7870 616e 645f 746f 3a20  nsor.expand_to: 
-0002ccf0: 7b74 6172 6765 747d 2c20 7368 6f75 6c64  {target}, should
-0002cd00: 2062 6520 6120 2774 7570 6c65 2720 6f72   be a 'tuple' or
-0002cd10: 2027 5369 7a65 272e 2229 290a 2020 2020   'Size'.")).    
-0002cd20: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
-0002cd30: 7461 6e63 6528 7461 7267 6574 2c20 5369  tance(target, Si
-0002cd40: 7a65 293a 2074 6172 6765 7420 3d20 5369  ze): target = Si
-0002cd50: 7a65 282a 7461 7267 6574 290a 2020 2020  ze(*target).    
-0002cd60: 2020 2020 6966 2061 7373 6967 6e5f 746f      if assign_to
-0002cd70: 5f64 696d 7320 6973 204e 6f6e 653a 0a20  _dims is None:. 
-0002cd80: 2020 2020 2020 2020 2020 206e 6577 5f73             new_s
-0002cd90: 6861 7065 2c20 5f20 3d20 7365 6c66 2e73  hape, _ = self.s
-0002cda0: 6861 7065 205e 2074 6172 6765 740a 2020  hape ^ target.  
-0002cdb0: 2020 2020 2020 2020 2020 6176 6f75 6368            avouch
-0002cdc0: 286c 656e 286e 6577 5f73 6861 7065 2920  (len(new_shape) 
-0002cdd0: 3d3d 206c 656e 2874 6172 6765 7429 2c20  == len(target), 
-0002cde0: 5479 7065 4572 726f 7228 6622 4361 6e6e  TypeError(f"Cann
-0002cdf0: 6f74 2065 7870 616e 6420 7465 6e73 6f72  ot expand tensor
-0002ce00: 2077 6974 6820 7368 6170 6520 7b73 656c   with shape {sel
-0002ce10: 662e 7368 6170 657d 2074 6f20 7b74 6172  f.shape} to {tar
-0002ce20: 6765 747d 2e20 2229 290a 2020 2020 2020  get}. ")).      
-0002ce30: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002ce40: 2020 2020 6173 7369 676e 5f74 6f5f 6469      assign_to_di
-0002ce50: 6d73 203d 206c 6973 7428 6578 6973 745f  ms = list(exist_
-0002ce60: 6469 6d28 7461 7267 6574 2c20 6173 7369  dim(target, assi
-0002ce70: 676e 5f74 6f5f 6469 6d73 2929 0a20 2020  gn_to_dims)).   
-0002ce80: 2020 2020 2020 2020 206e 6577 5f73 6861           new_sha
-0002ce90: 7065 203d 2053 697a 6528 2a28 7365 6c66  pe = Size(*(self
-0002cea0: 2e73 6861 7065 5b61 7373 6967 6e5f 746f  .shape[assign_to
-0002ceb0: 5f64 696d 732e 696e 6465 785b 695d 5d20  _dims.index[i]] 
-0002cec0: 6966 2069 2069 6e20 6173 7369 676e 5f74  if i in assign_t
-0002ced0: 6f5f 6469 6d73 2065 6c73 6520 3120 666f  o_dims else 1 fo
-0002cee0: 7220 6920 696e 2072 616e 6765 5f28 6c65  r i in range_(le
-0002cef0: 6e28 7461 7267 6574 2929 292e 7370 6563  n(target))).spec
-0002cf00: 6961 6c5f 6672 6f6d 2874 6172 6765 7429  ial_from(target)
-0002cf10: 290a 2020 2020 2020 2020 6966 2064 696d  ).        if dim
-0002cf20: 735f 616c 6c6f 775f 6d69 736d 6174 6368  s_allow_mismatch
-0002cf30: 2069 7320 4e6f 6e65 3a20 6469 6d73 5f61   is None: dims_a
-0002cf40: 6c6c 6f77 5f6d 6973 6d61 7463 6820 3d20  llow_mismatch = 
-0002cf50: 7475 706c 6528 290a 2020 2020 2020 2020  tuple().        
-0002cf60: 656c 7365 3a20 6469 6d73 5f61 6c6c 6f77  else: dims_allow
-0002cf70: 5f6d 6973 6d61 7463 6820 3d20 7475 706c  _mismatch = tupl
-0002cf80: 6528 6578 6973 745f 6469 6d28 7461 7267  e(exist_dim(targ
-0002cf90: 6574 2c20 6469 6d73 5f61 6c6c 6f77 5f6d  et, dims_allow_m
-0002cfa0: 6973 6d61 7463 6829 290a 2020 2020 2020  ismatch)).      
-0002cfb0: 2020 6176 6f75 6368 2861 6c6c 5f28 6920    avouch(all_(i 
-0002cfc0: 696e 2064 696d 735f 616c 6c6f 775f 6d69  in dims_allow_mi
-0002cfd0: 736d 6174 6368 206f 7220 7820 3d3d 2079  smatch or x == y
-0002cfe0: 206f 7220 7820 3d3d 2031 206f 7220 7920   or x == 1 or y 
-0002cff0: 696e 2028 312c 202d 3129 2066 6f72 2069  in (1, -1) for i
-0002d000: 2c20 2878 2c20 7929 2069 6e20 656e 756d  , (x, y) in enum
-0002d010: 6572 6174 6528 7a69 7028 6e65 775f 7368  erate(zip(new_sh
-0002d020: 6170 652c 2074 6172 6765 7429 2929 2c20  ape, target))), 
-0002d030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d040: 5479 7065 4572 726f 7228 6622 5369 7a65  TypeError(f"Size
-0002d050: 206d 6973 6d61 7463 6820 696e 2027 6578   mismatch in 'ex
-0002d060: 7061 6e64 5f74 6f27 3a20 7b73 656c 662e  pand_to': {self.
-0002d070: 7368 6170 657d 2028 6578 7061 6e64 6564  shape} (expanded
-0002d080: 2074 6f20 7b6e 6577 5f73 6861 7065 7d29   to {new_shape})
-0002d090: 2061 6e64 207b 7461 7267 6574 7d2e 2022   and {target}. "
-0002d0a0: 2929 0a20 2020 2020 2020 206e 5f72 6570  )).        n_rep
-0002d0b0: 6561 7473 203d 2074 7570 6c65 2879 2069  eats = tuple(y i
-0002d0c0: 6620 6920 6e6f 7420 696e 2064 696d 735f  f i not in dims_
-0002d0d0: 616c 6c6f 775f 6d69 736d 6174 6368 2061  allow_mismatch a
-0002d0e0: 6e64 2078 203d 3d20 3120 656c 7365 2031  nd x == 1 else 1
-0002d0f0: 2066 6f72 2069 2c20 2878 2c20 7929 2069   for i, (x, y) i
-0002d100: 6e20 656e 756d 6572 6174 6528 7a69 7028  n enumerate(zip(
-0002d110: 6e65 775f 7368 6170 652c 2074 6172 6765  new_shape, targe
-0002d120: 7429 2929 0a20 2020 2020 2020 2069 6620  t))).        if 
-0002d130: 6c65 6e28 6e5f 7265 7065 6174 7329 203e  len(n_repeats) >
-0002d140: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-0002d150: 7265 7475 726e 2073 656c 662e 7669 6577  return self.view
-0002d160: 286e 6577 5f73 6861 7065 292e 7265 7065  (new_shape).repe
-0002d170: 6174 282a 6e5f 7265 7065 6174 7329 2e67  at(*n_repeats).g
-0002d180: 7261 645f 666e 5f6e 616d 655f 2827 6578  rad_fn_name_('ex
-0002d190: 7061 6e64 5f74 6f27 290a 2020 2020 2020  pand_to').      
-0002d1a0: 2020 656c 7365 3a20 7265 7475 726e 2073    else: return s
-0002d1b0: 656c 662e 7669 6577 286e 6577 5f73 6861  elf.view(new_sha
-0002d1c0: 7065 292e 6772 6164 5f66 6e5f 6e61 6d65  pe).grad_fn_name
-0002d1d0: 5f28 2765 7870 616e 645f 746f 2729 0a20  _('expand_to'). 
-0002d1e0: 2020 200a 2020 2020 6465 6620 756e 7371     .    def unsq
-0002d1f0: 7565 657a 655f 746f 2873 656c 663a 2027  ueeze_to(self: '
-0002d200: 5465 6e73 6f72 272c 202a 7461 7267 6574  Tensor', *target
-0002d210: 3a53 697a 652c 2061 7373 6967 6e5f 746f  :Size, assign_to
-0002d220: 5f64 696d 733a 2065 7869 7374 5f64 696d  _dims: exist_dim
-0002d230: 3d4e 6f6e 6529 3a0a 2020 2020 2020 2020  =None):.        
-0002d240: 7265 7475 726e 2073 656c 662e 6578 7061  return self.expa
-0002d250: 6e64 5f74 6f28 2a74 6172 6765 742c 2061  nd_to(*target, a
-0002d260: 7373 6967 6e5f 746f 5f64 696d 733d 6173  ssign_to_dims=as
-0002d270: 7369 676e 5f74 6f5f 6469 6d73 2c20 6469  sign_to_dims, di
-0002d280: 6d73 5f61 6c6c 6f77 5f6d 6973 6d61 7463  ms_allow_mismatc
-0002d290: 683d 7475 706c 6528 2929 2e67 7261 645f  h=tuple()).grad_
-0002d2a0: 666e 5f6e 616d 655f 2827 756e 7371 7565  fn_name_('unsque
-0002d2b0: 657a 655f 746f 2729 0a0a 2020 2020 2320  eze_to')..    # 
-0002d2c0: 436f 6e74 726f 6c20 7468 6520 6f75 7470  Control the outp
-0002d2d0: 7574 206f 6620 7468 6520 7465 6e73 6f72  ut of the tensor
-0002d2e0: 2e20 0a20 2020 2064 6566 2074 6f62 7974  . .    def tobyt
-0002d2f0: 6573 2873 656c 6629 3a20 7265 7475 726e  es(self): return
-0002d300: 2073 656c 662e 6465 7461 6368 2829 2e63   self.detach().c
-0002d310: 7075 2829 2e6e 756d 7079 2829 2e74 6f62  pu().numpy().tob
-0002d320: 7974 6573 2829 0a20 2020 200a 2020 2020  ytes().    .    
-0002d330: 6465 6620 5f5f 6861 7368 5f5f 2873 656c  def __hash__(sel
-0002d340: 6629 3a20 7265 7475 726e 2073 7570 6572  f): return super
-0002d350: 2829 2e5f 5f68 6173 685f 5f28 290a 2020  ().__hash__().  
-0002d360: 2020 0a20 2020 2040 636c 6173 736d 6574    .    @classmet
-0002d370: 686f 640a 2020 2020 6465 6620 5f5f 626c  hod.    def __bl
-0002d380: 6f63 6b5f 7265 7072 5f5f 2863 6c73 2c20  ock_repr__(cls, 
-0002d390: 7270 723a 2073 7472 2c20 6279 3d27 2027  rpr: str, by=' '
-0002d3a0: 293a 0a20 2020 2020 2020 206e 5f63 6f6c  ):.        n_col
-0002d3b0: 203d 206d 6178 5f28 6c65 6e28 6c69 6e65   = max_(len(line
-0002d3c0: 2920 666f 7220 6c69 6e65 2069 6e20 7270  ) for line in rp
-0002d3d0: 722e 7370 6c69 7428 275c 6e27 2929 0a20  r.split('\n')). 
-0002d3e0: 2020 2020 2020 2072 6574 7572 6e20 275c         return '\
-0002d3f0: 6e27 2e6a 6f69 6e28 6c20 2b20 6279 202a  n'.join(l + by *
-0002d400: 2028 6e5f 636f 6c20 2d20 6c65 6e28 6c29   (n_col - len(l)
-0002d410: 2920 666f 7220 6c20 696e 2072 7072 2e73  ) for l in rpr.s
-0002d420: 706c 6974 2827 5c6e 2729 290a 2020 2020  plit('\n')).    
-0002d430: 0a20 2020 2040 636c 6173 736d 6574 686f  .    @classmetho
-0002d440: 640a 2020 2020 6465 6620 5f5f 636f 726e  d.    def __corn
-0002d450: 6572 5f62 6c6f 636b 5f72 6570 725f 5f28  er_block_repr__(
-0002d460: 636c 732c 2072 7072 3a20 7374 722c 2062  cls, rpr: str, b
-0002d470: 793d 2720 2729 3a0a 2020 2020 2020 2020  y=' '):.        
-0002d480: 6c69 6e65 7320 3d20 7270 722e 7370 6c69  lines = rpr.spli
-0002d490: 7428 275c 6e27 290a 2020 2020 2020 2020  t('\n').        
-0002d4a0: 6e5f 636f 6c20 3d20 6d61 785f 286c 656e  n_col = max_(len
-0002d4b0: 286c 696e 6529 2066 6f72 206c 696e 6520  (line) for line 
-0002d4c0: 696e 206c 696e 6573 290a 2020 2020 2020  in lines).      
-0002d4d0: 2020 6e5f 726f 7720 3d20 6c65 6e28 6c69    n_row = len(li
-0002d4e0: 6e65 7329 0a20 2020 2020 2020 2072 6574  nes).        ret
-0002d4f0: 7572 6e20 275c 6e27 2e6a 6f69 6e28 0a20  urn '\n'.join(. 
-0002d500: 2020 2020 2020 2020 2020 2028 27ef bda2             ('...
-0002d510: 2720 6966 2069 203d 3d20 3020 656c 7365  ' if i == 0 else
-0002d520: 2028 2720 2720 6966 2069 203d 3d20 6e5f   (' ' if i == n_
-0002d530: 726f 7720 2d20 3120 656c 7365 2027 7c27  row - 1 else '|'
-0002d540: 2929 202b 200a 2020 2020 2020 2020 2020  )) + .          
-0002d550: 2020 6c20 2b20 6279 202a 2028 6e5f 636f    l + by * (n_co
-0002d560: 6c20 2d20 6c65 6e28 6c29 2920 2b20 0a20  l - len(l)) + . 
-0002d570: 2020 2020 2020 2020 2020 2028 27ef bda3             ('...
-0002d580: 2720 6966 2069 203d 3d20 6e5f 726f 7720  ' if i == n_row 
-0002d590: 2d20 3120 656c 7365 2028 2720 2720 6966  - 1 else (' ' if
-0002d5a0: 2069 203d 3d20 3020 656c 7365 2027 7c27   i == 0 else '|'
-0002d5b0: 2929 0a20 2020 2020 2020 2066 6f72 2069  )).        for i
-0002d5c0: 2c20 6c20 696e 2065 6e75 6d65 7261 7465  , l in enumerate
-0002d5d0: 2872 7072 2e73 706c 6974 2827 5c6e 2729  (rpr.split('\n')
-0002d5e0: 2929 0a20 2020 200a 2020 2020 4063 6c61  )).    .    @cla
-0002d5f0: 7373 6d65 7468 6f64 0a20 2020 2064 6566  ssmethod.    def
-0002d600: 205f 5f73 6869 6674 5f72 6570 725f 5f28   __shift_repr__(
-0002d610: 636c 732c 2072 7072 3a20 7374 722c 2073  cls, rpr: str, s
-0002d620: 6869 6674 3a20 696e 743d 312c 2069 676e  hift: int=1, ign
-0002d630: 6f72 655f 6669 7273 743a 2062 6f6f 6c3d  ore_first: bool=
-0002d640: 5472 7565 2c20 6279 3d27 2027 293a 0a20  True, by=' '):. 
-0002d650: 2020 2020 2020 2069 6620 6967 6e6f 7265         if ignore
-0002d660: 5f66 6972 7374 3a20 7265 7475 726e 2028  _first: return (
-0002d670: 275c 6e27 202b 2062 7920 2a20 7368 6966  '\n' + by * shif
-0002d680: 7429 2e6a 6f69 6e28 7270 722e 7370 6c69  t).join(rpr.spli
-0002d690: 7428 275c 6e27 2929 0a20 2020 2020 2020  t('\n')).       
-0002d6a0: 2072 6574 7572 6e20 275c 6e27 2e6a 6f69   return '\n'.joi
-0002d6b0: 6e28 6279 202a 2073 6869 6674 202b 206c  n(by * shift + l
-0002d6c0: 2066 6f72 206c 2069 6e20 7270 722e 7370   for l in rpr.sp
-0002d6d0: 6c69 7428 275c 6e27 2929 0a20 2020 200a  lit('\n')).    .
-0002d6e0: 2020 2020 6465 6620 5f5f 7261 775f 7265      def __raw_re
-0002d6f0: 7072 5f5f 2873 656c 662c 2063 656c 6c5f  pr__(self, cell_
-0002d700: 666f 726d 6174 3d4e 6f6e 6529 3a0a 2020  format=None):.  
-0002d710: 2020 2020 2020 6372 6974 6572 6961 203d        criteria =
-0002d720: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
-0002d730: 6261 7463 6827 3a20 2831 2c20 2831 2c20  batch': (1, (1, 
-0002d740: 3029 292c 0a20 2020 2020 2020 2020 2020  0)),.           
-0002d750: 2027 7365 7175 656e 6365 273a 2028 322c   'sequence': (2,
-0002d760: 2031 292c 0a20 2020 2020 2020 2020 2020   1),.           
-0002d770: 2027 3c6e 2d34 273a 2028 342c 2031 292c   '<n-4': (4, 1),
-0002d780: 0a20 2020 2020 2020 2020 2020 2027 3c6e  .            '<n
-0002d790: 2d32 273a 2028 362c 2032 292c 0a20 2020  -2': (6, 2),.   
-0002d7a0: 2020 2020 2020 2020 2027 3c6e 2d31 273a           '<n-1':
-0002d7b0: 2028 3130 2c20 3429 2c0a 2020 2020 2020   (10, 4),.      
-0002d7c0: 2020 2020 2020 273c 6e27 3a20 2832 302c        '<n': (20,
-0002d7d0: 2038 290a 2020 2020 2020 2020 7d0a 2020   8).        }.  
-0002d7e0: 2020 2020 2020 6365 6c6c 5f6c 656e 5f65        cell_len_e
-0002d7f0: 7870 203d 2038 0a20 2020 2020 2020 2063  xp = 8.        c
-0002d800: 656c 6c5f 6c65 6e5f 7374 7220 3d20 330a  ell_len_str = 3.
-0002d810: 0a20 2020 2020 2020 2069 6620 6365 6c6c  .        if cell
-0002d820: 5f66 6f72 6d61 7420 6973 204e 6f6e 653a  _format is None:
-0002d830: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002d840: 7365 6c66 2e6e 5f65 6c65 203d 3d20 303a  self.n_ele == 0:
-0002d850: 2072 6574 7572 6e20 225b 5d22 0a20 2020   return "[]".   
-0002d860: 2020 2020 2020 2020 2023 2069 6620 7365           # if se
-0002d870: 6c66 2e6e 5f64 696d 203e 2031 3a0a 2020  lf.n_dim > 1:.  
-0002d880: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-0002d890: 2320 7065 726d 7574 6520 7468 6520 6469  # permute the di
-0002d8a0: 6d65 6e73 696f 6e73 2074 6f20 2862 6174  mensions to (bat
-0002d8b0: 6368 2c20 7365 7175 656e 6365 2c20 7370  ch, sequence, sp
-0002d8c0: 6163 652c 2066 6561 7475 7265 2c20 6675  ace, feature, fu
-0002d8d0: 6e63 2920 666f 7220 6469 7370 6c61 792e  nc) for display.
-0002d8e0: 200a 2020 2020 2020 2020 2020 2020 2320   .            # 
-0002d8f0: 2020 2020 6469 6d65 6e73 696f 6e73 203d      dimensions =
-0002d900: 2028 0a20 2020 2020 2020 2020 2020 2023   (.            #
-0002d910: 2020 2020 2020 2020 2028 5b73 656c 662e           ([self.
-0002d920: 6261 7463 685f 6469 6d5d 2069 6620 7365  batch_dim] if se
-0002d930: 6c66 2e68 6173 5f62 6174 6368 2065 6c73  lf.has_batch els
-0002d940: 6520 5b5d 2920 2b20 0a20 2020 2020 2020  e []) + .       
-0002d950: 2020 2020 2023 2020 2020 2020 2020 2028       #         (
-0002d960: 6c69 7374 2872 616e 6765 5f28 2a73 656c  list(range_(*sel
-0002d970: 662e 7365 7175 656e 6365 5f72 616e 6765  f.sequence_range
-0002d980: 2929 2069 6620 7365 6c66 2e68 6173 5f73  )) if self.has_s
-0002d990: 6571 7565 6e63 6520 656c 7365 205b 5d29  equence else [])
-0002d9a0: 202b 200a 2020 2020 2020 2020 2020 2020   + .            
-0002d9b0: 2320 2020 2020 2020 2020 286c 6973 7428  #         (list(
-0002d9c0: 7261 6e67 655f 282a 7365 6c66 2e73 7061  range_(*self.spa
-0002d9d0: 6365 5f72 616e 6765 2929 2069 6620 7365  ce_range)) if se
-0002d9e0: 6c66 2e68 6173 5f73 7061 6365 2065 6c73  lf.has_space els
-0002d9f0: 6520 5b5d 2920 2b20 0a20 2020 2020 2020  e []) + .       
-0002da00: 2020 2020 2023 2020 2020 2020 2020 2028       #         (
-0002da10: 6c69 7374 2872 616e 6765 5f28 2a73 656c  list(range_(*sel
-0002da20: 662e 6665 6174 7572 655f 7261 6e67 6529  f.feature_range)
-0002da30: 2920 6966 2073 656c 662e 6861 735f 6665  ) if self.has_fe
-0002da40: 6174 7572 6520 656c 7365 205b 5d29 202b  ature else []) +
-0002da50: 200a 2020 2020 2020 2020 2020 2020 2320   .            # 
-0002da60: 2020 2020 2020 2020 285b 7365 6c66 2e66          ([self.f
-0002da70: 756e 635f 6469 6d5d 2069 6620 7365 6c66  unc_dim] if self
-0002da80: 2e68 6173 5f66 756e 6320 656c 7365 205b  .has_func else [
-0002da90: 5d29 0a20 2020 2020 2020 2020 2020 2023  ]).            #
-0002daa0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0002dab0: 2020 2023 2020 2020 2073 656c 6620 3d20     #     self = 
-0002dac0: 7365 6c66 2e70 6572 6d75 7465 282a 6469  self.permute(*di
-0002dad0: 6d65 6e73 696f 6e73 290a 0a20 2020 2020  mensions)..     
-0002dae0: 2020 2020 2020 2064 6973 706c 6179 5f74         display_t
-0002daf0: 656e 736f 7220 3d20 4e6f 6e65 0a20 2020  ensor = None.   
-0002db00: 2020 2020 2020 2020 2066 6f72 2064 2069           for d i
-0002db10: 6e20 7261 6e67 655f 2873 656c 662e 6e5f  n range_(self.n_
-0002db20: 6469 6d29 3a0a 2020 2020 2020 2020 2020  dim):.          
-0002db30: 2020 2020 2020 6966 2073 656c 662e 6973        if self.is
-0002db40: 5f62 6174 6368 5f64 696d 2864 293a 206d  _batch_dim(d): m
-0002db50: 6178 5f73 697a 652c 2070 6164 5f73 697a  ax_size, pad_siz
-0002db60: 6520 3d20 6372 6974 6572 6961 5b27 6261  e = criteria['ba
-0002db70: 7463 6827 5d0a 2020 2020 2020 2020 2020  tch'].          
-0002db80: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
-0002db90: 6973 5f73 6571 7565 6e63 655f 6469 6d28  is_sequence_dim(
-0002dba0: 6429 3a20 6d61 785f 7369 7a65 2c20 7061  d): max_size, pa
-0002dbb0: 645f 7369 7a65 203d 2063 7269 7465 7269  d_size = criteri
-0002dbc0: 615b 2773 6571 7565 6e63 6527 5d0a 2020  a['sequence'].  
-0002dbd0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0002dbe0: 6966 2064 203c 2073 656c 662e 6e5f 6469  if d < self.n_di
-0002dbf0: 6d20 2d20 343a 206d 6178 5f73 697a 652c  m - 4: max_size,
-0002dc00: 2070 6164 5f73 697a 6520 3d20 6372 6974   pad_size = crit
-0002dc10: 6572 6961 5b27 3c6e 2d34 275d 0a20 2020  eria['<n-4'].   
-0002dc20: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-0002dc30: 6620 6420 3c20 7365 6c66 2e6e 5f64 696d  f d < self.n_dim
-0002dc40: 202d 2032 3a20 6d61 785f 7369 7a65 2c20   - 2: max_size, 
-0002dc50: 7061 645f 7369 7a65 203d 2063 7269 7465  pad_size = crite
-0002dc60: 7269 615b 273c 6e2d 3227 5d0a 2020 2020  ria['<n-2'].    
-0002dc70: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-0002dc80: 2064 203c 2073 656c 662e 6e5f 6469 6d20   d < self.n_dim 
-0002dc90: 2d20 313a 206d 6178 5f73 697a 652c 2070  - 1: max_size, p
-0002dca0: 6164 5f73 697a 6520 3d20 6372 6974 6572  ad_size = criter
-0002dcb0: 6961 5b27 3c6e 2d31 275d 0a20 2020 2020  ia['<n-1'].     
-0002dcc0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0002dcd0: 206d 6178 5f73 697a 652c 2070 6164 5f73   max_size, pad_s
-0002dce0: 697a 6520 3d20 6372 6974 6572 6961 5b27  ize = criteria['
-0002dcf0: 3c6e 275d 0a20 2020 2020 2020 2020 2020  <n'].           
-0002dd00: 2020 2020 2069 6620 7365 6c66 2e73 697a       if self.siz
-0002dd10: 6528 6429 203c 3d20 6d61 785f 7369 7a65  e(d) <= max_size
-0002dd20: 3a20 636f 6e74 696e 7565 0a20 2020 2020  : continue.     
-0002dd30: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-0002dd40: 696e 7374 616e 6365 2870 6164 5f73 697a  instance(pad_siz
-0002dd50: 652c 2069 6e74 5f29 3a20 7061 645f 7369  e, int_): pad_si
-0002dd60: 7a65 203d 2028 7061 645f 7369 7a65 2c20  ze = (pad_size, 
-0002dd70: 7061 645f 7369 7a65 290a 2020 2020 2020  pad_size).      
-0002dd80: 2020 2020 2020 2020 2020 6966 2064 6973            if dis
-0002dd90: 706c 6179 5f74 656e 736f 7220 6973 204e  play_tensor is N
-0002dda0: 6f6e 653a 2064 6973 706c 6179 5f74 656e  one: display_ten
-0002ddb0: 736f 7220 3d20 6361 7428 7365 6c66 5b28  sor = cat(self[(
-0002ddc0: 736c 6963 6528 4e6f 6e65 292c 2920 2a20  slice(None),) * 
-0002ddd0: 6420 2b20 2873 6c69 6365 284e 6f6e 652c  d + (slice(None,
-0002dde0: 2070 6164 5f73 697a 655b 305d 292c 295d   pad_size[0]),)]
-0002ddf0: 2c20 7365 6c66 5b28 736c 6963 6528 4e6f  , self[(slice(No
-0002de00: 6e65 292c 2920 2a20 6420 2b20 2873 6c69  ne),) * d + (sli
-0002de10: 6365 2873 656c 662e 7369 7a65 2864 292d  ce(self.size(d)-
-0002de20: 7061 645f 7369 7a65 5b31 5d2c 204e 6f6e  pad_size[1], Non
-0002de30: 6529 2c29 5d2c 2064 290a 2020 2020 2020  e),)], d).      
-0002de40: 2020 2020 2020 2020 2020 656c 7365 3a20            else: 
-0002de50: 6469 7370 6c61 795f 7465 6e73 6f72 203d  display_tensor =
-0002de60: 2063 6174 2864 6973 706c 6179 5f74 656e   cat(display_ten
-0002de70: 736f 725b 2873 6c69 6365 284e 6f6e 6529  sor[(slice(None)
-0002de80: 2c29 202a 2064 202b 2028 736c 6963 6528  ,) * d + (slice(
-0002de90: 4e6f 6e65 2c20 7061 645f 7369 7a65 5b30  None, pad_size[0
-0002dea0: 5d29 2c29 5d2c 2064 6973 706c 6179 5f74  ]),)], display_t
-0002deb0: 656e 736f 725b 2873 6c69 6365 284e 6f6e  ensor[(slice(Non
-0002dec0: 6529 2c29 202a 2064 202b 2028 736c 6963  e),) * d + (slic
-0002ded0: 6528 7365 6c66 2e73 697a 6528 6429 2d70  e(self.size(d)-p
-0002dee0: 6164 5f73 697a 655b 315d 2c20 4e6f 6e65  ad_size[1], None
-0002def0: 292c 295d 2c20 6429 0a20 2020 2020 2020  ),)], d).       
-0002df00: 2020 2020 2069 6620 6469 7370 6c61 795f       if display_
-0002df10: 7465 6e73 6f72 2069 7320 4e6f 6e65 3a20  tensor is None: 
-0002df20: 6469 7370 6c61 795f 7465 6e73 6f72 203d  display_tensor =
-0002df30: 2073 656c 662e 666c 6174 7465 6e28 290a   self.flatten().
-0002df40: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0002df50: 3a20 6469 7370 6c61 795f 7465 6e73 6f72  : display_tensor
-0002df60: 203d 2064 6973 706c 6179 5f74 656e 736f   = display_tenso
-0002df70: 722e 666c 6174 7465 6e28 290a 2020 2020  r.flatten().    
-0002df80: 2020 2020 2020 2020 6966 2064 6973 706c          if displ
-0002df90: 6179 5f74 656e 736f 722e 6973 5f63 6f6d  ay_tensor.is_com
-0002dfa0: 706c 6578 2829 3a20 6469 7370 6c61 795f  plex(): display_
-0002dfb0: 7465 6e73 6f72 203d 2063 6174 2864 6973  tensor = cat(dis
-0002dfc0: 706c 6179 5f74 656e 736f 722e 7265 616c  play_tensor.real
-0002dfd0: 2c20 6469 7370 6c61 795f 7465 6e73 6f72  , display_tensor
-0002dfe0: 2e69 6d61 6729 0a20 2020 2020 2020 2020  .imag).         
-0002dff0: 2020 2073 7472 5f65 6c65 203d 2046 616c     str_ele = Fal
-0002e000: 7365 0a20 2020 2020 2020 2020 2020 2069  se.            i
-0002e010: 6620 616e 7928 6973 6e61 6e28 6469 7370  f any(isnan(disp
-0002e020: 6c61 795f 7465 6e73 6f72 2929 3a0a 2020  lay_tensor)):.  
-0002e030: 2020 2020 2020 2020 2020 2020 2020 6469                di
-0002e040: 7370 6c61 795f 7465 6e73 6f72 203d 2064  splay_tensor = d
-0002e050: 6973 706c 6179 5f74 656e 736f 725b 7e69  isplay_tensor[~i
-0002e060: 736e 616e 2864 6973 706c 6179 5f74 656e  snan(display_ten
-0002e070: 736f 7229 5d0a 2020 2020 2020 2020 2020  sor)].          
-0002e080: 2020 2020 2020 7374 725f 656c 6520 3d20        str_ele = 
-0002e090: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-0002e0a0: 2069 6620 616e 7928 6973 696e 6628 6469   if any(isinf(di
-0002e0b0: 7370 6c61 795f 7465 6e73 6f72 2929 3a0a  splay_tensor)):.
-0002e0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e0d0: 6469 7370 6c61 795f 7465 6e73 6f72 203d  display_tensor =
-0002e0e0: 2064 6973 706c 6179 5f74 656e 736f 725b   display_tensor[
-0002e0f0: 7e69 7369 6e66 2864 6973 706c 6179 5f74  ~isinf(display_t
-0002e100: 656e 736f 7229 5d0a 2020 2020 2020 2020  ensor)].        
-0002e110: 2020 2020 2020 2020 7374 725f 656c 6520          str_ele 
-0002e120: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-0002e130: 2020 2069 6620 6469 7370 6c61 795f 7465     if display_te
-0002e140: 6e73 6f72 2e6e 5f65 6c65 203d 3d20 303a  nsor.n_ele == 0:
-0002e150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e160: 2069 6620 6e6f 7420 7374 725f 656c 653a   if not str_ele:
-0002e170: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
-0002e180: 726f 7228 2273 7472 5f65 6c65 3d46 616c  ror("str_ele=Fal
-0002e190: 7365 2061 6674 6572 2065 6c69 6d69 6e61  se after elimina
-0002e1a0: 7469 6e67 206e 616e 2f69 6e66 2074 6f20  ting nan/inf to 
-0002e1b0: 616e 2065 6d70 7479 2074 656e 736f 722e  an empty tensor.
-0002e1c0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-0002e1d0: 2020 2063 656c 6c5f 666f 726d 6174 203d     cell_format =
-0002e1e0: 2028 2769 6e74 272c 2063 656c 6c5f 6c65   ('int', cell_le
-0002e1f0: 6e5f 7374 7220 2b20 616e 7928 7365 6c66  n_str + any(self
-0002e200: 203c 2030 292c 2073 656c 662e 7368 6170   < 0), self.shap
-0002e210: 6529 0a20 2020 2020 2020 2020 2020 2065  e).            e
-0002e220: 6c69 6620 6973 7375 6263 6c61 7373 2864  lif issubclass(d
-0002e230: 6973 706c 6179 5f74 656e 736f 722e 6474  isplay_tensor.dt
-0002e240: 7970 652c 2064 7479 7065 5f28 626f 6f6c  ype, dtype_(bool
-0002e250: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-0002e260: 2020 2020 6365 6c6c 5f66 6f72 6d61 7420      cell_format 
-0002e270: 3d20 2827 626f 6f6c 272c 2034 2069 6620  = ('bool', 4 if 
-0002e280: 616c 6c28 6469 7370 6c61 795f 7465 6e73  all(display_tens
-0002e290: 6f72 2920 656c 7365 2035 2c20 7365 6c66  or) else 5, self
-0002e2a0: 2e73 6861 7065 290a 2020 2020 2020 2020  .shape).        
-0002e2b0: 2020 2020 656c 6966 206e 6f74 2064 6973      elif not dis
-0002e2c0: 706c 6179 5f74 656e 736f 722e 6474 7970  play_tensor.dtyp
-0002e2d0: 652e 6973 5f66 6c6f 6174 696e 675f 706f  e.is_floating_po
-0002e2e0: 696e 743a 0a20 2020 2020 2020 2020 2020  int:.           
-0002e2f0: 2020 2020 2063 656c 6c5f 6c65 6e20 3d20       cell_len = 
-0002e300: 696e 745f 286d 6178 2864 6973 706c 6179  int_(max(display
-0002e310: 5f74 656e 736f 722e 636c 616d 7028 6d69  _tensor.clamp(mi
-0002e320: 6e3d 3129 2e6c 6f67 2831 3029 2e66 6c6f  n=1).log(10).flo
-0002e330: 6f72 2829 292e 6974 656d 2829 2920 2b20  or()).item()) + 
-0002e340: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-0002e350: 2020 6365 6c6c 5f6c 656e 203d 206d 6178    cell_len = max
-0002e360: 5f28 6365 6c6c 5f6c 656e 2c20 696e 745f  _(cell_len, int_
-0002e370: 286d 6178 2864 6973 706c 6179 5f74 656e  (max(display_ten
-0002e380: 736f 722e 636c 616d 7028 6d61 783d 2d31  sor.clamp(max=-1
-0002e390: 652d 3129 2e61 6273 2829 2e6c 6f67 2831  e-1).abs().log(1
-0002e3a0: 3029 2e66 6c6f 6f72 2829 292e 6974 656d  0).floor()).item
-0002e3b0: 2829 2920 2b20 3120 2b20 3129 0a20 2020  ()) + 1 + 1).   
-0002e3c0: 2020 2020 2020 2020 2020 2020 2063 656c               cel
-0002e3d0: 6c5f 6c65 6e20 3d20 6d69 6e5f 2863 656c  l_len = min_(cel
-0002e3e0: 6c5f 6c65 6e2c 2063 656c 6c5f 6c65 6e5f  l_len, cell_len_
-0002e3f0: 6578 7029 0a20 2020 2020 2020 2020 2020  exp).           
-0002e400: 2020 2020 2069 6620 7374 725f 656c 653a       if str_ele:
-0002e410: 2063 656c 6c5f 6c65 6e20 3d20 6d61 785f   cell_len = max_
-0002e420: 2863 656c 6c5f 6c65 6e2c 2063 656c 6c5f  (cell_len, cell_
-0002e430: 6c65 6e5f 7374 7229 0a20 2020 2020 2020  len_str).       
-0002e440: 2020 2020 2020 2020 2063 656c 6c5f 666f           cell_fo
-0002e450: 726d 6174 203d 2028 2769 6e74 272c 2063  rmat = ('int', c
-0002e460: 656c 6c5f 6c65 6e2c 2073 656c 662e 7368  ell_len, self.sh
-0002e470: 6170 6529 0a20 2020 2020 2020 2020 2020  ape).           
-0002e480: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0002e490: 2020 2020 2020 207a 6572 6f5f 746f 5f6f         zero_to_o
-0002e4a0: 6e65 203d 206c 616d 6264 6120 783a 206f  ne = lambda x: o
-0002e4b0: 6e65 7328 3129 5b30 5d20 6966 2078 203d  nes(1)[0] if x =
-0002e4c0: 3d20 3020 656c 7365 2078 2e6c 6f67 2831  = 0 else x.log(1
-0002e4d0: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
-0002e4e0: 2020 2069 6620 7375 6d28 2864 6973 706c     if sum((displ
-0002e4f0: 6179 5f74 656e 736f 722e 6162 7328 2920  ay_tensor.abs() 
-0002e500: 3e20 3165 2d36 3429 2026 2028 6469 7370  > 1e-64) & (disp
-0002e510: 6c61 795f 7465 6e73 6f72 2e61 6273 2829  lay_tensor.abs()
-0002e520: 203c 2031 652d 3429 2920 3e20 6469 7370   < 1e-4)) > disp
-0002e530: 6c61 795f 7465 6e73 6f72 2e6e 5f65 6c65  lay_tensor.n_ele
-0002e540: 202f 2032 206f 7220 5c0a 2020 2020 2020   / 2 or \.      
-0002e550: 2020 2020 2020 2020 2020 2020 2020 616e                an
-0002e560: 7928 6469 7370 6c61 795f 7465 6e73 6f72  y(display_tensor
-0002e570: 203e 3d20 3165 3629 206f 7220 616e 7928   >= 1e6) or any(
-0002e580: 6469 7370 6c61 795f 7465 6e73 6f72 203c  display_tensor <
-0002e590: 3d20 2d31 6535 293a 2063 656c 6c5f 666f  = -1e5): cell_fo
-0002e5a0: 726d 6174 203d 2028 2765 7870 272c 2063  rmat = ('exp', c
-0002e5b0: 656c 6c5f 6c65 6e5f 6578 702c 2073 656c  ell_len_exp, sel
-0002e5c0: 662e 7368 6170 6529 0a20 2020 2020 2020  f.shape).       
-0002e5d0: 2020 2020 2020 2020 2065 6c69 6620 6162           elif ab
-0002e5e0: 7328 7a65 726f 5f74 6f5f 6f6e 6528 6469  s(zero_to_one(di
-0002e5f0: 7370 6c61 795f 7465 6e73 6f72 2e61 6273  splay_tensor.abs
-0002e600: 2829 2e6d 6178 2829 2920 2d20 7a65 726f  ().max()) - zero
-0002e610: 5f74 6f5f 6f6e 6528 6469 7370 6c61 795f  _to_one(display_
-0002e620: 7465 6e73 6f72 2e61 6273 2829 2e6d 696e  tensor.abs().min
-0002e630: 2829 2929 2e69 7465 6d28 2920 3e20 353a  ())).item() > 5:
-0002e640: 2063 656c 6c5f 666f 726d 6174 203d 2028   cell_format = (
-0002e650: 2765 7870 272c 2063 656c 6c5f 6c65 6e5f  'exp', cell_len_
-0002e660: 6578 702c 2073 656c 662e 7368 6170 6529  exp, self.shape)
-0002e670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e680: 2065 6c69 6620 616c 6c28 2864 6973 706c   elif all((displ
-0002e690: 6179 5f74 656e 736f 7220 2d20 6469 7370  ay_tensor - disp
-0002e6a0: 6c61 795f 7465 6e73 6f72 2e72 6f75 6e64  lay_tensor.round
-0002e6b0: 2829 292e 6162 7328 2920 3c20 3165 2d34  ()).abs() < 1e-4
-0002e6c0: 2920 6f72 2061 6e79 2864 6973 706c 6179  ) or any(display
-0002e6d0: 5f74 656e 736f 7220 3e3d 2031 6534 2920  _tensor >= 1e4) 
-0002e6e0: 6f72 2061 6e79 2864 6973 706c 6179 5f74  or any(display_t
-0002e6f0: 656e 736f 7220 3c3d 202d 3165 3329 3a0a  ensor <= -1e3):.
-0002e700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e710: 2020 2020 6365 6c6c 5f6c 656e 203d 2069      cell_len = i
-0002e720: 6e74 5f28 6d61 7828 282d 6469 7370 6c61  nt_(max((-displa
-0002e730: 795f 7465 6e73 6f72 2e73 6967 6e28 2929  y_tensor.sign())
-0002e740: 2e63 6c61 6d70 286d 696e 3d30 2920 2b20  .clamp(min=0) + 
-0002e750: 6469 7370 6c61 795f 7465 6e73 6f72 2e61  display_tensor.a
-0002e760: 6273 2829 2e63 6c61 6d70 286d 696e 3d31  bs().clamp(min=1
-0002e770: 292e 6c6f 6728 3130 292e 666c 6f6f 7228  ).log(10).floor(
-0002e780: 2929 2e69 7465 6d28 2929 202b 2031 202b  )).item()) + 1 +
-0002e790: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
-0002e7a0: 2020 2020 2020 2023 2063 656c 6c5f 6c65         # cell_le
-0002e7b0: 6e20 3d20 6d61 785f 2863 656c 6c5f 6c65  n = max_(cell_le
-0002e7c0: 6e2c 2069 6e74 5f28 6d61 7828 6469 7370  n, int_(max(disp
-0002e7d0: 6c61 795f 7465 6e73 6f72 2e63 6c61 6d70  lay_tensor.clamp
-0002e7e0: 286d 6178 3d2d 3165 2d31 292e 6162 7328  (max=-1e-1).abs(
-0002e7f0: 292e 6c6f 6728 3130 292e 666c 6f6f 7228  ).log(10).floor(
-0002e800: 2929 2e69 7465 6d28 2929 202b 2031 202b  )).item()) + 1 +
-0002e810: 2031 202b 2031 290a 2020 2020 2020 2020   1 + 1).        
-0002e820: 2020 2020 2020 2020 2020 2020 6365 6c6c              cell
-0002e830: 5f6c 656e 203d 206d 696e 5f28 6365 6c6c  _len = min_(cell
-0002e840: 5f6c 656e 2c20 6365 6c6c 5f6c 656e 5f65  _len, cell_len_e
-0002e850: 7870 290a 2020 2020 2020 2020 2020 2020  xp).            
-0002e860: 2020 2020 2020 2020 6966 2073 7472 5f65          if str_e
-0002e870: 6c65 3a20 6365 6c6c 5f6c 656e 203d 206d  le: cell_len = m
-0002e880: 6178 5f28 6365 6c6c 5f6c 656e 2c20 6365  ax_(cell_len, ce
-0002e890: 6c6c 5f6c 656e 5f73 7472 290a 2020 2020  ll_len_str).    
-0002e8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e8b0: 6365 6c6c 5f66 6f72 6d61 7420 3d20 2827  cell_format = ('
-0002e8c0: 2e30 6627 2c20 6365 6c6c 5f6c 656e 2c20  .0f', cell_len, 
-0002e8d0: 7365 6c66 2e73 6861 7065 290a 2020 2020  self.shape).    
-0002e8e0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-0002e8f0: 2061 6c6c 2828 6469 7370 6c61 795f 7465   all((display_te
-0002e900: 6e73 6f72 202d 2064 6973 706c 6179 5f74  nsor - display_t
-0002e910: 656e 736f 722e 726f 756e 6428 6465 6369  ensor.round(deci
-0002e920: 6d61 6c73 3d32 2929 2e61 6273 2829 203c  mals=2)).abs() <
-0002e930: 2031 652d 3429 206f 7220 616e 7928 6469   1e-4) or any(di
-0002e940: 7370 6c61 795f 7465 6e73 6f72 203e 3d20  splay_tensor >= 
-0002e950: 3165 3229 206f 7220 616e 7928 6469 7370  1e2) or any(disp
-0002e960: 6c61 795f 7465 6e73 6f72 203c 3d20 2d31  lay_tensor <= -1
-0002e970: 6531 293a 0a20 2020 2020 2020 2020 2020  e1):.           
-0002e980: 2020 2020 2020 2020 2063 656c 6c5f 6c65           cell_le
-0002e990: 6e20 3d20 696e 745f 286d 6178 2828 2d64  n = int_(max((-d
-0002e9a0: 6973 706c 6179 5f74 656e 736f 722e 7369  isplay_tensor.si
-0002e9b0: 676e 2829 292e 636c 616d 7028 6d69 6e3d  gn()).clamp(min=
-0002e9c0: 3029 202b 2064 6973 706c 6179 5f74 656e  0) + display_ten
-0002e9d0: 736f 722e 6162 7328 292e 636c 616d 7028  sor.abs().clamp(
-0002e9e0: 6d69 6e3d 3129 2e6c 6f67 2831 3029 2e66  min=1).log(10).f
-0002e9f0: 6c6f 6f72 2829 292e 6974 656d 2829 2920  loor()).item()) 
-0002ea00: 2b20 3120 2b20 330a 2020 2020 2020 2020  + 1 + 3.        
-0002ea10: 2020 2020 2020 2020 2020 2020 2320 6365              # ce
-0002ea20: 6c6c 5f6c 656e 203d 206d 6178 5f28 6365  ll_len = max_(ce
-0002ea30: 6c6c 5f6c 656e 2c20 696e 745f 286d 6178  ll_len, int_(max
-0002ea40: 2864 6973 706c 6179 5f74 656e 736f 722e  (display_tensor.
-0002ea50: 636c 616d 7028 6d61 783d 2d31 652d 3129  clamp(max=-1e-1)
-0002ea60: 2e61 6273 2829 2e6c 6f67 2831 3029 2e66  .abs().log(10).f
-0002ea70: 6c6f 6f72 2829 292e 6974 656d 2829 2920  loor()).item()) 
-0002ea80: 2b20 3120 2b20 3120 2b20 3329 0a20 2020  + 1 + 1 + 3).   
-0002ea90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eaa0: 2063 656c 6c5f 6c65 6e20 3d20 6d69 6e5f   cell_len = min_
-0002eab0: 2863 656c 6c5f 6c65 6e2c 2063 656c 6c5f  (cell_len, cell_
-0002eac0: 6c65 6e5f 6578 7029 0a20 2020 2020 2020  len_exp).       
-0002ead0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0002eae0: 7374 725f 656c 653a 2063 656c 6c5f 6c65  str_ele: cell_le
-0002eaf0: 6e20 3d20 6d61 785f 2863 656c 6c5f 6c65  n = max_(cell_le
-0002eb00: 6e2c 2063 656c 6c5f 6c65 6e5f 7374 7229  n, cell_len_str)
-0002eb10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002eb20: 2020 2020 2063 656c 6c5f 666f 726d 6174       cell_format
-0002eb30: 203d 2028 272e 3266 272c 2063 656c 6c5f   = ('.2f', cell_
-0002eb40: 6c65 6e2c 2073 656c 662e 7368 6170 6529  len, self.shape)
-0002eb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002eb60: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0002eb70: 2020 2020 2020 2020 2020 2063 656c 6c5f             cell_
-0002eb80: 6c65 6e20 3d20 696e 745f 286d 6178 2828  len = int_(max((
-0002eb90: 2d64 6973 706c 6179 5f74 656e 736f 722e  -display_tensor.
-0002eba0: 7369 676e 2829 292e 636c 616d 7028 6d69  sign()).clamp(mi
-0002ebb0: 6e3d 3029 202b 2064 6973 706c 6179 5f74  n=0) + display_t
-0002ebc0: 656e 736f 722e 6162 7328 292e 636c 616d  ensor.abs().clam
-0002ebd0: 7028 6d69 6e3d 3129 2e6c 6f67 2831 3029  p(min=1).log(10)
-0002ebe0: 2e66 6c6f 6f72 2829 292e 6974 656d 2829  .floor()).item()
-0002ebf0: 2920 2b20 3120 2b20 350a 2020 2020 2020  ) + 1 + 5.      
-0002ec00: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0002ec10: 6365 6c6c 5f6c 656e 203d 206d 6178 5f28  cell_len = max_(
-0002ec20: 6365 6c6c 5f6c 656e 2c20 696e 745f 286d  cell_len, int_(m
-0002ec30: 6178 2864 6973 706c 6179 5f74 656e 736f  ax(display_tenso
-0002ec40: 722e 636c 616d 7028 6d61 783d 2d31 652d  r.clamp(max=-1e-
-0002ec50: 3129 2e61 6273 2829 2e6c 6f67 2831 3029  1).abs().log(10)
-0002ec60: 2e66 6c6f 6f72 2829 292e 6974 656d 2829  .floor()).item()
-0002ec70: 2920 2b20 3120 2b20 3120 2b20 3529 0a20  ) + 1 + 1 + 5). 
-0002ec80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ec90: 2020 2063 656c 6c5f 6c65 6e20 3d20 6d69     cell_len = mi
-0002eca0: 6e5f 2863 656c 6c5f 6c65 6e2c 2063 656c  n_(cell_len, cel
-0002ecb0: 6c5f 6c65 6e5f 6578 7029 0a20 2020 2020  l_len_exp).     
-0002ecc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0002ecd0: 6620 7374 725f 656c 653a 2063 656c 6c5f  f str_ele: cell_
-0002ece0: 6c65 6e20 3d20 6d61 785f 2863 656c 6c5f  len = max_(cell_
-0002ecf0: 6c65 6e2c 2063 656c 6c5f 6c65 6e5f 7374  len, cell_len_st
-0002ed00: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-0002ed10: 2020 2020 2020 2063 656c 6c5f 666f 726d         cell_form
-0002ed20: 6174 203d 2028 272e 3466 272c 2063 656c  at = ('.4f', cel
-0002ed30: 6c5f 6c65 6e2c 2073 656c 662e 7368 6170  l_len, self.shap
-0002ed40: 6529 0a20 2020 2020 2020 2063 656c 6c5f  e).        cell_
-0002ed50: 666e 616d 652c 2063 656c 6c5f 6c65 6e2c  fname, cell_len,
-0002ed60: 2074 6f74 616c 5f73 697a 6520 3d20 6365   total_size = ce
-0002ed70: 6c6c 5f66 6f72 6d61 740a 2020 2020 2020  ll_format.      
-0002ed80: 2020 656c 7073 203d 2028 227b 3a5e 2564    elps = ("{:^%d
-0002ed90: 737d 2225 6365 6c6c 5f6c 656e 292e 666f  s}"%cell_len).fo
-0002eda0: 726d 6174 2827 2e2e 2e27 290a 2020 2020  rmat('...').    
-0002edb0: 2020 2020 6966 2073 656c 662e 6e5f 6469      if self.n_di
-0002edc0: 6d20 3d3d 2030 3a0a 2020 2020 2020 2020  m == 0:.        
-0002edd0: 2020 2020 7661 6c20 3d20 7365 6c66 2e69      val = self.i
-0002ede0: 7465 6d28 290a 2020 2020 2020 2020 2020  tem().          
-0002edf0: 2020 6465 6620 7661 6c5f 7374 7228 7661    def val_str(va
-0002ee00: 6c29 3a0a 2020 2020 2020 2020 2020 2020  l):.            
-0002ee10: 2020 2020 6966 2072 6570 7228 7661 6c29      if repr(val)
-0002ee20: 203d 3d20 276e 616e 273a 2072 6574 7572   == 'nan': retur
-0002ee30: 6e20 2822 7b3a 3e25 6473 7d22 2563 656c  n ("{:>%ds}"%cel
-0002ee40: 6c5f 6c65 6e29 2e66 6f72 6d61 7428 224e  l_len).format("N
-0002ee50: 614e 2229 0a20 2020 2020 2020 2020 2020  aN").           
-0002ee60: 2020 2020 2065 6c69 6620 7265 7072 2876       elif repr(v
-0002ee70: 616c 2920 3d3d 2027 696e 6627 3a20 7265  al) == 'inf': re
-0002ee80: 7475 726e 2028 227b 3a3e 2564 737d 2225  turn ("{:>%ds}"%
-0002ee90: 6365 6c6c 5f6c 656e 292e 666f 726d 6174  cell_len).format
-0002eea0: 2822 496e 6622 290a 2020 2020 2020 2020  ("Inf").        
-0002eeb0: 2020 2020 2020 2020 656c 6966 2072 6570          elif rep
-0002eec0: 7228 7661 6c29 203d 3d20 272d 696e 6627  r(val) == '-inf'
-0002eed0: 3a20 7265 7475 726e 2028 227b 3a3e 2564  : return ("{:>%d
-0002eee0: 737d 2225 6365 6c6c 5f6c 656e 292e 666f  s}"%cell_len).fo
-0002eef0: 726d 6174 2822 2d49 6e66 2229 0a20 2020  rmat("-Inf").   
-0002ef00: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-0002ef10: 6620 6365 6c6c 5f66 6e61 6d65 203d 3d20  f cell_fname == 
-0002ef20: 2762 6f6f 6c27 3a20 7265 7475 726e 2028  'bool': return (
-0002ef30: 227b 3a5e 2564 737d 2225 6365 6c6c 5f6c  "{:^%ds}"%cell_l
-0002ef40: 656e 292e 666f 726d 6174 2873 7472 2876  en).format(str(v
-0002ef50: 616c 2929 0a20 2020 2020 2020 2020 2020  al)).           
-0002ef60: 2020 2020 2065 6c69 6620 6365 6c6c 5f66       elif cell_f
-0002ef70: 6e61 6d65 203d 3d20 2769 6e74 273a 2072  name == 'int': r
-0002ef80: 6574 7572 6e20 2822 7b3a 5e25 6464 7d22  eturn ("{:^%dd}"
-0002ef90: 2563 656c 6c5f 6c65 6e29 2e66 6f72 6d61  %cell_len).forma
-0002efa0: 7428 7661 6c29 0a20 2020 2020 2020 2020  t(val).         
-0002efb0: 2020 2020 2020 2065 6c69 6620 6365 6c6c         elif cell
-0002efc0: 5f66 6e61 6d65 203d 3d20 272e 3066 273a  _fname == '.0f':
-0002efd0: 2072 6574 7572 6e20 2822 7b3a 2564 737d   return ("{:%ds}
-0002efe0: 2225 6365 6c6c 5f6c 656e 292e 666f 726d  "%cell_len).form
-0002eff0: 6174 2873 7472 2872 6f75 6e64 5f28 7661  at(str(round_(va
-0002f000: 6c29 2920 2b20 272e 2729 0a20 2020 2020  l)) + '.').     
-0002f010: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0002f020: 6365 6c6c 5f66 6e61 6d65 203d 3d20 272e  cell_fname == '.
-0002f030: 3266 273a 2072 6574 7572 6e20 2822 7b3a  2f': return ("{:
-0002f040: 2564 2e32 667d 2225 6365 6c6c 5f6c 656e  %d.2f}"%cell_len
-0002f050: 292e 666f 726d 6174 2876 616c 290a 2020  ).format(val).  
-0002f060: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0002f070: 6966 2063 656c 6c5f 666e 616d 6520 3d3d  if cell_fname ==
-0002f080: 2027 2e34 6627 3a20 7265 7475 726e 2028   '.4f': return (
-0002f090: 227b 3a25 642e 3466 7d22 2563 656c 6c5f  "{:%d.4f}"%cell_
-0002f0a0: 6c65 6e29 2e66 6f72 6d61 7428 7661 6c29  len).format(val)
-0002f0b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f0c0: 2065 6c69 6620 6365 6c6c 5f66 6e61 6d65   elif cell_fname
-0002f0d0: 203d 3d20 2765 7870 273a 0a20 2020 2020   == 'exp':.     
-0002f0e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0002f0f0: 6620 7661 6c20 3d3d 2030 3a20 6c65 7620  f val == 0: lev 
-0002f100: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
-0002f110: 2020 2020 2020 2020 656c 7365 3a20 6c65          else: le
-0002f120: 7620 3d20 696e 745f 286d 6174 682e 6c6f  v = int_(math.lo
-0002f130: 6728 6162 735f 2876 616c 292c 2031 3029  g(abs_(val), 10)
-0002f140: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002f150: 2020 2020 2020 6261 7365 203d 2076 616c        base = val
-0002f160: 202f 2028 3130 202a 2a20 6c65 7629 0a20   / (10 ** lev). 
-0002f170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f180: 2020 206c 6576 5f73 7472 203d 2066 277b     lev_str = f'{
-0002f190: 6c65 763a 3264 7d27 2e72 6570 6c61 6365  lev:2d}'.replace
-0002f1a0: 2827 2027 2c20 272b 2729 2069 6620 6c65  (' ', '+') if le
-0002f1b0: 7620 3e3d 2030 2065 6c73 6520 6627 7b6c  v >= 0 else f'{l
-0002f1c0: 6576 3a31 647d 270a 2020 2020 2020 2020  ev:1d}'.        
-0002f1d0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0002f1e0: 726e 2066 227b 6261 7365 3a35 2e32 667d  rn f"{base:5.2f}
-0002f1f0: 657b 6c65 765f 7374 727d 220a 2020 2020  e{lev_str}".    
-0002f200: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0002f210: 7461 6e63 6528 7661 6c2c 2063 6f6d 706c  tance(val, compl
-0002f220: 6578 5f29 3a0a 2020 2020 2020 2020 2020  ex_):.          
-0002f230: 2020 2020 2020 7265 7475 726e 2076 616c        return val
-0002f240: 5f73 7472 2876 616c 2e72 6561 6c29 202b  _str(val.real) +
-0002f250: 2027 2b27 202b 2076 616c 5f73 7472 2876   '+' + val_str(v
-0002f260: 616c 2e69 6d61 6729 202b 2027 6927 0a20  al.imag) + 'i'. 
-0002f270: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0002f280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f290: 2072 6574 7572 6e20 7661 6c5f 7374 7228   return val_str(
-0002f2a0: 7661 6c29 0a20 2020 2020 2020 2069 6620  val).        if 
-0002f2b0: 7365 6c66 2e6e 5f64 696d 203d 3d20 313a  self.n_dim == 1:
-0002f2c0: 0a20 2020 2020 2020 2020 2020 206d 6178  .            max
-0002f2d0: 5f73 697a 652c 2070 6164 5f73 697a 6520  _size, pad_size 
-0002f2e0: 3d20 6372 6974 6572 6961 5b27 3c6e 275d  = criteria['<n']
-0002f2f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002f300: 6973 696e 7374 616e 6365 2870 6164 5f73  isinstance(pad_s
-0002f310: 697a 652c 2069 6e74 5f29 3a20 7061 645f  ize, int_): pad_
-0002f320: 7369 7a65 203d 2028 7061 645f 7369 7a65  size = (pad_size
-0002f330: 2c20 7061 645f 7369 7a65 290a 2020 2020  , pad_size).    
-0002f340: 2020 2020 2020 2020 6e5f 7369 7a65 203d          n_size =
-0002f350: 2073 656c 662e 7369 7a65 2830 290a 2020   self.size(0).  
-0002f360: 2020 2020 2020 2020 2020 6469 7370 6c61            displa
-0002f370: 795f 7361 6d70 6c65 7320 3d20 7261 6e67  y_samples = rang
-0002f380: 655f 286e 5f73 697a 6529 2069 6620 6e5f  e_(n_size) if n_
-0002f390: 7369 7a65 203c 3d20 6d61 785f 7369 7a65  size <= max_size
-0002f3a0: 2065 6c73 6520 6c69 7374 2872 616e 6765   else list(range
-0002f3b0: 5f28 7061 645f 7369 7a65 5b30 5d29 2920  _(pad_size[0])) 
-0002f3c0: 2b20 5b2e 2e2e 5d20 2b20 6c69 7374 2872  + [...] + list(r
-0002f3d0: 616e 6765 5f28 6e5f 7369 7a65 202d 2070  ange_(n_size - p
-0002f3e0: 6164 5f73 697a 655b 315d 2c20 6e5f 7369  ad_size[1], n_si
-0002f3f0: 7a65 2929 0a20 2020 2020 2020 2020 2020  ze)).           
-0002f400: 2069 6620 7365 6c66 2e68 6173 5f66 756e   if self.has_fun
-0002f410: 633a 2072 6574 7572 6e20 6622 287b 2720  c: return f"({' 
-0002f420: 272e 6a6f 696e 2865 6c70 7320 6966 2069  '.join(elps if i
-0002f430: 203d 3d20 2e2e 2e20 656c 7365 2073 656c   == ... else sel
-0002f440: 665b 695d 2e5f 5f72 6177 5f72 6570 725f  f[i].__raw_repr_
-0002f450: 5f28 6365 6c6c 5f66 6f72 6d61 743d 6365  _(cell_format=ce
-0002f460: 6c6c 5f66 6f72 6d61 7429 2066 6f72 2069  ll_format) for i
-0002f470: 2069 6e20 6469 7370 6c61 795f 7361 6d70   in display_samp
-0002f480: 6c65 7329 7d29 220a 2020 2020 2020 2020  les)})".        
-0002f490: 2020 2020 656c 6966 2073 656c 662e 6861      elif self.ha
-0002f4a0: 735f 6261 7463 683a 0a20 2020 2020 2020  s_batch:.       
-0002f4b0: 2020 2020 2020 2020 2069 6620 746f 7461           if tota
-0002f4c0: 6c5f 7369 7a65 2e6e 5f66 756e 635f 6469  l_size.n_func_di
-0002f4d0: 6d20 2b20 746f 7461 6c5f 7369 7a65 2e6e  m + total_size.n
-0002f4e0: 5f62 6174 6368 5f64 696d 203d 3d20 746f  _batch_dim == to
-0002f4f0: 7461 6c5f 7369 7a65 2e6e 5f64 696d 3a0a  tal_size.n_dim:.
-0002f500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f510: 2020 2020 7265 7475 726e 2066 227b 7b7b      return f"{{{
-0002f520: 7365 6c66 5b30 5d2e 5f5f 7261 775f 7265  self[0].__raw_re
-0002f530: 7072 5f5f 2863 656c 6c5f 666f 726d 6174  pr__(cell_format
-0002f540: 3d63 656c 6c5f 666f 726d 6174 297d 2c20  =cell_format)}, 
-0002f550: 2e2e 2e7d 7d22 0a20 2020 2020 2020 2020  ...}}".         
-0002f560: 2020 2020 2020 2065 6c73 653a 2072 6574         else: ret
-0002f570: 7572 6e20 6622 7b7b 7b73 656c 665b 305d  urn f"{{{self[0]
-0002f580: 2e5f 5f72 6177 5f72 6570 725f 5f28 6365  .__raw_repr__(ce
-0002f590: 6c6c 5f66 6f72 6d61 743d 6365 6c6c 5f66  ll_format=cell_f
-0002f5a0: 6f72 6d61 7429 7d7d 7d22 0a20 2020 2020  ormat)}}}".     
-0002f5b0: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
-0002f5c0: 2e68 6173 5f66 6561 7475 7265 3a0a 2020  .has_feature:.  
-0002f5d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0002f5e0: 2074 6f74 616c 5f73 697a 652e 6e5f 6665   total_size.n_fe
-0002f5f0: 6174 7572 655f 6469 6d20 3d3d 2031 3a0a  ature_dim == 1:.
-0002f600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f610: 2020 2020 7265 7475 726e 2054 656e 736f      return Tenso
-0002f620: 722e 5f5f 636f 726e 6572 5f62 6c6f 636b  r.__corner_block
-0002f630: 5f72 6570 725f 5f28 275c 6e27 2e6a 6f69  _repr__('\n'.joi
-0002f640: 6e28 656c 7073 2069 6620 6920 3d3d 202e  n(elps if i == .
-0002f650: 2e2e 2065 6c73 6520 7365 6c66 5b69 5d2e  .. else self[i].
-0002f660: 5f5f 7261 775f 7265 7072 5f5f 2863 656c  __raw_repr__(cel
-0002f670: 6c5f 666f 726d 6174 3d63 656c 6c5f 666f  l_format=cell_fo
-0002f680: 726d 6174 2920 666f 7220 6920 696e 2064  rmat) for i in d
-0002f690: 6973 706c 6179 5f73 616d 706c 6573 2929  isplay_samples))
-0002f6a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f6b0: 2072 6574 7572 6e20 6622 7b27 2027 2e6a   return f"{' '.j
-0002f6c0: 6f69 6e28 656c 7073 2069 6620 6920 3d3d  oin(elps if i ==
-0002f6d0: 202e 2e2e 2065 6c73 6520 7365 6c66 5b69   ... else self[i
-0002f6e0: 5d2e 5f5f 7261 775f 7265 7072 5f5f 2863  ].__raw_repr__(c
-0002f6f0: 656c 6c5f 666f 726d 6174 3d63 656c 6c5f  ell_format=cell_
-0002f700: 666f 726d 6174 2920 666f 7220 6920 696e  format) for i in
-0002f710: 2064 6973 706c 6179 5f73 616d 706c 6573   display_samples
-0002f720: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
-0002f730: 656c 6966 2073 656c 662e 6861 735f 7365  elif self.has_se
-0002f740: 7175 656e 6365 3a0a 2020 2020 2020 2020  quence:.        
-0002f750: 2020 2020 2020 2020 6966 2074 6f74 616c          if total
-0002f760: 5f73 697a 652e 6e5f 7370 6163 655f 6469  _size.n_space_di
-0002f770: 6d20 3e20 303a 2072 6574 7572 6e20 6622  m > 0: return f"
-0002f780: 3e7b 7365 6c66 5b30 5d2e 5f5f 7261 775f  >{self[0].__raw_
-0002f790: 7265 7072 5f5f 2863 656c 6c5f 666f 726d  repr__(cell_form
-0002f7a0: 6174 3d63 656c 6c5f 666f 726d 6174 297d  at=cell_format)}
-0002f7b0: 3e22 0a20 2020 2020 2020 2020 2020 2020  >".             
-0002f7c0: 2020 2065 6c69 6620 6e5f 7369 7a65 203d     elif n_size =
-0002f7d0: 3d20 313a 2072 6574 7572 6e20 6622 3e20  = 1: return f"> 
-0002f7e0: 7b73 656c 665b 305d 2e5f 5f72 6177 5f72  {self[0].__raw_r
-0002f7f0: 6570 725f 5f28 6365 6c6c 5f66 6f72 6d61  epr__(cell_forma
-0002f800: 743d 6365 6c6c 5f66 6f72 6d61 7429 7d20  t=cell_format)} 
-0002f810: 3e22 0a20 2020 2020 2020 2020 2020 2020  >".             
-0002f820: 2020 2065 6c69 6620 6e5f 7369 7a65 203d     elif n_size =
-0002f830: 3d20 323a 2072 6574 7572 6e20 6622 277b  = 2: return f"'{
-0002f840: 7365 6c66 5b30 5d2e 5f5f 7261 775f 7265  self[0].__raw_re
-0002f850: 7072 5f5f 2863 656c 6c5f 666f 726d 6174  pr__(cell_format
-0002f860: 3d63 656c 6c5f 666f 726d 6174 297d 203e  =cell_format)} >
-0002f870: 207b 7365 6c66 5b2d 315d 2e5f 5f72 6177   {self[-1].__raw
-0002f880: 5f72 6570 725f 5f28 6365 6c6c 5f66 6f72  _repr__(cell_for
-0002f890: 6d61 743d 6365 6c6c 5f66 6f72 6d61 7429  mat=cell_format)
-0002f8a0: 7d27 220a 2020 2020 2020 2020 2020 2020  }'".            
-0002f8b0: 2020 2020 656c 7365 3a20 7265 7475 726e      else: return
-0002f8c0: 2066 2227 7b73 656c 665b 305d 2e5f 5f72   f"'{self[0].__r
-0002f8d0: 6177 5f72 6570 725f 5f28 6365 6c6c 5f66  aw_repr__(cell_f
-0002f8e0: 6f72 6d61 743d 6365 6c6c 5f66 6f72 6d61  ormat=cell_forma
-0002f8f0: 7429 7d20 3e20 2e2e 2e20 3e20 7b73 656c  t)} > ... > {sel
-0002f900: 665b 2d31 5d2e 5f5f 7261 775f 7265 7072  f[-1].__raw_repr
-0002f910: 5f5f 2863 656c 6c5f 666f 726d 6174 3d63  __(cell_format=c
-0002f920: 656c 6c5f 666f 726d 6174 297d 2722 0a20  ell_format)}'". 
-0002f930: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0002f940: 2072 6574 7572 6e20 6622 5b7b 272c 2027   return f"[{', '
-0002f950: 2e6a 6f69 6e28 656c 7073 2069 6620 6920  .join(elps if i 
-0002f960: 3d3d 202e 2e2e 2065 6c73 6520 7365 6c66  == ... else self
-0002f970: 5b69 5d2e 5f5f 7261 775f 7265 7072 5f5f  [i].__raw_repr__
-0002f980: 2863 656c 6c5f 666f 726d 6174 3d63 656c  (cell_format=cel
-0002f990: 6c5f 666f 726d 6174 2920 666f 7220 6920  l_format) for i 
-0002f9a0: 696e 2064 6973 706c 6179 5f73 616d 706c  in display_sampl
-0002f9b0: 6573 297d 5d22 0a20 2020 2020 2020 2069  es)}]".        i
-0002f9c0: 6620 7365 6c66 2e6e 5f64 696d 203e 2034  f self.n_dim > 4
-0002f9d0: 3a20 6d61 785f 7369 7a65 2c20 7061 645f  : max_size, pad_
-0002f9e0: 7369 7a65 203d 2063 7269 7465 7269 615b  size = criteria[
-0002f9f0: 273c 6e2d 3427 5d0a 2020 2020 2020 2020  '<n-4'].        
-0002fa00: 656c 6966 2073 656c 662e 6e5f 6469 6d20  elif self.n_dim 
-0002fa10: 3e20 323a 206d 6178 5f73 697a 652c 2070  > 2: max_size, p
-0002fa20: 6164 5f73 697a 6520 3d20 6372 6974 6572  ad_size = criter
-0002fa30: 6961 5b27 3c6e 2d32 275d 0a20 2020 2020  ia['<n-2'].     
-0002fa40: 2020 2065 6c73 653a 206d 6178 5f73 697a     else: max_siz
-0002fa50: 652c 2070 6164 5f73 697a 6520 3d20 6372  e, pad_size = cr
-0002fa60: 6974 6572 6961 5b27 3c6e 2d31 275d 0a20  iteria['<n-1']. 
-0002fa70: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0002fa80: 616e 6365 2870 6164 5f73 697a 652c 2069  ance(pad_size, i
-0002fa90: 6e74 5f29 3a20 7061 645f 7369 7a65 203d  nt_): pad_size =
-0002faa0: 2028 7061 645f 7369 7a65 2c20 7061 645f   (pad_size, pad_
-0002fab0: 7369 7a65 290a 2020 2020 2020 2020 6e5f  size).        n_
-0002fac0: 7369 7a65 203d 2073 656c 662e 7369 7a65  size = self.size
-0002fad0: 2830 290a 2020 2020 2020 2020 6469 7370  (0).        disp
-0002fae0: 6c61 795f 7361 6d70 6c65 7320 3d20 7261  lay_samples = ra
-0002faf0: 6e67 655f 286e 5f73 697a 6529 2069 6620  nge_(n_size) if 
-0002fb00: 6e5f 7369 7a65 203c 3d20 6d61 785f 7369  n_size <= max_si
-0002fb10: 7a65 2065 6c73 6520 6c69 7374 2872 616e  ze else list(ran
-0002fb20: 6765 5f28 7061 645f 7369 7a65 5b30 5d29  ge_(pad_size[0])
-0002fb30: 2920 2b20 5b2e 2e2e 5d20 2b20 6c69 7374  ) + [...] + list
-0002fb40: 2872 616e 6765 5f28 6e5f 7369 7a65 202d  (range_(n_size -
-0002fb50: 2070 6164 5f73 697a 655b 315d 2c20 6e5f   pad_size[1], n_
-0002fb60: 7369 7a65 2929 0a20 2020 2020 2020 2069  size)).        i
-0002fb70: 6620 7365 6c66 2e73 6861 7065 5b3a 315d  f self.shape[:1]
-0002fb80: 2e68 6173 5f66 756e 633a 2072 6574 7572  .has_func: retur
-0002fb90: 6e20 2728 2720 2b20 275c 6e20 272e 6a6f  n '(' + '\n '.jo
-0002fba0: 696e 2827 2027 202b 2065 6c70 7320 6966  in(' ' + elps if
-0002fbb0: 2069 203d 3d20 2e2e 2e20 656c 7365 2054   i == ... else T
-0002fbc0: 656e 736f 722e 5f5f 7368 6966 745f 7265  ensor.__shift_re
-0002fbd0: 7072 5f5f 2873 656c 665b 695d 2e5f 5f72  pr__(self[i].__r
-0002fbe0: 6177 5f72 6570 725f 5f28 6365 6c6c 5f66  aw_repr__(cell_f
-0002fbf0: 6f72 6d61 743d 6365 6c6c 5f66 6f72 6d61  ormat=cell_forma
-0002fc00: 7429 2920 666f 7220 6920 696e 2064 6973  t)) for i in dis
-0002fc10: 706c 6179 5f73 616d 706c 6573 2920 2b20  play_samples) + 
-0002fc20: 2729 270a 2020 2020 2020 2020 656c 6966  ')'.        elif
-0002fc30: 2073 656c 662e 7368 6170 655b 3a31 5d2e   self.shape[:1].
-0002fc40: 6861 735f 6261 7463 683a 0a20 2020 2020  has_batch:.     
-0002fc50: 2020 2020 2020 2069 6620 6c65 6e28 7365         if len(se
-0002fc60: 6c66 2e73 6861 7065 2920 3c3d 2032 206f  lf.shape) <= 2 o
-0002fc70: 7220 6c65 6e28 7365 6c66 2e73 6861 7065  r len(self.shape
-0002fc80: 2920 3d3d 2033 2061 6e64 2073 656c 662e  ) == 3 and self.
-0002fc90: 7368 6170 652e 6861 735f 7365 7175 656e  shape.has_sequen
-0002fca0: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
-0002fcb0: 2020 2020 7265 7475 726e 2066 227b 7b7b      return f"{{{
-0002fcc0: 5465 6e73 6f72 2e5f 5f73 6869 6674 5f72  Tensor.__shift_r
-0002fcd0: 6570 725f 5f28 7365 6c66 5b30 5d2e 5f5f  epr__(self[0].__
-0002fce0: 7261 775f 7265 7072 5f5f 2863 656c 6c5f  raw_repr__(cell_
-0002fcf0: 666f 726d 6174 3d63 656c 6c5f 666f 726d  format=cell_form
-0002fd00: 6174 2929 7d2c 202e 2e2e 7d7d 220a 2020  at))}, ...}}".  
-0002fd10: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0002fd20: 2066 227b 7b7b 5465 6e73 6f72 2e5f 5f73   f"{{{Tensor.__s
-0002fd30: 6869 6674 5f72 6570 725f 5f28 7365 6c66  hift_repr__(self
-0002fd40: 5b30 5d2e 5f5f 7261 775f 7265 7072 5f5f  [0].__raw_repr__
-0002fd50: 2863 656c 6c5f 666f 726d 6174 3d63 656c  (cell_format=cel
-0002fd60: 6c5f 666f 726d 6174 2929 7d2c 5c6e 2e2e  l_format))},\n..
-0002fd70: 2e7d 7d22 0a20 2020 2020 2020 2065 6c69  .}}".        eli
-0002fd80: 6620 7365 6c66 2e73 6861 7065 5b3a 315d  f self.shape[:1]
-0002fd90: 2e68 6173 5f66 6561 7475 7265 3a0a 2020  .has_feature:.  
-0002fda0: 2020 2020 2020 2020 2020 6966 2074 6f74            if tot
-0002fdb0: 616c 5f73 697a 652e 6e5f 6665 6174 7572  al_size.n_featur
-0002fdc0: 655f 6469 6d20 3c3d 2032 3a0a 2020 2020  e_dim <= 2:.    
-0002fdd0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0002fde0: 726e 2054 656e 736f 722e 5f5f 636f 726e  rn Tensor.__corn
-0002fdf0: 6572 5f62 6c6f 636b 5f72 6570 725f 5f28  er_block_repr__(
-0002fe00: 275c 6e27 2e6a 6f69 6e28 656c 7073 2069  '\n'.join(elps i
-0002fe10: 6620 6920 3d3d 202e 2e2e 2065 6c73 6520  f i == ... else 
-0002fe20: 7365 6c66 5b69 5d2e 5f5f 7261 775f 7265  self[i].__raw_re
-0002fe30: 7072 5f5f 2863 656c 6c5f 666f 726d 6174  pr__(cell_format
-0002fe40: 3d63 656c 6c5f 666f 726d 6174 2920 666f  =cell_format) fo
-0002fe50: 7220 6920 696e 2064 6973 706c 6179 5f73  r i in display_s
-0002fe60: 616d 706c 6573 2929 0a20 2020 2020 2020  amples)).       
-0002fe70: 2020 2020 2065 6c69 6620 746f 7461 6c5f       elif total_
-0002fe80: 7369 7a65 2e6e 5f64 696d 202d 206c 656e  size.n_dim - len
-0002fe90: 2873 656c 662e 7368 6170 6529 203d 3d20  (self.shape) == 
-0002fea0: 746f 7461 6c5f 7369 7a65 2e66 6561 7475  total_size.featu
-0002feb0: 7265 5f73 746f 702d 3120 616e 6420 746f  re_stop-1 and to
-0002fec0: 7461 6c5f 7369 7a65 2e73 7a5f 6665 6174  tal_size.sz_feat
-0002fed0: 7572 655f 6469 6d20 3c20 3020 616e 6420  ure_dim < 0 and 
-0002fee0: 6e6f 7420 7365 6c66 2e73 6861 7065 5b31  not self.shape[1
-0002fef0: 3a5d 2e68 6173 5f66 756e 633a 0a20 2020  :].has_func:.   
-0002ff00: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0002ff10: 746f 7461 6c5f 7369 7a65 2e6e 5f66 6561  total_size.n_fea
-0002ff20: 7475 7265 5f64 696d 203e 2031 3a0a 2020  ture_dim > 1:.  
-0002ff30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ff40: 2020 7265 7475 726e 2066 227b 2720 272e    return f"{' '.
-0002ff50: 6a6f 696e 2865 6c70 7320 6966 2069 203d  join(elps if i =
-0002ff60: 3d20 2e2e 2e20 656c 7365 2073 656c 665b  = ... else self[
-0002ff70: 695d 2e5f 5f72 6177 5f72 6570 725f 5f28  i].__raw_repr__(
-0002ff80: 6365 6c6c 5f66 6f72 6d61 743d 6365 6c6c  cell_format=cell
-0002ff90: 5f66 6f72 6d61 7429 2066 6f72 2069 2069  _format) for i i
-0002ffa0: 6e20 6469 7370 6c61 795f 7361 6d70 6c65  n display_sample
-0002ffb0: 7329 7d22 0a20 2020 2020 2020 2020 2020  s)}".           
-0002ffc0: 2020 2020 2072 6574 7572 6e20 6622 5b7b       return f"[{
-0002ffd0: 2720 272e 6a6f 696e 2865 6c70 7320 6966  ' '.join(elps if
-0002ffe0: 2069 203d 3d20 2e2e 2e20 656c 7365 2054   i == ... else T
-0002fff0: 656e 736f 722e 5f5f 7368 6966 745f 7265  ensor.__shift_re
-00030000: 7072 5f5f 2873 656c 665b 695d 2e5f 5f72  pr__(self[i].__r
-00030010: 6177 5f72 6570 725f 5f28 6365 6c6c 5f66  aw_repr__(cell_f
-00030020: 6f72 6d61 743d 6365 6c6c 5f66 6f72 6d61  ormat=cell_forma
-00030030: 7429 2920 666f 7220 6920 696e 2064 6973  t)) for i in dis
-00030040: 706c 6179 5f73 616d 706c 6573 297d 5d22  play_samples)}]"
-00030050: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00030060: 653a 2072 6574 7572 6e20 27ef bda2 2720  e: return '...' 
-00030070: 2b20 275c 6e20 272e 6a6f 696e 2827 2027  + '\n '.join(' '
-00030080: 202b 2065 6c70 7320 6966 2069 203d 3d20   + elps if i == 
-00030090: 2e2e 2e20 656c 7365 2054 656e 736f 722e  ... else Tensor.
-000300a0: 5f5f 7368 6966 745f 7265 7072 5f5f 2873  __shift_repr__(s
-000300b0: 656c 665b 695d 2e5f 5f72 6177 5f72 6570  elf[i].__raw_rep
-000300c0: 725f 5f28 6365 6c6c 5f66 6f72 6d61 743d  r__(cell_format=
-000300d0: 6365 6c6c 5f66 6f72 6d61 7429 2920 666f  cell_format)) fo
-000300e0: 7220 6920 696e 2064 6973 706c 6179 5f73  r i in display_s
-000300f0: 616d 706c 6573 2920 2b20 27ef bda3 270a  amples) + '...'.
-00030100: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
-00030110: 662e 7368 6170 655b 3a31 5d2e 6861 735f  f.shape[:1].has_
-00030120: 7365 7175 656e 6365 3a0a 2020 2020 2020  sequence:.      
-00030130: 2020 2020 2020 6966 2074 6f74 616c 5f73        if total_s
-00030140: 697a 652e 6e5f 6469 6d20 2d20 6c65 6e28  ize.n_dim - len(
-00030150: 7365 6c66 2e73 6861 7065 2920 3d3d 2074  self.shape) == t
-00030160: 6f74 616c 5f73 697a 652e 7365 7175 656e  otal_size.sequen
-00030170: 6365 5f73 746f 702d 3120 616e 6420 746f  ce_stop-1 and to
-00030180: 7461 6c5f 7369 7a65 2e73 7a5f 7365 7175  tal_size.sz_sequ
-00030190: 656e 6365 5f64 696d 203c 2030 3a0a 2020  ence_dim < 0:.  
-000301a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000301b0: 7475 726e 2066 223e 7b54 656e 736f 722e  turn f">{Tensor.
-000301c0: 5f5f 7368 6966 745f 7265 7072 5f5f 2873  __shift_repr__(s
-000301d0: 656c 665b 305d 2e5f 5f72 6177 5f72 6570  elf[0].__raw_rep
-000301e0: 725f 5f28 6365 6c6c 5f66 6f72 6d61 743d  r__(cell_format=
-000301f0: 6365 6c6c 5f66 6f72 6d61 7429 297d 3e22  cell_format))}>"
-00030200: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00030210: 6620 6e5f 7369 7a65 203d 3d20 313a 2072  f n_size == 1: r
-00030220: 6574 7572 6e20 273e 2027 202b 2054 656e  eturn '> ' + Ten
-00030230: 736f 722e 5f5f 7368 6966 745f 7265 7072  sor.__shift_repr
-00030240: 5f5f 2873 656c 665b 305d 2e5f 5f72 6177  __(self[0].__raw
-00030250: 5f72 6570 725f 5f28 6365 6c6c 5f66 6f72  _repr__(cell_for
-00030260: 6d61 743d 6365 6c6c 5f66 6f72 6d61 7429  mat=cell_format)
-00030270: 2c20 3329 202b 2027 203e 270a 2020 2020  , 3) + ' >'.    
-00030280: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00030290: 2020 2020 2020 2020 2020 2020 2020 6974                it
-000302a0: 656d 3120 3d20 5465 6e73 6f72 2e5f 5f73  em1 = Tensor.__s
-000302b0: 6869 6674 5f72 6570 725f 5f28 7365 6c66  hift_repr__(self
-000302c0: 5b30 5d2e 5f5f 7261 775f 7265 7072 5f5f  [0].__raw_repr__
-000302d0: 2863 656c 6c5f 666f 726d 6174 3d63 656c  (cell_format=cel
-000302e0: 6c5f 666f 726d 6174 2929 0a20 2020 2020  l_format)).     
-000302f0: 2020 2020 2020 2020 2020 2069 7465 6d6e             itemn
-00030300: 203d 2054 656e 736f 722e 5f5f 7368 6966   = Tensor.__shif
-00030310: 745f 7265 7072 5f5f 2873 656c 665b 2d31  t_repr__(self[-1
-00030320: 5d2e 5f5f 7261 775f 7265 7072 5f5f 2863  ].__raw_repr__(c
-00030330: 656c 6c5f 666f 726d 6174 3d63 656c 6c5f  ell_format=cell_
-00030340: 666f 726d 6174 2929 0a20 2020 2020 2020  format)).       
-00030350: 2020 2020 2020 2020 2069 6620 6e5f 7369           if n_si
-00030360: 7a65 203d 3d20 323a 2072 6574 7572 6e20  ze == 2: return 
-00030370: 2227 2727 3e22 202b 2069 7465 6d31 202b  "'''>" + item1 +
-00030380: 2027 5c6e 2027 202b 2069 7465 6d6e 202b   '\n ' + itemn +
-00030390: 2022 3e27 2727 220a 2020 2020 2020 2020   ">'''".        
-000303a0: 2020 2020 2020 2020 656c 7365 3a20 7265          else: re
-000303b0: 7475 726e 2022 2727 2722 202b 2069 7465  turn "'''" + ite
-000303c0: 6d31 202b 2027 5c6e 2027 202b 2027 2027  m1 + '\n ' + ' '
-000303d0: 202a 2072 652e 7365 6172 6368 2872 275c   * re.search(r'\
-000303e0: 6427 2c20 6974 656d 3129 2e73 7061 6e28  d', item1).span(
-000303f0: 295b 305d 202b 2027 762e 2e2e 765c 6e20  )[0] + 'v...v\n 
-00030400: 2720 2b20 6974 656d 6e20 2b20 2227 2727  ' + itemn + "'''
-00030410: 220a 2020 2020 2020 2020 656c 7365 3a0a  ".        else:.
-00030420: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-00030430: 6f74 616c 5f73 697a 652e 6e5f 6469 6d20  otal_size.n_dim 
-00030440: 2d20 6c65 6e28 7365 6c66 2e73 6861 7065  - len(self.shape
-00030450: 2920 3d3d 2074 6f74 616c 5f73 697a 652e  ) == total_size.
-00030460: 7370 6163 655f 7374 6f70 2d31 3a0a 2020  space_stop-1:.  
-00030470: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00030480: 6c75 6d6e 7320 3d20 5b5d 0a20 2020 2020  lumns = [].     
-00030490: 2020 2020 2020 2020 2020 206e 5f72 6f77             n_row
-000304a0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-000304b0: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
-000304c0: 2064 6973 706c 6179 5f73 616d 706c 6573   display_samples
-000304d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000304e0: 2020 2020 2020 6966 2069 203d 3d20 2e2e        if i == ..
-000304f0: 2e3a 2063 6f6c 756d 6e73 2e61 7070 656e  .: columns.appen
-00030500: 6428 275c 6e27 2e6a 6f69 6e28 5b27 2027  d('\n'.join([' '
-00030510: 202a 2063 656c 6c5f 666f 726d 6174 5b31   * cell_format[1
-00030520: 5d5d 202a 2028 6e5f 726f 7720 2d20 3129  ]] * (n_row - 1)
-00030530: 202b 205b 656c 7073 5d29 293b 2063 6f6e   + [elps])); con
-00030540: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
-00030550: 2020 2020 2020 2020 2020 636f 6c75 6d6e            column
-00030560: 732e 6170 7065 6e64 2854 656e 736f 722e  s.append(Tensor.
-00030570: 5f5f 626c 6f63 6b5f 7265 7072 5f5f 2873  __block_repr__(s
-00030580: 656c 665b 695d 2e5f 5f72 6177 5f72 6570  elf[i].__raw_rep
-00030590: 725f 5f28 6365 6c6c 5f66 6f72 6d61 743d  r__(cell_format=
-000305a0: 6365 6c6c 5f66 6f72 6d61 7429 2929 0a20  cell_format))). 
-000305b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000305c0: 2020 2069 6620 6e5f 726f 7720 6973 204e     if n_row is N
-000305d0: 6f6e 653a 206e 5f72 6f77 203d 206c 656e  one: n_row = len
-000305e0: 2863 6f6c 756d 6e73 5b30 5d2e 7370 6c69  (columns[0].spli
-000305f0: 7428 275c 6e27 2929 0a20 2020 2020 2020  t('\n')).       
-00030600: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00030610: 275b 2720 2b20 5465 6e73 6f72 2e5f 5f73  '[' + Tensor.__s
-00030620: 6869 6674 5f72 6570 725f 5f28 275c 6e27  hift_repr__('\n'
-00030630: 2e6a 6f69 6e28 2827 2c20 2720 6966 2069  .join((', ' if i
-00030640: 203d 3d20 6e5f 726f 7720 2d20 3120 656c   == n_row - 1 el
-00030650: 7365 2027 2020 2729 2e6a 6f69 6e28 726f  se '  ').join(ro
-00030660: 7773 2920 666f 7220 692c 2072 6f77 7320  ws) for i, rows 
-00030670: 696e 2065 6e75 6d65 7261 7465 287a 6970  in enumerate(zip
-00030680: 282a 5b63 2e73 706c 6974 2827 5c6e 2729  (*[c.split('\n')
-00030690: 2066 6f72 2063 2069 6e20 636f 6c75 6d6e   for c in column
-000306a0: 735d 2929 2929 202b 2027 5d27 0a20 2020  s])))) + ']'.   
-000306b0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000306c0: 275b 2720 2b20 272c 5c6e 2027 2e6a 6f69  '[' + ',\n '.joi
-000306d0: 6e28 5465 6e73 6f72 2e5f 5f73 6869 6674  n(Tensor.__shift
-000306e0: 5f72 6570 725f 5f28 656c 7073 2069 6620  _repr__(elps if 
-000306f0: 6920 3d3d 202e 2e2e 2065 6c73 6520 7365  i == ... else se
-00030700: 6c66 5b69 5d2e 5f5f 7261 775f 7265 7072  lf[i].__raw_repr
-00030710: 5f5f 2863 656c 6c5f 666f 726d 6174 3d63  __(cell_format=c
-00030720: 656c 6c5f 666f 726d 6174 2929 2066 6f72  ell_format)) for
-00030730: 2069 2069 6e20 6469 7370 6c61 795f 7361   i in display_sa
-00030740: 6d70 6c65 7329 202b 2027 5d27 0a20 2020  mples) + ']'.   
-00030750: 200a 2020 2020 4070 726f 7065 7274 790a   .    @property.
-00030760: 2020 2020 6465 6620 6d65 616e 5f73 7464      def mean_std
-00030770: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00030780: 7265 7475 726e 2066 227b 7365 6c66 2e6d  return f"{self.m
-00030790: 6561 6e28 292e 6465 7461 6368 2829 2e63  ean().detach().c
-000307a0: 7075 2829 2e69 7465 6d28 293a 2e36 667d  pu().item():.6f}
-000307b0: 20c2 b120 7b73 656c 662e 7374 6428 292e   .. {self.std().
-000307c0: 6465 7461 6368 2829 2e63 7075 2829 2e69  detach().cpu().i
-000307d0: 7465 6d28 293a 2e36 667d 220a 2020 2020  tem():.6f}".    
-000307e0: 0a20 2020 2064 6566 205f 5f73 7472 5f5f  .    def __str__
-000307f0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00030800: 6966 206e 6f74 2068 6173 6174 7472 2873  if not hasattr(s
-00030810: 656c 662c 2027 737a 5f66 756e 635f 6469  elf, 'sz_func_di
-00030820: 6d27 293a 0a20 2020 2020 2020 2020 2020  m'):.           
-00030830: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
-00030840: 726f 7228 6622 4e6f 7420 696e 6974 6961  ror(f"Not initia
-00030850: 6c69 7a65 6420 6261 746f 7263 682e 5465  lized batorch.Te
-00030860: 6e73 6f72 206f 6620 7368 6170 653a 207b  nsor of shape: {
-00030870: 7365 6c66 2e61 735f 7375 6263 6c61 7373  self.as_subclass
-00030880: 2874 6f72 6368 2e54 656e 736f 7229 2e73  (torch.Tensor).s
-00030890: 6861 7065 7d22 290a 2020 2020 2020 2020  hape}").        
-000308a0: 6966 2073 656c 662e 6e5f 6469 6d20 3d3d  if self.n_dim ==
-000308b0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-000308c0: 7661 6c20 3d20 7365 6c66 2e69 7465 6d28  val = self.item(
-000308d0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-000308e0: 206e 6f74 2073 656c 662e 6474 7970 652e   not self.dtype.
-000308f0: 6973 5f66 6c6f 6174 696e 675f 706f 696e  is_floating_poin
-00030900: 743a 2072 6574 7572 6e20 7374 7228 7661  t: return str(va
-00030910: 6c29 0a20 2020 2020 2020 2020 2020 2065  l).            e
-00030920: 6c69 6620 6162 735f 2876 616c 202d 2073  lif abs_(val - s
-00030930: 656c 662e 666c 6f6f 7228 292e 6974 656d  elf.floor().item
-00030940: 2829 2920 3c20 3165 2d34 3a20 7265 7475  ()) < 1e-4: retu
-00030950: 726e 2066 227b 696e 745f 2876 616c 297d  rn f"{int_(val)}
-00030960: 2e22 0a20 2020 2020 2020 2020 2020 2065  .".            e
-00030970: 6c69 6620 7265 7072 2876 616c 2920 3d3d  lif repr(val) ==
-00030980: 2027 6e61 6e27 3a20 7265 7475 726e 2022   'nan': return "
-00030990: 4e61 4e22 0a20 2020 2020 2020 2020 2020  NaN".           
-000309a0: 2065 6c69 6620 7265 7072 2876 616c 2920   elif repr(val) 
-000309b0: 3d3d 2027 696e 6627 3a20 7265 7475 726e  == 'inf': return
-000309c0: 2022 496e 6622 0a20 2020 2020 2020 2020   "Inf".         
-000309d0: 2020 2072 6574 7572 6e20 2225 362e 3466     return "%6.4f
-000309e0: 2225 7365 6c66 2e69 7465 6d28 290a 2020  "%self.item().  
-000309f0: 2020 2020 2020 7072 6566 6978 203d 2022        prefix = "
-00030a00: 5465 6e73 6f72 2822 0a20 2020 2020 2020  Tensor(".       
-00030a10: 2070 6172 7473 203d 205b 5465 6e73 6f72   parts = [Tensor
-00030a20: 2e5f 5f73 6869 6674 5f72 6570 725f 5f28  .__shift_repr__(
-00030a30: 7365 6c66 2e5f 5f72 6177 5f72 6570 725f  self.__raw_repr_
-00030a40: 5f28 292c 206c 656e 2870 7265 6669 7829  _(), len(prefix)
-00030a50: 295d 0a20 2020 2020 2020 2072 6177 5f73  )].        raw_s
-00030a60: 6861 7065 5f73 7472 203d 2073 7472 2873  hape_str = str(s
-00030a70: 656c 662e 7368 6170 6529 2e73 706c 6974  elf.shape).split
-00030a80: 2827 5369 7a65 2729 5b2d 315d 0a20 2020  ('Size')[-1].   
-00030a90: 2020 2020 2070 6172 7473 2e61 7070 656e       parts.appen
-00030aa0: 6428 6622 7368 6170 653d 7b72 6177 5f73  d(f"shape={raw_s
-00030ab0: 6861 7065 5f73 7472 7d22 290a 2020 2020  hape_str}").    
-00030ac0: 2020 2020 6966 2073 656c 662e 6465 7669      if self.devi
-00030ad0: 6365 2e74 7970 6520 213d 2027 6370 7527  ce.type != 'cpu'
-00030ae0: 3a20 2020 200a 2020 2020 2020 2020 2020  :    .          
-00030af0: 2020 6465 7669 6365 5f73 7472 203d 2027    device_str = '
-00030b00: 6370 7527 2069 6620 7365 6c66 2e64 6576  cpu' if self.dev
-00030b10: 6963 652e 7479 7065 203d 3d20 2763 7075  ice.type == 'cpu
-00030b20: 2720 656c 7365 2066 227b 7365 6c66 2e64  ' else f"{self.d
-00030b30: 6576 6963 652e 7479 7065 7d3a 7b73 656c  evice.type}:{sel
-00030b40: 662e 6465 7669 6365 2e69 6e64 6578 7d22  f.device.index}"
-00030b50: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
-00030b60: 7473 2e61 7070 656e 6428 6622 6465 7669  ts.append(f"devi
-00030b70: 6365 3d5b 7b64 6576 6963 655f 7374 727d  ce=[{device_str}
-00030b80: 5d22 290a 2020 2020 2020 2020 6966 2073  ]").        if s
-00030b90: 656c 662e 6772 6164 5f66 6e3a 2070 6172  elf.grad_fn: par
-00030ba0: 7473 2e61 7070 656e 6428 6622 6772 6164  ts.append(f"grad
-00030bb0: 5f66 6e3d 7b73 656c 662e 6772 6164 5f66  _fn={self.grad_f
-00030bc0: 6e7d 2229 0a20 2020 2020 2020 2069 6620  n}").        if 
-00030bd0: 7365 6c66 2e72 6571 7569 7265 735f 6772  self.requires_gr
-00030be0: 6164 3a20 7061 7274 732e 6170 7065 6e64  ad: parts.append
-00030bf0: 2866 2272 6571 7569 7265 735f 6772 6164  (f"requires_grad
-00030c00: 3d7b 7365 6c66 2e72 6571 7569 7265 735f  ={self.requires_
-00030c10: 6772 6164 7d22 290a 2020 2020 2020 2020  grad}").        
-00030c20: 7265 7475 726e 2070 7265 6669 7820 2b20  return prefix + 
-00030c30: 272c 2027 2e6a 6f69 6e28 7061 7274 7329  ', '.join(parts)
-00030c40: 202b 2027 2927 0a0a 2020 2020 6465 6620   + ')'..    def 
-00030c50: 5f5f 7265 7072 5f5f 2873 656c 6629 3a0a  __repr__(self):.
-00030c60: 2020 2020 2020 2020 6966 206e 6f74 2068          if not h
-00030c70: 6173 6174 7472 2873 656c 662c 2027 737a  asattr(self, 'sz
-00030c80: 5f66 756e 635f 6469 6d27 293a 0a20 2020  _func_dim'):.   
-00030c90: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
-00030ca0: 756e 7469 6d65 4572 726f 7228 6622 3c4e  untimeError(f"<N
-00030cb0: 6f74 2069 6e69 7469 616c 697a 6564 2062  ot initialized b
-00030cc0: 6174 6f72 6368 2e54 656e 736f 7220 6f66  atorch.Tensor of
-00030cd0: 2073 6861 7065 3a20 7b73 656c 662e 6173   shape: {self.as
-00030ce0: 5f73 7562 636c 6173 7328 746f 7263 682e  _subclass(torch.
-00030cf0: 5465 6e73 6f72 292e 7368 6170 657d 3e22  Tensor).shape}>"
-00030d00: 290a 2020 2020 2020 2020 6e75 6d5f 6e61  ).        num_na
-00030d10: 6e73 203d 2069 736e 616e 2873 656c 6629  ns = isnan(self)
-00030d20: 2e73 756d 2829 0a20 2020 2020 2020 206e  .sum().        n
-00030d30: 756d 5f69 6e66 7320 3d20 6973 696e 6628  um_infs = isinf(
-00030d40: 7365 6c66 292e 7375 6d28 290a 2020 2020  self).sum().    
-00030d50: 2020 2020 7370 6563 6961 6c5f 6469 6d5f      special_dim_
-00030d60: 7374 7220 3d20 6622 5b7b 7365 6c66 2e6e  str = f"[{self.n
-00030d70: 5f73 7065 6369 616c 5f64 696d 7d5d 2b22  _special_dim}]+"
-00030d80: 2069 6620 7365 6c66 2e6e 5f73 7065 6369   if self.n_speci
-00030d90: 616c 5f64 696d 203e 2030 2065 6c73 6520  al_dim > 0 else 
-00030da0: 2727 0a20 2020 2020 2020 2064 6576 6963  ''.        devic
-00030db0: 655f 7374 7220 3d20 2763 7075 2720 6966  e_str = 'cpu' if
-00030dc0: 2073 656c 662e 6465 7669 6365 2e74 7970   self.device.typ
-00030dd0: 6520 3d3d 2027 6370 7527 2065 6c73 6520  e == 'cpu' else 
-00030de0: 6622 7b73 656c 662e 6465 7669 6365 2e74  f"{self.device.t
-00030df0: 7970 657d 3a7b 7365 6c66 2e64 6576 6963  ype}:{self.devic
-00030e00: 652e 696e 6465 787d 220a 2020 2020 2020  e.index}".      
-00030e10: 2020 7261 775f 7368 6170 655f 7374 7220    raw_shape_str 
-00030e20: 3d20 7374 7228 7365 6c66 2e73 6861 7065  = str(self.shape
-00030e30: 292e 7370 6c69 7428 2753 697a 6527 295b  ).split('Size')[
-00030e40: 2d31 5d0a 2020 2020 2020 2020 7661 6c69  -1].        vali
-00030e50: 645f 6e75 6d73 203d 2073 656c 662e 666c  d_nums = self.fl
-00030e60: 6174 7465 6e28 290a 2020 2020 2020 2020  atten().        
-00030e70: 7661 6c69 645f 6e75 6d73 203d 2076 616c  valid_nums = val
-00030e80: 6964 5f6e 756d 735b 7e69 736e 616e 2876  id_nums[~isnan(v
-00030e90: 616c 6964 5f6e 756d 7329 5d0a 2020 2020  alid_nums)].    
-00030ea0: 2020 2020 7661 6c69 645f 6e75 6d73 203d      valid_nums =
-00030eb0: 2076 616c 6964 5f6e 756d 735b 7e69 7369   valid_nums[~isi
-00030ec0: 6e66 2876 616c 6964 5f6e 756d 7329 5d0a  nf(valid_nums)].
-00030ed0: 2020 2020 2020 2020 6966 2076 616c 6964          if valid
-00030ee0: 5f6e 756d 732e 6e5f 656c 6520 3d3d 2030  _nums.n_ele == 0
-00030ef0: 3a0a 2020 2020 2020 2020 2020 2020 7661  :.            va
-00030f00: 6c69 645f 7661 6c5f 7374 7220 3d20 276e  lid_val_str = 'n
-00030f10: 6f74 6869 6e67 270a 2020 2020 2020 2020  othing'.        
-00030f20: 656c 6966 2073 656c 662e 6973 5f63 6f6d  elif self.is_com
-00030f30: 706c 6578 2829 3a0a 2020 2020 2020 2020  plex():.        
-00030f40: 2020 2020 7661 6c69 645f 7661 6c5f 7374      valid_val_st
-00030f50: 7220 3d20 6622 5265 286d 696e 3a7b 7661  r = f"Re(min:{va
-00030f60: 6c69 645f 6e75 6d73 2e72 6561 6c2e 6d69  lid_nums.real.mi
-00030f70: 6e28 297d 2c20 6d65 643a 7b76 616c 6964  n()}, med:{valid
-00030f80: 5f6e 756d 732e 7265 616c 2e6d 6564 6961  _nums.real.media
-00030f90: 6e28 297d 2c20 6d61 783a 7b76 616c 6964  n()}, max:{valid
-00030fa0: 5f6e 756d 732e 7265 616c 2e6d 6178 2829  _nums.real.max()
-00030fb0: 7d29 2c20 220a 2020 2020 2020 2020 2020  }), ".          
-00030fc0: 2020 7661 6c69 645f 7661 6c5f 7374 7220    valid_val_str 
-00030fd0: 2b3d 2066 2249 6d28 6d69 6e3a 7b76 616c  += f"Im(min:{val
-00030fe0: 6964 5f6e 756d 732e 696d 6167 2e6d 696e  id_nums.imag.min
-00030ff0: 2829 7d2c 206d 6564 3a7b 7661 6c69 645f  ()}, med:{valid_
-00031000: 6e75 6d73 2e69 6d61 672e 6d65 6469 616e  nums.imag.median
-00031010: 2829 7d2c 206d 6178 3a7b 7661 6c69 645f  ()}, max:{valid_
-00031020: 6e75 6d73 2e69 6d61 672e 6d61 7828 297d  nums.imag.max()}
-00031030: 2922 0a20 2020 2020 2020 2065 6c73 653a  )".        else:
-00031040: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
-00031050: 6964 5f76 616c 5f73 7472 203d 2066 226d  id_val_str = f"m
-00031060: 696e 3a7b 7661 6c69 645f 6e75 6d73 2e6d  in:{valid_nums.m
-00031070: 696e 2829 7d2c 206d 6564 3a7b 7661 6c69  in()}, med:{vali
-00031080: 645f 6e75 6d73 2e6d 6564 6961 6e28 297d  d_nums.median()}
-00031090: 2c20 6d61 783a 7b76 616c 6964 5f6e 756d  , max:{valid_num
-000310a0: 732e 6d61 7828 297d 220a 2020 2020 2020  s.max()}".      
-000310b0: 2020 6e61 6e5f 7374 7220 3d20 2727 3b20    nan_str = ''; 
-000310c0: 696e 665f 7374 7220 3d20 2727 0a20 2020  inf_str = ''.   
-000310d0: 2020 2020 2069 6620 6e75 6d5f 6e61 6e73       if num_nans
-000310e0: 203e 2030 3a20 6e61 6e5f 7374 7220 3d20   > 0: nan_str = 
-000310f0: 6622 7b6e 756d 5f6e 616e 737d 204e 614e  f"{num_nans} NaN
-00031100: 220a 2020 2020 2020 2020 6966 206e 756d  ".        if num
-00031110: 5f6e 616e 7320 3e20 313a 206e 616e 5f73  _nans > 1: nan_s
-00031120: 7472 202b 3d20 2773 270a 2020 2020 2020  tr += 's'.      
-00031130: 2020 6966 206e 756d 5f69 6e66 7320 3e20    if num_infs > 
-00031140: 303a 2069 6e66 5f73 7472 203d 2066 227b  0: inf_str = f"{
-00031150: 6e75 6d5f 696e 6673 7d20 496e 6622 0a20  num_infs} Inf". 
-00031160: 2020 2020 2020 2069 6620 6e75 6d5f 696e         if num_in
-00031170: 6673 203e 2031 3a20 696e 665f 7374 7220  fs > 1: inf_str 
-00031180: 2b3d 2027 7327 0a20 2020 2020 2020 2065  += 's'.        e
-00031190: 7272 6f72 5f76 616c 5f73 7472 203d 2027  rror_val_str = '
-000311a0: 2c20 272e 6a6f 696e 285b 7820 666f 7220  , '.join([x for 
-000311b0: 7820 696e 2028 6e61 6e5f 7374 722c 2069  x in (nan_str, i
-000311c0: 6e66 5f73 7472 2920 6966 2078 5d29 0a20  nf_str) if x]). 
-000311d0: 2020 2020 2020 2069 6620 6e75 6d5f 6e61         if num_na
-000311e0: 6e73 202b 206e 756d 5f69 6e66 7320 3d3d  ns + num_infs ==
-000311f0: 2030 3a20 7661 6c5f 7261 6e67 655f 7374   0: val_range_st
-00031200: 7220 3d20 7661 6c69 645f 7661 6c5f 7374  r = valid_val_st
-00031210: 720a 2020 2020 2020 2020 656c 6966 2028  r.        elif (
-00031220: 6e75 6d5f 6e61 6e73 202b 206e 756d 5f69  num_nans + num_i
-00031230: 6e66 7329 202f 2073 656c 662e 6e5f 656c  nfs) / self.n_el
-00031240: 6520 3c20 302e 353a 2076 616c 5f72 616e  e < 0.5: val_ran
-00031250: 6765 5f73 7472 203d 2066 227b 7661 6c69  ge_str = f"{vali
-00031260: 645f 7661 6c5f 7374 727d 2c20 7b65 7272  d_val_str}, {err
-00031270: 6f72 5f76 616c 5f73 7472 7d22 0a20 2020  or_val_str}".   
-00031280: 2020 2020 2065 6c73 653a 2076 616c 5f72       else: val_r
-00031290: 616e 6765 5f73 7472 203d 2065 7272 6f72  ange_str = error
-000312a0: 5f76 616c 5f73 7472 0a20 2020 2020 2020  _val_str.       
-000312b0: 2072 6574 7572 6e20 6622 3c7b 7370 6563   return f"<{spec
-000312c0: 6961 6c5f 6469 6d5f 7374 727d 7b73 656c  ial_dim_str}{sel
-000312d0: 662e 6e5f 7370 6163 655f 6469 6d7d 4420  f.n_space_dim}D 
-000312e0: 7b73 7472 2873 656c 662e 6474 7970 6529  {str(self.dtype)
-000312f0: 2e73 706c 6974 2827 2e27 295b 2d31 5d7d  .split('.')[-1]}
-00031300: 2054 656e 736f 7220 6f6e 207b 6465 7669   Tensor on {devi
-00031310: 6365 5f73 7472 7d3a 2073 6861 7065 3d7b  ce_str}: shape={
-00031320: 7261 775f 7368 6170 655f 7374 727d 2c20  raw_shape_str}, 
-00031330: 7265 7175 6972 6573 5f67 7261 643d 7b73  requires_grad={s
-00031340: 656c 662e 7265 7175 6972 6573 5f67 7261  elf.requires_gra
-00031350: 647d 2c20 7661 6c3d 5b7b 7661 6c5f 7261  d}, val=[{val_ra
-00031360: 6e67 655f 7374 727d 5d3e 220a 2020 2020  nge_str}]>".    
-00031370: 0a20 2020 2023 2320 4f74 6865 7220 7574  .    ## Other ut
-00031380: 696c 6974 6965 730a 2020 2020 6465 6620  ilities.    def 
-00031390: 6279 7465 5f73 697a 6528 7365 6c66 293a  byte_size(self):
-000313a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000313b0: 4279 7465 5369 7a65 2873 656c 662e 656c  ByteSize(self.el
-000313c0: 656d 656e 745f 7369 7a65 2829 202a 2073  ement_size() * s
-000313d0: 656c 662e 6e75 6d65 6c28 2929 0a0a 2020  elf.numel())..  
-000313e0: 2020 6465 6620 7265 6e61 6d65 2873 656c    def rename(sel
-000313f0: 662c 202a 6172 6773 2c20 2a2a 6b77 6172  f, *args, **kwar
-00031400: 6773 293a 0a20 2020 2020 2020 2077 6974  gs):.        wit
-00031410: 6820 746f 7263 682e 5f43 2e44 6973 6162  h torch._C.Disab
-00031420: 6c65 546f 7263 6846 756e 6374 696f 6e28  leTorchFunction(
-00031430: 293a 0a20 2020 2020 2020 2020 2020 206f  ):.            o
-00031440: 7574 7075 7420 3d20 746f 7263 685f 7375  utput = torch_su
-00031450: 7065 7228 7365 6c66 2c20 2772 656e 616d  per(self, 'renam
-00031460: 6527 2928 2a61 7267 732c 202a 2a6b 7761  e')(*args, **kwa
-00031470: 7267 7329 2e61 735f 7375 6263 6c61 7373  rgs).as_subclass
-00031480: 2854 656e 736f 7229 2e73 7065 6369 616c  (Tensor).special
-00031490: 5f66 726f 6d28 7365 6c66 290a 2020 2020  _from(self).    
-000314a0: 2020 2020 666f 7220 692c 206e 2069 6e20      for i, n in 
-000314b0: 656e 756d 6572 6174 6528 6f75 7470 7574  enumerate(output
-000314c0: 2e6e 616d 6573 293a 0a20 2020 2020 2020  .names):.       
-000314d0: 2020 2020 2069 6620 6e20 6973 204e 6f6e       if n is Non
-000314e0: 653a 2063 6f6e 7469 6e75 650a 2020 2020  e: continue.    
-000314f0: 2020 2020 2020 2020 6966 2027 6675 6e63          if 'func
-00031500: 2720 696e 206e 2e6c 6f77 6572 2829 3a20  ' in n.lower(): 
-00031510: 6f75 7470 7574 2e61 6464 5f73 7065 6369  output.add_speci
-00031520: 616c 5f64 696d 2869 2c20 6675 6e63 5f64  al_dim(i, func_d
-00031530: 696d 290a 2020 2020 2020 2020 2020 2020  im).            
-00031540: 6966 2027 6261 7463 6827 2069 6e20 6e2e  if 'batch' in n.
-00031550: 6c6f 7765 7228 293a 206f 7574 7075 742e  lower(): output.
-00031560: 6164 645f 7370 6563 6961 6c5f 6469 6d28  add_special_dim(
-00031570: 692c 207b 7d29 0a20 2020 2020 2020 2020  i, {}).         
-00031580: 2020 2065 6c69 6620 2763 6861 6e6e 656c     elif 'channel
-00031590: 2720 696e 206e 2e6c 6f77 6572 2829 206f  ' in n.lower() o
-000315a0: 7220 2766 6561 7475 7265 2720 696e 206e  r 'feature' in n
-000315b0: 2e6c 6f77 6572 2829 3a20 6f75 7470 7574  .lower(): output
-000315c0: 2e61 6464 5f73 7065 6369 616c 5f64 696d  .add_special_dim
-000315d0: 2869 2c20 5b5d 290a 2020 2020 2020 2020  (i, []).        
-000315e0: 2020 2020 656c 6966 2027 7469 6d65 2720      elif 'time' 
-000315f0: 696e 206e 2e6c 6f77 6572 2829 206f 7220  in n.lower() or 
-00031600: 2773 6572 6965 7327 2069 6e20 6e2e 6c6f  'series' in n.lo
-00031610: 7765 7228 2920 6f72 2027 7365 7175 656e  wer() or 'sequen
-00031620: 6365 2720 696e 206e 2e6c 6f77 6572 2829  ce' in n.lower()
-00031630: 3a20 6f75 7470 7574 2e61 6464 5f73 7065  : output.add_spe
-00031640: 6369 616c 5f64 696d 2869 2c20 2727 290a  cial_dim(i, '').
-00031650: 2020 2020 2020 2020 7265 7475 726e 206f          return o
-00031660: 7574 7075 742e 6772 6164 5f66 6e5f 6e61  utput.grad_fn_na
-00031670: 6d65 5f28 2772 656e 616d 6527 290a 0a20  me_('rename').. 
-00031680: 2020 2064 6566 2072 6566 696e 655f 6e61     def refine_na
-00031690: 6d65 7328 7365 6c66 2c20 2a61 7267 7329  mes(self, *args)
-000316a0: 3a0a 2020 2020 2020 2020 7769 7468 2074  :.        with t
-000316b0: 6f72 6368 2e5f 432e 4469 7361 626c 6554  orch._C.DisableT
-000316c0: 6f72 6368 4675 6e63 7469 6f6e 2829 3a0a  orchFunction():.
-000316d0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
-000316e0: 7574 203d 2074 6f72 6368 5f73 7570 6572  ut = torch_super
-000316f0: 2873 656c 662c 2027 7265 6669 6e65 5f6e  (self, 'refine_n
-00031700: 616d 6573 2729 282a 6172 6773 292e 6173  ames')(*args).as
-00031710: 5f73 7562 636c 6173 7328 5465 6e73 6f72  _subclass(Tensor
-00031720: 292e 7370 6563 6961 6c5f 6672 6f6d 2873  ).special_from(s
-00031730: 656c 6629 0a20 2020 2020 2020 2066 6f72  elf).        for
-00031740: 2069 2c20 6e20 696e 2065 6e75 6d65 7261   i, n in enumera
-00031750: 7465 286f 7574 7075 742e 6e61 6d65 7329  te(output.names)
-00031760: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00031770: 206e 2069 7320 4e6f 6e65 3a20 636f 6e74   n is None: cont
-00031780: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
-00031790: 2069 6620 2766 756e 6327 2069 6e20 6e2e   if 'func' in n.
-000317a0: 6c6f 7765 7228 293a 206f 7574 7075 742e  lower(): output.
-000317b0: 6164 645f 7370 6563 6961 6c5f 6469 6d28  add_special_dim(
-000317c0: 692c 2066 756e 635f 6469 6d29 0a20 2020  i, func_dim).   
-000317d0: 2020 2020 2020 2020 2069 6620 2762 6174           if 'bat
-000317e0: 6368 2720 696e 206e 2e6c 6f77 6572 2829  ch' in n.lower()
-000317f0: 3a20 6f75 7470 7574 2e61 6464 5f73 7065  : output.add_spe
-00031800: 6369 616c 5f64 696d 2869 2c20 7b7d 290a  cial_dim(i, {}).
-00031810: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00031820: 2027 6368 616e 6e65 6c27 2069 6e20 6e2e   'channel' in n.
-00031830: 6c6f 7765 7228 2920 6f72 2027 6665 6174  lower() or 'feat
-00031840: 7572 6527 2069 6e20 6e2e 6c6f 7765 7228  ure' in n.lower(
-00031850: 293a 206f 7574 7075 742e 6164 645f 7370  ): output.add_sp
-00031860: 6563 6961 6c5f 6469 6d28 692c 205b 5d29  ecial_dim(i, [])
-00031870: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00031880: 6620 2774 696d 6527 2069 6e20 6e2e 6c6f  f 'time' in n.lo
-00031890: 7765 7228 2920 6f72 2027 7365 7269 6573  wer() or 'series
-000318a0: 2720 696e 206e 2e6c 6f77 6572 2829 206f  ' in n.lower() o
-000318b0: 7220 2773 6571 7565 6e63 6527 2069 6e20  r 'sequence' in 
-000318c0: 6e2e 6c6f 7765 7228 293a 206f 7574 7075  n.lower(): outpu
-000318d0: 742e 6164 645f 7370 6563 6961 6c5f 6469  t.add_special_di
-000318e0: 6d28 692c 2027 2729 0a20 2020 2020 2020  m(i, '').       
-000318f0: 2072 6574 7572 6e20 6f75 7470 7574 2e75   return output.u
-00031900: 7064 6174 655f 7370 6563 6961 6c5f 6672  pdate_special_fr
-00031910: 6f6d 2873 656c 6629 0a0a 2020 2020 6465  om(self)..    de
-00031920: 6620 6e6f 726d 616c 697a 655f 2873 656c  f normalize_(sel
-00031930: 6629 3a0a 2020 2020 2020 2020 6d2c 204d  f):.        m, M
-00031940: 203d 2073 656c 662e 6d69 6e28 292c 2073   = self.min(), s
-00031950: 656c 662e 6d61 7828 290a 2020 2020 2020  elf.max().      
-00031960: 2020 6966 206d 203d 3d20 4d3a 0a20 2020    if m == M:.   
-00031970: 2020 2020 2020 2020 2069 6620 4d20 3e3d           if M >=
-00031980: 2031 3a20 7265 7475 726e 2073 656c 662e   1: return self.
-00031990: 7a65 726f 5f28 292e 6164 645f 2831 290a  zero_().add_(1).
-000319a0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-000319b0: 203c 3d20 303a 2072 6574 7572 6e20 7365   <= 0: return se
-000319c0: 6c66 2e7a 6572 6f5f 2829 0a20 2020 2020  lf.zero_().     
-000319d0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-000319e0: 6c66 0a20 2020 2020 2020 2073 656c 662e  lf.        self.
-000319f0: 7375 625f 286d 290a 2020 2020 2020 2020  sub_(m).        
-00031a00: 7365 6c66 2e64 6976 5f28 4d2d 6d29 0a20  self.div_(M-m). 
-00031a10: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00031a20: 6c66 2e67 7261 645f 666e 5f6e 616d 655f  lf.grad_fn_name_
-00031a30: 2827 6e6f 726d 616c 697a 655f 2729 0a0a  ('normalize_')..
-00031a40: 2020 2020 6465 6620 6e6f 726d 616c 697a      def normaliz
-00031a50: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-00031a60: 206d 2c20 4d20 3d20 7365 6c66 2e6d 696e   m, M = self.min
-00031a70: 2829 2c20 7365 6c66 2e6d 6178 2829 0a20  (), self.max(). 
-00031a80: 2020 2020 2020 2069 6620 6d20 3d3d 204d         if m == M
-00031a90: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00031aa0: 204d 203e 3d20 313a 2072 6574 7572 6e20   M >= 1: return 
-00031ab0: 6f6e 6573 5f6c 696b 6528 7365 6c66 290a  ones_like(self).
-00031ac0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-00031ad0: 203c 3d20 303a 2072 6574 7572 6e20 7a65   <= 0: return ze
-00031ae0: 726f 735f 6c69 6b65 2873 656c 6629 0a20  ros_like(self). 
-00031af0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00031b00: 6e20 7365 6c66 0a20 2020 2020 2020 2072  n self.        r
-00031b10: 6574 7572 6e20 2828 7365 6c66 202d 206d  eturn ((self - m
-00031b20: 2920 2f20 284d 202d 206d 2929 2e67 7261  ) / (M - m)).gra
-00031b30: 645f 666e 5f6e 616d 655f 2827 6e6f 726d  d_fn_name_('norm
-00031b40: 616c 697a 6527 290a 0a20 2020 2040 616c  alize')..    @al
-00031b50: 6961 7328 2765 7874 656e 6427 290a 2020  ias('extend').  
-00031b60: 2020 6465 6620 6170 7065 6e64 2873 656c    def append(sel
-00031b70: 662c 2076 616c 7565 293a 0a20 2020 2020  f, value):.     
-00031b80: 2020 2061 766f 7563 6828 7365 6c66 2e6e     avouch(self.n
-00031b90: 5f64 696d 203d 3d20 312c 2022 4f6e 6c79  _dim == 1, "Only
-00031ba0: 2031 2d64 696d 656e 7369 6f6e 616c 2074   1-dimensional t
-00031bb0: 656e 736f 7220 6361 6e20 7573 6520 2761  ensor can use 'a
-00031bc0: 7070 656e 6427 2074 6f20 636f 6e63 6174  ppend' to concat
-00031bd0: 2e20 2229 0a20 2020 2020 2020 2074 656e  . ").        ten
-00031be0: 736f 725f 7661 6c75 6520 3d20 7465 6e73  sor_value = tens
-00031bf0: 6f72 2876 616c 7565 2c20 6465 7669 6365  or(value, device
-00031c00: 3d73 656c 662e 6465 7669 6365 2c20 6474  =self.device, dt
-00031c10: 7970 653d 7365 6c66 2e64 7479 7065 2920  ype=self.dtype) 
-00031c20: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-00031c30: 6528 7661 6c75 652c 2074 6f72 6368 2e54  e(value, torch.T
-00031c40: 656e 736f 7229 2065 6c73 6520 2876 616c  ensor) else (val
-00031c50: 7565 2e61 735f 7375 6263 6c61 7373 2854  ue.as_subclass(T
-00031c60: 656e 736f 722c 2064 6576 6963 653d 7365  ensor, device=se
-00031c70: 6c66 2e64 6576 6963 652c 2064 7479 7065  lf.device, dtype
-00031c80: 3d73 656c 662e 6474 7970 6529 2069 6620  =self.dtype) if 
-00031c90: 6e6f 7420 6973 696e 7374 616e 6365 2876  not isinstance(v
-00031ca0: 616c 7565 2c20 5465 6e73 6f72 2920 656c  alue, Tensor) el
-00031cb0: 7365 2076 616c 7565 290a 2020 2020 2020  se value).      
-00031cc0: 2020 6176 6f75 6368 2874 656e 736f 725f    avouch(tensor_
-00031cd0: 7661 6c75 652e 6e5f 6469 6d20 3c3d 2031  value.n_dim <= 1
-00031ce0: 2c20 224f 6e6c 7920 7363 616c 6172 206f  , "Only scalar o
-00031cf0: 7220 312d 6469 6d65 6e73 696f 6e61 6c20  r 1-dimensional 
-00031d00: 7465 6e73 6f72 7320 6361 6e20 6279 2063  tensors can by c
-00031d10: 6f6e 6361 7420 7573 696e 6720 6170 7065  oncat using appe
-00031d20: 6e64 2f65 7874 656e 642e 2022 290a 2020  nd/extend. ").  
-00031d30: 2020 2020 2020 7265 7475 726e 2063 6174        return cat
-00031d40: 2873 656c 662c 2074 656e 736f 725f 7661  (self, tensor_va
-00031d50: 6c75 652c 2064 696d 3d30 292e 6772 6164  lue, dim=0).grad
-00031d60: 5f66 6e5f 6e61 6d65 5f28 2761 7070 656e  _fn_name_('appen
-00031d70: 6427 290a 2020 2020 0a20 2020 2064 6566  d').    .    def
-00031d80: 2073 6574 6974 656d 5f28 7365 6c66 2c20   setitem_(self, 
-00031d90: 696e 642c 2076 616c 293a 0a20 2020 2020  ind, val):.     
-00031da0: 2020 2073 656c 665b 696e 645d 203d 2076     self[ind] = v
-00031db0: 616c 0a20 2020 2020 2020 2072 6574 7572  al.        retur
-00031dc0: 6e20 7365 6c66 2e67 7261 645f 666e 5f6e  n self.grad_fn_n
-00031dd0: 616d 655f 2827 7365 7469 7465 6d5f 2729  ame_('setitem_')
-00031de0: 0a20 2020 200a 2020 2020 6465 6620 6772  .    .    def gr
-00031df0: 6164 5f66 6e5f 6e61 6d65 5f28 7365 6c66  ad_fn_name_(self
-00031e00: 2c20 6e61 6d65 293a 0a20 2020 2020 2020  , name):.       
-00031e10: 2073 656c 662e 6772 6164 5f66 6e5f 6e61   self.grad_fn_na
-00031e20: 6d65 203d 206e 616d 650a 2020 2020 2020  me = name.      
-00031e30: 2020 7265 7475 726e 2073 656c 660a 2020    return self.  
-00031e40: 2020 0a20 2020 2064 6566 2063 6174 2873    .    def cat(s
-00031e50: 656c 662c 202a 6f74 6865 722c 2064 696d  elf, *other, dim
-00031e60: 3d30 293a 0a20 2020 2020 2020 2072 6574  =0):.        ret
-00031e70: 7572 6e20 6361 7428 7365 6c66 2c20 2a6f  urn cat(self, *o
-00031e80: 7468 6572 2c20 6469 6d3d 6469 6d29 2e67  ther, dim=dim).g
-00031e90: 7261 645f 666e 5f6e 616d 655f 2827 6361  rad_fn_name_('ca
-00031ea0: 7427 290a 0a20 2020 2064 6566 2073 7461  t')..    def sta
-00031eb0: 636b 2873 656c 662c 202a 6f74 6865 722c  ck(self, *other,
-00031ec0: 2064 696d 3d30 293a 0a20 2020 2020 2020   dim=0):.       
-00031ed0: 2072 6574 7572 6e20 7374 6163 6b28 7365   return stack(se
-00031ee0: 6c66 2c20 2a6f 7468 6572 2c20 6469 6d3d  lf, *other, dim=
-00031ef0: 6469 6d29 2e67 7261 645f 666e 5f6e 616d  dim).grad_fn_nam
-00031f00: 655f 2827 7374 6163 6b27 290a 2020 2020  e_('stack').    
-00031f10: 0a20 2020 2023 2320 6474 7970 6573 0a20  .    ## dtypes. 
-00031f20: 2020 2040 616c 6961 7328 2261 735f 7479     @alias("as_ty
-00031f30: 7065 2229 0a20 2020 2064 6566 2061 7374  pe").    def ast
-00031f40: 7970 6528 7365 6c66 2c20 6474 293a 0a20  ype(self, dt):. 
-00031f50: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00031f60: 2020 2020 2020 206e 756d 7079 2064 7479         numpy dty
-00031f70: 7065 2076 2e73 2e20 746f 7263 6820 6474  pe v.s. torch dt
-00031f80: 7970 653a 0a20 2020 2020 2020 2020 2020  ype:.           
-00031f90: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
-00031fa0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
-00031fb0: 2020 2020 2020 2020 2020 2020 6e75 6d70              nump
-00031fc0: 7920 7479 7065 202f 2f20 746f 7263 6820  y type // torch 
-00031fd0: 7479 7065 0a20 2020 2020 2020 2020 2020  type.           
-00031fe0: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
-00031ff0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
-00032000: 2020 2020 2020 2020 2020 2020 766f 6964              void
-00032010: 302c 2076 6f69 643a 3a76 6f69 6420 2f2f  0, void::void //
-00032020: 200a 2020 2020 2020 2020 2020 2020 6f62   .            ob
-00032030: 6a65 6374 302c 206f 626a 6563 745f 3a3a  ject0, object_::
-00032040: 6f62 6a65 6374 202f 2f20 0a20 2020 2020  object // .     
-00032050: 2020 2020 2020 2062 6f6f 6c38 2c20 626f         bool8, bo
-00032060: 6f6c 5f3a 3a62 6f6f 6c20 2f2f 2074 6f72  ol_::bool // tor
-00032070: 6368 2e62 6f6f 6c0a 2020 2020 2020 2020  ch.bool.        
-00032080: 2020 2020 6279 7465 2c20 696e 7438 3a3a      byte, int8::
-00032090: 696e 7438 202f 2f20 746f 7263 682e 696e  int8 // torch.in
-000320a0: 7438 0a20 2020 2020 2020 2020 2020 2073  t8.            s
-000320b0: 686f 7274 2c20 696e 7431 363a 3a69 6e74  hort, int16::int
-000320c0: 3136 202f 2f20 746f 7263 682e 7368 6f72  16 // torch.shor
-000320d0: 742c 2074 6f72 6368 2e69 6e74 3136 0a20  t, torch.int16. 
-000320e0: 2020 2020 2020 2020 2020 2069 6e74 3332             int32
-000320f0: 2c20 696e 7463 3a3a 696e 7433 3220 2f2f  , intc::int32 //
-00032100: 2074 6f72 6368 2e69 6e74 2c20 746f 7263   torch.int, torc
-00032110: 682e 696e 7433 320a 2020 2020 2020 2020  h.int32.        
-00032120: 2020 2020 696e 7430 2c20 696e 745f 2c20      int0, int_, 
-00032130: 696e 7436 342c 2069 6e74 702c 206c 6f6e  int64, intp, lon
-00032140: 676c 6f6e 672c 2073 6967 6e65 6469 6e74  glong, signedint
-00032150: 6567 6572 3a3a 696e 7436 3420 2f2f 2074  eger::int64 // t
-00032160: 6f72 6368 2e6c 6f6e 672c 2074 6f72 6368  orch.long, torch
-00032170: 2e69 6e74 3634 0a20 2020 2020 2020 2020  .int64.         
-00032180: 2020 2075 6279 7465 2c20 7569 6e74 383a     ubyte, uint8:
-00032190: 3a75 696e 7438 202f 2f20 746f 7263 682e  :uint8 // torch.
-000321a0: 7569 6e74 380a 2020 2020 2020 2020 2020  uint8.          
-000321b0: 2020 7573 686f 7274 2c20 7569 6e74 3136    ushort, uint16
-000321c0: 3a3a 7569 6e74 3136 202f 2f20 0a20 2020  ::uint16 // .   
-000321d0: 2020 2020 2020 2020 2075 696e 7433 322c           uint32,
-000321e0: 2075 696e 7463 3a3a 7569 6e74 3332 202f   uintc::uint32 /
-000321f0: 2f20 0a20 2020 2020 2020 2020 2020 2075  / .            u
-00032200: 696e 742c 2075 696e 7430 2c20 7569 6e74  int, uint0, uint
-00032210: 3634 2c20 5569 6e74 3634 2c20 7569 6e74  64, Uint64, uint
-00032220: 702c 2075 6c6f 6e67 6c6f 6e67 3a3a 7569  p, ulonglong::ui
-00032230: 6e74 3634 202f 2f20 0a20 2020 2020 2020  nt64 // .       
-00032240: 2020 2020 202f 2f20 746f 7263 682e 6266       // torch.bf
-00032250: 6c6f 6174 3136 2023 2031 3662 6974 2c20  loat16 # 16bit, 
-00032260: e88c 83e5 9bb4 e5a4 a7e5 a682 3332 6269  ............32bi
-00032270: 74e4 bd86 e7b2 bee5 baa6 e4bd 8e0a 2020  t.............  
-00032280: 2020 2020 2020 2020 2020 6861 6c66 2c20            half, 
-00032290: 666c 6f61 7431 363a 3a66 6c6f 6174 3136  float16::float16
-000322a0: 202f 2f20 746f 7263 682e 6861 6c66 2c20   // torch.half, 
-000322b0: 746f 7263 682e 666c 6f61 7431 360a 2020  torch.float16.  
-000322c0: 2020 2020 2020 2020 2020 7369 6e67 6c65            single
-000322d0: 2c20 666c 6f61 7433 323a 3a66 6c6f 6174  , float32::float
-000322e0: 3332 202f 2f20 746f 7263 682e 666c 6f61  32 // torch.floa
-000322f0: 742c 2074 6f72 6368 2e66 6c6f 6174 3332  t, torch.float32
-00032300: 0a20 2020 2020 2020 2020 2020 2064 6f75  .            dou
-00032310: 626c 652c 2066 6c6f 6174 3634 2c20 666c  ble, float64, fl
-00032320: 6f61 745f 2c20 6c6f 6e67 646f 7562 6c65  oat_, longdouble
-00032330: 2c20 6c6f 6e67 666c 6f61 742c 206e 756d  , longfloat, num
-00032340: 6265 723a 3a66 6c6f 6174 3634 202f 2f20  ber::float64 // 
-00032350: 746f 7263 682e 646f 7562 6c65 2c20 746f  torch.double, to
-00032360: 7263 682e 666c 6f61 7436 340a 2020 2020  rch.float64.    
-00032370: 2020 2020 2020 2020 2f2f 2074 6f72 6368          // torch
-00032380: 2e63 6f6d 706c 6578 3332 0a20 2020 2020  .complex32.     
-00032390: 2020 2020 2020 2063 7369 6e67 6c65 2c20         csingle, 
-000323a0: 636f 6d70 6c65 7836 342c 2073 696e 676c  complex64, singl
-000323b0: 6563 6f6d 706c 6578 3a3a 636f 6d70 6c65  ecomplex::comple
-000323c0: 7836 3420 2f2f 2074 6f72 6368 2e63 666c  x64 // torch.cfl
-000323d0: 6f61 742c 2074 6f72 6368 2e63 6f6d 706c  oat, torch.compl
-000323e0: 6578 3634 0a20 2020 2020 2020 2020 2020  ex64.           
-000323f0: 2063 646f 7562 6c65 2c20 6366 6c6f 6174   cdouble, cfloat
-00032400: 2c20 636c 6f6e 6764 6f75 626c 652c 2063  , clongdouble, c
-00032410: 6c6f 6e67 666c 6f61 742c 2063 6f6d 706c  longfloat, compl
-00032420: 6578 5f2c 2063 6f6d 706c 6578 3132 382c  ex_, complex128,
-00032430: 206c 6f6e 6763 6f6d 706c 6578 3a3a 636f   longcomplex::co
-00032440: 6d70 6c65 7831 3238 202f 2f20 746f 7263  mplex128 // torc
-00032450: 682e 6364 6f75 626c 652c 2074 6f72 6368  h.cdouble, torch
-00032460: 2e63 6f6d 706c 6578 3132 380a 2020 2020  .complex128.    
-00032470: 2020 2020 2020 2020 7374 7230 2c20 7374          str0, st
-00032480: 725f 2c20 5374 7230 3a3a 7374 7220 2f2f  r_, Str0::str //
-00032490: 200a 2020 2020 2020 2020 2020 2020 6279   .            by
-000324a0: 7465 7330 2c20 6279 7465 735f 2c20 7374  tes0, bytes_, st
-000324b0: 7269 6e67 5f3a 3a62 7974 6573 202f 2f20  ring_::bytes // 
-000324c0: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-000324d0: 6574 696d 6536 343a 3a64 6174 6574 696d  etime64::datetim
-000324e0: 6536 3420 2f2f 200a 2020 2020 2020 2020  e64 // .        
-000324f0: 2020 2020 7469 6d65 6465 6c74 6136 343a      timedelta64:
-00032500: 3a74 696d 6564 656c 7461 3634 202f 2f20  :timedelta64 // 
-00032510: 0a20 2020 2020 2020 2020 2020 2023 20e9  .            # .
-00032520: 878f e5ad 90e8 aea1 e7ae 97e7 b1bb e59e  ................
-00032530: 8b0a 2020 2020 2020 2020 2020 2020 2f2f  ..            //
-00032540: 2074 6f72 6368 2e71 696e 7438 0a20 2020   torch.qint8.   
-00032550: 2020 2020 2020 2020 202f 2f20 746f 7263           // torc
-00032560: 682e 7169 6e74 3332 0a20 2020 2020 2020  h.qint32.       
-00032570: 2020 2020 202f 2f20 746f 7263 682e 7175       // torch.qu
-00032580: 696e 7438 0a20 2020 2020 2020 2020 2020  int8.           
-00032590: 202f 2f20 746f 7263 682e 7175 696e 7434   // torch.quint4
-000325a0: 7832 0a20 2020 2020 2020 2022 2222 0a20  x2.        """. 
-000325b0: 2020 2020 2020 2074 6f72 6368 5f64 7420         torch_dt 
-000325c0: 3d20 746f 5f74 6f72 6368 5f64 7479 7065  = to_torch_dtype
-000325d0: 2864 7429 0a20 2020 2020 2020 2077 6974  (dt).        wit
-000325e0: 6820 746f 7263 682e 5f43 2e44 6973 6162  h torch._C.Disab
-000325f0: 6c65 546f 7263 6846 756e 6374 696f 6e28  leTorchFunction(
-00032600: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00032610: 6574 7572 6e20 746f 7263 685f 7375 7065  eturn torch_supe
-00032620: 7228 7365 6c66 2c20 2774 7970 6527 2928  r(self, 'type')(
-00032630: 746f 7263 685f 6474 292e 6173 5f73 7562  torch_dt).as_sub
-00032640: 636c 6173 7328 5465 6e73 6f72 292e 7370  class(Tensor).sp
-00032650: 6563 6961 6c5f 6672 6f6d 2873 656c 6629  ecial_from(self)
-00032660: 2e67 7261 645f 666e 5f6e 616d 655f 2827  .grad_fn_name_('
-00032670: 6173 7479 7065 2729 0a20 2020 2020 2020  astype').       
-00032680: 2023 2069 6620 6973 696e 7374 616e 6365   # if isinstance
-00032690: 2864 742c 2073 7472 293a 2072 6574 7572  (dt, str): retur
-000326a0: 6e20 7375 7065 7228 292e 7479 7065 2864  n super().type(d
-000326b0: 742e 7265 706c 6163 6528 2762 742e 272c  t.replace('bt.',
-000326c0: 2027 746f 7263 682e 2729 292e 6173 5f73   'torch.')).as_s
-000326d0: 7562 636c 6173 7328 7365 6c66 2e5f 5f63  ubclass(self.__c
-000326e0: 6c61 7373 5f5f 290a 2020 2020 2020 2020  lass__).        
-000326f0: 2320 6966 2068 6173 6174 7472 2864 742c  # if hasattr(dt,
-00032700: 2027 6474 7970 6527 293a 2064 7420 3d20   'dtype'): dt = 
-00032710: 6474 2e64 7479 7065 0a20 2020 2020 2020  dt.dtype.       
-00032720: 2023 2069 6620 6973 696e 7374 616e 6365   # if isinstance
-00032730: 2864 742c 2074 6f72 6368 2e64 7479 7065  (dt, torch.dtype
-00032740: 293a 2072 6574 7572 6e20 7375 7065 7228  ): return super(
-00032750: 292e 7479 7065 2864 7429 2e61 735f 7375  ).type(dt).as_su
-00032760: 6263 6c61 7373 2873 656c 662e 5f5f 636c  bclass(self.__cl
-00032770: 6173 735f 5f29 0a20 2020 2020 2020 2023  ass__).        #
-00032780: 2069 6d70 6f72 7420 6e75 6d70 7920 6173   import numpy as
-00032790: 206e 700a 2020 2020 2020 2020 2320 6474   np.        # dt
-000327a0: 5f6e 616d 6520 3d20 6e70 2e64 7479 7065  _name = np.dtype
-000327b0: 2864 7429 2e6e 616d 650a 2020 2020 2020  (dt).name.      
-000327c0: 2020 2320 6474 7970 655f 6d61 7020 3d20    # dtype_map = 
-000327d0: 7b27 7569 6e74 3136 273a 2022 696e 7433  {'uint16': "int3
-000327e0: 3222 2c20 2775 696e 7433 3227 3a20 2269  2", 'uint32': "i
-000327f0: 6e74 3634 222c 2027 7569 6e74 3634 273a  nt64", 'uint64':
-00032800: 2022 696e 7436 3422 7d0a 2020 2020 2020   "int64"}.      
-00032810: 2020 2320 746f 7263 685f 6474 203d 2067    # torch_dt = g
-00032820: 6574 6174 7472 2874 6f72 6368 2c20 6474  etattr(torch, dt
-00032830: 7970 655f 6d61 702e 6765 7428 6474 5f6e  ype_map.get(dt_n
-00032840: 616d 652c 2064 745f 6e61 6d65 292c 204e  ame, dt_name), N
-00032850: 6f6e 6529 0a20 2020 2020 2020 2023 2061  one).        # a
-00032860: 766f 7563 6828 746f 7263 685f 6474 2069  vouch(torch_dt i
-00032870: 7320 6e6f 7420 4e6f 6e65 2c20 6622 496e  s not None, f"In
-00032880: 7661 6c69 6420 6474 7970 6520 7b64 747d  valid dtype {dt}
-00032890: 3a20 7b64 745f 6e61 6d65 7d20 6361 6e6e  : {dt_name} cann
-000328a0: 6f74 2062 6520 636f 6e76 6572 7465 6420  ot be converted 
-000328b0: 696e 746f 2074 6f72 6368 2064 7479 7065  into torch dtype
-000328c0: 2e22 290a 2020 2020 2020 2020 2320 7265  .").        # re
-000328d0: 7475 726e 2073 7570 6572 2829 2e74 7970  turn super().typ
-000328e0: 6528 746f 7263 685f 6474 292e 6173 5f73  e(torch_dt).as_s
-000328f0: 7562 636c 6173 7328 7365 6c66 2e5f 5f63  ubclass(self.__c
-00032900: 6c61 7373 5f5f 290a 0a20 2020 2064 6566  lass__)..    def
-00032910: 2074 7970 6528 7365 6c66 2c20 6474 3d4e   type(self, dt=N
-00032920: 6f6e 6529 3a0a 2020 2020 2020 2020 7769  one):.        wi
-00032930: 7468 2074 6f72 6368 2e5f 432e 4469 7361  th torch._C.Disa
-00032940: 626c 6554 6f72 6368 4675 6e63 7469 6f6e  bleTorchFunction
-00032950: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00032960: 6966 2064 7420 6973 204e 6f6e 653a 2072  if dt is None: r
-00032970: 6574 7572 6e20 746f 7263 685f 7375 7065  eturn torch_supe
-00032980: 7228 7365 6c66 2c20 2774 7970 6527 2928  r(self, 'type')(
-00032990: 292e 7265 706c 6163 6528 2274 6f72 6368  ).replace("torch
-000329a0: 2e22 2c20 2262 6174 6f72 6368 2e22 290a  .", "batorch.").
-000329b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000329c0: 3a20 7265 7475 726e 2073 656c 662e 6173  : return self.as
-000329d0: 7479 7065 2864 7429 0a0a 2020 2020 6465  type(dt)..    de
-000329e0: 6620 5f5f 6765 7461 7474 7269 6275 7465  f __getattribute
-000329f0: 5f5f 2873 656c 662c 206b 6579 293a 0a20  __(self, key):. 
-00032a00: 2020 2020 2020 2077 6974 6820 746f 7263         with torc
-00032a10: 682e 5f43 2e44 6973 6162 6c65 546f 7263  h._C.DisableTorc
-00032a20: 6846 756e 6374 696f 6e28 293a 0a20 2020  hFunction():.   
-00032a30: 2020 2020 2020 2020 2067 203d 2073 7570           g = sup
-00032a40: 6572 2854 656e 736f 722c 2073 656c 6629  er(Tensor, self)
-00032a50: 2e5f 5f67 6574 6174 7472 6962 7574 655f  .__getattribute_
-00032a60: 5f28 6b65 7929 0a20 2020 2020 2020 2069  _(key).        i
-00032a70: 6620 6b65 7920 696e 2028 2767 7261 6427  f key in ('grad'
-00032a80: 2c20 2772 6561 6c27 2c20 2769 6d61 6727  , 'real', 'imag'
-00032a90: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-00032aa0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-00032ab0: 2867 2c20 746f 7263 682e 5465 6e73 6f72  (g, torch.Tensor
-00032ac0: 293a 2072 6574 7572 6e20 670a 2020 2020  ): return g.    
-00032ad0: 2020 2020 2020 2020 7265 7475 726e 2067          return g
-00032ae0: 2e61 735f 7375 6263 6c61 7373 2854 656e  .as_subclass(Ten
-00032af0: 736f 7229 2e73 7065 6369 616c 5f66 726f  sor).special_fro
-00032b00: 6d28 7365 6c66 290a 2020 2020 2020 2020  m(self).        
-00032b10: 656c 6966 206b 6579 203d 3d20 2767 7261  elif key == 'gra
-00032b20: 645f 666e 273a 0a20 2020 2020 2020 2020  d_fn':.         
-00032b30: 2020 2069 6620 6720 6973 204e 6f6e 653a     if g is None:
-00032b40: 2072 6574 7572 6e20 670a 2020 2020 2020   return g.      
-00032b50: 2020 2020 2020 636c 6173 7320 6766 6e3a        class gfn:
-00032b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032b70: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-00032b80: 6c66 2c20 666e 2c20 666e 5f6e 616d 6529  lf, fn, fn_name)
-00032b90: 3a20 7365 6c66 2e66 6e20 3d20 666e 3b20  : self.fn = fn; 
-00032ba0: 7365 6c66 2e66 6e5f 6e61 6d65 203d 2066  self.fn_name = f
-00032bb0: 6e5f 6e61 6d65 0a20 2020 2020 2020 2020  n_name.         
-00032bc0: 2020 2020 2020 2064 6566 205f 5f63 616c         def __cal
-00032bd0: 6c5f 5f28 7365 6c66 2c20 2a61 7267 732c  l__(self, *args,
-00032be0: 202a 2a6b 7761 7267 7329 3a20 7265 7475   **kwargs): retu
-00032bf0: 726e 2073 656c 662e 666e 282a 6172 6773  rn self.fn(*args
-00032c00: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
-00032c10: 2020 2020 2020 2020 2020 2020 6465 6620              def 
-00032c20: 5f5f 6765 7461 7474 7269 6275 7465 5f5f  __getattribute__
-00032c30: 2873 656c 662c 206b 6579 293a 0a20 2020  (self, key):.   
-00032c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032c50: 2069 6620 6b65 7920 696e 2028 2766 6e27   if key in ('fn'
-00032c60: 2c20 2766 6e5f 6e61 6d65 272c 2027 5f5f  , 'fn_name', '__
-00032c70: 696e 6974 5f5f 272c 2027 5f5f 6361 6c6c  init__', '__call
-00032c80: 5f5f 272c 2027 5f5f 6765 7461 7474 7269  __', '__getattri
-00032c90: 6275 7465 5f5f 272c 2027 5f5f 7265 7072  bute__', '__repr
-00032ca0: 5f5f 2729 3a0a 2020 2020 2020 2020 2020  __'):.          
-00032cb0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00032cc0: 7475 726e 2073 7570 6572 2829 2e5f 5f67  turn super().__g
-00032cd0: 6574 6174 7472 6962 7574 655f 5f28 6b65  etattribute__(ke
-00032ce0: 7929 0a20 2020 2020 2020 2020 2020 2020  y).             
-00032cf0: 2020 2020 2020 2061 7474 7220 3d20 6765         attr = ge
-00032d00: 7461 7474 7228 7365 6c66 2e66 6e2c 206b  tattr(self.fn, k
-00032d10: 6579 2c20 4e6f 6e65 290a 2020 2020 2020  ey, None).      
-00032d20: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00032d30: 2061 7474 7220 6973 206e 6f74 204e 6f6e   attr is not Non
-00032d40: 653a 2072 6574 7572 6e20 6174 7472 0a20  e: return attr. 
-00032d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032d60: 2020 2072 6574 7572 6e20 7375 7065 7228     return super(
-00032d70: 292e 5f5f 6765 7461 7474 7269 6275 7465  ).__getattribute
-00032d80: 5f5f 286b 6579 290a 2020 2020 2020 2020  __(key).        
-00032d90: 2020 2020 2020 2020 6465 6620 5f5f 7265          def __re
-00032da0: 7072 5f5f 2873 656c 6629 3a20 7265 7475  pr__(self): retu
-00032db0: 726e 2066 223c 6261 636b 7761 7264 3a20  rn f"<backward: 
-00032dc0: 7b73 656c 662e 666e 5f6e 616d 657d 2061  {self.fn_name} a
-00032dd0: 7420 3078 7b69 6428 7365 6c66 2e66 6e29  t 0x{id(self.fn)
-00032de0: 3a30 787d 3e22 0a20 2020 2020 2020 2020  :0x}>".         
-00032df0: 2020 2072 6574 7572 6e20 6766 6e28 672c     return gfn(g,
-00032e00: 2067 6574 6174 7472 2873 656c 662c 2027   getattr(self, '
-00032e10: 6772 6164 5f66 6e5f 6e61 6d65 272c 2027  grad_fn_name', '
-00032e20: 556e 6b6e 6f77 6e27 2929 0a20 2020 2020  Unknown')).     
-00032e30: 2020 2072 6574 7572 6e20 670a 2020 2020     return g.    
-00032e40: 0a20 2020 2064 6566 205f 5f73 6574 6174  .    def __setat
-00032e50: 7472 5f5f 2873 656c 662c 206b 6579 2c20  tr__(self, key, 
-00032e60: 7661 6c75 6529 3a0a 2020 2020 2020 2020  value):.        
-00032e70: 6966 206b 6579 2069 6e20 2827 6772 6164  if key in ('grad
-00032e80: 272c 2027 7265 616c 272c 2027 696d 6167  ', 'real', 'imag
-00032e90: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00032ea0: 6966 2069 7369 6e73 7461 6e63 6528 7661  if isinstance(va
-00032eb0: 6c75 652c 2054 656e 736f 7229 3a0a 2020  lue, Tensor):.  
-00032ec0: 2020 2020 2020 2020 2020 2020 2020 7661                va
-00032ed0: 6c75 6520 3d20 7661 6c75 652e 6173 5f73  lue = value.as_s
-00032ee0: 7562 636c 6173 7328 746f 7263 682e 5465  ubclass(torch.Te
-00032ef0: 6e73 6f72 290a 2020 2020 2020 2020 7375  nsor).        su
-00032f00: 7065 7228 292e 5f5f 7365 7461 7474 725f  per().__setattr_
-00032f10: 5f28 6b65 792c 2076 616c 7565 290a 2020  _(key, value).  
-00032f20: 2020 2020 2020 0a20 2020 2064 6566 2061        .    def a
-00032f30: 735f 6675 6e63 5f74 656e 736f 7228 7365  s_func_tensor(se
-00032f40: 6c66 293a 0a20 2020 2020 2020 2061 766f  lf):.        avo
-00032f50: 7563 6828 7365 6c66 2e6e 5f64 696d 203d  uch(self.n_dim =
-00032f60: 3d20 312c 2054 7970 6545 7272 6f72 2822  = 1, TypeError("
-00032f70: 4f6e 6c79 2031 4420 7465 6e73 6f72 2063  Only 1D tensor c
-00032f80: 616e 2062 6520 636f 6e76 6572 7465 6420  an be converted 
-00032f90: 746f 2066 756e 6374 696f 6e61 6c20 7465  to functional te
-00032fa0: 6e73 6f72 2e20 2229 290a 2020 2020 2020  nsor. ")).      
-00032fb0: 2020 7365 6c66 2e69 6e69 745f 7370 6563    self.init_spec
-00032fc0: 6961 6c28 290a 2020 2020 2020 2020 7365  ial().        se
-00032fd0: 6c66 2e73 7a5f 6675 6e63 5f64 696d 203d  lf.sz_func_dim =
-00032fe0: 2073 656c 662e 6e5f 6469 6d0a 2020 2020   self.n_dim.    
-00032ff0: 2020 2020 7265 7475 726e 2073 656c 660a      return self.
-00033000: 0a20 2020 2064 6566 2061 735f 6261 7463  .    def as_batc
-00033010: 685f 7465 6e73 6f72 2873 656c 6629 3a0a  h_tensor(self):.
-00033020: 2020 2020 2020 2020 6176 6f75 6368 2873          avouch(s
-00033030: 656c 662e 6e5f 6469 6d20 3d3d 2031 2c20  elf.n_dim == 1, 
-00033040: 5479 7065 4572 726f 7228 224f 6e6c 7920  TypeError("Only 
-00033050: 3144 2074 656e 736f 7220 6361 6e20 6265  1D tensor can be
-00033060: 2063 6f6e 7665 7274 6564 2074 6f20 6261   converted to ba
-00033070: 7463 6820 7465 6e73 6f72 2e20 2229 290a  tch tensor. ")).
-00033080: 2020 2020 2020 2020 7365 6c66 2e69 6e69          self.ini
-00033090: 745f 7370 6563 6961 6c28 290a 2020 2020  t_special().    
-000330a0: 2020 2020 7365 6c66 2e73 7a5f 6261 7463      self.sz_batc
-000330b0: 685f 6469 6d20 3d20 7365 6c66 2e6e 5f64  h_dim = self.n_d
-000330c0: 696d 0a20 2020 2020 2020 2072 6574 7572  im.        retur
-000330d0: 6e20 7365 6c66 0a0a 2020 2020 6465 6620  n self..    def 
-000330e0: 6173 5f66 6561 7475 7265 5f74 656e 736f  as_feature_tenso
-000330f0: 7228 7365 6c66 293a 0a20 2020 2020 2020  r(self):.       
-00033100: 2073 656c 662e 696e 6974 5f73 7065 6369   self.init_speci
-00033110: 616c 2829 0a20 2020 2020 2020 2073 656c  al().        sel
-00033120: 662e 737a 5f66 6561 7475 7265 5f64 696d  f.sz_feature_dim
-00033130: 203d 2073 656c 662e 6e5f 6469 6d0a 2020   = self.n_dim.  
-00033140: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00033150: 660a 0a20 2020 2064 6566 2061 735f 7365  f..    def as_se
-00033160: 7175 656e 6365 5f74 656e 736f 7228 7365  quence_tensor(se
-00033170: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-00033180: 662e 696e 6974 5f73 7065 6369 616c 2829  f.init_special()
-00033190: 0a20 2020 2020 2020 2073 656c 662e 737a  .        self.sz
-000331a0: 5f73 6571 7565 6e63 5f64 696d 203d 2073  _sequenc_dim = s
-000331b0: 656c 662e 6e5f 6469 6d0a 2020 2020 2020  elf.n_dim.      
-000331c0: 2020 7265 7475 726e 2073 656c 660a 0a20    return self.. 
-000331d0: 2020 2064 6566 2061 7574 6f5f 6465 7669     def auto_devi
-000331e0: 6365 2873 656c 6629 3a0a 2020 2020 2020  ce(self):.      
-000331f0: 2020 676c 6f62 616c 205f 6465 7669 6365    global _device
-00033200: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00033210: 7365 6c66 2e74 6f28 5f64 6576 6963 652e  self.to(_device.
-00033220: 6d61 696e 5f64 6576 6963 6529 0a0a 2020  main_device)..  
-00033230: 2020 6261 7369 635f 7661 7273 203d 206c    basic_vars = l
-00033240: 6973 7428 6c6f 6361 6c73 2829 2e6b 6579  ist(locals().key
-00033250: 7328 2929 202b 205b 2762 6173 6963 5f76  s()) + ['basic_v
-00033260: 6172 7327 5d0a 2020 2020 2320 6f70 6572  ars'].    # oper
-00033270: 6174 6f72 730a 2020 2020 6465 6620 5f5f  ators.    def __
-00033280: 6164 645f 5f28 7365 6c66 3a20 2754 656e  add__(self: 'Ten
-00033290: 736f 7227 2c20 6f74 6865 723a 2027 5465  sor', other: 'Te
-000332a0: 6e73 6f72 2729 3a20 2e2e 2e0a 2020 2020  nsor'): ....    
-000332b0: 6465 6620 5f5f 6961 6464 5f5f 2873 656c  def __iadd__(sel
-000332c0: 663a 2027 5465 6e73 6f72 272c 206f 7468  f: 'Tensor', oth
-000332d0: 6572 3a20 2754 656e 736f 7227 293a 202e  er: 'Tensor'): .
-000332e0: 2e2e 0a20 2020 2064 6566 205f 5f72 6164  ...    def __rad
-000332f0: 645f 5f28 7365 6c66 3a20 2754 656e 736f  d__(self: 'Tenso
-00033300: 7227 2c20 6f74 6865 723a 2027 5465 6e73  r', other: 'Tens
-00033310: 6f72 2729 3a20 2e2e 2e0a 2020 2020 6465  or'): ....    de
-00033320: 6620 5f5f 7375 625f 5f28 7365 6c66 3a20  f __sub__(self: 
-00033330: 2754 656e 736f 7227 2c20 6f74 6865 723a  'Tensor', other:
-00033340: 2027 5465 6e73 6f72 2729 3a20 2e2e 2e0a   'Tensor'): ....
-00033350: 2020 2020 6465 6620 5f5f 6973 7562 5f5f      def __isub__
-00033360: 2873 656c 663a 2027 5465 6e73 6f72 272c  (self: 'Tensor',
-00033370: 206f 7468 6572 3a20 2754 656e 736f 7227   other: 'Tensor'
-00033380: 293a 202e 2e2e 0a20 2020 2064 6566 205f  ): ....    def _
-00033390: 5f72 7375 625f 5f28 7365 6c66 3a20 2754  _rsub__(self: 'T
-000333a0: 656e 736f 7227 2c20 6f74 6865 723a 2027  ensor', other: '
-000333b0: 5465 6e73 6f72 2729 3a20 2e2e 2e0a 2020  Tensor'): ....  
-000333c0: 2020 6465 6620 5f5f 6d75 6c5f 5f28 7365    def __mul__(se
-000333d0: 6c66 3a20 2754 656e 736f 7227 2c20 6f74  lf: 'Tensor', ot
-000333e0: 6865 723a 2027 5465 6e73 6f72 2729 3a20  her: 'Tensor'): 
-000333f0: 2e2e 2e0a 2020 2020 6465 6620 5f5f 696d  ....    def __im
-00033400: 756c 5f5f 2873 656c 663a 2027 5465 6e73  ul__(self: 'Tens
-00033410: 6f72 272c 206f 7468 6572 3a20 2754 656e  or', other: 'Ten
-00033420: 736f 7227 293a 202e 2e2e 0a20 2020 2064  sor'): ....    d
-00033430: 6566 205f 5f72 6d75 6c5f 5f28 7365 6c66  ef __rmul__(self
-00033440: 3a20 2754 656e 736f 7227 2c20 6f74 6865  : 'Tensor', othe
-00033450: 723a 2027 5465 6e73 6f72 2729 3a20 2e2e  r: 'Tensor'): ..
-00033460: 2e0a 2020 2020 6465 6620 5f5f 6469 765f  ..    def __div_
-00033470: 5f28 7365 6c66 3a20 2754 656e 736f 7227  _(self: 'Tensor'
-00033480: 2c20 6f74 6865 723a 2027 5465 6e73 6f72  , other: 'Tensor
-00033490: 2729 3a20 2e2e 2e0a 2020 2020 6465 6620  '): ....    def 
-000334a0: 5f5f 6964 6976 5f5f 2873 656c 663a 2027  __idiv__(self: '
-000334b0: 5465 6e73 6f72 272c 206f 7468 6572 3a20  Tensor', other: 
-000334c0: 2754 656e 736f 7227 293a 202e 2e2e 0a20  'Tensor'): .... 
-000334d0: 2020 2064 6566 205f 5f72 6469 765f 5f28     def __rdiv__(
-000334e0: 7365 6c66 3a20 2754 656e 736f 7227 2c20  self: 'Tensor', 
-000334f0: 6f74 6865 723a 2027 5465 6e73 6f72 2729  other: 'Tensor')
-00033500: 3a20 2e2e 2e0a 2020 2020 6465 6620 5f5f  : ....    def __
-00033510: 706f 775f 5f28 7365 6c66 3a20 2754 656e  pow__(self: 'Ten
-00033520: 736f 7227 2c20 6f74 6865 723a 2027 5465  sor', other: 'Te
-00033530: 6e73 6f72 2729 3a20 2e2e 2e0a 2020 2020  nsor'): ....    
-00033540: 6465 6620 5f5f 6970 6f77 5f5f 2873 656c  def __ipow__(sel
-00033550: 663a 2027 5465 6e73 6f72 272c 206f 7468  f: 'Tensor', oth
-00033560: 6572 3a20 2754 656e 736f 7227 293a 202e  er: 'Tensor'): .
-00033570: 2e2e 0a20 2020 2064 6566 205f 5f72 706f  ...    def __rpo
-00033580: 775f 5f28 7365 6c66 3a20 2754 656e 736f  w__(self: 'Tenso
-00033590: 7227 2c20 6f74 6865 723a 2027 5465 6e73  r', other: 'Tens
-000335a0: 6f72 2729 3a20 2e2e 2e0a 2020 2020 6465  or'): ....    de
-000335b0: 6620 5f5f 6d6f 645f 5f28 7365 6c66 3a20  f __mod__(self: 
-000335c0: 2754 656e 736f 7227 2c20 6f74 6865 723a  'Tensor', other:
-000335d0: 2027 5465 6e73 6f72 2729 3a20 2e2e 2e0a   'Tensor'): ....
-000335e0: 2020 2020 6465 6620 5f5f 696d 6f64 5f5f      def __imod__
-000335f0: 2873 656c 663a 2027 5465 6e73 6f72 272c  (self: 'Tensor',
-00033600: 206f 7468 6572 3a20 2754 656e 736f 7227   other: 'Tensor'
-00033610: 293a 202e 2e2e 0a20 2020 2064 6566 205f  ): ....    def _
-00033620: 5f72 6d6f 645f 5f28 7365 6c66 3a20 2754  _rmod__(self: 'T
-00033630: 656e 736f 7227 2c20 6f74 6865 723a 2027  ensor', other: '
-00033640: 5465 6e73 6f72 2729 3a20 2e2e 2e0a 2020  Tensor'): ....  
-00033650: 2020 6465 6620 5f5f 7472 7565 6469 765f    def __truediv_
-00033660: 5f28 7365 6c66 3a20 2754 656e 736f 7227  _(self: 'Tensor'
-00033670: 2c20 6f74 6865 723a 2027 5465 6e73 6f72  , other: 'Tensor
-00033680: 2729 3a20 2e2e 2e0a 2020 2020 6465 6620  '): ....    def 
-00033690: 5f5f 6974 7275 6564 6976 5f5f 2873 656c  __itruediv__(sel
-000336a0: 663a 2027 5465 6e73 6f72 272c 206f 7468  f: 'Tensor', oth
-000336b0: 6572 3a20 2754 656e 736f 7227 293a 202e  er: 'Tensor'): .
-000336c0: 2e2e 0a20 2020 2064 6566 205f 5f72 7472  ...    def __rtr
-000336d0: 7565 6469 765f 5f28 7365 6c66 3a20 2754  uediv__(self: 'T
+0000edf0: 2020 6461 7461 2e64 7570 6c69 6361 7465    data.duplicate
+0000ee00: 286e 756d 2c20 3029 3a20 6461 7461 286e  (num, 0): data(n
+0000ee10: 5f31 2c20 6e5f 3229 203d 3e20 286e 756d  _1, n_2) => (num
+0000ee20: 2c20 6e5f 312c 206e 5f32 290a 2020 2020  , n_1, n_2).    
+0000ee30: 4475 706c 6963 6174 6520 6120 7465 6e73  Duplicate a tens
+0000ee40: 6f72 2062 7920 606e 756d 6020 7469 6d65  or by `num` time
+0000ee50: 7320 616e 6420 7374 6163 6b20 7468 656d  s and stack them
+0000ee60: 2061 7320 6120 6e65 7720 7465 6e73 6f72   as a new tensor
+0000ee70: 2e20 0a0a 2020 2020 4172 6773 3a0a 2020  . ..    Args:.  
+0000ee80: 2020 2020 2020 6e75 6d20 2869 6e74 2c20        num (int, 
+0000ee90: 6f70 7469 6f6e 616c 293a 2054 6865 206e  optional): The n
+0000eea0: 756d 6265 7220 6f66 2064 7570 6c69 6361  umber of duplica
+0000eeb0: 7469 6f6e 732e 2044 6566 6175 6c74 7320  tions. Defaults 
+0000eec0: 746f 2032 2e20 0a20 2020 2020 2020 2064  to 2. .        d
+0000eed0: 696d 2028 696e 742f 6e65 775f 6469 6d2c  im (int/new_dim,
+0000eee0: 206f 7074 696f 6e61 6c29 3a20 5468 6520   optional): The 
+0000eef0: 6469 6d65 6e73 696f 6e20 746f 2073 7461  dimension to sta
+0000ef00: 636b 2061 6c6f 6e67 2e20 4465 6661 756c  ck along. Defaul
+0000ef10: 7473 2074 6f20 6261 7463 682e 0a20 2020  ts to batch..   
+0000ef20: 2022 2222 0a20 2020 2072 6574 7572 6e20   """.    return 
+0000ef30: 7365 6c66 2e75 6e73 7175 6565 7a65 2864  self.unsqueeze(d
+0000ef40: 696d 292e 7265 7065 6174 2828 312c 2920  im).repeat((1,) 
+0000ef50: 2a20 6469 6d5b 305d 202b 2028 6e75 6d2c  * dim[0] + (num,
+0000ef60: 2920 2b20 2831 2c29 202a 2028 7365 6c66  ) + (1,) * (self
+0000ef70: 2e6e 6469 6d20 2d20 6469 6d5b 305d 2929  .ndim - dim[0]))
+0000ef80: 2e73 7065 6369 616c 5f66 726f 6d28 6469  .special_from(di
+0000ef90: 6d29 0a0a 6465 6620 616d 706c 6966 7928  m)..def amplify(
+0000efa0: 7365 6c66 3a20 2754 656e 736f 7227 2c20  self: 'Tensor', 
+0000efb0: 6e75 6d3d 322c 2064 696d 3a20 6578 6973  num=2, dim: exis
+0000efc0: 745f 6469 6d5b 315d 3d7b 7d29 3a0a 2020  t_dim[1]={}):.  
+0000efd0: 2020 2222 220a 2020 2020 6461 7461 2e61    """.    data.a
+0000efe0: 6d70 6c69 6679 286e 756d 2c20 3029 3a20  mplify(num, 0): 
+0000eff0: 6461 7461 286e 5f31 2c20 6e5f 3229 203d  data(n_1, n_2) =
+0000f000: 3e20 286e 5f31 202a 206e 756d 2c20 6e5f  > (n_1 * num, n_
+0000f010: 3229 0a20 2020 2041 6d70 6c69 6679 2061  2).    Amplify a
+0000f020: 2064 696d 656e 7369 6f6e 206f 6620 6120   dimension of a 
+0000f030: 7465 6e73 6f72 2062 7920 656e 6c61 7267  tensor by enlarg
+0000f040: 696e 6720 7769 7468 2064 7570 6c69 6361  ing with duplica
+0000f050: 7469 6f6e 733a 2061 6d70 6c69 6679 696e  tions: amplifyin
+0000f060: 6720 5b61 2c20 622c 2063 5d20 7769 7468  g [a, b, c] with
+0000f070: 206e 756d 6265 7220 3220 7265 7375 6c74   number 2 result
+0000f080: 7320 696e 205b 612c 2061 2c20 622c 2062  s in [a, a, b, b
+0000f090: 2c20 632c 2063 5d2e 0a20 2020 204e 6f74  , c, c]..    Not
+0000f0a0: 6520 7468 6174 206f 6e65 2073 686f 756c  e that one shoul
+0000f0b0: 6420 7573 6520 2772 6570 6561 7465 6427  d use 'repeated'
+0000f0c0: 2028 666f 7220 6f6e 6520 6469 6d65 6e73   (for one dimens
+0000f0d0: 696f 6e29 206f 7220 2772 6570 6561 7427  ion) or 'repeat'
+0000f0e0: 2028 666f 7220 616c 6c20 6469 6d65 6e73   (for all dimens
+0000f0f0: 696f 6e73 2920 746f 2064 7570 6c69 6361  ions) to duplica
+0000f100: 7465 2074 6865 2077 686f 6c65 2074 656e  te the whole ten
+0000f110: 736f 7220 616e 6420 0a20 2020 2020 2020  sor and .       
+0000f120: 2063 6f6e 6361 7465 6e61 7465 2074 6865   concatenate the
+0000f130: 2064 7570 6c69 6361 7469 6f6e 7320 746f   duplications to
+0000f140: 6765 7468 6572 2028 5b61 2c20 622c 2063  gether ([a, b, c
+0000f150: 5d20 3d3e 205b 612c 2062 2c20 632c 2061  ] => [a, b, c, a
+0000f160: 2c20 622c 2063 5d29 2e20 0a20 2020 200a  , b, c]). .    .
+0000f170: 2020 2020 4172 6773 3a20 0a20 2020 2020      Args: .     
+0000f180: 2020 206e 756d 2028 696e 742c 206f 7074     num (int, opt
+0000f190: 696f 6e61 6c29 3a20 5468 6520 6e75 6d62  ional): The numb
+0000f1a0: 6572 206f 6620 6475 706c 6963 6174 696f  er of duplicatio
+0000f1b0: 6e73 2e20 4465 6661 756c 7473 2074 6f20  ns. Defaults to 
+0000f1c0: 322e 200a 2020 2020 2020 2020 6469 6d20  2. .        dim 
+0000f1d0: 2869 6e74 2f6e 6577 5f64 696d 2c20 6f70  (int/new_dim, op
+0000f1e0: 7469 6f6e 616c 293a 2054 6865 2064 696d  tional): The dim
+0000f1f0: 656e 7369 6f6e 2074 6f20 7374 6163 6b20  ension to stack 
+0000f200: 616c 6f6e 672e 2044 6566 6175 6c74 7320  along. Defaults 
+0000f210: 746f 2062 6174 6368 2e0a 2020 2020 2222  to batch..    ""
+0000f220: 220a 2020 2020 6469 6d20 3d20 6469 6d5b  ".    dim = dim[
+0000f230: 305d 0a20 2020 2077 6974 6820 7365 6c66  0].    with self
+0000f240: 2e68 6964 655f 7370 6563 6961 6c28 293a  .hide_special():
+0000f250: 0a20 2020 2020 2020 206f 7574 7075 7420  .        output 
+0000f260: 3d20 7365 6c66 2e64 7570 6c69 6361 7465  = self.duplicate
+0000f270: 286e 756d 2c20 6469 6d2b 3129 2e66 6c61  (num, dim+1).fla
+0000f280: 7474 656e 2864 696d 2c20 6469 6d20 2b20  tten(dim, dim + 
+0000f290: 3129 0a20 2020 2072 6574 7572 6e20 6f75  1).    return ou
+0000f2a0: 7470 7574 2e73 7065 6369 616c 5f66 726f  tput.special_fro
+0000f2b0: 6d28 7365 6c66 290a 0a64 6566 2072 6570  m(self)..def rep
+0000f2c0: 6561 7465 6428 7365 6c66 3a20 2754 656e  eated(self: 'Ten
+0000f2d0: 736f 7227 2c20 6e75 6d3d 322c 2064 696d  sor', num=2, dim
+0000f2e0: 3a20 6578 6973 745f 6469 6d5b 315d 3d7b  : exist_dim[1]={
+0000f2f0: 7d29 3a0a 2020 2020 2222 220a 2020 2020  }):.    """.    
+0000f300: 6461 7461 2e72 6570 6561 7465 6428 6e75  data.repeated(nu
+0000f310: 6d2c 2030 293a 2064 6174 6128 6e5f 312c  m, 0): data(n_1,
+0000f320: 206e 5f32 2920 3d3e 2028 6e75 6d20 2a20   n_2) => (num * 
+0000f330: 6e5f 312c 206e 5f32 290a 2020 2020 5265  n_1, n_2).    Re
+0000f340: 7065 6174 2061 2074 656e 736f 7220 6279  peat a tensor by
+0000f350: 2060 6e75 6d60 2074 696d 6573 2061 6c6f   `num` times alo
+0000f360: 6e67 206f 6e65 2064 696d 656e 7369 6f6e  ng one dimension
+0000f370: 2060 6469 6d60 2028 7573 6520 2772 6570   `dim` (use 'rep
+0000f380: 6561 7427 2066 6f72 206d 756c 7469 706c  eat' for multipl
+0000f390: 6520 6469 6d65 6e73 696f 6e73 2920 616e  e dimensions) an
+0000f3a0: 6420 636f 6e63 6174 656e 6174 6520 7468  d concatenate th
+0000f3b0: 656d 2061 7320 6120 6e65 7720 7465 6e73  em as a new tens
+0000f3c0: 6f72 2e0a 2020 2020 4e6f 7465 2074 6861  or..    Note tha
+0000f3d0: 7420 7265 7065 6174 696e 6720 5b61 2c20  t repeating [a, 
+0000f3e0: 622c 2063 5d20 7769 7468 206e 756d 6265  b, c] with numbe
+0000f3f0: 7220 3220 7265 7375 6c74 7320 696e 205b  r 2 results in [
+0000f400: 612c 2062 2c20 632c 2061 2c20 622c 2063  a, b, c, a, b, c
+0000f410: 5d2e 0a20 2020 2020 2020 204f 6e65 2073  ]..        One s
+0000f420: 686f 756c 6420 7573 6520 2761 6d70 6c69  hould use 'ampli
+0000f430: 6679 2720 746f 2061 6d70 6c69 6679 2074  fy' to amplify t
+0000f440: 6f20 5b61 2c20 612c 2062 2c20 622c 2063  o [a, a, b, b, c
+0000f450: 2c20 635d 2e0a 2020 2020 0a20 2020 2041  , c]..    .    A
+0000f460: 7267 733a 200a 2020 2020 2020 2020 6e75  rgs: .        nu
+0000f470: 6d20 2869 6e74 2c20 6f70 7469 6f6e 616c  m (int, optional
+0000f480: 293a 2054 6865 206e 756d 6265 7220 6f66  ): The number of
+0000f490: 2064 7570 6c69 6361 7469 6f6e 732e 2044   duplications. D
+0000f4a0: 6566 6175 6c74 7320 746f 2032 2e20 0a20  efaults to 2. . 
+0000f4b0: 2020 2020 2020 2064 696d 2028 696e 742f         dim (int/
+0000f4c0: 6e65 775f 6469 6d2c 206f 7074 696f 6e61  new_dim, optiona
+0000f4d0: 6c29 3a20 5468 6520 6469 6d65 6e73 696f  l): The dimensio
+0000f4e0: 6e20 746f 2073 7461 636b 2061 6c6f 6e67  n to stack along
+0000f4f0: 2e20 4465 6661 756c 7473 2074 6f20 6261  . Defaults to ba
+0000f500: 7463 682e 0a20 2020 2022 2222 0a20 2020  tch..    """.   
+0000f510: 2064 696d 203d 2064 696d 5b30 5d0a 2020   dim = dim[0].  
+0000f520: 2020 7769 7468 2073 656c 662e 6869 6465    with self.hide
+0000f530: 5f73 7065 6369 616c 2829 3a0a 2020 2020  _special():.    
+0000f540: 2020 2020 6f75 7470 7574 203d 2073 656c      output = sel
+0000f550: 662e 6475 706c 6963 6174 6528 6e75 6d2c  f.duplicate(num,
+0000f560: 2064 696d 292e 666c 6174 7465 6e28 6469   dim).flatten(di
+0000f570: 6d2c 2064 696d 202b 2031 290a 2020 2020  m, dim + 1).    
+0000f580: 7265 7475 726e 206f 7574 7075 742e 7370  return output.sp
+0000f590: 6563 6961 6c5f 6672 6f6d 2873 656c 6629  ecial_from(self)
+0000f5a0: 0a0a 6465 6620 7265 7065 6174 2873 656c  ..def repeat(sel
+0000f5b0: 663a 2027 5465 6e73 6f72 272c 202a 7369  f: 'Tensor', *si
+0000f5c0: 7a65 3a20 2753 697a 6527 293a 0a20 2020  ze: 'Size'):.   
+0000f5d0: 2077 6974 6820 746f 7263 682e 5f43 2e44   with torch._C.D
+0000f5e0: 6973 6162 6c65 546f 7263 6846 756e 6374  isableTorchFunct
+0000f5f0: 696f 6e28 293a 0a20 2020 2020 2020 2072  ion():.        r
+0000f600: 6574 7572 6e20 746f 7263 685f 7375 7065  eturn torch_supe
+0000f610: 7228 7365 6c66 2c20 2772 6570 6561 7427  r(self, 'repeat'
+0000f620: 2928 2a73 697a 6529 2e61 735f 7375 6263  )(*size).as_subc
+0000f630: 6c61 7373 2854 656e 736f 7229 2e73 7065  lass(Tensor).spe
+0000f640: 6369 616c 5f66 726f 6d28 7365 6c66 292e  cial_from(self).
+0000f650: 7570 6461 7465 5f73 7065 6369 616c 5f66  update_special_f
+0000f660: 726f 6d28 7369 7a65 290a 0a23 2072 6573  rom(size)..# res
+0000f670: 616d 706c 6572 730a 6465 6620 6761 7468  amplers.def gath
+0000f680: 6572 2873 656c 663a 2027 5465 6e73 6f72  er(self: 'Tensor
+0000f690: 272c 2064 696d 3a20 6578 6973 745f 6469  ', dim: exist_di
+0000f6a0: 6d5b 315d 2c20 696e 6465 782c 202a 2c20  m[1], index, *, 
+0000f6b0: 7370 6172 7365 5f67 7261 643d 4661 6c73  sparse_grad=Fals
+0000f6c0: 652c 206f 7574 3d4e 6f6e 6529 3a20 2e2e  e, out=None): ..
+0000f6d0: 2e0a 6465 6620 666c 6970 2873 656c 663a  ..def flip(self:
+0000f6e0: 2027 5465 6e73 6f72 272c 202a 6469 6d73   'Tensor', *dims
+0000f6f0: 3a20 6578 6973 745f 6469 6d29 3a20 2e2e  : exist_dim): ..
+0000f700: 2e0a 0a23 2070 726f 7065 7274 6965 730a  ...# properties.
+0000f710: 6465 6620 6465 7461 6368 2873 656c 663a  def detach(self:
+0000f720: 2027 5465 6e73 6f72 2729 3a20 2e2e 2e0a   'Tensor'): ....
+0000f730: 6465 6620 7175 616e 7469 6c65 2873 656c  def quantile(sel
+0000f740: 663a 2027 5465 6e73 6f72 272c 2071 3a20  f: 'Tensor', q: 
+0000f750: 2754 656e 736f 7227 2c20 6469 6d3d 4e6f  'Tensor', dim=No
+0000f760: 6e65 2c20 6b65 6570 6469 6d3d 4661 6c73  ne, keepdim=Fals
+0000f770: 652c 202a 2c20 696e 7465 7270 6f6c 6174  e, *, interpolat
+0000f780: 696f 6e3d 276c 696e 6561 7227 293a 0a20  ion='linear'):. 
+0000f790: 2020 206e 5f64 696d 5f63 6f75 6e74 203d     n_dim_count =
+0000f7a0: 204e 6f6e 650a 2020 2020 6966 2064 696d   None.    if dim
+0000f7b0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0000f7c0: 2020 2020 2020 6469 6d20 3d20 6578 6973        dim = exis
+0000f7d0: 745f 6469 6d28 7365 6c66 2c20 6469 6d29  t_dim(self, dim)
+0000f7e0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+0000f7f0: 6469 6d29 203e 2031 3a20 7365 6c66 203d  dim) > 1: self =
+0000f800: 2073 656c 662e 666c 6174 7465 6e28 6469   self.flatten(di
+0000f810: 6d29 3b20 6e5f 6469 6d5f 636f 756e 7420  m); n_dim_count 
+0000f820: 3d20 6c65 6e28 6469 6d29 0a20 2020 2020  = len(dim).     
+0000f830: 2020 2072 6566 5f73 6861 7065 2c20 5f2c     ref_shape, _,
+0000f840: 205f 203d 2073 697a 655f 6d61 7070 696e   _ = size_mappin
+0000f850: 675f 6f70 5b27 7175 616e 7469 6c65 275d  g_op['quantile']
+0000f860: 2873 656c 662e 7368 6170 652c 2071 5f73  (self.shape, q_s
+0000f870: 6861 7065 2c20 6469 6d5b 3a31 5d2c 206b  hape, dim[:1], k
+0000f880: 6565 7064 696d 3d6b 6565 7064 696d 290a  eepdim=keepdim).
+0000f890: 2020 2020 7769 7468 2074 6f72 6368 2e5f      with torch._
+0000f8a0: 432e 4469 7361 626c 6554 6f72 6368 4675  C.DisableTorchFu
+0000f8b0: 6e63 7469 6f6e 2829 3a0a 2020 2020 2020  nction():.      
+0000f8c0: 2020 6966 2064 696d 2069 7320 4e6f 6e65    if dim is None
+0000f8d0: 3a20 7265 7320 3d20 746f 7263 682e 7175  : res = torch.qu
+0000f8e0: 616e 7469 6c65 2873 656c 662c 2071 2c20  antile(self, q, 
+0000f8f0: 6b65 6570 6469 6d3d 6b65 6570 6469 6d2c  keepdim=keepdim,
+0000f900: 696e 7465 7270 6f6c 6174 696f 6e3d 696e  interpolation=in
+0000f910: 7465 7270 6f6c 6174 696f 6e29 2e61 735f  terpolation).as_
+0000f920: 7375 6263 6c61 7373 2854 656e 736f 7229  subclass(Tensor)
+0000f930: 2e73 7065 6369 616c 5f66 726f 6d28 7129  .special_from(q)
+0000f940: 3b20 6469 6d20 3d20 5b69 6e74 5f28 712e  ; dim = [int_(q.
+0000f950: 6e5f 6469 6d20 3e20 3029 5d0a 2020 2020  n_dim > 0)].    
+0000f960: 2020 2020 656c 7365 3a20 7265 7320 3d20      else: res = 
+0000f970: 746f 7263 682e 7175 616e 7469 6c65 2873  torch.quantile(s
+0000f980: 656c 662c 2071 2c20 6469 6d5b 305d 2c20  elf, q, dim[0], 
+0000f990: 6b65 6570 6469 6d3d 6b65 6570 6469 6d2c  keepdim=keepdim,
+0000f9a0: 696e 7465 7270 6f6c 6174 696f 6e3d 696e  interpolation=in
+0000f9b0: 7465 7270 6f6c 6174 696f 6e29 2e61 735f  terpolation).as_
+0000f9c0: 7375 6263 6c61 7373 2854 656e 736f 7229  subclass(Tensor)
+0000f9d0: 2e73 7065 6369 616c 5f66 726f 6d28 7265  .special_from(re
+0000f9e0: 665f 7368 6170 6529 0a20 2020 2069 6620  f_shape).    if 
+0000f9f0: 6b65 6570 6469 6d3a 0a20 2020 2020 2020  keepdim:.       
+0000fa00: 2064 203d 2064 696d 5b30 5d20 2b20 696e   d = dim[0] + in
+0000fa10: 745f 2871 2e6e 5f64 696d 203e 2030 290a  t_(q.n_dim > 0).
+0000fa20: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+0000fa30: 6573 2e73 706c 6974 5f64 696d 2864 2c20  es.split_dim(d, 
+0000fa40: 7265 732e 7368 6170 655b 643a 642b 315d  res.shape[d:d+1]
+0000fa50: 202a 206e 5f64 696d 5f63 6f75 6e74 290a   * n_dim_count).
+0000fa60: 2020 2020 656c 7365 3a20 7265 7475 726e      else: return
+0000fa70: 2072 6573 0a64 6566 2076 616c 5f72 616e   res.def val_ran
+0000fa80: 6765 2873 656c 662c 2064 696d 3a20 6578  ge(self, dim: ex
+0000fa90: 6973 745f 6469 6d3d 4e6f 6e65 293a 0a20  ist_dim=None):. 
+0000faa0: 2020 2022 2222 0a20 2020 2043 6f6d 7075     """.    Compu
+0000fab0: 7465 2074 6865 2072 616e 6765 2069 6e20  te the range in 
+0000fac0: 6469 6d65 6e73 696f 6e73 2060 6469 6d60  dimensions `dim`
+0000fad0: 2c20 7265 7375 6c74 696e 6720 696e 2061  , resulting in a
+0000fae0: 2073 7175 6565 7a65 206f 6620 7468 6573   squeeze of thes
+0000faf0: 6520 6469 6d65 6e73 696f 6e73 200a 2020  e dimensions .  
+0000fb00: 2020 2020 2020 746f 2061 2073 6f6c 6520        to a sole 
+0000fb10: 6675 6e63 7469 6f6e 616c 2064 696d 656e  functional dimen
+0000fb20: 7369 6f6e 206f 6620 322c 2069 2e65 2e20  sion of 2, i.e. 
+0000fb30: 7468 6520 6d69 6e69 6d61 6c20 616e 6420  the minimal and 
+0000fb40: 6d61 7869 6d61 6c20 7661 6c75 6573 2e20  maximal values. 
+0000fb50: 0a0a 2020 2020 4172 6773 3a20 6469 6d20  ..    Args: dim 
+0000fb60: 2869 6e74 2f65 7869 7374 5f64 696d 2c20  (int/exist_dim, 
+0000fb70: 6f70 7469 6f6e 616c 293a 2054 6865 2064  optional): The d
+0000fb80: 696d 656e 7369 6f6e 7320 746f 2066 696e  imensions to fin
+0000fb90: 6420 7261 6e67 652e 2044 6566 6175 6c74  d range. Default
+0000fba0: 7320 746f 204e 6f6e 652e 0a20 2020 204f  s to None..    O
+0000fbb0: 7574 7075 743a 2028 2832 292c 202e 2e2e  utput: ((2), ...
+0000fbc0: 5b73 697a 6520 7769 7468 6f75 7420 7468  [size without th
+0000fbd0: 6520 7370 6563 6966 6965 6420 6469 6d6e  e specified dimn
+0000fbe0: 7369 6f6e 735d 290a 2020 2020 2222 220a  sions]).    """.
+0000fbf0: 2020 2020 7265 7475 726e 2073 7461 636b      return stack
+0000fc00: 2873 656c 662e 6d69 6e28 6469 6d29 2c20  (self.min(dim), 
+0000fc10: 7365 6c66 2e6d 6178 2864 696d 292c 2030  self.max(dim), 0
+0000fc20: 292e 7769 7468 5f66 756e 635f 6469 6d28  ).with_func_dim(
+0000fc30: 3029 2023 2073 7570 7072 6573 733a 2073  0) # suppress: s
+0000fc40: 7065 6369 616c 5f66 726f 6d0a 0a23 2072  pecial_from..# r
+0000fc50: 6564 7563 7469 6f6e 730a 6465 6620 7375  eductions.def su
+0000fc60: 6d28 696e 7075 743a 2027 5465 6e73 6f72  m(input: 'Tensor
+0000fc70: 272c 202a 6469 6d3a 2064 656c 5f64 696d  ', *dim: del_dim
+0000fc80: 5b3a 5d2c 206b 6565 7064 696d 3d46 616c  [:], keepdim=Fal
+0000fc90: 7365 2c20 6474 7970 653d 4e6f 6e65 293a  se, dtype=None):
+0000fca0: 202e 2e2e 0a64 6566 2070 726f 6428 696e   ....def prod(in
+0000fcb0: 7075 743a 2027 5465 6e73 6f72 272c 2064  put: 'Tensor', d
+0000fcc0: 696d 3a20 6465 6c5f 6469 6d5b 2e2e 2e5d  im: del_dim[...]
+0000fcd0: 3d4e 6f6e 652c 206b 6565 7064 696d 3d46  =None, keepdim=F
+0000fce0: 616c 7365 2c20 6474 7970 653d 4e6f 6e65  alse, dtype=None
+0000fcf0: 293a 202e 2e2e 0a64 6566 206d 6561 6e28  ): ....def mean(
+0000fd00: 696e 7075 743a 2027 5465 6e73 6f72 272c  input: 'Tensor',
+0000fd10: 202a 6469 6d3a 2064 656c 5f64 696d 5b3a   *dim: del_dim[:
+0000fd20: 5d2c 206b 6565 7064 696d 3d46 616c 7365  ], keepdim=False
+0000fd30: 2c20 6474 7970 653d 4e6f 6e65 293a 202e  , dtype=None): .
+0000fd40: 2e2e 0a64 6566 2073 7464 2869 6e70 7574  ...def std(input
+0000fd50: 3a20 2754 656e 736f 7227 2c20 2a64 696d  : 'Tensor', *dim
+0000fd60: 3a20 6465 6c5f 6469 6d5b 3a5d 2c20 636f  : del_dim[:], co
+0000fd70: 7272 6563 7469 6f6e 3d31 2c20 6b65 6570  rrection=1, keep
+0000fd80: 6469 6d3d 4661 6c73 6529 3a20 2e2e 2e0a  dim=False): ....
+0000fd90: 6465 6620 6375 6d73 756d 2869 6e70 7574  def cumsum(input
+0000fda0: 3a20 2754 656e 736f 7227 2c20 6469 6d3a  : 'Tensor', dim:
+0000fdb0: 2064 656c 5f64 696d 5b31 5d2c 2064 7479   del_dim[1], dty
+0000fdc0: 7065 3d4e 6f6e 652c 206f 7574 3d4e 6f6e  pe=None, out=Non
+0000fdd0: 6529 3a20 2e2e 2e0a 6465 6620 6375 6d70  e): ....def cump
+0000fde0: 726f 6428 696e 7075 743a 2027 5465 6e73  rod(input: 'Tens
+0000fdf0: 6f72 272c 2064 696d 3a20 6465 6c5f 6469  or', dim: del_di
+0000fe00: 6d5b 315d 2c20 6474 7970 653d 4e6f 6e65  m[1], dtype=None
+0000fe10: 2c20 6f75 743d 4e6f 6e65 293a 202e 2e2e  , out=None): ...
+0000fe20: 0a0a 6465 6620 5f5f 696e 6465 7865 645f  ..def __indexed_
+0000fe30: 7265 6475 6365 5f5f 2866 756e 635f 6e61  reduce__(func_na
+0000fe40: 6d65 2c20 7365 6c66 3a20 2754 656e 736f  me, self: 'Tenso
+0000fe50: 7227 2c20 2a64 696d 2c20 6b65 6570 6469  r', *dim, keepdi
+0000fe60: 6d3d 4e6f 6e65 2c20 6f75 743d 4e6f 6e65  m=None, out=None
+0000fe70: 2c20 7265 745f 696e 6465 785f 6f6e 6c79  , ret_index_only
+0000fe80: 3d46 616c 7365 293a 0a20 2020 2069 6620  =False):.    if 
+0000fe90: 6c65 6e28 6469 6d29 203d 3d20 3120 616e  len(dim) == 1 an
+0000fea0: 6420 6973 696e 7374 616e 6365 2864 696d  d isinstance(dim
+0000feb0: 5b30 5d2c 2074 6f72 6368 2e54 656e 736f  [0], torch.Tenso
+0000fec0: 7229 3a0a 2020 2020 2020 2020 6f74 6865  r):.        othe
+0000fed0: 7220 3d20 6469 6d5b 305d 0a20 2020 2020  r = dim[0].     
+0000fee0: 2020 206f 7468 6572 203d 206f 7468 6572     other = other
+0000fef0: 2e61 735f 7375 6263 6c61 7373 2854 656e  .as_subclass(Ten
+0000ff00: 736f 7229 2e73 7065 6369 616c 5f66 726f  sor).special_fro
+0000ff10: 6d28 6f74 6865 722e 7368 6170 6529 2069  m(other.shape) i
+0000ff20: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+0000ff30: 286f 7468 6572 2c20 5465 6e73 6f72 2920  (other, Tensor) 
+0000ff40: 656c 7365 206f 7468 6572 0a20 2020 2020  else other.     
+0000ff50: 2020 2073 656c 665f 7368 6170 6520 3d20     self_shape = 
+0000ff60: 5369 7a65 2873 656c 662e 7368 6170 6529  Size(self.shape)
+0000ff70: 3b20 6f74 6865 725f 7368 6170 6520 3d20  ; other_shape = 
+0000ff80: 5369 7a65 286f 7468 6572 2e73 6861 7065  Size(other.shape
+0000ff90: 290a 2020 2020 2020 2020 7265 665f 7368  ).        ref_sh
+0000ffa0: 6170 652c 2073 656c 665f 7368 6170 652c  ape, self_shape,
+0000ffb0: 206f 7468 6572 5f73 6861 7065 203d 2073   other_shape = s
+0000ffc0: 697a 655f 6d61 7070 696e 675f 6f70 5b66  ize_mapping_op[f
+0000ffd0: 756e 635f 6e61 6d65 5d28 7365 6c66 5f73  unc_name](self_s
+0000ffe0: 6861 7065 2c20 6f74 6865 725f 7368 6170  hape, other_shap
+0000fff0: 6529 0a20 2020 2020 2020 2077 6974 6820  e).        with 
+00010000: 746f 7263 682e 5f43 2e44 6973 6162 6c65  torch._C.Disable
+00010010: 546f 7263 6846 756e 6374 696f 6e28 293a  TorchFunction():
+00010020: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00010030: 7572 6e20 746f 7263 685f 7375 7065 7228  urn torch_super(
+00010040: 7365 6c66 2c20 6675 6e63 5f6e 616d 6529  self, func_name)
+00010050: 286f 7468 6572 2c20 2a2a 2864 6963 7428  (other, **(dict(
+00010060: 6f75 743d 6f75 7429 2069 6620 6c6f 6361  out=out) if loca
+00010070: 6c73 2829 2e67 6574 2827 6f75 7427 2c20  ls().get('out', 
+00010080: 4e6f 6e65 2920 6973 206e 6f74 204e 6f6e  None) is not Non
+00010090: 6520 656c 7365 207b 7d29 292e 6173 5f73  e else {})).as_s
+000100a0: 7562 636c 6173 7328 5465 6e73 6f72 292e  ubclass(Tensor).
+000100b0: 7370 6563 6961 6c5f 6672 6f6d 2872 6566  special_from(ref
+000100c0: 5f73 6861 7065 290a 2020 2020 6469 6d20  _shape).    dim 
+000100d0: 3d20 6465 6c5f 6469 6d28 7365 6c66 2c20  = del_dim(self, 
+000100e0: 2a64 696d 290a 2020 2020 696e 6469 6365  *dim).    indice
+000100f0: 7320 3d20 4e6f 6e65 0a20 2020 206e 756d  s = None.    num
+00010100: 5f64 696d 203d 2030 0a20 2020 2069 6e69  _dim = 0.    ini
+00010110: 745f 7368 6170 6520 3d20 7365 6c66 2e73  t_shape = self.s
+00010120: 6861 7065 0a20 2020 2077 6974 6820 746f  hape.    with to
+00010130: 7263 682e 5f43 2e44 6973 6162 6c65 546f  rch._C.DisableTo
+00010140: 7263 6846 756e 6374 696f 6e28 293a 0a20  rchFunction():. 
+00010150: 2020 2020 2020 2066 6f72 2064 2069 6e20         for d in 
+00010160: 6469 6d5b 3a3a 2d31 5d3a 0a20 2020 2020  dim[::-1]:.     
+00010170: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00010180: 746f 7263 685f 7375 7065 7228 7365 6c66  torch_super(self
+00010190: 2c20 6675 6e63 5f6e 616d 6529 2864 2c20  , func_name)(d, 
+000101a0: 2a2a 6469 6374 286b 6565 7064 696d 3d6b  **dict(keepdim=k
+000101b0: 6565 7064 696d 2920 6966 206b 6565 7064  eepdim) if keepd
+000101c0: 696d 2069 7320 6e6f 7420 4e6f 6e65 2065  im is not None e
+000101d0: 6c73 6520 7b7d 290a 2020 2020 2020 2020  lse {}).        
+000101e0: 2020 2020 7365 6c66 203d 2072 6573 756c      self = resul
+000101f0: 742e 7661 6c75 6573 0a20 2020 2020 2020  t.values.       
+00010200: 2020 2020 2072 6573 5f69 6e64 6963 6573       res_indices
+00010210: 203d 2072 6573 756c 742e 696e 6469 6365   = result.indice
+00010220: 732e 6173 5f73 7562 636c 6173 7328 5465  s.as_subclass(Te
+00010230: 6e73 6f72 292e 696e 6974 5f73 7065 6369  nsor).init_speci
+00010240: 616c 2829 0a20 2020 2020 2020 2020 2020  al().           
+00010250: 2069 6620 696e 6469 6365 7320 6973 204e   if indices is N
+00010260: 6f6e 653a 2069 6e64 6963 6573 203d 2072  one: indices = r
+00010270: 6573 5f69 6e64 6963 6573 2e75 6e73 7175  es_indices.unsqu
+00010280: 6565 7a65 2830 2c20 737a 5f66 756e 635f  eeze(0, sz_func_
+00010290: 6469 6d3d 3129 0a20 2020 2020 2020 2020  dim=1).         
+000102a0: 2020 2065 6c69 6620 6b65 6570 6469 6d20     elif keepdim 
+000102b0: 6f72 206b 6565 7064 696d 2069 7320 4e6f  or keepdim is No
+000102c0: 6e65 3a20 696e 6469 6365 7320 3d20 6361  ne: indices = ca
+000102d0: 7428 7265 735f 696e 6469 6365 732e 756e  t(res_indices.un
+000102e0: 7371 7565 657a 6528 302c 2073 7a5f 6675  squeeze(0, sz_fu
+000102f0: 6e63 5f64 696d 3d31 292c 2069 6e64 6963  nc_dim=1), indic
+00010300: 6573 2e67 6174 6865 7228 642b 312c 2072  es.gather(d+1, r
+00010310: 6573 5f69 6e64 6963 6573 2e64 7570 6c69  es_indices.dupli
+00010320: 6361 7465 286e 756d 5f64 696d 2c20 302c  cate(num_dim, 0,
+00010330: 2073 7a5f 6675 6e63 5f64 696d 3d31 2929   sz_func_dim=1))
+00010340: 2c20 3029 0a20 2020 2020 2020 2020 2020  , 0).           
+00010350: 2065 6c73 653a 2069 6e64 6963 6573 203d   else: indices =
+00010360: 2063 6174 2872 6573 5f69 6e64 6963 6573   cat(res_indices
+00010370: 2e75 6e73 7175 6565 7a65 2830 2c20 737a  .unsqueeze(0, sz
+00010380: 5f66 756e 635f 6469 6d3d 3129 2c20 696e  _func_dim=1), in
+00010390: 6469 6365 732e 6761 7468 6572 2864 2b31  dices.gather(d+1
+000103a0: 2c20 7265 735f 696e 6469 6365 732e 756e  , res_indices.un
+000103b0: 7371 7565 657a 6528 6429 2e64 7570 6c69  squeeze(d).dupli
+000103c0: 6361 7465 286e 756d 5f64 696d 2c20 302c  cate(num_dim, 0,
+000103d0: 2073 7a5f 6675 6e63 5f64 696d 3d31 2929   sz_func_dim=1))
+000103e0: 2e73 7175 6565 7a65 5f28 642b 3129 2c20  .squeeze_(d+1), 
+000103f0: 3029 0a20 2020 2020 2020 2020 2020 206e  0).            n
+00010400: 756d 5f64 696d 202b 3d20 310a 2020 2020  um_dim += 1.    
+00010410: 6966 206b 6565 7064 696d 2069 7320 4661  if keepdim is Fa
+00010420: 6c73 653a 2063 7572 5f73 6861 7065 203d  lse: cur_shape =
+00010430: 2072 656d 6f76 655f 6469 6d28 696e 6974   remove_dim(init
+00010440: 5f73 6861 7065 2c20 6469 6d29 0a20 2020  _shape, dim).   
+00010450: 2065 6c73 653a 2063 7572 5f73 6861 7065   else: cur_shape
+00010460: 203d 2069 6e69 745f 7368 6170 650a 2020   = init_shape.  
+00010470: 2020 6966 2072 6574 5f69 6e64 6578 5f6f    if ret_index_o
+00010480: 6e6c 793a 0a20 2020 2020 2020 2069 6e64  nly:.        ind
+00010490: 6963 6573 203d 2069 6e64 6963 6573 2e73  ices = indices.s
+000104a0: 7065 6369 616c 5f66 726f 6d28 6675 6e63  pecial_from(func
+000104b0: 5f64 696d 202b 2063 7572 5f73 6861 7065  _dim + cur_shape
+000104c0: 2920 6966 2069 6e64 6963 6573 2069 7320  ) if indices is 
+000104d0: 6e6f 7420 4e6f 6e65 2065 6c73 6520 4e6f  not None else No
+000104e0: 6e65 0a20 2020 2020 2020 2069 6620 6c65  ne.        if le
+000104f0: 6e28 6469 6d29 203d 3d20 313a 2069 6e64  n(dim) == 1: ind
+00010500: 6963 6573 2e73 7175 6565 7a65 5f28 3029  ices.squeeze_(0)
+00010510: 0a20 2020 2020 2020 2069 6e64 6963 6573  .        indices
+00010520: 2e69 6e64 6963 6573 203d 2069 6e64 6963  .indices = indic
+00010530: 6573 0a20 2020 2020 2020 2069 6e64 6963  es.        indic
+00010540: 6573 2e76 616c 7565 7320 3d20 7365 6c66  es.values = self
+00010550: 2e61 735f 7375 6263 6c61 7373 2854 656e  .as_subclass(Ten
+00010560: 736f 7229 2e73 7065 6369 616c 5f66 726f  sor).special_fro
+00010570: 6d28 6375 725f 7368 6170 6529 0a20 2020  m(cur_shape).   
+00010580: 2020 2020 2069 6620 6f75 7420 6973 206e       if out is n
+00010590: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+000105a0: 2020 2020 206f 7574 2e7a 6572 6f5f 2829       out.zero_()
+000105b0: 2e61 6464 5f28 696e 6469 6365 7329 0a20  .add_(indices). 
+000105c0: 2020 2020 2020 2072 6574 7572 6e20 696e         return in
+000105d0: 6469 6365 730a 2020 2020 656c 7365 3a0a  dices.    else:.
+000105e0: 2020 2020 2020 2020 7365 6c66 203d 2073          self = s
+000105f0: 656c 662e 6173 5f73 7562 636c 6173 7328  elf.as_subclass(
+00010600: 5465 6e73 6f72 292e 7370 6563 6961 6c5f  Tensor).special_
+00010610: 6672 6f6d 2863 7572 5f73 6861 7065 290a  from(cur_shape).
+00010620: 2020 2020 2020 2020 7365 6c66 2e69 6e64          self.ind
+00010630: 6963 6573 203d 2069 6e64 6963 6573 2e73  ices = indices.s
+00010640: 7065 6369 616c 5f66 726f 6d28 6675 6e63  pecial_from(func
+00010650: 5f64 696d 202b 2063 7572 5f73 6861 7065  _dim + cur_shape
+00010660: 2920 6966 2069 6e64 6963 6573 2069 7320  ) if indices is 
+00010670: 6e6f 7420 4e6f 6e65 2065 6c73 6520 4e6f  not None else No
+00010680: 6e65 0a20 2020 2020 2020 2069 6620 6c65  ne.        if le
+00010690: 6e28 6469 6d29 203d 3d20 313a 2073 656c  n(dim) == 1: sel
+000106a0: 662e 696e 6469 6365 732e 7371 7565 657a  f.indices.squeez
+000106b0: 655f 2830 290a 2020 2020 2020 2020 2320  e_(0).        # 
+000106c0: 696e 6469 6365 735f 7475 706c 6520 3d20  indices_tuple = 
+000106d0: 696e 6469 6365 732e 7370 6563 6961 6c5f  indices.special_
+000106e0: 6672 6f6d 2863 7572 5f73 6861 7065 202b  from(cur_shape +
+000106f0: 2028 312c 2929 2e73 706c 6974 2864 696d   (1,)).split(dim
+00010700: 3d2d 312c 2073 7175 6565 7a65 6469 6d3d  =-1, squeezedim=
+00010710: 5472 7565 290a 2020 2020 2020 2020 2320  True).        # 
+00010720: 7365 6c66 2e69 6e64 6963 6573 203d 2069  self.indices = i
+00010730: 6e64 6963 6573 5f74 7570 6c65 2069 6620  ndices_tuple if 
+00010740: 6c65 6e28 6469 6d29 203e 2031 2065 6c73  len(dim) > 1 els
+00010750: 6520 696e 6469 6365 735f 7475 706c 655b  e indices_tuple[
+00010760: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
+00010770: 7661 6c75 6573 203d 2073 656c 660a 2020  values = self.  
+00010780: 2020 2020 2020 6966 206f 7574 2069 7320        if out is 
+00010790: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+000107a0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+000107b0: 6e63 6528 6f75 742c 2074 7570 6c65 293a  nce(out, tuple):
+000107c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000107d0: 206f 7574 5b30 5d2e 7a65 726f 5f28 292e   out[0].zero_().
+000107e0: 6164 645f 2873 656c 662e 7661 6c75 6573  add_(self.values
+000107f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010800: 2020 6966 206c 656e 286f 7574 2920 3e20    if len(out) > 
+00010810: 313a 206f 7574 5b31 5d2e 7a65 726f 5f28  1: out[1].zero_(
+00010820: 292e 6164 645f 2873 656c 662e 696e 6469  ).add_(self.indi
+00010830: 6365 7329 0a20 2020 2020 2020 2020 2020  ces).           
+00010840: 2065 6c73 653a 206f 7574 2e7a 6572 6f5f   else: out.zero_
+00010850: 2829 2e61 6464 5f28 7365 6c66 2e76 616c  ().add_(self.val
+00010860: 7565 7329 0a20 2020 2020 2020 2072 6574  ues).        ret
+00010870: 7572 6e20 7365 6c66 0a0a 6465 6620 6d69  urn self..def mi
+00010880: 6e28 696e 7075 743a 2027 5465 6e73 6f72  n(input: 'Tensor
+00010890: 272c 202a 6469 6d2c 206b 6565 7064 696d  ', *dim, keepdim
+000108a0: 3d46 616c 7365 2c20 6f75 743d 4e6f 6e65  =False, out=None
+000108b0: 293a 0a20 2020 2072 6574 7572 6e20 5f5f  ):.    return __
+000108c0: 696e 6465 7865 645f 7265 6475 6365 5f5f  indexed_reduce__
+000108d0: 2827 6d69 6e27 2c20 696e 7075 742c 202a  ('min', input, *
+000108e0: 6469 6d2c 206b 6565 7064 696d 3d6b 6565  dim, keepdim=kee
+000108f0: 7064 696d 2c20 2a2a 6469 6374 286f 7574  pdim, **dict(out
+00010900: 3d6f 7574 2920 6966 206c 6f63 616c 7328  =out) if locals(
+00010910: 292e 6765 7428 276f 7574 272c 204e 6f6e  ).get('out', Non
+00010920: 6529 2069 7320 6e6f 7420 4e6f 6e65 2065  e) is not None e
+00010930: 6c73 6520 7b7d 2920 2320 7375 7070 7265  lse {}) # suppre
+00010940: 7373 3a20 7370 6563 6961 6c5f 6672 6f6d  ss: special_from
+00010950: 0a64 6566 206d 6178 2869 6e70 7574 3a20  .def max(input: 
+00010960: 2754 656e 736f 7227 2c20 2a64 696d 2c20  'Tensor', *dim, 
+00010970: 6b65 6570 6469 6d3d 4661 6c73 652c 206f  keepdim=False, o
+00010980: 7574 3d4e 6f6e 6529 3a0a 2020 2020 7265  ut=None):.    re
+00010990: 7475 726e 205f 5f69 6e64 6578 6564 5f72  turn __indexed_r
+000109a0: 6564 7563 655f 5f28 276d 6178 272c 2069  educe__('max', i
+000109b0: 6e70 7574 2c20 2a64 696d 2c20 6b65 6570  nput, *dim, keep
+000109c0: 6469 6d3d 6b65 6570 6469 6d2c 202a 2a64  dim=keepdim, **d
+000109d0: 6963 7428 6f75 743d 6f75 7429 2069 6620  ict(out=out) if 
+000109e0: 6c6f 6361 6c73 2829 2e67 6574 2827 6f75  locals().get('ou
+000109f0: 7427 2c20 4e6f 6e65 2920 6973 206e 6f74  t', None) is not
+00010a00: 204e 6f6e 6520 656c 7365 207b 7d29 2023   None else {}) #
+00010a10: 2073 7570 7072 6573 733a 2073 7065 6369   suppress: speci
+00010a20: 616c 5f66 726f 6d0a 6465 6620 6d65 6469  al_from.def medi
+00010a30: 616e 2869 6e70 7574 3a20 2754 656e 736f  an(input: 'Tenso
+00010a40: 7227 2c20 2a64 696d 2c20 6b65 6570 6469  r', *dim, keepdi
+00010a50: 6d3d 4661 6c73 652c 206f 7574 3d4e 6f6e  m=False, out=Non
+00010a60: 6529 3a0a 2020 2020 7265 7475 726e 205f  e):.    return _
+00010a70: 5f69 6e64 6578 6564 5f72 6564 7563 655f  _indexed_reduce_
+00010a80: 5f28 276d 6564 6961 6e27 2c20 696e 7075  _('median', inpu
+00010a90: 742c 202a 6469 6d2c 206b 6565 7064 696d  t, *dim, keepdim
+00010aa0: 3d6b 6565 7064 696d 2c20 2a2a 6469 6374  =keepdim, **dict
+00010ab0: 286f 7574 3d6f 7574 2920 6966 206c 6f63  (out=out) if loc
+00010ac0: 616c 7328 292e 6765 7428 276f 7574 272c  als().get('out',
+00010ad0: 204e 6f6e 6529 2069 7320 6e6f 7420 4e6f   None) is not No
+00010ae0: 6e65 2065 6c73 6520 7b7d 2920 2320 7375  ne else {}) # su
+00010af0: 7070 7265 7373 3a20 7370 6563 6961 6c5f  ppress: special_
+00010b00: 6672 6f6d 0a64 6566 2063 756d 6d69 6e28  from.def cummin(
+00010b10: 696e 7075 743a 2027 5465 6e73 6f72 272c  input: 'Tensor',
+00010b20: 2064 696d 3a20 6578 6973 745f 6469 6d5b   dim: exist_dim[
+00010b30: 315d 3d4e 6f6e 652c 202a 2c20 6f75 743d  1]=None, *, out=
+00010b40: 4e6f 6e65 293a 0a20 2020 2072 6574 7572  None):.    retur
+00010b50: 6e20 5f5f 696e 6465 7865 645f 7265 6475  n __indexed_redu
+00010b60: 6365 5f5f 2827 6375 6d6d 696e 272c 2069  ce__('cummin', i
+00010b70: 6e70 7574 2c20 2a64 696d 2c20 2a2a 6469  nput, *dim, **di
+00010b80: 6374 286f 7574 3d6f 7574 2920 6966 206c  ct(out=out) if l
+00010b90: 6f63 616c 7328 292e 6765 7428 276f 7574  ocals().get('out
+00010ba0: 272c 204e 6f6e 6529 2069 7320 6e6f 7420  ', None) is not 
+00010bb0: 4e6f 6e65 2065 6c73 6520 7b7d 2920 2320  None else {}) # 
+00010bc0: 7375 7070 7265 7373 3a20 7370 6563 6961  suppress: specia
+00010bd0: 6c5f 6672 6f6d 0a64 6566 2063 756d 6d61  l_from.def cumma
+00010be0: 7828 696e 7075 743a 2027 5465 6e73 6f72  x(input: 'Tensor
+00010bf0: 272c 2064 696d 3a20 6578 6973 745f 6469  ', dim: exist_di
+00010c00: 6d5b 315d 3d4e 6f6e 652c 202a 2c20 6f75  m[1]=None, *, ou
+00010c10: 743d 4e6f 6e65 293a 0a20 2020 2072 6574  t=None):.    ret
+00010c20: 7572 6e20 5f5f 696e 6465 7865 645f 7265  urn __indexed_re
+00010c30: 6475 6365 5f5f 2827 6375 6d6d 6178 272c  duce__('cummax',
+00010c40: 2069 6e70 7574 2c20 2a64 696d 2c20 2a2a   input, *dim, **
+00010c50: 6469 6374 286f 7574 3d6f 7574 2920 6966  dict(out=out) if
+00010c60: 206c 6f63 616c 7328 292e 6765 7428 276f   locals().get('o
+00010c70: 7574 272c 204e 6f6e 6529 2069 7320 6e6f  ut', None) is no
+00010c80: 7420 4e6f 6e65 2065 6c73 6520 7b7d 2920  t None else {}) 
+00010c90: 2320 7375 7070 7265 7373 3a20 7370 6563  # suppress: spec
+00010ca0: 6961 6c5f 6672 6f6d 0a64 6566 2061 7267  ial_from.def arg
+00010cb0: 6d69 6e28 696e 7075 743a 2027 5465 6e73  min(input: 'Tens
+00010cc0: 6f72 272c 202a 6469 6d2c 206b 6565 7064  or', *dim, keepd
+00010cd0: 696d 3d46 616c 7365 293a 0a20 2020 2072  im=False):.    r
+00010ce0: 6574 7572 6e20 5f5f 696e 6465 7865 645f  eturn __indexed_
+00010cf0: 7265 6475 6365 5f5f 2827 6d69 6e27 2c20  reduce__('min', 
+00010d00: 696e 7075 742c 202a 6469 6d2c 206b 6565  input, *dim, kee
+00010d10: 7064 696d 3d6b 6565 7064 696d 2c20 7265  pdim=keepdim, re
+00010d20: 745f 696e 6465 785f 6f6e 6c79 3d54 7275  t_index_only=Tru
+00010d30: 6529 2023 2073 7570 7072 6573 733a 2073  e) # suppress: s
+00010d40: 7065 6369 616c 5f66 726f 6d0a 6465 6620  pecial_from.def 
+00010d50: 6172 676d 6178 2869 6e70 7574 3a20 2754  argmax(input: 'T
+00010d60: 656e 736f 7227 2c20 2a64 696d 2c20 6b65  ensor', *dim, ke
+00010d70: 6570 6469 6d3d 4661 6c73 6529 3a0a 2020  epdim=False):.  
+00010d80: 2020 7265 7475 726e 205f 5f69 6e64 6578    return __index
+00010d90: 6564 5f72 6564 7563 655f 5f28 276d 6178  ed_reduce__('max
+00010da0: 272c 2069 6e70 7574 2c20 2a64 696d 2c20  ', input, *dim, 
+00010db0: 6b65 6570 6469 6d3d 6b65 6570 6469 6d2c  keepdim=keepdim,
+00010dc0: 2072 6574 5f69 6e64 6578 5f6f 6e6c 793d   ret_index_only=
+00010dd0: 5472 7565 2920 2320 7375 7070 7265 7373  True) # suppress
+00010de0: 3a20 7370 6563 6961 6c5f 6672 6f6d 0a0a  : special_from..
+00010df0: 2320 736c 6963 696e 6720 6675 6e63 7469  # slicing functi
+00010e00: 6f6e 730a 6465 6620 7370 6c69 7428 7365  ons.def split(se
+00010e10: 6c66 2c20 7370 6c69 745f 7369 7a65 3a20  lf, split_size: 
+00010e20: 696e 743d 312c 2064 696d 3a20 6578 6973  int=1, dim: exis
+00010e30: 745f 6469 6d5b 315d 203d 207b 7d2c 2073  t_dim[1] = {}, s
+00010e40: 7175 6565 7a65 6469 6d3d 4661 6c73 6529  queezedim=False)
+00010e50: 3a0a 2020 2020 2222 220a 2020 2020 7370  :.    """.    sp
+00010e60: 6c69 7428 7365 6c66 2c20 7370 6c69 745f  lit(self, split_
+00010e70: 7369 7a65 3a20 696e 743d 312c 2064 696d  size: int=1, dim
+00010e80: 3a20 6578 6973 745f 6469 6d20 3d20 7b7d  : exist_dim = {}
+00010e90: 2920 2d3e 2054 656e 736f 720a 2020 2020  ) -> Tensor.    
+00010ea0: 5370 6c69 7420 6120 7465 6e73 6f72 2069  Split a tensor i
+00010eb0: 6e74 6f20 6120 7475 706c 6520 6f66 2074  nto a tuple of t
+00010ec0: 656e 736f 7273 2c20 616c 6f6e 6720 6064  ensors, along `d
+00010ed0: 696d 602c 2077 6974 6820 7370 6c69 745f  im`, with split_
+00010ee0: 7369 7a65 2066 6f72 2065 6163 6820 7465  size for each te
+00010ef0: 6e73 6f72 2e0a 0a20 2020 2041 7267 733a  nsor...    Args:
+00010f00: 0a20 2020 2020 2020 2073 706c 6974 5f73  .        split_s
+00010f10: 697a 6520 2869 6e74 206f 7220 6c69 7374  ize (int or list
+00010f20: 2c20 6f70 7469 6f6e 616c 293a 2054 6865  , optional): The
+00010f30: 2073 706c 6974 2073 697a 6520 666f 7220   split size for 
+00010f40: 6561 6368 2074 656e 736f 722c 2075 7369  each tensor, usi
+00010f50: 6e67 2061 206c 6973 7420 6f66 2069 6e74  ng a list of int
+00010f60: 6567 6572 7320 6164 6469 6e67 2075 7020  egers adding up 
+00010f70: 746f 2073 697a 6520 746f 2073 706c 6974  to size to split
+00010f80: 2074 6865 2064 696d 656e 7369 6f6e 2061   the dimension a
+00010f90: 6363 6f72 6469 6e67 6c79 2e20 4465 6661  ccordingly. Defa
+00010fa0: 756c 7473 2074 6f20 312e 0a20 2020 2020  ults to 1..     
+00010fb0: 2020 2064 696d 2028 696e 742f 6578 6973     dim (int/exis
+00010fc0: 745f 6469 6d2c 206f 7074 696f 6e61 6c29  t_dim, optional)
+00010fd0: 3a20 5468 6520 6469 6d65 6e73 696f 6e20  : The dimension 
+00010fe0: 746f 2073 706c 6974 2061 6c6f 6e67 2e20  to split along. 
+00010ff0: 4465 6661 756c 7473 2074 6f20 6261 7463  Defaults to batc
+00011000: 682e 0a20 2020 2022 2222 0a20 2020 2064  h..    """.    d
+00011010: 696d 203d 2064 696d 5b30 5d0a 2020 2020  im = dim[0].    
+00011020: 7769 7468 2074 6f72 6368 2e5f 432e 4469  with torch._C.Di
+00011030: 7361 626c 6554 6f72 6368 4675 6e63 7469  sableTorchFuncti
+00011040: 6f6e 2829 3a0a 2020 2020 2020 2020 6966  on():.        if
+00011050: 2073 7175 6565 7a65 6469 6d3a 0a20 2020   squeezedim:.   
+00011060: 2020 2020 2020 2020 2061 766f 7563 6828           avouch(
+00011070: 7370 6c69 745f 7369 7a65 203d 3d20 3120  split_size == 1 
+00011080: 6f72 2061 6c6c 5f28 7320 3d3d 2031 2066  or all_(s == 1 f
+00011090: 6f72 2073 2069 6e20 7370 6c69 745f 7369  or s in split_si
+000110a0: 7a65 292c 2054 7970 6545 7272 6f72 2822  ze), TypeError("
+000110b0: 4b65 7977 6f72 6420 6172 6775 6d65 6e74  Keyword argument
+000110c0: 2027 7371 7565 657a 6564 696d 2720 6973   'squeezedim' is
+000110d0: 206f 6e6c 7920 6163 7469 7665 2066 6f72   only active for
+000110e0: 2027 7370 6c69 745f 7369 7a65 3d31 2720   'split_size=1' 
+000110f0: 696e 2062 742e 5465 6e73 6f72 2e73 706c  in bt.Tensor.spl
+00011100: 6974 2e20 2229 290a 2020 2020 2020 2020  it. ")).        
+00011110: 2020 2020 7265 7475 726e 2074 7570 6c65      return tuple
+00011120: 2878 2e61 735f 7375 6263 6c61 7373 2854  (x.as_subclass(T
+00011130: 656e 736f 7229 2e73 7065 6369 616c 5f66  ensor).special_f
+00011140: 726f 6d28 7365 6c66 292e 7371 7565 657a  rom(self).squeez
+00011150: 655f 2864 696d 2920 666f 7220 7820 696e  e_(dim) for x in
+00011160: 2074 6f72 6368 5f73 7570 6572 2873 656c   torch_super(sel
+00011170: 662c 2027 7370 6c69 7427 2928 7370 6c69  f, 'split')(spli
+00011180: 745f 7369 7a65 2c20 6469 6d29 290a 2020  t_size, dim)).  
+00011190: 2020 2020 2020 656c 7365 3a20 7265 7475        else: retu
+000111a0: 726e 2074 7570 6c65 2878 2e61 735f 7375  rn tuple(x.as_su
+000111b0: 6263 6c61 7373 2854 656e 736f 7229 2e73  bclass(Tensor).s
+000111c0: 7065 6369 616c 5f66 726f 6d28 7365 6c66  pecial_from(self
+000111d0: 2920 666f 7220 7820 696e 2074 6f72 6368  ) for x in torch
+000111e0: 5f73 7570 6572 2873 656c 662c 2027 7370  _super(self, 'sp
+000111f0: 6c69 7427 2928 7370 6c69 745f 7369 7a65  lit')(split_size
+00011200: 2c20 6469 6d29 290a 0a64 6566 2073 616d  , dim))..def sam
+00011210: 706c 6528 7365 6c66 2c20 6e75 6d62 6572  ple(self, number
+00011220: 3a20 696e 7420 3d20 312c 2064 696d 3a20  : int = 1, dim: 
+00011230: 6578 6973 745f 6469 6d20 3d20 7b7d 2c20  exist_dim = {}, 
+00011240: 7261 6e64 6f6d 3a20 626f 6f6c 203d 2054  random: bool = T
+00011250: 7275 6529 3a0a 2020 2020 2222 220a 2020  rue):.    """.  
+00011260: 2020 7361 6d70 6c65 2873 656c 662c 206e    sample(self, n
+00011270: 756d 6264 6572 3a20 696e 7420 3d20 312c  umbder: int = 1,
+00011280: 2064 696d 3a20 696e 7420 3d20 7365 6c66   dim: int = self
+00011290: 2e62 6174 6368 5f64 696d 656e 7369 6f6e  .batch_dimension
+000112a0: 2c20 7261 6e64 6f6d 3a20 626f 6f6c 203d  , random: bool =
+000112b0: 2054 7275 6529 202d 3e20 5465 6e73 6f72   True) -> Tensor
+000112c0: 0a0a 2020 2020 5361 6d70 6c65 2060 6e75  ..    Sample `nu
+000112d0: 6d62 6572 6020 6f66 2073 6c69 6365 7320  mber` of slices 
+000112e0: 6672 6f6d 2061 2067 6976 656e 2064 696d  from a given dim
+000112f0: 656e 7369 6f6e 2e0a 2020 2020 0a20 2020  ension..    .   
+00011300: 2041 7267 733a 0a20 2020 2020 2020 206e   Args:.        n
+00011310: 756d 6265 7220 2869 6e74 2c20 6f70 7469  umber (int, opti
+00011320: 6f6e 616c 293a 2074 6865 206e 756d 6265  onal): the numbe
+00011330: 7220 6f66 2073 6c69 6365 732e 2044 6566  r of slices. Def
+00011340: 6175 6c74 7320 746f 2060 3160 2e0a 2020  aults to `1`..  
+00011350: 2020 2020 2020 6469 6d20 2869 6e74 2f65        dim (int/e
+00011360: 7869 7374 5f64 696d 2c20 6b65 7977 6f72  xist_dim, keywor
+00011370: 6420 6172 6775 6d65 6e74 293a 2074 6865  d argument): the
+00011380: 2064 696d 656e 7369 6f6e 2074 6f20 736c   dimension to sl
+00011390: 6963 6520 6f72 2073 656c 6563 742e 2044  ice or select. D
+000113a0: 6566 6175 6c74 7320 746f 2062 6174 6368  efaults to batch
+000113b0: 2064 696d 656e 7369 6f6e 2e0a 2020 2020   dimension..    
+000113c0: 2020 2020 7261 6e64 6f6d 2028 626f 6f6c      random (bool
+000113d0: 2c20 6f70 7469 6f6e 616c 293a 2077 6865  , optional): whe
+000113e0: 7468 6572 2074 6f20 7261 6e64 6f6d 6c79  ther to randomly
+000113f0: 2070 6963 6b20 7468 6520 736c 6963 6573   pick the slices
+00011400: 206f 7220 6e6f 742e 2044 6566 6175 6c74   or not. Default
+00011410: 7320 746f 2054 7275 652e 0a20 2020 200a  s to True..    .
+00011420: 2020 2020 4e6f 7465 3a0a 2020 2020 2020      Note:.      
+00011430: 2020 5573 696e 6720 6073 616d 706c 6528    Using `sample(
+00011440: 6e75 6d2c 2064 696d 2960 2066 6f72 2064  num, dim)` for d
+00011450: 6174 6120 6f66 2073 697a 6520 286e 5f31  ata of size (n_1
+00011460: 2c20 6e5f 322c 202e 2e2e 2c20 6e5f 7229  , n_2, ..., n_r)
+00011470: 2077 6f75 6c64 2072 6573 756c 7420 696e   would result in
+00011480: 0a20 2020 2020 2020 2020 2020 2061 2074  .            a t
+00011490: 656e 736f 7220 6f66 2073 697a 6520 286e  ensor of size (n
+000114a0: 5f31 2c20 6e5f 322c 202e 2e2e 2c20 6e5f  _1, n_2, ..., n_
+000114b0: 7b64 696d 2d31 7d2c 206e 756d 2c20 6e5f  {dim-1}, num, n_
+000114c0: 7b64 696d 2b31 7d2c 202e 2e2e 2c20 6e5f  {dim+1}, ..., n_
+000114d0: 7229 0a20 2020 200a 2020 2020 4578 616d  r).    .    Exam
+000114e0: 706c 6573 3a3a 0a20 2020 2020 2020 203e  ples::.        >
+000114f0: 3e3e 2064 6174 612e 7368 6170 650a 2020  >> data.shape.  
+00011500: 2020 2020 2020 6261 746f 7263 682e 5369        batorch.Si
+00011510: 7a65 285b 342c 2033 5d2c 2035 2c20 3629  ze([4, 3], 5, 6)
+00011520: 0a20 2020 2020 2020 203e 3e3e 2064 6174  .        >>> dat
+00011530: 612e 7361 6d70 6c65 2831 2c20 322c 2072  a.sample(1, 2, r
+00011540: 616e 646f 6d3d 4661 6c73 6529 2e73 6861  andom=False).sha
+00011550: 7065 0a20 2020 2020 2020 2062 6174 6f72  pe.        bator
+00011560: 6368 2e53 697a 6528 5b34 2c20 335d 2c20  ch.Size([4, 3], 
+00011570: 312c 2036 290a 2020 2020 2020 2020 3e3e  1, 6).        >>
+00011580: 3e20 2320 5468 6520 6162 6f76 6520 6973  > # The above is
+00011590: 2065 7175 6976 616c 616e 7420 746f 2064   equivalant to d
+000115a0: 6174 615b 3a2c 203a 2c20 3a31 2c20 2e2e  ata[:, :, :1, ..
+000115b0: 2e5d 2e73 6861 7065 2e0a 2020 2020 2020  .].shape..      
+000115c0: 2020 3e3e 3e20 6461 7461 2e73 616d 706c    >>> data.sampl
+000115d0: 6528 372c 205b 5d2c 2072 616e 646f 6d3d  e(7, [], random=
+000115e0: 4661 6c73 6529 2e73 6861 7065 0a20 2020  False).shape.   
+000115f0: 2020 2020 2062 6174 6f72 6368 2e53 697a       batorch.Siz
+00011600: 6528 372c 2035 2c20 3629 0a20 2020 2020  e(7, 5, 6).     
+00011610: 2020 203e 3e3e 2023 2054 6865 2061 626f     >>> # The abo
+00011620: 7665 2069 7320 6571 7569 7661 6c61 6e74  ve is equivalant
+00011630: 2074 6f20 6461 7461 2e66 6c61 7474 656e   to data.flatten
+00011640: 2830 2c20 3129 5b3a 375d 2e73 6861 7065  (0, 1)[:7].shape
+00011650: 2e0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
+00011660: 206c 656e 2864 696d 2920 3e20 313a 2073   len(dim) > 1: s
+00011670: 656c 6620 3d20 7365 6c66 2e6d 6572 6765  elf = self.merge
+00011680: 5f64 696d 7328 2a64 696d 2c20 7461 7267  _dims(*dim, targ
+00011690: 6574 3d64 696d 5b30 5d29 0a20 2020 2073  et=dim[0]).    s
+000116a0: 616d 706c 655f 696e 6469 6365 7320 3d20  ample_indices = 
+000116b0: 5b73 6c69 6365 284e 6f6e 6529 5d20 2a20  [slice(None)] * 
+000116c0: 7365 6c66 2e6e 5f64 696d 0a20 2020 2064  self.n_dim.    d
+000116d0: 696d 203d 2064 696d 5b30 5d0a 2020 2020  im = dim[0].    
+000116e0: 6966 2072 616e 646f 6d3a 0a20 2020 2020  if random:.     
+000116f0: 2020 2069 6d70 6f72 7420 7261 6e64 6f6d     import random
+00011700: 0a20 2020 2020 2020 206e 5f74 6f74 616c  .        n_total
+00011710: 203d 2073 656c 662e 7369 7a65 2864 696d   = self.size(dim
+00011720: 290a 2020 2020 2020 2020 6e5f 726f 756e  ).        n_roun
+00011730: 6420 3d20 6e75 6d62 6572 202f 2f20 6e5f  d = number // n_
+00011740: 746f 7461 6c0a 2020 2020 2020 2020 6e5f  total.        n_
+00011750: 7265 6d61 696e 203d 206e 756d 6265 7220  remain = number 
+00011760: 2520 6e5f 746f 7461 6c0a 2020 2020 2020  % n_total.      
+00011770: 2020 7361 6d70 6c65 7320 3d20 6361 7428    samples = cat(
+00011780: 7261 6e64 7065 726d 287b 6e5f 726f 756e  randperm({n_roun
+00011790: 647d 2c20 6e5f 746f 7461 6c2c 2064 6576  d}, n_total, dev
+000117a0: 6963 653d 7365 6c66 2e64 6576 6963 6529  ice=self.device)
+000117b0: 2e66 6c61 7474 656e 2829 2e76 6965 7728  .flatten().view(
+000117c0: 2d31 292c 2074 656e 736f 7228 7261 6e64  -1), tensor(rand
+000117d0: 6f6d 2e73 616d 706c 6528 7261 6e67 655f  om.sample(range_
+000117e0: 286e 5f74 6f74 616c 292c 206b 203d 206e  (n_total), k = n
+000117f0: 5f72 656d 6169 6e29 2c20 6465 7669 6365  _remain), device
+00011800: 3d73 656c 662e 6465 7669 6365 292c 2030  =self.device), 0
+00011810: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00011820: 2020 2020 6176 6f75 6368 286e 756d 6265      avouch(numbe
+00011830: 7220 3c3d 2073 656c 662e 7369 7a65 2864  r <= self.size(d
+00011840: 696d 292c 2054 7970 6545 7272 6f72 2866  im), TypeError(f
+00011850: 2254 6f6f 206d 616e 7920 656c 656d 656e  "Too many elemen
+00011860: 7473 206e 6565 6465 6420 746f 2062 6520  ts needed to be 
+00011870: 7361 6d70 6c65 6420 6672 6f6d 2064 696d  sampled from dim
+00011880: 656e 7369 6f6e 207b 6469 6d7d 2229 290a  ension {dim}")).
+00011890: 2020 2020 2020 2020 7361 6d70 6c65 7320          samples 
+000118a0: 3d20 7465 6e73 6f72 2872 616e 6765 5f28  = tensor(range_(
+000118b0: 6e75 6d62 6572 2929 0a20 2020 2073 616d  number)).    sam
+000118c0: 706c 655f 696e 6469 6365 735b 6469 6d5d  ple_indices[dim]
+000118d0: 203d 2073 616d 706c 6573 2e73 7065 6369   = samples.speci
+000118e0: 616c 5f66 726f 6d28 7365 6c66 2e73 6861  al_from(self.sha
+000118f0: 7065 5b64 696d 3a64 696d 2b31 5d29 0a20  pe[dim:dim+1]). 
+00011900: 2020 2072 6574 7572 6e20 7365 6c66 5b74     return self[t
+00011910: 7570 6c65 2873 616d 706c 655f 696e 6469  uple(sample_indi
+00011920: 6365 7329 5d20 2320 7375 7070 7265 7373  ces)] # suppress
+00011930: 3a20 7370 6563 6961 6c5f 6672 6f6d 0a0a  : special_from..
+00011940: 6465 6620 7069 636b 2873 656c 662c 2069  def pick(self, i
+00011950: 6e64 6578 3a20 696e 7420 3d20 4e6f 6e65  ndex: int = None
+00011960: 2c20 6469 6d3a 2065 7869 7374 5f64 696d  , dim: exist_dim
+00011970: 203d 207b 7d2c 2072 616e 646f 6d3a 2062   = {}, random: b
+00011980: 6f6f 6c20 3d20 4661 6c73 6529 3a0a 2020  ool = False):.  
+00011990: 2020 2222 220a 2020 2020 7069 636b 2873    """.    pick(s
+000119a0: 656c 662c 2069 6e64 6578 3a20 696e 7420  elf, index: int 
+000119b0: 3d20 302c 2064 696d 3a20 696e 7420 3d20  = 0, dim: int = 
+000119c0: 7365 6c66 2e62 6174 6368 5f64 696d 656e  self.batch_dimen
+000119d0: 7369 6f6e 2c20 7261 6e64 6f6d 3a20 626f  sion, random: bo
+000119e0: 6f6c 203d 2046 616c 7365 2920 2d3e 2054  ol = False) -> T
+000119f0: 656e 736f 720a 0a20 2020 2050 6963 6b20  ensor..    Pick 
+00011a00: 6f6e 6520 736c 6963 6520 6f6e 2064 696d  one slice on dim
+00011a10: 656e 7369 6f6e 2060 6469 6d60 2066 6f72  ension `dim` for
+00011a20: 2062 6967 2074 656e 736f 7273 2e20 0a20   big tensors. . 
+00011a30: 2020 200a 2020 2020 4172 6773 3a0a 2020     .    Args:.  
+00011a40: 2020 2020 2020 696e 6465 7820 2869 6e74        index (int
+00011a50: 2c20 6f70 7469 6f6e 616c 293a 2074 6865  , optional): the
+00011a60: 2073 6c69 6365 2069 6e64 6578 2074 6f20   slice index to 
+00011a70: 7069 636b 2e20 4465 6661 756c 7473 2074  pick. Defaults t
+00011a80: 6f20 604e 6f6e 6560 2e0a 2020 2020 2020  o `None`..      
+00011a90: 2020 6469 6d20 2869 6e74 2f65 7869 7374    dim (int/exist
+00011aa0: 5f64 696d 2c20 6b65 7977 6f72 6420 6172  _dim, keyword ar
+00011ab0: 6775 6d65 6e74 293a 2074 6865 2064 696d  gument): the dim
+00011ac0: 656e 7369 6f6e 2074 6f20 736c 6963 6520  ension to slice 
+00011ad0: 6f72 2073 656c 6563 742e 2044 6566 6175  or select. Defau
+00011ae0: 6c74 7320 746f 2062 6174 6368 2064 696d  lts to batch dim
+00011af0: 656e 7369 6f6e 2e0a 2020 2020 2020 2020  ension..        
+00011b00: 7261 6e64 6f6d 2028 626f 6f6c 2c20 6f70  random (bool, op
+00011b10: 7469 6f6e 616c 293a 2077 6865 7468 6572  tional): whether
+00011b20: 2074 6f20 7261 6e64 6f6d 6c79 2070 6963   to randomly pic
+00011b30: 6b20 7468 6520 736c 6963 6520 6f72 206e  k the slice or n
+00011b40: 6f74 2e20 4465 6661 756c 7473 2074 6f20  ot. Defaults to 
+00011b50: 4661 6c73 652e 0a20 2020 200a 2020 2020  False..    .    
+00011b60: 4e6f 7465 3a0a 2020 2020 2020 2020 5573  Note:.        Us
+00011b70: 696e 6720 6070 6963 6b28 696e 6465 782c  ing `pick(index,
+00011b80: 2064 696d 2960 2066 6f72 2064 6174 6120   dim)` for data 
+00011b90: 6f66 2073 697a 6520 286e 5f31 2c20 6e5f  of size (n_1, n_
+00011ba0: 322c 202e 2e2e 2c20 6e5f 7229 2077 6f75  2, ..., n_r) wou
+00011bb0: 6c64 2072 6573 756c 7420 696e 0a20 2020  ld result in.   
+00011bc0: 2020 2020 2020 2020 2061 2074 656e 736f           a tenso
+00011bd0: 7220 6f66 2073 697a 6520 286e 5f31 2c20  r of size (n_1, 
+00011be0: 6e5f 322c 202e 2e2e 2c20 6e5f 7b64 696d  n_2, ..., n_{dim
+00011bf0: 2d31 7d2c 206e 5f7b 6469 6d2b 317d 2c20  -1}, n_{dim+1}, 
+00011c00: 2e2e 2e2c 206e 5f72 290a 2020 2020 0a20  ..., n_r).    . 
+00011c10: 2020 2045 7861 6d70 6c65 733a 3a0a 2020     Examples::.  
+00011c20: 2020 2020 2020 3e3e 3e20 6461 7461 2e73        >>> data.s
+00011c30: 6861 7065 0a20 2020 2020 2020 2062 6174  hape.        bat
+00011c40: 6f72 6368 2e53 697a 6528 342c 2033 2c20  orch.Size(4, 3, 
+00011c50: 352c 2036 290a 2020 2020 2020 2020 3e3e  5, 6).        >>
+00011c60: 3e20 6461 7461 2e70 6963 6b28 2d31 2c20  > data.pick(-1, 
+00011c70: 322c 2072 616e 646f 6d3d 4661 6c73 6529  2, random=False)
+00011c80: 2e73 6861 7065 0a20 2020 2020 2020 2062  .shape.        b
+00011c90: 6174 6f72 6368 2e53 697a 6528 342c 2033  atorch.Size(4, 3
+00011ca0: 2c20 3629 0a20 2020 2020 2020 203e 3e3e  , 6).        >>>
+00011cb0: 2023 2054 6865 2061 626f 7665 2069 7320   # The above is 
+00011cc0: 6571 7569 7661 6c61 6e74 2074 6f20 6461  equivalant to da
+00011cd0: 7461 5b3a 2c20 3a2c 2034 2c20 2e2e 2e5d  ta[:, :, 4, ...]
+00011ce0: 2e73 6861 7065 2e0a 2020 2020 2222 220a  .shape..    """.
+00011cf0: 2020 2020 6966 206c 656e 2864 696d 2920      if len(dim) 
+00011d00: 3e20 313a 2073 656c 6620 3d20 7365 6c66  > 1: self = self
+00011d10: 2e6d 6572 6765 5f64 696d 7328 2a64 696d  .merge_dims(*dim
+00011d20: 2c20 7461 7267 6574 3d64 696d 5b30 5d29  , target=dim[0])
+00011d30: 0a20 2020 2064 696d 203d 2064 696d 5b30  .    dim = dim[0
+00011d40: 5d0a 2020 2020 6966 2072 616e 646f 6d3a  ].    if random:
+00011d50: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
+00011d60: 696e 6465 7820 6973 204e 6f6e 652c 2022  index is None, "
+00011d70: 2769 6e64 6578 2720 7368 6f75 6c64 2062  'index' should b
+00011d80: 6520 4e6f 6e65 2069 6620 7261 6e64 6f6d  e None if random
+00011d90: 2070 6963 6b20 6973 2065 6e61 626c 6564   pick is enabled
+00011da0: 2e20 5573 6520 6b65 7977 6f72 6420 6172  . Use keyword ar
+00011db0: 6775 6d65 6e74 2027 6469 6d3d 7878 2720  gument 'dim=xx' 
+00011dc0: 746f 2069 6465 6e74 6966 7920 7468 6520  to identify the 
+00011dd0: 6469 6d65 6e73 696f 6e2e 2229 0a20 2020  dimension.").   
+00011de0: 2020 2020 2069 6d70 6f72 7420 7261 6e64       import rand
+00011df0: 6f6d 0a20 2020 2020 2020 2069 6e64 6578  om.        index
+00011e00: 203d 2072 616e 646f 6d2e 7261 6e64 696e   = random.randin
+00011e10: 7428 302c 2073 656c 662e 7369 7a65 2864  t(0, self.size(d
+00011e20: 696d 292d 3129 0a20 2020 2065 6c73 653a  im)-1).    else:
+00011e30: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
+00011e40: 6973 696e 7374 616e 6365 2869 6e64 6578  isinstance(index
+00011e50: 2c20 696e 745f 2920 616e 6420 2d73 656c  , int_) and -sel
+00011e60: 662e 7369 7a65 2864 696d 2920 3c3d 2069  f.size(dim) <= i
+00011e70: 6e64 6578 203c 2073 656c 662e 7369 7a65  ndex < self.size
+00011e80: 2864 696d 292c 2054 7970 6545 7272 6f72  (dim), TypeError
+00011e90: 2866 2249 6e76 616c 6964 2069 6e64 6578  (f"Invalid index
+00011ea0: 2066 6f72 2070 6963 6b69 6e67 2066 726f   for picking fro
+00011eb0: 6d20 6469 6d65 6e73 696f 6e20 7b64 696d  m dimension {dim
+00011ec0: 7d3a 207b 696e 6465 787d 2e20 2229 290a  }: {index}. ")).
+00011ed0: 2020 2020 7265 7475 726e 2073 656c 665b      return self[
+00011ee0: 2873 6c69 6365 284e 6f6e 6529 2c29 202a  (slice(None),) *
+00011ef0: 2064 696d 202b 2028 696e 6465 782c 295d   dim + (index,)]
+00011f00: 2023 2073 7570 7072 6573 733a 2073 7065   # suppress: spe
+00011f10: 6369 616c 5f66 726f 6d0a 0a64 6566 2065  cial_from..def e
+00011f20: 6967 2869 6e70 7574 3a20 2754 656e 736f  ig(input: 'Tenso
+00011f30: 7227 2c20 6469 6d3a 206c 696e 616c 675f  r', dim: linalg_
+00011f40: 6469 6d5b 325d 3d4e 6f6e 652c 206f 7574  dim[2]=None, out
+00011f50: 3d4e 6f6e 6529 3a0a 2020 2020 2222 220a  =None):.    """.
+00011f60: 2020 2020 4669 6e64 2065 6967 656e 2076      Find eigen v
+00011f70: 616c 7565 7320 616e 6420 7665 6374 6f72  alues and vector
+00011f80: 7320 666f 7220 6d61 7472 6978 2060 696e  s for matrix `in
+00011f90: 7075 7460 3a20 2866 6f72 2074 6865 2066  put`: (for the f
+00011fa0: 6972 7374 2061 7661 696c 6162 6c65 2063  irst available c
+00011fb0: 6f6e 6469 7469 6f6e 293a 0a20 2020 2028  ondition):.    (
+00011fc0: 3129 2069 6e20 6665 6174 7572 6520 6469  1) in feature di
+00011fd0: 6d65 6e73 696f 6e73 2069 6620 6d6f 7265  mensions if more
+00011fe0: 2074 6861 6e20 3244 2069 7320 6176 6169   than 2D is avai
+00011ff0: 6c61 626c 653b 200a 2020 2020 2832 2920  lable; .    (2) 
+00012000: 696e 2073 7061 6365 2064 696d 656e 7369  in space dimensi
+00012010: 6f6e 7320 6966 206d 6f72 6520 7468 616e  ons if more than
+00012020: 2032 4420 6973 2061 7661 696c 6162 6c65   2D is available
+00012030: 3b20 0a20 2020 2028 3329 2069 6e20 7365  ; .    (3) in se
+00012040: 7175 656e 6365 2064 696d 656e 7369 6f6e  quence dimension
+00012050: 7320 6966 206d 6f72 6520 7468 616e 2032  s if more than 2
+00012060: 4420 6973 2061 7661 696c 6162 6c65 2e20  D is available. 
+00012070: 0a20 2020 2022 2222 0a20 2020 2068 6173  .    """.    has
+00012080: 5f62 6174 6368 203d 2046 616c 7365 0a20  _batch = False. 
+00012090: 2020 2077 6974 6820 696e 7075 742e 6869     with input.hi
+000120a0: 6465 5f73 7065 6369 616c 2829 2c20 746f  de_special(), to
+000120b0: 7263 682e 5f43 2e44 6973 6162 6c65 546f  rch._C.DisableTo
+000120c0: 7263 6846 756e 6374 696f 6e28 293a 0a20  rchFunction():. 
+000120d0: 2020 2020 2020 2041 203d 2069 6e70 7574         A = input
+000120e0: 2e6d 6f76 655f 6469 6d28 6469 6d2c 202d  .move_dim(dim, -
+000120f0: 3129 0a20 2020 2020 2020 2069 6620 412e  1).        if A.
+00012100: 6e5f 6469 6d20 3e20 323a 2041 203d 2041  n_dim > 2: A = A
+00012110: 2e66 6c61 7474 656e 2830 2c20 2d33 293b  .flatten(0, -3);
+00012120: 2068 6173 5f62 6174 6368 203d 2054 7275   has_batch = Tru
+00012130: 650a 2020 2020 2020 2020 6966 2074 6f72  e.        if tor
+00012140: 6368 2e5f 5f76 6572 7369 6f6e 5f5f 203e  ch.__version__ >
+00012150: 3d20 5665 7273 696f 6e28 2731 2e31 3027  = Version('1.10'
+00012160: 293a 0a20 2020 2020 2020 2020 2020 204c  ):.            L
+00012170: 2c20 5620 3d20 746f 7263 682e 6c69 6e61  , V = torch.lina
+00012180: 6c67 2e65 6967 2841 290a 2020 2020 2020  lg.eig(A).      
+00012190: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000121a0: 2020 2020 4b2c 2050 203d 2074 6f72 6368      K, P = torch
+000121b0: 2e65 6967 2841 2c20 6569 6765 6e76 6563  .eig(A, eigenvec
+000121c0: 746f 7273 3d54 7275 6529 0a20 2020 2020  tors=True).     
+000121d0: 2020 2020 2020 204c 203d 2074 6f72 6368         L = torch
+000121e0: 2e63 6f6d 706c 6578 284b 5b3a 2c20 305d  .complex(K[:, 0]
+000121f0: 2c20 4b5b 3a2c 2031 5d29 0a20 2020 2020  , K[:, 1]).     
+00012200: 2020 2020 2020 2056 7220 3d20 746f 7263         Vr = torc
+00012210: 682e 7768 6572 6528 284b 5b3a 2c20 315d  h.where((K[:, 1]
+00012220: 203c 2030 292e 7265 7368 6170 6528 2831   < 0).reshape((1
+00012230: 2c20 2d31 2929 2c20 746f 7263 682e 6361  , -1)), torch.ca
+00012240: 7428 2850 5b3a 2c20 3a31 5d2c 2050 5b3a  t((P[:, :1], P[:
+00012250: 2c20 3a2d 315d 292c 2031 292c 2050 290a  , :-1]), 1), P).
+00012260: 2020 2020 2020 2020 2020 2020 5669 203d              Vi =
+00012270: 2028 4b5b 3a2c 2031 5d20 3e20 3029 2e72   (K[:, 1] > 0).r
+00012280: 6573 6861 7065 2828 312c 202d 3129 2920  eshape((1, -1)) 
+00012290: 2a20 746f 7263 682e 6361 7428 2850 5b3a  * torch.cat((P[:
+000122a0: 2c20 313a 5d2c 2050 5b3a 2c20 2d31 3a5d  , 1:], P[:, -1:]
+000122b0: 292c 2031 2920 2d20 284b 5b3a 2c20 315d  ), 1) - (K[:, 1]
+000122c0: 203c 2030 292e 7265 7368 6170 6528 2831   < 0).reshape((1
+000122d0: 2c20 2d31 2929 202a 2050 0a20 2020 2020  , -1)) * P.     
+000122e0: 2020 2020 2020 2056 203d 2074 6f72 6368         V = torch
+000122f0: 2e63 6f6d 706c 6578 2856 722c 2056 6929  .complex(Vr, Vi)
+00012300: 0a20 2020 2020 2020 204c 203d 204c 2e61  .        L = L.a
+00012310: 735f 7375 6263 6c61 7373 2854 656e 736f  s_subclass(Tenso
+00012320: 7229 2e69 6e69 745f 7370 6563 6961 6c28  r).init_special(
+00012330: 290a 2020 2020 2020 2020 5620 3d20 562e  ).        V = V.
+00012340: 6173 5f73 7562 636c 6173 7328 5465 6e73  as_subclass(Tens
+00012350: 6f72 292e 696e 6974 5f73 7065 6369 616c  or).init_special
+00012360: 2829 0a20 2020 2064 696d 5f74 7970 6520  ().    dim_type 
+00012370: 3d20 696e 7075 742e 7368 6170 655b 6469  = input.shape[di
+00012380: 6d5b 305d 3a64 696d 5b30 5d2b 315d 0a20  m[0]:dim[0]+1]. 
+00012390: 2020 2069 6620 6861 735f 6261 7463 683a     if has_batch:
+000123a0: 0a20 2020 2020 2020 204c 203d 204c 2e73  .        L = L.s
+000123b0: 706c 6974 5f64 696d 2830 2c20 7265 6d6f  plit_dim(0, remo
+000123c0: 7665 5f64 696d 2869 6e70 7574 2e73 6861  ve_dim(input.sha
+000123d0: 7065 2c20 6469 6d29 290a 2020 2020 2020  pe, dim)).      
+000123e0: 2020 5620 3d20 562e 7370 6c69 745f 6469    V = V.split_di
+000123f0: 6d28 302c 2072 656d 6f76 655f 6469 6d28  m(0, remove_dim(
+00012400: 696e 7075 742e 7368 6170 652c 2064 696d  input.shape, dim
+00012410: 2929 0a20 2020 204c 203d 204c 2e6d 6f76  )).    L = L.mov
+00012420: 655f 6469 6d28 2d31 2c20 6469 6d5b 305d  e_dim(-1, dim[0]
+00012430: 292e 6164 645f 7370 6563 6961 6c5f 6469  ).add_special_di
+00012440: 6d28 6469 6d5b 305d 2c20 6469 6d5f 7479  m(dim[0], dim_ty
+00012450: 7065 290a 2020 2020 5620 3d20 562e 6d6f  pe).    V = V.mo
+00012460: 7665 5f64 696d 285b 2d32 2c20 2d31 5d2c  ve_dim([-2, -1],
+00012470: 2064 696d 292e 6164 645f 7370 6563 6961   dim).add_specia
+00012480: 6c5f 6469 6d28 6469 6d5b 305d 2c20 6469  l_dim(dim[0], di
+00012490: 6d5f 7479 7065 292e 6164 645f 7370 6563  m_type).add_spec
+000124a0: 6961 6c5f 6469 6d28 6469 6d5b 305d 2b31  ial_dim(dim[0]+1
+000124b0: 2c20 6469 6d5f 7479 7065 290a 2020 2020  , dim_type).    
+000124c0: 7265 7475 726e 204c 2c20 5620 2320 7375  return L, V # su
+000124d0: 7070 7265 7373 3a20 7370 6563 6961 6c5f  ppress: special_
+000124e0: 6672 6f6d 0a0a 6465 6620 6d61 746d 756c  from..def matmul
+000124f0: 2869 6e70 7574 3a20 2754 656e 736f 7227  (input: 'Tensor'
+00012500: 2c20 6f74 6865 723a 2027 5465 6e73 6f72  , other: 'Tensor
+00012510: 272c 202a 2c20 6469 6d31 3d4e 6f6e 652c  ', *, dim1=None,
+00012520: 2064 696d 323d 4e6f 6e65 2c20 6f75 743d   dim2=None, out=
+00012530: 4e6f 6e65 293a 0a20 2020 2022 2222 7065  None):.    """pe
+00012540: 7266 6f72 6d20 6d61 746d 756c 2066 6f72  rform matmul for
+00012550: 2074 6865 2062 6573 7420 6c69 6e65 6172   the best linear
+00012560: 2064 696d 656e 7369 6f6e 732c 206a 7573   dimensions, jus
+00012570: 746c 696b 6520 6f74 6865 7220 6d61 742a  tlike other mat*
+00012580: 2a20 6675 6e63 7469 6f6e 7320 646f 2e20  * functions do. 
+00012590: 2222 220a 2020 2020 6966 2069 6e70 7574  """.    if input
+000125a0: 2e68 6173 5f66 6561 7475 7265 2061 6e64  .has_feature and
+000125b0: 206f 7468 6572 2e68 6173 5f66 6561 7475   other.has_featu
+000125c0: 7265 3a0a 2020 2020 2020 2020 6469 6d31  re:.        dim1
+000125d0: 203d 2065 7869 7374 5f64 696d 2869 6e70   = exist_dim(inp
+000125e0: 7574 2c20 5b5d 290a 2020 2020 2020 2020  ut, []).        
+000125f0: 6469 6d32 203d 2065 7869 7374 5f64 696d  dim2 = exist_dim
+00012600: 286f 7468 6572 2c20 5b5d 290a 2020 2020  (other, []).    
+00012610: 656c 6966 2069 6e70 7574 2e68 6173 5f73  elif input.has_s
+00012620: 7061 6365 2061 6e64 206f 7468 6572 2e68  pace and other.h
+00012630: 6173 5f73 7061 6365 3a0a 2020 2020 2020  as_space:.      
+00012640: 2020 6469 6d31 203d 2065 7869 7374 5f64    dim1 = exist_d
+00012650: 696d 2869 6e70 7574 2c20 2e2e 2e29 0a20  im(input, ...). 
+00012660: 2020 2020 2020 2064 696d 3220 3d20 6578         dim2 = ex
+00012670: 6973 745f 6469 6d28 6f74 6865 722c 202e  ist_dim(other, .
+00012680: 2e2e 290a 2020 2020 656c 6966 2069 6e70  ..).    elif inp
+00012690: 7574 2e68 6173 5f73 6571 7565 6e63 6520  ut.has_sequence 
+000126a0: 616e 6420 6f74 6865 722e 6861 735f 7365  and other.has_se
+000126b0: 7175 656e 6365 3a0a 2020 2020 2020 2020  quence:.        
+000126c0: 6469 6d31 203d 2065 7869 7374 5f64 696d  dim1 = exist_dim
+000126d0: 2869 6e70 7574 2c20 2727 290a 2020 2020  (input, '').    
+000126e0: 2020 2020 6469 6d32 203d 2065 7869 7374      dim2 = exist
+000126f0: 5f64 696d 286f 7468 6572 2c20 2727 290a  _dim(other, '').
+00012700: 2020 2020 656c 7365 3a20 7261 6973 6520      else: raise 
+00012710: 5479 7065 4572 726f 7228 6622 4361 6e6e  TypeError(f"Cann
+00012720: 6f74 2070 6572 666f 726d 206d 6174 6d75  ot perform matmu
+00012730: 6c20 616c 6967 6e6d 656e 7420 666f 7220  l alignment for 
+00012740: 7368 6170 6573 207b 696e 7075 745f 7368  shapes {input_sh
+00012750: 6170 657d 2061 6e64 207b 6f74 6865 725f  ape} and {other_
+00012760: 7368 6170 657d 2e20 2229 0a20 2020 2064  shape}. ").    d
+00012770: 696d 3120 3d20 6469 6d31 5b2d 323a 5d0a  im1 = dim1[-2:].
+00012780: 2020 2020 6469 6d32 203d 2064 696d 325b      dim2 = dim2[
+00012790: 2d32 3a5d 0a20 2020 2073 697a 6520 3d20  -2:].    size = 
+000127a0: 3220 6966 206c 656e 2864 696d 3129 203d  2 if len(dim1) =
+000127b0: 3d20 6c65 6e28 6469 6d32 2920 656c 7365  = len(dim2) else
+000127c0: 2031 0a20 2020 2069 6e70 7574 203d 2069   1.    input = i
+000127d0: 6e70 7574 2e6d 6f76 655f 6469 6d28 6469  nput.move_dim(di
+000127e0: 6d31 2c20 2d31 290a 2020 2020 6f74 6865  m1, -1).    othe
+000127f0: 7220 3d20 6f74 6865 722e 6d6f 7665 5f64  r = other.move_d
+00012800: 696d 2864 696d 322c 202d 3129 0a20 2020  im(dim2, -1).   
+00012810: 2072 6574 7572 6e20 2869 6e70 7574 2040   return (input @
+00012820: 206f 7468 6572 292e 6d6f 7665 6469 6d28   other).movedim(
+00012830: 6c69 7374 2872 616e 6765 5f28 2d73 697a  list(range_(-siz
+00012840: 652c 2030 2929 2c20 6469 6d32 5b30 5d29  e, 0)), dim2[0])
+00012850: 2023 2073 7570 7072 6573 733a 2073 7065   # suppress: spe
+00012860: 6369 616c 5f66 726f 6d0a 0a64 6566 206d  cial_from..def m
+00012870: 6174 706f 7728 696e 7075 743a 2027 5465  atpow(input: 'Te
+00012880: 6e73 6f72 272c 206b 2c20 2a2c 2064 696d  nsor', k, *, dim
+00012890: 3a20 6c69 6e61 6c67 5f64 696d 5b32 5d3d  : linalg_dim[2]=
+000128a0: 4e6f 6e65 293a 0a20 2020 2022 2222 7265  None):.    """re
+000128b0: 7475 726e 2061 206d 6174 7269 7820 706f  turn a matrix po
+000128c0: 7765 7220 6f66 2041 5e6b 2e22 2222 0a20  wer of A^k.""". 
+000128d0: 2020 204c 2c20 5620 3d20 6569 6728 696e     L, V = eig(in
+000128e0: 7075 742c 2064 696d 3d64 696d 290a 2020  put, dim=dim).  
+000128f0: 2020 4c20 3d20 4c2e 6d6f 7665 5f64 696d    L = L.move_dim
+00012900: 2864 696d 5b30 5d2c 202d 3129 0a20 2020  (dim[0], -1).   
+00012910: 2056 203d 2056 2e6d 6f76 655f 6469 6d28   V = V.move_dim(
+00012920: 6469 6d2c 202d 3129 0a20 2020 204c 5f6b  dim, -1).    L_k
+00012930: 203d 2077 6865 7265 2828 4c2e 7265 616c   = where((L.real
+00012940: 203c 2030 2920 2620 284c 2e69 6d61 672e   < 0) & (L.imag.
+00012950: 6162 7328 2920 3c20 3165 2d36 292c 202d  abs() < 1e-6), -
+00012960: 636f 6d70 6c65 7828 282d 4c2e 7265 616c  complex((-L.real
+00012970: 2920 2a2a 206b 2c20 4c2e 696d 6167 292c  ) ** k, L.imag),
+00012980: 204c 202a 2a20 6b29 0a20 2020 2052 203d   L ** k).    R =
+00012990: 2056 2040 2064 6961 6728 4c5f 6b2c 2064   V @ diag(L_k, d
+000129a0: 696d 3d2d 3129 2040 2056 2e69 6e76 2829  im=-1) @ V.inv()
+000129b0: 0a20 2020 2069 6620 522e 6973 5f63 6f6d  .    if R.is_com
+000129c0: 706c 6578 2829 2061 6e64 206e 6f74 2069  plex() and not i
+000129d0: 6e70 7574 2e69 735f 636f 6d70 6c65 7828  nput.is_complex(
+000129e0: 293a 2052 203d 2052 2e72 6561 6c0a 2020  ): R = R.real.  
+000129f0: 2020 7265 7475 726e 2052 2e6d 6f76 655f    return R.move_
+00012a00: 6469 6d28 5b2d 322c 202d 315d 2c20 6469  dim([-2, -1], di
+00012a10: 6d29 2e74 7970 6528 696e 7075 742e 6474  m).type(input.dt
+00012a20: 7970 6529 2023 2073 7570 7072 6573 733a  ype) # suppress:
+00012a30: 2073 7065 6369 616c 5f66 726f 6d0a 0a64   special_from..d
+00012a40: 6566 206d 6174 6578 7028 696e 7075 743a  ef matexp(input:
+00012a50: 2027 5465 6e73 6f72 272c 202a 2c20 6469   'Tensor', *, di
+00012a60: 6d3a 206c 696e 616c 675f 6469 6d5b 325d  m: linalg_dim[2]
+00012a70: 3d4e 6f6e 6529 3a0a 2020 2020 2222 2272  =None):.    """r
+00012a80: 6574 7572 6e20 6120 6d61 7472 6978 2065  eturn a matrix e
+00012a90: 7870 6f6e 656e 7469 616c 206f 6620 655e  xponential of e^
+00012aa0: 412e 2222 220a 2020 2020 4c2c 2056 203d  A.""".    L, V =
+00012ab0: 2065 6967 2869 6e70 7574 2c20 6469 6d3d   eig(input, dim=
+00012ac0: 6469 6d29 0a20 2020 204c 203d 204c 2e6d  dim).    L = L.m
+00012ad0: 6f76 655f 6469 6d28 6469 6d5b 305d 2c20  ove_dim(dim[0], 
+00012ae0: 2d31 290a 2020 2020 5620 3d20 562e 6d6f  -1).    V = V.mo
+00012af0: 7665 5f64 696d 2864 696d 2c20 2d31 290a  ve_dim(dim, -1).
+00012b00: 2020 2020 5220 3d20 5620 4020 6469 6167      R = V @ diag
+00012b10: 2865 7870 284c 292c 2064 696d 3d2d 3129  (exp(L), dim=-1)
+00012b20: 2040 2056 2e69 6e76 2829 0a20 2020 2069   @ V.inv().    i
+00012b30: 6620 522e 6973 5f63 6f6d 706c 6578 2829  f R.is_complex()
+00012b40: 2061 6e64 206e 6f74 2069 6e70 7574 2e69   and not input.i
+00012b50: 735f 636f 6d70 6c65 7828 293a 2052 203d  s_complex(): R =
+00012b60: 2052 2e72 6561 6c0a 2020 2020 7265 7475   R.real.    retu
+00012b70: 726e 2052 2e6d 6f76 655f 6469 6d28 5b2d  rn R.move_dim([-
+00012b80: 322c 202d 315d 2c20 6469 6d29 2e74 7970  2, -1], dim).typ
+00012b90: 6528 696e 7075 742e 6474 7970 6529 2023  e(input.dtype) #
+00012ba0: 2073 7570 7072 6573 733a 2073 7065 6369   suppress: speci
+00012bb0: 616c 5f66 726f 6d0a 0a64 6566 206d 6174  al_from..def mat
+00012bc0: 6c6f 6728 696e 7075 743a 2027 5465 6e73  log(input: 'Tens
+00012bd0: 6f72 272c 202a 2c20 6469 6d3a 206c 696e  or', *, dim: lin
+00012be0: 616c 675f 6469 6d5b 325d 3d4e 6f6e 6529  alg_dim[2]=None)
+00012bf0: 3a0a 2020 2020 2222 2272 6574 7572 6e20  :.    """return 
+00012c00: 6120 6d61 7472 6978 2065 7870 6f6e 656e  a matrix exponen
+00012c10: 7469 616c 206f 6620 655e 412e 2222 220a  tial of e^A.""".
+00012c20: 2020 2020 4c2c 2056 203d 2065 6967 2869      L, V = eig(i
+00012c30: 6e70 7574 2c20 6469 6d3d 6469 6d29 0a20  nput, dim=dim). 
+00012c40: 2020 204c 203d 204c 2e6d 6f76 655f 6469     L = L.move_di
+00012c50: 6d28 6469 6d5b 305d 2c20 2d31 290a 2020  m(dim[0], -1).  
+00012c60: 2020 5620 3d20 562e 6d6f 7665 5f64 696d    V = V.move_dim
+00012c70: 2864 696d 2c20 2d31 290a 2020 2020 5220  (dim, -1).    R 
+00012c80: 3d20 5620 4020 6469 6167 286c 6f67 284c  = V @ diag(log(L
+00012c90: 292c 2064 696d 3d2d 3129 2040 2056 2e69  ), dim=-1) @ V.i
+00012ca0: 6e76 2829 0a20 2020 2069 6620 522e 6973  nv().    if R.is
+00012cb0: 5f63 6f6d 706c 6578 2829 2061 6e64 206e  _complex() and n
+00012cc0: 6f74 2069 6e70 7574 2e69 735f 636f 6d70  ot input.is_comp
+00012cd0: 6c65 7828 293a 2052 203d 2052 2e72 6561  lex(): R = R.rea
+00012ce0: 6c0a 2020 2020 7265 7475 726e 2052 2e6d  l.    return R.m
+00012cf0: 6f76 655f 6469 6d28 5b2d 322c 202d 315d  ove_dim([-2, -1]
+00012d00: 2c20 6469 6d29 2e74 7970 6528 696e 7075  , dim).type(inpu
+00012d10: 742e 6474 7970 6529 2023 2073 7570 7072  t.dtype) # suppr
+00012d20: 6573 733a 2073 7065 6369 616c 5f66 726f  ess: special_fro
+00012d30: 6d0a 0a64 6566 2072 616e 6b28 696e 7075  m..def rank(inpu
+00012d40: 743a 2027 5465 6e73 6f72 272c 202a 2c20  t: 'Tensor', *, 
+00012d50: 6174 6f6c 3d4e 6f6e 652c 2072 746f 6c3d  atol=None, rtol=
+00012d60: 4e6f 6e65 2c20 6865 726d 6974 6961 6e3d  None, hermitian=
+00012d70: 4661 6c73 652c 2064 696d 3a20 6c69 6e61  False, dim: lina
+00012d80: 6c67 5f64 696d 5b32 5d3d 4e6f 6e65 2c20  lg_dim[2]=None, 
+00012d90: 6f75 743d 4e6f 6e65 293a 0a20 2020 2041  out=None):.    A
+00012da0: 203d 2069 6e70 7574 2e6d 6f76 655f 6469   = input.move_di
+00012db0: 6d28 6469 6d2c 202d 3129 0a20 2020 2077  m(dim, -1).    w
+00012dc0: 6974 6820 746f 7263 682e 5f43 2e44 6973  ith torch._C.Dis
+00012dd0: 6162 6c65 546f 7263 6846 756e 6374 696f  ableTorchFunctio
+00012de0: 6e28 293a 0a20 2020 2020 2020 2072 6574  n():.        ret
+00012df0: 7572 6e20 746f 7263 682e 6c69 6e61 6c67  urn torch.linalg
+00012e00: 2e6d 6174 7269 785f 7261 6e6b 2841 2c20  .matrix_rank(A, 
+00012e10: 6174 6f6c 3d61 746f 6c2c 2072 746f 6c3d  atol=atol, rtol=
+00012e20: 7274 6f6c 2c20 6865 726d 6974 6961 6e3d  rtol, hermitian=
+00012e30: 6865 726d 6974 6961 6e2c 202a 2a64 6963  hermitian, **dic
+00012e40: 7428 6f75 743d 6f75 7429 2069 6620 6c6f  t(out=out) if lo
+00012e50: 6361 6c73 2829 2e67 6574 2827 6f75 7427  cals().get('out'
+00012e60: 2c20 4e6f 6e65 2920 6973 206e 6f74 204e  , None) is not N
+00012e70: 6f6e 6520 656c 7365 207b 7d29 2e61 735f  one else {}).as_
+00012e80: 7375 6263 6c61 7373 2854 656e 736f 7229  subclass(Tensor)
+00012e90: 2e73 7065 6369 616c 5f66 726f 6d28 412e  .special_from(A.
+00012ea0: 7368 6170 655b 3a2d 325d 290a 0a64 6566  shape[:-2])..def
+00012eb0: 206d 6174 6e6f 726d 2869 6e70 7574 3a20   matnorm(input: 
+00012ec0: 2754 656e 736f 7227 2c20 6f72 643d 2766  'Tensor', ord='f
+00012ed0: 726f 272c 2064 696d 3a20 6c69 6e61 6c67  ro', dim: linalg
+00012ee0: 5f64 696d 5b32 5d3d 4e6f 6e65 2c20 6b65  _dim[2]=None, ke
+00012ef0: 6570 6469 6d3d 4661 6c73 652c 202a 2c20  epdim=False, *, 
+00012f00: 6474 7970 653d 4e6f 6e65 2c20 6f75 743d  dtype=None, out=
+00012f10: 4e6f 6e65 293a 0a20 2020 2041 203d 2069  None):.    A = i
+00012f20: 6e70 7574 2e6d 6f76 655f 6469 6d28 6469  nput.move_dim(di
+00012f30: 6d2c 202d 3129 0a20 2020 2077 6974 6820  m, -1).    with 
+00012f40: 746f 7263 682e 5f43 2e44 6973 6162 6c65  torch._C.Disable
+00012f50: 546f 7263 6846 756e 6374 696f 6e28 293a  TorchFunction():
+00012f60: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00012f70: 746f 7263 682e 6c69 6e61 6c67 2e6d 6174  torch.linalg.mat
+00012f80: 7269 785f 6e6f 726d 2841 2c20 6f72 643d  rix_norm(A, ord=
+00012f90: 6f72 642c 2064 696d 3d64 696d 2c20 6b65  ord, dim=dim, ke
+00012fa0: 6570 6469 6d3d 6b65 6570 6469 6d2c 2064  epdim=keepdim, d
+00012fb0: 7479 7065 3d64 7479 7065 2c20 2a2a 6469  type=dtype, **di
+00012fc0: 6374 286f 7574 3d6f 7574 2920 6966 206c  ct(out=out) if l
+00012fd0: 6f63 616c 7328 292e 6765 7428 276f 7574  ocals().get('out
+00012fe0: 272c 204e 6f6e 6529 2069 7320 6e6f 7420  ', None) is not 
+00012ff0: 4e6f 6e65 2065 6c73 6520 7b7d 292e 6173  None else {}).as
+00013000: 5f73 7562 636c 6173 7328 5465 6e73 6f72  _subclass(Tensor
+00013010: 292e 7370 6563 6961 6c5f 6672 6f6d 2841  ).special_from(A
+00013020: 2e73 6861 7065 2069 6620 6b65 6570 6469  .shape if keepdi
+00013030: 6d20 656c 7365 2041 2e73 6861 7065 5b3a  m else A.shape[:
+00013040: 2d32 5d29 0a0a 6269 7761 795f 6675 6e63  -2])..biway_func
+00013050: 7469 6f6e 7320 3d20 5b66 2066 6f72 2066  tions = [f for f
+00013060: 2069 6e20 6c6f 6361 6c73 2829 2069 6620   in locals() if 
+00013070: 6620 6e6f 7420 696e 2062 6173 6963 5f6c  f not in basic_l
+00013080: 6f63 616c 735d 0a0a 636c 6173 7320 5369  ocals]..class Si
+00013090: 7a65 2874 7570 6c65 293a 0a0a 2020 2020  ze(tuple):..    
+000130a0: 4063 6c61 7373 6d65 7468 6f64 0a20 2020  @classmethod.   
+000130b0: 2064 6566 205f 5f6e 6577 5f72 6177 5f5f   def __new_raw__
+000130c0: 2863 6c73 2c20 7368 6170 652c 2073 7a5f  (cls, shape, sz_
+000130d0: 6675 6e63 5f64 696d 3a20 696e 7420 3d20  func_dim: int = 
+000130e0: 302c 2073 7a5f 6261 7463 685f 6469 6d3a  0, sz_batch_dim:
+000130f0: 2069 6e74 203d 2030 2c20 737a 5f66 6561   int = 0, sz_fea
+00013100: 7475 7265 5f64 696d 3a20 696e 7420 3d20  ture_dim: int = 
+00013110: 302c 2073 7a5f 7365 7175 656e 6365 5f64  0, sz_sequence_d
+00013120: 696d 3a20 696e 7420 3d20 3029 3a0a 2020  im: int = 0):.  
+00013130: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00013140: 2020 5468 6520 7261 7720 636f 6e73 7472    The raw constr
+00013150: 7563 7469 6f6e 2066 756e 6374 696f 6e20  uction function 
+00013160: 6465 6669 6e65 6420 6279 2074 6865 2069  defined by the i
+00013170: 6e6e 6572 2070 6172 616d 6574 6572 732e  nner parameters.
+00013180: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
+00013190: 2020 2020 2020 2020 2020 2020 7368 6170              shap
+000131a0: 6520 2874 7570 6c65 206f 6620 696e 7473  e (tuple of ints
+000131b0: 293a 2054 6865 2072 6177 2074 7570 6c65  ): The raw tuple
+000131c0: 2073 7472 7563 7475 7265 2e20 0a20 2020   structure. .   
+000131d0: 2020 2020 2020 2020 2073 7a5f 6675 6e63           sz_func
+000131e0: 5f64 696d 2028 696e 742c 206f 7074 696f  _dim (int, optio
+000131f0: 6e61 6c29 3a20 416e 2069 6e6e 6572 2070  nal): An inner p
+00013200: 6172 616d 6574 6572 2066 6f72 2066 756e  arameter for fun
+00013210: 6374 696f 6e61 6c20 6469 6d65 6e73 696f  ctional dimensio
+00013220: 6e2c 2069 7420 6361 6e20 6f6e 6c79 2062  n, it can only b
+00013230: 6520 302c 2031 2c20 6f72 202d 312e 2044  e 0, 1, or -1. D
+00013240: 6566 6175 6c74 7320 746f 2030 2e0a 2020  efaults to 0..  
+00013250: 2020 2020 2020 2020 2020 737a 5f62 6174            sz_bat
+00013260: 6368 5f64 696d 2028 696e 742c 206f 7074  ch_dim (int, opt
+00013270: 696f 6e61 6c29 3a20 416e 2069 6e6e 6572  ional): An inner
+00013280: 2070 6172 616d 6574 6572 2066 6f72 2062   parameter for b
+00013290: 6174 6368 2064 696d 656e 7369 6f6e 2c20  atch dimension, 
+000132a0: 6974 2063 616e 206f 6e6c 7920 6265 2030  it can only be 0
+000132b0: 2c20 312c 206f 7220 2d31 2e20 4465 6661  , 1, or -1. Defa
+000132c0: 756c 7473 2074 6f20 302e 0a20 2020 2020  ults to 0..     
+000132d0: 2020 2020 2020 2073 7a5f 6665 6174 7572         sz_featur
+000132e0: 655f 6469 6d20 2869 6e74 2c20 6f70 7469  e_dim (int, opti
+000132f0: 6f6e 616c 293a 2041 6e20 696e 6e65 7220  onal): An inner 
+00013300: 7061 7261 6d65 7465 7220 666f 7220 6665  parameter for fe
+00013310: 6174 7572 6520 6469 6d65 6e73 696f 6e73  ature dimensions
+00013320: 2c20 6265 696e 6720 706f 7369 7469 7665  , being positive
+00013330: 2077 6865 6e20 7468 6579 2061 7265 2069   when they are i
+00013340: 6e20 6672 6f6e 7420 6f66 2074 6865 2073  n front of the s
+00013350: 7061 6365 2d73 6571 7565 6e63 6520 6469  pace-sequence di
+00013360: 6d65 6e73 696f 6e73 2e20 4465 6661 756c  mensions. Defaul
+00013370: 7473 2074 6f20 302e 0a20 2020 2020 2020  ts to 0..       
+00013380: 2020 2020 2073 7a5f 7365 7175 656e 6365       sz_sequence
+00013390: 5f64 696d 2028 696e 742c 206f 7074 696f  _dim (int, optio
+000133a0: 6e61 6c29 3a20 416e 2069 6e6e 6572 2070  nal): An inner p
+000133b0: 6172 616d 6574 6572 2066 6f72 2073 6571  arameter for seq
+000133c0: 7565 6e63 6520 6469 6d65 6e73 696f 6e73  uence dimensions
+000133d0: 2c20 6265 696e 6720 706f 7369 7469 7665  , being positive
+000133e0: 2077 6865 6e20 7468 6579 2061 7265 2069   when they are i
+000133f0: 6e20 6672 6f6e 7420 6f66 2074 6865 2073  n front of the s
+00013400: 7061 6365 2064 696d 656e 7369 6f6e 732e  pace dimensions.
+00013410: 2044 6566 6175 6c74 7320 746f 2030 2e0a   Defaults to 0..
+00013420: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00013430: 2020 2020 6176 6f75 6368 2869 7369 6e73      avouch(isins
+00013440: 7461 6e63 6528 7368 6170 652c 2074 7570  tance(shape, tup
+00013450: 6c65 2920 616e 6420 616c 6c5f 2869 7369  le) and all_(isi
+00013460: 6e73 7461 6e63 6528 732c 206e 756d 5f29  nstance(s, num_)
+00013470: 2066 6f72 2073 2069 6e20 7368 6170 6529   for s in shape)
+00013480: 2c20 5479 7065 4572 726f 7228 6622 496e  , TypeError(f"In
+00013490: 7661 6c69 6420 2773 6861 7065 203d 207b  valid 'shape = {
+000134a0: 7368 6170 657d 2720 666f 7220 6274 2e53  shape}' for bt.S
+000134b0: 697a 652c 2073 686f 756c 6420 6265 2061  ize, should be a
+000134c0: 2074 7570 6c65 2e20 2229 290a 2020 2020   tuple. ")).    
+000134d0: 2020 2020 6176 6f75 6368 2873 7a5f 6675      avouch(sz_fu
+000134e0: 6e63 5f64 696d 2069 6e20 2830 2c20 312c  nc_dim in (0, 1,
+000134f0: 202d 3129 2c20 5479 7065 4572 726f 7228   -1), TypeError(
+00013500: 6622 496e 7661 6c69 6420 2773 7a5f 6675  f"Invalid 'sz_fu
+00013510: 6e63 5f64 696d 203d 207b 737a 5f66 756e  nc_dim = {sz_fun
+00013520: 635f 6469 6d7d 2720 666f 7220 6274 2e53  c_dim}' for bt.S
+00013530: 697a 652c 2073 686f 756c 6420 6265 2030  ize, should be 0
+00013540: 2c20 312c 206f 7220 2d31 2e20 2229 290a  , 1, or -1. ")).
+00013550: 2020 2020 2020 2020 6176 6f75 6368 2873          avouch(s
+00013560: 7a5f 6261 7463 685f 6469 6d20 696e 2028  z_batch_dim in (
+00013570: 302c 2031 2c20 2d31 292c 2054 7970 6545  0, 1, -1), TypeE
+00013580: 7272 6f72 2866 2249 6e76 616c 6964 2027  rror(f"Invalid '
+00013590: 737a 5f62 6174 6368 5f64 696d 203d 207b  sz_batch_dim = {
+000135a0: 737a 5f62 6174 6368 5f64 696d 7d27 2066  sz_batch_dim}' f
+000135b0: 6f72 2062 742e 5369 7a65 2c20 7368 6f75  or bt.Size, shou
+000135c0: 6c64 2062 6520 302c 2031 2c20 6f72 202d  ld be 0, 1, or -
+000135d0: 312e 2022 2929 0a20 2020 2020 2020 2061  1. ")).        a
+000135e0: 766f 7563 6828 6973 696e 7374 616e 6365  vouch(isinstance
+000135f0: 2873 7a5f 6665 6174 7572 655f 6469 6d2c  (sz_feature_dim,
+00013600: 2069 6e74 5f29 2c20 5479 7065 4572 726f   int_), TypeErro
+00013610: 7228 6622 496e 7661 6c69 6420 2773 7a5f  r(f"Invalid 'sz_
+00013620: 6665 6174 7572 655f 6469 6d20 3d20 7b73  feature_dim = {s
+00013630: 7a5f 6665 6174 7572 655f 6469 6d7d 2720  z_feature_dim}' 
+00013640: 666f 7220 6274 2e53 697a 652c 2073 686f  for bt.Size, sho
+00013650: 756c 6420 6265 2061 6e20 696e 7465 6765  uld be an intege
+00013660: 722e 2022 2929 0a20 2020 2020 2020 2061  r. ")).        a
+00013670: 766f 7563 6828 6973 696e 7374 616e 6365  vouch(isinstance
+00013680: 2873 7a5f 7365 7175 656e 6365 5f64 696d  (sz_sequence_dim
+00013690: 2c20 696e 745f 292c 2054 7970 6545 7272  , int_), TypeErr
+000136a0: 6f72 2866 2249 6e76 616c 6964 2027 737a  or(f"Invalid 'sz
+000136b0: 5f73 6571 7565 6e63 655f 6469 6d20 3d20  _sequence_dim = 
+000136c0: 7b73 7a5f 7365 7175 656e 6365 5f64 696d  {sz_sequence_dim
+000136d0: 7d27 2066 6f72 2062 742e 5369 7a65 2c20  }' for bt.Size, 
+000136e0: 7368 6f75 6c64 2062 6520 616e 2069 6e74  should be an int
+000136f0: 6567 6572 2e20 2229 290a 2020 2020 2020  eger. ")).      
+00013700: 2020 6176 6f75 6368 286c 656e 2873 6861    avouch(len(sha
+00013710: 7065 2920 3e3d 2061 6273 5f28 737a 5f66  pe) >= abs_(sz_f
+00013720: 756e 635f 6469 6d29 202b 2061 6273 5f28  unc_dim) + abs_(
+00013730: 737a 5f62 6174 6368 5f64 696d 2920 2b20  sz_batch_dim) + 
+00013740: 6162 735f 2873 7a5f 6665 6174 7572 655f  abs_(sz_feature_
+00013750: 6469 6d29 202b 2061 6273 5f28 737a 5f73  dim) + abs_(sz_s
+00013760: 6571 7565 6e63 655f 6469 6d29 2c20 5479  equence_dim), Ty
+00013770: 7065 4572 726f 7228 6622 546f 6f20 6d61  peError(f"Too ma
+00013780: 6e79 2073 7065 6369 616c 2064 696d 656e  ny special dimen
+00013790: 7369 6f6e 7320 666f 7220 7368 6170 6520  sions for shape 
+000137a0: 6f66 206c 656e 6774 6820 7b6c 656e 2873  of length {len(s
+000137b0: 6861 7065 297d 3a20 737a 5f66 756e 635f  hape)}: sz_func_
+000137c0: 6469 6d20 3d20 7b73 7a5f 6675 6e63 5f64  dim = {sz_func_d
+000137d0: 696d 7d2c 2073 7a5f 6261 7463 685f 6469  im}, sz_batch_di
+000137e0: 6d20 3d20 7b73 7a5f 6261 7463 685f 6469  m = {sz_batch_di
+000137f0: 6d7d 2c20 737a 5f66 6561 7475 7265 5f64  m}, sz_feature_d
+00013800: 696d 203d 207b 737a 5f66 6561 7475 7265  im = {sz_feature
+00013810: 5f64 696d 7d2c 2073 7a5f 7365 7175 656e  _dim}, sz_sequen
+00013820: 6365 5f64 696d 203d 207b 737a 5f73 6571  ce_dim = {sz_seq
+00013830: 7565 6e63 655f 6469 6d7d 2e20 2229 290a  uence_dim}. ")).
+00013840: 2020 2020 2020 2020 7365 6c66 203d 2073          self = s
+00013850: 7570 6572 2829 2e5f 5f6e 6577 5f5f 2863  uper().__new__(c
+00013860: 6c73 2c20 7368 6170 6529 0a20 2020 2020  ls, shape).     
+00013870: 2020 2073 656c 662e 737a 5f66 756e 635f     self.sz_func_
+00013880: 6469 6d20 3d20 737a 5f66 756e 635f 6469  dim = sz_func_di
+00013890: 6d0a 2020 2020 2020 2020 7365 6c66 2e73  m.        self.s
+000138a0: 7a5f 6261 7463 685f 6469 6d20 3d20 737a  z_batch_dim = sz
+000138b0: 5f62 6174 6368 5f64 696d 0a20 2020 2020  _batch_dim.     
+000138c0: 2020 2073 656c 662e 737a 5f66 6561 7475     self.sz_featu
+000138d0: 7265 5f64 696d 203d 2073 7a5f 6665 6174  re_dim = sz_feat
+000138e0: 7572 655f 6469 6d0a 2020 2020 2020 2020  ure_dim.        
+000138f0: 7365 6c66 2e73 7a5f 7365 7175 656e 6365  self.sz_sequence
+00013900: 5f64 696d 203d 2073 7a5f 7365 7175 656e  _dim = sz_sequen
+00013910: 6365 5f64 696d 0a20 2020 2020 2020 2073  ce_dim.        s
+00013920: 656c 662e 6e5f 6469 6d20 3d20 7365 6c66  elf.n_dim = self
+00013930: 2e6e 6469 6d20 3d20 6c65 6e28 7368 6170  .ndim = len(shap
+00013940: 6529 0a20 2020 2020 2020 2072 6574 7572  e).        retur
+00013950: 6e20 7365 6c66 0a0a 2020 2020 4063 6c61  n self..    @cla
+00013960: 7373 6d65 7468 6f64 0a20 2020 2064 6566  ssmethod.    def
+00013970: 205f 5f6e 6577 5f73 697a 655f 5f28 636c   __new_size__(cl
+00013980: 732c 2073 697a 652c 202a 2a6b 7761 7267  s, size, **kwarg
+00013990: 7329 3a0a 2020 2020 2020 2020 2222 2254  s):.        """T
+000139a0: 6865 2063 6f6e 7374 7275 6374 696f 6e20  he construction 
+000139b0: 6675 6e63 7469 6f6e 2066 6f72 2061 2062  function for a b
+000139c0: 742e 5369 7a65 206f 626a 6563 742e 2022  t.Size object. "
+000139d0: 2222 0a20 2020 2020 2020 2061 766f 7563  "".        avouc
+000139e0: 6828 6973 696e 7374 616e 6365 2873 697a  h(isinstance(siz
+000139f0: 652c 2053 697a 6529 2c20 5479 7065 4572  e, Size), TypeEr
+00013a00: 726f 7228 6622 496e 7661 6c69 6420 2773  ror(f"Invalid 's
+00013a10: 697a 6520 3d20 7b73 697a 657d 2720 666f  ize = {size}' fo
+00013a20: 7220 6274 2e53 697a 652c 2073 686f 756c  r bt.Size, shoul
+00013a30: 6420 6265 2061 2062 742e 5369 7a65 206f  d be a bt.Size o
+00013a40: 626a 6563 742e 2022 2929 0a20 2020 2020  bject. ")).     
+00013a50: 2020 206b 7761 7267 732e 7365 7464 6566     kwargs.setdef
+00013a60: 6175 6c74 2822 737a 5f66 756e 635f 6469  ault("sz_func_di
+00013a70: 6d22 2c20 7369 7a65 2e73 7a5f 6675 6e63  m", size.sz_func
+00013a80: 5f64 696d 290a 2020 2020 2020 2020 6b77  _dim).        kw
+00013a90: 6172 6773 2e73 6574 6465 6661 756c 7428  args.setdefault(
+00013aa0: 2273 7a5f 6261 7463 685f 6469 6d22 2c20  "sz_batch_dim", 
+00013ab0: 7369 7a65 2e73 7a5f 6261 7463 685f 6469  size.sz_batch_di
+00013ac0: 6d29 0a20 2020 2020 2020 206b 7761 7267  m).        kwarg
+00013ad0: 732e 7365 7464 6566 6175 6c74 2822 737a  s.setdefault("sz
+00013ae0: 5f66 6561 7475 7265 5f64 696d 222c 2073  _feature_dim", s
+00013af0: 697a 652e 737a 5f66 6561 7475 7265 5f64  ize.sz_feature_d
+00013b00: 696d 290a 2020 2020 2020 2020 6b77 6172  im).        kwar
+00013b10: 6773 2e73 6574 6465 6661 756c 7428 2273  gs.setdefault("s
+00013b20: 7a5f 7365 7175 656e 6365 5f64 696d 222c  z_sequence_dim",
+00013b30: 2073 697a 652e 737a 5f73 6571 7565 6e63   size.sz_sequenc
+00013b40: 655f 6469 6d29 0a20 2020 2020 2020 2072  e_dim).        r
+00013b50: 6574 7572 6e20 636c 732e 5f5f 6e65 775f  eturn cls.__new_
+00013b60: 7261 775f 5f28 7475 706c 6528 7369 7a65  raw__(tuple(size
+00013b70: 292c 202a 2a6b 7761 7267 7329 0a0a 2020  ), **kwargs)..  
+00013b80: 2020 4063 6c61 7373 6d65 7468 6f64 0a20    @classmethod. 
+00013b90: 2020 2064 6566 205f 5f6e 6577 5f74 7570     def __new_tup
+00013ba0: 6c65 5f5f 2863 6c73 2c20 7368 6170 652c  le__(cls, shape,
+00013bb0: 2066 756e 635f 6469 6d3a 2028 696e 742c   func_dim: (int,
+00013bc0: 206e 756c 6c29 203d 204e 6f6e 652c 2062   null) = None, b
+00013bd0: 6174 6368 5f64 696d 3a20 2869 6e74 2c20  atch_dim: (int, 
+00013be0: 6e75 6c6c 2920 3d20 4e6f 6e65 2c20 6368  null) = None, ch
+00013bf0: 616e 6e65 6c5f 6469 6d3a 2028 696e 742c  annel_dim: (int,
+00013c00: 206e 756c 6c29 203d 204e 6f6e 652c 2073   null) = None, s
+00013c10: 6571 7565 6e63 655f 6469 6d3a 2028 696e  equence_dim: (in
+00013c20: 742c 206e 756c 6c29 203d 204e 6f6e 652c  t, null) = None,
+00013c30: 206e 5f66 6561 7475 7265 5f64 696d 3a20   n_feature_dim: 
+00013c40: 696e 7420 3d20 4e6f 6e65 2c20 6e5f 7365  int = None, n_se
+00013c50: 7175 656e 6365 5f64 696d 3a20 696e 7420  quence_dim: int 
+00013c60: 3d20 4e6f 6e65 2c20 737a 5f66 756e 635f  = None, sz_func_
+00013c70: 6469 6d3a 2069 6e74 203d 204e 6f6e 652c  dim: int = None,
+00013c80: 2073 7a5f 6261 7463 685f 6469 6d3a 2069   sz_batch_dim: i
+00013c90: 6e74 203d 204e 6f6e 652c 2073 7a5f 6665  nt = None, sz_fe
+00013ca0: 6174 7572 655f 6469 6d3a 2069 6e74 203d  ature_dim: int =
+00013cb0: 204e 6f6e 652c 2073 7a5f 7365 7175 656e   None, sz_sequen
+00013cc0: 6365 5f64 696d 3a20 696e 7420 3d20 4e6f  ce_dim: int = No
+00013cd0: 6e65 293a 0a20 2020 2020 2020 2022 2222  ne):.        """
+00013ce0: 0a20 2020 2020 2020 2054 6865 2063 6f6e  .        The con
+00013cf0: 7374 7275 6374 696f 6e20 6675 6e63 7469  struction functi
+00013d00: 6f6e 2066 6f72 2061 2074 7570 6c65 2077  on for a tuple w
+00013d10: 6974 6820 7265 6164 6162 6c65 2070 6172  ith readable par
+00013d20: 616d 6574 6572 732e 200a 0a20 2020 2020  ameters. ..     
+00013d30: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00013d40: 2020 2020 2073 6861 7065 2028 7475 706c       shape (tupl
+00013d50: 6520 6f66 2069 6e74 7329 3a20 7468 6520  e of ints): the 
+00013d60: 7261 7720 7475 706c 6520 7374 7275 6374  raw tuple struct
+00013d70: 7572 652e 200a 2020 2020 2020 2020 2020  ure. .          
+00013d80: 2020 6675 6e63 5f64 696d 2028 696e 742c    func_dim (int,
+00013d90: 206e 756c 6c2c 206f 7074 696f 6e61 6c29   null, optional)
+00013da0: 3a20 5468 6520 696e 6465 7820 6f66 2074  : The index of t
+00013db0: 6865 2066 756e 6374 696f 6e61 6c20 6469  he functional di
+00013dc0: 6d65 6e73 696f 6e2c 2068 6176 696e 6720  mension, having 
+00013dd0: 6120 646f 6d61 696e 206f 6620 3020 6f72  a domain of 0 or
+00013de0: 206e 5f64 696d 202d 2031 2c20 7468 6520   n_dim - 1, the 
+00013df0: 6669 7273 7420 6f72 206c 6173 7420 6469  first or last di
+00013e00: 6d65 6e73 696f 6e2e 2044 6566 6175 6c74  mension. Default
+00013e10: 7320 746f 204e 6f6e 652e 0a20 2020 2020  s to None..     
+00013e20: 2020 2020 2020 2062 6174 6368 5f64 696d         batch_dim
+00013e30: 2028 696e 742c 206e 756c 6c2c 206f 7074   (int, null, opt
+00013e40: 696f 6e61 6c29 3a20 5468 6520 696e 6465  ional): The inde
+00013e50: 7820 6f66 2074 6865 2062 6174 6368 2064  x of the batch d
+00013e60: 696d 656e 7369 6f6e 2c20 6861 7669 6e67  imension, having
+00013e70: 2061 2064 6f6d 6169 6e20 6f66 2030 206f   a domain of 0 o
+00013e80: 7220 6e5f 6469 6d20 2d20 312c 2074 6865  r n_dim - 1, the
+00013e90: 2066 6972 7374 206f 7220 6c61 7374 2064   first or last d
+00013ea0: 696d 656e 7369 6f6e 2e20 4465 6661 756c  imension. Defaul
+00013eb0: 7473 2074 6f20 4e6f 6e65 2e0a 2020 2020  ts to None..    
+00013ec0: 2020 2020 2020 2020 6368 616e 6e65 6c5f          channel_
+00013ed0: 6469 6d20 2869 6e74 2c20 6e75 6c6c 2c20  dim (int, null, 
+00013ee0: 6f70 7469 6f6e 616c 293a 2054 6865 2069  optional): The i
+00013ef0: 6e64 6578 206f 6620 7468 6520 6368 616e  ndex of the chan
+00013f00: 6e65 6c20 6469 6d65 6e73 696f 6e2c 2062  nel dimension, b
+00013f10: 6569 6e67 2074 6865 2066 6972 7374 206f  eing the first o
+00013f20: 7220 6c61 7374 2064 696d 656e 7369 6f6e  r last dimension
+00013f30: 2061 7061 7274 2066 726f 6d20 7468 6520   apart from the 
+00013f40: 6261 7463 6820 6469 6d65 6e73 696f 6e2e  batch dimension.
+00013f50: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
+00013f60: 652e 0a20 2020 2020 2020 2020 2020 2073  e..            s
+00013f70: 6571 7565 6e63 655f 6469 6d20 2869 6e74  equence_dim (int
+00013f80: 2c20 6e75 6c6c 2c20 6f70 7469 6f6e 616c  , null, optional
+00013f90: 293a 2054 6865 2069 6e64 6578 206f 6620  ): The index of 
+00013fa0: 7468 6520 7365 7175 656e 6365 2064 696d  the sequence dim
+00013fb0: 656e 7369 6f6e 2c20 6861 7669 6e67 2074  ension, having t
+00013fc0: 6865 2066 6972 7374 206f 7220 6c61 7374  he first or last
+00013fd0: 2064 696d 656e 7369 6f6e 2061 7061 7274   dimension apart
+00013fe0: 2066 726f 6d20 7468 6520 6261 7463 6820   from the batch 
+00013ff0: 616e 6420 6368 616e 6e65 6c20 6469 6d65  and channel dime
+00014000: 6e73 696f 6e2e 2044 6566 6175 6c74 7320  nsion. Defaults 
+00014010: 746f 204e 6f6e 652e 0a20 2020 2020 2020  to None..       
+00014020: 2020 2020 206e 5f66 6561 7475 7265 5f64       n_feature_d
+00014030: 696d 2028 696e 742c 206f 7074 696f 6e61  im (int, optiona
+00014040: 6c29 3a20 5468 6520 6e75 6d62 6572 206f  l): The number o
+00014050: 6620 6665 6174 7572 6520 6469 6d65 6e73  f feature dimens
+00014060: 696f 6e73 2028 746f 2074 6865 206c 6566  ions (to the lef
+00014070: 7420 6f66 2073 7061 6365 2064 696d 656e  t of space dimen
+00014080: 7369 6f6e 7329 2c20 636f 6e66 6c69 6374  sions), conflict
+00014090: 2074 6f20 6172 6775 6d65 6e74 2027 6368   to argument 'ch
+000140a0: 616e 6e65 6c5f 6469 6d27 2e20 4465 6661  annel_dim'. Defa
+000140b0: 756c 7473 2074 6f20 4e6f 6e65 2e0a 2020  ults to None..  
+000140c0: 2020 2020 2020 2020 2020 6e5f 7365 7175            n_sequ
+000140d0: 656e 6365 5f64 696d 2028 696e 742c 206f  ence_dim (int, o
+000140e0: 7074 696f 6e61 6c29 3a20 5468 6520 6e75  ptional): The nu
+000140f0: 6d62 6572 206f 6620 7365 7175 656e 6365  mber of sequence
+00014100: 2064 696d 656e 7369 6f6e 7320 2874 6f20   dimensions (to 
+00014110: 7468 6520 7269 6768 7420 6f66 2073 7061  the right of spa
+00014120: 6365 2064 696d 656e 7369 6f6e 7329 2c20  ce dimensions), 
+00014130: 636f 6e66 6c69 6374 2074 6f20 6172 6775  conflict to argu
+00014140: 6d65 6e74 2027 7365 7175 656e 6365 5f64  ment 'sequence_d
+00014150: 696d 272e 2044 6566 6175 6c74 7320 746f  im'. Defaults to
+00014160: 204e 6f6e 652e 0a20 2020 2020 2020 2020   None..         
+00014170: 2020 2073 7a5f 6675 6e63 5f64 696d 2028     sz_func_dim (
+00014180: 696e 742c 206f 7074 696f 6e61 6c29 3a20  int, optional): 
+00014190: 5468 6520 737a 206e 756d 6265 7220 6f66  The sz number of
+000141a0: 2074 6865 2066 756e 6374 696f 6e61 6c20   the functional 
+000141b0: 6469 6d65 6e73 696f 6e2c 2063 6f6e 666c  dimension, confl
+000141c0: 6963 7420 746f 2061 7267 756d 656e 7420  ict to argument 
+000141d0: 2766 756e 635f 6469 6d27 2e20 4465 6661  'func_dim'. Defa
+000141e0: 756c 7473 2074 6f20 4e6f 6e65 2e0a 2020  ults to None..  
+000141f0: 2020 2020 2020 2020 2020 737a 5f62 6174            sz_bat
+00014200: 6368 5f64 696d 2028 696e 742c 206f 7074  ch_dim (int, opt
+00014210: 696f 6e61 6c29 3a20 5468 6520 737a 206e  ional): The sz n
+00014220: 756d 6265 7220 6f66 2074 6865 2062 6174  umber of the bat
+00014230: 6368 2064 696d 656e 7369 6f6e 2c20 636f  ch dimension, co
+00014240: 6e66 6c69 6374 2074 6f20 6172 6775 6d65  nflict to argume
+00014250: 6e74 2027 6261 7463 685f 6469 6d27 2e20  nt 'batch_dim'. 
+00014260: 4465 6661 756c 7473 2074 6f20 4e6f 6e65  Defaults to None
+00014270: 2e0a 2020 2020 2020 2020 2020 2020 737a  ..            sz
+00014280: 5f66 6561 7475 7265 5f64 696d 2028 696e  _feature_dim (in
+00014290: 742c 206f 7074 696f 6e61 6c29 3a20 5468  t, optional): Th
+000142a0: 6520 737a 206e 756d 6265 7220 6f66 2066  e sz number of f
+000142b0: 6561 7475 7265 2064 696d 656e 7369 6f6e  eature dimension
+000142c0: 732c 2063 6f6e 666c 6963 7420 746f 2061  s, conflict to a
+000142d0: 7267 756d 656e 7473 2027 6368 616e 6e65  rguments 'channe
+000142e0: 6c5f 6469 6d27 2061 6e64 2027 6e5f 6665  l_dim' and 'n_fe
+000142f0: 6174 7572 655f 6469 6d27 2e20 4465 6661  ature_dim'. Defa
+00014300: 756c 7473 2074 6f20 4e6f 6e65 2e0a 2020  ults to None..  
+00014310: 2020 2020 2020 2020 2020 737a 5f73 6571            sz_seq
+00014320: 7565 6e63 655f 6469 6d20 2869 6e74 2c20  uence_dim (int, 
+00014330: 6f70 7469 6f6e 616c 293a 2054 6865 2073  optional): The s
+00014340: 7a20 6e75 6d62 6572 206f 6620 7365 7175  z number of sequ
+00014350: 656e 6365 2064 696d 656e 7369 6f6e 732c  ence dimensions,
+00014360: 2063 6f6e 666c 6963 7420 746f 2061 7267   conflict to arg
+00014370: 756d 656e 7473 2027 7365 7175 656e 6365  uments 'sequence
+00014380: 5f64 696d 2720 616e 6420 276e 5f73 6571  _dim' and 'n_seq
+00014390: 7565 6e63 655f 6469 6d27 2e20 4465 6661  uence_dim'. Defa
+000143a0: 756c 7473 2074 6f20 4e6f 6e65 2e0a 2020  ults to None..  
+000143b0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000143c0: 2020 6176 6f75 6368 2869 7369 6e73 7461    avouch(isinsta
+000143d0: 6e63 6528 7368 6170 652c 2074 7570 6c65  nce(shape, tuple
+000143e0: 292c 2054 7970 6545 7272 6f72 2866 2249  ), TypeError(f"I
+000143f0: 6e76 616c 6964 2027 7368 6170 6520 3d20  nvalid 'shape = 
+00014400: 7b73 6861 7065 7d27 2066 6f72 2062 742e  {shape}' for bt.
+00014410: 5369 7a65 2c20 7368 6f75 6c64 2062 6520  Size, should be 
+00014420: 6120 7475 706c 652e 2022 2929 0a20 2020  a tuple. ")).   
+00014430: 2020 2020 2069 6620 6c65 6e28 7368 6170       if len(shap
+00014440: 6529 203e 2030 2061 6e64 206e 6f74 2061  e) > 0 and not a
+00014450: 6c6c 5f28 6973 696e 7374 616e 6365 2878  ll_(isinstance(x
+00014460: 2c20 6e75 6d5f 2920 666f 7220 7820 696e  , num_) for x in
+00014470: 2073 6861 7065 293a 0a20 2020 2020 2020   shape):.       
+00014480: 2020 2020 2072 6177 5f73 6861 7065 203d       raw_shape =
+00014490: 2063 6c73 2e5f 5f6e 6577 5f72 6570 725f   cls.__new_repr_
+000144a0: 5f28 7368 6170 6529 0a20 2020 2020 2020  _(shape).       
+000144b0: 2020 2020 2073 6861 7065 203d 2074 7570       shape = tup
+000144c0: 6c65 2872 6177 5f73 6861 7065 290a 2020  le(raw_shape).  
+000144d0: 2020 2020 2020 2020 2020 6176 6f75 6368            avouch
+000144e0: 2866 756e 635f 6469 6d20 6973 204e 6f6e  (func_dim is Non
+000144f0: 6520 6f72 2072 6177 5f73 6861 7065 2e73  e or raw_shape.s
+00014500: 7a5f 6675 6e63 5f64 696d 203d 3d20 302c  z_func_dim == 0,
+00014510: 2054 7970 6545 7272 6f72 2866 2249 6e76   TypeError(f"Inv
+00014520: 616c 6964 2027 7368 6170 6520 3d20 7b73  alid 'shape = {s
+00014530: 6861 7065 7d3b 2066 756e 635f 6469 6d20  hape}; func_dim 
+00014540: 3d20 7b66 756e 635f 6469 6d7d 2720 666f  = {func_dim}' fo
+00014550: 7220 6274 2e53 697a 6520 2863 6f6e 666c  r bt.Size (confl
+00014560: 6963 7420 696e 2066 756e 6320 6469 6d65  ict in func dime
+00014570: 6e73 696f 6e29 2e22 2929 0a20 2020 2020  nsion).")).     
+00014580: 2020 2020 2020 2061 766f 7563 6828 6261         avouch(ba
+00014590: 7463 685f 6469 6d20 6973 204e 6f6e 6520  tch_dim is None 
+000145a0: 6f72 2072 6177 5f73 6861 7065 2e73 7a5f  or raw_shape.sz_
+000145b0: 6261 7463 685f 6469 6d20 3d3d 2030 2c20  batch_dim == 0, 
+000145c0: 5479 7065 4572 726f 7228 6622 496e 7661  TypeError(f"Inva
+000145d0: 6c69 6420 2773 6861 7065 203d 207b 7368  lid 'shape = {sh
+000145e0: 6170 657d 3b20 6261 7463 685f 6469 6d20  ape}; batch_dim 
+000145f0: 3d20 7b62 6174 6368 5f64 696d 7d27 2066  = {batch_dim}' f
+00014600: 6f72 2062 742e 5369 7a65 2028 636f 6e66  or bt.Size (conf
+00014610: 6c69 6374 2069 6e20 6261 7463 6820 6469  lict in batch di
+00014620: 6d65 6e73 696f 6e29 2e22 2929 0a20 2020  mension).")).   
+00014630: 2020 2020 2020 2020 2061 766f 7563 6828           avouch(
+00014640: 6368 616e 6e65 6c5f 6469 6d20 6973 204e  channel_dim is N
+00014650: 6f6e 6520 616e 6420 6e5f 6665 6174 7572  one and n_featur
+00014660: 655f 6469 6d20 6973 204e 6f6e 6520 6f72  e_dim is None or
+00014670: 2072 6177 5f73 6861 7065 2e73 7a5f 6665   raw_shape.sz_fe
+00014680: 6174 7572 655f 6469 6d20 3d3d 2030 2061  ature_dim == 0 a
+00014690: 6e64 2028 6368 616e 6e65 6c5f 6469 6d20  nd (channel_dim 
+000146a0: 6973 204e 6f6e 6520 6f72 206e 5f66 6561  is None or n_fea
+000146b0: 7475 7265 5f64 696d 2069 7320 4e6f 6e65  ture_dim is None
+000146c0: 292c 200a 2020 2020 2020 2020 2020 2020  ), .            
+000146d0: 2020 2020 2020 2054 7970 6545 7272 6f72         TypeError
+000146e0: 2866 2249 6e76 616c 6964 2027 7368 6170  (f"Invalid 'shap
+000146f0: 6520 3d20 7b73 6861 7065 7d3b 2063 6861  e = {shape}; cha
+00014700: 6e6e 656c 5f64 696d 203d 207b 6368 616e  nnel_dim = {chan
+00014710: 6e65 6c5f 6469 6d7d 3b20 6e5f 6665 6174  nel_dim}; n_feat
+00014720: 7572 655f 6469 6d20 3d20 7b6e 5f66 6561  ure_dim = {n_fea
+00014730: 7475 7265 5f64 696d 7d27 2066 6f72 2062  ture_dim}' for b
+00014740: 742e 5369 7a65 2028 636f 6e66 6c69 6374  t.Size (conflict
+00014750: 2069 6e20 6665 6174 7572 6520 6469 6d65   in feature dime
+00014760: 6e73 696f 6e73 292e 2229 290a 2020 2020  nsions).")).    
+00014770: 2020 2020 2020 2020 6176 6f75 6368 2873          avouch(s
+00014780: 6571 7565 6e63 655f 6469 6d20 6973 204e  equence_dim is N
+00014790: 6f6e 6520 616e 6420 6e5f 7365 7175 656e  one and n_sequen
+000147a0: 6365 5f64 696d 2069 7320 4e6f 6e65 206f  ce_dim is None o
+000147b0: 7220 7261 775f 7368 6170 652e 737a 5f73  r raw_shape.sz_s
+000147c0: 6571 7565 6e63 655f 6469 6d20 3d3d 2030  equence_dim == 0
+000147d0: 2061 6e64 2028 7365 7175 656e 6365 5f64   and (sequence_d
+000147e0: 696d 2069 7320 4e6f 6e65 206f 7220 6e5f  im is None or n_
+000147f0: 7365 7175 656e 6365 5f64 696d 2069 7320  sequence_dim is 
+00014800: 4e6f 6e65 292c 200a 2020 2020 2020 2020  None), .        
+00014810: 2020 2020 2020 2020 2020 2054 7970 6545             TypeE
+00014820: 7272 6f72 2866 2249 6e76 616c 6964 2027  rror(f"Invalid '
+00014830: 7368 6170 6520 3d20 7b73 6861 7065 7d3b  shape = {shape};
+00014840: 2073 6571 7565 6e63 655f 6469 6d20 3d20   sequence_dim = 
+00014850: 7b73 6571 7565 6e63 655f 6469 6d7d 3b20  {sequence_dim}; 
+00014860: 6e5f 7365 7175 656e 6365 5f64 696d 203d  n_sequence_dim =
+00014870: 207b 6e5f 7365 7175 656e 6365 5f64 696d   {n_sequence_dim
+00014880: 7d27 2066 6f72 2062 742e 5369 7a65 2028  }' for bt.Size (
+00014890: 636f 6e66 6c69 6374 2069 6e20 7365 7175  conflict in sequ
+000148a0: 656e 6365 2064 696d 656e 7369 6f6e 7329  ence dimensions)
+000148b0: 2e22 2929 0a20 2020 2020 2020 2020 2020  .")).           
+000148c0: 2069 6620 7261 775f 7368 6170 652e 737a   if raw_shape.sz
+000148d0: 5f66 756e 635f 6469 6d20 213d 2030 3a0a  _func_dim != 0:.
+000148e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000148f0: 6176 6f75 6368 2873 7a5f 6675 6e63 5f64  avouch(sz_func_d
+00014900: 696d 2069 7320 4e6f 6e65 2c20 5479 7065  im is None, Type
+00014910: 4572 726f 7228 2243 6f6e 666c 6963 7420  Error("Conflict 
+00014920: 6172 6775 6d65 6e74 7320 6475 7269 6e67  arguments during
+00014930: 2074 6865 2063 7265 6174 696f 6e20 6f66   the creation of
+00014940: 2053 697a 653a 2073 7a5f 6675 6e63 5f64   Size: sz_func_d
+00014950: 696d 2229 290a 2020 2020 2020 2020 2020  im")).          
+00014960: 2020 2020 2020 737a 5f66 756e 635f 6469        sz_func_di
+00014970: 6d20 3d20 7261 775f 7368 6170 652e 737a  m = raw_shape.sz
+00014980: 5f66 756e 635f 6469 6d0a 2020 2020 2020  _func_dim.      
+00014990: 2020 2020 2020 6966 2072 6177 5f73 6861        if raw_sha
+000149a0: 7065 2e73 7a5f 6261 7463 685f 6469 6d20  pe.sz_batch_dim 
+000149b0: 213d 2030 3a0a 2020 2020 2020 2020 2020  != 0:.          
+000149c0: 2020 2020 2020 6176 6f75 6368 2873 7a5f        avouch(sz_
+000149d0: 6261 7463 685f 6469 6d20 6973 204e 6f6e  batch_dim is Non
+000149e0: 652c 2054 7970 6545 7272 6f72 2822 436f  e, TypeError("Co
+000149f0: 6e66 6c69 6374 2061 7267 756d 656e 7473  nflict arguments
+00014a00: 2064 7572 696e 6720 7468 6520 6372 6561   during the crea
+00014a10: 7469 6f6e 206f 6620 5369 7a65 3a20 737a  tion of Size: sz
+00014a20: 5f62 6174 6368 5f64 696d 2229 290a 2020  _batch_dim")).  
+00014a30: 2020 2020 2020 2020 2020 2020 2020 737a                sz
+00014a40: 5f62 6174 6368 5f64 696d 203d 2072 6177  _batch_dim = raw
+00014a50: 5f73 6861 7065 2e73 7a5f 6261 7463 685f  _shape.sz_batch_
+00014a60: 6469 6d0a 2020 2020 2020 2020 2020 2020  dim.            
+00014a70: 6966 2072 6177 5f73 6861 7065 2e73 7a5f  if raw_shape.sz_
+00014a80: 6665 6174 7572 655f 6469 6d20 213d 2030  feature_dim != 0
+00014a90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00014aa0: 2020 6176 6f75 6368 2873 7a5f 6665 6174    avouch(sz_feat
+00014ab0: 7572 655f 6469 6d20 6973 204e 6f6e 652c  ure_dim is None,
+00014ac0: 2054 7970 6545 7272 6f72 2822 436f 6e66   TypeError("Conf
+00014ad0: 6c69 6374 2061 7267 756d 656e 7473 2064  lict arguments d
+00014ae0: 7572 696e 6720 7468 6520 6372 6561 7469  uring the creati
+00014af0: 6f6e 206f 6620 5369 7a65 3a20 737a 5f66  on of Size: sz_f
+00014b00: 6561 7475 7265 5f64 696d 2229 290a 2020  eature_dim")).  
+00014b10: 2020 2020 2020 2020 2020 2020 2020 737a                sz
+00014b20: 5f66 6561 7475 7265 5f64 696d 203d 2072  _feature_dim = r
+00014b30: 6177 5f73 6861 7065 2e73 7a5f 6665 6174  aw_shape.sz_feat
+00014b40: 7572 655f 6469 6d0a 2020 2020 2020 2020  ure_dim.        
+00014b50: 2020 2020 6966 2072 6177 5f73 6861 7065      if raw_shape
+00014b60: 2e73 7a5f 7365 7175 656e 6365 5f64 696d  .sz_sequence_dim
+00014b70: 2021 3d20 303a 0a20 2020 2020 2020 2020   != 0:.         
+00014b80: 2020 2020 2020 2061 766f 7563 6828 737a         avouch(sz
+00014b90: 5f73 6571 7565 6e63 655f 6469 6d20 6973  _sequence_dim is
+00014ba0: 204e 6f6e 652c 2054 7970 6545 7272 6f72   None, TypeError
+00014bb0: 2822 436f 6e66 6c69 6374 2061 7267 756d  ("Conflict argum
+00014bc0: 656e 7473 2064 7572 696e 6720 7468 6520  ents during the 
+00014bd0: 6372 6561 7469 6f6e 206f 6620 5369 7a65  creation of Size
+00014be0: 3a20 737a 5f73 6571 7565 6e63 655f 6469  : sz_sequence_di
+00014bf0: 6d22 2929 0a20 2020 2020 2020 2020 2020  m")).           
+00014c00: 2020 2020 2073 7a5f 7365 7175 656e 6365       sz_sequence
+00014c10: 5f64 696d 203d 2072 6177 5f73 6861 7065  _dim = raw_shape
+00014c20: 2e73 7a5f 7365 7175 656e 6365 5f64 696d  .sz_sequence_dim
+00014c30: 0a20 2020 2020 2020 2069 6620 737a 5f66  .        if sz_f
+00014c40: 756e 635f 6469 6d20 6973 204e 6f6e 653a  unc_dim is None:
+00014c50: 2073 7a5f 6675 6e63 5f64 696d 203d 2030   sz_func_dim = 0
+00014c60: 0a20 2020 2020 2020 2069 6620 737a 5f62  .        if sz_b
+00014c70: 6174 6368 5f64 696d 2069 7320 4e6f 6e65  atch_dim is None
+00014c80: 3a20 737a 5f62 6174 6368 5f64 696d 203d  : sz_batch_dim =
+00014c90: 2030 0a20 2020 2020 2020 2069 6620 737a   0.        if sz
+00014ca0: 5f66 6561 7475 7265 5f64 696d 2069 7320  _feature_dim is 
+00014cb0: 4e6f 6e65 3a20 737a 5f66 6561 7475 7265  None: sz_feature
+00014cc0: 5f64 696d 203d 2030 0a20 2020 2020 2020  _dim = 0.       
+00014cd0: 2069 6620 737a 5f73 6571 7565 6e63 655f   if sz_sequence_
+00014ce0: 6469 6d20 6973 204e 6f6e 653a 2073 7a5f  dim is None: sz_
+00014cf0: 7365 7175 656e 6365 5f64 696d 203d 2030  sequence_dim = 0
+00014d00: 0a20 2020 2020 2020 206e 5f64 696d 203d  .        n_dim =
+00014d10: 206c 656e 2873 6861 7065 290a 2020 2020   len(shape).    
+00014d20: 2020 2020 2320 4465 616c 2077 6974 6820      # Deal with 
+00014d30: 7468 6520 6675 6e63 2064 696d 656e 7369  the func dimensi
+00014d40: 6f6e 0a20 2020 2020 2020 2069 6620 737a  on.        if sz
+00014d50: 5f66 756e 635f 6469 6d20 3d3d 2030 3a0a  _func_dim == 0:.
+00014d60: 2020 2020 2020 2020 2020 2020 6675 6e63              func
+00014d70: 5f63 616e 6473 203d 2028 4e6f 6e65 2c20  _cands = (None, 
+00014d80: 302c 202d 6e5f 6469 6d2c 206e 5f64 696d  0, -n_dim, n_dim
+00014d90: 2d31 2c20 2d31 290a 2020 2020 2020 2020  -1, -1).        
+00014da0: 2020 2020 6176 6f75 6368 2866 756e 635f      avouch(func_
+00014db0: 6469 6d20 696e 2066 756e 635f 6361 6e64  dim in func_cand
+00014dc0: 732c 2054 7970 6545 7272 6f72 2866 2249  s, TypeError(f"I
+00014dd0: 6e76 616c 6964 2027 6675 6e63 5f64 696d  nvalid 'func_dim
+00014de0: 203d 207b 6675 6e63 5f64 696d 7d27 2066   = {func_dim}' f
+00014df0: 6f72 2062 742e 5369 7a65 2c20 7368 6f75  or bt.Size, shou
+00014e00: 6c64 2062 6520 4e6f 6e65 206f 7220 7b66  ld be None or {f
+00014e10: 756e 635f 6361 6e64 735b 315d 7d20 2862  unc_cands[1]} (b
+00014e20: 6566 6f72 6520 7468 6520 7370 6163 652d  efore the space-
+00014e30: 7365 7175 656e 6365 2064 696d 656e 7369  sequence dimensi
+00014e40: 6f6e 7329 2c20 6f72 207b 6675 6e63 5f63  ons), or {func_c
+00014e50: 616e 6473 5b2d 315d 7d20 2861 6674 6572  ands[-1]} (after
+00014e60: 2074 6865 2073 7061 6365 2d73 6571 7565   the space-seque
+00014e70: 6e63 6520 6469 6d65 6e73 696f 6e73 292e  nce dimensions).
+00014e80: 2022 2929 0a20 2020 2020 2020 2020 2020   ")).           
+00014e90: 2073 7a5f 6675 6e63 5f64 696d 203d 2030   sz_func_dim = 0
+00014ea0: 2069 6620 6675 6e63 5f64 696d 2069 7320   if func_dim is 
+00014eb0: 4e6f 6e65 2065 6c73 6520 2831 2069 6620  None else (1 if 
+00014ec0: 6675 6e63 5f64 696d 2069 6e20 2830 2c20  func_dim in (0, 
+00014ed0: 2d6e 5f64 696d 2920 656c 7365 202d 3129  -n_dim) else -1)
+00014ee0: 0a20 2020 2020 2020 2023 2044 6561 6c20  .        # Deal 
+00014ef0: 7769 7468 2074 6865 2062 6174 6368 2064  with the batch d
+00014f00: 696d 656e 7369 6f6e 0a20 2020 2020 2020  imension.       
+00014f10: 2069 6620 737a 5f62 6174 6368 5f64 696d   if sz_batch_dim
+00014f20: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+00014f30: 2020 2062 6174 6368 5f63 616e 6473 203d     batch_cands =
+00014f40: 2028 4e6f 6e65 2c20 0a20 2020 2020 2020   (None, .       
+00014f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f60: 2020 2020 6d61 785f 2873 7a5f 6675 6e63      max_(sz_func
+00014f70: 5f64 696d 2c20 3029 2c20 0a20 2020 2020  _dim, 0), .     
+00014f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f90: 2020 2020 2020 6d61 785f 2873 7a5f 6675        max_(sz_fu
+00014fa0: 6e63 5f64 696d 2c20 3029 202d 206e 5f64  nc_dim, 0) - n_d
+00014fb0: 696d 2c20 0a20 2020 2020 2020 2020 2020  im, .           
+00014fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014fd0: 6e5f 6469 6d20 2d20 3120 2b20 6d69 6e5f  n_dim - 1 + min_
+00014fe0: 2873 7a5f 6675 6e63 5f64 696d 2c20 3029  (sz_func_dim, 0)
+00014ff0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+00015000: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
+00015010: 6e5f 2873 7a5f 6675 6e63 5f64 696d 2c20  n_(sz_func_dim, 
+00015020: 3029 202d 2031 290a 2020 2020 2020 2020  0) - 1).        
+00015030: 2020 2020 6176 6f75 6368 2862 6174 6368      avouch(batch
+00015040: 5f64 696d 2069 6e20 6261 7463 685f 6361  _dim in batch_ca
+00015050: 6e64 732c 2054 7970 6545 7272 6f72 2866  nds, TypeError(f
+00015060: 2249 6e76 616c 6964 2027 6261 7463 685f  "Invalid 'batch_
+00015070: 6469 6d20 3d20 7b62 6174 6368 5f64 696d  dim = {batch_dim
+00015080: 7d27 2066 6f72 2062 742e 5369 7a65 2c20  }' for bt.Size, 
+00015090: 7368 6f75 6c64 2062 6520 4e6f 6e65 206f  should be None o
+000150a0: 7220 7b62 6174 6368 5f63 616e 6473 5b31  r {batch_cands[1
+000150b0: 5d7d 2028 6265 666f 7265 2074 6865 2073  ]} (before the s
+000150c0: 7061 6365 2d73 6571 7565 6e63 6520 6469  pace-sequence di
+000150d0: 6d65 6e73 696f 6e73 292c 206f 7220 7b62  mensions), or {b
+000150e0: 6174 6368 5f63 616e 6473 5b2d 315d 7d20  atch_cands[-1]} 
+000150f0: 2861 6674 6572 2074 6865 2073 7061 6365  (after the space
+00015100: 2d73 6571 7565 6e63 6520 6469 6d65 6e73  -sequence dimens
+00015110: 696f 6e73 292e 2022 2929 0a20 2020 2020  ions). ")).     
+00015120: 2020 2020 2020 2073 7a5f 6261 7463 685f         sz_batch_
+00015130: 6469 6d20 3d20 3020 6966 2062 6174 6368  dim = 0 if batch
+00015140: 5f64 696d 2069 7320 4e6f 6e65 2065 6c73  _dim is None els
+00015150: 6520 2831 2069 6620 6261 7463 685f 6469  e (1 if batch_di
+00015160: 6d20 696e 2028 302c 202d 6e5f 6469 6d29  m in (0, -n_dim)
+00015170: 2065 6c73 6520 2d31 290a 2020 2020 2020   else -1).      
+00015180: 2020 2320 4465 616c 2077 6974 6820 7468    # Deal with th
+00015190: 6520 6665 6174 7572 6520 6469 6d65 6e73  e feature dimens
+000151a0: 696f 6e28 7329 0a20 2020 2020 2020 2069  ion(s).        i
+000151b0: 6620 737a 5f66 6561 7475 7265 5f64 696d  f sz_feature_dim
+000151c0: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+000151d0: 2020 2069 6620 6e5f 6665 6174 7572 655f     if n_feature_
+000151e0: 6469 6d20 6973 204e 6f6e 653a 0a20 2020  dim is None:.   
+000151f0: 2020 2020 2020 2020 2020 2020 2063 6861               cha
+00015200: 6e6e 656c 5f63 616e 6473 203d 2028 4e6f  nnel_cands = (No
+00015210: 6e65 2c20 0a20 2020 2020 2020 2020 2020  ne, .           
+00015220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015230: 2020 2020 2020 6d61 785f 2873 7a5f 6675        max_(sz_fu
+00015240: 6e63 5f64 696d 2c20 3029 202b 206d 6178  nc_dim, 0) + max
+00015250: 5f28 737a 5f62 6174 6368 5f64 696d 2c20  _(sz_batch_dim, 
+00015260: 3029 2c20 0a20 2020 2020 2020 2020 2020  0), .           
+00015270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015280: 2020 2020 2020 6d61 785f 2873 7a5f 6675        max_(sz_fu
+00015290: 6e63 5f64 696d 2c20 3029 202b 206d 6178  nc_dim, 0) + max
+000152a0: 5f28 737a 5f62 6174 6368 5f64 696d 2c20  _(sz_batch_dim, 
+000152b0: 3029 202d 206e 5f64 696d 2c20 0a20 2020  0) - n_dim, .   
+000152c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000152d0: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
+000152e0: 6469 6d20 2d20 3120 2b20 6d69 6e5f 2873  dim - 1 + min_(s
+000152f0: 7a5f 6675 6e63 5f64 696d 2c20 3029 202b  z_func_dim, 0) +
+00015300: 206d 696e 5f28 737a 5f62 6174 6368 5f64   min_(sz_batch_d
+00015310: 696d 2c20 3029 2c20 0a20 2020 2020 2020  im, 0), .       
+00015320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015330: 2020 2020 2020 2020 2020 6d69 6e5f 2873            min_(s
+00015340: 7a5f 6675 6e63 5f64 696d 2c20 3029 202b  z_func_dim, 0) +
+00015350: 206d 696e 5f28 737a 5f62 6174 6368 5f64   min_(sz_batch_d
+00015360: 696d 2c20 3029 202d 2031 290a 2020 2020  im, 0) - 1).    
+00015370: 2020 2020 2020 2020 2020 2020 6176 6f75              avou
+00015380: 6368 2863 6861 6e6e 656c 5f64 696d 2069  ch(channel_dim i
+00015390: 6e20 6368 616e 6e65 6c5f 6361 6e64 732c  n channel_cands,
+000153a0: 2054 7970 6545 7272 6f72 2866 2249 6e76   TypeError(f"Inv
+000153b0: 616c 6964 2027 6368 616e 6e65 6c5f 6469  alid 'channel_di
+000153c0: 6d20 3d20 7b63 6861 6e6e 656c 5f64 696d  m = {channel_dim
+000153d0: 7d27 2066 6f72 2062 742e 5369 7a65 2c20  }' for bt.Size, 
+000153e0: 7368 6f75 6c64 2062 6520 4e6f 6e65 206f  should be None o
+000153f0: 7220 7b63 6861 6e6e 656c 5f63 616e 6473  r {channel_cands
+00015400: 5b31 5d7d 2028 6265 666f 7265 2074 6865  [1]} (before the
+00015410: 2073 7061 6365 2d73 6571 7565 6e63 6520   space-sequence 
+00015420: 6469 6d65 6e73 696f 6e73 292c 206f 7220  dimensions), or 
+00015430: 7b63 6861 6e6e 656c 5f63 616e 6473 5b2d  {channel_cands[-
+00015440: 315d 7d20 2861 6674 6572 2074 6865 2073  1]} (after the s
+00015450: 7061 6365 2d73 6571 7565 6e63 6520 6469  pace-sequence di
+00015460: 6d65 6e73 696f 6e73 292e 2022 2929 0a20  mensions). ")). 
+00015470: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00015480: 7a5f 6665 6174 7572 655f 6469 6d20 3d20  z_feature_dim = 
+00015490: 3020 6966 2063 6861 6e6e 656c 5f64 696d  0 if channel_dim
+000154a0: 2069 7320 4e6f 6e65 2065 6c73 6520 2831   is None else (1
+000154b0: 2069 6620 6368 616e 6e65 6c5f 6469 6d20   if channel_dim 
+000154c0: 696e 2063 6861 6e6e 656c 5f63 616e 6473  in channel_cands
+000154d0: 5b31 3a33 5d20 656c 7365 202d 3129 0a20  [1:3] else -1). 
+000154e0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+000154f0: 6368 616e 6e65 6c5f 6469 6d20 6973 206e  channel_dim is n
+00015500: 6f74 204e 6f6e 653a 2072 6169 7365 2054  ot None: raise T
+00015510: 7970 6545 7272 6f72 2822 4172 6775 6d65  ypeError("Argume
+00015520: 6e74 2027 6368 616e 6e65 6c5f 6469 6d27  nt 'channel_dim'
+00015530: 2069 7320 636f 6e66 6c69 6374 2074 6f20   is conflict to 
+00015540: 276e 5f66 6561 7475 7265 5f64 696d 2720  'n_feature_dim' 
+00015550: 666f 7220 6274 2e53 697a 652c 2074 6865  for bt.Size, the
+00015560: 7920 6361 6e6e 6f74 2062 6520 6173 7369  y cannot be assi
+00015570: 676e 6564 2073 696d 756c 7461 6e65 6f75  gned simultaneou
+00015580: 736c 792e 2022 290a 2020 2020 2020 2020  sly. ").        
+00015590: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000155a0: 2020 2020 2020 2020 2020 6176 6f75 6368            avouch
+000155b0: 2869 7369 6e73 7461 6e63 6528 6e5f 6665  (isinstance(n_fe
+000155c0: 6174 7572 655f 6469 6d2c 2069 6e74 5f29  ature_dim, int_)
+000155d0: 2061 6e64 206e 5f66 6561 7475 7265 5f64   and n_feature_d
+000155e0: 696d 203e 3d20 302c 2054 7970 6545 7272  im >= 0, TypeErr
+000155f0: 6f72 2866 2249 6e76 616c 6964 2027 6e5f  or(f"Invalid 'n_
+00015600: 6665 6174 7572 655f 6469 6d20 3d20 7b6e  feature_dim = {n
+00015610: 5f66 6561 7475 7265 5f64 696d 7d27 2066  _feature_dim}' f
+00015620: 6f72 2062 742e 5369 7a65 2c20 7368 6f75  or bt.Size, shou
+00015630: 6c64 2062 6520 616e 2069 6e74 6567 6572  ld be an integer
+00015640: 2e20 2229 290a 2020 2020 2020 2020 2020  . ")).          
+00015650: 2020 2020 2020 737a 5f66 6561 7475 7265        sz_feature
+00015660: 5f64 696d 203d 206e 5f66 6561 7475 7265  _dim = n_feature
+00015670: 5f64 696d 0a20 2020 2020 2020 2023 2044  _dim.        # D
+00015680: 6561 6c20 7769 7468 2074 6865 2073 6571  eal with the seq
+00015690: 7565 6e63 6520 6469 6d65 6e73 696f 6e28  uence dimension(
+000156a0: 7329 0a20 2020 2020 2020 2069 6620 737a  s).        if sz
+000156b0: 5f73 6571 7565 6e63 655f 6469 6d20 3d3d  _sequence_dim ==
+000156c0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+000156d0: 6966 206e 5f73 6571 7565 6e63 655f 6469  if n_sequence_di
+000156e0: 6d20 6973 204e 6f6e 653a 0a20 2020 2020  m is None:.     
+000156f0: 2020 2020 2020 2020 2020 2073 6571 7565             seque
+00015700: 6e63 655f 6361 6e64 7320 3d20 284e 6f6e  nce_cands = (Non
+00015710: 652c 200a 2020 2020 2020 2020 2020 2020  e, .            
+00015720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015730: 2020 2020 2020 6d61 785f 2873 7a5f 6675        max_(sz_fu
+00015740: 6e63 5f64 696d 2c20 3029 202b 206d 6178  nc_dim, 0) + max
+00015750: 5f28 737a 5f62 6174 6368 5f64 696d 2c20  _(sz_batch_dim, 
+00015760: 3029 202b 206d 6178 5f28 737a 5f66 6561  0) + max_(sz_fea
+00015770: 7475 7265 5f64 696d 2c20 3029 2c20 0a20  ture_dim, 0), . 
+00015780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000157a0: 206d 6178 5f28 737a 5f66 756e 635f 6469   max_(sz_func_di
+000157b0: 6d2c 2030 2920 2b20 6d61 785f 2873 7a5f  m, 0) + max_(sz_
+000157c0: 6261 7463 685f 6469 6d2c 2030 2920 2b20  batch_dim, 0) + 
+000157d0: 6d61 785f 2873 7a5f 6665 6174 7572 655f  max_(sz_feature_
+000157e0: 6469 6d2c 2030 2920 2d20 6e5f 6469 6d2c  dim, 0) - n_dim,
+000157f0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+00015800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015810: 2020 2020 6e5f 6469 6d20 2d20 3120 2b20      n_dim - 1 + 
+00015820: 6d69 6e5f 2873 7a5f 6675 6e63 5f64 696d  min_(sz_func_dim
+00015830: 2c20 3029 202b 206d 696e 5f28 737a 5f62  , 0) + min_(sz_b
+00015840: 6174 6368 5f64 696d 2c20 3029 202b 206d  atch_dim, 0) + m
+00015850: 696e 5f28 737a 5f66 6561 7475 7265 5f64  in_(sz_feature_d
+00015860: 696d 2c20 3029 2c20 0a20 2020 2020 2020  im, 0), .       
+00015870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015880: 2020 2020 2020 2020 2020 206d 696e 5f28             min_(
+00015890: 737a 5f66 756e 635f 6469 6d2c 2030 2920  sz_func_dim, 0) 
+000158a0: 2b20 6d69 6e5f 2873 7a5f 6261 7463 685f  + min_(sz_batch_
+000158b0: 6469 6d2c 2030 2920 2b20 6d69 6e5f 2873  dim, 0) + min_(s
+000158c0: 7a5f 6665 6174 7572 655f 6469 6d2c 2030  z_feature_dim, 0
+000158d0: 2920 2d20 3129 0a20 2020 2020 2020 2020  ) - 1).         
+000158e0: 2020 2020 2020 2061 766f 7563 6828 7365         avouch(se
+000158f0: 7175 656e 6365 5f64 696d 2069 6e20 7365  quence_dim in se
+00015900: 7175 656e 6365 5f63 616e 6473 2c20 5479  quence_cands, Ty
+00015910: 7065 4572 726f 7228 6622 496e 7661 6c69  peError(f"Invali
+00015920: 6420 2773 6571 7565 6e63 655f 6469 6d20  d 'sequence_dim 
+00015930: 3d20 7b73 6571 7565 6e63 655f 6469 6d7d  = {sequence_dim}
+00015940: 2720 666f 7220 6274 2e53 697a 652c 2073  ' for bt.Size, s
+00015950: 686f 756c 6420 6265 206f 6e65 206f 6620  hould be one of 
+00015960: 4e6f 6e65 2c20 7b73 6571 7565 6e63 655f  None, {sequence_
+00015970: 6361 6e64 735b 315d 7d20 2862 6566 6f72  cands[1]} (befor
+00015980: 6520 7468 6520 7370 6163 6520 6469 6d65  e the space dime
+00015990: 6e73 696f 6e73 292c 206f 7220 7b73 6571  nsions), or {seq
+000159a0: 7565 6e63 655f 6361 6e64 735b 2d31 5d7d  uence_cands[-1]}
+000159b0: 2028 6166 7465 7220 7468 6520 7370 6163   (after the spac
+000159c0: 6520 6469 6d65 6e73 696f 6e73 2922 2929  e dimensions)"))
+000159d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000159e0: 2073 7a5f 7365 7175 656e 6365 5f64 696d   sz_sequence_dim
+000159f0: 203d 2030 2069 6620 7365 7175 656e 6365   = 0 if sequence
+00015a00: 5f64 696d 2069 7320 4e6f 6e65 2065 6c73  _dim is None els
+00015a10: 6520 2831 2069 6620 7365 7175 656e 6365  e (1 if sequence
+00015a20: 5f64 696d 2069 6e20 7365 7175 656e 6365  _dim in sequence
+00015a30: 5f63 616e 6473 5b31 3a33 5d20 656c 7365  _cands[1:3] else
+00015a40: 202d 3129 0a20 2020 2020 2020 2020 2020   -1).           
+00015a50: 2065 6c69 6620 7365 7175 656e 6365 5f64   elif sequence_d
+00015a60: 696d 2069 7320 6e6f 7420 4e6f 6e65 3a20  im is not None: 
+00015a70: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
+00015a80: 2241 7267 756d 656e 7420 2773 6571 7565  "Argument 'seque
+00015a90: 6e63 655f 6469 6d27 2069 7320 636f 6e66  nce_dim' is conf
+00015aa0: 6c69 6374 2074 6f20 276e 5f73 6571 7565  lict to 'n_seque
+00015ab0: 6e63 655f 6469 6d27 2066 6f72 2062 742e  nce_dim' for bt.
+00015ac0: 5369 7a65 2c20 7468 6579 2063 616e 6e6f  Size, they canno
+00015ad0: 7420 6265 2061 7373 6967 6e65 6420 7369  t be assigned si
+00015ae0: 6d75 6c74 616e 656f 7573 6c79 2e20 2229  multaneously. ")
+00015af0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00015b00: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00015b10: 2020 2061 766f 7563 6828 6973 696e 7374     avouch(isinst
+00015b20: 616e 6365 286e 5f73 6571 7565 6e63 655f  ance(n_sequence_
+00015b30: 6469 6d2c 2069 6e74 5f29 2061 6e64 206e  dim, int_) and n
+00015b40: 5f73 6571 7565 6e63 655f 6469 6d20 3e3d  _sequence_dim >=
+00015b50: 2030 2c20 5479 7065 4572 726f 7228 6622   0, TypeError(f"
+00015b60: 496e 7661 6c69 6420 276e 5f73 6571 7565  Invalid 'n_seque
+00015b70: 6e63 655f 6469 6d20 3d20 7b6e 5f73 6571  nce_dim = {n_seq
+00015b80: 7565 6e63 655f 6469 6d7d 2720 666f 7220  uence_dim}' for 
+00015b90: 6274 2e53 697a 652c 2073 686f 756c 6420  bt.Size, should 
+00015ba0: 6265 2061 6e20 696e 7465 6765 722e 2022  be an integer. "
+00015bb0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00015bc0: 2020 2073 7a5f 7365 7175 656e 6365 5f64     sz_sequence_d
+00015bd0: 696d 203d 202d 206e 5f73 6571 7565 6e63  im = - n_sequenc
+00015be0: 655f 6469 6d0a 2020 2020 2020 2020 2320  e_dim.        # 
+00015bf0: 4368 6563 6b20 6469 6d65 6e73 696f 6e20  Check dimension 
+00015c00: 636f 6e73 6973 7465 6e63 790a 2020 2020  consistency.    
+00015c10: 2020 2020 6176 6f75 6368 2861 6273 5f28      avouch(abs_(
+00015c20: 737a 5f66 756e 635f 6469 6d29 202b 2061  sz_func_dim) + a
+00015c30: 6273 5f28 737a 5f62 6174 6368 5f64 696d  bs_(sz_batch_dim
+00015c40: 2920 2b20 6162 735f 2873 7a5f 6665 6174  ) + abs_(sz_feat
+00015c50: 7572 655f 6469 6d29 202b 2061 6273 5f28  ure_dim) + abs_(
+00015c60: 737a 5f73 6571 7565 6e63 655f 6469 6d29  sz_sequence_dim)
+00015c70: 203c 3d20 6e5f 6469 6d2c 2054 7970 6545   <= n_dim, TypeE
+00015c80: 7272 6f72 2866 2254 6f6f 206d 616e 7920  rror(f"Too many 
+00015c90: 7370 6563 6961 6c20 6469 6d65 6e73 696f  special dimensio
+00015ca0: 6e73 2066 6f72 2073 6861 7065 206f 6620  ns for shape of 
+00015cb0: 6c65 6e67 7468 207b 6e5f 6469 6d7d 2e20  length {n_dim}. 
+00015cc0: 2229 290a 2020 2020 2020 2020 7265 7475  ")).        retu
+00015cd0: 726e 2063 6c73 2e5f 5f6e 6577 5f72 6177  rn cls.__new_raw
+00015ce0: 5f5f 2873 6861 7065 2c20 737a 5f66 756e  __(shape, sz_fun
+00015cf0: 635f 6469 6d3d 737a 5f66 756e 635f 6469  c_dim=sz_func_di
+00015d00: 6d2c 2073 7a5f 6261 7463 685f 6469 6d3d  m, sz_batch_dim=
+00015d10: 737a 5f62 6174 6368 5f64 696d 2c20 737a  sz_batch_dim, sz
+00015d20: 5f66 6561 7475 7265 5f64 696d 3d73 7a5f  _feature_dim=sz_
+00015d30: 6665 6174 7572 655f 6469 6d2c 2073 7a5f  feature_dim, sz_
+00015d40: 7365 7175 656e 6365 5f64 696d 3d73 7a5f  sequence_dim=sz_
+00015d50: 7365 7175 656e 6365 5f64 696d 290a 0a20  sequence_dim).. 
+00015d60: 2020 2040 636c 6173 736d 6574 686f 640a     @classmethod.
+00015d70: 2020 2020 6465 6620 5f5f 6e65 775f 7265      def __new_re
+00015d80: 7072 5f5f 2863 6c73 2c20 7368 6170 6529  pr__(cls, shape)
+00015d90: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00015da0: 2020 2020 2020 5468 6520 636f 6e73 7472        The constr
+00015db0: 7563 746f 7220 7573 696e 6720 7079 7468  uctor using pyth
+00015dc0: 6f6e 2072 6570 7265 7365 6e74 6174 696f  on representatio
+00015dd0: 6e73 2e20 496e 636c 7564 696e 673a 0a20  ns. Including:. 
+00015de0: 2020 2020 2020 2031 2e20 286e 5f66 756e         1. (n_fun
+00015df0: 632c 2920 666f 7220 6675 6e63 7469 6f6e  c,) for function
+00015e00: 616c 2064 696d 656e 7369 6f6e 2c20 0a20  al dimension, . 
+00015e10: 2020 2020 2020 2032 2e20 7b6e 5f62 6174         2. {n_bat
+00015e20: 6368 7d20 666f 7220 6261 7463 6820 6469  ch} for batch di
+00015e30: 6d65 6e73 696f 6e2c 200a 2020 2020 2020  mension, .      
+00015e40: 2020 332e 205b 6e5f 6665 6174 7572 655d    3. [n_feature]
+00015e50: 2066 6f72 2066 6561 7475 7265 2064 696d   for feature dim
+00015e60: 656e 7369 6f6e 732c 0a20 2020 2020 2020  ensions,.       
+00015e70: 2034 2e20 276e 5f73 6571 7565 6e63 6527   4. 'n_sequence'
+00015e80: 2066 6f72 2073 6571 7565 6e63 6520 6469   for sequence di
+00015e90: 6d65 6e73 696f 6e73 2c0a 2020 2020 2020  mensions,.      
+00015ea0: 2020 352e 2069 6e74 6567 6572 7320 666f    5. integers fo
+00015eb0: 7220 6f72 6469 6e61 7279 2073 7061 6365  r ordinary space
+00015ec0: 2064 696d 656e 7369 6f6e 732e 200a 0a20   dimensions. .. 
+00015ed0: 2020 2020 2020 2045 7861 6d70 6c65 733a         Examples:
+00015ee0: 3a0a 2020 2020 2020 2020 2020 2020 3e3e  :.            >>
+00015ef0: 3e20 7320 3d20 6274 2e53 697a 6528 7b32  > s = bt.Size({2
+00015f00: 7d2c 205b 335d 2c20 5b34 2c20 355d 2c20  }, [3], [4, 5], 
+00015f10: 362c 2037 2c20 2738 2729 0a20 2020 2020  6, 7, '8').     
+00015f20: 2020 2020 2020 203e 3e3e 2073 0a20 2020         >>> s.   
+00015f30: 2020 2020 2020 2020 2062 6174 6f72 6368           batorch
+00015f40: 2e53 697a 6528 7b32 7d2c 205b 332c 2034  .Size({2}, [3, 4
+00015f50: 2c20 355d 2c20 362c 2037 2c20 2738 2729  , 5], 6, 7, '8')
+00015f60: 0a20 2020 2020 2020 2020 2020 203e 3e3e  .            >>>
+00015f70: 2073 2e66 6561 7475 7265 0a20 2020 2020   s.feature.     
+00015f80: 2020 2020 2020 2062 6174 6f72 6368 2e53         batorch.S
+00015f90: 697a 6528 5b33 2c20 342c 2035 5d29 0a20  ize([3, 4, 5]). 
+00015fa0: 2020 2020 2020 2020 2020 203e 3e3e 2073             >>> s
+00015fb0: 2e77 6974 685f 6665 6174 7572 6528 3229  .with_feature(2)
+00015fc0: 0a20 2020 2020 2020 2020 2020 2062 6174  .            bat
+00015fd0: 6f72 6368 2e53 697a 6528 7b32 7d2c 205b  orch.Size({2}, [
+00015fe0: 325d 2c20 362c 2037 2c20 2738 2729 0a20  2], 6, 7, '8'). 
+00015ff0: 2020 2020 2020 2020 2020 203e 3e3e 2073             >>> s
+00016000: 203c 3c20 3220 2320 7061 6464 696e 670a   << 2 # padding.
+00016010: 2020 2020 2020 2020 2020 2020 6261 746f              bato
+00016020: 7263 682e 5369 7a65 287b 327d 2c20 5b33  rch.Size({2}, [3
+00016030: 2c20 342c 2035 5d2c 2038 2c20 392c 2027  , 4, 5], 8, 9, '
+00016040: 3827 290a 2020 2020 2020 2020 2020 2020  8').            
+00016050: 3e3e 3e20 7320 2a2a 2032 2023 2072 6570  >>> s ** 2 # rep
+00016060: 6561 7420 746f 2065 6e6c 6172 6765 0a20  eat to enlarge. 
+00016070: 2020 2020 2020 2020 2020 2062 6174 6f72             bator
+00016080: 6368 2e53 697a 6528 7b32 7d2c 205b 332c  ch.Size({2}, [3,
+00016090: 2034 2c20 355d 2c20 3132 2c20 3134 2c20   4, 5], 12, 14, 
+000160a0: 2738 2729 0a20 2020 2020 2020 2022 2222  '8').        """
+000160b0: 0a20 2020 2020 2020 2073 7a5f 6675 6e63  .        sz_func
+000160c0: 5f64 696d 203d 2030 0a20 2020 2020 2020  _dim = 0.       
+000160d0: 2073 7a5f 6261 7463 685f 6469 6d20 3d20   sz_batch_dim = 
+000160e0: 300a 2020 2020 2020 2020 737a 5f66 6561  0.        sz_fea
+000160f0: 7475 7265 5f64 696d 203d 2030 0a20 2020  ture_dim = 0.   
+00016100: 2020 2020 2073 7a5f 7365 7175 656e 6365       sz_sequence
+00016110: 5f64 696d 203d 2030 0a20 2020 2020 2020  _dim = 0.       
+00016120: 2072 6177 5f73 697a 6520 3d20 5b5d 0a20   raw_size = []. 
+00016130: 2020 2020 2020 2063 756d 5f69 203d 2030         cum_i = 0
+00016140: 0a20 2020 2020 2020 2065 6e64 735f 7769  .        ends_wi
+00016150: 7468 5f66 756e 6320 3d20 4661 6c73 650a  th_func = False.
+00016160: 2020 2020 2020 2020 656e 6473 5f77 6974          ends_wit
+00016170: 685f 6261 7463 6820 3d20 4661 6c73 650a  h_batch = False.
+00016180: 2020 2020 2020 2020 656e 6473 5f77 6974          ends_wit
+00016190: 685f 6665 6174 7572 6520 3d20 4661 6c73  h_feature = Fals
+000161a0: 650a 2020 2020 2020 2020 656e 6473 5f77  e.        ends_w
+000161b0: 6974 685f 7365 7175 656e 6365 203d 2046  ith_sequence = F
+000161c0: 616c 7365 0a20 2020 2020 2020 2066 6f72  alse.        for
+000161d0: 2069 2c20 7320 696e 2065 6e75 6d65 7261   i, s in enumera
+000161e0: 7465 2873 6861 7065 293a 0a20 2020 2020  te(shape):.     
+000161f0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00016200: 616e 6365 2873 2c20 7475 706c 6529 3a20  ance(s, tuple): 
+00016210: 2320 6675 6e63 7469 6f6e 616c 2064 696d  # functional dim
+00016220: 656e 7369 6f6e 0a20 2020 2020 2020 2020  ension.         
+00016230: 2020 2020 2020 2061 766f 7563 6828 737a         avouch(sz
+00016240: 5f66 756e 635f 6469 6d20 3d3d 2030 2c20  _func_dim == 0, 
+00016250: 5479 7065 4572 726f 7228 6622 496e 7661  TypeError(f"Inva
+00016260: 6c69 6420 2773 6861 7065 203d 207b 7368  lid 'shape = {sh
+00016270: 6170 657d 2720 666f 7220 6274 2e53 697a  ape}' for bt.Siz
+00016280: 6520 2863 6f6e 666c 6963 7420 6f66 206d  e (conflict of m
+00016290: 756c 7469 706c 6520 6675 6e63 7469 6f6e  ultiple function
+000162a0: 616c 2064 696d 656e 7369 6f6e 7329 2e22  al dimensions)."
+000162b0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+000162c0: 2020 2061 766f 7563 6828 6c65 6e28 7329     avouch(len(s)
+000162d0: 203d 3d20 3120 616e 6420 6973 696e 7374   == 1 and isinst
+000162e0: 616e 6365 2873 5b30 5d2c 206e 756d 5f29  ance(s[0], num_)
+000162f0: 206f 7220 6c65 6e28 7329 203d 3d20 302c   or len(s) == 0,
+00016300: 2054 7970 6545 7272 6f72 2866 2249 6e76   TypeError(f"Inv
+00016310: 616c 6964 2027 7368 6170 6520 3d20 7b73  alid 'shape = {s
+00016320: 6861 7065 7d27 2066 6f72 2062 742e 5369  hape}' for bt.Si
+00016330: 7a65 2028 6f6e 6c79 2028 782c 2920 6973  ze (only (x,) is
+00016340: 2061 7661 696c 6162 6c65 2066 6f72 2066   available for f
+00016350: 756e 6374 696f 6e61 6c20 6469 6d65 6e73  unctional dimens
+00016360: 696f 6e29 2e22 2929 0a20 2020 2020 2020  ion).")).       
+00016370: 2020 2020 2020 2020 2061 766f 7563 6828           avouch(
+00016380: 6920 696e 2028 302c 206c 656e 2873 6861  i in (0, len(sha
+00016390: 7065 2920 2d20 3129 2c20 5479 7065 4572  pe) - 1), TypeEr
+000163a0: 726f 7228 6622 496e 7661 6c69 6420 2773  ror(f"Invalid 's
+000163b0: 6861 7065 203d 207b 7368 6170 657d 2720  hape = {shape}' 
+000163c0: 666f 7220 6274 2e53 697a 6520 2866 756e  for bt.Size (fun
+000163d0: 6374 696f 6e61 6c20 6469 6d65 6e73 696f  ctional dimensio
+000163e0: 6e20 6361 6e20 6f6e 6c79 2062 6520 7468  n can only be th
+000163f0: 6520 6669 7273 742f 6c61 7374 2064 696d  e first/last dim
+00016400: 656e 7369 6f6e 292e 2229 290a 2020 2020  ension).")).    
+00016410: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+00016420: 656e 2873 2920 3d3d 2030 3a20 7261 775f  en(s) == 0: raw_
+00016430: 7369 7a65 2e61 7070 656e 6428 2d31 290a  size.append(-1).
+00016440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016450: 656c 7365 3a20 7261 775f 7369 7a65 2e61  else: raw_size.a
+00016460: 7070 656e 6428 735b 305d 290a 2020 2020  ppend(s[0]).    
+00016470: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00016480: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+00016490: 2020 2020 2020 2020 2020 2073 7a5f 6675             sz_fu
+000164a0: 6e63 5f64 696d 203d 2031 0a20 2020 2020  nc_dim = 1.     
+000164b0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000164c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000164d0: 2020 2020 2073 7a5f 6675 6e63 5f64 696d       sz_func_dim
+000164e0: 203d 202d 310a 2020 2020 2020 2020 2020   = -1.          
+000164f0: 2020 2020 2020 2020 2020 656e 6473 5f77            ends_w
+00016500: 6974 685f 6675 6e63 203d 2054 7275 650a  ith_func = True.
+00016510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016520: 6375 6d5f 6920 2b3d 2031 0a20 2020 2020  cum_i += 1.     
+00016530: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
+00016540: 7374 616e 6365 2873 2c20 2864 6963 742c  stance(s, (dict,
+00016550: 2073 6574 2929 3a20 2320 6261 7463 6820   set)): # batch 
+00016560: 6469 6d65 6e73 696f 6e0a 2020 2020 2020  dimension.      
+00016570: 2020 2020 2020 2020 2020 6176 6f75 6368            avouch
+00016580: 2873 7a5f 6261 7463 685f 6469 6d20 3d3d  (sz_batch_dim ==
+00016590: 2030 2c20 5479 7065 4572 726f 7228 6622   0, TypeError(f"
+000165a0: 496e 7661 6c69 6420 2773 6861 7065 203d  Invalid 'shape =
+000165b0: 207b 7368 6170 657d 2720 666f 7220 6274   {shape}' for bt
+000165c0: 2e53 697a 6520 2863 6f6e 666c 6963 7420  .Size (conflict 
+000165d0: 6f66 206d 756c 7469 706c 6520 6261 7463  of multiple batc
+000165e0: 6820 6469 6d65 6e73 696f 6e73 292e 2229  h dimensions).")
+000165f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00016600: 2020 6176 6f75 6368 2869 7369 6e73 7461    avouch(isinsta
+00016610: 6e63 6528 732c 2073 6574 2920 616e 6420  nce(s, set) and 
+00016620: 6c65 6e28 7329 203d 3d20 3120 6f72 206c  len(s) == 1 or l
+00016630: 656e 2873 2920 3d3d 2030 2c20 5479 7065  en(s) == 0, Type
+00016640: 4572 726f 7228 6622 496e 7661 6c69 6420  Error(f"Invalid 
+00016650: 2773 6861 7065 203d 207b 7368 6170 657d  'shape = {shape}
+00016660: 2720 666f 7220 6274 2e53 697a 6520 286e  ' for bt.Size (n
+00016670: 6f20 6469 6374 2069 7465 6d20 6973 2061  o dict item is a
+00016680: 6c6c 6f77 6564 2c20 6f6e 6c79 207b 7b78  llowed, only {{x
+00016690: 7d7d 206f 7220 7b7b 7d7d 2061 7265 2061  }} or {{}} are a
+000166a0: 7661 696c 6162 6c65 292e 2229 290a 2020  vailable).")).  
+000166b0: 2020 2020 2020 2020 2020 2020 2020 6176                av
+000166c0: 6f75 6368 286e 6f74 2065 6e64 735f 7769  ouch(not ends_wi
+000166d0: 7468 5f66 756e 632c 2054 7970 6545 7272  th_func, TypeErr
+000166e0: 6f72 2866 2249 6e76 616c 6964 2027 7368  or(f"Invalid 'sh
+000166f0: 6170 6520 3d20 7b73 6861 7065 7d27 2066  ape = {shape}' f
+00016700: 6f72 2062 742e 5369 7a65 2028 6261 7463  or bt.Size (batc
+00016710: 6820 6469 6d65 6e73 696f 6e20 6361 6e20  h dimension can 
+00016720: 6f6e 6c79 2062 6520 7468 6520 6669 7273  only be the firs
+00016730: 742f 6c61 7374 2064 696d 656e 7369 6f6e  t/last dimension
+00016740: 2061 7061 7274 2066 726f 6d20 7468 6520   apart from the 
+00016750: 6675 6e63 7469 6f6e 616c 2064 696d 656e  functional dimen
+00016760: 7369 6f6e 292e 2229 290a 2020 2020 2020  sion).")).      
+00016770: 2020 2020 2020 2020 2020 6176 6f75 6368            avouch
+00016780: 2869 2069 6e20 286d 6178 5f28 737a 5f66  (i in (max_(sz_f
+00016790: 756e 635f 6469 6d2c 2030 292c 206c 656e  unc_dim, 0), len
+000167a0: 2873 6861 7065 2920 2d20 3120 2b20 6d69  (shape) - 1 + mi
+000167b0: 6e5f 2873 7a5f 6675 6e63 5f64 696d 2c20  n_(sz_func_dim, 
+000167c0: 3029 292c 2054 7970 6545 7272 6f72 2866  0)), TypeError(f
+000167d0: 2249 6e76 616c 6964 2027 7368 6170 6520  "Invalid 'shape 
+000167e0: 3d20 7b73 6861 7065 7d27 2066 6f72 2062  = {shape}' for b
+000167f0: 742e 5369 7a65 2028 6261 7463 6820 6469  t.Size (batch di
+00016800: 6d65 6e73 696f 6e20 6361 6e20 6f6e 6c79  mension can only
+00016810: 2062 6520 7468 6520 6669 7273 742f 6c61   be the first/la
+00016820: 7374 2064 696d 656e 7369 6f6e 2061 7061  st dimension apa
+00016830: 7274 2066 726f 6d20 7468 6520 6675 6e63  rt from the func
+00016840: 7469 6f6e 616c 2064 696d 656e 7369 6f6e  tional dimension
+00016850: 292e 2229 290a 2020 2020 2020 2020 2020  ).")).          
+00016860: 2020 2020 2020 6966 206c 656e 2873 2920        if len(s) 
+00016870: 3d3d 2030 3a20 7261 775f 7369 7a65 2e61  == 0: raw_size.a
+00016880: 7070 656e 6428 2d31 290a 2020 2020 2020  ppend(-1).      
+00016890: 2020 2020 2020 2020 2020 656c 7365 3a20            else: 
+000168a0: 7820 3d20 732e 706f 7028 293b 2072 6177  x = s.pop(); raw
+000168b0: 5f73 697a 652e 6170 7065 6e64 2878 293b  _size.append(x);
+000168c0: 2073 6861 7065 5b69 5d2e 6164 6428 7829   shape[i].add(x)
+000168d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000168e0: 2069 6620 6920 3d3d 206d 6178 5f28 737a   if i == max_(sz
+000168f0: 5f66 756e 635f 6469 6d2c 2030 293a 0a20  _func_dim, 0):. 
+00016900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016910: 2020 2073 7a5f 6261 7463 685f 6469 6d20     sz_batch_dim 
+00016920: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+00016930: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00016940: 2020 2020 2020 2020 2020 2020 2020 737a                sz
+00016950: 5f62 6174 6368 5f64 696d 203d 202d 310a  _batch_dim = -1.
+00016960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016970: 2020 2020 656e 6473 5f77 6974 685f 6261      ends_with_ba
+00016980: 7463 6820 3d20 5472 7565 0a20 2020 2020  tch = True.     
+00016990: 2020 2020 2020 2020 2020 2063 756d 5f69             cum_i
+000169a0: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+000169b0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+000169c0: 6528 732c 206c 6973 7429 3a20 2320 6665  e(s, list): # fe
+000169d0: 6174 7572 6520 6469 6d65 6e73 696f 6e73  ature dimensions
+000169e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000169f0: 2061 766f 7563 6828 737a 5f66 6561 7475   avouch(sz_featu
+00016a00: 7265 5f64 696d 203c 3d20 3020 6f72 2069  re_dim <= 0 or i
+00016a10: 7369 6e73 7461 6e63 6528 7368 6170 655b  sinstance(shape[
+00016a20: 692d 315d 2c20 2874 7570 6c65 2c20 6469  i-1], (tuple, di
+00016a30: 6374 2c20 7365 742c 206c 6973 7429 292c  ct, set, list)),
+00016a40: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+00016a50: 2020 2020 2020 2020 2054 7970 6545 7272           TypeErr
+00016a60: 6f72 2866 2249 6e76 616c 6964 2027 7368  or(f"Invalid 'sh
+00016a70: 6170 6520 3d20 7b73 6861 7065 7d27 2066  ape = {shape}' f
+00016a80: 6f72 2062 742e 5369 7a65 2028 6665 6174  or bt.Size (feat
+00016a90: 7572 6520 6469 6d65 6e73 696f 6e73 2073  ure dimensions s
+00016aa0: 686f 756c 6420 6265 206e 6569 6768 626f  hould be neighbo
+00016ab0: 7269 6e67 2064 696d 656e 7369 6f6e 7329  ring dimensions)
+00016ac0: 2e22 2929 0a20 2020 2020 2020 2020 2020  .")).           
+00016ad0: 2020 2020 2061 766f 7563 6828 616c 6c5f       avouch(all_
+00016ae0: 285b 6973 696e 7374 616e 6365 2879 2c20  ([isinstance(y, 
+00016af0: 6e75 6d5f 2920 666f 7220 7920 696e 2073  num_) for y in s
+00016b00: 5d29 2c20 5479 7065 4572 726f 7228 6622  ]), TypeError(f"
+00016b10: 496e 7661 6c69 6420 2773 6861 7065 203d  Invalid 'shape =
+00016b20: 207b 7368 6170 657d 2720 666f 7220 6274   {shape}' for bt
+00016b30: 2e53 697a 6520 2872 6570 7265 7365 6e74  .Size (represent
+00016b40: 6174 696f 6e20 666f 7220 6665 6174 7572  ation for featur
+00016b50: 6520 6469 6d65 6e73 696f 6e73 2073 686f  e dimensions sho
+00016b60: 756c 6420 6265 2061 206c 6973 7420 6f66  uld be a list of
+00016b70: 2069 6e74 6567 6572 7329 2e22 2929 0a20   integers).")). 
+00016b80: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00016b90: 766f 7563 6828 6e6f 7420 656e 6473 5f77  vouch(not ends_w
+00016ba0: 6974 685f 6261 7463 6820 616e 6420 6e6f  ith_batch and no
+00016bb0: 7420 656e 6473 5f77 6974 685f 6675 6e63  t ends_with_func
+00016bc0: 2c20 5479 7065 4572 726f 7228 6622 496e  , TypeError(f"In
+00016bd0: 7661 6c69 6420 2773 6861 7065 203d 207b  valid 'shape = {
+00016be0: 7368 6170 657d 2720 666f 7220 6274 2e53  shape}' for bt.S
+00016bf0: 697a 6520 2862 6174 6368 2064 696d 656e  ize (batch dimen
+00016c00: 7369 6f6e 2063 616e 206f 6e6c 7920 6265  sion can only be
+00016c10: 2074 6865 2066 6972 7374 2f6c 6173 7420   the first/last 
+00016c20: 6469 6d65 6e73 696f 6e20 6170 6172 7420  dimension apart 
+00016c30: 6672 6f6d 2074 6865 2066 756e 6374 696f  from the functio
+00016c40: 6e61 6c20 6469 6d65 6e73 696f 6e29 2e22  nal dimension)."
+00016c50: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00016c60: 2020 2069 6620 6c65 6e28 7329 203d 3d20     if len(s) == 
+00016c70: 303a 2072 6177 5f73 697a 652e 6170 7065  0: raw_size.appe
+00016c80: 6e64 282d 3129 3b20 6c65 6e5f 6665 6174  nd(-1); len_feat
+00016c90: 203d 2031 0a20 2020 2020 2020 2020 2020   = 1.           
+00016ca0: 2020 2020 2065 6c73 653a 2072 6177 5f73       else: raw_s
+00016cb0: 697a 652e 6578 7465 6e64 2873 293b 206c  ize.extend(s); l
+00016cc0: 656e 5f66 6561 7420 3d20 6c65 6e28 7329  en_feat = len(s)
+00016cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016ce0: 2069 6620 737a 5f66 6561 7475 7265 5f64   if sz_feature_d
+00016cf0: 696d 203d 3d20 303a 0a20 2020 2020 2020  im == 0:.       
+00016d00: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00016d10: 6375 6d5f 6920 3d3d 206d 6178 5f28 737a  cum_i == max_(sz
+00016d20: 5f66 756e 635f 6469 6d2c 2030 2920 2b20  _func_dim, 0) + 
+00016d30: 6d61 785f 2873 7a5f 6261 7463 685f 6469  max_(sz_batch_di
+00016d40: 6d2c 2030 293a 2073 7a5f 6665 6174 7572  m, 0): sz_featur
+00016d50: 655f 6469 6d20 3d20 6c65 6e5f 6665 6174  e_dim = len_feat
+00016d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016d70: 2020 2020 2065 6c73 653a 2073 7a5f 6665       else: sz_fe
+00016d80: 6174 7572 655f 6469 6d20 3d20 2d6c 656e  ature_dim = -len
+00016d90: 5f66 6561 740a 2020 2020 2020 2020 2020  _feat.          
+00016da0: 2020 2020 2020 656c 6966 2073 7a5f 6665        elif sz_fe
+00016db0: 6174 7572 655f 6469 6d20 3e20 303a 2073  ature_dim > 0: s
+00016dc0: 7a5f 6665 6174 7572 655f 6469 6d20 2b3d  z_feature_dim +=
+00016dd0: 206c 656e 5f66 6561 740a 2020 2020 2020   len_feat.      
+00016de0: 2020 2020 2020 2020 2020 656c 7365 3a20            else: 
+00016df0: 737a 5f66 6561 7475 7265 5f64 696d 202d  sz_feature_dim -
+00016e00: 3d20 6c65 6e5f 6665 6174 0a20 2020 2020  = len_feat.     
+00016e10: 2020 2020 2020 2020 2020 2069 6620 737a             if sz
+00016e20: 5f66 6561 7475 7265 5f64 696d 203c 2030  _feature_dim < 0
+00016e30: 3a20 656e 6473 5f77 6974 685f 6665 6174  : ends_with_feat
+00016e40: 7572 6520 3d20 5472 7565 0a20 2020 2020  ure = True.     
+00016e50: 2020 2020 2020 2020 2020 2063 756d 5f69             cum_i
+00016e60: 202b 3d20 6c65 6e5f 6665 6174 0a20 2020   += len_feat.   
+00016e70: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
+00016e80: 696e 7374 616e 6365 2873 2c20 7374 7229  instance(s, str)
+00016e90: 3a20 2320 7365 7175 656e 6365 2064 696d  : # sequence dim
+00016ea0: 656e 7369 6f6e 730a 2020 2020 2020 2020  ensions.        
+00016eb0: 2020 2020 2020 2020 735f 7661 6c20 3d20          s_val = 
+00016ec0: 2d31 2069 6620 7320 3d3d 2027 2720 656c  -1 if s == '' el
+00016ed0: 7365 2074 6f75 6368 286c 616d 6264 613a  se touch(lambda:
+00016ee0: 2065 7661 6c28 7329 290a 2020 2020 2020   eval(s)).      
+00016ef0: 2020 2020 2020 2020 2020 6176 6f75 6368            avouch
+00016f00: 2873 7a5f 7365 7175 656e 6365 5f64 696d  (sz_sequence_dim
+00016f10: 203c 3d20 3020 6f72 2069 7369 6e73 7461   <= 0 or isinsta
+00016f20: 6e63 6528 7368 6170 655b 692d 315d 2c20  nce(shape[i-1], 
+00016f30: 2874 7570 6c65 2c20 6469 6374 2c20 7365  (tuple, dict, se
+00016f40: 742c 206c 6973 742c 2073 7472 2929 2c0a  t, list, str)),.
+00016f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016f60: 2020 2020 2020 2054 7970 6545 7272 6f72         TypeError
+00016f70: 2866 2249 6e76 616c 6964 2027 7368 6170  (f"Invalid 'shap
+00016f80: 6520 3d20 7b73 6861 7065 7d27 2066 6f72  e = {shape}' for
+00016f90: 2062 742e 5369 7a65 2028 7365 7175 656e   bt.Size (sequen
+00016fa0: 6365 2064 696d 656e 7369 6f6e 7320 7368  ce dimensions sh
+00016fb0: 6f75 6c64 2062 6520 6e65 6967 6862 6f72  ould be neighbor
+00016fc0: 696e 6720 6469 6d65 6e73 696f 6e73 292e  ing dimensions).
+00016fd0: 2229 290a 2020 2020 2020 2020 2020 2020  ")).            
+00016fe0: 2020 2020 6176 6f75 6368 2873 5f76 616c      avouch(s_val
+00016ff0: 2069 7320 6e6f 7420 4e6f 6e65 2c20 5479   is not None, Ty
+00017000: 7065 4572 726f 7228 6622 496e 7661 6c69  peError(f"Invali
+00017010: 6420 2773 6861 7065 203d 207b 7368 6170  d 'shape = {shap
+00017020: 657d 2720 666f 7220 6274 2e53 697a 6520  e}' for bt.Size 
+00017030: 2872 6570 7265 7365 6e74 6174 696f 6e20  (representation 
+00017040: 666f 7220 7365 7175 656e 6365 2064 696d  for sequence dim
+00017050: 656e 7369 6f6e 7320 7368 6f75 6c64 2062  ensions should b
+00017060: 6520 6120 6c69 7374 206f 6620 696e 7465  e a list of inte
+00017070: 6765 7273 292e 2229 290a 2020 2020 2020  gers).")).      
+00017080: 2020 2020 2020 2020 2020 6176 6f75 6368            avouch
+00017090: 286e 6f74 2065 6e64 735f 7769 7468 5f66  (not ends_with_f
+000170a0: 6561 7475 7265 2061 6e64 206e 6f74 2065  eature and not e
+000170b0: 6e64 735f 7769 7468 5f62 6174 6368 2061  nds_with_batch a
+000170c0: 6e64 206e 6f74 2065 6e64 735f 7769 7468  nd not ends_with
+000170d0: 5f66 756e 632c 2054 7970 6545 7272 6f72  _func, TypeError
+000170e0: 2866 2249 6e76 616c 6964 2027 7368 6170  (f"Invalid 'shap
+000170f0: 6520 3d20 7b73 6861 7065 7d27 2066 6f72  e = {shape}' for
+00017100: 2062 742e 5369 7a65 2028 6665 6174 7572   bt.Size (featur
+00017110: 6520 6469 6d65 6e73 696f 6e73 2063 616e  e dimensions can
+00017120: 206f 6e6c 7920 6265 2074 6865 2066 6972   only be the fir
+00017130: 7374 2f6c 6173 7420 6469 6d65 6e73 696f  st/last dimensio
+00017140: 6e73 2061 7061 7274 2066 726f 6d20 7468  ns apart from th
+00017150: 6520 6675 6e63 7469 6f6e 616c 2f62 6174  e functional/bat
+00017160: 6368 2064 696d 656e 7369 6f6e 7329 2e22  ch dimensions)."
+00017170: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00017180: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
+00017190: 616e 6365 2873 5f76 616c 2c20 7475 706c  ance(s_val, tupl
+000171a0: 6529 3a20 735f 7661 6c20 3d20 2873 5f76  e): s_val = (s_v
+000171b0: 616c 2c29 0a20 2020 2020 2020 2020 2020  al,).           
+000171c0: 2020 2020 2073 5f76 616c 203d 206c 6973       s_val = lis
+000171d0: 7428 735f 7661 6c29 0a20 2020 2020 2020  t(s_val).       
+000171e0: 2020 2020 2020 2020 2061 766f 7563 6828           avouch(
+000171f0: 616c 6c5f 285b 6973 696e 7374 616e 6365  all_([isinstance
+00017200: 2879 2c20 6e75 6d5f 2920 666f 7220 7920  (y, num_) for y 
+00017210: 696e 2073 5f76 616c 5d29 2c20 5479 7065  in s_val]), Type
+00017220: 4572 726f 7228 6622 496e 7661 6c69 6420  Error(f"Invalid 
+00017230: 2773 6861 7065 203d 207b 7368 6170 657d  'shape = {shape}
+00017240: 2720 666f 7220 6274 2e53 697a 6520 2872  ' for bt.Size (r
+00017250: 6570 7265 7365 6e74 6174 696f 6e20 666f  epresentation fo
+00017260: 7220 7365 7175 656e 6365 2064 696d 656e  r sequence dimen
+00017270: 7369 6f6e 7320 7368 6f75 6c64 2062 6520  sions should be 
+00017280: 6120 6c69 7374 206f 6620 696e 7465 6765  a list of intege
+00017290: 7273 292e 2229 290a 2020 2020 2020 2020  rs).")).        
+000172a0: 2020 2020 2020 2020 7261 775f 7369 7a65          raw_size
+000172b0: 2e65 7874 656e 6428 735f 7661 6c29 3b20  .extend(s_val); 
+000172c0: 6c65 6e5f 7371 7320 3d20 6c65 6e28 735f  len_sqs = len(s_
+000172d0: 7661 6c29 0a20 2020 2020 2020 2020 2020  val).           
+000172e0: 2020 2020 2069 6620 737a 5f73 6571 7565       if sz_seque
+000172f0: 6e63 655f 6469 6d20 3d3d 2030 3a0a 2020  nce_dim == 0:.  
+00017300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017310: 2020 656e 6473 5f77 6974 685f 7365 7175    ends_with_sequ
+00017320: 656e 6365 203d 2063 756d 5f69 203e 206d  ence = cum_i > m
+00017330: 6178 5f28 737a 5f66 756e 635f 6469 6d2c  ax_(sz_func_dim,
+00017340: 2030 2920 2b20 6d61 785f 2873 7a5f 6261   0) + max_(sz_ba
+00017350: 7463 685f 6469 6d2c 2030 2920 2b20 6d61  tch_dim, 0) + ma
+00017360: 785f 2873 7a5f 6665 6174 7572 655f 6469  x_(sz_feature_di
+00017370: 6d2c 2030 290a 2020 2020 2020 2020 2020  m, 0).          
+00017380: 2020 2020 2020 2020 2020 737a 5f73 6571            sz_seq
+00017390: 7565 6e63 655f 6469 6d20 3d20 2d6c 656e  uence_dim = -len
+000173a0: 5f73 7173 0a20 2020 2020 2020 2020 2020  _sqs.           
+000173b0: 2020 2020 2065 6c69 6620 737a 5f73 6571       elif sz_seq
+000173c0: 7565 6e63 655f 6469 6d20 3e20 303a 2073  uence_dim > 0: s
+000173d0: 7a5f 7365 7175 656e 6365 5f64 696d 202b  z_sequence_dim +
+000173e0: 3d20 6c65 6e5f 7371 730a 2020 2020 2020  = len_sqs.      
+000173f0: 2020 2020 2020 2020 2020 656c 7365 3a20            else: 
+00017400: 737a 5f73 6571 7565 6e63 655f 6469 6d20  sz_sequence_dim 
+00017410: 2d3d 206c 656e 5f73 7173 0a20 2020 2020  -= len_sqs.     
+00017420: 2020 2020 2020 2020 2020 2063 756d 5f69             cum_i
+00017430: 202b 3d20 6c65 6e5f 7371 730a 2020 2020   += len_sqs.    
+00017440: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
+00017450: 6e73 7461 6e63 6528 732c 206e 756d 5f29  nstance(s, num_)
+00017460: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017470: 2020 6176 6f75 6368 286e 6f74 2065 6e64    avouch(not end
+00017480: 735f 7769 7468 5f73 6571 7565 6e63 6520  s_with_sequence 
+00017490: 616e 6420 6e6f 7420 656e 6473 5f77 6974  and not ends_wit
+000174a0: 685f 6665 6174 7572 6520 616e 6420 6e6f  h_feature and no
+000174b0: 7420 656e 6473 5f77 6974 685f 6261 7463  t ends_with_batc
+000174c0: 6820 616e 6420 6e6f 7420 656e 6473 5f77  h and not ends_w
+000174d0: 6974 685f 6675 6e63 2c20 5479 7065 4572  ith_func, TypeEr
+000174e0: 726f 7228 6622 496e 7661 6c69 6420 2773  ror(f"Invalid 's
+000174f0: 6861 7065 203d 207b 7368 6170 657d 2720  hape = {shape}' 
+00017500: 666f 7220 6274 2e53 697a 6520 2873 6571  for bt.Size (seq
+00017510: 7565 6e63 6520 6469 6d65 6e73 696f 6e73  uence dimensions
+00017520: 2063 616e 206f 6e6c 7920 6265 2074 6865   can only be the
+00017530: 2066 6972 7374 2f6c 6173 7420 6469 6d65   first/last dime
+00017540: 6e73 696f 6e73 2061 7061 7274 2066 726f  nsions apart fro
+00017550: 6d20 7468 6520 6675 6e63 7469 6f6e 616c  m the functional
+00017560: 2f62 6174 6368 2f66 6561 7475 7265 2064  /batch/feature d
+00017570: 696d 656e 7369 6f6e 7329 2e22 2929 0a20  imensions).")). 
+00017580: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00017590: 6620 737a 5f73 6571 7565 6e63 655f 6469  f sz_sequence_di
+000175a0: 6d20 3c20 303a 2073 7a5f 7365 7175 656e  m < 0: sz_sequen
+000175b0: 6365 5f64 696d 203d 202d 737a 5f73 6571  ce_dim = -sz_seq
+000175c0: 7565 6e63 655f 6469 6d0a 2020 2020 2020  uence_dim.      
+000175d0: 2020 2020 2020 2020 2020 7261 775f 7369            raw_si
+000175e0: 7a65 2e61 7070 656e 6428 7329 0a20 2020  ze.append(s).   
+000175f0: 2020 2020 2020 2020 2020 2020 2063 756d               cum
+00017600: 5f69 202b 3d20 310a 2020 2020 2020 2020  _i += 1.        
+00017610: 2020 2020 656c 7365 3a20 7261 6973 6520      else: raise 
+00017620: 5479 7065 4572 726f 7228 6622 496e 7661  TypeError(f"Inva
+00017630: 6c69 6420 2773 6861 7065 203d 207b 7368  lid 'shape = {sh
+00017640: 6170 657d 2720 666f 7220 6274 2e53 697a  ape}' for bt.Siz
+00017650: 6520 286f 6e6c 7920 2878 2c29 2866 756e  e (only (x,)(fun
+00017660: 6374 696f 6e61 6c20 6469 6d65 6e73 696f  ctional dimensio
+00017670: 6e29 2c20 7b7b 787d 7d28 6261 7463 6820  n), {{x}}(batch 
+00017680: 6469 6d65 6e73 696f 6e29 2c20 7b7b 7d7d  dimension), {{}}
+00017690: 2862 6174 6368 2064 696d 656e 7369 6f6e  (batch dimension
+000176a0: 2077 6974 6820 6172 6269 7472 6172 7920   with arbitrary 
+000176b0: 7369 7a65 292c 205b 782c 2079 2c20 2e2e  size), [x, y, ..
+000176c0: 2e5d 2866 6561 7475 7265 2064 696d 656e  .](feature dimen
+000176d0: 7369 6f6e 7329 2c20 5b5d 2866 6561 7475  sions), [](featu
+000176e0: 7265 2064 696d 656e 7369 6f6e 2077 6974  re dimension wit
+000176f0: 6820 6172 6269 7472 6172 7920 7369 7a65  h arbitrary size
+00017700: 2929 2c20 2778 2c20 792c 202e 2e2e 2728  )), 'x, y, ...'(
+00017710: 7365 7175 656e 6365 2064 696d 656e 7369  sequence dimensi
+00017720: 6f6e 7329 2c20 616e 6420 2727 2873 6571  ons), and ''(seq
+00017730: 7565 6e63 6520 6469 6d65 6e73 696f 6e20  uence dimension 
+00017740: 7769 7468 2061 7262 6974 7261 7279 2073  with arbitrary s
+00017750: 697a 6529 2061 7265 2061 6c6c 6f77 6564  ize) are allowed
+00017760: 2061 7320 7370 6563 6961 6c20 6469 6d65   as special dime
+00017770: 6e73 696f 6e73 2069 6e20 6274 2e53 697a  nsions in bt.Siz
+00017780: 6529 2e22 290a 0a20 2020 2020 2020 2072  e).")..        r
+00017790: 6574 7572 6e20 636c 732e 5f5f 6e65 775f  eturn cls.__new_
+000177a0: 7261 775f 5f28 7475 706c 6528 7261 775f  raw__(tuple(raw_
+000177b0: 7369 7a65 292c 2073 7a5f 6675 6e63 5f64  size), sz_func_d
+000177c0: 696d 3d73 7a5f 6675 6e63 5f64 696d 2c20  im=sz_func_dim, 
+000177d0: 737a 5f62 6174 6368 5f64 696d 3d73 7a5f  sz_batch_dim=sz_
+000177e0: 6261 7463 685f 6469 6d2c 2073 7a5f 6665  batch_dim, sz_fe
+000177f0: 6174 7572 655f 6469 6d3d 737a 5f66 6561  ature_dim=sz_fea
+00017800: 7475 7265 5f64 696d 2c20 737a 5f73 6571  ture_dim, sz_seq
+00017810: 7565 6e63 655f 6469 6d3d 737a 5f73 6571  uence_dim=sz_seq
+00017820: 7565 6e63 655f 6469 6d29 0a0a 2020 2020  uence_dim)..    
+00017830: 6465 6620 5f5f 6e65 775f 5f28 636c 732c  def __new__(cls,
+00017840: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
+00017850: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+00017860: 2020 2020 2020 2054 6865 2063 6f6e 7374         The const
+00017870: 7275 6374 696f 6e20 6675 6e63 7469 6f6e  ruction function
+00017880: 2066 6f72 2027 6274 2e53 697a 6527 2e20   for 'bt.Size'. 
+00017890: 0a0a 2020 2020 2020 2020 5573 6167 6573  ..        Usages
+000178a0: 3a0a 2020 2020 2020 2020 2020 2020 6274  :.            bt
+000178b0: 2e53 697a 6528 7368 6170 653a 2074 6f72  .Size(shape: tor
+000178c0: 6368 2e54 656e 736f 722f 6274 2e54 656e  ch.Tensor/bt.Ten
+000178d0: 736f 722f 6274 2e53 697a 652f 6765 6e65  sor/bt.Size/gene
+000178e0: 7261 746f 722f 7475 706c 652f 7374 722c  rator/tuple/str,
+000178f0: 2062 6174 6368 5f64 696d 3d46 616c 7365   batch_dim=False
+00017900: 2c20 6e5f 6665 6174 7572 655f 6469 6d3d  , n_feature_dim=
+00017910: 4e6f 6e65 2c20 6e5f 7365 7175 656e 6365  None, n_sequence
+00017920: 5f64 696d 3d6e 5f73 6571 7565 6e63 655f  _dim=n_sequence_
+00017930: 6469 6d29 0a20 2020 2020 2020 2020 2020  dim).           
+00017940: 2062 742e 5369 7a65 282a 7368 6170 653a   bt.Size(*shape:
+00017950: 2070 7974 686f 6e5f 7265 7072 5b69 6e74   python_repr[int
+00017960: 2c20 6469 6374 5b30 5d2c 2073 6574 5b31  , dict[0], set[1
+00017970: 5d2c 206c 6973 745b 5d2c 2073 7472 5d2c  ], list[], str],
+00017980: 2062 6174 6368 5f64 696d 3d46 616c 7365   batch_dim=False
+00017990: 2c20 6e5f 6665 6174 7572 655f 6469 6d3d  , n_feature_dim=
+000179a0: 4e6f 6e65 2c20 6e5f 7365 7175 656e 6365  None, n_sequence
+000179b0: 5f64 696d 3d6e 5f73 6571 7565 6e63 655f  _dim=n_sequence_
+000179c0: 6469 6d29 0a20 2020 2020 2020 2020 2020  dim).           
+000179d0: 204f 6e65 206d 6179 2075 7365 2027 6368   One may use 'ch
+000179e0: 616e 6e65 6c5f 6469 6d3d 2a27 2074 6f20  annel_dim=*' to 
+000179f0: 7265 706c 6163 6520 6e5f 6665 6174 7572  replace n_featur
+00017a00: 655f 6469 6d20 6966 2074 6865 7265 2069  e_dim if there i
+00017a10: 7320 6f6e 6c79 206f 6e65 2066 6561 7475  s only one featu
+00017a20: 7265 2064 696d 656e 7369 6f6e 2e20 0a20  re dimension. . 
+00017a30: 2020 2020 2020 2020 2020 2061 6e64 2027             and '
+00017a40: 7365 7175 656e 6365 5f64 696d 3d2a 2720  sequence_dim=*' 
+00017a50: 746f 2072 6570 6c61 6365 206e 5f73 6571  to replace n_seq
+00017a60: 7565 6e63 655f 6469 6d20 6966 2074 6865  uence_dim if the
+00017a70: 7265 2069 7320 6f6e 6c79 206f 6e65 2073  re is only one s
+00017a80: 6571 7565 6e63 6520 6469 6d65 6e73 696f  equence dimensio
+00017a90: 6e2e 200a 2020 2020 2020 2020 0a20 2020  n. .        .   
+00017aa0: 2020 2020 2057 6172 6e69 6e67 3a0a 2020       Warning:.  
+00017ab0: 2020 2020 2020 2020 2020 506c 6561 7365            Please
+00017ac0: 2062 6520 6361 7265 6675 6c20 7573 696e   be careful usin
+00017ad0: 6720 7072 6976 6174 6520 7573 6167 6573  g private usages
+00017ae0: 2069 6e63 6c75 6469 6e67 206b 6579 776f   including keywo
+00017af0: 7264 7320 7374 6172 7469 6e67 2077 6974  rds starting wit
+00017b00: 6820 2773 7a5f 2720 7375 6368 2061 7320  h 'sz_' such as 
+00017b10: 2773 7a5f 6261 7463 685f 6469 6d27 2e20  'sz_batch_dim'. 
+00017b20: 0a20 2020 2020 2020 204e 6f74 6520 7468  .        Note th
+00017b30: 6174 206f 6e65 2063 616e 6e6f 7420 6372  at one cannot cr
+00017b40: 6561 7465 2061 2066 756e 6374 696f 6e61  eate a functiona
+00017b50: 6c20 6469 6d65 6e73 696f 6e20 6279 2070  l dimension by p
+00017b60: 7974 686f 6e20 7265 7072 6573 656e 7461  ython representa
+00017b70: 7469 6f6e 732c 2070 6c65 6173 6520 7573  tions, please us
+00017b80: 6520 6172 6775 6d65 6e74 2060 737a 5f66  e argument `sz_f
+00017b90: 756e 635f 6469 6d60 2069 6e73 7465 6164  unc_dim` instead
+00017ba0: 2e20 0a0a 2020 2020 2020 2020 4578 616d  . ..        Exam
+00017bb0: 706c 6573 3a3a 0a20 2020 2020 2020 2020  ples::.         
+00017bc0: 2020 203e 3e3e 2073 203d 2062 742e 5369     >>> s = bt.Si
+00017bd0: 7a65 287b 327d 2c20 5b33 5d2c 205b 342c  ze({2}, [3], [4,
+00017be0: 2035 5d2c 2036 2c20 372c 2027 3827 290a   5], 6, 7, '8').
+00017bf0: 2020 2020 2020 2020 2020 2020 3e3e 3e20              >>> 
+00017c00: 730a 2020 2020 2020 2020 2020 2020 6261  s.            ba
+00017c10: 746f 7263 682e 5369 7a65 287b 327d 2c20  torch.Size({2}, 
+00017c20: 5b33 2c20 342c 2035 5d2c 2036 2c20 372c  [3, 4, 5], 6, 7,
+00017c30: 2027 3827 290a 2020 2020 2020 2020 2020   '8').          
+00017c40: 2020 3e3e 3e20 732e 6665 6174 7572 650a    >>> s.feature.
+00017c50: 2020 2020 2020 2020 2020 2020 6261 746f              bato
+00017c60: 7263 682e 5369 7a65 285b 332c 2034 2c20  rch.Size([3, 4, 
+00017c70: 355d 290a 2020 2020 2020 2020 2020 2020  5]).            
+00017c80: 3e3e 3e20 732e 7769 7468 5f66 6561 7475  >>> s.with_featu
+00017c90: 7265 2832 290a 2020 2020 2020 2020 2020  re(2).          
+00017ca0: 2020 6261 746f 7263 682e 5369 7a65 287b    batorch.Size({
+00017cb0: 327d 2c20 5b32 5d2c 2036 2c20 372c 2027  2}, [2], 6, 7, '
+00017cc0: 3827 290a 2020 2020 2020 2020 2020 2020  8').            
+00017cd0: 3e3e 3e20 7320 3c3c 2032 2023 2070 6164  >>> s << 2 # pad
+00017ce0: 6469 6e67 0a20 2020 2020 2020 2020 2020  ding.           
+00017cf0: 2062 6174 6f72 6368 2e53 697a 6528 7b32   batorch.Size({2
+00017d00: 7d2c 205b 332c 2034 2c20 355d 2c20 382c  }, [3, 4, 5], 8,
+00017d10: 2039 2c20 2738 2729 0a20 2020 2020 2020   9, '8').       
+00017d20: 2020 2020 203e 3e3e 2073 202a 2a20 3220       >>> s ** 2 
+00017d30: 2320 7265 7065 6174 2074 6f20 656e 6c61  # repeat to enla
+00017d40: 7267 650a 2020 2020 2020 2020 2020 2020  rge.            
+00017d50: 6261 746f 7263 682e 5369 7a65 287b 327d  batorch.Size({2}
+00017d60: 2c20 5b33 2c20 342c 2035 5d2c 2031 322c  , [3, 4, 5], 12,
+00017d70: 2031 342c 2027 3827 290a 2020 2020 2020   14, '8').      
+00017d80: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+00017d90: 206c 656e 2861 7267 7329 203d 3d20 3120   len(args) == 1 
+00017da0: 616e 6420 6861 7361 7474 7228 6172 6773  and hasattr(args
+00017db0: 5b30 5d2c 2027 7368 6170 6527 293a 2061  [0], 'shape'): a
+00017dc0: 7267 7320 3d20 2861 7267 735b 305d 2e73  rgs = (args[0].s
+00017dd0: 6861 7065 2c29 0a20 2020 2020 2020 2069  hape,).        i
+00017de0: 6620 6c65 6e28 6172 6773 2920 3d3d 2031  f len(args) == 1
+00017df0: 2061 6e64 2069 7369 6e73 7461 6e63 6528   and isinstance(
+00017e00: 6172 6773 5b30 5d2c 2047 656e 6572 6174  args[0], Generat
+00017e10: 6f72 293a 2072 6574 7572 6e20 636c 732e  or): return cls.
+00017e20: 5f5f 6e65 775f 7475 706c 655f 5f28 7475  __new_tuple__(tu
+00017e30: 706c 6528 6172 6773 5b30 5d29 2c20 2a2a  ple(args[0]), **
+00017e40: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
+00017e50: 6966 206c 656e 2861 7267 7329 203d 3d20  if len(args) == 
+00017e60: 3120 616e 6420 6973 696e 7374 616e 6365  1 and isinstance
+00017e70: 2861 7267 735b 305d 2c20 4661 6b65 5369  (args[0], FakeSi
+00017e80: 7a65 293a 2072 6574 7572 6e20 636c 732e  ze): return cls.
+00017e90: 5f5f 6e65 775f 7261 775f 5f28 7475 706c  __new_raw__(tupl
+00017ea0: 6528 6172 6773 5b30 5d29 2c20 2a2a 6b77  e(args[0]), **kw
+00017eb0: 6172 6773 292e 7370 6563 6961 6c5f 6672  args).special_fr
+00017ec0: 6f6d 2861 7267 735b 305d 290a 2020 2020  om(args[0]).    
+00017ed0: 2020 2020 6966 206c 656e 2861 7267 7329      if len(args)
+00017ee0: 203d 3d20 3120 616e 6420 6973 696e 7374   == 1 and isinst
+00017ef0: 616e 6365 2861 7267 735b 305d 2c20 5369  ance(args[0], Si
+00017f00: 7a65 293a 2072 6574 7572 6e20 636c 732e  ze): return cls.
+00017f10: 5f5f 6e65 775f 7369 7a65 5f5f 2861 7267  __new_size__(arg
+00017f20: 735b 305d 2c20 2a2a 6b77 6172 6773 290a  s[0], **kwargs).
+00017f30: 2020 2020 2020 2020 6966 206c 656e 2861          if len(a
+00017f40: 7267 7329 203d 3d20 3120 616e 6420 6973  rgs) == 1 and is
+00017f50: 696e 7374 616e 6365 2861 7267 735b 305d  instance(args[0]
+00017f60: 2c20 7475 706c 6529 3a20 7265 7475 726e  , tuple): return
+00017f70: 2063 6c73 2e5f 5f6e 6577 5f74 7570 6c65   cls.__new_tuple
+00017f80: 5f5f 2861 7267 735b 305d 2c20 2a2a 6b77  __(args[0], **kw
+00017f90: 6172 6773 290a 2020 2020 2020 2020 6966  args).        if
+00017fa0: 206c 656e 2861 7267 7329 203d 3d20 3120   len(args) == 1 
+00017fb0: 616e 6420 6973 696e 7374 616e 6365 2861  and isinstance(a
+00017fc0: 7267 735b 305d 2c20 7374 7229 3a0a 2020  rgs[0], str):.  
+00017fd0: 2020 2020 2020 2020 2020 6966 2061 7267            if arg
+00017fe0: 735b 305d 203d 3d20 2727 3a0a 2020 2020  s[0] == '':.    
+00017ff0: 2020 2020 2020 2020 2020 2020 6b77 6172              kwar
+00018000: 6773 5b27 737a 5f73 6571 7565 6e63 655f  gs['sz_sequence_
+00018010: 6469 6d27 5d20 3d20 310a 2020 2020 2020  dim'] = 1.      
+00018020: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00018030: 2063 6c73 2e5f 5f6e 6577 5f74 7570 6c65   cls.__new_tuple
+00018040: 5f5f 2828 2d31 2c29 2c20 2a2a 6b77 6172  __((-1,), **kwar
+00018050: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+00018060: 6966 2074 6f75 6368 286c 616d 6264 613a  if touch(lambda:
+00018070: 2069 6e74 5f28 6172 6773 5b30 5d29 2920   int_(args[0])) 
+00018080: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00018090: 2020 2020 2020 2020 2020 2020 206b 7761               kwa
+000180a0: 7267 735b 2773 7a5f 7365 7175 656e 6365  rgs['sz_sequence
+000180b0: 5f64 696d 275d 203d 2031 0a20 2020 2020  _dim'] = 1.     
+000180c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000180d0: 6e20 636c 732e 5f5f 6e65 775f 7475 706c  n cls.__new_tupl
+000180e0: 655f 5f28 2869 6e74 5f28 6172 6773 5b30  e__((int_(args[0
+000180f0: 5d29 2c29 2c20 2a2a 6b77 6172 6773 290a  ]),), **kwargs).
+00018100: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00018110: 203d 2063 6c73 2e5f 5f6e 6577 5f74 7570   = cls.__new_tup
+00018120: 6c65 5f5f 2865 7661 6c28 6172 6773 5b30  le__(eval(args[0
+00018130: 5d29 2c20 2a2a 6b77 6172 6773 290a 2020  ]), **kwargs).  
+00018140: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00018150: 662e 6e5f 7370 6563 6961 6c5f 6469 6d20  f.n_special_dim 
+00018160: 3e20 3020 6f72 2061 7267 735b 305d 2e73  > 0 or args[0].s
+00018170: 7461 7274 7377 6974 6828 2728 2729 3a20  tartswith('('): 
+00018180: 7265 7475 726e 2073 656c 660a 2020 2020  return self.    
+00018190: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+000181a0: 656c 662e 737a 5f73 6571 7565 6e63 655f  elf.sz_sequence_
+000181b0: 6469 6d5f 282d 7365 6c66 2e6e 5f64 696d  dim_(-self.n_dim
+000181c0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+000181d0: 2063 6c73 2e5f 5f6e 6577 5f74 7570 6c65   cls.__new_tuple
+000181e0: 5f5f 2861 7267 732c 202a 2a6b 7761 7267  __(args, **kwarg
+000181f0: 7329 0a0a 2020 2020 6465 6620 5f5f 696e  s)..    def __in
+00018200: 6974 5f5f 2873 656c 662c 202a 6172 6773  it__(self, *args
+00018210: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00018220: 2020 2020 2073 656c 662e 737a 5f66 756e       self.sz_fun
+00018230: 635f 6469 6d20 3d20 7365 6c66 2e73 7a5f  c_dim = self.sz_
+00018240: 6675 6e63 5f64 696d 0a20 2020 2020 2020  func_dim.       
+00018250: 2073 656c 662e 737a 5f62 6174 6368 5f64   self.sz_batch_d
+00018260: 696d 203d 2073 656c 662e 737a 5f62 6174  im = self.sz_bat
+00018270: 6368 5f64 696d 0a20 2020 2020 2020 2073  ch_dim.        s
+00018280: 656c 662e 737a 5f66 6561 7475 7265 5f64  elf.sz_feature_d
+00018290: 696d 203d 2073 656c 662e 737a 5f66 6561  im = self.sz_fea
+000182a0: 7475 7265 5f64 696d 0a20 2020 2020 2020  ture_dim.       
+000182b0: 2073 656c 662e 737a 5f73 6571 7565 6e63   self.sz_sequenc
+000182c0: 655f 6469 6d20 3d20 7365 6c66 2e73 7a5f  e_dim = self.sz_
+000182d0: 7365 7175 656e 6365 5f64 696d 0a20 2020  sequence_dim.   
+000182e0: 2020 2020 2073 656c 662e 6e5f 6469 6d20       self.n_dim 
+000182f0: 3d20 7365 6c66 2e6e 5f64 696d 0a20 2020  = self.n_dim.   
+00018300: 2020 2020 2073 656c 662e 6e64 696d 203d       self.ndim =
+00018310: 2073 656c 662e 6e5f 6469 6d0a 0a20 2020   self.n_dim..   
+00018320: 2023 2320 6675 6e63 7469 6f6e 616c 2064   ## functional d
+00018330: 696d 656e 7369 6f6e 3a0a 2020 2020 4070  imension:.    @p
+00018340: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+00018350: 6861 735f 6675 6e63 2873 656c 6629 3a20  has_func(self): 
+00018360: 7265 7475 726e 2073 656c 662e 737a 5f66  return self.sz_f
+00018370: 756e 635f 6469 6d20 213d 2030 0a0a 2020  unc_dim != 0..  
+00018380: 2020 4061 6c69 6173 2822 6e66 756e 6364    @alias("nfuncd
+00018390: 696d 2229 0a20 2020 2040 7072 6f70 6572  im").    @proper
+000183a0: 7479 0a20 2020 2064 6566 206e 5f66 756e  ty.    def n_fun
+000183b0: 635f 6469 6d28 7365 6c66 293a 2072 6574  c_dim(self): ret
+000183c0: 7572 6e20 6162 735f 2873 656c 662e 737a  urn abs_(self.sz
+000183d0: 5f66 756e 635f 6469 6d29 0a20 2020 200a  _func_dim).    .
+000183e0: 2020 2020 4061 6c69 6173 2822 6973 5f66      @alias("is_f
+000183f0: 756e 6364 696d 2229 0a20 2020 2064 6566  uncdim").    def
+00018400: 2069 735f 6675 6e63 5f64 696d 2873 656c   is_func_dim(sel
+00018410: 662c 2069 293a 0a20 2020 2020 2020 2061  f, i):.        a
+00018420: 766f 7563 6828 6973 696e 7374 616e 6365  vouch(isinstance
+00018430: 2869 2c20 696e 745f 292c 2054 7970 6545  (i, int_), TypeE
+00018440: 7272 6f72 2866 2249 6e76 616c 6964 2063  rror(f"Invalid c
+00018450: 616c 6c20 2769 735f 6675 6e63 5f64 696d  all 'is_func_dim
+00018460: 287b 697d 2927 3a20 7468 6520 6172 6775  ({i})': the argu
+00018470: 6d65 6e74 2069 7320 6e6f 7420 616e 2069  ment is not an i
+00018480: 6e74 6567 6572 2e20 2229 290a 2020 2020  nteger. ")).    
+00018490: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+000184a0: 6861 735f 6675 6e63 3a20 7265 7475 726e  has_func: return
+000184b0: 2046 616c 7365 0a20 2020 2020 2020 2072   False.        r
+000184c0: 6574 7572 6e20 7365 6c66 2e73 7a5f 6675  eturn self.sz_fu
+000184d0: 6e63 5f64 696d 203d 3d20 3120 616e 6420  nc_dim == 1 and 
+000184e0: 6920 696e 2028 302c 202d 7365 6c66 2e6e  i in (0, -self.n
+000184f0: 5f64 696d 2920 6f72 2073 656c 662e 737a  _dim) or self.sz
+00018500: 5f66 756e 635f 6469 6d20 3d3d 202d 3120  _func_dim == -1 
+00018510: 616e 6420 6920 696e 2028 7365 6c66 2e6e  and i in (self.n
+00018520: 5f64 696d 2d31 2c20 2d31 290a 0a20 2020  _dim-1, -1)..   
+00018530: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+00018540: 6566 2066 756e 635f 6469 6d28 7365 6c66  ef func_dim(self
+00018550: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00018560: 6e20 4e6f 6e65 2069 6620 7365 6c66 2e73  n None if self.s
+00018570: 7a5f 6675 6e63 5f64 696d 203d 3d20 3020  z_func_dim == 0 
+00018580: 656c 7365 2028 3020 6966 2073 656c 662e  else (0 if self.
+00018590: 737a 5f66 756e 635f 6469 6d20 3e20 3020  sz_func_dim > 0 
+000185a0: 656c 7365 2073 656c 662e 6e5f 6469 6d2d  else self.n_dim-
+000185b0: 3129 0a20 2020 200a 2020 2020 4061 6c69  1).    .    @ali
+000185c0: 6173 2822 6675 6e63 5f64 696d 656e 7369  as("func_dimensi
+000185d0: 6f6e 2229 0a20 2020 2040 6675 6e63 5f64  on").    @func_d
+000185e0: 696d 2e73 6574 7465 720a 2020 2020 6465  im.setter.    de
+000185f0: 6620 6675 6e63 5f64 696d 2873 656c 662c  f func_dim(self,
+00018600: 2069 6675 6e63 293a 0a20 2020 2020 2020   ifunc):.       
+00018610: 2072 6574 7572 6e20 7365 6c66 2e77 6974   return self.wit
+00018620: 685f 6675 6e63 5f64 696d 2869 6675 6e63  h_func_dim(ifunc
+00018630: 290a 0a20 2020 2040 616c 6961 7328 2266  )..    @alias("f
+00018640: 756e 635f 6469 6d5f 222c 2022 6675 6e63  unc_dim_", "func
+00018650: 5f64 696d 656e 7369 6f6e 5f22 290a 2020  _dimension_").  
+00018660: 2020 4061 6c69 6173 2822 7769 7468 5f66    @alias("with_f
+00018670: 756e 6364 696d 2229 0a20 2020 2064 6566  uncdim").    def
+00018680: 2077 6974 685f 6675 6e63 5f64 696d 2873   with_func_dim(s
+00018690: 656c 662c 2069 6675 6e63 3a20 2869 6e74  elf, ifunc: (int
+000186a0: 2c20 626f 6f6c 2c20 6e75 6c6c 2929 3a0a  , bool, null)):.
+000186b0: 2020 2020 2020 2020 6176 6f75 6368 2869          avouch(i
+000186c0: 6675 6e63 2069 7320 4e6f 6e65 206f 7220  func is None or 
+000186d0: 6973 696e 7374 616e 6365 2869 6675 6e63  isinstance(ifunc
+000186e0: 2c20 626f 6f6c 5f29 206f 7220 6966 756e  , bool_) or ifun
+000186f0: 6320 696e 2028 302c 202d 7365 6c66 2e6e  c in (0, -self.n
+00018700: 5f64 696d 2c20 7365 6c66 2e6e 5f64 696d  _dim, self.n_dim
+00018710: 2d31 2c20 2d31 292c 2054 7970 6545 7272  -1, -1), TypeErr
+00018720: 6f72 2822 2762 742e 5369 7a65 2e77 6974  or("'bt.Size.wit
+00018730: 685f 6675 6e63 5f64 696d 2720 6f6e 6c79  h_func_dim' only
+00018740: 2074 616b 6573 2069 6e70 7574 2062 6f6f   takes input boo
+00018750: 6c20 6f72 2069 6e74 6567 6572 2030 2c20  l or integer 0, 
+00018760: 2d31 2e22 2929 0a20 2020 2020 2020 2069  -1.")).        i
+00018770: 6620 6966 756e 6320 6f72 2069 7369 6e73  f ifunc or isins
+00018780: 7461 6e63 6528 6966 756e 632c 2069 6e74  tance(ifunc, int
+00018790: 5f29 3a0a 2020 2020 2020 2020 2020 2020  _):.            
+000187a0: 6176 6f75 6368 2873 656c 662e 6e5f 6261  avouch(self.n_ba
+000187b0: 7463 685f 6469 6d20 2b20 7365 6c66 2e6e  tch_dim + self.n
+000187c0: 5f66 6561 7475 7265 5f64 696d 202b 2073  _feature_dim + s
+000187d0: 656c 662e 6e5f 7365 7175 656e 6365 5f64  elf.n_sequence_d
+000187e0: 696d 203c 2073 656c 662e 6e5f 6469 6d2c  im < self.n_dim,
+000187f0: 2054 7970 6545 7272 6f72 2866 2243 616e   TypeError(f"Can
+00018800: 6e6f 7420 7365 7420 6675 6e63 5f64 696d  not set func_dim
+00018810: 2066 6f72 2073 697a 6520 7b73 656c 667d   for size {self}
+00018820: 206f 6620 6e6f 6e2d 7370 6563 6961 6c20   of non-special 
+00018830: 6469 6d65 6e73 696f 6e20 307b 2720 2873  dimension 0{' (s
+00018840: 6361 6c61 7229 2720 6966 2073 656c 662e  calar)' if self.
+00018850: 6e5f 6469 6d20 3d3d 2030 2065 6c73 6520  n_dim == 0 else 
+00018860: 2727 7d2e 2229 290a 2020 2020 2020 2020  ''}.")).        
+00018870: 2020 2020 7365 6c66 2e73 7a5f 6675 6e63      self.sz_func
+00018880: 5f64 696d 203d 2031 2069 6620 6966 756e  _dim = 1 if ifun
+00018890: 6320 696e 2028 302c 202d 7365 6c66 2e6e  c in (0, -self.n
+000188a0: 5f64 696d 2c20 5472 7565 2920 656c 7365  _dim, True) else
+000188b0: 202d 310a 2020 2020 2020 2020 656c 7365   -1.        else
+000188c0: 3a20 7365 6c66 2e73 7a5f 6675 6e63 5f64  : self.sz_func_d
+000188d0: 696d 203d 2030 0a20 2020 2020 2020 2072  im = 0.        r
+000188e0: 6574 7572 6e20 7365 6c66 0a0a 2020 2020  eturn self..    
+000188f0: 4061 6c69 6173 2822 737a 5f66 756e 635f  @alias("sz_func_
+00018900: 6469 6d5f 222c 2022 7769 7468 5f73 7a66  dim_", "with_szf
+00018910: 756e 6364 696d 2229 0a20 2020 2064 6566  uncdim").    def
+00018920: 2077 6974 685f 737a 5f66 756e 635f 6469   with_sz_func_di
+00018930: 6d28 7365 6c66 2c20 6e66 6364 696d 293a  m(self, nfcdim):
+00018940: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
+00018950: 6e66 6364 696d 2069 7320 4e6f 6e65 206f  nfcdim is None o
+00018960: 7220 6973 696e 7374 616e 6365 286e 6663  r isinstance(nfc
+00018970: 6469 6d2c 2069 6e74 5f29 2c20 5479 7065  dim, int_), Type
+00018980: 4572 726f 7228 2227 6274 2e53 697a 652e  Error("'bt.Size.
+00018990: 7769 7468 5f73 7a5f 6675 6e63 5f64 696d  with_sz_func_dim
+000189a0: 2720 6f6e 6c79 2074 616b 6573 2069 6e70  ' only takes inp
+000189b0: 7574 206f 6620 616e 2069 6e74 6567 6572  ut of an integer
+000189c0: 2e22 2929 0a20 2020 2020 2020 2069 6620  .")).        if 
+000189d0: 6e66 6364 696d 2069 7320 4e6f 6e65 3a20  nfcdim is None: 
+000189e0: 7365 6c66 2e73 7a5f 6675 6e63 5f64 696d  self.sz_func_dim
+000189f0: 203d 2030 0a20 2020 2020 2020 2065 6c73   = 0.        els
+00018a00: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00018a10: 766f 7563 6828 7365 6c66 2e6e 5f62 6174  vouch(self.n_bat
+00018a20: 6368 5f64 696d 202b 2073 656c 662e 6e5f  ch_dim + self.n_
+00018a30: 6665 6174 7572 655f 6469 6d20 2b20 7365  feature_dim + se
+00018a40: 6c66 2e6e 5f73 6571 7565 6e63 655f 6469  lf.n_sequence_di
+00018a50: 6d20 3c20 7365 6c66 2e6e 5f64 696d 2c20  m < self.n_dim, 
+00018a60: 5479 7065 4572 726f 7228 6622 4361 6e6e  TypeError(f"Cann
+00018a70: 6f74 2073 6574 2066 756e 635f 6469 6d20  ot set func_dim 
+00018a80: 666f 7220 7369 7a65 207b 7365 6c66 7d20  for size {self} 
+00018a90: 6f66 206e 6f6e 2d73 7065 6369 616c 2064  of non-special d
+00018aa0: 696d 656e 7369 6f6e 2030 7b27 2028 7363  imension 0{' (sc
+00018ab0: 616c 6172 2927 2069 6620 7365 6c66 2e6e  alar)' if self.n
+00018ac0: 5f64 696d 203d 3d20 3020 656c 7365 2027  _dim == 0 else '
+00018ad0: 277d 2e22 2929 0a20 2020 2020 2020 2020  '}.")).         
+00018ae0: 2020 2073 656c 662e 737a 5f66 756e 635f     self.sz_func_
+00018af0: 6469 6d20 3d20 6e66 6364 696d 0a20 2020  dim = nfcdim.   
+00018b00: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00018b10: 0a0a 2020 2020 4061 6c69 6173 2822 6e5f  ..    @alias("n_
+00018b20: 6675 6e63 5f64 696d 5f22 2c20 2277 6974  func_dim_", "wit
+00018b30: 685f 6e66 756e 6364 696d 2229 0a20 2020  h_nfuncdim").   
+00018b40: 2064 6566 2077 6974 685f 6e5f 6675 6e63   def with_n_func
+00018b50: 5f64 696d 2873 656c 662c 206e 6663 6469  _dim(self, nfcdi
+00018b60: 6d29 3a0a 2020 2020 2020 2020 6176 6f75  m):.        avou
+00018b70: 6368 286e 6663 6469 6d20 3e3d 2030 2c20  ch(nfcdim >= 0, 
+00018b80: 5479 7065 4572 726f 7228 2227 6274 2e53  TypeError("'bt.S
+00018b90: 697a 652e 7769 7468 5f6e 5f66 756e 635f  ize.with_n_func_
+00018ba0: 6469 6d27 2061 6363 6570 7420 6f6e 6c79  dim' accept only
+00018bb0: 2070 6f73 6974 6976 6520 6e75 6d62 6572   positive number
+00018bc0: 206f 6620 6469 6d65 6e73 696f 6e73 2028   of dimensions (
+00018bd0: 6265 666f 7265 2074 6865 2073 7061 6365  before the space
+00018be0: 2064 696d 656e 7369 6f6e 7329 2e20 2229   dimensions). ")
+00018bf0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00018c00: 2073 656c 662e 7769 7468 5f73 7a5f 6675   self.with_sz_fu
+00018c10: 6e63 5f64 696d 286e 6663 6469 6d29 0a0a  nc_dim(nfcdim)..
+00018c20: 2020 2020 4061 6c69 6173 2822 6e66 756e      @alias("nfun
+00018c30: 6322 2c20 2266 756e 635f 7369 7a65 2229  c", "func_size")
+00018c40: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+00018c50: 2020 2064 6566 206e 5f66 756e 6328 7365     def n_func(se
+00018c60: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
+00018c70: 7572 6e20 7365 6c66 5b73 656c 662e 6675  urn self[self.fu
+00018c80: 6e63 5f64 696d 5d20 6966 2073 656c 662e  nc_dim] if self.
+00018c90: 6861 735f 6675 6e63 2065 6c73 6520 4e6f  has_func else No
+00018ca0: 6e65 0a0a 2020 2020 6465 6620 7769 7468  ne..    def with
+00018cb0: 5f66 756e 6328 7365 6c66 2c20 6e5f 6675  _func(self, n_fu
+00018cc0: 6e63 293a 0a20 2020 2020 2020 2069 6620  nc):.        if 
+00018cd0: 6e5f 6675 6e63 2069 7320 4e6f 6e65 3a20  n_func is None: 
+00018ce0: 7265 7475 726e 2073 656c 665b 7365 6c66  return self[self
+00018cf0: 2e73 697a 655f 7374 6172 743a 7365 6c66  .size_start:self
+00018d00: 2e73 697a 655f 7374 6f70 5d0a 2020 2020  .size_stop].    
+00018d10: 2020 2020 6176 6f75 6368 2869 7369 6e73      avouch(isins
+00018d20: 7461 6e63 6528 6e5f 6675 6e63 2c20 696e  tance(n_func, in
+00018d30: 745f 292c 2054 7970 6545 7272 6f72 2822  t_), TypeError("
+00018d40: 4675 6e63 2073 697a 6520 7368 6f75 6c64  Func size should
+00018d50: 2062 6520 616e 2069 6e74 6567 6572 2e20   be an integer. 
+00018d60: 2229 290a 2020 2020 2020 2020 6966 2073  ")).        if s
+00018d70: 656c 662e 737a 5f66 756e 635f 6469 6d20  elf.sz_func_dim 
+00018d80: 3e3d 2030 3a0a 2020 2020 2020 2020 2020  >= 0:.          
+00018d90: 2020 7265 7475 726e 2066 756e 635f 6469    return func_di
+00018da0: 6d5f 7369 7a65 286e 5f66 756e 6329 202b  m_size(n_func) +
+00018db0: 2073 656c 665b 7365 6c66 2e6e 5f66 756e   self[self.n_fun
+00018dc0: 635f 6469 6d3a 5d0a 2020 2020 2020 2020  c_dim:].        
+00018dd0: 656c 7365 3a20 7265 7475 726e 2073 656c  else: return sel
+00018de0: 665b 3a2d 7365 6c66 2e6e 5f66 756e 635f  f[:-self.n_func_
+00018df0: 6469 6d5d 202b 2066 756e 635f 6469 6d5f  dim] + func_dim_
+00018e00: 7369 7a65 286e 5f66 756e 6329 0a0a 2020  size(n_func)..  
+00018e10: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00018e20: 6465 6620 7369 7a65 5f73 7461 7274 2873  def size_start(s
+00018e30: 656c 6629 3a20 7265 7475 726e 206d 6178  elf): return max
+00018e40: 5f28 7365 6c66 2e73 7a5f 6675 6e63 5f64  _(self.sz_func_d
+00018e50: 696d 2c20 3029 0a20 2020 2040 7072 6f70  im, 0).    @prop
+00018e60: 6572 7479 0a20 2020 2064 6566 2073 697a  erty.    def siz
+00018e70: 655f 7374 6f70 2873 656c 6629 3a20 7265  e_stop(self): re
+00018e80: 7475 726e 2073 656c 662e 6e5f 6469 6d20  turn self.n_dim 
+00018e90: 2b20 6d69 6e5f 2873 656c 662e 737a 5f66  + min_(self.sz_f
+00018ea0: 756e 635f 6469 6d2c 2030 290a 0a20 2020  unc_dim, 0)..   
+00018eb0: 2023 2320 6261 7463 6820 6469 6d65 6e73   ## batch dimens
+00018ec0: 696f 6e3a 0a20 2020 2040 7072 6f70 6572  ion:.    @proper
+00018ed0: 7479 0a20 2020 2064 6566 2068 6173 5f62  ty.    def has_b
+00018ee0: 6174 6368 2873 656c 6629 3a20 7265 7475  atch(self): retu
+00018ef0: 726e 2073 656c 662e 737a 5f62 6174 6368  rn self.sz_batch
+00018f00: 5f64 696d 2021 3d20 300a 0a20 2020 2040  _dim != 0..    @
+00018f10: 616c 6961 7328 226e 6261 7463 6864 696d  alias("nbatchdim
+00018f20: 2229 0a20 2020 2040 7072 6f70 6572 7479  ").    @property
+00018f30: 0a20 2020 2064 6566 206e 5f62 6174 6368  .    def n_batch
+00018f40: 5f64 696d 2873 656c 6629 3a20 7265 7475  _dim(self): retu
+00018f50: 726e 2061 6273 5f28 7365 6c66 2e73 7a5f  rn abs_(self.sz_
+00018f60: 6261 7463 685f 6469 6d29 0a20 2020 200a  batch_dim).    .
+00018f70: 2020 2020 4061 6c69 6173 2822 6973 5f62      @alias("is_b
+00018f80: 6174 6368 6469 6d22 290a 2020 2020 6465  atchdim").    de
+00018f90: 6620 6973 5f62 6174 6368 5f64 696d 2873  f is_batch_dim(s
+00018fa0: 656c 662c 2069 293a 0a20 2020 2020 2020  elf, i):.       
+00018fb0: 2061 766f 7563 6828 6973 696e 7374 616e   avouch(isinstan
+00018fc0: 6365 2869 2c20 696e 745f 292c 2054 7970  ce(i, int_), Typ
+00018fd0: 6545 7272 6f72 2866 2249 6e76 616c 6964  eError(f"Invalid
+00018fe0: 2063 616c 6c20 2769 735f 6261 7463 685f   call 'is_batch_
+00018ff0: 6469 6d28 7b69 7d29 273a 2074 6865 2061  dim({i})': the a
+00019000: 7267 756d 656e 7420 6973 206e 6f74 2061  rgument is not a
+00019010: 6e20 696e 7465 6765 722e 2022 2929 0a20  n integer. ")). 
+00019020: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+00019030: 6c66 2e68 6173 5f62 6174 6368 3a20 7265  lf.has_batch: re
+00019040: 7475 726e 2046 616c 7365 0a20 2020 2020  turn False.     
+00019050: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
+00019060: 7a5f 6261 7463 685f 6469 6d20 3d3d 2031  z_batch_dim == 1
+00019070: 2061 6e64 2069 2069 6e20 2873 656c 662e   and i in (self.
+00019080: 7369 7a65 5f73 7461 7274 2c20 7365 6c66  size_start, self
+00019090: 2e73 697a 655f 7374 6172 742d 7365 6c66  .size_start-self
+000190a0: 2e6e 5f64 696d 2920 6f72 2073 656c 662e  .n_dim) or self.
+000190b0: 737a 5f62 6174 6368 5f64 696d 203d 3d20  sz_batch_dim == 
+000190c0: 2d31 2061 6e64 2069 2069 6e20 2873 656c  -1 and i in (sel
+000190d0: 662e 7369 7a65 5f73 746f 702d 312c 2073  f.size_stop-1, s
+000190e0: 656c 662e 7369 7a65 5f73 746f 702d 312d  elf.size_stop-1-
+000190f0: 7365 6c66 2e6e 5f64 696d 290a 0a20 2020  self.n_dim)..   
+00019100: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+00019110: 6566 2062 6174 6368 5f64 696d 2873 656c  ef batch_dim(sel
+00019120: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
+00019130: 726e 204e 6f6e 6520 6966 2073 656c 662e  rn None if self.
+00019140: 737a 5f62 6174 6368 5f64 696d 203d 3d20  sz_batch_dim == 
+00019150: 3020 656c 7365 2028 7365 6c66 2e73 697a  0 else (self.siz
+00019160: 655f 7374 6172 7420 6966 2073 656c 662e  e_start if self.
+00019170: 737a 5f62 6174 6368 5f64 696d 203e 2030  sz_batch_dim > 0
+00019180: 2065 6c73 6520 7365 6c66 2e73 697a 655f   else self.size_
+00019190: 7374 6f70 2d31 290a 0a20 2020 2040 616c  stop-1)..    @al
+000191a0: 6961 7328 2262 6174 6368 5f64 696d 656e  ias("batch_dimen
+000191b0: 7369 6f6e 2229 0a20 2020 2040 6261 7463  sion").    @batc
+000191c0: 685f 6469 6d2e 7365 7474 6572 0a20 2020  h_dim.setter.   
+000191d0: 2064 6566 2062 6174 6368 5f64 696d 2873   def batch_dim(s
+000191e0: 656c 662c 2069 6261 7463 6829 3a0a 2020  elf, ibatch):.  
+000191f0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00019200: 662e 7769 7468 5f62 6174 6368 5f64 696d  f.with_batch_dim
+00019210: 2869 6261 7463 6829 0a0a 2020 2020 4061  (ibatch)..    @a
+00019220: 6c69 6173 2822 6261 7463 685f 6469 6d5f  lias("batch_dim_
+00019230: 222c 2022 6261 7463 685f 6469 6d65 6e73  ", "batch_dimens
+00019240: 696f 6e5f 2229 0a20 2020 2040 616c 6961  ion_").    @alia
+00019250: 7328 2277 6974 685f 6261 7463 6864 696d  s("with_batchdim
+00019260: 2229 0a20 2020 2064 6566 2077 6974 685f  ").    def with_
+00019270: 6261 7463 685f 6469 6d28 7365 6c66 2c20  batch_dim(self, 
+00019280: 6962 6174 6368 3a20 2869 6e74 2c20 626f  ibatch: (int, bo
+00019290: 6f6c 2c20 6e75 6c6c 2929 3a0a 2020 2020  ol, null)):.    
+000192a0: 2020 2020 6176 6f75 6368 2869 6261 7463      avouch(ibatc
+000192b0: 6820 6973 204e 6f6e 6520 6f72 2069 7369  h is None or isi
+000192c0: 6e73 7461 6e63 6528 6962 6174 6368 2c20  nstance(ibatch, 
+000192d0: 626f 6f6c 5f29 206f 7220 6962 6174 6368  bool_) or ibatch
+000192e0: 2069 6e20 2873 656c 662e 7369 7a65 5f73   in (self.size_s
+000192f0: 7461 7274 2c20 7365 6c66 2e73 697a 655f  tart, self.size_
+00019300: 7374 6172 742d 7365 6c66 2e6e 5f64 696d  start-self.n_dim
+00019310: 2c20 7365 6c66 2e73 697a 655f 7374 6f70  , self.size_stop
+00019320: 2d31 2c20 7365 6c66 2e73 697a 655f 7374  -1, self.size_st
+00019330: 6f70 2d31 2d73 656c 662e 6e5f 6469 6d29  op-1-self.n_dim)
+00019340: 2c20 5479 7065 4572 726f 7228 6622 2762  , TypeError(f"'b
+00019350: 742e 5369 7a65 2e77 6974 685f 6261 7463  t.Size.with_batc
+00019360: 685f 6469 6d27 206f 6e6c 7920 7461 6b65  h_dim' only take
+00019370: 7320 696e 7075 7420 626f 6f6c 206f 7220  s input bool or 
+00019380: 696e 7465 6765 7273 207b 7365 6c66 2e73  integers {self.s
+00019390: 697a 655f 7374 6172 747d 2c20 7b73 656c  ize_start}, {sel
+000193a0: 662e 7369 7a65 5f73 746f 702d 317d 2e22  f.size_stop-1}."
+000193b0: 2929 0a20 2020 2020 2020 2069 6620 6962  )).        if ib
+000193c0: 6174 6368 206f 7220 6973 696e 7374 616e  atch or isinstan
+000193d0: 6365 2869 6261 7463 682c 2069 6e74 5f29  ce(ibatch, int_)
+000193e0: 3a0a 2020 2020 2020 2020 2020 2020 6176  :.            av
+000193f0: 6f75 6368 2873 656c 662e 6e5f 6675 6e63  ouch(self.n_func
+00019400: 5f64 696d 202b 2073 656c 662e 6e5f 6665  _dim + self.n_fe
+00019410: 6174 7572 655f 6469 6d20 2b20 7365 6c66  ature_dim + self
+00019420: 2e6e 5f73 6571 7565 6e63 655f 6469 6d20  .n_sequence_dim 
+00019430: 3c20 7365 6c66 2e6e 5f64 696d 2c20 5479  < self.n_dim, Ty
+00019440: 7065 4572 726f 7228 6622 4361 6e6e 6f74  peError(f"Cannot
+00019450: 2073 6574 2062 6174 6368 5f64 696d 2066   set batch_dim f
+00019460: 6f72 2073 697a 6520 7b73 656c 667d 206f  or size {self} o
+00019470: 6620 6e6f 6e2d 7370 6563 6961 6c20 6469  f non-special di
+00019480: 6d65 6e73 696f 6e20 307b 2720 2873 6361  mension 0{' (sca
+00019490: 6c61 7229 2720 6966 2073 656c 662e 6e5f  lar)' if self.n_
+000194a0: 6469 6d20 3d3d 2030 2065 6c73 6520 2727  dim == 0 else ''
+000194b0: 7d2e 2229 290a 2020 2020 2020 2020 2020  }.")).          
+000194c0: 2020 7365 6c66 2e73 7a5f 6261 7463 685f    self.sz_batch_
+000194d0: 6469 6d20 3d20 3120 6966 2069 6261 7463  dim = 1 if ibatc
+000194e0: 6820 696e 2028 7365 6c66 2e73 697a 655f  h in (self.size_
+000194f0: 7374 6172 742c 2073 656c 662e 7369 7a65  start, self.size
+00019500: 5f73 7461 7274 2d73 656c 662e 6e5f 6469  _start-self.n_di
+00019510: 6d2c 2054 7275 6529 2065 6c73 6520 2d31  m, True) else -1
+00019520: 0a20 2020 2020 2020 2065 6c73 653a 2073  .        else: s
+00019530: 656c 662e 737a 5f62 6174 6368 5f64 696d  elf.sz_batch_dim
+00019540: 203d 2030 0a20 2020 2020 2020 2072 6574   = 0.        ret
+00019550: 7572 6e20 7365 6c66 0a0a 2020 2020 4061  urn self..    @a
+00019560: 6c69 6173 2822 737a 5f62 6174 6368 5f64  lias("sz_batch_d
+00019570: 696d 5f22 2c20 2277 6974 685f 737a 6261  im_", "with_szba
+00019580: 7463 6864 696d 2229 0a20 2020 2064 6566  tchdim").    def
+00019590: 2077 6974 685f 737a 5f62 6174 6368 5f64   with_sz_batch_d
+000195a0: 696d 2873 656c 662c 206e 6264 696d 293a  im(self, nbdim):
+000195b0: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
+000195c0: 6e62 6469 6d20 6973 204e 6f6e 6520 6f72  nbdim is None or
+000195d0: 2069 7369 6e73 7461 6e63 6528 6e62 6469   isinstance(nbdi
+000195e0: 6d2c 2069 6e74 5f29 2c20 5479 7065 4572  m, int_), TypeEr
+000195f0: 726f 7228 2227 6274 2e53 697a 652e 7769  ror("'bt.Size.wi
+00019600: 7468 5f73 7a5f 6261 7463 685f 6469 6d27  th_sz_batch_dim'
+00019610: 206f 6e6c 7920 7461 6b65 7320 696e 7075   only takes inpu
+00019620: 7420 6f66 2061 6e20 696e 7465 6765 722e  t of an integer.
+00019630: 2229 290a 2020 2020 2020 2020 6966 206e  ")).        if n
+00019640: 6264 696d 2069 7320 4e6f 6e65 3a20 7365  bdim is None: se
+00019650: 6c66 2e73 7a5f 6261 7463 685f 6469 6d20  lf.sz_batch_dim 
+00019660: 3d20 300a 2020 2020 2020 2020 656c 7365  = 0.        else
+00019670: 3a0a 2020 2020 2020 2020 2020 2020 6176  :.            av
+00019680: 6f75 6368 2873 656c 662e 6e5f 6675 6e63  ouch(self.n_func
+00019690: 5f64 696d 202b 2073 656c 662e 6e5f 6665  _dim + self.n_fe
+000196a0: 6174 7572 655f 6469 6d20 2b20 7365 6c66  ature_dim + self
+000196b0: 2e6e 5f73 6571 7565 6e63 655f 6469 6d20  .n_sequence_dim 
+000196c0: 3c20 7365 6c66 2e6e 5f64 696d 2c20 5479  < self.n_dim, Ty
+000196d0: 7065 4572 726f 7228 6622 4361 6e6e 6f74  peError(f"Cannot
+000196e0: 2073 6574 2062 6174 6368 5f64 696d 2066   set batch_dim f
+000196f0: 6f72 2073 697a 6520 7b73 656c 667d 206f  or size {self} o
+00019700: 6620 6e6f 6e2d 7370 6563 6961 6c20 6469  f non-special di
+00019710: 6d65 6e73 696f 6e20 307b 2720 2873 6361  mension 0{' (sca
+00019720: 6c61 7229 2720 6966 2073 656c 662e 6e5f  lar)' if self.n_
+00019730: 6469 6d20 3d3d 2030 2065 6c73 6520 2727  dim == 0 else ''
+00019740: 7d2e 2229 290a 2020 2020 2020 2020 2020  }.")).          
+00019750: 2020 7365 6c66 2e73 7a5f 6261 7463 685f    self.sz_batch_
+00019760: 6469 6d20 3d20 6e62 6469 6d0a 2020 2020  dim = nbdim.    
+00019770: 2020 2020 7265 7475 726e 2073 656c 660a      return self.
+00019780: 0a20 2020 2040 616c 6961 7328 226e 5f62  .    @alias("n_b
+00019790: 6174 6368 5f64 696d 5f22 2c20 2277 6974  atch_dim_", "wit
+000197a0: 685f 6e62 6174 6368 6469 6d22 290a 2020  h_nbatchdim").  
+000197b0: 2020 6465 6620 7769 7468 5f6e 5f62 6174    def with_n_bat
+000197c0: 6368 5f64 696d 2873 656c 662c 206e 6264  ch_dim(self, nbd
+000197d0: 696d 293a 0a20 2020 2020 2020 2061 766f  im):.        avo
+000197e0: 7563 6828 6e62 6469 6d20 3e3d 2030 2c20  uch(nbdim >= 0, 
+000197f0: 5479 7065 4572 726f 7228 2227 6274 2e53  TypeError("'bt.S
+00019800: 697a 652e 7769 7468 5f6e 5f62 6174 6368  ize.with_n_batch
+00019810: 5f64 696d 2720 6163 6365 7074 206f 6e6c  _dim' accept onl
+00019820: 7920 706f 7369 7469 7665 206e 756d 6265  y positive numbe
+00019830: 7220 6f66 2064 696d 656e 7369 6f6e 7320  r of dimensions 
+00019840: 2862 6566 6f72 6520 7468 6520 7370 6163  (before the spac
+00019850: 6520 6469 6d65 6e73 696f 6e73 292e 2022  e dimensions). "
+00019860: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
+00019870: 6e20 7365 6c66 2e77 6974 685f 737a 5f62  n self.with_sz_b
+00019880: 6174 6368 5f64 696d 286e 6264 696d 290a  atch_dim(nbdim).
+00019890: 0a20 2020 2040 616c 6961 7328 226e 6261  .    @alias("nba
+000198a0: 7463 6822 2c20 2262 6174 6368 5f73 697a  tch", "batch_siz
+000198b0: 6522 290a 2020 2020 4070 726f 7065 7274  e").    @propert
+000198c0: 790a 2020 2020 6465 6620 6e5f 6261 7463  y.    def n_batc
+000198d0: 6828 7365 6c66 293a 0a20 2020 2020 2020  h(self):.       
+000198e0: 2072 6574 7572 6e20 7365 6c66 5b73 656c   return self[sel
+000198f0: 662e 6261 7463 685f 6469 6d5d 2069 6620  f.batch_dim] if 
+00019900: 7365 6c66 2e68 6173 5f62 6174 6368 2065  self.has_batch e
+00019910: 6c73 6520 4e6f 6e65 0a0a 2020 2020 6465  lse None..    de
+00019920: 6620 7769 7468 5f62 6174 6368 2873 656c  f with_batch(sel
+00019930: 662c 206e 5f62 6174 6368 293a 0a20 2020  f, n_batch):.   
+00019940: 2020 2020 2069 6620 6e5f 6261 7463 6820       if n_batch 
+00019950: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00019960: 2020 2020 2069 6620 7365 6c66 2e73 7a5f       if self.sz_
+00019970: 6675 6e63 5f64 696d 203d 3d20 303a 2072  func_dim == 0: r
+00019980: 6574 7572 6e20 7365 6c66 5b73 656c 662e  eturn self[self.
+00019990: 6e6f 6e5f 6261 745f 7374 6172 743a 7365  non_bat_start:se
+000199a0: 6c66 2e6e 6f6e 5f62 6174 5f73 746f 705d  lf.non_bat_stop]
+000199b0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+000199c0: 6620 7365 6c66 2e73 7a5f 6675 6e63 5f64  f self.sz_func_d
+000199d0: 696d 203e 2030 3a20 7265 7475 726e 2073  im > 0: return s
+000199e0: 656c 665b 3a31 5d20 2b20 7365 6c66 5b73  elf[:1] + self[s
+000199f0: 656c 662e 6e6f 6e5f 6261 745f 7374 6172  elf.non_bat_star
+00019a00: 743a 7365 6c66 2e6e 6f6e 5f62 6174 5f73  t:self.non_bat_s
+00019a10: 746f 705d 0a20 2020 2020 2020 2020 2020  top].           
+00019a20: 2065 6c73 653a 2072 6574 7572 6e20 7365   else: return se
+00019a30: 6c66 5b73 656c 662e 6e6f 6e5f 6261 745f  lf[self.non_bat_
+00019a40: 7374 6172 743a 7365 6c66 2e6e 6f6e 5f62  start:self.non_b
+00019a50: 6174 5f73 746f 705d 202b 2073 656c 665b  at_stop] + self[
+00019a60: 2d31 3a5d 0a20 2020 2020 2020 2061 766f  -1:].        avo
+00019a70: 7563 6828 6973 696e 7374 616e 6365 286e  uch(isinstance(n
+00019a80: 5f62 6174 6368 2c20 696e 745f 292c 2054  _batch, int_), T
+00019a90: 7970 6545 7272 6f72 2822 4261 7463 6820  ypeError("Batch 
+00019aa0: 7369 7a65 2073 686f 756c 6420 6265 2061  size should be a
+00019ab0: 6e20 696e 7465 6765 722e 2022 2929 0a20  n integer. ")). 
+00019ac0: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+00019ad0: 7a5f 6261 7463 685f 6469 6d20 3e20 303a  z_batch_dim > 0:
+00019ae0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00019af0: 7572 6e20 7365 6c66 5b3a 7365 6c66 2e73  urn self[:self.s
+00019b00: 697a 655f 7374 6172 745d 202b 2053 697a  ize_start] + Siz
+00019b10: 6528 7b6e 5f62 6174 6368 7d29 202b 2073  e({n_batch}) + s
+00019b20: 656c 665b 7365 6c66 2e73 697a 655f 7374  elf[self.size_st
+00019b30: 6172 7420 2b20 7365 6c66 2e6e 5f62 6174  art + self.n_bat
+00019b40: 6368 5f64 696d 3a5d 0a20 2020 2020 2020  ch_dim:].       
+00019b50: 2065 6c73 653a 2072 6574 7572 6e20 7365   else: return se
+00019b60: 6c66 5b3a 7365 6c66 2e73 697a 655f 7374  lf[:self.size_st
+00019b70: 6f70 2d73 656c 662e 6e5f 6261 7463 685f  op-self.n_batch_
+00019b80: 6469 6d5d 202b 2053 697a 6528 7b6e 5f62  dim] + Size({n_b
+00019b90: 6174 6368 7d29 202b 2073 656c 665b 7365  atch}) + self[se
+00019ba0: 6c66 2e73 697a 655f 7374 6f70 3a5d 0a0a  lf.size_stop:]..
+00019bb0: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00019bc0: 2020 6465 6620 6e6f 6e5f 6261 745f 7374    def non_bat_st
+00019bd0: 6172 7428 7365 6c66 293a 2072 6574 7572  art(self): retur
+00019be0: 6e20 6d61 785f 2873 656c 662e 737a 5f66  n max_(self.sz_f
+00019bf0: 756e 635f 6469 6d2c 2030 2920 2b20 6d61  unc_dim, 0) + ma
+00019c00: 785f 2873 656c 662e 737a 5f62 6174 6368  x_(self.sz_batch
+00019c10: 5f64 696d 2c20 3029 0a20 2020 2040 7072  _dim, 0).    @pr
+00019c20: 6f70 6572 7479 0a20 2020 2064 6566 206e  operty.    def n
+00019c30: 6f6e 5f62 6174 5f73 746f 7028 7365 6c66  on_bat_stop(self
+00019c40: 293a 2072 6574 7572 6e20 7365 6c66 2e6e  ): return self.n
+00019c50: 5f64 696d 202b 206d 696e 5f28 7365 6c66  _dim + min_(self
+00019c60: 2e73 7a5f 6675 6e63 5f64 696d 2c20 3029  .sz_func_dim, 0)
+00019c70: 202b 206d 696e 5f28 7365 6c66 2e73 7a5f   + min_(self.sz_
+00019c80: 6261 7463 685f 6469 6d2c 2030 290a 0a20  batch_dim, 0).. 
+00019c90: 2020 2023 2320 6368 616e 6e65 6c20 6469     ## channel di
+00019ca0: 6d65 6e73 696f 6e3a 200a 2020 2020 4070  mension: .    @p
+00019cb0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+00019cc0: 6861 735f 6368 616e 6e65 6c28 7365 6c66  has_channel(self
+00019cd0: 293a 2072 6574 7572 6e20 7365 6c66 2e73  ): return self.s
+00019ce0: 7a5f 6665 6174 7572 655f 6469 6d20 696e  z_feature_dim in
+00019cf0: 2028 312c 202d 3129 0a0a 2020 2020 4061   (1, -1)..    @a
+00019d00: 6c69 6173 2822 6e63 6861 6e6e 656c 6469  lias("nchanneldi
+00019d10: 6d22 290a 2020 2020 4070 726f 7065 7274  m").    @propert
+00019d20: 790a 2020 2020 6465 6620 6e5f 6368 616e  y.    def n_chan
+00019d30: 6e65 6c5f 6469 6d28 7365 6c66 293a 2072  nel_dim(self): r
+00019d40: 6574 7572 6e20 696e 745f 2873 656c 662e  eturn int_(self.
+00019d50: 6861 735f 6368 616e 6e65 6c29 0a0a 2020  has_channel)..  
+00019d60: 2020 4061 6c69 6173 2822 6973 5f63 6861    @alias("is_cha
+00019d70: 6e6e 656c 6469 6d22 290a 2020 2020 6465  nneldim").    de
+00019d80: 6620 6973 5f63 6861 6e6e 656c 5f64 696d  f is_channel_dim
+00019d90: 2873 656c 662c 2069 293a 0a20 2020 2020  (self, i):.     
+00019da0: 2020 2061 766f 7563 6828 6973 696e 7374     avouch(isinst
+00019db0: 616e 6365 2869 2c20 696e 745f 292c 2054  ance(i, int_), T
+00019dc0: 7970 6545 7272 6f72 2866 2249 6e76 616c  ypeError(f"Inval
+00019dd0: 6964 2063 616c 6c20 2769 735f 6368 616e  id call 'is_chan
+00019de0: 6e65 6c5f 6469 6d28 7b69 7d29 273a 2074  nel_dim({i})': t
+00019df0: 6865 2061 7267 756d 656e 7420 6973 206e  he argument is n
+00019e00: 6f74 2061 6e20 696e 7465 6765 722e 2022  ot an integer. "
+00019e10: 2929 0a20 2020 2020 2020 2069 6620 6e6f  )).        if no
+00019e20: 7420 7365 6c66 2e68 6173 5f66 6561 7475  t self.has_featu
+00019e30: 7265 3a20 7265 7475 726e 2046 616c 7365  re: return False
+00019e40: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00019e50: 2873 656c 662e 737a 5f66 6561 7475 7265  (self.sz_feature
+00019e60: 5f64 696d 203d 3d20 3120 616e 6420 6920  _dim == 1 and i 
+00019e70: 696e 2028 7365 6c66 2e6e 6f6e 5f62 6174  in (self.non_bat
+00019e80: 5f73 7461 7274 2c20 7365 6c66 2e6e 6f6e  _start, self.non
+00019e90: 5f62 6174 5f73 7461 7274 202d 2073 656c  _bat_start - sel
+00019ea0: 662e 6e5f 6469 6d29 206f 7220 0a20 2020  f.n_dim) or .   
+00019eb0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00019ec0: 662e 737a 5f66 6561 7475 7265 5f64 696d  f.sz_feature_dim
+00019ed0: 203d 3d20 2d31 2061 6e64 2069 2069 6e20   == -1 and i in 
+00019ee0: 2873 656c 662e 6e6f 6e5f 6261 745f 7374  (self.non_bat_st
+00019ef0: 6f70 202d 2031 2c20 7365 6c66 2e6e 6f6e  op - 1, self.non
+00019f00: 5f62 6174 5f73 746f 7020 2d20 7365 6c66  _bat_stop - self
+00019f10: 2e6e 5f64 696d 202d 2031 2929 0a0a 2020  .n_dim - 1))..  
+00019f20: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00019f30: 6465 6620 6368 616e 6e65 6c5f 6469 6d28  def channel_dim(
+00019f40: 7365 6c66 293a 0a20 2020 2020 2020 2061  self):.        a
+00019f50: 766f 7563 6828 7365 6c66 2e73 7a5f 6665  vouch(self.sz_fe
+00019f60: 6174 7572 655f 6469 6d20 696e 2028 312c  ature_dim in (1,
+00019f70: 202d 3129 2c20 5479 7065 4572 726f 7228   -1), TypeError(
+00019f80: 6622 4361 6e6e 6f74 2067 6574 2063 6861  f"Cannot get cha
+00019f90: 6e6e 656c 2064 696d 656e 7369 6f6e 2066  nnel dimension f
+00019fa0: 726f 6d20 7369 7a65 2077 6974 6820 7b73  rom size with {s
+00019fb0: 656c 662e 6e5f 6665 6174 7572 655f 6469  elf.n_feature_di
+00019fc0: 6d7d 2066 6561 7475 7265 2064 696d 656e  m} feature dimen
+00019fd0: 7369 6f6e 732e 2229 290a 2020 2020 2020  sions.")).      
+00019fe0: 2020 7265 7475 726e 2073 656c 662e 6e6f    return self.no
+00019ff0: 6e5f 6261 745f 7374 6172 7420 6966 2073  n_bat_start if s
+0001a000: 656c 662e 737a 5f66 6561 7475 7265 5f64  elf.sz_feature_d
+0001a010: 696d 203e 2030 2065 6c73 6520 7365 6c66  im > 0 else self
+0001a020: 2e6e 6f6e 5f62 6174 5f73 746f 7020 2d20  .non_bat_stop - 
+0001a030: 310a 0a20 2020 2040 616c 6961 7328 2263  1..    @alias("c
+0001a040: 6861 6e6e 656c 5f64 696d 656e 7369 6f6e  hannel_dimension
+0001a050: 2229 0a20 2020 2040 6368 616e 6e65 6c5f  ").    @channel_
+0001a060: 6469 6d2e 7365 7474 6572 0a20 2020 2064  dim.setter.    d
+0001a070: 6566 2063 6861 6e6e 656c 5f64 696d 2873  ef channel_dim(s
+0001a080: 656c 662c 2069 6368 616e 6e65 6c29 3a0a  elf, ichannel):.
+0001a090: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0001a0a0: 656c 662e 7769 7468 5f63 6861 6e6e 656c  elf.with_channel
+0001a0b0: 5f64 696d 2869 6368 616e 6e65 6c29 0a0a  _dim(ichannel)..
+0001a0c0: 2020 2020 4061 6c69 6173 2822 6368 616e      @alias("chan
+0001a0d0: 6e65 6c5f 6469 6d5f 222c 2022 6368 616e  nel_dim_", "chan
+0001a0e0: 6e65 6c5f 6469 6d65 6e73 696f 6e5f 2229  nel_dimension_")
+0001a0f0: 0a20 2020 2040 616c 6961 7328 2277 6974  .    @alias("wit
+0001a100: 685f 6368 616e 6e65 6c64 696d 2229 0a20  h_channeldim"). 
+0001a110: 2020 2064 6566 2077 6974 685f 6368 616e     def with_chan
+0001a120: 6e65 6c5f 6469 6d28 7365 6c66 2c20 6963  nel_dim(self, ic
+0001a130: 6861 6e6e 656c 3a20 2869 6e74 2c20 6e75  hannel: (int, nu
+0001a140: 6c6c 2929 3a0a 2020 2020 2020 2020 6176  ll)):.        av
+0001a150: 6f75 6368 2869 6368 616e 6e65 6c20 6973  ouch(ichannel is
+0001a160: 204e 6f6e 6520 6f72 2069 6368 616e 6e65   None or ichanne
+0001a170: 6c20 696e 2028 7365 6c66 2e6e 6f6e 5f62  l in (self.non_b
+0001a180: 6174 5f73 7461 7274 2c20 7365 6c66 2e6e  at_start, self.n
+0001a190: 6f6e 5f62 6174 5f73 7461 7274 202d 2073  on_bat_start - s
+0001a1a0: 656c 662e 6e5f 6469 6d2c 2073 656c 662e  elf.n_dim, self.
+0001a1b0: 6e6f 6e5f 6261 745f 7374 6f70 202d 2031  non_bat_stop - 1
+0001a1c0: 2c20 7365 6c66 2e6e 6f6e 5f62 6174 5f73  , self.non_bat_s
+0001a1d0: 746f 7020 2d20 7365 6c66 2e6e 5f64 696d  top - self.n_dim
+0001a1e0: 202d 2031 292c 200a 2020 2020 2020 2020   - 1), .        
+0001a1f0: 2020 2020 2020 2054 7970 6545 7272 6f72         TypeError
+0001a200: 2866 2243 6861 6e6e 656c 2064 696d 656e  (f"Channel dimen
+0001a210: 7369 6f6e 206f 6620 7b73 656c 667d 2073  sion of {self} s
+0001a220: 686f 756c 6420 6265 2074 6865 2066 6972  hould be the fir
+0001a230: 7374 206f 7220 6c61 7374 2064 696d 656e  st or last dimen
+0001a240: 7369 6f6e 2061 7061 7274 2066 726f 6d20  sion apart from 
+0001a250: 7468 6520 6261 7463 6820 6469 6d65 6e73  the batch dimens
+0001a260: 696f 6e2c 2077 6869 6368 2061 7265 207b  ion, which are {
+0001a270: 7365 6c66 2e6e 6f6e 5f62 6174 5f73 7461  self.non_bat_sta
+0001a280: 7274 7d20 616e 6420 7b73 656c 662e 6e6f  rt} and {self.no
+0001a290: 6e5f 6261 745f 7374 6f70 202d 2031 7d2e  n_bat_stop - 1}.
+0001a2a0: 2229 290a 2020 2020 2020 2020 6966 2069  ")).        if i
+0001a2b0: 6368 616e 6e65 6c20 6973 204e 6f6e 653a  channel is None:
+0001a2c0: 2073 656c 662e 737a 5f66 6561 7475 7265   self.sz_feature
+0001a2d0: 5f64 696d 203d 2030 0a20 2020 2020 2020  _dim = 0.       
+0001a2e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001a2f0: 2020 2061 766f 7563 6828 7365 6c66 2e6e     avouch(self.n
+0001a300: 5f66 756e 635f 6469 6d20 2b20 7365 6c66  _func_dim + self
+0001a310: 2e6e 5f62 6174 6368 5f64 696d 202b 2073  .n_batch_dim + s
+0001a320: 656c 662e 6e5f 7365 7175 656e 6365 5f64  elf.n_sequence_d
+0001a330: 696d 203c 2073 656c 662e 6e5f 6469 6d2c  im < self.n_dim,
+0001a340: 2054 7970 6545 7272 6f72 2866 2243 616e   TypeError(f"Can
+0001a350: 6e6f 7420 7365 7420 6368 616e 6e65 6c5f  not set channel_
+0001a360: 6469 6d20 666f 7220 7369 7a65 207b 7365  dim for size {se
+0001a370: 6c66 7d20 6f66 206e 6f6e 2d73 7065 6369  lf} of non-speci
+0001a380: 616c 2064 696d 656e 7369 6f6e 2030 2e22  al dimension 0."
+0001a390: 2929 0a20 2020 2020 2020 2020 2020 2073  )).            s
+0001a3a0: 656c 662e 737a 5f66 6561 7475 7265 5f64  elf.sz_feature_d
+0001a3b0: 696d 203d 2031 2069 6620 6963 6861 6e6e  im = 1 if ichann
+0001a3c0: 656c 2069 6e20 2873 656c 662e 6e6f 6e5f  el in (self.non_
+0001a3d0: 6261 745f 7374 6172 742c 2073 656c 662e  bat_start, self.
+0001a3e0: 6e6f 6e5f 6261 745f 7374 6172 7420 2d20  non_bat_start - 
+0001a3f0: 7365 6c66 2e6e 5f64 696d 2920 656c 7365  self.n_dim) else
+0001a400: 202d 310a 2020 2020 2020 2020 7265 7475   -1.        retu
+0001a410: 726e 2073 656c 660a 0a20 2020 2040 616c  rn self..    @al
+0001a420: 6961 7328 226e 6368 616e 6e65 6c22 2c20  ias("nchannel", 
+0001a430: 2263 6861 6e6e 656c 5f73 697a 6522 290a  "channel_size").
+0001a440: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+0001a450: 2020 6465 6620 6e5f 6368 616e 6e65 6c28    def n_channel(
+0001a460: 7365 6c66 293a 0a20 2020 2020 2020 2061  self):.        a
+0001a470: 766f 7563 6828 7365 6c66 2e6e 5f66 6561  vouch(self.n_fea
+0001a480: 7475 7265 5f64 696d 203d 3d20 312c 2054  ture_dim == 1, T
+0001a490: 7970 6545 7272 6f72 2866 2243 616e 6e6f  ypeError(f"Canno
+0001a4a0: 7420 6765 7420 6368 616e 6e65 6c20 6469  t get channel di
+0001a4b0: 6d65 6e73 696f 6e20 6672 6f6d 2073 697a  mension from siz
+0001a4c0: 6520 7769 7468 207b 7365 6c66 2e6e 5f66  e with {self.n_f
+0001a4d0: 6561 7475 7265 5f64 696d 7d20 6665 6174  eature_dim} feat
+0001a4e0: 7572 6520 6469 6d65 6e73 696f 6e73 2e22  ure dimensions."
+0001a4f0: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
+0001a500: 6e20 7365 6c66 5b73 656c 662e 6368 616e  n self[self.chan
+0001a510: 6e65 6c5f 6469 6d5d 0a0a 2020 2020 6465  nel_dim]..    de
+0001a520: 6620 7769 7468 5f63 6861 6e6e 656c 2873  f with_channel(s
+0001a530: 656c 662c 206e 5f63 6861 6e6e 656c 293a  elf, n_channel):
+0001a540: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
+0001a550: 6973 696e 7374 616e 6365 286e 5f63 6861  isinstance(n_cha
+0001a560: 6e6e 656c 2c20 696e 745f 292c 2054 7970  nnel, int_), Typ
+0001a570: 6545 7272 6f72 2822 4368 616e 6e65 6c20  eError("Channel 
+0001a580: 7369 7a65 2073 686f 756c 6420 6265 2061  size should be a
+0001a590: 6e20 696e 7465 6765 722e 2022 2929 0a20  n integer. ")). 
+0001a5a0: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+0001a5b0: 7a5f 6665 6174 7572 655f 6469 6d20 3e20  z_feature_dim > 
+0001a5c0: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
+0001a5d0: 6574 7572 6e20 7365 6c66 5b3a 7365 6c66  eturn self[:self
+0001a5e0: 2e6e 6f6e 5f62 6174 5f73 7461 7274 5d20  .non_bat_start] 
+0001a5f0: 2b20 5369 7a65 285b 6e5f 6368 616e 6e65  + Size([n_channe
+0001a600: 6c5d 2920 2b20 7365 6c66 5b73 656c 662e  l]) + self[self.
+0001a610: 6e6f 6e5f 6261 745f 7374 6172 7420 2b20  non_bat_start + 
+0001a620: 7365 6c66 2e6e 5f66 6561 7475 7265 5f64  self.n_feature_d
+0001a630: 696d 3a5d 0a20 2020 2020 2020 2065 6c73  im:].        els
+0001a640: 653a 2072 6574 7572 6e20 7365 6c66 5b3a  e: return self[:
+0001a650: 7365 6c66 2e6e 6f6e 5f62 6174 5f73 746f  self.non_bat_sto
+0001a660: 7020 2d20 7365 6c66 2e6e 5f66 6561 7475  p - self.n_featu
+0001a670: 7265 5f64 696d 5d20 2b20 5369 7a65 285b  re_dim] + Size([
+0001a680: 6e5f 6368 616e 6e65 6c5d 2920 2b20 7365  n_channel]) + se
+0001a690: 6c66 5b73 656c 662e 6e6f 6e5f 6261 745f  lf[self.non_bat_
+0001a6a0: 7374 6f70 3a5d 0a0a 2020 2020 2323 2066  stop:]..    ## f
+0001a6b0: 6561 7475 7265 2064 696d 656e 7369 6f6e  eature dimension
+0001a6c0: 733a 0a20 2020 2040 7072 6f70 6572 7479  s:.    @property
+0001a6d0: 0a20 2020 2064 6566 2068 6173 5f66 6561  .    def has_fea
+0001a6e0: 7475 7265 2873 656c 6629 3a20 7265 7475  ture(self): retu
+0001a6f0: 726e 2073 656c 662e 6e5f 6665 6174 7572  rn self.n_featur
+0001a700: 655f 6469 6d20 213d 2030 0a0a 2020 2020  e_dim != 0..    
+0001a710: 4061 6c69 6173 2822 6973 5f66 6561 7475  @alias("is_featu
+0001a720: 7265 6469 6d22 290a 2020 2020 6465 6620  redim").    def 
+0001a730: 6973 5f66 6561 7475 7265 5f64 696d 2873  is_feature_dim(s
+0001a740: 656c 662c 2069 293a 0a20 2020 2020 2020  elf, i):.       
+0001a750: 2061 766f 7563 6828 6973 696e 7374 616e   avouch(isinstan
+0001a760: 6365 2869 2c20 696e 745f 292c 2054 7970  ce(i, int_), Typ
+0001a770: 6545 7272 6f72 2866 2249 6e76 616c 6964  eError(f"Invalid
+0001a780: 2063 616c 6c20 2769 735f 6665 6174 7572   call 'is_featur
+0001a790: 655f 6469 6d28 7b69 7d29 273a 2074 6865  e_dim({i})': the
+0001a7a0: 2061 7267 756d 656e 7420 6973 206e 6f74   argument is not
+0001a7b0: 2061 6e20 696e 7465 6765 722e 2022 2929   an integer. "))
+0001a7c0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0001a7d0: 7365 6c66 2e68 6173 5f66 6561 7475 7265  self.has_feature
+0001a7e0: 3a20 7265 7475 726e 2046 616c 7365 0a20  : return False. 
+0001a7f0: 2020 2020 2020 2069 6620 6920 3c20 303a         if i < 0:
+0001a800: 2069 202b 3d20 7365 6c66 2e6e 5f64 696d   i += self.n_dim
+0001a810: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001a820: 7365 6c66 2e66 6561 7475 7265 5f73 7461  self.feature_sta
+0001a830: 7274 203c 3d20 6920 3c20 7365 6c66 2e66  rt <= i < self.f
+0001a840: 6561 7475 7265 5f73 746f 700a 0a20 2020  eature_stop..   
+0001a850: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+0001a860: 6566 206e 5f66 6561 7475 7265 5f64 696d  ef n_feature_dim
+0001a870: 2873 656c 6629 3a20 7265 7475 726e 2061  (self): return a
+0001a880: 6273 5f28 7365 6c66 2e73 7a5f 6665 6174  bs_(self.sz_feat
+0001a890: 7572 655f 6469 6d29 0a0a 2020 2020 4061  ure_dim)..    @a
+0001a8a0: 6c69 6173 2822 6e66 6561 7475 7265 6469  lias("nfeaturedi
+0001a8b0: 6d22 290a 2020 2020 406e 5f66 6561 7475  m").    @n_featu
+0001a8c0: 7265 5f64 696d 2e73 6574 7465 720a 2020  re_dim.setter.  
+0001a8d0: 2020 6465 6620 6e5f 6665 6174 7572 655f    def n_feature_
+0001a8e0: 6469 6d28 7365 6c66 2c20 6e29 3a20 7265  dim(self, n): re
+0001a8f0: 7475 726e 2073 656c 662e 7769 7468 5f6e  turn self.with_n
+0001a900: 5f66 6561 7475 7265 5f64 696d 286e 290a  _feature_dim(n).
+0001a910: 0a20 2020 2040 616c 6961 7328 2273 7a5f  .    @alias("sz_
+0001a920: 6665 6174 7572 655f 6469 6d5f 222c 2022  feature_dim_", "
+0001a930: 7769 7468 5f73 7a66 6561 7475 7265 6469  with_szfeaturedi
+0001a940: 6d22 290a 2020 2020 6465 6620 7769 7468  m").    def with
+0001a950: 5f73 7a5f 6665 6174 7572 655f 6469 6d28  _sz_feature_dim(
+0001a960: 7365 6c66 2c20 6e66 6469 6d29 3a0a 2020  self, nfdim):.  
+0001a970: 2020 2020 2020 6176 6f75 6368 286e 6664        avouch(nfd
+0001a980: 696d 2069 7320 4e6f 6e65 206f 7220 6973  im is None or is
+0001a990: 696e 7374 616e 6365 286e 6664 696d 2c20  instance(nfdim, 
+0001a9a0: 696e 745f 292c 2054 7970 6545 7272 6f72  int_), TypeError
+0001a9b0: 2822 2762 742e 5369 7a65 2e77 6974 685f  ("'bt.Size.with_
+0001a9c0: 737a 5f66 6561 7475 7265 5f64 696d 2720  sz_feature_dim' 
+0001a9d0: 6f6e 6c79 2074 616b 6573 2069 6e70 7574  only takes input
+0001a9e0: 206f 6620 616e 2069 6e74 6567 6572 2e22   of an integer."
+0001a9f0: 2929 0a20 2020 2020 2020 2069 6620 6e66  )).        if nf
+0001aa00: 6469 6d20 6973 204e 6f6e 653a 2073 656c  dim is None: sel
+0001aa10: 662e 737a 5f66 6561 7475 7265 5f64 696d  f.sz_feature_dim
+0001aa20: 203d 2030 0a20 2020 2020 2020 2065 6c73   = 0.        els
+0001aa30: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+0001aa40: 766f 7563 6828 7365 6c66 2e6e 5f66 756e  vouch(self.n_fun
+0001aa50: 635f 6469 6d20 2b20 7365 6c66 2e6e 5f62  c_dim + self.n_b
+0001aa60: 6174 6368 5f64 696d 202b 2061 6273 5f28  atch_dim + abs_(
+0001aa70: 6e66 6469 6d29 202b 2073 656c 662e 6e5f  nfdim) + self.n_
+0001aa80: 7365 7175 656e 6365 5f64 696d 203c 3d20  sequence_dim <= 
+0001aa90: 7365 6c66 2e6e 5f64 696d 2c20 5479 7065  self.n_dim, Type
+0001aaa0: 4572 726f 7228 6622 4361 6e6e 6f74 2061  Error(f"Cannot a
+0001aab0: 7373 6967 6e20 7b61 6273 5f28 6e66 6469  ssign {abs_(nfdi
+0001aac0: 6d29 7d20 6665 6174 7572 6573 2069 6e20  m)} features in 
+0001aad0: 7369 7a65 207b 7365 6c66 7d20 7769 7468  size {self} with
+0001aae0: 206e 6f6e 2d73 7065 6369 616c 2064 696d   non-special dim
+0001aaf0: 656e 7369 6f6e 206f 6620 7b73 656c 662e  ension of {self.
+0001ab00: 6e5f 6469 6d20 2d20 7365 6c66 2e6e 5f66  n_dim - self.n_f
+0001ab10: 756e 635f 6469 6d20 2d20 7365 6c66 2e6e  unc_dim - self.n
+0001ab20: 5f62 6174 6368 5f64 696d 202d 2073 656c  _batch_dim - sel
+0001ab30: 662e 6e5f 7365 7175 656e 6365 5f64 696d  f.n_sequence_dim
+0001ab40: 7d2c 206f 7220 7468 6572 6520 7769 6c6c  }, or there will
+0001ab50: 2062 6520 636f 6e66 6c69 6374 2e20 2229   be conflict. ")
+0001ab60: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+0001ab70: 6c66 2e73 7a5f 6665 6174 7572 655f 6469  lf.sz_feature_di
+0001ab80: 6d20 3d20 6e66 6469 6d0a 2020 2020 2020  m = nfdim.      
+0001ab90: 2020 7265 7475 726e 2073 656c 660a 0a20    return self.. 
+0001aba0: 2020 2040 616c 6961 7328 226e 5f66 6561     @alias("n_fea
+0001abb0: 7475 7265 5f64 696d 5f22 2c20 2277 6974  ture_dim_", "wit
+0001abc0: 685f 6e66 6561 7475 7265 6469 6d22 290a  h_nfeaturedim").
+0001abd0: 2020 2020 6465 6620 7769 7468 5f6e 5f66      def with_n_f
+0001abe0: 6561 7475 7265 5f64 696d 2873 656c 662c  eature_dim(self,
+0001abf0: 206e 6664 696d 293a 0a20 2020 2020 2020   nfdim):.       
+0001ac00: 2061 766f 7563 6828 6e66 6469 6d20 3e3d   avouch(nfdim >=
+0001ac10: 2030 2c20 5479 7065 4572 726f 7228 2227   0, TypeError("'
+0001ac20: 6274 2e53 697a 652e 7769 7468 5f6e 5f66  bt.Size.with_n_f
+0001ac30: 6561 7475 7265 5f64 696d 2720 6163 6365  eature_dim' acce
+0001ac40: 7074 206f 6e6c 7920 706f 7369 7469 7665  pt only positive
+0001ac50: 206e 756d 6265 7220 6f66 2064 696d 656e   number of dimen
+0001ac60: 7369 6f6e 7320 2862 6566 6f72 6520 7468  sions (before th
+0001ac70: 6520 7370 6163 6520 6469 6d65 6e73 696f  e space dimensio
+0001ac80: 6e73 292e 2022 2929 0a20 2020 2020 2020  ns). ")).       
+0001ac90: 2072 6574 7572 6e20 7365 6c66 2e77 6974   return self.wit
+0001aca0: 685f 737a 5f66 6561 7475 7265 5f64 696d  h_sz_feature_dim
+0001acb0: 286e 6664 696d 290a 0a20 2020 2040 7072  (nfdim)..    @pr
+0001acc0: 6f70 6572 7479 0a20 2020 2064 6566 2066  operty.    def f
+0001acd0: 6561 7475 7265 5f73 7461 7274 2873 656c  eature_start(sel
+0001ace0: 6629 3a0a 2020 2020 2020 2020 6176 6f75  f):.        avou
+0001acf0: 6368 2873 656c 662e 6861 735f 6665 6174  ch(self.has_feat
+0001ad00: 7572 652c 2054 7970 6545 7272 6f72 2822  ure, TypeError("
+0001ad10: 4361 6e6e 6f74 2067 6574 2066 6561 7475  Cannot get featu
+0001ad20: 7265 2073 7461 7274 2066 726f 6d20 7369  re start from si
+0001ad30: 7a65 2077 6974 686f 7574 2066 6561 7475  ze without featu
+0001ad40: 7265 2064 696d 656e 7369 6f6e 732e 2229  re dimensions.")
+0001ad50: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0001ad60: 204e 6f6e 6520 6966 2073 656c 662e 737a   None if self.sz
+0001ad70: 5f66 6561 7475 7265 5f64 696d 203d 3d20  _feature_dim == 
+0001ad80: 3020 656c 7365 2028 7365 6c66 2e6e 6f6e  0 else (self.non
+0001ad90: 5f62 6174 5f73 7461 7274 2069 6620 7365  _bat_start if se
+0001ada0: 6c66 2e73 7a5f 6665 6174 7572 655f 6469  lf.sz_feature_di
+0001adb0: 6d20 3e20 3020 656c 7365 2073 656c 662e  m > 0 else self.
+0001adc0: 6e6f 6e5f 6261 745f 7374 6f70 202b 2073  non_bat_stop + s
+0001add0: 656c 662e 737a 5f66 6561 7475 7265 5f64  elf.sz_feature_d
+0001ade0: 696d 290a 0a20 2020 2040 6665 6174 7572  im)..    @featur
+0001adf0: 655f 7374 6172 742e 7365 7474 6572 0a20  e_start.setter. 
+0001ae00: 2020 2064 6566 2066 6561 7475 7265 5f73     def feature_s
+0001ae10: 7461 7274 2873 656c 662c 2064 696d 293a  tart(self, dim):
+0001ae20: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
+0001ae30: 6469 6d20 6973 204e 6f6e 6520 6f72 2069  dim is None or i
+0001ae40: 7369 6e73 7461 6e63 6528 6469 6d2c 2069  sinstance(dim, i
+0001ae50: 6e74 5f29 2c20 5479 7065 4572 726f 7228  nt_), TypeError(
+0001ae60: 6622 4665 6174 7572 6520 7374 6172 7420  f"Feature start 
+0001ae70: 7368 6f75 6c64 2062 6520 616e 2069 6e74  should be an int
+0001ae80: 6567 6572 2e20 2229 290a 2020 2020 2020  eger. ")).      
+0001ae90: 2020 6966 2064 696d 2069 7320 4e6f 6e65    if dim is None
+0001aea0: 3a20 7365 6c66 2e73 7a5f 6665 6174 7572  : self.sz_featur
+0001aeb0: 655f 6469 6d20 3d20 303b 2072 6574 7572  e_dim = 0; retur
+0001aec0: 6e0a 2020 2020 2020 2020 6966 2064 696d  n.        if dim
+0001aed0: 203c 2030 3a20 6469 6d20 2b3d 2073 656c   < 0: dim += sel
+0001aee0: 662e 6e5f 6469 6d0a 2020 2020 2020 2020  f.n_dim.        
+0001aef0: 6176 6f75 6368 2873 656c 662e 6e6f 6e5f  avouch(self.non_
+0001af00: 6261 745f 7374 6172 7420 3c3d 2064 696d  bat_start <= dim
+0001af10: 203c 2073 656c 662e 6e6f 6e5f 6261 745f   < self.non_bat_
+0001af20: 7374 6f70 2c20 5479 7065 4572 726f 7228  stop, TypeError(
+0001af30: 6622 4665 6174 7572 6520 7374 6172 7420  f"Feature start 
+0001af40: 7368 6f75 6c64 2061 766f 6964 2074 6865  should avoid the
+0001af50: 2062 6174 6368 2064 696d 656e 7369 6f6e   batch dimension
+0001af60: 732c 2077 6869 6368 2069 7320 6265 7477  s, which is betw
+0001af70: 6565 6e20 7b73 656c 662e 6e6f 6e5f 6261  een {self.non_ba
+0001af80: 745f 7374 6172 747d 2061 6e64 207b 7365  t_start} and {se
+0001af90: 6c66 2e6e 6f6e 5f62 6174 5f73 746f 7020  lf.non_bat_stop 
+0001afa0: 2d20 317d 2c20 6f72 2074 6865 7265 2077  - 1}, or there w
+0001afb0: 696c 6c20 6265 2063 6f6e 666c 6963 742e  ill be conflict.
+0001afc0: 2022 2929 0a20 2020 2020 2020 2073 656c   ")).        sel
+0001afd0: 662e 737a 5f66 6561 7475 7265 5f64 696d  f.sz_feature_dim
+0001afe0: 203d 2064 696d 202d 2073 656c 662e 6e6f   = dim - self.no
+0001aff0: 6e5f 6261 745f 7374 6f70 0a0a 2020 2020  n_bat_stop..    
+0001b000: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+0001b010: 6620 6665 6174 7572 655f 7374 6f70 2873  f feature_stop(s
+0001b020: 656c 6629 3a0a 2020 2020 2020 2020 6176  elf):.        av
+0001b030: 6f75 6368 2873 656c 662e 6861 735f 6665  ouch(self.has_fe
+0001b040: 6174 7572 652c 2054 7970 6545 7272 6f72  ature, TypeError
+0001b050: 2822 4361 6e6e 6f74 2067 6574 2066 6561  ("Cannot get fea
+0001b060: 7475 7265 2073 7461 7274 2066 726f 6d20  ture start from 
+0001b070: 7369 7a65 2077 6974 686f 7574 2066 6561  size without fea
+0001b080: 7475 7265 2064 696d 656e 7369 6f6e 732e  ture dimensions.
+0001b090: 2229 290a 2020 2020 2020 2020 7265 7475  ")).        retu
+0001b0a0: 726e 204e 6f6e 6520 6966 2073 656c 662e  rn None if self.
+0001b0b0: 737a 5f66 6561 7475 7265 5f64 696d 203d  sz_feature_dim =
+0001b0c0: 3d20 3020 656c 7365 2028 7365 6c66 2e6e  = 0 else (self.n
+0001b0d0: 6f6e 5f62 6174 5f73 7461 7274 202b 2073  on_bat_start + s
+0001b0e0: 656c 662e 737a 5f66 6561 7475 7265 5f64  elf.sz_feature_d
+0001b0f0: 696d 2069 6620 7365 6c66 2e73 7a5f 6665  im if self.sz_fe
+0001b100: 6174 7572 655f 6469 6d20 3e20 3020 656c  ature_dim > 0 el
+0001b110: 7365 2073 656c 662e 6e6f 6e5f 6261 745f  se self.non_bat_
+0001b120: 7374 6f70 290a 0a20 2020 2040 6665 6174  stop)..    @feat
+0001b130: 7572 655f 7374 6f70 2e73 6574 7465 720a  ure_stop.setter.
+0001b140: 2020 2020 6465 6620 6665 6174 7572 655f      def feature_
+0001b150: 7374 6f70 2873 656c 662c 2064 696d 293a  stop(self, dim):
+0001b160: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
+0001b170: 6469 6d20 6973 204e 6f6e 6520 6f72 2069  dim is None or i
+0001b180: 7369 6e73 7461 6e63 6528 6469 6d2c 2069  sinstance(dim, i
+0001b190: 6e74 5f29 2c20 5479 7065 4572 726f 7228  nt_), TypeError(
+0001b1a0: 6622 4665 6174 7572 6520 7374 6f70 2073  f"Feature stop s
+0001b1b0: 686f 756c 6420 6265 2061 6e20 696e 7465  hould be an inte
+0001b1c0: 6765 722e 2022 2929 0a20 2020 2020 2020  ger. ")).       
+0001b1d0: 2069 6620 6469 6d20 6973 204e 6f6e 653a   if dim is None:
+0001b1e0: 2073 656c 662e 737a 5f66 6561 7475 7265   self.sz_feature
+0001b1f0: 5f64 696d 203d 2030 3b20 7265 7475 726e  _dim = 0; return
+0001b200: 0a20 2020 2020 2020 2069 6620 6469 6d20  .        if dim 
+0001b210: 3c20 303a 2064 696d 202b 3d20 7365 6c66  < 0: dim += self
+0001b220: 2e6e 5f64 696d 0a20 2020 2020 2020 2061  .n_dim.        a
+0001b230: 766f 7563 6828 7365 6c66 2e6e 6f6e 5f62  vouch(self.non_b
+0001b240: 6174 5f73 7461 7274 203c 3d20 6469 6d20  at_start <= dim 
+0001b250: 3c20 7365 6c66 2e6e 6f6e 5f62 6174 5f73  < self.non_bat_s
+0001b260: 746f 702c 2054 7970 6545 7272 6f72 2866  top, TypeError(f
+0001b270: 2246 6561 7475 7265 2073 746f 7020 7368  "Feature stop sh
+0001b280: 6f75 6c64 2061 766f 6964 2074 6865 2062  ould avoid the b
+0001b290: 6174 6368 2064 696d 656e 7369 6f6e 732c  atch dimensions,
+0001b2a0: 2077 6869 6368 2069 7320 6265 7477 6565   which is betwee
+0001b2b0: 6e20 7b73 656c 662e 6e6f 6e5f 6261 745f  n {self.non_bat_
+0001b2c0: 7374 6172 747d 2061 6e64 207b 7365 6c66  start} and {self
+0001b2d0: 2e6e 6f6e 5f62 6174 5f73 746f 7020 2d20  .non_bat_stop - 
+0001b2e0: 317d 2c20 6f72 2074 6865 7265 2077 696c  1}, or there wil
+0001b2f0: 6c20 6265 2063 6f6e 666c 6963 742e 2022  l be conflict. "
+0001b300: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
+0001b310: 737a 5f66 6561 7475 7265 5f64 696d 203d  sz_feature_dim =
+0001b320: 2064 696d 202d 2073 656c 662e 6e6f 6e5f   dim - self.non_
+0001b330: 6261 745f 7374 6172 740a 0a20 2020 2040  bat_start..    @
+0001b340: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+0001b350: 2066 6561 7475 7265 5f72 616e 6765 2873   feature_range(s
+0001b360: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+0001b370: 7475 726e 2028 7365 6c66 2e66 6561 7475  turn (self.featu
+0001b380: 7265 5f73 7461 7274 2c20 7365 6c66 2e66  re_start, self.f
+0001b390: 6561 7475 7265 5f73 746f 7029 0a20 2020  eature_stop).   
+0001b3a0: 200a 2020 2020 4066 6561 7475 7265 5f72   .    @feature_r
+0001b3b0: 616e 6765 2e73 6574 7465 720a 2020 2020  ange.setter.    
+0001b3c0: 6465 6620 6665 6174 7572 655f 7261 6e67  def feature_rang
+0001b3d0: 6528 7365 6c66 2c20 2a61 7267 7329 3a0a  e(self, *args):.
+0001b3e0: 2020 2020 2020 2020 6176 6f75 6368 286c          avouch(l
+0001b3f0: 656e 2861 7267 7329 203d 3d20 3220 6f72  en(args) == 2 or
+0001b400: 206c 656e 2861 7267 7329 203d 3d20 3120   len(args) == 1 
+0001b410: 616e 6420 6973 696e 7374 616e 6365 2861  and isinstance(a
+0001b420: 7267 735b 305d 2c20 2874 7570 6c65 2c20  rgs[0], (tuple, 
+0001b430: 6c69 7374 2929 2061 6e64 206c 656e 2861  list)) and len(a
+0001b440: 7267 735b 305d 2920 3d3d 2032 2c20 0a20  rgs[0]) == 2, . 
+0001b450: 2020 2020 2020 2020 2020 2020 2020 5479                Ty
+0001b460: 7065 4572 726f 7228 224f 6e6c 7920 7477  peError("Only tw
+0001b470: 6f20 7661 6c75 6573 2061 7265 2061 6c6c  o values are all
+0001b480: 6f77 6564 2069 6e20 7468 6520 6173 7369  owed in the assi
+0001b490: 676e 6d65 6e74 206f 6620 2766 6561 7475  gnment of 'featu
+0001b4a0: 7265 5f72 616e 6765 272c 2069 6e64 6963  re_range', indic
+0001b4b0: 6174 696e 6720 7468 6520 7374 6172 7420  ating the start 
+0001b4c0: 616e 6420 656e 6420 6469 6d65 6e73 696f  and end dimensio
+0001b4d0: 6e73 2e20 2229 290a 2020 2020 2020 2020  ns. ")).        
+0001b4e0: 6966 206c 656e 2861 7267 7329 203d 3d20  if len(args) == 
+0001b4f0: 313a 2061 7267 7320 3d20 6172 6773 5b30  1: args = args[0
+0001b500: 5d0a 2020 2020 2020 2020 6176 6f75 6368  ].        avouch
+0001b510: 2861 7267 735b 305d 203d 3d20 7365 6c66  (args[0] == self
+0001b520: 2e6e 6f6e 5f62 6174 5f73 7461 7274 206f  .non_bat_start o
+0001b530: 7220 6172 6773 5b31 5d20 3d3d 2073 656c  r args[1] == sel
+0001b540: 662e 6e6f 6e5f 6261 745f 7374 6f70 2c20  f.non_bat_stop, 
+0001b550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b560: 5479 7065 4572 726f 7228 6622 4665 6174  TypeError(f"Feat
+0001b570: 7572 6520 6469 6d65 6e73 696f 6e73 2061  ure dimensions a
+0001b580: 7265 2074 6865 2066 6972 7374 206f 7220  re the first or 
+0001b590: 6c61 7374 2064 696d 656e 7369 6f6e 7320  last dimensions 
+0001b5a0: 2873 7461 7274 696e 6720 6672 6f6d 207b  (starting from {
+0001b5b0: 7365 6c66 2e6e 6f6e 5f62 6174 5f73 7461  self.non_bat_sta
+0001b5c0: 7274 7d20 6f72 2065 6e64 696e 6720 6174  rt} or ending at
+0001b5d0: 207b 7365 6c66 2e6e 6f6e 5f62 6174 5f73   {self.non_bat_s
+0001b5e0: 746f 707d 292e 2022 2929 0a20 2020 2020  top}). ")).     
+0001b5f0: 2020 2069 6620 6172 6773 5b30 5d20 3d3d     if args[0] ==
+0001b600: 2073 656c 662e 6e6f 6e5f 6261 745f 7374   self.non_bat_st
+0001b610: 6172 743a 2073 656c 662e 6665 6174 7572  art: self.featur
+0001b620: 655f 7374 6f70 203d 2061 7267 735b 315d  e_stop = args[1]
+0001b630: 0a20 2020 2020 2020 2065 6c73 653a 2073  .        else: s
+0001b640: 656c 662e 6665 6174 7572 655f 7374 6172  elf.feature_star
+0001b650: 7420 3d20 6172 6773 5b30 5d0a 0a20 2020  t = args[0]..   
+0001b660: 2040 616c 6961 7328 226e 6665 6174 7572   @alias("nfeatur
+0001b670: 6522 290a 2020 2020 4070 726f 7065 7274  e").    @propert
+0001b680: 790a 2020 2020 6465 6620 6e5f 6665 6174  y.    def n_feat
+0001b690: 7572 6528 7365 6c66 293a 0a20 2020 2020  ure(self):.     
+0001b6a0: 2020 2061 766f 7563 6828 7365 6c66 2e68     avouch(self.h
+0001b6b0: 6173 5f66 6561 7475 7265 2c20 5479 7065  as_feature, Type
+0001b6c0: 4572 726f 7228 6622 4361 6e6e 6f74 2067  Error(f"Cannot g
+0001b6d0: 6574 2066 6561 7475 7265 2064 696d 656e  et feature dimen
+0001b6e0: 7369 6f6e 7320 6672 6f6d 2073 697a 6520  sions from size 
+0001b6f0: 7b73 656c 667d 2e22 2929 0a20 2020 2020  {self}.")).     
+0001b700: 2020 2070 203d 2031 0a20 2020 2020 2020     p = 1.       
+0001b710: 2066 6f72 2069 2069 6e20 7261 6e67 655f   for i in range_
+0001b720: 282a 7365 6c66 2e66 6561 7475 7265 5f72  (*self.feature_r
+0001b730: 616e 6765 293a 2070 202a 3d20 7365 6c66  ange): p *= self
+0001b740: 5b69 5d0a 2020 2020 2020 2020 7265 7475  [i].        retu
+0001b750: 726e 2070 0a0a 2020 2020 4061 6c69 6173  rn p..    @alias
+0001b760: 2822 6665 6174 7572 655f 7369 7a65 2229  ("feature_size")
+0001b770: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+0001b780: 2020 2064 6566 2066 6561 7475 7265 2873     def feature(s
+0001b790: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+0001b7a0: 7475 726e 2073 656c 665b 7365 6c66 2e66  turn self[self.f
+0001b7b0: 6561 7475 7265 5f73 7461 7274 3a20 7365  eature_start: se
+0001b7c0: 6c66 2e66 6561 7475 7265 5f73 746f 705d  lf.feature_stop]
+0001b7d0: 0a0a 2020 2020 6465 6620 7769 7468 5f66  ..    def with_f
+0001b7e0: 6561 7475 7265 2873 656c 662c 202a 7369  eature(self, *si
+0001b7f0: 7a65 293a 0a20 2020 2020 2020 2069 6620  ze):.        if 
+0001b800: 6c65 6e28 7369 7a65 2920 3d3d 2031 2061  len(size) == 1 a
+0001b810: 6e64 2069 7369 6e73 7461 6e63 6528 7369  nd isinstance(si
+0001b820: 7a65 5b30 5d2c 2074 7570 6c65 293a 2073  ze[0], tuple): s
+0001b830: 697a 6520 3d20 7369 7a65 5b30 5d0a 2020  ize = size[0].  
+0001b840: 2020 2020 2020 6176 6f75 6368 2861 6c6c        avouch(all
+0001b850: 5f28 6973 696e 7374 616e 6365 2878 2c20  _(isinstance(x, 
+0001b860: 696e 745f 2920 666f 7220 7820 696e 2073  int_) for x in s
+0001b870: 697a 6529 2c20 5479 7065 4572 726f 7228  ize), TypeError(
+0001b880: 2266 6561 7475 7265 2073 697a 6520 7368  "feature size sh
+0001b890: 6f75 6c64 2062 6520 6120 7475 706c 6520  ould be a tuple 
+0001b8a0: 6f66 2069 6e74 6567 6572 732e 2022 2929  of integers. "))
+0001b8b0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0001b8c0: 7365 6c66 2e68 6173 5f66 6561 7475 7265  self.has_feature
+0001b8d0: 3a20 7374 6172 7420 3d20 7365 6c66 2e6e  : start = self.n
+0001b8e0: 6f6e 5f62 6174 5f73 7461 7274 3b20 7374  on_bat_start; st
+0001b8f0: 6f70 203d 2073 656c 662e 6e6f 6e5f 6261  op = self.non_ba
+0001b900: 745f 7374 6172 740a 2020 2020 2020 2020  t_start.        
+0001b910: 656c 7365 3a20 7374 6172 7420 3d20 7365  else: start = se
+0001b920: 6c66 2e66 6561 7475 7265 5f73 7461 7274  lf.feature_start
+0001b930: 3b20 7374 6f70 203d 2073 656c 662e 6665  ; stop = self.fe
+0001b940: 6174 7572 655f 7374 6f70 0a20 2020 2020  ature_stop.     
+0001b950: 2020 2023 2061 766f 7563 6828 6c65 6e28     # avouch(len(
+0001b960: 7369 7a65 2920 3d3d 2073 656c 662e 6e5f  size) == self.n_
+0001b970: 6665 6174 7572 655f 6469 6d2c 2066 2243  feature_dim, f"C
+0001b980: 616e 6e6f 7420 7375 6273 7469 7475 7465  annot substitute
+0001b990: 2066 6561 7475 7265 2069 6e20 7b73 656c   feature in {sel
+0001b9a0: 667d 2062 7920 7b73 697a 657d 2061 7320  f} by {size} as 
+0001b9b0: 7468 6569 7220 6469 6d65 6e73 696f 6e73  their dimensions
+0001b9c0: 2061 7265 206e 6f74 2074 6865 2073 616d   are not the sam
+0001b9d0: 652e 2229 0a20 2020 2020 2020 2072 6574  e.").        ret
+0001b9e0: 7572 6e20 7365 6c66 5b3a 7374 6172 745d  urn self[:start]
+0001b9f0: 202b 2053 697a 6528 7369 7a65 2c20 737a   + Size(size, sz
+0001ba00: 5f66 6561 7475 7265 5f64 696d 3d6c 656e  _feature_dim=len
+0001ba10: 2873 697a 6529 2920 2b20 7365 6c66 5b73  (size)) + self[s
+0001ba20: 746f 703a 5d0a 2020 2020 2020 2020 0a20  top:].        . 
+0001ba30: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+0001ba40: 2064 6566 2073 6571 5f73 7063 5f73 7461   def seq_spc_sta
+0001ba50: 7274 2873 656c 6629 3a20 7265 7475 726e  rt(self): return
+0001ba60: 206d 6178 5f28 7365 6c66 2e73 7a5f 6675   max_(self.sz_fu
+0001ba70: 6e63 5f64 696d 2c20 3029 202b 206d 6178  nc_dim, 0) + max
+0001ba80: 5f28 7365 6c66 2e73 7a5f 6261 7463 685f  _(self.sz_batch_
+0001ba90: 6469 6d2c 2030 2920 2b20 6d61 785f 2873  dim, 0) + max_(s
+0001baa0: 656c 662e 737a 5f66 6561 7475 7265 5f64  elf.sz_feature_d
+0001bab0: 696d 2c20 3029 0a20 2020 2040 7072 6f70  im, 0).    @prop
+0001bac0: 6572 7479 0a20 2020 2064 6566 2073 6571  erty.    def seq
+0001bad0: 5f73 7063 5f73 746f 7028 7365 6c66 293a  _spc_stop(self):
+0001bae0: 2072 6574 7572 6e20 7365 6c66 2e6e 5f64   return self.n_d
+0001baf0: 696d 202b 206d 696e 5f28 7365 6c66 2e73  im + min_(self.s
+0001bb00: 7a5f 6675 6e63 5f64 696d 2c20 3029 202b  z_func_dim, 0) +
+0001bb10: 206d 696e 5f28 7365 6c66 2e73 7a5f 6261   min_(self.sz_ba
+0001bb20: 7463 685f 6469 6d2c 2030 2920 2b20 6d69  tch_dim, 0) + mi
+0001bb30: 6e5f 2873 656c 662e 737a 5f66 6561 7475  n_(self.sz_featu
+0001bb40: 7265 5f64 696d 2c20 3029 0a0a 2020 2020  re_dim, 0)..    
+0001bb50: 2323 2073 6571 7565 6e63 6520 6469 6d65  ## sequence dime
+0001bb60: 6e73 696f 6e73 3a0a 2020 2020 4061 6c69  nsions:.    @ali
+0001bb70: 6173 2822 6861 735f 7469 6d65 222c 2022  as("has_time", "
+0001bb80: 6861 735f 7365 7269 6573 2229 0a20 2020  has_series").   
+0001bb90: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+0001bba0: 6566 2068 6173 5f73 6571 7565 6e63 6528  ef has_sequence(
+0001bbb0: 7365 6c66 293a 2072 6574 7572 6e20 7365  self): return se
+0001bbc0: 6c66 2e73 7a5f 7365 7175 656e 6365 5f64  lf.sz_sequence_d
+0001bbd0: 696d 2021 3d20 300a 0a20 2020 2040 616c  im != 0..    @al
+0001bbe0: 6961 7328 2269 735f 7469 6d65 6469 6d22  ias("is_timedim"
+0001bbf0: 2c20 2269 735f 7365 7269 6573 6469 6d22  , "is_seriesdim"
+0001bc00: 2c20 2269 735f 7365 7175 656e 6365 6469  , "is_sequencedi
+0001bc10: 6d22 290a 2020 2020 4061 6c69 6173 2822  m").    @alias("
+0001bc20: 6973 5f74 696d 655f 6469 6d22 2c20 2269  is_time_dim", "i
+0001bc30: 735f 7365 7269 6573 5f64 696d 2229 0a20  s_series_dim"). 
+0001bc40: 2020 2064 6566 2069 735f 7365 7175 656e     def is_sequen
+0001bc50: 6365 5f64 696d 2873 656c 662c 2069 293a  ce_dim(self, i):
+0001bc60: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
+0001bc70: 6973 696e 7374 616e 6365 2869 2c20 696e  isinstance(i, in
+0001bc80: 745f 292c 2054 7970 6545 7272 6f72 2866  t_), TypeError(f
+0001bc90: 2249 6e76 616c 6964 2063 616c 6c20 2769  "Invalid call 'i
+0001bca0: 735f 7365 7175 656e 6365 5f64 696d 287b  s_sequence_dim({
+0001bcb0: 697d 2927 3a20 7468 6520 6172 6775 6d65  i})': the argume
+0001bcc0: 6e74 2069 7320 6e6f 7420 616e 2069 6e74  nt is not an int
+0001bcd0: 6567 6572 2e20 2229 290a 2020 2020 2020  eger. ")).      
+0001bce0: 2020 6966 206e 6f74 2073 656c 662e 6861    if not self.ha
+0001bcf0: 735f 7365 7175 656e 6365 3a20 7265 7475  s_sequence: retu
+0001bd00: 726e 2046 616c 7365 0a20 2020 2020 2020  rn False.       
+0001bd10: 2069 6620 6920 3c20 303a 2069 202b 3d20   if i < 0: i += 
+0001bd20: 7365 6c66 2e6e 5f64 696d 0a20 2020 2020  self.n_dim.     
+0001bd30: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
+0001bd40: 6571 7565 6e63 655f 7374 6172 7420 3c3d  equence_start <=
+0001bd50: 2069 203c 2073 656c 662e 7365 7175 656e   i < self.sequen
+0001bd60: 6365 5f73 746f 700a 0a20 2020 2040 7072  ce_stop..    @pr
+0001bd70: 6f70 6572 7479 0a20 2020 2064 6566 206e  operty.    def n
+0001bd80: 5f73 6571 7565 6e63 655f 6469 6d28 7365  _sequence_dim(se
+0001bd90: 6c66 293a 2072 6574 7572 6e20 6162 735f  lf): return abs_
+0001bda0: 2873 656c 662e 737a 5f73 6571 7565 6e63  (self.sz_sequenc
+0001bdb0: 655f 6469 6d29 0a0a 2020 2020 4061 6c69  e_dim)..    @ali
+0001bdc0: 6173 2822 6e74 696d 6564 696d 222c 2022  as("ntimedim", "
+0001bdd0: 6e73 6572 6965 7364 696d 222c 2022 6e73  nseriesdim", "ns
+0001bde0: 6571 7565 6e63 6564 696d 2229 0a20 2020  equencedim").   
+0001bdf0: 2040 616c 6961 7328 226e 5f74 696d 655f   @alias("n_time_
+0001be00: 6469 6d22 2c20 226e 5f73 6572 6965 735f  dim", "n_series_
+0001be10: 6469 6d22 290a 2020 2020 406e 5f73 6571  dim").    @n_seq
+0001be20: 7565 6e63 655f 6469 6d2e 7365 7474 6572  uence_dim.setter
+0001be30: 0a20 2020 2064 6566 206e 5f73 6571 7565  .    def n_seque
+0001be40: 6e63 655f 6469 6d28 7365 6c66 2c20 6e29  nce_dim(self, n)
+0001be50: 3a20 7265 7475 726e 2073 656c 662e 7769  : return self.wi
+0001be60: 7468 5f6e 5f73 6571 7565 6e63 655f 6469  th_n_sequence_di
+0001be70: 6d28 6e29 0a0a 2020 2020 4061 6c69 6173  m(n)..    @alias
+0001be80: 2822 737a 5f74 696d 655f 6469 6d5f 222c  ("sz_time_dim_",
+0001be90: 2022 737a 5f73 6572 6965 735f 6469 6d5f   "sz_series_dim_
+0001bea0: 222c 2022 737a 5f73 6571 7565 6e63 655f  ", "sz_sequence_
+0001beb0: 6469 6d5f 2229 0a20 2020 2040 616c 6961  dim_").    @alia
+0001bec0: 7328 2277 6974 685f 737a 7469 6d65 6469  s("with_sztimedi
+0001bed0: 6d22 2c20 2277 6974 685f 737a 7365 7269  m", "with_szseri
+0001bee0: 6573 6469 6d22 2c20 2277 6974 685f 737a  esdim", "with_sz
+0001bef0: 7365 7175 656e 6365 6469 6d22 290a 2020  sequencedim").  
+0001bf00: 2020 4061 6c69 6173 2822 7769 7468 5f73    @alias("with_s
+0001bf10: 7a5f 7469 6d65 5f64 696d 222c 2022 7769  z_time_dim", "wi
+0001bf20: 7468 5f73 7a5f 7365 7269 6573 5f64 696d  th_sz_series_dim
+0001bf30: 2229 0a20 2020 2064 6566 2077 6974 685f  ").    def with_
+0001bf40: 737a 5f73 6571 7565 6e63 655f 6469 6d28  sz_sequence_dim(
+0001bf50: 7365 6c66 2c20 6e73 6469 6d29 3a0a 2020  self, nsdim):.  
+0001bf60: 2020 2020 2020 6176 6f75 6368 286e 7364        avouch(nsd
+0001bf70: 696d 2069 7320 4e6f 6e65 206f 7220 6973  im is None or is
+0001bf80: 696e 7374 616e 6365 286e 7364 696d 2c20  instance(nsdim, 
+0001bf90: 696e 745f 292c 2054 7970 6545 7272 6f72  int_), TypeError
+0001bfa0: 2822 2762 742e 5369 7a65 2e77 6974 685f  ("'bt.Size.with_
+0001bfb0: 737a 5f73 6571 7565 6e63 655f 6469 6d27  sz_sequence_dim'
+0001bfc0: 206f 6e6c 7920 7461 6b65 7320 696e 7075   only takes inpu
+0001bfd0: 7420 6f66 2061 6e20 696e 7465 6765 722e  t of an integer.
+0001bfe0: 2229 290a 2020 2020 2020 2020 6966 206e  ")).        if n
+0001bff0: 7364 696d 2069 7320 4e6f 6e65 3a20 7365  sdim is None: se
+0001c000: 6c66 2e73 7a5f 7365 7175 656e 6365 5f64  lf.sz_sequence_d
+0001c010: 696d 203d 2030 0a20 2020 2020 2020 2065  im = 0.        e
+0001c020: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001c030: 2061 766f 7563 6828 7365 6c66 2e6e 5f66   avouch(self.n_f
+0001c040: 756e 635f 6469 6d20 2b20 7365 6c66 2e6e  unc_dim + self.n
+0001c050: 5f62 6174 6368 5f64 696d 202b 2073 656c  _batch_dim + sel
+0001c060: 662e 6e5f 6665 6174 7572 655f 6469 6d20  f.n_feature_dim 
+0001c070: 2b20 6162 735f 286e 7364 696d 2920 3c3d  + abs_(nsdim) <=
+0001c080: 2073 656c 662e 6e5f 6469 6d2c 2054 7970   self.n_dim, Typ
+0001c090: 6545 7272 6f72 2866 2243 616e 6e6f 7420  eError(f"Cannot 
+0001c0a0: 6173 7369 676e 207b 6162 735f 286e 7364  assign {abs_(nsd
+0001c0b0: 696d 297d 2073 6571 7565 6e63 6520 6469  im)} sequence di
+0001c0c0: 6d65 6e73 696f 6e73 2069 6e20 7369 7a65  mensions in size
+0001c0d0: 207b 7365 6c66 7d20 7769 7468 206e 6f6e   {self} with non
+0001c0e0: 2d73 7065 6369 616c 2064 696d 656e 7369  -special dimensi
+0001c0f0: 6f6e 206f 6620 7b73 656c 662e 6e5f 6469  on of {self.n_di
+0001c100: 6d20 2d20 7365 6c66 2e6e 5f66 756e 635f  m - self.n_func_
+0001c110: 6469 6d20 2d20 7365 6c66 2e6e 5f62 6174  dim - self.n_bat
+0001c120: 6368 5f64 696d 202d 2073 656c 662e 6e5f  ch_dim - self.n_
+0001c130: 6665 6174 7572 655f 6469 6d7d 2c20 6f72  feature_dim}, or
+0001c140: 2074 6865 7265 2077 696c 6c20 6265 2063   there will be c
+0001c150: 6f6e 666c 6963 742e 2022 2929 0a20 2020  onflict. ")).   
+0001c160: 2020 2020 2020 2020 2073 656c 662e 737a           self.sz
+0001c170: 5f73 6571 7565 6e63 655f 6469 6d20 3d20  _sequence_dim = 
+0001c180: 6e73 6469 6d0a 2020 2020 2020 2020 7265  nsdim.        re
+0001c190: 7475 726e 2073 656c 660a 0a20 2020 2040  turn self..    @
+0001c1a0: 616c 6961 7328 226e 5f74 696d 655f 6469  alias("n_time_di
+0001c1b0: 6d5f 222c 2022 6e5f 7365 7269 6573 5f64  m_", "n_series_d
+0001c1c0: 696d 5f22 2c20 226e 5f73 6571 7565 6e63  im_", "n_sequenc
+0001c1d0: 655f 6469 6d5f 2229 0a20 2020 2040 616c  e_dim_").    @al
+0001c1e0: 6961 7328 2277 6974 685f 6e74 696d 6564  ias("with_ntimed
+0001c1f0: 696d 222c 2022 7769 7468 5f6e 7365 7269  im", "with_nseri
+0001c200: 6573 6469 6d22 2c20 2277 6974 685f 6e73  esdim", "with_ns
+0001c210: 6571 7565 6e63 6564 696d 2229 0a20 2020  equencedim").   
+0001c220: 2040 616c 6961 7328 2277 6974 685f 6e5f   @alias("with_n_
+0001c230: 7469 6d65 5f64 696d 222c 2022 7769 7468  time_dim", "with
+0001c240: 5f6e 5f73 6572 6965 735f 6469 6d22 290a  _n_series_dim").
+0001c250: 2020 2020 6465 6620 7769 7468 5f6e 5f73      def with_n_s
+0001c260: 6571 7565 6e63 655f 6469 6d28 7365 6c66  equence_dim(self
+0001c270: 2c20 6e73 6469 6d29 3a0a 2020 2020 2020  , nsdim):.      
+0001c280: 2020 6176 6f75 6368 286e 7364 696d 203e    avouch(nsdim >
+0001c290: 3d20 302c 2054 7970 6545 7272 6f72 2822  = 0, TypeError("
+0001c2a0: 2762 742e 5369 7a65 2e77 6974 685f 6e5f  'bt.Size.with_n_
+0001c2b0: 7365 7175 656e 6365 5f64 696d 2720 6163  sequence_dim' ac
+0001c2c0: 6365 7074 206f 6e6c 7920 706f 7369 7469  cept only positi
+0001c2d0: 7665 206e 756d 6265 7220 6f66 2064 696d  ve number of dim
+0001c2e0: 656e 7369 6f6e 7320 2862 6566 6f72 6520  ensions (before 
+0001c2f0: 7468 6520 7370 6163 6520 6469 6d65 6e73  the space dimens
+0001c300: 696f 6e73 292e 2022 2929 0a20 2020 2020  ions). ")).     
+0001c310: 2020 2072 6574 7572 6e20 7365 6c66 2e77     return self.w
+0001c320: 6974 685f 737a 5f73 6571 7565 6e63 655f  ith_sz_sequence_
+0001c330: 6469 6d28 2d6e 7364 696d 290a 0a20 2020  dim(-nsdim)..   
+0001c340: 2040 616c 6961 7328 2274 696d 655f 6469   @alias("time_di
+0001c350: 6d5f 222c 2022 7365 7269 6573 5f64 696d  m_", "series_dim
+0001c360: 5f22 2c20 2273 6571 7565 6e63 655f 6469  _", "sequence_di
+0001c370: 6d5f 2229 0a20 2020 2040 616c 6961 7328  m_").    @alias(
+0001c380: 2277 6974 685f 7469 6d65 6469 6d22 2c20  "with_timedim", 
+0001c390: 2277 6974 685f 7365 7269 6573 6469 6d22  "with_seriesdim"
+0001c3a0: 2c20 2277 6974 685f 7365 7175 656e 6365  , "with_sequence
+0001c3b0: 6469 6d22 290a 2020 2020 4061 6c69 6173  dim").    @alias
+0001c3c0: 2822 7769 7468 5f74 696d 655f 6469 6d22  ("with_time_dim"
+0001c3d0: 2c20 2277 6974 685f 7365 7269 6573 5f64  , "with_series_d
+0001c3e0: 696d 2229 0a20 2020 2064 6566 2077 6974  im").    def wit
+0001c3f0: 685f 7365 7175 656e 6365 5f64 696d 2873  h_sequence_dim(s
+0001c400: 656c 662c 2064 696d 293a 0a20 2020 2020  elf, dim):.     
+0001c410: 2020 2061 766f 7563 6828 6469 6d20 6973     avouch(dim is
+0001c420: 204e 6f6e 6520 6f72 2069 7369 6e73 7461   None or isinsta
+0001c430: 6e63 6528 6469 6d2c 2028 626f 6f6c 5f2c  nce(dim, (bool_,
+0001c440: 2069 6e74 5f29 292c 2054 7970 6545 7272   int_)), TypeErr
+0001c450: 6f72 2822 2762 742e 5369 7a65 2e77 6974  or("'bt.Size.wit
+0001c460: 685f 7365 7175 656e 6365 5f64 696d 2720  h_sequence_dim' 
+0001c470: 6f6e 6c79 2074 616b 6573 2069 6e74 6567  only takes integ
+0001c480: 6572 206f 7220 626f 6f6c 2e22 2929 0a20  er or bool.")). 
+0001c490: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0001c4a0: 616e 6365 2864 696d 2c20 626f 6f6c 5f29  ance(dim, bool_)
+0001c4b0: 3a20 6469 6d20 3d20 2d31 2069 6620 6469  : dim = -1 if di
+0001c4c0: 6d20 656c 7365 204e 6f6e 650a 2020 2020  m else None.    
+0001c4d0: 2020 2020 6966 2064 696d 2069 7320 4e6f      if dim is No
+0001c4e0: 6e65 3a20 7365 6c66 2e73 7a5f 7365 7175  ne: self.sz_sequ
+0001c4f0: 656e 6365 5f64 696d 203d 2030 3b20 7265  ence_dim = 0; re
+0001c500: 7475 726e 2073 656c 660a 2020 2020 2020  turn self.      
+0001c510: 2020 6966 2064 696d 203c 2030 3a20 6469    if dim < 0: di
+0001c520: 6d20 2b3d 2073 656c 662e 6e5f 6469 6d0a  m += self.n_dim.
+0001c530: 2020 2020 2020 2020 6176 6f75 6368 2864          avouch(d
+0001c540: 696d 2069 6e20 2873 656c 662e 7365 715f  im in (self.seq_
+0001c550: 7370 635f 7374 6172 742c 2073 656c 662e  spc_start, self.
+0001c560: 7365 715f 7370 635f 7374 6f70 202d 2031  seq_spc_stop - 1
+0001c570: 292c 2054 7970 6545 7272 6f72 2866 2253  ), TypeError(f"S
+0001c580: 6571 7565 6e63 6520 6469 6d65 6e73 696f  equence dimensio
+0001c590: 6e20 6361 6e20 6f6e 6c79 2062 6520 7468  n can only be th
+0001c5a0: 6520 6669 7273 7420 6f72 206c 6173 7420  e first or last 
+0001c5b0: 6469 6d65 6e73 696f 6e20 287b 7365 6c66  dimension ({self
+0001c5c0: 2e73 6571 5f73 7063 5f73 7461 7274 7d20  .seq_spc_start} 
+0001c5d0: 6f72 207b 7365 6c66 2e73 6571 5f73 7063  or {self.seq_spc
+0001c5e0: 5f73 746f 702d 317d 2920 6170 6172 7420  _stop-1}) apart 
+0001c5f0: 6672 6f6d 2062 6174 6368 2061 6e64 2066  from batch and f
+0001c600: 6561 7475 7265 2064 696d 656e 7369 6f6e  eature dimension
+0001c610: 732e 2229 290a 2020 2020 2020 2020 7365  s.")).        se
+0001c620: 6c66 2e73 7a5f 7365 7175 656e 6365 5f64  lf.sz_sequence_d
+0001c630: 696d 203d 2031 2069 6620 6469 6d20 3d3d  im = 1 if dim ==
+0001c640: 2073 656c 662e 7365 715f 7370 635f 7374   self.seq_spc_st
+0001c650: 6172 7420 656c 7365 202d 310a 2020 2020  art else -1.    
+0001c660: 2020 2020 7265 7475 726e 2073 656c 660a      return self.
+0001c670: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+0001c680: 2020 2064 6566 2073 6571 7565 6e63 655f     def sequence_
+0001c690: 7374 6172 7428 7365 6c66 293a 0a20 2020  start(self):.   
+0001c6a0: 2020 2020 2061 766f 7563 6828 7365 6c66       avouch(self
+0001c6b0: 2e68 6173 5f73 6571 7565 6e63 652c 2054  .has_sequence, T
+0001c6c0: 7970 6545 7272 6f72 2822 4361 6e6e 6f74  ypeError("Cannot
+0001c6d0: 2067 6574 2073 6571 7565 6e63 6520 7374   get sequence st
+0001c6e0: 6172 7420 6672 6f6d 2073 697a 6520 7769  art from size wi
+0001c6f0: 7468 6f75 7420 7365 7175 656e 6365 2064  thout sequence d
+0001c700: 696d 656e 7369 6f6e 732e 2229 290a 2020  imensions.")).  
+0001c710: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+0001c720: 6520 6966 2073 656c 662e 737a 5f73 6571  e if self.sz_seq
+0001c730: 7565 6e63 655f 6469 6d20 3d3d 2030 2065  uence_dim == 0 e
+0001c740: 6c73 6520 2873 656c 662e 7365 715f 7370  lse (self.seq_sp
+0001c750: 635f 7374 6172 7420 6966 2073 656c 662e  c_start if self.
+0001c760: 737a 5f73 6571 7565 6e63 655f 6469 6d20  sz_sequence_dim 
+0001c770: 3e20 3020 656c 7365 2073 656c 662e 7365  > 0 else self.se
+0001c780: 715f 7370 635f 7374 6f70 202b 2073 656c  q_spc_stop + sel
+0001c790: 662e 737a 5f73 6571 7565 6e63 655f 6469  f.sz_sequence_di
+0001c7a0: 6d29 0a0a 2020 2020 4061 6c69 6173 2822  m)..    @alias("
+0001c7b0: 7469 6d65 5f73 7461 7274 222c 2022 7365  time_start", "se
+0001c7c0: 7269 6573 5f73 7461 7274 2229 0a20 2020  ries_start").   
+0001c7d0: 2040 7365 7175 656e 6365 5f73 7461 7274   @sequence_start
+0001c7e0: 2e73 6574 7465 720a 2020 2020 6465 6620  .setter.    def 
+0001c7f0: 7365 7175 656e 6365 5f73 7461 7274 2873  sequence_start(s
+0001c800: 656c 662c 2064 696d 293a 0a20 2020 2020  elf, dim):.     
+0001c810: 2020 2061 766f 7563 6828 6469 6d20 6973     avouch(dim is
+0001c820: 204e 6f6e 6520 6f72 2069 7369 6e73 7461   None or isinsta
+0001c830: 6e63 6528 6469 6d2c 2069 6e74 5f29 2c20  nce(dim, int_), 
+0001c840: 5479 7065 4572 726f 7228 6622 5365 7175  TypeError(f"Sequ
+0001c850: 656e 6365 2073 7461 7274 2073 686f 756c  ence start shoul
+0001c860: 6420 6265 2061 6e20 696e 7465 6765 722e  d be an integer.
+0001c870: 2022 2929 0a20 2020 2020 2020 2069 6620   ")).        if 
+0001c880: 6469 6d20 6973 204e 6f6e 653a 2073 656c  dim is None: sel
+0001c890: 662e 737a 5f73 6571 7565 6e63 655f 6469  f.sz_sequence_di
+0001c8a0: 6d20 3d20 303b 2072 6574 7572 6e0a 2020  m = 0; return.  
+0001c8b0: 2020 2020 2020 6966 2064 696d 203c 2030        if dim < 0
+0001c8c0: 3a20 6469 6d20 2b3d 2073 656c 662e 6e5f  : dim += self.n_
+0001c8d0: 6469 6d0a 2020 2020 2020 2020 6176 6f75  dim.        avou
+0001c8e0: 6368 2873 656c 662e 7365 715f 7370 635f  ch(self.seq_spc_
+0001c8f0: 7374 6172 7420 3c3d 2064 696d 203c 2073  start <= dim < s
+0001c900: 656c 662e 7365 715f 7370 635f 7374 6f70  elf.seq_spc_stop
+0001c910: 2c20 5479 7065 4572 726f 7228 6622 5365  , TypeError(f"Se
+0001c920: 7175 656e 6365 2073 7461 7274 2073 686f  quence start sho
+0001c930: 756c 6420 6176 6f69 6420 7468 6520 6261  uld avoid the ba
+0001c940: 7463 682f 6665 6174 7572 6520 6469 6d65  tch/feature dime
+0001c950: 6e73 696f 6e73 2c20 7768 6963 6820 6973  nsions, which is
+0001c960: 2062 6574 7765 656e 207b 7365 6c66 2e73   between {self.s
+0001c970: 6571 5f73 7063 5f73 7461 7274 7d20 616e  eq_spc_start} an
+0001c980: 6420 7b73 656c 662e 7365 715f 7370 635f  d {self.seq_spc_
+0001c990: 7374 6f70 202d 2031 7d2c 206f 7220 7468  stop - 1}, or th
+0001c9a0: 6572 6520 7769 6c6c 2062 6520 636f 6e66  ere will be conf
+0001c9b0: 6c69 6374 2e20 2229 290a 2020 2020 2020  lict. ")).      
+0001c9c0: 2020 7365 6c66 2e73 7a5f 7365 7175 656e    self.sz_sequen
+0001c9d0: 6365 5f64 696d 203d 2064 696d 202d 2073  ce_dim = dim - s
+0001c9e0: 656c 662e 7365 715f 7370 635f 7374 6f70  elf.seq_spc_stop
+0001c9f0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+0001ca00: 2020 2020 6465 6620 7365 7175 656e 6365      def sequence
+0001ca10: 5f73 746f 7028 7365 6c66 293a 0a20 2020  _stop(self):.   
+0001ca20: 2020 2020 2061 766f 7563 6828 7365 6c66       avouch(self
+0001ca30: 2e68 6173 5f73 6571 7565 6e63 652c 2054  .has_sequence, T
+0001ca40: 7970 6545 7272 6f72 2822 4361 6e6e 6f74  ypeError("Cannot
+0001ca50: 2067 6574 2073 6571 7565 6e63 6520 7374   get sequence st
+0001ca60: 6172 7420 6672 6f6d 2073 697a 6520 7769  art from size wi
+0001ca70: 7468 6f75 7420 7365 7175 656e 6365 2064  thout sequence d
+0001ca80: 696d 656e 7369 6f6e 732e 2229 290a 2020  imensions.")).  
+0001ca90: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+0001caa0: 6520 6966 2073 656c 662e 737a 5f73 6571  e if self.sz_seq
+0001cab0: 7565 6e63 655f 6469 6d20 3d3d 2030 2065  uence_dim == 0 e
+0001cac0: 6c73 6520 2873 656c 662e 7365 715f 7370  lse (self.seq_sp
+0001cad0: 635f 7374 6172 7420 2b20 7365 6c66 2e73  c_start + self.s
+0001cae0: 7a5f 7365 7175 656e 6365 5f64 696d 2069  z_sequence_dim i
+0001caf0: 6620 7365 6c66 2e73 7a5f 7365 7175 656e  f self.sz_sequen
+0001cb00: 6365 5f64 696d 203e 2030 2065 6c73 6520  ce_dim > 0 else 
+0001cb10: 7365 6c66 2e73 6571 5f73 7063 5f73 746f  self.seq_spc_sto
+0001cb20: 7029 0a0a 2020 2020 4061 6c69 6173 2822  p)..    @alias("
+0001cb30: 7469 6d65 5f73 746f 7022 2c20 2273 6572  time_stop", "ser
+0001cb40: 6965 735f 7374 6f70 2229 0a20 2020 2040  ies_stop").    @
+0001cb50: 7365 7175 656e 6365 5f73 746f 702e 7365  sequence_stop.se
+0001cb60: 7474 6572 0a20 2020 2064 6566 2073 6571  tter.    def seq
+0001cb70: 7565 6e63 655f 7374 6f70 2873 656c 662c  uence_stop(self,
+0001cb80: 2064 696d 293a 0a20 2020 2020 2020 2061   dim):.        a
+0001cb90: 766f 7563 6828 6469 6d20 6973 204e 6f6e  vouch(dim is Non
+0001cba0: 6520 6f72 2069 7369 6e73 7461 6e63 6528  e or isinstance(
+0001cbb0: 6469 6d2c 2069 6e74 5f29 2c20 5479 7065  dim, int_), Type
+0001cbc0: 4572 726f 7228 6622 5365 7175 656e 6365  Error(f"Sequence
+0001cbd0: 2073 746f 7020 7368 6f75 6c64 2062 6520   stop should be 
+0001cbe0: 616e 2069 6e74 6567 6572 2e20 2229 290a  an integer. ")).
+0001cbf0: 2020 2020 2020 2020 6966 2064 696d 2069          if dim i
+0001cc00: 7320 4e6f 6e65 3a20 7365 6c66 2e73 7a5f  s None: self.sz_
+0001cc10: 7365 7175 656e 6365 5f64 696d 203d 2030  sequence_dim = 0
+0001cc20: 3b20 7265 7475 726e 0a20 2020 2020 2020  ; return.       
+0001cc30: 2069 6620 6469 6d20 3c20 303a 2064 696d   if dim < 0: dim
+0001cc40: 202b 3d20 7365 6c66 2e6e 5f64 696d 0a20   += self.n_dim. 
+0001cc50: 2020 2020 2020 2061 766f 7563 6828 7365         avouch(se
+0001cc60: 6c66 2e73 6571 5f73 7063 5f73 7461 7274  lf.seq_spc_start
+0001cc70: 203c 3d20 6469 6d20 3c20 7365 6c66 2e73   <= dim < self.s
+0001cc80: 6571 5f73 7063 5f73 746f 702c 2054 7970  eq_spc_stop, Typ
+0001cc90: 6545 7272 6f72 2866 2253 6571 7565 6e63  eError(f"Sequenc
+0001cca0: 6520 7374 6f70 2073 686f 756c 6420 6176  e stop should av
+0001ccb0: 6f69 6420 7468 6520 6261 7463 682f 6665  oid the batch/fe
+0001ccc0: 6174 7572 6520 6469 6d65 6e73 696f 6e73  ature dimensions
+0001ccd0: 2c20 7768 6963 6820 6973 2062 6574 7765  , which is betwe
+0001cce0: 656e 207b 7365 6c66 2e73 6571 5f73 7063  en {self.seq_spc
+0001ccf0: 5f73 7461 7274 7d20 616e 6420 7b73 656c  _start} and {sel
+0001cd00: 662e 7365 715f 7370 635f 7374 6f70 202d  f.seq_spc_stop -
+0001cd10: 2031 7d2c 206f 7220 7468 6572 6520 7769   1}, or there wi
+0001cd20: 6c6c 2062 6520 636f 6e66 6c69 6374 2e20  ll be conflict. 
+0001cd30: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
+0001cd40: 2e73 7a5f 7365 7175 656e 6365 5f64 696d  .sz_sequence_dim
+0001cd50: 203d 2064 696d 202d 2073 656c 662e 7365   = dim - self.se
+0001cd60: 715f 7370 635f 7374 6172 740a 0a20 2020  q_spc_start..   
+0001cd70: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+0001cd80: 6566 2073 6571 7565 6e63 655f 7261 6e67  ef sequence_rang
+0001cd90: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+0001cda0: 2072 6574 7572 6e20 2873 656c 662e 7365   return (self.se
+0001cdb0: 7175 656e 6365 5f73 7461 7274 2c20 7365  quence_start, se
+0001cdc0: 6c66 2e73 6571 7565 6e63 655f 7374 6f70  lf.sequence_stop
+0001cdd0: 290a 2020 2020 0a20 2020 2040 616c 6961  ).    .    @alia
+0001cde0: 7328 2274 696d 655f 7261 6e67 6522 2c20  s("time_range", 
+0001cdf0: 2273 6572 6965 735f 7261 6e67 6522 290a  "series_range").
+0001ce00: 2020 2020 4073 6571 7565 6e63 655f 7261      @sequence_ra
+0001ce10: 6e67 652e 7365 7474 6572 0a20 2020 2064  nge.setter.    d
+0001ce20: 6566 2073 6571 7565 6e63 655f 7261 6e67  ef sequence_rang
+0001ce30: 6528 7365 6c66 2c20 2a61 7267 7329 3a0a  e(self, *args):.
+0001ce40: 2020 2020 2020 2020 6176 6f75 6368 286c          avouch(l
+0001ce50: 656e 2861 7267 7329 203d 3d20 3220 6f72  en(args) == 2 or
+0001ce60: 206c 656e 2861 7267 7329 203d 3d20 3120   len(args) == 1 
+0001ce70: 616e 6420 6973 696e 7374 616e 6365 2861  and isinstance(a
+0001ce80: 7267 735b 305d 2c20 2874 7570 6c65 2c20  rgs[0], (tuple, 
+0001ce90: 6c69 7374 2929 2061 6e64 206c 656e 2861  list)) and len(a
+0001cea0: 7267 735b 305d 2920 3d3d 2032 2c20 0a20  rgs[0]) == 2, . 
+0001ceb0: 2020 2020 2020 2020 2020 2020 2020 224f                "O
+0001cec0: 6e6c 7920 7477 6f20 7661 6c75 6573 2061  nly two values a
+0001ced0: 7265 2061 6c6c 6f77 6564 2069 6e20 7468  re allowed in th
+0001cee0: 6520 6173 7369 676e 6d65 6e74 206f 6620  e assignment of 
+0001cef0: 2773 6571 7565 6e63 655f 7261 6e67 6527  'sequence_range'
+0001cf00: 2c20 696e 6469 6361 7469 6e67 2074 6865  , indicating the
+0001cf10: 2073 7461 7274 2061 6e64 2065 6e64 2064   start and end d
+0001cf20: 696d 656e 7369 6f6e 732e 2022 290a 2020  imensions. ").  
+0001cf30: 2020 2020 2020 6966 206c 656e 2861 7267        if len(arg
+0001cf40: 7329 203d 3d20 313a 2061 7267 7320 3d20  s) == 1: args = 
+0001cf50: 6172 6773 5b30 5d0a 2020 2020 2020 2020  args[0].        
+0001cf60: 6176 6f75 6368 2861 7267 735b 305d 203d  avouch(args[0] =
+0001cf70: 3d20 7365 6c66 2e73 6571 5f73 7063 5f73  = self.seq_spc_s
+0001cf80: 7461 7274 206f 7220 6172 6773 5b31 5d20  tart or args[1] 
+0001cf90: 3d3d 2073 656c 662e 7365 715f 7370 635f  == self.seq_spc_
+0001cfa0: 7374 6f70 2c20 0a20 2020 2020 2020 2020  stop, .         
+0001cfb0: 2020 2020 2020 5479 7065 4572 726f 7228        TypeError(
+0001cfc0: 6622 4665 6174 7572 6520 6469 6d65 6e73  f"Feature dimens
+0001cfd0: 696f 6e73 2061 7265 2074 6865 2066 6972  ions are the fir
+0001cfe0: 7374 206f 7220 6c61 7374 2064 696d 656e  st or last dimen
+0001cff0: 7369 6f6e 7320 2873 7461 7274 696e 6720  sions (starting 
+0001d000: 6672 6f6d 207b 7365 6c66 2e73 6571 5f73  from {self.seq_s
+0001d010: 7063 5f73 7461 7274 7d20 6f72 2065 6e64  pc_start} or end
+0001d020: 696e 6720 6174 207b 7365 6c66 2e73 6571  ing at {self.seq
+0001d030: 5f73 7063 5f73 746f 707d 292e 2022 2929  _spc_stop}). "))
+0001d040: 0a20 2020 2020 2020 2069 6620 6172 6773  .        if args
+0001d050: 5b30 5d20 3d3d 2073 656c 662e 7365 715f  [0] == self.seq_
+0001d060: 7370 635f 7374 6172 743a 2073 656c 662e  spc_start: self.
+0001d070: 7365 7175 656e 6365 5f73 746f 7020 3d20  sequence_stop = 
+0001d080: 6172 6773 5b31 5d0a 2020 2020 2020 2020  args[1].        
+0001d090: 656c 7365 3a20 7365 6c66 2e73 6571 7565  else: self.seque
+0001d0a0: 6e63 655f 7374 6172 7420 3d20 6172 6773  nce_start = args
+0001d0b0: 5b30 5d0a 0a20 2020 2040 616c 6961 7328  [0]..    @alias(
+0001d0c0: 226e 7469 6d65 222c 2022 6e74 696d 656c  "ntime", "ntimel
+0001d0d0: 696e 6522 2c20 226e 7365 7269 6573 222c  ine", "nseries",
+0001d0e0: 2022 6e73 6571 7565 6e63 6522 290a 2020   "nsequence").  
+0001d0f0: 2020 4061 6c69 6173 2822 6e5f 7469 6d65    @alias("n_time
+0001d100: 222c 2022 6e5f 7469 6d65 6c69 6e65 222c  ", "n_timeline",
+0001d110: 2022 6e5f 7365 7269 6573 2229 0a20 2020   "n_series").   
+0001d120: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+0001d130: 6566 206e 5f73 6571 7565 6e63 6528 7365  ef n_sequence(se
+0001d140: 6c66 293a 0a20 2020 2020 2020 2061 766f  lf):.        avo
+0001d150: 7563 6828 7365 6c66 2e68 6173 5f73 6571  uch(self.has_seq
+0001d160: 7565 6e63 6520 3e20 302c 2054 7970 6545  uence > 0, TypeE
+0001d170: 7272 6f72 2866 2243 616e 6e6f 7420 6765  rror(f"Cannot ge
+0001d180: 7420 7365 7175 656e 6365 2064 696d 656e  t sequence dimen
+0001d190: 7369 6f6e 7320 6672 6f6d 2073 697a 6520  sions from size 
+0001d1a0: 7b73 656c 667d 2e22 2929 0a20 2020 2020  {self}.")).     
+0001d1b0: 2020 2070 203d 2031 0a20 2020 2020 2020     p = 1.       
+0001d1c0: 2066 6f72 2069 2069 6e20 7261 6e67 655f   for i in range_
+0001d1d0: 282a 7365 6c66 2e73 6571 7565 6e63 655f  (*self.sequence_
+0001d1e0: 7261 6e67 6529 3a20 7020 2a3d 2073 656c  range): p *= sel
+0001d1f0: 665b 695d 0a20 2020 2020 2020 2072 6574  f[i].        ret
+0001d200: 7572 6e20 700a 0a20 2020 2040 616c 6961  urn p..    @alia
+0001d210: 7328 2274 696d 655f 7369 7a65 222c 2022  s("time_size", "
+0001d220: 7365 7269 6573 5f73 697a 6522 2c20 2273  series_size", "s
+0001d230: 6571 7565 6e63 655f 7369 7a65 2229 0a20  equence_size"). 
+0001d240: 2020 2040 616c 6961 7328 2274 696d 6522     @alias("time"
+0001d250: 2c20 2273 6572 6965 7322 290a 2020 2020  , "series").    
+0001d260: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+0001d270: 6620 7365 7175 656e 6365 2873 656c 6629  f sequence(self)
+0001d280: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0001d290: 2073 656c 665b 7365 6c66 2e73 6571 7565   self[self.seque
+0001d2a0: 6e63 655f 7374 6172 743a 7365 6c66 2e73  nce_start:self.s
+0001d2b0: 6571 7565 6e63 655f 7374 6f70 5d0a 0a20  equence_stop].. 
+0001d2c0: 2020 2040 616c 6961 7328 2277 6974 685f     @alias("with_
+0001d2d0: 7469 6d65 222c 2022 7769 7468 5f73 6572  time", "with_ser
+0001d2e0: 6965 7322 290a 2020 2020 6465 6620 7769  ies").    def wi
+0001d2f0: 7468 5f73 6571 7565 6e63 6528 7365 6c66  th_sequence(self
+0001d300: 2c20 2a73 697a 6529 3a0a 2020 2020 2020  , *size):.      
+0001d310: 2020 6966 206c 656e 2873 697a 6529 203d    if len(size) =
+0001d320: 3d20 3120 616e 6420 6973 696e 7374 616e  = 1 and isinstan
+0001d330: 6365 2873 697a 655b 305d 2c20 7475 706c  ce(size[0], tupl
+0001d340: 6529 3a20 7369 7a65 203d 2073 697a 655b  e): size = size[
+0001d350: 305d 0a20 2020 2020 2020 2061 766f 7563  0].        avouc
+0001d360: 6828 616c 6c5f 2869 7369 6e73 7461 6e63  h(all_(isinstanc
+0001d370: 6528 782c 2069 6e74 5f29 2066 6f72 2078  e(x, int_) for x
+0001d380: 2069 6e20 7369 7a65 292c 2054 7970 6545   in size), TypeE
+0001d390: 7272 6f72 2822 7365 7175 656e 6365 2073  rror("sequence s
+0001d3a0: 697a 6520 7368 6f75 6c64 2062 6520 6120  ize should be a 
+0001d3b0: 7475 706c 6520 6f66 2069 6e74 6567 6572  tuple of integer
+0001d3c0: 732e 2022 2929 0a20 2020 2020 2020 2069  s. ")).        i
+0001d3d0: 6620 6e6f 7420 7365 6c66 2e68 6173 5f73  f not self.has_s
+0001d3e0: 6571 7565 6e63 653a 2073 7461 7274 203d  equence: start =
+0001d3f0: 2073 656c 662e 7365 715f 7370 635f 7374   self.seq_spc_st
+0001d400: 6f70 3b20 7374 6f70 203d 2073 656c 662e  op; stop = self.
+0001d410: 7365 715f 7370 635f 7374 6f70 0a20 2020  seq_spc_stop.   
+0001d420: 2020 2020 2065 6c73 653a 2073 7461 7274       else: start
+0001d430: 203d 2073 656c 662e 7365 7175 656e 6365   = self.sequence
+0001d440: 5f73 7461 7274 3b20 7374 6f70 203d 2073  _start; stop = s
+0001d450: 656c 662e 7365 7175 656e 6365 5f73 746f  elf.sequence_sto
+0001d460: 700a 2020 2020 2020 2020 2320 6176 6f75  p.        # avou
+0001d470: 6368 286c 656e 2873 697a 6529 203d 3d20  ch(len(size) == 
+0001d480: 7365 6c66 2e6e 5f73 6571 7565 6e63 655f  self.n_sequence_
+0001d490: 6469 6d2c 2066 2243 616e 6e6f 7420 7375  dim, f"Cannot su
+0001d4a0: 6273 7469 7475 7465 2073 6571 7565 6e63  bstitute sequenc
+0001d4b0: 6520 696e 207b 7365 6c66 7d20 6279 207b  e in {self} by {
+0001d4c0: 7369 7a65 7d20 6173 2074 6865 6972 2064  size} as their d
+0001d4d0: 696d 656e 7369 6f6e 7320 6172 6520 6e6f  imensions are no
+0001d4e0: 7420 7468 6520 7361 6d65 2e22 290a 2020  t the same.").  
+0001d4f0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0001d500: 665b 3a73 7461 7274 5d20 2b20 5369 7a65  f[:start] + Size
+0001d510: 2873 697a 652c 2073 7a5f 7365 7175 656e  (size, sz_sequen
+0001d520: 6365 5f64 696d 3d6c 656e 2873 697a 6529  ce_dim=len(size)
+0001d530: 2920 2b20 7365 6c66 5b73 746f 703a 5d0a  ) + self[stop:].
+0001d540: 0a20 2020 2023 2320 7370 6163 6520 6469  .    ## space di
+0001d550: 6d65 6e73 696f 6e73 3a0a 2020 2020 4070  mensions:.    @p
+0001d560: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+0001d570: 6861 735f 7370 6163 6528 7365 6c66 293a  has_space(self):
+0001d580: 2072 6574 7572 6e20 7365 6c66 2e6e 5f73   return self.n_s
+0001d590: 7061 6365 5f64 696d 203e 2030 0a20 2020  pace_dim > 0.   
+0001d5a0: 200a 2020 2020 4061 6c69 6173 2822 6973   .    @alias("is
+0001d5b0: 5f73 7061 6365 6469 6d22 290a 2020 2020  _spacedim").    
+0001d5c0: 6465 6620 6973 5f73 7061 6365 5f64 696d  def is_space_dim
+0001d5d0: 2873 656c 662c 2069 293a 0a20 2020 2020  (self, i):.     
+0001d5e0: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
+0001d5f0: 7061 6365 5f73 7461 7274 203c 3d20 6920  pace_start <= i 
+0001d600: 3c20 7365 6c66 2e73 7061 6365 5f73 746f  < self.space_sto
+0001d610: 700a 0a20 2020 2040 616c 6961 7328 226e  p..    @alias("n
+0001d620: 7370 6163 6564 696d 2229 0a20 2020 2040  spacedim").    @
+0001d630: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+0001d640: 206e 5f73 7061 6365 5f64 696d 2873 656c   n_space_dim(sel
+0001d650: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
+0001d660: 726e 2073 656c 662e 6e5f 6469 6d20 2d20  rn self.n_dim - 
+0001d670: 7365 6c66 2e6e 5f66 756e 635f 6469 6d20  self.n_func_dim 
+0001d680: 2d20 7365 6c66 2e6e 5f62 6174 6368 5f64  - self.n_batch_d
+0001d690: 696d 202d 2073 656c 662e 6e5f 6665 6174  im - self.n_feat
+0001d6a0: 7572 655f 6469 6d20 2d20 7365 6c66 2e6e  ure_dim - self.n
+0001d6b0: 5f73 6571 7565 6e63 655f 6469 6d0a 2020  _sequence_dim.  
+0001d6c0: 2020 0a20 2020 2040 7072 6f70 6572 7479    .    @property
+0001d6d0: 0a20 2020 2064 6566 2073 7061 6365 5f73  .    def space_s
+0001d6e0: 7461 7274 2873 656c 6629 3a0a 2020 2020  tart(self):.    
+0001d6f0: 2020 2020 7265 7475 726e 206d 6178 5f28      return max_(
+0001d700: 7365 6c66 2e73 7a5f 6675 6e63 5f64 696d  self.sz_func_dim
+0001d710: 2c20 3029 202b 206d 6178 5f28 7365 6c66  , 0) + max_(self
+0001d720: 2e73 7a5f 6261 7463 685f 6469 6d2c 2030  .sz_batch_dim, 0
+0001d730: 2920 2b20 6d61 785f 2873 656c 662e 737a  ) + max_(self.sz
+0001d740: 5f66 6561 7475 7265 5f64 696d 2c20 3029  _feature_dim, 0)
+0001d750: 202b 206d 6178 5f28 7365 6c66 2e73 7a5f   + max_(self.sz_
+0001d760: 7365 7175 656e 6365 5f64 696d 2c20 3029  sequence_dim, 0)
+0001d770: 0a20 2020 200a 2020 2020 4070 726f 7065  .    .    @prope
+0001d780: 7274 790a 2020 2020 6465 6620 7370 6163  rty.    def spac
+0001d790: 655f 7374 6f70 2873 656c 6629 3a0a 2020  e_stop(self):.  
+0001d7a0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0001d7b0: 662e 6e5f 6469 6d20 2b20 6d69 6e5f 2873  f.n_dim + min_(s
+0001d7c0: 656c 662e 737a 5f66 756e 635f 6469 6d2c  elf.sz_func_dim,
+0001d7d0: 2030 2920 2b20 6d69 6e5f 2873 656c 662e   0) + min_(self.
+0001d7e0: 737a 5f62 6174 6368 5f64 696d 2c20 3029  sz_batch_dim, 0)
+0001d7f0: 202b 206d 696e 5f28 7365 6c66 2e73 7a5f   + min_(self.sz_
+0001d800: 6665 6174 7572 655f 6469 6d2c 2030 2920  feature_dim, 0) 
+0001d810: 2b20 6d69 6e5f 2873 656c 662e 737a 5f73  + min_(self.sz_s
+0001d820: 6571 7565 6e63 655f 6469 6d2c 2030 290a  equence_dim, 0).
+0001d830: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+0001d840: 2020 2064 6566 2073 7061 6365 5f72 616e     def space_ran
+0001d850: 6765 2873 656c 6629 3a0a 2020 2020 2020  ge(self):.      
+0001d860: 2020 7265 7475 726e 2028 7365 6c66 2e73    return (self.s
+0001d870: 7061 6365 5f73 7461 7274 2c20 7365 6c66  pace_start, self
+0001d880: 2e73 7061 6365 5f73 746f 7029 0a0a 2020  .space_stop)..  
+0001d890: 2020 4061 6c69 6173 2822 6e73 7061 6365    @alias("nspace
+0001d8a0: 2229 0a20 2020 2040 7072 6f70 6572 7479  ").    @property
+0001d8b0: 0a20 2020 2064 6566 206e 5f73 7061 6365  .    def n_space
+0001d8c0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001d8d0: 6176 6f75 6368 2873 656c 662e 6861 735f  avouch(self.has_
+0001d8e0: 7370 6163 652c 2054 7970 6545 7272 6f72  space, TypeError
+0001d8f0: 2866 2243 616e 6e6f 7420 6765 7420 7370  (f"Cannot get sp
+0001d900: 6163 6520 6469 6d65 6e73 696f 6e73 2066  ace dimensions f
+0001d910: 726f 6d20 7369 7a65 207b 7365 6c66 7d2e  rom size {self}.
+0001d920: 2229 290a 2020 2020 2020 2020 7020 3d20  ")).        p = 
+0001d930: 310a 2020 2020 2020 2020 666f 7220 6920  1.        for i 
+0001d940: 696e 2072 616e 6765 5f28 2a73 656c 662e  in range_(*self.
+0001d950: 7370 6163 655f 7261 6e67 6529 3a20 7020  space_range): p 
+0001d960: 2a3d 2073 656c 665b 695d 0a20 2020 2020  *= self[i].     
+0001d970: 2020 2072 6574 7572 6e20 700a 0a20 2020     return p..   
+0001d980: 2040 616c 6961 7328 2273 7061 6365 5f73   @alias("space_s
+0001d990: 697a 6522 290a 2020 2020 4070 726f 7065  ize").    @prope
+0001d9a0: 7274 790a 2020 2020 6465 6620 7370 6163  rty.    def spac
+0001d9b0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+0001d9c0: 2072 6574 7572 6e20 7365 6c66 5b73 656c   return self[sel
+0001d9d0: 662e 7370 6163 655f 7374 6172 743a 7365  f.space_start:se
+0001d9e0: 6c66 2e73 7061 6365 5f73 746f 705d 0a0a  lf.space_stop]..
+0001d9f0: 2020 2020 6465 6620 7769 7468 5f73 7061      def with_spa
+0001da00: 6365 2873 656c 662c 202a 7369 7a65 293a  ce(self, *size):
+0001da10: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+0001da20: 7369 7a65 2920 3d3d 2031 2061 6e64 2069  size) == 1 and i
+0001da30: 7369 6e73 7461 6e63 6528 7369 7a65 5b30  sinstance(size[0
+0001da40: 5d2c 2074 7570 6c65 293a 2073 697a 6520  ], tuple): size 
+0001da50: 3d20 7369 7a65 5b30 5d0a 2020 2020 2020  = size[0].      
+0001da60: 2020 6176 6f75 6368 2861 6c6c 5f28 6973    avouch(all_(is
+0001da70: 696e 7374 616e 6365 2878 2c20 696e 745f  instance(x, int_
+0001da80: 2920 666f 7220 7820 696e 2073 697a 6529  ) for x in size)
+0001da90: 2c20 5479 7065 4572 726f 7228 2273 7061  , TypeError("spa
+0001daa0: 6365 2073 697a 6520 7368 6f75 6c64 2062  ce size should b
+0001dab0: 6520 6120 7475 706c 6520 6f66 2069 6e74  e a tuple of int
+0001dac0: 6567 6572 732e 2022 2929 0a20 2020 2020  egers. ")).     
+0001dad0: 2020 2023 2061 766f 7563 6828 6c65 6e28     # avouch(len(
+0001dae0: 7369 7a65 2920 3d3d 2073 656c 662e 6e5f  size) == self.n_
+0001daf0: 7370 6163 655f 6469 6d2c 2066 2243 616e  space_dim, f"Can
+0001db00: 6e6f 7420 7375 6273 7469 7475 7465 2073  not substitute s
+0001db10: 7061 6365 2069 6e20 7b73 656c 667d 2062  pace in {self} b
+0001db20: 7920 7b73 697a 657d 2061 7320 7468 6569  y {size} as thei
+0001db30: 7220 6469 6d65 6e73 696f 6e73 2061 7265  r dimensions are
+0001db40: 206e 6f74 2074 6865 2073 616d 652e 2229   not the same.")
+0001db50: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001db60: 7365 6c66 5b3a 7365 6c66 2e73 7061 6365  self[:self.space
+0001db70: 5f73 7461 7274 5d20 2b20 7369 7a65 202b  _start] + size +
+0001db80: 2073 656c 665b 7365 6c66 2e73 7061 6365   self[self.space
+0001db90: 5f73 746f 703a 5d0a 0a20 2020 2023 2320  _stop:]..    ## 
+0001dba0: 7370 6563 6961 6c20 6469 6d65 6e73 696f  special dimensio
+0001dbb0: 6e73 3a0a 2020 2020 4070 726f 7065 7274  ns:.    @propert
+0001dbc0: 790a 2020 2020 6465 6620 6861 735f 7370  y.    def has_sp
+0001dbd0: 6563 6961 6c28 7365 6c66 293a 2072 6574  ecial(self): ret
+0001dbe0: 7572 6e20 7365 6c66 2e68 6173 5f66 756e  urn self.has_fun
+0001dbf0: 6320 6f72 2073 656c 662e 6861 735f 6261  c or self.has_ba
+0001dc00: 7463 6820 6f72 2073 656c 662e 6861 735f  tch or self.has_
+0001dc10: 6665 6174 7572 6520 6f72 2073 656c 662e  feature or self.
+0001dc20: 6861 735f 7365 7175 656e 6365 0a0a 2020  has_sequence..  
+0001dc30: 2020 4061 6c69 6173 2822 6e73 7065 6369    @alias("nspeci
+0001dc40: 616c 6469 6d22 290a 2020 2020 4070 726f  aldim").    @pro
+0001dc50: 7065 7274 790a 2020 2020 6465 6620 6e5f  perty.    def n_
+0001dc60: 7370 6563 6961 6c5f 6469 6d28 7365 6c66  special_dim(self
+0001dc70: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+0001dc80: 6e20 7365 6c66 2e6e 5f66 756e 635f 6469  n self.n_func_di
+0001dc90: 6d20 2b20 7365 6c66 2e6e 5f62 6174 6368  m + self.n_batch
+0001dca0: 5f64 696d 202b 2073 656c 662e 6e5f 6665  _dim + self.n_fe
+0001dcb0: 6174 7572 655f 6469 6d20 2b20 7365 6c66  ature_dim + self
+0001dcc0: 2e6e 5f73 6571 7565 6e63 655f 6469 6d0a  .n_sequence_dim.
+0001dcd0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+0001dce0: 2020 2064 6566 2073 7065 6369 616c 5f64     def special_d
+0001dcf0: 696d 7328 7365 6c66 293a 0a20 2020 2020  ims(self):.     
+0001dd00: 2020 2073 6469 6d5f 6c69 7374 203d 2028     sdim_list = (
+0001dd10: 285b 5d20 6966 2073 656c 662e 737a 5f66  ([] if self.sz_f
+0001dd20: 756e 635f 6469 6d20 3d3d 2030 2065 6c73  unc_dim == 0 els
+0001dd30: 6520 285b 305d 2069 6620 7365 6c66 2e73  e ([0] if self.s
+0001dd40: 7a5f 6675 6e63 5f64 696d 203e 2030 2065  z_func_dim > 0 e
+0001dd50: 6c73 6520 5b73 656c 662e 6e5f 6469 6d2d  lse [self.n_dim-
+0001dd60: 315d 2929 202b 200a 2020 2020 2020 2020  1])) + .        
+0001dd70: 2020 2020 2020 2020 2020 2020 2028 5b5d               ([]
+0001dd80: 2069 6620 7365 6c66 2e73 7a5f 6261 7463   if self.sz_batc
+0001dd90: 685f 6469 6d20 3d3d 2030 2065 6c73 6520  h_dim == 0 else 
+0001dda0: 285b 7365 6c66 2e73 697a 655f 7374 6172  ([self.size_star
+0001ddb0: 745d 2069 6620 7365 6c66 2e73 7a5f 6261  t] if self.sz_ba
+0001ddc0: 7463 685f 6469 6d20 3e20 3020 656c 7365  tch_dim > 0 else
+0001ddd0: 205b 7365 6c66 2e73 697a 655f 7374 6f70   [self.size_stop
+0001dde0: 5d29 2920 2b20 0a20 2020 2020 2020 2020  ])) + .         
+0001ddf0: 2020 2020 2020 2020 2020 2020 285b 5d20              ([] 
+0001de00: 6966 2073 656c 662e 737a 5f66 6561 7475  if self.sz_featu
+0001de10: 7265 5f64 696d 203d 3d20 3020 656c 7365  re_dim == 0 else
+0001de20: 206c 6973 7428 7261 6e67 655f 2873 656c   list(range_(sel
+0001de30: 662e 6665 6174 7572 655f 7374 6172 742c  f.feature_start,
+0001de40: 2073 656c 662e 6665 6174 7572 655f 7374   self.feature_st
+0001de50: 6f70 2929 2920 2b20 0a20 2020 2020 2020  op))) + .       
+0001de60: 2020 2020 2020 2020 2020 2020 2020 285b                ([
+0001de70: 5d20 6966 2073 656c 662e 737a 5f73 6571  ] if self.sz_seq
+0001de80: 7565 6e63 655f 6469 6d20 3d3d 2030 2065  uence_dim == 0 e
+0001de90: 6c73 6520 6c69 7374 2872 616e 6765 5f28  lse list(range_(
+0001dea0: 7365 6c66 2e73 6571 7565 6e63 655f 7374  self.sequence_st
+0001deb0: 6172 742c 2073 656c 662e 7365 7175 656e  art, self.sequen
+0001dec0: 6365 5f73 746f 7029 2929 290a 2020 2020  ce_stop)))).    
+0001ded0: 2020 2020 7364 696d 5f6c 6973 742e 736f      sdim_list.so
+0001dee0: 7274 2829 0a20 2020 2020 2020 2072 6574  rt().        ret
+0001def0: 7572 6e20 7364 696d 5f6c 6973 740a 2020  urn sdim_list.  
+0001df00: 2020 0a20 2020 2064 6566 2061 6464 5f73    .    def add_s
+0001df10: 7065 6369 616c 5f64 696d 2873 656c 662c  pecial_dim(self,
+0001df20: 2069 6e64 6578 2c20 2a72 6566 6572 656e   index, *referen
+0001df30: 6365 293a 0a20 2020 2020 2020 2061 766f  ce):.        avo
+0001df40: 7563 6828 6c65 6e28 7265 6665 7265 6e63  uch(len(referenc
+0001df50: 6529 203d 3d20 312c 2054 7970 6545 7272  e) == 1, TypeErr
+0001df60: 6f72 2822 4f6e 6c79 206f 6e65 2064 696d  or("Only one dim
+0001df70: 656e 7369 6f6e 2069 7320 6163 6365 7074  ension is accept
+0001df80: 6162 6c65 2066 6f72 2027 6164 645f 7370  able for 'add_sp
+0001df90: 6563 6961 6c5f 6469 6d27 2e20 2229 290a  ecial_dim'. ")).
+0001dfa0: 2020 2020 2020 2020 6176 6f75 6368 282d          avouch(-
+0001dfb0: 7365 6c66 2e6e 5f64 696d 203c 3d20 696e  self.n_dim <= in
+0001dfc0: 6465 7820 3c20 7365 6c66 2e6e 5f64 696d  dex < self.n_dim
+0001dfd0: 2c20 5479 7065 4572 726f 7228 6622 496e  , TypeError(f"In
+0001dfe0: 6465 7820 666f 7220 2761 6464 5f73 7065  dex for 'add_spe
+0001dff0: 6369 616c 5f64 696d 2720 7368 6f75 6c64  cial_dim' should
+0001e000: 2062 6520 7769 7468 696e 2074 6865 2074   be within the t
+0001e010: 6f74 616c 2064 696d 656e 7369 6f6e 733a  otal dimensions:
+0001e020: 2066 726f 6d20 7b2d 7365 6c66 2e6e 5f64   from {-self.n_d
+0001e030: 696d 7d20 746f 207b 7365 6c66 2e6e 5f64  im} to {self.n_d
+0001e040: 696d 2d31 7d2e 2022 2929 0a20 2020 2020  im-1}. ")).     
+0001e050: 2020 2069 6620 696e 6465 7820 3c20 303a     if index < 0:
+0001e060: 2069 6e64 6578 202b 3d20 7365 6c66 2e6e   index += self.n
+0001e070: 5f64 696d 0a20 2020 2020 2020 2069 6620  _dim.        if 
+0001e080: 6e6f 7420 6973 696e 7374 616e 6365 2872  not isinstance(r
+0001e090: 6566 6572 656e 6365 5b30 5d2c 2053 697a  eference[0], Siz
+0001e0a0: 6529 3a20 7265 6665 7265 6e63 6520 3d20  e): reference = 
+0001e0b0: 5369 7a65 282a 7265 6665 7265 6e63 6529  Size(*reference)
+0001e0c0: 0a20 2020 2020 2020 2065 6c73 653a 2072  .        else: r
+0001e0d0: 6566 6572 656e 6365 203d 2072 6566 6572  eference = refer
+0001e0e0: 656e 6365 5b30 5d0a 2020 2020 2020 2020  ence[0].        
+0001e0f0: 6966 2072 6566 6572 656e 6365 2e68 6173  if reference.has
+0001e100: 5f66 756e 633a 0a20 2020 2020 2020 2020  _func:.         
+0001e110: 2020 2072 6574 7572 6e20 7365 6c66 5b3a     return self[:
+0001e120: 696e 6465 785d 202b 2066 756e 635f 6469  index] + func_di
+0001e130: 6d5f 7369 7a65 2873 656c 665b 696e 6465  m_size(self[inde
+0001e140: 785d 2920 2b20 7365 6c66 5b69 6e64 6578  x]) + self[index
+0001e150: 2b31 3a5d 0a20 2020 2020 2020 2069 6620  +1:].        if 
+0001e160: 7265 6665 7265 6e63 652e 6861 735f 6261  reference.has_ba
+0001e170: 7463 683a 0a20 2020 2020 2020 2020 2020  tch:.           
+0001e180: 2072 6574 7572 6e20 7365 6c66 5b3a 696e   return self[:in
+0001e190: 6465 785d 202b 2053 697a 6528 7b73 656c  dex] + Size({sel
+0001e1a0: 665b 696e 6465 785d 7d29 202b 2073 656c  f[index]}) + sel
+0001e1b0: 665b 696e 6465 782b 313a 5d0a 2020 2020  f[index+1:].    
+0001e1c0: 2020 2020 6966 2072 6566 6572 656e 6365      if reference
+0001e1d0: 2e68 6173 5f66 6561 7475 7265 3a0a 2020  .has_feature:.  
+0001e1e0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+0001e1f0: 662e 6861 735f 6665 6174 7572 653a 2061  f.has_feature: a
+0001e200: 766f 7563 6828 7365 6c66 2e66 6561 7475  vouch(self.featu
+0001e210: 7265 5f73 7461 7274 202d 2031 203c 3d20  re_start - 1 <= 
+0001e220: 696e 6465 7820 3c3d 2073 656c 662e 6665  index <= self.fe
+0001e230: 6174 7572 655f 7374 6f70 2c20 5479 7065  ature_stop, Type
+0001e240: 4572 726f 7228 6622 4f6e 6c79 2064 696d  Error(f"Only dim
+0001e250: 656e 7369 6f6e 7320 6164 6a61 6365 6e74  ensions adjacent
+0001e260: 2074 6f20 6375 7272 656e 7420 6361 6e20   to current can 
+0001e270: 6265 2063 6f6e 7665 7274 6564 2069 6e74  be converted int
+0001e280: 6f20 6665 6174 7572 6573 2062 7920 2761  o features by 'a
+0001e290: 6464 5f73 7065 6369 616c 5f64 696d 273a  dd_special_dim':
+0001e2a0: 2074 7279 696e 6720 746f 2063 6f6e 7665   trying to conve
+0001e2b0: 7274 207b 696e 6465 787d 2d74 6820 6469  rt {index}-th di
+0001e2c0: 6d20 746f 2066 6561 7475 7265 2069 6e20  m to feature in 
+0001e2d0: 7b73 656c 667d 2e20 2229 290a 2020 2020  {self}. ")).    
+0001e2e0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0001e2f0: 656c 665b 3a69 6e64 6578 5d20 2b20 5369  elf[:index] + Si
+0001e300: 7a65 285b 7365 6c66 5b69 6e64 6578 5d5d  ze([self[index]]
+0001e310: 2920 2b20 7365 6c66 5b69 6e64 6578 2b31  ) + self[index+1
+0001e320: 3a5d 0a20 2020 2020 2020 2069 6620 7265  :].        if re
+0001e330: 6665 7265 6e63 652e 6861 735f 7365 7175  ference.has_sequ
+0001e340: 656e 6365 3a0a 2020 2020 2020 2020 2020  ence:.          
+0001e350: 2020 6966 2073 656c 662e 6861 735f 7365    if self.has_se
+0001e360: 7175 656e 6365 3a20 6176 6f75 6368 2873  quence: avouch(s
+0001e370: 656c 662e 7365 7175 656e 6365 5f73 7461  elf.sequence_sta
+0001e380: 7274 202d 2031 203c 3d20 696e 6465 7820  rt - 1 <= index 
+0001e390: 3c3d 2073 656c 662e 7365 7175 656e 6365  <= self.sequence
+0001e3a0: 5f73 746f 702c 2054 7970 6545 7272 6f72  _stop, TypeError
+0001e3b0: 2866 224f 6e6c 7920 6469 6d65 6e73 696f  (f"Only dimensio
+0001e3c0: 6e73 2061 646a 6163 656e 7420 746f 2063  ns adjacent to c
+0001e3d0: 7572 7265 6e74 2063 616e 2062 6520 636f  urrent can be co
+0001e3e0: 6e76 6572 7465 6420 696e 746f 2073 6571  nverted into seq
+0001e3f0: 7565 6e63 6573 2062 7920 2761 6464 5f73  uences by 'add_s
+0001e400: 7065 6369 616c 5f64 696d 273a 2074 7279  pecial_dim': try
+0001e410: 696e 6720 746f 2063 6f6e 7665 7274 207b  ing to convert {
+0001e420: 696e 6465 787d 2d74 6820 6469 6d20 746f  index}-th dim to
+0001e430: 2073 6571 7565 6e63 6520 696e 207b 7365   sequence in {se
+0001e440: 6c66 7d2e 2022 2929 0a20 2020 2020 2020  lf}. ")).       
+0001e450: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0001e460: 5b3a 696e 6465 785d 202b 2053 697a 6528  [:index] + Size(
+0001e470: 7265 7072 2873 7472 2873 656c 665b 696e  repr(str(self[in
+0001e480: 6465 785d 2929 2920 2b20 7365 6c66 5b69  dex]))) + self[i
+0001e490: 6e64 6578 2b31 3a5d 0a20 2020 2020 2020  ndex+1:].       
+0001e4a0: 2072 6574 7572 6e20 7365 6c66 0a20 2020   return self.   
+0001e4b0: 200a 2020 2020 6465 6620 6368 616e 6765   .    def change
+0001e4c0: 5f73 7065 6369 616c 5f64 696d 2873 656c  _special_dim(sel
+0001e4d0: 662c 2066 726f 6d5f 6469 6d2c 202a 746f  f, from_dim, *to
+0001e4e0: 5f64 696d 293a 0a20 2020 2020 2020 2066  _dim):.        f
+0001e4f0: 726f 6d5f 6469 6d20 3d20 6578 6973 745f  rom_dim = exist_
+0001e500: 6469 6d28 7365 6c66 2c20 6672 6f6d 5f64  dim(self, from_d
+0001e510: 696d 290a 2020 2020 2020 2020 6176 6f75  im).        avou
+0001e520: 6368 286c 656e 2866 726f 6d5f 6469 6d29  ch(len(from_dim)
+0001e530: 203d 3d20 312c 2054 7970 6545 7272 6f72   == 1, TypeError
+0001e540: 2822 4f6e 6c79 206f 6e65 2027 6672 6f6d  ("Only one 'from
+0001e550: 5f64 696d 2720 6973 2061 6363 6570 7461  _dim' is accepta
+0001e560: 626c 6520 666f 7220 2763 6861 6e67 655f  ble for 'change_
+0001e570: 7370 6563 6961 6c5f 6469 6d27 2e20 2229  special_dim'. ")
+0001e580: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0001e590: 2073 656c 662e 6164 645f 7370 6563 6961   self.add_specia
+0001e5a0: 6c5f 6469 6d28 6672 6f6d 5f64 696d 5b30  l_dim(from_dim[0
+0001e5b0: 5d2c 202a 746f 5f64 696d 290a 0a20 2020  ], *to_dim)..   
+0001e5c0: 2064 6566 2073 7065 6369 616c 5f66 726f   def special_fro
+0001e5d0: 6d28 7365 6c66 2c20 6f74 6865 722c 2061  m(self, other, a
+0001e5e0: 6c6c 6f77 5f76 6965 773d 4661 6c73 6529  llow_view=False)
+0001e5f0: 3a0a 2020 2020 2020 2020 6176 6f75 6368  :.        avouch
+0001e600: 2869 7369 6e73 7461 6e63 6528 6f74 6865  (isinstance(othe
+0001e610: 722c 2028 7475 706c 652c 2053 697a 652c  r, (tuple, Size,
+0001e620: 2054 656e 736f 7229 292c 2054 7970 6545   Tensor)), TypeE
+0001e630: 7272 6f72 2866 2249 6e76 616c 6964 2069  rror(f"Invalid i
+0001e640: 6e70 7574 2066 6f72 2053 697a 652e 7370  nput for Size.sp
+0001e650: 6563 6961 6c5f 6672 6f6d 3a20 7b74 7970  ecial_from: {typ
+0001e660: 6528 6f74 6865 7229 7d2e 2022 2929 0a20  e(other)}. ")). 
+0001e670: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0001e680: 616e 6365 286f 7468 6572 2c20 5465 6e73  ance(other, Tens
+0001e690: 6f72 293a 206f 7468 6572 203d 206f 7468  or): other = oth
+0001e6a0: 6572 2e73 6861 7065 0a20 2020 2020 2020  er.shape.       
+0001e6b0: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
+0001e6c0: 7468 6572 2c20 5369 7a65 293a 0a20 2020  ther, Size):.   
+0001e6d0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+0001e6e0: 2e6e 5f64 696d 2021 3d20 6f74 6865 722e  .n_dim != other.
+0001e6f0: 6e5f 6469 6d3a 0a20 2020 2020 2020 2020  n_dim:.         
+0001e700: 2020 2020 2020 2069 6620 616c 6c6f 775f         if allow_
+0001e710: 7669 6577 3a20 7265 7475 726e 2073 656c  view: return sel
+0001e720: 662e 7669 6577 286f 7468 6572 290a 2020  f.view(other).  
+0001e730: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0001e740: 6973 6520 5479 7065 4572 726f 7228 6622  ise TypeError(f"
+0001e750: 4469 6d65 6e73 696f 6e20 6d69 736d 6174  Dimension mismat
+0001e760: 6368 2077 6865 6e20 696e 6865 7269 7469  ch when inheriti
+0001e770: 6e67 2073 7065 6369 616c 2064 696d 656e  ng special dimen
+0001e780: 7369 6f6e 733a 2066 726f 6d20 7b6f 7468  sions: from {oth
+0001e790: 6572 2e6e 5f64 696d 7d20 746f 207b 7365  er.n_dim} to {se
+0001e7a0: 6c66 2e6e 5f64 696d 7d2e 2022 290a 2020  lf.n_dim}. ").  
+0001e7b0: 2020 2020 2020 7365 6c66 2e73 7a5f 6675        self.sz_fu
+0001e7c0: 6e63 5f64 696d 203d 2067 6574 6174 7472  nc_dim = getattr
+0001e7d0: 286f 7468 6572 2c20 2773 7a5f 6675 6e63  (other, 'sz_func
+0001e7e0: 5f64 696d 272c 2030 290a 2020 2020 2020  _dim', 0).      
+0001e7f0: 2020 7365 6c66 2e73 7a5f 6261 7463 685f    self.sz_batch_
+0001e800: 6469 6d20 3d20 6765 7461 7474 7228 6f74  dim = getattr(ot
+0001e810: 6865 722c 2027 737a 5f62 6174 6368 5f64  her, 'sz_batch_d
+0001e820: 696d 272c 2030 290a 2020 2020 2020 2020  im', 0).        
+0001e830: 7365 6c66 2e73 7a5f 6665 6174 7572 655f  self.sz_feature_
+0001e840: 6469 6d20 3d20 6765 7461 7474 7228 6f74  dim = getattr(ot
+0001e850: 6865 722c 2027 737a 5f66 6561 7475 7265  her, 'sz_feature
+0001e860: 5f64 696d 272c 2030 290a 2020 2020 2020  _dim', 0).      
+0001e870: 2020 7365 6c66 2e73 7a5f 7365 7175 656e    self.sz_sequen
+0001e880: 6365 5f64 696d 203d 2067 6574 6174 7472  ce_dim = getattr
+0001e890: 286f 7468 6572 2c20 2773 7a5f 7365 7175  (other, 'sz_sequ
+0001e8a0: 656e 6365 5f64 696d 272c 2030 290a 2020  ence_dim', 0).  
+0001e8b0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0001e8c0: 660a 0a20 2020 2064 6566 2075 7064 6174  f..    def updat
+0001e8d0: 655f 7370 6563 6961 6c5f 6672 6f6d 2873  e_special_from(s
+0001e8e0: 656c 662c 206f 7468 6572 293a 0a20 2020  elf, other):.   
+0001e8f0: 2020 2020 2061 766f 7563 6828 6973 696e       avouch(isin
+0001e900: 7374 616e 6365 286f 7468 6572 2c20 2874  stance(other, (t
+0001e910: 7570 6c65 2c20 5369 7a65 2c20 5465 6e73  uple, Size, Tens
+0001e920: 6f72 2929 2c20 5479 7065 4572 726f 7228  or)), TypeError(
+0001e930: 6622 496e 7661 6c69 6420 696e 7075 7420  f"Invalid input 
+0001e940: 666f 7220 5369 7a65 2e73 7065 6369 616c  for Size.special
+0001e950: 5f66 726f 6d3a 207b 7479 7065 286f 7468  _from: {type(oth
+0001e960: 6572 297d 2e20 2229 290a 2020 2020 2020  er)}. ")).      
+0001e970: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0001e980: 6f74 6865 722c 2054 656e 736f 7229 3a20  other, Tensor): 
+0001e990: 6f74 6865 7220 3d20 6f74 6865 722e 7368  other = other.sh
+0001e9a0: 6170 650a 2020 2020 2020 2020 737a 5f66  ape.        sz_f
+0001e9b0: 756e 635f 6469 6d20 3d20 6765 7461 7474  unc_dim = getatt
+0001e9c0: 7228 6f74 6865 722c 2027 737a 5f66 756e  r(other, 'sz_fun
+0001e9d0: 635f 6469 6d27 2c20 3029 0a20 2020 2020  c_dim', 0).     
+0001e9e0: 2020 2069 6620 737a 5f66 756e 635f 6469     if sz_func_di
+0001e9f0: 6d20 213d 2030 3a20 7365 6c66 2e73 7a5f  m != 0: self.sz_
+0001ea00: 6675 6e63 5f64 696d 203d 2073 7a5f 6675  func_dim = sz_fu
+0001ea10: 6e63 5f64 696d 0a20 2020 2020 2020 2073  nc_dim.        s
+0001ea20: 7a5f 6261 7463 685f 6469 6d20 3d20 6765  z_batch_dim = ge
+0001ea30: 7461 7474 7228 6f74 6865 722c 2027 737a  tattr(other, 'sz
+0001ea40: 5f62 6174 6368 5f64 696d 272c 2030 290a  _batch_dim', 0).
+0001ea50: 2020 2020 2020 2020 6966 2073 7a5f 6261          if sz_ba
+0001ea60: 7463 685f 6469 6d20 213d 2030 3a20 7365  tch_dim != 0: se
+0001ea70: 6c66 2e73 7a5f 6261 7463 685f 6469 6d20  lf.sz_batch_dim 
+0001ea80: 3d20 737a 5f62 6174 6368 5f64 696d 0a20  = sz_batch_dim. 
+0001ea90: 2020 2020 2020 2073 7a5f 6665 6174 7572         sz_featur
+0001eaa0: 655f 6469 6d20 3d20 6765 7461 7474 7228  e_dim = getattr(
+0001eab0: 6f74 6865 722c 2027 737a 5f66 6561 7475  other, 'sz_featu
+0001eac0: 7265 5f64 696d 272c 2030 290a 2020 2020  re_dim', 0).    
+0001ead0: 2020 2020 6966 2073 7a5f 6665 6174 7572      if sz_featur
+0001eae0: 655f 6469 6d20 213d 2030 3a20 7365 6c66  e_dim != 0: self
+0001eaf0: 2e73 7a5f 6665 6174 7572 655f 6469 6d20  .sz_feature_dim 
+0001eb00: 3d20 737a 5f66 6561 7475 7265 5f64 696d  = sz_feature_dim
+0001eb10: 0a20 2020 2020 2020 2073 7a5f 7365 7175  .        sz_sequ
+0001eb20: 656e 6365 5f64 696d 203d 2067 6574 6174  ence_dim = getat
+0001eb30: 7472 286f 7468 6572 2c20 2773 7a5f 7365  tr(other, 'sz_se
+0001eb40: 7175 656e 6365 5f64 696d 272c 2030 290a  quence_dim', 0).
+0001eb50: 2020 2020 2020 2020 6966 2073 7a5f 7365          if sz_se
+0001eb60: 7175 656e 6365 5f64 696d 2021 3d20 303a  quence_dim != 0:
+0001eb70: 2073 656c 662e 737a 5f73 6571 7565 6e63   self.sz_sequenc
+0001eb80: 655f 6469 6d20 3d20 737a 5f73 6571 7565  e_dim = sz_seque
+0001eb90: 6e63 655f 6469 6d0a 2020 2020 2020 2020  nce_dim.        
+0001eba0: 7265 7475 726e 2073 656c 660a 0a20 2020  return self..   
+0001ebb0: 2064 6566 2069 6e69 745f 7370 6563 6961   def init_specia
+0001ebc0: 6c28 7365 6c66 293a 0a20 2020 2020 2020  l(self):.       
+0001ebd0: 2073 656c 662e 737a 5f66 756e 635f 6469   self.sz_func_di
+0001ebe0: 6d20 3d20 300a 2020 2020 2020 2020 7365  m = 0.        se
+0001ebf0: 6c66 2e73 7a5f 6261 7463 685f 6469 6d20  lf.sz_batch_dim 
+0001ec00: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+0001ec10: 2e73 7a5f 6665 6174 7572 655f 6469 6d20  .sz_feature_dim 
+0001ec20: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+0001ec30: 2e73 7a5f 7365 7175 656e 6365 5f64 696d  .sz_sequence_dim
+0001ec40: 203d 2030 0a20 2020 2020 2020 2072 6574   = 0.        ret
+0001ec50: 7572 6e20 7365 6c66 0a20 2020 200a 2020  urn self.    .  
+0001ec60: 2020 4061 6c69 6173 2822 6973 5f73 7065    @alias("is_spe
+0001ec70: 6369 616c 6469 6d22 290a 2020 2020 6465  cialdim").    de
+0001ec80: 6620 6973 5f73 7065 6369 616c 5f64 696d  f is_special_dim
+0001ec90: 2873 656c 662c 2069 293a 2072 6574 7572  (self, i): retur
+0001eca0: 6e20 7365 6c66 2e69 735f 6675 6e63 5f64  n self.is_func_d
+0001ecb0: 696d 2869 2920 6f72 2073 656c 662e 6973  im(i) or self.is
+0001ecc0: 5f62 6174 6368 5f64 696d 2869 2920 6f72  _batch_dim(i) or
+0001ecd0: 2073 656c 662e 6973 5f66 6561 7475 7265   self.is_feature
+0001ece0: 5f64 696d 2869 2920 6f72 2073 656c 662e  _dim(i) or self.
+0001ecf0: 6973 5f73 6571 7565 6e63 655f 6469 6d28  is_sequence_dim(
+0001ed00: 6929 0a0a 2020 2020 2323 2061 6c6c 2064  i)..    ## all d
+0001ed10: 696d 656e 7369 6f6e 733a 0a20 2020 2040  imensions:.    @
+0001ed20: 616c 6961 7328 226e 656c 6522 290a 2020  alias("nele").  
+0001ed30: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+0001ed40: 6465 6620 6e5f 656c 6528 7365 6c66 293a  def n_ele(self):
+0001ed50: 0a20 2020 2020 2020 2070 203d 2031 0a20  .        p = 1. 
+0001ed60: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+0001ed70: 7261 6e67 655f 2873 656c 662e 6e5f 6469  range_(self.n_di
+0001ed80: 6d29 3a20 7020 2a3d 2073 656c 665b 695d  m): p *= self[i]
+0001ed90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001eda0: 700a 0a20 2020 2040 616c 6961 7328 2277  p..    @alias("w
+0001edb0: 6974 685f 6e65 6c65 2229 0a20 2020 2064  ith_nele").    d
+0001edc0: 6566 2077 6974 685f 6e5f 656c 6528 7365  ef with_n_ele(se
+0001edd0: 6c66 2c20 6e5f 656c 6529 3a0a 2020 2020  lf, n_ele):.    
+0001ede0: 2020 2020 756e 6420 3d20 5b69 2066 6f72      und = [i for
+0001edf0: 2069 2c20 7820 696e 2065 6e75 6d65 7261   i, x in enumera
+0001ee00: 7465 2873 656c 6629 2069 6620 7820 3c20  te(self) if x < 
+0001ee10: 305d 0a20 2020 2020 2020 2069 6620 6c65  0].        if le
+0001ee20: 6e28 756e 6429 203d 3d20 303a 0a20 2020  n(und) == 0:.   
+0001ee30: 2020 2020 2020 2020 2061 766f 7563 6828           avouch(
+0001ee40: 6e5f 656c 6520 3d3d 2073 656c 662e 6e5f  n_ele == self.n_
+0001ee50: 656c 652c 2054 7970 6545 7272 6f72 2866  ele, TypeError(f
+0001ee60: 2243 616e 6e6f 7420 7365 7420 6e5f 656c  "Cannot set n_el
+0001ee70: 653d 7b6e 5f65 6c65 7d20 666f 7220 7369  e={n_ele} for si
+0001ee80: 7a65 207b 7365 6c66 7d20 7769 7468 6f75  ze {self} withou
+0001ee90: 7420 756e 6465 7465 726d 696e 6564 2064  t undetermined d
+0001eea0: 696d 656e 7369 6f6e 732e 2229 290a 2020  imensions.")).  
+0001eeb0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001eec0: 2073 656c 660a 2020 2020 2020 2020 6176   self.        av
+0001eed0: 6f75 6368 286c 656e 2875 6e64 2920 3d3d  ouch(len(und) ==
+0001eee0: 2031 2c20 5479 7065 4572 726f 7228 6622   1, TypeError(f"
+0001eef0: 4361 6e6e 6f74 2073 6574 206e 5f65 6c65  Cannot set n_ele
+0001ef00: 2066 6f72 2073 697a 6520 7b73 656c 667d   for size {self}
+0001ef10: 2077 6974 6820 6d6f 7265 2074 6861 6e20   with more than 
+0001ef20: 6f6e 6520 756e 6465 7465 726d 696e 6564  one undetermined
+0001ef30: 2064 696d 656e 7369 6f6e 732e 2229 290a   dimensions.")).
+0001ef40: 2020 2020 2020 2020 735f 656c 6520 3d20          s_ele = 
+0001ef50: 2d20 7365 6c66 2e6e 5f65 6c65 0a20 2020  - self.n_ele.   
+0001ef60: 2020 2020 2061 766f 7563 6828 6e5f 656c       avouch(n_el
+0001ef70: 6520 2520 735f 656c 6520 3d3d 2030 2c20  e % s_ele == 0, 
+0001ef80: 5479 7065 4572 726f 7228 6622 4361 6e6e  TypeError(f"Cann
+0001ef90: 6f74 2073 6574 206e 5f65 6c65 3d7b 6e5f  ot set n_ele={n_
+0001efa0: 656c 657d 2066 6f72 2073 697a 6520 7b73  ele} for size {s
+0001efb0: 656c 667d 2061 7320 6974 2069 7320 6e6f  elf} as it is no
+0001efc0: 7420 6120 6d75 6c74 6970 6c69 6361 7469  t a multiplicati
+0001efd0: 6f6e 206f 6620 6375 7272 656e 7420 7369  on of current si
+0001efe0: 7a65 207b 735f 656c 657d 2e20 2229 290a  ze {s_ele}. ")).
+0001eff0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0001f000: 656c 665b 3a75 6e64 5b30 5d5d 202b 2053  elf[:und[0]] + S
+0001f010: 697a 6528 6e5f 656c 6520 2f2f 2073 656c  ize(n_ele // sel
+0001f020: 662e 6e5f 656c 6529 2e73 7065 6369 616c  f.n_ele).special
+0001f030: 5f66 726f 6d28 7365 6c66 5b75 6e64 5b30  _from(self[und[0
+0001f040: 5d3a 756e 645b 305d 2b31 5d29 202b 2073  ]:und[0]+1]) + s
+0001f050: 656c 665b 756e 645b 305d 2b31 3a5d 0a20  elf[und[0]+1:]. 
+0001f060: 2020 200a 2020 2020 6465 6620 7769 7468     .    def with
+0001f070: 5f64 696d 5f73 697a 6528 7365 6c66 2c20  _dim_size(self, 
+0001f080: 696e 6465 782c 2073 697a 6529 3a0a 2020  index, size):.  
+0001f090: 2020 2020 2020 6966 2069 6e64 6578 203c        if index <
+0001f0a0: 2030 3a20 696e 6465 7820 2b3d 2073 656c   0: index += sel
+0001f0b0: 662e 6e5f 6469 6d0a 2020 2020 2020 2020  f.n_dim.        
+0001f0c0: 7265 7475 726e 2073 656c 665b 3a69 6e64  return self[:ind
+0001f0d0: 6578 5d20 2b20 5369 7a65 2873 697a 6529  ex] + Size(size)
+0001f0e0: 2e73 7065 6369 616c 5f66 726f 6d28 7365  .special_from(se
+0001f0f0: 6c66 5b69 6e64 6578 3a69 6e64 6578 2b31  lf[index:index+1
+0001f100: 5d29 202b 2073 656c 665b 696e 6465 782b  ]) + self[index+
+0001f110: 313a 5d0a 2020 2020 0a20 2020 2064 6566  1:].    .    def
+0001f120: 2074 7261 6e73 706f 7365 2873 656c 662c   transpose(self,
+0001f130: 2069 3a20 696e 745f 2c20 6a3a 696e 745f   i: int_, j:int_
+0001f140: 293a 0a20 2020 2020 2020 2069 6620 6920  ):.        if i 
+0001f150: 3d3d 206a 3a20 7265 7475 726e 2073 656c  == j: return sel
+0001f160: 660a 2020 2020 2020 2020 6966 2069 203e  f.        if i >
+0001f170: 206a 3a20 692c 206a 203d 206a 2c20 690a   j: i, j = j, i.
+0001f180: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0001f190: 6973 5f66 756e 635f 6469 6d28 6929 3a0a  is_func_dim(i):.
+0001f1a0: 2020 2020 2020 2020 2020 2020 6176 6f75              avou
+0001f1b0: 6368 284e 6f6e 652c 2049 6e64 6578 4572  ch(None, IndexEr
+0001f1c0: 726f 7228 2246 6169 6c75 7265 2069 6e20  ror("Failure in 
+0001f1d0: 2762 742e 5369 7a65 2e74 7261 6e73 706f  'bt.Size.transpo
+0001f1e0: 7365 273a 2043 616e 6e6f 7420 6d6f 7665  se': Cannot move
+0001f1f0: 2074 6865 2066 756e 6374 696f 6e61 6c20   the functional 
+0001f200: 6469 6d65 6e73 696f 6e2e 2022 2929 0a20  dimension. ")). 
+0001f210: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+0001f220: 735f 6261 7463 685f 6469 6d28 6929 3a0a  s_batch_dim(i):.
+0001f230: 2020 2020 2020 2020 2020 2020 6176 6f75              avou
+0001f240: 6368 284e 6f6e 652c 2049 6e64 6578 4572  ch(None, IndexEr
+0001f250: 726f 7228 2246 6169 6c75 7265 2069 6e20  ror("Failure in 
+0001f260: 2762 742e 5369 7a65 2e74 7261 6e73 706f  'bt.Size.transpo
+0001f270: 7365 273a 2043 616e 6e6f 7420 6d6f 7665  se': Cannot move
+0001f280: 2074 6865 2062 6174 6368 2064 696d 656e   the batch dimen
+0001f290: 7369 6f6e 2e20 2229 290a 2020 2020 2020  sion. ")).      
+0001f2a0: 2020 656c 6966 2073 656c 662e 6973 5f66    elif self.is_f
+0001f2b0: 6561 7475 7265 5f64 696d 2869 293a 0a20  eature_dim(i):. 
+0001f2c0: 2020 2020 2020 2020 2020 2061 766f 7563             avouc
+0001f2d0: 6828 7365 6c66 2e69 735f 6665 6174 7572  h(self.is_featur
+0001f2e0: 655f 6469 6d28 6a29 2c20 496e 6465 7845  e_dim(j), IndexE
+0001f2f0: 7272 6f72 2866 2246 6169 6c75 7265 2069  rror(f"Failure i
+0001f300: 6e20 2762 742e 5369 7a65 2e74 7261 6e73  n 'bt.Size.trans
+0001f310: 706f 7365 273a 2043 616e 6e6f 7420 6d6f  pose': Cannot mo
+0001f320: 7665 2066 6561 7475 7265 2064 696d 656e  ve feature dimen
+0001f330: 7369 6f6e 207b 697d 206f 7574 206f 6620  sion {i} out of 
+0001f340: 7468 6520 6665 6174 7572 6520 7363 6f70  the feature scop
+0001f350: 652e 2022 2929 0a20 2020 2020 2020 2065  e. ")).        e
+0001f360: 6c69 6620 7365 6c66 2e69 735f 7370 6163  lif self.is_spac
+0001f370: 655f 6469 6d28 6929 3a0a 2020 2020 2020  e_dim(i):.      
+0001f380: 2020 2020 2020 6176 6f75 6368 2873 656c        avouch(sel
+0001f390: 662e 6973 5f73 7061 6365 5f64 696d 286a  f.is_space_dim(j
+0001f3a0: 292c 2049 6e64 6578 4572 726f 7228 6622  ), IndexError(f"
+0001f3b0: 4661 696c 7572 6520 696e 2027 6274 2e53  Failure in 'bt.S
+0001f3c0: 697a 652e 7472 616e 7370 6f73 6527 3a20  ize.transpose': 
+0001f3d0: 4361 6e6e 6f74 206d 6f76 6520 7370 6163  Cannot move spac
+0001f3e0: 6520 6469 6d65 6e73 696f 6e20 7b69 7d20  e dimension {i} 
+0001f3f0: 6f75 7420 6f66 2074 6865 2073 7061 6365  out of the space
+0001f400: 2073 636f 7065 2e20 2229 290a 2020 2020   scope. ")).    
+0001f410: 2020 2020 7265 7475 726e 2073 656c 665b      return self[
+0001f420: 3a69 5d20 2b20 7365 6c66 5b6a 3a6a 2b31  :i] + self[j:j+1
+0001f430: 5d20 2b20 7365 6c66 5b69 2b31 3a6a 5d20  ] + self[i+1:j] 
+0001f440: 2b20 7365 6c66 5b69 3a69 2b31 5d20 2b20  + self[i:i+1] + 
+0001f450: 7365 6c66 5b6a 2b31 3a5d 0a0a 2020 2020  self[j+1:]..    
+0001f460: 2323 206d 6574 686f 6473 3a0a 2020 2020  ## methods:.    
+0001f470: 4061 6c69 6173 2822 636c 6f6e 6522 290a  @alias("clone").
+0001f480: 2020 2020 6465 6620 636f 7079 2873 656c      def copy(sel
+0001f490: 6629 3a20 7265 7475 726e 2053 697a 6528  f): return Size(
+0001f4a0: 7365 6c66 290a 0a20 2020 2040 616c 6961  self)..    @alia
+0001f4b0: 7328 2272 6177 2229 0a20 2020 2064 6566  s("raw").    def
+0001f4c0: 2074 7570 6c65 2873 656c 6629 3a20 7265   tuple(self): re
+0001f4d0: 7475 726e 2074 7570 6c65 2873 656c 6629  turn tuple(self)
+0001f4e0: 0a20 2020 200a 2020 2020 6465 6620 7065  .    .    def pe
+0001f4f0: 726d 7574 6528 7365 6c66 2c20 2a64 696d  rmute(self, *dim
+0001f500: 7329 3a0a 2020 2020 2020 2020 6966 206c  s):.        if l
+0001f510: 656e 2864 696d 7329 203d 3d20 3120 616e  en(dims) == 1 an
+0001f520: 6420 6973 696e 7374 616e 6365 2864 696d  d isinstance(dim
+0001f530: 735b 305d 2c20 7475 706c 6529 3a20 6469  s[0], tuple): di
+0001f540: 6d73 203d 2064 696d 735b 305d 0a20 2020  ms = dims[0].   
+0001f550: 2020 2020 2061 766f 7563 6828 736f 7274       avouch(sort
+0001f560: 6564 2864 696d 7329 203d 3d20 6c69 7374  ed(dims) == list
+0001f570: 2872 616e 6765 5f28 6c65 6e28 7365 6c66  (range_(len(self
+0001f580: 2929 292c 2054 7970 6545 7272 6f72 2822  ))), TypeError("
+0001f590: 2770 6572 6d75 7465 2720 6e65 6564 7320  'permute' needs 
+0001f5a0: 696e 7075 7420 6469 6d65 6e73 696f 6e73  input dimensions
+0001f5b0: 2066 6f72 6d69 6e67 2061 2070 6572 6d75   forming a permu
+0001f5c0: 7461 7469 6f6e 206f 6620 302d 286e 2d31  tation of 0-(n-1
+0001f5d0: 292e 2022 2929 0a20 2020 2020 2020 2072  ). ")).        r
+0001f5e0: 6574 7572 6e20 7375 6d5f 285b 7365 6c66  eturn sum_([self
+0001f5f0: 5b64 3a64 2b31 5d20 666f 7220 6420 696e  [d:d+1] for d in
+0001f600: 2064 696d 735d 2c20 5369 7a65 2829 2920   dims], Size()) 
+0001f610: 2020 200a 0a20 2020 2040 7072 6f70 6572     ..    @proper
+0001f620: 7479 0a20 2020 2064 6566 2070 7974 686f  ty.    def pytho
+0001f630: 6e5f 7265 7072 2873 656c 6629 3a0a 2020  n_repr(self):.  
+0001f640: 2020 2020 2020 6966 2073 656c 662e 6861        if self.ha
+0001f650: 735f 7370 6163 653a 206f 7574 7075 7420  s_space: output 
+0001f660: 3d20 7475 706c 6528 7365 6c66 2e73 7061  = tuple(self.spa
+0001f670: 6365 290a 2020 2020 2020 2020 656c 7365  ce).        else
+0001f680: 3a20 6f75 7470 7574 203d 2074 7570 6c65  : output = tuple
+0001f690: 2829 0a20 2020 2020 2020 2069 6620 7365  ().        if se
+0001f6a0: 6c66 2e68 6173 5f73 6571 7565 6e63 653a  lf.has_sequence:
+0001f6b0: 0a20 2020 2020 2020 2020 2020 2073 6571  .            seq
+0001f6c0: 7565 6e63 6520 3d20 7374 7228 6c69 7374  uence = str(list
+0001f6d0: 2873 656c 665b 7365 6c66 2e73 6571 7565  (self[self.seque
+0001f6e0: 6e63 655f 7374 6172 743a 7365 6c66 2e73  nce_start:self.s
+0001f6f0: 6571 7565 6e63 655f 7374 6f70 5d29 292e  equence_stop])).
+0001f700: 7374 7269 7028 275b 5d27 290a 2020 2020  strip('[]').    
+0001f710: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0001f720: 737a 5f73 6571 7565 6e63 655f 6469 6d20  sz_sequence_dim 
+0001f730: 3e20 303a 206f 7574 7075 7420 3d20 2873  > 0: output = (s
+0001f740: 6571 7565 6e63 652c 2920 2b20 6f75 7470  equence,) + outp
+0001f750: 7574 0a20 2020 2020 2020 2020 2020 2069  ut.            i
+0001f760: 6620 7365 6c66 2e73 7a5f 7365 7175 656e  f self.sz_sequen
+0001f770: 6365 5f64 696d 203c 2030 3a20 6f75 7470  ce_dim < 0: outp
+0001f780: 7574 203d 206f 7574 7075 7420 2b20 2873  ut = output + (s
+0001f790: 6571 7565 6e63 652c 290a 2020 2020 2020  equence,).      
+0001f7a0: 2020 6966 2073 656c 662e 6861 735f 6665    if self.has_fe
+0001f7b0: 6174 7572 653a 0a20 2020 2020 2020 2020  ature:.         
+0001f7c0: 2020 2066 6561 7475 7265 203d 206c 6973     feature = lis
+0001f7d0: 7428 7365 6c66 5b73 656c 662e 6665 6174  t(self[self.feat
+0001f7e0: 7572 655f 7374 6172 743a 2073 656c 662e  ure_start: self.
+0001f7f0: 6665 6174 7572 655f 7374 6f70 5d29 0a20  feature_stop]). 
+0001f800: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+0001f810: 6c66 2e73 7a5f 6665 6174 7572 655f 6469  lf.sz_feature_di
+0001f820: 6d20 3e20 303a 206f 7574 7075 7420 3d20  m > 0: output = 
+0001f830: 2866 6561 7475 7265 2c29 202b 206f 7574  (feature,) + out
+0001f840: 7075 740a 2020 2020 2020 2020 2020 2020  put.            
+0001f850: 6966 2073 656c 662e 737a 5f66 6561 7475  if self.sz_featu
+0001f860: 7265 5f64 696d 203c 2030 3a20 6f75 7470  re_dim < 0: outp
+0001f870: 7574 203d 206f 7574 7075 7420 2b20 2866  ut = output + (f
+0001f880: 6561 7475 7265 2c29 0a20 2020 2020 2020  eature,).       
+0001f890: 2069 6620 7365 6c66 2e68 6173 5f62 6174   if self.has_bat
+0001f8a0: 6368 3a0a 2020 2020 2020 2020 2020 2020  ch:.            
+0001f8b0: 6261 7463 6820 3d20 7b73 656c 662e 6e5f  batch = {self.n_
+0001f8c0: 6261 7463 687d 0a20 2020 2020 2020 2020  batch}.         
+0001f8d0: 2020 2069 6620 7365 6c66 2e73 7a5f 6261     if self.sz_ba
+0001f8e0: 7463 685f 6469 6d20 3e20 303a 206f 7574  tch_dim > 0: out
+0001f8f0: 7075 7420 3d20 2862 6174 6368 2c29 202b  put = (batch,) +
+0001f900: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
+0001f910: 2020 2020 6966 2073 656c 662e 737a 5f62      if self.sz_b
+0001f920: 6174 6368 5f64 696d 203c 2030 3a20 6f75  atch_dim < 0: ou
+0001f930: 7470 7574 203d 206f 7574 7075 7420 2b20  tput = output + 
+0001f940: 2862 6174 6368 2c29 0a20 2020 2020 2020  (batch,).       
+0001f950: 2069 6620 7365 6c66 2e68 6173 5f66 756e   if self.has_fun
+0001f960: 633a 0a20 2020 2020 2020 2020 2020 2066  c:.            f
+0001f970: 756e 6320 3d20 2873 656c 662e 6e5f 6675  unc = (self.n_fu
+0001f980: 6e63 2c29 0a20 2020 2020 2020 2020 2020  nc,).           
+0001f990: 2069 6620 7365 6c66 2e73 7a5f 6675 6e63   if self.sz_func
+0001f9a0: 5f64 696d 203e 2030 3a20 6f75 7470 7574  _dim > 0: output
+0001f9b0: 203d 2028 6675 6e63 2c29 202b 206f 7574   = (func,) + out
+0001f9c0: 7075 740a 2020 2020 2020 2020 2020 2020  put.            
+0001f9d0: 6966 2073 656c 662e 737a 5f66 756e 635f  if self.sz_func_
+0001f9e0: 6469 6d20 3c20 303a 206f 7574 7075 7420  dim < 0: output 
+0001f9f0: 3d20 6f75 7470 7574 202b 2028 6675 6e63  = output + (func
+0001fa00: 2c29 0a20 2020 2020 2020 2072 6574 7572  ,).        retur
+0001fa10: 6e20 6f75 7470 7574 0a0a 2020 2020 4061  n output..    @a
+0001fa20: 6c69 6173 2822 5f5f 7265 7072 5f5f 2229  lias("__repr__")
+0001fa30: 0a20 2020 2064 6566 205f 5f73 7472 5f5f  .    def __str__
+0001fa40: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0001fa50: 7265 7020 3d20 7365 6c66 2e70 7974 686f  rep = self.pytho
+0001fa60: 6e5f 7265 7072 0a20 2020 2020 2020 2072  n_repr.        r
+0001fa70: 6574 7572 6e20 6622 6261 746f 7263 682e  eturn f"batorch.
+0001fa80: 5369 7a65 7b72 6570 7d22 2e72 6570 6c61  Size{rep}".repla
+0001fa90: 6365 2827 2c29 272c 2027 2927 292e 7265  ce(',)', ')').re
+0001faa0: 706c 6163 6528 2745 6c6c 6970 7369 7327  place('Ellipsis'
+0001fab0: 2c20 272e 2e2e 2729 0a20 2020 200a 2020  , '...').    .  
+0001fac0: 2020 2323 206f 7065 7261 7469 6f6e 733a    ## operations:
+0001fad0: 0a20 2020 2064 6566 205f 5f67 6574 6974  .    def __getit
+0001fae0: 656d 5f5f 2873 656c 662c 206b 293a 0a20  em__(self, k):. 
+0001faf0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0001fb00: 616e 6365 286b 2c20 696e 745f 293a 2072  ance(k, int_): r
+0001fb10: 6574 7572 6e20 7375 7065 7228 292e 5f5f  eturn super().__
+0001fb20: 6765 7469 7465 6d5f 5f28 6b29 0a20 2020  getitem__(k).   
+0001fb30: 2020 2020 2061 766f 7563 6828 6973 696e       avouch(isin
+0001fb40: 7374 616e 6365 286b 2c20 736c 6963 6529  stance(k, slice)
+0001fb50: 2c20 5479 7065 4572 726f 7228 6622 536c  , TypeError(f"Sl
+0001fb60: 6963 696e 6720 6f66 2027 6274 2e53 697a  icing of 'bt.Siz
+0001fb70: 6527 206f 6e6c 7920 7461 6b65 7320 696e  e' only takes in
+0001fb80: 7465 6765 7273 206f 7220 736c 6963 6573  tegers or slices
+0001fb90: 2c20 6e6f 7420 7b6b 7d20 6f66 2074 7970  , not {k} of typ
+0001fba0: 6520 7b74 7970 6528 6b29 7d2e 2022 2929  e {type(k)}. "))
+0001fbb0: 0a20 2020 2020 2020 2073 2c20 6520 3d20  .        s, e = 
+0001fbc0: 6b2e 7374 6172 742c 206b 2e73 746f 700a  k.start, k.stop.
+0001fbd0: 2020 2020 2020 2020 6966 2073 2069 7320          if s is 
+0001fbe0: 4e6f 6e65 3a20 7320 3d20 300a 2020 2020  None: s = 0.    
+0001fbf0: 2020 2020 6966 2065 2069 7320 4e6f 6e65      if e is None
+0001fc00: 3a20 6520 3d20 7365 6c66 2e6e 5f64 696d  : e = self.n_dim
+0001fc10: 0a20 2020 2020 2020 2069 6620 7320 3c20  .        if s < 
+0001fc20: 303a 2073 202b 3d20 7365 6c66 2e6e 5f64  0: s += self.n_d
+0001fc30: 696d 0a20 2020 2020 2020 2069 6620 6520  im.        if e 
+0001fc40: 3c20 303a 2065 202b 3d20 7365 6c66 2e6e  < 0: e += self.n
+0001fc50: 5f64 696d 0a20 2020 2020 2020 2069 6620  _dim.        if 
+0001fc60: 7365 6c66 2e68 6173 5f66 756e 633a 0a20  self.has_func:. 
+0001fc70: 2020 2020 2020 2020 2020 2073 7a5f 6675             sz_fu
+0001fc80: 6e63 5f64 696d 203d 2073 656c 662e 737a  nc_dim = self.sz
+0001fc90: 5f66 756e 635f 6469 6d20 6966 2073 203c  _func_dim if s <
+0001fca0: 3d20 7365 6c66 2e66 756e 635f 6469 6d20  = self.func_dim 
+0001fcb0: 616e 6420 6520 3e20 7365 6c66 2e66 756e  and e > self.fun
+0001fcc0: 635f 6469 6d20 656c 7365 2028 6d61 785f  c_dim else (max_
+0001fcd0: 286d 696e 5f28 652c 2073 656c 662e 6675  (min_(e, self.fu
+0001fce0: 6e63 5f64 696d 202b 2031 2920 2d20 732c  nc_dim + 1) - s,
+0001fcf0: 2030 2920 6966 2073 203e 2073 656c 662e   0) if s > self.
+0001fd00: 6675 6e63 5f64 696d 2065 6c73 6520 6d69  func_dim else mi
+0001fd10: 6e5f 286d 6178 5f28 732c 2073 656c 662e  n_(max_(s, self.
+0001fd20: 6675 6e63 5f64 696d 2920 2d20 652c 2030  func_dim) - e, 0
+0001fd30: 2929 0a20 2020 2020 2020 2065 6c73 653a  )).        else:
+0001fd40: 2073 7a5f 6675 6e63 5f64 696d 203d 2030   sz_func_dim = 0
+0001fd50: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0001fd60: 2e68 6173 5f62 6174 6368 3a0a 2020 2020  .has_batch:.    
+0001fd70: 2020 2020 2020 2020 737a 5f62 6174 6368          sz_batch
+0001fd80: 5f64 696d 203d 2073 656c 662e 737a 5f62  _dim = self.sz_b
+0001fd90: 6174 6368 5f64 696d 2069 6620 7320 3c3d  atch_dim if s <=
+0001fda0: 2073 656c 662e 6261 7463 685f 6469 6d20   self.batch_dim 
+0001fdb0: 616e 6420 6520 3e20 7365 6c66 2e62 6174  and e > self.bat
+0001fdc0: 6368 5f64 696d 2065 6c73 6520 286d 6178  ch_dim else (max
+0001fdd0: 5f28 6d69 6e5f 2865 2c20 7365 6c66 2e62  _(min_(e, self.b
+0001fde0: 6174 6368 5f64 696d 202b 2031 2920 2d20  atch_dim + 1) - 
+0001fdf0: 732c 2030 2920 6966 2073 203e 2073 656c  s, 0) if s > sel
+0001fe00: 662e 6261 7463 685f 6469 6d20 656c 7365  f.batch_dim else
+0001fe10: 206d 696e 5f28 6d61 785f 2873 2c20 7365   min_(max_(s, se
+0001fe20: 6c66 2e62 6174 6368 5f64 696d 2920 2d20  lf.batch_dim) - 
+0001fe30: 652c 2030 2929 0a20 2020 2020 2020 2020  e, 0)).         
+0001fe40: 2020 2023 2073 7a5f 6261 7463 685f 6469     # sz_batch_di
+0001fe50: 6d20 3d20 7365 6c66 2e6e 6f6e 5f62 6174  m = self.non_bat
+0001fe60: 5f73 7461 7274 202d 2073 2069 6620 7320  _start - s if s 
+0001fe70: 3c20 7365 6c66 2e6e 6f6e 5f62 6174 5f73  < self.non_bat_s
+0001fe80: 7461 7274 2065 6c73 6520 2873 656c 662e  tart else (self.
+0001fe90: 6e6f 6e5f 6261 745f 7374 6f70 202d 2065  non_bat_stop - e
+0001fea0: 2069 6620 7365 6c66 2e6e 6f6e 5f62 6174   if self.non_bat
+0001feb0: 5f73 746f 7020 3c20 6520 656c 7365 2030  _stop < e else 0
+0001fec0: 290a 2020 2020 2020 2020 656c 7365 3a20  ).        else: 
+0001fed0: 737a 5f62 6174 6368 5f64 696d 203d 2030  sz_batch_dim = 0
+0001fee0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0001fef0: 2e68 6173 5f66 6561 7475 7265 3a0a 2020  .has_feature:.  
+0001ff00: 2020 2020 2020 2020 2020 737a 5f66 6561            sz_fea
+0001ff10: 7475 7265 5f64 696d 203d 2073 656c 662e  ture_dim = self.
+0001ff20: 737a 5f66 6561 7475 7265 5f64 696d 2069  sz_feature_dim i
+0001ff30: 6620 7320 3c3d 2073 656c 662e 6665 6174  f s <= self.feat
+0001ff40: 7572 655f 7374 6172 7420 616e 6420 6520  ure_start and e 
+0001ff50: 3e3d 2073 656c 662e 6665 6174 7572 655f  >= self.feature_
+0001ff60: 7374 6f70 2065 6c73 6520 286d 6178 5f28  stop else (max_(
+0001ff70: 6d69 6e5f 2865 2c20 7365 6c66 2e66 6561  min_(e, self.fea
+0001ff80: 7475 7265 5f73 746f 7029 202d 2073 2c20  ture_stop) - s, 
+0001ff90: 3029 2069 6620 7320 3e20 7365 6c66 2e66  0) if s > self.f
+0001ffa0: 6561 7475 7265 5f73 7461 7274 2065 6c73  eature_start els
+0001ffb0: 6520 6d69 6e5f 286d 6178 5f28 732c 2073  e min_(max_(s, s
+0001ffc0: 656c 662e 6665 6174 7572 655f 7374 6172  elf.feature_star
+0001ffd0: 7429 202d 2065 2c20 3029 290a 2020 2020  t) - e, 0)).    
+0001ffe0: 2020 2020 656c 7365 3a20 737a 5f66 6561      else: sz_fea
+0001fff0: 7475 7265 5f64 696d 203d 2030 0a20 2020  ture_dim = 0.   
+00020000: 2020 2020 2069 6620 7365 6c66 2e68 6173       if self.has
+00020010: 5f73 6571 7565 6e63 653a 0a20 2020 2020  _sequence:.     
+00020020: 2020 2020 2020 2073 7a5f 7365 7175 656e         sz_sequen
+00020030: 6365 5f64 696d 203d 2073 656c 662e 737a  ce_dim = self.sz
+00020040: 5f73 6571 7565 6e63 655f 6469 6d20 6966  _sequence_dim if
+00020050: 2073 203c 3d20 7365 6c66 2e73 6571 7565   s <= self.seque
+00020060: 6e63 655f 7374 6172 7420 616e 6420 6520  nce_start and e 
+00020070: 3e3d 2073 656c 662e 7365 7175 656e 6365  >= self.sequence
+00020080: 5f73 746f 7020 656c 7365 2028 6d61 785f  _stop else (max_
+00020090: 286d 696e 5f28 652c 2073 656c 662e 7365  (min_(e, self.se
+000200a0: 7175 656e 6365 5f73 746f 7029 202d 2073  quence_stop) - s
+000200b0: 2c20 3029 2069 6620 7320 3e20 7365 6c66  , 0) if s > self
+000200c0: 2e73 6571 7565 6e63 655f 7374 6172 7420  .sequence_start 
+000200d0: 656c 7365 206d 696e 5f28 6d61 785f 2873  else min_(max_(s
+000200e0: 2c20 7365 6c66 2e73 6571 7565 6e63 655f  , self.sequence_
+000200f0: 7374 6172 7429 202d 2065 2c20 3029 290a  start) - e, 0)).
+00020100: 2020 2020 2020 2020 656c 7365 3a20 737a          else: sz
+00020110: 5f73 6571 7565 6e63 655f 6469 6d20 3d20  _sequence_dim = 
+00020120: 300a 2020 2020 2020 2020 7265 7475 726e  0.        return
+00020130: 2073 656c 662e 5f5f 636c 6173 735f 5f2e   self.__class__.
+00020140: 5f5f 6e65 775f 7261 775f 5f28 7375 7065  __new_raw__(supe
+00020150: 7228 292e 5f5f 6765 7469 7465 6d5f 5f28  r().__getitem__(
+00020160: 6b29 2c20 737a 5f66 756e 635f 6469 6d3d  k), sz_func_dim=
+00020170: 737a 5f66 756e 635f 6469 6d2c 2073 7a5f  sz_func_dim, sz_
+00020180: 6261 7463 685f 6469 6d3d 737a 5f62 6174  batch_dim=sz_bat
+00020190: 6368 5f64 696d 2c20 737a 5f66 6561 7475  ch_dim, sz_featu
+000201a0: 7265 5f64 696d 3d73 7a5f 6665 6174 7572  re_dim=sz_featur
+000201b0: 655f 6469 6d2c 2073 7a5f 7365 7175 656e  e_dim, sz_sequen
+000201c0: 6365 5f64 696d 3d73 7a5f 7365 7175 656e  ce_dim=sz_sequen
+000201d0: 6365 5f64 696d 290a 2020 2020 0a20 2020  ce_dim).    .   
+000201e0: 2040 616c 6961 7328 275f 5f69 6164 645f   @alias('__iadd_
+000201f0: 5f27 290a 2020 2020 6465 6620 5f5f 6164  _').    def __ad
+00020200: 645f 5f28 7365 6c66 2c20 6f74 6865 7229  d__(self, other)
+00020210: 3a0a 2020 2020 2020 2020 6176 6f75 6368  :.        avouch
+00020220: 2869 7369 6e73 7461 6e63 6528 6f74 6865  (isinstance(othe
+00020230: 722c 2074 7570 6c65 292c 2054 7970 6545  r, tuple), TypeE
+00020240: 7272 6f72 2822 5375 6d6d 6174 696f 6e20  rror("Summation 
+00020250: 666f 7220 2762 742e 5369 7a65 2720 6973  for 'bt.Size' is
+00020260: 2069 6e68 6572 6974 6564 2066 726f 6d20   inherited from 
+00020270: 7079 7468 6f6e 206f 626a 6563 7420 2774  python object 't
+00020280: 7570 6c65 2720 746f 2070 6572 666f 726d  uple' to perform
+00020290: 2063 6f6e 6361 7465 6e61 7469 6f6e 2c20   concatenation, 
+000202a0: 706c 6561 7365 2075 7365 2060 7369 7a65  please use `size
+000202b0: 203c 3c28 3e3e 2920 3260 2074 6f20 7065   <<(>>) 2` to pe
+000202c0: 7266 6f72 6d20 656c 656d 656e 742d 7769  rform element-wi
+000202d0: 7365 2073 756d 6d61 7469 6f6e 2028 7375  se summation (su
+000202e0: 6274 7261 6374 696f 6e29 2074 6f20 696e  btraction) to in
+000202f0: 6372 6561 7365 2028 6465 6372 6561 7365  crease (decrease
+00020300: 2920 7468 6520 7369 7a65 2e20 2229 290a  ) the size. ")).
+00020310: 2020 2020 2020 2020 6966 206c 656e 286f          if len(o
+00020320: 7468 6572 2920 3d3d 2030 3a20 7265 7475  ther) == 0: retu
+00020330: 726e 2073 656c 660a 2020 2020 2020 2020  rn self.        
+00020340: 6966 206c 656e 2873 656c 6629 203d 3d20  if len(self) == 
+00020350: 303a 2072 6574 7572 6e20 6f74 6865 720a  0: return other.
+00020360: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
+00020370: 7369 6e73 7461 6e63 6528 6f74 6865 722c  sinstance(other,
+00020380: 2053 697a 6529 3a20 6f74 6865 7220 3d20   Size): other = 
+00020390: 7365 6c66 2e5f 5f63 6c61 7373 5f5f 2e5f  self.__class__._
+000203a0: 5f6e 6577 5f72 6177 5f5f 286f 7468 6572  _new_raw__(other
+000203b0: 290a 2020 2020 2020 2020 2320 4465 616c  ).        # Deal
+000203c0: 2077 6974 6820 7468 6520 6675 6e63 2064   with the func d
+000203d0: 696d 656e 7369 6f6e 0a20 2020 2020 2020  imension.       
+000203e0: 2069 6620 7365 6c66 2e73 7a5f 6675 6e63   if self.sz_func
+000203f0: 5f64 696d 203d 3d20 303a 0a20 2020 2020  _dim == 0:.     
+00020400: 2020 2020 2020 2069 6620 6f74 6865 722e         if other.
+00020410: 737a 5f66 756e 635f 6469 6d20 3c3d 2030  sz_func_dim <= 0
+00020420: 206f 7220 6f74 6865 722e 6e5f 6675 6e63   or other.n_func
+00020430: 5f64 696d 203d 3d20 6f74 6865 722e 6e5f  _dim == other.n_
+00020440: 6469 6d3a 2073 7a5f 6675 6e63 5f64 696d  dim: sz_func_dim
+00020450: 203d 202d 6f74 6865 722e 6e5f 6675 6e63   = -other.n_func
+00020460: 5f64 696d 0a20 2020 2020 2020 2020 2020  _dim.           
+00020470: 2065 6c69 6620 7365 6c66 2e6e 5f64 696d   elif self.n_dim
+00020480: 203d 3d20 303a 2073 7a5f 6675 6e63 5f64   == 0: sz_func_d
+00020490: 696d 203d 206f 7468 6572 2e6e 5f66 756e  im = other.n_fun
+000204a0: 635f 6469 6d0a 2020 2020 2020 2020 2020  c_dim.          
+000204b0: 2020 656c 7365 3a20 7261 6973 6520 5479    else: raise Ty
+000204c0: 7065 4572 726f 7228 6622 4572 726f 7220  peError(f"Error 
+000204d0: 696e 2063 6f6e 6361 7465 6e61 7469 6e67  in concatenating
+000204e0: 207b 7365 6c66 7d20 616e 6420 7b6f 7468   {self} and {oth
+000204f0: 6572 7d3a 2066 756e 6374 696f 6e61 6c20  er}: functional 
+00020500: 6469 6d65 6e73 696f 6e20 696e 206d 6964  dimension in mid
+00020510: 646c 652e 2022 290a 2020 2020 2020 2020  dle. ").        
+00020520: 656c 6966 206f 7468 6572 2e73 7a5f 6675  elif other.sz_fu
+00020530: 6e63 5f64 696d 203d 3d20 303a 0a20 2020  nc_dim == 0:.   
+00020540: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00020550: 2e73 7a5f 6675 6e63 5f64 696d 203e 3d20  .sz_func_dim >= 
+00020560: 3020 6f72 2073 656c 662e 6e5f 6675 6e63  0 or self.n_func
+00020570: 5f64 696d 203d 3d20 7365 6c66 2e6e 5f64  _dim == self.n_d
+00020580: 696d 3a20 737a 5f66 756e 635f 6469 6d20  im: sz_func_dim 
+00020590: 3d20 7365 6c66 2e6e 5f66 756e 635f 6469  = self.n_func_di
+000205a0: 6d0a 2020 2020 2020 2020 2020 2020 656c  m.            el
+000205b0: 6966 206f 7468 6572 2e6e 5f64 696d 203d  if other.n_dim =
+000205c0: 3d20 303a 2073 7a5f 6675 6e63 5f64 696d  = 0: sz_func_dim
+000205d0: 203d 2073 656c 662e 737a 5f66 756e 635f   = self.sz_func_
+000205e0: 6469 6d0a 2020 2020 2020 2020 2020 2020  dim.            
+000205f0: 656c 7365 3a20 7261 6973 6520 5479 7065  else: raise Type
+00020600: 4572 726f 7228 6622 4572 726f 7220 696e  Error(f"Error in
+00020610: 2063 6f6e 6361 7465 6e61 7469 6e67 207b   concatenating {
+00020620: 7365 6c66 7d20 616e 6420 7b6f 7468 6572  self} and {other
+00020630: 7d3a 2066 756e 6374 696f 6e61 6c20 6469  }: functional di
+00020640: 6d65 6e73 696f 6e20 696e 206d 6964 646c  mension in middl
+00020650: 652e 2022 290a 2020 2020 2020 2020 656c  e. ").        el
+00020660: 7365 3a20 7261 6973 6520 5479 7065 4572  se: raise TypeEr
+00020670: 726f 7228 6622 4572 726f 7220 696e 2063  ror(f"Error in c
+00020680: 6f6e 6361 7465 6e61 7469 6e67 207b 7365  oncatenating {se
+00020690: 6c66 7d20 616e 6420 7b6f 7468 6572 7d3a  lf} and {other}:
+000206a0: 2063 6f6e 666c 6963 7420 696e 2066 756e   conflict in fun
+000206b0: 6374 696f 6e61 6c20 6469 6d65 6e73 696f  ctional dimensio
+000206c0: 6e2e 2022 290a 2020 2020 2020 2020 2320  n. ").        # 
+000206d0: 4465 616c 2077 6974 6820 7468 6520 6261  Deal with the ba
+000206e0: 7463 6820 6469 6d65 6e73 696f 6e0a 2020  tch dimension.  
+000206f0: 2020 2020 2020 6966 2073 656c 662e 737a        if self.sz
+00020700: 5f62 6174 6368 5f64 696d 203d 3d20 303a  _batch_dim == 0:
+00020710: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00020720: 6f74 6865 722e 737a 5f62 6174 6368 5f64  other.sz_batch_d
+00020730: 696d 203c 3d20 3020 6f72 206f 7468 6572  im <= 0 or other
+00020740: 2e6e 5f62 6174 6368 5f64 696d 203d 3d20  .n_batch_dim == 
+00020750: 6f74 6865 722e 6e5f 6469 6d20 2d20 6f74  other.n_dim - ot
+00020760: 6865 722e 6e5f 6675 6e63 5f64 696d 3a20  her.n_func_dim: 
+00020770: 737a 5f62 6174 6368 5f64 696d 203d 202d  sz_batch_dim = -
+00020780: 6f74 6865 722e 6e5f 6261 7463 685f 6469  other.n_batch_di
+00020790: 6d0a 2020 2020 2020 2020 2020 2020 656c  m.            el
+000207a0: 6966 2073 656c 662e 6e5f 6469 6d20 2d20  if self.n_dim - 
+000207b0: 7365 6c66 2e6e 5f66 756e 635f 6469 6d20  self.n_func_dim 
+000207c0: 3d3d 2030 3a20 737a 5f62 6174 6368 5f64  == 0: sz_batch_d
+000207d0: 696d 203d 206f 7468 6572 2e6e 5f62 6174  im = other.n_bat
+000207e0: 6368 5f64 696d 0a20 2020 2020 2020 2020  ch_dim.         
+000207f0: 2020 2065 6c73 653a 2072 6169 7365 2054     else: raise T
+00020800: 7970 6545 7272 6f72 2866 2245 7272 6f72  ypeError(f"Error
+00020810: 2069 6e20 636f 6e63 6174 656e 6174 696e   in concatenatin
+00020820: 6720 7b73 656c 667d 2061 6e64 207b 6f74  g {self} and {ot
+00020830: 6865 727d 3a20 6261 7463 6820 6469 6d65  her}: batch dime
+00020840: 6e73 696f 6e20 696e 206d 6964 646c 652e  nsion in middle.
+00020850: 2022 290a 2020 2020 2020 2020 656c 6966   ").        elif
+00020860: 206f 7468 6572 2e73 7a5f 6261 7463 685f   other.sz_batch_
+00020870: 6469 6d20 3d3d 2030 3a0a 2020 2020 2020  dim == 0:.      
+00020880: 2020 2020 2020 6966 2073 656c 662e 737a        if self.sz
+00020890: 5f62 6174 6368 5f64 696d 203e 3d20 3020  _batch_dim >= 0 
+000208a0: 6f72 2073 656c 662e 6e5f 6261 7463 685f  or self.n_batch_
+000208b0: 6469 6d20 3d3d 2073 656c 662e 6e5f 6469  dim == self.n_di
+000208c0: 6d20 2d20 7365 6c66 2e6e 5f66 756e 635f  m - self.n_func_
+000208d0: 6469 6d3a 2073 7a5f 6261 7463 685f 6469  dim: sz_batch_di
+000208e0: 6d20 3d20 7365 6c66 2e6e 5f62 6174 6368  m = self.n_batch
+000208f0: 5f64 696d 0a20 2020 2020 2020 2020 2020  _dim.           
+00020900: 2065 6c69 6620 6f74 6865 722e 6e5f 6469   elif other.n_di
+00020910: 6d20 2d20 6f74 6865 722e 6e5f 6675 6e63  m - other.n_func
+00020920: 5f64 696d 203d 3d20 303a 2073 7a5f 6261  _dim == 0: sz_ba
+00020930: 7463 685f 6469 6d20 3d20 7365 6c66 2e73  tch_dim = self.s
+00020940: 7a5f 6261 7463 685f 6469 6d0a 2020 2020  z_batch_dim.    
+00020950: 2020 2020 2020 2020 656c 7365 3a20 7261          else: ra
+00020960: 6973 6520 5479 7065 4572 726f 7228 6622  ise TypeError(f"
+00020970: 4572 726f 7220 696e 2063 6f6e 6361 7465  Error in concate
+00020980: 6e61 7469 6e67 207b 7365 6c66 7d20 616e  nating {self} an
+00020990: 6420 7b6f 7468 6572 7d3a 2062 6174 6368  d {other}: batch
+000209a0: 2064 696d 656e 7369 6f6e 2069 6e20 6d69   dimension in mi
+000209b0: 6464 6c65 2e20 2229 0a20 2020 2020 2020  ddle. ").       
+000209c0: 2065 6c73 653a 2072 6169 7365 2054 7970   else: raise Typ
+000209d0: 6545 7272 6f72 2866 2245 7272 6f72 2069  eError(f"Error i
+000209e0: 6e20 636f 6e63 6174 656e 6174 696e 6720  n concatenating 
+000209f0: 7b73 656c 667d 2061 6e64 207b 6f74 6865  {self} and {othe
+00020a00: 727d 3a20 636f 6e66 6c69 6374 2069 6e20  r}: conflict in 
+00020a10: 6261 7463 6820 6469 6d65 6e73 696f 6e2e  batch dimension.
+00020a20: 2022 290a 2020 2020 2020 2020 2320 4465   ").        # De
+00020a30: 616c 2077 6974 6820 7468 6520 6665 6174  al with the feat
+00020a40: 7572 6520 6469 6d65 6e73 696f 6e73 0a20  ure dimensions. 
+00020a50: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+00020a60: 7a5f 6665 6174 7572 655f 6469 6d20 3d3d  z_feature_dim ==
+00020a70: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00020a80: 6966 206f 7468 6572 2e73 7a5f 6665 6174  if other.sz_feat
+00020a90: 7572 655f 6469 6d20 3c3d 2030 206f 7220  ure_dim <= 0 or 
+00020aa0: 6f74 6865 722e 6e5f 6665 6174 7572 655f  other.n_feature_
+00020ab0: 6469 6d20 3d3d 206f 7468 6572 2e6e 5f64  dim == other.n_d
+00020ac0: 696d 202d 206f 7468 6572 2e6e 5f66 756e  im - other.n_fun
+00020ad0: 635f 6469 6d20 2d20 6f74 6865 722e 6e5f  c_dim - other.n_
+00020ae0: 6261 7463 685f 6469 6d3a 2073 7a5f 6665  batch_dim: sz_fe
+00020af0: 6174 7572 655f 6469 6d20 3d20 2d6f 7468  ature_dim = -oth
+00020b00: 6572 2e6e 5f66 6561 7475 7265 5f64 696d  er.n_feature_dim
+00020b10: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00020b20: 6620 7365 6c66 2e6e 5f73 6571 7565 6e63  f self.n_sequenc
+00020b30: 655f 6469 6d20 2b20 7365 6c66 2e6e 5f73  e_dim + self.n_s
+00020b40: 7061 6365 5f64 696d 203d 3d20 303a 2073  pace_dim == 0: s
+00020b50: 7a5f 6665 6174 7572 655f 6469 6d20 3d20  z_feature_dim = 
+00020b60: 6f74 6865 722e 737a 5f66 6561 7475 7265  other.sz_feature
+00020b70: 5f64 696d 0a20 2020 2020 2020 2020 2020  _dim.           
+00020b80: 2065 6c73 653a 2072 6169 7365 2054 7970   else: raise Typ
+00020b90: 6545 7272 6f72 2866 2245 7272 6f72 2069  eError(f"Error i
+00020ba0: 6e20 636f 6e63 6174 656e 6174 696e 6720  n concatenating 
+00020bb0: 7b73 656c 667d 2061 6e64 207b 6f74 6865  {self} and {othe
+00020bc0: 727d 3a20 6665 6174 7572 6520 6469 6d65  r}: feature dime
+00020bd0: 6e73 696f 6e73 2069 6e20 6d69 6464 6c65  nsions in middle
+00020be0: 2e20 2229 0a20 2020 2020 2020 2065 6c69  . ").        eli
+00020bf0: 6620 6f74 6865 722e 737a 5f66 6561 7475  f other.sz_featu
+00020c00: 7265 5f64 696d 203d 3d20 303a 0a20 2020  re_dim == 0:.   
+00020c10: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00020c20: 2e73 7a5f 6665 6174 7572 655f 6469 6d20  .sz_feature_dim 
+00020c30: 3e3d 2030 206f 7220 7365 6c66 2e6e 5f66  >= 0 or self.n_f
+00020c40: 6561 7475 7265 5f64 696d 203d 3d20 7365  eature_dim == se
+00020c50: 6c66 2e6e 5f64 696d 202d 2073 656c 662e  lf.n_dim - self.
+00020c60: 6e5f 6675 6e63 5f64 696d 202d 2073 656c  n_func_dim - sel
+00020c70: 662e 6e5f 6261 7463 685f 6469 6d3a 2073  f.n_batch_dim: s
+00020c80: 7a5f 6665 6174 7572 655f 6469 6d20 3d20  z_feature_dim = 
+00020c90: 7365 6c66 2e6e 5f66 6561 7475 7265 5f64  self.n_feature_d
+00020ca0: 696d 0a20 2020 2020 2020 2020 2020 2065  im.            e
+00020cb0: 6c69 6620 6f74 6865 722e 6e5f 7365 7175  lif other.n_sequ
+00020cc0: 656e 6365 5f64 696d 202b 206f 7468 6572  ence_dim + other
+00020cd0: 2e6e 5f73 7061 6365 5f64 696d 203d 3d20  .n_space_dim == 
+00020ce0: 303a 2073 7a5f 6665 6174 7572 655f 6469  0: sz_feature_di
+00020cf0: 6d20 3d20 7365 6c66 2e73 7a5f 6665 6174  m = self.sz_feat
+00020d00: 7572 655f 6469 6d0a 2020 2020 2020 2020  ure_dim.        
+00020d10: 2020 2020 656c 7365 3a20 7261 6973 6520      else: raise 
+00020d20: 5479 7065 4572 726f 7228 6622 4572 726f  TypeError(f"Erro
+00020d30: 7220 696e 2063 6f6e 6361 7465 6e61 7469  r in concatenati
+00020d40: 6e67 207b 7365 6c66 7d20 616e 6420 7b6f  ng {self} and {o
+00020d50: 7468 6572 7d3a 2066 6561 7475 7265 2064  ther}: feature d
+00020d60: 696d 656e 7369 6f6e 7320 696e 206d 6964  imensions in mid
+00020d70: 646c 652e 2022 290a 2020 2020 2020 2020  dle. ").        
+00020d80: 656c 6966 2073 656c 662e 737a 5f66 756e  elif self.sz_fun
+00020d90: 635f 6469 6d20 3e3d 2030 2061 6e64 2073  c_dim >= 0 and s
+00020da0: 656c 662e 737a 5f62 6174 6368 5f64 696d  elf.sz_batch_dim
+00020db0: 203e 3d20 3020 616e 6420 2873 656c 662e   >= 0 and (self.
+00020dc0: 737a 5f66 6561 7475 7265 5f64 696d 203c  sz_feature_dim <
+00020dd0: 2030 206f 7220 7365 6c66 2e6e 5f66 756e   0 or self.n_fun
+00020de0: 635f 6469 6d20 2b20 7365 6c66 2e6e 5f62  c_dim + self.n_b
+00020df0: 6174 6368 5f64 696d 202b 2073 656c 662e  atch_dim + self.
+00020e00: 6e5f 6665 6174 7572 655f 6469 6d20 3d3d  n_feature_dim ==
+00020e10: 2073 656c 662e 6e5f 6469 6d29 2061 6e64   self.n_dim) and
+00020e20: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
+00020e30: 6f74 6865 722e 737a 5f66 756e 635f 6469  other.sz_func_di
+00020e40: 6d20 3c3d 2030 2061 6e64 206f 7468 6572  m <= 0 and other
+00020e50: 2e73 7a5f 6261 7463 685f 6469 6d20 3c3d  .sz_batch_dim <=
+00020e60: 2030 2061 6e64 2028 6f74 6865 722e 737a   0 and (other.sz
+00020e70: 5f66 6561 7475 7265 5f64 696d 203e 2030  _feature_dim > 0
+00020e80: 206f 7220 6f74 6865 722e 6e5f 6675 6e63   or other.n_func
+00020e90: 5f64 696d 202b 206f 7468 6572 2e6e 5f62  _dim + other.n_b
+00020ea0: 6174 6368 5f64 696d 202b 206f 7468 6572  atch_dim + other
+00020eb0: 2e6e 5f66 6561 7475 7265 5f64 696d 203d  .n_feature_dim =
+00020ec0: 3d20 6f74 6865 722e 6e5f 6469 6d29 3a0a  = other.n_dim):.
+00020ed0: 2020 2020 2020 2020 2020 2020 737a 5f66              sz_f
+00020ee0: 6561 7475 7265 5f64 696d 203d 205b 2d31  eature_dim = [-1
+00020ef0: 2c20 315d 5b73 656c 662e 6665 6174 7572  , 1][self.featur
+00020f00: 655f 7374 6172 7420 3d3d 2073 656c 662e  e_start == self.
+00020f10: 6e6f 6e5f 6261 745f 7374 6172 745d 202a  non_bat_start] *
+00020f20: 2028 7365 6c66 2e6e 5f66 6561 7475 7265   (self.n_feature
+00020f30: 5f64 696d 202b 206f 7468 6572 2e6e 5f66  _dim + other.n_f
+00020f40: 6561 7475 7265 5f64 696d 290a 2020 2020  eature_dim).    
+00020f50: 2020 2020 2320 656c 6966 206f 7468 6572      # elif other
+00020f60: 2e6e 5f66 6561 7475 7265 5f64 696d 203d  .n_feature_dim =
+00020f70: 3d20 6f74 6865 722e 6e5f 6469 6d20 616e  = other.n_dim an
+00020f80: 6420 7365 6c66 2e73 7a5f 6665 6174 7572  d self.sz_featur
+00020f90: 655f 6469 6d20 3c20 303a 0a20 2020 2020  e_dim < 0:.     
+00020fa0: 2020 2023 2020 2020 2073 7a5f 6665 6174     #     sz_feat
+00020fb0: 7572 655f 6469 6d20 3d20 7365 6c66 2e73  ure_dim = self.s
+00020fc0: 7a5f 6665 6174 7572 655f 6469 6d20 2d20  z_feature_dim - 
+00020fd0: 6f74 6865 722e 6e5f 6469 6d0a 2020 2020  other.n_dim.    
+00020fe0: 2020 2020 2320 656c 6966 2073 656c 662e      # elif self.
+00020ff0: 6e5f 6665 6174 7572 655f 6469 6d20 3d3d  n_feature_dim ==
+00021000: 2073 656c 662e 6e5f 6469 6d20 616e 6420   self.n_dim and 
+00021010: 6f74 6865 722e 737a 5f66 6561 7475 7265  other.sz_feature
+00021020: 5f64 696d 203e 2030 3a0a 2020 2020 2020  _dim > 0:.      
+00021030: 2020 2320 2020 2020 737a 5f66 6561 7475    #     sz_featu
+00021040: 7265 5f64 696d 203d 206f 7468 6572 2e73  re_dim = other.s
+00021050: 7a5f 6665 6174 7572 655f 6469 6d20 2b20  z_feature_dim + 
+00021060: 7365 6c66 2e6e 5f64 696d 0a20 2020 2020  self.n_dim.     
+00021070: 2020 2065 6c73 653a 2072 6169 7365 2054     else: raise T
+00021080: 7970 6545 7272 6f72 2866 2245 7272 6f72  ypeError(f"Error
+00021090: 2069 6e20 636f 6e63 6174 656e 6174 696e   in concatenatin
+000210a0: 6720 7b73 656c 667d 2061 6e64 207b 6f74  g {self} and {ot
+000210b0: 6865 727d 3a20 6d75 6c74 6970 6c65 2073  her}: multiple s
+000210c0: 6574 7320 6f66 2066 6561 7475 7265 2064  ets of feature d
+000210d0: 696d 656e 7369 6f6e 732e 2022 290a 2020  imensions. ").  
+000210e0: 2020 2020 2020 2320 4465 616c 2077 6974        # Deal wit
+000210f0: 6820 7468 6520 7365 7175 656e 6365 2064  h the sequence d
+00021100: 696d 656e 7369 6f6e 730a 2020 2020 2020  imensions.      
+00021110: 2020 6966 2073 656c 662e 737a 5f73 6571    if self.sz_seq
+00021120: 7565 6e63 655f 6469 6d20 3d3d 2030 3a0a  uence_dim == 0:.
+00021130: 2020 2020 2020 2020 2020 2020 6966 206f              if o
+00021140: 7468 6572 2e73 7a5f 7365 7175 656e 6365  ther.sz_sequence
+00021150: 5f64 696d 203c 3d20 3020 6f72 206f 7468  _dim <= 0 or oth
+00021160: 6572 2e6e 5f73 6571 7565 6e63 655f 6469  er.n_sequence_di
+00021170: 6d20 3d3d 206f 7468 6572 2e6e 5f64 696d  m == other.n_dim
+00021180: 202d 206f 7468 6572 2e6e 5f66 756e 635f   - other.n_func_
+00021190: 6469 6d20 2d20 6f74 6865 722e 6e5f 6261  dim - other.n_ba
+000211a0: 7463 685f 6469 6d20 2d20 6f74 6865 722e  tch_dim - other.
+000211b0: 6e5f 6665 6174 7572 655f 6469 6d3a 2073  n_feature_dim: s
+000211c0: 7a5f 7365 7175 656e 6365 5f64 696d 203d  z_sequence_dim =
+000211d0: 202d 6f74 6865 722e 6e5f 7365 7175 656e   -other.n_sequen
+000211e0: 6365 5f64 696d 0a20 2020 2020 2020 2020  ce_dim.         
+000211f0: 2020 2065 6c69 6620 7365 6c66 2e6e 5f73     elif self.n_s
+00021200: 7061 6365 5f64 696d 203d 3d20 303a 2073  pace_dim == 0: s
+00021210: 7a5f 7365 7175 656e 6365 5f64 696d 203d  z_sequence_dim =
+00021220: 206f 7468 6572 2e73 7a5f 7365 7175 656e   other.sz_sequen
+00021230: 6365 5f64 696d 0a20 2020 2020 2020 2020  ce_dim.         
+00021240: 2020 2065 6c73 653a 2072 6169 7365 2054     else: raise T
+00021250: 7970 6545 7272 6f72 2866 2245 7272 6f72  ypeError(f"Error
+00021260: 2069 6e20 636f 6e63 6174 656e 6174 696e   in concatenatin
+00021270: 6720 7b73 656c 667d 2061 6e64 207b 6f74  g {self} and {ot
+00021280: 6865 727d 3a20 7365 7175 656e 6365 2064  her}: sequence d
+00021290: 696d 656e 7369 6f6e 7320 696e 206d 6964  imensions in mid
+000212a0: 646c 652e 2022 290a 2020 2020 2020 2020  dle. ").        
+000212b0: 656c 6966 206f 7468 6572 2e73 7a5f 7365  elif other.sz_se
+000212c0: 7175 656e 6365 5f64 696d 203d 3d20 303a  quence_dim == 0:
+000212d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000212e0: 7365 6c66 2e73 7a5f 7365 7175 656e 6365  self.sz_sequence
+000212f0: 5f64 696d 203e 3d20 3020 6f72 2073 656c  _dim >= 0 or sel
+00021300: 662e 6e5f 7365 7175 656e 6365 5f64 696d  f.n_sequence_dim
+00021310: 203d 3d20 7365 6c66 2e6e 5f64 696d 202d   == self.n_dim -
+00021320: 2073 656c 662e 6e5f 6675 6e63 5f64 696d   self.n_func_dim
+00021330: 202d 2073 656c 662e 6e5f 6261 7463 685f   - self.n_batch_
+00021340: 6469 6d20 2d20 7365 6c66 2e6e 5f66 6561  dim - self.n_fea
+00021350: 7475 7265 5f64 696d 3a20 737a 5f73 6571  ture_dim: sz_seq
+00021360: 7565 6e63 655f 6469 6d20 3d20 7365 6c66  uence_dim = self
+00021370: 2e6e 5f73 6571 7565 6e63 655f 6469 6d0a  .n_sequence_dim.
+00021380: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00021390: 206f 7468 6572 2e6e 5f73 7061 6365 5f64   other.n_space_d
+000213a0: 696d 203d 3d20 303a 2073 7a5f 7365 7175  im == 0: sz_sequ
+000213b0: 656e 6365 5f64 696d 203d 2073 656c 662e  ence_dim = self.
+000213c0: 737a 5f73 6571 7565 6e63 655f 6469 6d0a  sz_sequence_dim.
+000213d0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000213e0: 3a20 7261 6973 6520 5479 7065 4572 726f  : raise TypeErro
+000213f0: 7228 6622 4572 726f 7220 696e 2063 6f6e  r(f"Error in con
+00021400: 6361 7465 6e61 7469 6e67 207b 7365 6c66  catenating {self
+00021410: 7d20 616e 6420 7b6f 7468 6572 7d3a 2073  } and {other}: s
+00021420: 6571 7565 6e63 6520 6469 6d65 6e73 696f  equence dimensio
+00021430: 6e73 2069 6e20 6d69 6464 6c65 2e20 2229  ns in middle. ")
+00021440: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
+00021450: 6c66 2e73 7a5f 6675 6e63 5f64 696d 203e  lf.sz_func_dim >
+00021460: 3d20 3020 616e 6420 7365 6c66 2e73 7a5f  = 0 and self.sz_
+00021470: 6261 7463 685f 6469 6d20 3e3d 2030 2061  batch_dim >= 0 a
+00021480: 6e64 2073 656c 662e 737a 5f66 6561 7475  nd self.sz_featu
+00021490: 7265 5f64 696d 203e 3d20 3020 616e 6420  re_dim >= 0 and 
+000214a0: 2873 656c 662e 737a 5f73 6571 7565 6e63  (self.sz_sequenc
+000214b0: 655f 6469 6d20 3c20 3020 6f72 2073 656c  e_dim < 0 or sel
+000214c0: 662e 6e5f 7370 6163 655f 6469 6d20 3d3d  f.n_space_dim ==
+000214d0: 2030 2920 616e 6420 5c0a 2020 2020 2020   0) and \.      
+000214e0: 2020 2020 2020 206f 7468 6572 2e73 7a5f         other.sz_
+000214f0: 6675 6e63 5f64 696d 203c 3d20 3020 616e  func_dim <= 0 an
+00021500: 6420 6f74 6865 722e 737a 5f62 6174 6368  d other.sz_batch
+00021510: 5f64 696d 203c 3d20 3020 616e 6420 6f74  _dim <= 0 and ot
+00021520: 6865 722e 737a 5f66 6561 7475 7265 5f64  her.sz_feature_d
+00021530: 696d 203c 3d20 3020 616e 6420 286f 7468  im <= 0 and (oth
+00021540: 6572 2e73 7a5f 7365 7175 656e 6365 5f64  er.sz_sequence_d
+00021550: 696d 203e 2030 206f 7220 6f74 6865 722e  im > 0 or other.
+00021560: 6e5f 7370 6163 655f 6469 6d20 3d3d 2030  n_space_dim == 0
+00021570: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00021580: 7a5f 7365 7175 656e 6365 5f64 696d 203d  z_sequence_dim =
+00021590: 205b 2d31 2c20 315d 5b73 656c 662e 7365   [-1, 1][self.se
+000215a0: 7175 656e 6365 5f73 7461 7274 203d 3d20  quence_start == 
+000215b0: 7365 6c66 2e73 6571 5f73 7063 5f73 7461  self.seq_spc_sta
+000215c0: 7274 5d20 2a20 2873 656c 662e 6e5f 7365  rt] * (self.n_se
+000215d0: 7175 656e 6365 5f64 696d 202b 206f 7468  quence_dim + oth
+000215e0: 6572 2e6e 5f73 6571 7565 6e63 655f 6469  er.n_sequence_di
+000215f0: 6d29 0a20 2020 2020 2020 2023 2065 6c69  m).        # eli
+00021600: 6620 6f74 6865 722e 6e5f 7365 7175 656e  f other.n_sequen
+00021610: 6365 5f64 696d 203d 3d20 6f74 6865 722e  ce_dim == other.
+00021620: 6e5f 6469 6d20 616e 6420 7365 6c66 2e73  n_dim and self.s
+00021630: 7a5f 7365 7175 656e 6365 5f64 696d 203c  z_sequence_dim <
+00021640: 2030 3a0a 2020 2020 2020 2020 2320 2020   0:.        #   
+00021650: 2020 737a 5f73 6571 7565 6e63 655f 6469    sz_sequence_di
+00021660: 6d20 3d20 7365 6c66 2e73 7a5f 7365 7175  m = self.sz_sequ
+00021670: 656e 6365 5f64 696d 202d 206f 7468 6572  ence_dim - other
+00021680: 2e6e 5f64 696d 0a20 2020 2020 2020 2023  .n_dim.        #
+00021690: 2065 6c69 6620 7365 6c66 2e6e 5f73 6571   elif self.n_seq
+000216a0: 7565 6e63 655f 6469 6d20 3d3d 2073 656c  uence_dim == sel
+000216b0: 662e 6e5f 6469 6d20 616e 6420 6f74 6865  f.n_dim and othe
+000216c0: 722e 737a 5f73 6571 7565 6e63 655f 6469  r.sz_sequence_di
+000216d0: 6d20 3e20 303a 0a20 2020 2020 2020 2023  m > 0:.        #
+000216e0: 2020 2020 2073 7a5f 7365 7175 656e 6365       sz_sequence
+000216f0: 5f64 696d 203d 206f 7468 6572 2e73 7a5f  _dim = other.sz_
+00021700: 7365 7175 656e 6365 5f64 696d 202b 2073  sequence_dim + s
+00021710: 656c 662e 6e5f 6469 6d0a 2020 2020 2020  elf.n_dim.      
+00021720: 2020 656c 7365 3a20 7261 6973 6520 5479    else: raise Ty
+00021730: 7065 4572 726f 7228 6622 4572 726f 7220  peError(f"Error 
+00021740: 696e 2063 6f6e 6361 7465 6e61 7469 6e67  in concatenating
+00021750: 207b 7365 6c66 7d20 616e 6420 7b6f 7468   {self} and {oth
+00021760: 6572 7d3a 206d 756c 7469 706c 6520 7365  er}: multiple se
+00021770: 7473 206f 6620 7365 7175 656e 6365 2064  ts of sequence d
+00021780: 696d 656e 7369 6f6e 732e 2022 290a 2020  imensions. ").  
+00021790: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+000217a0: 662e 5f5f 636c 6173 735f 5f2e 5f5f 6e65  f.__class__.__ne
+000217b0: 775f 7261 775f 5f28 7375 7065 7228 292e  w_raw__(super().
+000217c0: 5f5f 6164 645f 5f28 6f74 6865 7229 2c20  __add__(other), 
+000217d0: 737a 5f66 756e 635f 6469 6d3d 737a 5f66  sz_func_dim=sz_f
+000217e0: 756e 635f 6469 6d2c 2073 7a5f 6261 7463  unc_dim, sz_batc
+000217f0: 685f 6469 6d3d 737a 5f62 6174 6368 5f64  h_dim=sz_batch_d
+00021800: 696d 2c20 737a 5f66 6561 7475 7265 5f64  im, sz_feature_d
+00021810: 696d 3d73 7a5f 6665 6174 7572 655f 6469  im=sz_feature_di
+00021820: 6d2c 2073 7a5f 7365 7175 656e 6365 5f64  m, sz_sequence_d
+00021830: 696d 3d73 7a5f 7365 7175 656e 6365 5f64  im=sz_sequence_d
+00021840: 696d 290a 2020 2020 2020 2020 0a20 2020  im).        .   
+00021850: 2064 6566 205f 5f72 6164 645f 5f28 7365   def __radd__(se
+00021860: 6c66 2c20 6f74 6865 7229 3a0a 2020 2020  lf, other):.    
+00021870: 2020 2020 6176 6f75 6368 2869 7369 6e73      avouch(isins
+00021880: 7461 6e63 6528 6f74 6865 722c 2074 7570  tance(other, tup
+00021890: 6c65 292c 2054 7970 6545 7272 6f72 2822  le), TypeError("
+000218a0: 5375 6d6d 6174 696f 6e20 666f 7220 2762  Summation for 'b
+000218b0: 742e 5369 7a65 2720 6973 2069 6e68 6572  t.Size' is inher
+000218c0: 6974 6564 2066 726f 6d20 7079 7468 6f6e  ited from python
+000218d0: 206f 626a 6563 7420 2774 7570 6c65 2720   object 'tuple' 
+000218e0: 746f 2070 6572 666f 726d 2063 6f6e 6361  to perform conca
+000218f0: 7465 6e61 7469 6f6e 2c20 706c 6561 7365  tenation, please
+00021900: 2075 7365 2060 7369 7a65 203c 3c28 3e3e   use `size <<(>>
+00021910: 2920 3260 2074 6f20 7065 7266 6f72 6d20  ) 2` to perform 
+00021920: 656c 656d 656e 742d 7769 7365 2073 756d  element-wise sum
+00021930: 6d61 7469 6f6e 2028 7375 6274 7261 6374  mation (subtract
+00021940: 696f 6e29 2074 6f20 696e 6372 6561 7365  ion) to increase
+00021950: 2028 6465 6372 6561 7365 2920 7468 6520   (decrease) the 
+00021960: 7369 7a65 2e20 2229 290a 2020 2020 2020  size. ")).      
+00021970: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
+00021980: 6e63 6528 6f74 6865 722c 2053 697a 6529  nce(other, Size)
+00021990: 3a20 6f74 6865 7220 3d20 7365 6c66 2e5f  : other = self._
+000219a0: 5f63 6c61 7373 5f5f 2e5f 5f6e 6577 5f72  _class__.__new_r
+000219b0: 6177 5f5f 286f 7468 6572 290a 2020 2020  aw__(other).    
+000219c0: 2020 2020 7265 7475 726e 206f 7468 6572      return other
+000219d0: 2e5f 5f61 6464 5f5f 2873 656c 6629 0a20  .__add__(self). 
+000219e0: 2020 200a 2020 2020 4061 6c69 6173 2827     .    @alias('
+000219f0: 5f5f 696d 756c 5f5f 272c 2027 5f5f 726d  __imul__', '__rm
+00021a00: 756c 5f5f 2729 0a20 2020 2064 6566 205f  ul__').    def _
+00021a10: 5f6d 756c 5f5f 2873 656c 662c 206f 7468  _mul__(self, oth
+00021a20: 6572 293a 0a20 2020 2020 2020 2061 766f  er):.        avo
+00021a30: 7563 6828 6973 696e 7374 616e 6365 286f  uch(isinstance(o
+00021a40: 7468 6572 2c20 696e 745f 292c 2054 7970  ther, int_), Typ
+00021a50: 6545 7272 6f72 2822 5072 6f64 7563 7469  eError("Producti
+00021a60: 6f6e 2066 6f72 2027 6274 2e53 697a 6527  on for 'bt.Size'
+00021a70: 2069 7320 696e 6865 7269 7465 6420 6672   is inherited fr
+00021a80: 6f6d 2070 7974 686f 6e20 6f62 6a65 6374  om python object
+00021a90: 2027 7475 706c 6527 2074 6f20 7065 7266   'tuple' to perf
+00021aa0: 6f72 6d20 6475 706c 6963 6174 696f 6e2c  orm duplication,
+00021ab0: 2070 6c65 6173 6520 7573 6520 6073 697a   please use `siz
+00021ac0: 6520 2a2a 282f 2f29 2032 6020 746f 2070  e **(//) 2` to p
+00021ad0: 6572 666f 726d 2065 6c65 6d65 6e74 2d77  erform element-w
+00021ae0: 6973 6520 6d75 6c74 6970 6c69 6361 7469  ise multiplicati
+00021af0: 6f6e 2028 6469 7669 7369 6f6e 2920 746f  on (division) to
+00021b00: 2065 6e6c 6172 6765 2028 7368 7269 6e6b   enlarge (shrink
+00021b10: 2920 7468 6520 7369 7a65 2e20 2229 290a  ) the size. ")).
+00021b20: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00021b30: 6e5f 6675 6e63 5f64 696d 203d 3d20 7365  n_func_dim == se
+00021b40: 6c66 2e6e 5f64 696d 3a0a 2020 2020 2020  lf.n_dim:.      
+00021b50: 2020 2020 2020 6176 6f75 6368 286f 7468        avouch(oth
+00021b60: 6572 2069 6e20 2830 2c20 3129 2c20 5479  er in (0, 1), Ty
+00021b70: 7065 4572 726f 7228 6622 4572 726f 7220  peError(f"Error 
+00021b80: 696e 207b 7365 6c66 7d20 2a20 7b6f 7468  in {self} * {oth
+00021b90: 6572 7d3a 206d 756c 7469 706c 6520 6675  er}: multiple fu
+00021ba0: 6e63 7469 6f6e 616c 2064 696d 656e 7369  nctional dimensi
+00021bb0: 6f6e 732e 2022 2929 0a20 2020 2020 2020  ons. ")).       
+00021bc0: 2020 2020 2069 6620 6f74 6865 7220 3d3d       if other ==
+00021bd0: 2030 3a20 7265 7475 726e 2073 656c 662e   0: return self.
+00021be0: 5f5f 636c 6173 735f 5f2e 5f5f 6e65 775f  __class__.__new_
+00021bf0: 7261 775f 5f28 7475 706c 6528 2929 0a20  raw__(tuple()). 
+00021c00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00021c10: 6e20 7365 6c66 0a20 2020 2020 2020 2069  n self.        i
+00021c20: 6620 7365 6c66 2e6e 5f62 6174 6368 5f64  f self.n_batch_d
+00021c30: 696d 203d 3d20 7365 6c66 2e6e 5f64 696d  im == self.n_dim
+00021c40: 3a0a 2020 2020 2020 2020 2020 2020 6176  :.            av
+00021c50: 6f75 6368 286f 7468 6572 2069 6e20 2830  ouch(other in (0
+00021c60: 2c20 3129 2c20 5479 7065 4572 726f 7228  , 1), TypeError(
+00021c70: 6622 4572 726f 7220 696e 207b 7365 6c66  f"Error in {self
+00021c80: 7d20 2a20 7b6f 7468 6572 7d3a 206d 756c  } * {other}: mul
+00021c90: 7469 706c 6520 6261 7463 6820 6469 6d65  tiple batch dime
+00021ca0: 6e73 696f 6e73 2e20 2229 290a 2020 2020  nsions. ")).    
+00021cb0: 2020 2020 2020 2020 6966 206f 7468 6572          if other
+00021cc0: 203d 3d20 303a 2072 6574 7572 6e20 7365   == 0: return se
+00021cd0: 6c66 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e  lf.__class__.__n
+00021ce0: 6577 5f72 6177 5f5f 2874 7570 6c65 2829  ew_raw__(tuple()
+00021cf0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00021d00: 7475 726e 2073 656c 660a 2020 2020 2020  turn self.      
+00021d10: 2020 6966 2073 656c 662e 6e5f 6665 6174    if self.n_feat
+00021d20: 7572 655f 6469 6d20 3d3d 2073 656c 662e  ure_dim == self.
+00021d30: 6e5f 6469 6d3a 0a20 2020 2020 2020 2020  n_dim:.         
+00021d40: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00021d50: 5f63 6c61 7373 5f5f 2e5f 5f6e 6577 5f72  _class__.__new_r
+00021d60: 6177 5f5f 2873 7570 6572 2829 2e5f 5f6d  aw__(super().__m
+00021d70: 756c 5f5f 286f 7468 6572 292c 2073 7a5f  ul__(other), sz_
+00021d80: 6665 6174 7572 655f 6469 6d3d 7365 6c66  feature_dim=self
+00021d90: 2e6e 5f64 696d 202a 206f 7468 6572 290a  .n_dim * other).
+00021da0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00021db0: 6e5f 7365 7175 656e 6365 5f64 696d 203d  n_sequence_dim =
+00021dc0: 3d20 7365 6c66 2e6e 5f64 696d 3a0a 2020  = self.n_dim:.  
+00021dd0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00021de0: 2073 656c 662e 5f5f 636c 6173 735f 5f2e   self.__class__.
+00021df0: 5f5f 6e65 775f 7261 775f 5f28 7375 7065  __new_raw__(supe
+00021e00: 7228 292e 5f5f 6d75 6c5f 5f28 6f74 6865  r().__mul__(othe
+00021e10: 7229 2c20 737a 5f73 6571 7565 6e63 655f  r), sz_sequence_
+00021e20: 6469 6d3d 7365 6c66 2e6e 5f64 696d 202a  dim=self.n_dim *
+00021e30: 206f 7468 6572 290a 2020 2020 2020 2020   other).        
+00021e40: 6966 2073 656c 662e 6e5f 7370 6163 655f  if self.n_space_
+00021e50: 6469 6d20 3e20 303a 0a20 2020 2020 2020  dim > 0:.       
+00021e60: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00021e70: 2e77 6974 685f 7370 6163 6528 7365 6c66  .with_space(self
+00021e80: 2e73 7061 6365 2e74 7570 6c65 2829 202a  .space.tuple() *
+00021e90: 206f 7468 6572 290a 2020 2020 2020 2020   other).        
+00021ea0: 6966 2073 656c 662e 6e5f 7365 7175 656e  if self.n_sequen
+00021eb0: 6365 5f64 696d 203e 2030 3a0a 2020 2020  ce_dim > 0:.    
+00021ec0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00021ed0: 656c 662e 7769 7468 5f73 6571 7565 6e63  elf.with_sequenc
+00021ee0: 6528 7365 6c66 2e73 6571 7565 6e63 652e  e(self.sequence.
+00021ef0: 7475 706c 6528 2920 2a20 6f74 6865 7229  tuple() * other)
+00021f00: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
+00021f10: 7365 6c66 2e6e 5f66 6561 7475 7265 5f64  self.n_feature_d
+00021f20: 696d 203e 2030 2c20 5275 6e74 696d 6545  im > 0, RuntimeE
+00021f30: 7272 6f72 2866 2253 697a 6520 7b73 656c  rror(f"Size {sel
+00021f40: 667d 2065 6e63 6f75 6e74 6572 7320 616e  f} encounters an
+00021f50: 2069 6e6e 6572 2070 726f 626c 656d 3a20   inner problem: 
+00021f60: 6e5f 7370 6163 655f 6469 6d20 2b20 6e5f  n_space_dim + n_
+00021f70: 7365 7175 656e 6365 5f64 696d 202b 206e  sequence_dim + n
+00021f80: 5f66 6561 7475 7265 5f64 696d 202b 206e  _feature_dim + n
+00021f90: 5f62 6174 6368 5f64 696d 202b 206e 5f66  _batch_dim + n_f
+00021fa0: 756e 635f 6469 6d20 213d 206e 5f64 696d  unc_dim != n_dim
+00021fb0: 2e20 2229 290a 2020 2020 2020 2020 7265  . ")).        re
+00021fc0: 7475 726e 2073 656c 662e 7769 7468 5f66  turn self.with_f
+00021fd0: 6561 7475 7265 2873 656c 662e 6665 6174  eature(self.feat
+00021fe0: 7572 652e 7475 706c 6528 2920 2a20 6f74  ure.tuple() * ot
+00021ff0: 6865 7229 0a20 2020 200a 2020 2020 2323  her).    .    ##
+00022000: 2065 6c65 6d65 6e74 2d77 6973 6520 6f70   element-wise op
+00022010: 6572 6174 696f 6e73 3a0a 2020 2020 4073  erations:.    @s
+00022020: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
+00022030: 6465 6620 5f5f 6f70 5f5f 2873 656c 662c  def __op__(self,
+00022040: 206f 7468 6572 2c20 2a2c 206f 7065 7261   other, *, opera
+00022050: 7469 6f6e 2c20 6964 656e 7469 7479 293a  tion, identity):
+00022060: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
+00022070: 6973 696e 7374 616e 6365 2873 656c 662c  isinstance(self,
+00022080: 2053 697a 6529 2c20 5275 6e74 696d 6545   Size), RuntimeE
+00022090: 7272 6f72 2822 496e 6e65 7220 7072 6f62  rror("Inner prob
+000220a0: 6c65 6d3a 2069 6620 2762 742e 5369 7a65  lem: if 'bt.Size
+000220b0: 2e5f 5f6f 705f 5f27 2069 7320 6e6f 7420  .__op__' is not 
+000220c0: 6361 6c6c 6564 206d 616e 7561 6c6c 792c  called manually,
+000220d0: 2070 6c65 6173 6520 636f 6e74 6163 7420   please contact 
+000220e0: 7468 6520 6465 7665 6c6f 7065 7273 2077  the developers w
+000220f0: 6974 6820 4572 726f 7220 436f 6465 3a20  ith Error Code: 
+00022100: 4235 3236 2229 290a 2020 2020 2020 2020  B526")).        
+00022110: 6176 6f75 6368 2869 7369 6e73 7461 6e63  avouch(isinstanc
+00022120: 6528 6f74 6865 722c 2028 6e75 6d5f 2c20  e(other, (num_, 
+00022130: 7475 706c 6529 292c 2054 7970 6545 7272  tuple)), TypeErr
+00022140: 6f72 2866 2245 6c65 6d65 6e74 2d77 6973  or(f"Element-wis
+00022150: 6520 6f70 6572 6174 696f 6e73 2061 7265  e operations are
+00022160: 206f 6e6c 7920 7573 6564 2066 6f72 206e   only used for n
+00022170: 756d 6265 7273 206f 7220 7475 706c 6573  umbers or tuples
+00022180: 2c20 6e6f 7420 7b74 7970 6528 6f74 6865  , not {type(othe
+00022190: 7229 7d2e 2229 290a 2020 2020 2020 2020  r)}.")).        
+000221a0: 6f70 203d 206c 616d 6264 6120 782c 2079  op = lambda x, y
+000221b0: 3a20 286d 6178 5f28 696e 745f 286f 7065  : (max_(int_(ope
+000221c0: 7261 7469 6f6e 2878 2c20 7929 292c 2030  ration(x, y)), 0
+000221d0: 2920 6966 2078 203e 3d20 3020 656c 7365  ) if x >= 0 else
+000221e0: 202d 3129 2069 6620 6964 656e 7469 7479   -1) if identity
+000221f0: 203d 3d20 3020 6f72 2079 203e 3d20 3020   == 0 or y >= 0 
+00022200: 656c 7365 202d 310a 2020 2020 2020 2020  else -1.        
+00022210: 6966 2069 7369 6e73 7461 6e63 6528 6f74  if isinstance(ot
+00022220: 6865 722c 206e 756d 5f29 3a20 7265 7475  her, num_): retu
+00022230: 726e 2073 656c 662e 7769 7468 5f73 7061  rn self.with_spa
+00022240: 6365 2874 7570 6c65 286f 7028 782c 206f  ce(tuple(op(x, o
+00022250: 7468 6572 2920 666f 7220 7820 696e 2073  ther) for x in s
+00022260: 656c 662e 7370 6163 6529 290a 2020 2020  elf.space)).    
+00022270: 2020 2020 6f74 6865 725f 6675 6e63 203d      other_func =
+00022280: 2069 6465 6e74 6974 790a 2020 2020 2020   identity.      
+00022290: 2020 6f74 6865 725f 6261 7463 6820 3d20    other_batch = 
+000222a0: 6964 656e 7469 7479 0a20 2020 2020 2020  identity.       
+000222b0: 206f 7468 6572 5f66 6561 7475 7265 203d   other_feature =
+000222c0: 2028 6964 656e 7469 7479 2c29 0a20 2020   (identity,).   
+000222d0: 2020 2020 206f 7468 6572 5f73 6571 7565       other_seque
+000222e0: 6e63 6520 3d20 2869 6465 6e74 6974 792c  nce = (identity,
+000222f0: 290a 2020 2020 2020 2020 6f74 6865 725f  ).        other_
+00022300: 7370 6163 6520 3d20 2869 6465 6e74 6974  space = (identit
+00022310: 792c 290a 2020 2020 2020 2020 6966 2069  y,).        if i
+00022320: 7369 6e73 7461 6e63 6528 6f74 6865 722c  sinstance(other,
+00022330: 2053 697a 6529 3a0a 2020 2020 2020 2020   Size):.        
+00022340: 2020 2020 6966 206f 7468 6572 2e68 6173      if other.has
+00022350: 5f66 756e 633a 206f 7468 6572 5f66 756e  _func: other_fun
+00022360: 6320 3d20 6f74 6865 722e 6e5f 6675 6e63  c = other.n_func
+00022370: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00022380: 6f74 6865 722e 6861 735f 6261 7463 683a  other.has_batch:
+00022390: 206f 7468 6572 5f62 6174 6368 203d 206f   other_batch = o
+000223a0: 7468 6572 2e6e 5f62 6174 6368 0a20 2020  ther.n_batch.   
+000223b0: 2020 2020 2020 2020 2069 6620 6f74 6865           if othe
+000223c0: 722e 6861 735f 6665 6174 7572 653a 206f  r.has_feature: o
+000223d0: 7468 6572 5f66 6561 7475 7265 203d 206f  ther_feature = o
+000223e0: 7468 6572 2e66 6561 7475 7265 0a20 2020  ther.feature.   
+000223f0: 2020 2020 2020 2020 2069 6620 6f74 6865           if othe
+00022400: 722e 6861 735f 7365 7175 656e 6365 3a20  r.has_sequence: 
+00022410: 6f74 6865 725f 7365 7175 656e 6365 203d  other_sequence =
+00022420: 206f 7468 6572 2e73 6571 7565 6e63 650a   other.sequence.
+00022430: 2020 2020 2020 2020 2020 2020 6966 206f              if o
+00022440: 7468 6572 2e68 6173 5f73 7061 6365 3a20  ther.has_space: 
+00022450: 6f74 6865 725f 7370 6163 6520 3d20 6f74  other_space = ot
+00022460: 6865 722e 7370 6163 650a 2020 2020 2020  her.space.      
+00022470: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+00022480: 6528 6f74 6865 722c 2074 7570 6c65 293a  e(other, tuple):
+00022490: 206f 7468 6572 5f73 7061 6365 203d 206f   other_space = o
+000224a0: 7468 6572 0a20 2020 2020 2020 2065 6c73  ther.        els
+000224b0: 653a 2072 6169 7365 2054 7970 6545 7272  e: raise TypeErr
+000224c0: 6f72 2866 2243 616e 6e6f 7420 7065 7266  or(f"Cannot perf
+000224d0: 6f72 6d20 656c 656d 656e 742d 7769 7365  orm element-wise
+000224e0: 206f 7065 7261 7469 6f6e 2062 6574 7765   operation betwe
+000224f0: 656e 2074 7970 6573 207b 7479 7065 2873  en types {type(s
+00022500: 656c 6629 7d20 616e 6420 7b74 7970 6528  elf)} and {type(
+00022510: 6f74 6865 7229 7d2e 2022 290a 2020 2020  other)}. ").    
+00022520: 2020 2020 7365 6c66 5f66 6561 7475 7265      self_feature
+00022530: 203d 2074 7570 6c65 2829 0a20 2020 2020   = tuple().     
+00022540: 2020 2073 656c 665f 7365 7175 656e 6365     self_sequence
+00022550: 203d 2074 7570 6c65 2829 0a20 2020 2020   = tuple().     
+00022560: 2020 2073 656c 665f 7370 6163 6520 3d20     self_space = 
+00022570: 7475 706c 6528 290a 2020 2020 2020 2020  tuple().        
+00022580: 6966 2073 656c 662e 6861 735f 6665 6174  if self.has_feat
+00022590: 7572 653a 2073 656c 665f 6665 6174 7572  ure: self_featur
+000225a0: 6520 3d20 7365 6c66 2e66 6561 7475 7265  e = self.feature
+000225b0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+000225c0: 2e68 6173 5f73 6571 7565 6e63 653a 2073  .has_sequence: s
+000225d0: 656c 665f 7365 7175 656e 6365 203d 2073  elf_sequence = s
+000225e0: 656c 662e 7365 7175 656e 6365 0a20 2020  elf.sequence.   
+000225f0: 2020 2020 2069 6620 7365 6c66 2e68 6173       if self.has
+00022600: 5f73 7061 6365 3a20 7365 6c66 5f73 7061  _space: self_spa
+00022610: 6365 203d 2073 656c 662e 7370 6163 650a  ce = self.space.
+00022620: 2020 2020 2020 2020 6966 206c 656e 286f          if len(o
+00022630: 7468 6572 5f66 6561 7475 7265 2920 3d3d  ther_feature) ==
+00022640: 2031 3a20 6f74 6865 725f 6665 6174 7572   1: other_featur
+00022650: 6520 2a3d 2073 656c 662e 6e5f 6665 6174  e *= self.n_feat
+00022660: 7572 655f 6469 6d0a 2020 2020 2020 2020  ure_dim.        
+00022670: 656c 6966 206c 656e 2873 656c 665f 6665  elif len(self_fe
+00022680: 6174 7572 6529 203d 3d20 313a 2073 656c  ature) == 1: sel
+00022690: 665f 6665 6174 7572 6520 2a3d 206c 656e  f_feature *= len
+000226a0: 286f 7468 6572 5f66 6561 7475 7265 290a  (other_feature).
+000226b0: 2020 2020 2020 2020 6966 206c 656e 286f          if len(o
+000226c0: 7468 6572 5f73 6571 7565 6e63 6529 203d  ther_sequence) =
+000226d0: 3d20 313a 206f 7468 6572 5f73 6571 7565  = 1: other_seque
+000226e0: 6e63 6520 2a3d 2073 656c 662e 6e5f 7365  nce *= self.n_se
+000226f0: 7175 656e 6365 5f64 696d 0a20 2020 2020  quence_dim.     
+00022700: 2020 2065 6c69 6620 6c65 6e28 7365 6c66     elif len(self
+00022710: 5f73 6571 7565 6e63 6529 203d 3d20 313a  _sequence) == 1:
+00022720: 2073 656c 665f 7365 7175 656e 6365 202a   self_sequence *
+00022730: 3d20 6c65 6e28 6f74 6865 725f 7365 7175  = len(other_sequ
+00022740: 656e 6365 290a 2020 2020 2020 2020 6966  ence).        if
+00022750: 206c 656e 286f 7468 6572 5f73 7061 6365   len(other_space
+00022760: 2920 3d3d 2031 3a20 6f74 6865 725f 7370  ) == 1: other_sp
+00022770: 6163 6520 2a3d 2073 656c 662e 6e5f 7370  ace *= self.n_sp
+00022780: 6163 655f 6469 6d0a 2020 2020 2020 2020  ace_dim.        
+00022790: 656c 6966 206c 656e 2873 656c 665f 7370  elif len(self_sp
+000227a0: 6163 6529 203d 3d20 313a 2073 656c 665f  ace) == 1: self_
+000227b0: 7370 6163 6520 2a3d 206c 656e 286f 7468  space *= len(oth
+000227c0: 6572 5f73 7061 6365 290a 2020 2020 2020  er_space).      
+000227d0: 2020 6176 6f75 6368 2869 7369 6e73 7461    avouch(isinsta
+000227e0: 6e63 6528 6f74 6865 725f 6675 6e63 2c20  nce(other_func, 
+000227f0: 6e75 6d5f 292c 2054 7970 6545 7272 6f72  num_), TypeError
+00022800: 2866 2249 6e76 616c 6964 206f 7065 7261  (f"Invalid opera
+00022810: 7469 6f6e 2062 6574 7765 656e 207b 7365  tion between {se
+00022820: 6c66 7d20 616e 6420 7b6f 7468 6572 7d3a  lf} and {other}:
+00022830: 2063 6f6e 666c 6963 7420 696e 2066 756e   conflict in fun
+00022840: 6374 696f 6e61 6c20 6469 6d65 6e73 696f  ctional dimensio
+00022850: 6e2e 2022 2929 0a20 2020 2020 2020 2061  n. ")).        a
+00022860: 766f 7563 6828 6973 696e 7374 616e 6365  vouch(isinstance
+00022870: 286f 7468 6572 5f62 6174 6368 2c20 6e75  (other_batch, nu
+00022880: 6d5f 292c 2054 7970 6545 7272 6f72 2866  m_), TypeError(f
+00022890: 2249 6e76 616c 6964 206f 7065 7261 7469  "Invalid operati
+000228a0: 6f6e 2062 6574 7765 656e 207b 7365 6c66  on between {self
+000228b0: 7d20 616e 6420 7b6f 7468 6572 7d3a 2063  } and {other}: c
+000228c0: 6f6e 666c 6963 7420 696e 2062 6174 6368  onflict in batch
+000228d0: 2064 696d 656e 7369 6f6e 2e20 2229 290a   dimension. ")).
+000228e0: 2020 2020 2020 2020 6176 6f75 6368 2869          avouch(i
+000228f0: 7369 6e73 7461 6e63 6528 6f74 6865 725f  sinstance(other_
+00022900: 6665 6174 7572 652c 2074 7570 6c65 2920  feature, tuple) 
+00022910: 616e 6420 6c65 6e28 6f74 6865 725f 6665  and len(other_fe
+00022920: 6174 7572 6529 203d 3d20 7365 6c66 2e6e  ature) == self.n
+00022930: 5f66 6561 7475 7265 5f64 696d 2c20 5479  _feature_dim, Ty
+00022940: 7065 4572 726f 7228 6622 496e 7661 6c69  peError(f"Invali
+00022950: 6420 6f70 6572 6174 696f 6e20 6265 7477  d operation betw
+00022960: 6565 6e20 7b73 656c 667d 2061 6e64 207b  een {self} and {
+00022970: 6f74 6865 727d 3a20 636f 6e66 6c69 6374  other}: conflict
+00022980: 2069 6e20 6665 6174 7572 6520 7369 7a65   in feature size
+00022990: 2e20 2229 290a 2020 2020 2020 2020 6176  . ")).        av
+000229a0: 6f75 6368 2869 7369 6e73 7461 6e63 6528  ouch(isinstance(
+000229b0: 6f74 6865 725f 7365 7175 656e 6365 2c20  other_sequence, 
+000229c0: 7475 706c 6529 2061 6e64 206c 656e 286f  tuple) and len(o
+000229d0: 7468 6572 5f73 6571 7565 6e63 6529 203d  ther_sequence) =
+000229e0: 3d20 7365 6c66 2e6e 5f73 6571 7565 6e63  = self.n_sequenc
+000229f0: 655f 6469 6d2c 2054 7970 6545 7272 6f72  e_dim, TypeError
+00022a00: 2866 2249 6e76 616c 6964 206f 7065 7261  (f"Invalid opera
+00022a10: 7469 6f6e 2062 6574 7765 656e 207b 7365  tion between {se
+00022a20: 6c66 7d20 616e 6420 7b6f 7468 6572 7d3a  lf} and {other}:
+00022a30: 2063 6f6e 666c 6963 7420 696e 2073 6571   conflict in seq
+00022a40: 7565 6e63 6520 7369 7a65 2e20 2229 290a  uence size. ")).
+00022a50: 2020 2020 2020 2020 6176 6f75 6368 2869          avouch(i
+00022a60: 7369 6e73 7461 6e63 6528 6f74 6865 725f  sinstance(other_
+00022a70: 7370 6163 652c 2074 7570 6c65 2920 616e  space, tuple) an
+00022a80: 6420 6c65 6e28 6f74 6865 725f 7370 6163  d len(other_spac
+00022a90: 6529 203d 3d20 7365 6c66 2e6e 5f73 7061  e) == self.n_spa
+00022aa0: 6365 5f64 696d 2c20 5479 7065 4572 726f  ce_dim, TypeErro
+00022ab0: 7228 6622 496e 7661 6c69 6420 6f70 6572  r(f"Invalid oper
+00022ac0: 6174 696f 6e20 6265 7477 6565 6e20 7b73  ation between {s
+00022ad0: 656c 667d 2061 6e64 207b 6f74 6865 727d  elf} and {other}
+00022ae0: 3a20 636f 6e66 6c69 6374 2069 6e20 7370  : conflict in sp
+00022af0: 6163 6520 7369 7a65 2e20 2229 290a 2020  ace size. ")).  
+00022b00: 2020 2020 2020 6966 2073 656c 662e 6861        if self.ha
+00022b10: 735f 6675 6e63 3a20 7365 6c66 203d 2073  s_func: self = s
+00022b20: 656c 662e 7769 7468 5f66 756e 6328 6f70  elf.with_func(op
+00022b30: 2873 656c 662e 6e5f 6675 6e63 2c20 6f74  (self.n_func, ot
+00022b40: 6865 725f 6675 6e63 2929 0a20 2020 2020  her_func)).     
+00022b50: 2020 2069 6620 7365 6c66 2e68 6173 5f62     if self.has_b
+00022b60: 6174 6368 3a20 7365 6c66 203d 2073 656c  atch: self = sel
+00022b70: 662e 7769 7468 5f62 6174 6368 286f 7028  f.with_batch(op(
+00022b80: 7365 6c66 2e6e 5f62 6174 6368 2c20 6f74  self.n_batch, ot
+00022b90: 6865 725f 6261 7463 6829 290a 2020 2020  her_batch)).    
+00022ba0: 2020 2020 6966 2073 656c 662e 6861 735f      if self.has_
+00022bb0: 6665 6174 7572 653a 2073 656c 6620 3d20  feature: self = 
+00022bc0: 7365 6c66 2e77 6974 685f 6665 6174 7572  self.with_featur
+00022bd0: 6528 7475 706c 6528 6f70 2878 2c20 7929  e(tuple(op(x, y)
+00022be0: 2066 6f72 2078 2c20 7920 696e 207a 6970   for x, y in zip
+00022bf0: 2873 656c 665f 6665 6174 7572 652c 206f  (self_feature, o
+00022c00: 7468 6572 5f66 6561 7475 7265 2929 290a  ther_feature))).
+00022c10: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00022c20: 6861 735f 7365 7175 656e 6365 3a20 7365  has_sequence: se
+00022c30: 6c66 203d 2073 656c 662e 7769 7468 5f73  lf = self.with_s
+00022c40: 6571 7565 6e63 6528 7475 706c 6528 6f70  equence(tuple(op
+00022c50: 2878 2c20 7929 2066 6f72 2078 2c20 7920  (x, y) for x, y 
+00022c60: 696e 207a 6970 2873 656c 665f 7365 7175  in zip(self_sequ
+00022c70: 656e 6365 2c20 6f74 6865 725f 7365 7175  ence, other_sequ
+00022c80: 656e 6365 2929 290a 2020 2020 2020 2020  ence))).        
+00022c90: 6966 2073 656c 662e 6861 735f 7370 6163  if self.has_spac
+00022ca0: 653a 2073 656c 6620 3d20 7365 6c66 2e77  e: self = self.w
+00022cb0: 6974 685f 7370 6163 6528 7475 706c 6528  ith_space(tuple(
+00022cc0: 6f70 2878 2c20 7929 2066 6f72 2078 2c20  op(x, y) for x, 
+00022cd0: 7920 696e 207a 6970 2873 656c 665f 7370  y in zip(self_sp
+00022ce0: 6163 652c 206f 7468 6572 5f73 7061 6365  ace, other_space
+00022cf0: 2929 290a 2020 2020 2020 2020 7265 7475  ))).        retu
+00022d00: 726e 2073 656c 660a 0a20 2020 2040 616c  rn self..    @al
+00022d10: 6961 7328 275f 5f69 6c73 6869 6674 5f5f  ias('__ilshift__
+00022d20: 272c 2027 5f5f 726c 7368 6966 745f 5f27  ', '__rlshift__'
+00022d30: 290a 2020 2020 6465 6620 5f5f 6c73 6869  ).    def __lshi
+00022d40: 6674 5f5f 2873 656c 662c 206f 7468 6572  ft__(self, other
+00022d50: 293a 2072 6574 7572 6e20 5369 7a65 2e5f  ): return Size._
+00022d60: 5f6f 705f 5f28 7365 6c66 2c20 6f74 6865  _op__(self, othe
+00022d70: 722c 206f 7065 7261 7469 6f6e 3d6c 616d  r, operation=lam
+00022d80: 6264 6120 782c 2079 3a20 7820 2b20 792c  bda x, y: x + y,
+00022d90: 2069 6465 6e74 6974 793d 3029 0a20 2020   identity=0).   
+00022da0: 2040 616c 6961 7328 275f 5f69 7273 6869   @alias('__irshi
+00022db0: 6674 5f5f 2729 0a20 2020 2064 6566 205f  ft__').    def _
+00022dc0: 5f72 7368 6966 745f 5f28 7365 6c66 2c20  _rshift__(self, 
+00022dd0: 6f74 6865 7229 3a20 7265 7475 726e 2053  other): return S
+00022de0: 697a 652e 5f5f 6f70 5f5f 2873 656c 662c  ize.__op__(self,
+00022df0: 206f 7468 6572 2c20 6f70 6572 6174 696f   other, operatio
+00022e00: 6e3d 6c61 6d62 6461 2078 2c20 793a 2078  n=lambda x, y: x
+00022e10: 202d 2079 2c20 6964 656e 7469 7479 3d30   - y, identity=0
+00022e20: 290a 2020 2020 6465 6620 5f5f 7272 7368  ).    def __rrsh
+00022e30: 6966 745f 5f28 7365 6c66 2c20 6f74 6865  ift__(self, othe
+00022e40: 7229 3a20 7265 7475 726e 2053 697a 652e  r): return Size.
+00022e50: 5f5f 6f70 5f5f 2873 656c 662c 206f 7468  __op__(self, oth
+00022e60: 6572 2c20 6f70 6572 6174 696f 6e3d 6c61  er, operation=la
+00022e70: 6d62 6461 2078 2c20 793a 2079 202d 2078  mbda x, y: y - x
+00022e80: 2c20 6964 656e 7469 7479 3d30 290a 2020  , identity=0).  
+00022e90: 2020 4061 6c69 6173 2827 5f5f 6970 6f77    @alias('__ipow
+00022ea0: 5f5f 272c 2027 5f5f 7270 6f77 5f5f 2729  __', '__rpow__')
+00022eb0: 0a20 2020 2064 6566 205f 5f70 6f77 5f5f  .    def __pow__
+00022ec0: 2873 656c 662c 206f 7468 6572 293a 2072  (self, other): r
+00022ed0: 6574 7572 6e20 5369 7a65 2e5f 5f6f 705f  eturn Size.__op_
+00022ee0: 5f28 7365 6c66 2c20 6f74 6865 722c 206f  _(self, other, o
+00022ef0: 7065 7261 7469 6f6e 3d6c 616d 6264 6120  peration=lambda 
+00022f00: 782c 2079 3a20 7820 2a20 792c 2069 6465  x, y: x * y, ide
+00022f10: 6e74 6974 793d 3129 0a20 2020 2040 616c  ntity=1).    @al
+00022f20: 6961 7328 275f 5f69 666c 6f6f 7264 6976  ias('__ifloordiv
+00022f30: 5f5f 2729 0a20 2020 2064 6566 205f 5f66  __').    def __f
+00022f40: 6c6f 6f72 6469 765f 5f28 7365 6c66 2c20  loordiv__(self, 
+00022f50: 6f74 6865 7229 3a20 7265 7475 726e 2053  other): return S
+00022f60: 697a 652e 5f5f 6f70 5f5f 2873 656c 662c  ize.__op__(self,
+00022f70: 206f 7468 6572 2c20 6f70 6572 6174 696f   other, operatio
+00022f80: 6e3d 6c61 6d62 6461 2078 2c20 793a 2078  n=lambda x, y: x
+00022f90: 202f 2f20 792c 2069 6465 6e74 6974 793d   // y, identity=
+00022fa0: 3129 0a20 2020 2064 6566 205f 5f72 666c  1).    def __rfl
+00022fb0: 6f6f 7264 6976 5f5f 2873 656c 662c 206f  oordiv__(self, o
+00022fc0: 7468 6572 293a 2072 6574 7572 6e20 5369  ther): return Si
+00022fd0: 7a65 2e5f 5f6f 705f 5f28 6f74 6865 722c  ze.__op__(other,
+00022fe0: 2073 656c 662c 206f 7065 7261 7469 6f6e   self, operation
+00022ff0: 3d6c 616d 6264 6120 782c 2079 3a20 7920  =lambda x, y: y 
+00023000: 2f2f 2078 2c20 6964 656e 7469 7479 3d31  // x, identity=1
+00023010: 290a 2020 2020 0a20 2020 2064 6566 205f  ).    .    def _
+00023020: 5f78 6f72 5f5f 2873 656c 662c 206f 7468  _xor__(self, oth
+00023030: 6572 293a 0a20 2020 2020 2020 2022 2222  er):.        """
+00023040: 0a20 2020 2020 2020 2041 205e 2042 2072  .        A ^ B r
+00023050: 6574 7572 6e73 2041 5f20 616e 6420 425f  eturns A_ and B_
+00023060: 206f 6620 7468 6520 7361 6d65 206e 756d   of the same num
+00023070: 6265 7220 6f66 2064 696d 656e 7369 6f6e  ber of dimension
+00023080: 732c 2067 6976 656e 2074 6861 7420 415f  s, given that A_
+00023090: 2068 6173 2074 6865 2073 616d 6520 746f   has the same to
+000230a0: 7461 6c20 656c 656d 656e 7420 746f 2041  tal element to A
+000230b0: 2061 6e64 2042 5f20 6861 7320 7468 6520   and B_ has the 
+000230c0: 7361 6d65 2074 6f74 616c 2065 6c65 6d65  same total eleme
+000230d0: 6e74 2074 6f20 422e 200a 2020 2020 2020  nt to B. .      
+000230e0: 2020 4f6e 6520 6361 6e20 6578 7061 6e64    One can expand
+000230f0: 2074 6f20 7465 6e73 6f72 7320 6f66 2073   to tensors of s
+00023100: 697a 6573 2041 2061 6e64 2042 2074 6f20  izes A and B to 
+00023110: 415f 2061 6e64 2042 5f20 736f 2074 6861  A_ and B_ so tha
+00023120: 7420 7079 746f 7263 6820 6361 6e20 6561  t pytorch can ea
+00023130: 7369 6c79 2068 616e 646c 6520 6361 6c63  sily handle calc
+00023140: 756c 6174 696f 6e73 2e20 0a20 2020 2020  ulations. .     
+00023150: 2020 2022 2222 0a20 2020 2020 2020 2061     """.        a
+00023160: 766f 7563 6828 6973 696e 7374 616e 6365  vouch(isinstance
+00023170: 2873 656c 662c 2053 697a 6529 2061 6e64  (self, Size) and
+00023180: 2069 7369 6e73 7461 6e63 6528 6f74 6865   isinstance(othe
+00023190: 722c 2074 7570 6c65 292c 2054 7970 6545  r, tuple), TypeE
+000231a0: 7272 6f72 2822 786f 7220 666f 7220 6274  rror("xor for bt
+000231b0: 2e53 697a 6520 6f6e 6c79 2061 6363 6570  .Size only accep
+000231c0: 7420 7477 6f20 7475 706c 6573 2e22 2929  t two tuples."))
+000231d0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+000231e0: 6973 696e 7374 616e 6365 286f 7468 6572  isinstance(other
+000231f0: 2c20 5369 7a65 293a 206f 7468 6572 203d  , Size): other =
+00023200: 2073 656c 662e 5f5f 636c 6173 735f 5f2e   self.__class__.
+00023210: 5f5f 6e65 775f 7261 775f 5f28 6f74 6865  __new_raw__(othe
+00023220: 7229 0a20 2020 2020 2020 2023 2044 6561  r).        # Dea
+00023230: 6c20 7769 7468 2066 756e 6320 6469 6d65  l with func dime
+00023240: 6e73 696f 6e73 0a20 2020 2020 2020 2073  nsions.        s
+00023250: 7761 7020 3d20 4661 6c73 6520 2320 7377  wap = False # sw
+00023260: 6170 2074 6f20 656e 7375 7265 2074 6861  ap to ensure tha
+00023270: 7420 7661 7269 6162 6c65 2027 7365 6c66  t variable 'self
+00023280: 2720 6861 7320 6d6f 7265 2061 6e64 2072  ' has more and r
+00023290: 6563 6f76 6572 2077 6865 6e20 646f 6e65  ecover when done
+000232a0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+000232b0: 7365 6c66 2e68 6173 5f66 756e 6320 616e  self.has_func an
+000232c0: 6420 6f74 6865 722e 6861 735f 6675 6e63  d other.has_func
+000232d0: 3a20 7365 6c66 2c20 6f74 6865 7220 3d20  : self, other = 
+000232e0: 6f74 6865 722c 2073 656c 663b 2073 7761  other, self; swa
+000232f0: 7020 3d20 5472 7565 0a20 2020 2020 2020  p = True.       
+00023300: 2069 6620 7365 6c66 2e68 6173 5f66 756e   if self.has_fun
+00023310: 6320 616e 6420 6e6f 7420 6f74 6865 722e  c and not other.
+00023320: 6861 735f 6675 6e63 3a0a 2020 2020 2020  has_func:.      
+00023330: 2020 2020 2020 6966 2073 656c 662e 737a        if self.sz
+00023340: 5f66 756e 635f 6469 6d20 3e20 303a 206f  _func_dim > 0: o
+00023350: 7468 6572 203d 2053 697a 6528 3129 2e77  ther = Size(1).w
+00023360: 6974 685f 6675 6e63 5f64 696d 2854 7275  ith_func_dim(Tru
+00023370: 6529 202b 206f 7468 6572 0a20 2020 2020  e) + other.     
+00023380: 2020 2020 2020 2065 6c73 653a 206f 7468         else: oth
+00023390: 6572 203d 206f 7468 6572 202b 2053 697a  er = other + Siz
+000233a0: 6528 3129 2e77 6974 685f 6675 6e63 5f64  e(1).with_func_d
+000233b0: 696d 2854 7275 6529 0a20 2020 2020 2020  im(True).       
+000233c0: 2020 2020 206f 7468 6572 2e73 7a5f 6675       other.sz_fu
+000233d0: 6e63 5f64 696d 203d 2073 656c 662e 737a  nc_dim = self.sz
+000233e0: 5f66 756e 635f 6469 6d0a 2020 2020 2020  _func_dim.      
+000233f0: 2020 6966 2073 7761 703a 2073 656c 662c    if swap: self,
+00023400: 206f 7468 6572 203d 206f 7468 6572 2c20   other = other, 
+00023410: 7365 6c66 0a20 2020 2020 2020 2069 6620  self.        if 
+00023420: 7365 6c66 2e68 6173 5f66 756e 6320 616e  self.has_func an
+00023430: 6420 6f74 6865 722e 6861 735f 6675 6e63  d other.has_func
+00023440: 3a0a 2020 2020 2020 2020 2020 2020 6176  :.            av
+00023450: 6f75 6368 2873 656c 662e 737a 5f66 756e  ouch(self.sz_fun
+00023460: 635f 6469 6d20 2a20 6f74 6865 722e 737a  c_dim * other.sz
+00023470: 5f66 756e 635f 6469 6d20 3e20 3020 6f72  _func_dim > 0 or
+00023480: 2073 656c 662e 6e5f 6675 6e63 5f64 696d   self.n_func_dim
+00023490: 203d 3d20 7365 6c66 2e6e 5f64 696d 206f   == self.n_dim o
+000234a0: 7220 6f74 6865 722e 6e5f 6675 6e63 5f64  r other.n_func_d
+000234b0: 696d 203d 3d20 6f74 6865 722e 6e5f 6469  im == other.n_di
+000234c0: 6d2c 0a20 2020 2020 2020 2020 2020 2020  m,.             
+000234d0: 2020 2020 2020 5479 7065 4572 726f 7228        TypeError(
+000234e0: 6622 436f 6e66 6c69 6374 206f 6363 7572  f"Conflict occur
+000234f0: 7265 6420 696e 2075 6e69 6679 696e 6720  red in unifying 
+00023500: 7369 7a65 7320 7b73 656c 667d 2061 6e64  sizes {self} and
+00023510: 207b 6f74 6865 727d 3a20 6d69 736d 6174   {other}: mismat
+00023520: 6368 6564 206f 7264 6572 2062 6574 7765  ched order betwe
+00023530: 656e 2066 756e 6374 696f 6e61 6c20 6469  en functional di
+00023540: 6d65 6e73 696f 6e20 616e 6420 6f74 6865  mension and othe
+00023550: 7273 2e20 2229 290a 2020 2020 2020 2020  rs. ")).        
+00023560: 2320 4465 616c 2077 6974 6820 6261 7463  # Deal with batc
+00023570: 6820 6469 6d65 6e73 696f 6e73 0a20 2020  h dimensions.   
+00023580: 2020 2020 2073 7761 7020 3d20 4661 6c73       swap = Fals
+00023590: 6520 2320 7377 6170 2074 6f20 656e 7375  e # swap to ensu
+000235a0: 7265 2074 6861 7420 7661 7269 6162 6c65  re that variable
+000235b0: 2027 7365 6c66 2720 6861 7320 6d6f 7265   'self' has more
+000235c0: 2061 6e64 2072 6563 6f76 6572 2077 6865   and recover whe
+000235d0: 6e20 646f 6e65 0a20 2020 2020 2020 2069  n done.        i
+000235e0: 6620 6e6f 7420 7365 6c66 2e68 6173 5f62  f not self.has_b
+000235f0: 6174 6368 2061 6e64 206f 7468 6572 2e68  atch and other.h
+00023600: 6173 5f62 6174 6368 3a20 7365 6c66 2c20  as_batch: self, 
+00023610: 6f74 6865 7220 3d20 6f74 6865 722c 2073  other = other, s
+00023620: 656c 663b 2073 7761 7020 3d20 5472 7565  elf; swap = True
+00023630: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00023640: 2e68 6173 5f62 6174 6368 2061 6e64 206e  .has_batch and n
+00023650: 6f74 206f 7468 6572 2e68 6173 5f62 6174  ot other.has_bat
+00023660: 6368 3a0a 2020 2020 2020 2020 2020 2020  ch:.            
+00023670: 6966 2073 656c 662e 737a 5f62 6174 6368  if self.sz_batch
+00023680: 5f64 696d 203e 2030 3a20 6f74 6865 7220  _dim > 0: other 
+00023690: 3d20 6f74 6865 725b 3a6f 7468 6572 2e73  = other[:other.s
+000236a0: 697a 655f 7374 6172 745d 202b 2053 697a  ize_start] + Siz
+000236b0: 6528 7b31 7d29 202b 206f 7468 6572 5b6f  e({1}) + other[o
+000236c0: 7468 6572 2e73 697a 655f 7374 6172 743a  ther.size_start:
+000236d0: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
+000236e0: 7365 3a20 6f74 6865 7220 3d20 6f74 6865  se: other = othe
+000236f0: 725b 3a6f 7468 6572 2e73 697a 655f 7374  r[:other.size_st
+00023700: 6f70 5d20 2b20 5369 7a65 287b 317d 2920  op] + Size({1}) 
+00023710: 2b20 6f74 6865 725b 6f74 6865 722e 7369  + other[other.si
+00023720: 7a65 5f73 746f 703a 5d0a 2020 2020 2020  ze_stop:].      
+00023730: 2020 2020 2020 6f74 6865 722e 737a 5f62        other.sz_b
+00023740: 6174 6368 5f64 696d 203d 2073 656c 662e  atch_dim = self.
+00023750: 737a 5f62 6174 6368 5f64 696d 0a20 2020  sz_batch_dim.   
+00023760: 2020 2020 2069 6620 7377 6170 3a20 7365       if swap: se
+00023770: 6c66 2c20 6f74 6865 7220 3d20 6f74 6865  lf, other = othe
+00023780: 722c 2073 656c 660a 2020 2020 2020 2020  r, self.        
+00023790: 6966 2073 656c 662e 6861 735f 6261 7463  if self.has_batc
+000237a0: 6820 616e 6420 6f74 6865 722e 6861 735f  h and other.has_
+000237b0: 6261 7463 683a 0a20 2020 2020 2020 2020  batch:.         
+000237c0: 2020 2061 766f 7563 6828 7365 6c66 2e73     avouch(self.s
+000237d0: 7a5f 6261 7463 685f 6469 6d20 2a20 6f74  z_batch_dim * ot
+000237e0: 6865 722e 737a 5f62 6174 6368 5f64 696d  her.sz_batch_dim
+000237f0: 203e 2030 206f 7220 7365 6c66 2e6e 5f62   > 0 or self.n_b
+00023800: 6174 6368 5f64 696d 203d 3d20 7365 6c66  atch_dim == self
+00023810: 2e6e 5f64 696d 202d 2073 656c 662e 6e5f  .n_dim - self.n_
+00023820: 6675 6e63 5f64 696d 206f 7220 6f74 6865  func_dim or othe
+00023830: 722e 6e5f 6261 7463 685f 6469 6d20 3d3d  r.n_batch_dim ==
+00023840: 206f 7468 6572 2e6e 5f64 696d 202d 206f   other.n_dim - o
+00023850: 7468 6572 2e6e 5f66 756e 635f 6469 6d2c  ther.n_func_dim,
+00023860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023870: 2020 2020 5479 7065 4572 726f 7228 6622      TypeError(f"
+00023880: 436f 6e66 6c69 6374 206f 6363 7572 7265  Conflict occurre
+00023890: 6420 696e 2075 6e69 6679 696e 6720 7369  d in unifying si
+000238a0: 7a65 7320 7b73 656c 667d 2061 6e64 207b  zes {self} and {
+000238b0: 6f74 6865 727d 3a20 6d69 736d 6174 6368  other}: mismatch
+000238c0: 6564 206f 7264 6572 2062 6574 7765 656e  ed order between
+000238d0: 2062 6174 6368 2064 696d 656e 7369 6f6e   batch dimension
+000238e0: 2061 6e64 206f 7468 6572 732e 2022 2929   and others. "))
+000238f0: 0a20 2020 2020 2020 2023 2044 6561 6c20  .        # Deal 
+00023900: 7769 7468 2066 6561 7475 7265 2064 696d  with feature dim
+00023910: 656e 7369 6f6e 730a 2020 2020 2020 2020  ensions.        
+00023920: 7377 6170 203d 2046 616c 7365 2023 2073  swap = False # s
+00023930: 7761 7020 746f 2065 6e73 7572 6520 7468  wap to ensure th
+00023940: 6174 2076 6172 6961 626c 6520 2773 656c  at variable 'sel
+00023950: 6627 2068 6173 206d 6f72 6520 616e 6420  f' has more and 
+00023960: 7265 636f 7665 7220 7768 656e 2064 6f6e  recover when don
+00023970: 650a 2020 2020 2020 2020 6966 206e 6f74  e.        if not
+00023980: 2073 656c 662e 6861 735f 6665 6174 7572   self.has_featur
+00023990: 6520 616e 6420 6f74 6865 722e 6861 735f  e and other.has_
+000239a0: 6665 6174 7572 653a 2073 656c 662c 206f  feature: self, o
+000239b0: 7468 6572 203d 206f 7468 6572 2c20 7365  ther = other, se
+000239c0: 6c66 3b20 7377 6170 203d 2054 7275 650a  lf; swap = True.
+000239d0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000239e0: 6861 735f 6665 6174 7572 6520 616e 6420  has_feature and 
+000239f0: 6e6f 7420 6f74 6865 722e 6861 735f 6665  not other.has_fe
+00023a00: 6174 7572 653a 0a20 2020 2020 2020 2020  ature:.         
+00023a10: 2020 2069 6620 7365 6c66 2e73 7a5f 6665     if self.sz_fe
+00023a20: 6174 7572 655f 6469 6d20 3e20 303a 206f  ature_dim > 0: o
+00023a30: 7468 6572 203d 206f 7468 6572 5b3a 6f74  ther = other[:ot
+00023a40: 6865 722e 6e6f 6e5f 6261 745f 7374 6172  her.non_bat_star
+00023a50: 745d 202b 2053 697a 6528 5b31 5d20 2a20  t] + Size([1] * 
+00023a60: 7365 6c66 2e6e 5f66 6561 7475 7265 5f64  self.n_feature_d
+00023a70: 696d 2920 2b20 6f74 6865 725b 6f74 6865  im) + other[othe
+00023a80: 722e 6e6f 6e5f 6261 745f 7374 6172 743a  r.non_bat_start:
+00023a90: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
+00023aa0: 7365 3a20 6f74 6865 7220 3d20 6f74 6865  se: other = othe
+00023ab0: 725b 3a6f 7468 6572 2e6e 6f6e 5f62 6174  r[:other.non_bat
+00023ac0: 5f73 746f 705d 202b 2053 697a 6528 5b31  _stop] + Size([1
+00023ad0: 5d20 2a20 7365 6c66 2e6e 5f66 6561 7475  ] * self.n_featu
+00023ae0: 7265 5f64 696d 2920 2b20 6f74 6865 725b  re_dim) + other[
+00023af0: 6f74 6865 722e 6e6f 6e5f 6261 745f 7374  other.non_bat_st
+00023b00: 6f70 3a5d 0a20 2020 2020 2020 2020 2020  op:].           
+00023b10: 206f 7468 6572 2e73 7a5f 6665 6174 7572   other.sz_featur
+00023b20: 655f 6469 6d20 3d20 7365 6c66 2e73 7a5f  e_dim = self.sz_
+00023b30: 6665 6174 7572 655f 6469 6d0a 2020 2020  feature_dim.    
+00023b40: 2020 2020 6966 2073 7761 703a 2073 656c      if swap: sel
+00023b50: 662c 206f 7468 6572 203d 206f 7468 6572  f, other = other
+00023b60: 2c20 7365 6c66 0a20 2020 2020 2020 2069  , self.        i
+00023b70: 6620 7365 6c66 2e68 6173 5f66 6561 7475  f self.has_featu
+00023b80: 7265 2061 6e64 206f 7468 6572 2e68 6173  re and other.has
+00023b90: 5f66 6561 7475 7265 3a0a 2020 2020 2020  _feature:.      
+00023ba0: 2020 2020 2020 6176 6f75 6368 2873 656c        avouch(sel
+00023bb0: 662e 737a 5f66 6561 7475 7265 5f64 696d  f.sz_feature_dim
+00023bc0: 202a 206f 7468 6572 2e73 7a5f 6665 6174   * other.sz_feat
+00023bd0: 7572 655f 6469 6d20 3e20 3020 6f72 2073  ure_dim > 0 or s
+00023be0: 656c 662e 6e5f 6665 6174 7572 655f 6469  elf.n_feature_di
+00023bf0: 6d20 3d3d 2073 656c 662e 6e5f 6469 6d20  m == self.n_dim 
+00023c00: 2d20 7365 6c66 2e6e 5f66 756e 635f 6469  - self.n_func_di
+00023c10: 6d20 2d20 7365 6c66 2e6e 5f62 6174 6368  m - self.n_batch
+00023c20: 5f64 696d 206f 7220 6f74 6865 722e 6e5f  _dim or other.n_
+00023c30: 6665 6174 7572 655f 6469 6d20 3d3d 206f  feature_dim == o
+00023c40: 7468 6572 2e6e 5f64 696d 202d 206f 7468  ther.n_dim - oth
+00023c50: 6572 2e6e 5f66 756e 635f 6469 6d20 2d20  er.n_func_dim - 
+00023c60: 6f74 6865 722e 6e5f 6261 7463 685f 6469  other.n_batch_di
+00023c70: 6d2c 0a20 2020 2020 2020 2020 2020 2020  m,.             
+00023c80: 2020 2020 2020 5479 7065 4572 726f 7228        TypeError(
+00023c90: 6622 436f 6e66 6c69 6374 206f 6363 7572  f"Conflict occur
+00023ca0: 7265 6420 696e 2075 6e69 6679 696e 6720  red in unifying 
+00023cb0: 7369 7a65 7320 7b73 656c 667d 2061 6e64  sizes {self} and
+00023cc0: 207b 6f74 6865 727d 3a20 6d69 736d 6174   {other}: mismat
+00023cd0: 6368 6564 206f 7264 6572 2062 6574 7765  ched order betwe
+00023ce0: 656e 2066 6561 7475 7265 2064 696d 656e  en feature dimen
+00023cf0: 7369 6f6e 7320 616e 6420 7365 7175 656e  sions and sequen
+00023d00: 6365 2f73 7061 6365 2064 696d 656e 7369  ce/space dimensi
+00023d10: 6f6e 732e 2022 2929 0a20 2020 2020 2020  ons. ")).       
+00023d20: 2020 2020 2069 6620 7365 6c66 2e6e 5f66       if self.n_f
+00023d30: 6561 7475 7265 5f64 696d 203e 206f 7468  eature_dim > oth
+00023d40: 6572 2e6e 5f66 6561 7475 7265 5f64 696d  er.n_feature_dim
+00023d50: 3a20 6f74 6865 7220 3d20 6f74 6865 722e  : other = other.
+00023d60: 7769 7468 5f66 6561 7475 7265 2828 312c  with_feature((1,
+00023d70: 2920 2a20 2873 656c 662e 6e5f 6665 6174  ) * (self.n_feat
+00023d80: 7572 655f 6469 6d20 2d20 6f74 6865 722e  ure_dim - other.
+00023d90: 6e5f 6665 6174 7572 655f 6469 6d29 202b  n_feature_dim) +
+00023da0: 206f 7468 6572 2e66 6561 7475 7265 2e74   other.feature.t
+00023db0: 7570 6c65 2829 290a 2020 2020 2020 2020  uple()).        
+00023dc0: 2020 2020 656c 7365 3a20 7365 6c66 203d      else: self =
+00023dd0: 2073 656c 662e 7769 7468 5f66 6561 7475   self.with_featu
+00023de0: 7265 2828 312c 2920 2a20 286f 7468 6572  re((1,) * (other
+00023df0: 2e6e 5f66 6561 7475 7265 5f64 696d 202d  .n_feature_dim -
+00023e00: 2073 656c 662e 6e5f 6665 6174 7572 655f   self.n_feature_
+00023e10: 6469 6d29 202b 2073 656c 662e 6665 6174  dim) + self.feat
+00023e20: 7572 652e 7475 706c 6528 2929 0a20 2020  ure.tuple()).   
+00023e30: 2020 2020 2023 2044 6561 6c20 7769 7468       # Deal with
+00023e40: 2073 6571 7565 6e63 6520 6469 6d65 6e73   sequence dimens
+00023e50: 696f 6e73 0a20 2020 2020 2020 2073 7761  ions.        swa
+00023e60: 7020 3d20 4661 6c73 6520 2320 7377 6170  p = False # swap
+00023e70: 2074 6f20 656e 7375 7265 2074 6861 7420   to ensure that 
+00023e80: 7661 7269 6162 6c65 2027 7365 6c66 2720  variable 'self' 
+00023e90: 6861 7320 6d6f 7265 2061 6e64 2072 6563  has more and rec
+00023ea0: 6f76 6572 2077 6865 6e20 646f 6e65 0a20  over when done. 
+00023eb0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+00023ec0: 6c66 2e68 6173 5f73 6571 7565 6e63 6520  lf.has_sequence 
+00023ed0: 616e 6420 6f74 6865 722e 6861 735f 7365  and other.has_se
+00023ee0: 7175 656e 6365 3a20 7365 6c66 2c20 6f74  quence: self, ot
+00023ef0: 6865 7220 3d20 6f74 6865 722c 2073 656c  her = other, sel
+00023f00: 663b 2073 7761 7020 3d20 5472 7565 0a20  f; swap = True. 
+00023f10: 2020 2020 2020 2069 6620 7365 6c66 2e68         if self.h
+00023f20: 6173 5f73 6571 7565 6e63 6520 616e 6420  as_sequence and 
+00023f30: 6e6f 7420 6f74 6865 722e 6861 735f 7365  not other.has_se
+00023f40: 7175 656e 6365 3a0a 2020 2020 2020 2020  quence:.        
+00023f50: 2020 2020 6966 2073 656c 662e 737a 5f73      if self.sz_s
+00023f60: 6571 7565 6e63 655f 6469 6d20 3e20 303a  equence_dim > 0:
+00023f70: 206f 7468 6572 203d 206f 7468 6572 5b3a   other = other[:
+00023f80: 6f74 6865 722e 7365 715f 7370 635f 7374  other.seq_spc_st
+00023f90: 6172 745d 202b 2053 697a 6528 2827 3127  art] + Size(('1'
+00023fa0: 2c29 202a 2073 656c 662e 6e5f 7365 7175  ,) * self.n_sequ
+00023fb0: 656e 6365 5f64 696d 2920 2b20 6f74 6865  ence_dim) + othe
+00023fc0: 725b 6f74 6865 722e 7365 715f 7370 635f  r[other.seq_spc_
+00023fd0: 7374 6172 743a 5d0a 2020 2020 2020 2020  start:].        
+00023fe0: 2020 2020 656c 7365 3a20 6f74 6865 7220      else: other 
+00023ff0: 3d20 6f74 6865 725b 3a6f 7468 6572 2e73  = other[:other.s
+00024000: 6571 5f73 7063 5f73 746f 705d 202b 2053  eq_spc_stop] + S
+00024010: 697a 6528 2827 3127 2c29 202a 2073 656c  ize(('1',) * sel
+00024020: 662e 6e5f 7365 7175 656e 6365 5f64 696d  f.n_sequence_dim
+00024030: 2920 2b20 6f74 6865 725b 6f74 6865 722e  ) + other[other.
+00024040: 7365 715f 7370 635f 7374 6f70 3a5d 0a20  seq_spc_stop:]. 
+00024050: 2020 2020 2020 2020 2020 206f 7468 6572             other
+00024060: 2e73 7a5f 7365 7175 656e 6365 5f64 696d  .sz_sequence_dim
+00024070: 203d 2073 656c 662e 737a 5f73 6571 7565   = self.sz_seque
+00024080: 6e63 655f 6469 6d0a 2020 2020 2020 2020  nce_dim.        
+00024090: 6966 2073 7761 703a 2073 656c 662c 206f  if swap: self, o
+000240a0: 7468 6572 203d 206f 7468 6572 2c20 7365  ther = other, se
+000240b0: 6c66 0a20 2020 2020 2020 2069 6620 7365  lf.        if se
+000240c0: 6c66 2e68 6173 5f73 6571 7565 6e63 6520  lf.has_sequence 
+000240d0: 616e 6420 6f74 6865 722e 6861 735f 7365  and other.has_se
+000240e0: 7175 656e 6365 3a0a 2020 2020 2020 2020  quence:.        
+000240f0: 2020 2020 6176 6f75 6368 2873 656c 662e      avouch(self.
+00024100: 737a 5f73 6571 7565 6e63 655f 6469 6d20  sz_sequence_dim 
+00024110: 2a20 6f74 6865 722e 737a 5f73 6571 7565  * other.sz_seque
+00024120: 6e63 655f 6469 6d20 3e20 3020 6f72 2073  nce_dim > 0 or s
+00024130: 656c 662e 6e5f 7365 7175 656e 6365 5f64  elf.n_sequence_d
+00024140: 696d 203d 3d20 7365 6c66 2e6e 5f64 696d  im == self.n_dim
+00024150: 202d 2073 656c 662e 6e5f 6675 6e63 5f64   - self.n_func_d
+00024160: 696d 202d 2073 656c 662e 6e5f 6261 7463  im - self.n_batc
+00024170: 685f 6469 6d20 2d20 7365 6c66 2e6e 5f66  h_dim - self.n_f
+00024180: 6561 7475 7265 5f64 696d 206f 7220 6f74  eature_dim or ot
+00024190: 6865 722e 6e5f 7365 7175 656e 6365 5f64  her.n_sequence_d
+000241a0: 696d 203d 3d20 6f74 6865 722e 6e5f 6469  im == other.n_di
+000241b0: 6d20 2d20 6f74 6865 722e 6e5f 6675 6e63  m - other.n_func
+000241c0: 5f64 696d 202d 206f 7468 6572 2e6e 5f62  _dim - other.n_b
+000241d0: 6174 6368 5f64 696d 202d 2073 656c 662e  atch_dim - self.
+000241e0: 6e5f 6665 6174 7572 655f 6469 6d2c 0a20  n_feature_dim,. 
+000241f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024200: 2020 5479 7065 4572 726f 7228 6622 436f    TypeError(f"Co
+00024210: 6e66 6c69 6374 206f 6363 7572 7265 6420  nflict occurred 
+00024220: 696e 2075 6e69 6679 696e 6720 7369 7a65  in unifying size
+00024230: 7320 7b73 656c 667d 2061 6e64 207b 6f74  s {self} and {ot
+00024240: 6865 727d 3a20 6d69 736d 6174 6368 6564  her}: mismatched
+00024250: 206f 7264 6572 2062 6574 7765 656e 2073   order between s
+00024260: 6571 7565 6e63 6520 6469 6d65 6e73 696f  equence dimensio
+00024270: 6e73 2061 6e64 2073 7061 6365 2064 696d  ns and space dim
+00024280: 656e 7369 6f6e 732e 2022 2929 0a20 2020  ensions. ")).   
+00024290: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+000242a0: 2e6e 5f73 6571 7565 6e63 655f 6469 6d20  .n_sequence_dim 
+000242b0: 3e20 6f74 6865 722e 6e5f 7365 7175 656e  > other.n_sequen
+000242c0: 6365 5f64 696d 3a20 6f74 6865 7220 3d20  ce_dim: other = 
+000242d0: 6f74 6865 722e 7769 7468 5f73 6571 7565  other.with_seque
+000242e0: 6e63 6528 2831 2c29 202a 2028 7365 6c66  nce((1,) * (self
+000242f0: 2e6e 5f73 6571 7565 6e63 655f 6469 6d20  .n_sequence_dim 
+00024300: 2d20 6f74 6865 722e 6e5f 7365 7175 656e  - other.n_sequen
+00024310: 6365 5f64 696d 2920 2b20 6f74 6865 722e  ce_dim) + other.
+00024320: 7365 7175 656e 6365 2e74 7570 6c65 2829  sequence.tuple()
+00024330: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00024340: 7365 3a20 7365 6c66 203d 2073 656c 662e  se: self = self.
+00024350: 7769 7468 5f73 6571 7565 6e63 6528 2831  with_sequence((1
+00024360: 2c29 202a 2028 6f74 6865 722e 6e5f 7365  ,) * (other.n_se
+00024370: 7175 656e 6365 5f64 696d 202d 2073 656c  quence_dim - sel
+00024380: 662e 6e5f 7365 7175 656e 6365 5f64 696d  f.n_sequence_dim
+00024390: 2920 2b20 7365 6c66 2e73 6571 7565 6e63  ) + self.sequenc
+000243a0: 652e 7475 706c 6528 2929 0a20 2020 2020  e.tuple()).     
+000243b0: 2020 2023 2044 6561 6c20 7769 7468 2073     # Deal with s
+000243c0: 7061 6365 2064 696d 656e 7369 6f6e 730a  pace dimensions.
+000243d0: 2020 2020 2020 2020 7377 6170 203d 2046          swap = F
+000243e0: 616c 7365 2023 2073 7761 7020 746f 2065  alse # swap to e
+000243f0: 6e73 7572 6520 7468 6174 2076 6172 6961  nsure that varia
+00024400: 626c 6520 2773 656c 6627 2068 6173 206d  ble 'self' has m
+00024410: 6f72 6520 616e 6420 7265 636f 7665 7220  ore and recover 
+00024420: 7768 656e 2064 6f6e 650a 2020 2020 2020  when done.      
+00024430: 2020 6966 206e 6f74 2073 656c 662e 6861    if not self.ha
+00024440: 735f 7370 6163 6520 616e 6420 6f74 6865  s_space and othe
+00024450: 722e 6861 735f 7370 6163 653a 2073 656c  r.has_space: sel
+00024460: 662c 206f 7468 6572 203d 206f 7468 6572  f, other = other
+00024470: 2c20 7365 6c66 3b20 7377 6170 203d 2054  , self; swap = T
+00024480: 7275 650a 2020 2020 2020 2020 6966 2073  rue.        if s
+00024490: 656c 662e 6861 735f 7370 6163 6520 616e  elf.has_space an
+000244a0: 6420 6e6f 7420 6f74 6865 722e 6861 735f  d not other.has_
+000244b0: 7370 6163 653a 0a20 2020 2020 2020 2020  space:.         
+000244c0: 2020 2069 6620 7365 6c66 2e73 7a5f 7365     if self.sz_se
+000244d0: 7175 656e 6365 5f64 696d 202a 206f 7468  quence_dim * oth
+000244e0: 6572 2e73 7a5f 7365 7175 656e 6365 5f64  er.sz_sequence_d
+000244f0: 696d 203c 2030 3a20 6f74 6865 722e 737a  im < 0: other.sz
+00024500: 5f73 6571 7565 6e63 655f 6469 6d20 3d20  _sequence_dim = 
+00024510: 7365 6c66 2e73 7a5f 7365 7175 656e 6365  self.sz_sequence
+00024520: 5f64 696d 0a20 2020 2020 2020 2020 2020  _dim.           
+00024530: 2065 6c69 6620 6f74 6865 722e 737a 5f73   elif other.sz_s
+00024540: 6571 7565 6e63 655f 6469 6d20 3d3d 2030  equence_dim == 0
+00024550: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00024560: 2020 6966 2073 656c 662e 737a 5f66 6561    if self.sz_fea
+00024570: 7475 7265 5f64 696d 202a 206f 7468 6572  ture_dim * other
+00024580: 2e73 7a5f 6665 6174 7572 655f 6469 6d20  .sz_feature_dim 
+00024590: 3c20 303a 206f 7468 6572 2e73 7a5f 6665  < 0: other.sz_fe
+000245a0: 6174 7572 655f 6469 6d20 3d20 7365 6c66  ature_dim = self
+000245b0: 2e73 7a5f 6665 6174 7572 655f 6469 6d0a  .sz_feature_dim.
+000245c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000245d0: 656c 6966 206f 7468 6572 2e73 7a5f 6665  elif other.sz_fe
+000245e0: 6174 7572 655f 6469 6d20 3d3d 2030 3a0a  ature_dim == 0:.
+000245f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024600: 2020 2020 6966 2073 656c 662e 737a 5f62      if self.sz_b
+00024610: 6174 6368 5f64 696d 202a 206f 7468 6572  atch_dim * other
+00024620: 2e73 7a5f 6261 7463 685f 6469 6d20 3c20  .sz_batch_dim < 
+00024630: 303a 206f 7468 6572 2e73 7a5f 6261 7463  0: other.sz_batc
+00024640: 685f 6469 6d20 3d20 7365 6c66 2e73 7a5f  h_dim = self.sz_
+00024650: 6261 7463 685f 6469 6d0a 2020 2020 2020  batch_dim.      
+00024660: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00024670: 6966 206f 7468 6572 2e73 7a5f 6261 7463  if other.sz_batc
+00024680: 685f 6469 6d20 3d3d 2030 3a0a 2020 2020  h_dim == 0:.    
+00024690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000246a0: 2020 2020 6966 2073 656c 662e 737a 5f66      if self.sz_f
+000246b0: 756e 635f 6469 6d20 2a20 6f74 6865 722e  unc_dim * other.
+000246c0: 737a 5f66 756e 635f 6469 6d20 3c20 303a  sz_func_dim < 0:
+000246d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000246e0: 2020 2020 2020 2020 2020 2020 206f 7468               oth
+000246f0: 6572 2e73 7a5f 6675 6e63 5f64 696d 203d  er.sz_func_dim =
+00024700: 2073 656c 662e 737a 5f66 756e 635f 6469   self.sz_func_di
+00024710: 6d0a 2020 2020 2020 2020 2020 2020 6f74  m.            ot
+00024720: 6865 7220 3d20 6f74 6865 725b 3a6f 7468  her = other[:oth
+00024730: 6572 2e73 7061 6365 5f73 7461 7274 5d20  er.space_start] 
+00024740: 2b20 5369 7a65 2828 312c 2920 2a20 7365  + Size((1,) * se
+00024750: 6c66 2e6e 5f73 7061 6365 5f64 696d 2920  lf.n_space_dim) 
+00024760: 2b20 6f74 6865 725b 6f74 6865 722e 7370  + other[other.sp
+00024770: 6163 655f 7374 6172 743a 5d0a 2020 2020  ace_start:].    
+00024780: 2020 2020 6966 2073 7761 703a 2073 656c      if swap: sel
+00024790: 662c 206f 7468 6572 203d 206f 7468 6572  f, other = other
+000247a0: 2c20 7365 6c66 0a20 2020 2020 2020 2069  , self.        i
+000247b0: 6620 7365 6c66 2e68 6173 5f73 7061 6365  f self.has_space
+000247c0: 2061 6e64 206f 7468 6572 2e68 6173 5f73   and other.has_s
+000247d0: 7061 6365 3a0a 2020 2020 2020 2020 2020  pace:.          
+000247e0: 2020 6966 2073 656c 662e 6e5f 7370 6163    if self.n_spac
+000247f0: 655f 6469 6d20 3e20 6f74 6865 722e 6e5f  e_dim > other.n_
+00024800: 7370 6163 655f 6469 6d3a 206f 7468 6572  space_dim: other
+00024810: 203d 206f 7468 6572 2e77 6974 685f 7370   = other.with_sp
+00024820: 6163 6528 2831 2c29 202a 2028 7365 6c66  ace((1,) * (self
+00024830: 2e6e 5f73 7061 6365 5f64 696d 202d 206f  .n_space_dim - o
+00024840: 7468 6572 2e6e 5f73 7061 6365 5f64 696d  ther.n_space_dim
+00024850: 2920 2b20 6f74 6865 722e 7370 6163 652e  ) + other.space.
+00024860: 7475 706c 6528 2929 0a20 2020 2020 2020  tuple()).       
+00024870: 2020 2020 2065 6c73 653a 2073 656c 6620       else: self 
+00024880: 3d20 7365 6c66 2e77 6974 685f 7370 6163  = self.with_spac
+00024890: 6528 2831 2c29 202a 2028 6f74 6865 722e  e((1,) * (other.
+000248a0: 6e5f 7370 6163 655f 6469 6d20 2d20 7365  n_space_dim - se
+000248b0: 6c66 2e6e 5f73 7061 6365 5f64 696d 2920  lf.n_space_dim) 
+000248c0: 2b20 7365 6c66 2e73 7061 6365 2e74 7570  + self.space.tup
+000248d0: 6c65 2829 290a 2020 2020 2020 2020 7265  le()).        re
+000248e0: 7475 726e 2073 656c 662c 206f 7468 6572  turn self, other
+000248f0: 0a20 2020 200a 6675 6e63 5f64 696d 5f73  .    .func_dim_s
+00024900: 697a 6520 3d20 6c61 6d62 6461 2069 3a20  ize = lambda i: 
+00024910: 5369 7a65 2e5f 5f6e 6577 5f72 6177 5f5f  Size.__new_raw__
+00024920: 2828 692c 292c 2073 7a5f 6675 6e63 5f64  ((i,), sz_func_d
+00024930: 696d 3d31 290a 6675 6e63 5f64 696d 203d  im=1).func_dim =
+00024940: 2066 756e 635f 6469 6d5f 7369 7a65 2831   func_dim_size(1
+00024950: 290a 2020 2020 0a63 6c61 7373 2046 616b  ).    .class Fak
+00024960: 6553 697a 6528 7475 706c 6529 3a0a 2020  eSize(tuple):.  
+00024970: 2020 6465 6620 5f5f 6e65 775f 5f28 636c    def __new__(cl
+00024980: 732c 2072 6177 5f74 7570 6c65 2c20 737a  s, raw_tuple, sz
+00024990: 5f66 756e 635f 6469 6d20 3d20 302c 2073  _func_dim = 0, s
+000249a0: 7a5f 6261 7463 685f 6469 6d20 3d20 302c  z_batch_dim = 0,
+000249b0: 2073 7a5f 6665 6174 7572 655f 6469 6d20   sz_feature_dim 
+000249c0: 3d20 302c 2073 7a5f 7365 7175 656e 6365  = 0, sz_sequence
+000249d0: 5f64 696d 203d 2030 293a 0a20 2020 2020  _dim = 0):.     
+000249e0: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
+000249f0: 7265 6174 6520 6120 4661 6b65 5369 7a65  reate a FakeSize
+00024a00: 2077 6974 686f 7574 206e 5f64 696d 2061   without n_dim a
+00024a10: 6e64 2063 6865 636b 7320 696e 766f 6c76  nd checks involv
+00024a20: 696e 6720 6e5f 6469 6d20 616e 6420 7370  ing n_dim and sp
+00024a30: 6563 6961 6c2d 6469 6d20 636f 6e66 6c69  ecial-dim confli
+00024a40: 6374 732e 200a 2020 2020 2020 2020 5448  cts. .        TH
+00024a50: 4953 2049 5320 5052 4956 4154 4520 464f  IS IS PRIVATE FO
+00024a60: 5220 4261 546f 7263 6820 322e 302c 2070  R BaTorch 2.0, p
+00024a70: 6c65 6173 6520 646f 6e6f 7420 7573 6520  lease donot use 
+00024a80: 7468 6973 2069 6620 796f 7520 6172 6520  this if you are 
+00024a90: 6e6f 7420 6661 6d69 6c69 6172 2077 6974  not familiar wit
+00024aa0: 6820 6973 2e20 0a20 2020 2020 2020 2054  h is. .        T
+00024ab0: 6869 7320 6973 2064 6573 6967 6e65 6420  his is designed 
+00024ac0: 696e 2074 6865 2066 6972 7374 2070 6c61  in the first pla
+00024ad0: 6365 2066 6f72 2074 6865 2064 696d 656e  ce for the dimen
+00024ae0: 7369 6f6e 206d 616e 6970 756c 6174 696f  sion manipulatio
+00024af0: 6e73 2077 6974 6820 6120 7475 706c 6520  ns with a tuple 
+00024b00: 6f66 200a 2020 2020 2020 2020 2020 2020  of .            
+00024b10: 696e 7465 6765 7273 2069 7320 7072 6f76  integers is prov
+00024b20: 6964 6564 2061 6c6f 6e67 2077 6974 6820  ided along with 
+00024b30: 7370 6563 6961 6c20 6469 6d65 6e73 696f  special dimensio
+00024b40: 6e20 696e 666f 726d 6174 696f 6e2e 200a  n information. .
+00024b50: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00024b60: 2045 7861 6d70 6c65 733a 3a0a 2020 2020   Examples::.    
+00024b70: 2020 2020 2020 2020 3e3e 3e20 6274 2e53          >>> bt.S
+00024b80: 697a 6528 322c 332c 3429 2e73 7065 6369  ize(2,3,4).speci
+00024b90: 616c 5f66 726f 6d28 6274 2e46 616b 6553  al_from(bt.FakeS
+00024ba0: 697a 6528 2831 302c 2031 3029 2c20 737a  ize((10, 10), sz
+00024bb0: 5f62 6174 6368 5f64 696d 3d31 2929 0a20  _batch_dim=1)). 
+00024bc0: 2020 2020 2020 2020 2020 2062 6174 6f72             bator
+00024bd0: 6368 2e53 697a 6528 7b32 7d2c 2033 2c20  ch.Size({2}, 3, 
+00024be0: 3429 0a20 2020 2020 2020 2022 2222 0a20  4).        """. 
+00024bf0: 2020 2020 2020 2069 6620 7261 775f 7475         if raw_tu
+00024c00: 706c 6520 6973 204e 6f6e 653a 2072 6574  ple is None: ret
+00024c10: 7572 6e20 4e6f 6e65 0a20 2020 2020 2020  urn None.       
+00024c20: 2069 6620 6973 696e 7374 616e 6365 2872   if isinstance(r
+00024c30: 6177 5f74 7570 6c65 2c20 5369 7a65 293a  aw_tuple, Size):
+00024c40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00024c50: 6620 3d20 7375 7065 7228 292e 5f5f 6e65  f = super().__ne
+00024c60: 775f 5f28 636c 732c 2072 6177 5f74 7570  w__(cls, raw_tup
+00024c70: 6c65 2e74 7570 6c65 2829 290a 2020 2020  le.tuple()).    
+00024c80: 2020 2020 2020 2020 7365 6c66 2e73 7a5f          self.sz_
+00024c90: 6675 6e63 5f64 696d 203d 2072 6177 5f74  func_dim = raw_t
+00024ca0: 7570 6c65 2e73 7a5f 6675 6e63 5f64 696d  uple.sz_func_dim
+00024cb0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00024cc0: 662e 737a 5f62 6174 6368 5f64 696d 203d  f.sz_batch_dim =
+00024cd0: 2072 6177 5f74 7570 6c65 2e73 7a5f 6261   raw_tuple.sz_ba
+00024ce0: 7463 685f 6469 6d0a 2020 2020 2020 2020  tch_dim.        
+00024cf0: 2020 2020 7365 6c66 2e73 7a5f 6665 6174      self.sz_feat
+00024d00: 7572 655f 6469 6d20 3d20 7261 775f 7475  ure_dim = raw_tu
+00024d10: 706c 652e 737a 5f66 6561 7475 7265 5f64  ple.sz_feature_d
+00024d20: 696d 0a20 2020 2020 2020 2020 2020 2073  im.            s
+00024d30: 656c 662e 737a 5f73 6571 7565 6e63 655f  elf.sz_sequence_
+00024d40: 6469 6d20 3d20 7261 775f 7475 706c 652e  dim = raw_tuple.
+00024d50: 737a 5f73 6571 7565 6e63 655f 6469 6d0a  sz_sequence_dim.
+00024d60: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00024d70: 726e 2073 656c 660a 2020 2020 2020 2020  rn self.        
+00024d80: 7365 6c66 203d 2073 7570 6572 2829 2e5f  self = super()._
+00024d90: 5f6e 6577 5f5f 2863 6c73 2c20 7261 775f  _new__(cls, raw_
+00024da0: 7475 706c 6529 0a20 2020 2020 2020 2073  tuple).        s
+00024db0: 656c 662e 737a 5f66 756e 635f 6469 6d20  elf.sz_func_dim 
+00024dc0: 3d20 737a 5f66 756e 635f 6469 6d0a 2020  = sz_func_dim.  
+00024dd0: 2020 2020 2020 7365 6c66 2e73 7a5f 6261        self.sz_ba
+00024de0: 7463 685f 6469 6d20 3d20 737a 5f62 6174  tch_dim = sz_bat
+00024df0: 6368 5f64 696d 0a20 2020 2020 2020 2073  ch_dim.        s
+00024e00: 656c 662e 737a 5f66 6561 7475 7265 5f64  elf.sz_feature_d
+00024e10: 696d 203d 2073 7a5f 6665 6174 7572 655f  im = sz_feature_
+00024e20: 6469 6d0a 2020 2020 2020 2020 7365 6c66  dim.        self
+00024e30: 2e73 7a5f 7365 7175 656e 6365 5f64 696d  .sz_sequence_dim
+00024e40: 203d 2073 7a5f 7365 7175 656e 6365 5f64   = sz_sequence_d
+00024e50: 696d 0a20 2020 2020 2020 2072 6574 7572  im.        retur
+00024e60: 6e20 7365 6c66 0a20 2020 2064 6566 205f  n self.    def _
+00024e70: 5f72 6570 725f 5f28 7365 6c66 293a 0a20  _repr__(self):. 
+00024e80: 2020 2020 2020 2072 6574 7572 6e20 2746         return 'F
+00024e90: 616b 6553 697a 6527 202b 2073 7570 6572  akeSize' + super
+00024ea0: 2829 2e5f 5f72 6570 725f 5f28 292e 7273  ().__repr__().rs
+00024eb0: 7472 6970 2827 2c29 2729 202b 2066 222c  trip(',)') + f",
+00024ec0: 2073 7a5f 6675 6e63 5f64 696d 3d7b 7365   sz_func_dim={se
+00024ed0: 6c66 2e73 7a5f 6675 6e63 5f64 696d 7d2c  lf.sz_func_dim},
+00024ee0: 2073 7a5f 6261 7463 685f 6469 6d3d 7b73   sz_batch_dim={s
+00024ef0: 656c 662e 737a 5f62 6174 6368 5f64 696d  elf.sz_batch_dim
+00024f00: 7d2c 2073 7a5f 6665 6174 7572 655f 6469  }, sz_feature_di
+00024f10: 6d3d 7b73 656c 662e 737a 5f66 6561 7475  m={self.sz_featu
+00024f20: 7265 5f64 696d 7d2c 2073 7a5f 7365 7175  re_dim}, sz_sequ
+00024f30: 656e 6365 5f64 696d 3d7b 7365 6c66 2e73  ence_dim={self.s
+00024f40: 7a5f 7365 7175 656e 6365 5f64 696d 7d29  z_sequence_dim})
+00024f50: 220a 2020 2020 6465 6620 5f5f 6765 7469  ".    def __geti
+00024f60: 7465 6d5f 5f28 7365 6c66 2c20 2a61 7267  tem__(self, *arg
+00024f70: 7329 3a0a 2020 2020 2020 2020 6966 206c  s):.        if l
+00024f80: 656e 2861 7267 7329 203d 3d20 3120 616e  en(args) == 1 an
+00024f90: 6420 6973 696e 7374 616e 6365 2861 7267  d isinstance(arg
+00024fa0: 735b 305d 2c20 696e 745f 293a 2072 6574  s[0], int_): ret
+00024fb0: 7572 6e20 7375 7065 7228 292e 5f5f 6765  urn super().__ge
+00024fc0: 7469 7465 6d5f 5f28 2a61 7267 7329 0a20  titem__(*args). 
+00024fd0: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
+00024fe0: 6b65 5369 7a65 2873 7570 6572 2829 2e5f  keSize(super()._
+00024ff0: 5f67 6574 6974 656d 5f5f 282a 6172 6773  _getitem__(*args
+00025000: 292c 2073 7a5f 6675 6e63 5f64 696d 203d  ), sz_func_dim =
+00025010: 2073 656c 662e 737a 5f66 756e 635f 6469   self.sz_func_di
+00025020: 6d2c 2073 7a5f 6261 7463 685f 6469 6d20  m, sz_batch_dim 
+00025030: 3d20 7365 6c66 2e73 7a5f 6261 7463 685f  = self.sz_batch_
+00025040: 6469 6d2c 2073 7a5f 6665 6174 7572 655f  dim, sz_feature_
+00025050: 6469 6d20 3d20 7365 6c66 2e73 7a5f 6665  dim = self.sz_fe
+00025060: 6174 7572 655f 6469 6d2c 2073 7a5f 7365  ature_dim, sz_se
+00025070: 7175 656e 6365 5f64 696d 203d 2073 656c  quence_dim = sel
+00025080: 662e 737a 5f73 6571 7565 6e63 655f 6469  f.sz_sequence_di
+00025090: 6d29 0a20 2020 2040 616c 6961 7328 275f  m).    @alias('_
+000250a0: 5f69 6164 645f 5f27 290a 2020 2020 6465  _iadd__').    de
+000250b0: 6620 5f5f 6164 645f 5f28 7365 6c66 2c20  f __add__(self, 
+000250c0: 6f74 6865 7229 3a0a 2020 2020 2020 2020  other):.        
+000250d0: 7265 7475 726e 2046 616b 6553 697a 6528  return FakeSize(
+000250e0: 7375 7065 7228 292e 5f5f 6164 645f 5f28  super().__add__(
+000250f0: 7475 706c 6528 6f74 6865 7229 292c 2073  tuple(other)), s
+00025100: 7a5f 6675 6e63 5f64 696d 203d 2073 656c  z_func_dim = sel
+00025110: 662e 737a 5f66 756e 635f 6469 6d2c 2073  f.sz_func_dim, s
+00025120: 7a5f 6261 7463 685f 6469 6d20 3d20 7365  z_batch_dim = se
+00025130: 6c66 2e73 7a5f 6261 7463 685f 6469 6d2c  lf.sz_batch_dim,
+00025140: 2073 7a5f 6665 6174 7572 655f 6469 6d20   sz_feature_dim 
+00025150: 3d20 7365 6c66 2e73 7a5f 6665 6174 7572  = self.sz_featur
+00025160: 655f 6469 6d2c 2073 7a5f 7365 7175 656e  e_dim, sz_sequen
+00025170: 6365 5f64 696d 203d 2073 656c 662e 737a  ce_dim = self.sz
+00025180: 5f73 6571 7565 6e63 655f 6469 6d29 0a20  _sequence_dim). 
+00025190: 2020 2064 6566 205f 5f72 6164 645f 5f28     def __radd__(
+000251a0: 7365 6c66 2c20 6f74 6865 7229 3a0a 2020  self, other):.  
+000251b0: 2020 2020 2020 7265 7475 726e 2046 616b        return Fak
+000251c0: 6553 697a 6528 7475 706c 6528 6f74 6865  eSize(tuple(othe
+000251d0: 7229 202b 2074 7570 6c65 2873 656c 6629  r) + tuple(self)
+000251e0: 2c20 0a20 2020 2020 2020 2020 2020 2073  , .            s
+000251f0: 7a5f 6675 6e63 5f64 696d 203d 2067 6574  z_func_dim = get
+00025200: 6174 7472 286f 7468 6572 2c20 2773 7a5f  attr(other, 'sz_
+00025210: 6675 6e63 5f64 696d 272c 2073 656c 662e  func_dim', self.
+00025220: 737a 5f66 756e 635f 6469 6d29 2c20 0a20  sz_func_dim), . 
+00025230: 2020 2020 2020 2020 2020 2073 7a5f 6261             sz_ba
+00025240: 7463 685f 6469 6d20 3d20 6765 7461 7474  tch_dim = getatt
+00025250: 7228 6f74 6865 722c 2027 737a 5f62 6174  r(other, 'sz_bat
+00025260: 6368 5f64 696d 272c 2073 656c 662e 737a  ch_dim', self.sz
+00025270: 5f62 6174 6368 5f64 696d 292c 200a 2020  _batch_dim), .  
+00025280: 2020 2020 2020 2020 2020 737a 5f66 6561            sz_fea
+00025290: 7475 7265 5f64 696d 203d 2067 6574 6174  ture_dim = getat
+000252a0: 7472 286f 7468 6572 2c20 2773 7a5f 6665  tr(other, 'sz_fe
+000252b0: 6174 7572 655f 6469 6d27 2c20 7365 6c66  ature_dim', self
+000252c0: 2e73 7a5f 6665 6174 7572 655f 6469 6d29  .sz_feature_dim)
+000252d0: 2c20 0a20 2020 2020 2020 2020 2020 2073  , .            s
+000252e0: 7a5f 7365 7175 656e 6365 5f64 696d 203d  z_sequence_dim =
+000252f0: 2067 6574 6174 7472 286f 7468 6572 2c20   getattr(other, 
+00025300: 2773 7a5f 7365 7175 656e 6365 5f64 696d  'sz_sequence_dim
+00025310: 272c 2073 656c 662e 737a 5f73 6571 7565  ', self.sz_seque
+00025320: 6e63 655f 6469 6d29 0a20 2020 2020 2020  nce_dim).       
+00025330: 2029 0a0a 6465 6620 6272 6f61 6463 6173   )..def broadcas
+00025340: 7428 2a73 697a 6573 2c20 7769 7468 5f73  t(*sizes, with_s
+00025350: 697a 655f 7570 6461 7465 733d 4661 6c73  ize_updates=Fals
+00025360: 6529 3a0a 2020 2020 6966 206c 656e 2873  e):.    if len(s
+00025370: 697a 6573 2920 3d3d 2030 3a0a 2020 2020  izes) == 0:.    
+00025380: 2020 2020 6272 6f61 6463 6173 7465 6420      broadcasted 
+00025390: 3d20 5369 7a65 2829 0a20 2020 2020 2020  = Size().       
+000253a0: 2069 6620 7769 7468 5f73 697a 655f 7570   if with_size_up
+000253b0: 6461 7465 733a 2062 726f 6164 6361 7374  dates: broadcast
+000253c0: 6564 2e75 7064 6174 6564 5f73 697a 6573  ed.updated_sizes
+000253d0: 203d 205b 5d0a 2020 2020 656c 6966 206c   = [].    elif l
+000253e0: 656e 2873 697a 6573 2920 3d3d 2031 3a0a  en(sizes) == 1:.
+000253f0: 2020 2020 2020 2020 6272 6f61 6463 6173          broadcas
+00025400: 7465 6420 3d20 7369 7a65 735b 305d 0a20  ted = sizes[0]. 
+00025410: 2020 2020 2020 2069 6620 7769 7468 5f73         if with_s
+00025420: 697a 655f 7570 6461 7465 733a 2062 726f  ize_updates: bro
+00025430: 6164 6361 7374 6564 2e75 7064 6174 6564  adcasted.updated
+00025440: 5f73 697a 6573 203d 205b 7369 7a65 735b  _sizes = [sizes[
+00025450: 305d 5d0a 2020 2020 656c 7365 3a0a 2020  0]].    else:.  
+00025460: 2020 2020 2020 782c 2079 203d 2073 697a        x, y = siz
+00025470: 6573 5b30 5d20 5e20 7369 7a65 735b 315d  es[0] ^ sizes[1]
+00025480: 0a20 2020 2020 2020 2062 726f 6164 6361  .        broadca
+00025490: 7374 6564 203d 2053 697a 6528 6d61 785f  sted = Size(max_
+000254a0: 2875 2c20 7629 2066 6f72 2075 2c20 7620  (u, v) for u, v 
+000254b0: 696e 207a 6970 2878 2c20 7929 292e 7370  in zip(x, y)).sp
+000254c0: 6563 6961 6c5f 6672 6f6d 2879 290a 2020  ecial_from(y).  
+000254d0: 2020 2020 2020 7570 6461 7465 645f 7369        updated_si
+000254e0: 7a65 7320 3d20 5b78 2c20 795d 0a20 2020  zes = [x, y].   
+000254f0: 2020 2020 2066 6f72 207a 2069 6e20 7369       for z in si
+00025500: 7a65 735b 323a 5d3a 0a20 2020 2020 2020  zes[2:]:.       
+00025510: 2020 2020 2078 2c20 7920 3d20 6272 6f61       x, y = broa
+00025520: 6463 6173 7465 6420 5e20 7a0a 2020 2020  dcasted ^ z.    
+00025530: 2020 2020 2020 2020 6272 6f61 6463 6173          broadcas
+00025540: 7465 6420 3d20 5369 7a65 286d 6178 5f28  ted = Size(max_(
+00025550: 752c 2076 2920 666f 7220 752c 2076 2069  u, v) for u, v i
+00025560: 6e20 7a69 7028 782c 2079 2929 2e73 7065  n zip(x, y)).spe
+00025570: 6369 616c 5f66 726f 6d28 7929 0a20 2020  cial_from(y).   
+00025580: 2020 2020 2020 2020 2075 7064 6174 6564           updated
+00025590: 5f73 697a 6573 2e61 7070 656e 6428 7929  _sizes.append(y)
+000255a0: 0a20 2020 2020 2020 2069 6620 7769 7468  .        if with
+000255b0: 5f73 697a 655f 7570 6461 7465 733a 2062  _size_updates: b
+000255c0: 726f 6164 6361 7374 6564 2e75 7064 6174  roadcasted.updat
+000255d0: 6564 5f73 697a 6573 203d 2075 7064 6174  ed_sizes = updat
+000255e0: 6564 5f73 697a 6573 0a20 2020 2072 6574  ed_sizes.    ret
+000255f0: 7572 6e20 6272 6f61 6463 6173 7465 640a  urn broadcasted.
+00025600: 0a64 6566 2072 656d 6f76 655f 6469 6d28  .def remove_dim(
+00025610: 7369 7a65 2c20 6c69 7374 5f6f 665f 7265  size, list_of_re
+00025620: 6d6f 7661 6c73 293a 0a20 2020 2069 6620  movals):.    if 
+00025630: 6e6f 7420 6973 696e 7374 616e 6365 286c  not isinstance(l
+00025640: 6973 745f 6f66 5f72 656d 6f76 616c 732c  ist_of_removals,
+00025650: 206c 6973 7429 3a20 6c69 7374 5f6f 665f   list): list_of_
+00025660: 7265 6d6f 7661 6c73 203d 206c 6973 7428  removals = list(
+00025670: 6c69 7374 5f6f 665f 7265 6d6f 7661 6c73  list_of_removals
+00025680: 290a 2020 2020 6c69 7374 5f6f 665f 7265  ).    list_of_re
+00025690: 6d6f 7661 6c73 2e73 6f72 7428 290a 2020  movals.sort().  
+000256a0: 2020 7265 7475 726e 2073 756d 5f28 5b73    return sum_([s
+000256b0: 697a 655b 736c 6963 6528 7820 2b20 312c  ize[slice(x + 1,
+000256c0: 2079 295d 2066 6f72 2078 2c20 7920 696e   y)] for x, y in
+000256d0: 207a 6970 285b 2d31 5d20 2b20 6c69 7374   zip([-1] + list
+000256e0: 5f6f 665f 7265 6d6f 7661 6c73 2c20 6c69  _of_removals, li
+000256f0: 7374 5f6f 665f 7265 6d6f 7661 6c73 202b  st_of_removals +
+00025700: 205b 4e6f 6e65 5d29 5d2c 2053 697a 6528   [None])], Size(
+00025710: 2929 0a0a 6465 6620 6164 645f 6469 6d28  ))..def add_dim(
+00025720: 7369 7a65 2c20 6c69 7374 5f6f 665f 6164  size, list_of_ad
+00025730: 6473 293a 0a20 2020 2069 6620 6e6f 7420  ds):.    if not 
+00025740: 6973 696e 7374 616e 6365 286c 6973 745f  isinstance(list_
+00025750: 6f66 5f61 6464 732c 206c 6973 7429 3a20  of_adds, list): 
+00025760: 6c69 7374 5f6f 665f 6164 6473 203d 206c  list_of_adds = l
+00025770: 6973 7428 6c69 7374 5f6f 665f 6164 6473  ist(list_of_adds
+00025780: 290a 2020 2020 666f 7220 6920 696e 206c  ).    for i in l
+00025790: 6973 745f 6f66 5f61 6464 733a 2073 697a  ist_of_adds: siz
+000257a0: 6520 3d20 7369 7a65 5b3a 695d 202b 2028  e = size[:i] + (
+000257b0: 312c 2920 2b20 7369 7a65 5b69 3a5d 0a20  1,) + size[i:]. 
+000257c0: 2020 2072 6574 7572 6e20 7369 7a65 0a0a     return size..
+000257d0: 636c 6173 7320 5465 6e73 6f72 2874 6f72  class Tensor(tor
+000257e0: 6368 2e54 656e 736f 7229 3a0a 2020 2020  ch.Tensor):.    
+000257f0: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
+00025800: 6f64 0a20 2020 2064 6566 205f 6d61 6b65  od.    def _make
+00025810: 5f73 7562 636c 6173 7328 636c 732c 200a  _subclass(cls, .
+00025820: 2020 2020 2020 2020 746f 7263 685f 7465          torch_te
+00025830: 6e73 6f72 2c20 7265 7175 6972 6573 5f67  nsor, requires_g
+00025840: 7261 643d 4e6f 6e65 2c20 6465 7669 6365  rad=None, device
+00025850: 3d4e 6f6e 652c 200a 2020 2020 2020 2020  =None, .        
+00025860: 7769 7468 5f66 756e 633d 4e6f 6e65 2c20  with_func=None, 
+00025870: 6675 6e63 5f64 696d 3d76 6f69 642c 2073  func_dim=void, s
+00025880: 7a5f 6675 6e63 5f64 696d 3d4e 6f6e 652c  z_func_dim=None,
+00025890: 0a20 2020 2020 2020 2077 6974 685f 6261  .        with_ba
+000258a0: 7463 683d 4e6f 6e65 2c20 6261 7463 685f  tch=None, batch_
+000258b0: 6469 6d3d 766f 6964 2c20 737a 5f62 6174  dim=void, sz_bat
+000258c0: 6368 5f64 696d 3d4e 6f6e 652c 0a20 2020  ch_dim=None,.   
+000258d0: 2020 2020 2077 6974 685f 6368 616e 6e65       with_channe
+000258e0: 6c3d 4e6f 6e65 2c20 6368 616e 6e65 6c5f  l=None, channel_
+000258f0: 6469 6d3d 766f 6964 2c20 6e5f 6665 6174  dim=void, n_feat
+00025900: 7572 655f 6469 6d3d 4e6f 6e65 2c0a 2020  ure_dim=None,.  
+00025910: 2020 2020 2020 7769 7468 5f66 6561 7475        with_featu
+00025920: 7265 3d4e 6f6e 652c 2066 6561 7475 7265  re=None, feature
+00025930: 5f64 696d 3d76 6f69 642c 2073 7a5f 6665  _dim=void, sz_fe
+00025940: 6174 7572 655f 6469 6d3d 4e6f 6e65 2c0a  ature_dim=None,.
+00025950: 2020 2020 2020 2020 7769 7468 5f73 6571          with_seq
+00025960: 7565 6e63 653d 4e6f 6e65 2c20 7365 7175  uence=None, sequ
+00025970: 656e 6365 5f64 696d 3d76 6f69 642c 206e  ence_dim=void, n
+00025980: 5f73 6571 7565 6e63 655f 6469 6d3d 4e6f  _sequence_dim=No
+00025990: 6e65 2c0a 2020 2020 2020 2020 737a 5f73  ne,.        sz_s
+000259a0: 6571 7565 6e63 655f 6469 6d3d 4e6f 6e65  equence_dim=None
+000259b0: 2c20 7265 665f 7369 7a65 3d4e 6f6e 650a  , ref_size=None.
+000259c0: 2020 2020 293a 0a20 2020 2020 2020 2023      ):.        #
+000259d0: 2046 6972 7374 206d 6f76 6520 7468 6520   First move the 
+000259e0: 6461 7461 2074 6f20 6465 7669 6365 2c20  data to device, 
+000259f0: 656c 696d 696e 6174 696e 6720 6172 6775  eliminating argu
+00025a00: 6d65 6e74 2027 6465 7669 6365 270a 2020  ment 'device'.  
+00025a10: 2020 2020 2020 6966 2064 6576 6963 6520        if device 
+00025a20: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+00025a30: 746f 7263 685f 7465 6e73 6f72 2e64 6576  torch_tensor.dev
+00025a40: 6963 6520 213d 2064 6576 6963 653a 0a20  ice != device:. 
+00025a50: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00025a60: 696e 7374 616e 6365 2864 6576 6963 652c  instance(device,
+00025a70: 2041 7574 6f44 6576 6963 6529 3a20 6465   AutoDevice): de
+00025a80: 7669 6365 203d 2064 6576 6963 652e 6d61  vice = device.ma
+00025a90: 696e 5f64 6576 6963 650a 2020 2020 2020  in_device.      
+00025aa0: 2020 2020 2020 746f 7263 685f 7465 6e73        torch_tens
+00025ab0: 6f72 203d 2074 6f72 6368 5f74 656e 736f  or = torch_tenso
+00025ac0: 722e 746f 2864 6576 6963 6529 0a20 2020  r.to(device).   
+00025ad0: 2020 2020 2069 6620 7265 7175 6972 6573       if requires
+00025ae0: 5f67 7261 6420 6973 204e 6f6e 653a 2072  _grad is None: r
+00025af0: 6571 7569 7265 735f 6772 6164 203d 2074  equires_grad = t
+00025b00: 6f72 6368 5f74 656e 736f 722e 7265 7175  orch_tensor.requ
+00025b10: 6972 6573 5f67 7261 640a 2020 2020 2020  ires_grad.      
+00025b20: 2020 2320 4372 6561 7465 2074 6865 2072    # Create the r
+00025b30: 6573 756c 7469 6e67 2074 656e 736f 720a  esulting tensor.
+00025b40: 2020 2020 2020 2020 6966 2074 6f72 6368          if torch
+00025b50: 5f74 656e 736f 722e 5f5f 636c 6173 735f  _tensor.__class_
+00025b60: 5f20 3d3d 2063 6c73 3a20 7365 6c66 203d  _ == cls: self =
+00025b70: 2074 6f72 6368 5f74 656e 736f 722e 636c   torch_tensor.cl
+00025b80: 6f6e 6528 290a 2020 2020 2020 2020 656c  one().        el
+00025b90: 7365 3a20 7365 6c66 203d 2074 6f72 6368  se: self = torch
+00025ba0: 2e54 656e 736f 722e 5f6d 616b 655f 7375  .Tensor._make_su
+00025bb0: 6263 6c61 7373 2863 6c73 2c20 746f 7263  bclass(cls, torc
+00025bc0: 685f 7465 6e73 6f72 2c20 7265 7175 6972  h_tensor, requir
+00025bd0: 6573 5f67 7261 6429 0a20 2020 2020 2020  es_grad).       
+00025be0: 2023 2043 6f6d 7072 6573 7320 7468 6520   # Compress the 
+00025bf0: 636f 6e74 726f 6c6c 6572 2061 7267 756d  controller argum
+00025c00: 656e 7473 2069 6e74 6f20 737a 206e 756d  ents into sz num
+00025c10: 6265 7273 0a20 2020 2020 2020 206e 5f64  bers.        n_d
+00025c20: 696d 203d 2073 656c 662e 6e64 696d 0a20  im = self.ndim. 
+00025c30: 2020 2020 2020 2069 6620 6e6f 7420 6861         if not ha
+00025c40: 7361 7474 7228 7365 6c66 2c20 2773 7a5f  sattr(self, 'sz_
+00025c50: 6675 6e63 5f64 696d 2729 3a20 7365 6c66  func_dim'): self
+00025c60: 2e73 7a5f 6675 6e63 5f64 696d 203d 2030  .sz_func_dim = 0
+00025c70: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00025c80: 6861 7361 7474 7228 7365 6c66 2c20 2773  hasattr(self, 's
+00025c90: 7a5f 6261 7463 685f 6469 6d27 293a 2073  z_batch_dim'): s
+00025ca0: 656c 662e 737a 5f62 6174 6368 5f64 696d  elf.sz_batch_dim
+00025cb0: 203d 2030 0a20 2020 2020 2020 2069 6620   = 0.        if 
+00025cc0: 6e6f 7420 6861 7361 7474 7228 7365 6c66  not hasattr(self
+00025cd0: 2c20 2773 7a5f 6665 6174 7572 655f 6469  , 'sz_feature_di
+00025ce0: 6d27 293a 2073 656c 662e 737a 5f66 6561  m'): self.sz_fea
+00025cf0: 7475 7265 5f64 696d 203d 2030 0a20 2020  ture_dim = 0.   
+00025d00: 2020 2020 2069 6620 6e6f 7420 6861 7361       if not hasa
+00025d10: 7474 7228 7365 6c66 2c20 2773 7a5f 7365  ttr(self, 'sz_se
+00025d20: 7175 656e 6365 5f64 696d 2729 3a20 7365  quence_dim'): se
+00025d30: 6c66 2e73 7a5f 7365 7175 656e 6365 5f64  lf.sz_sequence_d
+00025d40: 696d 203d 2030 0a20 2020 2020 2020 2061  im = 0.        a
+00025d50: 766f 7563 6828 7375 6d5f 285b 7769 7468  vouch(sum_([with
+00025d60: 5f66 756e 6320 6973 206e 6f74 204e 6f6e  _func is not Non
+00025d70: 652c 2066 756e 635f 6469 6d20 213d 2076  e, func_dim != v
+00025d80: 6f69 642c 2073 7a5f 6675 6e63 5f64 696d  oid, sz_func_dim
+00025d90: 2069 7320 6e6f 7420 4e6f 6e65 2c20 7265   is not None, re
+00025da0: 665f 7369 7a65 2069 7320 6e6f 7420 4e6f  f_size is not No
+00025db0: 6e65 2061 6e64 2072 6566 5f73 697a 652e  ne and ref_size.
+00025dc0: 737a 5f66 756e 635f 6469 6d20 213d 2030  sz_func_dim != 0
+00025dd0: 5d29 203c 3d20 312c 2022 4f6e 6c79 206f  ]) <= 1, "Only o
+00025de0: 6e65 2069 6e70 7574 2069 7320 6163 6365  ne input is acce
+00025df0: 7074 6564 2069 6e20 2777 6974 685f 6675  pted in 'with_fu
+00025e00: 6e63 272c 2027 6675 6e63 5f64 696d 272c  nc', 'func_dim',
+00025e10: 2027 737a 5f66 756e 635f 6469 6d27 2061   'sz_func_dim' a
+00025e20: 6e64 2027 7265 665f 7369 7a65 272e 2022  nd 'ref_size'. "
+00025e30: 290a 2020 2020 2020 2020 6176 6f75 6368  ).        avouch
+00025e40: 2873 756d 5f28 5b77 6974 685f 6261 7463  (sum_([with_batc
+00025e50: 6820 6973 206e 6f74 204e 6f6e 652c 2062  h is not None, b
+00025e60: 6174 6368 5f64 696d 2021 3d20 766f 6964  atch_dim != void
+00025e70: 2c20 737a 5f62 6174 6368 5f64 696d 2069  , sz_batch_dim i
+00025e80: 7320 6e6f 7420 4e6f 6e65 2c20 7265 665f  s not None, ref_
+00025e90: 7369 7a65 2069 7320 6e6f 7420 4e6f 6e65  size is not None
+00025ea0: 2061 6e64 2072 6566 5f73 697a 652e 737a   and ref_size.sz
+00025eb0: 5f62 6174 6368 5f64 696d 2021 3d20 305d  _batch_dim != 0]
+00025ec0: 2920 3c3d 2031 2c20 224f 6e6c 7920 6f6e  ) <= 1, "Only on
+00025ed0: 6520 696e 7075 7420 6973 2061 6363 6570  e input is accep
+00025ee0: 7465 6420 696e 2027 7769 7468 5f62 6174  ted in 'with_bat
+00025ef0: 6368 272c 2027 6261 7463 685f 6469 6d27  ch', 'batch_dim'
+00025f00: 2c20 2773 7a5f 6261 7463 685f 6469 6d27  , 'sz_batch_dim'
+00025f10: 2061 6e64 2027 7265 665f 7369 7a65 272e   and 'ref_size'.
+00025f20: 2022 290a 2020 2020 2020 2020 6176 6f75   ").        avou
+00025f30: 6368 2873 756d 5f28 5b77 6974 685f 6368  ch(sum_([with_ch
+00025f40: 616e 6e65 6c20 6973 206e 6f74 204e 6f6e  annel is not Non
+00025f50: 652c 2077 6974 685f 6665 6174 7572 6520  e, with_feature 
+00025f60: 6973 206e 6f74 204e 6f6e 652c 2063 6861  is not None, cha
+00025f70: 6e6e 656c 5f64 696d 2021 3d20 766f 6964  nnel_dim != void
+00025f80: 2c20 6665 6174 7572 655f 6469 6d20 213d  , feature_dim !=
+00025f90: 2076 6f69 642c 206e 5f66 6561 7475 7265   void, n_feature
+00025fa0: 5f64 696d 2069 7320 6e6f 7420 4e6f 6e65  _dim is not None
+00025fb0: 2c20 737a 5f66 6561 7475 7265 5f64 696d  , sz_feature_dim
+00025fc0: 2069 7320 6e6f 7420 4e6f 6e65 2c20 7265   is not None, re
+00025fd0: 665f 7369 7a65 2069 7320 6e6f 7420 4e6f  f_size is not No
+00025fe0: 6e65 2061 6e64 2072 6566 5f73 697a 652e  ne and ref_size.
+00025ff0: 737a 5f66 6561 7475 7265 5f64 696d 2021  sz_feature_dim !
+00026000: 3d20 305d 2920 3c3d 2031 2c20 224f 6e6c  = 0]) <= 1, "Onl
+00026010: 7920 6f6e 6520 696e 7075 7420 6973 2061  y one input is a
+00026020: 6363 6570 7465 6420 696e 2027 7769 7468  ccepted in 'with
+00026030: 5f63 6861 6e6e 656c 272c 2027 7769 7468  _channel', 'with
+00026040: 5f66 6561 7475 7265 272c 2027 6368 616e  _feature', 'chan
+00026050: 6e65 6c5f 6469 6d27 2c20 2766 6561 7475  nel_dim', 'featu
+00026060: 7265 5f64 696d 272c 2027 6e5f 6665 6174  re_dim', 'n_feat
+00026070: 7572 655f 6469 6d27 2c20 2773 7a5f 6665  ure_dim', 'sz_fe
+00026080: 6174 7572 655f 6469 6d27 2c20 616e 6420  ature_dim', and 
+00026090: 2772 6566 5f73 697a 6527 2e20 2229 0a20  'ref_size'. "). 
+000260a0: 2020 2020 2020 2061 766f 7563 6828 7375         avouch(su
+000260b0: 6d5f 285b 7769 7468 5f73 6571 7565 6e63  m_([with_sequenc
+000260c0: 6520 6973 206e 6f74 204e 6f6e 652c 2073  e is not None, s
+000260d0: 6571 7565 6e63 655f 6469 6d20 213d 2076  equence_dim != v
+000260e0: 6f69 642c 206e 5f73 6571 7565 6e63 655f  oid, n_sequence_
+000260f0: 6469 6d20 6973 206e 6f74 204e 6f6e 652c  dim is not None,
+00026100: 2073 7a5f 7365 7175 656e 6365 5f64 696d   sz_sequence_dim
+00026110: 2069 7320 6e6f 7420 4e6f 6e65 2c20 7265   is not None, re
+00026120: 665f 7369 7a65 2069 7320 6e6f 7420 4e6f  f_size is not No
+00026130: 6e65 2061 6e64 2072 6566 5f73 697a 652e  ne and ref_size.
+00026140: 737a 5f73 6571 7565 6e63 655f 6469 6d20  sz_sequence_dim 
+00026150: 213d 2030 5d29 203c 3d20 312c 2022 4f6e  != 0]) <= 1, "On
+00026160: 6c79 206f 6e65 2069 6e70 7574 2069 7320  ly one input is 
+00026170: 6163 6365 7074 6564 2069 6e20 2777 6974  accepted in 'wit
+00026180: 685f 7365 7175 656e 6365 272c 2027 7365  h_sequence', 'se
+00026190: 7175 656e 6365 5f64 696d 272c 2027 6e5f  quence_dim', 'n_
+000261a0: 7365 7175 656e 6365 5f64 696d 272c 2027  sequence_dim', '
+000261b0: 737a 5f73 6571 7565 6e63 655f 6469 6d27  sz_sequence_dim'
+000261c0: 2c20 616e 6420 2772 6566 5f73 697a 6527  , and 'ref_size'
+000261d0: 2e20 2229 0a20 2020 2020 2020 2069 6620  . ").        if 
+000261e0: 7769 7468 5f66 756e 6320 6973 206e 6f74  with_func is not
+000261f0: 204e 6f6e 653a 2073 656c 662e 737a 5f66   None: self.sz_f
+00026200: 756e 635f 6469 6d20 3d20 696e 745f 2877  unc_dim = int_(w
+00026210: 6974 685f 6675 6e63 290a 2020 2020 2020  ith_func).      
+00026220: 2020 656c 6966 2066 756e 635f 6469 6d20    elif func_dim 
+00026230: 213d 2076 6f69 643a 0a20 2020 2020 2020  != void:.       
+00026240: 2020 2020 2063 616e 6473 203d 2028 302c       cands = (0,
+00026250: 202d 6e5f 6469 6d2c 206e 5f64 696d 2d31   -n_dim, n_dim-1
+00026260: 2c20 2d31 290a 2020 2020 2020 2020 2020  , -1).          
+00026270: 2020 6176 6f75 6368 2866 756e 635f 6469    avouch(func_di
+00026280: 6d20 696e 2063 616e 6473 2c20 5479 7065  m in cands, Type
+00026290: 4572 726f 7228 6622 2766 756e 635f 6469  Error(f"'func_di
+000262a0: 6d27 2066 6f72 2074 656e 736f 7220 7368  m' for tensor sh
+000262b0: 6f75 6c64 2062 6520 6f6e 6520 6f66 207b  ould be one of {
+000262c0: 6361 6e64 735b 305d 7d20 616e 6420 7b63  cands[0]} and {c
+000262d0: 616e 6473 5b2d 315d 7d2e 2022 2929 0a20  ands[-1]}. ")). 
+000262e0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000262f0: 737a 5f66 756e 635f 6469 6d20 3d20 3120  sz_func_dim = 1 
+00026300: 6966 2066 756e 635f 6469 6d20 696e 2063  if func_dim in c
+00026310: 616e 6473 5b3a 325d 2065 6c73 6520 2d31  ands[:2] else -1
+00026320: 0a20 2020 2020 2020 2065 6c69 6620 737a  .        elif sz
+00026330: 5f66 756e 635f 6469 6d20 6973 206e 6f74  _func_dim is not
+00026340: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00026350: 2020 2061 766f 7563 6828 737a 5f66 756e     avouch(sz_fun
+00026360: 635f 6469 6d20 696e 2028 302c 2031 2c20  c_dim in (0, 1, 
+00026370: 2d31 292c 2054 7970 6545 7272 6f72 2822  -1), TypeError("
+00026380: 2773 7a5f 6675 6e63 5f64 696d 2720 666f  'sz_func_dim' fo
+00026390: 7220 7465 6e73 6f72 2073 686f 756c 6420  r tensor should 
+000263a0: 6265 206f 6e65 206f 6620 2830 2c20 312c  be one of (0, 1,
+000263b0: 202d 3129 2e20 2229 290a 2020 2020 2020   -1). ")).      
+000263c0: 2020 2020 2020 7365 6c66 2e73 7a5f 6675        self.sz_fu
+000263d0: 6e63 5f64 696d 203d 2073 7a5f 6675 6e63  nc_dim = sz_func
+000263e0: 5f64 696d 0a20 2020 2020 2020 2065 6c69  _dim.        eli
+000263f0: 6620 7265 665f 7369 7a65 2069 7320 6e6f  f ref_size is no
+00026400: 7420 4e6f 6e65 2061 6e64 2072 6566 5f73  t None and ref_s
+00026410: 697a 652e 737a 5f66 756e 635f 6469 6d20  ize.sz_func_dim 
+00026420: 213d 2030 3a20 7365 6c66 2e73 7a5f 6675  != 0: self.sz_fu
+00026430: 6e63 5f64 696d 203d 2072 6566 5f73 697a  nc_dim = ref_siz
+00026440: 652e 737a 5f66 756e 635f 6469 6d0a 2020  e.sz_func_dim.  
+00026450: 2020 2020 2020 6966 2077 6974 685f 6261        if with_ba
+00026460: 7463 6820 6973 206e 6f74 204e 6f6e 653a  tch is not None:
+00026470: 2073 656c 662e 737a 5f62 6174 6368 5f64   self.sz_batch_d
+00026480: 696d 203d 2069 6e74 5f28 7769 7468 5f62  im = int_(with_b
+00026490: 6174 6368 290a 2020 2020 2020 2020 656c  atch).        el
+000264a0: 6966 2062 6174 6368 5f64 696d 2021 3d20  if batch_dim != 
+000264b0: 766f 6964 3a0a 2020 2020 2020 2020 2020  void:.          
+000264c0: 2020 6361 6e64 7320 3d20 286d 6178 5f28    cands = (max_(
+000264d0: 7365 6c66 2e73 7a5f 6675 6e63 5f64 696d  self.sz_func_dim
+000264e0: 2c20 3029 2c20 6d61 785f 2873 656c 662e  , 0), max_(self.
+000264f0: 737a 5f66 756e 635f 6469 6d2c 2030 292d  sz_func_dim, 0)-
+00026500: 6e5f 6469 6d2c 206e 5f64 696d 2d31 2b6d  n_dim, n_dim-1+m
+00026510: 696e 5f28 7365 6c66 2e73 7a5f 6675 6e63  in_(self.sz_func
+00026520: 5f64 696d 2c20 3029 2c20 2d31 2b6d 696e  _dim, 0), -1+min
+00026530: 5f28 7365 6c66 2e73 7a5f 6675 6e63 5f64  _(self.sz_func_d
+00026540: 696d 2c20 3029 290a 2020 2020 2020 2020  im, 0)).        
+00026550: 2020 2020 6176 6f75 6368 2862 6174 6368      avouch(batch
+00026560: 5f64 696d 2069 6e20 6361 6e64 732c 2054  _dim in cands, T
+00026570: 7970 6545 7272 6f72 2866 2227 6261 7463  ypeError(f"'batc
+00026580: 685f 6469 6d27 2066 6f72 2074 656e 736f  h_dim' for tenso
+00026590: 7220 7368 6f75 6c64 2062 6520 6f6e 6520  r should be one 
+000265a0: 6f66 207b 6361 6e64 735b 305d 7d20 616e  of {cands[0]} an
+000265b0: 6420 7b63 616e 6473 5b2d 315d 7d2e 2022  d {cands[-1]}. "
+000265c0: 2929 0a20 2020 2020 2020 2020 2020 2073  )).            s
+000265d0: 656c 662e 737a 5f62 6174 6368 5f64 696d  elf.sz_batch_dim
+000265e0: 203d 2031 2069 6620 6261 7463 685f 6469   = 1 if batch_di
+000265f0: 6d20 696e 2063 616e 6473 5b3a 325d 2065  m in cands[:2] e
+00026600: 6c73 6520 2d31 0a20 2020 2020 2020 2065  lse -1.        e
+00026610: 6c69 6620 737a 5f62 6174 6368 5f64 696d  lif sz_batch_dim
+00026620: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00026630: 2020 2020 2020 2020 2020 6176 6f75 6368            avouch
+00026640: 2873 7a5f 6261 7463 685f 6469 6d20 696e  (sz_batch_dim in
+00026650: 2028 302c 2031 2c20 2d31 292c 2054 7970   (0, 1, -1), Typ
+00026660: 6545 7272 6f72 2822 2773 7a5f 6261 7463  eError("'sz_batc
+00026670: 685f 6469 6d27 2066 6f72 2074 656e 736f  h_dim' for tenso
+00026680: 7220 7368 6f75 6c64 2062 6520 6f6e 6520  r should be one 
+00026690: 6f66 2028 302c 2031 2c20 2d31 292e 2022  of (0, 1, -1). "
+000266a0: 2929 0a20 2020 2020 2020 2020 2020 2073  )).            s
+000266b0: 656c 662e 737a 5f62 6174 6368 5f64 696d  elf.sz_batch_dim
+000266c0: 203d 2073 7a5f 6261 7463 685f 6469 6d0a   = sz_batch_dim.
+000266d0: 2020 2020 2020 2020 656c 6966 2072 6566          elif ref
+000266e0: 5f73 697a 6520 6973 206e 6f74 204e 6f6e  _size is not Non
+000266f0: 6520 616e 6420 7265 665f 7369 7a65 2e73  e and ref_size.s
+00026700: 7a5f 6261 7463 685f 6469 6d20 213d 2030  z_batch_dim != 0
+00026710: 3a20 7365 6c66 2e73 7a5f 6261 7463 685f  : self.sz_batch_
+00026720: 6469 6d20 3d20 7265 665f 7369 7a65 2e73  dim = ref_size.s
+00026730: 7a5f 6261 7463 685f 6469 6d0a 2020 2020  z_batch_dim.    
+00026740: 2020 2020 6966 2077 6974 685f 6368 616e      if with_chan
+00026750: 6e65 6c20 6973 206e 6f74 204e 6f6e 653a  nel is not None:
+00026760: 2073 656c 662e 737a 5f66 6561 7475 7265   self.sz_feature
+00026770: 5f64 696d 203d 2069 6e74 5f28 7769 7468  _dim = int_(with
+00026780: 5f63 6861 6e6e 656c 290a 2020 2020 2020  _channel).      
+00026790: 2020 656c 6966 2077 6974 685f 6665 6174    elif with_feat
+000267a0: 7572 6520 6973 206e 6f74 204e 6f6e 653a  ure is not None:
+000267b0: 2073 656c 662e 737a 5f66 6561 7475 7265   self.sz_feature
+000267c0: 5f64 696d 203d 2069 6e74 5f28 7769 7468  _dim = int_(with
+000267d0: 5f66 6561 7475 7265 290a 2020 2020 2020  _feature).      
+000267e0: 2020 656c 6966 2063 6861 6e6e 656c 5f64    elif channel_d
+000267f0: 696d 2021 3d20 766f 6964 3a0a 2020 2020  im != void:.    
+00026800: 2020 2020 2020 2020 6361 6e64 7320 3d20          cands = 
+00026810: 286d 6178 5f28 7365 6c66 2e73 7a5f 6675  (max_(self.sz_fu
+00026820: 6e63 5f64 696d 2c20 3029 2b6d 6178 5f28  nc_dim, 0)+max_(
+00026830: 7365 6c66 2e73 7a5f 6261 7463 685f 6469  self.sz_batch_di
+00026840: 6d2c 2030 292c 200a 2020 2020 2020 2020  m, 0), .        
+00026850: 2020 2020 2020 2020 2020 2020 206d 6178               max
+00026860: 5f28 7365 6c66 2e73 7a5f 6675 6e63 5f64  _(self.sz_func_d
+00026870: 696d 2c20 3029 2b6d 6178 5f28 7365 6c66  im, 0)+max_(self
+00026880: 2e73 7a5f 6261 7463 685f 6469 6d2c 2030  .sz_batch_dim, 0
+00026890: 292d 6e5f 6469 6d2c 200a 2020 2020 2020  )-n_dim, .      
+000268a0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000268b0: 5f64 696d 2d31 2b6d 696e 5f28 7365 6c66  _dim-1+min_(self
+000268c0: 2e73 7a5f 6675 6e63 5f64 696d 2c20 3029  .sz_func_dim, 0)
+000268d0: 2b6d 696e 5f28 7365 6c66 2e73 7a5f 6261  +min_(self.sz_ba
+000268e0: 7463 685f 6469 6d2c 2030 292c 200a 2020  tch_dim, 0), .  
+000268f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026900: 2020 202d 312b 6d69 6e5f 2873 656c 662e     -1+min_(self.
+00026910: 737a 5f66 756e 635f 6469 6d2c 2030 292b  sz_func_dim, 0)+
+00026920: 6d69 6e5f 2873 656c 662e 737a 5f62 6174  min_(self.sz_bat
+00026930: 6368 5f64 696d 2c20 3029 290a 2020 2020  ch_dim, 0)).    
+00026940: 2020 2020 2020 2020 6176 6f75 6368 2863          avouch(c
+00026950: 6861 6e6e 656c 5f64 696d 2069 6e20 6361  hannel_dim in ca
+00026960: 6e64 732c 2054 7970 6545 7272 6f72 2866  nds, TypeError(f
+00026970: 2227 6368 616e 6e65 6c5f 6469 6d27 2066  "'channel_dim' f
+00026980: 6f72 2074 656e 736f 7220 7368 6f75 6c64  or tensor should
+00026990: 2062 6520 6f6e 6520 6f66 207b 6361 6e64   be one of {cand
+000269a0: 735b 305d 7d20 616e 6420 7b63 616e 6473  s[0]} and {cands
+000269b0: 5b2d 315d 7d2e 2022 2929 0a20 2020 2020  [-1]}. ")).     
+000269c0: 2020 2020 2020 2073 656c 662e 737a 5f66         self.sz_f
+000269d0: 6561 7475 7265 5f64 696d 203d 2031 2069  eature_dim = 1 i
+000269e0: 6620 6368 616e 6e65 6c5f 6469 6d20 696e  f channel_dim in
+000269f0: 2063 616e 6473 5b3a 325d 2065 6c73 6520   cands[:2] else 
+00026a00: 2d31 0a20 2020 2020 2020 2065 6c69 6620  -1.        elif 
+00026a10: 6665 6174 7572 655f 6469 6d20 213d 2076  feature_dim != v
+00026a20: 6f69 643a 0a20 2020 2020 2020 2020 2020  oid:.           
+00026a30: 2063 616e 6473 203d 2028 6d61 785f 2873   cands = (max_(s
+00026a40: 656c 662e 737a 5f66 756e 635f 6469 6d2c  elf.sz_func_dim,
+00026a50: 2030 292b 6d61 785f 2873 656c 662e 737a   0)+max_(self.sz
+00026a60: 5f62 6174 6368 5f64 696d 2c20 3029 2c20  _batch_dim, 0), 
+00026a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026a80: 2020 2020 2020 6d61 785f 2873 656c 662e        max_(self.
+00026a90: 737a 5f66 756e 635f 6469 6d2c 2030 292b  sz_func_dim, 0)+
+00026aa0: 6d61 785f 2873 656c 662e 737a 5f62 6174  max_(self.sz_bat
+00026ab0: 6368 5f64 696d 2c20 3029 2d6e 5f64 696d  ch_dim, 0)-n_dim
+00026ac0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+00026ad0: 2020 2020 2020 2020 6e5f 6469 6d2d 312b          n_dim-1+
+00026ae0: 6d69 6e5f 2873 656c 662e 737a 5f66 756e  min_(self.sz_fun
+00026af0: 635f 6469 6d2c 2030 292b 6d69 6e5f 2873  c_dim, 0)+min_(s
+00026b00: 656c 662e 737a 5f62 6174 6368 5f64 696d  elf.sz_batch_dim
+00026b10: 2c20 3029 2c20 0a20 2020 2020 2020 2020  , 0), .         
+00026b20: 2020 2020 2020 2020 2020 2020 2d31 2b6d              -1+m
+00026b30: 696e 5f28 7365 6c66 2e73 7a5f 6675 6e63  in_(self.sz_func
+00026b40: 5f64 696d 2c20 3029 2b6d 696e 5f28 7365  _dim, 0)+min_(se
+00026b50: 6c66 2e73 7a5f 6261 7463 685f 6469 6d2c  lf.sz_batch_dim,
+00026b60: 2030 2929 0a20 2020 2020 2020 2020 2020   0)).           
+00026b70: 2061 766f 7563 6828 6665 6174 7572 655f   avouch(feature_
+00026b80: 6469 6d20 696e 2063 616e 6473 2c20 5479  dim in cands, Ty
+00026b90: 7065 4572 726f 7228 6622 2766 6561 7475  peError(f"'featu
+00026ba0: 7265 5f64 696d 2720 666f 7220 7465 6e73  re_dim' for tens
+00026bb0: 6f72 2073 686f 756c 6420 6265 206f 6e65  or should be one
+00026bc0: 206f 6620 7b63 616e 6473 5b30 5d7d 2061   of {cands[0]} a
+00026bd0: 6e64 207b 6361 6e64 735b 2d31 5d7d 2e20  nd {cands[-1]}. 
+00026be0: 2229 290a 2020 2020 2020 2020 2020 2020  ")).            
+00026bf0: 7365 6c66 2e73 7a5f 6665 6174 7572 655f  self.sz_feature_
+00026c00: 6469 6d20 3d20 3120 6966 2066 6561 7475  dim = 1 if featu
+00026c10: 7265 5f64 696d 2069 6e20 6361 6e64 735b  re_dim in cands[
+00026c20: 3a32 5d20 656c 7365 202d 310a 2020 2020  :2] else -1.    
+00026c30: 2020 2020 656c 6966 206e 5f66 6561 7475      elif n_featu
+00026c40: 7265 5f64 696d 2069 7320 6e6f 7420 4e6f  re_dim is not No
+00026c50: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00026c60: 6176 6f75 6368 2869 7369 6e73 7461 6e63  avouch(isinstanc
+00026c70: 6528 6e5f 6665 6174 7572 655f 6469 6d2c  e(n_feature_dim,
+00026c80: 2069 6e74 5f29 2061 6e64 206e 5f66 6561   int_) and n_fea
+00026c90: 7475 7265 5f64 696d 203e 3d20 302c 2054  ture_dim >= 0, T
+00026ca0: 7970 6545 7272 6f72 2866 2227 6e5f 6665  ypeError(f"'n_fe
+00026cb0: 6174 7572 655f 6469 6d27 2066 6f72 2074  ature_dim' for t
+00026cc0: 656e 736f 7220 7368 6f75 6c64 2062 6520  ensor should be 
+00026cd0: 6e6f 6e2d 6e65 6761 7469 7665 2069 6e74  non-negative int
+00026ce0: 6567 6572 2c20 6e6f 7420 7b6e 5f66 6561  eger, not {n_fea
+00026cf0: 7475 7265 5f64 696d 7d2e 2022 2929 0a20  ture_dim}. ")). 
+00026d00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00026d10: 737a 5f66 6561 7475 7265 5f64 696d 203d  sz_feature_dim =
+00026d20: 206e 5f66 6561 7475 7265 5f64 696d 0a20   n_feature_dim. 
+00026d30: 2020 2020 2020 2065 6c69 6620 737a 5f66         elif sz_f
+00026d40: 6561 7475 7265 5f64 696d 2069 7320 6e6f  eature_dim is no
+00026d50: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00026d60: 2020 2020 6176 6f75 6368 2869 7369 6e73      avouch(isins
+00026d70: 7461 6e63 6528 737a 5f66 6561 7475 7265  tance(sz_feature
+00026d80: 5f64 696d 2c20 696e 745f 292c 2054 7970  _dim, int_), Typ
+00026d90: 6545 7272 6f72 2866 2227 737a 5f66 6561  eError(f"'sz_fea
+00026da0: 7475 7265 5f64 696d 2720 666f 7220 7465  ture_dim' for te
+00026db0: 6e73 6f72 2073 686f 756c 6420 6265 2061  nsor should be a
+00026dc0: 6e20 696e 7465 6765 722c 206e 6f74 207b  n integer, not {
+00026dd0: 737a 5f66 6561 7475 7265 5f64 696d 7d2e  sz_feature_dim}.
+00026de0: 2022 2929 0a20 2020 2020 2020 2020 2020   ")).           
+00026df0: 2073 656c 662e 737a 5f66 6561 7475 7265   self.sz_feature
+00026e00: 5f64 696d 203d 2073 7a5f 6665 6174 7572  _dim = sz_featur
+00026e10: 655f 6469 6d0a 2020 2020 2020 2020 656c  e_dim.        el
+00026e20: 6966 2072 6566 5f73 697a 6520 6973 206e  if ref_size is n
+00026e30: 6f74 204e 6f6e 6520 616e 6420 7265 665f  ot None and ref_
+00026e40: 7369 7a65 2e73 7a5f 6665 6174 7572 655f  size.sz_feature_
+00026e50: 6469 6d20 213d 2030 3a20 7365 6c66 2e73  dim != 0: self.s
+00026e60: 7a5f 6665 6174 7572 655f 6469 6d20 3d20  z_feature_dim = 
+00026e70: 7265 665f 7369 7a65 2e73 7a5f 6665 6174  ref_size.sz_feat
+00026e80: 7572 655f 6469 6d0a 2020 2020 2020 2020  ure_dim.        
+00026e90: 6966 2077 6974 685f 7365 7175 656e 6365  if with_sequence
+00026ea0: 2069 7320 6e6f 7420 4e6f 6e65 3a20 7365   is not None: se
+00026eb0: 6c66 2e73 7a5f 7365 7175 656e 6365 5f64  lf.sz_sequence_d
+00026ec0: 696d 203d 2069 6e74 5f28 7769 7468 5f73  im = int_(with_s
+00026ed0: 6571 7565 6e63 6529 0a20 2020 2020 2020  equence).       
+00026ee0: 2065 6c69 6620 7365 7175 656e 6365 5f64   elif sequence_d
+00026ef0: 696d 2021 3d20 766f 6964 3a0a 2020 2020  im != void:.    
+00026f00: 2020 2020 2020 2020 6361 6e64 7320 3d20          cands = 
+00026f10: 286d 6178 5f28 7365 6c66 2e73 7a5f 6675  (max_(self.sz_fu
+00026f20: 6e63 5f64 696d 2c20 3029 2b6d 6178 5f28  nc_dim, 0)+max_(
+00026f30: 7365 6c66 2e73 7a5f 6261 7463 685f 6469  self.sz_batch_di
+00026f40: 6d2c 2030 292b 6d61 785f 2873 656c 662e  m, 0)+max_(self.
+00026f50: 737a 5f66 6561 7475 7265 5f64 696d 2c20  sz_feature_dim, 
+00026f60: 3029 2c20 0a20 2020 2020 2020 2020 2020  0), .           
+00026f70: 2020 2020 2020 2020 2020 6d61 785f 2873            max_(s
+00026f80: 656c 662e 737a 5f66 756e 635f 6469 6d2c  elf.sz_func_dim,
+00026f90: 2030 292b 6d61 785f 2873 656c 662e 737a   0)+max_(self.sz
+00026fa0: 5f62 6174 6368 5f64 696d 2c20 3029 2b6d  _batch_dim, 0)+m
+00026fb0: 6178 5f28 7365 6c66 2e73 7a5f 6665 6174  ax_(self.sz_feat
+00026fc0: 7572 655f 6469 6d2c 2030 292d 6e5f 6469  ure_dim, 0)-n_di
+00026fd0: 6d2c 200a 2020 2020 2020 2020 2020 2020  m, .            
+00026fe0: 2020 2020 2020 2020 206e 5f64 696d 2d31           n_dim-1
+00026ff0: 2b6d 696e 5f28 7365 6c66 2e73 7a5f 6675  +min_(self.sz_fu
+00027000: 6e63 5f64 696d 2c20 3029 2b6d 696e 5f28  nc_dim, 0)+min_(
+00027010: 7365 6c66 2e73 7a5f 6261 7463 685f 6469  self.sz_batch_di
+00027020: 6d2c 2030 292b 6d69 6e5f 2873 656c 662e  m, 0)+min_(self.
+00027030: 737a 5f66 6561 7475 7265 5f64 696d 2c20  sz_feature_dim, 
+00027040: 3029 2c20 0a20 2020 2020 2020 2020 2020  0), .           
+00027050: 2020 2020 2020 2020 2020 2d31 2b6d 696e            -1+min
+00027060: 5f28 7365 6c66 2e73 7a5f 6675 6e63 5f64  _(self.sz_func_d
+00027070: 696d 2c20 3029 2b6d 696e 5f28 7365 6c66  im, 0)+min_(self
+00027080: 2e73 7a5f 6261 7463 685f 6469 6d2c 2030  .sz_batch_dim, 0
+00027090: 292b 6d69 6e5f 2873 656c 662e 737a 5f66  )+min_(self.sz_f
+000270a0: 6561 7475 7265 5f64 696d 2c20 3029 290a  eature_dim, 0)).
+000270b0: 2020 2020 2020 2020 2020 2020 6176 6f75              avou
+000270c0: 6368 2873 6571 7565 6e63 655f 6469 6d20  ch(sequence_dim 
+000270d0: 696e 2063 616e 6473 2c20 5479 7065 4572  in cands, TypeEr
+000270e0: 726f 7228 6622 2773 6571 7565 6e63 655f  ror(f"'sequence_
+000270f0: 6469 6d27 2066 6f72 2074 656e 736f 7220  dim' for tensor 
+00027100: 7368 6f75 6c64 2062 6520 6f6e 6520 6f66  should be one of
+00027110: 207b 6361 6e64 735b 305d 7d20 616e 6420   {cands[0]} and 
+00027120: 7b63 616e 6473 5b2d 315d 7d2e 2022 2929  {cands[-1]}. "))
+00027130: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00027140: 662e 737a 5f73 6571 7565 6e63 655f 6469  f.sz_sequence_di
+00027150: 6d20 3d20 3120 6966 2073 6571 7565 6e63  m = 1 if sequenc
+00027160: 655f 6469 6d20 696e 2063 616e 6473 5b3a  e_dim in cands[:
+00027170: 325d 2065 6c73 6520 2d31 0a20 2020 2020  2] else -1.     
+00027180: 2020 2065 6c69 6620 6e5f 7365 7175 656e     elif n_sequen
+00027190: 6365 5f64 696d 2069 7320 6e6f 7420 4e6f  ce_dim is not No
+000271a0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000271b0: 6176 6f75 6368 2869 7369 6e73 7461 6e63  avouch(isinstanc
+000271c0: 6528 6e5f 7365 7175 656e 6365 5f64 696d  e(n_sequence_dim
+000271d0: 2c20 696e 745f 2920 616e 6420 6e5f 7365  , int_) and n_se
+000271e0: 7175 656e 6365 5f64 696d 203e 3d20 302c  quence_dim >= 0,
+000271f0: 2054 7970 6545 7272 6f72 2866 2227 6e5f   TypeError(f"'n_
+00027200: 7365 7175 656e 6365 5f64 696d 2720 666f  sequence_dim' fo
+00027210: 7220 7465 6e73 6f72 2073 686f 756c 6420  r tensor should 
+00027220: 6265 206e 6f6e 2d6e 6567 6174 6976 6520  be non-negative 
+00027230: 696e 7465 6765 722c 206e 6f74 207b 6e5f  integer, not {n_
+00027240: 7365 7175 656e 6365 5f64 696d 7d2e 2022  sequence_dim}. "
+00027250: 2929 0a20 2020 2020 2020 2020 2020 2073  )).            s
+00027260: 656c 662e 737a 5f73 6571 7565 6e63 655f  elf.sz_sequence_
+00027270: 6469 6d20 3d20 2d6e 5f73 6571 7565 6e63  dim = -n_sequenc
+00027280: 655f 6469 6d0a 2020 2020 2020 2020 656c  e_dim.        el
+00027290: 6966 2073 7a5f 7365 7175 656e 6365 5f64  if sz_sequence_d
+000272a0: 696d 2069 7320 6e6f 7420 4e6f 6e65 3a0a  im is not None:.
+000272b0: 2020 2020 2020 2020 2020 2020 6176 6f75              avou
+000272c0: 6368 2869 7369 6e73 7461 6e63 6528 737a  ch(isinstance(sz
+000272d0: 5f73 6571 7565 6e63 655f 6469 6d2c 2069  _sequence_dim, i
+000272e0: 6e74 5f29 2c20 5479 7065 4572 726f 7228  nt_), TypeError(
+000272f0: 6622 2773 7a5f 7365 7175 656e 6365 5f64  f"'sz_sequence_d
+00027300: 696d 2720 666f 7220 7465 6e73 6f72 2073  im' for tensor s
+00027310: 686f 756c 6420 6265 2061 6e20 696e 7465  hould be an inte
+00027320: 6765 722c 206e 6f74 207b 737a 5f73 6571  ger, not {sz_seq
+00027330: 7565 6e63 655f 6469 6d7d 2e20 2229 290a  uence_dim}. ")).
+00027340: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00027350: 2e73 7a5f 7365 7175 656e 6365 5f64 696d  .sz_sequence_dim
+00027360: 203d 2073 7a5f 7365 7175 656e 6365 5f64   = sz_sequence_d
+00027370: 696d 0a20 2020 2020 2020 2065 6c69 6620  im.        elif 
+00027380: 7265 665f 7369 7a65 2069 7320 6e6f 7420  ref_size is not 
+00027390: 4e6f 6e65 2061 6e64 2072 6566 5f73 697a  None and ref_siz
+000273a0: 652e 737a 5f73 6571 7565 6e63 655f 6469  e.sz_sequence_di
+000273b0: 6d20 213d 2030 3a20 7365 6c66 2e73 7a5f  m != 0: self.sz_
+000273c0: 7365 7175 656e 6365 5f64 696d 203d 2072  sequence_dim = r
+000273d0: 6566 5f73 697a 652e 737a 5f73 6571 7565  ef_size.sz_seque
+000273e0: 6e63 655f 6469 6d0a 2020 2020 2020 2020  nce_dim.        
+000273f0: 7265 7475 726e 2073 656c 660a 2020 2020  return self.    
+00027400: 0a20 2020 2040 636f 6c6c 6563 745f 6d65  .    @collect_me
+00027410: 6d6f 7279 0a20 2020 2064 6566 205f 5f6e  mory.    def __n
+00027420: 6577 5f5f 2863 6c73 2c20 2a61 7267 732c  ew__(cls, *args,
+00027430: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+00027440: 2020 2020 2222 2262 742e 5465 6e73 6f72      """bt.Tensor
+00027450: 0a20 2020 2020 2020 2055 7361 6765 733a  .        Usages:
+00027460: 0a20 2020 2020 2020 2020 2020 2062 742e  .            bt.
+00027470: 5465 6e73 6f72 2874 656e 736f 723a 2074  Tensor(tensor: t
+00027480: 7570 6c65 2f6c 6973 742f 746f 7263 682e  uple/list/torch.
+00027490: 5465 6e73 6f72 2f62 742e 5465 6e73 6f72  Tensor/bt.Tensor
+000274a0: 2f28 7465 6e73 6f72 2077 6974 6820 2773  /(tensor with 's
+000274b0: 6861 7065 2729 2f28 7465 6e73 6f72 2077  hape')/(tensor w
+000274c0: 6974 6820 6d65 7468 6f64 2027 5f5f 7465  ith method '__te
+000274d0: 6e73 6f72 5f5f 2729 2c20 7265 7175 6972  nsor__'), requir
+000274e0: 6573 5f67 7261 643d 4e6f 6e65 2c20 6465  es_grad=None, de
+000274f0: 7669 6365 3d4e 6f6e 652c 202a 2a6b 7761  vice=None, **kwa
+00027500: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
+00027510: 2062 742e 5465 6e73 6f72 2873 6861 7065   bt.Tensor(shape
+00027520: 3a20 7475 706c 652c 2072 6571 7569 7265  : tuple, require
+00027530: 735f 6772 6164 3d4e 6f6e 652c 2064 6576  s_grad=None, dev
+00027540: 6963 653d 4e6f 6e65 2c20 2a2a 6b77 6172  ice=None, **kwar
+00027550: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+00027560: 6274 2e54 656e 736f 7228 2a73 6861 7065  bt.Tensor(*shape
+00027570: 3a20 696e 742c 2072 6571 7569 7265 735f  : int, requires_
+00027580: 6772 6164 3d4e 6f6e 652c 2064 6576 6963  grad=None, devic
+00027590: 653d 4e6f 6e65 2c20 2a2a 6b77 6172 6773  e=None, **kwargs
+000275a0: 290a 2020 2020 2020 2020 2020 2020 0a20  ).            . 
+000275b0: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+000275c0: 2020 2020 2020 2020 2074 656e 736f 7220           tensor 
+000275d0: 2874 7570 6c65 206f 7220 6c69 7374 206f  (tuple or list o
+000275e0: 7220 5465 6e73 6f72 293a 2043 7265 6174  r Tensor): Creat
+000275f0: 6520 6672 6f6d 2061 2074 656e 736f 7220  e from a tensor 
+00027600: 6f72 2069 7465 7261 7469 7665 206f 626a  or iterative obj
+00027610: 6563 742e 200a 2020 2020 2020 2020 2020  ect. .          
+00027620: 2020 7368 6170 6520 2874 7570 6c65 206f    shape (tuple o
+00027630: 7220 2a74 7570 6c65 293a 2043 7265 6174  r *tuple): Creat
+00027640: 6520 6120 7465 6e73 6f72 206d 656d 6f72  e a tensor memor
+00027650: 7920 6672 6f6d 2061 2073 6861 7065 2074  y from a shape t
+00027660: 7570 6c65 2e20 0a20 2020 2020 2020 2020  uple. .         
+00027670: 2020 202a 2a6b 7761 7267 7320 696e 636c     **kwargs incl
+00027680: 7564 6573 3a0a 2020 2020 2020 2020 2020  udes:.          
+00027690: 2020 2020 2020 6675 6e63 2063 6f6e 7472        func contr
+000276a0: 6f6c 6c65 7273 3a0a 2020 2020 2020 2020  ollers:.        
+000276b0: 2020 2020 2020 2020 2020 2020 7769 7468              with
+000276c0: 5f66 756e 6320 2862 6f6f 6c29 3a20 5768  _func (bool): Wh
+000276d0: 6574 6865 7220 7468 6520 7465 6e73 6f72  ether the tensor
+000276e0: 2068 6173 2061 2066 756e 6374 696f 6e61   has a functiona
+000276f0: 6c20 6469 6d65 6e73 696f 6e2c 2061 7420  l dimension, at 
+00027700: 7468 6520 6669 7273 7420 6469 6d65 6e73  the first dimens
+00027710: 696f 6e2e 2044 6566 6175 6c74 7320 746f  ion. Defaults to
+00027720: 2046 616c 7365 2e20 0a20 2020 2020 2020   False. .       
+00027730: 2020 2020 2020 2020 2020 2020 2066 756e               fun
+00027740: 635f 6469 6d20 2869 6e74 3a30 2f6e 5f64  c_dim (int:0/n_d
+00027750: 696d 2d31 206f 7220 4e6f 6e65 293a 2054  im-1 or None): T
+00027760: 6865 2066 756e 6374 696f 6e61 6c20 6469  he functional di
+00027770: 6d65 6e73 696f 6e20 696e 6465 7820 2830  mension index (0
+00027780: 206f 7220 2d31 206f 6e6c 792c 2061 7320   or -1 only, as 
+00027790: 7468 6520 6675 6e63 7469 6f6e 616c 2064  the functional d
+000277a0: 696d 656e 7369 6f6e 2063 616e 206f 6e6c  imension can onl
+000277b0: 7920 6265 2074 6865 2066 6972 7374 2f6c  y be the first/l
+000277c0: 6173 7420 6469 6d65 6e73 696f 6e29 206f  ast dimension) o
+000277d0: 6620 7468 6520 7465 6e73 6f72 2e20 4465  f the tensor. De
+000277e0: 6661 756c 7473 2074 6f20 4e6f 6e65 2e0a  faults to None..
+000277f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027800: 2020 2020 737a 5f66 756e 635f 6469 6d20      sz_func_dim 
+00027810: 2869 6e74 293a 2054 6865 2073 7a20 6e75  (int): The sz nu
+00027820: 6d62 6572 206f 6620 6675 6e63 7469 6f6e  mber of function
+00027830: 616c 2064 696d 656e 7369 6f6e 3a20 3020  al dimension: 0 
+00027840: 666f 7220 6e6f 2066 756e 6374 696f 6e61  for no functiona
+00027850: 6c20 6469 6d65 6e73 696f 6e2c 2031 2066  l dimension, 1 f
+00027860: 6f72 206f 6e65 2066 756e 6320 6f6e 2074  or one func on t
+00027870: 6865 206c 6566 742c 2061 6e64 202d 3120  he left, and -1 
+00027880: 666f 7220 6f6e 6520 6f6e 2074 6865 2072  for one on the r
+00027890: 6967 6874 2e20 4465 6661 756c 7473 2074  ight. Defaults t
+000278a0: 6f20 302e 200a 2020 2020 2020 2020 2020  o 0. .          
+000278b0: 2020 2020 2020 6261 7463 6820 636f 6e74        batch cont
+000278c0: 726f 6c6c 6572 733a 0a20 2020 2020 2020  rollers:.       
+000278d0: 2020 2020 2020 2020 2020 2020 2077 6974               wit
+000278e0: 685f 6261 7463 6820 2862 6f6f 6c29 3a20  h_batch (bool): 
+000278f0: 5768 6574 6865 7220 7468 6520 7465 6e73  Whether the tens
+00027900: 6f72 2068 6173 2061 2062 6174 6368 2064  or has a batch d
+00027910: 696d 656e 7369 6f6e 2c20 6174 2074 6865  imension, at the
+00027920: 2066 6972 7374 2064 696d 656e 7369 6f6e   first dimension
+00027930: 2028 6170 6172 7420 6672 6f6d 2066 756e   (apart from fun
+00027940: 6374 696f 6e61 6c20 6469 6d65 6e73 696f  ctional dimensio
+00027950: 6e29 2e20 4465 6661 756c 7473 2074 6f20  n). Defaults to 
+00027960: 4661 6c73 652e 200a 2020 2020 2020 2020  False. .        
+00027970: 2020 2020 2020 2020 2020 2020 6261 7463              batc
+00027980: 685f 6469 6d20 2869 6e74 206f 7220 4e6f  h_dim (int or No
+00027990: 6e65 293a 2054 6865 2062 6174 6368 2064  ne): The batch d
+000279a0: 696d 656e 7369 6f6e 2069 6e64 6578 2028  imension index (
+000279b0: 7468 6520 6669 7273 742f 6c61 7374 2064  the first/last d
+000279c0: 696d 656e 7369 6f6e 2061 7061 7274 2066  imension apart f
+000279d0: 726f 6d20 6675 6e63 7469 6f6e 616c 2064  rom functional d
+000279e0: 696d 656e 7369 6f6e 2920 6f66 2074 6865  imension) of the
+000279f0: 2074 656e 736f 722e 2044 6566 6175 6c74   tensor. Default
+00027a00: 7320 746f 204e 6f6e 652e 0a20 2020 2020  s to None..     
+00027a10: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00027a20: 7a5f 6261 7463 685f 6469 6d20 2869 6e74  z_batch_dim (int
+00027a30: 293a 2054 6865 2073 7a20 6e75 6d62 6572  ): The sz number
+00027a40: 206f 6620 6261 7463 6820 6469 6d65 6e73   of batch dimens
+00027a50: 696f 6e3a 2030 2066 6f72 206e 6f20 6261  ion: 0 for no ba
+00027a60: 7463 6820 6469 6d65 6e73 696f 6e2c 2031  tch dimension, 1
+00027a70: 2066 6f72 206f 6e65 2062 6174 6368 206f   for one batch o
+00027a80: 6e20 7468 6520 6c65 6674 2c20 616e 6420  n the left, and 
+00027a90: 2d31 2066 6f72 206f 6e65 206f 6e20 7468  -1 for one on th
+00027aa0: 6520 7269 6768 742e 2044 6566 6175 6c74  e right. Default
+00027ab0: 7320 746f 2030 2e20 0a20 2020 2020 2020  s to 0. .       
+00027ac0: 2020 2020 2020 2020 2066 6561 7475 7265           feature
+00027ad0: 2063 6f6e 7472 6f6c 6c65 7273 3a0a 2020   controllers:.  
+00027ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027af0: 2020 7769 7468 5f63 6861 6e6e 656c 2028    with_channel (
+00027b00: 626f 6f6c 293a 2057 6865 7468 6572 2074  bool): Whether t
+00027b10: 6865 2074 656e 736f 7220 6861 7320 6120  he tensor has a 
+00027b20: 6368 616e 6e65 6c20 6469 6d65 6e73 696f  channel dimensio
+00027b30: 6e2c 2061 7420 7468 6520 6669 7273 7420  n, at the first 
+00027b40: 6469 6d65 6e73 696f 6e20 6170 6172 7420  dimension apart 
+00027b50: 6672 6f6d 2062 6174 6368 2e20 4465 6661  from batch. Defa
+00027b60: 756c 7473 2074 6f20 4661 6c73 652e 200a  ults to False. .
+00027b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027b80: 2020 2020 7769 7468 5f66 6561 7475 7265      with_feature
+00027b90: 2028 626f 6f6c 293a 2057 6865 7468 6572   (bool): Whether
+00027ba0: 2074 6865 2074 656e 736f 7220 6861 7320   the tensor has 
+00027bb0: 6120 6665 6174 7572 6520 6469 6d65 6e73  a feature dimens
+00027bc0: 696f 6e2c 2061 7420 7468 6520 6669 7273  ion, at the firs
+00027bd0: 7420 6469 6d65 6e73 696f 6e20 6170 6172  t dimension apar
+00027be0: 7420 6672 6f6d 2062 6174 6368 2e20 4465  t from batch. De
+00027bf0: 6661 756c 7473 2074 6f20 4661 6c73 652e  faults to False.
+00027c00: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+00027c10: 2020 2020 2020 6368 616e 6e65 6c5f 6469        channel_di
+00027c20: 6d20 2869 6e74 206f 7220 4e6f 6e65 293a  m (int or None):
+00027c30: 2054 6865 2063 6861 6e6e 656c 2064 696d   The channel dim
+00027c40: 656e 7369 6f6e 2069 6e64 6578 2028 7468  ension index (th
+00027c50: 6520 6669 7273 742f 6c61 7374 2064 696d  e first/last dim
+00027c60: 656e 7369 6f6e 2061 7061 7274 2066 726f  ension apart fro
+00027c70: 6d20 6261 7463 6829 206f 6620 7468 6520  m batch) of the 
+00027c80: 7465 6e73 6f72 2e20 4465 6661 756c 7473  tensor. Defaults
+00027c90: 2074 6f20 4e6f 6e65 2e20 0a20 2020 2020   to None. .     
+00027ca0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00027cb0: 6561 7475 7265 5f64 696d 2028 696e 7420  eature_dim (int 
+00027cc0: 6f72 204e 6f6e 6529 3a20 5468 6520 6665  or None): The fe
+00027cd0: 6174 7572 6520 6469 6d65 6e73 696f 6e20  ature dimension 
+00027ce0: 696e 6465 7820 2874 6865 2066 6972 7374  index (the first
+00027cf0: 2f6c 6173 7420 6469 6d65 6e73 696f 6e20  /last dimension 
+00027d00: 6170 6172 7420 6672 6f6d 2062 6174 6368  apart from batch
+00027d10: 2920 6f66 2074 6865 2074 656e 736f 722e  ) of the tensor.
+00027d20: 2044 6566 6175 6c74 7320 746f 204e 6f6e   Defaults to Non
+00027d30: 652e 200a 2020 2020 2020 2020 2020 2020  e. .            
+00027d40: 2020 2020 2020 2020 6e5f 6665 6174 7572          n_featur
+00027d50: 655f 6469 6d20 2869 6e74 2b29 3a20 5468  e_dim (int+): Th
+00027d60: 6520 6e75 6d62 6572 206f 6620 6665 6174  e number of feat
+00027d70: 7572 6520 6469 6d65 6e73 696f 6e73 2c20  ure dimensions, 
+00027d80: 6f6e 2074 6865 206c 6566 7420 7061 7274  on the left part
+00027d90: 206f 6620 7468 6520 7369 7a65 2e20 4465   of the size. De
+00027da0: 6661 756c 7473 2074 6f20 302e 200a 2020  faults to 0. .  
+00027db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027dc0: 2020 737a 5f66 6561 7475 7265 5f64 696d    sz_feature_dim
+00027dd0: 2028 696e 7429 3a20 5468 6520 737a 206e   (int): The sz n
+00027de0: 756d 6265 7220 6f66 2066 6561 7475 7265  umber of feature
+00027df0: 2064 696d 656e 7369 6f6e 733a 2030 2066   dimensions: 0 f
+00027e00: 6f72 206e 6f20 6665 6174 7572 6573 2c20  or no features, 
+00027e10: 706f 7369 7469 7665 2066 6f72 2066 6561  positive for fea
+00027e20: 7475 7265 7320 6f6e 2074 6865 206c 6566  tures on the lef
+00027e30: 742c 2061 6e64 206e 6567 6174 6976 6520  t, and negative 
+00027e40: 666f 7220 6665 6174 7572 6573 206f 6e20  for features on 
+00027e50: 7468 6520 7269 6768 742e 2044 6566 6175  the right. Defau
+00027e60: 6c74 7320 746f 2030 2e0a 2020 2020 2020  lts to 0..      
+00027e70: 2020 2020 2020 2020 2020 7365 7175 656e            sequen
+00027e80: 6365 2063 6f6e 7472 6f6c 6c65 7273 3a0a  ce controllers:.
+00027e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027ea0: 2020 2020 7769 7468 5f73 6571 7565 6e63      with_sequenc
+00027eb0: 6520 2862 6f6f 6c29 3a20 5768 6574 6865  e (bool): Whethe
+00027ec0: 7220 7468 6520 7465 6e73 6f72 2068 6173  r the tensor has
+00027ed0: 206f 6e65 2073 6571 7565 6e63 6520 6469   one sequence di
+00027ee0: 6d65 6e73 696f 6e2c 2061 7420 7468 6520  mension, at the 
+00027ef0: 6669 7273 7420 6469 6d65 6e73 696f 6e20  first dimension 
+00027f00: 6170 6172 7420 6672 6f6d 2062 6174 6368  apart from batch
+00027f10: 2061 6e64 2066 6561 7475 7265 2e20 4465   and feature. De
+00027f20: 6661 756c 7473 2074 6f20 4661 6c73 652e  faults to False.
+00027f30: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+00027f40: 2020 2020 2020 7365 7175 656e 6365 5f64        sequence_d
+00027f50: 696d 2028 696e 7420 6f72 204e 6f6e 6529  im (int or None)
+00027f60: 3a20 5468 6520 7365 7175 656e 6365 2064  : The sequence d
+00027f70: 696d 656e 7369 6f6e 2069 6e64 6578 2028  imension index (
+00027f80: 7468 6520 6669 7273 742f 6c61 7374 2064  the first/last d
+00027f90: 696d 656e 7369 6f6e 2061 7061 7274 2066  imension apart f
+00027fa0: 726f 6d20 6261 7463 6820 616e 6420 6665  rom batch and fe
+00027fb0: 6174 7572 6529 206f 6620 7468 6520 7465  ature) of the te
+00027fc0: 6e73 6f72 2e20 4465 6661 756c 7473 2074  nsor. Defaults t
+00027fd0: 6f20 4e6f 6e65 2e20 0a20 2020 2020 2020  o None. .       
+00027fe0: 2020 2020 2020 2020 2020 2020 206e 5f73               n_s
+00027ff0: 6571 7565 6e63 655f 6469 6d20 2869 6e74  equence_dim (int
+00028000: 2b29 3a20 5468 6520 6e75 6d62 6572 206f  +): The number o
+00028010: 6620 7365 7175 656e 6365 2064 696d 656e  f sequence dimen
+00028020: 7369 6f6e 732c 206f 6e20 7468 6520 6c65  sions, on the le
+00028030: 6674 2070 6172 7420 6f66 2074 6865 2073  ft part of the s
+00028040: 697a 652e 2044 6566 6175 6c74 7320 746f  ize. Defaults to
+00028050: 2030 2e20 0a20 2020 2020 2020 2020 2020   0. .           
+00028060: 2020 2020 2020 2020 2073 7a5f 7365 7175           sz_sequ
+00028070: 656e 6365 5f64 696d 2028 696e 7429 3a20  ence_dim (int): 
+00028080: 5468 6520 737a 206e 756d 6265 7220 6f66  The sz number of
+00028090: 2073 6571 7565 6e63 6520 6469 6d65 6e73   sequence dimens
+000280a0: 696f 6e73 3a20 3020 666f 7220 6e6f 2073  ions: 0 for no s
+000280b0: 6571 7565 6e63 6573 2c20 706f 7369 7469  equences, positi
+000280c0: 7665 2066 6f72 2073 6571 7565 6e63 6573  ve for sequences
+000280d0: 206f 6e20 7468 6520 6c65 6674 2c20 616e   on the left, an
+000280e0: 6420 6e65 6761 7469 7665 2066 6f72 2073  d negative for s
+000280f0: 6571 7565 6e63 6573 206f 6e20 7468 6520  equences on the 
+00028100: 7269 6768 742e 2044 6566 6175 6c74 7320  right. Defaults 
+00028110: 746f 2030 2e0a 2020 2020 2020 2020 2222  to 0..        ""
+00028120: 220a 2020 2020 2020 2020 6966 206c 656e  ".        if len
+00028130: 2861 7267 7329 203e 3d20 3120 616e 6420  (args) >= 1 and 
+00028140: 6973 696e 7374 616e 6365 2861 7267 735b  isinstance(args[
+00028150: 305d 2c20 746f 7263 682e 5465 6e73 6f72  0], torch.Tensor
+00028160: 293a 2072 6574 7572 6e20 5465 6e73 6f72  ): return Tensor
+00028170: 2e5f 6d61 6b65 5f73 7562 636c 6173 7328  ._make_subclass(
+00028180: 636c 732c 202a 6172 6773 2c20 2a2a 6b77  cls, *args, **kw
+00028190: 6172 6773 290a 2020 2020 2020 2020 6966  args).        if
+000281a0: 206c 656e 2861 7267 7329 203e 3d20 3120   len(args) >= 1 
+000281b0: 616e 6420 6861 7361 7474 7228 6172 6773  and hasattr(args
+000281c0: 5b30 5d2c 2027 5f5f 7465 6e73 6f72 5f5f  [0], '__tensor__
+000281d0: 2729 3a20 7265 7475 726e 2054 656e 736f  '): return Tenso
+000281e0: 722e 5f6d 616b 655f 7375 6263 6c61 7373  r._make_subclass
+000281f0: 2863 6c73 2c20 6172 6773 5b30 5d2e 5f5f  (cls, args[0].__
+00028200: 7465 6e73 6f72 5f5f 2829 2c20 2a61 7267  tensor__(), *arg
+00028210: 735b 313a 5d2c 202a 2a6b 7761 7267 7329  s[1:], **kwargs)
+00028220: 0a20 2020 2020 2020 2064 6576 6963 6520  .        device 
+00028230: 3d20 6b77 6172 6773 2e70 6f70 2827 6465  = kwargs.pop('de
+00028240: 7669 6365 272c 205f 6465 7669 6365 290a  vice', _device).
+00028250: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00028260: 7461 6e63 6528 6465 7669 6365 2c20 4175  tance(device, Au
+00028270: 746f 4465 7669 6365 293a 2064 6576 6963  toDevice): devic
+00028280: 6520 3d20 6465 7669 6365 2e6d 6169 6e5f  e = device.main_
+00028290: 6465 7669 6365 0a20 2020 2020 2020 2069  device.        i
+000282a0: 6620 6c65 6e28 6172 6773 2920 3e3d 2031  f len(args) >= 1
+000282b0: 2061 6e64 2068 6173 6174 7472 2861 7267   and hasattr(arg
+000282c0: 735b 305d 2c20 2773 6861 7065 2729 206f  s[0], 'shape') o
+000282d0: 7220 6973 696e 7374 616e 6365 2861 7267  r isinstance(arg
+000282e0: 735b 305d 2c20 286c 6973 742c 2074 7570  s[0], (list, tup
+000282f0: 6c65 2929 3a20 7265 7475 726e 2054 656e  le)): return Ten
+00028300: 736f 722e 5f6d 616b 655f 7375 6263 6c61  sor._make_subcla
+00028310: 7373 2863 6c73 2c20 746f 7263 682e 7465  ss(cls, torch.te
+00028320: 6e73 6f72 2861 7267 735b 305d 2c20 7265  nsor(args[0], re
+00028330: 7175 6972 6573 5f67 7261 643d 4661 6c73  quires_grad=Fals
+00028340: 652c 2064 6576 6963 653d 6465 7669 6365  e, device=device
+00028350: 292c 202a 6172 6773 5b31 3a5d 2c20 2a2a  ), *args[1:], **
+00028360: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
+00028370: 7368 6170 6520 3d20 5369 7a65 282a 6172  shape = Size(*ar
+00028380: 6773 290a 2020 2020 2020 2020 6966 2073  gs).        if s
+00028390: 6861 7065 2e68 6173 5f73 7065 6369 616c  hape.has_special
+000283a0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+000283b0: 2073 6861 7065 2e73 7a5f 6675 6e63 5f64   shape.sz_func_d
+000283c0: 696d 2021 3d20 303a 206b 7761 7267 732e  im != 0: kwargs.
+000283d0: 7365 7464 6566 6175 6c74 2827 737a 5f66  setdefault('sz_f
+000283e0: 756e 635f 6469 6d27 2c20 7368 6170 652e  unc_dim', shape.
+000283f0: 737a 5f66 756e 635f 6469 6d29 0a20 2020  sz_func_dim).   
+00028400: 2020 2020 2020 2020 2069 6620 7368 6170           if shap
+00028410: 652e 737a 5f62 6174 6368 5f64 696d 2021  e.sz_batch_dim !
+00028420: 3d20 303a 206b 7761 7267 732e 7365 7464  = 0: kwargs.setd
+00028430: 6566 6175 6c74 2827 737a 5f62 6174 6368  efault('sz_batch
+00028440: 5f64 696d 272c 2073 6861 7065 2e73 7a5f  _dim', shape.sz_
+00028450: 6261 7463 685f 6469 6d29 0a20 2020 2020  batch_dim).     
+00028460: 2020 2020 2020 2069 6620 7368 6170 652e         if shape.
+00028470: 737a 5f66 6561 7475 7265 5f64 696d 2021  sz_feature_dim !
+00028480: 3d20 303a 206b 7761 7267 732e 7365 7464  = 0: kwargs.setd
+00028490: 6566 6175 6c74 2827 737a 5f66 6561 7475  efault('sz_featu
+000284a0: 7265 5f64 696d 272c 2073 6861 7065 2e73  re_dim', shape.s
+000284b0: 7a5f 6665 6174 7572 655f 6469 6d29 0a20  z_feature_dim). 
+000284c0: 2020 2020 2020 2020 2020 2069 6620 7368             if sh
+000284d0: 6170 652e 737a 5f73 6571 7565 6e63 655f  ape.sz_sequence_
+000284e0: 6469 6d20 213d 2030 3a20 6b77 6172 6773  dim != 0: kwargs
+000284f0: 2e73 6574 6465 6661 756c 7428 2773 7a5f  .setdefault('sz_
+00028500: 7365 7175 656e 6365 5f64 696d 272c 2073  sequence_dim', s
+00028510: 6861 7065 2e73 7a5f 7365 7175 656e 6365  hape.sz_sequence
+00028520: 5f64 696d 290a 2020 2020 2020 2020 2020  _dim).          
+00028530: 2020 7265 7475 726e 2054 656e 736f 722e    return Tensor.
+00028540: 5f6d 616b 655f 7375 6263 6c61 7373 2863  _make_subclass(c
+00028550: 6c73 2c20 7375 7065 7228 292e 5f5f 6e65  ls, super().__ne
+00028560: 775f 5f28 746f 7263 682e 5465 6e73 6f72  w__(torch.Tensor
+00028570: 2c20 2a73 6861 7065 2e74 7570 6c65 2829  , *shape.tuple()
+00028580: 2c20 6465 7669 6365 3d64 6576 6963 6529  , device=device)
+00028590: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
+000285a0: 2020 2020 7265 7475 726e 2054 656e 736f      return Tenso
+000285b0: 722e 5f6d 616b 655f 7375 6263 6c61 7373  r._make_subclass
+000285c0: 2863 6c73 2c20 7375 7065 7228 292e 5f5f  (cls, super().__
+000285d0: 6e65 775f 5f28 746f 7263 682e 5465 6e73  new__(torch.Tens
+000285e0: 6f72 2c20 2a61 7267 732c 2064 6576 6963  or, *args, devic
+000285f0: 653d 6465 7669 6365 292c 202a 2a6b 7761  e=device), **kwa
+00028600: 7267 7329 0a0a 2020 2020 6465 6620 5f5f  rgs)..    def __
+00028610: 696e 6974 5f5f 2873 656c 662c 202a 6172  init__(self, *ar
+00028620: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+00028630: 2020 2020 2020 2073 656c 662e 737a 5f66         self.sz_f
+00028640: 756e 635f 6469 6d20 3d20 7365 6c66 2e73  unc_dim = self.s
+00028650: 7a5f 6675 6e63 5f64 696d 0a20 2020 2020  z_func_dim.     
+00028660: 2020 2073 656c 662e 737a 5f62 6174 6368     self.sz_batch
+00028670: 5f64 696d 203d 2073 656c 662e 737a 5f62  _dim = self.sz_b
+00028680: 6174 6368 5f64 696d 0a20 2020 2020 2020  atch_dim.       
+00028690: 2073 656c 662e 737a 5f66 6561 7475 7265   self.sz_feature
+000286a0: 5f64 696d 203d 2073 656c 662e 737a 5f66  _dim = self.sz_f
+000286b0: 6561 7475 7265 5f64 696d 0a20 2020 2020  eature_dim.     
+000286c0: 2020 2073 656c 662e 737a 5f73 6571 7565     self.sz_seque
+000286d0: 6e63 655f 6469 6d20 3d20 7365 6c66 2e73  nce_dim = self.s
+000286e0: 7a5f 7365 7175 656e 6365 5f64 696d 0a20  z_sequence_dim. 
+000286f0: 2020 200a 2020 2020 2320 496e 6865 7269     .    # Inheri
+00028700: 7420 616c 6c20 7468 6520 7072 6f70 6572  t all the proper
+00028710: 7469 6573 2066 6f72 2073 7065 6369 616c  ties for special
+00028720: 2064 696d 656e 7369 6f6e 7320 6672 6f6d   dimensions from
+00028730: 2027 6274 2e53 697a 6527 2e20 0a20 2020   'bt.Size'. .   
+00028740: 2068 6173 5f66 756e 6320 3d20 7072 6f70   has_func = prop
+00028750: 6572 7479 2853 697a 652e 6861 735f 6675  erty(Size.has_fu
+00028760: 6e63 2e66 6765 7429 0a20 2020 206e 6675  nc.fget).    nfu
+00028770: 6e63 6469 6d20 3d20 6e5f 6675 6e63 5f64  ncdim = n_func_d
+00028780: 696d 203d 2070 726f 7065 7274 7928 5369  im = property(Si
+00028790: 7a65 2e6e 5f66 756e 635f 6469 6d2e 6667  ze.n_func_dim.fg
+000287a0: 6574 290a 2020 2020 6973 5f66 756e 6364  et).    is_funcd
+000287b0: 696d 203d 2069 735f 6675 6e63 5f64 696d  im = is_func_dim
+000287c0: 203d 2053 697a 652e 6973 5f66 756e 635f   = Size.is_func_
+000287d0: 6469 6d0a 2020 2020 737a 5f66 756e 635f  dim.    sz_func_
+000287e0: 6469 6d5f 203d 2077 6974 685f 737a 6675  dim_ = with_szfu
+000287f0: 6e63 6469 6d20 3d20 7769 7468 5f73 7a5f  ncdim = with_sz_
+00028800: 6675 6e63 5f64 696d 203d 2053 697a 652e  func_dim = Size.
+00028810: 7769 7468 5f73 7a5f 6675 6e63 5f64 696d  with_sz_func_dim
+00028820: 0a20 2020 206e 5f66 756e 635f 6469 6d5f  .    n_func_dim_
+00028830: 203d 2077 6974 685f 6e66 756e 6364 696d   = with_nfuncdim
+00028840: 203d 2077 6974 685f 6e5f 6675 6e63 5f64   = with_n_func_d
+00028850: 696d 203d 2053 697a 652e 7769 7468 5f6e  im = Size.with_n
+00028860: 5f66 756e 635f 6469 6d0a 2020 2020 6675  _func_dim.    fu
+00028870: 6e63 5f64 696d 656e 7369 6f6e 203d 2066  nc_dimension = f
+00028880: 756e 635f 6469 6d20 3d20 7072 6f70 6572  unc_dim = proper
+00028890: 7479 2853 697a 652e 6675 6e63 5f64 696d  ty(Size.func_dim
+000288a0: 2e66 6765 7429 2e73 6574 7465 7228 5369  .fget).setter(Si
+000288b0: 7a65 2e66 756e 635f 6469 6d2e 6673 6574  ze.func_dim.fset
+000288c0: 290a 2020 2020 6675 6e63 5f64 696d 5f20  ).    func_dim_ 
+000288d0: 3d20 6675 6e63 5f64 696d 656e 7369 6f6e  = func_dimension
+000288e0: 5f20 3d20 5c0a 2020 2020 7769 7468 5f66  _ = \.    with_f
+000288f0: 756e 6364 696d 203d 2077 6974 685f 6675  uncdim = with_fu
+00028900: 6e63 5f64 696d 203d 2053 697a 652e 7769  nc_dim = Size.wi
+00028910: 7468 5f66 756e 635f 6469 6d0a 2020 2020  th_func_dim.    
+00028920: 6e66 756e 6320 3d20 6675 6e63 5f73 697a  nfunc = func_siz
+00028930: 6520 3d20 6e5f 6675 6e63 203d 2070 726f  e = n_func = pro
+00028940: 7065 7274 7928 6c61 6d62 6461 2073 656c  perty(lambda sel
+00028950: 663a 2053 697a 652e 6e5f 6675 6e63 2e66  f: Size.n_func.f
+00028960: 6765 7428 7365 6c66 2e73 6861 7065 2929  get(self.shape))
+00028970: 0a20 2020 2073 697a 655f 7374 6172 7420  .    size_start 
+00028980: 3d20 7072 6f70 6572 7479 2853 697a 652e  = property(Size.
+00028990: 7369 7a65 5f73 7461 7274 2e66 6765 7429  size_start.fget)
+000289a0: 0a20 2020 2073 697a 655f 7374 6f70 203d  .    size_stop =
+000289b0: 2070 726f 7065 7274 7928 5369 7a65 2e73   property(Size.s
+000289c0: 697a 655f 7374 6f70 2e66 6765 7429 0a0a  ize_stop.fget)..
+000289d0: 2020 2020 6861 735f 6261 7463 6820 3d20      has_batch = 
+000289e0: 7072 6f70 6572 7479 2853 697a 652e 6861  property(Size.ha
+000289f0: 735f 6261 7463 682e 6667 6574 290a 2020  s_batch.fget).  
+00028a00: 2020 6e62 6174 6368 6469 6d20 3d20 6e5f    nbatchdim = n_
+00028a10: 6261 7463 685f 6469 6d20 3d20 7072 6f70  batch_dim = prop
+00028a20: 6572 7479 2853 697a 652e 6e5f 6261 7463  erty(Size.n_batc
+00028a30: 685f 6469 6d2e 6667 6574 290a 2020 2020  h_dim.fget).    
+00028a40: 6973 5f62 6174 6368 6469 6d20 3d20 6973  is_batchdim = is
+00028a50: 5f62 6174 6368 5f64 696d 203d 2053 697a  _batch_dim = Siz
+00028a60: 652e 6973 5f62 6174 6368 5f64 696d 0a20  e.is_batch_dim. 
+00028a70: 2020 2073 7a5f 6261 7463 685f 6469 6d5f     sz_batch_dim_
+00028a80: 203d 2077 6974 685f 737a 6261 7463 6864   = with_szbatchd
+00028a90: 696d 203d 2077 6974 685f 737a 5f62 6174  im = with_sz_bat
+00028aa0: 6368 5f64 696d 203d 2053 697a 652e 7769  ch_dim = Size.wi
+00028ab0: 7468 5f73 7a5f 6261 7463 685f 6469 6d0a  th_sz_batch_dim.
+00028ac0: 2020 2020 6e5f 6261 7463 685f 6469 6d5f      n_batch_dim_
+00028ad0: 203d 2077 6974 685f 6e62 6174 6368 6469   = with_nbatchdi
+00028ae0: 6d20 3d20 7769 7468 5f6e 5f62 6174 6368  m = with_n_batch
+00028af0: 5f64 696d 203d 2053 697a 652e 7769 7468  _dim = Size.with
+00028b00: 5f6e 5f62 6174 6368 5f64 696d 0a20 2020  _n_batch_dim.   
+00028b10: 2062 6174 6368 5f64 696d 656e 7369 6f6e   batch_dimension
+00028b20: 203d 2062 6174 6368 5f64 696d 203d 2070   = batch_dim = p
+00028b30: 726f 7065 7274 7928 5369 7a65 2e62 6174  roperty(Size.bat
+00028b40: 6368 5f64 696d 2e66 6765 7429 2e73 6574  ch_dim.fget).set
+00028b50: 7465 7228 5369 7a65 2e62 6174 6368 5f64  ter(Size.batch_d
+00028b60: 696d 2e66 7365 7429 0a20 2020 2062 6174  im.fset).    bat
+00028b70: 6368 5f64 696d 5f20 3d20 6261 7463 685f  ch_dim_ = batch_
+00028b80: 6469 6d65 6e73 696f 6e5f 203d 205c 0a20  dimension_ = \. 
+00028b90: 2020 2077 6974 685f 6261 7463 6864 696d     with_batchdim
+00028ba0: 203d 2077 6974 685f 6261 7463 685f 6469   = with_batch_di
+00028bb0: 6d20 3d20 5369 7a65 2e77 6974 685f 6261  m = Size.with_ba
+00028bc0: 7463 685f 6469 6d0a 2020 2020 6e62 6174  tch_dim.    nbat
+00028bd0: 6368 203d 2062 6174 6368 5f73 697a 6520  ch = batch_size 
+00028be0: 3d20 6e5f 6261 7463 6820 3d20 7072 6f70  = n_batch = prop
+00028bf0: 6572 7479 286c 616d 6264 6120 7365 6c66  erty(lambda self
+00028c00: 3a20 5369 7a65 2e6e 5f62 6174 6368 2e66  : Size.n_batch.f
+00028c10: 6765 7428 7365 6c66 2e73 6861 7065 2929  get(self.shape))
+00028c20: 0a20 2020 206e 6f6e 5f62 6174 5f73 7461  .    non_bat_sta
+00028c30: 7274 203d 2070 726f 7065 7274 7928 5369  rt = property(Si
+00028c40: 7a65 2e6e 6f6e 5f62 6174 5f73 7461 7274  ze.non_bat_start
+00028c50: 2e66 6765 7429 0a20 2020 206e 6f6e 5f62  .fget).    non_b
+00028c60: 6174 5f73 746f 7020 3d20 7072 6f70 6572  at_stop = proper
+00028c70: 7479 2853 697a 652e 6e6f 6e5f 6261 745f  ty(Size.non_bat_
+00028c80: 7374 6f70 2e66 6765 7429 0a0a 2020 2020  stop.fget)..    
+00028c90: 6861 735f 6368 616e 6e65 6c20 3d20 7072  has_channel = pr
+00028ca0: 6f70 6572 7479 2853 697a 652e 6861 735f  operty(Size.has_
+00028cb0: 6368 616e 6e65 6c2e 6667 6574 290a 2020  channel.fget).  
+00028cc0: 2020 6e63 6861 6e6e 656c 6469 6d20 3d20    nchanneldim = 
+00028cd0: 6e5f 6368 616e 6e65 6c5f 6469 6d20 3d20  n_channel_dim = 
+00028ce0: 7072 6f70 6572 7479 2853 697a 652e 6e5f  property(Size.n_
+00028cf0: 6368 616e 6e65 6c5f 6469 6d2e 6667 6574  channel_dim.fget
+00028d00: 290a 2020 2020 6973 5f63 6861 6e6e 656c  ).    is_channel
+00028d10: 6469 6d20 3d20 6973 5f63 6861 6e6e 656c  dim = is_channel
+00028d20: 5f64 696d 203d 2053 697a 652e 6973 5f63  _dim = Size.is_c
+00028d30: 6861 6e6e 656c 5f64 696d 0a20 2020 2063  hannel_dim.    c
+00028d40: 6861 6e6e 656c 5f64 696d 656e 7369 6f6e  hannel_dimension
+00028d50: 203d 2063 6861 6e6e 656c 5f64 696d 203d   = channel_dim =
+00028d60: 2070 726f 7065 7274 7928 5369 7a65 2e63   property(Size.c
+00028d70: 6861 6e6e 656c 5f64 696d 2e66 6765 7429  hannel_dim.fget)
+00028d80: 2e73 6574 7465 7228 5369 7a65 2e63 6861  .setter(Size.cha
+00028d90: 6e6e 656c 5f64 696d 2e66 7365 7429 0a20  nnel_dim.fset). 
+00028da0: 2020 2063 6861 6e6e 656c 5f64 696d 5f20     channel_dim_ 
+00028db0: 3d20 6368 616e 6e65 6c5f 6469 6d65 6e73  = channel_dimens
+00028dc0: 696f 6e5f 203d 205c 0a20 2020 2077 6974  ion_ = \.    wit
+00028dd0: 685f 6368 616e 6e65 6c64 696d 203d 2077  h_channeldim = w
+00028de0: 6974 685f 6368 616e 6e65 6c5f 6469 6d20  ith_channel_dim 
+00028df0: 3d20 5369 7a65 2e77 6974 685f 6368 616e  = Size.with_chan
+00028e00: 6e65 6c5f 6469 6d0a 2020 2020 6e63 6861  nel_dim.    ncha
+00028e10: 6e6e 656c 203d 2063 6861 6e6e 656c 5f73  nnel = channel_s
+00028e20: 697a 6520 3d20 6e5f 6368 616e 6e65 6c20  ize = n_channel 
+00028e30: 3d20 7072 6f70 6572 7479 286c 616d 6264  = property(lambd
+00028e40: 6120 7365 6c66 3a20 5369 7a65 2e6e 5f63  a self: Size.n_c
+00028e50: 6861 6e6e 656c 2e66 6765 7428 7365 6c66  hannel.fget(self
+00028e60: 2e73 6861 7065 2929 0a20 2020 200a 2020  .shape)).    .  
+00028e70: 2020 6861 735f 6665 6174 7572 6520 3d20    has_feature = 
+00028e80: 7072 6f70 6572 7479 2853 697a 652e 6861  property(Size.ha
+00028e90: 735f 6665 6174 7572 652e 6667 6574 290a  s_feature.fget).
+00028ea0: 2020 2020 6973 5f66 6561 7475 7265 6469      is_featuredi
+00028eb0: 6d20 3d20 6973 5f66 6561 7475 7265 5f64  m = is_feature_d
+00028ec0: 696d 203d 2053 697a 652e 6973 5f66 6561  im = Size.is_fea
+00028ed0: 7475 7265 5f64 696d 0a20 2020 206e 6665  ture_dim.    nfe
+00028ee0: 6174 7572 6564 696d 203d 206e 5f66 6561  aturedim = n_fea
+00028ef0: 7475 7265 5f64 696d 203d 2070 726f 7065  ture_dim = prope
+00028f00: 7274 7928 5369 7a65 2e6e 5f66 6561 7475  rty(Size.n_featu
+00028f10: 7265 5f64 696d 2e66 6765 7429 2e73 6574  re_dim.fget).set
+00028f20: 7465 7228 5369 7a65 2e6e 5f66 6561 7475  ter(Size.n_featu
+00028f30: 7265 5f64 696d 2e66 7365 7429 0a20 2020  re_dim.fset).   
+00028f40: 2073 7a5f 6665 6174 7572 655f 6469 6d5f   sz_feature_dim_
+00028f50: 203d 2077 6974 685f 737a 6665 6174 7572   = with_szfeatur
+00028f60: 6564 696d 203d 2077 6974 685f 737a 5f66  edim = with_sz_f
+00028f70: 6561 7475 7265 5f64 696d 203d 2053 697a  eature_dim = Siz
+00028f80: 652e 7769 7468 5f73 7a5f 6665 6174 7572  e.with_sz_featur
+00028f90: 655f 6469 6d0a 2020 2020 6e5f 6665 6174  e_dim.    n_feat
+00028fa0: 7572 655f 6469 6d5f 203d 2077 6974 685f  ure_dim_ = with_
+00028fb0: 6e66 6561 7475 7265 6469 6d20 3d20 7769  nfeaturedim = wi
+00028fc0: 7468 5f6e 5f66 6561 7475 7265 5f64 696d  th_n_feature_dim
+00028fd0: 203d 2053 697a 652e 7769 7468 5f6e 5f66   = Size.with_n_f
+00028fe0: 6561 7475 7265 5f64 696d 0a20 2020 2066  eature_dim.    f
+00028ff0: 6561 7475 7265 5f73 7461 7274 203d 2070  eature_start = p
+00029000: 726f 7065 7274 7928 5369 7a65 2e66 6561  roperty(Size.fea
+00029010: 7475 7265 5f73 7461 7274 2e66 6765 7429  ture_start.fget)
+00029020: 2e73 6574 7465 7228 5369 7a65 2e66 6561  .setter(Size.fea
+00029030: 7475 7265 5f73 7461 7274 2e66 7365 7429  ture_start.fset)
+00029040: 0a20 2020 2066 6561 7475 7265 5f73 746f  .    feature_sto
+00029050: 7020 3d20 7072 6f70 6572 7479 2853 697a  p = property(Siz
+00029060: 652e 6665 6174 7572 655f 7374 6f70 2e66  e.feature_stop.f
+00029070: 6765 7429 2e73 6574 7465 7228 5369 7a65  get).setter(Size
+00029080: 2e66 6561 7475 7265 5f73 746f 702e 6673  .feature_stop.fs
+00029090: 6574 290a 2020 2020 6665 6174 7572 655f  et).    feature_
+000290a0: 7261 6e67 6520 3d20 7072 6f70 6572 7479  range = property
+000290b0: 2853 697a 652e 6665 6174 7572 655f 7261  (Size.feature_ra
+000290c0: 6e67 652e 6667 6574 292e 7365 7474 6572  nge.fget).setter
+000290d0: 2853 697a 652e 6665 6174 7572 655f 7261  (Size.feature_ra
+000290e0: 6e67 652e 6673 6574 290a 2020 2020 6e66  nge.fset).    nf
+000290f0: 6561 7475 7265 203d 206e 5f66 6561 7475  eature = n_featu
+00029100: 7265 203d 2070 726f 7065 7274 7928 6c61  re = property(la
+00029110: 6d62 6461 2073 656c 663a 2053 697a 652e  mbda self: Size.
+00029120: 6e5f 6665 6174 7572 652e 6667 6574 2873  n_feature.fget(s
+00029130: 656c 662e 7368 6170 6529 290a 2020 2020  elf.shape)).    
+00029140: 6665 6174 7572 655f 7369 7a65 203d 2066  feature_size = f
+00029150: 6561 7475 7265 203d 2070 726f 7065 7274  eature = propert
+00029160: 7928 6c61 6d62 6461 2073 656c 663a 2053  y(lambda self: S
+00029170: 697a 652e 6665 6174 7572 652e 6667 6574  ize.feature.fget
+00029180: 2873 656c 662e 7368 6170 6529 290a 2020  (self.shape)).  
+00029190: 2020 7365 715f 7370 635f 7374 6172 7420    seq_spc_start 
+000291a0: 3d20 7072 6f70 6572 7479 2853 697a 652e  = property(Size.
+000291b0: 7365 715f 7370 635f 7374 6172 742e 6667  seq_spc_start.fg
+000291c0: 6574 290a 2020 2020 7365 715f 7370 635f  et).    seq_spc_
+000291d0: 7374 6f70 203d 2070 726f 7065 7274 7928  stop = property(
+000291e0: 5369 7a65 2e73 6571 5f73 7063 5f73 746f  Size.seq_spc_sto
+000291f0: 702e 6667 6574 290a 0a20 2020 2068 6173  p.fget)..    has
+00029200: 5f74 696d 6520 3d20 6861 735f 7365 7269  _time = has_seri
+00029210: 6573 203d 2068 6173 5f73 6571 7565 6e63  es = has_sequenc
+00029220: 6520 3d20 7072 6f70 6572 7479 2853 697a  e = property(Siz
+00029230: 652e 6861 735f 7365 7175 656e 6365 2e66  e.has_sequence.f
+00029240: 6765 7429 0a20 2020 2069 735f 7469 6d65  get).    is_time
+00029250: 6469 6d20 3d20 6973 5f73 6572 6965 7364  dim = is_seriesd
+00029260: 696d 203d 2069 735f 7365 7175 656e 6365  im = is_sequence
+00029270: 6469 6d20 3d20 5c0a 2020 2020 6973 5f74  dim = \.    is_t
+00029280: 696d 655f 6469 6d20 3d20 6973 5f73 6572  ime_dim = is_ser
+00029290: 6965 735f 6469 6d20 3d20 6973 5f73 6571  ies_dim = is_seq
+000292a0: 7565 6e63 655f 6469 6d20 3d20 5369 7a65  uence_dim = Size
+000292b0: 2e69 735f 7365 7175 656e 6365 5f64 696d  .is_sequence_dim
+000292c0: 0a20 2020 206e 7469 6d65 6469 6d20 3d20  .    ntimedim = 
+000292d0: 6e73 6572 6965 7364 696d 203d 206e 7365  nseriesdim = nse
+000292e0: 7175 656e 6365 6469 6d20 3d20 5c0a 2020  quencedim = \.  
+000292f0: 2020 6e5f 7469 6d65 5f64 696d 203d 206e    n_time_dim = n
+00029300: 5f73 6572 6965 735f 6469 6d20 3d20 6e5f  _series_dim = n_
+00029310: 7365 7175 656e 6365 5f64 696d 203d 2070  sequence_dim = p
+00029320: 726f 7065 7274 7928 5369 7a65 2e6e 5f73  roperty(Size.n_s
+00029330: 6571 7565 6e63 655f 6469 6d2e 6667 6574  equence_dim.fget
+00029340: 292e 7365 7474 6572 2853 697a 652e 6e5f  ).setter(Size.n_
+00029350: 7365 7175 656e 6365 5f64 696d 2e66 7365  sequence_dim.fse
+00029360: 7429 0a20 2020 2073 7a5f 7469 6d65 5f64  t).    sz_time_d
+00029370: 696d 5f20 3d20 737a 5f73 6572 6965 735f  im_ = sz_series_
+00029380: 6469 6d5f 203d 2073 7a5f 7365 7175 656e  dim_ = sz_sequen
+00029390: 6365 5f64 696d 5f20 3d20 5c0a 2020 2020  ce_dim_ = \.    
+000293a0: 7769 7468 5f73 7a74 696d 6564 696d 203d  with_sztimedim =
+000293b0: 2077 6974 685f 737a 7365 7269 6573 6469   with_szseriesdi
+000293c0: 6d20 3d20 7769 7468 5f73 7a73 6571 7565  m = with_szseque
+000293d0: 6e63 6564 696d 203d 205c 0a20 2020 2077  ncedim = \.    w
+000293e0: 6974 685f 737a 5f74 696d 655f 6469 6d20  ith_sz_time_dim 
+000293f0: 3d20 7769 7468 5f73 7a5f 7365 7269 6573  = with_sz_series
+00029400: 5f64 696d 203d 2077 6974 685f 737a 5f73  _dim = with_sz_s
+00029410: 6571 7565 6e63 655f 6469 6d20 3d20 5369  equence_dim = Si
+00029420: 7a65 2e77 6974 685f 737a 5f73 6571 7565  ze.with_sz_seque
+00029430: 6e63 655f 6469 6d0a 2020 2020 6e5f 7469  nce_dim.    n_ti
+00029440: 6d65 5f64 696d 5f20 3d20 6e5f 7365 7269  me_dim_ = n_seri
+00029450: 6573 5f64 696d 5f20 3d20 6e5f 7365 7175  es_dim_ = n_sequ
+00029460: 656e 6365 5f64 696d 5f20 3d20 5c0a 2020  ence_dim_ = \.  
+00029470: 2020 7769 7468 5f6e 7469 6d65 6469 6d20    with_ntimedim 
+00029480: 3d20 7769 7468 5f6e 7365 7269 6573 6469  = with_nseriesdi
+00029490: 6d20 3d20 7769 7468 5f6e 7365 7175 656e  m = with_nsequen
+000294a0: 6365 6469 6d20 3d20 5c0a 2020 2020 7769  cedim = \.    wi
+000294b0: 7468 5f6e 5f74 696d 655f 6469 6d20 3d20  th_n_time_dim = 
+000294c0: 7769 7468 5f6e 5f73 6572 6965 735f 6469  with_n_series_di
+000294d0: 6d20 3d20 7769 7468 5f6e 5f73 6571 7565  m = with_n_seque
+000294e0: 6e63 655f 6469 6d20 3d20 5369 7a65 2e77  nce_dim = Size.w
+000294f0: 6974 685f 6e5f 7365 7175 656e 6365 5f64  ith_n_sequence_d
+00029500: 696d 0a20 2020 2074 696d 655f 6469 6d5f  im.    time_dim_
+00029510: 203d 2073 6572 6965 735f 6469 6d5f 203d   = series_dim_ =
+00029520: 2073 6571 7565 6e63 655f 6469 6d5f 203d   sequence_dim_ =
+00029530: 205c 0a20 2020 2077 6974 685f 7469 6d65   \.    with_time
+00029540: 6469 6d20 3d20 7769 7468 5f73 6572 6965  dim = with_serie
+00029550: 7364 696d 203d 2077 6974 685f 7365 7175  sdim = with_sequ
+00029560: 656e 6365 6469 6d20 3d20 5c0a 2020 2020  encedim = \.    
+00029570: 7769 7468 5f74 696d 655f 6469 6d20 3d20  with_time_dim = 
+00029580: 7769 7468 5f73 6572 6965 735f 6469 6d20  with_series_dim 
+00029590: 3d20 7769 7468 5f73 6571 7565 6e63 655f  = with_sequence_
+000295a0: 6469 6d20 3d20 5369 7a65 2e77 6974 685f  dim = Size.with_
+000295b0: 7365 7175 656e 6365 5f64 696d 0a20 2020  sequence_dim.   
+000295c0: 2074 696d 655f 7374 6172 7420 3d20 7365   time_start = se
+000295d0: 7269 6573 5f73 7461 7274 203d 2073 6571  ries_start = seq
+000295e0: 7565 6e63 655f 7374 6172 7420 3d20 7072  uence_start = pr
+000295f0: 6f70 6572 7479 2853 697a 652e 7365 7175  operty(Size.sequ
+00029600: 656e 6365 5f73 7461 7274 2e66 6765 7429  ence_start.fget)
+00029610: 2e73 6574 7465 7228 5369 7a65 2e73 6571  .setter(Size.seq
+00029620: 7565 6e63 655f 7374 6172 742e 6673 6574  uence_start.fset
+00029630: 290a 2020 2020 7469 6d65 5f73 746f 7020  ).    time_stop 
+00029640: 3d20 7365 7269 6573 5f73 746f 7020 3d20  = series_stop = 
+00029650: 7365 7175 656e 6365 5f73 746f 7020 3d20  sequence_stop = 
+00029660: 7072 6f70 6572 7479 2853 697a 652e 7365  property(Size.se
+00029670: 7175 656e 6365 5f73 746f 702e 6667 6574  quence_stop.fget
+00029680: 292e 7365 7474 6572 2853 697a 652e 7365  ).setter(Size.se
+00029690: 7175 656e 6365 5f73 746f 702e 6673 6574  quence_stop.fset
+000296a0: 290a 2020 2020 7469 6d65 5f72 616e 6765  ).    time_range
+000296b0: 203d 2073 6572 6965 735f 7261 6e67 6520   = series_range 
+000296c0: 3d20 7365 7175 656e 6365 5f72 616e 6765  = sequence_range
+000296d0: 203d 2070 726f 7065 7274 7928 5369 7a65   = property(Size
+000296e0: 2e73 6571 7565 6e63 655f 7261 6e67 652e  .sequence_range.
+000296f0: 6667 6574 292e 7365 7474 6572 2853 697a  fget).setter(Siz
+00029700: 652e 7365 7175 656e 6365 5f72 616e 6765  e.sequence_range
+00029710: 2e66 7365 7429 0a20 2020 206e 7469 6d65  .fset).    ntime
+00029720: 203d 206e 7469 6d65 6c69 6e65 203d 206e   = ntimeline = n
+00029730: 7365 7269 6573 203d 206e 7365 7175 656e  series = nsequen
+00029740: 6365 203d 205c 0a20 2020 206e 5f74 696d  ce = \.    n_tim
+00029750: 6520 3d20 6e5f 7469 6d65 6c69 6e65 203d  e = n_timeline =
+00029760: 206e 5f73 6572 6965 7320 3d20 6e5f 7365   n_series = n_se
+00029770: 7175 656e 6365 203d 2070 726f 7065 7274  quence = propert
+00029780: 7928 6c61 6d62 6461 2073 656c 663a 2053  y(lambda self: S
+00029790: 697a 652e 6e5f 7365 7175 656e 6365 2e66  ize.n_sequence.f
+000297a0: 6765 7428 7365 6c66 2e73 6861 7065 2929  get(self.shape))
+000297b0: 0a20 2020 2074 696d 655f 7369 7a65 203d  .    time_size =
+000297c0: 2073 6572 6965 735f 7369 7a65 203d 2073   series_size = s
+000297d0: 6571 7565 6e63 655f 7369 7a65 203d 205c  equence_size = \
+000297e0: 0a20 2020 2074 696d 6520 3d20 7365 7269  .    time = seri
+000297f0: 6573 203d 2073 6571 7565 6e63 6520 3d20  es = sequence = 
+00029800: 7072 6f70 6572 7479 286c 616d 6264 6120  property(lambda 
+00029810: 7365 6c66 3a20 5369 7a65 2e73 6571 7565  self: Size.seque
+00029820: 6e63 652e 6667 6574 2873 656c 662e 7368  nce.fget(self.sh
+00029830: 6170 6529 290a 2020 2020 0a20 2020 2068  ape)).    .    h
+00029840: 6173 5f73 7061 6365 203d 2070 726f 7065  as_space = prope
+00029850: 7274 7928 5369 7a65 2e68 6173 5f73 7061  rty(Size.has_spa
+00029860: 6365 2e66 6765 7429 0a20 2020 2069 735f  ce.fget).    is_
+00029870: 7370 6163 6564 696d 203d 2069 735f 7370  spacedim = is_sp
+00029880: 6163 655f 6469 6d20 3d20 5369 7a65 2e69  ace_dim = Size.i
+00029890: 735f 7370 6163 655f 6469 6d0a 2020 2020  s_space_dim.    
+000298a0: 6e73 7061 6365 6469 6d20 3d20 6e5f 7370  nspacedim = n_sp
+000298b0: 6163 655f 6469 6d20 3d20 7072 6f70 6572  ace_dim = proper
+000298c0: 7479 2853 697a 652e 6e5f 7370 6163 655f  ty(Size.n_space_
+000298d0: 6469 6d2e 6667 6574 290a 2020 2020 7370  dim.fget).    sp
+000298e0: 6163 655f 7374 6172 7420 3d20 7072 6f70  ace_start = prop
+000298f0: 6572 7479 2853 697a 652e 7370 6163 655f  erty(Size.space_
+00029900: 7374 6172 742e 6667 6574 290a 2020 2020  start.fget).    
+00029910: 7370 6163 655f 7374 6f70 203d 2070 726f  space_stop = pro
+00029920: 7065 7274 7928 5369 7a65 2e73 7061 6365  perty(Size.space
+00029930: 5f73 746f 702e 6667 6574 290a 2020 2020  _stop.fget).    
+00029940: 7370 6163 655f 7261 6e67 6520 3d20 7072  space_range = pr
+00029950: 6f70 6572 7479 2853 697a 652e 7370 6163  operty(Size.spac
+00029960: 655f 7261 6e67 652e 6667 6574 290a 2020  e_range.fget).  
+00029970: 2020 6e73 7061 6365 203d 206e 5f73 7061    nspace = n_spa
+00029980: 6365 203d 2070 726f 7065 7274 7928 6c61  ce = property(la
+00029990: 6d62 6461 2073 656c 663a 2053 697a 652e  mbda self: Size.
+000299a0: 6e5f 7370 6163 652e 6667 6574 2873 656c  n_space.fget(sel
+000299b0: 662e 7368 6170 6529 290a 2020 2020 7370  f.shape)).    sp
+000299c0: 6163 655f 7369 7a65 203d 2073 7061 6365  ace_size = space
+000299d0: 203d 2070 726f 7065 7274 7928 6c61 6d62   = property(lamb
+000299e0: 6461 2073 656c 663a 2053 697a 652e 7370  da self: Size.sp
+000299f0: 6163 652e 6667 6574 2873 656c 662e 7368  ace.fget(self.sh
+00029a00: 6170 6529 290a 0a20 2020 2068 6173 5f73  ape))..    has_s
+00029a10: 7065 6369 616c 203d 2070 726f 7065 7274  pecial = propert
+00029a20: 7928 5369 7a65 2e68 6173 5f73 7065 6369  y(Size.has_speci
+00029a30: 616c 2e66 6765 7429 0a20 2020 206e 7370  al.fget).    nsp
+00029a40: 6563 6961 6c64 696d 203d 206e 5f73 7065  ecialdim = n_spe
+00029a50: 6369 616c 5f64 696d 203d 2070 726f 7065  cial_dim = prope
+00029a60: 7274 7928 5369 7a65 2e6e 7370 6563 6961  rty(Size.nspecia
+00029a70: 6c64 696d 2e66 6765 7429 0a20 2020 2073  ldim.fget).    s
+00029a80: 7065 6369 616c 5f64 696d 7320 3d20 7072  pecial_dims = pr
+00029a90: 6f70 6572 7479 2853 697a 652e 7370 6563  operty(Size.spec
+00029aa0: 6961 6c5f 6469 6d73 2e66 6765 7429 0a20  ial_dims.fget). 
+00029ab0: 2020 2064 6566 2061 6464 5f73 7065 6369     def add_speci
+00029ac0: 616c 5f64 696d 2873 656c 662c 202a 6172  al_dim(self, *ar
+00029ad0: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+00029ae0: 2020 2020 2020 2073 656c 662e 7368 6170         self.shap
+00029af0: 6520 3d20 5369 7a65 2e61 6464 5f73 7065  e = Size.add_spe
+00029b00: 6369 616c 5f64 696d 2873 656c 662e 7368  cial_dim(self.sh
+00029b10: 6170 652c 202a 6172 6773 2c20 2a2a 6b77  ape, *args, **kw
+00029b20: 6172 6773 290a 2020 2020 2020 2020 7265  args).        re
+00029b30: 7475 726e 2073 656c 660a 2020 2020 6465  turn self.    de
+00029b40: 6620 6368 616e 6765 5f73 7065 6369 616c  f change_special
+00029b50: 5f64 696d 2873 656c 662c 202a 6172 6773  _dim(self, *args
+00029b60: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00029b70: 2020 2020 2073 656c 662e 7368 6170 6520       self.shape 
+00029b80: 3d20 5369 7a65 2e63 6861 6e67 655f 7370  = Size.change_sp
+00029b90: 6563 6961 6c5f 6469 6d28 7365 6c66 2e73  ecial_dim(self.s
+00029ba0: 6861 7065 2c20 2a61 7267 732c 202a 2a6b  hape, *args, **k
+00029bb0: 7761 7267 7329 0a20 2020 2020 2020 2072  wargs).        r
+00029bc0: 6574 7572 6e20 7365 6c66 0a20 2020 2073  eturn self.    s
+00029bd0: 7065 6369 616c 5f66 726f 6d20 3d20 5369  pecial_from = Si
+00029be0: 7a65 2e73 7065 6369 616c 5f66 726f 6d0a  ze.special_from.
+00029bf0: 2020 2020 7570 6461 7465 5f73 7065 6369      update_speci
+00029c00: 616c 5f66 726f 6d20 3d20 5369 7a65 2e75  al_from = Size.u
+00029c10: 7064 6174 655f 7370 6563 6961 6c5f 6672  pdate_special_fr
+00029c20: 6f6d 0a20 2020 2069 6e69 745f 7370 6563  om.    init_spec
+00029c30: 6961 6c20 3d20 5369 7a65 2e69 6e69 745f  ial = Size.init_
+00029c40: 7370 6563 6961 6c0a 2020 2020 6973 5f73  special.    is_s
+00029c50: 7065 6369 616c 6469 6d20 3d20 6973 5f73  pecialdim = is_s
+00029c60: 7065 6369 616c 5f64 696d 203d 2053 697a  pecial_dim = Siz
+00029c70: 652e 6973 5f73 7065 6369 616c 5f64 696d  e.is_special_dim
+00029c80: 0a20 2020 206e 656c 6520 3d20 6e5f 656c  .    nele = n_el
+00029c90: 6520 3d20 7072 6f70 6572 7479 286c 616d  e = property(lam
+00029ca0: 6264 6120 7365 6c66 3a20 5369 7a65 2e6e  bda self: Size.n
+00029cb0: 5f65 6c65 2e66 6765 7428 7365 6c66 2e73  _ele.fget(self.s
+00029cc0: 6861 7065 2929 0a20 2020 206e 6469 6d20  hape)).    ndim 
+00029cd0: 3d20 6e5f 6469 6d20 3d20 7072 6f70 6572  = n_dim = proper
+00029ce0: 7479 286c 616d 6264 6120 7365 6c66 3a20  ty(lambda self: 
+00029cf0: 7375 7065 7228 292e 6e64 696d 290a 2020  super().ndim).  
+00029d00: 2020 7079 7468 6f6e 5f72 6570 7220 3d20    python_repr = 
+00029d10: 7072 6f70 6572 7479 286c 616d 6264 6120  property(lambda 
+00029d20: 7365 6c66 3a20 7365 6c66 2e73 6861 7065  self: self.shape
+00029d30: 2e70 7974 686f 6e5f 7265 7072 290a 2020  .python_repr).  
+00029d40: 2020 0a20 2020 2064 6566 2068 6964 655f    .    def hide_
+00029d50: 7370 6563 6961 6c28 7365 6c66 293a 0a20  special(self):. 
+00029d60: 2020 2020 2020 2063 6c61 7373 2068 6964         class hid
+00029d70: 655f 7370 6563 6961 6c5f 6f70 6572 6174  e_special_operat
+00029d80: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00029d90: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+00029da0: 662c 2074 6869 7329 3a0a 2020 2020 2020  f, this):.      
+00029db0: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
+00029dc0: 6869 7320 3d20 7468 6973 0a20 2020 2020  his = this.     
+00029dd0: 2020 2020 2020 2064 6566 205f 5f65 6e74         def __ent
+00029de0: 6572 5f5f 2873 656c 6629 3a0a 2020 2020  er__(self):.    
+00029df0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00029e00: 2e73 7a5f 6675 6e63 5f64 696d 203d 2073  .sz_func_dim = s
+00029e10: 656c 662e 7468 6973 2e73 7a5f 6675 6e63  elf.this.sz_func
+00029e20: 5f64 696d 0a20 2020 2020 2020 2020 2020  _dim.           
+00029e30: 2020 2020 2073 656c 662e 737a 5f62 6174       self.sz_bat
+00029e40: 6368 5f64 696d 203d 2073 656c 662e 7468  ch_dim = self.th
+00029e50: 6973 2e73 7a5f 6261 7463 685f 6469 6d0a  is.sz_batch_dim.
+00029e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029e70: 7365 6c66 2e73 7a5f 6665 6174 7572 655f  self.sz_feature_
+00029e80: 6469 6d20 3d20 7365 6c66 2e74 6869 732e  dim = self.this.
+00029e90: 737a 5f66 6561 7475 7265 5f64 696d 0a20  sz_feature_dim. 
+00029ea0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00029eb0: 656c 662e 737a 5f73 6571 7565 6e63 655f  elf.sz_sequence_
+00029ec0: 6469 6d20 3d20 7365 6c66 2e74 6869 732e  dim = self.this.
+00029ed0: 737a 5f73 6571 7565 6e63 655f 6469 6d0a  sz_sequence_dim.
+00029ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029ef0: 7365 6c66 2e74 6869 732e 696e 6974 5f73  self.this.init_s
+00029f00: 7065 6369 616c 2829 0a20 2020 2020 2020  pecial().       
+00029f10: 2020 2020 2064 6566 205f 5f65 7869 745f       def __exit_
+00029f20: 5f28 7365 6c66 2c20 6578 635f 7479 7065  _(self, exc_type
+00029f30: 2c20 6578 635f 7661 6c75 652c 2074 7261  , exc_value, tra
+00029f40: 6365 6261 636b 293a 0a20 2020 2020 2020  ceback):.       
+00029f50: 2020 2020 2020 2020 2073 656c 662e 7468           self.th
+00029f60: 6973 2e73 7a5f 6675 6e63 5f64 696d 203d  is.sz_func_dim =
+00029f70: 2073 656c 662e 737a 5f66 756e 635f 6469   self.sz_func_di
+00029f80: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
+00029f90: 2020 7365 6c66 2e74 6869 732e 737a 5f62    self.this.sz_b
+00029fa0: 6174 6368 5f64 696d 203d 2073 656c 662e  atch_dim = self.
+00029fb0: 737a 5f62 6174 6368 5f64 696d 0a20 2020  sz_batch_dim.   
+00029fc0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00029fd0: 662e 7468 6973 2e73 7a5f 6665 6174 7572  f.this.sz_featur
+00029fe0: 655f 6469 6d20 3d20 7365 6c66 2e73 7a5f  e_dim = self.sz_
+00029ff0: 6665 6174 7572 655f 6469 6d0a 2020 2020  feature_dim.    
+0002a000: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0002a010: 2e74 6869 732e 737a 5f73 6571 7565 6e63  .this.sz_sequenc
+0002a020: 655f 6469 6d20 3d20 7365 6c66 2e73 7a5f  e_dim = self.sz_
+0002a030: 7365 7175 656e 6365 5f64 696d 0a20 2020  sequence_dim.   
+0002a040: 2020 2020 2072 6574 7572 6e20 6869 6465       return hide
+0002a050: 5f73 7065 6369 616c 5f6f 7065 7261 746f  _special_operato
+0002a060: 7228 7365 6c66 290a 2020 2020 0a20 2020  r(self).    .   
+0002a070: 2064 6566 206e 756d 656c 2873 656c 662c   def numel(self,
+0002a080: 202a 6469 6d3a 2065 7869 7374 5f64 696d   *dim: exist_dim
+0002a090: 293a 0a20 2020 2020 2020 2064 696d 203d  ):.        dim =
+0002a0a0: 2065 7869 7374 5f64 696d 2873 656c 662c   exist_dim(self,
+0002a0b0: 202a 6469 6d29 0a20 2020 2020 2020 2069   *dim).        i
+0002a0c0: 6620 6c65 6e28 6469 6d29 203e 2031 3a20  f len(dim) > 1: 
+0002a0d0: 7265 7475 726e 2070 726f 645f 2873 656c  return prod_(sel
+0002a0e0: 662e 7369 7a65 282a 6469 6d29 290a 2020  f.size(*dim)).  
+0002a0f0: 2020 2020 2020 656c 6966 206c 656e 2864        elif len(d
+0002a100: 696d 2920 3e20 303a 2072 6574 7572 6e20  im) > 0: return 
+0002a110: 7365 6c66 2e73 697a 6528 6469 6d5b 305d  self.size(dim[0]
+0002a120: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0002a130: 2031 0a20 2020 2064 6566 2064 696d 2873   1.    def dim(s
+0002a140: 656c 6629 3a20 7265 7475 726e 2073 7570  elf): return sup
+0002a150: 6572 2829 2e64 696d 2829 0a0a 2020 2020  er().dim()..    
+0002a160: 2320 4765 7420 616e 6420 6173 7369 676e  # Get and assign
+0002a170: 2074 6865 2073 6861 7065 2070 726f 7065   the shape prope
+0002a180: 7274 792e 2054 6865 2061 7373 6967 6e6d  rty. The assignm
+0002a190: 656e 7420 6973 206f 6e6c 7920 6163 6365  ent is only acce
+0002a1a0: 7373 6962 6c65 2066 6f72 2073 7065 6369  ssible for speci
+0002a1b0: 616c 2064 696d 656e 7369 6f6e 732e 2041  al dimensions. A
+0002a1c0: 7373 6967 6e69 6e67 2069 6e63 6f6e 7369  ssigning inconsi
+0002a1d0: 7374 656e 7420 7368 6170 6520 776f 756c  stent shape woul
+0002a1e0: 6420 7265 7375 6c74 2069 6e20 616e 2065  d result in an e
+0002a1f0: 7272 6f72 2e20 0a20 2020 2040 7072 6f70  rror. .    @prop
+0002a200: 6572 7479 0a20 2020 2064 6566 2073 6861  erty.    def sha
+0002a210: 7065 2873 656c 6629 3a0a 2020 2020 2020  pe(self):.      
+0002a220: 2020 6966 206e 6f74 2068 6173 6174 7472    if not hasattr
+0002a230: 2873 656c 662c 2027 737a 5f66 756e 635f  (self, 'sz_func_
+0002a240: 6469 6d27 293a 0a20 2020 2020 2020 2020  dim'):.         
+0002a250: 2020 2070 7966 696c 652c 206c 696e 656e     pyfile, linen
+0002a260: 6f2c 206c 696e 6520 3d20 6765 745f 7265  o, line = get_re
+0002a270: 6665 7265 6e63 655f 6c69 6e65 2873 6561  ference_line(sea
+0002a280: 7263 685f 6d6f 7265 3d54 7275 652c 2077  rch_more=True, w
+0002a290: 6974 685f 6c69 6e65 5f69 6e66 6f3d 5472  ith_line_info=Tr
+0002a2a0: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+0002a2b0: 7261 6973 6520 4174 7472 6962 7574 6545  raise AttributeE
+0002a2c0: 7272 6f72 2866 2247 6574 7469 6e67 2062  rror(f"Getting b
+0002a2d0: 6174 6f72 6368 2073 6861 7065 2066 726f  atorch shape fro
+0002a2e0: 6d20 616e 2075 6e69 6e69 7469 616c 697a  m an uninitializ
+0002a2f0: 6564 2054 656e 736f 7220 6f62 6a65 6374  ed Tensor object
+0002a300: 206f 6620 7369 7a65 207b 7375 7065 7228   of size {super(
+0002a310: 292e 7368 6170 657d 2c20 696e 206c 696e  ).shape}, in lin
+0002a320: 6520 7b6c 696e 656e 6f7d 2c20 7b70 7966  e {lineno}, {pyf
+0002a330: 696c 657d 3a20 5c6e 7b6c 696e 657d 2229  ile}: \n{line}")
+0002a340: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0002a350: 5369 7a65 2e5f 5f6e 6577 5f72 6177 5f5f  Size.__new_raw__
+0002a360: 2873 7570 6572 2829 2e73 6861 7065 2c20  (super().shape, 
+0002a370: 737a 5f66 756e 635f 6469 6d3d 7365 6c66  sz_func_dim=self
+0002a380: 2e73 7a5f 6675 6e63 5f64 696d 2c20 737a  .sz_func_dim, sz
+0002a390: 5f62 6174 6368 5f64 696d 3d73 656c 662e  _batch_dim=self.
+0002a3a0: 737a 5f62 6174 6368 5f64 696d 2c20 737a  sz_batch_dim, sz
+0002a3b0: 5f66 6561 7475 7265 5f64 696d 3d73 656c  _feature_dim=sel
+0002a3c0: 662e 737a 5f66 6561 7475 7265 5f64 696d  f.sz_feature_dim
+0002a3d0: 2c20 737a 5f73 6571 7565 6e63 655f 6469  , sz_sequence_di
+0002a3e0: 6d3d 7365 6c66 2e73 7a5f 7365 7175 656e  m=self.sz_sequen
+0002a3f0: 6365 5f64 696d 290a 2020 2020 0a20 2020  ce_dim).    .   
+0002a400: 2040 7368 6170 652e 7365 7474 6572 0a20   @shape.setter. 
+0002a410: 2020 2064 6566 2073 6861 7065 2873 656c     def shape(sel
+0002a420: 662c 202a 7829 3a20 7265 7475 726e 2073  f, *x): return s
+0002a430: 656c 662e 7769 7468 5f73 6861 7065 282a  elf.with_shape(*
+0002a440: 7829 0a0a 2020 2020 6465 6620 7369 7a65  x)..    def size
+0002a450: 2873 656c 662c 202a 6469 6d3a 2065 7869  (self, *dim: exi
+0002a460: 7374 5f64 696d 293a 0a20 2020 2020 2020  st_dim):.       
+0002a470: 2064 696d 203d 2065 7869 7374 5f64 696d   dim = exist_dim
+0002a480: 2873 656c 662c 2064 696d 290a 2020 2020  (self, dim).    
+0002a490: 2020 2020 7769 7468 2074 6f72 6368 2e5f      with torch._
+0002a4a0: 432e 4469 7361 626c 6554 6f72 6368 4675  C.DisableTorchFu
+0002a4b0: 6e63 7469 6f6e 2829 3a0a 2020 2020 2020  nction():.      
+0002a4c0: 2020 2020 2020 7369 7a65 7320 3d20 7475        sizes = tu
+0002a4d0: 706c 6528 746f 7263 685f 7375 7065 7228  ple(torch_super(
+0002a4e0: 7365 6c66 2c20 2773 697a 6527 2928 6429  self, 'size')(d)
+0002a4f0: 2066 6f72 2064 2069 6e20 6469 6d29 0a20   for d in dim). 
+0002a500: 2020 2020 2020 2069 6620 6c65 6e28 6469         if len(di
+0002a510: 6d29 203e 2031 3a20 7265 7475 726e 2073  m) > 1: return s
+0002a520: 697a 6573 0a20 2020 2020 2020 2065 6c73  izes.        els
+0002a530: 653a 2072 6574 7572 6e20 7369 7a65 735b  e: return sizes[
+0002a540: 305d 0a20 2020 200a 2020 2020 6465 6620  0].    .    def 
+0002a550: 7769 7468 5f73 6861 7065 2873 656c 662c  with_shape(self,
+0002a560: 202a 7829 3a0a 2020 2020 2020 2020 7820   *x):.        x 
+0002a570: 3d20 6172 675f 6578 7472 6163 7428 7829  = arg_extract(x)
+0002a580: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+0002a590: 7374 616e 6365 2878 2c20 5465 6e73 6f72  stance(x, Tensor
+0002a5a0: 293a 2078 203d 2078 2e73 6861 7065 0a20  ): x = x.shape. 
+0002a5b0: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+0002a5c0: 696e 7374 616e 6365 2878 2c20 5369 7a65  instance(x, Size
+0002a5d0: 293a 2078 203d 2053 697a 6528 7829 0a20  ): x = Size(x). 
+0002a5e0: 2020 2020 2020 2077 6974 6820 746f 7263         with torc
+0002a5f0: 682e 5f43 2e44 6973 6162 6c65 546f 7263  h._C.DisableTorc
+0002a600: 6846 756e 6374 696f 6e28 293a 0a20 2020  hFunction():.   
+0002a610: 2020 2020 2020 2020 2061 766f 7563 6828           avouch(
+0002a620: 616c 6c5f 2875 203d 3d20 7620 6f72 2076  all_(u == v or v
+0002a630: 203d 3d20 2d31 2066 6f72 2075 2c20 7620   == -1 for u, v 
+0002a640: 696e 207a 6970 2873 7570 6572 2829 2e73  in zip(super().s
+0002a650: 6861 7065 2c20 782e 7475 706c 6528 2929  hape, x.tuple())
+0002a660: 292c 2066 2243 616e 6e6f 7420 6173 7369  ), f"Cannot assi
+0002a670: 676e 2073 6861 7065 207b 787d 2074 6f20  gn shape {x} to 
+0002a680: 7465 6e73 6f72 2077 6974 6820 6461 7461  tensor with data
+0002a690: 2073 6861 7065 207b 7475 706c 6528 7375   shape {tuple(su
+0002a6a0: 7065 7228 292e 7368 6170 6529 7d2c 2064  per().shape)}, d
+0002a6b0: 7565 2074 6f20 756e 6571 7561 6c20 7369  ue to unequal si
+0002a6c0: 7a65 732e 2022 290a 2020 2020 2020 2020  zes. ").        
+0002a6d0: 7365 6c66 2e73 7065 6369 616c 5f66 726f  self.special_fro
+0002a6e0: 6d28 7829 0a20 2020 2020 2020 2072 6574  m(x).        ret
+0002a6f0: 7572 6e20 7365 6c66 0a20 2020 200a 2020  urn self.    .  
+0002a700: 2020 2320 436f 6e74 726f 6c20 7468 6520    # Control the 
+0002a710: 736c 6963 696e 6720 7379 7374 656d 2e20  slicing system. 
+0002a720: 0a20 2020 2064 6566 205f 5f67 6574 6974  .    def __getit
+0002a730: 656d 5f5f 2873 656c 662c 2069 6e64 6963  em__(self, indic
+0002a740: 6573 293a 0a20 2020 2020 2020 2073 6861  es):.        sha
+0002a750: 7065 7320 3d20 5b5d 0a20 2020 2020 2020  pes = [].       
+0002a760: 2069 6620 6973 696e 7374 616e 6365 2869   if isinstance(i
+0002a770: 6e64 6963 6573 2c20 2873 6c69 6365 2c20  ndices, (slice, 
+0002a780: 746f 7263 682e 5465 6e73 6f72 2929 206f  torch.Tensor)) o
+0002a790: 7220 696e 6469 6365 7320 6973 202e 2e2e  r indices is ...
+0002a7a0: 3a20 696e 6469 6365 7320 3d20 2869 6e64  : indices = (ind
+0002a7b0: 6963 6573 2c29 0a20 2020 2020 2020 2069  ices,).        i
+0002a7c0: 6620 6973 696e 7374 616e 6365 2869 6e64  f isinstance(ind
+0002a7d0: 6963 6573 2c20 7475 706c 6529 3a0a 2020  ices, tuple):.  
+0002a7e0: 2020 2020 2020 2020 2020 7371 7565 657a            squeez
+0002a7f0: 655f 6469 6d73 203d 205b 5d0a 2020 2020  e_dims = [].    
+0002a800: 2020 2020 2020 2020 756e 7371 7565 657a          unsqueez
+0002a810: 655f 6469 6d73 203d 205b 5d0a 2020 2020  e_dims = [].    
+0002a820: 2020 2020 2020 2020 6f66 6673 6574 203d          offset =
+0002a830: 2030 0a20 2020 2020 2020 2020 2020 2066   0.            f
+0002a840: 6f72 2069 2c20 7820 696e 2065 6e75 6d65  or i, x in enume
+0002a850: 7261 7465 2869 6e64 6963 6573 293a 0a20  rate(indices):. 
+0002a860: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002a870: 202b 3d20 6f66 6673 6574 0a20 2020 2020   += offset.     
+0002a880: 2020 2020 2020 2020 2020 2069 6620 7820             if x 
+0002a890: 6973 202e 2e2e 3a20 6f66 6673 6574 202b  is ...: offset +
+0002a8a0: 3d20 7365 6c66 2e6e 5f64 696d 202d 206c  = self.n_dim - l
+0002a8b0: 656e 2869 6e64 6963 6573 293b 2063 6f6e  en(indices); con
+0002a8c0: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
+0002a8d0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+0002a8e0: 6e63 6528 782c 2069 6e74 5f29 3a20 7371  nce(x, int_): sq
+0002a8f0: 7565 657a 655f 6469 6d73 2e61 7070 656e  ueeze_dims.appen
+0002a900: 6428 6929 3b20 636f 6e74 696e 7565 0a20  d(i); continue. 
+0002a910: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002a920: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+0002a930: 736c 6963 6529 3a20 636f 6e74 696e 7565  slice): continue
+0002a940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a950: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
+0002a960: 2c20 746f 7263 682e 5465 6e73 6f72 293a  , torch.Tensor):
+0002a970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a980: 2020 2020 2069 6620 6973 7375 6263 6c61       if issubcla
+0002a990: 7373 2878 2e64 7479 7065 2c20 6474 7970  ss(x.dtype, dtyp
+0002a9a0: 655f 2862 6f6f 6c29 293a 0a20 2020 2020  e_(bool)):.     
+0002a9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a9c0: 2020 2061 766f 7563 6828 7365 6c66 2e73     avouch(self.s
+0002a9d0: 6861 7065 5b69 3a69 2b78 2e6e 5f64 696d  hape[i:i+x.n_dim
+0002a9e0: 5d20 3d3d 2078 2e73 6861 7065 2c20 5479  ] == x.shape, Ty
+0002a9f0: 7065 4572 726f 7228 2242 6f6f 6c20 696e  peError("Bool in
+0002aa00: 6469 6365 7320 666f 7220 7465 6e73 6f72  dices for tensor
+0002aa10: 2073 686f 756c 6420 6265 206f 6620 6578   should be of ex
+0002aa20: 6163 7420 7361 6d65 2073 697a 6520 6173  act same size as
+0002aa30: 2074 6865 2069 6e70 7574 2074 656e 736f   the input tenso
+0002aa40: 722e 2022 2929 0a20 2020 2020 2020 2020  r. ")).         
+0002aa50: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0002aa60: 6666 7365 7420 2b3d 2078 2e6e 5f64 696d  ffset += x.n_dim
+0002aa70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002aa80: 2020 2020 2020 2020 2075 6e73 7175 6565           unsquee
+0002aa90: 7a65 5f64 696d 732e 6170 7065 6e64 2828  ze_dims.append((
+0002aaa0: 6920 2b20 6c65 6e28 756e 7371 7565 657a  i + len(unsqueez
+0002aab0: 655f 6469 6d73 2920 2d20 6c65 6e28 7371  e_dims) - len(sq
+0002aac0: 7565 657a 655f 6469 6d73 292c 2078 2e73  ueeze_dims), x.s
+0002aad0: 6861 7065 5b3a 315d 2929 0a20 2020 2020  hape[:1])).     
+0002aae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aaf0: 2020 2073 7175 6565 7a65 5f64 696d 732e     squeeze_dims.
+0002ab00: 6578 7465 6e64 2872 616e 6765 5f28 692c  extend(range_(i,
+0002ab10: 2069 202b 2078 2e6e 5f64 696d 2929 0a20   i + x.n_dim)). 
+0002ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ab30: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+0002ab40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ab50: 2020 2020 7368 6170 6573 2e61 7070 656e      shapes.appen
+0002ab60: 6428 782e 7368 6170 6529 0a20 2020 2020  d(x.shape).     
+0002ab70: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0002ab80: 2073 6861 7065 732e 6170 7065 6e64 2854   shapes.append(T
+0002ab90: 656e 736f 7228 7829 2e73 6861 7065 290a  ensor(x).shape).
+0002aba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002abb0: 7371 7565 657a 655f 6469 6d73 2e61 7070  squeeze_dims.app
+0002abc0: 656e 6428 6929 0a20 2020 2020 2020 2065  end(i).        e
+0002abd0: 6c69 6620 6973 696e 7374 616e 6365 2869  lif isinstance(i
+0002abe0: 6e64 6963 6573 2c20 696e 745f 293a 2073  ndices, int_): s
+0002abf0: 7175 6565 7a65 5f64 696d 7320 3d20 5b30  queeze_dims = [0
+0002ac00: 5d3b 2075 6e73 7175 6565 7a65 5f64 696d  ]; unsqueeze_dim
+0002ac10: 7320 3d20 5b5d 0a20 2020 2020 2020 2065  s = [].        e
+0002ac20: 6c73 653a 2072 6169 7365 2054 7970 6545  lse: raise TypeE
+0002ac30: 7272 6f72 2866 2249 6e76 616c 6964 2069  rror(f"Invalid i
+0002ac40: 6e64 6963 6573 203d 207b 696e 6469 6365  ndices = {indice
+0002ac50: 737d 2066 6f72 2074 656e 736f 7220 696e  s} for tensor in
+0002ac60: 6465 7869 6e67 2e20 2229 0a20 2020 2020  dexing. ").     
+0002ac70: 2020 2069 6620 7371 7565 657a 655f 6469     if squeeze_di
+0002ac80: 6d73 2061 6e64 2061 6c6c 5f28 7920 2d20  ms and all_(y - 
+0002ac90: 7820 3d3d 2031 2066 6f72 2078 2c20 7920  x == 1 for x, y 
+0002aca0: 696e 207a 6970 2873 7175 6565 7a65 5f64  in zip(squeeze_d
+0002acb0: 696d 735b 3a2d 315d 2c20 7371 7565 657a  ims[:-1], squeez
+0002acc0: 655f 6469 6d73 5b31 3a5d 2929 3a0a 2020  e_dims[1:])):.  
+0002acd0: 2020 2020 2020 2020 2020 6e65 775f 7368            new_sh
+0002ace0: 6170 6520 3d20 7365 6c66 2e73 6861 7065  ape = self.shape
+0002acf0: 5b3a 7371 7565 657a 655f 6469 6d73 5b30  [:squeeze_dims[0
+0002ad00: 5d5d 202b 2062 726f 6164 6361 7374 282a  ]] + broadcast(*
+0002ad10: 7368 6170 6573 2920 2b20 7365 6c66 2e73  shapes) + self.s
+0002ad20: 6861 7065 5b73 7175 6565 7a65 5f64 696d  hape[squeeze_dim
+0002ad30: 735b 2d31 5d2b 313a 5d0a 2020 2020 2020  s[-1]+1:].      
+0002ad40: 2020 656c 7365 3a20 6e65 775f 7368 6170    else: new_shap
+0002ad50: 6520 3d20 6272 6f61 6463 6173 7428 2a73  e = broadcast(*s
+0002ad60: 6861 7065 7329 202b 2072 656d 6f76 655f  hapes) + remove_
+0002ad70: 6469 6d28 7365 6c66 2e73 6861 7065 2c20  dim(self.shape, 
+0002ad80: 7371 7565 657a 655f 6469 6d73 290a 2020  squeeze_dims).  
+0002ad90: 2020 2020 2020 666f 7220 692c 2078 2069        for i, x i
+0002ada0: 6e20 756e 7371 7565 657a 655f 6469 6d73  n unsqueeze_dims
+0002adb0: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
+0002adc0: 775f 7368 6170 6520 3d20 6e65 775f 7368  w_shape = new_sh
+0002add0: 6170 655b 3a69 5d20 2b20 7820 2b20 6e65  ape[:i] + x + ne
+0002ade0: 775f 7368 6170 655b 693a 5d0a 2020 2020  w_shape[i:].    
+0002adf0: 2020 2020 7769 7468 2074 6f72 6368 2e5f      with torch._
+0002ae00: 432e 4469 7361 626c 6554 6f72 6368 4675  C.DisableTorchFu
+0002ae10: 6e63 7469 6f6e 2829 3a0a 2020 2020 2020  nction():.      
+0002ae20: 2020 2020 2020 7265 7475 726e 2074 6f72        return tor
+0002ae30: 6368 2e54 656e 736f 722e 5f5f 6765 7469  ch.Tensor.__geti
+0002ae40: 7465 6d5f 5f28 7365 6c66 2c20 696e 6469  tem__(self, indi
+0002ae50: 6365 7329 2e61 735f 7375 6263 6c61 7373  ces).as_subclass
+0002ae60: 2854 656e 736f 7229 2e73 7065 6369 616c  (Tensor).special
+0002ae70: 5f66 726f 6d28 6e65 775f 7368 6170 6529  _from(new_shape)
+0002ae80: 2e67 7261 645f 666e 5f6e 616d 655f 2822  .grad_fn_name_("
+0002ae90: 696e 6465 7869 6e67 2229 0a20 2020 2020  indexing").     
+0002aea0: 2020 2020 2020 2023 2072 6574 7572 6e20         # return 
+0002aeb0: 5465 6e73 6f72 2e5f 6d61 6b65 5f73 7562  Tensor._make_sub
+0002aec0: 636c 6173 7328 5465 6e73 6f72 2c20 7375  class(Tensor, su
+0002aed0: 7065 7228 292e 5f5f 6765 7469 7465 6d5f  per().__getitem_
+0002aee0: 5f28 696e 6469 6365 7329 2e61 735f 7375  _(indices).as_su
+0002aef0: 6263 6c61 7373 2874 6f72 6368 2e54 656e  bclass(torch.Ten
+0002af00: 736f 7229 2c20 7265 665f 7369 7a65 3d6e  sor), ref_size=n
+0002af10: 6577 5f73 6861 7065 292e 6772 6164 5f66  ew_shape).grad_f
+0002af20: 6e5f 6e61 6d65 5f28 2269 6e64 6578 696e  n_name_("indexin
+0002af30: 6722 290a 2020 2020 0a20 2020 2064 6566  g").    .    def
+0002af40: 205f 5f69 7465 725f 5f28 7365 6c66 293a   __iter__(self):
+0002af50: 0a20 2020 2020 2020 2066 6f72 2069 2069  .        for i i
+0002af60: 6e20 7261 6e67 655f 2873 656c 662e 7369  n range_(self.si
+0002af70: 7a65 2830 2929 3a0a 2020 2020 2020 2020  ze(0)):.        
+0002af80: 2020 2020 7969 656c 6420 7365 6c66 5b69      yield self[i
+0002af90: 5d0a 2020 2020 2020 2020 0a20 2020 2023  ].        .    #
+0002afa0: 204d 616e 6970 756c 6174 6520 6469 6d65   Manipulate dime
+0002afb0: 6e73 696f 6e73 2e0a 2020 2020 4070 726f  nsions..    @pro
+0002afc0: 7065 7274 790a 2020 2020 6465 6620 5428  perty.    def T(
+0002afd0: 7365 6c66 3a20 2754 656e 736f 7227 2c20  self: 'Tensor', 
+0002afe0: 6469 6d3a 206c 696e 616c 675f 6469 6d5b  dim: linalg_dim[
+0002aff0: 313a 5d3d 4e6f 6e65 293a 0a20 2020 2020  1:]=None):.     
+0002b000: 2020 2073 6861 7065 203d 2073 656c 662e     shape = self.
+0002b010: 7368 6170 650a 2020 2020 2020 2020 6469  shape.        di
+0002b020: 6d20 3d20 6c69 6e61 6c67 5f64 696d 5b31  m = linalg_dim[1
+0002b030: 3a5d 2873 656c 662e 7368 6170 652c 2064  :](self.shape, d
+0002b040: 696d 290a 2020 2020 2020 2020 6469 6d5f  im).        dim_
+0002b050: 6f72 6465 7220 3d20 5b69 2069 6620 6920  order = [i if i 
+0002b060: 6e6f 7420 696e 2064 696d 2065 6c73 6520  not in dim else 
+0002b070: 6469 6d5b 2d64 696d 2e69 6e64 6578 2869  dim[-dim.index(i
+0002b080: 2920 2d20 315d 2066 6f72 2069 2069 6e20  ) - 1] for i in 
+0002b090: 7261 6e67 655f 2873 656c 662e 6e5f 6469  range_(self.n_di
+0002b0a0: 6d29 5d0a 2020 2020 2020 2020 756e 7371  m)].        unsq
+0002b0b0: 5f64 696d 203d 2073 656c 662e 7368 6170  _dim = self.shap
+0002b0c0: 655b 6469 6d5b 305d 3a64 696d 5b30 5d2b  e[dim[0]:dim[0]+
+0002b0d0: 315d 2e77 6974 685f 6469 6d5f 7369 7a65  1].with_dim_size
+0002b0e0: 2830 2c20 6469 6d5b 305d 292e 7079 7468  (0, dim[0]).pyth
+0002b0f0: 6f6e 5f72 6570 720a 2020 2020 2020 2020  on_repr.        
+0002b100: 6966 206c 656e 2864 696d 2920 3d3d 2031  if len(dim) == 1
+0002b110: 3a20 7265 7475 726e 2073 656c 662e 7065  : return self.pe
+0002b120: 726d 7574 6528 2a64 696d 5f6f 7264 6572  rmute(*dim_order
+0002b130: 292e 756e 7371 7565 657a 6528 756e 7371  ).unsqueeze(unsq
+0002b140: 5f64 696d 292e 6772 6164 5f66 6e5f 6e61  _dim).grad_fn_na
+0002b150: 6d65 5f28 2774 7261 6e73 706f 7365 2729  me_('transpose')
+0002b160: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0002b170: 7365 6c66 2e70 6572 6d75 7465 282a 6469  self.permute(*di
+0002b180: 6d5f 6f72 6465 7229 2e67 7261 645f 666e  m_order).grad_fn
+0002b190: 5f6e 616d 655f 2827 7472 616e 7370 6f73  _name_('transpos
+0002b1a0: 6527 290a 2020 2020 0a20 2020 2064 6566  e').    .    def
+0002b1b0: 2074 5f28 7365 6c66 3a20 2754 656e 736f   t_(self: 'Tenso
+0002b1c0: 7227 2c20 6469 6d3a 206c 696e 616c 675f  r', dim: linalg_
+0002b1d0: 6469 6d5b 313a 5d3d 4e6f 6e65 293a 0a20  dim[1:]=None):. 
+0002b1e0: 2020 2020 2020 2073 6861 7065 203d 2073         shape = s
+0002b1f0: 656c 662e 7368 6170 650a 2020 2020 2020  elf.shape.      
+0002b200: 2020 6469 6d20 3d20 6c69 6e61 6c67 5f64    dim = linalg_d
+0002b210: 696d 5b31 3a5d 2873 656c 662e 7368 6170  im[1:](self.shap
+0002b220: 652c 2064 696d 290a 2020 2020 2020 2020  e, dim).        
+0002b230: 6469 6d5f 6f72 6465 7220 3d20 5b69 2069  dim_order = [i i
+0002b240: 6620 6920 6e6f 7420 696e 2064 696d 2065  f i not in dim e
+0002b250: 6c73 6520 6469 6d5b 2d64 696d 2e69 6e64  lse dim[-dim.ind
+0002b260: 6578 2869 2920 2d20 315d 2066 6f72 2069  ex(i) - 1] for i
+0002b270: 2069 6e20 7261 6e67 655f 2873 656c 662e   in range_(self.
+0002b280: 6e5f 6469 6d29 5d0a 2020 2020 2020 2020  n_dim)].        
+0002b290: 756e 7371 5f64 696d 203d 2073 656c 662e  unsq_dim = self.
+0002b2a0: 7368 6170 655b 6469 6d5b 305d 3a64 696d  shape[dim[0]:dim
+0002b2b0: 5b30 5d2b 315d 2e77 6974 685f 6469 6d5f  [0]+1].with_dim_
+0002b2c0: 7369 7a65 2830 2c20 6469 6d5b 305d 292e  size(0, dim[0]).
+0002b2d0: 7079 7468 6f6e 5f72 6570 720a 2020 2020  python_repr.    
+0002b2e0: 2020 2020 6966 206c 656e 2864 696d 2920      if len(dim) 
+0002b2f0: 3d3d 2031 3a20 7265 7475 726e 2073 656c  == 1: return sel
+0002b300: 662e 7065 726d 7574 6528 2a64 696d 5f6f  f.permute(*dim_o
+0002b310: 7264 6572 292e 756e 7371 7565 657a 6528  rder).unsqueeze(
+0002b320: 756e 7371 5f64 696d 292e 6772 6164 5f66  unsq_dim).grad_f
+0002b330: 6e5f 6e61 6d65 5f28 2774 7261 6e73 706f  n_name_('transpo
+0002b340: 7365 2729 0a20 2020 2020 2020 2072 6574  se').        ret
+0002b350: 7572 6e20 7365 6c66 2e70 6572 6d75 7465  urn self.permute
+0002b360: 5f28 2a64 696d 5f6f 7264 6572 292e 6772  _(*dim_order).gr
+0002b370: 6164 5f66 6e5f 6e61 6d65 5f28 2774 7261  ad_fn_name_('tra
+0002b380: 6e73 706f 7365 5f27 290a 2020 2020 0a20  nspose_').    . 
+0002b390: 2020 2064 6566 2070 6572 6d75 7465 5f28     def permute_(
+0002b3a0: 7365 6c66 3a20 2754 656e 736f 7227 2c20  self: 'Tensor', 
+0002b3b0: 2a64 696d 733a 2065 7869 7374 5f64 696d  *dims: exist_dim
+0002b3c0: 293a 0a20 2020 2020 2020 2064 696d 7320  ):.        dims 
+0002b3d0: 3d20 6578 6973 745f 6469 6d28 7365 6c66  = exist_dim(self
+0002b3e0: 2c20 2a64 696d 7329 0a20 2020 2020 2020  , *dims).       
+0002b3f0: 2061 766f 7563 6828 6c65 6e28 6469 6d73   avouch(len(dims
+0002b400: 2920 3d3d 2073 656c 662e 6e64 696d 2c20  ) == self.ndim, 
+0002b410: 5275 6e74 696d 6545 7272 6f72 2866 2270  RuntimeError(f"p
+0002b420: 6572 6d75 7465 5f28 7370 6172 7365 5f63  ermute_(sparse_c
+0002b430: 6f6f 293a 206e 756d 6265 7220 6f66 2064  oo): number of d
+0002b440: 696d 656e 7369 6f6e 7320 696e 2074 6865  imensions in the
+0002b450: 2074 656e 736f 7220 696e 7075 7420 646f   tensor input do
+0002b460: 6573 206e 6f74 206d 6174 6368 2074 6865  es not match the
+0002b470: 206c 656e 6774 6820 6f66 2074 6865 2064   length of the d
+0002b480: 6573 6972 6564 206f 7264 6572 696e 6720  esired ordering 
+0002b490: 6f66 2064 696d 656e 7369 6f6e 7320 692e  of dimensions i.
+0002b4a0: 652e 2069 6e70 7574 2e64 696d 2829 203d  e. input.dim() =
+0002b4b0: 207b 7365 6c66 2e6e 5f64 696d 7d20 6973   {self.n_dim} is
+0002b4c0: 206e 6f74 2065 7175 616c 2074 6f20 6c65   not equal to le
+0002b4d0: 6e28 6469 6d73 2920 3d20 7b6c 656e 2864  n(dims) = {len(d
+0002b4e0: 696d 7329 7d22 2929 0a20 2020 2020 2020  ims)}")).       
+0002b4f0: 2063 7572 5f6f 7264 6572 203d 206c 6973   cur_order = lis
+0002b500: 7428 7261 6e67 655f 2873 656c 662e 6e64  t(range_(self.nd
+0002b510: 696d 2929 0a20 2020 2020 2020 2073 7065  im)).        spe
+0002b520: 6369 616c 5f73 6861 7065 203d 2073 656c  cial_shape = sel
+0002b530: 662e 7368 6170 650a 2020 2020 2020 2020  f.shape.        
+0002b540: 7365 6c66 2e69 6e69 745f 7370 6563 6961  self.init_specia
+0002b550: 6c28 290a 2020 2020 2020 2020 666f 7220  l().        for 
+0002b560: 6920 696e 2072 616e 6765 5f28 6c65 6e28  i in range_(len(
+0002b570: 6375 725f 6f72 6465 7229 293a 0a20 2020  cur_order)):.   
+0002b580: 2020 2020 2020 2020 206a 203d 2063 7572           j = cur
+0002b590: 5f6f 7264 6572 2e69 6e64 6578 2864 696d  _order.index(dim
+0002b5a0: 735b 695d 290a 2020 2020 2020 2020 2020  s[i]).          
+0002b5b0: 2020 6966 206a 203d 3d20 693a 2063 6f6e    if j == i: con
+0002b5c0: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
+0002b5d0: 2020 6375 725f 6f72 6465 725b 695d 2c20    cur_order[i], 
+0002b5e0: 6375 725f 6f72 6465 725b 6a5d 203d 2063  cur_order[j] = c
+0002b5f0: 7572 5f6f 7264 6572 5b6a 5d2c 2063 7572  ur_order[j], cur
+0002b600: 5f6f 7264 6572 5b69 5d0a 2020 2020 2020  _order[i].      
+0002b610: 2020 2020 2020 7365 6c66 2e74 7261 6e73        self.trans
+0002b620: 706f 7365 5f28 692c 206a 290a 2020 2020  pose_(i, j).    
+0002b630: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0002b640: 7370 6563 6961 6c5f 6672 6f6d 2873 7065  special_from(spe
+0002b650: 6369 616c 5f73 6861 7065 2e70 6572 6d75  cial_shape.permu
+0002b660: 7465 282a 6469 6d73 2929 2e67 7261 645f  te(*dims)).grad_
+0002b670: 666e 5f6e 616d 655f 2827 7065 726d 7574  fn_name_('permut
+0002b680: 655f 2729 0a0a 2020 2020 4061 6c69 6173  e_')..    @alias
+0002b690: 2822 6d6f 7665 6469 6d22 290a 2020 2020  ("movedim").    
+0002b6a0: 6465 6620 6d6f 7665 5f64 696d 2873 656c  def move_dim(sel
+0002b6b0: 662c 2064 696d 313a 2064 656c 5f64 696d  f, dim1: del_dim
+0002b6c0: 2c20 6469 6d32 3a20 6578 6973 745f 6469  , dim2: exist_di
+0002b6d0: 6d29 3a0a 2020 2020 2020 2020 2222 220a  m):.        """.
+0002b6e0: 2020 2020 2020 2020 6d6f 7665 6469 6d28          movedim(
+0002b6f0: 7365 6c66 2c20 6469 6d31 2c20 6469 6d32  self, dim1, dim2
+0002b700: 2920 2d3e 2054 656e 736f 720a 0a20 2020  ) -> Tensor..   
+0002b710: 2020 2020 206d 6f76 6520 6469 6d31 2074       move dim1 t
+0002b720: 6f20 6469 6d32 2028 7370 6563 6966 6965  o dim2 (specifie
+0002b730: 6420 696e 2074 6865 2074 6172 6765 7469  d in the targeti
+0002b740: 6e67 2073 697a 6529 0a20 2020 2020 2020  ng size).       
+0002b750: 2064 6174 6120 6f66 2073 697a 6520 2832   data of size (2
+0002b760: 2c20 332c 2034 2c20 3529 2063 616e 2062  , 3, 4, 5) can b
+0002b770: 6520 7472 616e 7366 6f72 6d20 746f 2028  e transform to (
+0002b780: 322c 2034 2c20 352c 2033 2920 6279 2064  2, 4, 5, 3) by d
+0002b790: 6174 612e 6d6f 7665 6469 6d28 312c 202d  ata.movedim(1, -
+0002b7a0: 3129 206f 7220 6461 7461 2e6d 6f76 6564  1) or data.moved
+0002b7b0: 696d 2831 2c20 3329 0a20 2020 2020 2020  im(1, 3).       
+0002b7c0: 2022 2222 0a20 2020 2020 2020 2072 6566   """.        ref
+0002b7d0: 5f73 6861 7065 203d 2053 697a 6528 6469  _shape = Size(di
+0002b7e0: 6d32 290a 2020 2020 2020 2020 6469 6d31  m2).        dim1
+0002b7f0: 203d 2064 656c 5f64 696d 2873 656c 662e   = del_dim(self.
+0002b800: 7368 6170 652c 2064 696d 3129 0a20 2020  shape, dim1).   
+0002b810: 2020 2020 2064 696d 3220 3d20 6578 6973       dim2 = exis
+0002b820: 745f 6469 6d28 7365 6c66 2e73 6861 7065  t_dim(self.shape
+0002b830: 2c20 6469 6d32 290a 2020 2020 2020 2020  , dim2).        
+0002b840: 6176 6f75 6368 286c 656e 2864 696d 3129  avouch(len(dim1)
+0002b850: 203d 3d20 6c65 6e28 6469 6d32 2920 6f72   == len(dim2) or
+0002b860: 206c 656e 2864 696d 3229 3d3d 2031 2c20   len(dim2)== 1, 
+0002b870: 2254 656e 736f 722e 6d6f 7665 5f64 696d  "Tensor.move_dim
+0002b880: 206f 6e6c 7920 7461 6b65 7320 6469 6d65   only takes dime
+0002b890: 6e73 696f 6e20 6f66 2073 616d 6520 7369  nsion of same si
+0002b8a0: 7a65 206f 7220 6f6e 6520 7461 7267 6574  ze or one target
+0002b8b0: 2064 696d 2e22 290a 2020 2020 2020 2020   dim.").        
+0002b8c0: 6966 206c 656e 2864 696d 3229 203d 3d20  if len(dim2) == 
+0002b8d0: 313a 0a20 2020 2020 2020 2020 2020 2064  1:.            d
+0002b8e0: 3220 3d20 6469 6d32 5b30 5d0a 2020 2020  2 = dim2[0].    
+0002b8f0: 2020 2020 2020 2020 6966 2061 6c6c 5f28          if all_(
+0002b900: 6420 3e20 6432 2066 6f72 2064 2069 6e20  d > d2 for d in 
+0002b910: 6469 6d31 293a 0a20 2020 2020 2020 2020  dim1):.         
+0002b920: 2020 2020 2020 2064 696d 656e 7369 6f6e         dimension
+0002b930: 7320 3d20 6c69 7374 2872 616e 6765 5f28  s = list(range_(
+0002b940: 6432 2929 202b 206c 6973 7428 6469 6d31  d2)) + list(dim1
+0002b950: 2920 2b20 5b69 2066 6f72 2069 2069 6e20  ) + [i for i in 
+0002b960: 7261 6e67 655f 2864 322c 2073 656c 662e  range_(d2, self.
+0002b970: 6e5f 6469 6d29 2069 6620 6920 6e6f 7420  n_dim) if i not 
+0002b980: 696e 2064 696d 315d 0a20 2020 2020 2020  in dim1].       
+0002b990: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0002b9a0: 2020 2020 2020 2020 2020 2064 696d 656e             dimen
+0002b9b0: 7369 6f6e 7320 3d20 5b69 2066 6f72 2069  sions = [i for i
+0002b9c0: 2069 6e20 7261 6e67 655f 2864 322b 3129   in range_(d2+1)
+0002b9d0: 2069 6620 6920 6e6f 7420 696e 2064 696d   if i not in dim
+0002b9e0: 315d 202b 206c 6973 7428 6469 6d31 2920  1] + list(dim1) 
+0002b9f0: 2b20 5b69 2066 6f72 2069 2069 6e20 7261  + [i for i in ra
+0002ba00: 6e67 655f 2864 322b 312c 2073 656c 662e  nge_(d2+1, self.
+0002ba10: 6e5f 6469 6d29 2069 6620 6920 6e6f 7420  n_dim) if i not 
+0002ba20: 696e 2064 696d 315d 0a20 2020 2020 2020  in dim1].       
+0002ba30: 2020 2020 2072 6573 203d 2073 656c 662e       res = self.
+0002ba40: 7065 726d 7574 6528 2a64 696d 656e 7369  permute(*dimensi
+0002ba50: 6f6e 7329 2e61 6464 5f73 7065 6369 616c  ons).add_special
+0002ba60: 5f64 696d 2864 322c 2064 696d 3229 0a20  _dim(d2, dim2). 
+0002ba70: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002ba80: 2020 2020 2020 2020 2064 696d 656e 7369           dimensi
+0002ba90: 6f6e 7320 3d20 5b30 5d20 2a20 7365 6c66  ons = [0] * self
+0002baa0: 2e6e 5f64 696d 0a20 2020 2020 2020 2020  .n_dim.         
+0002bab0: 2020 2061 7373 6967 6e65 6420 3d20 5b46     assigned = [F
+0002bac0: 616c 7365 5d20 2a20 7365 6c66 2e6e 5f64  alse] * self.n_d
+0002bad0: 696d 0a20 2020 2020 2020 2020 2020 2066  im.            f
+0002bae0: 6f72 2069 2069 6e20 6469 6d31 3a0a 2020  or i in dim1:.  
+0002baf0: 2020 2020 2020 2020 2020 2020 2020 6a20                j 
+0002bb00: 3d20 6469 6d32 5b64 696d 312e 696e 6465  = dim2[dim1.inde
+0002bb10: 7828 6929 5d0a 2020 2020 2020 2020 2020  x(i)].          
+0002bb20: 2020 2020 2020 6469 6d65 6e73 696f 6e73        dimensions
+0002bb30: 5b6a 5d20 3d20 690a 2020 2020 2020 2020  [j] = i.        
+0002bb40: 2020 2020 2020 2020 6173 7369 676e 6564          assigned
+0002bb50: 5b6a 5d20 3d20 5472 7565 0a20 2020 2020  [j] = True.     
+0002bb60: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+0002bb70: 7261 6e67 655f 2873 656c 662e 6e5f 6469  range_(self.n_di
+0002bb80: 6d29 3a0a 2020 2020 2020 2020 2020 2020  m):.            
+0002bb90: 2020 2020 6966 2069 2069 6e20 6469 6d31      if i in dim1
+0002bba0: 3a20 636f 6e74 696e 7565 0a20 2020 2020  : continue.     
+0002bbb0: 2020 2020 2020 2020 2020 206a 203d 2061             j = a
+0002bbc0: 7373 6967 6e65 642e 696e 6465 7828 4661  ssigned.index(Fa
+0002bbd0: 6c73 6529 0a20 2020 2020 2020 2020 2020  lse).           
+0002bbe0: 2020 2020 2064 696d 656e 7369 6f6e 735b       dimensions[
+0002bbf0: 6a5d 203d 2069 0a20 2020 2020 2020 2020  j] = i.         
+0002bc00: 2020 2020 2020 2061 7373 6967 6e65 645b         assigned[
+0002bc10: 6a5d 203d 2054 7275 650a 2020 2020 2020  j] = True.      
+0002bc20: 2020 2020 2020 6176 6f75 6368 2861 6c6c        avouch(all
+0002bc30: 5f28 6173 7369 676e 6564 292c 2052 756e  _(assigned), Run
+0002bc40: 7469 6d65 4572 726f 7228 6622 4e6f 7420  timeError(f"Not 
+0002bc50: 7065 726d 7574 6520 666f 7220 6469 6d65  permute for dime
+0002bc60: 6e73 696f 6e20 6d6f 7665 2069 6620 6469  nsion move if di
+0002bc70: 6d31 3d7b 6469 6d31 7d20 616e 6420 6469  m1={dim1} and di
+0002bc80: 6d32 3d7b 6469 6d32 7d2e 2022 2929 0a20  m2={dim2}. ")). 
+0002bc90: 2020 2020 2020 2020 2020 2072 6573 203d             res =
+0002bca0: 2073 656c 662e 7065 726d 7574 6528 2a64   self.permute(*d
+0002bcb0: 696d 656e 7369 6f6e 7329 0a20 2020 2020  imensions).     
+0002bcc0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+0002bcd0: 7261 6e67 655f 286c 656e 2864 696d 3229  range_(len(dim2)
+0002bce0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0002bcf0: 2020 2072 6573 2e61 6464 5f73 7065 6369     res.add_speci
+0002bd00: 616c 5f64 696d 2864 696d 325b 695d 2c20  al_dim(dim2[i], 
+0002bd10: 6469 6d32 5b69 3a69 2b31 5d29 0a20 2020  dim2[i:i+1]).   
+0002bd20: 2020 2020 2072 6574 7572 6e20 7265 732e       return res.
+0002bd30: 6772 6164 5f66 6e5f 6e61 6d65 5f28 276d  grad_fn_name_('m
+0002bd40: 6f76 655f 6469 6d27 290a 2020 2020 2020  ove_dim').      
+0002bd50: 2020 2020 2020 0a20 2020 2020 2020 2023        .        #
+0002bd60: 2064 3120 3d20 6469 6d31 5b30 5d0a 2020   d1 = dim1[0].  
+0002bd70: 2020 2020 2020 2320 6432 203d 2064 696d        # d2 = dim
+0002bd80: 325b 305d 0a0a 2020 2020 2020 2020 2320  2[0]..        # 
+0002bd90: 6966 2064 3120 3c20 6432 3a20 7265 7475  if d1 < d2: retu
+0002bda0: 726e 2073 656c 662e 7065 726d 7574 6528  rn self.permute(
+0002bdb0: 2a72 616e 6765 2864 3129 2c20 2a72 616e  *range(d1), *ran
+0002bdc0: 6765 2864 312b 312c 2064 322b 3129 2c20  ge(d1+1, d2+1), 
+0002bdd0: 6431 2c20 2a72 616e 6765 2864 322b 312c  d1, *range(d2+1,
+0002bde0: 2073 656c 662e 6e5f 6469 6d29 292e 6164   self.n_dim)).ad
+0002bdf0: 645f 7370 6563 6961 6c5f 6469 6d28 6432  d_special_dim(d2
+0002be00: 2c20 6469 6d32 290a 2020 2020 2020 2020  , dim2).        
+0002be10: 2320 656c 6966 2064 3120 3e20 6432 3a20  # elif d1 > d2: 
+0002be20: 7265 7475 726e 2073 656c 662e 7065 726d  return self.perm
+0002be30: 7574 6528 2a72 616e 6765 2864 3229 2c20  ute(*range(d2), 
+0002be40: 6431 2c20 2a72 616e 6765 2864 322c 2064  d1, *range(d2, d
+0002be50: 3129 2c20 2a72 616e 6765 2864 312b 312c  1), *range(d1+1,
+0002be60: 2073 656c 662e 6e5f 6469 6d29 292e 6164   self.n_dim)).ad
+0002be70: 645f 7370 6563 6961 6c5f 6469 6d28 6432  d_special_dim(d2
+0002be80: 2c20 6469 6d32 290a 2020 2020 2020 2020  , dim2).        
+0002be90: 2320 7265 7475 726e 2073 656c 662e 6164  # return self.ad
+0002bea0: 645f 7370 6563 6961 6c5f 6469 6d28 6432  d_special_dim(d2
+0002beb0: 2c20 6469 6d32 292e 6772 6164 5f66 6e5f  , dim2).grad_fn_
+0002bec0: 6e61 6d65 5f28 276d 6f76 655f 6469 6d27  name_('move_dim'
+0002bed0: 290a 0a20 2020 2040 616c 6961 7328 226d  )..    @alias("m
+0002bee0: 6f76 6564 696d 5f22 290a 2020 2020 6465  ovedim_").    de
+0002bef0: 6620 6d6f 7665 5f64 696d 5f28 7365 6c66  f move_dim_(self
+0002bf00: 2c20 6469 6d31 3a20 6465 6c5f 6469 6d2c  , dim1: del_dim,
+0002bf10: 2064 696d 323a 2065 7869 7374 5f64 696d   dim2: exist_dim
+0002bf20: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+0002bf30: 2020 2020 2020 2049 6e2d 706c 6163 6520         In-place 
+0002bf40: 6f70 6572 6174 696f 6e20 666f 7220 6d6f  operation for mo
+0002bf50: 7665 6469 6d0a 2020 2020 2020 2020 2222  vedim.        ""
+0002bf60: 220a 2020 2020 2020 2020 6469 6d31 203d  ".        dim1 =
+0002bf70: 2064 656c 5f64 696d 2873 656c 662e 7368   del_dim(self.sh
+0002bf80: 6170 652c 2064 696d 3129 0a20 2020 2020  ape, dim1).     
+0002bf90: 2020 2064 696d 3220 3d20 6578 6973 745f     dim2 = exist_
+0002bfa0: 6469 6d28 7365 6c66 2e73 6861 7065 2c20  dim(self.shape, 
+0002bfb0: 6469 6d32 290a 2020 2020 2020 2020 6176  dim2).        av
+0002bfc0: 6f75 6368 286c 656e 2864 696d 3129 203d  ouch(len(dim1) =
+0002bfd0: 3d20 6c65 6e28 6469 6d32 2920 3d3d 2031  = len(dim2) == 1
+0002bfe0: 2c20 2254 656e 736f 722e 6d6f 7665 5f64  , "Tensor.move_d
+0002bff0: 696d 206f 6e6c 7920 7461 6b65 7320 696e  im only takes in
+0002c000: 7465 6765 7273 2061 7320 696e 7075 7473  tegers as inputs
+0002c010: 2e22 290a 2020 2020 2020 2020 6431 203d  .").        d1 =
+0002c020: 2064 696d 315b 305d 0a20 2020 2020 2020   dim1[0].       
+0002c030: 2064 3220 3d20 6469 6d32 5b30 5d0a 0a20   d2 = dim2[0].. 
+0002c040: 2020 2020 2020 2069 6620 6431 203c 2064         if d1 < d
+0002c050: 323a 2072 6574 7572 6e20 7365 6c66 2e70  2: return self.p
+0002c060: 6572 6d75 7465 5f28 2a72 616e 6765 2864  ermute_(*range(d
+0002c070: 3129 2c20 2a72 616e 6765 2864 312b 312c  1), *range(d1+1,
+0002c080: 2064 322b 3129 2c20 6431 2c20 2a72 616e   d2+1), d1, *ran
+0002c090: 6765 2864 322b 312c 2073 656c 662e 6e5f  ge(d2+1, self.n_
+0002c0a0: 6469 6d29 292e 6164 645f 7370 6563 6961  dim)).add_specia
+0002c0b0: 6c5f 6469 6d28 6432 2c20 6469 6d32 290a  l_dim(d2, dim2).
+0002c0c0: 2020 2020 2020 2020 656c 6966 2064 3120          elif d1 
+0002c0d0: 3e20 6432 3a20 7265 7475 726e 2073 656c  > d2: return sel
+0002c0e0: 662e 7065 726d 7574 655f 282a 7261 6e67  f.permute_(*rang
+0002c0f0: 6528 6432 292c 2064 312c 202a 7261 6e67  e(d2), d1, *rang
+0002c100: 6528 6432 2c20 6431 292c 202a 7261 6e67  e(d2, d1), *rang
+0002c110: 6528 6431 2b31 2c20 7365 6c66 2e6e 5f64  e(d1+1, self.n_d
+0002c120: 696d 2929 2e61 6464 5f73 7065 6369 616c  im)).add_special
+0002c130: 5f64 696d 2864 322c 2064 696d 3229 0a20  _dim(d2, dim2). 
+0002c140: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0002c150: 6c66 2e61 6464 5f73 7065 6369 616c 5f64  lf.add_special_d
+0002c160: 696d 2864 322c 2064 696d 3229 2e67 7261  im(d2, dim2).gra
+0002c170: 645f 666e 5f6e 616d 655f 2827 6d6f 7665  d_fn_name_('move
+0002c180: 5f64 696d 5f27 290a 0a20 2020 2040 616c  _dim_')..    @al
+0002c190: 6961 7328 226a 6f69 6e64 696d 7322 2c20  ias("joindims", 
+0002c1a0: 226a 6f69 6e5f 6469 6d73 222c 2022 6d65  "join_dims", "me
+0002c1b0: 7267 6564 696d 7322 290a 2020 2020 6465  rgedims").    de
+0002c1c0: 6620 6d65 7267 655f 6469 6d73 2873 656c  f merge_dims(sel
+0002c1d0: 662c 202a 6469 6d73 3a20 6578 6973 745f  f, *dims: exist_
+0002c1e0: 6469 6d2c 2074 6172 6765 743a 206e 6577  dim, target: new
+0002c1f0: 5f64 696d 3d4e 6f6e 6529 3a0a 2020 2020  _dim=None):.    
+0002c200: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0002c210: 6d65 7267 6564 696d 7328 7365 6c66 2c20  mergedims(self, 
+0002c220: 2a73 6f75 7263 652c 2074 6172 6765 7429  *source, target)
+0002c230: 202d 3e20 5465 6e73 6f72 0a0a 2020 2020   -> Tensor..    
+0002c240: 2020 2020 6d65 7267 6520 6469 6d73 2069      merge dims i
+0002c250: 6e74 6f20 6f6e 6520 6469 6d65 6e73 696f  nto one dimensio
+0002c260: 6e3a 2074 6172 6765 7420 2874 6865 206c  n: target (the l
+0002c270: 6173 7420 6172 6775 6d65 6e74 290a 2020  ast argument).  
+0002c280: 2020 2020 2020 6461 7461 206f 6620 7369        data of si
+0002c290: 7a65 2028 322c 2033 2c20 342c 2035 2920  ze (2, 3, 4, 5) 
+0002c2a0: 6361 6e20 6265 2074 7261 6e73 666f 726d  can be transform
+0002c2b0: 2074 6f20 2832 342c 2035 2920 7769 7468   to (24, 5) with
+0002c2c0: 2061 2043 6172 7465 7369 616e 206f 6620   a Cartesian of 
+0002c2d0: 3320 7820 3220 7820 3420 6279 3a0a 2020  3 x 2 x 4 by:.  
+0002c2e0: 2020 2020 2020 2020 2020 6461 7461 2e6d            data.m
+0002c2f0: 6572 6765 6469 6d73 285b 312c 2030 2c20  ergedims([1, 0, 
+0002c300: 325d 2c20 7461 7267 6574 3d30 2920 2f20  2], target=0) / 
+0002c310: 6461 7461 2e6d 6572 6765 6469 6d73 2831  data.mergedims(1
+0002c320: 2c20 302c 2032 2c20 7461 7267 6574 3d30  , 0, 2, target=0
+0002c330: 290a 2020 2020 2020 2020 4e6f 7465 2074  ).        Note t
+0002c340: 6861 7420 6f6e 6520 6361 6e20 6f6e 6c79  hat one can only
+0002c350: 206f 6d69 7420 7468 6520 7461 7267 6574   omit the target
+0002c360: 2064 696d 656e 7369 6f6e 2069 6620 6e6f   dimension if no
+0002c370: 206f 7264 6572 206f 6620 6469 6d65 6e73   order of dimens
+0002c380: 696f 6e20 6973 2063 6861 6e67 6564 2e20  ion is changed. 
+0002c390: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
+0002c3a0: 2061 7574 6f6d 6174 6963 616c 6c79 2063   automatically c
+0002c3b0: 686f 7365 6e20 7461 7267 6574 2069 7320  hosen target is 
+0002c3c0: 7468 6520 6e65 7720 706f 7369 7469 6f6e  the new position
+0002c3d0: 206f 6620 7468 6520 6c61 7374 2064 696d   of the last dim
+0002c3e0: 656e 7369 6f6e 206f 6e65 2067 6976 6573  ension one gives
+0002c3f0: 2e20 0a20 2020 2020 2020 2020 2020 2065  . .            e
+0002c400: 2e67 2e20 6461 7461 2e6d 6572 6765 6469  .g. data.mergedi
+0002c410: 6d73 2831 2c20 302c 2033 2920 7265 7375  ms(1, 0, 3) resu
+0002c420: 6c74 2069 6e20 2834 2c20 3330 2920 616e  lt in (4, 30) an
+0002c430: 6420 6974 2066 6f6c 6c6f 7773 2061 2043  d it follows a C
+0002c440: 6172 7465 7369 616e 206f 6620 3220 7820  artesian of 2 x 
+0002c450: 3320 7820 352e 0a20 2020 2020 2020 2022  3 x 5..        "
+0002c460: 2222 0a20 2020 2020 2020 2069 6e70 7574  "".        input
+0002c470: 5f64 696d 7320 3d20 6469 6d73 0a20 2020  _dims = dims.   
+0002c480: 2020 2020 2064 696d 7320 3d20 6578 6973       dims = exis
+0002c490: 745f 6469 6d28 7365 6c66 2e73 6861 7065  t_dim(self.shape
+0002c4a0: 2c20 2a64 696d 7329 0a20 2020 2020 2020  , *dims).       
+0002c4b0: 2069 6620 7461 7267 6574 2069 7320 4e6f   if target is No
+0002c4c0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0002c4d0: 7461 7267 6574 5f72 6570 7220 3d20 5369  target_repr = Si
+0002c4e0: 7a65 2864 696d 735b 2d31 5d20 2d20 7375  ze(dims[-1] - su
+0002c4f0: 6d5f 285b 3120 6966 2064 203c 2064 696d  m_([1 if d < dim
+0002c500: 735b 2d31 5d20 656c 7365 2030 2066 6f72  s[-1] else 0 for
+0002c510: 2064 2069 6e20 6469 6d73 5b3a 2d31 5d5d   d in dims[:-1]]
+0002c520: 2929 2e75 7064 6174 655f 7370 6563 6961  )).update_specia
+0002c530: 6c5f 6672 6f6d 2853 697a 6528 696e 7075  l_from(Size(inpu
+0002c540: 745f 6469 6d73 5b2d 315d 2929 2e70 7974  t_dims[-1])).pyt
+0002c550: 686f 6e5f 7265 7072 0a20 2020 2020 2020  hon_repr.       
+0002c560: 2020 2020 2064 696d 7320 3d20 736f 7274       dims = sort
+0002c570: 6564 2864 696d 7329 0a20 2020 2020 2020  ed(dims).       
+0002c580: 2065 6c73 653a 2074 6172 6765 745f 7265   else: target_re
+0002c590: 7072 203d 2028 7461 7267 6574 2c29 0a20  pr = (target,). 
+0002c5a0: 2020 2020 2020 2074 6172 6765 7420 3d20         target = 
+0002c5b0: 6e65 775f 6469 6d28 7265 6d6f 7665 5f64  new_dim(remove_d
+0002c5c0: 696d 2873 656c 662e 7368 6170 652c 2064  im(self.shape, d
+0002c5d0: 696d 7329 2c20 2a74 6172 6765 745f 7265  ims), *target_re
+0002c5e0: 7072 290a 2020 2020 2020 2020 6176 6f75  pr).        avou
+0002c5f0: 6368 286c 656e 2864 696d 7329 203e 3d20  ch(len(dims) >= 
+0002c600: 322c 2066 2250 6c65 6173 6520 696e 7075  2, f"Please inpu
+0002c610: 7420 6174 206c 6561 7374 2074 776f 2064  t at least two d
+0002c620: 696d 7320 746f 2062 6520 6d65 7267 6564  ims to be merged
+0002c630: 2066 6f72 206d 6574 686f 6420 276d 6572   for method 'mer
+0002c640: 6765 6469 6d73 272c 206e 6f74 207b 6469  gedims', not {di
+0002c650: 6d73 7d2e 2022 290a 2020 2020 2020 2020  ms}. ").        
+0002c660: 6176 6f75 6368 286c 656e 2874 6172 6765  avouch(len(targe
+0002c670: 7429 203d 3d20 312c 2066 2241 7420 6d6f  t) == 1, f"At mo
+0002c680: 7374 206f 6e65 2027 7461 7267 6574 2720  st one 'target' 
+0002c690: 6172 6775 6d65 6e74 2069 7320 616c 6c6f  argument is allo
+0002c6a0: 7765 6420 666f 7220 6d65 7468 6f64 2027  wed for method '
+0002c6b0: 6d65 7267 6564 696d 7327 2c20 6e6f 7420  mergedims', not 
+0002c6c0: 7b74 6172 6765 745f 7265 7072 7d2e 2022  {target_repr}. "
+0002c6d0: 290a 0a20 2020 2020 2020 2072 6573 203d  )..        res =
+0002c6e0: 2073 656c 662e 636c 6f6e 6528 290a 2020   self.clone().  
+0002c6f0: 2020 2020 2020 6f74 6865 725f 6469 6d73        other_dims
+0002c700: 203d 205b 6920 666f 7220 6920 696e 2072   = [i for i in r
+0002c710: 616e 6765 5f28 7365 6c66 2e6e 5f64 696d  ange_(self.n_dim
+0002c720: 2920 6966 2069 206e 6f74 2069 6e20 6469  ) if i not in di
+0002c730: 6d73 5d0a 2020 2020 2020 2020 6f75 745f  ms].        out_
+0002c740: 6469 6d73 203d 206f 7468 6572 5f64 696d  dims = other_dim
+0002c750: 735b 3a74 6172 6765 745b 305d 5d20 2b20  s[:target[0]] + 
+0002c760: 6469 6d73 202b 206f 7468 6572 5f64 696d  dims + other_dim
+0002c770: 735b 7461 7267 6574 5b30 5d3a 5d0a 2020  s[target[0]:].  
+0002c780: 2020 2020 2020 7072 6576 5f73 6861 7065        prev_shape
+0002c790: 203d 2072 6573 2e73 6861 7065 0a20 2020   = res.shape.   
+0002c7a0: 2020 2020 2077 6974 6820 7265 732e 6869       with res.hi
+0002c7b0: 6465 5f73 7065 6369 616c 2829 3a0a 2020  de_special():.  
+0002c7c0: 2020 2020 2020 2020 2020 7265 732e 7065            res.pe
+0002c7d0: 726d 7574 655f 286f 7574 5f64 696d 7329  rmute_(out_dims)
+0002c7e0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+0002c7f0: 203d 2072 6573 2e66 6c61 7474 656e 2874   = res.flatten(t
+0002c800: 6172 6765 745b 305d 2c20 7461 7267 6574  arget[0], target
+0002c810: 5b30 5d20 2b20 6c65 6e28 6469 6d73 2920  [0] + len(dims) 
+0002c820: 2d20 3129 0a20 2020 2020 2020 2070 6f73  - 1).        pos
+0002c830: 745f 7368 6170 6520 3d20 7375 6d5f 2828  t_shape = sum_((
+0002c840: 7072 6576 5f73 6861 7065 5b69 3a69 2b31  prev_shape[i:i+1
+0002c850: 5d20 666f 7220 6920 696e 206f 7468 6572  ] for i in other
+0002c860: 5f64 696d 735b 3a74 6172 6765 745b 305d  _dims[:target[0]
+0002c870: 5d29 2c20 5369 7a65 2829 290a 2020 2020  ]), Size()).    
+0002c880: 2020 2020 706f 7374 5f73 6861 7065 202b      post_shape +
+0002c890: 3d20 7265 732e 7368 6170 652e 7370 6563  = res.shape.spec
+0002c8a0: 6961 6c5f 6672 6f6d 2874 6172 6765 7429  ial_from(target)
+0002c8b0: 5b74 6172 6765 745b 305d 3a74 6172 6765  [target[0]:targe
+0002c8c0: 745b 305d 2b31 5d0a 2020 2020 2020 2020  t[0]+1].        
+0002c8d0: 706f 7374 5f73 6861 7065 202b 3d20 7375  post_shape += su
+0002c8e0: 6d5f 2828 7072 6576 5f73 6861 7065 5b69  m_((prev_shape[i
+0002c8f0: 3a69 2b31 5d20 666f 7220 6920 696e 206f  :i+1] for i in o
+0002c900: 7468 6572 5f64 696d 735b 7461 7267 6574  ther_dims[target
+0002c910: 5b30 5d3a 5d29 2c20 5369 7a65 2829 290a  [0]:]), Size()).
+0002c920: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+0002c930: 6573 2e73 7065 6369 616c 5f66 726f 6d28  es.special_from(
+0002c940: 706f 7374 5f73 6861 7065 292e 6772 6164  post_shape).grad
+0002c950: 5f66 6e5f 6e61 6d65 5f28 276d 6572 6765  _fn_name_('merge
+0002c960: 5f64 696d 7327 290a 0a20 2020 2040 616c  _dims')..    @al
+0002c970: 6961 7328 2273 706c 6974 6469 6d22 290a  ias("splitdim").
+0002c980: 2020 2020 6465 6620 7370 6c69 745f 6469      def split_di
+0002c990: 6d28 7365 6c66 2c20 736f 7572 6365 3a20  m(self, source: 
+0002c9a0: 6465 6c5f 6469 6d2c 202a 7369 7a65 3a20  del_dim, *size: 
+0002c9b0: 5369 7a65 293a 0a20 2020 2020 2020 2022  Size):.        "
+0002c9c0: 2222 0a20 2020 2020 2020 2073 706c 6974  "".        split
+0002c9d0: 6469 6d28 7365 6c66 2c20 736f 7572 6365  dim(self, source
+0002c9e0: 2c20 2a74 6172 6765 745f 7369 7a65 2920  , *target_size) 
+0002c9f0: 2d3e 2054 656e 736f 720a 0a20 2020 2020  -> Tensor..     
+0002ca00: 2020 2073 706c 6974 206f 6e65 2064 696d     split one dim
+0002ca10: 656e 7369 6f6e 2073 6f75 7263 6520 696e  ension source in
+0002ca20: 746f 206d 756c 7469 706c 6520 6469 6d65  to multiple dime
+0002ca30: 6e73 696f 6e73 3a20 7461 7267 6574 0a20  nsions: target. 
+0002ca40: 2020 2020 2020 2064 6174 6120 6f66 2073         data of s
+0002ca50: 697a 6520 2832 2c20 342c 2035 2920 6361  ize (2, 4, 5) ca
+0002ca60: 6e20 6265 2074 7261 6e73 666f 726d 2074  n be transform t
+0002ca70: 6f20 2832 2c20 322c 2032 2c20 3529 2077  o (2, 2, 2, 5) w
+0002ca80: 6974 6820 6461 7461 2e73 706c 6974 6469  ith data.splitdi
+0002ca90: 6d28 312c 2032 2c20 3229 2e0a 2020 2020  m(1, 2, 2)..    
+0002caa0: 2020 2020 4e6f 7465 2074 6861 7420 6261      Note that ba
+0002cab0: 7463 6820 7265 7072 6573 656e 7461 7469  tch representati
+0002cac0: 6f6e 7320 666f 7220 736f 7572 6365 2061  ons for source a
+0002cad0: 6e64 2074 6172 6765 7420 6172 6520 6469  nd target are di
+0002cae0: 6666 6572 656e 740a 2020 2020 2020 2020  fferent.        
+0002caf0: 2020 2020 2873 706c 6974 6469 6d28 5b31      (splitdim([1
+0002cb00: 5d2c 205b 325d 2c20 3229 206d 6561 6e73  ], [2], 2) means
+0002cb10: 2073 706c 6974 2074 6865 2062 6174 6368   split the batch
+0002cb20: 6469 6d20 6174 2069 6e64 6578 2031 2069  dim at index 1 i
+0002cb30: 6e74 6f20 6120 7369 7a65 206f 6620 285b  nto a size of ([
+0002cb40: 325d 2c20 3229 2c20 7768 6963 6820 6973  2], 2), which is
+0002cb50: 2032 7832 2077 6974 6820 6261 7463 6864   2x2 with batchd
+0002cb60: 696d 2061 7420 696e 6465 7820 3029 2e0a  im at index 0)..
+0002cb70: 2020 2020 2020 2020 2020 2020 4f6e 6520              One 
+0002cb80: 6361 6e20 7573 6520 2d31 2066 6f72 2061  can use -1 for a
+0002cb90: 7262 6974 7261 7279 2073 697a 652e 200a  rbitrary size. .
+0002cba0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0002cbb0: 2020 2020 7369 7a65 203d 2053 697a 6528      size = Size(
+0002cbc0: 2a73 697a 6529 0a20 2020 2020 2020 2073  *size).        s
+0002cbd0: 6f75 7263 6520 3d20 6465 6c5f 6469 6d28  ource = del_dim(
+0002cbe0: 7365 6c66 2c20 736f 7572 6365 290a 2020  self, source).  
+0002cbf0: 2020 2020 2020 2320 6176 6f75 6368 286c        # avouch(l
+0002cc00: 656e 2873 697a 6529 203e 3d20 322c 2066  en(size) >= 2, f
+0002cc10: 2250 6c65 6173 6520 696e 7075 7420 616e  "Please input an
+0002cc20: 2061 742d 6c65 6173 742d 7477 6f2d 6469   at-least-two-di
+0002cc30: 6d2d 7368 6170 6520 746f 2073 706c 6974  m-shape to split
+0002cc40: 2064 696d 656e 7369 6f6e 207b 736f 7572   dimension {sour
+0002cc50: 6365 7d20 696e 746f 2069 6e20 6d65 7468  ce} into in meth
+0002cc60: 6f64 2027 7370 6c69 7464 696d 272c 206e  od 'splitdim', n
+0002cc70: 6f74 207b 7369 7a65 7d2e 2022 290a 2020  ot {size}. ").  
+0002cc80: 2020 2020 2020 6966 206c 656e 2873 6f75        if len(sou
+0002cc90: 7263 6529 203e 2031 3a20 7365 6c66 203d  rce) > 1: self =
+0002cca0: 2073 656c 662e 6d65 7267 655f 6469 6d73   self.merge_dims
+0002ccb0: 282a 736f 7572 6365 2c20 7461 7267 6574  (*source, target
+0002ccc0: 3d73 6f75 7263 655b 305d 290a 0a20 2020  =source[0])..   
+0002ccd0: 2020 2020 206e 6577 5f73 697a 6520 3d20       new_size = 
+0002cce0: 7365 6c66 2e73 6861 7065 5b3a 736f 7572  self.shape[:sour
+0002ccf0: 6365 5b30 5d5d 202b 2073 697a 652e 7769  ce[0]] + size.wi
+0002cd00: 7468 5f6e 5f65 6c65 2873 656c 662e 7368  th_n_ele(self.sh
+0002cd10: 6170 655b 736f 7572 6365 5b30 5d5d 2920  ape[source[0]]) 
+0002cd20: 2b20 7365 6c66 2e73 6861 7065 5b73 6f75  + self.shape[sou
+0002cd30: 7263 655b 305d 202b 2031 3a5d 0a20 2020  rce[0] + 1:].   
+0002cd40: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0002cd50: 2e76 6965 7728 6e65 775f 7369 7a65 292e  .view(new_size).
+0002cd60: 6772 6164 5f66 6e5f 6e61 6d65 5f28 2773  grad_fn_name_('s
+0002cd70: 706c 6974 5f64 696d 2729 0a20 2020 200a  plit_dim').    .
+0002cd80: 2020 2020 6465 6620 6578 7061 6e64 2873      def expand(s
+0002cd90: 656c 662c 202a 7369 7a65 733a 2053 697a  elf, *sizes: Siz
+0002cda0: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
+0002cdb0: 726e 2073 656c 662e 6578 7061 6e64 5f74  rn self.expand_t
+0002cdc0: 6f28 2a73 697a 6573 292e 6772 6164 5f66  o(*sizes).grad_f
+0002cdd0: 6e5f 6e61 6d65 5f28 2765 7870 616e 6427  n_name_('expand'
+0002cde0: 290a 0a20 2020 2064 6566 2065 7870 616e  )..    def expan
+0002cdf0: 645f 6173 2873 656c 662c 206f 7468 6572  d_as(self, other
+0002ce00: 3a20 2754 656e 736f 7227 293a 0a20 2020  : 'Tensor'):.   
+0002ce10: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0002ce20: 2e65 7870 616e 645f 746f 286f 7468 6572  .expand_to(other
+0002ce30: 292e 6772 6164 5f66 6e5f 6e61 6d65 5f28  ).grad_fn_name_(
+0002ce40: 2765 7870 616e 645f 6173 2729 0a20 2020  'expand_as').   
+0002ce50: 2020 2020 200a 2020 2020 6465 6620 6578       .    def ex
+0002ce60: 7061 6e64 5f74 6f28 7365 6c66 2c20 2a74  pand_to(self, *t
+0002ce70: 6172 6765 742c 2061 7373 6967 6e5f 746f  arget, assign_to
+0002ce80: 5f64 696d 733a 2065 7869 7374 5f64 696d  _dims: exist_dim
+0002ce90: 3d4e 6f6e 652c 2064 696d 735f 616c 6c6f  =None, dims_allo
+0002cea0: 775f 6d69 736d 6174 6368 3a20 6578 6973  w_mismatch: exis
+0002ceb0: 745f 6469 6d3d 4e6f 6e65 293a 0a20 2020  t_dim=None):.   
+0002cec0: 2020 2020 2069 6620 6c65 6e28 7461 7267       if len(targ
+0002ced0: 6574 2920 3d3d 2031 2061 6e64 2069 7369  et) == 1 and isi
+0002cee0: 6e73 7461 6e63 6528 7461 7267 6574 5b30  nstance(target[0
+0002cef0: 5d2c 2074 6f72 6368 2e54 656e 736f 7229  ], torch.Tensor)
+0002cf00: 3a20 7461 7267 6574 203d 2074 6172 6765  : target = targe
+0002cf10: 745b 305d 2e73 6861 7065 0a20 2020 2020  t[0].shape.     
+0002cf20: 2020 2061 766f 7563 6828 6973 696e 7374     avouch(isinst
+0002cf30: 616e 6365 2874 6172 6765 742c 2074 7570  ance(target, tup
+0002cf40: 6c65 292c 2054 7970 6545 7272 6f72 2866  le), TypeError(f
+0002cf50: 2249 6e76 616c 6964 2069 6e70 7574 2066  "Invalid input f
+0002cf60: 6f72 2062 742e 5465 6e73 6f72 2e65 7870  or bt.Tensor.exp
+0002cf70: 616e 645f 746f 3a20 7b74 6172 6765 747d  and_to: {target}
+0002cf80: 2c20 7368 6f75 6c64 2062 6520 6120 2774  , should be a 't
+0002cf90: 7570 6c65 2720 6f72 2027 5369 7a65 272e  uple' or 'Size'.
+0002cfa0: 2229 290a 2020 2020 2020 2020 6966 206e  ")).        if n
+0002cfb0: 6f74 2069 7369 6e73 7461 6e63 6528 7461  ot isinstance(ta
+0002cfc0: 7267 6574 2c20 5369 7a65 293a 2074 6172  rget, Size): tar
+0002cfd0: 6765 7420 3d20 5369 7a65 282a 7461 7267  get = Size(*targ
+0002cfe0: 6574 290a 2020 2020 2020 2020 6966 2061  et).        if a
+0002cff0: 7373 6967 6e5f 746f 5f64 696d 7320 6973  ssign_to_dims is
+0002d000: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0002d010: 2020 206e 6577 5f73 6861 7065 2c20 5f20     new_shape, _ 
+0002d020: 3d20 7365 6c66 2e73 6861 7065 205e 2074  = self.shape ^ t
+0002d030: 6172 6765 740a 2020 2020 2020 2020 2020  arget.          
+0002d040: 2020 6176 6f75 6368 286c 656e 286e 6577    avouch(len(new
+0002d050: 5f73 6861 7065 2920 3d3d 206c 656e 2874  _shape) == len(t
+0002d060: 6172 6765 7429 2c20 5479 7065 4572 726f  arget), TypeErro
+0002d070: 7228 6622 4361 6e6e 6f74 2065 7870 616e  r(f"Cannot expan
+0002d080: 6420 7465 6e73 6f72 2077 6974 6820 7368  d tensor with sh
+0002d090: 6170 6520 7b73 656c 662e 7368 6170 657d  ape {self.shape}
+0002d0a0: 2074 6f20 7b74 6172 6765 747d 2e20 2229   to {target}. ")
+0002d0b0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0002d0c0: 2020 2020 2020 2020 2020 2020 6173 7369              assi
+0002d0d0: 676e 5f74 6f5f 6469 6d73 203d 206c 6973  gn_to_dims = lis
+0002d0e0: 7428 6578 6973 745f 6469 6d28 7461 7267  t(exist_dim(targ
+0002d0f0: 6574 2c20 6173 7369 676e 5f74 6f5f 6469  et, assign_to_di
+0002d100: 6d73 2929 0a20 2020 2020 2020 2020 2020  ms)).           
+0002d110: 206e 6577 5f73 6861 7065 203d 2053 697a   new_shape = Siz
+0002d120: 6528 2a28 7365 6c66 2e73 6861 7065 5b61  e(*(self.shape[a
+0002d130: 7373 6967 6e5f 746f 5f64 696d 732e 696e  ssign_to_dims.in
+0002d140: 6465 785b 695d 5d20 6966 2069 2069 6e20  dex[i]] if i in 
+0002d150: 6173 7369 676e 5f74 6f5f 6469 6d73 2065  assign_to_dims e
+0002d160: 6c73 6520 3120 666f 7220 6920 696e 2072  lse 1 for i in r
+0002d170: 616e 6765 5f28 6c65 6e28 7461 7267 6574  ange_(len(target
+0002d180: 2929 292e 7370 6563 6961 6c5f 6672 6f6d  ))).special_from
+0002d190: 2874 6172 6765 7429 290a 2020 2020 2020  (target)).      
+0002d1a0: 2020 6966 2064 696d 735f 616c 6c6f 775f    if dims_allow_
+0002d1b0: 6d69 736d 6174 6368 2069 7320 4e6f 6e65  mismatch is None
+0002d1c0: 3a20 6469 6d73 5f61 6c6c 6f77 5f6d 6973  : dims_allow_mis
+0002d1d0: 6d61 7463 6820 3d20 7475 706c 6528 290a  match = tuple().
+0002d1e0: 2020 2020 2020 2020 656c 7365 3a20 6469          else: di
+0002d1f0: 6d73 5f61 6c6c 6f77 5f6d 6973 6d61 7463  ms_allow_mismatc
+0002d200: 6820 3d20 7475 706c 6528 6578 6973 745f  h = tuple(exist_
+0002d210: 6469 6d28 7461 7267 6574 2c20 6469 6d73  dim(target, dims
+0002d220: 5f61 6c6c 6f77 5f6d 6973 6d61 7463 6829  _allow_mismatch)
+0002d230: 290a 2020 2020 2020 2020 6176 6f75 6368  ).        avouch
+0002d240: 2861 6c6c 5f28 6920 696e 2064 696d 735f  (all_(i in dims_
+0002d250: 616c 6c6f 775f 6d69 736d 6174 6368 206f  allow_mismatch o
+0002d260: 7220 7820 3d3d 2079 206f 7220 7820 3d3d  r x == y or x ==
+0002d270: 2031 206f 7220 7920 696e 2028 312c 202d   1 or y in (1, -
+0002d280: 3129 2066 6f72 2069 2c20 2878 2c20 7929  1) for i, (x, y)
+0002d290: 2069 6e20 656e 756d 6572 6174 6528 7a69   in enumerate(zi
+0002d2a0: 7028 6e65 775f 7368 6170 652c 2074 6172  p(new_shape, tar
+0002d2b0: 6765 7429 2929 2c20 0a20 2020 2020 2020  get))), .       
+0002d2c0: 2020 2020 2020 2020 5479 7065 4572 726f          TypeErro
+0002d2d0: 7228 6622 5369 7a65 206d 6973 6d61 7463  r(f"Size mismatc
+0002d2e0: 6820 696e 2027 6578 7061 6e64 5f74 6f27  h in 'expand_to'
+0002d2f0: 3a20 7b73 656c 662e 7368 6170 657d 2028  : {self.shape} (
+0002d300: 6578 7061 6e64 6564 2074 6f20 7b6e 6577  expanded to {new
+0002d310: 5f73 6861 7065 7d29 2061 6e64 207b 7461  _shape}) and {ta
+0002d320: 7267 6574 7d2e 2022 2929 0a20 2020 2020  rget}. ")).     
+0002d330: 2020 206e 5f72 6570 6561 7473 203d 2074     n_repeats = t
+0002d340: 7570 6c65 2879 2069 6620 6920 6e6f 7420  uple(y if i not 
+0002d350: 696e 2064 696d 735f 616c 6c6f 775f 6d69  in dims_allow_mi
+0002d360: 736d 6174 6368 2061 6e64 2078 203d 3d20  smatch and x == 
+0002d370: 3120 656c 7365 2031 2066 6f72 2069 2c20  1 else 1 for i, 
+0002d380: 2878 2c20 7929 2069 6e20 656e 756d 6572  (x, y) in enumer
+0002d390: 6174 6528 7a69 7028 6e65 775f 7368 6170  ate(zip(new_shap
+0002d3a0: 652c 2074 6172 6765 7429 2929 0a20 2020  e, target))).   
+0002d3b0: 2020 2020 2069 6620 6c65 6e28 6e5f 7265       if len(n_re
+0002d3c0: 7065 6174 7329 203e 2030 3a0a 2020 2020  peats) > 0:.    
+0002d3d0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0002d3e0: 656c 662e 7669 6577 286e 6577 5f73 6861  elf.view(new_sha
+0002d3f0: 7065 292e 7265 7065 6174 282a 6e5f 7265  pe).repeat(*n_re
+0002d400: 7065 6174 7329 2e67 7261 645f 666e 5f6e  peats).grad_fn_n
+0002d410: 616d 655f 2827 6578 7061 6e64 5f74 6f27  ame_('expand_to'
+0002d420: 290a 2020 2020 2020 2020 656c 7365 3a20  ).        else: 
+0002d430: 7265 7475 726e 2073 656c 662e 7669 6577  return self.view
+0002d440: 286e 6577 5f73 6861 7065 292e 6772 6164  (new_shape).grad
+0002d450: 5f66 6e5f 6e61 6d65 5f28 2765 7870 616e  _fn_name_('expan
+0002d460: 645f 746f 2729 0a20 2020 200a 2020 2020  d_to').    .    
+0002d470: 6465 6620 756e 7371 7565 657a 655f 746f  def unsqueeze_to
+0002d480: 2873 656c 663a 2027 5465 6e73 6f72 272c  (self: 'Tensor',
+0002d490: 202a 7461 7267 6574 3a53 697a 652c 2061   *target:Size, a
+0002d4a0: 7373 6967 6e5f 746f 5f64 696d 733a 2065  ssign_to_dims: e
+0002d4b0: 7869 7374 5f64 696d 3d4e 6f6e 6529 3a0a  xist_dim=None):.
+0002d4c0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0002d4d0: 656c 662e 6578 7061 6e64 5f74 6f28 2a74  elf.expand_to(*t
+0002d4e0: 6172 6765 742c 2061 7373 6967 6e5f 746f  arget, assign_to
+0002d4f0: 5f64 696d 733d 6173 7369 676e 5f74 6f5f  _dims=assign_to_
+0002d500: 6469 6d73 2c20 6469 6d73 5f61 6c6c 6f77  dims, dims_allow
+0002d510: 5f6d 6973 6d61 7463 683d 7475 706c 6528  _mismatch=tuple(
+0002d520: 2929 2e67 7261 645f 666e 5f6e 616d 655f  )).grad_fn_name_
+0002d530: 2827 756e 7371 7565 657a 655f 746f 2729  ('unsqueeze_to')
+0002d540: 0a0a 2020 2020 2320 436f 6e74 726f 6c20  ..    # Control 
+0002d550: 7468 6520 6f75 7470 7574 206f 6620 7468  the output of th
+0002d560: 6520 7465 6e73 6f72 2e20 0a20 2020 2064  e tensor. .    d
+0002d570: 6566 2074 6f62 7974 6573 2873 656c 6629  ef tobytes(self)
+0002d580: 3a20 7265 7475 726e 2073 656c 662e 6465  : return self.de
+0002d590: 7461 6368 2829 2e63 7075 2829 2e6e 756d  tach().cpu().num
+0002d5a0: 7079 2829 2e74 6f62 7974 6573 2829 0a20  py().tobytes(). 
+0002d5b0: 2020 200a 2020 2020 6465 6620 5f5f 6861     .    def __ha
+0002d5c0: 7368 5f5f 2873 656c 6629 3a20 7265 7475  sh__(self): retu
+0002d5d0: 726e 2073 7570 6572 2829 2e5f 5f68 6173  rn super().__has
+0002d5e0: 685f 5f28 290a 2020 2020 0a20 2020 2040  h__().    .    @
+0002d5f0: 636c 6173 736d 6574 686f 640a 2020 2020  classmethod.    
+0002d600: 6465 6620 5f5f 626c 6f63 6b5f 7265 7072  def __block_repr
+0002d610: 5f5f 2863 6c73 2c20 7270 723a 2073 7472  __(cls, rpr: str
+0002d620: 2c20 6279 3d27 2027 293a 0a20 2020 2020  , by=' '):.     
+0002d630: 2020 206e 5f63 6f6c 203d 206d 6178 5f28     n_col = max_(
+0002d640: 6c65 6e28 6c69 6e65 2920 666f 7220 6c69  len(line) for li
+0002d650: 6e65 2069 6e20 7270 722e 7370 6c69 7428  ne in rpr.split(
+0002d660: 275c 6e27 2929 0a20 2020 2020 2020 2072  '\n')).        r
+0002d670: 6574 7572 6e20 275c 6e27 2e6a 6f69 6e28  eturn '\n'.join(
+0002d680: 6c20 2b20 6279 202a 2028 6e5f 636f 6c20  l + by * (n_col 
+0002d690: 2d20 6c65 6e28 6c29 2920 666f 7220 6c20  - len(l)) for l 
+0002d6a0: 696e 2072 7072 2e73 706c 6974 2827 5c6e  in rpr.split('\n
+0002d6b0: 2729 290a 2020 2020 0a20 2020 2040 636c  ')).    .    @cl
+0002d6c0: 6173 736d 6574 686f 640a 2020 2020 6465  assmethod.    de
+0002d6d0: 6620 5f5f 636f 726e 6572 5f62 6c6f 636b  f __corner_block
+0002d6e0: 5f72 6570 725f 5f28 636c 732c 2072 7072  _repr__(cls, rpr
+0002d6f0: 3a20 7374 722c 2062 793d 2720 2729 3a0a  : str, by=' '):.
+0002d700: 2020 2020 2020 2020 6c69 6e65 7320 3d20          lines = 
+0002d710: 7270 722e 7370 6c69 7428 275c 6e27 290a  rpr.split('\n').
+0002d720: 2020 2020 2020 2020 6e5f 636f 6c20 3d20          n_col = 
+0002d730: 6d61 785f 286c 656e 286c 696e 6529 2066  max_(len(line) f
+0002d740: 6f72 206c 696e 6520 696e 206c 696e 6573  or line in lines
+0002d750: 290a 2020 2020 2020 2020 6e5f 726f 7720  ).        n_row 
+0002d760: 3d20 6c65 6e28 6c69 6e65 7329 0a20 2020  = len(lines).   
+0002d770: 2020 2020 2072 6574 7572 6e20 275c 6e27       return '\n'
+0002d780: 2e6a 6f69 6e28 0a20 2020 2020 2020 2020  .join(.         
+0002d790: 2020 2028 27ef bda2 2720 6966 2069 203d     ('...' if i =
+0002d7a0: 3d20 3020 656c 7365 2028 2720 2720 6966  = 0 else (' ' if
+0002d7b0: 2069 203d 3d20 6e5f 726f 7720 2d20 3120   i == n_row - 1 
+0002d7c0: 656c 7365 2027 7c27 2929 202b 200a 2020  else '|')) + .  
+0002d7d0: 2020 2020 2020 2020 2020 6c20 2b20 6279            l + by
+0002d7e0: 202a 2028 6e5f 636f 6c20 2d20 6c65 6e28   * (n_col - len(
+0002d7f0: 6c29 2920 2b20 0a20 2020 2020 2020 2020  l)) + .         
+0002d800: 2020 2028 27ef bda3 2720 6966 2069 203d     ('...' if i =
+0002d810: 3d20 6e5f 726f 7720 2d20 3120 656c 7365  = n_row - 1 else
+0002d820: 2028 2720 2720 6966 2069 203d 3d20 3020   (' ' if i == 0 
+0002d830: 656c 7365 2027 7c27 2929 0a20 2020 2020  else '|')).     
+0002d840: 2020 2066 6f72 2069 2c20 6c20 696e 2065     for i, l in e
+0002d850: 6e75 6d65 7261 7465 2872 7072 2e73 706c  numerate(rpr.spl
+0002d860: 6974 2827 5c6e 2729 2929 0a20 2020 200a  it('\n'))).    .
+0002d870: 2020 2020 4063 6c61 7373 6d65 7468 6f64      @classmethod
+0002d880: 0a20 2020 2064 6566 205f 5f73 6869 6674  .    def __shift
+0002d890: 5f72 6570 725f 5f28 636c 732c 2072 7072  _repr__(cls, rpr
+0002d8a0: 3a20 7374 722c 2073 6869 6674 3a20 696e  : str, shift: in
+0002d8b0: 743d 312c 2069 676e 6f72 655f 6669 7273  t=1, ignore_firs
+0002d8c0: 743a 2062 6f6f 6c3d 5472 7565 2c20 6279  t: bool=True, by
+0002d8d0: 3d27 2027 293a 0a20 2020 2020 2020 2069  =' '):.        i
+0002d8e0: 6620 6967 6e6f 7265 5f66 6972 7374 3a20  f ignore_first: 
+0002d8f0: 7265 7475 726e 2028 275c 6e27 202b 2062  return ('\n' + b
+0002d900: 7920 2a20 7368 6966 7429 2e6a 6f69 6e28  y * shift).join(
+0002d910: 7270 722e 7370 6c69 7428 275c 6e27 2929  rpr.split('\n'))
+0002d920: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0002d930: 275c 6e27 2e6a 6f69 6e28 6279 202a 2073  '\n'.join(by * s
+0002d940: 6869 6674 202b 206c 2066 6f72 206c 2069  hift + l for l i
+0002d950: 6e20 7270 722e 7370 6c69 7428 275c 6e27  n rpr.split('\n'
+0002d960: 2929 0a20 2020 200a 2020 2020 6465 6620  )).    .    def 
+0002d970: 5f5f 7261 775f 7265 7072 5f5f 2873 656c  __raw_repr__(sel
+0002d980: 662c 2063 656c 6c5f 666f 726d 6174 3d4e  f, cell_format=N
+0002d990: 6f6e 6529 3a0a 2020 2020 2020 2020 6372  one):.        cr
+0002d9a0: 6974 6572 6961 203d 207b 0a20 2020 2020  iteria = {.     
+0002d9b0: 2020 2020 2020 2027 6261 7463 6827 3a20         'batch': 
+0002d9c0: 2831 2c20 2831 2c20 3029 292c 0a20 2020  (1, (1, 0)),.   
+0002d9d0: 2020 2020 2020 2020 2027 7365 7175 656e           'sequen
+0002d9e0: 6365 273a 2028 322c 2031 292c 0a20 2020  ce': (2, 1),.   
+0002d9f0: 2020 2020 2020 2020 2027 3c6e 2d34 273a           '<n-4':
+0002da00: 2028 342c 2031 292c 0a20 2020 2020 2020   (4, 1),.       
+0002da10: 2020 2020 2027 3c6e 2d32 273a 2028 362c       '<n-2': (6,
+0002da20: 2032 292c 0a20 2020 2020 2020 2020 2020   2),.           
+0002da30: 2027 3c6e 2d31 273a 2028 3130 2c20 3429   '<n-1': (10, 4)
+0002da40: 2c0a 2020 2020 2020 2020 2020 2020 273c  ,.            '<
+0002da50: 6e27 3a20 2832 302c 2038 290a 2020 2020  n': (20, 8).    
+0002da60: 2020 2020 7d0a 2020 2020 2020 2020 6365      }.        ce
+0002da70: 6c6c 5f6c 656e 5f65 7870 203d 2038 0a20  ll_len_exp = 8. 
+0002da80: 2020 2020 2020 2063 656c 6c5f 6c65 6e5f         cell_len_
+0002da90: 7374 7220 3d20 330a 0a20 2020 2020 2020  str = 3..       
+0002daa0: 2069 6620 6365 6c6c 5f66 6f72 6d61 7420   if cell_format 
+0002dab0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0002dac0: 2020 2020 2069 6620 7365 6c66 2e6e 5f65       if self.n_e
+0002dad0: 6c65 203d 3d20 303a 2072 6574 7572 6e20  le == 0: return 
+0002dae0: 225b 5d22 0a20 2020 2020 2020 2020 2020  "[]".           
+0002daf0: 2023 2069 6620 7365 6c66 2e6e 5f64 696d   # if self.n_dim
+0002db00: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
+0002db10: 2020 2320 2020 2020 2320 7065 726d 7574    #     # permut
+0002db20: 6520 7468 6520 6469 6d65 6e73 696f 6e73  e the dimensions
+0002db30: 2074 6f20 2862 6174 6368 2c20 7365 7175   to (batch, sequ
+0002db40: 656e 6365 2c20 7370 6163 652c 2066 6561  ence, space, fea
+0002db50: 7475 7265 2c20 6675 6e63 2920 666f 7220  ture, func) for 
+0002db60: 6469 7370 6c61 792e 200a 2020 2020 2020  display. .      
+0002db70: 2020 2020 2020 2320 2020 2020 6469 6d65        #     dime
+0002db80: 6e73 696f 6e73 203d 2028 0a20 2020 2020  nsions = (.     
+0002db90: 2020 2020 2020 2023 2020 2020 2020 2020         #        
+0002dba0: 2028 5b73 656c 662e 6261 7463 685f 6469   ([self.batch_di
+0002dbb0: 6d5d 2069 6620 7365 6c66 2e68 6173 5f62  m] if self.has_b
+0002dbc0: 6174 6368 2065 6c73 6520 5b5d 2920 2b20  atch else []) + 
+0002dbd0: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
+0002dbe0: 2020 2020 2020 2028 6c69 7374 2872 616e         (list(ran
+0002dbf0: 6765 5f28 2a73 656c 662e 7365 7175 656e  ge_(*self.sequen
+0002dc00: 6365 5f72 616e 6765 2929 2069 6620 7365  ce_range)) if se
+0002dc10: 6c66 2e68 6173 5f73 6571 7565 6e63 6520  lf.has_sequence 
+0002dc20: 656c 7365 205b 5d29 202b 200a 2020 2020  else []) + .    
+0002dc30: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+0002dc40: 2020 286c 6973 7428 7261 6e67 655f 282a    (list(range_(*
+0002dc50: 7365 6c66 2e73 7061 6365 5f72 616e 6765  self.space_range
+0002dc60: 2929 2069 6620 7365 6c66 2e68 6173 5f73  )) if self.has_s
+0002dc70: 7061 6365 2065 6c73 6520 5b5d 2920 2b20  pace else []) + 
+0002dc80: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
+0002dc90: 2020 2020 2020 2028 6c69 7374 2872 616e         (list(ran
+0002dca0: 6765 5f28 2a73 656c 662e 6665 6174 7572  ge_(*self.featur
+0002dcb0: 655f 7261 6e67 6529 2920 6966 2073 656c  e_range)) if sel
+0002dcc0: 662e 6861 735f 6665 6174 7572 6520 656c  f.has_feature el
+0002dcd0: 7365 205b 5d29 202b 200a 2020 2020 2020  se []) + .      
+0002dce0: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+0002dcf0: 285b 7365 6c66 2e66 756e 635f 6469 6d5d  ([self.func_dim]
+0002dd00: 2069 6620 7365 6c66 2e68 6173 5f66 756e   if self.has_fun
+0002dd10: 6320 656c 7365 205b 5d29 0a20 2020 2020  c else []).     
+0002dd20: 2020 2020 2020 2023 2020 2020 2029 0a20         #     ). 
+0002dd30: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+0002dd40: 2073 656c 6620 3d20 7365 6c66 2e70 6572   self = self.per
+0002dd50: 6d75 7465 282a 6469 6d65 6e73 696f 6e73  mute(*dimensions
+0002dd60: 290a 0a20 2020 2020 2020 2020 2020 2064  )..            d
+0002dd70: 6973 706c 6179 5f74 656e 736f 7220 3d20  isplay_tensor = 
+0002dd80: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0002dd90: 2066 6f72 2064 2069 6e20 7261 6e67 655f   for d in range_
+0002dda0: 2873 656c 662e 6e5f 6469 6d29 3a0a 2020  (self.n_dim):.  
+0002ddb0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0002ddc0: 2073 656c 662e 6973 5f62 6174 6368 5f64   self.is_batch_d
+0002ddd0: 696d 2864 293a 206d 6178 5f73 697a 652c  im(d): max_size,
+0002dde0: 2070 6164 5f73 697a 6520 3d20 6372 6974   pad_size = crit
+0002ddf0: 6572 6961 5b27 6261 7463 6827 5d0a 2020  eria['batch'].  
+0002de00: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0002de10: 6966 2073 656c 662e 6973 5f73 6571 7565  if self.is_seque
+0002de20: 6e63 655f 6469 6d28 6429 3a20 6d61 785f  nce_dim(d): max_
+0002de30: 7369 7a65 2c20 7061 645f 7369 7a65 203d  size, pad_size =
+0002de40: 2063 7269 7465 7269 615b 2773 6571 7565   criteria['seque
+0002de50: 6e63 6527 5d0a 2020 2020 2020 2020 2020  nce'].          
+0002de60: 2020 2020 2020 656c 6966 2064 203c 2073        elif d < s
+0002de70: 656c 662e 6e5f 6469 6d20 2d20 343a 206d  elf.n_dim - 4: m
+0002de80: 6178 5f73 697a 652c 2070 6164 5f73 697a  ax_size, pad_siz
+0002de90: 6520 3d20 6372 6974 6572 6961 5b27 3c6e  e = criteria['<n
+0002dea0: 2d34 275d 0a20 2020 2020 2020 2020 2020  -4'].           
+0002deb0: 2020 2020 2065 6c69 6620 6420 3c20 7365       elif d < se
+0002dec0: 6c66 2e6e 5f64 696d 202d 2032 3a20 6d61  lf.n_dim - 2: ma
+0002ded0: 785f 7369 7a65 2c20 7061 645f 7369 7a65  x_size, pad_size
+0002dee0: 203d 2063 7269 7465 7269 615b 273c 6e2d   = criteria['<n-
+0002def0: 3227 5d0a 2020 2020 2020 2020 2020 2020  2'].            
+0002df00: 2020 2020 656c 6966 2064 203c 2073 656c      elif d < sel
+0002df10: 662e 6e5f 6469 6d20 2d20 313a 206d 6178  f.n_dim - 1: max
+0002df20: 5f73 697a 652c 2070 6164 5f73 697a 6520  _size, pad_size 
+0002df30: 3d20 6372 6974 6572 6961 5b27 3c6e 2d31  = criteria['<n-1
+0002df40: 275d 0a20 2020 2020 2020 2020 2020 2020  '].             
+0002df50: 2020 2065 6c73 653a 206d 6178 5f73 697a     else: max_siz
+0002df60: 652c 2070 6164 5f73 697a 6520 3d20 6372  e, pad_size = cr
+0002df70: 6974 6572 6961 5b27 3c6e 275d 0a20 2020  iteria['<n'].   
+0002df80: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002df90: 7365 6c66 2e73 697a 6528 6429 203c 3d20  self.size(d) <= 
+0002dfa0: 6d61 785f 7369 7a65 3a20 636f 6e74 696e  max_size: contin
+0002dfb0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+0002dfc0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0002dfd0: 2870 6164 5f73 697a 652c 2069 6e74 5f29  (pad_size, int_)
+0002dfe0: 3a20 7061 645f 7369 7a65 203d 2028 7061  : pad_size = (pa
+0002dff0: 645f 7369 7a65 2c20 7061 645f 7369 7a65  d_size, pad_size
+0002e000: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002e010: 2020 6966 2064 6973 706c 6179 5f74 656e    if display_ten
+0002e020: 736f 7220 6973 204e 6f6e 653a 2064 6973  sor is None: dis
+0002e030: 706c 6179 5f74 656e 736f 7220 3d20 6361  play_tensor = ca
+0002e040: 7428 7365 6c66 5b28 736c 6963 6528 4e6f  t(self[(slice(No
+0002e050: 6e65 292c 2920 2a20 6420 2b20 2873 6c69  ne),) * d + (sli
+0002e060: 6365 284e 6f6e 652c 2070 6164 5f73 697a  ce(None, pad_siz
+0002e070: 655b 305d 292c 295d 2c20 7365 6c66 5b28  e[0]),)], self[(
+0002e080: 736c 6963 6528 4e6f 6e65 292c 2920 2a20  slice(None),) * 
+0002e090: 6420 2b20 2873 6c69 6365 2873 656c 662e  d + (slice(self.
+0002e0a0: 7369 7a65 2864 292d 7061 645f 7369 7a65  size(d)-pad_size
+0002e0b0: 5b31 5d2c 204e 6f6e 6529 2c29 5d2c 2064  [1], None),)], d
+0002e0c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002e0d0: 2020 656c 7365 3a20 6469 7370 6c61 795f    else: display_
+0002e0e0: 7465 6e73 6f72 203d 2063 6174 2864 6973  tensor = cat(dis
+0002e0f0: 706c 6179 5f74 656e 736f 725b 2873 6c69  play_tensor[(sli
+0002e100: 6365 284e 6f6e 6529 2c29 202a 2064 202b  ce(None),) * d +
+0002e110: 2028 736c 6963 6528 4e6f 6e65 2c20 7061   (slice(None, pa
+0002e120: 645f 7369 7a65 5b30 5d29 2c29 5d2c 2064  d_size[0]),)], d
+0002e130: 6973 706c 6179 5f74 656e 736f 725b 2873  isplay_tensor[(s
+0002e140: 6c69 6365 284e 6f6e 6529 2c29 202a 2064  lice(None),) * d
+0002e150: 202b 2028 736c 6963 6528 7365 6c66 2e73   + (slice(self.s
+0002e160: 697a 6528 6429 2d70 6164 5f73 697a 655b  ize(d)-pad_size[
+0002e170: 315d 2c20 4e6f 6e65 292c 295d 2c20 6429  1], None),)], d)
+0002e180: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002e190: 6469 7370 6c61 795f 7465 6e73 6f72 2069  display_tensor i
+0002e1a0: 7320 4e6f 6e65 3a20 6469 7370 6c61 795f  s None: display_
+0002e1b0: 7465 6e73 6f72 203d 2073 656c 662e 666c  tensor = self.fl
+0002e1c0: 6174 7465 6e28 290a 2020 2020 2020 2020  atten().        
+0002e1d0: 2020 2020 656c 7365 3a20 6469 7370 6c61      else: displa
+0002e1e0: 795f 7465 6e73 6f72 203d 2064 6973 706c  y_tensor = displ
+0002e1f0: 6179 5f74 656e 736f 722e 666c 6174 7465  ay_tensor.flatte
+0002e200: 6e28 290a 2020 2020 2020 2020 2020 2020  n().            
+0002e210: 6966 2064 6973 706c 6179 5f74 656e 736f  if display_tenso
+0002e220: 722e 6973 5f63 6f6d 706c 6578 2829 3a20  r.is_complex(): 
+0002e230: 6469 7370 6c61 795f 7465 6e73 6f72 203d  display_tensor =
+0002e240: 2063 6174 2864 6973 706c 6179 5f74 656e   cat(display_ten
+0002e250: 736f 722e 7265 616c 2c20 6469 7370 6c61  sor.real, displa
+0002e260: 795f 7465 6e73 6f72 2e69 6d61 6729 0a20  y_tensor.imag). 
+0002e270: 2020 2020 2020 2020 2020 2073 7472 5f65             str_e
+0002e280: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
+0002e290: 2020 2020 2020 2069 6620 616e 7928 6973         if any(is
+0002e2a0: 6e61 6e28 6469 7370 6c61 795f 7465 6e73  nan(display_tens
+0002e2b0: 6f72 2929 3a0a 2020 2020 2020 2020 2020  or)):.          
+0002e2c0: 2020 2020 2020 6469 7370 6c61 795f 7465        display_te
+0002e2d0: 6e73 6f72 203d 2064 6973 706c 6179 5f74  nsor = display_t
+0002e2e0: 656e 736f 725b 7e69 736e 616e 2864 6973  ensor[~isnan(dis
+0002e2f0: 706c 6179 5f74 656e 736f 7229 5d0a 2020  play_tensor)].  
+0002e300: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002e310: 725f 656c 6520 3d20 5472 7565 0a20 2020  r_ele = True.   
+0002e320: 2020 2020 2020 2020 2069 6620 616e 7928           if any(
+0002e330: 6973 696e 6628 6469 7370 6c61 795f 7465  isinf(display_te
+0002e340: 6e73 6f72 2929 3a0a 2020 2020 2020 2020  nsor)):.        
+0002e350: 2020 2020 2020 2020 6469 7370 6c61 795f          display_
+0002e360: 7465 6e73 6f72 203d 2064 6973 706c 6179  tensor = display
+0002e370: 5f74 656e 736f 725b 7e69 7369 6e66 2864  _tensor[~isinf(d
+0002e380: 6973 706c 6179 5f74 656e 736f 7229 5d0a  isplay_tensor)].
+0002e390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e3a0: 7374 725f 656c 6520 3d20 5472 7565 0a20  str_ele = True. 
+0002e3b0: 2020 2020 2020 2020 2020 2069 6620 6469             if di
+0002e3c0: 7370 6c61 795f 7465 6e73 6f72 2e6e 5f65  splay_tensor.n_e
+0002e3d0: 6c65 203d 3d20 303a 0a20 2020 2020 2020  le == 0:.       
+0002e3e0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0002e3f0: 7374 725f 656c 653a 2072 6169 7365 2052  str_ele: raise R
+0002e400: 756e 7469 6d65 4572 726f 7228 2273 7472  untimeError("str
+0002e410: 5f65 6c65 3d46 616c 7365 2061 6674 6572  _ele=False after
+0002e420: 2065 6c69 6d69 6e61 7469 6e67 206e 616e   eliminating nan
+0002e430: 2f69 6e66 2074 6f20 616e 2065 6d70 7479  /inf to an empty
+0002e440: 2074 656e 736f 722e 2229 0a20 2020 2020   tensor.").     
+0002e450: 2020 2020 2020 2020 2020 2063 656c 6c5f             cell_
+0002e460: 666f 726d 6174 203d 2028 2769 6e74 272c  format = ('int',
+0002e470: 2063 656c 6c5f 6c65 6e5f 7374 7220 2b20   cell_len_str + 
+0002e480: 616e 7928 7365 6c66 203c 2030 292c 2073  any(self < 0), s
+0002e490: 656c 662e 7368 6170 6529 0a20 2020 2020  elf.shape).     
+0002e4a0: 2020 2020 2020 2065 6c69 6620 6973 7375         elif issu
+0002e4b0: 6263 6c61 7373 2864 6973 706c 6179 5f74  bclass(display_t
+0002e4c0: 656e 736f 722e 6474 7970 652c 2064 7479  ensor.dtype, dty
+0002e4d0: 7065 5f28 626f 6f6c 2929 3a0a 2020 2020  pe_(bool)):.    
+0002e4e0: 2020 2020 2020 2020 2020 2020 6365 6c6c              cell
+0002e4f0: 5f66 6f72 6d61 7420 3d20 2827 626f 6f6c  _format = ('bool
+0002e500: 272c 2034 2069 6620 616c 6c28 6469 7370  ', 4 if all(disp
+0002e510: 6c61 795f 7465 6e73 6f72 2920 656c 7365  lay_tensor) else
+0002e520: 2035 2c20 7365 6c66 2e73 6861 7065 290a   5, self.shape).
+0002e530: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0002e540: 206e 6f74 2064 6973 706c 6179 5f74 656e   not display_ten
+0002e550: 736f 722e 6474 7970 652e 6973 5f66 6c6f  sor.dtype.is_flo
+0002e560: 6174 696e 675f 706f 696e 743a 0a20 2020  ating_point:.   
+0002e570: 2020 2020 2020 2020 2020 2020 2063 656c               cel
+0002e580: 6c5f 6c65 6e20 3d20 696e 745f 286d 6178  l_len = int_(max
+0002e590: 2864 6973 706c 6179 5f74 656e 736f 722e  (display_tensor.
+0002e5a0: 636c 616d 7028 6d69 6e3d 3129 2e6c 6f67  clamp(min=1).log
+0002e5b0: 2831 3029 2e66 6c6f 6f72 2829 292e 6974  (10).floor()).it
+0002e5c0: 656d 2829 2920 2b20 310a 2020 2020 2020  em()) + 1.      
+0002e5d0: 2020 2020 2020 2020 2020 6365 6c6c 5f6c            cell_l
+0002e5e0: 656e 203d 206d 6178 5f28 6365 6c6c 5f6c  en = max_(cell_l
+0002e5f0: 656e 2c20 696e 745f 286d 6178 2864 6973  en, int_(max(dis
+0002e600: 706c 6179 5f74 656e 736f 722e 636c 616d  play_tensor.clam
+0002e610: 7028 6d61 783d 2d31 652d 3129 2e61 6273  p(max=-1e-1).abs
+0002e620: 2829 2e6c 6f67 2831 3029 2e66 6c6f 6f72  ().log(10).floor
+0002e630: 2829 292e 6974 656d 2829 2920 2b20 3120  ()).item()) + 1 
+0002e640: 2b20 3129 0a20 2020 2020 2020 2020 2020  + 1).           
+0002e650: 2020 2020 2063 656c 6c5f 6c65 6e20 3d20       cell_len = 
+0002e660: 6d69 6e5f 2863 656c 6c5f 6c65 6e2c 2063  min_(cell_len, c
+0002e670: 656c 6c5f 6c65 6e5f 6578 7029 0a20 2020  ell_len_exp).   
+0002e680: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002e690: 7374 725f 656c 653a 2063 656c 6c5f 6c65  str_ele: cell_le
+0002e6a0: 6e20 3d20 6d61 785f 2863 656c 6c5f 6c65  n = max_(cell_le
+0002e6b0: 6e2c 2063 656c 6c5f 6c65 6e5f 7374 7229  n, cell_len_str)
+0002e6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e6d0: 2063 656c 6c5f 666f 726d 6174 203d 2028   cell_format = (
+0002e6e0: 2769 6e74 272c 2063 656c 6c5f 6c65 6e2c  'int', cell_len,
+0002e6f0: 2073 656c 662e 7368 6170 6529 0a20 2020   self.shape).   
+0002e700: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0002e710: 2020 2020 2020 2020 2020 2020 2020 207a                 z
+0002e720: 6572 6f5f 746f 5f6f 6e65 203d 206c 616d  ero_to_one = lam
+0002e730: 6264 6120 783a 206f 6e65 7328 3129 5b30  bda x: ones(1)[0
+0002e740: 5d20 6966 2078 203d 3d20 3020 656c 7365  ] if x == 0 else
+0002e750: 2078 2e6c 6f67 2831 3029 0a20 2020 2020   x.log(10).     
+0002e760: 2020 2020 2020 2020 2020 2069 6620 7375             if su
+0002e770: 6d28 2864 6973 706c 6179 5f74 656e 736f  m((display_tenso
+0002e780: 722e 6162 7328 2920 3e20 3165 2d36 3429  r.abs() > 1e-64)
+0002e790: 2026 2028 6469 7370 6c61 795f 7465 6e73   & (display_tens
+0002e7a0: 6f72 2e61 6273 2829 203c 2031 652d 3429  or.abs() < 1e-4)
+0002e7b0: 2920 3e20 6469 7370 6c61 795f 7465 6e73  ) > display_tens
+0002e7c0: 6f72 2e6e 5f65 6c65 202f 2032 206f 7220  or.n_ele / 2 or 
+0002e7d0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+0002e7e0: 2020 2020 2020 616e 7928 6469 7370 6c61        any(displa
+0002e7f0: 795f 7465 6e73 6f72 203e 3d20 3165 3629  y_tensor >= 1e6)
+0002e800: 206f 7220 616e 7928 6469 7370 6c61 795f   or any(display_
+0002e810: 7465 6e73 6f72 203c 3d20 2d31 6535 293a  tensor <= -1e5):
+0002e820: 2063 656c 6c5f 666f 726d 6174 203d 2028   cell_format = (
+0002e830: 2765 7870 272c 2063 656c 6c5f 6c65 6e5f  'exp', cell_len_
+0002e840: 6578 702c 2073 656c 662e 7368 6170 6529  exp, self.shape)
+0002e850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e860: 2065 6c69 6620 6162 7328 7a65 726f 5f74   elif abs(zero_t
+0002e870: 6f5f 6f6e 6528 6469 7370 6c61 795f 7465  o_one(display_te
+0002e880: 6e73 6f72 2e61 6273 2829 2e6d 6178 2829  nsor.abs().max()
+0002e890: 2920 2d20 7a65 726f 5f74 6f5f 6f6e 6528  ) - zero_to_one(
+0002e8a0: 6469 7370 6c61 795f 7465 6e73 6f72 2e61  display_tensor.a
+0002e8b0: 6273 2829 2e6d 696e 2829 2929 2e69 7465  bs().min())).ite
+0002e8c0: 6d28 2920 3e20 353a 2063 656c 6c5f 666f  m() > 5: cell_fo
+0002e8d0: 726d 6174 203d 2028 2765 7870 272c 2063  rmat = ('exp', c
+0002e8e0: 656c 6c5f 6c65 6e5f 6578 702c 2073 656c  ell_len_exp, sel
+0002e8f0: 662e 7368 6170 6529 0a20 2020 2020 2020  f.shape).       
+0002e900: 2020 2020 2020 2020 2065 6c69 6620 616c           elif al
+0002e910: 6c28 2864 6973 706c 6179 5f74 656e 736f  l((display_tenso
+0002e920: 7220 2d20 6469 7370 6c61 795f 7465 6e73  r - display_tens
+0002e930: 6f72 2e72 6f75 6e64 2829 292e 6162 7328  or.round()).abs(
+0002e940: 2920 3c20 3165 2d34 2920 6f72 2061 6e79  ) < 1e-4) or any
+0002e950: 2864 6973 706c 6179 5f74 656e 736f 7220  (display_tensor 
+0002e960: 3e3d 2031 6534 2920 6f72 2061 6e79 2864  >= 1e4) or any(d
+0002e970: 6973 706c 6179 5f74 656e 736f 7220 3c3d  isplay_tensor <=
+0002e980: 202d 3165 3329 3a0a 2020 2020 2020 2020   -1e3):.        
+0002e990: 2020 2020 2020 2020 2020 2020 6365 6c6c              cell
+0002e9a0: 5f6c 656e 203d 2069 6e74 5f28 6d61 7828  _len = int_(max(
+0002e9b0: 282d 6469 7370 6c61 795f 7465 6e73 6f72  (-display_tensor
+0002e9c0: 2e73 6967 6e28 2929 2e63 6c61 6d70 286d  .sign()).clamp(m
+0002e9d0: 696e 3d30 2920 2b20 6469 7370 6c61 795f  in=0) + display_
+0002e9e0: 7465 6e73 6f72 2e61 6273 2829 2e63 6c61  tensor.abs().cla
+0002e9f0: 6d70 286d 696e 3d31 292e 6c6f 6728 3130  mp(min=1).log(10
+0002ea00: 292e 666c 6f6f 7228 2929 2e69 7465 6d28  ).floor()).item(
+0002ea10: 2929 202b 2031 202b 2031 0a20 2020 2020  )) + 1 + 1.     
+0002ea20: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0002ea30: 2063 656c 6c5f 6c65 6e20 3d20 6d61 785f   cell_len = max_
+0002ea40: 2863 656c 6c5f 6c65 6e2c 2069 6e74 5f28  (cell_len, int_(
+0002ea50: 6d61 7828 6469 7370 6c61 795f 7465 6e73  max(display_tens
+0002ea60: 6f72 2e63 6c61 6d70 286d 6178 3d2d 3165  or.clamp(max=-1e
+0002ea70: 2d31 292e 6162 7328 292e 6c6f 6728 3130  -1).abs().log(10
+0002ea80: 292e 666c 6f6f 7228 2929 2e69 7465 6d28  ).floor()).item(
+0002ea90: 2929 202b 2031 202b 2031 202b 2031 290a  )) + 1 + 1 + 1).
+0002eaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eab0: 2020 2020 6365 6c6c 5f6c 656e 203d 206d      cell_len = m
+0002eac0: 696e 5f28 6365 6c6c 5f6c 656e 2c20 6365  in_(cell_len, ce
+0002ead0: 6c6c 5f6c 656e 5f65 7870 290a 2020 2020  ll_len_exp).    
+0002eae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eaf0: 6966 2073 7472 5f65 6c65 3a20 6365 6c6c  if str_ele: cell
+0002eb00: 5f6c 656e 203d 206d 6178 5f28 6365 6c6c  _len = max_(cell
+0002eb10: 5f6c 656e 2c20 6365 6c6c 5f6c 656e 5f73  _len, cell_len_s
+0002eb20: 7472 290a 2020 2020 2020 2020 2020 2020  tr).            
+0002eb30: 2020 2020 2020 2020 6365 6c6c 5f66 6f72          cell_for
+0002eb40: 6d61 7420 3d20 2827 2e30 6627 2c20 6365  mat = ('.0f', ce
+0002eb50: 6c6c 5f6c 656e 2c20 7365 6c66 2e73 6861  ll_len, self.sha
+0002eb60: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
+0002eb70: 2020 2020 656c 6966 2061 6c6c 2828 6469      elif all((di
+0002eb80: 7370 6c61 795f 7465 6e73 6f72 202d 2064  splay_tensor - d
+0002eb90: 6973 706c 6179 5f74 656e 736f 722e 726f  isplay_tensor.ro
+0002eba0: 756e 6428 6465 6369 6d61 6c73 3d32 2929  und(decimals=2))
+0002ebb0: 2e61 6273 2829 203c 2031 652d 3429 206f  .abs() < 1e-4) o
+0002ebc0: 7220 616e 7928 6469 7370 6c61 795f 7465  r any(display_te
+0002ebd0: 6e73 6f72 203e 3d20 3165 3229 206f 7220  nsor >= 1e2) or 
+0002ebe0: 616e 7928 6469 7370 6c61 795f 7465 6e73  any(display_tens
+0002ebf0: 6f72 203c 3d20 2d31 6531 293a 0a20 2020  or <= -1e1):.   
+0002ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ec10: 2063 656c 6c5f 6c65 6e20 3d20 696e 745f   cell_len = int_
+0002ec20: 286d 6178 2828 2d64 6973 706c 6179 5f74  (max((-display_t
+0002ec30: 656e 736f 722e 7369 676e 2829 292e 636c  ensor.sign()).cl
+0002ec40: 616d 7028 6d69 6e3d 3029 202b 2064 6973  amp(min=0) + dis
+0002ec50: 706c 6179 5f74 656e 736f 722e 6162 7328  play_tensor.abs(
+0002ec60: 292e 636c 616d 7028 6d69 6e3d 3129 2e6c  ).clamp(min=1).l
+0002ec70: 6f67 2831 3029 2e66 6c6f 6f72 2829 292e  og(10).floor()).
+0002ec80: 6974 656d 2829 2920 2b20 3120 2b20 330a  item()) + 1 + 3.
+0002ec90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eca0: 2020 2020 2320 6365 6c6c 5f6c 656e 203d      # cell_len =
+0002ecb0: 206d 6178 5f28 6365 6c6c 5f6c 656e 2c20   max_(cell_len, 
+0002ecc0: 696e 745f 286d 6178 2864 6973 706c 6179  int_(max(display
+0002ecd0: 5f74 656e 736f 722e 636c 616d 7028 6d61  _tensor.clamp(ma
+0002ece0: 783d 2d31 652d 3129 2e61 6273 2829 2e6c  x=-1e-1).abs().l
+0002ecf0: 6f67 2831 3029 2e66 6c6f 6f72 2829 292e  og(10).floor()).
+0002ed00: 6974 656d 2829 2920 2b20 3120 2b20 3120  item()) + 1 + 1 
+0002ed10: 2b20 3329 0a20 2020 2020 2020 2020 2020  + 3).           
+0002ed20: 2020 2020 2020 2020 2063 656c 6c5f 6c65           cell_le
+0002ed30: 6e20 3d20 6d69 6e5f 2863 656c 6c5f 6c65  n = min_(cell_le
+0002ed40: 6e2c 2063 656c 6c5f 6c65 6e5f 6578 7029  n, cell_len_exp)
+0002ed50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ed60: 2020 2020 2069 6620 7374 725f 656c 653a       if str_ele:
+0002ed70: 2063 656c 6c5f 6c65 6e20 3d20 6d61 785f   cell_len = max_
+0002ed80: 2863 656c 6c5f 6c65 6e2c 2063 656c 6c5f  (cell_len, cell_
+0002ed90: 6c65 6e5f 7374 7229 0a20 2020 2020 2020  len_str).       
+0002eda0: 2020 2020 2020 2020 2020 2020 2063 656c               cel
+0002edb0: 6c5f 666f 726d 6174 203d 2028 272e 3266  l_format = ('.2f
+0002edc0: 272c 2063 656c 6c5f 6c65 6e2c 2073 656c  ', cell_len, sel
+0002edd0: 662e 7368 6170 6529 0a20 2020 2020 2020  f.shape).       
+0002ede0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0002edf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ee00: 2020 2063 656c 6c5f 6c65 6e20 3d20 696e     cell_len = in
+0002ee10: 745f 286d 6178 2828 2d64 6973 706c 6179  t_(max((-display
+0002ee20: 5f74 656e 736f 722e 7369 676e 2829 292e  _tensor.sign()).
+0002ee30: 636c 616d 7028 6d69 6e3d 3029 202b 2064  clamp(min=0) + d
+0002ee40: 6973 706c 6179 5f74 656e 736f 722e 6162  isplay_tensor.ab
+0002ee50: 7328 292e 636c 616d 7028 6d69 6e3d 3129  s().clamp(min=1)
+0002ee60: 2e6c 6f67 2831 3029 2e66 6c6f 6f72 2829  .log(10).floor()
+0002ee70: 292e 6974 656d 2829 2920 2b20 3120 2b20  ).item()) + 1 + 
+0002ee80: 350a 2020 2020 2020 2020 2020 2020 2020  5.              
+0002ee90: 2020 2020 2020 2320 6365 6c6c 5f6c 656e        # cell_len
+0002eea0: 203d 206d 6178 5f28 6365 6c6c 5f6c 656e   = max_(cell_len
+0002eeb0: 2c20 696e 745f 286d 6178 2864 6973 706c  , int_(max(displ
+0002eec0: 6179 5f74 656e 736f 722e 636c 616d 7028  ay_tensor.clamp(
+0002eed0: 6d61 783d 2d31 652d 3129 2e61 6273 2829  max=-1e-1).abs()
+0002eee0: 2e6c 6f67 2831 3029 2e66 6c6f 6f72 2829  .log(10).floor()
+0002eef0: 292e 6974 656d 2829 2920 2b20 3120 2b20  ).item()) + 1 + 
+0002ef00: 3120 2b20 3529 0a20 2020 2020 2020 2020  1 + 5).         
+0002ef10: 2020 2020 2020 2020 2020 2063 656c 6c5f             cell_
+0002ef20: 6c65 6e20 3d20 6d69 6e5f 2863 656c 6c5f  len = min_(cell_
+0002ef30: 6c65 6e2c 2063 656c 6c5f 6c65 6e5f 6578  len, cell_len_ex
+0002ef40: 7029 0a20 2020 2020 2020 2020 2020 2020  p).             
+0002ef50: 2020 2020 2020 2069 6620 7374 725f 656c         if str_el
+0002ef60: 653a 2063 656c 6c5f 6c65 6e20 3d20 6d61  e: cell_len = ma
+0002ef70: 785f 2863 656c 6c5f 6c65 6e2c 2063 656c  x_(cell_len, cel
+0002ef80: 6c5f 6c65 6e5f 7374 7229 0a20 2020 2020  l_len_str).     
+0002ef90: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0002efa0: 656c 6c5f 666f 726d 6174 203d 2028 272e  ell_format = ('.
+0002efb0: 3466 272c 2063 656c 6c5f 6c65 6e2c 2073  4f', cell_len, s
+0002efc0: 656c 662e 7368 6170 6529 0a20 2020 2020  elf.shape).     
+0002efd0: 2020 2063 656c 6c5f 666e 616d 652c 2063     cell_fname, c
+0002efe0: 656c 6c5f 6c65 6e2c 2074 6f74 616c 5f73  ell_len, total_s
+0002eff0: 697a 6520 3d20 6365 6c6c 5f66 6f72 6d61  ize = cell_forma
+0002f000: 740a 2020 2020 2020 2020 656c 7073 203d  t.        elps =
+0002f010: 2028 227b 3a5e 2564 737d 2225 6365 6c6c   ("{:^%ds}"%cell
+0002f020: 5f6c 656e 292e 666f 726d 6174 2827 2e2e  _len).format('..
+0002f030: 2e27 290a 2020 2020 2020 2020 6966 2073  .').        if s
+0002f040: 656c 662e 6e5f 6469 6d20 3d3d 2030 3a0a  elf.n_dim == 0:.
+0002f050: 2020 2020 2020 2020 2020 2020 7661 6c20              val 
+0002f060: 3d20 7365 6c66 2e69 7465 6d28 290a 2020  = self.item().  
+0002f070: 2020 2020 2020 2020 2020 6465 6620 7661            def va
+0002f080: 6c5f 7374 7228 7661 6c29 3a0a 2020 2020  l_str(val):.    
+0002f090: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+0002f0a0: 6570 7228 7661 6c29 203d 3d20 276e 616e  epr(val) == 'nan
+0002f0b0: 273a 2072 6574 7572 6e20 2822 7b3a 3e25  ': return ("{:>%
+0002f0c0: 6473 7d22 2563 656c 6c5f 6c65 6e29 2e66  ds}"%cell_len).f
+0002f0d0: 6f72 6d61 7428 224e 614e 2229 0a20 2020  ormat("NaN").   
+0002f0e0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+0002f0f0: 6620 7265 7072 2876 616c 2920 3d3d 2027  f repr(val) == '
+0002f100: 696e 6627 3a20 7265 7475 726e 2028 227b  inf': return ("{
+0002f110: 3a3e 2564 737d 2225 6365 6c6c 5f6c 656e  :>%ds}"%cell_len
+0002f120: 292e 666f 726d 6174 2822 496e 6622 290a  ).format("Inf").
+0002f130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f140: 656c 6966 2072 6570 7228 7661 6c29 203d  elif repr(val) =
+0002f150: 3d20 272d 696e 6627 3a20 7265 7475 726e  = '-inf': return
+0002f160: 2028 227b 3a3e 2564 737d 2225 6365 6c6c   ("{:>%ds}"%cell
+0002f170: 5f6c 656e 292e 666f 726d 6174 2822 2d49  _len).format("-I
+0002f180: 6e66 2229 0a20 2020 2020 2020 2020 2020  nf").           
+0002f190: 2020 2020 2065 6c69 6620 6365 6c6c 5f66       elif cell_f
+0002f1a0: 6e61 6d65 203d 3d20 2762 6f6f 6c27 3a20  name == 'bool': 
+0002f1b0: 7265 7475 726e 2028 227b 3a5e 2564 737d  return ("{:^%ds}
+0002f1c0: 2225 6365 6c6c 5f6c 656e 292e 666f 726d  "%cell_len).form
+0002f1d0: 6174 2873 7472 2876 616c 2929 0a20 2020  at(str(val)).   
+0002f1e0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+0002f1f0: 6620 6365 6c6c 5f66 6e61 6d65 203d 3d20  f cell_fname == 
+0002f200: 2769 6e74 273a 2072 6574 7572 6e20 2822  'int': return ("
+0002f210: 7b3a 5e25 6464 7d22 2563 656c 6c5f 6c65  {:^%dd}"%cell_le
+0002f220: 6e29 2e66 6f72 6d61 7428 7661 6c29 0a20  n).format(val). 
+0002f230: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0002f240: 6c69 6620 6365 6c6c 5f66 6e61 6d65 203d  lif cell_fname =
+0002f250: 3d20 272e 3066 273a 2072 6574 7572 6e20  = '.0f': return 
+0002f260: 2822 7b3a 2564 737d 2225 6365 6c6c 5f6c  ("{:%ds}"%cell_l
+0002f270: 656e 292e 666f 726d 6174 2873 7472 2872  en).format(str(r
+0002f280: 6f75 6e64 5f28 7661 6c29 2920 2b20 272e  ound_(val)) + '.
+0002f290: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+0002f2a0: 2020 2065 6c69 6620 6365 6c6c 5f66 6e61     elif cell_fna
+0002f2b0: 6d65 203d 3d20 272e 3266 273a 2072 6574  me == '.2f': ret
+0002f2c0: 7572 6e20 2822 7b3a 2564 2e32 667d 2225  urn ("{:%d.2f}"%
+0002f2d0: 6365 6c6c 5f6c 656e 292e 666f 726d 6174  cell_len).format
+0002f2e0: 2876 616c 290a 2020 2020 2020 2020 2020  (val).          
+0002f2f0: 2020 2020 2020 656c 6966 2063 656c 6c5f        elif cell_
+0002f300: 666e 616d 6520 3d3d 2027 2e34 6627 3a20  fname == '.4f': 
+0002f310: 7265 7475 726e 2028 227b 3a25 642e 3466  return ("{:%d.4f
+0002f320: 7d22 2563 656c 6c5f 6c65 6e29 2e66 6f72  }"%cell_len).for
+0002f330: 6d61 7428 7661 6c29 0a20 2020 2020 2020  mat(val).       
+0002f340: 2020 2020 2020 2020 2065 6c69 6620 6365           elif ce
+0002f350: 6c6c 5f66 6e61 6d65 203d 3d20 2765 7870  ll_fname == 'exp
+0002f360: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+0002f370: 2020 2020 2020 2069 6620 7661 6c20 3d3d         if val ==
+0002f380: 2030 3a20 6c65 7620 3d20 300a 2020 2020   0: lev = 0.    
+0002f390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f3a0: 656c 7365 3a20 6c65 7620 3d20 696e 745f  else: lev = int_
+0002f3b0: 286d 6174 682e 6c6f 6728 6162 735f 2876  (math.log(abs_(v
+0002f3c0: 616c 292c 2031 3029 290a 2020 2020 2020  al), 10)).      
+0002f3d0: 2020 2020 2020 2020 2020 2020 2020 6261                ba
+0002f3e0: 7365 203d 2076 616c 202f 2028 3130 202a  se = val / (10 *
+0002f3f0: 2a20 6c65 7629 0a20 2020 2020 2020 2020  * lev).         
+0002f400: 2020 2020 2020 2020 2020 206c 6576 5f73             lev_s
+0002f410: 7472 203d 2066 277b 6c65 763a 3264 7d27  tr = f'{lev:2d}'
+0002f420: 2e72 6570 6c61 6365 2827 2027 2c20 272b  .replace(' ', '+
+0002f430: 2729 2069 6620 6c65 7620 3e3d 2030 2065  ') if lev >= 0 e
+0002f440: 6c73 6520 6627 7b6c 6576 3a31 647d 270a  lse f'{lev:1d}'.
+0002f450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f460: 2020 2020 7265 7475 726e 2066 227b 6261      return f"{ba
+0002f470: 7365 3a35 2e32 667d 657b 6c65 765f 7374  se:5.2f}e{lev_st
+0002f480: 727d 220a 2020 2020 2020 2020 2020 2020  r}".            
+0002f490: 6966 2069 7369 6e73 7461 6e63 6528 7661  if isinstance(va
+0002f4a0: 6c2c 2063 6f6d 706c 6578 5f29 3a0a 2020  l, complex_):.  
+0002f4b0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0002f4c0: 7475 726e 2076 616c 5f73 7472 2876 616c  turn val_str(val
+0002f4d0: 2e72 6561 6c29 202b 2027 2b27 202b 2076  .real) + '+' + v
+0002f4e0: 616c 5f73 7472 2876 616c 2e69 6d61 6729  al_str(val.imag)
+0002f4f0: 202b 2027 6927 0a20 2020 2020 2020 2020   + 'i'.         
+0002f500: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002f510: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0002f520: 7661 6c5f 7374 7228 7661 6c29 0a20 2020  val_str(val).   
+0002f530: 2020 2020 2069 6620 7365 6c66 2e6e 5f64       if self.n_d
+0002f540: 696d 203d 3d20 313a 0a20 2020 2020 2020  im == 1:.       
+0002f550: 2020 2020 206d 6178 5f73 697a 652c 2070       max_size, p
+0002f560: 6164 5f73 697a 6520 3d20 6372 6974 6572  ad_size = criter
+0002f570: 6961 5b27 3c6e 275d 0a20 2020 2020 2020  ia['<n'].       
+0002f580: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0002f590: 6365 2870 6164 5f73 697a 652c 2069 6e74  ce(pad_size, int
+0002f5a0: 5f29 3a20 7061 645f 7369 7a65 203d 2028  _): pad_size = (
+0002f5b0: 7061 645f 7369 7a65 2c20 7061 645f 7369  pad_size, pad_si
+0002f5c0: 7a65 290a 2020 2020 2020 2020 2020 2020  ze).            
+0002f5d0: 6e5f 7369 7a65 203d 2073 656c 662e 7369  n_size = self.si
+0002f5e0: 7a65 2830 290a 2020 2020 2020 2020 2020  ze(0).          
+0002f5f0: 2020 6469 7370 6c61 795f 7361 6d70 6c65    display_sample
+0002f600: 7320 3d20 7261 6e67 655f 286e 5f73 697a  s = range_(n_siz
+0002f610: 6529 2069 6620 6e5f 7369 7a65 203c 3d20  e) if n_size <= 
+0002f620: 6d61 785f 7369 7a65 2065 6c73 6520 6c69  max_size else li
+0002f630: 7374 2872 616e 6765 5f28 7061 645f 7369  st(range_(pad_si
+0002f640: 7a65 5b30 5d29 2920 2b20 5b2e 2e2e 5d20  ze[0])) + [...] 
+0002f650: 2b20 6c69 7374 2872 616e 6765 5f28 6e5f  + list(range_(n_
+0002f660: 7369 7a65 202d 2070 6164 5f73 697a 655b  size - pad_size[
+0002f670: 315d 2c20 6e5f 7369 7a65 2929 0a20 2020  1], n_size)).   
+0002f680: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+0002f690: 2e68 6173 5f66 756e 633a 2072 6574 7572  .has_func: retur
+0002f6a0: 6e20 6622 287b 2720 272e 6a6f 696e 2865  n f"({' '.join(e
+0002f6b0: 6c70 7320 6966 2069 203d 3d20 2e2e 2e20  lps if i == ... 
+0002f6c0: 656c 7365 2073 656c 665b 695d 2e5f 5f72  else self[i].__r
+0002f6d0: 6177 5f72 6570 725f 5f28 6365 6c6c 5f66  aw_repr__(cell_f
+0002f6e0: 6f72 6d61 743d 6365 6c6c 5f66 6f72 6d61  ormat=cell_forma
+0002f6f0: 7429 2066 6f72 2069 2069 6e20 6469 7370  t) for i in disp
+0002f700: 6c61 795f 7361 6d70 6c65 7329 7d29 220a  lay_samples)})".
+0002f710: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0002f720: 2073 656c 662e 6861 735f 6261 7463 683a   self.has_batch:
+0002f730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f740: 2069 6620 746f 7461 6c5f 7369 7a65 2e6e   if total_size.n
+0002f750: 5f66 756e 635f 6469 6d20 2b20 746f 7461  _func_dim + tota
+0002f760: 6c5f 7369 7a65 2e6e 5f62 6174 6368 5f64  l_size.n_batch_d
+0002f770: 696d 203d 3d20 746f 7461 6c5f 7369 7a65  im == total_size
+0002f780: 2e6e 5f64 696d 3a0a 2020 2020 2020 2020  .n_dim:.        
+0002f790: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002f7a0: 726e 2066 227b 7b7b 7365 6c66 5b30 5d2e  rn f"{{{self[0].
+0002f7b0: 5f5f 7261 775f 7265 7072 5f5f 2863 656c  __raw_repr__(cel
+0002f7c0: 6c5f 666f 726d 6174 3d63 656c 6c5f 666f  l_format=cell_fo
+0002f7d0: 726d 6174 297d 2c20 2e2e 2e7d 7d22 0a20  rmat)}, ...}}". 
+0002f7e0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0002f7f0: 6c73 653a 2072 6574 7572 6e20 6622 7b7b  lse: return f"{{
+0002f800: 7b73 656c 665b 305d 2e5f 5f72 6177 5f72  {self[0].__raw_r
+0002f810: 6570 725f 5f28 6365 6c6c 5f66 6f72 6d61  epr__(cell_forma
+0002f820: 743d 6365 6c6c 5f66 6f72 6d61 7429 7d7d  t=cell_format)}}
+0002f830: 7d22 0a20 2020 2020 2020 2020 2020 2065  }".            e
+0002f840: 6c69 6620 7365 6c66 2e68 6173 5f66 6561  lif self.has_fea
+0002f850: 7475 7265 3a0a 2020 2020 2020 2020 2020  ture:.          
+0002f860: 2020 2020 2020 6966 2074 6f74 616c 5f73        if total_s
+0002f870: 697a 652e 6e5f 6665 6174 7572 655f 6469  ize.n_feature_di
+0002f880: 6d20 3d3d 2031 3a0a 2020 2020 2020 2020  m == 1:.        
+0002f890: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002f8a0: 726e 2054 656e 736f 722e 5f5f 636f 726e  rn Tensor.__corn
+0002f8b0: 6572 5f62 6c6f 636b 5f72 6570 725f 5f28  er_block_repr__(
+0002f8c0: 275c 6e27 2e6a 6f69 6e28 656c 7073 2069  '\n'.join(elps i
+0002f8d0: 6620 6920 3d3d 202e 2e2e 2065 6c73 6520  f i == ... else 
+0002f8e0: 7365 6c66 5b69 5d2e 5f5f 7261 775f 7265  self[i].__raw_re
+0002f8f0: 7072 5f5f 2863 656c 6c5f 666f 726d 6174  pr__(cell_format
+0002f900: 3d63 656c 6c5f 666f 726d 6174 2920 666f  =cell_format) fo
+0002f910: 7220 6920 696e 2064 6973 706c 6179 5f73  r i in display_s
+0002f920: 616d 706c 6573 2929 0a20 2020 2020 2020  amples)).       
+0002f930: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0002f940: 6622 7b27 2027 2e6a 6f69 6e28 656c 7073  f"{' '.join(elps
+0002f950: 2069 6620 6920 3d3d 202e 2e2e 2065 6c73   if i == ... els
+0002f960: 6520 7365 6c66 5b69 5d2e 5f5f 7261 775f  e self[i].__raw_
+0002f970: 7265 7072 5f5f 2863 656c 6c5f 666f 726d  repr__(cell_form
+0002f980: 6174 3d63 656c 6c5f 666f 726d 6174 2920  at=cell_format) 
+0002f990: 666f 7220 6920 696e 2064 6973 706c 6179  for i in display
+0002f9a0: 5f73 616d 706c 6573 297d 220a 2020 2020  _samples)}".    
+0002f9b0: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
+0002f9c0: 662e 6861 735f 7365 7175 656e 6365 3a0a  f.has_sequence:.
+0002f9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f9e0: 6966 2074 6f74 616c 5f73 697a 652e 6e5f  if total_size.n_
+0002f9f0: 7370 6163 655f 6469 6d20 3e20 303a 2072  space_dim > 0: r
+0002fa00: 6574 7572 6e20 6622 3e7b 7365 6c66 5b30  eturn f">{self[0
+0002fa10: 5d2e 5f5f 7261 775f 7265 7072 5f5f 2863  ].__raw_repr__(c
+0002fa20: 656c 6c5f 666f 726d 6174 3d63 656c 6c5f  ell_format=cell_
+0002fa30: 666f 726d 6174 297d 3e22 0a20 2020 2020  format)}>".     
+0002fa40: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0002fa50: 6e5f 7369 7a65 203d 3d20 313a 2072 6574  n_size == 1: ret
+0002fa60: 7572 6e20 6622 3e20 7b73 656c 665b 305d  urn f"> {self[0]
+0002fa70: 2e5f 5f72 6177 5f72 6570 725f 5f28 6365  .__raw_repr__(ce
+0002fa80: 6c6c 5f66 6f72 6d61 743d 6365 6c6c 5f66  ll_format=cell_f
+0002fa90: 6f72 6d61 7429 7d20 3e22 0a20 2020 2020  ormat)} >".     
+0002faa0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0002fab0: 6e5f 7369 7a65 203d 3d20 323a 2072 6574  n_size == 2: ret
+0002fac0: 7572 6e20 6622 277b 7365 6c66 5b30 5d2e  urn f"'{self[0].
+0002fad0: 5f5f 7261 775f 7265 7072 5f5f 2863 656c  __raw_repr__(cel
+0002fae0: 6c5f 666f 726d 6174 3d63 656c 6c5f 666f  l_format=cell_fo
+0002faf0: 726d 6174 297d 203e 207b 7365 6c66 5b2d  rmat)} > {self[-
+0002fb00: 315d 2e5f 5f72 6177 5f72 6570 725f 5f28  1].__raw_repr__(
+0002fb10: 6365 6c6c 5f66 6f72 6d61 743d 6365 6c6c  cell_format=cell
+0002fb20: 5f66 6f72 6d61 7429 7d27 220a 2020 2020  _format)}'".    
+0002fb30: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0002fb40: 3a20 7265 7475 726e 2066 2227 7b73 656c  : return f"'{sel
+0002fb50: 665b 305d 2e5f 5f72 6177 5f72 6570 725f  f[0].__raw_repr_
+0002fb60: 5f28 6365 6c6c 5f66 6f72 6d61 743d 6365  _(cell_format=ce
+0002fb70: 6c6c 5f66 6f72 6d61 7429 7d20 3e20 2e2e  ll_format)} > ..
+0002fb80: 2e20 3e20 7b73 656c 665b 2d31 5d2e 5f5f  . > {self[-1].__
+0002fb90: 7261 775f 7265 7072 5f5f 2863 656c 6c5f  raw_repr__(cell_
+0002fba0: 666f 726d 6174 3d63 656c 6c5f 666f 726d  format=cell_form
+0002fbb0: 6174 297d 2722 0a20 2020 2020 2020 2020  at)}'".         
+0002fbc0: 2020 2065 6c73 653a 2072 6574 7572 6e20     else: return 
+0002fbd0: 6622 5b7b 272c 2027 2e6a 6f69 6e28 656c  f"[{', '.join(el
+0002fbe0: 7073 2069 6620 6920 3d3d 202e 2e2e 2065  ps if i == ... e
+0002fbf0: 6c73 6520 7365 6c66 5b69 5d2e 5f5f 7261  lse self[i].__ra
+0002fc00: 775f 7265 7072 5f5f 2863 656c 6c5f 666f  w_repr__(cell_fo
+0002fc10: 726d 6174 3d63 656c 6c5f 666f 726d 6174  rmat=cell_format
+0002fc20: 2920 666f 7220 6920 696e 2064 6973 706c  ) for i in displ
+0002fc30: 6179 5f73 616d 706c 6573 297d 5d22 0a20  ay_samples)}]". 
+0002fc40: 2020 2020 2020 2069 6620 7365 6c66 2e6e         if self.n
+0002fc50: 5f64 696d 203e 2034 3a20 6d61 785f 7369  _dim > 4: max_si
+0002fc60: 7a65 2c20 7061 645f 7369 7a65 203d 2063  ze, pad_size = c
+0002fc70: 7269 7465 7269 615b 273c 6e2d 3427 5d0a  riteria['<n-4'].
+0002fc80: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
+0002fc90: 662e 6e5f 6469 6d20 3e20 323a 206d 6178  f.n_dim > 2: max
+0002fca0: 5f73 697a 652c 2070 6164 5f73 697a 6520  _size, pad_size 
+0002fcb0: 3d20 6372 6974 6572 6961 5b27 3c6e 2d32  = criteria['<n-2
+0002fcc0: 275d 0a20 2020 2020 2020 2065 6c73 653a  '].        else:
+0002fcd0: 206d 6178 5f73 697a 652c 2070 6164 5f73   max_size, pad_s
+0002fce0: 697a 6520 3d20 6372 6974 6572 6961 5b27  ize = criteria['
+0002fcf0: 3c6e 2d31 275d 0a20 2020 2020 2020 2069  <n-1'].        i
+0002fd00: 6620 6973 696e 7374 616e 6365 2870 6164  f isinstance(pad
+0002fd10: 5f73 697a 652c 2069 6e74 5f29 3a20 7061  _size, int_): pa
+0002fd20: 645f 7369 7a65 203d 2028 7061 645f 7369  d_size = (pad_si
+0002fd30: 7a65 2c20 7061 645f 7369 7a65 290a 2020  ze, pad_size).  
+0002fd40: 2020 2020 2020 6e5f 7369 7a65 203d 2073        n_size = s
+0002fd50: 656c 662e 7369 7a65 2830 290a 2020 2020  elf.size(0).    
+0002fd60: 2020 2020 6469 7370 6c61 795f 7361 6d70      display_samp
+0002fd70: 6c65 7320 3d20 7261 6e67 655f 286e 5f73  les = range_(n_s
+0002fd80: 697a 6529 2069 6620 6e5f 7369 7a65 203c  ize) if n_size <
+0002fd90: 3d20 6d61 785f 7369 7a65 2065 6c73 6520  = max_size else 
+0002fda0: 6c69 7374 2872 616e 6765 5f28 7061 645f  list(range_(pad_
+0002fdb0: 7369 7a65 5b30 5d29 2920 2b20 5b2e 2e2e  size[0])) + [...
+0002fdc0: 5d20 2b20 6c69 7374 2872 616e 6765 5f28  ] + list(range_(
+0002fdd0: 6e5f 7369 7a65 202d 2070 6164 5f73 697a  n_size - pad_siz
+0002fde0: 655b 315d 2c20 6e5f 7369 7a65 2929 0a20  e[1], n_size)). 
+0002fdf0: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+0002fe00: 6861 7065 5b3a 315d 2e68 6173 5f66 756e  hape[:1].has_fun
+0002fe10: 633a 2072 6574 7572 6e20 2728 2720 2b20  c: return '(' + 
+0002fe20: 275c 6e20 272e 6a6f 696e 2827 2027 202b  '\n '.join(' ' +
+0002fe30: 2065 6c70 7320 6966 2069 203d 3d20 2e2e   elps if i == ..
+0002fe40: 2e20 656c 7365 2054 656e 736f 722e 5f5f  . else Tensor.__
+0002fe50: 7368 6966 745f 7265 7072 5f5f 2873 656c  shift_repr__(sel
+0002fe60: 665b 695d 2e5f 5f72 6177 5f72 6570 725f  f[i].__raw_repr_
+0002fe70: 5f28 6365 6c6c 5f66 6f72 6d61 743d 6365  _(cell_format=ce
+0002fe80: 6c6c 5f66 6f72 6d61 7429 2920 666f 7220  ll_format)) for 
+0002fe90: 6920 696e 2064 6973 706c 6179 5f73 616d  i in display_sam
+0002fea0: 706c 6573 2920 2b20 2729 270a 2020 2020  ples) + ')'.    
+0002feb0: 2020 2020 656c 6966 2073 656c 662e 7368      elif self.sh
+0002fec0: 6170 655b 3a31 5d2e 6861 735f 6261 7463  ape[:1].has_batc
+0002fed0: 683a 0a20 2020 2020 2020 2020 2020 2069  h:.            i
+0002fee0: 6620 6c65 6e28 7365 6c66 2e73 6861 7065  f len(self.shape
+0002fef0: 2920 3c3d 2032 206f 7220 6c65 6e28 7365  ) <= 2 or len(se
+0002ff00: 6c66 2e73 6861 7065 2920 3d3d 2033 2061  lf.shape) == 3 a
+0002ff10: 6e64 2073 656c 662e 7368 6170 652e 6861  nd self.shape.ha
+0002ff20: 735f 7365 7175 656e 6365 3a0a 2020 2020  s_sequence:.    
+0002ff30: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002ff40: 726e 2066 227b 7b7b 5465 6e73 6f72 2e5f  rn f"{{{Tensor._
+0002ff50: 5f73 6869 6674 5f72 6570 725f 5f28 7365  _shift_repr__(se
+0002ff60: 6c66 5b30 5d2e 5f5f 7261 775f 7265 7072  lf[0].__raw_repr
+0002ff70: 5f5f 2863 656c 6c5f 666f 726d 6174 3d63  __(cell_format=c
+0002ff80: 656c 6c5f 666f 726d 6174 2929 7d2c 202e  ell_format))}, .
+0002ff90: 2e2e 7d7d 220a 2020 2020 2020 2020 2020  ..}}".          
+0002ffa0: 2020 7265 7475 726e 2066 227b 7b7b 5465    return f"{{{Te
+0002ffb0: 6e73 6f72 2e5f 5f73 6869 6674 5f72 6570  nsor.__shift_rep
+0002ffc0: 725f 5f28 7365 6c66 5b30 5d2e 5f5f 7261  r__(self[0].__ra
+0002ffd0: 775f 7265 7072 5f5f 2863 656c 6c5f 666f  w_repr__(cell_fo
+0002ffe0: 726d 6174 3d63 656c 6c5f 666f 726d 6174  rmat=cell_format
+0002fff0: 2929 7d2c 5c6e 2e2e 2e7d 7d22 0a20 2020  ))},\n...}}".   
+00030000: 2020 2020 2065 6c69 6620 7365 6c66 2e73       elif self.s
+00030010: 6861 7065 5b3a 315d 2e68 6173 5f66 6561  hape[:1].has_fea
+00030020: 7475 7265 3a0a 2020 2020 2020 2020 2020  ture:.          
+00030030: 2020 6966 2074 6f74 616c 5f73 697a 652e    if total_size.
+00030040: 6e5f 6665 6174 7572 655f 6469 6d20 3c3d  n_feature_dim <=
+00030050: 2032 3a0a 2020 2020 2020 2020 2020 2020   2:.            
+00030060: 2020 2020 7265 7475 726e 2054 656e 736f      return Tenso
+00030070: 722e 5f5f 636f 726e 6572 5f62 6c6f 636b  r.__corner_block
+00030080: 5f72 6570 725f 5f28 275c 6e27 2e6a 6f69  _repr__('\n'.joi
+00030090: 6e28 656c 7073 2069 6620 6920 3d3d 202e  n(elps if i == .
+000300a0: 2e2e 2065 6c73 6520 7365 6c66 5b69 5d2e  .. else self[i].
+000300b0: 5f5f 7261 775f 7265 7072 5f5f 2863 656c  __raw_repr__(cel
+000300c0: 6c5f 666f 726d 6174 3d63 656c 6c5f 666f  l_format=cell_fo
+000300d0: 726d 6174 2920 666f 7220 6920 696e 2064  rmat) for i in d
+000300e0: 6973 706c 6179 5f73 616d 706c 6573 2929  isplay_samples))
+000300f0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00030100: 6620 746f 7461 6c5f 7369 7a65 2e6e 5f64  f total_size.n_d
+00030110: 696d 202d 206c 656e 2873 656c 662e 7368  im - len(self.sh
+00030120: 6170 6529 203d 3d20 746f 7461 6c5f 7369  ape) == total_si
+00030130: 7a65 2e66 6561 7475 7265 5f73 746f 702d  ze.feature_stop-
+00030140: 3120 616e 6420 746f 7461 6c5f 7369 7a65  1 and total_size
+00030150: 2e73 7a5f 6665 6174 7572 655f 6469 6d20  .sz_feature_dim 
+00030160: 3c20 3020 616e 6420 6e6f 7420 7365 6c66  < 0 and not self
+00030170: 2e73 6861 7065 5b31 3a5d 2e68 6173 5f66  .shape[1:].has_f
+00030180: 756e 633a 0a20 2020 2020 2020 2020 2020  unc:.           
+00030190: 2020 2020 2069 6620 746f 7461 6c5f 7369       if total_si
+000301a0: 7a65 2e6e 5f66 6561 7475 7265 5f64 696d  ze.n_feature_dim
+000301b0: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
+000301c0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000301d0: 2066 227b 2720 272e 6a6f 696e 2865 6c70   f"{' '.join(elp
+000301e0: 7320 6966 2069 203d 3d20 2e2e 2e20 656c  s if i == ... el
+000301f0: 7365 2073 656c 665b 695d 2e5f 5f72 6177  se self[i].__raw
+00030200: 5f72 6570 725f 5f28 6365 6c6c 5f66 6f72  _repr__(cell_for
+00030210: 6d61 743d 6365 6c6c 5f66 6f72 6d61 7429  mat=cell_format)
+00030220: 2066 6f72 2069 2069 6e20 6469 7370 6c61   for i in displa
+00030230: 795f 7361 6d70 6c65 7329 7d22 0a20 2020  y_samples)}".   
+00030240: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00030250: 7572 6e20 6622 5b7b 2720 272e 6a6f 696e  urn f"[{' '.join
+00030260: 2865 6c70 7320 6966 2069 203d 3d20 2e2e  (elps if i == ..
+00030270: 2e20 656c 7365 2054 656e 736f 722e 5f5f  . else Tensor.__
+00030280: 7368 6966 745f 7265 7072 5f5f 2873 656c  shift_repr__(sel
+00030290: 665b 695d 2e5f 5f72 6177 5f72 6570 725f  f[i].__raw_repr_
+000302a0: 5f28 6365 6c6c 5f66 6f72 6d61 743d 6365  _(cell_format=ce
+000302b0: 6c6c 5f66 6f72 6d61 7429 2920 666f 7220  ll_format)) for 
+000302c0: 6920 696e 2064 6973 706c 6179 5f73 616d  i in display_sam
+000302d0: 706c 6573 297d 5d22 0a20 2020 2020 2020  ples)}]".       
+000302e0: 2020 2020 2065 6c73 653a 2072 6574 7572       else: retur
+000302f0: 6e20 27ef bda2 2720 2b20 275c 6e20 272e  n '...' + '\n '.
+00030300: 6a6f 696e 2827 2027 202b 2065 6c70 7320  join(' ' + elps 
+00030310: 6966 2069 203d 3d20 2e2e 2e20 656c 7365  if i == ... else
+00030320: 2054 656e 736f 722e 5f5f 7368 6966 745f   Tensor.__shift_
+00030330: 7265 7072 5f5f 2873 656c 665b 695d 2e5f  repr__(self[i]._
+00030340: 5f72 6177 5f72 6570 725f 5f28 6365 6c6c  _raw_repr__(cell
+00030350: 5f66 6f72 6d61 743d 6365 6c6c 5f66 6f72  _format=cell_for
+00030360: 6d61 7429 2920 666f 7220 6920 696e 2064  mat)) for i in d
+00030370: 6973 706c 6179 5f73 616d 706c 6573 2920  isplay_samples) 
+00030380: 2b20 27ef bda3 270a 2020 2020 2020 2020  + '...'.        
+00030390: 656c 6966 2073 656c 662e 7368 6170 655b  elif self.shape[
+000303a0: 3a31 5d2e 6861 735f 7365 7175 656e 6365  :1].has_sequence
+000303b0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+000303c0: 2074 6f74 616c 5f73 697a 652e 6e5f 6469   total_size.n_di
+000303d0: 6d20 2d20 6c65 6e28 7365 6c66 2e73 6861  m - len(self.sha
+000303e0: 7065 2920 3d3d 2074 6f74 616c 5f73 697a  pe) == total_siz
+000303f0: 652e 7365 7175 656e 6365 5f73 746f 702d  e.sequence_stop-
+00030400: 3120 616e 6420 746f 7461 6c5f 7369 7a65  1 and total_size
+00030410: 2e73 7a5f 7365 7175 656e 6365 5f64 696d  .sz_sequence_dim
+00030420: 203c 2030 3a0a 2020 2020 2020 2020 2020   < 0:.          
+00030430: 2020 2020 2020 7265 7475 726e 2066 223e        return f">
+00030440: 7b54 656e 736f 722e 5f5f 7368 6966 745f  {Tensor.__shift_
+00030450: 7265 7072 5f5f 2873 656c 665b 305d 2e5f  repr__(self[0]._
+00030460: 5f72 6177 5f72 6570 725f 5f28 6365 6c6c  _raw_repr__(cell
+00030470: 5f66 6f72 6d61 743d 6365 6c6c 5f66 6f72  _format=cell_for
+00030480: 6d61 7429 297d 3e22 0a20 2020 2020 2020  mat))}>".       
+00030490: 2020 2020 2065 6c69 6620 6e5f 7369 7a65       elif n_size
+000304a0: 203d 3d20 313a 2072 6574 7572 6e20 273e   == 1: return '>
+000304b0: 2027 202b 2054 656e 736f 722e 5f5f 7368   ' + Tensor.__sh
+000304c0: 6966 745f 7265 7072 5f5f 2873 656c 665b  ift_repr__(self[
+000304d0: 305d 2e5f 5f72 6177 5f72 6570 725f 5f28  0].__raw_repr__(
+000304e0: 6365 6c6c 5f66 6f72 6d61 743d 6365 6c6c  cell_format=cell
+000304f0: 5f66 6f72 6d61 7429 2c20 3329 202b 2027  _format), 3) + '
+00030500: 203e 270a 2020 2020 2020 2020 2020 2020   >'.            
+00030510: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00030520: 2020 2020 2020 6974 656d 3120 3d20 5465        item1 = Te
+00030530: 6e73 6f72 2e5f 5f73 6869 6674 5f72 6570  nsor.__shift_rep
+00030540: 725f 5f28 7365 6c66 5b30 5d2e 5f5f 7261  r__(self[0].__ra
+00030550: 775f 7265 7072 5f5f 2863 656c 6c5f 666f  w_repr__(cell_fo
+00030560: 726d 6174 3d63 656c 6c5f 666f 726d 6174  rmat=cell_format
+00030570: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00030580: 2020 2069 7465 6d6e 203d 2054 656e 736f     itemn = Tenso
+00030590: 722e 5f5f 7368 6966 745f 7265 7072 5f5f  r.__shift_repr__
+000305a0: 2873 656c 665b 2d31 5d2e 5f5f 7261 775f  (self[-1].__raw_
+000305b0: 7265 7072 5f5f 2863 656c 6c5f 666f 726d  repr__(cell_form
+000305c0: 6174 3d63 656c 6c5f 666f 726d 6174 2929  at=cell_format))
+000305d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000305e0: 2069 6620 6e5f 7369 7a65 203d 3d20 323a   if n_size == 2:
+000305f0: 2072 6574 7572 6e20 2227 2727 3e22 202b   return "'''>" +
+00030600: 2069 7465 6d31 202b 2027 5c6e 2027 202b   item1 + '\n ' +
+00030610: 2069 7465 6d6e 202b 2022 3e27 2727 220a   itemn + ">'''".
+00030620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030630: 656c 7365 3a20 7265 7475 726e 2022 2727  else: return "''
+00030640: 2722 202b 2069 7465 6d31 202b 2027 5c6e  '" + item1 + '\n
+00030650: 2027 202b 2027 2027 202a 2072 652e 7365   ' + ' ' * re.se
+00030660: 6172 6368 2872 275c 6427 2c20 6974 656d  arch(r'\d', item
+00030670: 3129 2e73 7061 6e28 295b 305d 202b 2027  1).span()[0] + '
+00030680: 762e 2e2e 765c 6e20 2720 2b20 6974 656d  v...v\n ' + item
+00030690: 6e20 2b20 2227 2727 220a 2020 2020 2020  n + "'''".      
+000306a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000306b0: 2020 2020 6966 2074 6f74 616c 5f73 697a      if total_siz
+000306c0: 652e 6e5f 6469 6d20 2d20 6c65 6e28 7365  e.n_dim - len(se
+000306d0: 6c66 2e73 6861 7065 2920 3d3d 2074 6f74  lf.shape) == tot
+000306e0: 616c 5f73 697a 652e 7370 6163 655f 7374  al_size.space_st
+000306f0: 6f70 2d31 3a0a 2020 2020 2020 2020 2020  op-1:.          
+00030700: 2020 2020 2020 636f 6c75 6d6e 7320 3d20        columns = 
+00030710: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
+00030720: 2020 206e 5f72 6f77 203d 204e 6f6e 650a     n_row = None.
+00030730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030740: 666f 7220 6920 696e 2064 6973 706c 6179  for i in display
+00030750: 5f73 616d 706c 6573 3a0a 2020 2020 2020  _samples:.      
+00030760: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00030770: 2069 203d 3d20 2e2e 2e3a 2063 6f6c 756d   i == ...: colum
+00030780: 6e73 2e61 7070 656e 6428 275c 6e27 2e6a  ns.append('\n'.j
+00030790: 6f69 6e28 5b27 2027 202a 2063 656c 6c5f  oin([' ' * cell_
+000307a0: 666f 726d 6174 5b31 5d5d 202a 2028 6e5f  format[1]] * (n_
+000307b0: 726f 7720 2d20 3129 202b 205b 656c 7073  row - 1) + [elps
+000307c0: 5d29 293b 2063 6f6e 7469 6e75 650a 2020  ])); continue.  
+000307d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000307e0: 2020 636f 6c75 6d6e 732e 6170 7065 6e64    columns.append
+000307f0: 2854 656e 736f 722e 5f5f 626c 6f63 6b5f  (Tensor.__block_
+00030800: 7265 7072 5f5f 2873 656c 665b 695d 2e5f  repr__(self[i]._
+00030810: 5f72 6177 5f72 6570 725f 5f28 6365 6c6c  _raw_repr__(cell
+00030820: 5f66 6f72 6d61 743d 6365 6c6c 5f66 6f72  _format=cell_for
+00030830: 6d61 7429 2929 0a20 2020 2020 2020 2020  mat))).         
+00030840: 2020 2020 2020 2020 2020 2069 6620 6e5f             if n_
+00030850: 726f 7720 6973 204e 6f6e 653a 206e 5f72  row is None: n_r
+00030860: 6f77 203d 206c 656e 2863 6f6c 756d 6e73  ow = len(columns
+00030870: 5b30 5d2e 7370 6c69 7428 275c 6e27 2929  [0].split('\n'))
+00030880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030890: 2072 6574 7572 6e20 275b 2720 2b20 5465   return '[' + Te
+000308a0: 6e73 6f72 2e5f 5f73 6869 6674 5f72 6570  nsor.__shift_rep
+000308b0: 725f 5f28 275c 6e27 2e6a 6f69 6e28 2827  r__('\n'.join(('
+000308c0: 2c20 2720 6966 2069 203d 3d20 6e5f 726f  , ' if i == n_ro
+000308d0: 7720 2d20 3120 656c 7365 2027 2020 2729  w - 1 else '  ')
+000308e0: 2e6a 6f69 6e28 726f 7773 2920 666f 7220  .join(rows) for 
+000308f0: 692c 2072 6f77 7320 696e 2065 6e75 6d65  i, rows in enume
+00030900: 7261 7465 287a 6970 282a 5b63 2e73 706c  rate(zip(*[c.spl
+00030910: 6974 2827 5c6e 2729 2066 6f72 2063 2069  it('\n') for c i
+00030920: 6e20 636f 6c75 6d6e 735d 2929 2929 202b  n columns])))) +
+00030930: 2027 5d27 0a20 2020 2020 2020 2020 2020   ']'.           
+00030940: 2072 6574 7572 6e20 275b 2720 2b20 272c   return '[' + ',
+00030950: 5c6e 2027 2e6a 6f69 6e28 5465 6e73 6f72  \n '.join(Tensor
+00030960: 2e5f 5f73 6869 6674 5f72 6570 725f 5f28  .__shift_repr__(
+00030970: 656c 7073 2069 6620 6920 3d3d 202e 2e2e  elps if i == ...
+00030980: 2065 6c73 6520 7365 6c66 5b69 5d2e 5f5f   else self[i].__
+00030990: 7261 775f 7265 7072 5f5f 2863 656c 6c5f  raw_repr__(cell_
+000309a0: 666f 726d 6174 3d63 656c 6c5f 666f 726d  format=cell_form
+000309b0: 6174 2929 2066 6f72 2069 2069 6e20 6469  at)) for i in di
+000309c0: 7370 6c61 795f 7361 6d70 6c65 7329 202b  splay_samples) +
+000309d0: 2027 5d27 0a20 2020 200a 2020 2020 4070   ']'.    .    @p
+000309e0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+000309f0: 6d65 616e 5f73 7464 2873 656c 6629 3a0a  mean_std(self):.
+00030a00: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+00030a10: 227b 7365 6c66 2e6d 6561 6e28 292e 6465  "{self.mean().de
+00030a20: 7461 6368 2829 2e63 7075 2829 2e69 7465  tach().cpu().ite
+00030a30: 6d28 293a 2e36 667d 20c2 b120 7b73 656c  m():.6f} .. {sel
+00030a40: 662e 7374 6428 292e 6465 7461 6368 2829  f.std().detach()
+00030a50: 2e63 7075 2829 2e69 7465 6d28 293a 2e36  .cpu().item():.6
+00030a60: 667d 220a 2020 2020 0a20 2020 2064 6566  f}".    .    def
+00030a70: 205f 5f73 7472 5f5f 2873 656c 6629 3a0a   __str__(self):.
+00030a80: 2020 2020 2020 2020 6966 206e 6f74 2068          if not h
+00030a90: 6173 6174 7472 2873 656c 662c 2027 737a  asattr(self, 'sz
+00030aa0: 5f66 756e 635f 6469 6d27 293a 0a20 2020  _func_dim'):.   
+00030ab0: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
+00030ac0: 756e 7469 6d65 4572 726f 7228 6622 4e6f  untimeError(f"No
+00030ad0: 7420 696e 6974 6961 6c69 7a65 6420 6261  t initialized ba
+00030ae0: 746f 7263 682e 5465 6e73 6f72 206f 6620  torch.Tensor of 
+00030af0: 7368 6170 653a 207b 7365 6c66 2e61 735f  shape: {self.as_
+00030b00: 7375 6263 6c61 7373 2874 6f72 6368 2e54  subclass(torch.T
+00030b10: 656e 736f 7229 2e73 6861 7065 7d22 290a  ensor).shape}").
+00030b20: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00030b30: 6e5f 6469 6d20 3d3d 2030 3a0a 2020 2020  n_dim == 0:.    
+00030b40: 2020 2020 2020 2020 7661 6c20 3d20 7365          val = se
+00030b50: 6c66 2e69 7465 6d28 290a 2020 2020 2020  lf.item().      
+00030b60: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
+00030b70: 662e 6474 7970 652e 6973 5f66 6c6f 6174  f.dtype.is_float
+00030b80: 696e 675f 706f 696e 743a 2072 6574 7572  ing_point: retur
+00030b90: 6e20 7374 7228 7661 6c29 0a20 2020 2020  n str(val).     
+00030ba0: 2020 2020 2020 2065 6c69 6620 6162 735f         elif abs_
+00030bb0: 2876 616c 202d 2073 656c 662e 666c 6f6f  (val - self.floo
+00030bc0: 7228 292e 6974 656d 2829 2920 3c20 3165  r().item()) < 1e
+00030bd0: 2d34 3a20 7265 7475 726e 2066 227b 696e  -4: return f"{in
+00030be0: 745f 2876 616c 297d 2e22 0a20 2020 2020  t_(val)}.".     
+00030bf0: 2020 2020 2020 2065 6c69 6620 7265 7072         elif repr
+00030c00: 2876 616c 2920 3d3d 2027 6e61 6e27 3a20  (val) == 'nan': 
+00030c10: 7265 7475 726e 2022 4e61 4e22 0a20 2020  return "NaN".   
+00030c20: 2020 2020 2020 2020 2065 6c69 6620 7265           elif re
+00030c30: 7072 2876 616c 2920 3d3d 2027 696e 6627  pr(val) == 'inf'
+00030c40: 3a20 7265 7475 726e 2022 496e 6622 0a20  : return "Inf". 
+00030c50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00030c60: 6e20 2225 362e 3466 2225 7365 6c66 2e69  n "%6.4f"%self.i
+00030c70: 7465 6d28 290a 2020 2020 2020 2020 7072  tem().        pr
+00030c80: 6566 6978 203d 2022 5465 6e73 6f72 2822  efix = "Tensor("
+00030c90: 0a20 2020 2020 2020 2070 6172 7473 203d  .        parts =
+00030ca0: 205b 5465 6e73 6f72 2e5f 5f73 6869 6674   [Tensor.__shift
+00030cb0: 5f72 6570 725f 5f28 7365 6c66 2e5f 5f72  _repr__(self.__r
+00030cc0: 6177 5f72 6570 725f 5f28 292c 206c 656e  aw_repr__(), len
+00030cd0: 2870 7265 6669 7829 295d 0a20 2020 2020  (prefix))].     
+00030ce0: 2020 2072 6177 5f73 6861 7065 5f73 7472     raw_shape_str
+00030cf0: 203d 2073 7472 2873 656c 662e 7368 6170   = str(self.shap
+00030d00: 6529 2e73 706c 6974 2827 5369 7a65 2729  e).split('Size')
+00030d10: 5b2d 315d 0a20 2020 2020 2020 2070 6172  [-1].        par
+00030d20: 7473 2e61 7070 656e 6428 6622 7368 6170  ts.append(f"shap
+00030d30: 653d 7b72 6177 5f73 6861 7065 5f73 7472  e={raw_shape_str
+00030d40: 7d22 290a 2020 2020 2020 2020 6966 2073  }").        if s
+00030d50: 656c 662e 6465 7669 6365 2e74 7970 6520  elf.device.type 
+00030d60: 213d 2027 6370 7527 3a20 2020 200a 2020  != 'cpu':    .  
+00030d70: 2020 2020 2020 2020 2020 6465 7669 6365            device
+00030d80: 5f73 7472 203d 2027 6370 7527 2069 6620  _str = 'cpu' if 
+00030d90: 7365 6c66 2e64 6576 6963 652e 7479 7065  self.device.type
+00030da0: 203d 3d20 2763 7075 2720 656c 7365 2066   == 'cpu' else f
+00030db0: 227b 7365 6c66 2e64 6576 6963 652e 7479  "{self.device.ty
+00030dc0: 7065 7d3a 7b73 656c 662e 6465 7669 6365  pe}:{self.device
+00030dd0: 2e69 6e64 6578 7d22 0a20 2020 2020 2020  .index}".       
+00030de0: 2020 2020 2070 6172 7473 2e61 7070 656e       parts.appen
+00030df0: 6428 6622 6465 7669 6365 3d5b 7b64 6576  d(f"device=[{dev
+00030e00: 6963 655f 7374 727d 5d22 290a 2020 2020  ice_str}]").    
+00030e10: 2020 2020 6966 2073 656c 662e 6772 6164      if self.grad
+00030e20: 5f66 6e3a 2070 6172 7473 2e61 7070 656e  _fn: parts.appen
+00030e30: 6428 6622 6772 6164 5f66 6e3d 7b73 656c  d(f"grad_fn={sel
+00030e40: 662e 6772 6164 5f66 6e7d 2229 0a20 2020  f.grad_fn}").   
+00030e50: 2020 2020 2069 6620 7365 6c66 2e72 6571       if self.req
+00030e60: 7569 7265 735f 6772 6164 3a20 7061 7274  uires_grad: part
+00030e70: 732e 6170 7065 6e64 2866 2272 6571 7569  s.append(f"requi
+00030e80: 7265 735f 6772 6164 3d7b 7365 6c66 2e72  res_grad={self.r
+00030e90: 6571 7569 7265 735f 6772 6164 7d22 290a  equires_grad}").
+00030ea0: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+00030eb0: 7265 6669 7820 2b20 272c 2027 2e6a 6f69  refix + ', '.joi
+00030ec0: 6e28 7061 7274 7329 202b 2027 2927 0a0a  n(parts) + ')'..
+00030ed0: 2020 2020 6465 6620 5f5f 7265 7072 5f5f      def __repr__
+00030ee0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00030ef0: 6966 206e 6f74 2068 6173 6174 7472 2873  if not hasattr(s
+00030f00: 656c 662c 2027 737a 5f66 756e 635f 6469  elf, 'sz_func_di
+00030f10: 6d27 293a 0a20 2020 2020 2020 2020 2020  m'):.           
+00030f20: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+00030f30: 726f 7228 6622 3c4e 6f74 2069 6e69 7469  ror(f"<Not initi
+00030f40: 616c 697a 6564 2062 6174 6f72 6368 2e54  alized batorch.T
+00030f50: 656e 736f 7220 6f66 2073 6861 7065 3a20  ensor of shape: 
+00030f60: 7b73 656c 662e 6173 5f73 7562 636c 6173  {self.as_subclas
+00030f70: 7328 746f 7263 682e 5465 6e73 6f72 292e  s(torch.Tensor).
+00030f80: 7368 6170 657d 3e22 290a 2020 2020 2020  shape}>").      
+00030f90: 2020 6e75 6d5f 6e61 6e73 203d 2069 736e    num_nans = isn
+00030fa0: 616e 2873 656c 6629 2e73 756d 2829 0a20  an(self).sum(). 
+00030fb0: 2020 2020 2020 206e 756d 5f69 6e66 7320         num_infs 
+00030fc0: 3d20 6973 696e 6628 7365 6c66 292e 7375  = isinf(self).su
+00030fd0: 6d28 290a 2020 2020 2020 2020 7370 6563  m().        spec
+00030fe0: 6961 6c5f 6469 6d5f 7374 7220 3d20 6622  ial_dim_str = f"
+00030ff0: 5b7b 7365 6c66 2e6e 5f73 7065 6369 616c  [{self.n_special
+00031000: 5f64 696d 7d5d 2b22 2069 6620 7365 6c66  _dim}]+" if self
+00031010: 2e6e 5f73 7065 6369 616c 5f64 696d 203e  .n_special_dim >
+00031020: 2030 2065 6c73 6520 2727 0a20 2020 2020   0 else ''.     
+00031030: 2020 2064 6576 6963 655f 7374 7220 3d20     device_str = 
+00031040: 2763 7075 2720 6966 2073 656c 662e 6465  'cpu' if self.de
+00031050: 7669 6365 2e74 7970 6520 3d3d 2027 6370  vice.type == 'cp
+00031060: 7527 2065 6c73 6520 6622 7b73 656c 662e  u' else f"{self.
+00031070: 6465 7669 6365 2e74 7970 657d 3a7b 7365  device.type}:{se
+00031080: 6c66 2e64 6576 6963 652e 696e 6465 787d  lf.device.index}
+00031090: 220a 2020 2020 2020 2020 7261 775f 7368  ".        raw_sh
+000310a0: 6170 655f 7374 7220 3d20 7374 7228 7365  ape_str = str(se
+000310b0: 6c66 2e73 6861 7065 292e 7370 6c69 7428  lf.shape).split(
+000310c0: 2753 697a 6527 295b 2d31 5d0a 2020 2020  'Size')[-1].    
+000310d0: 2020 2020 7661 6c69 645f 6e75 6d73 203d      valid_nums =
+000310e0: 2073 656c 662e 666c 6174 7465 6e28 290a   self.flatten().
+000310f0: 2020 2020 2020 2020 7661 6c69 645f 6e75          valid_nu
+00031100: 6d73 203d 2076 616c 6964 5f6e 756d 735b  ms = valid_nums[
+00031110: 7e69 736e 616e 2876 616c 6964 5f6e 756d  ~isnan(valid_num
+00031120: 7329 5d0a 2020 2020 2020 2020 7661 6c69  s)].        vali
+00031130: 645f 6e75 6d73 203d 2076 616c 6964 5f6e  d_nums = valid_n
+00031140: 756d 735b 7e69 7369 6e66 2876 616c 6964  ums[~isinf(valid
+00031150: 5f6e 756d 7329 5d0a 2020 2020 2020 2020  _nums)].        
+00031160: 6966 2076 616c 6964 5f6e 756d 732e 6e5f  if valid_nums.n_
+00031170: 656c 6520 3d3d 2030 3a0a 2020 2020 2020  ele == 0:.      
+00031180: 2020 2020 2020 7661 6c69 645f 7661 6c5f        valid_val_
+00031190: 7374 7220 3d20 276e 6f74 6869 6e67 270a  str = 'nothing'.
+000311a0: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
+000311b0: 662e 6973 5f63 6f6d 706c 6578 2829 3a0a  f.is_complex():.
+000311c0: 2020 2020 2020 2020 2020 2020 7661 6c69              vali
+000311d0: 645f 7661 6c5f 7374 7220 3d20 6622 5265  d_val_str = f"Re
+000311e0: 286d 696e 3a7b 7661 6c69 645f 6e75 6d73  (min:{valid_nums
+000311f0: 2e72 6561 6c2e 6d69 6e28 297d 2c20 6d65  .real.min()}, me
+00031200: 643a 7b76 616c 6964 5f6e 756d 732e 7265  d:{valid_nums.re
+00031210: 616c 2e6d 6564 6961 6e28 297d 2c20 6d61  al.median()}, ma
+00031220: 783a 7b76 616c 6964 5f6e 756d 732e 7265  x:{valid_nums.re
+00031230: 616c 2e6d 6178 2829 7d29 2c20 220a 2020  al.max()}), ".  
+00031240: 2020 2020 2020 2020 2020 7661 6c69 645f            valid_
+00031250: 7661 6c5f 7374 7220 2b3d 2066 2249 6d28  val_str += f"Im(
+00031260: 6d69 6e3a 7b76 616c 6964 5f6e 756d 732e  min:{valid_nums.
+00031270: 696d 6167 2e6d 696e 2829 7d2c 206d 6564  imag.min()}, med
+00031280: 3a7b 7661 6c69 645f 6e75 6d73 2e69 6d61  :{valid_nums.ima
+00031290: 672e 6d65 6469 616e 2829 7d2c 206d 6178  g.median()}, max
+000312a0: 3a7b 7661 6c69 645f 6e75 6d73 2e69 6d61  :{valid_nums.ima
+000312b0: 672e 6d61 7828 297d 2922 0a20 2020 2020  g.max()})".     
+000312c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000312d0: 2020 2020 2076 616c 6964 5f76 616c 5f73       valid_val_s
+000312e0: 7472 203d 2066 226d 696e 3a7b 7661 6c69  tr = f"min:{vali
+000312f0: 645f 6e75 6d73 2e6d 696e 2829 7d2c 206d  d_nums.min()}, m
+00031300: 6564 3a7b 7661 6c69 645f 6e75 6d73 2e6d  ed:{valid_nums.m
+00031310: 6564 6961 6e28 297d 2c20 6d61 783a 7b76  edian()}, max:{v
+00031320: 616c 6964 5f6e 756d 732e 6d61 7828 297d  alid_nums.max()}
+00031330: 220a 2020 2020 2020 2020 6e61 6e5f 7374  ".        nan_st
+00031340: 7220 3d20 2727 3b20 696e 665f 7374 7220  r = ''; inf_str 
+00031350: 3d20 2727 0a20 2020 2020 2020 2069 6620  = ''.        if 
+00031360: 6e75 6d5f 6e61 6e73 203e 2030 3a20 6e61  num_nans > 0: na
+00031370: 6e5f 7374 7220 3d20 6622 7b6e 756d 5f6e  n_str = f"{num_n
+00031380: 616e 737d 204e 614e 220a 2020 2020 2020  ans} NaN".      
+00031390: 2020 6966 206e 756d 5f6e 616e 7320 3e20    if num_nans > 
+000313a0: 313a 206e 616e 5f73 7472 202b 3d20 2773  1: nan_str += 's
+000313b0: 270a 2020 2020 2020 2020 6966 206e 756d  '.        if num
+000313c0: 5f69 6e66 7320 3e20 303a 2069 6e66 5f73  _infs > 0: inf_s
+000313d0: 7472 203d 2066 227b 6e75 6d5f 696e 6673  tr = f"{num_infs
+000313e0: 7d20 496e 6622 0a20 2020 2020 2020 2069  } Inf".        i
+000313f0: 6620 6e75 6d5f 696e 6673 203e 2031 3a20  f num_infs > 1: 
+00031400: 696e 665f 7374 7220 2b3d 2027 7327 0a20  inf_str += 's'. 
+00031410: 2020 2020 2020 2065 7272 6f72 5f76 616c         error_val
+00031420: 5f73 7472 203d 2027 2c20 272e 6a6f 696e  _str = ', '.join
+00031430: 285b 7820 666f 7220 7820 696e 2028 6e61  ([x for x in (na
+00031440: 6e5f 7374 722c 2069 6e66 5f73 7472 2920  n_str, inf_str) 
+00031450: 6966 2078 5d29 0a20 2020 2020 2020 2069  if x]).        i
+00031460: 6620 6e75 6d5f 6e61 6e73 202b 206e 756d  f num_nans + num
+00031470: 5f69 6e66 7320 3d3d 2030 3a20 7661 6c5f  _infs == 0: val_
+00031480: 7261 6e67 655f 7374 7220 3d20 7661 6c69  range_str = vali
+00031490: 645f 7661 6c5f 7374 720a 2020 2020 2020  d_val_str.      
+000314a0: 2020 656c 6966 2028 6e75 6d5f 6e61 6e73    elif (num_nans
+000314b0: 202b 206e 756d 5f69 6e66 7329 202f 2073   + num_infs) / s
+000314c0: 656c 662e 6e5f 656c 6520 3c20 302e 353a  elf.n_ele < 0.5:
+000314d0: 2076 616c 5f72 616e 6765 5f73 7472 203d   val_range_str =
+000314e0: 2066 227b 7661 6c69 645f 7661 6c5f 7374   f"{valid_val_st
+000314f0: 727d 2c20 7b65 7272 6f72 5f76 616c 5f73  r}, {error_val_s
+00031500: 7472 7d22 0a20 2020 2020 2020 2065 6c73  tr}".        els
+00031510: 653a 2076 616c 5f72 616e 6765 5f73 7472  e: val_range_str
+00031520: 203d 2065 7272 6f72 5f76 616c 5f73 7472   = error_val_str
+00031530: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00031540: 6622 3c7b 7370 6563 6961 6c5f 6469 6d5f  f"<{special_dim_
+00031550: 7374 727d 7b73 656c 662e 6e5f 7370 6163  str}{self.n_spac
+00031560: 655f 6469 6d7d 4420 7b73 7472 2873 656c  e_dim}D {str(sel
+00031570: 662e 6474 7970 6529 2e73 706c 6974 2827  f.dtype).split('
+00031580: 2e27 295b 2d31 5d7d 2054 656e 736f 7220  .')[-1]} Tensor 
+00031590: 6f6e 207b 6465 7669 6365 5f73 7472 7d3a  on {device_str}:
+000315a0: 2073 6861 7065 3d7b 7261 775f 7368 6170   shape={raw_shap
+000315b0: 655f 7374 727d 2c20 7265 7175 6972 6573  e_str}, requires
+000315c0: 5f67 7261 643d 7b73 656c 662e 7265 7175  _grad={self.requ
+000315d0: 6972 6573 5f67 7261 647d 2c20 7661 6c3d  ires_grad}, val=
+000315e0: 5b7b 7661 6c5f 7261 6e67 655f 7374 727d  [{val_range_str}
+000315f0: 5d3e 220a 2020 2020 0a20 2020 2023 2320  ]>".    .    ## 
+00031600: 4f74 6865 7220 7574 696c 6974 6965 730a  Other utilities.
+00031610: 2020 2020 6465 6620 6279 7465 5f73 697a      def byte_siz
+00031620: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+00031630: 2072 6574 7572 6e20 4279 7465 5369 7a65   return ByteSize
+00031640: 2873 656c 662e 656c 656d 656e 745f 7369  (self.element_si
+00031650: 7a65 2829 202a 2073 656c 662e 6e75 6d65  ze() * self.nume
+00031660: 6c28 2929 0a0a 2020 2020 6465 6620 7265  l())..    def re
+00031670: 6e61 6d65 2873 656c 662c 202a 6172 6773  name(self, *args
+00031680: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00031690: 2020 2020 2077 6974 6820 746f 7263 682e       with torch.
+000316a0: 5f43 2e44 6973 6162 6c65 546f 7263 6846  _C.DisableTorchF
+000316b0: 756e 6374 696f 6e28 293a 0a20 2020 2020  unction():.     
+000316c0: 2020 2020 2020 206f 7574 7075 7420 3d20         output = 
+000316d0: 746f 7263 685f 7375 7065 7228 7365 6c66  torch_super(self
+000316e0: 2c20 2772 656e 616d 6527 2928 2a61 7267  , 'rename')(*arg
+000316f0: 732c 202a 2a6b 7761 7267 7329 2e61 735f  s, **kwargs).as_
+00031700: 7375 6263 6c61 7373 2854 656e 736f 7229  subclass(Tensor)
+00031710: 2e73 7065 6369 616c 5f66 726f 6d28 7365  .special_from(se
+00031720: 6c66 290a 2020 2020 2020 2020 666f 7220  lf).        for 
+00031730: 692c 206e 2069 6e20 656e 756d 6572 6174  i, n in enumerat
+00031740: 6528 6f75 7470 7574 2e6e 616d 6573 293a  e(output.names):
+00031750: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00031760: 6e20 6973 204e 6f6e 653a 2063 6f6e 7469  n is None: conti
+00031770: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
+00031780: 6966 2027 6675 6e63 2720 696e 206e 2e6c  if 'func' in n.l
+00031790: 6f77 6572 2829 3a20 6f75 7470 7574 2e61  ower(): output.a
+000317a0: 6464 5f73 7065 6369 616c 5f64 696d 2869  dd_special_dim(i
+000317b0: 2c20 6675 6e63 5f64 696d 290a 2020 2020  , func_dim).    
+000317c0: 2020 2020 2020 2020 6966 2027 6261 7463          if 'batc
+000317d0: 6827 2069 6e20 6e2e 6c6f 7765 7228 293a  h' in n.lower():
+000317e0: 206f 7574 7075 742e 6164 645f 7370 6563   output.add_spec
+000317f0: 6961 6c5f 6469 6d28 692c 207b 7d29 0a20  ial_dim(i, {}). 
+00031800: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00031810: 2763 6861 6e6e 656c 2720 696e 206e 2e6c  'channel' in n.l
+00031820: 6f77 6572 2829 206f 7220 2766 6561 7475  ower() or 'featu
+00031830: 7265 2720 696e 206e 2e6c 6f77 6572 2829  re' in n.lower()
+00031840: 3a20 6f75 7470 7574 2e61 6464 5f73 7065  : output.add_spe
+00031850: 6369 616c 5f64 696d 2869 2c20 5b5d 290a  cial_dim(i, []).
+00031860: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00031870: 2027 7469 6d65 2720 696e 206e 2e6c 6f77   'time' in n.low
+00031880: 6572 2829 206f 7220 2773 6572 6965 7327  er() or 'series'
+00031890: 2069 6e20 6e2e 6c6f 7765 7228 2920 6f72   in n.lower() or
+000318a0: 2027 7365 7175 656e 6365 2720 696e 206e   'sequence' in n
+000318b0: 2e6c 6f77 6572 2829 3a20 6f75 7470 7574  .lower(): output
+000318c0: 2e61 6464 5f73 7065 6369 616c 5f64 696d  .add_special_dim
+000318d0: 2869 2c20 2727 290a 2020 2020 2020 2020  (i, '').        
+000318e0: 7265 7475 726e 206f 7574 7075 742e 6772  return output.gr
+000318f0: 6164 5f66 6e5f 6e61 6d65 5f28 2772 656e  ad_fn_name_('ren
+00031900: 616d 6527 290a 0a20 2020 2064 6566 2072  ame')..    def r
+00031910: 6566 696e 655f 6e61 6d65 7328 7365 6c66  efine_names(self
+00031920: 2c20 2a61 7267 7329 3a0a 2020 2020 2020  , *args):.      
+00031930: 2020 7769 7468 2074 6f72 6368 2e5f 432e    with torch._C.
+00031940: 4469 7361 626c 6554 6f72 6368 4675 6e63  DisableTorchFunc
+00031950: 7469 6f6e 2829 3a0a 2020 2020 2020 2020  tion():.        
+00031960: 2020 2020 6f75 7470 7574 203d 2074 6f72      output = tor
+00031970: 6368 5f73 7570 6572 2873 656c 662c 2027  ch_super(self, '
+00031980: 7265 6669 6e65 5f6e 616d 6573 2729 282a  refine_names')(*
+00031990: 6172 6773 292e 6173 5f73 7562 636c 6173  args).as_subclas
+000319a0: 7328 5465 6e73 6f72 292e 7370 6563 6961  s(Tensor).specia
+000319b0: 6c5f 6672 6f6d 2873 656c 6629 0a20 2020  l_from(self).   
+000319c0: 2020 2020 2066 6f72 2069 2c20 6e20 696e       for i, n in
+000319d0: 2065 6e75 6d65 7261 7465 286f 7574 7075   enumerate(outpu
+000319e0: 742e 6e61 6d65 7329 3a0a 2020 2020 2020  t.names):.      
+000319f0: 2020 2020 2020 6966 206e 2069 7320 4e6f        if n is No
+00031a00: 6e65 3a20 636f 6e74 696e 7565 0a20 2020  ne: continue.   
+00031a10: 2020 2020 2020 2020 2069 6620 2766 756e           if 'fun
+00031a20: 6327 2069 6e20 6e2e 6c6f 7765 7228 293a  c' in n.lower():
+00031a30: 206f 7574 7075 742e 6164 645f 7370 6563   output.add_spec
+00031a40: 6961 6c5f 6469 6d28 692c 2066 756e 635f  ial_dim(i, func_
+00031a50: 6469 6d29 0a20 2020 2020 2020 2020 2020  dim).           
+00031a60: 2069 6620 2762 6174 6368 2720 696e 206e   if 'batch' in n
+00031a70: 2e6c 6f77 6572 2829 3a20 6f75 7470 7574  .lower(): output
+00031a80: 2e61 6464 5f73 7065 6369 616c 5f64 696d  .add_special_dim
+00031a90: 2869 2c20 7b7d 290a 2020 2020 2020 2020  (i, {}).        
+00031aa0: 2020 2020 656c 6966 2027 6368 616e 6e65      elif 'channe
+00031ab0: 6c27 2069 6e20 6e2e 6c6f 7765 7228 2920  l' in n.lower() 
+00031ac0: 6f72 2027 6665 6174 7572 6527 2069 6e20  or 'feature' in 
+00031ad0: 6e2e 6c6f 7765 7228 293a 206f 7574 7075  n.lower(): outpu
+00031ae0: 742e 6164 645f 7370 6563 6961 6c5f 6469  t.add_special_di
+00031af0: 6d28 692c 205b 5d29 0a20 2020 2020 2020  m(i, []).       
+00031b00: 2020 2020 2065 6c69 6620 2774 696d 6527       elif 'time'
+00031b10: 2069 6e20 6e2e 6c6f 7765 7228 2920 6f72   in n.lower() or
+00031b20: 2027 7365 7269 6573 2720 696e 206e 2e6c   'series' in n.l
+00031b30: 6f77 6572 2829 206f 7220 2773 6571 7565  ower() or 'seque
+00031b40: 6e63 6527 2069 6e20 6e2e 6c6f 7765 7228  nce' in n.lower(
+00031b50: 293a 206f 7574 7075 742e 6164 645f 7370  ): output.add_sp
+00031b60: 6563 6961 6c5f 6469 6d28 692c 2027 2729  ecial_dim(i, '')
+00031b70: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00031b80: 6f75 7470 7574 2e75 7064 6174 655f 7370  output.update_sp
+00031b90: 6563 6961 6c5f 6672 6f6d 2873 656c 6629  ecial_from(self)
+00031ba0: 0a0a 2020 2020 6465 6620 6e6f 726d 616c  ..    def normal
+00031bb0: 697a 655f 2873 656c 6629 3a0a 2020 2020  ize_(self):.    
+00031bc0: 2020 2020 6d2c 204d 203d 2073 656c 662e      m, M = self.
+00031bd0: 6d69 6e28 292c 2073 656c 662e 6d61 7828  min(), self.max(
+00031be0: 290a 2020 2020 2020 2020 6966 206d 203d  ).        if m =
+00031bf0: 3d20 4d3a 0a20 2020 2020 2020 2020 2020  = M:.           
+00031c00: 2069 6620 4d20 3e3d 2031 3a20 7265 7475   if M >= 1: retu
+00031c10: 726e 2073 656c 662e 7a65 726f 5f28 292e  rn self.zero_().
+00031c20: 6164 645f 2831 290a 2020 2020 2020 2020  add_(1).        
+00031c30: 2020 2020 6966 206d 203c 3d20 303a 2072      if m <= 0: r
+00031c40: 6574 7572 6e20 7365 6c66 2e7a 6572 6f5f  eturn self.zero_
+00031c50: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
+00031c60: 6574 7572 6e20 7365 6c66 0a20 2020 2020  eturn self.     
+00031c70: 2020 2073 656c 662e 7375 625f 286d 290a     self.sub_(m).
+00031c80: 2020 2020 2020 2020 7365 6c66 2e64 6976          self.div
+00031c90: 5f28 4d2d 6d29 0a20 2020 2020 2020 2072  _(M-m).        r
+00031ca0: 6574 7572 6e20 7365 6c66 2e67 7261 645f  eturn self.grad_
+00031cb0: 666e 5f6e 616d 655f 2827 6e6f 726d 616c  fn_name_('normal
+00031cc0: 697a 655f 2729 0a0a 2020 2020 6465 6620  ize_')..    def 
+00031cd0: 6e6f 726d 616c 697a 6528 7365 6c66 293a  normalize(self):
+00031ce0: 0a20 2020 2020 2020 206d 2c20 4d20 3d20  .        m, M = 
+00031cf0: 7365 6c66 2e6d 696e 2829 2c20 7365 6c66  self.min(), self
+00031d00: 2e6d 6178 2829 0a20 2020 2020 2020 2069  .max().        i
+00031d10: 6620 6d20 3d3d 204d 3a0a 2020 2020 2020  f m == M:.      
+00031d20: 2020 2020 2020 6966 204d 203e 3d20 313a        if M >= 1:
+00031d30: 2072 6574 7572 6e20 6f6e 6573 5f6c 696b   return ones_lik
+00031d40: 6528 7365 6c66 290a 2020 2020 2020 2020  e(self).        
+00031d50: 2020 2020 6966 206d 203c 3d20 303a 2072      if m <= 0: r
+00031d60: 6574 7572 6e20 7a65 726f 735f 6c69 6b65  eturn zeros_like
+00031d70: 2873 656c 6629 0a20 2020 2020 2020 2020  (self).         
+00031d80: 2020 2072 6574 7572 6e20 7365 6c66 0a20     return self. 
+00031d90: 2020 2020 2020 2072 6574 7572 6e20 2828         return ((
+00031da0: 7365 6c66 202d 206d 2920 2f20 284d 202d  self - m) / (M -
+00031db0: 206d 2929 2e67 7261 645f 666e 5f6e 616d   m)).grad_fn_nam
+00031dc0: 655f 2827 6e6f 726d 616c 697a 6527 290a  e_('normalize').
+00031dd0: 0a20 2020 2040 616c 6961 7328 2765 7874  .    @alias('ext
+00031de0: 656e 6427 290a 2020 2020 6465 6620 6170  end').    def ap
+00031df0: 7065 6e64 2873 656c 662c 2076 616c 7565  pend(self, value
+00031e00: 293a 0a20 2020 2020 2020 2061 766f 7563  ):.        avouc
+00031e10: 6828 7365 6c66 2e6e 5f64 696d 203d 3d20  h(self.n_dim == 
+00031e20: 312c 2022 4f6e 6c79 2031 2d64 696d 656e  1, "Only 1-dimen
+00031e30: 7369 6f6e 616c 2074 656e 736f 7220 6361  sional tensor ca
+00031e40: 6e20 7573 6520 2761 7070 656e 6427 2074  n use 'append' t
+00031e50: 6f20 636f 6e63 6174 2e20 2229 0a20 2020  o concat. ").   
+00031e60: 2020 2020 2074 656e 736f 725f 7661 6c75       tensor_valu
+00031e70: 6520 3d20 7465 6e73 6f72 2876 616c 7565  e = tensor(value
+00031e80: 2c20 6465 7669 6365 3d73 656c 662e 6465  , device=self.de
+00031e90: 7669 6365 2c20 6474 7970 653d 7365 6c66  vice, dtype=self
+00031ea0: 2e64 7479 7065 2920 6966 206e 6f74 2069  .dtype) if not i
+00031eb0: 7369 6e73 7461 6e63 6528 7661 6c75 652c  sinstance(value,
+00031ec0: 2074 6f72 6368 2e54 656e 736f 7229 2065   torch.Tensor) e
+00031ed0: 6c73 6520 2876 616c 7565 2e61 735f 7375  lse (value.as_su
+00031ee0: 6263 6c61 7373 2854 656e 736f 722c 2064  bclass(Tensor, d
+00031ef0: 6576 6963 653d 7365 6c66 2e64 6576 6963  evice=self.devic
+00031f00: 652c 2064 7479 7065 3d73 656c 662e 6474  e, dtype=self.dt
+00031f10: 7970 6529 2069 6620 6e6f 7420 6973 696e  ype) if not isin
+00031f20: 7374 616e 6365 2876 616c 7565 2c20 5465  stance(value, Te
+00031f30: 6e73 6f72 2920 656c 7365 2076 616c 7565  nsor) else value
+00031f40: 290a 2020 2020 2020 2020 6176 6f75 6368  ).        avouch
+00031f50: 2874 656e 736f 725f 7661 6c75 652e 6e5f  (tensor_value.n_
+00031f60: 6469 6d20 3c3d 2031 2c20 224f 6e6c 7920  dim <= 1, "Only 
+00031f70: 7363 616c 6172 206f 7220 312d 6469 6d65  scalar or 1-dime
+00031f80: 6e73 696f 6e61 6c20 7465 6e73 6f72 7320  nsional tensors 
+00031f90: 6361 6e20 6279 2063 6f6e 6361 7420 7573  can by concat us
+00031fa0: 696e 6720 6170 7065 6e64 2f65 7874 656e  ing append/exten
+00031fb0: 642e 2022 290a 2020 2020 2020 2020 7265  d. ").        re
+00031fc0: 7475 726e 2063 6174 2873 656c 662c 2074  turn cat(self, t
+00031fd0: 656e 736f 725f 7661 6c75 652c 2064 696d  ensor_value, dim
+00031fe0: 3d30 292e 6772 6164 5f66 6e5f 6e61 6d65  =0).grad_fn_name
+00031ff0: 5f28 2761 7070 656e 6427 290a 2020 2020  _('append').    
+00032000: 0a20 2020 2064 6566 2073 6574 6974 656d  .    def setitem
+00032010: 5f28 7365 6c66 2c20 696e 642c 2076 616c  _(self, ind, val
+00032020: 293a 0a20 2020 2020 2020 2073 656c 665b  ):.        self[
+00032030: 696e 645d 203d 2076 616c 0a20 2020 2020  ind] = val.     
+00032040: 2020 2072 6574 7572 6e20 7365 6c66 2e67     return self.g
+00032050: 7261 645f 666e 5f6e 616d 655f 2827 7365  rad_fn_name_('se
+00032060: 7469 7465 6d5f 2729 0a20 2020 200a 2020  titem_').    .  
+00032070: 2020 6465 6620 6772 6164 5f66 6e5f 6e61    def grad_fn_na
+00032080: 6d65 5f28 7365 6c66 2c20 6e61 6d65 293a  me_(self, name):
+00032090: 0a20 2020 2020 2020 2073 656c 662e 6772  .        self.gr
+000320a0: 6164 5f66 6e5f 6e61 6d65 203d 206e 616d  ad_fn_name = nam
+000320b0: 650a 2020 2020 2020 2020 7265 7475 726e  e.        return
+000320c0: 2073 656c 660a 2020 2020 0a20 2020 2064   self.    .    d
+000320d0: 6566 2063 6174 2873 656c 662c 202a 6f74  ef cat(self, *ot
+000320e0: 6865 722c 2064 696d 3d30 293a 0a20 2020  her, dim=0):.   
+000320f0: 2020 2020 2072 6574 7572 6e20 6361 7428       return cat(
+00032100: 7365 6c66 2c20 2a6f 7468 6572 2c20 6469  self, *other, di
+00032110: 6d3d 6469 6d29 2e67 7261 645f 666e 5f6e  m=dim).grad_fn_n
+00032120: 616d 655f 2827 6361 7427 290a 0a20 2020  ame_('cat')..   
+00032130: 2064 6566 2073 7461 636b 2873 656c 662c   def stack(self,
+00032140: 202a 6f74 6865 722c 2064 696d 3d30 293a   *other, dim=0):
+00032150: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00032160: 7374 6163 6b28 7365 6c66 2c20 2a6f 7468  stack(self, *oth
+00032170: 6572 2c20 6469 6d3d 6469 6d29 2e67 7261  er, dim=dim).gra
+00032180: 645f 666e 5f6e 616d 655f 2827 7374 6163  d_fn_name_('stac
+00032190: 6b27 290a 2020 2020 0a20 2020 2023 2320  k').    .    ## 
+000321a0: 6474 7970 6573 0a20 2020 2040 616c 6961  dtypes.    @alia
+000321b0: 7328 2261 735f 7479 7065 2229 0a20 2020  s("as_type").   
+000321c0: 2064 6566 2061 7374 7970 6528 7365 6c66   def astype(self
+000321d0: 2c20 6474 293a 0a20 2020 2020 2020 2022  , dt):.        "
+000321e0: 2222 0a20 2020 2020 2020 2020 2020 206e  "".            n
+000321f0: 756d 7079 2064 7479 7065 2076 2e73 2e20  umpy dtype v.s. 
+00032200: 746f 7263 6820 6474 7970 653a 0a20 2020  torch dtype:.   
+00032210: 2020 2020 2020 2020 203d 3d3d 3d3d 3d3d           =======
+00032220: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00032230: 3d3d 3d3d 3d3d 3d0a 2020 2020 2020 2020  =======.        
+00032240: 2020 2020 6e75 6d70 7920 7479 7065 202f      numpy type /
+00032250: 2f20 746f 7263 6820 7479 7065 0a20 2020  / torch type.   
+00032260: 2020 2020 2020 2020 202d 2d2d 2d2d 2d2d           -------
+00032270: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00032280: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00032290: 2020 2020 766f 6964 302c 2076 6f69 643a      void0, void:
+000322a0: 3a76 6f69 6420 2f2f 200a 2020 2020 2020  :void // .      
+000322b0: 2020 2020 2020 6f62 6a65 6374 302c 206f        object0, o
+000322c0: 626a 6563 745f 3a3a 6f62 6a65 6374 202f  bject_::object /
+000322d0: 2f20 0a20 2020 2020 2020 2020 2020 2062  / .            b
+000322e0: 6f6f 6c38 2c20 626f 6f6c 5f3a 3a62 6f6f  ool8, bool_::boo
+000322f0: 6c20 2f2f 2074 6f72 6368 2e62 6f6f 6c0a  l // torch.bool.
+00032300: 2020 2020 2020 2020 2020 2020 6279 7465              byte
+00032310: 2c20 696e 7438 3a3a 696e 7438 202f 2f20  , int8::int8 // 
+00032320: 746f 7263 682e 696e 7438 0a20 2020 2020  torch.int8.     
+00032330: 2020 2020 2020 2073 686f 7274 2c20 696e         short, in
+00032340: 7431 363a 3a69 6e74 3136 202f 2f20 746f  t16::int16 // to
+00032350: 7263 682e 7368 6f72 742c 2074 6f72 6368  rch.short, torch
+00032360: 2e69 6e74 3136 0a20 2020 2020 2020 2020  .int16.         
+00032370: 2020 2069 6e74 3332 2c20 696e 7463 3a3a     int32, intc::
+00032380: 696e 7433 3220 2f2f 2074 6f72 6368 2e69  int32 // torch.i
+00032390: 6e74 2c20 746f 7263 682e 696e 7433 320a  nt, torch.int32.
+000323a0: 2020 2020 2020 2020 2020 2020 696e 7430              int0
+000323b0: 2c20 696e 745f 2c20 696e 7436 342c 2069  , int_, int64, i
+000323c0: 6e74 702c 206c 6f6e 676c 6f6e 672c 2073  ntp, longlong, s
+000323d0: 6967 6e65 6469 6e74 6567 6572 3a3a 696e  ignedinteger::in
+000323e0: 7436 3420 2f2f 2074 6f72 6368 2e6c 6f6e  t64 // torch.lon
+000323f0: 672c 2074 6f72 6368 2e69 6e74 3634 0a20  g, torch.int64. 
+00032400: 2020 2020 2020 2020 2020 2075 6279 7465             ubyte
+00032410: 2c20 7569 6e74 383a 3a75 696e 7438 202f  , uint8::uint8 /
+00032420: 2f20 746f 7263 682e 7569 6e74 380a 2020  / torch.uint8.  
+00032430: 2020 2020 2020 2020 2020 7573 686f 7274            ushort
+00032440: 2c20 7569 6e74 3136 3a3a 7569 6e74 3136  , uint16::uint16
+00032450: 202f 2f20 0a20 2020 2020 2020 2020 2020   // .           
+00032460: 2075 696e 7433 322c 2075 696e 7463 3a3a   uint32, uintc::
+00032470: 7569 6e74 3332 202f 2f20 0a20 2020 2020  uint32 // .     
+00032480: 2020 2020 2020 2075 696e 742c 2075 696e         uint, uin
+00032490: 7430 2c20 7569 6e74 3634 2c20 5569 6e74  t0, uint64, Uint
+000324a0: 3634 2c20 7569 6e74 702c 2075 6c6f 6e67  64, uintp, ulong
+000324b0: 6c6f 6e67 3a3a 7569 6e74 3634 202f 2f20  long::uint64 // 
+000324c0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+000324d0: 746f 7263 682e 6266 6c6f 6174 3136 2023  torch.bfloat16 #
+000324e0: 2031 3662 6974 2c20 e88c 83e5 9bb4 e5a4   16bit, ........
+000324f0: a7e5 a682 3332 6269 74e4 bd86 e7b2 bee5  ....32bit.......
+00032500: baa6 e4bd 8e0a 2020 2020 2020 2020 2020  ......          
+00032510: 2020 6861 6c66 2c20 666c 6f61 7431 363a    half, float16:
+00032520: 3a66 6c6f 6174 3136 202f 2f20 746f 7263  :float16 // torc
+00032530: 682e 6861 6c66 2c20 746f 7263 682e 666c  h.half, torch.fl
+00032540: 6f61 7431 360a 2020 2020 2020 2020 2020  oat16.          
+00032550: 2020 7369 6e67 6c65 2c20 666c 6f61 7433    single, float3
+00032560: 323a 3a66 6c6f 6174 3332 202f 2f20 746f  2::float32 // to
+00032570: 7263 682e 666c 6f61 742c 2074 6f72 6368  rch.float, torch
+00032580: 2e66 6c6f 6174 3332 0a20 2020 2020 2020  .float32.       
+00032590: 2020 2020 2064 6f75 626c 652c 2066 6c6f       double, flo
+000325a0: 6174 3634 2c20 666c 6f61 745f 2c20 6c6f  at64, float_, lo
+000325b0: 6e67 646f 7562 6c65 2c20 6c6f 6e67 666c  ngdouble, longfl
+000325c0: 6f61 742c 206e 756d 6265 723a 3a66 6c6f  oat, number::flo
+000325d0: 6174 3634 202f 2f20 746f 7263 682e 646f  at64 // torch.do
+000325e0: 7562 6c65 2c20 746f 7263 682e 666c 6f61  uble, torch.floa
+000325f0: 7436 340a 2020 2020 2020 2020 2020 2020  t64.            
+00032600: 2f2f 2074 6f72 6368 2e63 6f6d 706c 6578  // torch.complex
+00032610: 3332 0a20 2020 2020 2020 2020 2020 2063  32.            c
+00032620: 7369 6e67 6c65 2c20 636f 6d70 6c65 7836  single, complex6
+00032630: 342c 2073 696e 676c 6563 6f6d 706c 6578  4, singlecomplex
+00032640: 3a3a 636f 6d70 6c65 7836 3420 2f2f 2074  ::complex64 // t
+00032650: 6f72 6368 2e63 666c 6f61 742c 2074 6f72  orch.cfloat, tor
+00032660: 6368 2e63 6f6d 706c 6578 3634 0a20 2020  ch.complex64.   
+00032670: 2020 2020 2020 2020 2063 646f 7562 6c65           cdouble
+00032680: 2c20 6366 6c6f 6174 2c20 636c 6f6e 6764  , cfloat, clongd
+00032690: 6f75 626c 652c 2063 6c6f 6e67 666c 6f61  ouble, clongfloa
+000326a0: 742c 2063 6f6d 706c 6578 5f2c 2063 6f6d  t, complex_, com
+000326b0: 706c 6578 3132 382c 206c 6f6e 6763 6f6d  plex128, longcom
+000326c0: 706c 6578 3a3a 636f 6d70 6c65 7831 3238  plex::complex128
+000326d0: 202f 2f20 746f 7263 682e 6364 6f75 626c   // torch.cdoubl
+000326e0: 652c 2074 6f72 6368 2e63 6f6d 706c 6578  e, torch.complex
+000326f0: 3132 380a 2020 2020 2020 2020 2020 2020  128.            
+00032700: 7374 7230 2c20 7374 725f 2c20 5374 7230  str0, str_, Str0
+00032710: 3a3a 7374 7220 2f2f 200a 2020 2020 2020  ::str // .      
+00032720: 2020 2020 2020 6279 7465 7330 2c20 6279        bytes0, by
+00032730: 7465 735f 2c20 7374 7269 6e67 5f3a 3a62  tes_, string_::b
+00032740: 7974 6573 202f 2f20 0a20 2020 2020 2020  ytes // .       
+00032750: 2020 2020 2064 6174 6574 696d 6536 343a       datetime64:
+00032760: 3a64 6174 6574 696d 6536 3420 2f2f 200a  :datetime64 // .
+00032770: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+00032780: 6465 6c74 6136 343a 3a74 696d 6564 656c  delta64::timedel
+00032790: 7461 3634 202f 2f20 0a20 2020 2020 2020  ta64 // .       
+000327a0: 2020 2020 2023 20e9 878f e5ad 90e8 aea1       # .........
+000327b0: e7ae 97e7 b1bb e59e 8b0a 2020 2020 2020  ..........      
+000327c0: 2020 2020 2020 2f2f 2074 6f72 6368 2e71        // torch.q
+000327d0: 696e 7438 0a20 2020 2020 2020 2020 2020  int8.           
+000327e0: 202f 2f20 746f 7263 682e 7169 6e74 3332   // torch.qint32
+000327f0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+00032800: 746f 7263 682e 7175 696e 7438 0a20 2020  torch.quint8.   
+00032810: 2020 2020 2020 2020 202f 2f20 746f 7263           // torc
+00032820: 682e 7175 696e 7434 7832 0a20 2020 2020  h.quint4x2.     
+00032830: 2020 2022 2222 0a20 2020 2020 2020 2074     """.        t
+00032840: 6f72 6368 5f64 7420 3d20 746f 5f74 6f72  orch_dt = to_tor
+00032850: 6368 5f64 7479 7065 2864 7429 0a20 2020  ch_dtype(dt).   
+00032860: 2020 2020 2077 6974 6820 746f 7263 682e       with torch.
+00032870: 5f43 2e44 6973 6162 6c65 546f 7263 6846  _C.DisableTorchF
+00032880: 756e 6374 696f 6e28 293a 0a20 2020 2020  unction():.     
+00032890: 2020 2020 2020 2072 6574 7572 6e20 746f         return to
+000328a0: 7263 685f 7375 7065 7228 7365 6c66 2c20  rch_super(self, 
+000328b0: 2774 7970 6527 2928 746f 7263 685f 6474  'type')(torch_dt
+000328c0: 292e 6173 5f73 7562 636c 6173 7328 5465  ).as_subclass(Te
+000328d0: 6e73 6f72 292e 7370 6563 6961 6c5f 6672  nsor).special_fr
+000328e0: 6f6d 2873 656c 6629 2e67 7261 645f 666e  om(self).grad_fn
+000328f0: 5f6e 616d 655f 2827 6173 7479 7065 2729  _name_('astype')
+00032900: 0a20 2020 2020 2020 2023 2069 6620 6973  .        # if is
+00032910: 696e 7374 616e 6365 2864 742c 2073 7472  instance(dt, str
+00032920: 293a 2072 6574 7572 6e20 7375 7065 7228  ): return super(
+00032930: 292e 7479 7065 2864 742e 7265 706c 6163  ).type(dt.replac
+00032940: 6528 2762 742e 272c 2027 746f 7263 682e  e('bt.', 'torch.
+00032950: 2729 292e 6173 5f73 7562 636c 6173 7328  ')).as_subclass(
+00032960: 7365 6c66 2e5f 5f63 6c61 7373 5f5f 290a  self.__class__).
+00032970: 2020 2020 2020 2020 2320 6966 2068 6173          # if has
+00032980: 6174 7472 2864 742c 2027 6474 7970 6527  attr(dt, 'dtype'
+00032990: 293a 2064 7420 3d20 6474 2e64 7479 7065  ): dt = dt.dtype
+000329a0: 0a20 2020 2020 2020 2023 2069 6620 6973  .        # if is
+000329b0: 696e 7374 616e 6365 2864 742c 2074 6f72  instance(dt, tor
+000329c0: 6368 2e64 7479 7065 293a 2072 6574 7572  ch.dtype): retur
+000329d0: 6e20 7375 7065 7228 292e 7479 7065 2864  n super().type(d
+000329e0: 7429 2e61 735f 7375 6263 6c61 7373 2873  t).as_subclass(s
+000329f0: 656c 662e 5f5f 636c 6173 735f 5f29 0a20  elf.__class__). 
+00032a00: 2020 2020 2020 2023 2069 6d70 6f72 7420         # import 
+00032a10: 6e75 6d70 7920 6173 206e 700a 2020 2020  numpy as np.    
+00032a20: 2020 2020 2320 6474 5f6e 616d 6520 3d20      # dt_name = 
+00032a30: 6e70 2e64 7479 7065 2864 7429 2e6e 616d  np.dtype(dt).nam
+00032a40: 650a 2020 2020 2020 2020 2320 6474 7970  e.        # dtyp
+00032a50: 655f 6d61 7020 3d20 7b27 7569 6e74 3136  e_map = {'uint16
+00032a60: 273a 2022 696e 7433 3222 2c20 2775 696e  ': "int32", 'uin
+00032a70: 7433 3227 3a20 2269 6e74 3634 222c 2027  t32': "int64", '
+00032a80: 7569 6e74 3634 273a 2022 696e 7436 3422  uint64': "int64"
+00032a90: 7d0a 2020 2020 2020 2020 2320 746f 7263  }.        # torc
+00032aa0: 685f 6474 203d 2067 6574 6174 7472 2874  h_dt = getattr(t
+00032ab0: 6f72 6368 2c20 6474 7970 655f 6d61 702e  orch, dtype_map.
+00032ac0: 6765 7428 6474 5f6e 616d 652c 2064 745f  get(dt_name, dt_
+00032ad0: 6e61 6d65 292c 204e 6f6e 6529 0a20 2020  name), None).   
+00032ae0: 2020 2020 2023 2061 766f 7563 6828 746f       # avouch(to
+00032af0: 7263 685f 6474 2069 7320 6e6f 7420 4e6f  rch_dt is not No
+00032b00: 6e65 2c20 6622 496e 7661 6c69 6420 6474  ne, f"Invalid dt
+00032b10: 7970 6520 7b64 747d 3a20 7b64 745f 6e61  ype {dt}: {dt_na
+00032b20: 6d65 7d20 6361 6e6e 6f74 2062 6520 636f  me} cannot be co
+00032b30: 6e76 6572 7465 6420 696e 746f 2074 6f72  nverted into tor
+00032b40: 6368 2064 7479 7065 2e22 290a 2020 2020  ch dtype.").    
+00032b50: 2020 2020 2320 7265 7475 726e 2073 7570      # return sup
+00032b60: 6572 2829 2e74 7970 6528 746f 7263 685f  er().type(torch_
+00032b70: 6474 292e 6173 5f73 7562 636c 6173 7328  dt).as_subclass(
+00032b80: 7365 6c66 2e5f 5f63 6c61 7373 5f5f 290a  self.__class__).
+00032b90: 0a20 2020 2064 6566 2074 7970 6528 7365  .    def type(se
+00032ba0: 6c66 2c20 6474 3d4e 6f6e 6529 3a0a 2020  lf, dt=None):.  
+00032bb0: 2020 2020 2020 7769 7468 2074 6f72 6368        with torch
+00032bc0: 2e5f 432e 4469 7361 626c 6554 6f72 6368  ._C.DisableTorch
+00032bd0: 4675 6e63 7469 6f6e 2829 3a0a 2020 2020  Function():.    
+00032be0: 2020 2020 2020 2020 6966 2064 7420 6973          if dt is
+00032bf0: 204e 6f6e 653a 2072 6574 7572 6e20 746f   None: return to
+00032c00: 7263 685f 7375 7065 7228 7365 6c66 2c20  rch_super(self, 
+00032c10: 2774 7970 6527 2928 292e 7265 706c 6163  'type')().replac
+00032c20: 6528 2274 6f72 6368 2e22 2c20 2262 6174  e("torch.", "bat
+00032c30: 6f72 6368 2e22 290a 2020 2020 2020 2020  orch.").        
+00032c40: 2020 2020 656c 7365 3a20 7265 7475 726e      else: return
+00032c50: 2073 656c 662e 6173 7479 7065 2864 7429   self.astype(dt)
+00032c60: 0a0a 2020 2020 6465 6620 5f5f 6765 7461  ..    def __geta
+00032c70: 7474 7269 6275 7465 5f5f 2873 656c 662c  ttribute__(self,
+00032c80: 206b 6579 293a 0a20 2020 2020 2020 2077   key):.        w
+00032c90: 6974 6820 746f 7263 682e 5f43 2e44 6973  ith torch._C.Dis
+00032ca0: 6162 6c65 546f 7263 6846 756e 6374 696f  ableTorchFunctio
+00032cb0: 6e28 293a 0a20 2020 2020 2020 2020 2020  n():.           
+00032cc0: 2067 203d 2073 7570 6572 2854 656e 736f   g = super(Tenso
+00032cd0: 722c 2073 656c 6629 2e5f 5f67 6574 6174  r, self).__getat
+00032ce0: 7472 6962 7574 655f 5f28 6b65 7929 0a20  tribute__(key). 
+00032cf0: 2020 2020 2020 2069 6620 6b65 7920 696e         if key in
+00032d00: 2028 2767 7261 6427 2c20 2772 6561 6c27   ('grad', 'real'
+00032d10: 2c20 2769 6d61 6727 293a 0a20 2020 2020  , 'imag'):.     
+00032d20: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+00032d30: 696e 7374 616e 6365 2867 2c20 746f 7263  instance(g, torc
+00032d40: 682e 5465 6e73 6f72 293a 2072 6574 7572  h.Tensor): retur
+00032d50: 6e20 670a 2020 2020 2020 2020 2020 2020  n g.            
+00032d60: 7265 7475 726e 2067 2e61 735f 7375 6263  return g.as_subc
+00032d70: 6c61 7373 2854 656e 736f 7229 2e73 7065  lass(Tensor).spe
+00032d80: 6369 616c 5f66 726f 6d28 7365 6c66 290a  cial_from(self).
+00032d90: 2020 2020 2020 2020 656c 6966 206b 6579          elif key
+00032da0: 203d 3d20 2767 7261 645f 666e 273a 0a20   == 'grad_fn':. 
+00032db0: 2020 2020 2020 2020 2020 2069 6620 6720             if g 
+00032dc0: 6973 204e 6f6e 653a 2072 6574 7572 6e20  is None: return 
+00032dd0: 670a 2020 2020 2020 2020 2020 2020 636c  g.            cl
+00032de0: 6173 7320 6766 6e3a 0a20 2020 2020 2020  ass gfn:.       
+00032df0: 2020 2020 2020 2020 2064 6566 205f 5f69           def __i
+00032e00: 6e69 745f 5f28 7365 6c66 2c20 666e 2c20  nit__(self, fn, 
+00032e10: 666e 5f6e 616d 6529 3a20 7365 6c66 2e66  fn_name): self.f
+00032e20: 6e20 3d20 666e 3b20 7365 6c66 2e66 6e5f  n = fn; self.fn_
+00032e30: 6e61 6d65 203d 2066 6e5f 6e61 6d65 0a20  name = fn_name. 
+00032e40: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00032e50: 6566 205f 5f63 616c 6c5f 5f28 7365 6c66  ef __call__(self
+00032e60: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
+00032e70: 7329 3a20 7265 7475 726e 2073 656c 662e  s): return self.
+00032e80: 666e 282a 6172 6773 2c20 2a2a 6b77 6172  fn(*args, **kwar
+00032e90: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+00032ea0: 2020 2020 6465 6620 5f5f 6765 7461 7474      def __getatt
+00032eb0: 7269 6275 7465 5f5f 2873 656c 662c 206b  ribute__(self, k
+00032ec0: 6579 293a 0a20 2020 2020 2020 2020 2020  ey):.           
+00032ed0: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
+00032ee0: 696e 2028 2766 6e27 2c20 2766 6e5f 6e61  in ('fn', 'fn_na
+00032ef0: 6d65 272c 2027 5f5f 696e 6974 5f5f 272c  me', '__init__',
+00032f00: 2027 5f5f 6361 6c6c 5f5f 272c 2027 5f5f   '__call__', '__
+00032f10: 6765 7461 7474 7269 6275 7465 5f5f 272c  getattribute__',
+00032f20: 2027 5f5f 7265 7072 5f5f 2729 3a0a 2020   '__repr__'):.  
+00032f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032f40: 2020 2020 2020 7265 7475 726e 2073 7570        return sup
+00032f50: 6572 2829 2e5f 5f67 6574 6174 7472 6962  er().__getattrib
+00032f60: 7574 655f 5f28 6b65 7929 0a20 2020 2020  ute__(key).     
+00032f70: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00032f80: 7474 7220 3d20 6765 7461 7474 7228 7365  ttr = getattr(se
+00032f90: 6c66 2e66 6e2c 206b 6579 2c20 4e6f 6e65  lf.fn, key, None
+00032fa0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00032fb0: 2020 2020 2020 6966 2061 7474 7220 6973        if attr is
+00032fc0: 206e 6f74 204e 6f6e 653a 2072 6574 7572   not None: retur
+00032fd0: 6e20 6174 7472 0a20 2020 2020 2020 2020  n attr.         
+00032fe0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00032ff0: 6e20 7375 7065 7228 292e 5f5f 6765 7461  n super().__geta
+00033000: 7474 7269 6275 7465 5f5f 286b 6579 290a  ttribute__(key).
+00033010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033020: 6465 6620 5f5f 7265 7072 5f5f 2873 656c  def __repr__(sel
+00033030: 6629 3a20 7265 7475 726e 2066 223c 6261  f): return f"<ba
+00033040: 636b 7761 7264 3a20 7b73 656c 662e 666e  ckward: {self.fn
+00033050: 5f6e 616d 657d 2061 7420 3078 7b69 6428  _name} at 0x{id(
+00033060: 7365 6c66 2e66 6e29 3a30 787d 3e22 0a20  self.fn):0x}>". 
+00033070: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00033080: 6e20 6766 6e28 672c 2067 6574 6174 7472  n gfn(g, getattr
+00033090: 2873 656c 662c 2027 6772 6164 5f66 6e5f  (self, 'grad_fn_
+000330a0: 6e61 6d65 272c 2027 556e 6b6e 6f77 6e27  name', 'Unknown'
+000330b0: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
+000330c0: 6e20 670a 2020 2020 0a20 2020 2064 6566  n g.    .    def
+000330d0: 205f 5f73 6574 6174 7472 5f5f 2873 656c   __setattr__(sel
+000330e0: 662c 206b 6579 2c20 7661 6c75 6529 3a0a  f, key, value):.
+000330f0: 2020 2020 2020 2020 6966 206b 6579 2069          if key i
+00033100: 6e20 2827 6772 6164 272c 2027 7265 616c  n ('grad', 'real
+00033110: 272c 2027 696d 6167 2729 3a0a 2020 2020  ', 'imag'):.    
+00033120: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00033130: 7461 6e63 6528 7661 6c75 652c 2054 656e  tance(value, Ten
+00033140: 736f 7229 3a0a 2020 2020 2020 2020 2020  sor):.          
+00033150: 2020 2020 2020 7661 6c75 6520 3d20 7661        value = va
+00033160: 6c75 652e 6173 5f73 7562 636c 6173 7328  lue.as_subclass(
+00033170: 746f 7263 682e 5465 6e73 6f72 290a 2020  torch.Tensor).  
+00033180: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
+00033190: 7365 7461 7474 725f 5f28 6b65 792c 2076  setattr__(key, v
+000331a0: 616c 7565 290a 2020 2020 2020 2020 0a20  alue).        . 
+000331b0: 2020 2064 6566 2061 735f 6675 6e63 5f74     def as_func_t
+000331c0: 656e 736f 7228 7365 6c66 293a 0a20 2020  ensor(self):.   
+000331d0: 2020 2020 2061 766f 7563 6828 7365 6c66       avouch(self
+000331e0: 2e6e 5f64 696d 203d 3d20 312c 2054 7970  .n_dim == 1, Typ
+000331f0: 6545 7272 6f72 2822 4f6e 6c79 2031 4420  eError("Only 1D 
+00033200: 7465 6e73 6f72 2063 616e 2062 6520 636f  tensor can be co
+00033210: 6e76 6572 7465 6420 746f 2066 756e 6374  nverted to funct
+00033220: 696f 6e61 6c20 7465 6e73 6f72 2e20 2229  ional tensor. ")
+00033230: 290a 2020 2020 2020 2020 7365 6c66 2e69  ).        self.i
+00033240: 6e69 745f 7370 6563 6961 6c28 290a 2020  nit_special().  
+00033250: 2020 2020 2020 7365 6c66 2e73 7a5f 6675        self.sz_fu
+00033260: 6e63 5f64 696d 203d 2073 656c 662e 6e5f  nc_dim = self.n_
+00033270: 6469 6d0a 2020 2020 2020 2020 7265 7475  dim.        retu
+00033280: 726e 2073 656c 660a 0a20 2020 2064 6566  rn self..    def
+00033290: 2061 735f 6261 7463 685f 7465 6e73 6f72   as_batch_tensor
+000332a0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+000332b0: 6176 6f75 6368 2873 656c 662e 6e5f 6469  avouch(self.n_di
+000332c0: 6d20 3d3d 2031 2c20 5479 7065 4572 726f  m == 1, TypeErro
+000332d0: 7228 224f 6e6c 7920 3144 2074 656e 736f  r("Only 1D tenso
+000332e0: 7220 6361 6e20 6265 2063 6f6e 7665 7274  r can be convert
+000332f0: 6564 2074 6f20 6261 7463 6820 7465 6e73  ed to batch tens
+00033300: 6f72 2e20 2229 290a 2020 2020 2020 2020  or. ")).        
+00033310: 7365 6c66 2e69 6e69 745f 7370 6563 6961  self.init_specia
+00033320: 6c28 290a 2020 2020 2020 2020 7365 6c66  l().        self
+00033330: 2e73 7a5f 6261 7463 685f 6469 6d20 3d20  .sz_batch_dim = 
+00033340: 7365 6c66 2e6e 5f64 696d 0a20 2020 2020  self.n_dim.     
+00033350: 2020 2072 6574 7572 6e20 7365 6c66 0a0a     return self..
+00033360: 2020 2020 6465 6620 6173 5f66 6561 7475      def as_featu
+00033370: 7265 5f74 656e 736f 7228 7365 6c66 293a  re_tensor(self):
+00033380: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
+00033390: 6974 5f73 7065 6369 616c 2829 0a20 2020  it_special().   
+000333a0: 2020 2020 2073 656c 662e 737a 5f66 6561       self.sz_fea
+000333b0: 7475 7265 5f64 696d 203d 2073 656c 662e  ture_dim = self.
+000333c0: 6e5f 6469 6d0a 2020 2020 2020 2020 7265  n_dim.        re
+000333d0: 7475 726e 2073 656c 660a 0a20 2020 2064  turn self..    d
+000333e0: 6566 2061 735f 7365 7175 656e 6365 5f74  ef as_sequence_t
+000333f0: 656e 736f 7228 7365 6c66 293a 0a20 2020  ensor(self):.   
+00033400: 2020 2020 2073 656c 662e 696e 6974 5f73       self.init_s
+00033410: 7065 6369 616c 2829 0a20 2020 2020 2020  pecial().       
+00033420: 2073 656c 662e 737a 5f73 6571 7565 6e63   self.sz_sequenc
+00033430: 5f64 696d 203d 2073 656c 662e 6e5f 6469  _dim = self.n_di
+00033440: 6d0a 2020 2020 2020 2020 7265 7475 726e  m.        return
+00033450: 2073 656c 660a 0a20 2020 2064 6566 2061   self..    def a
+00033460: 7574 6f5f 6465 7669 6365 2873 656c 6629  uto_device(self)
+00033470: 3a0a 2020 2020 2020 2020 676c 6f62 616c  :.        global
+00033480: 205f 6465 7669 6365 0a20 2020 2020 2020   _device.       
+00033490: 2072 6574 7572 6e20 7365 6c66 2e74 6f28   return self.to(
+000334a0: 5f64 6576 6963 652e 6d61 696e 5f64 6576  _device.main_dev
+000334b0: 6963 6529 0a20 2020 200a 2020 2020 6465  ice).    .    de
+000334c0: 6620 6e75 6d70 7928 7365 6c66 293a 0a20  f numpy(self):. 
+000334d0: 2020 2020 2020 2072 6574 7572 6e20 746f         return to
+000334e0: 7263 682e 5465 6e73 6f72 2e6e 756d 7079  rch.Tensor.numpy
+000334f0: 2873 7570 6572 2829 2e63 7075 2829 290a  (super().cpu()).
+00033500: 0a20 2020 2062 6173 6963 5f76 6172 7320  .    basic_vars 
+00033510: 3d20 6c69 7374 286c 6f63 616c 7328 292e  = list(locals().
+00033520: 6b65 7973 2829 2920 2b20 5b27 6261 7369  keys()) + ['basi
+00033530: 635f 7661 7273 275d 0a20 2020 2023 206f  c_vars'].    # o
+00033540: 7065 7261 746f 7273 0a20 2020 2064 6566  perators.    def
+00033550: 205f 5f61 6464 5f5f 2873 656c 663a 2027   __add__(self: '
+00033560: 5465 6e73 6f72 272c 206f 7468 6572 3a20  Tensor', other: 
+00033570: 2754 656e 736f 7227 293a 202e 2e2e 0a20  'Tensor'): .... 
+00033580: 2020 2064 6566 205f 5f69 6164 645f 5f28     def __iadd__(
+00033590: 7365 6c66 3a20 2754 656e 736f 7227 2c20  self: 'Tensor', 
+000335a0: 6f74 6865 723a 2027 5465 6e73 6f72 2729  other: 'Tensor')
+000335b0: 3a20 2e2e 2e0a 2020 2020 6465 6620 5f5f  : ....    def __
+000335c0: 7261 6464 5f5f 2873 656c 663a 2027 5465  radd__(self: 'Te
+000335d0: 6e73 6f72 272c 206f 7468 6572 3a20 2754  nsor', other: 'T
+000335e0: 656e 736f 7227 293a 202e 2e2e 0a20 2020  ensor'): ....   
+000335f0: 2064 6566 205f 5f73 7562 5f5f 2873 656c   def __sub__(sel
+00033600: 663a 2027 5465 6e73 6f72 272c 206f 7468  f: 'Tensor', oth
+00033610: 6572 3a20 2754 656e 736f 7227 293a 202e  er: 'Tensor'): .
+00033620: 2e2e 0a20 2020 2064 6566 205f 5f69 7375  ...    def __isu
+00033630: 625f 5f28 7365 6c66 3a20 2754 656e 736f  b__(self: 'Tenso
+00033640: 7227 2c20 6f74 6865 723a 2027 5465 6e73  r', other: 'Tens
+00033650: 6f72 2729 3a20 2e2e 2e0a 2020 2020 6465  or'): ....    de
+00033660: 6620 5f5f 7273 7562 5f5f 2873 656c 663a  f __rsub__(self:
+00033670: 2027 5465 6e73 6f72 272c 206f 7468 6572   'Tensor', other
+00033680: 3a20 2754 656e 736f 7227 293a 202e 2e2e  : 'Tensor'): ...
+00033690: 0a20 2020 2064 6566 205f 5f6d 756c 5f5f  .    def __mul__
+000336a0: 2873 656c 663a 2027 5465 6e73 6f72 272c  (self: 'Tensor',
+000336b0: 206f 7468 6572 3a20 2754 656e 736f 7227   other: 'Tensor'
+000336c0: 293a 202e 2e2e 0a20 2020 2064 6566 205f  ): ....    def _
+000336d0: 5f69 6d75 6c5f 5f28 7365 6c66 3a20 2754  _imul__(self: 'T
 000336e0: 656e 736f 7227 2c20 6f74 6865 723a 2027  ensor', other: '
 000336f0: 5465 6e73 6f72 2729 3a20 2e2e 2e0a 2020  Tensor'): ....  
-00033700: 2020 6465 6620 5f5f 666c 6f6f 7264 6976    def __floordiv
-00033710: 5f5f 2873 656c 663a 2027 5465 6e73 6f72  __(self: 'Tensor
-00033720: 272c 206f 7468 6572 3a20 2754 656e 736f  ', other: 'Tenso
-00033730: 7227 293a 202e 2e2e 0a20 2020 2064 6566  r'): ....    def
-00033740: 205f 5f69 666c 6f6f 7264 6976 5f5f 2873   __ifloordiv__(s
-00033750: 656c 663a 2027 5465 6e73 6f72 272c 206f  elf: 'Tensor', o
-00033760: 7468 6572 3a20 2754 656e 736f 7227 293a  ther: 'Tensor'):
-00033770: 202e 2e2e 0a20 2020 2064 6566 205f 5f72   ....    def __r
-00033780: 666c 6f6f 7264 6976 5f5f 2873 656c 663a  floordiv__(self:
-00033790: 2027 5465 6e73 6f72 272c 206f 7468 6572   'Tensor', other
-000337a0: 3a20 2754 656e 736f 7227 293a 202e 2e2e  : 'Tensor'): ...
-000337b0: 0a20 2020 2064 6566 205f 5f6e 6567 5f5f  .    def __neg__
-000337c0: 2873 656c 663a 2027 5465 6e73 6f72 2729  (self: 'Tensor')
-000337d0: 3a20 2e2e 2e0a 2020 2020 6465 6620 5f5f  : ....    def __
-000337e0: 6571 5f5f 2873 656c 663a 2027 5465 6e73  eq__(self: 'Tens
-000337f0: 6f72 272c 206f 7468 6572 3a20 2754 656e  or', other: 'Ten
-00033800: 736f 7227 293a 202e 2e2e 0a20 2020 2064  sor'): ....    d
-00033810: 6566 205f 5f6e 655f 5f28 7365 6c66 3a20  ef __ne__(self: 
-00033820: 2754 656e 736f 7227 2c20 6f74 6865 723a  'Tensor', other:
-00033830: 2027 5465 6e73 6f72 2729 3a20 2e2e 2e0a   'Tensor'): ....
-00033840: 2020 2020 6465 6620 5f5f 6f72 5f5f 2873      def __or__(s
-00033850: 656c 663a 2027 5465 6e73 6f72 272c 206f  elf: 'Tensor', o
-00033860: 7468 6572 3a20 2754 656e 736f 7227 293a  ther: 'Tensor'):
-00033870: 202e 2e2e 0a20 2020 2064 6566 205f 5f69   ....    def __i
-00033880: 6f72 5f5f 2873 656c 663a 2027 5465 6e73  or__(self: 'Tens
-00033890: 6f72 272c 206f 7468 6572 3a20 2754 656e  or', other: 'Ten
-000338a0: 736f 7227 293a 202e 2e2e 0a20 2020 2064  sor'): ....    d
-000338b0: 6566 205f 5f72 6f72 5f5f 2873 656c 663a  ef __ror__(self:
-000338c0: 2027 5465 6e73 6f72 272c 206f 7468 6572   'Tensor', other
-000338d0: 3a20 2754 656e 736f 7227 293a 202e 2e2e  : 'Tensor'): ...
-000338e0: 0a20 2020 2064 6566 205f 5f61 6e64 5f5f  .    def __and__
-000338f0: 2873 656c 663a 2027 5465 6e73 6f72 272c  (self: 'Tensor',
-00033900: 206f 7468 6572 3a20 2754 656e 736f 7227   other: 'Tensor'
-00033910: 293a 202e 2e2e 0a20 2020 2064 6566 205f  ): ....    def _
-00033920: 5f69 616e 645f 5f28 7365 6c66 3a20 2754  _iand__(self: 'T
-00033930: 656e 736f 7227 2c20 6f74 6865 723a 2027  ensor', other: '
-00033940: 5465 6e73 6f72 2729 3a20 2e2e 2e0a 2020  Tensor'): ....  
-00033950: 2020 6465 6620 5f5f 7261 6e64 5f5f 2873    def __rand__(s
-00033960: 656c 663a 2027 5465 6e73 6f72 272c 206f  elf: 'Tensor', o
-00033970: 7468 6572 3a20 2754 656e 736f 7227 293a  ther: 'Tensor'):
-00033980: 202e 2e2e 0a20 2020 2064 6566 205f 5f78   ....    def __x
-00033990: 6f72 5f5f 2873 656c 663a 2027 5465 6e73  or__(self: 'Tens
-000339a0: 6f72 272c 206f 7468 6572 3a20 2754 656e  or', other: 'Ten
-000339b0: 736f 7227 293a 202e 2e2e 0a20 2020 2064  sor'): ....    d
-000339c0: 6566 205f 5f69 786f 725f 5f28 7365 6c66  ef __ixor__(self
-000339d0: 3a20 2754 656e 736f 7227 2c20 6f74 6865  : 'Tensor', othe
-000339e0: 723a 2027 5465 6e73 6f72 2729 3a20 2e2e  r: 'Tensor'): ..
-000339f0: 2e0a 2020 2020 6465 6620 5f5f 7278 6f72  ..    def __rxor
-00033a00: 5f5f 2873 656c 663a 2027 5465 6e73 6f72  __(self: 'Tensor
-00033a10: 272c 206f 7468 6572 3a20 2754 656e 736f  ', other: 'Tenso
-00033a20: 7227 293a 202e 2e2e 0a20 2020 2064 6566  r'): ....    def
-00033a30: 205f 5f69 6e76 6572 745f 5f28 7365 6c66   __invert__(self
-00033a40: 3a20 2754 656e 736f 7227 293a 202e 2e2e  : 'Tensor'): ...
-00033a50: 0a20 2020 2064 6566 205f 5f6c 745f 5f28  .    def __lt__(
-00033a60: 7365 6c66 3a20 2754 656e 736f 7227 2c20  self: 'Tensor', 
-00033a70: 6f74 6865 723a 2027 5465 6e73 6f72 2729  other: 'Tensor')
-00033a80: 3a20 2e2e 2e0a 2020 2020 6465 6620 5f5f  : ....    def __
-00033a90: 6c65 5f5f 2873 656c 663a 2027 5465 6e73  le__(self: 'Tens
-00033aa0: 6f72 272c 206f 7468 6572 3a20 2754 656e  or', other: 'Ten
-00033ab0: 736f 7227 293a 202e 2e2e 0a20 2020 2064  sor'): ....    d
-00033ac0: 6566 205f 5f67 745f 5f28 7365 6c66 3a20  ef __gt__(self: 
-00033ad0: 2754 656e 736f 7227 2c20 6f74 6865 723a  'Tensor', other:
-00033ae0: 2027 5465 6e73 6f72 2729 3a20 2e2e 2e0a   'Tensor'): ....
-00033af0: 2020 2020 6465 6620 5f5f 6765 5f5f 2873      def __ge__(s
-00033b00: 656c 663a 2027 5465 6e73 6f72 272c 206f  elf: 'Tensor', o
-00033b10: 7468 6572 3a20 2754 656e 736f 7227 293a  ther: 'Tensor'):
-00033b20: 202e 2e2e 0a20 2020 2064 6566 205f 5f6d   ....    def __m
-00033b30: 6174 6d75 6c5f 5f28 7365 6c66 3a20 2754  atmul__(self: 'T
-00033b40: 656e 736f 7227 2c20 6f74 6865 723a 2027  ensor', other: '
-00033b50: 5465 6e73 6f72 2729 3a20 2e2e 2e0a 2020  Tensor'): ....  
-00033b60: 2020 0a20 2020 2023 2069 6e70 6c61 6365    .    # inplace
-00033b70: 206d 6574 686f 6473 3a20 6f70 6572 6174   methods: operat
-00033b80: 696f 6e73 0a20 2020 2064 6566 2061 6464  ions.    def add
-00033b90: 5f28 7365 6c66 3a20 2754 656e 736f 7227  _(self: 'Tensor'
-00033ba0: 2c20 6f74 6865 723a 2027 5465 6e73 6f72  , other: 'Tensor
-00033bb0: 272c 202a 2c20 616c 7068 613d 3129 3a20  ', *, alpha=1): 
-00033bc0: 2e2e 2e0a 2020 2020 6465 6620 7375 625f  ....    def sub_
-00033bd0: 2873 656c 663a 2027 5465 6e73 6f72 272c  (self: 'Tensor',
-00033be0: 206f 7468 6572 3a20 2754 656e 736f 7227   other: 'Tensor'
-00033bf0: 2c20 2a2c 2061 6c70 6861 3d31 293a 202e  , *, alpha=1): .
-00033c00: 2e2e 0a20 2020 2064 6566 206d 756c 7469  ...    def multi
-00033c10: 706c 7928 7365 6c66 3a20 2754 656e 736f  ply(self: 'Tenso
-00033c20: 7227 2c20 7661 6c75 653a 2027 5465 6e73  r', value: 'Tens
-00033c30: 6f72 2729 3a20 2e2e 2e0a 2020 2020 6465  or'): ....    de
-00033c40: 6620 6d75 6c5f 2873 656c 663a 2027 5465  f mul_(self: 'Te
-00033c50: 6e73 6f72 272c 2076 616c 7565 3a20 2754  nsor', value: 'T
-00033c60: 656e 736f 7227 293a 202e 2e2e 0a20 2020  ensor'): ....   
-00033c70: 2064 6566 2064 6976 5f28 7365 6c66 3a20   def div_(self: 
-00033c80: 2754 656e 736f 7227 2c20 7661 6c75 653a  'Tensor', value:
-00033c90: 2027 5465 6e73 6f72 272c 202a 2c20 726f   'Tensor', *, ro
-00033ca0: 756e 6469 6e67 5f6d 6f64 653d 4e6f 6e65  unding_mode=None
-00033cb0: 293a 202e 2e2e 0a20 2020 2064 6566 2070  ): ....    def p
-00033cc0: 6f77 5f28 7365 6c66 3a20 2754 656e 736f  ow_(self: 'Tenso
-00033cd0: 7227 2c20 6f74 6865 723a 2027 5465 6e73  r', other: 'Tens
-00033ce0: 6f72 2729 3a20 2e2e 2e0a 2020 2020 6465  or'): ....    de
-00033cf0: 6620 666d 6f64 5f28 7365 6c66 3a20 2754  f fmod_(self: 'T
-00033d00: 656e 736f 7227 2c20 6f74 6865 723a 2027  ensor', other: '
-00033d10: 5465 6e73 6f72 2729 3a20 2e2e 2e0a 0a20  Tensor'): ..... 
-00033d20: 2020 2023 2069 6e70 6c61 6365 206d 6574     # inplace met
-00033d30: 686f 6473 3a20 696e 6974 6961 6c69 7a65  hods: initialize
-00033d40: 7273 0a20 2020 2064 6566 207a 6572 6f5f  rs.    def zero_
-00033d50: 2873 656c 663a 2027 5465 6e73 6f72 2729  (self: 'Tensor')
-00033d60: 3a20 2e2e 2e0a 2020 2020 6465 6620 6f6e  : ....    def on
-00033d70: 655f 2873 656c 6629 3a20 7265 7475 726e  e_(self): return
-00033d80: 2073 656c 662e 6669 6c6c 5f28 3129 2023   self.fill_(1) #
-00033d90: 2073 7570 7072 6573 733a 2073 7065 6369   suppress: speci
-00033da0: 616c 5f66 726f 6d0a 2020 2020 6465 6620  al_from.    def 
-00033db0: 6669 6c6c 5f28 7365 6c66 3a20 2754 656e  fill_(self: 'Ten
-00033dc0: 736f 7227 2c20 7661 6c75 6529 3a20 2e2e  sor', value): ..
-00033dd0: 2e0a 2020 2020 6465 6620 6e6f 726d 616c  ..    def normal
-00033de0: 5f28 7365 6c66 3a20 2754 656e 736f 7227  _(self: 'Tensor'
-00033df0: 2c20 6d65 616e 3d30 2c20 7374 643d 312c  , mean=0, std=1,
-00033e00: 202a 2c20 6765 6e65 7261 746f 723d 4e6f   *, generator=No
-00033e10: 6e65 293a 202e 2e2e 0a0a 2020 2020 2320  ne): .....    # 
-00033e20: 696e 706c 6163 6520 6d65 7468 6f64 733a  inplace methods:
-00033e30: 2064 696d 656e 7369 6f6e 206d 616e 6970   dimension manip
-00033e40: 756c 6174 696f 6e73 0a20 2020 2064 6566  ulations.    def
-00033e50: 2075 6e73 7175 6565 7a65 5f28 7365 6c66   unsqueeze_(self
-00033e60: 3a20 2754 656e 736f 7227 2c20 2a64 696d  : 'Tensor', *dim
-00033e70: 733a 206e 6577 5f64 696d 5b2e 2e2e 5d29  s: new_dim[...])
-00033e80: 3a20 2e2e 2e0a 2020 2020 6465 6620 7371  : ....    def sq
-00033e90: 7565 657a 655f 2873 656c 663a 2027 5465  ueeze_(self: 'Te
-00033ea0: 6e73 6f72 272c 202a 6469 6d73 3a20 6465  nsor', *dims: de
-00033eb0: 6c5f 6469 6d5b 2e2e 2e5d 293a 0a20 2020  l_dim[...]):.   
-00033ec0: 2020 2020 2076 616c 6964 5f64 696d 7320       valid_dims 
-00033ed0: 3d20 5b5d 0a20 2020 2020 2020 2077 6974  = [].        wit
-00033ee0: 6820 746f 7263 682e 5f43 2e44 6973 6162  h torch._C.Disab
-00033ef0: 6c65 546f 7263 6846 756e 6374 696f 6e28  leTorchFunction(
-00033f00: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
-00033f10: 6f72 2064 2069 6e20 6469 6d73 5b3a 3a2d  or d in dims[::-
-00033f20: 315d 3a0a 2020 2020 2020 2020 2020 2020  1]:.            
-00033f30: 2020 2020 6966 2073 656c 662e 7369 7a65      if self.size
-00033f40: 2864 2920 3d3d 2031 3a0a 2020 2020 2020  (d) == 1:.      
-00033f50: 2020 2020 2020 2020 2020 2020 2020 7661                va
-00033f60: 6c69 645f 6469 6d73 2e61 7070 656e 6428  lid_dims.append(
-00033f70: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
-00033f80: 2020 2020 2020 2074 6f72 6368 5f73 7570         torch_sup
-00033f90: 6572 2873 656c 662c 2027 7371 7565 657a  er(self, 'squeez
-00033fa0: 655f 2729 2864 290a 2020 2020 2020 2020  e_')(d).        
-00033fb0: 6469 6d73 203d 2074 7570 6c65 2876 616c  dims = tuple(val
-00033fc0: 6964 5f64 696d 7329 0a20 2020 2020 2020  id_dims).       
-00033fd0: 2072 6574 7572 6e20 7365 6c66 0a20 2020   return self.   
-00033fe0: 2064 6566 2074 7261 6e73 706f 7365 5f28   def transpose_(
-00033ff0: 7365 6c66 3a20 2754 656e 736f 7227 2c20  self: 'Tensor', 
-00034000: 6469 6d30 3a20 6578 6973 745f 6469 6d5b  dim0: exist_dim[
-00034010: 315d 2c20 6469 6d31 3a20 6578 6973 745f  1], dim1: exist_
-00034020: 6469 6d5b 315d 293a 202e 2e2e 0a20 2020  dim[1]): ....   
-00034030: 200a 2020 2020 2320 7072 6f70 6572 7469   .    # properti
-00034040: 6573 0a20 2020 2040 636f 6c6c 6563 745f  es.    @collect_
-00034050: 6d65 6d6f 7279 0a20 2020 2064 6566 2074  memory.    def t
-00034060: 6f28 7365 6c66 3a20 2754 656e 736f 7227  o(self: 'Tensor'
-00034070: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
-00034080: 7329 3a20 2e2e 2e0a 2020 2020 6465 6620  s): ....    def 
-00034090: 636c 6f6e 6528 7365 6c66 3a20 2754 656e  clone(self: 'Ten
-000340a0: 736f 7227 2c20 2a2c 206d 656d 6f72 795f  sor', *, memory_
-000340b0: 666f 726d 6174 3d74 6f72 6368 2e70 7265  format=torch.pre
-000340c0: 7365 7276 655f 666f 726d 6174 293a 202e  serve_format): .
-000340d0: 2e2e 0a20 2020 2064 6566 2069 6e74 2873  ...    def int(s
-000340e0: 656c 663a 2027 5465 6e73 6f72 272c 206d  elf: 'Tensor', m
-000340f0: 656d 6f72 795f 666f 726d 6174 3d74 6f72  emory_format=tor
-00034100: 6368 2e70 7265 7365 7276 655f 666f 726d  ch.preserve_form
-00034110: 6174 293a 202e 2e2e 0a20 2020 2064 6566  at): ....    def
-00034120: 206c 6f6e 6728 7365 6c66 3a20 2754 656e   long(self: 'Ten
-00034130: 736f 7227 2c20 6d65 6d6f 7279 5f66 6f72  sor', memory_for
-00034140: 6d61 743d 746f 7263 682e 7072 6573 6572  mat=torch.preser
-00034150: 7665 5f66 6f72 6d61 7429 3a20 2e2e 2e0a  ve_format): ....
-00034160: 2020 2020 6465 6620 666c 6f61 7428 7365      def float(se
-00034170: 6c66 3a20 2754 656e 736f 7227 2c20 6d65  lf: 'Tensor', me
-00034180: 6d6f 7279 5f66 6f72 6d61 743d 746f 7263  mory_format=torc
-00034190: 682e 7072 6573 6572 7665 5f66 6f72 6d61  h.preserve_forma
-000341a0: 7429 3a20 2e2e 2e0a 2020 2020 6465 6620  t): ....    def 
-000341b0: 646f 7562 6c65 2873 656c 663a 2027 5465  double(self: 'Te
-000341c0: 6e73 6f72 272c 206d 656d 6f72 795f 666f  nsor', memory_fo
-000341d0: 726d 6174 3d74 6f72 6368 2e70 7265 7365  rmat=torch.prese
-000341e0: 7276 655f 666f 726d 6174 293a 202e 2e2e  rve_format): ...
-000341f0: 0a20 2020 2064 6566 2063 7075 2873 656c  .    def cpu(sel
-00034200: 663a 2027 5465 6e73 6f72 2729 3a20 2e2e  f: 'Tensor'): ..
-00034210: 2e0a 2020 2020 6465 6620 6375 6461 2873  ..    def cuda(s
-00034220: 656c 663a 2027 5465 6e73 6f72 2729 3a20  elf: 'Tensor'): 
-00034230: 2e2e 2e0a 0a20 2020 2023 2073 6861 7065  .....    # shape
-00034240: 733a 0a20 2020 2064 6566 2072 6573 6861  s:.    def resha
-00034250: 7065 2873 656c 662c 202a 7369 7a65 3a20  pe(self, *size: 
-00034260: 5369 7a65 293a 202e 2e2e 0a20 2020 2064  Size): ....    d
-00034270: 6566 2072 6573 6861 7065 5f61 7328 7365  ef reshape_as(se
-00034280: 6c66 2c20 6f74 6865 723a 2027 5465 6e73  lf, other: 'Tens
-00034290: 6f72 2729 3a20 2e2e 2e0a 2020 2020 6465  or'): ....    de
-000342a0: 6620 7669 6577 2873 656c 662c 202a 7369  f view(self, *si
-000342b0: 7a65 3a20 5369 7a65 293a 0a20 2020 2020  ze: Size):.     
-000342c0: 2020 2077 6974 6820 746f 7263 682e 5f43     with torch._C
-000342d0: 2e44 6973 6162 6c65 546f 7263 6846 756e  .DisableTorchFun
-000342e0: 6374 696f 6e28 293a 0a20 2020 2020 2020  ction():.       
-000342f0: 2020 2020 2072 6574 7572 6e20 746f 7263       return torc
-00034300: 685f 7375 7065 7228 7365 6c66 2c20 2776  h_super(self, 'v
-00034310: 6965 7727 2928 7369 7a65 290a 2020 2020  iew')(size).    
-00034320: 6465 6620 7669 6577 5f61 7328 7365 6c66  def view_as(self
-00034330: 2c20 6f74 6865 723a 2027 5465 6e73 6f72  , other: 'Tensor
-00034340: 2729 3a20 2e2e 2e0a 2020 2020 6465 6620  '): ....    def 
-00034350: 7768 6572 6528 7365 6c66 3a20 2754 656e  where(self: 'Ten
-00034360: 736f 7227 2c20 636f 6e64 6974 696f 6e3a  sor', condition:
-00034370: 2027 5465 6e73 6f72 272c 206f 7468 6572   'Tensor', other
-00034380: 3a20 2754 656e 736f 7227 3d4e 6f6e 652c  : 'Tensor'=None,
-00034390: 202a 2c20 6571 7561 6c73 3a20 2754 656e   *, equals: 'Ten
-000343a0: 736f 7227 3d4e 6f6e 6529 3a0a 2020 2020  sor'=None):.    
-000343b0: 2020 2020 6966 2065 7175 616c 7320 6973      if equals is
-000343c0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000343d0: 2020 2072 6566 5f73 6861 7065 203d 2062     ref_shape = b
-000343e0: 726f 6164 6361 7374 2873 656c 665f 7368  roadcast(self_sh
-000343f0: 6170 652c 2063 6f6e 6469 7469 6f6e 5f73  ape, condition_s
-00034400: 6861 7065 2c20 6f74 6865 725f 7368 6170  hape, other_shap
-00034410: 652c 2077 6974 685f 7369 7a65 5f75 7064  e, with_size_upd
-00034420: 6174 6573 3d54 7275 6529 0a20 2020 2020  ates=True).     
-00034430: 2020 2020 2020 2073 656c 6620 3d20 7365         self = se
-00034440: 6c66 2e76 6965 7728 7265 665f 7368 6170  lf.view(ref_shap
-00034450: 652e 7570 6461 7465 645f 7369 7a65 735b  e.updated_sizes[
-00034460: 305d 290a 2020 2020 2020 2020 2020 2020  0]).            
-00034470: 636f 6e64 6974 696f 6e20 3d20 636f 6e64  condition = cond
-00034480: 6974 696f 6e2e 7669 6577 2872 6566 5f73  ition.view(ref_s
-00034490: 6861 7065 2e75 7064 6174 6564 5f73 697a  hape.updated_siz
-000344a0: 6573 5b31 5d29 0a20 2020 2020 2020 2020  es[1]).         
-000344b0: 2020 206f 7468 6572 203d 206f 7468 6572     other = other
-000344c0: 2e76 6965 7728 7265 665f 7368 6170 652e  .view(ref_shape.
-000344d0: 7570 6461 7465 645f 7369 7a65 735b 325d  updated_sizes[2]
-000344e0: 290a 2020 2020 2020 2020 2020 2020 7769  ).            wi
-000344f0: 7468 2074 6f72 6368 2e5f 432e 4469 7361  th torch._C.Disa
-00034500: 626c 6554 6f72 6368 4675 6e63 7469 6f6e  bleTorchFunction
-00034510: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00034520: 2020 2020 6f62 6a20 3d20 746f 7263 685f      obj = torch_
-00034530: 7375 7065 7228 7365 6c66 2c20 2777 6865  super(self, 'whe
-00034540: 7265 2729 2863 6f6e 6469 7469 6f6e 2c20  re')(condition, 
-00034550: 6f74 6865 7229 0a20 2020 2020 2020 2020  other).         
-00034560: 2020 2072 6574 7572 6e20 6f62 6a2e 6173     return obj.as
-00034570: 5f73 7562 636c 6173 7328 5465 6e73 6f72  _subclass(Tensor
-00034580: 292e 7370 6563 6961 6c5f 6672 6f6d 2872  ).special_from(r
-00034590: 6566 5f73 6861 7065 290a 2020 2020 2020  ef_shape).      
-000345a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000345b0: 2020 2020 7265 665f 7368 6170 6520 3d20      ref_shape = 
-000345c0: 6272 6f61 6463 6173 7428 7365 6c66 5f73  broadcast(self_s
-000345d0: 6861 7065 2c20 636f 6e64 6974 696f 6e5f  hape, condition_
-000345e0: 7368 6170 652c 2065 7175 616c 735f 7368  shape, equals_sh
-000345f0: 6170 652c 2077 6974 685f 7369 7a65 5f75  ape, with_size_u
-00034600: 7064 6174 6573 3d54 7275 6529 0a20 2020  pdates=True).   
-00034610: 2020 2020 2020 2020 2073 656c 6620 3d20           self = 
-00034620: 7365 6c66 2e76 6965 7728 7265 665f 7368  self.view(ref_sh
-00034630: 6170 652e 7570 6461 7465 645f 7369 7a65  ape.updated_size
-00034640: 735b 305d 290a 2020 2020 2020 2020 2020  s[0]).          
-00034650: 2020 636f 6e64 6974 696f 6e20 3d20 636f    condition = co
-00034660: 6e64 6974 696f 6e2e 7669 6577 2872 6566  ndition.view(ref
-00034670: 5f73 6861 7065 2e75 7064 6174 6564 5f73  _shape.updated_s
-00034680: 697a 6573 5b31 5d29 0a20 2020 2020 2020  izes[1]).       
-00034690: 2020 2020 2065 7175 616c 7320 3d20 6571       equals = eq
-000346a0: 7561 6c73 2e76 6965 7728 7265 665f 7368  uals.view(ref_sh
-000346b0: 6170 652e 7570 6461 7465 645f 7369 7a65  ape.updated_size
-000346c0: 735b 325d 290a 2020 2020 2020 2020 2020  s[2]).          
-000346d0: 2020 7769 7468 2074 6f72 6368 2e5f 432e    with torch._C.
-000346e0: 4469 7361 626c 6554 6f72 6368 4675 6e63  DisableTorchFunc
-000346f0: 7469 6f6e 2829 3a0a 2020 2020 2020 2020  tion():.        
-00034700: 2020 2020 2020 2020 6f62 6a20 3d20 746f          obj = to
-00034710: 7263 685f 7375 7065 7228 7365 6c66 2c20  rch_super(self, 
-00034720: 2777 6865 7265 2729 287e 636f 6e64 6974  'where')(~condit
-00034730: 696f 6e2c 2065 7175 616c 7329 0a20 2020  ion, equals).   
-00034740: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00034750: 6f62 6a2e 6173 5f73 7562 636c 6173 7328  obj.as_subclass(
-00034760: 5465 6e73 6f72 292e 7370 6563 6961 6c5f  Tensor).special_
-00034770: 6672 6f6d 2872 6566 5f73 6861 7065 290a  from(ref_shape).
-00034780: 2020 2020 6465 6620 646f 776e 5f73 6361      def down_sca
-00034790: 6c65 2873 656c 663a 2027 5465 6e73 6f72  le(self: 'Tensor
-000347a0: 272c 2066 6163 746f 723d 3129 3a0a 2020  ', factor=1):.  
-000347b0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-000347c0: 665b 2873 6c69 6365 284e 6f6e 6529 2c29  f[(slice(None),)
-000347d0: 202a 2073 656c 662e 7370 6163 655f 7374   * self.space_st
-000347e0: 6172 7420 2b20 2873 6c69 6365 284e 6f6e  art + (slice(Non
-000347f0: 652c 204e 6f6e 652c 2066 6163 746f 7229  e, None, factor)
-00034800: 2c29 202a 2073 656c 662e 6e5f 7370 6163  ,) * self.n_spac
-00034810: 655f 6469 6d5d 2023 2073 7570 7072 6573  e_dim] # suppres
-00034820: 733a 2073 7065 6369 616c 5f66 726f 6d0a  s: special_from.
-00034830: 2020 2020 6465 6620 7570 5f73 6361 6c65      def up_scale
-00034840: 2873 656c 663a 2027 5465 6e73 6f72 272c  (self: 'Tensor',
-00034850: 2066 6163 746f 723d 3129 3a0a 2020 2020   factor=1):.    
-00034860: 2020 2020 666f 7220 6420 696e 2072 616e      for d in ran
-00034870: 6765 5f28 2a73 656c 662e 7370 6163 655f  ge_(*self.space_
-00034880: 7261 6e67 6529 3a0a 2020 2020 2020 2020  range):.        
-00034890: 2020 2020 7365 6c66 203d 2073 656c 662e      self = self.
-000348a0: 616d 706c 6966 7928 6661 6374 6f72 2c20  amplify(factor, 
-000348b0: 6429 0a20 2020 2020 2020 2072 6574 7572  d).        retur
-000348c0: 6e20 7365 6c66 2023 2073 7570 7072 6573  n self # suppres
-000348d0: 733a 2073 7065 6369 616c 5f66 726f 6d0a  s: special_from.
-000348e0: 2020 2020 6164 6469 7469 6f6e 616c 5f6d      additional_m
-000348f0: 6574 686f 6473 203d 206c 6973 7428 7365  ethods = list(se
-00034900: 7428 6c6f 6361 6c73 2829 2920 2d20 7365  t(locals()) - se
-00034910: 7428 6261 7369 635f 7661 7273 2929 0a20  t(basic_vars)). 
-00034920: 2020 200a 2020 2020 666f 7220 6973 5f62     .    for is_b
-00034930: 6977 6179 2c20 6620 696e 205b 2846 616c  iway, f in [(Fal
-00034940: 7365 2c20 6629 2066 6f72 2066 2069 6e20  se, f) for f in 
-00034950: 6164 6469 7469 6f6e 616c 5f6d 6574 686f  additional_metho
-00034960: 6473 5d20 2b20 5b28 5472 7565 2c20 6629  ds] + [(True, f)
-00034970: 2066 6f72 2066 2069 6e20 6269 7761 795f   for f in biway_
-00034980: 6675 6e63 7469 6f6e 735d 3a0a 2020 2020  functions]:.    
-00034990: 2020 2020 6675 6e63 5f63 6f64 6573 203d      func_codes =
-000349a0: 2067 6574 5f75 7064 6174 6564 5f63 6f64   get_updated_cod
-000349b0: 6528 6576 616c 2866 292c 206d 6f64 653d  e(eval(f), mode=
-000349c0: 276d 6574 686f 6427 2c20 6967 6e6f 7265  'method', ignore
-000349d0: 5f61 7267 733d 5b27 6f75 7427 5d20 6966  _args=['out'] if
-000349e0: 2069 735f 6269 7761 7920 656c 7365 205b   is_biway else [
-000349f0: 5d29 0a20 2020 2020 2020 2065 7865 6362  ]).        execb
-00034a00: 6c6f 636b 2866 756e 635f 636f 6465 7329  lock(func_codes)
-00034a10: 0a20 2020 2020 2020 2069 6620 6861 7361  .        if hasa
-00034a20: 7474 7228 746f 7263 682e 5465 6e73 6f72  ttr(torch.Tensor
-00034a30: 2c20 6629 3a0a 2020 2020 2020 2020 2020  , f):.          
-00034a40: 2020 746f 7263 685f 646f 6320 3d20 6622    torch_doc = f"
-00034a50: 5468 6520 646f 6375 6d65 6e74 206f 6620  The document of 
-00034a60: 7468 6520 6f72 6967 696e 616c 2066 756e  the original fun
-00034a70: 6374 696f 6e20 6973 3a5c 6e7b 6765 7461  ction is:\n{geta
-00034a80: 7474 7228 746f 7263 682e 5465 6e73 6f72  ttr(torch.Tensor
-00034a90: 2c20 6629 2e5f 5f64 6f63 5f5f 7d22 0a20  , f).__doc__}". 
-00034aa0: 2020 2020 2020 2020 2020 2066 6f72 206c             for l
-00034ab0: 696e 6520 696e 2074 6f72 6368 5f64 6f63  ine in torch_doc
-00034ac0: 2e73 706c 6974 2827 5c6e 2729 3a0a 2020  .split('\n'):.  
-00034ad0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00034ae0: 206c 696e 652e 7374 6172 7473 7769 7468   line.startswith
-00034af0: 2822 5365 6520 3a66 756e 633a 2229 3a0a  ("See :func:"):.
-00034b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034b10: 2020 2020 746f 7263 685f 646f 6320 2b3d      torch_doc +=
-00034b20: 2066 225c 6e77 6869 6368 2069 733a 5c6e   f"\nwhich is:\n
-00034b30: 7b65 7661 6c28 6c69 6e65 2e73 706c 6974  {eval(line.split
-00034b40: 2827 5365 6520 3a66 756e 633a 2729 5b2d  ('See :func:')[-
-00034b50: 315d 2e73 7472 6970 2829 2e73 7472 6970  1].strip().strip
-00034b60: 2827 602e 2729 292e 5f5f 646f 635f 5f7d  ('`.')).__doc__}
-00034b70: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00034b80: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
-00034b90: 2020 2020 656c 7365 3a20 746f 7263 685f      else: torch_
-00034ba0: 646f 6320 3d20 2727 0a20 2020 2020 2020  doc = ''.       
-00034bb0: 2065 7661 6c28 6629 2e5f 5f64 6f63 5f5f   eval(f).__doc__
-00034bc0: 203d 2066 2222 2241 7574 6f6d 6174 6963   = f"""Automatic
-00034bd0: 616c 6c79 2069 6e68 6572 6974 7465 6420  ally inheritted 
-00034be0: 6d65 7468 6f64 2066 726f 6d20 2774 6f72  method from 'tor
-00034bf0: 6368 2e54 656e 736f 722e 7b66 7d27 2e20  ch.Tensor.{f}'. 
-00034c00: 5468 6520 6175 746f 6d61 7469 6361 6c6c  The automaticall
-00034c10: 7920 6765 6e65 7261 7465 6420 636f 6465  y generated code
-00034c20: 7320 6172 6520 6173 2066 6f6c 6c6f 7773  s are as follows
-00034c30: 3a0a 2020 2020 2020 2020 7b61 6464 5f6c  :.        {add_l
-00034c40: 696e 656e 6f28 6675 6e63 5f63 6f64 6573  ineno(func_codes
-00034c50: 297d 0a20 2020 2020 2020 205c 6e7b 746f  )}.        \n{to
-00034c60: 7263 685f 646f 637d 0a20 2020 2020 2020  rch_doc}.       
-00034c70: 2022 2222 0a20 2020 2065 6c73 653a 2023   """.    else: #
-00034c80: 2061 6c69 6173 6573 2028 7573 656c 6573   aliases (useles
-00034c90: 7320 2765 6c73 6527 2073 636f 7065 2066  s 'else' scope f
-00034ca0: 6f72 2061 206e 6577 2073 6563 7469 6f6e  or a new section
-00034cb0: 290a 2020 2020 2020 2020 636f 6e63 6174  ).        concat
-00034cc0: 656e 6174 6520 3d20 6361 740a 2020 2020  enate = cat.    
-00034cd0: 2020 2020 696e 7620 3d20 696e 7665 7273      inv = invers
-00034ce0: 650a 2020 2020 2020 2020 7472 203d 2074  e.        tr = t
-00034cf0: 7261 6365 0a20 2020 2020 2020 206d 6174  race.        mat
-00034d00: 7269 785f 706f 7765 7220 3d20 6d61 7470  rix_power = matp
-00034d10: 6f77 0a20 2020 2020 2020 206d 6174 7269  ow.        matri
-00034d20: 785f 6578 7020 3d20 6d61 7465 7870 0a20  x_exp = matexp. 
-00034d30: 2020 2020 2020 206d 6174 7269 785f 6c6f         matrix_lo
-00034d40: 6720 3d20 6d61 746c 6f67 0a20 2020 2020  g = matlog.     
-00034d50: 2020 206d 6174 7269 785f 7261 6e6b 203d     matrix_rank =
-00034d60: 2072 616e 6b0a 2020 2020 2020 2020 6d61   rank.        ma
-00034d70: 7472 6978 5f6e 6f72 6d20 3d20 6d61 746e  trix_norm = matn
-00034d80: 6f72 6d0a 2020 2020 2020 2020 0a20 2020  orm.        .   
-00034d90: 2040 636c 6173 736d 6574 686f 640a 2020   @classmethod.  
-00034da0: 2020 6465 6620 5f5f 746f 7263 685f 6675    def __torch_fu
-00034db0: 6e63 7469 6f6e 5f5f 2863 6c73 2c20 6675  nction__(cls, fu
-00034dc0: 6e63 2c20 7479 7065 732c 2061 7267 733d  nc, types, args=
-00034dd0: 2829 2c20 6b77 6172 6773 3d4e 6f6e 6529  (), kwargs=None)
-00034de0: 3a0a 0a20 2020 2020 2020 2074 7279 3a0a  :..        try:.
-00034df0: 2020 2020 2020 2020 2020 2020 6966 2054              if T
-00034e00: 656e 736f 7220 696e 2074 7970 6573 2061  ensor in types a
-00034e10: 6e64 2063 6c73 2021 3d20 5465 6e73 6f72  nd cls != Tensor
-00034e20: 3a20 7265 7475 726e 204e 6f74 496d 706c  : return NotImpl
-00034e30: 656d 656e 7465 640a 2020 2020 2020 2020  emented.        
-00034e40: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-00034e50: 2073 656c 6620 3d20 6172 6773 5b30 5d20   self = args[0] 
-00034e60: 6966 206c 656e 2861 7267 7329 203e 2030  if len(args) > 0
-00034e70: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
-00034e80: 2020 2020 2020 2023 2069 6620 6675 6e63         # if func
-00034e90: 2e5f 5f71 7561 6c6e 616d 655f 5f2e 7374  .__qualname__.st
-00034ea0: 6172 7473 7769 7468 2822 5f56 6172 6961  artswith("_Varia
-00034eb0: 626c 6546 756e 6374 696f 6e73 436c 6173  bleFunctionsClas
-00034ec0: 7322 293a 2023 2062 6173 6963 2066 756e  s"): # basic fun
-00034ed0: 6374 696f 6e73 2027 746f 7263 682e 2a27  ctions 'torch.*'
-00034ee0: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-00034ef0: 2020 2069 6620 6675 6e63 2e5f 5f6e 616d     if func.__nam
-00034f00: 655f 5f20 696e 2067 6c6f 6261 6c73 2829  e__ in globals()
-00034f10: 3a20 7365 6c66 203d 204e 6f6e 650a 0a20  : self = None.. 
-00034f20: 2020 2020 2020 2020 2020 2023 2069 6620             # if 
-00034f30: 6675 6e63 2e5f 5f71 7561 6c6e 616d 655f  func.__qualname_
-00034f40: 5f2e 7374 6172 7473 7769 7468 2822 5f54  _.startswith("_T
-00034f50: 656e 736f 7242 6173 6522 293a 2023 2074  ensorBase"): # t
-00034f60: 656e 736f 7220 6675 6e63 7469 6f6e 7320  ensor functions 
-00034f70: 2774 6f72 6368 2e54 656e 736f 723b 2a27  'torch.Tensor;*'
-00034f80: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-00034f90: 2020 2069 6620 6861 7361 7474 7228 5465     if hasattr(Te
-00034fa0: 6e73 6f72 2c20 6675 6e63 2e5f 5f6e 616d  nsor, func.__nam
-00034fb0: 655f 5f2c 2066 756e 632e 5f5f 6e61 6d65  e__, func.__name
-00034fc0: 5f5f 293a 2073 656c 6620 3d20 4e6f 6e65  __): self = None
-00034fd0: 0a0a 2020 2020 2020 2020 2020 2020 7479  ..            ty
-00034fe0: 7065 7320 3d20 7475 706c 6528 636c 7320  pes = tuple(cls 
-00034ff0: 6966 2074 2e5f 5f6e 616d 655f 5f20 3d3d  if t.__name__ ==
-00035000: 2022 5061 7261 6d65 7465 7222 2065 6c73   "Parameter" els
-00035010: 6520 7420 666f 7220 7420 696e 2074 7970  e t for t in typ
-00035020: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
-00035030: 7265 7420 3d20 7375 7065 7228 292e 5f5f  ret = super().__
-00035040: 746f 7263 685f 6675 6e63 7469 6f6e 5f5f  torch_function__
-00035050: 2866 756e 632c 2074 7970 6573 2c20 6172  (func, types, ar
-00035060: 6773 2c20 6b77 6172 6773 290a 2020 2020  gs, kwargs).    
-00035070: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00035080: 7461 6e63 6528 7265 742c 2074 6f72 6368  tance(ret, torch
-00035090: 2e54 656e 736f 7229 3a0a 2020 2020 2020  .Tensor):.      
-000350a0: 2020 2020 2020 2020 2020 6176 6f75 6368            avouch
-000350b0: 2869 7369 6e73 7461 6e63 6528 7265 742c  (isinstance(ret,
-000350c0: 2063 6c73 292c 2052 756e 7469 6d65 4572   cls), RuntimeEr
-000350d0: 726f 7228 6622 4572 726f 7220 696e 2068  ror(f"Error in h
-000350e0: 6176 696e 6720 7265 7475 726e 2076 616c  aving return val
-000350f0: 7565 206e 6f74 206f 6620 7375 6263 6c61  ue not of subcla
-00035100: 7373 2027 7b63 6c73 2e5f 5f6e 616d 655f  ss '{cls.__name_
-00035110: 5f7d 272c 2074 6869 7320 7368 6f75 6c64  _}', this should
-00035120: 2062 6520 646f 6e65 2062 7920 5079 546f   be done by PyTo
-00035130: 7263 6820 3e3d 2031 2e36 2e20 2229 290a  rch >= 1.6. ")).
-00035140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035150: 6966 2068 6173 6174 7472 2872 6574 2c20  if hasattr(ret, 
-00035160: 2773 7a5f 6675 6e63 5f64 696d 2729 3a20  'sz_func_dim'): 
-00035170: 7265 7475 726e 2072 6574 0a20 2020 2020  return ret.     
-00035180: 2020 2020 2020 2020 2020 2072 6574 2e69             ret.i
-00035190: 6e69 745f 7370 6563 6961 6c28 290a 2020  nit_special().  
-000351a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000351b0: 2069 7369 6e73 7461 6e63 6528 7365 6c66   isinstance(self
-000351c0: 2c20 5465 6e73 6f72 2920 616e 6420 7265  , Tensor) and re
-000351d0: 742e 6e5f 6469 6d20 3d3d 2073 656c 662e  t.n_dim == self.
-000351e0: 6e5f 6469 6d3a 2072 6574 2e73 7065 6369  n_dim: ret.speci
-000351f0: 616c 5f66 726f 6d28 7365 6c66 290a 2020  al_from(self).  
-00035200: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-00035210: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00035220: 740a 2020 2020 2020 2020 2020 2020 0a20  t.            . 
-00035230: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-00035240: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-00035250: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00035260: 6622 496e 2066 756e 6374 696f 6e20 7b66  f"In function {f
-00035270: 756e 632e 5f5f 7175 616c 6e61 6d65 5f5f  unc.__qualname__
-00035280: 7d3a 2229 0a20 2020 2020 2020 2020 2020  }:").           
-00035290: 2072 6169 7365 2065 0a0a 6465 6620 6578   raise e..def ex
-000352a0: 7061 6e64 2873 656c 663a 2054 656e 736f  pand(self: Tenso
-000352b0: 722c 202a 7369 7a65 733a 2053 697a 6529  r, *sizes: Size)
-000352c0: 3a20 7265 7475 726e 2073 656c 662e 6578  : return self.ex
-000352d0: 7061 6e64 282a 7369 7a65 7329 0a64 6566  pand(*sizes).def
-000352e0: 2065 7870 616e 645f 6173 2873 656c 663a   expand_as(self:
-000352f0: 2054 656e 736f 722c 206f 7468 6572 3a20   Tensor, other: 
-00035300: 5465 6e73 6f72 293a 2072 6574 7572 6e20  Tensor): return 
-00035310: 7365 6c66 2e65 7870 616e 645f 6173 286f  self.expand_as(o
-00035320: 7468 6572 290a 6465 6620 6578 7061 6e64  ther).def expand
-00035330: 5f74 6f28 7365 6c66 3a20 5465 6e73 6f72  _to(self: Tensor
-00035340: 2c20 2a74 6172 6765 742c 2061 7373 6967  , *target, assig
-00035350: 6e5f 746f 5f64 696d 733a 2065 7869 7374  n_to_dims: exist
-00035360: 5f64 696d 3d4e 6f6e 652c 2064 696d 735f  _dim=None, dims_
-00035370: 616c 6c6f 775f 6d69 736d 6174 6368 3a20  allow_mismatch: 
-00035380: 6578 6973 745f 6469 6d3d 4e6f 6e65 293a  exist_dim=None):
-00035390: 2072 6574 7572 6e20 7365 6c66 2e65 7870   return self.exp
-000353a0: 616e 645f 746f 282a 7461 7267 6574 2c20  and_to(*target, 
-000353b0: 6173 7369 676e 5f74 6f5f 6469 6d73 3d61  assign_to_dims=a
-000353c0: 7373 6967 6e5f 746f 5f64 696d 732c 2064  ssign_to_dims, d
-000353d0: 696d 735f 616c 6c6f 775f 6d69 736d 6174  ims_allow_mismat
-000353e0: 6368 3d64 696d 735f 616c 6c6f 775f 6d69  ch=dims_allow_mi
-000353f0: 736d 6174 6368 290a 0a62 6173 6963 5f6c  smatch)..basic_l
-00035400: 6f63 616c 7320 3d20 6c69 7374 286c 6f63  ocals = list(loc
-00035410: 616c 7328 292e 6b65 7973 2829 2920 2b20  als().keys()) + 
-00035420: 5b27 6261 7369 635f 6c6f 6361 6c73 275d  ['basic_locals']
-00035430: 0a64 6566 2063 6f6d 706c 6578 2872 6561  .def complex(rea
-00035440: 6c3a 2054 656e 736f 722c 2069 6d61 673a  l: Tensor, imag:
-00035450: 2054 656e 736f 722c 202a 2c20 6f75 743d   Tensor, *, out=
-00035460: 4e6f 6e65 293a 202e 2e2e 0a64 6566 2074  None): ....def t
-00035470: 656e 736f 7228 6461 7461 2c20 2a2c 2064  ensor(data, *, d
-00035480: 7479 7065 3d4e 6f6e 652c 2064 6576 6963  type=None, devic
-00035490: 653d 4e6f 6e65 2c20 7265 7175 6972 6573  e=None, requires
-000354a0: 5f67 7261 643d 4661 6c73 652c 2070 696e  _grad=False, pin
-000354b0: 5f6d 656d 6f72 793d 4661 6c73 6529 3a20  _memory=False): 
-000354c0: 2e2e 2e0a 6465 6620 6173 5f74 656e 736f  ....def as_tenso
-000354d0: 7228 6461 7461 3a20 5465 6e73 6f72 2c20  r(data: Tensor, 
-000354e0: 6474 7970 653d 4e6f 6e65 2c20 6465 7669  dtype=None, devi
-000354f0: 6365 3d4e 6f6e 6529 3a20 2e2e 2e0a 4063  ce=None): ....@c
-00035500: 6f6c 6c65 6374 5f6d 656d 6f72 790a 6465  ollect_memory.de
-00035510: 6620 656d 7074 7928 2a73 697a 653a 2053  f empty(*size: S
-00035520: 697a 652c 206f 7574 3d4e 6f6e 652c 2064  ize, out=None, d
-00035530: 7479 7065 3d4e 6f6e 652c 206c 6179 6f75  type=None, layou
-00035540: 743d 746f 7263 682e 7374 7269 6465 642c  t=torch.strided,
-00035550: 2064 6576 6963 653d 5f64 6576 6963 652e   device=_device.
-00035560: 6d61 696e 5f64 6576 6963 652c 2072 6571  main_device, req
-00035570: 7569 7265 735f 6772 6164 3d46 616c 7365  uires_grad=False
-00035580: 2c20 7069 6e5f 6d65 6d6f 7279 3d46 616c  , pin_memory=Fal
-00035590: 7365 2c20 6d65 6d6f 7279 5f66 6f72 6d61  se, memory_forma
-000355a0: 743d 746f 7263 682e 636f 6e74 6967 756f  t=torch.contiguo
-000355b0: 7573 5f66 6f72 6d61 7429 3a20 2e2e 2e0a  us_format): ....
-000355c0: 4063 6f6c 6c65 6374 5f6d 656d 6f72 790a  @collect_memory.
-000355d0: 6465 6620 6675 6c6c 282a 7369 7a65 2c20  def full(*size, 
-000355e0: 6669 6c6c 5f76 616c 7565 3d4e 6f6e 652c  fill_value=None,
-000355f0: 206f 7574 3d4e 6f6e 652c 2064 7479 7065   out=None, dtype
-00035600: 3d4e 6f6e 652c 206c 6179 6f75 743d 746f  =None, layout=to
-00035610: 7263 682e 7374 7269 6465 642c 2064 6576  rch.strided, dev
-00035620: 6963 653d 5f64 6576 6963 652e 6d61 696e  ice=_device.main
-00035630: 5f64 6576 6963 652c 2072 6571 7569 7265  _device, require
-00035640: 735f 6772 6164 3d46 616c 7365 293a 0a20  s_grad=False):. 
-00035650: 2020 2069 6620 6c65 6e28 7369 7a65 2920     if len(size) 
-00035660: 3d3d 2032 2061 6e64 2069 7369 6e73 7461  == 2 and isinsta
-00035670: 6e63 6528 7369 7a65 5b30 5d2c 2074 7570  nce(size[0], tup
-00035680: 6c65 293a 2073 697a 652c 2066 696c 6c5f  le): size, fill_
-00035690: 7661 6c75 6520 3d20 7369 7a65 5b30 5d0a  value = size[0].
-000356a0: 2020 2020 656c 6966 206c 656e 2873 697a      elif len(siz
-000356b0: 6529 203d 3d20 3120 616e 6420 6973 696e  e) == 1 and isin
-000356c0: 7374 616e 6365 2873 697a 655b 305d 2c20  stance(size[0], 
-000356d0: 7475 706c 6529 3a20 7369 7a65 203d 2073  tuple): size = s
-000356e0: 697a 655b 305d 0a20 2020 2069 6620 6e6f  ize[0].    if no
-000356f0: 7420 6973 696e 7374 616e 6365 2873 697a  t isinstance(siz
-00035700: 652c 2053 697a 6529 3a20 7369 7a65 203d  e, Size): size =
-00035710: 2053 697a 6528 7369 7a65 290a 2020 2020   Size(size).    
-00035720: 6966 2066 696c 6c5f 7661 6c75 6520 6973  if fill_value is
-00035730: 204e 6f6e 653a 2066 696c 6c5f 7661 6c75   None: fill_valu
-00035740: 6520 3d20 300a 2020 2020 7769 7468 2074  e = 0.    with t
-00035750: 6f72 6368 2e5f 432e 4469 7361 626c 6554  orch._C.DisableT
-00035760: 6f72 6368 4675 6e63 7469 6f6e 2829 3a0a  orchFunction():.
-00035770: 2020 2020 2020 2020 7265 7320 3d20 746f          res = to
-00035780: 7263 682e 6675 6c6c 2873 697a 652c 2066  rch.full(size, f
-00035790: 696c 6c5f 7661 6c75 653d 6669 6c6c 5f76  ill_value=fill_v
-000357a0: 616c 7565 2c20 6f75 743d 6f75 742c 2064  alue, out=out, d
-000357b0: 7479 7065 3d64 7479 7065 2c20 6c61 796f  type=dtype, layo
-000357c0: 7574 3d6c 6179 6f75 742c 2064 6576 6963  ut=layout, devic
-000357d0: 653d 6465 7669 6365 2c20 7265 7175 6972  e=device, requir
-000357e0: 6573 5f67 7261 643d 7265 7175 6972 6573  es_grad=requires
-000357f0: 5f67 7261 6429 0a20 2020 2072 6574 7572  _grad).    retur
-00035800: 6e20 7265 732e 6173 5f73 7562 636c 6173  n res.as_subclas
-00035810: 7328 5465 6e73 6f72 292e 7370 6563 6961  s(Tensor).specia
-00035820: 6c5f 6672 6f6d 2873 697a 6529 0a40 636f  l_from(size).@co
-00035830: 6c6c 6563 745f 6d65 6d6f 7279 0a64 6566  llect_memory.def
-00035840: 206f 6e65 7328 2a73 697a 653a 2053 697a   ones(*size: Siz
-00035850: 652c 206f 7574 3d4e 6f6e 652c 2064 7479  e, out=None, dty
-00035860: 7065 3d4e 6f6e 652c 206c 6179 6f75 743d  pe=None, layout=
-00035870: 746f 7263 682e 7374 7269 6465 642c 2064  torch.strided, d
-00035880: 6576 6963 653d 5f64 6576 6963 652e 6d61  evice=_device.ma
-00035890: 696e 5f64 6576 6963 652c 2072 6571 7569  in_device, requi
-000358a0: 7265 735f 6772 6164 3d46 616c 7365 293a  res_grad=False):
-000358b0: 202e 2e2e 0a40 636f 6c6c 6563 745f 6d65   ....@collect_me
-000358c0: 6d6f 7279 0a64 6566 207a 6572 6f73 282a  mory.def zeros(*
-000358d0: 7369 7a65 3a20 5369 7a65 2c20 6f75 743d  size: Size, out=
-000358e0: 4e6f 6e65 2c20 6474 7970 653d 4e6f 6e65  None, dtype=None
-000358f0: 2c20 6c61 796f 7574 3d74 6f72 6368 2e73  , layout=torch.s
-00035900: 7472 6964 6564 2c20 6465 7669 6365 3d5f  trided, device=_
-00035910: 6465 7669 6365 2e6d 6169 6e5f 6465 7669  device.main_devi
-00035920: 6365 2c20 7265 7175 6972 6573 5f67 7261  ce, requires_gra
-00035930: 643d 4661 6c73 6529 3a20 2e2e 2e0a 4063  d=False): ....@c
-00035940: 6f6c 6c65 6374 5f6d 656d 6f72 790a 6465  ollect_memory.de
-00035950: 6620 656d 7074 795f 6c69 6b65 2869 6e70  f empty_like(inp
-00035960: 7574 3a20 5465 6e73 6f72 2c20 2a2c 2064  ut: Tensor, *, d
-00035970: 7479 7065 3d4e 6f6e 652c 206c 6179 6f75  type=None, layou
-00035980: 743d 4e6f 6e65 2c20 6465 7669 6365 3d5f  t=None, device=_
-00035990: 6465 7669 6365 2e6d 6169 6e5f 6465 7669  device.main_devi
-000359a0: 6365 2c20 7265 7175 6972 6573 5f67 7261  ce, requires_gra
-000359b0: 643d 4661 6c73 652c 206d 656d 6f72 795f  d=False, memory_
-000359c0: 666f 726d 6174 3d74 6f72 6368 2e70 7265  format=torch.pre
-000359d0: 7365 7276 655f 666f 726d 6174 293a 202e  serve_format): .
-000359e0: 2e2e 0a40 636f 6c6c 6563 745f 6d65 6d6f  ...@collect_memo
-000359f0: 7279 0a64 6566 2066 756c 6c5f 6c69 6b65  ry.def full_like
-00035a00: 2869 6e70 7574 3a20 5465 6e73 6f72 2c20  (input: Tensor, 
-00035a10: 6669 6c6c 5f76 616c 7565 3d30 2c20 2a2c  fill_value=0, *,
-00035a20: 2064 7479 7065 3d4e 6f6e 652c 206c 6179   dtype=None, lay
-00035a30: 6f75 743d 746f 7263 682e 7374 7269 6465  out=torch.stride
-00035a40: 642c 2064 6576 6963 653d 5f64 6576 6963  d, device=_devic
-00035a50: 652e 6d61 696e 5f64 6576 6963 652c 2072  e.main_device, r
-00035a60: 6571 7569 7265 735f 6772 6164 3d46 616c  equires_grad=Fal
-00035a70: 7365 2c20 6d65 6d6f 7279 5f66 6f72 6d61  se, memory_forma
-00035a80: 743d 746f 7263 682e 7072 6573 6572 7665  t=torch.preserve
-00035a90: 5f66 6f72 6d61 7429 3a20 2e2e 2e0a 4063  _format): ....@c
-00035aa0: 6f6c 6c65 6374 5f6d 656d 6f72 790a 6465  ollect_memory.de
-00035ab0: 6620 6f6e 6573 5f6c 696b 6528 696e 7075  f ones_like(inpu
-00035ac0: 743a 2054 656e 736f 722c 202a 2c20 6474  t: Tensor, *, dt
-00035ad0: 7970 653d 4e6f 6e65 2c20 6c61 796f 7574  ype=None, layout
-00035ae0: 3d4e 6f6e 652c 2064 6576 6963 653d 5f64  =None, device=_d
-00035af0: 6576 6963 652e 6d61 696e 5f64 6576 6963  evice.main_devic
-00035b00: 652c 2072 6571 7569 7265 735f 6772 6164  e, requires_grad
-00035b10: 3d46 616c 7365 2c20 6d65 6d6f 7279 5f66  =False, memory_f
-00035b20: 6f72 6d61 743d 746f 7263 682e 7072 6573  ormat=torch.pres
-00035b30: 6572 7665 5f66 6f72 6d61 7429 3a20 2e2e  erve_format): ..
-00035b40: 2e0a 4063 6f6c 6c65 6374 5f6d 656d 6f72  ..@collect_memor
-00035b50: 790a 6465 6620 7a65 726f 735f 6c69 6b65  y.def zeros_like
-00035b60: 2869 6e70 7574 3a20 5465 6e73 6f72 2c20  (input: Tensor, 
-00035b70: 2a2c 2064 7479 7065 3d4e 6f6e 652c 206c  *, dtype=None, l
-00035b80: 6179 6f75 743d 4e6f 6e65 2c20 6465 7669  ayout=None, devi
-00035b90: 6365 3d5f 6465 7669 6365 2e6d 6169 6e5f  ce=_device.main_
-00035ba0: 6465 7669 6365 2c20 7265 7175 6972 6573  device, requires
-00035bb0: 5f67 7261 643d 4661 6c73 652c 206d 656d  _grad=False, mem
-00035bc0: 6f72 795f 666f 726d 6174 3d74 6f72 6368  ory_format=torch
-00035bd0: 2e70 7265 7365 7276 655f 666f 726d 6174  .preserve_format
-00035be0: 293a 202e 2e2e 0a40 636f 6c6c 6563 745f  ): ....@collect_
-00035bf0: 6d65 6d6f 7279 0a64 6566 2074 656e 736f  memory.def tenso
-00035c00: 725f 6c69 6b65 2869 6e70 7574 2c20 7461  r_like(input, ta
-00035c10: 7267 6574 3a20 5465 6e73 6f72 2c20 2a2c  rget: Tensor, *,
-00035c20: 2064 7479 7065 3d4e 6f6e 652c 2064 6576   dtype=None, dev
-00035c30: 6963 653d 4e6f 6e65 2c20 7265 7175 6972  ice=None, requir
-00035c40: 6573 5f67 7261 643d 4e6f 6e65 293a 0a20  es_grad=None):. 
-00035c50: 2020 2069 6620 6474 7970 6520 6973 204e     if dtype is N
-00035c60: 6f6e 653a 2064 7479 7065 203d 2074 6172  one: dtype = tar
-00035c70: 6765 742e 6474 7970 650a 2020 2020 6966  get.dtype.    if
-00035c80: 2064 6576 6963 6520 6973 204e 6f6e 653a   device is None:
-00035c90: 2064 6576 6963 6520 3d20 7461 7267 6574   device = target
-00035ca0: 2e64 6576 6963 650a 2020 2020 6966 2072  .device.    if r
-00035cb0: 6571 7569 7265 735f 6772 6164 2069 7320  equires_grad is 
-00035cc0: 4e6f 6e65 3a20 7265 7175 6972 6573 5f67  None: requires_g
-00035cd0: 7261 6420 3d20 7461 7267 6574 2e72 6571  rad = target.req
-00035ce0: 7569 7265 735f 6772 6164 0a20 2020 2069  uires_grad.    i
-00035cf0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-00035d00: 2869 6e70 7574 2c20 746f 7263 682e 5465  (input, torch.Te
-00035d10: 6e73 6f72 293a 2069 6e70 7574 203d 2074  nsor): input = t
-00035d20: 6f72 6368 2e74 656e 736f 7228 696e 7075  orch.tensor(inpu
-00035d30: 742c 2064 7479 7065 3d64 7479 7065 2c20  t, dtype=dtype, 
-00035d40: 6465 7669 6365 3d64 6576 6963 652c 2072  device=device, r
-00035d50: 6571 7569 7265 735f 6772 6164 3d72 6571  equires_grad=req
-00035d60: 7569 7265 735f 6772 6164 290a 2020 2020  uires_grad).    
-00035d70: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-00035d80: 6528 696e 7075 742c 2054 656e 736f 7229  e(input, Tensor)
-00035d90: 3a20 696e 7075 7420 3d20 6173 5f74 656e  : input = as_ten
-00035da0: 736f 7228 696e 7075 742e 6173 5f73 7562  sor(input.as_sub
-00035db0: 636c 6173 7328 5465 6e73 6f72 292e 696e  class(Tensor).in
-00035dc0: 6974 5f73 7065 6369 616c 2829 2c20 6474  it_special(), dt
-00035dd0: 7970 653d 6474 7970 652c 2064 6576 6963  ype=dtype, devic
-00035de0: 653d 6465 7669 6365 292e 7265 7175 6972  e=device).requir
-00035df0: 6573 5f67 7261 645f 2872 6571 7569 7265  es_grad_(require
-00035e00: 735f 6772 6164 290a 2020 2020 656c 7365  s_grad).    else
-00035e10: 3a20 696e 7075 7420 3d20 6173 5f74 656e  : input = as_ten
-00035e20: 736f 7228 696e 7075 742c 2064 7479 7065  sor(input, dtype
-00035e30: 3d64 7479 7065 2c20 6465 7669 6365 3d64  =dtype, device=d
-00035e40: 6576 6963 6529 2e72 6571 7569 7265 735f  evice).requires_
-00035e50: 6772 6164 5f28 7265 7175 6972 6573 5f67  grad_(requires_g
-00035e60: 7261 6429 0a20 2020 2069 6620 696e 7075  rad).    if inpu
-00035e70: 742e 6e5f 6469 6d20 3d3d 2074 6172 6765  t.n_dim == targe
-00035e80: 742e 6e5f 6469 6d3a 2069 6e70 7574 203d  t.n_dim: input =
-00035e90: 2069 6e70 7574 2e73 7065 6369 616c 5f66   input.special_f
-00035ea0: 726f 6d28 7461 7267 6574 290a 2020 2020  rom(target).    
-00035eb0: 656c 7365 3a20 696e 7075 7420 3d20 696e  else: input = in
-00035ec0: 7075 742e 6578 7061 6e64 5f74 6f28 7461  put.expand_to(ta
-00035ed0: 7267 6574 290a 2020 2020 7265 7475 726e  rget).    return
-00035ee0: 2069 6e70 7574 0a0a 4063 6f6c 6c65 6374   input..@collect
-00035ef0: 5f6d 656d 6f72 790a 6465 6620 7261 6e64  _memory.def rand
-00035f00: 282a 7369 7a65 3a20 5369 7a65 2c20 6765  (*size: Size, ge
-00035f10: 6e65 7261 746f 723d 4e6f 6e65 2c20 6f75  nerator=None, ou
-00035f20: 743d 4e6f 6e65 2c20 6474 7970 653d 4e6f  t=None, dtype=No
-00035f30: 6e65 2c20 6c61 796f 7574 3d74 6f72 6368  ne, layout=torch
-00035f40: 2e73 7472 6964 6564 2c20 6465 7669 6365  .strided, device
-00035f50: 3d5f 6465 7669 6365 2e6d 6169 6e5f 6465  =_device.main_de
-00035f60: 7669 6365 2c20 7265 7175 6972 6573 5f67  vice, requires_g
-00035f70: 7261 643d 4661 6c73 652c 2070 696e 5f6d  rad=False, pin_m
-00035f80: 656d 6f72 793d 4661 6c73 6529 3a20 2e2e  emory=False): ..
-00035f90: 2e0a 4063 6f6c 6c65 6374 5f6d 656d 6f72  ..@collect_memor
-00035fa0: 790a 6465 6620 7261 6e64 6e28 2a73 697a  y.def randn(*siz
-00035fb0: 653a 2053 697a 652c 206f 7574 3d4e 6f6e  e: Size, out=Non
-00035fc0: 652c 2064 7479 7065 3d4e 6f6e 652c 206c  e, dtype=None, l
-00035fd0: 6179 6f75 743d 746f 7263 682e 7374 7269  ayout=torch.stri
-00035fe0: 6465 642c 2064 6576 6963 653d 5f64 6576  ded, device=_dev
-00035ff0: 6963 652e 6d61 696e 5f64 6576 6963 652c  ice.main_device,
-00036000: 2072 6571 7569 7265 735f 6772 6164 3d46   requires_grad=F
-00036010: 616c 7365 2c20 7069 6e5f 6d65 6d6f 7279  alse, pin_memory
-00036020: 3d46 616c 7365 293a 202e 2e2e 0a40 636f  =False): ....@co
-00036030: 6c6c 6563 745f 6d65 6d6f 7279 0a64 6566  llect_memory.def
-00036040: 2072 616e 645f 6c69 6b65 2869 6e70 7574   rand_like(input
-00036050: 3a20 5465 6e73 6f72 2c20 2a2c 2064 7479  : Tensor, *, dty
-00036060: 7065 3d4e 6f6e 652c 206c 6179 6f75 743d  pe=None, layout=
-00036070: 4e6f 6e65 2c20 6465 7669 6365 3d5f 6465  None, device=_de
-00036080: 7669 6365 2e6d 6169 6e5f 6465 7669 6365  vice.main_device
-00036090: 2c20 7265 7175 6972 6573 5f67 7261 643d  , requires_grad=
-000360a0: 4661 6c73 652c 206d 656d 6f72 795f 666f  False, memory_fo
-000360b0: 726d 6174 3d74 6f72 6368 2e70 7265 7365  rmat=torch.prese
-000360c0: 7276 655f 666f 726d 6174 293a 202e 2e2e  rve_format): ...
-000360d0: 0a40 636f 6c6c 6563 745f 6d65 6d6f 7279  .@collect_memory
-000360e0: 0a64 6566 2072 616e 646e 5f6c 696b 6528  .def randn_like(
-000360f0: 696e 7075 743a 2054 656e 736f 722c 202a  input: Tensor, *
-00036100: 2c20 6474 7970 653d 4e6f 6e65 2c20 6c61  , dtype=None, la
-00036110: 796f 7574 3d4e 6f6e 652c 2064 6576 6963  yout=None, devic
-00036120: 653d 5f64 6576 6963 652e 6d61 696e 5f64  e=_device.main_d
-00036130: 6576 6963 652c 2072 6571 7569 7265 735f  evice, requires_
-00036140: 6772 6164 3d46 616c 7365 2c20 6d65 6d6f  grad=False, memo
-00036150: 7279 5f66 6f72 6d61 743d 746f 7263 682e  ry_format=torch.
-00036160: 7072 6573 6572 7665 5f66 6f72 6d61 7429  preserve_format)
-00036170: 3a20 2e2e 2e0a 4063 6f6c 6c65 6374 5f6d  : ....@collect_m
-00036180: 656d 6f72 790a 6465 6620 7261 6e64 7065  emory.def randpe
-00036190: 726d 282a 6e3a 2053 697a 652c 2067 656e  rm(*n: Size, gen
-000361a0: 6572 6174 6f72 3d4e 6f6e 652c 206f 7574  erator=None, out
-000361b0: 3d4e 6f6e 652c 2064 7479 7065 3d74 6f72  =None, dtype=tor
-000361c0: 6368 2e69 6e74 3634 2c6c 6179 6f75 743d  ch.int64,layout=
-000361d0: 746f 7263 682e 7374 7269 6465 642c 2064  torch.strided, d
-000361e0: 6576 6963 653d 5f64 6576 6963 652e 6d61  evice=_device.ma
-000361f0: 696e 5f64 6576 6963 652c 2072 6571 7569  in_device, requi
-00036200: 7265 735f 6772 6164 3d46 616c 7365 2c20  res_grad=False, 
-00036210: 7069 6e5f 6d65 6d6f 7279 3d46 616c 7365  pin_memory=False
-00036220: 293a 0a20 2020 2061 766f 7563 6828 6e2e  ):.    avouch(n.
-00036230: 6e5f 7370 6163 655f 6469 6d20 3d3d 2031  n_space_dim == 1
-00036240: 2c20 5479 7065 4572 726f 7228 2227 746f  , TypeError("'to
-00036250: 7263 682e 7261 6e64 7065 726d 2720 6f6e  rch.randperm' on
-00036260: 6c79 2061 6363 6570 7473 2031 2073 7061  ly accepts 1 spa
-00036270: 6365 2064 696d 656e 7369 6f6e 2066 6f72  ce dimension for
-00036280: 2070 6572 6d75 7461 7469 6f6e 2e20 2229   permutation. ")
-00036290: 290a 2020 2020 6e5f 6261 7463 6820 3d20  ).    n_batch = 
-000362a0: 286e 2e6e 5f62 6174 6368 2069 6620 6e2e  (n.n_batch if n.
-000362b0: 6861 735f 6261 7463 6820 656c 7365 2031  has_batch else 1
-000362c0: 2920 2a20 286e 2e6e 5f66 6561 7475 7265  ) * (n.n_feature
-000362d0: 2069 6620 6e2e 6861 735f 6665 6174 7572   if n.has_featur
-000362e0: 6520 656c 7365 2031 2920 2a20 286e 2e6e  e else 1) * (n.n
-000362f0: 5f73 6571 7565 6e63 6520 6966 206e 2e68  _sequence if n.h
-00036300: 6173 5f73 6571 7565 6e63 6520 656c 7365  as_sequence else
-00036310: 2031 290a 2020 2020 7769 7468 2074 6f72   1).    with tor
-00036320: 6368 2e5f 432e 4469 7361 626c 6554 6f72  ch._C.DisableTor
-00036330: 6368 4675 6e63 7469 6f6e 2829 3a0a 2020  chFunction():.  
-00036340: 2020 2020 2020 7265 7375 6c74 203d 2073        result = s
-00036350: 7461 636b 285b 746f 7263 682e 7261 6e64  tack([torch.rand
-00036360: 7065 726d 282a 6e2e 7370 6163 652c 6765  perm(*n.space,ge
-00036370: 6e65 7261 746f 723d 6765 6e65 7261 746f  nerator=generato
-00036380: 722c 6f75 743d 6f75 742c 6474 7970 653d  r,out=out,dtype=
-00036390: 6474 7970 652c 6c61 796f 7574 3d6c 6179  dtype,layout=lay
-000363a0: 6f75 742c 6465 7669 6365 3d64 6576 6963  out,device=devic
-000363b0: 652c 7265 7175 6972 6573 5f67 7261 643d  e,requires_grad=
-000363c0: 7265 7175 6972 6573 5f67 7261 642c 7069  requires_grad,pi
-000363d0: 6e5f 6d65 6d6f 7279 3d70 696e 5f6d 656d  n_memory=pin_mem
-000363e0: 6f72 7929 2e61 735f 7375 6263 6c61 7373  ory).as_subclass
-000363f0: 2854 656e 736f 7229 2e69 6e69 745f 7370  (Tensor).init_sp
-00036400: 6563 6961 6c28 2920 666f 7220 5f20 696e  ecial() for _ in
-00036410: 2072 616e 6765 5f28 6e5f 6261 7463 6829   range_(n_batch)
-00036420: 5d2c 207b 7d29 0a20 2020 2069 6620 6e5f  ], {}).    if n_
-00036430: 6261 7463 6820 3d3d 2030 3a20 7265 7375  batch == 0: resu
-00036440: 6c74 203d 207a 6572 6f73 287b 307d 2c20  lt = zeros({0}, 
-00036450: 6e2e 7370 6163 655b 305d 292e 6c6f 6e67  n.space[0]).long
-00036460: 2829 0a20 2020 2072 6574 7572 6e20 7265  ().    return re
-00036470: 7375 6c74 2e73 706c 6974 5f64 696d 287b  sult.split_dim({
-00036480: 7d2c 206e 2e77 6974 685f 7370 6163 6528  }, n.with_space(
-00036490: 2929 2e6d 6f76 655f 6469 6d28 2d31 2c20  )).move_dim(-1, 
-000364a0: 6e2e 7370 6163 655f 7374 6172 7429 0a40  n.space_start).@
-000364b0: 636f 6c6c 6563 745f 6d65 6d6f 7279 0a64  collect_memory.d
-000364c0: 6566 2061 7261 6e67 6528 2a73 7461 7274  ef arange(*start
-000364d0: 5f73 746f 705f 7374 6570 2c20 6f75 743d  _stop_step, out=
-000364e0: 4e6f 6e65 2c20 6474 7970 653d 4e6f 6e65  None, dtype=None
-000364f0: 2c20 6c61 796f 7574 3d74 6f72 6368 2e73  , layout=torch.s
-00036500: 7472 6964 6564 2c20 6465 7669 6365 3d5f  trided, device=_
-00036510: 6465 7669 6365 2e6d 6169 6e5f 6465 7669  device.main_devi
-00036520: 6365 2c20 7265 7175 6972 6573 5f67 7261  ce, requires_gra
-00036530: 643d 4661 6c73 6529 3a0a 2020 2020 7374  d=False):.    st
-00036540: 6172 745f 7374 6f70 5f73 7465 7020 3d20  art_stop_step = 
-00036550: 5369 7a65 282a 7374 6172 745f 7374 6f70  Size(*start_stop
-00036560: 5f73 7465 7029 0a20 2020 2077 6974 6820  _step).    with 
-00036570: 746f 7263 682e 5f43 2e44 6973 6162 6c65  torch._C.Disable
-00036580: 546f 7263 6846 756e 6374 696f 6e28 293a  TorchFunction():
-00036590: 0a20 2020 2020 2020 206f 626a 203d 2074  .        obj = t
-000365a0: 6f72 6368 2e61 7261 6e67 6528 2a73 7461  orch.arange(*sta
-000365b0: 7274 5f73 746f 705f 7374 6570 2c6f 7574  rt_stop_step,out
-000365c0: 3d6f 7574 2c64 7479 7065 3d64 7479 7065  =out,dtype=dtype
-000365d0: 2c6c 6179 6f75 743d 6c61 796f 7574 2c64  ,layout=layout,d
-000365e0: 6576 6963 653d 6465 7669 6365 2c72 6571  evice=device,req
-000365f0: 7569 7265 735f 6772 6164 3d72 6571 7569  uires_grad=requi
-00036600: 7265 735f 6772 6164 290a 2020 2020 6f62  res_grad).    ob
-00036610: 6a20 3d20 6f62 6a2e 6173 5f73 7562 636c  j = obj.as_subcl
-00036620: 6173 7328 5465 6e73 6f72 292e 7370 6563  ass(Tensor).spec
-00036630: 6961 6c5f 6672 6f6d 2873 7461 7274 5f73  ial_from(start_s
-00036640: 746f 705f 7374 6570 5b3a 315d 2920 2320  top_step[:1]) # 
-00036650: 7375 7070 7265 7373 3a20 7370 6563 6961  suppress: specia
-00036660: 6c5f 6672 6f6d 0a0a 6465 6620 7768 6572  l_from..def wher
-00036670: 6528 636f 6e64 6974 696f 6e3a 2027 5465  e(condition: 'Te
-00036680: 6e73 6f72 272c 2069 6e70 7574 3a20 2754  nsor', input: 'T
-00036690: 656e 736f 7227 2c20 6f74 6865 723a 2027  ensor', other: '
-000366a0: 5465 6e73 6f72 272c 202a 2c20 6f75 743d  Tensor', *, out=
-000366b0: 4e6f 6e65 293a 202e 2e2e 0a0a 6465 6620  None): .....def 
-000366c0: 7265 7368 6170 6528 7365 6c66 2c20 2a73  reshape(self, *s
-000366d0: 697a 653a 2053 697a 6529 3a20 2e2e 2e0a  ize: Size): ....
-000366e0: 0a64 6566 2063 6174 282a 7465 6e73 6f72  .def cat(*tensor
-000366f0: 732c 2064 696d 3d4e 6f6e 652c 2063 726f  s, dim=None, cro
-00036700: 703d 4661 6c73 652c 206f 7574 3d4e 6f6e  p=False, out=Non
-00036710: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
-00036720: 436f 6e63 6174 656e 6174 6520 7465 6e73  Concatenate tens
-00036730: 6f72 7320 616c 6f6e 6720 6469 6d65 6e73  ors along dimens
-00036740: 696f 6e20 6064 696d 602e 200a 0a20 2020  ion `dim`. ..   
-00036750: 2041 7267 733a 0a20 2020 2020 2020 2064   Args:.        d
-00036760: 696d 2028 696e 742f 6578 6973 745f 6469  im (int/exist_di
-00036770: 6d2c 206f 7074 696f 6e61 6c29 3a20 5468  m, optional): Th
-00036780: 6520 6469 6d65 6e73 696f 6e20 666f 7220  e dimension for 
-00036790: 636f 6e63 6174 656e 6174 696f 6e2e 200a  concatenation. .
-000367a0: 2020 2020 2020 2020 2020 2020 4465 6661              Defa
-000367b0: 756c 7473 2074 6f20 6175 746f 2063 6f6e  ults to auto con
-000367c0: 6361 7465 6e61 7469 6f6e 2061 740a 2020  catenation at.  
-000367d0: 2020 2020 2020 2020 2020 2831 2920 7468            (1) th
-000367e0: 6520 6669 7273 7420 6665 6174 7572 6520  e first feature 
-000367f0: 6469 6d65 6e73 696f 6e20 6966 2074 656e  dimension if ten
-00036800: 736f 7273 2068 6176 6520 6665 6174 7572  sors have featur
-00036810: 653b 0a20 2020 2020 2020 2020 2020 2028  e;.            (
-00036820: 3229 2074 6865 2062 6174 6368 2064 696d  2) the batch dim
-00036830: 656e 7369 6f6e 2069 6620 7465 6e73 6f72  ension if tensor
-00036840: 7320 6861 7665 2062 6174 6368 3b0a 2020  s have batch;.  
-00036850: 2020 2020 2020 2020 2020 2833 2920 7468            (3) th
-00036860: 6520 6669 7273 7420 7365 7175 656e 6365  e first sequence
-00036870: 2064 696d 656e 7369 6f6e 2069 6620 7465   dimension if te
-00036880: 6e73 6f72 7320 6861 7665 2073 6571 7565  nsors have seque
-00036890: 6e63 653b 0a20 2020 2020 2020 2020 2020  nce;.           
-000368a0: 2028 3429 2074 6865 2066 6972 7374 2073   (4) the first s
-000368b0: 7061 6369 616c 2064 696d 656e 7369 6f6e  pacial dimension
-000368c0: 206f 7468 6572 7769 7365 2e0a 2020 2020   otherwise..    
-000368d0: 2020 2020 6372 6f70 2028 626f 6f6c 293a      crop (bool):
-000368e0: 2057 6865 7468 6572 2074 6f20 6372 6f70   Whether to crop
-000368f0: 2074 6865 2073 697a 6573 2061 7574 6f6d   the sizes autom
-00036900: 6174 6963 616c 6c79 2077 6865 6e20 6e65  atically when ne
-00036910: 6365 7373 6172 792e 200a 2020 2020 2222  cessary. .    ""
-00036920: 220a 2020 2020 6672 6f6d 202e 7465 6e73  ".    from .tens
-00036930: 6f72 6675 6e63 2069 6d70 6f72 7420 6372  orfunc import cr
-00036940: 6f70 5f61 730a 2020 2020 6966 206c 656e  op_as.    if len
-00036950: 2874 656e 736f 7273 2920 3d3d 2030 3a20  (tensors) == 0: 
-00036960: 7265 7475 726e 2074 656e 736f 7228 5b5d  return tensor([]
-00036970: 290a 2020 2020 656c 6966 206c 656e 2874  ).    elif len(t
-00036980: 656e 736f 7273 2920 3d3d 2031 2061 6e64  ensors) == 1 and
-00036990: 2069 7369 6e73 7461 6e63 6528 7465 6e73   isinstance(tens
-000369a0: 6f72 735b 305d 2c20 286c 6973 742c 2074  ors[0], (list, t
-000369b0: 7570 6c65 2929 3a20 7465 6e73 6f72 7320  uple)): tensors 
-000369c0: 3d20 7475 706c 6528 7465 6e73 6f72 735b  = tuple(tensors[
-000369d0: 305d 290a 2020 2020 656c 6966 206c 656e  0]).    elif len
-000369e0: 2874 656e 736f 7273 2920 3d3d 2032 2061  (tensors) == 2 a
-000369f0: 6e64 2069 7369 6e73 7461 6e63 6528 7465  nd isinstance(te
-00036a00: 6e73 6f72 735b 305d 2c20 286c 6973 742c  nsors[0], (list,
-00036a10: 2074 7570 6c65 2929 2061 6e64 2069 7369   tuple)) and isi
-00036a20: 6e73 7461 6e63 6528 7465 6e73 6f72 735b  nstance(tensors[
-00036a30: 315d 2c20 6578 6973 745f 6469 6d29 3a0a  1], exist_dim):.
-00036a40: 2020 2020 2020 2020 6176 6f75 6368 2864          avouch(d
-00036a50: 696d 2069 7320 4e6f 6e65 2c20 5479 7065  im is None, Type
-00036a60: 4572 726f 7228 6622 4361 6e6e 6f74 2063  Error(f"Cannot c
-00036a70: 6f6e 6361 7465 6e61 7465 2074 656e 736f  oncatenate tenso
-00036a80: 7273 2062 7920 6d75 6c74 6970 6c65 2064  rs by multiple d
-00036a90: 696d 656e 7369 6f6e 732e 2229 290a 2020  imensions.")).  
-00036aa0: 2020 2020 2020 6469 6d20 3d20 7465 6e73        dim = tens
-00036ab0: 6f72 735b 315d 0a20 2020 2020 2020 2074  ors[1].        t
-00036ac0: 656e 736f 7273 203d 2074 7570 6c65 2874  ensors = tuple(t
-00036ad0: 656e 736f 7273 5b30 5d29 0a20 2020 2065  ensors[0]).    e
-00036ae0: 6c69 6620 6c65 6e28 7465 6e73 6f72 7329  lif len(tensors)
-00036af0: 203e 2032 2061 6e64 2069 7369 6e73 7461   > 2 and isinsta
-00036b00: 6e63 6528 7465 6e73 6f72 735b 2d31 5d2c  nce(tensors[-1],
-00036b10: 2065 7869 7374 5f64 696d 293a 0a20 2020   exist_dim):.   
-00036b20: 2020 2020 2061 766f 7563 6828 6469 6d20       avouch(dim 
-00036b30: 6973 204e 6f6e 652c 2054 7970 6545 7272  is None, TypeErr
-00036b40: 6f72 2866 2243 616e 6e6f 7420 636f 6e63  or(f"Cannot conc
-00036b50: 6174 656e 6174 6520 7465 6e73 6f72 7320  atenate tensors 
-00036b60: 6279 206d 756c 7469 706c 6520 6469 6d65  by multiple dime
-00036b70: 6e73 696f 6e73 2e22 2929 0a20 2020 2020  nsions.")).     
-00036b80: 2020 2064 696d 203d 2074 656e 736f 7273     dim = tensors
-00036b90: 5b2d 315d 0a20 2020 2020 2020 2074 656e  [-1].        ten
-00036ba0: 736f 7273 203d 2074 7570 6c65 2874 656e  sors = tuple(ten
-00036bb0: 736f 7273 5b3a 2d31 5d29 0a20 2020 2061  sors[:-1]).    a
-00036bc0: 766f 7563 6828 616c 6c5f 2869 7369 6e73  vouch(all_(isins
-00036bd0: 7461 6e63 6528 782c 2074 6f72 6368 2e54  tance(x, torch.T
-00036be0: 656e 736f 7229 2066 6f72 2078 2069 6e20  ensor) for x in 
-00036bf0: 7465 6e73 6f72 7329 2c20 5479 7065 4572  tensors), TypeEr
-00036c00: 726f 7228 6622 2762 742e 6361 7427 2063  ror(f"'bt.cat' c
-00036c10: 616e 206f 6e6c 7920 636f 6e63 6174 656e  an only concaten
-00036c20: 6174 6520 746f 7263 682e 5465 6e73 6f72  ate torch.Tensor
-00036c30: 206f 626a 6563 7473 2e20 2229 290a 2020   objects. ")).  
-00036c40: 2020 6966 206c 656e 2874 656e 736f 7273    if len(tensors
-00036c50: 2920 3d3d 2030 3a20 7265 7475 726e 2074  ) == 0: return t
-00036c60: 656e 736f 7228 5b5d 290a 2020 2020 7069  ensor([]).    pi
-00036c70: 766f 7420 3d20 7465 6e73 6f72 735b 6172  vot = tensors[ar
-00036c80: 676d 6178 5f28 5b78 2e6e 5f64 696d 2066  gmax_([x.n_dim f
-00036c90: 6f72 2078 2069 6e20 7465 6e73 6f72 735d  or x in tensors]
-00036ca0: 295b 305d 5d0a 2020 2020 6966 2064 696d  )[0]].    if dim
-00036cb0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00036cc0: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
-00036cd0: 6e63 6528 7069 766f 742c 2054 656e 736f  nce(pivot, Tenso
-00036ce0: 7229 3a20 6469 6d20 3d20 2830 2c29 0a20  r): dim = (0,). 
-00036cf0: 2020 2020 2020 2065 6c69 6620 7069 766f         elif pivo
-00036d00: 742e 6861 735f 6665 6174 7572 653a 2064  t.has_feature: d
-00036d10: 696d 203d 2065 7869 7374 5f64 696d 2870  im = exist_dim(p
-00036d20: 6976 6f74 2c20 5b30 5d29 0a20 2020 2020  ivot, [0]).     
-00036d30: 2020 2065 6c69 6620 7069 766f 742e 6861     elif pivot.ha
-00036d40: 735f 6261 7463 683a 2064 696d 203d 2065  s_batch: dim = e
-00036d50: 7869 7374 5f64 696d 2870 6976 6f74 2c20  xist_dim(pivot, 
-00036d60: 7b7d 290a 2020 2020 2020 2020 656c 6966  {}).        elif
-00036d70: 2070 6976 6f74 2e68 6173 5f73 6571 7565   pivot.has_seque
-00036d80: 6e63 653a 2064 696d 203d 2065 7869 7374  nce: dim = exist
-00036d90: 5f64 696d 2870 6976 6f74 2c20 2730 2729  _dim(pivot, '0')
-00036da0: 0a20 2020 2020 2020 2065 6c73 653a 2064  .        else: d
-00036db0: 696d 203d 2028 302c 290a 2020 2020 656c  im = (0,).    el
-00036dc0: 7365 3a20 6469 6d20 3d20 6578 6973 745f  se: dim = exist_
-00036dd0: 6469 6d28 7069 766f 742c 2064 696d 290a  dim(pivot, dim).
-00036de0: 2020 2020 6176 6f75 6368 286c 656e 2864      avouch(len(d
-00036df0: 696d 2920 3d3d 2031 2c20 5479 7065 4572  im) == 1, TypeEr
-00036e00: 726f 7228 6622 4361 6e6e 6f74 2063 6f6e  ror(f"Cannot con
-00036e10: 6361 7420 7465 6e73 6f72 7320 696e 2064  cat tensors in d
-00036e20: 696d 656e 7369 6f6e 7320 7b64 696d 7d2c  imensions {dim},
-00036e30: 2070 6c65 6173 6520 666c 6174 7465 6e20   please flatten 
-00036e40: 7468 656d 2066 6972 7374 206f 7220 7573  them first or us
-00036e50: 6520 275b 305d 2720 616e 6420 2227 3027  e '[0]' and "'0'
-00036e60: 2220 746f 2073 7065 6369 6679 2074 6865  " to specify the
-00036e70: 2066 6972 7374 2066 6561 7475 7265 2f73   first feature/s
-00036e80: 6571 7565 6e63 6520 6469 6d65 6e73 696f  equence dimensio
-00036e90: 6e2e 2229 290a 2020 2020 6469 6d20 3d20  n.")).    dim = 
-00036ea0: 6469 6d5b 305d 0a20 2020 200a 2020 2020  dim[0].    .    
-00036eb0: 6966 2063 726f 703a 2064 696d 735f 616c  if crop: dims_al
-00036ec0: 6c6f 775f 6d69 736d 6174 6368 203d 2028  low_mismatch = (
-00036ed0: 6469 6d2c 2920 2b20 7475 706c 6528 7261  dim,) + tuple(ra
-00036ee0: 6e67 655f 2870 6976 6f74 2e73 7061 6365  nge_(pivot.space
-00036ef0: 5f73 7461 7274 2c20 7069 766f 742e 7370  _start, pivot.sp
-00036f00: 6163 655f 7374 6f70 2929 0a20 2020 2065  ace_stop)).    e
-00036f10: 6c73 653a 2064 696d 735f 616c 6c6f 775f  lse: dims_allow_
-00036f20: 6d69 736d 6174 6368 203d 2064 696d 0a20  mismatch = dim. 
-00036f30: 2020 2074 7279 3a20 7465 6e73 6f72 7320     try: tensors 
-00036f40: 3d20 5b78 2e65 7870 616e 645f 746f 2870  = [x.expand_to(p
-00036f50: 6976 6f74 2c20 6469 6d73 5f61 6c6c 6f77  ivot, dims_allow
-00036f60: 5f6d 6973 6d61 7463 683d 6469 6d73 5f61  _mismatch=dims_a
-00036f70: 6c6c 6f77 5f6d 6973 6d61 7463 6829 2066  llow_mismatch) f
-00036f80: 6f72 2078 2069 6e20 7465 6e73 6f72 7320  or x in tensors 
-00036f90: 6966 2078 2e6e 5f65 6c65 203e 2030 5d0a  if x.n_ele > 0].
-00036fa0: 2020 2020 6578 6365 7074 2054 7970 6545      except TypeE
-00036fb0: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
-00036fc0: 2020 2069 6620 2243 616e 6e6f 7420 6578     if "Cannot ex
-00036fd0: 7061 6e64 2074 656e 736f 7222 2069 6e20  pand tensor" in 
-00036fe0: 7374 7228 6529 206f 7220 2253 697a 6520  str(e) or "Size 
-00036ff0: 6d69 736d 6174 6368 2069 6e20 2765 7870  mismatch in 'exp
-00037000: 616e 645f 746f 2722 2069 6e20 7374 7228  and_to'" in str(
-00037010: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00037020: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
-00037030: 2254 656e 736f 7273 2063 616e 206f 6e6c  "Tensors can onl
-00037040: 7920 6265 2063 6f6e 6361 7465 6e61 7465  y be concatenate
-00037050: 6420 7768 656e 2061 6c6c 206f 6620 7468  d when all of th
-00037060: 656d 2068 6176 6520 6120 7361 6d65 2073  em have a same s
-00037070: 6861 7065 2065 7863 6570 7420 666f 7220  hape except for 
-00037080: 6f6e 6520 6469 6d65 6e73 696f 6e2e 2022  one dimension. "
-00037090: 202b 2066 2243 7572 7265 6e74 6c79 3a20   + f"Currently: 
-000370a0: 7b5b 782e 7368 6170 6520 666f 7220 7820  {[x.shape for x 
-000370b0: 696e 2074 656e 736f 7273 5d7d 2229 0a20  in tensors]}"). 
-000370c0: 2020 2020 2020 2065 6c73 653a 2072 6169         else: rai
-000370d0: 7365 2065 0a20 2020 2069 6620 6372 6f70  se e.    if crop
-000370e0: 3a20 7465 6e73 6f72 7320 3d20 5b78 2069  : tensors = [x i
-000370f0: 6620 782e 7368 6170 655b 3a64 696d 5d20  f x.shape[:dim] 
-00037100: 3d3d 2070 6976 6f74 2e73 6861 7065 5b3a  == pivot.shape[:
-00037110: 6469 6d5d 2061 6e64 2078 2e73 6861 7065  dim] and x.shape
-00037120: 5b64 696d 2b31 3a5d 203d 3d20 7069 766f  [dim+1:] == pivo
-00037130: 742e 7368 6170 655b 6469 6d2b 313a 5d20  t.shape[dim+1:] 
-00037140: 656c 7365 2063 726f 705f 6173 2878 2c20  else crop_as(x, 
-00037150: 7069 766f 742e 7370 6163 6529 2066 6f72  pivot.space) for
-00037160: 2078 2069 6e20 7465 6e73 6f72 735d 0a20   x in tensors]. 
-00037170: 2020 200a 2020 2020 6274 5f74 656e 736f     .    bt_tenso
-00037180: 7273 203d 205b 7420 666f 7220 7420 696e  rs = [t for t in
-00037190: 2074 656e 736f 7273 2069 6620 6973 696e   tensors if isin
-000371a0: 7374 616e 6365 2874 2c20 5465 6e73 6f72  stance(t, Tensor
-000371b0: 295d 0a20 2020 2077 6974 6820 746f 7263  )].    with torc
-000371c0: 682e 5f43 2e44 6973 6162 6c65 546f 7263  h._C.DisableTorc
-000371d0: 6846 756e 6374 696f 6e28 293a 0a20 2020  hFunction():.   
-000371e0: 2020 2020 2069 6620 6c65 6e28 6274 5f74       if len(bt_t
-000371f0: 656e 736f 7273 2920 3d3d 2030 3a20 7265  ensors) == 0: re
-00037200: 7475 726e 2074 6f72 6368 2e63 6174 2874  turn torch.cat(t
-00037210: 656e 736f 7273 2c20 6469 6d2c 206f 7574  ensors, dim, out
-00037220: 3d6f 7574 292e 6173 5f73 7562 636c 6173  =out).as_subclas
-00037230: 7328 5465 6e73 6f72 290a 2020 2020 2020  s(Tensor).      
-00037240: 2020 656c 7365 3a20 7265 7475 726e 2074    else: return t
-00037250: 6f72 6368 2e63 6174 2874 656e 736f 7273  orch.cat(tensors
-00037260: 2c20 6469 6d2c 206f 7574 3d6f 7574 292e  , dim, out=out).
-00037270: 6173 5f73 7562 636c 6173 7328 5465 6e73  as_subclass(Tens
-00037280: 6f72 292e 7370 6563 6961 6c5f 6672 6f6d  or).special_from
-00037290: 2862 745f 7465 6e73 6f72 735b 305d 290a  (bt_tensors[0]).
-000372a0: 0a64 6566 2073 7461 636b 282a 7465 6e73  .def stack(*tens
-000372b0: 6f72 732c 2064 696d 3d4e 6f6e 652c 2063  ors, dim=None, c
-000372c0: 726f 703d 4661 6c73 652c 206f 7574 3d4e  rop=False, out=N
-000372d0: 6f6e 6529 3a0a 2020 2020 2222 220a 2020  one):.    """.  
-000372e0: 2020 5374 6163 6b20 7465 6e73 6f72 7320    Stack tensors 
-000372f0: 616c 6f6e 6720 6120 6e65 7720 6469 6d65  along a new dime
-00037300: 6e73 696f 6e20 6064 696d 602e 200a 0a20  nsion `dim`. .. 
-00037310: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00037320: 2064 696d 2028 696e 742f 6e65 775f 6469   dim (int/new_di
-00037330: 6d2c 206f 7074 696f 6e61 6c29 3a20 5468  m, optional): Th
-00037340: 6520 6469 6d65 6e73 696f 6e20 666f 7220  e dimension for 
-00037350: 7374 6163 6b69 6e67 2e20 0a20 2020 2020  stacking. .     
-00037360: 2020 2020 2020 2044 6566 6175 6c74 7320         Defaults 
-00037370: 746f 2061 7574 6f20 7374 6163 6b20 6174  to auto stack at
-00037380: 0a20 2020 2020 2020 2020 2020 2028 3129  .            (1)
-00037390: 2061 206e 6577 2062 6174 6368 2064 696d   a new batch dim
-000373a0: 656e 7369 6f6e 2069 6620 7465 6e73 6f72  ension if tensor
-000373b0: 7320 6861 7665 206e 6f20 6261 7463 683b  s have no batch;
-000373c0: 0a20 2020 2020 2020 2020 2020 2028 3229  .            (2)
-000373d0: 2061 206e 6577 2066 6561 7475 7265 2064   a new feature d
-000373e0: 696d 656e 7369 6f6e 2069 6620 7465 6e73  imension if tens
-000373f0: 6f72 7320 6861 7665 2062 6174 6368 2064  ors have batch d
-00037400: 696d 656e 7369 6f6e 3b0a 2020 2020 2020  imension;.      
-00037410: 2020 6372 6f70 2028 626f 6f6c 293a 2057    crop (bool): W
-00037420: 6865 7468 6572 2074 6f20 6372 6f70 2074  hether to crop t
-00037430: 6865 2073 697a 6573 2061 7574 6f6d 6174  he sizes automat
-00037440: 6963 616c 6c79 2077 6865 6e20 6e65 6365  ically when nece
-00037450: 7373 6172 792e 200a 2020 2020 2222 220a  ssary. .    """.
-00037460: 2020 2020 6672 6f6d 202e 7465 6e73 6f72      from .tensor
-00037470: 6675 6e63 2069 6d70 6f72 7420 6372 6f70  func import crop
-00037480: 5f61 730a 2020 2020 6966 206c 656e 2874  _as.    if len(t
-00037490: 656e 736f 7273 2920 3d3d 2030 3a20 7265  ensors) == 0: re
-000374a0: 7475 726e 2074 656e 736f 7228 5b5d 290a  turn tensor([]).
-000374b0: 2020 2020 656c 6966 206c 656e 2874 656e      elif len(ten
-000374c0: 736f 7273 2920 3d3d 2031 2061 6e64 2069  sors) == 1 and i
-000374d0: 7369 6e73 7461 6e63 6528 7465 6e73 6f72  sinstance(tensor
-000374e0: 735b 305d 2c20 286c 6973 742c 2074 7570  s[0], (list, tup
-000374f0: 6c65 2929 3a20 7465 6e73 6f72 7320 3d20  le)): tensors = 
-00037500: 7475 706c 6528 7465 6e73 6f72 735b 305d  tuple(tensors[0]
-00037510: 290a 2020 2020 656c 6966 206c 656e 2874  ).    elif len(t
-00037520: 656e 736f 7273 2920 3d3d 2032 2061 6e64  ensors) == 2 and
-00037530: 2069 7369 6e73 7461 6e63 6528 7465 6e73   isinstance(tens
-00037540: 6f72 735b 305d 2c20 286c 6973 742c 2074  ors[0], (list, t
-00037550: 7570 6c65 2929 2061 6e64 2069 7369 6e73  uple)) and isins
-00037560: 7461 6e63 6528 7465 6e73 6f72 735b 315d  tance(tensors[1]
-00037570: 2c20 6e65 775f 6469 6d29 3a0a 2020 2020  , new_dim):.    
-00037580: 2020 2020 6176 6f75 6368 2864 696d 2069      avouch(dim i
-00037590: 7320 4e6f 6e65 2c20 5479 7065 4572 726f  s None, TypeErro
-000375a0: 7228 6622 4361 6e6e 6f74 2073 7461 636b  r(f"Cannot stack
-000375b0: 2074 656e 736f 7273 2062 7920 6d75 6c74   tensors by mult
-000375c0: 6970 6c65 2064 696d 656e 7369 6f6e 732e  iple dimensions.
-000375d0: 2229 290a 2020 2020 2020 2020 6469 6d20  ")).        dim 
-000375e0: 3d20 7465 6e73 6f72 735b 315d 0a20 2020  = tensors[1].   
-000375f0: 2020 2020 2074 656e 736f 7273 203d 2074       tensors = t
-00037600: 7570 6c65 2874 656e 736f 7273 5b30 5d29  uple(tensors[0])
-00037610: 0a20 2020 2065 6c69 6620 6c65 6e28 7465  .    elif len(te
-00037620: 6e73 6f72 7329 203e 2032 2061 6e64 2069  nsors) > 2 and i
-00037630: 7369 6e73 7461 6e63 6528 7465 6e73 6f72  sinstance(tensor
-00037640: 735b 2d31 5d2c 206e 6577 5f64 696d 293a  s[-1], new_dim):
-00037650: 0a20 2020 2020 2020 2061 766f 7563 6828  .        avouch(
-00037660: 6469 6d20 6973 204e 6f6e 652c 2054 7970  dim is None, Typ
-00037670: 6545 7272 6f72 2866 2243 616e 6e6f 7420  eError(f"Cannot 
-00037680: 7374 6163 6b20 7465 6e73 6f72 7320 6279  stack tensors by
-00037690: 206d 756c 7469 706c 6520 6469 6d65 6e73   multiple dimens
-000376a0: 696f 6e73 2e22 2929 0a20 2020 2020 2020  ions.")).       
-000376b0: 2064 696d 203d 2074 656e 736f 7273 5b2d   dim = tensors[-
-000376c0: 315d 0a20 2020 2020 2020 2074 656e 736f  1].        tenso
-000376d0: 7273 203d 2074 7570 6c65 2874 656e 736f  rs = tuple(tenso
-000376e0: 7273 5b3a 2d31 5d29 0a20 2020 2061 766f  rs[:-1]).    avo
-000376f0: 7563 6828 616c 6c5f 2869 7369 6e73 7461  uch(all_(isinsta
-00037700: 6e63 6528 782c 2074 6f72 6368 2e54 656e  nce(x, torch.Ten
-00037710: 736f 7229 2066 6f72 2078 2069 6e20 7465  sor) for x in te
-00037720: 6e73 6f72 7329 2c20 5479 7065 4572 726f  nsors), TypeErro
-00037730: 7228 6622 2762 742e 7374 6163 6b27 2063  r(f"'bt.stack' c
-00037740: 616e 206f 6e6c 7920 7374 6163 6b20 746f  an only stack to
-00037750: 7263 682e 5465 6e73 6f72 206f 626a 6563  rch.Tensor objec
-00037760: 7473 2e20 2229 290a 2020 2020 6966 206c  ts. ")).    if l
-00037770: 656e 2874 656e 736f 7273 2920 3d3d 2030  en(tensors) == 0
-00037780: 3a20 7265 7475 726e 2074 656e 736f 7228  : return tensor(
-00037790: 5b5d 290a 2020 2020 7069 766f 7420 3d20  []).    pivot = 
-000377a0: 7465 6e73 6f72 735b 6172 676d 6178 5f28  tensors[argmax_(
-000377b0: 5b78 2e6e 5f64 696d 2066 6f72 2078 2069  [x.n_dim for x i
-000377c0: 6e20 7465 6e73 6f72 735d 295b 305d 5d0a  n tensors])[0]].
-000377d0: 2020 2020 6966 2064 696d 2069 7320 4e6f      if dim is No
-000377e0: 6e65 3a0a 2020 2020 2020 2020 6966 206e  ne:.        if n
-000377f0: 6f74 2069 7369 6e73 7461 6e63 6528 7069  ot isinstance(pi
-00037800: 766f 742c 2054 656e 736f 7229 3a20 6469  vot, Tensor): di
-00037810: 6d20 3d20 6e65 775f 6469 6d28 7069 766f  m = new_dim(pivo
-00037820: 742c 207b 7d29 0a20 2020 2020 2020 2065  t, {}).        e
-00037830: 6c69 6620 6e6f 7420 7069 766f 742e 6861  lif not pivot.ha
-00037840: 735f 6261 7463 683a 2064 696d 203d 206e  s_batch: dim = n
-00037850: 6577 5f64 696d 2870 6976 6f74 2c20 7b7d  ew_dim(pivot, {}
-00037860: 290a 2020 2020 2020 2020 656c 7365 3a20  ).        else: 
-00037870: 6469 6d20 3d20 6e65 775f 6469 6d28 7069  dim = new_dim(pi
-00037880: 766f 742c 205b 7069 766f 742e 6e6f 6e5f  vot, [pivot.non_
-00037890: 6261 745f 7374 6172 745d 290a 2020 2020  bat_start]).    
-000378a0: 656c 7365 3a20 6469 6d20 3d20 6e65 775f  else: dim = new_
-000378b0: 6469 6d28 7069 766f 742c 2064 696d 290a  dim(pivot, dim).
-000378c0: 2020 2020 6176 6f75 6368 286c 656e 2864      avouch(len(d
-000378d0: 696d 2920 3d3d 2031 2c20 5479 7065 4572  im) == 1, TypeEr
-000378e0: 726f 7228 6622 4361 6e6e 6f74 2063 6f6e  ror(f"Cannot con
-000378f0: 6361 7420 7465 6e73 6f72 7320 696e 2064  cat tensors in d
-00037900: 696d 656e 7369 6f6e 7320 7b64 696d 7d2c  imensions {dim},
-00037910: 2070 6c65 6173 6520 666c 6174 7465 6e20   please flatten 
-00037920: 7468 656d 2066 6972 7374 206f 7220 7573  them first or us
-00037930: 6520 275b 305d 2720 616e 6420 2227 3027  e '[0]' and "'0'
-00037940: 2220 746f 2073 7065 6369 6679 2074 6865  " to specify the
-00037950: 2066 6972 7374 2066 6561 7475 7265 2f73   first feature/s
-00037960: 6571 7565 6e63 6520 6469 6d65 6e73 696f  equence dimensio
-00037970: 6e2e 2229 290a 2020 2020 0a20 2020 2069  n.")).    .    i
-00037980: 6620 6372 6f70 3a20 6469 6d73 5f61 6c6c  f crop: dims_all
-00037990: 6f77 5f6d 6973 6d61 7463 6820 3d20 7475  ow_mismatch = tu
-000379a0: 706c 6528 7261 6e67 655f 2870 6976 6f74  ple(range_(pivot
-000379b0: 2e73 7061 6365 5f73 7461 7274 2c20 7069  .space_start, pi
-000379c0: 766f 742e 7370 6163 655f 7374 6f70 2929  vot.space_stop))
-000379d0: 0a20 2020 2065 6c73 653a 2064 696d 735f  .    else: dims_
-000379e0: 616c 6c6f 775f 6d69 736d 6174 6368 203d  allow_mismatch =
-000379f0: 204e 6f6e 650a 2020 2020 7472 793a 2074   None.    try: t
-00037a00: 656e 736f 7273 203d 205b 782e 6578 7061  ensors = [x.expa
-00037a10: 6e64 5f74 6f28 7069 766f 742c 2064 696d  nd_to(pivot, dim
-00037a20: 735f 616c 6c6f 775f 6d69 736d 6174 6368  s_allow_mismatch
-00037a30: 3d64 696d 735f 616c 6c6f 775f 6d69 736d  =dims_allow_mism
-00037a40: 6174 6368 2920 666f 7220 7820 696e 2074  atch) for x in t
-00037a50: 656e 736f 7273 2069 6620 782e 6e5f 656c  ensors if x.n_el
-00037a60: 6520 3e20 305d 0a20 2020 2065 7863 6570  e > 0].    excep
-00037a70: 7420 5479 7065 4572 726f 7220 6173 2065  t TypeError as e
-00037a80: 3a0a 2020 2020 2020 2020 6966 2022 4361  :.        if "Ca
-00037a90: 6e6e 6f74 2065 7870 616e 6420 7465 6e73  nnot expand tens
-00037aa0: 6f72 2220 696e 2073 7472 2865 2920 6f72  or" in str(e) or
-00037ab0: 2022 5369 7a65 206d 6973 6d61 7463 6820   "Size mismatch 
-00037ac0: 696e 2027 6578 7061 6e64 5f74 6f27 2220  in 'expand_to'" 
-00037ad0: 696e 2073 7472 2865 293a 0a20 2020 2020  in str(e):.     
-00037ae0: 2020 2020 2020 2072 6169 7365 2054 7970         raise Typ
-00037af0: 6545 7272 6f72 2822 5465 6e73 6f72 7320  eError("Tensors 
-00037b00: 6361 6e20 6f6e 6c79 2062 6520 7374 6163  can only be stac
-00037b10: 6b65 6420 7768 656e 2061 6c6c 206f 6620  ked when all of 
-00037b20: 7468 656d 2068 6176 6520 6120 7361 6d65  them have a same
-00037b30: 2073 6861 7065 2e20 2220 2b20 6622 4375   shape. " + f"Cu
-00037b40: 7272 656e 746c 793a 207b 5b78 2e73 6861  rrently: {[x.sha
-00037b50: 7065 2066 6f72 2078 2069 6e20 7465 6e73  pe for x in tens
-00037b60: 6f72 735d 7d22 290a 2020 2020 2020 2020  ors]}").        
-00037b70: 656c 7365 3a20 7261 6973 6520 650a 2020  else: raise e.  
-00037b80: 2020 6966 2063 726f 703a 2074 656e 736f    if crop: tenso
-00037b90: 7273 203d 205b 7820 6966 2078 2e73 6861  rs = [x if x.sha
-00037ba0: 7065 203d 3d20 7069 766f 742e 7368 6170  pe == pivot.shap
-00037bb0: 6520 656c 7365 2063 726f 705f 6173 2878  e else crop_as(x
-00037bc0: 2c20 7069 766f 742e 7370 6163 6529 2066  , pivot.space) f
-00037bd0: 6f72 2078 2069 6e20 7465 6e73 6f72 735d  or x in tensors]
-00037be0: 0a20 2020 200a 2020 2020 6274 5f74 656e  .    .    bt_ten
-00037bf0: 736f 7273 203d 205b 7420 666f 7220 7420  sors = [t for t 
-00037c00: 696e 2074 656e 736f 7273 2069 6620 6973  in tensors if is
-00037c10: 696e 7374 616e 6365 2874 2c20 5465 6e73  instance(t, Tens
-00037c20: 6f72 295d 0a20 2020 2077 6974 6820 746f  or)].    with to
-00037c30: 7263 682e 5f43 2e44 6973 6162 6c65 546f  rch._C.DisableTo
-00037c40: 7263 6846 756e 6374 696f 6e28 293a 0a20  rchFunction():. 
-00037c50: 2020 2020 2020 2069 6620 6c65 6e28 6274         if len(bt
-00037c60: 5f74 656e 736f 7273 2920 3d3d 2030 3a20  _tensors) == 0: 
-00037c70: 7265 7475 726e 2074 6f72 6368 2e73 7461  return torch.sta
-00037c80: 636b 2874 656e 736f 7273 2c20 6469 6d5b  ck(tensors, dim[
-00037c90: 305d 2c20 6f75 743d 6f75 7429 2e61 735f  0], out=out).as_
-00037ca0: 7375 6263 6c61 7373 2854 656e 736f 7229  subclass(Tensor)
-00037cb0: 0a20 2020 2020 2020 2065 6c73 653a 2072  .        else: r
-00037cc0: 6574 7572 6e20 746f 7263 682e 7374 6163  eturn torch.stac
-00037cd0: 6b28 7465 6e73 6f72 732c 2064 696d 5b30  k(tensors, dim[0
-00037ce0: 5d2c 206f 7574 3d6f 7574 292e 6173 5f73  ], out=out).as_s
-00037cf0: 7562 636c 6173 7328 5465 6e73 6f72 292e  ubclass(Tensor).
-00037d00: 7370 6563 6961 6c5f 6672 6f6d 2864 696d  special_from(dim
-00037d10: 290a 0a64 6566 206d 6573 6867 7269 6428  )..def meshgrid(
-00037d20: 2a74 656e 736f 7273 2c20 696e 6465 7869  *tensors, indexi
-00037d30: 6e67 3a20 7374 7220 3d20 4e6f 6e65 293a  ng: str = None):
-00037d40: 0a20 2020 2022 2222 0a20 2020 2043 7265  .    """.    Cre
-00037d50: 6174 6520 7468 6520 6d65 7368 2067 7269  ate the mesh gri
-00037d60: 6420 7573 696e 6720 3144 2074 656e 736f  d using 1D tenso
-00037d70: 7273 2e20 0a0a 2020 2020 4172 6773 3a0a  rs. ..    Args:.
-00037d80: 2020 2020 2020 2020 7465 6e73 6f72 7320          tensors 
-00037d90: 2874 7570 6c65 206f 6620 5465 6e73 6f72  (tuple of Tensor
-00037da0: 7329 3a20 5468 6520 7465 6e73 6f72 7320  s): The tensors 
-00037db0: 7573 6564 2066 6f72 206d 6573 6820 6772  used for mesh gr
-00037dc0: 6964 2e20 0a20 2020 2020 2020 2020 2020  id. .           
-00037dd0: 206f 7574 7075 745b 6a5d 5b69 5f30 2c20   output[j][i_0, 
-00037de0: 2e2e 2e2c 2069 5f7b 6b2d 317d 5d20 3d20  ..., i_{k-1}] = 
-00037df0: 7465 6e73 6f72 735b 6a5d 5b69 5f7b 6a7d  tensors[j][i_{j}
-00037e00: 5d2c 0a20 2020 2020 2020 2020 2020 2065  ],.            e
-00037e10: 2e67 2e20 6f75 7470 7574 5f30 2c20 6f75  .g. output_0, ou
-00037e20: 7470 7574 5f31 203d 206d 6573 6867 7269  tput_1 = meshgri
-00037e30: 6428 6172 616e 6765 2832 292c 2061 7261  d(arange(2), ara
-00037e40: 6e67 6528 3329 2c20 696e 6465 7869 6e67  nge(3), indexing
-00037e50: 3d27 696a 2729 203d 3e0a 2020 2020 2020  ='ij') =>.      
-00037e60: 2020 2020 2020 2020 2020 6f75 7470 7574            output
-00037e70: 5f30 203d 2054 656e 736f 7228 5b5b 302c  _0 = Tensor([[0,
-00037e80: 2030 2c20 305d 2c0a 2020 2020 2020 2020   0, 0],.        
-00037e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037ea0: 2020 2020 2020 2020 2020 205b 312c 2031             [1, 1
-00037eb0: 2c20 315d 5d29 0a20 2020 2020 2020 2020  , 1]]).         
-00037ec0: 2020 2020 2020 206f 7574 7075 745f 3120         output_1 
-00037ed0: 3d20 5465 6e73 6f72 285b 5b30 2c20 312c  = Tensor([[0, 1,
-00037ee0: 2032 5d2c 0a20 2020 2020 2020 2020 2020   2],.           
-00037ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037f00: 2020 2020 2020 2020 5b30 2c20 312c 2032          [0, 1, 2
-00037f10: 5d5d 290a 2020 2020 2020 2020 696e 6465  ]]).        inde
-00037f20: 7869 6e67 2028 7374 722c 206f 7074 696f  xing (str, optio
-00037f30: 6e61 6c29 3a20 5468 6520 696e 6465 7869  nal): The indexi
-00037f40: 6e67 2063 7269 7465 7269 612e 0a20 2020  ng criteria..   
-00037f50: 2020 2020 2020 2020 2069 6e64 6578 696e           indexin
-00037f60: 6720 3d20 2769 6a27 206d 6561 6e73 2074  g = 'ij' means t
-00037f70: 6865 2069 6e64 6578 2066 6f72 2061 6e20  he index for an 
-00037f80: 656c 656d 656e 7420 676f 6573 2061 7320  element goes as 
-00037f90: 2869 5f72 6f77 2c20 6a5f 636f 6c75 6d6e  (i_row, j_column
-00037fa0: 292e 0a20 2020 2020 2020 2020 2020 2069  )..            i
-00037fb0: 6e64 6578 696e 6720 3d20 2778 7927 206d  ndexing = 'xy' m
-00037fc0: 6561 6e73 2074 6865 2069 6e64 6578 2066  eans the index f
-00037fd0: 6f72 2061 6e20 656c 656d 656e 7420 676f  or an element go
-00037fe0: 6573 2061 7320 2878 2b5f 636f 6f72 6469  es as (x+_coordi
-00037ff0: 6e61 7465 2028 696e 2063 6f6c 756d 6e29  nate (in column)
-00038000: 2c20 792d 5f63 6f6f 7264 696e 6174 6520  , y-_coordinate 
-00038010: 2869 6e20 726f 7729 292c 0a20 2020 2020  (in row)),.     
-00038020: 2020 2020 2020 2020 2020 206e 6f74 6520             note 
-00038030: 7468 6174 2079 5f63 6f6f 7264 696e 6174  that y_coordinat
-00038040: 653d 3020 666f 7220 7468 6520 6669 7273  e=0 for the firs
-00038050: 7420 726f 7720 616e 6420 696e 6372 6561  t row and increa
-00038060: 7365 7320 666f 7220 6c6f 7765 7220 726f  ses for lower ro
-00038070: 7773 2e0a 2020 2020 2020 2020 2020 2020  ws..            
-00038080: 416c 7465 7269 6e67 2069 6e64 6578 696e  Altering indexin
-00038090: 6720 6672 6f6d 2027 696a 2720 616e 6420  g from 'ij' and 
-000380a0: 2778 7927 2077 696c 6c20 7265 7375 6c74  'xy' will result
-000380b0: 2069 6e20 6120 7472 616e 7370 6f73 6520   in a transpose 
-000380c0: 6f66 2072 6573 756c 7473 2e0a 2020 2020  of results..    
-000380d0: 2020 2020 2020 2020 4465 6661 756c 7473          Defaults
-000380e0: 2074 6f20 2769 6a27 2069 6e20 5079 546f   to 'ij' in PyTo
-000380f0: 7263 6820 3c20 312e 3130 2061 6e64 2027  rch < 1.10 and '
-00038100: 7879 2720 696e 2066 7574 7572 6520 7665  xy' in future ve
-00038110: 7273 696f 6e73 2028 666f 6c6c 6f77 696e  rsions (followin
-00038120: 6720 5079 546f 7263 6829 2e0a 2020 2020  g PyTorch)..    
-00038130: 2222 220a 2020 2020 6176 6f75 6368 2861  """.    avouch(a
-00038140: 6c6c 5f28 6973 696e 7374 616e 6365 2878  ll_(isinstance(x
-00038150: 2c20 746f 7263 682e 5465 6e73 6f72 2920  , torch.Tensor) 
-00038160: 616e 6420 782e 6e64 696d 203d 3d20 3120  and x.ndim == 1 
-00038170: 666f 7220 7820 696e 2074 656e 736f 7273  for x in tensors
-00038180: 292c 2054 7970 6545 7272 6f72 2866 2227  ), TypeError(f"'
-00038190: 6274 2e6d 6573 6867 7269 6427 2063 616e  bt.meshgrid' can
-000381a0: 206f 6e6c 7920 7370 616e 2074 6f72 6368   only span torch
-000381b0: 2e54 656e 736f 7220 6f62 6a65 6374 732e  .Tensor objects.
-000381c0: 2022 2929 0a20 2020 2077 6974 6820 746f   ")).    with to
-000381d0: 7263 682e 5f43 2e44 6973 6162 6c65 546f  rch._C.DisableTo
-000381e0: 7263 6846 756e 6374 696f 6e28 293a 0a20  rchFunction():. 
-000381f0: 2020 2020 2020 2072 6574 203d 2074 7570         ret = tup
-00038200: 6c65 2874 2e61 735f 7375 6263 6c61 7373  le(t.as_subclass
-00038210: 2854 656e 736f 7229 2e69 6e69 745f 7370  (Tensor).init_sp
-00038220: 6563 6961 6c28 2920 666f 7220 7420 696e  ecial() for t in
-00038230: 2074 6f72 6368 2e6d 6573 6867 7269 6428   torch.meshgrid(
-00038240: 2a74 656e 736f 7273 2c20 696e 6465 7869  *tensors, indexi
-00038250: 6e67 3d69 6e64 6578 696e 6729 290a 2020  ng=indexing)).  
-00038260: 2020 666f 7220 692c 2074 2069 6e20 656e    for i, t in en
-00038270: 756d 6572 6174 6528 7465 6e73 6f72 7329  umerate(tensors)
-00038280: 3a0a 2020 2020 2020 2020 666f 7220 7220  :.        for r 
-00038290: 696e 2072 6574 3a20 722e 6164 645f 7370  in ret: r.add_sp
-000382a0: 6563 6961 6c5f 6469 6d28 692c 2074 2e73  ecial_dim(i, t.s
-000382b0: 6861 7065 290a 2020 2020 7265 7475 726e  hape).    return
-000382c0: 2072 6574 2023 2073 7570 7072 6573 733a   ret # suppress:
-000382d0: 2073 7065 6369 616c 5f66 726f 6d0a 0a40   special_from..@
-000382e0: 636f 6c6c 6563 745f 6d65 6d6f 7279 0a64  collect_memory.d
-000382f0: 6566 2065 7965 282a 7369 7a65 3a20 5369  ef eye(*size: Si
-00038300: 7a65 2c20 6469 6d3d 4e6f 6e65 2c20 6f75  ze, dim=None, ou
-00038310: 743d 4e6f 6e65 2c20 6474 7970 653d 4e6f  t=None, dtype=No
-00038320: 6e65 2c20 6c61 796f 7574 3d74 6f72 6368  ne, layout=torch
-00038330: 2e73 7472 6964 6564 2c20 6465 7669 6365  .strided, device
-00038340: 3d5f 6465 7669 6365 2e6d 6169 6e5f 6465  =_device.main_de
-00038350: 7669 6365 2c20 7265 7175 6972 6573 5f67  vice, requires_g
-00038360: 7261 643d 4661 6c73 6529 3a0a 2020 2020  rad=False):.    
-00038370: 2222 220a 2020 2020 6372 6561 7465 2069  """.    create i
-00038380: 6465 6e74 6974 7920 6d61 7472 6978 2069  dentity matrix i
-00038390: 6e20 2874 6865 2066 6972 7374 2061 7661  n (the first ava
-000383a0: 696c 6162 6c65 2063 6f6e 6469 7469 6f6e  ilable condition
-000383b0: 293a 0a20 2020 2028 3129 2066 6561 7475  ):.    (1) featu
-000383c0: 7265 2064 696d 656e 7369 6f6e 7320 6966  re dimensions if
-000383d0: 2073 697a 6520 6861 7320 6174 206c 6561   size has at lea
-000383e0: 7374 206f 6e65 3b20 0a20 2020 2028 3229  st one; .    (2)
-000383f0: 2073 7061 6365 2064 696d 656e 7369 6f6e   space dimension
-00038400: 7320 6966 2073 697a 6520 6861 7320 6174  s if size has at
-00038410: 206c 6561 7374 206f 6e65 3b20 0a20 2020   least one; .   
-00038420: 2028 3329 2073 6571 7565 6e63 6520 6469   (3) sequence di
-00038430: 6d65 6e73 696f 6e73 2069 6620 7369 7a65  mensions if size
-00038440: 2068 6173 2061 7420 6c65 6173 7420 6f6e   has at least on
-00038450: 652e 200a 2020 2020 2222 220a 2020 2020  e. .    """.    
-00038460: 6176 6f75 6368 286c 656e 2873 697a 6529  avouch(len(size)
-00038470: 203e 2030 2c20 5479 7065 4572 726f 7228   > 0, TypeError(
-00038480: 2262 742e 6579 6520 7265 6365 6976 6573  "bt.eye receives
-00038490: 2061 7420 6c65 6173 7420 6f6e 6520 7369   at least one si
-000384a0: 7a65 2069 6e70 7574 2e20 2229 290a 2020  ze input. ")).  
-000384b0: 2020 6966 2064 696d 2069 7320 4e6f 6e65    if dim is None
-000384c0: 3a0a 2020 2020 2020 2020 6966 2073 697a  :.        if siz
-000384d0: 652e 6861 735f 6665 6174 7572 653a 0a20  e.has_feature:. 
-000384e0: 2020 2020 2020 2020 2020 2064 696d 203d             dim =
-000384f0: 2065 7869 7374 5f64 696d 2873 697a 652c   exist_dim(size,
-00038500: 205b 5d29 0a20 2020 2020 2020 2020 2020   []).           
-00038510: 2069 6620 6c65 6e28 6469 6d29 203e 2032   if len(dim) > 2
-00038520: 3a20 6469 6d20 3d20 6469 6d5b 2d32 3a5d  : dim = dim[-2:]
-00038530: 0a20 2020 2020 2020 2065 6c69 6620 7369  .        elif si
-00038540: 7a65 2e68 6173 5f73 7061 6365 3a20 6469  ze.has_space: di
-00038550: 6d20 3d20 6578 6973 745f 6469 6d28 7369  m = exist_dim(si
-00038560: 7a65 2c20 2e2e 2e29 0a20 2020 2020 2020  ze, ...).       
-00038570: 2065 6c69 6620 7369 7a65 2e68 6173 5f73   elif size.has_s
-00038580: 6571 7565 6e63 653a 2064 696d 203d 2065  equence: dim = e
-00038590: 7869 7374 5f64 696d 2873 697a 652c 2027  xist_dim(size, '
-000385a0: 2729 0a20 2020 2020 2020 2065 6c73 653a  ').        else:
-000385b0: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
-000385c0: 2866 2249 6e76 616c 6964 2073 697a 6520  (f"Invalid size 
-000385d0: 7b73 697a 657d 2066 6f72 2062 742e 6579  {size} for bt.ey
-000385e0: 653a 2061 7420 6c65 6173 7420 6f6e 6520  e: at least one 
-000385f0: 6e6f 6e2d 6261 7463 6820 6469 6d65 6e73  non-batch dimens
-00038600: 696f 6e20 6e65 6564 6564 2e20 2229 0a20  ion needed. "). 
-00038610: 2020 2069 6620 6c65 6e28 6469 6d29 203d     if len(dim) =
-00038620: 3d20 313a 0a20 2020 2020 2020 2073 697a  = 1:.        siz
-00038630: 6520 3d20 7369 7a65 5b3a 6469 6d5b 305d  e = size[:dim[0]
-00038640: 5d20 2b20 7369 7a65 5b64 696d 5b30 5d3a  ] + size[dim[0]:
-00038650: 6469 6d5b 305d 2b31 5d20 2b20 7369 7a65  dim[0]+1] + size
-00038660: 5b64 696d 5b30 5d3a 5d0a 2020 2020 2020  [dim[0]:].      
-00038670: 2020 6469 6d20 3d20 2864 696d 5b30 5d2c    dim = (dim[0],
-00038680: 2064 696d 5b30 5d2b 3129 0a20 2020 2061   dim[0]+1).    a
-00038690: 766f 7563 6828 6c65 6e28 6469 6d29 203d  vouch(len(dim) =
-000386a0: 3d20 322c 2054 7970 6545 7272 6f72 2822  = 2, TypeError("
-000386b0: 6274 2e65 7965 2063 616e 206f 6e6c 7920  bt.eye can only 
-000386c0: 6265 2063 7265 6174 6564 2069 6e20 7477  be created in tw
-000386d0: 6f2d 6469 6d65 6e73 696f 6e61 6c20 7370  o-dimensional sp
-000386e0: 6163 652c 2070 6c65 6173 6520 6d61 6b65  ace, please make
-000386f0: 2073 7572 6520 7468 6520 7368 6170 6520   sure the shape 
-00038700: 6861 7320 3220 7370 6163 6520 6469 6d65  has 2 space dime
-00038710: 6e73 696f 6e73 206f 7220 7573 6520 6b65  nsions or use ke
-00038720: 7977 6f72 6420 6172 6775 6d65 6e74 2027  yword argument '
-00038730: 6469 6d27 2074 6f20 6964 656e 7469 6679  dim' to identify
-00038740: 2074 6865 6d2e 2022 2929 0a20 2020 200a   them. ")).    .
-00038750: 2020 2020 6b77 6172 6773 203d 2064 6963      kwargs = dic
-00038760: 7428 6f75 743d 6f75 742c 2064 7479 7065  t(out=out, dtype
-00038770: 3d64 7479 7065 2c20 6c61 796f 7574 3d6c  =dtype, layout=l
-00038780: 6179 6f75 742c 2064 6576 6963 653d 6465  ayout, device=de
-00038790: 7669 6365 2c20 7265 7175 6972 6573 5f67  vice, requires_g
-000387a0: 7261 643d 7265 7175 6972 6573 5f67 7261  rad=requires_gra
-000387b0: 6429 0a20 2020 2069 6620 6469 6d5b 305d  d).    if dim[0]
-000387c0: 203e 2064 696d 5b31 5d3a 2064 696d 203d   > dim[1]: dim =
-000387d0: 2064 696d 5b3a 3a2d 315d 0a20 2020 206e   dim[::-1].    n
-000387e0: 6577 5f73 697a 6520 3d20 7369 7a65 5b3a  ew_size = size[:
-000387f0: 6469 6d5b 315d 5d2e 7769 7468 5f64 696d  dim[1]].with_dim
-00038800: 5f73 697a 6528 6469 6d5b 305d 2c20 6d69  _size(dim[0], mi
-00038810: 6e5f 2873 697a 655b 6469 6d5b 305d 5d2c  n_(size[dim[0]],
-00038820: 2073 697a 655b 6469 6d5b 315d 5d29 2920   size[dim[1]])) 
-00038830: 2b20 7369 7a65 5b64 696d 5b31 5d2b 313a  + size[dim[1]+1:
-00038840: 5d0a 2020 2020 6579 655f 6f75 7470 7574  ].    eye_output
-00038850: 203d 206f 6e65 7328 6e65 775f 7369 7a65   = ones(new_size
-00038860: 2c20 2a2a 6b77 6172 6773 292e 6469 6167  , **kwargs).diag
-00038870: 2864 696d 3d28 6469 6d5b 305d 2c29 292e  (dim=(dim[0],)).
-00038880: 6d6f 7665 5f64 696d 2864 696d 5b30 5d2b  move_dim(dim[0]+
-00038890: 312c 2064 696d 5b31 5d29 2e73 7065 6369  1, dim[1]).speci
-000388a0: 616c 5f66 726f 6d28 7369 7a65 290a 2020  al_from(size).  
-000388b0: 2020 6966 2073 697a 655b 6469 6d5b 315d    if size[dim[1]
-000388c0: 5d20 3e20 7369 7a65 5b64 696d 5b30 5d5d  ] > size[dim[0]]
-000388d0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-000388e0: 2063 6174 2865 7965 5f6f 7574 7075 742c   cat(eye_output,
-000388f0: 207a 6572 6f73 2865 7965 5f6f 7574 7075   zeros(eye_outpu
-00038900: 742e 7368 6170 652e 7769 7468 5f64 696d  t.shape.with_dim
-00038910: 5f73 697a 6528 6469 6d5b 315d 2c20 7369  _size(dim[1], si
-00038920: 7a65 5b64 696d 5b31 5d5d 2d73 697a 655b  ze[dim[1]]-size[
-00038930: 6469 6d5b 305d 5d29 2c20 2a2a 6b77 6172  dim[0]]), **kwar
-00038940: 6773 292c 2064 696d 5b31 5d29 2e73 7065  gs), dim[1]).spe
-00038950: 6369 616c 5f66 726f 6d28 7369 7a65 290a  cial_from(size).
-00038960: 2020 2020 656c 6966 2073 697a 655b 6469      elif size[di
-00038970: 6d5b 315d 5d20 3c20 7369 7a65 5b64 696d  m[1]] < size[dim
-00038980: 5b30 5d5d 3a0a 2020 2020 2020 2020 7265  [0]]:.        re
-00038990: 7475 726e 2065 7965 5f6f 7574 7075 745b  turn eye_output[
-000389a0: 2873 6c69 6365 284e 6f6e 6529 2c29 202a  (slice(None),) *
-000389b0: 2064 696d 5b31 5d20 2b20 2873 6c69 6365   dim[1] + (slice
-000389c0: 2830 2c20 7369 7a65 5b64 696d 5b31 5d5d  (0, size[dim[1]]
-000389d0: 292c 295d 2e73 7065 6369 616c 5f66 726f  ),)].special_fro
-000389e0: 6d28 7369 7a65 290a 2020 2020 656c 7365  m(size).    else
-000389f0: 3a20 7265 7475 726e 2065 7965 5f6f 7574  : return eye_out
-00038a00: 7075 742e 7370 6563 6961 6c5f 6672 6f6d  put.special_from
-00038a10: 2873 697a 6529 0a0a 4063 6f6c 6c65 6374  (size)..@collect
-00038a20: 5f6d 656d 6f72 790a 6465 6620 6579 655f  _memory.def eye_
-00038a30: 6c69 6b65 2869 6e70 7574 3a20 5465 6e73  like(input: Tens
-00038a40: 6f72 2c20 6469 6d3d 4e6f 6e65 293a 0a20  or, dim=None):. 
-00038a50: 2020 2022 2222 0a20 2020 2063 7265 6174     """.    creat
-00038a60: 6520 6964 656e 7469 7479 206d 6174 7269  e identity matri
-00038a70: 7820 6672 6f6d 2073 6861 7065 206f 6620  x from shape of 
-00038a80: 6069 6e70 7574 6020 696e 2028 7468 6520  `input` in (the 
-00038a90: 6669 7273 7420 6176 6169 6c61 626c 6520  first available 
-00038aa0: 636f 6e64 6974 696f 6e29 3a0a 2020 2020  condition):.    
-00038ab0: 2831 2920 6665 6174 7572 6520 6469 6d65  (1) feature dime
-00038ac0: 6e73 696f 6e73 2069 6620 7369 7a65 2068  nsions if size h
-00038ad0: 6173 2061 7420 6c65 6173 7420 6f6e 653b  as at least one;
-00038ae0: 200a 2020 2020 2832 2920 7370 6163 6520   .    (2) space 
-00038af0: 6469 6d65 6e73 696f 6e73 2069 6620 7369  dimensions if si
-00038b00: 7a65 2068 6173 2061 7420 6c65 6173 7420  ze has at least 
-00038b10: 6f6e 653b 200a 2020 2020 2833 2920 7365  one; .    (3) se
-00038b20: 7175 656e 6365 2064 696d 656e 7369 6f6e  quence dimension
-00038b30: 7320 6966 2073 697a 6520 6861 7320 6174  s if size has at
-00038b40: 206c 6561 7374 206f 6e65 2e20 0a20 2020   least one. .   
-00038b50: 2022 2222 0a20 2020 2072 6574 7572 6e20   """.    return 
-00038b60: 6579 6528 696e 7075 745f 7368 6170 652c  eye(input_shape,
-00038b70: 2064 696d 3d64 696d 2c20 6474 7970 653d   dim=dim, dtype=
-00038b80: 696e 7075 742e 6474 7970 652c 2064 6576  input.dtype, dev
-00038b90: 6963 653d 696e 7075 742e 6465 7669 6365  ice=input.device
-00038ba0: 2c20 6c61 796f 7574 3d69 6e70 7574 2e6c  , layout=input.l
-00038bb0: 6179 6f75 7429 0a0a 6164 6469 7469 6f6e  ayout)..addition
-00038bc0: 616c 5f66 756e 6374 696f 6e73 203d 205b  al_functions = [
-00038bd0: 6620 666f 7220 6620 696e 206c 6f63 616c  f for f in local
-00038be0: 7328 2920 6966 2066 206e 6f74 2069 6e20  s() if f not in 
-00038bf0: 6261 7369 635f 6c6f 6361 6c73 5d0a 0a66  basic_locals]..f
-00038c00: 6f72 2066 2069 6e20 6164 6469 7469 6f6e  or f in addition
-00038c10: 616c 5f66 756e 6374 696f 6e73 202b 2062  al_functions + b
-00038c20: 6977 6179 5f66 756e 6374 696f 6e73 3a0a  iway_functions:.
-00038c30: 2020 2020 6675 6e63 5f63 6f64 6573 203d      func_codes =
-00038c40: 2067 6574 5f75 7064 6174 6564 5f63 6f64   get_updated_cod
-00038c50: 6528 6576 616c 2866 2929 0a20 2020 2065  e(eval(f)).    e
-00038c60: 7865 6362 6c6f 636b 2866 756e 635f 636f  xecblock(func_co
-00038c70: 6465 7329 0a20 2020 2069 6620 6861 7361  des).    if hasa
-00038c80: 7474 7228 746f 7263 682c 2066 293a 2074  ttr(torch, f): t
-00038c90: 6f72 6368 5f64 6f63 203d 2066 2254 6865  orch_doc = f"The
-00038ca0: 2064 6f63 756d 656e 7420 6f66 2074 6865   document of the
-00038cb0: 206f 7269 6769 6e61 6c20 6675 6e63 7469   original functi
-00038cc0: 6f6e 2069 733a 5c6e 7b67 6574 6174 7472  on is:\n{getattr
-00038cd0: 2874 6f72 6368 2c20 6629 2e5f 5f64 6f63  (torch, f).__doc
-00038ce0: 5f5f 7d22 0a20 2020 2065 6c73 653a 2074  __}".    else: t
-00038cf0: 6f72 6368 5f64 6f63 203d 2027 270a 2020  orch_doc = ''.  
-00038d00: 2020 6576 616c 2866 292e 5f5f 646f 635f    eval(f).__doc_
-00038d10: 5f20 3d20 6622 2222 4175 746f 6d61 7469  _ = f"""Automati
-00038d20: 6361 6c6c 7920 696e 6865 7269 7474 6564  cally inheritted
-00038d30: 2070 6163 6b61 6765 2066 756e 6374 696f   package functio
-00038d40: 6e20 6672 6f6d 2027 746f 7263 6827 2e20  n from 'torch'. 
-00038d50: 5468 6520 6175 746f 6d61 7469 6361 6c6c  The automaticall
-00038d60: 7920 6765 6e65 7261 7465 6420 636f 6465  y generated code
-00038d70: 7320 6172 6520 6173 2066 6f6c 6c6f 7773  s are as follows
-00038d80: 3a0a 2020 2020 2020 2020 7b61 6464 5f6c  :.        {add_l
-00038d90: 696e 656e 6f28 6675 6e63 5f63 6f64 6573  ineno(func_codes
-00038da0: 297d 0a20 2020 2020 2020 205c 6e7b 746f  )}.        \n{to
-00038db0: 7263 685f 646f 637d 0a20 2020 2022 2222  rch_doc}.    """
-00038dc0: 0a65 6c73 653a 2023 2061 6c69 6173 6573  .else: # aliases
-00038dd0: 2028 7573 656c 6573 7320 2765 6c73 6527   (useless 'else'
-00038de0: 2073 636f 7065 2066 6f72 2061 206e 6577   scope for a new
-00038df0: 2073 6563 7469 6f6e 290a 2020 2020 636f   section).    co
-00038e00: 6e63 6174 656e 6174 6520 3d20 6361 740a  ncatenate = cat.
-00038e10: 2020 2020 696e 7620 3d20 696e 7665 7273      inv = invers
-00038e20: 650a 2020 2020 7472 203d 2074 7261 6365  e.    tr = trace
-00038e30: 0a20 2020 206d 6174 7269 785f 706f 7765  .    matrix_powe
-00038e40: 7220 3d20 6d61 7470 6f77 0a20 2020 206d  r = matpow.    m
-00038e50: 6174 7269 785f 6578 7020 3d20 6d61 7465  atrix_exp = mate
-00038e60: 7870 0a20 2020 206d 6174 7269 785f 6c6f  xp.    matrix_lo
-00038e70: 6720 3d20 6d61 746c 6f67 0a20 2020 206d  g = matlog.    m
-00038e80: 6174 7269 785f 7261 6e6b 203d 2072 616e  atrix_rank = ran
-00038e90: 6b0a 2020 2020 6d61 7472 6978 5f6e 6f72  k.    matrix_nor
-00038ea0: 6d20 3d20 6d61 746e 6f72 6d0a 0a64 6566  m = matnorm..def
-00038eb0: 2074 6f5f 6274 7465 6e73 6f72 2864 6174   to_bttensor(dat
-00038ec0: 612c 202a 2c20 6474 7970 653d 4e6f 6e65  a, *, dtype=None
-00038ed0: 2c20 6465 7669 6365 3d4e 6f6e 652c 2072  , device=None, r
-00038ee0: 6571 7569 7265 735f 6772 6164 3d46 616c  equires_grad=Fal
-00038ef0: 7365 2c20 7069 6e5f 6d65 6d6f 7279 3d46  se, pin_memory=F
-00038f00: 616c 7365 293a 0a20 2020 2069 6620 6461  alse):.    if da
-00038f10: 7461 2069 7320 4e6f 6e65 3a20 7265 7475  ta is None: retu
-00038f20: 726e 0a20 2020 2065 6c69 6620 6e6f 7420  rn.    elif not 
-00038f30: 6973 696e 7374 616e 6365 2864 6174 612c  isinstance(data,
-00038f40: 2074 6f72 6368 2e54 656e 736f 7229 3a0a   torch.Tensor):.
-00038f50: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-00038f60: 656e 736f 7228 6461 7461 2c20 6474 7970  ensor(data, dtyp
-00038f70: 653d 6474 7970 652c 2064 6576 6963 653d  e=dtype, device=
-00038f80: 6465 7669 6365 2c20 7265 7175 6972 6573  device, requires
-00038f90: 5f67 7261 643d 7265 7175 6972 6573 5f67  _grad=requires_g
-00038fa0: 7261 642c 2070 696e 5f6d 656d 6f72 793d  rad, pin_memory=
-00038fb0: 7069 6e5f 6d65 6d6f 7279 290a 2020 2020  pin_memory).    
-00038fc0: 656c 6966 206e 6f74 2069 7369 6e73 7461  elif not isinsta
-00038fd0: 6e63 6528 6461 7461 2c20 5465 6e73 6f72  nce(data, Tensor
-00038fe0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00038ff0: 6e20 6461 7461 2e61 735f 7375 6263 6c61  n data.as_subcla
-00039000: 7373 2854 656e 736f 7229 2e69 6e69 745f  ss(Tensor).init_
-00039010: 7370 6563 6961 6c28 290a 2020 2020 656c  special().    el
-00039020: 7365 3a20 7265 7475 726e 2064 6174 610a  se: return data.
-00039030: 0a40 636f 6c6c 6563 745f 6d65 6d6f 7279  .@collect_memory
-00039040: 0a64 6566 2062 6174 6368 5f61 7261 6e67  .def batch_arang
-00039050: 6528 2a73 7461 7274 5f73 746f 705f 7374  e(*start_stop_st
-00039060: 6570 2c20 6f75 743d 4e6f 6e65 2c20 6474  ep, out=None, dt
-00039070: 7970 653d 4e6f 6e65 2c20 6c61 796f 7574  ype=None, layout
-00039080: 3d74 6f72 6368 2e73 7472 6964 6564 2c20  =torch.strided, 
-00039090: 6465 7669 6365 3d5f 6465 7669 6365 2e64  device=_device.d
-000390a0: 6576 6963 652c 2072 6571 7569 7265 735f  evice, requires_
-000390b0: 6772 6164 3d46 616c 7365 293a 0a20 2020  grad=False):.   
-000390c0: 2072 6574 7572 6e20 6172 616e 6765 282a   return arange(*
-000390d0: 7374 6172 745f 7374 6f70 5f73 7465 702c  start_stop_step,
-000390e0: 206f 7574 3d6f 7574 2c20 6474 7970 653d   out=out, dtype=
-000390f0: 6474 7970 652c 206c 6179 6f75 743d 6c61  dtype, layout=la
-00039100: 796f 7574 2c20 6465 7669 6365 3d64 6576  yout, device=dev
-00039110: 6963 652c 2072 6571 7569 7265 735f 6772  ice, requires_gr
-00039120: 6164 3d72 6571 7569 7265 735f 6772 6164  ad=requires_grad
-00039130: 292e 7769 7468 5f73 7a5f 6261 7463 685f  ).with_sz_batch_
-00039140: 6469 6d28 3129 0a0a 4063 6f6c 6c65 6374  dim(1)..@collect
-00039150: 5f6d 656d 6f72 790a 4061 6c69 6173 2827  _memory.@alias('
-00039160: 6368 616e 6e65 6c5f 6172 616e 6765 2729  channel_arange')
-00039170: 0a64 6566 2066 6561 7475 7265 5f61 7261  .def feature_ara
-00039180: 6e67 6528 2a73 7461 7274 5f73 746f 705f  nge(*start_stop_
-00039190: 7374 6570 2c20 6f75 743d 4e6f 6e65 2c20  step, out=None, 
-000391a0: 6474 7970 653d 4e6f 6e65 2c20 6c61 796f  dtype=None, layo
-000391b0: 7574 3d74 6f72 6368 2e73 7472 6964 6564  ut=torch.strided
-000391c0: 2c20 6465 7669 6365 3d5f 6465 7669 6365  , device=_device
-000391d0: 2e64 6576 6963 652c 2072 6571 7569 7265  .device, require
-000391e0: 735f 6772 6164 3d46 616c 7365 293a 0a20  s_grad=False):. 
-000391f0: 2020 2072 6574 7572 6e20 6172 616e 6765     return arange
-00039200: 282a 7374 6172 745f 7374 6f70 5f73 7465  (*start_stop_ste
-00039210: 702c 206f 7574 3d6f 7574 2c20 6474 7970  p, out=out, dtyp
-00039220: 653d 6474 7970 652c 206c 6179 6f75 743d  e=dtype, layout=
-00039230: 6c61 796f 7574 2c20 6465 7669 6365 3d64  layout, device=d
-00039240: 6576 6963 652c 2072 6571 7569 7265 735f  evice, requires_
-00039250: 6772 6164 3d72 6571 7569 7265 735f 6772  grad=requires_gr
-00039260: 6164 292e 7769 7468 5f73 7a5f 6665 6174  ad).with_sz_feat
-00039270: 7572 655f 6469 6d28 3129 0a0a 4063 6f6c  ure_dim(1)..@col
-00039280: 6c65 6374 5f6d 656d 6f72 790a 6465 6620  lect_memory.def 
-00039290: 7365 7175 656e 6365 5f61 7261 6e67 6528  sequence_arange(
-000392a0: 2a73 7461 7274 5f73 746f 705f 7374 6570  *start_stop_step
-000392b0: 2c20 6f75 743d 4e6f 6e65 2c20 6474 7970  , out=None, dtyp
-000392c0: 653d 4e6f 6e65 2c20 6c61 796f 7574 3d74  e=None, layout=t
-000392d0: 6f72 6368 2e73 7472 6964 6564 2c20 6465  orch.strided, de
-000392e0: 7669 6365 3d5f 6465 7669 6365 2e64 6576  vice=_device.dev
-000392f0: 6963 652c 2072 6571 7569 7265 735f 6772  ice, requires_gr
-00039300: 6164 3d46 616c 7365 293a 0a20 2020 2072  ad=False):.    r
-00039310: 6574 7572 6e20 6172 616e 6765 282a 7374  eturn arange(*st
-00039320: 6172 745f 7374 6f70 5f73 7465 702c 206f  art_stop_step, o
-00039330: 7574 3d6f 7574 2c20 6474 7970 653d 6474  ut=out, dtype=dt
-00039340: 7970 652c 206c 6179 6f75 743d 6c61 796f  ype, layout=layo
-00039350: 7574 2c20 6465 7669 6365 3d64 6576 6963  ut, device=devic
-00039360: 652c 2072 6571 7569 7265 735f 6772 6164  e, requires_grad
-00039370: 3d72 6571 7569 7265 735f 6772 6164 292e  =requires_grad).
-00039380: 7769 7468 5f73 7a5f 7365 7175 656e 6365  with_sz_sequence
-00039390: 5f64 696d 282d 3129 0a0a 6465 6620 6261  _dim(-1)..def ba
-000393a0: 7463 685f 7465 6e73 6f72 2864 6174 612c  tch_tensor(data,
-000393b0: 202a 2c20 6474 7970 653d 4e6f 6e65 2c20   *, dtype=None, 
-000393c0: 6465 7669 6365 3d5f 6465 7669 6365 2e64  device=_device.d
-000393d0: 6576 6963 652c 2072 6571 7569 7265 735f  evice, requires_
-000393e0: 6772 6164 3d46 616c 7365 2c20 7069 6e5f  grad=False, pin_
-000393f0: 6d65 6d6f 7279 3d46 616c 7365 293a 0a20  memory=False):. 
-00039400: 2020 2073 656c 6620 3d20 7465 6e73 6f72     self = tensor
-00039410: 2864 6174 612c 2064 7479 7065 3d64 7479  (data, dtype=dty
-00039420: 7065 2c20 6465 7669 6365 3d64 6576 6963  pe, device=devic
-00039430: 652c 2072 6571 7569 7265 735f 6772 6164  e, requires_grad
-00039440: 3d72 6571 7569 7265 735f 6772 6164 2c20  =requires_grad, 
-00039450: 7069 6e5f 6d65 6d6f 7279 3d70 696e 5f6d  pin_memory=pin_m
-00039460: 656d 6f72 7929 0a20 2020 2061 766f 7563  emory).    avouc
-00039470: 6828 7365 6c66 2e6e 5f64 696d 203d 3d20  h(self.n_dim == 
-00039480: 312c 2054 7970 6545 7272 6f72 2866 2243  1, TypeError(f"C
-00039490: 616e 6e6f 7420 6372 6561 7465 2027 6261  annot create 'ba
-000394a0: 7463 685f 7465 6e73 6f72 2720 6672 6f6d  tch_tensor' from
-000394b0: 207b 6461 7461 7d3a 2064 696d 656e 7369   {data}: dimensi
-000394c0: 6f6e 2069 7320 6e6f 7420 312e 2022 2929  on is not 1. "))
-000394d0: 0a20 2020 2072 6574 7572 6e20 7365 6c66  .    return self
-000394e0: 2e77 6974 685f 737a 5f62 6174 6368 5f64  .with_sz_batch_d
-000394f0: 696d 2831 290a 0a40 616c 6961 7328 2263  im(1)..@alias("c
-00039500: 6861 6e6e 656c 5f74 656e 736f 7222 2c20  hannel_tensor", 
-00039510: 6f6e 655f 6469 6d5f 6f6e 6c79 3d54 7275  one_dim_only=Tru
-00039520: 6529 0a64 6566 2066 6561 7475 7265 5f74  e).def feature_t
-00039530: 656e 736f 7228 6461 7461 2c20 2a2c 2064  ensor(data, *, d
-00039540: 7479 7065 3d4e 6f6e 652c 2064 6576 6963  type=None, devic
-00039550: 653d 5f64 6576 6963 652e 6465 7669 6365  e=_device.device
-00039560: 2c20 7265 7175 6972 6573 5f67 7261 643d  , requires_grad=
-00039570: 4661 6c73 652c 2070 696e 5f6d 656d 6f72  False, pin_memor
-00039580: 793d 4661 6c73 652c 206f 6e65 5f64 696d  y=False, one_dim
-00039590: 5f6f 6e6c 793d 4661 6c73 6529 3a0a 2020  _only=False):.  
-000395a0: 2020 7365 6c66 203d 2074 656e 736f 7228    self = tensor(
-000395b0: 6461 7461 2c20 6474 7970 653d 6474 7970  data, dtype=dtyp
-000395c0: 652c 2064 6576 6963 653d 6465 7669 6365  e, device=device
-000395d0: 2c20 7265 7175 6972 6573 5f67 7261 643d  , requires_grad=
-000395e0: 7265 7175 6972 6573 5f67 7261 642c 2070  requires_grad, p
-000395f0: 696e 5f6d 656d 6f72 793d 7069 6e5f 6d65  in_memory=pin_me
-00039600: 6d6f 7279 290a 2020 2020 6966 206f 6e65  mory).    if one
-00039610: 5f64 696d 5f6f 6e6c 793a 2061 766f 7563  _dim_only: avouc
-00039620: 6828 7365 6c66 2e6e 5f64 696d 203d 3d20  h(self.n_dim == 
-00039630: 312c 2054 7970 6545 7272 6f72 2866 2243  1, TypeError(f"C
-00039640: 616e 6e6f 7420 6372 6561 7465 2027 6368  annot create 'ch
-00039650: 616e 6e65 6c2f 6665 6174 7572 655f 7465  annel/feature_te
-00039660: 6e73 6f72 2720 6672 6f6d 207b 6461 7461  nsor' from {data
-00039670: 7d3a 2064 696d 656e 7369 6f6e 2069 7320  }: dimension is 
-00039680: 6e6f 7420 312e 2022 2929 0a20 2020 2072  not 1. ")).    r
-00039690: 6574 7572 6e20 7365 6c66 2e77 6974 685f  eturn self.with_
-000396a0: 737a 5f66 6561 7475 7265 5f64 696d 2873  sz_feature_dim(s
-000396b0: 656c 662e 6e5f 6469 6d29 0a0a 4061 6c69  elf.n_dim)..@ali
-000396c0: 6173 2822 7469 6d65 5f74 656e 736f 7222  as("time_tensor"
-000396d0: 2c20 2273 6572 6965 735f 7465 6e73 6f72  , "series_tensor
-000396e0: 2229 0a64 6566 2073 6571 7565 6e63 655f  ").def sequence_
-000396f0: 7465 6e73 6f72 2864 6174 612c 202a 2c20  tensor(data, *, 
-00039700: 6474 7970 653d 4e6f 6e65 2c20 6465 7669  dtype=None, devi
-00039710: 6365 3d5f 6465 7669 6365 2e64 6576 6963  ce=_device.devic
-00039720: 652c 2072 6571 7569 7265 735f 6772 6164  e, requires_grad
-00039730: 3d46 616c 7365 2c20 7069 6e5f 6d65 6d6f  =False, pin_memo
-00039740: 7279 3d46 616c 7365 293a 0a20 2020 2073  ry=False):.    s
-00039750: 656c 6620 3d20 7465 6e73 6f72 2864 6174  elf = tensor(dat
-00039760: 612c 2064 7479 7065 3d64 7479 7065 2c20  a, dtype=dtype, 
-00039770: 6465 7669 6365 3d64 6576 6963 652c 2072  device=device, r
-00039780: 6571 7569 7265 735f 6772 6164 3d72 6571  equires_grad=req
-00039790: 7569 7265 735f 6772 6164 2c20 7069 6e5f  uires_grad, pin_
-000397a0: 6d65 6d6f 7279 3d70 696e 5f6d 656d 6f72  memory=pin_memor
-000397b0: 7929 0a20 2020 2072 6574 7572 6e20 7365  y).    return se
-000397c0: 6c66 2e77 6974 685f 737a 5f73 6571 7565  lf.with_sz_seque
-000397d0: 6e63 655f 6469 6d28 2d73 656c 662e 6e5f  nce_dim(-self.n_
-000397e0: 6469 6d29 0a0a 636c 6173 7320 5f52 616e  dim)..class _Ran
-000397f0: 6469 6e74 3a0a 0a20 2020 2064 6566 205f  dint:..    def _
-00039800: 5f69 6e69 745f 5f28 7365 6c66 293a 0a20  _init__(self):. 
-00039810: 2020 2020 2020 2022 2222 506c 6561 7365         """Please
-00039820: 2075 7365 2072 616e 6469 6e74 5b6c 6f77   use randint[low
-00039830: 6572 2c20 7570 7065 725d 2074 6f20 7370  er, upper] to sp
-00039840: 6563 6966 7920 7468 6520 7261 6e67 6520  ecify the range 
-00039850: 7769 7468 2075 7070 6572 2065 6e64 2065  with upper end e
-00039860: 7863 6c75 6465 642e 2022 2222 0a20 2020  xcluded. """.   
-00039870: 2020 2020 2073 656c 662e 7261 6e67 6520       self.range 
-00039880: 3d20 2830 2c20 3229 0a0a 2020 2020 6465  = (0, 2)..    de
-00039890: 6620 5f5f 6765 7469 7465 6d5f 5f28 7365  f __getitem__(se
-000398a0: 6c66 2c20 2a74 293a 0a20 2020 2020 2020  lf, *t):.       
-000398b0: 2069 6620 6c65 6e28 7429 203d 3d20 3120   if len(t) == 1 
-000398c0: 616e 6420 6973 696e 7374 616e 6365 2874  and isinstance(t
-000398d0: 5b30 5d2c 2073 6c69 6365 293a 0a20 2020  [0], slice):.   
-000398e0: 2020 2020 2020 2020 2074 203d 2074 5b30           t = t[0
-000398f0: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-00039900: 2074 2e73 7465 7020 6973 206e 6f74 204e   t.step is not N
-00039910: 6f6e 653a 2072 6169 7365 2054 7970 6545  one: raise TypeE
-00039920: 7272 6f72 2866 2250 6c65 6173 6520 7573  rror(f"Please us
-00039930: 6520 7261 6e64 696e 745f 6c69 6b65 5b6c  e randint_like[l
-00039940: 6f77 6572 3a75 7070 6572 5d20 746f 2073  ower:upper] to s
-00039950: 7065 6369 6679 2074 6865 2072 616e 6765  pecify the range
-00039960: 2077 6974 6820 7570 7065 7220 656e 6420   with upper end 
-00039970: 6578 636c 7564 6564 2e20 2229 0a20 2020  excluded. ").   
-00039980: 2020 2020 2020 2020 2074 203d 2028 742e           t = (t.
-00039990: 7374 6172 7420 6966 2074 2e73 7461 7274  start if t.start
-000399a0: 2069 7320 4e6f 6e65 2065 6c73 6520 302c   is None else 0,
-000399b0: 2074 2e73 746f 7020 6966 2074 2e73 746f   t.stop if t.sto
-000399c0: 7020 6973 206e 6f74 204e 6f6e 6520 656c  p is not None el
-000399d0: 7365 2032 290a 2020 2020 2020 2020 656c  se 2).        el
-000399e0: 6966 206c 656e 2874 2920 3d3d 2031 2061  if len(t) == 1 a
-000399f0: 6e64 2069 7369 6e73 7461 6e63 6528 745b  nd isinstance(t[
-00039a00: 305d 2c20 7475 706c 6529 3a20 7420 3d20  0], tuple): t = 
-00039a10: 745b 305d 0a20 2020 2020 2020 2069 6620  t[0].        if 
-00039a20: 6c65 6e28 7429 203d 3d20 303a 2074 203d  len(t) == 0: t =
-00039a30: 2028 302c 2032 290a 2020 2020 2020 2020   (0, 2).        
-00039a40: 656c 6966 206c 656e 2874 2920 3d3d 2031  elif len(t) == 1
-00039a50: 3a20 7420 3d20 2830 2c20 745b 305d 290a  : t = (0, t[0]).
-00039a60: 2020 2020 2020 2020 6966 206c 656e 2874          if len(t
-00039a70: 2920 3e20 3220 6f72 2074 5b30 5d20 3e3d  ) > 2 or t[0] >=
-00039a80: 2074 5b31 5d3a 2072 6169 7365 2054 7970   t[1]: raise Typ
-00039a90: 6545 7272 6f72 2866 2250 6c65 6173 6520  eError(f"Please 
-00039aa0: 7573 6520 7261 6e64 696e 745f 6c69 6b65  use randint_like
-00039ab0: 5b6c 6f77 6572 2c20 7570 7065 725d 2074  [lower, upper] t
-00039ac0: 6f20 7370 6563 6966 7920 7468 6520 7261  o specify the ra
-00039ad0: 6e67 6520 7769 7468 2075 7070 6572 2065  nge with upper e
-00039ae0: 6e64 2065 7863 6c75 6465 642e 2022 290a  nd excluded. ").
-00039af0: 2020 2020 2020 2020 7365 6c66 2e72 616e          self.ran
-00039b00: 6765 203d 2074 0a20 2020 2020 2020 2072  ge = t.        r
-00039b10: 6574 7572 6e20 7365 6c66 0a0a 2020 2020  eturn self..    
-00039b20: 6465 6620 5f5f 6361 6c6c 5f5f 2873 656c  def __call__(sel
-00039b30: 662c 202a 7369 7a65 2c20 6765 6e65 7261  f, *size, genera
-00039b40: 746f 723d 4e6f 6e65 2c20 6474 7970 653d  tor=None, dtype=
-00039b50: 4e6f 6e65 2c20 6465 7669 6365 3d4e 6f6e  None, device=Non
-00039b60: 652c 2072 6571 7569 7265 735f 6772 6164  e, requires_grad
-00039b70: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
-00039b80: 2069 6620 6c65 6e28 7369 7a65 2920 3c3d   if len(size) <=
-00039b90: 2033 2061 6e64 2069 7369 6e73 7461 6e63   3 and isinstanc
-00039ba0: 6528 7369 7a65 5b2d 315d 2c20 7475 706c  e(size[-1], tupl
-00039bb0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00039bc0: 2a74 2c20 7369 7a65 203d 2073 697a 650a  *t, size = size.
-00039bd0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-00039be0: 656e 2874 2920 3d3d 2030 3a20 7420 3d20  en(t) == 0: t = 
-00039bf0: 2830 2c20 3229 0a20 2020 2020 2020 2020  (0, 2).         
-00039c00: 2020 2065 6c69 6620 6c65 6e28 7429 203d     elif len(t) =
-00039c10: 3d20 313a 2074 203d 2028 302c 2074 5b30  = 1: t = (0, t[0
-00039c20: 5d29 0a20 2020 2020 2020 2020 2020 2065  ]).            e
-00039c30: 6c69 6620 6c65 6e28 7429 203e 2032 3a20  lif len(t) > 2: 
-00039c40: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
-00039c50: 6622 506c 6561 7365 2075 7365 2072 616e  f"Please use ran
-00039c60: 6469 6e74 5b6c 6f77 6572 2c20 7570 7065  dint[lower, uppe
-00039c70: 725d 2074 6f20 7370 6563 6966 7920 7468  r] to specify th
-00039c80: 6520 7261 6e67 6520 7769 7468 2075 7070  e range with upp
-00039c90: 6572 2065 6e64 2065 7863 6c75 6465 642e  er end excluded.
-00039ca0: 2022 290a 2020 2020 2020 2020 2020 2020   ").            
-00039cb0: 7365 6c66 2e72 616e 6765 203d 2074 0a20  self.range = t. 
-00039cc0: 2020 2020 2020 2073 697a 6520 3d20 5369         size = Si
-00039cd0: 7a65 282a 7369 7a65 290a 2020 2020 2020  ze(*size).      
-00039ce0: 2020 7769 7468 2074 6f72 6368 2e5f 432e    with torch._C.
-00039cf0: 4469 7361 626c 6554 6f72 6368 4675 6e63  DisableTorchFunc
-00039d00: 7469 6f6e 2829 3a0a 2020 2020 2020 2020  tion():.        
-00039d10: 2020 2020 7265 7475 726e 2074 6f72 6368      return torch
-00039d20: 2e72 616e 6469 6e74 2873 656c 662e 7261  .randint(self.ra
-00039d30: 6e67 655b 305d 2c20 7365 6c66 2e72 616e  nge[0], self.ran
-00039d40: 6765 5b31 5d2c 2073 697a 652c 2067 656e  ge[1], size, gen
-00039d50: 6572 6174 6f72 3d67 656e 6572 6174 6f72  erator=generator
-00039d60: 2c20 6474 7970 653d 6474 7970 652c 2064  , dtype=dtype, d
-00039d70: 6576 6963 653d 6465 7669 6365 2c20 7265  evice=device, re
-00039d80: 7175 6972 6573 5f67 7261 643d 7265 7175  quires_grad=requ
-00039d90: 6972 6573 5f67 7261 6429 2e61 735f 7375  ires_grad).as_su
-00039da0: 6263 6c61 7373 2854 656e 736f 7229 2e73  bclass(Tensor).s
-00039db0: 7065 6369 616c 5f66 726f 6d28 7369 7a65  pecial_from(size
-00039dc0: 290a 0a63 6c61 7373 205f 5261 6e64 696e  )..class _Randin
-00039dd0: 745f 6c69 6b65 3a0a 0a20 2020 2064 6566  t_like:..    def
-00039de0: 205f 5f69 6e69 745f 5f28 7365 6c66 293a   __init__(self):
-00039df0: 0a20 2020 2020 2020 2022 2222 506c 6561  .        """Plea
-00039e00: 7365 2075 7365 2072 616e 6469 6e74 5f6c  se use randint_l
-00039e10: 696b 655b 6c6f 7765 722c 2075 7070 6572  ike[lower, upper
-00039e20: 5d20 746f 2073 7065 6369 6679 2074 6865  ] to specify the
-00039e30: 2072 616e 6765 2077 6974 6820 7570 7065   range with uppe
-00039e40: 7220 656e 6420 6578 636c 7564 6564 2e20  r end excluded. 
-00039e50: 2222 220a 2020 2020 2020 2020 7365 6c66  """.        self
-00039e60: 2e72 616e 6765 203d 2028 302c 2032 290a  .range = (0, 2).
-00039e70: 0a20 2020 2064 6566 205f 5f67 6574 6974  .    def __getit
-00039e80: 656d 5f5f 2873 656c 662c 202a 7429 3a0a  em__(self, *t):.
-00039e90: 2020 2020 2020 2020 6966 206c 656e 2874          if len(t
-00039ea0: 2920 3d3d 2031 2061 6e64 2069 7369 6e73  ) == 1 and isins
-00039eb0: 7461 6e63 6528 745b 305d 2c20 736c 6963  tance(t[0], slic
-00039ec0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00039ed0: 7420 3d20 745b 305d 0a20 2020 2020 2020  t = t[0].       
-00039ee0: 2020 2020 2069 6620 742e 7374 6570 2069       if t.step i
-00039ef0: 7320 6e6f 7420 4e6f 6e65 3a20 7261 6973  s not None: rais
-00039f00: 6520 5479 7065 4572 726f 7228 6622 506c  e TypeError(f"Pl
-00039f10: 6561 7365 2075 7365 2072 616e 6469 6e74  ease use randint
-00039f20: 5f6c 696b 655b 6c6f 7765 723a 7570 7065  _like[lower:uppe
-00039f30: 725d 2074 6f20 7370 6563 6966 7920 7468  r] to specify th
-00039f40: 6520 7261 6e67 6520 7769 7468 2075 7070  e range with upp
-00039f50: 6572 2065 6e64 2065 7863 6c75 6465 642e  er end excluded.
-00039f60: 2022 290a 2020 2020 2020 2020 2020 2020   ").            
-00039f70: 7420 3d20 2874 2e73 7461 7274 2069 6620  t = (t.start if 
-00039f80: 742e 7374 6172 7420 6973 204e 6f6e 6520  t.start is None 
-00039f90: 656c 7365 2030 2c20 742e 7374 6f70 2069  else 0, t.stop i
-00039fa0: 6620 742e 7374 6f70 2069 7320 6e6f 7420  f t.stop is not 
-00039fb0: 4e6f 6e65 2065 6c73 6520 3229 0a20 2020  None else 2).   
-00039fc0: 2020 2020 2065 6c69 6620 6c65 6e28 7429       elif len(t)
-00039fd0: 203d 3d20 3120 616e 6420 6973 696e 7374   == 1 and isinst
-00039fe0: 616e 6365 2874 5b30 5d2c 2074 7570 6c65  ance(t[0], tuple
-00039ff0: 293a 2074 203d 2074 5b30 5d0a 2020 2020  ): t = t[0].    
-0003a000: 2020 2020 6966 206c 656e 2874 2920 3d3d      if len(t) ==
-0003a010: 2030 3a20 7420 3d20 2830 2c20 3229 0a20   0: t = (0, 2). 
-0003a020: 2020 2020 2020 2065 6c69 6620 6c65 6e28         elif len(
-0003a030: 7429 203d 3d20 313a 2074 203d 2028 302c  t) == 1: t = (0,
-0003a040: 2074 5b30 5d29 0a20 2020 2020 2020 2069   t[0]).        i
-0003a050: 6620 6c65 6e28 7429 203e 2032 206f 7220  f len(t) > 2 or 
-0003a060: 745b 305d 203e 3d20 745b 315d 3a20 7261  t[0] >= t[1]: ra
-0003a070: 6973 6520 5479 7065 4572 726f 7228 6622  ise TypeError(f"
-0003a080: 506c 6561 7365 2075 7365 2072 616e 6469  Please use randi
-0003a090: 6e74 5f6c 696b 655b 6c6f 7765 722c 2075  nt_like[lower, u
-0003a0a0: 7070 6572 5d20 746f 2073 7065 6369 6679  pper] to specify
-0003a0b0: 2074 6865 2072 616e 6765 2077 6974 6820   the range with 
-0003a0c0: 7570 7065 7220 656e 6420 6578 636c 7564  upper end exclud
-0003a0d0: 6564 2e20 2229 0a20 2020 2020 2020 2073  ed. ").        s
-0003a0e0: 656c 662e 7261 6e67 6520 3d20 740a 2020  elf.range = t.  
-0003a0f0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0003a100: 660a 0a20 2020 2064 6566 205f 5f63 616c  f..    def __cal
-0003a110: 6c5f 5f28 7365 6c66 2c20 6461 7461 2c20  l__(self, data, 
-0003a120: 2a74 2c20 6d65 6d6f 7279 5f66 6f72 6d61  *t, memory_forma
-0003a130: 743d 4e6f 6e65 2c20 6474 7970 653d 4e6f  t=None, dtype=No
-0003a140: 6e65 2c20 6c61 796f 7574 3d4e 6f6e 652c  ne, layout=None,
-0003a150: 2064 6576 6963 653d 4e6f 6e65 2c20 7069   device=None, pi
-0003a160: 6e5f 6d65 6d6f 7279 3d46 616c 7365 2c20  n_memory=False, 
-0003a170: 7265 7175 6972 6573 5f67 7261 643d 4661  requires_grad=Fa
-0003a180: 6c73 6529 3a0a 2020 2020 2020 2020 6966  lse):.        if
-0003a190: 2030 203c 206c 656e 2874 2920 3c3d 2032   0 < len(t) <= 2
-0003a1a0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0003a1b0: 206c 656e 2874 2920 3d3d 2031 3a20 7420   len(t) == 1: t 
-0003a1c0: 3d20 2830 2c20 745b 305d 290a 2020 2020  = (0, t[0]).    
-0003a1d0: 2020 2020 2020 2020 656c 6966 206c 656e          elif len
-0003a1e0: 2874 2920 3e20 323a 2072 6169 7365 2054  (t) > 2: raise T
-0003a1f0: 7970 6545 7272 6f72 2866 2250 6c65 6173  ypeError(f"Pleas
-0003a200: 6520 7573 6520 7261 6e64 696e 745b 6c6f  e use randint[lo
-0003a210: 7765 722c 2075 7070 6572 5d20 746f 2073  wer, upper] to s
-0003a220: 7065 6369 6679 2074 6865 2072 616e 6765  pecify the range
-0003a230: 2077 6974 6820 7570 7065 7220 656e 6420   with upper end 
-0003a240: 6578 636c 7564 6564 2e20 2229 0a20 2020  excluded. ").   
-0003a250: 2020 2020 2020 2020 2073 656c 662e 7261           self.ra
-0003a260: 6e67 6520 3d20 740a 2020 2020 2020 2020  nge = t.        
-0003a270: 7769 7468 2074 6f72 6368 2e5f 432e 4469  with torch._C.Di
-0003a280: 7361 626c 6554 6f72 6368 4675 6e63 7469  sableTorchFuncti
-0003a290: 6f6e 2829 3a0a 2020 2020 2020 2020 2020  on():.          
-0003a2a0: 2020 6966 206c 6179 6f75 7420 6973 204e    if layout is N
-0003a2b0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0003a2c0: 2020 2020 2072 6574 7572 6e20 746f 7263       return torc
-0003a2d0: 682e 7261 6e64 696e 745f 6c69 6b65 2864  h.randint_like(d
-0003a2e0: 6174 612c 2073 656c 662e 7261 6e67 655b  ata, self.range[
-0003a2f0: 305d 2c20 7365 6c66 2e72 616e 6765 5b31  0], self.range[1
-0003a300: 5d2c 206d 656d 6f72 795f 666f 726d 6174  ], memory_format
-0003a310: 3d6d 656d 6f72 795f 666f 726d 6174 2c20  =memory_format, 
-0003a320: 6474 7970 653d 6474 7970 652c 2064 6576  dtype=dtype, dev
-0003a330: 6963 653d 6465 7669 6365 2c20 7069 6e5f  ice=device, pin_
-0003a340: 6d65 6d6f 7279 3d70 696e 5f6d 656d 6f72  memory=pin_memor
-0003a350: 792c 2072 6571 7569 7265 735f 6772 6164  y, requires_grad
-0003a360: 3d72 6571 7569 7265 735f 6772 6164 292e  =requires_grad).
-0003a370: 6173 5f73 7562 636c 6173 7328 5465 6e73  as_subclass(Tens
-0003a380: 6f72 292e 7370 6563 6961 6c5f 6672 6f6d  or).special_from
-0003a390: 2864 6174 612e 7368 6170 6529 0a20 2020  (data.shape).   
-0003a3a0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0003a3b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0003a3c0: 6574 7572 6e20 746f 7263 682e 7261 6e64  eturn torch.rand
-0003a3d0: 696e 745f 6c69 6b65 2864 6174 612c 2073  int_like(data, s
-0003a3e0: 656c 662e 7261 6e67 655b 305d 2c20 7365  elf.range[0], se
-0003a3f0: 6c66 2e72 616e 6765 5b31 5d2c 206d 656d  lf.range[1], mem
-0003a400: 6f72 795f 666f 726d 6174 3d6d 656d 6f72  ory_format=memor
-0003a410: 795f 666f 726d 6174 2c20 6474 7970 653d  y_format, dtype=
-0003a420: 6474 7970 652c 206c 6179 6f75 743d 6c61  dtype, layout=la
-0003a430: 796f 7574 2c20 6465 7669 6365 3d64 6576  yout, device=dev
-0003a440: 6963 652c 2070 696e 5f6d 656d 6f72 793d  ice, pin_memory=
-0003a450: 7069 6e5f 6d65 6d6f 7279 2c20 7265 7175  pin_memory, requ
-0003a460: 6972 6573 5f67 7261 643d 7265 7175 6972  ires_grad=requir
-0003a470: 6573 5f67 7261 6429 2e61 735f 7375 6263  es_grad).as_subc
-0003a480: 6c61 7373 2854 656e 736f 7229 2e73 7065  lass(Tensor).spe
-0003a490: 6369 616c 5f66 726f 6d28 6461 7461 2e73  cial_from(data.s
-0003a4a0: 6861 7065 290a 0a72 616e 6469 6e74 203d  hape)..randint =
-0003a4b0: 205f 5261 6e64 696e 7428 290a 7261 6e64   _Randint().rand
-0003a4c0: 696e 745f 6c69 6b65 203d 205f 5261 6e64  int_like = _Rand
-0003a4d0: 696e 745f 6c69 6b65 2829 0a0a 2323 2323  int_like()..####
-0003a4e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0003a4f0: 2323 2323 2323 0a23 2320 2044 6972 6563  ######.##  Direc
-0003a500: 7420 696e 6865 7269 7461 6e63 6520 2023  t inheritance  #
-0003a510: 230a 2323 2323 2323 2323 2323 2323 2323  #.##############
-0003a520: 2323 2323 2323 2323 2323 2323 0a0a 6474  ############..dt
-0003a530: 7970 6520 3d20 746f 7263 682e 6474 7970  ype = torch.dtyp
-0003a540: 653b 2020 2020 2020 2020 2020 2020 2020  e;              
-0003a550: 6465 7669 6365 203d 2074 6f72 6368 2e64  device = torch.d
-0003a560: 6576 6963 650a 0a23 2044 2d54 7970 6573  evice..# D-Types
-0003a570: 0a62 666c 6f61 7431 3620 3d20 746f 7263  .bfloat16 = torc
-0003a580: 682e 6266 6c6f 6174 3136 3b20 2020 2020  h.bfloat16;     
-0003a590: 2020 2062 6f6f 6c20 3d20 746f 7263 682e     bool = torch.
-0003a5a0: 626f 6f6c 0a63 646f 7562 6c65 203d 2074  bool.cdouble = t
-0003a5b0: 6f72 6368 2e63 646f 7562 6c65 3b20 2020  orch.cdouble;   
-0003a5c0: 2020 2020 2020 2063 666c 6f61 7420 3d20         cfloat = 
-0003a5d0: 746f 7263 682e 6366 6c6f 6174 3b20 2020  torch.cfloat;   
-0003a5e0: 2020 2020 2020 2020 2020 6368 616c 6620            chalf 
-0003a5f0: 3d20 746f 7263 682e 6368 616c 660a 636f  = torch.chalf.co
-0003a600: 6d70 6c65 7831 3238 203d 2074 6f72 6368  mplex128 = torch
-0003a610: 2e63 6f6d 706c 6578 3132 383b 2020 2020  .complex128;    
-0003a620: 636f 6d70 6c65 7836 3420 3d20 746f 7263  complex64 = torc
-0003a630: 682e 636f 6d70 6c65 7836 343b 2020 2020  h.complex64;    
-0003a640: 2020 2063 6f6d 706c 6578 3332 203d 2074     complex32 = t
-0003a650: 6f72 6368 2e63 6f6d 706c 6578 3332 0a64  orch.complex32.d
-0003a660: 6f75 626c 6520 3d20 746f 7263 682e 646f  ouble = torch.do
-0003a670: 7562 6c65 3b20 2020 2020 2020 2020 2020  uble;           
-0003a680: 2068 616c 6620 3d20 746f 7263 682e 6861   half = torch.ha
-0003a690: 6c66 0a66 6c6f 6174 203d 2074 6f72 6368  lf.float = torch
-0003a6a0: 2e66 6c6f 6174 3b20 2020 2020 2020 2020  .float;         
-0003a6b0: 2020 2020 2066 6c6f 6174 3136 203d 2074       float16 = t
-0003a6c0: 6f72 6368 2e66 6c6f 6174 3136 3b20 2020  orch.float16;   
-0003a6d0: 2020 2020 2020 2020 666c 6f61 7433 3220          float32 
-0003a6e0: 3d20 746f 7263 682e 666c 6f61 7433 323b  = torch.float32;
-0003a6f0: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-0003a700: 3634 203d 2074 6f72 6368 2e66 6c6f 6174  64 = torch.float
-0003a710: 3634 0a69 6e74 203d 2074 6f72 6368 2e69  64.int = torch.i
-0003a720: 6e74 3b20 2020 2020 2020 2020 2020 2020  nt;             
-0003a730: 2020 2020 2069 6e74 3136 203d 2074 6f72       int16 = tor
-0003a740: 6368 2e69 6e74 3136 3b20 2020 2020 2020  ch.int16;       
-0003a750: 2020 2020 2020 2020 696e 7433 3220 3d20          int32 = 
-0003a760: 746f 7263 682e 696e 7433 323b 2020 2020  torch.int32;    
-0003a770: 2020 2020 2020 2020 2020 2069 6e74 3634             int64
-0003a780: 203d 2074 6f72 6368 2e69 6e74 3634 3b20   = torch.int64; 
-0003a790: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0003a7a0: 7438 203d 2074 6f72 6368 2e69 6e74 380a  t8 = torch.int8.
-0003a7b0: 7169 6e74 3332 203d 2074 6f72 6368 2e71  qint32 = torch.q
-0003a7c0: 696e 7433 323b 2020 2020 2020 2020 2020  int32;          
-0003a7d0: 2020 7169 6e74 3820 3d20 746f 7263 682e    qint8 = torch.
-0003a7e0: 7169 6e74 383b 2020 2020 2020 2020 2020  qint8;          
-0003a7f0: 2020 2020 2071 7569 6e74 3278 3420 3d20       quint2x4 = 
-0003a800: 746f 7263 682e 7175 696e 7432 7834 3b20  torch.quint2x4; 
-0003a810: 2020 2020 2020 2020 7175 696e 7434 7832          quint4x2
-0003a820: 203d 2074 6f72 6368 2e71 7569 6e74 3478   = torch.quint4x
-0003a830: 323b 2020 2020 2020 2020 2071 7569 6e74  2;         quint
-0003a840: 3820 3d20 746f 7263 682e 7175 696e 7438  8 = torch.quint8
-0003a850: 0a6c 6f6e 6720 3d20 746f 7263 682e 6c6f  .long = torch.lo
-0003a860: 6e67 3b20 2020 2020 2020 2020 2020 2020  ng;             
-0003a870: 2020 2073 686f 7274 203d 2074 6f72 6368     short = torch
-0003a880: 2e73 686f 7274 3b20 2020 2020 2020 2020  .short;         
-0003a890: 2020 2020 2020 7569 6e74 3820 3d20 746f        uint8 = to
-0003a8a0: 7263 682e 7569 6e74 380a 0a23 2066 756e  rch.uint8..# fun
-0003a8b0: 6374 696f 6e73 0a6d 616e 7561 6c5f 7365  ctions.manual_se
-0003a8c0: 6564 203d 2074 6f72 6368 2e6d 616e 7561  ed = torch.manua
-0003a8d0: 6c5f 7365 6564 0a                        l_seed.
+00033700: 2020 6465 6620 5f5f 726d 756c 5f5f 2873    def __rmul__(s
+00033710: 656c 663a 2027 5465 6e73 6f72 272c 206f  elf: 'Tensor', o
+00033720: 7468 6572 3a20 2754 656e 736f 7227 293a  ther: 'Tensor'):
+00033730: 202e 2e2e 0a20 2020 2064 6566 205f 5f64   ....    def __d
+00033740: 6976 5f5f 2873 656c 663a 2027 5465 6e73  iv__(self: 'Tens
+00033750: 6f72 272c 206f 7468 6572 3a20 2754 656e  or', other: 'Ten
+00033760: 736f 7227 293a 202e 2e2e 0a20 2020 2064  sor'): ....    d
+00033770: 6566 205f 5f69 6469 765f 5f28 7365 6c66  ef __idiv__(self
+00033780: 3a20 2754 656e 736f 7227 2c20 6f74 6865  : 'Tensor', othe
+00033790: 723a 2027 5465 6e73 6f72 2729 3a20 2e2e  r: 'Tensor'): ..
+000337a0: 2e0a 2020 2020 6465 6620 5f5f 7264 6976  ..    def __rdiv
+000337b0: 5f5f 2873 656c 663a 2027 5465 6e73 6f72  __(self: 'Tensor
+000337c0: 272c 206f 7468 6572 3a20 2754 656e 736f  ', other: 'Tenso
+000337d0: 7227 293a 202e 2e2e 0a20 2020 2064 6566  r'): ....    def
+000337e0: 205f 5f70 6f77 5f5f 2873 656c 663a 2027   __pow__(self: '
+000337f0: 5465 6e73 6f72 272c 206f 7468 6572 3a20  Tensor', other: 
+00033800: 2754 656e 736f 7227 293a 202e 2e2e 0a20  'Tensor'): .... 
+00033810: 2020 2064 6566 205f 5f69 706f 775f 5f28     def __ipow__(
+00033820: 7365 6c66 3a20 2754 656e 736f 7227 2c20  self: 'Tensor', 
+00033830: 6f74 6865 723a 2027 5465 6e73 6f72 2729  other: 'Tensor')
+00033840: 3a20 2e2e 2e0a 2020 2020 6465 6620 5f5f  : ....    def __
+00033850: 7270 6f77 5f5f 2873 656c 663a 2027 5465  rpow__(self: 'Te
+00033860: 6e73 6f72 272c 206f 7468 6572 3a20 2754  nsor', other: 'T
+00033870: 656e 736f 7227 293a 202e 2e2e 0a20 2020  ensor'): ....   
+00033880: 2064 6566 205f 5f6d 6f64 5f5f 2873 656c   def __mod__(sel
+00033890: 663a 2027 5465 6e73 6f72 272c 206f 7468  f: 'Tensor', oth
+000338a0: 6572 3a20 2754 656e 736f 7227 293a 202e  er: 'Tensor'): .
+000338b0: 2e2e 0a20 2020 2064 6566 205f 5f69 6d6f  ...    def __imo
+000338c0: 645f 5f28 7365 6c66 3a20 2754 656e 736f  d__(self: 'Tenso
+000338d0: 7227 2c20 6f74 6865 723a 2027 5465 6e73  r', other: 'Tens
+000338e0: 6f72 2729 3a20 2e2e 2e0a 2020 2020 6465  or'): ....    de
+000338f0: 6620 5f5f 726d 6f64 5f5f 2873 656c 663a  f __rmod__(self:
+00033900: 2027 5465 6e73 6f72 272c 206f 7468 6572   'Tensor', other
+00033910: 3a20 2754 656e 736f 7227 293a 202e 2e2e  : 'Tensor'): ...
+00033920: 0a20 2020 2064 6566 205f 5f74 7275 6564  .    def __trued
+00033930: 6976 5f5f 2873 656c 663a 2027 5465 6e73  iv__(self: 'Tens
+00033940: 6f72 272c 206f 7468 6572 3a20 2754 656e  or', other: 'Ten
+00033950: 736f 7227 293a 202e 2e2e 0a20 2020 2064  sor'): ....    d
+00033960: 6566 205f 5f69 7472 7565 6469 765f 5f28  ef __itruediv__(
+00033970: 7365 6c66 3a20 2754 656e 736f 7227 2c20  self: 'Tensor', 
+00033980: 6f74 6865 723a 2027 5465 6e73 6f72 2729  other: 'Tensor')
+00033990: 3a20 2e2e 2e0a 2020 2020 6465 6620 5f5f  : ....    def __
+000339a0: 7274 7275 6564 6976 5f5f 2873 656c 663a  rtruediv__(self:
+000339b0: 2027 5465 6e73 6f72 272c 206f 7468 6572   'Tensor', other
+000339c0: 3a20 2754 656e 736f 7227 293a 202e 2e2e  : 'Tensor'): ...
+000339d0: 0a20 2020 2064 6566 205f 5f66 6c6f 6f72  .    def __floor
+000339e0: 6469 765f 5f28 7365 6c66 3a20 2754 656e  div__(self: 'Ten
+000339f0: 736f 7227 2c20 6f74 6865 723a 2027 5465  sor', other: 'Te
+00033a00: 6e73 6f72 2729 3a20 2e2e 2e0a 2020 2020  nsor'): ....    
+00033a10: 6465 6620 5f5f 6966 6c6f 6f72 6469 765f  def __ifloordiv_
+00033a20: 5f28 7365 6c66 3a20 2754 656e 736f 7227  _(self: 'Tensor'
+00033a30: 2c20 6f74 6865 723a 2027 5465 6e73 6f72  , other: 'Tensor
+00033a40: 2729 3a20 2e2e 2e0a 2020 2020 6465 6620  '): ....    def 
+00033a50: 5f5f 7266 6c6f 6f72 6469 765f 5f28 7365  __rfloordiv__(se
+00033a60: 6c66 3a20 2754 656e 736f 7227 2c20 6f74  lf: 'Tensor', ot
+00033a70: 6865 723a 2027 5465 6e73 6f72 2729 3a20  her: 'Tensor'): 
+00033a80: 2e2e 2e0a 2020 2020 6465 6620 5f5f 6e65  ....    def __ne
+00033a90: 675f 5f28 7365 6c66 3a20 2754 656e 736f  g__(self: 'Tenso
+00033aa0: 7227 293a 202e 2e2e 0a20 2020 2064 6566  r'): ....    def
+00033ab0: 205f 5f65 715f 5f28 7365 6c66 3a20 2754   __eq__(self: 'T
+00033ac0: 656e 736f 7227 2c20 6f74 6865 723a 2027  ensor', other: '
+00033ad0: 5465 6e73 6f72 2729 3a20 2e2e 2e0a 2020  Tensor'): ....  
+00033ae0: 2020 6465 6620 5f5f 6e65 5f5f 2873 656c    def __ne__(sel
+00033af0: 663a 2027 5465 6e73 6f72 272c 206f 7468  f: 'Tensor', oth
+00033b00: 6572 3a20 2754 656e 736f 7227 293a 202e  er: 'Tensor'): .
+00033b10: 2e2e 0a20 2020 2064 6566 205f 5f6f 725f  ...    def __or_
+00033b20: 5f28 7365 6c66 3a20 2754 656e 736f 7227  _(self: 'Tensor'
+00033b30: 2c20 6f74 6865 723a 2027 5465 6e73 6f72  , other: 'Tensor
+00033b40: 2729 3a20 2e2e 2e0a 2020 2020 6465 6620  '): ....    def 
+00033b50: 5f5f 696f 725f 5f28 7365 6c66 3a20 2754  __ior__(self: 'T
+00033b60: 656e 736f 7227 2c20 6f74 6865 723a 2027  ensor', other: '
+00033b70: 5465 6e73 6f72 2729 3a20 2e2e 2e0a 2020  Tensor'): ....  
+00033b80: 2020 6465 6620 5f5f 726f 725f 5f28 7365    def __ror__(se
+00033b90: 6c66 3a20 2754 656e 736f 7227 2c20 6f74  lf: 'Tensor', ot
+00033ba0: 6865 723a 2027 5465 6e73 6f72 2729 3a20  her: 'Tensor'): 
+00033bb0: 2e2e 2e0a 2020 2020 6465 6620 5f5f 616e  ....    def __an
+00033bc0: 645f 5f28 7365 6c66 3a20 2754 656e 736f  d__(self: 'Tenso
+00033bd0: 7227 2c20 6f74 6865 723a 2027 5465 6e73  r', other: 'Tens
+00033be0: 6f72 2729 3a20 2e2e 2e0a 2020 2020 6465  or'): ....    de
+00033bf0: 6620 5f5f 6961 6e64 5f5f 2873 656c 663a  f __iand__(self:
+00033c00: 2027 5465 6e73 6f72 272c 206f 7468 6572   'Tensor', other
+00033c10: 3a20 2754 656e 736f 7227 293a 202e 2e2e  : 'Tensor'): ...
+00033c20: 0a20 2020 2064 6566 205f 5f72 616e 645f  .    def __rand_
+00033c30: 5f28 7365 6c66 3a20 2754 656e 736f 7227  _(self: 'Tensor'
+00033c40: 2c20 6f74 6865 723a 2027 5465 6e73 6f72  , other: 'Tensor
+00033c50: 2729 3a20 2e2e 2e0a 2020 2020 6465 6620  '): ....    def 
+00033c60: 5f5f 786f 725f 5f28 7365 6c66 3a20 2754  __xor__(self: 'T
+00033c70: 656e 736f 7227 2c20 6f74 6865 723a 2027  ensor', other: '
+00033c80: 5465 6e73 6f72 2729 3a20 2e2e 2e0a 2020  Tensor'): ....  
+00033c90: 2020 6465 6620 5f5f 6978 6f72 5f5f 2873    def __ixor__(s
+00033ca0: 656c 663a 2027 5465 6e73 6f72 272c 206f  elf: 'Tensor', o
+00033cb0: 7468 6572 3a20 2754 656e 736f 7227 293a  ther: 'Tensor'):
+00033cc0: 202e 2e2e 0a20 2020 2064 6566 205f 5f72   ....    def __r
+00033cd0: 786f 725f 5f28 7365 6c66 3a20 2754 656e  xor__(self: 'Ten
+00033ce0: 736f 7227 2c20 6f74 6865 723a 2027 5465  sor', other: 'Te
+00033cf0: 6e73 6f72 2729 3a20 2e2e 2e0a 2020 2020  nsor'): ....    
+00033d00: 6465 6620 5f5f 696e 7665 7274 5f5f 2873  def __invert__(s
+00033d10: 656c 663a 2027 5465 6e73 6f72 2729 3a20  elf: 'Tensor'): 
+00033d20: 2e2e 2e0a 2020 2020 6465 6620 5f5f 6c74  ....    def __lt
+00033d30: 5f5f 2873 656c 663a 2027 5465 6e73 6f72  __(self: 'Tensor
+00033d40: 272c 206f 7468 6572 3a20 2754 656e 736f  ', other: 'Tenso
+00033d50: 7227 293a 202e 2e2e 0a20 2020 2064 6566  r'): ....    def
+00033d60: 205f 5f6c 655f 5f28 7365 6c66 3a20 2754   __le__(self: 'T
+00033d70: 656e 736f 7227 2c20 6f74 6865 723a 2027  ensor', other: '
+00033d80: 5465 6e73 6f72 2729 3a20 2e2e 2e0a 2020  Tensor'): ....  
+00033d90: 2020 6465 6620 5f5f 6774 5f5f 2873 656c    def __gt__(sel
+00033da0: 663a 2027 5465 6e73 6f72 272c 206f 7468  f: 'Tensor', oth
+00033db0: 6572 3a20 2754 656e 736f 7227 293a 202e  er: 'Tensor'): .
+00033dc0: 2e2e 0a20 2020 2064 6566 205f 5f67 655f  ...    def __ge_
+00033dd0: 5f28 7365 6c66 3a20 2754 656e 736f 7227  _(self: 'Tensor'
+00033de0: 2c20 6f74 6865 723a 2027 5465 6e73 6f72  , other: 'Tensor
+00033df0: 2729 3a20 2e2e 2e0a 2020 2020 6465 6620  '): ....    def 
+00033e00: 5f5f 6d61 746d 756c 5f5f 2873 656c 663a  __matmul__(self:
+00033e10: 2027 5465 6e73 6f72 272c 206f 7468 6572   'Tensor', other
+00033e20: 3a20 2754 656e 736f 7227 293a 202e 2e2e  : 'Tensor'): ...
+00033e30: 0a20 2020 200a 2020 2020 2320 696e 706c  .    .    # inpl
+00033e40: 6163 6520 6d65 7468 6f64 733a 206f 7065  ace methods: ope
+00033e50: 7261 7469 6f6e 730a 2020 2020 6465 6620  rations.    def 
+00033e60: 6164 645f 2873 656c 663a 2027 5465 6e73  add_(self: 'Tens
+00033e70: 6f72 272c 206f 7468 6572 3a20 2754 656e  or', other: 'Ten
+00033e80: 736f 7227 2c20 2a2c 2061 6c70 6861 3d31  sor', *, alpha=1
+00033e90: 293a 202e 2e2e 0a20 2020 2064 6566 2073  ): ....    def s
+00033ea0: 7562 5f28 7365 6c66 3a20 2754 656e 736f  ub_(self: 'Tenso
+00033eb0: 7227 2c20 6f74 6865 723a 2027 5465 6e73  r', other: 'Tens
+00033ec0: 6f72 272c 202a 2c20 616c 7068 613d 3129  or', *, alpha=1)
+00033ed0: 3a20 2e2e 2e0a 2020 2020 6465 6620 6d75  : ....    def mu
+00033ee0: 6c74 6970 6c79 2873 656c 663a 2027 5465  ltiply(self: 'Te
+00033ef0: 6e73 6f72 272c 2076 616c 7565 3a20 2754  nsor', value: 'T
+00033f00: 656e 736f 7227 293a 202e 2e2e 0a20 2020  ensor'): ....   
+00033f10: 2064 6566 206d 756c 5f28 7365 6c66 3a20   def mul_(self: 
+00033f20: 2754 656e 736f 7227 2c20 7661 6c75 653a  'Tensor', value:
+00033f30: 2027 5465 6e73 6f72 2729 3a20 2e2e 2e0a   'Tensor'): ....
+00033f40: 2020 2020 6465 6620 6469 765f 2873 656c      def div_(sel
+00033f50: 663a 2027 5465 6e73 6f72 272c 2076 616c  f: 'Tensor', val
+00033f60: 7565 3a20 2754 656e 736f 7227 2c20 2a2c  ue: 'Tensor', *,
+00033f70: 2072 6f75 6e64 696e 675f 6d6f 6465 3d4e   rounding_mode=N
+00033f80: 6f6e 6529 3a20 2e2e 2e0a 2020 2020 6465  one): ....    de
+00033f90: 6620 706f 775f 2873 656c 663a 2027 5465  f pow_(self: 'Te
+00033fa0: 6e73 6f72 272c 206f 7468 6572 3a20 2754  nsor', other: 'T
+00033fb0: 656e 736f 7227 293a 202e 2e2e 0a20 2020  ensor'): ....   
+00033fc0: 2064 6566 2066 6d6f 645f 2873 656c 663a   def fmod_(self:
+00033fd0: 2027 5465 6e73 6f72 272c 206f 7468 6572   'Tensor', other
+00033fe0: 3a20 2754 656e 736f 7227 293a 202e 2e2e  : 'Tensor'): ...
+00033ff0: 0a0a 2020 2020 2320 696e 706c 6163 6520  ..    # inplace 
+00034000: 6d65 7468 6f64 733a 2069 6e69 7469 616c  methods: initial
+00034010: 697a 6572 730a 2020 2020 6465 6620 7a65  izers.    def ze
+00034020: 726f 5f28 7365 6c66 3a20 2754 656e 736f  ro_(self: 'Tenso
+00034030: 7227 293a 202e 2e2e 0a20 2020 2064 6566  r'): ....    def
+00034040: 206f 6e65 5f28 7365 6c66 293a 2072 6574   one_(self): ret
+00034050: 7572 6e20 7365 6c66 2e66 696c 6c5f 2831  urn self.fill_(1
+00034060: 2920 2320 7375 7070 7265 7373 3a20 7370  ) # suppress: sp
+00034070: 6563 6961 6c5f 6672 6f6d 0a20 2020 2064  ecial_from.    d
+00034080: 6566 2066 696c 6c5f 2873 656c 663a 2027  ef fill_(self: '
+00034090: 5465 6e73 6f72 272c 2076 616c 7565 293a  Tensor', value):
+000340a0: 202e 2e2e 0a20 2020 2064 6566 206e 6f72   ....    def nor
+000340b0: 6d61 6c5f 2873 656c 663a 2027 5465 6e73  mal_(self: 'Tens
+000340c0: 6f72 272c 206d 6561 6e3d 302c 2073 7464  or', mean=0, std
+000340d0: 3d31 2c20 2a2c 2067 656e 6572 6174 6f72  =1, *, generator
+000340e0: 3d4e 6f6e 6529 3a20 2e2e 2e0a 0a20 2020  =None): .....   
+000340f0: 2023 2069 6e70 6c61 6365 206d 6574 686f   # inplace metho
+00034100: 6473 3a20 6469 6d65 6e73 696f 6e20 6d61  ds: dimension ma
+00034110: 6e69 7075 6c61 7469 6f6e 730a 2020 2020  nipulations.    
+00034120: 6465 6620 756e 7371 7565 657a 655f 2873  def unsqueeze_(s
+00034130: 656c 663a 2027 5465 6e73 6f72 272c 202a  elf: 'Tensor', *
+00034140: 6469 6d73 3a20 6e65 775f 6469 6d5b 2e2e  dims: new_dim[..
+00034150: 2e5d 293a 202e 2e2e 0a20 2020 2064 6566  .]): ....    def
+00034160: 2073 7175 6565 7a65 5f28 7365 6c66 3a20   squeeze_(self: 
+00034170: 2754 656e 736f 7227 2c20 2a64 696d 733a  'Tensor', *dims:
+00034180: 2064 656c 5f64 696d 5b2e 2e2e 5d29 3a0a   del_dim[...]):.
+00034190: 2020 2020 2020 2020 7661 6c69 645f 6469          valid_di
+000341a0: 6d73 203d 205b 5d0a 2020 2020 2020 2020  ms = [].        
+000341b0: 7769 7468 2074 6f72 6368 2e5f 432e 4469  with torch._C.Di
+000341c0: 7361 626c 6554 6f72 6368 4675 6e63 7469  sableTorchFuncti
+000341d0: 6f6e 2829 3a0a 2020 2020 2020 2020 2020  on():.          
+000341e0: 2020 666f 7220 6420 696e 2064 696d 735b    for d in dims[
+000341f0: 3a3a 2d31 5d3a 0a20 2020 2020 2020 2020  ::-1]:.         
+00034200: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+00034210: 697a 6528 6429 203d 3d20 313a 0a20 2020  ize(d) == 1:.   
+00034220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034230: 2076 616c 6964 5f64 696d 732e 6170 7065   valid_dims.appe
+00034240: 6e64 2864 290a 2020 2020 2020 2020 2020  nd(d).          
+00034250: 2020 2020 2020 2020 2020 746f 7263 685f            torch_
+00034260: 7375 7065 7228 7365 6c66 2c20 2773 7175  super(self, 'squ
+00034270: 6565 7a65 5f27 2928 6429 0a20 2020 2020  eeze_')(d).     
+00034280: 2020 2064 696d 7320 3d20 7475 706c 6528     dims = tuple(
+00034290: 7661 6c69 645f 6469 6d73 290a 2020 2020  valid_dims).    
+000342a0: 2020 2020 7265 7475 726e 2073 656c 660a      return self.
+000342b0: 2020 2020 6465 6620 7472 616e 7370 6f73      def transpos
+000342c0: 655f 2873 656c 663a 2027 5465 6e73 6f72  e_(self: 'Tensor
+000342d0: 272c 2064 696d 303a 2065 7869 7374 5f64  ', dim0: exist_d
+000342e0: 696d 5b31 5d2c 2064 696d 313a 2065 7869  im[1], dim1: exi
+000342f0: 7374 5f64 696d 5b31 5d29 3a20 2e2e 2e0a  st_dim[1]): ....
+00034300: 2020 2020 0a20 2020 2023 2070 726f 7065      .    # prope
+00034310: 7274 6965 730a 2020 2020 4063 6f6c 6c65  rties.    @colle
+00034320: 6374 5f6d 656d 6f72 790a 2020 2020 6465  ct_memory.    de
+00034330: 6620 746f 2873 656c 663a 2027 5465 6e73  f to(self: 'Tens
+00034340: 6f72 272c 202a 6172 6773 2c20 2a2a 6b77  or', *args, **kw
+00034350: 6172 6773 293a 202e 2e2e 0a20 2020 2064  args): ....    d
+00034360: 6566 2063 6c6f 6e65 2873 656c 663a 2027  ef clone(self: '
+00034370: 5465 6e73 6f72 272c 202a 2c20 6d65 6d6f  Tensor', *, memo
+00034380: 7279 5f66 6f72 6d61 743d 746f 7263 682e  ry_format=torch.
+00034390: 7072 6573 6572 7665 5f66 6f72 6d61 7429  preserve_format)
+000343a0: 3a20 2e2e 2e0a 2020 2020 6465 6620 696e  : ....    def in
+000343b0: 7428 7365 6c66 3a20 2754 656e 736f 7227  t(self: 'Tensor'
+000343c0: 2c20 6d65 6d6f 7279 5f66 6f72 6d61 743d  , memory_format=
+000343d0: 746f 7263 682e 7072 6573 6572 7665 5f66  torch.preserve_f
+000343e0: 6f72 6d61 7429 3a20 2e2e 2e0a 2020 2020  ormat): ....    
+000343f0: 6465 6620 6c6f 6e67 2873 656c 663a 2027  def long(self: '
+00034400: 5465 6e73 6f72 272c 206d 656d 6f72 795f  Tensor', memory_
+00034410: 666f 726d 6174 3d74 6f72 6368 2e70 7265  format=torch.pre
+00034420: 7365 7276 655f 666f 726d 6174 293a 202e  serve_format): .
+00034430: 2e2e 0a20 2020 2064 6566 2066 6c6f 6174  ...    def float
+00034440: 2873 656c 663a 2027 5465 6e73 6f72 272c  (self: 'Tensor',
+00034450: 206d 656d 6f72 795f 666f 726d 6174 3d74   memory_format=t
+00034460: 6f72 6368 2e70 7265 7365 7276 655f 666f  orch.preserve_fo
+00034470: 726d 6174 293a 202e 2e2e 0a20 2020 2064  rmat): ....    d
+00034480: 6566 2064 6f75 626c 6528 7365 6c66 3a20  ef double(self: 
+00034490: 2754 656e 736f 7227 2c20 6d65 6d6f 7279  'Tensor', memory
+000344a0: 5f66 6f72 6d61 743d 746f 7263 682e 7072  _format=torch.pr
+000344b0: 6573 6572 7665 5f66 6f72 6d61 7429 3a20  eserve_format): 
+000344c0: 2e2e 2e0a 2020 2020 6465 6620 6370 7528  ....    def cpu(
+000344d0: 7365 6c66 3a20 2754 656e 736f 7227 293a  self: 'Tensor'):
+000344e0: 202e 2e2e 0a20 2020 2064 6566 2063 7564   ....    def cud
+000344f0: 6128 7365 6c66 3a20 2754 656e 736f 7227  a(self: 'Tensor'
+00034500: 293a 202e 2e2e 0a0a 2020 2020 2320 7368  ): .....    # sh
+00034510: 6170 6573 3a0a 2020 2020 6465 6620 7265  apes:.    def re
+00034520: 7368 6170 6528 7365 6c66 2c20 2a73 697a  shape(self, *siz
+00034530: 653a 2053 697a 6529 3a20 2e2e 2e0a 2020  e: Size): ....  
+00034540: 2020 6465 6620 7265 7368 6170 655f 6173    def reshape_as
+00034550: 2873 656c 662c 206f 7468 6572 3a20 2754  (self, other: 'T
+00034560: 656e 736f 7227 293a 202e 2e2e 0a20 2020  ensor'): ....   
+00034570: 2064 6566 2076 6965 7728 7365 6c66 2c20   def view(self, 
+00034580: 2a73 697a 653a 2053 697a 6529 3a0a 2020  *size: Size):.  
+00034590: 2020 2020 2020 7769 7468 2074 6f72 6368        with torch
+000345a0: 2e5f 432e 4469 7361 626c 6554 6f72 6368  ._C.DisableTorch
+000345b0: 4675 6e63 7469 6f6e 2829 3a0a 2020 2020  Function():.    
+000345c0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+000345d0: 6f72 6368 5f73 7570 6572 2873 656c 662c  orch_super(self,
+000345e0: 2027 7669 6577 2729 2873 697a 6529 0a20   'view')(size). 
+000345f0: 2020 2064 6566 2076 6965 775f 6173 2873     def view_as(s
+00034600: 656c 662c 206f 7468 6572 3a20 2754 656e  elf, other: 'Ten
+00034610: 736f 7227 293a 202e 2e2e 0a20 2020 2064  sor'): ....    d
+00034620: 6566 2077 6865 7265 2873 656c 663a 2027  ef where(self: '
+00034630: 5465 6e73 6f72 272c 2063 6f6e 6469 7469  Tensor', conditi
+00034640: 6f6e 3a20 2754 656e 736f 7227 2c20 6f74  on: 'Tensor', ot
+00034650: 6865 723a 2027 5465 6e73 6f72 273d 4e6f  her: 'Tensor'=No
+00034660: 6e65 2c20 2a2c 2065 7175 616c 733a 2027  ne, *, equals: '
+00034670: 5465 6e73 6f72 273d 4e6f 6e65 293a 0a20  Tensor'=None):. 
+00034680: 2020 2020 2020 2069 6620 6571 7561 6c73         if equals
+00034690: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+000346a0: 2020 2020 2020 7265 665f 7368 6170 6520        ref_shape 
+000346b0: 3d20 6272 6f61 6463 6173 7428 7365 6c66  = broadcast(self
+000346c0: 5f73 6861 7065 2c20 636f 6e64 6974 696f  _shape, conditio
+000346d0: 6e5f 7368 6170 652c 206f 7468 6572 5f73  n_shape, other_s
+000346e0: 6861 7065 2c20 7769 7468 5f73 697a 655f  hape, with_size_
+000346f0: 7570 6461 7465 733d 5472 7565 290a 2020  updates=True).  
+00034700: 2020 2020 2020 2020 2020 7365 6c66 203d            self =
+00034710: 2073 656c 662e 7669 6577 2872 6566 5f73   self.view(ref_s
+00034720: 6861 7065 2e75 7064 6174 6564 5f73 697a  hape.updated_siz
+00034730: 6573 5b30 5d29 0a20 2020 2020 2020 2020  es[0]).         
+00034740: 2020 2063 6f6e 6469 7469 6f6e 203d 2063     condition = c
+00034750: 6f6e 6469 7469 6f6e 2e76 6965 7728 7265  ondition.view(re
+00034760: 665f 7368 6170 652e 7570 6461 7465 645f  f_shape.updated_
+00034770: 7369 7a65 735b 315d 290a 2020 2020 2020  sizes[1]).      
+00034780: 2020 2020 2020 6f74 6865 7220 3d20 6f74        other = ot
+00034790: 6865 722e 7669 6577 2872 6566 5f73 6861  her.view(ref_sha
+000347a0: 7065 2e75 7064 6174 6564 5f73 697a 6573  pe.updated_sizes
+000347b0: 5b32 5d29 0a20 2020 2020 2020 2020 2020  [2]).           
+000347c0: 2077 6974 6820 746f 7263 682e 5f43 2e44   with torch._C.D
+000347d0: 6973 6162 6c65 546f 7263 6846 756e 6374  isableTorchFunct
+000347e0: 696f 6e28 293a 0a20 2020 2020 2020 2020  ion():.         
+000347f0: 2020 2020 2020 206f 626a 203d 2074 6f72         obj = tor
+00034800: 6368 5f73 7570 6572 2873 656c 662c 2027  ch_super(self, '
+00034810: 7768 6572 6527 2928 636f 6e64 6974 696f  where')(conditio
+00034820: 6e2c 206f 7468 6572 290a 2020 2020 2020  n, other).      
+00034830: 2020 2020 2020 7265 7475 726e 206f 626a        return obj
+00034840: 2e61 735f 7375 6263 6c61 7373 2854 656e  .as_subclass(Ten
+00034850: 736f 7229 2e73 7065 6369 616c 5f66 726f  sor).special_fro
+00034860: 6d28 7265 665f 7368 6170 6529 0a20 2020  m(ref_shape).   
+00034870: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00034880: 2020 2020 2020 2072 6566 5f73 6861 7065         ref_shape
+00034890: 203d 2062 726f 6164 6361 7374 2873 656c   = broadcast(sel
+000348a0: 665f 7368 6170 652c 2063 6f6e 6469 7469  f_shape, conditi
+000348b0: 6f6e 5f73 6861 7065 2c20 6571 7561 6c73  on_shape, equals
+000348c0: 5f73 6861 7065 2c20 7769 7468 5f73 697a  _shape, with_siz
+000348d0: 655f 7570 6461 7465 733d 5472 7565 290a  e_updates=True).
+000348e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000348f0: 203d 2073 656c 662e 7669 6577 2872 6566   = self.view(ref
+00034900: 5f73 6861 7065 2e75 7064 6174 6564 5f73  _shape.updated_s
+00034910: 697a 6573 5b30 5d29 0a20 2020 2020 2020  izes[0]).       
+00034920: 2020 2020 2063 6f6e 6469 7469 6f6e 203d       condition =
+00034930: 2063 6f6e 6469 7469 6f6e 2e76 6965 7728   condition.view(
+00034940: 7265 665f 7368 6170 652e 7570 6461 7465  ref_shape.update
+00034950: 645f 7369 7a65 735b 315d 290a 2020 2020  d_sizes[1]).    
+00034960: 2020 2020 2020 2020 6571 7561 6c73 203d          equals =
+00034970: 2065 7175 616c 732e 7669 6577 2872 6566   equals.view(ref
+00034980: 5f73 6861 7065 2e75 7064 6174 6564 5f73  _shape.updated_s
+00034990: 697a 6573 5b32 5d29 0a20 2020 2020 2020  izes[2]).       
+000349a0: 2020 2020 2077 6974 6820 746f 7263 682e       with torch.
+000349b0: 5f43 2e44 6973 6162 6c65 546f 7263 6846  _C.DisableTorchF
+000349c0: 756e 6374 696f 6e28 293a 0a20 2020 2020  unction():.     
+000349d0: 2020 2020 2020 2020 2020 206f 626a 203d             obj =
+000349e0: 2074 6f72 6368 5f73 7570 6572 2873 656c   torch_super(sel
+000349f0: 662c 2027 7768 6572 6527 2928 7e63 6f6e  f, 'where')(~con
+00034a00: 6469 7469 6f6e 2c20 6571 7561 6c73 290a  dition, equals).
+00034a10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00034a20: 726e 206f 626a 2e61 735f 7375 6263 6c61  rn obj.as_subcla
+00034a30: 7373 2854 656e 736f 7229 2e73 7065 6369  ss(Tensor).speci
+00034a40: 616c 5f66 726f 6d28 7265 665f 7368 6170  al_from(ref_shap
+00034a50: 6529 0a20 2020 2064 6566 2064 6f77 6e5f  e).    def down_
+00034a60: 7363 616c 6528 7365 6c66 3a20 2754 656e  scale(self: 'Ten
+00034a70: 736f 7227 2c20 6661 6374 6f72 3d31 293a  sor', factor=1):
+00034a80: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00034a90: 7365 6c66 5b28 736c 6963 6528 4e6f 6e65  self[(slice(None
+00034aa0: 292c 2920 2a20 7365 6c66 2e73 7061 6365  ),) * self.space
+00034ab0: 5f73 7461 7274 202b 2028 736c 6963 6528  _start + (slice(
+00034ac0: 4e6f 6e65 2c20 4e6f 6e65 2c20 6661 6374  None, None, fact
+00034ad0: 6f72 292c 2920 2a20 7365 6c66 2e6e 5f73  or),) * self.n_s
+00034ae0: 7061 6365 5f64 696d 5d20 2320 7375 7070  pace_dim] # supp
+00034af0: 7265 7373 3a20 7370 6563 6961 6c5f 6672  ress: special_fr
+00034b00: 6f6d 0a20 2020 2064 6566 2075 705f 7363  om.    def up_sc
+00034b10: 616c 6528 7365 6c66 3a20 2754 656e 736f  ale(self: 'Tenso
+00034b20: 7227 2c20 6661 6374 6f72 3d31 293a 0a20  r', factor=1):. 
+00034b30: 2020 2020 2020 2066 6f72 2064 2069 6e20         for d in 
+00034b40: 7261 6e67 655f 282a 7365 6c66 2e73 7061  range_(*self.spa
+00034b50: 6365 5f72 616e 6765 293a 0a20 2020 2020  ce_range):.     
+00034b60: 2020 2020 2020 2073 656c 6620 3d20 7365         self = se
+00034b70: 6c66 2e61 6d70 6c69 6679 2866 6163 746f  lf.amplify(facto
+00034b80: 722c 2064 290a 2020 2020 2020 2020 7265  r, d).        re
+00034b90: 7475 726e 2073 656c 6620 2320 7375 7070  turn self # supp
+00034ba0: 7265 7373 3a20 7370 6563 6961 6c5f 6672  ress: special_fr
+00034bb0: 6f6d 0a20 2020 2061 6464 6974 696f 6e61  om.    additiona
+00034bc0: 6c5f 6d65 7468 6f64 7320 3d20 6c69 7374  l_methods = list
+00034bd0: 2873 6574 286c 6f63 616c 7328 2929 202d  (set(locals()) -
+00034be0: 2073 6574 2862 6173 6963 5f76 6172 7329   set(basic_vars)
+00034bf0: 290a 2020 2020 0a20 2020 2066 6f72 2069  ).    .    for i
+00034c00: 735f 6269 7761 792c 2066 2069 6e20 5b28  s_biway, f in [(
+00034c10: 4661 6c73 652c 2066 2920 666f 7220 6620  False, f) for f 
+00034c20: 696e 2061 6464 6974 696f 6e61 6c5f 6d65  in additional_me
+00034c30: 7468 6f64 735d 202b 205b 2854 7275 652c  thods] + [(True,
+00034c40: 2066 2920 666f 7220 6620 696e 2062 6977   f) for f in biw
+00034c50: 6179 5f66 756e 6374 696f 6e73 5d3a 0a20  ay_functions]:. 
+00034c60: 2020 2020 2020 2066 756e 635f 636f 6465         func_code
+00034c70: 7320 3d20 6765 745f 7570 6461 7465 645f  s = get_updated_
+00034c80: 636f 6465 2865 7661 6c28 6629 2c20 6d6f  code(eval(f), mo
+00034c90: 6465 3d27 6d65 7468 6f64 272c 2069 676e  de='method', ign
+00034ca0: 6f72 655f 6172 6773 3d5b 276f 7574 275d  ore_args=['out']
+00034cb0: 2069 6620 6973 5f62 6977 6179 2065 6c73   if is_biway els
+00034cc0: 6520 5b5d 290a 2020 2020 2020 2020 6578  e []).        ex
+00034cd0: 6563 626c 6f63 6b28 6675 6e63 5f63 6f64  ecblock(func_cod
+00034ce0: 6573 290a 2020 2020 2020 2020 6966 2068  es).        if h
+00034cf0: 6173 6174 7472 2874 6f72 6368 2e54 656e  asattr(torch.Ten
+00034d00: 736f 722c 2066 293a 0a20 2020 2020 2020  sor, f):.       
+00034d10: 2020 2020 2074 6f72 6368 5f64 6f63 203d       torch_doc =
+00034d20: 2066 2254 6865 2064 6f63 756d 656e 7420   f"The document 
+00034d30: 6f66 2074 6865 206f 7269 6769 6e61 6c20  of the original 
+00034d40: 6675 6e63 7469 6f6e 2069 733a 5c6e 7b67  function is:\n{g
+00034d50: 6574 6174 7472 2874 6f72 6368 2e54 656e  etattr(torch.Ten
+00034d60: 736f 722c 2066 292e 5f5f 646f 635f 5f7d  sor, f).__doc__}
+00034d70: 220a 2020 2020 2020 2020 2020 2020 666f  ".            fo
+00034d80: 7220 6c69 6e65 2069 6e20 746f 7263 685f  r line in torch_
+00034d90: 646f 632e 7370 6c69 7428 275c 6e27 293a  doc.split('\n'):
+00034da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034db0: 2069 6620 6c69 6e65 2e73 7461 7274 7377   if line.startsw
+00034dc0: 6974 6828 2253 6565 203a 6675 6e63 3a22  ith("See :func:"
+00034dd0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00034de0: 2020 2020 2020 2074 6f72 6368 5f64 6f63         torch_doc
+00034df0: 202b 3d20 6622 5c6e 7768 6963 6820 6973   += f"\nwhich is
+00034e00: 3a5c 6e7b 6576 616c 286c 696e 652e 7370  :\n{eval(line.sp
+00034e10: 6c69 7428 2753 6565 203a 6675 6e63 3a27  lit('See :func:'
+00034e20: 295b 2d31 5d2e 7374 7269 7028 292e 7374  )[-1].strip().st
+00034e30: 7269 7028 2760 2e27 2929 2e5f 5f64 6f63  rip('`.')).__doc
+00034e40: 5f5f 7d22 0a20 2020 2020 2020 2020 2020  __}".           
+00034e50: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
+00034e60: 2020 2020 2020 2065 6c73 653a 2074 6f72         else: tor
+00034e70: 6368 5f64 6f63 203d 2027 270a 2020 2020  ch_doc = ''.    
+00034e80: 2020 2020 6576 616c 2866 292e 5f5f 646f      eval(f).__do
+00034e90: 635f 5f20 3d20 6622 2222 4175 746f 6d61  c__ = f"""Automa
+00034ea0: 7469 6361 6c6c 7920 696e 6865 7269 7474  tically inheritt
+00034eb0: 6564 206d 6574 686f 6420 6672 6f6d 2027  ed method from '
+00034ec0: 746f 7263 682e 5465 6e73 6f72 2e7b 667d  torch.Tensor.{f}
+00034ed0: 272e 2054 6865 2061 7574 6f6d 6174 6963  '. The automatic
+00034ee0: 616c 6c79 2067 656e 6572 6174 6564 2063  ally generated c
+00034ef0: 6f64 6573 2061 7265 2061 7320 666f 6c6c  odes are as foll
+00034f00: 6f77 733a 0a20 2020 2020 2020 207b 6164  ows:.        {ad
+00034f10: 645f 6c69 6e65 6e6f 2866 756e 635f 636f  d_lineno(func_co
+00034f20: 6465 7329 7d0a 2020 2020 2020 2020 5c6e  des)}.        \n
+00034f30: 7b74 6f72 6368 5f64 6f63 7d0a 2020 2020  {torch_doc}.    
+00034f40: 2020 2020 2222 220a 2020 2020 656c 7365      """.    else
+00034f50: 3a20 2320 616c 6961 7365 7320 2875 7365  : # aliases (use
+00034f60: 6c65 7373 2027 656c 7365 2720 7363 6f70  less 'else' scop
+00034f70: 6520 666f 7220 6120 6e65 7720 7365 6374  e for a new sect
+00034f80: 696f 6e29 0a20 2020 2020 2020 2063 6f6e  ion).        con
+00034f90: 6361 7465 6e61 7465 203d 2063 6174 0a20  catenate = cat. 
+00034fa0: 2020 2020 2020 2069 6e76 203d 2069 6e76         inv = inv
+00034fb0: 6572 7365 0a20 2020 2020 2020 2074 7220  erse.        tr 
+00034fc0: 3d20 7472 6163 650a 2020 2020 2020 2020  = trace.        
+00034fd0: 6d61 7472 6978 5f70 6f77 6572 203d 206d  matrix_power = m
+00034fe0: 6174 706f 770a 2020 2020 2020 2020 6d61  atpow.        ma
+00034ff0: 7472 6978 5f65 7870 203d 206d 6174 6578  trix_exp = matex
+00035000: 700a 2020 2020 2020 2020 6d61 7472 6978  p.        matrix
+00035010: 5f6c 6f67 203d 206d 6174 6c6f 670a 2020  _log = matlog.  
+00035020: 2020 2020 2020 6d61 7472 6978 5f72 616e        matrix_ran
+00035030: 6b20 3d20 7261 6e6b 0a20 2020 2020 2020  k = rank.       
+00035040: 206d 6174 7269 785f 6e6f 726d 203d 206d   matrix_norm = m
+00035050: 6174 6e6f 726d 0a20 2020 2020 2020 200a  atnorm.        .
+00035060: 2020 2020 4063 6c61 7373 6d65 7468 6f64      @classmethod
+00035070: 0a20 2020 2064 6566 205f 5f74 6f72 6368  .    def __torch
+00035080: 5f66 756e 6374 696f 6e5f 5f28 636c 732c  _function__(cls,
+00035090: 2066 756e 632c 2074 7970 6573 2c20 6172   func, types, ar
+000350a0: 6773 3d28 292c 206b 7761 7267 733d 4e6f  gs=(), kwargs=No
+000350b0: 6e65 293a 0a0a 2020 2020 2020 2020 7472  ne):..        tr
+000350c0: 793a 0a20 2020 2020 2020 2020 2020 2069  y:.            i
+000350d0: 6620 5465 6e73 6f72 2069 6e20 7479 7065  f Tensor in type
+000350e0: 7320 616e 6420 636c 7320 213d 2054 656e  s and cls != Ten
+000350f0: 736f 723a 2072 6574 7572 6e20 4e6f 7449  sor: return NotI
+00035100: 6d70 6c65 6d65 6e74 6564 0a20 2020 2020  mplemented.     
+00035110: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00035120: 2020 2020 7365 6c66 203d 2061 7267 735b      self = args[
+00035130: 305d 2069 6620 6c65 6e28 6172 6773 2920  0] if len(args) 
+00035140: 3e20 3020 656c 7365 204e 6f6e 650a 2020  > 0 else None.  
+00035150: 2020 2020 2020 2020 2020 2320 6966 2066            # if f
+00035160: 756e 632e 5f5f 7175 616c 6e61 6d65 5f5f  unc.__qualname__
+00035170: 2e73 7461 7274 7377 6974 6828 225f 5661  .startswith("_Va
+00035180: 7269 6162 6c65 4675 6e63 7469 6f6e 7343  riableFunctionsC
+00035190: 6c61 7373 2229 3a20 2320 6261 7369 6320  lass"): # basic 
+000351a0: 6675 6e63 7469 6f6e 7320 2774 6f72 6368  functions 'torch
+000351b0: 2e2a 270a 2020 2020 2020 2020 2020 2020  .*'.            
+000351c0: 2320 2020 2020 6966 2066 756e 632e 5f5f  #     if func.__
+000351d0: 6e61 6d65 5f5f 2069 6e20 676c 6f62 616c  name__ in global
+000351e0: 7328 293a 2073 656c 6620 3d20 4e6f 6e65  s(): self = None
+000351f0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00035200: 6966 2066 756e 632e 5f5f 7175 616c 6e61  if func.__qualna
+00035210: 6d65 5f5f 2e73 7461 7274 7377 6974 6828  me__.startswith(
+00035220: 225f 5465 6e73 6f72 4261 7365 2229 3a20  "_TensorBase"): 
+00035230: 2320 7465 6e73 6f72 2066 756e 6374 696f  # tensor functio
+00035240: 6e73 2027 746f 7263 682e 5465 6e73 6f72  ns 'torch.Tensor
+00035250: 3b2a 270a 2020 2020 2020 2020 2020 2020  ;*'.            
+00035260: 2320 2020 2020 6966 2068 6173 6174 7472  #     if hasattr
+00035270: 2854 656e 736f 722c 2066 756e 632e 5f5f  (Tensor, func.__
+00035280: 6e61 6d65 5f5f 2c20 6675 6e63 2e5f 5f6e  name__, func.__n
+00035290: 616d 655f 5f29 3a20 7365 6c66 203d 204e  ame__): self = N
+000352a0: 6f6e 650a 0a20 2020 2020 2020 2020 2020  one..           
+000352b0: 2074 7970 6573 203d 2074 7570 6c65 2863   types = tuple(c
+000352c0: 6c73 2069 6620 742e 5f5f 6e61 6d65 5f5f  ls if t.__name__
+000352d0: 203d 3d20 2250 6172 616d 6574 6572 2220   == "Parameter" 
+000352e0: 656c 7365 2074 2066 6f72 2074 2069 6e20  else t for t in 
+000352f0: 7479 7065 7329 0a20 2020 2020 2020 2020  types).         
+00035300: 2020 2072 6574 203d 2073 7570 6572 2829     ret = super()
+00035310: 2e5f 5f74 6f72 6368 5f66 756e 6374 696f  .__torch_functio
+00035320: 6e5f 5f28 6675 6e63 2c20 7479 7065 732c  n__(func, types,
+00035330: 2061 7267 732c 206b 7761 7267 7329 0a20   args, kwargs). 
+00035340: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00035350: 696e 7374 616e 6365 2872 6574 2c20 746f  instance(ret, to
+00035360: 7263 682e 5465 6e73 6f72 293a 0a20 2020  rch.Tensor):.   
+00035370: 2020 2020 2020 2020 2020 2020 2061 766f               avo
+00035380: 7563 6828 6973 696e 7374 616e 6365 2872  uch(isinstance(r
+00035390: 6574 2c20 636c 7329 2c20 5275 6e74 696d  et, cls), Runtim
+000353a0: 6545 7272 6f72 2866 2245 7272 6f72 2069  eError(f"Error i
+000353b0: 6e20 6861 7669 6e67 2072 6574 7572 6e20  n having return 
+000353c0: 7661 6c75 6520 6e6f 7420 6f66 2073 7562  value not of sub
+000353d0: 636c 6173 7320 277b 636c 732e 5f5f 6e61  class '{cls.__na
+000353e0: 6d65 5f5f 7d27 2c20 7468 6973 2073 686f  me__}', this sho
+000353f0: 756c 6420 6265 2064 6f6e 6520 6279 2050  uld be done by P
+00035400: 7954 6f72 6368 203e 3d20 312e 362e 2022  yTorch >= 1.6. "
+00035410: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00035420: 2020 2069 6620 6861 7361 7474 7228 7265     if hasattr(re
+00035430: 742c 2027 737a 5f66 756e 635f 6469 6d27  t, 'sz_func_dim'
+00035440: 293a 2072 6574 7572 6e20 7265 740a 2020  ): return ret.  
+00035450: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00035460: 742e 696e 6974 5f73 7065 6369 616c 2829  t.init_special()
+00035470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035480: 2069 6620 6973 696e 7374 616e 6365 2873   if isinstance(s
+00035490: 656c 662c 2054 656e 736f 7229 2061 6e64  elf, Tensor) and
+000354a0: 2072 6574 2e6e 5f64 696d 203d 3d20 7365   ret.n_dim == se
+000354b0: 6c66 2e6e 5f64 696d 3a20 7265 742e 7370  lf.n_dim: ret.sp
+000354c0: 6563 6961 6c5f 6672 6f6d 2873 656c 6629  ecial_from(self)
+000354d0: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
+000354e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000354f0: 2072 6574 0a20 2020 2020 2020 2020 2020   ret.           
+00035500: 200a 2020 2020 2020 2020 6578 6365 7074   .        except
+00035510: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
+00035520: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+00035530: 6e74 2866 2249 6e20 6675 6e63 7469 6f6e  nt(f"In function
+00035540: 207b 6675 6e63 2e5f 5f71 7561 6c6e 616d   {func.__qualnam
+00035550: 655f 5f7d 3a22 290a 2020 2020 2020 2020  e__}:").        
+00035560: 2020 2020 7261 6973 6520 650a 0a64 6566      raise e..def
+00035570: 2065 7870 616e 6428 7365 6c66 3a20 5465   expand(self: Te
+00035580: 6e73 6f72 2c20 2a73 697a 6573 3a20 5369  nsor, *sizes: Si
+00035590: 7a65 293a 2072 6574 7572 6e20 7365 6c66  ze): return self
+000355a0: 2e65 7870 616e 6428 2a73 697a 6573 290a  .expand(*sizes).
+000355b0: 6465 6620 6578 7061 6e64 5f61 7328 7365  def expand_as(se
+000355c0: 6c66 3a20 5465 6e73 6f72 2c20 6f74 6865  lf: Tensor, othe
+000355d0: 723a 2054 656e 736f 7229 3a20 7265 7475  r: Tensor): retu
+000355e0: 726e 2073 656c 662e 6578 7061 6e64 5f61  rn self.expand_a
+000355f0: 7328 6f74 6865 7229 0a64 6566 2065 7870  s(other).def exp
+00035600: 616e 645f 746f 2873 656c 663a 2054 656e  and_to(self: Ten
+00035610: 736f 722c 202a 7461 7267 6574 2c20 6173  sor, *target, as
+00035620: 7369 676e 5f74 6f5f 6469 6d73 3a20 6578  sign_to_dims: ex
+00035630: 6973 745f 6469 6d3d 4e6f 6e65 2c20 6469  ist_dim=None, di
+00035640: 6d73 5f61 6c6c 6f77 5f6d 6973 6d61 7463  ms_allow_mismatc
+00035650: 683a 2065 7869 7374 5f64 696d 3d4e 6f6e  h: exist_dim=Non
+00035660: 6529 3a20 7265 7475 726e 2073 656c 662e  e): return self.
+00035670: 6578 7061 6e64 5f74 6f28 2a74 6172 6765  expand_to(*targe
+00035680: 742c 2061 7373 6967 6e5f 746f 5f64 696d  t, assign_to_dim
+00035690: 733d 6173 7369 676e 5f74 6f5f 6469 6d73  s=assign_to_dims
+000356a0: 2c20 6469 6d73 5f61 6c6c 6f77 5f6d 6973  , dims_allow_mis
+000356b0: 6d61 7463 683d 6469 6d73 5f61 6c6c 6f77  match=dims_allow
+000356c0: 5f6d 6973 6d61 7463 6829 0a0a 6261 7369  _mismatch)..basi
+000356d0: 635f 6c6f 6361 6c73 203d 206c 6973 7428  c_locals = list(
+000356e0: 6c6f 6361 6c73 2829 2e6b 6579 7328 2929  locals().keys())
+000356f0: 202b 205b 2762 6173 6963 5f6c 6f63 616c   + ['basic_local
+00035700: 7327 5d0a 6465 6620 636f 6d70 6c65 7828  s'].def complex(
+00035710: 7265 616c 3a20 5465 6e73 6f72 2c20 696d  real: Tensor, im
+00035720: 6167 3a20 5465 6e73 6f72 2c20 2a2c 206f  ag: Tensor, *, o
+00035730: 7574 3d4e 6f6e 6529 3a20 2e2e 2e0a 6465  ut=None): ....de
+00035740: 6620 7465 6e73 6f72 2864 6174 612c 202a  f tensor(data, *
+00035750: 2c20 6474 7970 653d 4e6f 6e65 2c20 6465  , dtype=None, de
+00035760: 7669 6365 3d4e 6f6e 652c 2072 6571 7569  vice=None, requi
+00035770: 7265 735f 6772 6164 3d46 616c 7365 2c20  res_grad=False, 
+00035780: 7069 6e5f 6d65 6d6f 7279 3d46 616c 7365  pin_memory=False
+00035790: 293a 202e 2e2e 0a64 6566 2061 735f 7465  ): ....def as_te
+000357a0: 6e73 6f72 2864 6174 613a 2054 656e 736f  nsor(data: Tenso
+000357b0: 722c 2064 7479 7065 3d4e 6f6e 652c 2064  r, dtype=None, d
+000357c0: 6576 6963 653d 4e6f 6e65 293a 202e 2e2e  evice=None): ...
+000357d0: 0a40 636f 6c6c 6563 745f 6d65 6d6f 7279  .@collect_memory
+000357e0: 0a64 6566 2065 6d70 7479 282a 7369 7a65  .def empty(*size
+000357f0: 3a20 5369 7a65 2c20 6f75 743d 4e6f 6e65  : Size, out=None
+00035800: 2c20 6474 7970 653d 4e6f 6e65 2c20 6c61  , dtype=None, la
+00035810: 796f 7574 3d74 6f72 6368 2e73 7472 6964  yout=torch.strid
+00035820: 6564 2c20 6465 7669 6365 3d5f 6465 7669  ed, device=_devi
+00035830: 6365 2e6d 6169 6e5f 6465 7669 6365 2c20  ce.main_device, 
+00035840: 7265 7175 6972 6573 5f67 7261 643d 4661  requires_grad=Fa
+00035850: 6c73 652c 2070 696e 5f6d 656d 6f72 793d  lse, pin_memory=
+00035860: 4661 6c73 652c 206d 656d 6f72 795f 666f  False, memory_fo
+00035870: 726d 6174 3d74 6f72 6368 2e63 6f6e 7469  rmat=torch.conti
+00035880: 6775 6f75 735f 666f 726d 6174 293a 202e  guous_format): .
+00035890: 2e2e 0a40 636f 6c6c 6563 745f 6d65 6d6f  ...@collect_memo
+000358a0: 7279 0a64 6566 2066 756c 6c28 2a73 697a  ry.def full(*siz
+000358b0: 652c 2066 696c 6c5f 7661 6c75 653d 4e6f  e, fill_value=No
+000358c0: 6e65 2c20 6f75 743d 4e6f 6e65 2c20 6474  ne, out=None, dt
+000358d0: 7970 653d 4e6f 6e65 2c20 6c61 796f 7574  ype=None, layout
+000358e0: 3d74 6f72 6368 2e73 7472 6964 6564 2c20  =torch.strided, 
+000358f0: 6465 7669 6365 3d5f 6465 7669 6365 2e6d  device=_device.m
+00035900: 6169 6e5f 6465 7669 6365 2c20 7265 7175  ain_device, requ
+00035910: 6972 6573 5f67 7261 643d 4661 6c73 6529  ires_grad=False)
+00035920: 3a0a 2020 2020 6966 206c 656e 2873 697a  :.    if len(siz
+00035930: 6529 203d 3d20 3220 616e 6420 6973 696e  e) == 2 and isin
+00035940: 7374 616e 6365 2873 697a 655b 305d 2c20  stance(size[0], 
+00035950: 7475 706c 6529 3a20 7369 7a65 2c20 6669  tuple): size, fi
+00035960: 6c6c 5f76 616c 7565 203d 2073 697a 655b  ll_value = size[
+00035970: 305d 0a20 2020 2065 6c69 6620 6c65 6e28  0].    elif len(
+00035980: 7369 7a65 2920 3d3d 2031 2061 6e64 2069  size) == 1 and i
+00035990: 7369 6e73 7461 6e63 6528 7369 7a65 5b30  sinstance(size[0
+000359a0: 5d2c 2074 7570 6c65 293a 2073 697a 6520  ], tuple): size 
+000359b0: 3d20 7369 7a65 5b30 5d0a 2020 2020 6966  = size[0].    if
+000359c0: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+000359d0: 7369 7a65 2c20 5369 7a65 293a 2073 697a  size, Size): siz
+000359e0: 6520 3d20 5369 7a65 2873 697a 6529 0a20  e = Size(size). 
+000359f0: 2020 2069 6620 6669 6c6c 5f76 616c 7565     if fill_value
+00035a00: 2069 7320 4e6f 6e65 3a20 6669 6c6c 5f76   is None: fill_v
+00035a10: 616c 7565 203d 2030 0a20 2020 2077 6974  alue = 0.    wit
+00035a20: 6820 746f 7263 682e 5f43 2e44 6973 6162  h torch._C.Disab
+00035a30: 6c65 546f 7263 6846 756e 6374 696f 6e28  leTorchFunction(
+00035a40: 293a 0a20 2020 2020 2020 2072 6573 203d  ):.        res =
+00035a50: 2074 6f72 6368 2e66 756c 6c28 7369 7a65   torch.full(size
+00035a60: 2c20 6669 6c6c 5f76 616c 7565 3d66 696c  , fill_value=fil
+00035a70: 6c5f 7661 6c75 652c 206f 7574 3d6f 7574  l_value, out=out
+00035a80: 2c20 6474 7970 653d 6474 7970 652c 206c  , dtype=dtype, l
+00035a90: 6179 6f75 743d 6c61 796f 7574 2c20 6465  ayout=layout, de
+00035aa0: 7669 6365 3d64 6576 6963 652c 2072 6571  vice=device, req
+00035ab0: 7569 7265 735f 6772 6164 3d72 6571 7569  uires_grad=requi
+00035ac0: 7265 735f 6772 6164 290a 2020 2020 7265  res_grad).    re
+00035ad0: 7475 726e 2072 6573 2e61 735f 7375 6263  turn res.as_subc
+00035ae0: 6c61 7373 2854 656e 736f 7229 2e73 7065  lass(Tensor).spe
+00035af0: 6369 616c 5f66 726f 6d28 7369 7a65 290a  cial_from(size).
+00035b00: 4063 6f6c 6c65 6374 5f6d 656d 6f72 790a  @collect_memory.
+00035b10: 6465 6620 6f6e 6573 282a 7369 7a65 3a20  def ones(*size: 
+00035b20: 5369 7a65 2c20 6f75 743d 4e6f 6e65 2c20  Size, out=None, 
+00035b30: 6474 7970 653d 4e6f 6e65 2c20 6c61 796f  dtype=None, layo
+00035b40: 7574 3d74 6f72 6368 2e73 7472 6964 6564  ut=torch.strided
+00035b50: 2c20 6465 7669 6365 3d5f 6465 7669 6365  , device=_device
+00035b60: 2e6d 6169 6e5f 6465 7669 6365 2c20 7265  .main_device, re
+00035b70: 7175 6972 6573 5f67 7261 643d 4661 6c73  quires_grad=Fals
+00035b80: 6529 3a20 2e2e 2e0a 4063 6f6c 6c65 6374  e): ....@collect
+00035b90: 5f6d 656d 6f72 790a 6465 6620 7a65 726f  _memory.def zero
+00035ba0: 7328 2a73 697a 653a 2053 697a 652c 206f  s(*size: Size, o
+00035bb0: 7574 3d4e 6f6e 652c 2064 7479 7065 3d4e  ut=None, dtype=N
+00035bc0: 6f6e 652c 206c 6179 6f75 743d 746f 7263  one, layout=torc
+00035bd0: 682e 7374 7269 6465 642c 2064 6576 6963  h.strided, devic
+00035be0: 653d 5f64 6576 6963 652e 6d61 696e 5f64  e=_device.main_d
+00035bf0: 6576 6963 652c 2072 6571 7569 7265 735f  evice, requires_
+00035c00: 6772 6164 3d46 616c 7365 293a 202e 2e2e  grad=False): ...
+00035c10: 0a40 636f 6c6c 6563 745f 6d65 6d6f 7279  .@collect_memory
+00035c20: 0a64 6566 2065 6d70 7479 5f6c 696b 6528  .def empty_like(
+00035c30: 696e 7075 743a 2054 656e 736f 722c 202a  input: Tensor, *
+00035c40: 2c20 6474 7970 653d 4e6f 6e65 2c20 6c61  , dtype=None, la
+00035c50: 796f 7574 3d4e 6f6e 652c 2064 6576 6963  yout=None, devic
+00035c60: 653d 5f64 6576 6963 652e 6d61 696e 5f64  e=_device.main_d
+00035c70: 6576 6963 652c 2072 6571 7569 7265 735f  evice, requires_
+00035c80: 6772 6164 3d46 616c 7365 2c20 6d65 6d6f  grad=False, memo
+00035c90: 7279 5f66 6f72 6d61 743d 746f 7263 682e  ry_format=torch.
+00035ca0: 7072 6573 6572 7665 5f66 6f72 6d61 7429  preserve_format)
+00035cb0: 3a20 2e2e 2e0a 4063 6f6c 6c65 6374 5f6d  : ....@collect_m
+00035cc0: 656d 6f72 790a 6465 6620 6675 6c6c 5f6c  emory.def full_l
+00035cd0: 696b 6528 696e 7075 743a 2054 656e 736f  ike(input: Tenso
+00035ce0: 722c 2066 696c 6c5f 7661 6c75 653d 302c  r, fill_value=0,
+00035cf0: 202a 2c20 6474 7970 653d 4e6f 6e65 2c20   *, dtype=None, 
+00035d00: 6c61 796f 7574 3d74 6f72 6368 2e73 7472  layout=torch.str
+00035d10: 6964 6564 2c20 6465 7669 6365 3d5f 6465  ided, device=_de
+00035d20: 7669 6365 2e6d 6169 6e5f 6465 7669 6365  vice.main_device
+00035d30: 2c20 7265 7175 6972 6573 5f67 7261 643d  , requires_grad=
+00035d40: 4661 6c73 652c 206d 656d 6f72 795f 666f  False, memory_fo
+00035d50: 726d 6174 3d74 6f72 6368 2e70 7265 7365  rmat=torch.prese
+00035d60: 7276 655f 666f 726d 6174 293a 202e 2e2e  rve_format): ...
+00035d70: 0a40 636f 6c6c 6563 745f 6d65 6d6f 7279  .@collect_memory
+00035d80: 0a64 6566 206f 6e65 735f 6c69 6b65 2869  .def ones_like(i
+00035d90: 6e70 7574 3a20 5465 6e73 6f72 2c20 2a2c  nput: Tensor, *,
+00035da0: 2064 7479 7065 3d4e 6f6e 652c 206c 6179   dtype=None, lay
+00035db0: 6f75 743d 4e6f 6e65 2c20 6465 7669 6365  out=None, device
+00035dc0: 3d5f 6465 7669 6365 2e6d 6169 6e5f 6465  =_device.main_de
+00035dd0: 7669 6365 2c20 7265 7175 6972 6573 5f67  vice, requires_g
+00035de0: 7261 643d 4661 6c73 652c 206d 656d 6f72  rad=False, memor
+00035df0: 795f 666f 726d 6174 3d74 6f72 6368 2e70  y_format=torch.p
+00035e00: 7265 7365 7276 655f 666f 726d 6174 293a  reserve_format):
+00035e10: 202e 2e2e 0a40 636f 6c6c 6563 745f 6d65   ....@collect_me
+00035e20: 6d6f 7279 0a64 6566 207a 6572 6f73 5f6c  mory.def zeros_l
+00035e30: 696b 6528 696e 7075 743a 2054 656e 736f  ike(input: Tenso
+00035e40: 722c 202a 2c20 6474 7970 653d 4e6f 6e65  r, *, dtype=None
+00035e50: 2c20 6c61 796f 7574 3d4e 6f6e 652c 2064  , layout=None, d
+00035e60: 6576 6963 653d 5f64 6576 6963 652e 6d61  evice=_device.ma
+00035e70: 696e 5f64 6576 6963 652c 2072 6571 7569  in_device, requi
+00035e80: 7265 735f 6772 6164 3d46 616c 7365 2c20  res_grad=False, 
+00035e90: 6d65 6d6f 7279 5f66 6f72 6d61 743d 746f  memory_format=to
+00035ea0: 7263 682e 7072 6573 6572 7665 5f66 6f72  rch.preserve_for
+00035eb0: 6d61 7429 3a20 2e2e 2e0a 4063 6f6c 6c65  mat): ....@colle
+00035ec0: 6374 5f6d 656d 6f72 790a 6465 6620 7465  ct_memory.def te
+00035ed0: 6e73 6f72 5f6c 696b 6528 696e 7075 742c  nsor_like(input,
+00035ee0: 2074 6172 6765 743a 2054 656e 736f 722c   target: Tensor,
+00035ef0: 202a 2c20 6474 7970 653d 4e6f 6e65 2c20   *, dtype=None, 
+00035f00: 6465 7669 6365 3d4e 6f6e 652c 2072 6571  device=None, req
+00035f10: 7569 7265 735f 6772 6164 3d4e 6f6e 6529  uires_grad=None)
+00035f20: 3a0a 2020 2020 6966 2064 7479 7065 2069  :.    if dtype i
+00035f30: 7320 4e6f 6e65 3a20 6474 7970 6520 3d20  s None: dtype = 
+00035f40: 7461 7267 6574 2e64 7479 7065 0a20 2020  target.dtype.   
+00035f50: 2069 6620 6465 7669 6365 2069 7320 4e6f   if device is No
+00035f60: 6e65 3a20 6465 7669 6365 203d 2074 6172  ne: device = tar
+00035f70: 6765 742e 6465 7669 6365 0a20 2020 2069  get.device.    i
+00035f80: 6620 7265 7175 6972 6573 5f67 7261 6420  f requires_grad 
+00035f90: 6973 204e 6f6e 653a 2072 6571 7569 7265  is None: require
+00035fa0: 735f 6772 6164 203d 2074 6172 6765 742e  s_grad = target.
+00035fb0: 7265 7175 6972 6573 5f67 7261 640a 2020  requires_grad.  
+00035fc0: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
+00035fd0: 6e63 6528 696e 7075 742c 2074 6f72 6368  nce(input, torch
+00035fe0: 2e54 656e 736f 7229 3a20 696e 7075 7420  .Tensor): input 
+00035ff0: 3d20 746f 7263 682e 7465 6e73 6f72 2869  = torch.tensor(i
+00036000: 6e70 7574 2c20 6474 7970 653d 6474 7970  nput, dtype=dtyp
+00036010: 652c 2064 6576 6963 653d 6465 7669 6365  e, device=device
+00036020: 2c20 7265 7175 6972 6573 5f67 7261 643d  , requires_grad=
+00036030: 7265 7175 6972 6573 5f67 7261 6429 0a20  requires_grad). 
+00036040: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
+00036050: 616e 6365 2869 6e70 7574 2c20 5465 6e73  ance(input, Tens
+00036060: 6f72 293a 2069 6e70 7574 203d 2061 735f  or): input = as_
+00036070: 7465 6e73 6f72 2869 6e70 7574 2e61 735f  tensor(input.as_
+00036080: 7375 6263 6c61 7373 2854 656e 736f 7229  subclass(Tensor)
+00036090: 2e69 6e69 745f 7370 6563 6961 6c28 292c  .init_special(),
+000360a0: 2064 7479 7065 3d64 7479 7065 2c20 6465   dtype=dtype, de
+000360b0: 7669 6365 3d64 6576 6963 6529 2e72 6571  vice=device).req
+000360c0: 7569 7265 735f 6772 6164 5f28 7265 7175  uires_grad_(requ
+000360d0: 6972 6573 5f67 7261 6429 0a20 2020 2065  ires_grad).    e
+000360e0: 6c73 653a 2069 6e70 7574 203d 2061 735f  lse: input = as_
+000360f0: 7465 6e73 6f72 2869 6e70 7574 2c20 6474  tensor(input, dt
+00036100: 7970 653d 6474 7970 652c 2064 6576 6963  ype=dtype, devic
+00036110: 653d 6465 7669 6365 292e 7265 7175 6972  e=device).requir
+00036120: 6573 5f67 7261 645f 2872 6571 7569 7265  es_grad_(require
+00036130: 735f 6772 6164 290a 2020 2020 6966 2069  s_grad).    if i
+00036140: 6e70 7574 2e6e 5f64 696d 203d 3d20 7461  nput.n_dim == ta
+00036150: 7267 6574 2e6e 5f64 696d 3a20 696e 7075  rget.n_dim: inpu
+00036160: 7420 3d20 696e 7075 742e 7370 6563 6961  t = input.specia
+00036170: 6c5f 6672 6f6d 2874 6172 6765 7429 0a20  l_from(target). 
+00036180: 2020 2065 6c73 653a 2069 6e70 7574 203d     else: input =
+00036190: 2069 6e70 7574 2e65 7870 616e 645f 746f   input.expand_to
+000361a0: 2874 6172 6765 7429 0a20 2020 2072 6574  (target).    ret
+000361b0: 7572 6e20 696e 7075 740a 0a40 636f 6c6c  urn input..@coll
+000361c0: 6563 745f 6d65 6d6f 7279 0a64 6566 2072  ect_memory.def r
+000361d0: 616e 6428 2a73 697a 653a 2053 697a 652c  and(*size: Size,
+000361e0: 2067 656e 6572 6174 6f72 3d4e 6f6e 652c   generator=None,
+000361f0: 206f 7574 3d4e 6f6e 652c 2064 7479 7065   out=None, dtype
+00036200: 3d4e 6f6e 652c 206c 6179 6f75 743d 746f  =None, layout=to
+00036210: 7263 682e 7374 7269 6465 642c 2064 6576  rch.strided, dev
+00036220: 6963 653d 5f64 6576 6963 652e 6d61 696e  ice=_device.main
+00036230: 5f64 6576 6963 652c 2072 6571 7569 7265  _device, require
+00036240: 735f 6772 6164 3d46 616c 7365 2c20 7069  s_grad=False, pi
+00036250: 6e5f 6d65 6d6f 7279 3d46 616c 7365 293a  n_memory=False):
+00036260: 202e 2e2e 0a40 636f 6c6c 6563 745f 6d65   ....@collect_me
+00036270: 6d6f 7279 0a64 6566 2072 616e 646e 282a  mory.def randn(*
+00036280: 7369 7a65 3a20 5369 7a65 2c20 6f75 743d  size: Size, out=
+00036290: 4e6f 6e65 2c20 6474 7970 653d 4e6f 6e65  None, dtype=None
+000362a0: 2c20 6c61 796f 7574 3d74 6f72 6368 2e73  , layout=torch.s
+000362b0: 7472 6964 6564 2c20 6465 7669 6365 3d5f  trided, device=_
+000362c0: 6465 7669 6365 2e6d 6169 6e5f 6465 7669  device.main_devi
+000362d0: 6365 2c20 7265 7175 6972 6573 5f67 7261  ce, requires_gra
+000362e0: 643d 4661 6c73 652c 2070 696e 5f6d 656d  d=False, pin_mem
+000362f0: 6f72 793d 4661 6c73 6529 3a20 2e2e 2e0a  ory=False): ....
+00036300: 4063 6f6c 6c65 6374 5f6d 656d 6f72 790a  @collect_memory.
+00036310: 6465 6620 7261 6e64 5f6c 696b 6528 696e  def rand_like(in
+00036320: 7075 743a 2054 656e 736f 722c 202a 2c20  put: Tensor, *, 
+00036330: 6474 7970 653d 4e6f 6e65 2c20 6c61 796f  dtype=None, layo
+00036340: 7574 3d4e 6f6e 652c 2064 6576 6963 653d  ut=None, device=
+00036350: 5f64 6576 6963 652e 6d61 696e 5f64 6576  _device.main_dev
+00036360: 6963 652c 2072 6571 7569 7265 735f 6772  ice, requires_gr
+00036370: 6164 3d46 616c 7365 2c20 6d65 6d6f 7279  ad=False, memory
+00036380: 5f66 6f72 6d61 743d 746f 7263 682e 7072  _format=torch.pr
+00036390: 6573 6572 7665 5f66 6f72 6d61 7429 3a20  eserve_format): 
+000363a0: 2e2e 2e0a 4063 6f6c 6c65 6374 5f6d 656d  ....@collect_mem
+000363b0: 6f72 790a 6465 6620 7261 6e64 6e5f 6c69  ory.def randn_li
+000363c0: 6b65 2869 6e70 7574 3a20 5465 6e73 6f72  ke(input: Tensor
+000363d0: 2c20 2a2c 2064 7479 7065 3d4e 6f6e 652c  , *, dtype=None,
+000363e0: 206c 6179 6f75 743d 4e6f 6e65 2c20 6465   layout=None, de
+000363f0: 7669 6365 3d5f 6465 7669 6365 2e6d 6169  vice=_device.mai
+00036400: 6e5f 6465 7669 6365 2c20 7265 7175 6972  n_device, requir
+00036410: 6573 5f67 7261 643d 4661 6c73 652c 206d  es_grad=False, m
+00036420: 656d 6f72 795f 666f 726d 6174 3d74 6f72  emory_format=tor
+00036430: 6368 2e70 7265 7365 7276 655f 666f 726d  ch.preserve_form
+00036440: 6174 293a 202e 2e2e 0a40 636f 6c6c 6563  at): ....@collec
+00036450: 745f 6d65 6d6f 7279 0a64 6566 2072 616e  t_memory.def ran
+00036460: 6470 6572 6d28 2a6e 3a20 5369 7a65 2c20  dperm(*n: Size, 
+00036470: 6765 6e65 7261 746f 723d 4e6f 6e65 2c20  generator=None, 
+00036480: 6f75 743d 4e6f 6e65 2c20 6474 7970 653d  out=None, dtype=
+00036490: 746f 7263 682e 696e 7436 342c 6c61 796f  torch.int64,layo
+000364a0: 7574 3d74 6f72 6368 2e73 7472 6964 6564  ut=torch.strided
+000364b0: 2c20 6465 7669 6365 3d5f 6465 7669 6365  , device=_device
+000364c0: 2e6d 6169 6e5f 6465 7669 6365 2c20 7265  .main_device, re
+000364d0: 7175 6972 6573 5f67 7261 643d 4661 6c73  quires_grad=Fals
+000364e0: 652c 2070 696e 5f6d 656d 6f72 793d 4661  e, pin_memory=Fa
+000364f0: 6c73 6529 3a0a 2020 2020 6176 6f75 6368  lse):.    avouch
+00036500: 286e 2e6e 5f73 7061 6365 5f64 696d 203d  (n.n_space_dim =
+00036510: 3d20 312c 2054 7970 6545 7272 6f72 2822  = 1, TypeError("
+00036520: 2774 6f72 6368 2e72 616e 6470 6572 6d27  'torch.randperm'
+00036530: 206f 6e6c 7920 6163 6365 7074 7320 3120   only accepts 1 
+00036540: 7370 6163 6520 6469 6d65 6e73 696f 6e20  space dimension 
+00036550: 666f 7220 7065 726d 7574 6174 696f 6e2e  for permutation.
+00036560: 2022 2929 0a20 2020 206e 5f62 6174 6368   ")).    n_batch
+00036570: 203d 2028 6e2e 6e5f 6261 7463 6820 6966   = (n.n_batch if
+00036580: 206e 2e68 6173 5f62 6174 6368 2065 6c73   n.has_batch els
+00036590: 6520 3129 202a 2028 6e2e 6e5f 6665 6174  e 1) * (n.n_feat
+000365a0: 7572 6520 6966 206e 2e68 6173 5f66 6561  ure if n.has_fea
+000365b0: 7475 7265 2065 6c73 6520 3129 202a 2028  ture else 1) * (
+000365c0: 6e2e 6e5f 7365 7175 656e 6365 2069 6620  n.n_sequence if 
+000365d0: 6e2e 6861 735f 7365 7175 656e 6365 2065  n.has_sequence e
+000365e0: 6c73 6520 3129 0a20 2020 2077 6974 6820  lse 1).    with 
+000365f0: 746f 7263 682e 5f43 2e44 6973 6162 6c65  torch._C.Disable
+00036600: 546f 7263 6846 756e 6374 696f 6e28 293a  TorchFunction():
+00036610: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
+00036620: 3d20 7374 6163 6b28 5b74 6f72 6368 2e72  = stack([torch.r
+00036630: 616e 6470 6572 6d28 2a6e 2e73 7061 6365  andperm(*n.space
+00036640: 2c67 656e 6572 6174 6f72 3d67 656e 6572  ,generator=gener
+00036650: 6174 6f72 2c6f 7574 3d6f 7574 2c64 7479  ator,out=out,dty
+00036660: 7065 3d64 7479 7065 2c6c 6179 6f75 743d  pe=dtype,layout=
+00036670: 6c61 796f 7574 2c64 6576 6963 653d 6465  layout,device=de
+00036680: 7669 6365 2c72 6571 7569 7265 735f 6772  vice,requires_gr
+00036690: 6164 3d72 6571 7569 7265 735f 6772 6164  ad=requires_grad
+000366a0: 2c70 696e 5f6d 656d 6f72 793d 7069 6e5f  ,pin_memory=pin_
+000366b0: 6d65 6d6f 7279 292e 6173 5f73 7562 636c  memory).as_subcl
+000366c0: 6173 7328 5465 6e73 6f72 292e 696e 6974  ass(Tensor).init
+000366d0: 5f73 7065 6369 616c 2829 2066 6f72 205f  _special() for _
+000366e0: 2069 6e20 7261 6e67 655f 286e 5f62 6174   in range_(n_bat
+000366f0: 6368 295d 2c20 7b7d 290a 2020 2020 6966  ch)], {}).    if
+00036700: 206e 5f62 6174 6368 203d 3d20 303a 2072   n_batch == 0: r
+00036710: 6573 756c 7420 3d20 7a65 726f 7328 7b30  esult = zeros({0
+00036720: 7d2c 206e 2e73 7061 6365 5b30 5d29 2e6c  }, n.space[0]).l
+00036730: 6f6e 6728 290a 2020 2020 7265 7475 726e  ong().    return
+00036740: 2072 6573 756c 742e 7370 6c69 745f 6469   result.split_di
+00036750: 6d28 7b7d 2c20 6e2e 7769 7468 5f73 7061  m({}, n.with_spa
+00036760: 6365 2829 292e 6d6f 7665 5f64 696d 282d  ce()).move_dim(-
+00036770: 312c 206e 2e73 7061 6365 5f73 7461 7274  1, n.space_start
+00036780: 290a 4063 6f6c 6c65 6374 5f6d 656d 6f72  ).@collect_memor
+00036790: 790a 6465 6620 6172 616e 6765 282a 7374  y.def arange(*st
+000367a0: 6172 745f 7374 6f70 5f73 7465 702c 206f  art_stop_step, o
+000367b0: 7574 3d4e 6f6e 652c 2064 7479 7065 3d4e  ut=None, dtype=N
+000367c0: 6f6e 652c 206c 6179 6f75 743d 746f 7263  one, layout=torc
+000367d0: 682e 7374 7269 6465 642c 2064 6576 6963  h.strided, devic
+000367e0: 653d 5f64 6576 6963 652e 6d61 696e 5f64  e=_device.main_d
+000367f0: 6576 6963 652c 2072 6571 7569 7265 735f  evice, requires_
+00036800: 6772 6164 3d46 616c 7365 293a 0a20 2020  grad=False):.   
+00036810: 2073 7461 7274 5f73 746f 705f 7374 6570   start_stop_step
+00036820: 203d 2053 697a 6528 2a73 7461 7274 5f73   = Size(*start_s
+00036830: 746f 705f 7374 6570 290a 2020 2020 7769  top_step).    wi
+00036840: 7468 2074 6f72 6368 2e5f 432e 4469 7361  th torch._C.Disa
+00036850: 626c 6554 6f72 6368 4675 6e63 7469 6f6e  bleTorchFunction
+00036860: 2829 3a0a 2020 2020 2020 2020 6f62 6a20  ():.        obj 
+00036870: 3d20 746f 7263 682e 6172 616e 6765 282a  = torch.arange(*
+00036880: 7374 6172 745f 7374 6f70 5f73 7465 702c  start_stop_step,
+00036890: 6f75 743d 6f75 742c 6474 7970 653d 6474  out=out,dtype=dt
+000368a0: 7970 652c 6c61 796f 7574 3d6c 6179 6f75  ype,layout=layou
+000368b0: 742c 6465 7669 6365 3d64 6576 6963 652c  t,device=device,
+000368c0: 7265 7175 6972 6573 5f67 7261 643d 7265  requires_grad=re
+000368d0: 7175 6972 6573 5f67 7261 6429 0a20 2020  quires_grad).   
+000368e0: 206f 626a 203d 206f 626a 2e61 735f 7375   obj = obj.as_su
+000368f0: 6263 6c61 7373 2854 656e 736f 7229 2e73  bclass(Tensor).s
+00036900: 7065 6369 616c 5f66 726f 6d28 7374 6172  pecial_from(star
+00036910: 745f 7374 6f70 5f73 7465 705b 3a31 5d29  t_stop_step[:1])
+00036920: 2023 2073 7570 7072 6573 733a 2073 7065   # suppress: spe
+00036930: 6369 616c 5f66 726f 6d0a 0a64 6566 2077  cial_from..def w
+00036940: 6865 7265 2863 6f6e 6469 7469 6f6e 3a20  here(condition: 
+00036950: 2754 656e 736f 7227 2c20 696e 7075 743a  'Tensor', input:
+00036960: 2027 5465 6e73 6f72 272c 206f 7468 6572   'Tensor', other
+00036970: 3a20 2754 656e 736f 7227 2c20 2a2c 206f  : 'Tensor', *, o
+00036980: 7574 3d4e 6f6e 6529 3a20 2e2e 2e0a 0a64  ut=None): .....d
+00036990: 6566 2072 6573 6861 7065 2873 656c 662c  ef reshape(self,
+000369a0: 202a 7369 7a65 3a20 5369 7a65 293a 202e   *size: Size): .
+000369b0: 2e2e 0a0a 6465 6620 6361 7428 2a74 656e  ....def cat(*ten
+000369c0: 736f 7273 2c20 6469 6d3d 4e6f 6e65 2c20  sors, dim=None, 
+000369d0: 6372 6f70 3d46 616c 7365 2c20 6f75 743d  crop=False, out=
+000369e0: 4e6f 6e65 293a 0a20 2020 2022 2222 0a20  None):.    """. 
+000369f0: 2020 2043 6f6e 6361 7465 6e61 7465 2074     Concatenate t
+00036a00: 656e 736f 7273 2061 6c6f 6e67 2064 696d  ensors along dim
+00036a10: 656e 7369 6f6e 2060 6469 6d60 2e20 0a0a  ension `dim`. ..
+00036a20: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00036a30: 2020 6469 6d20 2869 6e74 2f65 7869 7374    dim (int/exist
+00036a40: 5f64 696d 2c20 6f70 7469 6f6e 616c 293a  _dim, optional):
+00036a50: 2054 6865 2064 696d 656e 7369 6f6e 2066   The dimension f
+00036a60: 6f72 2063 6f6e 6361 7465 6e61 7469 6f6e  or concatenation
+00036a70: 2e20 0a20 2020 2020 2020 2020 2020 2044  . .            D
+00036a80: 6566 6175 6c74 7320 746f 2061 7574 6f20  efaults to auto 
+00036a90: 636f 6e63 6174 656e 6174 696f 6e20 6174  concatenation at
+00036aa0: 0a20 2020 2020 2020 2020 2020 2028 3129  .            (1)
+00036ab0: 2074 6865 2066 6972 7374 2066 6561 7475   the first featu
+00036ac0: 7265 2064 696d 656e 7369 6f6e 2069 6620  re dimension if 
+00036ad0: 7465 6e73 6f72 7320 6861 7665 2066 6561  tensors have fea
+00036ae0: 7475 7265 3b0a 2020 2020 2020 2020 2020  ture;.          
+00036af0: 2020 2832 2920 7468 6520 6261 7463 6820    (2) the batch 
+00036b00: 6469 6d65 6e73 696f 6e20 6966 2074 656e  dimension if ten
+00036b10: 736f 7273 2068 6176 6520 6261 7463 683b  sors have batch;
+00036b20: 0a20 2020 2020 2020 2020 2020 2028 3329  .            (3)
+00036b30: 2074 6865 2066 6972 7374 2073 6571 7565   the first seque
+00036b40: 6e63 6520 6469 6d65 6e73 696f 6e20 6966  nce dimension if
+00036b50: 2074 656e 736f 7273 2068 6176 6520 7365   tensors have se
+00036b60: 7175 656e 6365 3b0a 2020 2020 2020 2020  quence;.        
+00036b70: 2020 2020 2834 2920 7468 6520 6669 7273      (4) the firs
+00036b80: 7420 7370 6163 6961 6c20 6469 6d65 6e73  t spacial dimens
+00036b90: 696f 6e20 6f74 6865 7277 6973 652e 0a20  ion otherwise.. 
+00036ba0: 2020 2020 2020 2063 726f 7020 2862 6f6f         crop (boo
+00036bb0: 6c29 3a20 5768 6574 6865 7220 746f 2063  l): Whether to c
+00036bc0: 726f 7020 7468 6520 7369 7a65 7320 6175  rop the sizes au
+00036bd0: 746f 6d61 7469 6361 6c6c 7920 7768 656e  tomatically when
+00036be0: 206e 6563 6573 7361 7279 2e20 0a20 2020   necessary. .   
+00036bf0: 2022 2222 0a20 2020 2066 726f 6d20 2e74   """.    from .t
+00036c00: 656e 736f 7266 756e 6320 696d 706f 7274  ensorfunc import
+00036c10: 2063 726f 705f 6173 0a20 2020 2069 6620   crop_as.    if 
+00036c20: 6c65 6e28 7465 6e73 6f72 7329 203d 3d20  len(tensors) == 
+00036c30: 303a 2072 6574 7572 6e20 7465 6e73 6f72  0: return tensor
+00036c40: 285b 5d29 0a20 2020 2065 6c69 6620 6c65  ([]).    elif le
+00036c50: 6e28 7465 6e73 6f72 7329 203d 3d20 3120  n(tensors) == 1 
+00036c60: 616e 6420 6973 696e 7374 616e 6365 2874  and isinstance(t
+00036c70: 656e 736f 7273 5b30 5d2c 2028 6c69 7374  ensors[0], (list
+00036c80: 2c20 7475 706c 6529 293a 2074 656e 736f  , tuple)): tenso
+00036c90: 7273 203d 2074 7570 6c65 2874 656e 736f  rs = tuple(tenso
+00036ca0: 7273 5b30 5d29 0a20 2020 2065 6c69 6620  rs[0]).    elif 
+00036cb0: 6c65 6e28 7465 6e73 6f72 7329 203d 3d20  len(tensors) == 
+00036cc0: 3220 616e 6420 6973 696e 7374 616e 6365  2 and isinstance
+00036cd0: 2874 656e 736f 7273 5b30 5d2c 2028 6c69  (tensors[0], (li
+00036ce0: 7374 2c20 7475 706c 6529 2920 616e 6420  st, tuple)) and 
+00036cf0: 6973 696e 7374 616e 6365 2874 656e 736f  isinstance(tenso
+00036d00: 7273 5b31 5d2c 2065 7869 7374 5f64 696d  rs[1], exist_dim
+00036d10: 293a 0a20 2020 2020 2020 2061 766f 7563  ):.        avouc
+00036d20: 6828 6469 6d20 6973 204e 6f6e 652c 2054  h(dim is None, T
+00036d30: 7970 6545 7272 6f72 2866 2243 616e 6e6f  ypeError(f"Canno
+00036d40: 7420 636f 6e63 6174 656e 6174 6520 7465  t concatenate te
+00036d50: 6e73 6f72 7320 6279 206d 756c 7469 706c  nsors by multipl
+00036d60: 6520 6469 6d65 6e73 696f 6e73 2e22 2929  e dimensions."))
+00036d70: 0a20 2020 2020 2020 2064 696d 203d 2074  .        dim = t
+00036d80: 656e 736f 7273 5b31 5d0a 2020 2020 2020  ensors[1].      
+00036d90: 2020 7465 6e73 6f72 7320 3d20 7475 706c    tensors = tupl
+00036da0: 6528 7465 6e73 6f72 735b 305d 290a 2020  e(tensors[0]).  
+00036db0: 2020 656c 6966 206c 656e 2874 656e 736f    elif len(tenso
+00036dc0: 7273 2920 3e20 3220 616e 6420 6973 696e  rs) > 2 and isin
+00036dd0: 7374 616e 6365 2874 656e 736f 7273 5b2d  stance(tensors[-
+00036de0: 315d 2c20 6578 6973 745f 6469 6d29 3a0a  1], exist_dim):.
+00036df0: 2020 2020 2020 2020 6176 6f75 6368 2864          avouch(d
+00036e00: 696d 2069 7320 4e6f 6e65 2c20 5479 7065  im is None, Type
+00036e10: 4572 726f 7228 6622 4361 6e6e 6f74 2063  Error(f"Cannot c
+00036e20: 6f6e 6361 7465 6e61 7465 2074 656e 736f  oncatenate tenso
+00036e30: 7273 2062 7920 6d75 6c74 6970 6c65 2064  rs by multiple d
+00036e40: 696d 656e 7369 6f6e 732e 2229 290a 2020  imensions.")).  
+00036e50: 2020 2020 2020 6469 6d20 3d20 7465 6e73        dim = tens
+00036e60: 6f72 735b 2d31 5d0a 2020 2020 2020 2020  ors[-1].        
+00036e70: 7465 6e73 6f72 7320 3d20 7475 706c 6528  tensors = tuple(
+00036e80: 7465 6e73 6f72 735b 3a2d 315d 290a 2020  tensors[:-1]).  
+00036e90: 2020 6176 6f75 6368 2861 6c6c 5f28 6973    avouch(all_(is
+00036ea0: 696e 7374 616e 6365 2878 2c20 746f 7263  instance(x, torc
+00036eb0: 682e 5465 6e73 6f72 2920 666f 7220 7820  h.Tensor) for x 
+00036ec0: 696e 2074 656e 736f 7273 292c 2054 7970  in tensors), Typ
+00036ed0: 6545 7272 6f72 2866 2227 6274 2e63 6174  eError(f"'bt.cat
+00036ee0: 2720 6361 6e20 6f6e 6c79 2063 6f6e 6361  ' can only conca
+00036ef0: 7465 6e61 7465 2074 6f72 6368 2e54 656e  tenate torch.Ten
+00036f00: 736f 7220 6f62 6a65 6374 732e 2022 2929  sor objects. "))
+00036f10: 0a20 2020 2069 6620 6c65 6e28 7465 6e73  .    if len(tens
+00036f20: 6f72 7329 203d 3d20 303a 2072 6574 7572  ors) == 0: retur
+00036f30: 6e20 7465 6e73 6f72 285b 5d29 0a20 2020  n tensor([]).   
+00036f40: 2070 6976 6f74 203d 2074 656e 736f 7273   pivot = tensors
+00036f50: 5b61 7267 6d61 785f 285b 782e 6e5f 6469  [argmax_([x.n_di
+00036f60: 6d20 666f 7220 7820 696e 2074 656e 736f  m for x in tenso
+00036f70: 7273 5d29 5b30 5d5d 0a20 2020 2069 6620  rs])[0]].    if 
+00036f80: 6469 6d20 6973 204e 6f6e 653a 0a20 2020  dim is None:.   
+00036f90: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+00036fa0: 7374 616e 6365 2870 6976 6f74 2c20 5465  stance(pivot, Te
+00036fb0: 6e73 6f72 293a 2064 696d 203d 2028 302c  nsor): dim = (0,
+00036fc0: 290a 2020 2020 2020 2020 656c 6966 2070  ).        elif p
+00036fd0: 6976 6f74 2e68 6173 5f66 6561 7475 7265  ivot.has_feature
+00036fe0: 3a20 6469 6d20 3d20 6578 6973 745f 6469  : dim = exist_di
+00036ff0: 6d28 7069 766f 742c 205b 305d 290a 2020  m(pivot, [0]).  
+00037000: 2020 2020 2020 656c 6966 2070 6976 6f74        elif pivot
+00037010: 2e68 6173 5f62 6174 6368 3a20 6469 6d20  .has_batch: dim 
+00037020: 3d20 6578 6973 745f 6469 6d28 7069 766f  = exist_dim(pivo
+00037030: 742c 207b 7d29 0a20 2020 2020 2020 2065  t, {}).        e
+00037040: 6c69 6620 7069 766f 742e 6861 735f 7365  lif pivot.has_se
+00037050: 7175 656e 6365 3a20 6469 6d20 3d20 6578  quence: dim = ex
+00037060: 6973 745f 6469 6d28 7069 766f 742c 2027  ist_dim(pivot, '
+00037070: 3027 290a 2020 2020 2020 2020 656c 7365  0').        else
+00037080: 3a20 6469 6d20 3d20 2830 2c29 0a20 2020  : dim = (0,).   
+00037090: 2065 6c73 653a 2064 696d 203d 2065 7869   else: dim = exi
+000370a0: 7374 5f64 696d 2870 6976 6f74 2c20 6469  st_dim(pivot, di
+000370b0: 6d29 0a20 2020 2061 766f 7563 6828 6c65  m).    avouch(le
+000370c0: 6e28 6469 6d29 203d 3d20 312c 2054 7970  n(dim) == 1, Typ
+000370d0: 6545 7272 6f72 2866 2243 616e 6e6f 7420  eError(f"Cannot 
+000370e0: 636f 6e63 6174 2074 656e 736f 7273 2069  concat tensors i
+000370f0: 6e20 6469 6d65 6e73 696f 6e73 207b 6469  n dimensions {di
+00037100: 6d7d 2c20 706c 6561 7365 2066 6c61 7474  m}, please flatt
+00037110: 656e 2074 6865 6d20 6669 7273 7420 6f72  en them first or
+00037120: 2075 7365 2027 5b30 5d27 2061 6e64 2022   use '[0]' and "
+00037130: 2730 2722 2074 6f20 7370 6563 6966 7920  '0'" to specify 
+00037140: 7468 6520 6669 7273 7420 6665 6174 7572  the first featur
+00037150: 652f 7365 7175 656e 6365 2064 696d 656e  e/sequence dimen
+00037160: 7369 6f6e 2e22 2929 0a20 2020 2064 696d  sion.")).    dim
+00037170: 203d 2064 696d 5b30 5d0a 2020 2020 0a20   = dim[0].    . 
+00037180: 2020 2069 6620 6372 6f70 3a20 6469 6d73     if crop: dims
+00037190: 5f61 6c6c 6f77 5f6d 6973 6d61 7463 6820  _allow_mismatch 
+000371a0: 3d20 2864 696d 2c29 202b 2074 7570 6c65  = (dim,) + tuple
+000371b0: 2872 616e 6765 5f28 7069 766f 742e 7370  (range_(pivot.sp
+000371c0: 6163 655f 7374 6172 742c 2070 6976 6f74  ace_start, pivot
+000371d0: 2e73 7061 6365 5f73 746f 7029 290a 2020  .space_stop)).  
+000371e0: 2020 656c 7365 3a20 6469 6d73 5f61 6c6c    else: dims_all
+000371f0: 6f77 5f6d 6973 6d61 7463 6820 3d20 6469  ow_mismatch = di
+00037200: 6d0a 2020 2020 7472 793a 2074 656e 736f  m.    try: tenso
+00037210: 7273 203d 205b 782e 6578 7061 6e64 5f74  rs = [x.expand_t
+00037220: 6f28 7069 766f 742c 2064 696d 735f 616c  o(pivot, dims_al
+00037230: 6c6f 775f 6d69 736d 6174 6368 3d64 696d  low_mismatch=dim
+00037240: 735f 616c 6c6f 775f 6d69 736d 6174 6368  s_allow_mismatch
+00037250: 2920 666f 7220 7820 696e 2074 656e 736f  ) for x in tenso
+00037260: 7273 2069 6620 782e 6e5f 656c 6520 3e20  rs if x.n_ele > 
+00037270: 305d 0a20 2020 2065 7863 6570 7420 5479  0].    except Ty
+00037280: 7065 4572 726f 7220 6173 2065 3a0a 2020  peError as e:.  
+00037290: 2020 2020 2020 6966 2022 4361 6e6e 6f74        if "Cannot
+000372a0: 2065 7870 616e 6420 7465 6e73 6f72 2220   expand tensor" 
+000372b0: 696e 2073 7472 2865 2920 6f72 2022 5369  in str(e) or "Si
+000372c0: 7a65 206d 6973 6d61 7463 6820 696e 2027  ze mismatch in '
+000372d0: 6578 7061 6e64 5f74 6f27 2220 696e 2073  expand_to'" in s
+000372e0: 7472 2865 293a 0a20 2020 2020 2020 2020  tr(e):.         
+000372f0: 2020 2072 6169 7365 2054 7970 6545 7272     raise TypeErr
+00037300: 6f72 2822 5465 6e73 6f72 7320 6361 6e20  or("Tensors can 
+00037310: 6f6e 6c79 2062 6520 636f 6e63 6174 656e  only be concaten
+00037320: 6174 6564 2077 6865 6e20 616c 6c20 6f66  ated when all of
+00037330: 2074 6865 6d20 6861 7665 2061 2073 616d   them have a sam
+00037340: 6520 7368 6170 6520 6578 6365 7074 2066  e shape except f
+00037350: 6f72 206f 6e65 2064 696d 656e 7369 6f6e  or one dimension
+00037360: 2e20 2220 2b20 6622 4375 7272 656e 746c  . " + f"Currentl
+00037370: 793a 207b 5b78 2e73 6861 7065 2066 6f72  y: {[x.shape for
+00037380: 2078 2069 6e20 7465 6e73 6f72 735d 7d22   x in tensors]}"
+00037390: 290a 2020 2020 2020 2020 656c 7365 3a20  ).        else: 
+000373a0: 7261 6973 6520 650a 2020 2020 6966 2063  raise e.    if c
+000373b0: 726f 703a 2074 656e 736f 7273 203d 205b  rop: tensors = [
+000373c0: 7820 6966 2078 2e73 6861 7065 5b3a 6469  x if x.shape[:di
+000373d0: 6d5d 203d 3d20 7069 766f 742e 7368 6170  m] == pivot.shap
+000373e0: 655b 3a64 696d 5d20 616e 6420 782e 7368  e[:dim] and x.sh
+000373f0: 6170 655b 6469 6d2b 313a 5d20 3d3d 2070  ape[dim+1:] == p
+00037400: 6976 6f74 2e73 6861 7065 5b64 696d 2b31  ivot.shape[dim+1
+00037410: 3a5d 2065 6c73 6520 6372 6f70 5f61 7328  :] else crop_as(
+00037420: 782c 2070 6976 6f74 2e73 7061 6365 2920  x, pivot.space) 
+00037430: 666f 7220 7820 696e 2074 656e 736f 7273  for x in tensors
+00037440: 5d0a 2020 2020 0a20 2020 2062 745f 7465  ].    .    bt_te
+00037450: 6e73 6f72 7320 3d20 5b74 2066 6f72 2074  nsors = [t for t
+00037460: 2069 6e20 7465 6e73 6f72 7320 6966 2069   in tensors if i
+00037470: 7369 6e73 7461 6e63 6528 742c 2054 656e  sinstance(t, Ten
+00037480: 736f 7229 5d0a 2020 2020 7769 7468 2074  sor)].    with t
+00037490: 6f72 6368 2e5f 432e 4469 7361 626c 6554  orch._C.DisableT
+000374a0: 6f72 6368 4675 6e63 7469 6f6e 2829 3a0a  orchFunction():.
+000374b0: 2020 2020 2020 2020 6966 206c 656e 2862          if len(b
+000374c0: 745f 7465 6e73 6f72 7329 203d 3d20 303a  t_tensors) == 0:
+000374d0: 2072 6574 7572 6e20 746f 7263 682e 6361   return torch.ca
+000374e0: 7428 7465 6e73 6f72 732c 2064 696d 2c20  t(tensors, dim, 
+000374f0: 6f75 743d 6f75 7429 2e61 735f 7375 6263  out=out).as_subc
+00037500: 6c61 7373 2854 656e 736f 7229 0a20 2020  lass(Tensor).   
+00037510: 2020 2020 2065 6c73 653a 2072 6574 7572       else: retur
+00037520: 6e20 746f 7263 682e 6361 7428 7465 6e73  n torch.cat(tens
+00037530: 6f72 732c 2064 696d 2c20 6f75 743d 6f75  ors, dim, out=ou
+00037540: 7429 2e61 735f 7375 6263 6c61 7373 2854  t).as_subclass(T
+00037550: 656e 736f 7229 2e73 7065 6369 616c 5f66  ensor).special_f
+00037560: 726f 6d28 6274 5f74 656e 736f 7273 5b30  rom(bt_tensors[0
+00037570: 5d29 0a0a 6465 6620 7374 6163 6b28 2a74  ])..def stack(*t
+00037580: 656e 736f 7273 2c20 6469 6d3d 4e6f 6e65  ensors, dim=None
+00037590: 2c20 6372 6f70 3d46 616c 7365 2c20 6f75  , crop=False, ou
+000375a0: 743d 4e6f 6e65 293a 0a20 2020 2022 2222  t=None):.    """
+000375b0: 0a20 2020 2053 7461 636b 2074 656e 736f  .    Stack tenso
+000375c0: 7273 2061 6c6f 6e67 2061 206e 6577 2064  rs along a new d
+000375d0: 696d 656e 7369 6f6e 2060 6469 6d60 2e20  imension `dim`. 
+000375e0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+000375f0: 2020 2020 6469 6d20 2869 6e74 2f6e 6577      dim (int/new
+00037600: 5f64 696d 2c20 6f70 7469 6f6e 616c 293a  _dim, optional):
+00037610: 2054 6865 2064 696d 656e 7369 6f6e 2066   The dimension f
+00037620: 6f72 2073 7461 636b 696e 672e 200a 2020  or stacking. .  
+00037630: 2020 2020 2020 2020 2020 4465 6661 756c            Defaul
+00037640: 7473 2074 6f20 6175 746f 2073 7461 636b  ts to auto stack
+00037650: 2061 740a 2020 2020 2020 2020 2020 2020   at.            
+00037660: 2831 2920 6120 6e65 7720 6261 7463 6820  (1) a new batch 
+00037670: 6469 6d65 6e73 696f 6e20 6966 2074 656e  dimension if ten
+00037680: 736f 7273 2068 6176 6520 6e6f 2062 6174  sors have no bat
+00037690: 6368 3b0a 2020 2020 2020 2020 2020 2020  ch;.            
+000376a0: 2832 2920 6120 6e65 7720 6665 6174 7572  (2) a new featur
+000376b0: 6520 6469 6d65 6e73 696f 6e20 6966 2074  e dimension if t
+000376c0: 656e 736f 7273 2068 6176 6520 6261 7463  ensors have batc
+000376d0: 6820 6469 6d65 6e73 696f 6e3b 0a20 2020  h dimension;.   
+000376e0: 2020 2020 2063 726f 7020 2862 6f6f 6c29       crop (bool)
+000376f0: 3a20 5768 6574 6865 7220 746f 2063 726f  : Whether to cro
+00037700: 7020 7468 6520 7369 7a65 7320 6175 746f  p the sizes auto
+00037710: 6d61 7469 6361 6c6c 7920 7768 656e 206e  matically when n
+00037720: 6563 6573 7361 7279 2e20 0a20 2020 2022  ecessary. .    "
+00037730: 2222 0a20 2020 2066 726f 6d20 2e74 656e  "".    from .ten
+00037740: 736f 7266 756e 6320 696d 706f 7274 2063  sorfunc import c
+00037750: 726f 705f 6173 0a20 2020 2069 6620 6c65  rop_as.    if le
+00037760: 6e28 7465 6e73 6f72 7329 203d 3d20 303a  n(tensors) == 0:
+00037770: 2072 6574 7572 6e20 7465 6e73 6f72 285b   return tensor([
+00037780: 5d29 0a20 2020 2065 6c69 6620 6c65 6e28  ]).    elif len(
+00037790: 7465 6e73 6f72 7329 203d 3d20 3120 616e  tensors) == 1 an
+000377a0: 6420 6973 696e 7374 616e 6365 2874 656e  d isinstance(ten
+000377b0: 736f 7273 5b30 5d2c 2028 6c69 7374 2c20  sors[0], (list, 
+000377c0: 7475 706c 6529 293a 2074 656e 736f 7273  tuple)): tensors
+000377d0: 203d 2074 7570 6c65 2874 656e 736f 7273   = tuple(tensors
+000377e0: 5b30 5d29 0a20 2020 2065 6c69 6620 6c65  [0]).    elif le
+000377f0: 6e28 7465 6e73 6f72 7329 203d 3d20 3220  n(tensors) == 2 
+00037800: 616e 6420 6973 696e 7374 616e 6365 2874  and isinstance(t
+00037810: 656e 736f 7273 5b30 5d2c 2028 6c69 7374  ensors[0], (list
+00037820: 2c20 7475 706c 6529 2920 616e 6420 6973  , tuple)) and is
+00037830: 696e 7374 616e 6365 2874 656e 736f 7273  instance(tensors
+00037840: 5b31 5d2c 206e 6577 5f64 696d 293a 0a20  [1], new_dim):. 
+00037850: 2020 2020 2020 2061 766f 7563 6828 6469         avouch(di
+00037860: 6d20 6973 204e 6f6e 652c 2054 7970 6545  m is None, TypeE
+00037870: 7272 6f72 2866 2243 616e 6e6f 7420 7374  rror(f"Cannot st
+00037880: 6163 6b20 7465 6e73 6f72 7320 6279 206d  ack tensors by m
+00037890: 756c 7469 706c 6520 6469 6d65 6e73 696f  ultiple dimensio
+000378a0: 6e73 2e22 2929 0a20 2020 2020 2020 2064  ns.")).        d
+000378b0: 696d 203d 2074 656e 736f 7273 5b31 5d0a  im = tensors[1].
+000378c0: 2020 2020 2020 2020 7465 6e73 6f72 7320          tensors 
+000378d0: 3d20 7475 706c 6528 7465 6e73 6f72 735b  = tuple(tensors[
+000378e0: 305d 290a 2020 2020 656c 6966 206c 656e  0]).    elif len
+000378f0: 2874 656e 736f 7273 2920 3e20 3220 616e  (tensors) > 2 an
+00037900: 6420 6973 696e 7374 616e 6365 2874 656e  d isinstance(ten
+00037910: 736f 7273 5b2d 315d 2c20 6e65 775f 6469  sors[-1], new_di
+00037920: 6d29 3a0a 2020 2020 2020 2020 6176 6f75  m):.        avou
+00037930: 6368 2864 696d 2069 7320 4e6f 6e65 2c20  ch(dim is None, 
+00037940: 5479 7065 4572 726f 7228 6622 4361 6e6e  TypeError(f"Cann
+00037950: 6f74 2073 7461 636b 2074 656e 736f 7273  ot stack tensors
+00037960: 2062 7920 6d75 6c74 6970 6c65 2064 696d   by multiple dim
+00037970: 656e 7369 6f6e 732e 2229 290a 2020 2020  ensions.")).    
+00037980: 2020 2020 6469 6d20 3d20 7465 6e73 6f72      dim = tensor
+00037990: 735b 2d31 5d0a 2020 2020 2020 2020 7465  s[-1].        te
+000379a0: 6e73 6f72 7320 3d20 7475 706c 6528 7465  nsors = tuple(te
+000379b0: 6e73 6f72 735b 3a2d 315d 290a 2020 2020  nsors[:-1]).    
+000379c0: 6176 6f75 6368 2861 6c6c 5f28 6973 696e  avouch(all_(isin
+000379d0: 7374 616e 6365 2878 2c20 746f 7263 682e  stance(x, torch.
+000379e0: 5465 6e73 6f72 2920 666f 7220 7820 696e  Tensor) for x in
+000379f0: 2074 656e 736f 7273 292c 2054 7970 6545   tensors), TypeE
+00037a00: 7272 6f72 2866 2227 6274 2e73 7461 636b  rror(f"'bt.stack
+00037a10: 2720 6361 6e20 6f6e 6c79 2073 7461 636b  ' can only stack
+00037a20: 2074 6f72 6368 2e54 656e 736f 7220 6f62   torch.Tensor ob
+00037a30: 6a65 6374 732e 2022 2929 0a20 2020 2069  jects. ")).    i
+00037a40: 6620 6c65 6e28 7465 6e73 6f72 7329 203d  f len(tensors) =
+00037a50: 3d20 303a 2072 6574 7572 6e20 7465 6e73  = 0: return tens
+00037a60: 6f72 285b 5d29 0a20 2020 2070 6976 6f74  or([]).    pivot
+00037a70: 203d 2074 656e 736f 7273 5b61 7267 6d61   = tensors[argma
+00037a80: 785f 285b 782e 6e5f 6469 6d20 666f 7220  x_([x.n_dim for 
+00037a90: 7820 696e 2074 656e 736f 7273 5d29 5b30  x in tensors])[0
+00037aa0: 5d5d 0a20 2020 2069 6620 6469 6d20 6973  ]].    if dim is
+00037ab0: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+00037ac0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+00037ad0: 2870 6976 6f74 2c20 5465 6e73 6f72 293a  (pivot, Tensor):
+00037ae0: 2064 696d 203d 206e 6577 5f64 696d 2870   dim = new_dim(p
+00037af0: 6976 6f74 2c20 7b7d 290a 2020 2020 2020  ivot, {}).      
+00037b00: 2020 656c 6966 206e 6f74 2070 6976 6f74    elif not pivot
+00037b10: 2e68 6173 5f62 6174 6368 3a20 6469 6d20  .has_batch: dim 
+00037b20: 3d20 6e65 775f 6469 6d28 7069 766f 742c  = new_dim(pivot,
+00037b30: 207b 7d29 0a20 2020 2020 2020 2065 6c73   {}).        els
+00037b40: 653a 2064 696d 203d 206e 6577 5f64 696d  e: dim = new_dim
+00037b50: 2870 6976 6f74 2c20 5b70 6976 6f74 2e6e  (pivot, [pivot.n
+00037b60: 6f6e 5f62 6174 5f73 7461 7274 5d29 0a20  on_bat_start]). 
+00037b70: 2020 2065 6c73 653a 2064 696d 203d 206e     else: dim = n
+00037b80: 6577 5f64 696d 2870 6976 6f74 2c20 6469  ew_dim(pivot, di
+00037b90: 6d29 0a20 2020 2061 766f 7563 6828 6c65  m).    avouch(le
+00037ba0: 6e28 6469 6d29 203d 3d20 312c 2054 7970  n(dim) == 1, Typ
+00037bb0: 6545 7272 6f72 2866 2243 616e 6e6f 7420  eError(f"Cannot 
+00037bc0: 636f 6e63 6174 2074 656e 736f 7273 2069  concat tensors i
+00037bd0: 6e20 6469 6d65 6e73 696f 6e73 207b 6469  n dimensions {di
+00037be0: 6d7d 2c20 706c 6561 7365 2066 6c61 7474  m}, please flatt
+00037bf0: 656e 2074 6865 6d20 6669 7273 7420 6f72  en them first or
+00037c00: 2075 7365 2027 5b30 5d27 2061 6e64 2022   use '[0]' and "
+00037c10: 2730 2722 2074 6f20 7370 6563 6966 7920  '0'" to specify 
+00037c20: 7468 6520 6669 7273 7420 6665 6174 7572  the first featur
+00037c30: 652f 7365 7175 656e 6365 2064 696d 656e  e/sequence dimen
+00037c40: 7369 6f6e 2e22 2929 0a20 2020 200a 2020  sion.")).    .  
+00037c50: 2020 6966 2063 726f 703a 2064 696d 735f    if crop: dims_
+00037c60: 616c 6c6f 775f 6d69 736d 6174 6368 203d  allow_mismatch =
+00037c70: 2074 7570 6c65 2872 616e 6765 5f28 7069   tuple(range_(pi
+00037c80: 766f 742e 7370 6163 655f 7374 6172 742c  vot.space_start,
+00037c90: 2070 6976 6f74 2e73 7061 6365 5f73 746f   pivot.space_sto
+00037ca0: 7029 290a 2020 2020 656c 7365 3a20 6469  p)).    else: di
+00037cb0: 6d73 5f61 6c6c 6f77 5f6d 6973 6d61 7463  ms_allow_mismatc
+00037cc0: 6820 3d20 4e6f 6e65 0a20 2020 2074 7279  h = None.    try
+00037cd0: 3a20 7465 6e73 6f72 7320 3d20 5b78 2e65  : tensors = [x.e
+00037ce0: 7870 616e 645f 746f 2870 6976 6f74 2c20  xpand_to(pivot, 
+00037cf0: 6469 6d73 5f61 6c6c 6f77 5f6d 6973 6d61  dims_allow_misma
+00037d00: 7463 683d 6469 6d73 5f61 6c6c 6f77 5f6d  tch=dims_allow_m
+00037d10: 6973 6d61 7463 6829 2066 6f72 2078 2069  ismatch) for x i
+00037d20: 6e20 7465 6e73 6f72 7320 6966 2078 2e6e  n tensors if x.n
+00037d30: 5f65 6c65 203e 2030 5d0a 2020 2020 6578  _ele > 0].    ex
+00037d40: 6365 7074 2054 7970 6545 7272 6f72 2061  cept TypeError a
+00037d50: 7320 653a 0a20 2020 2020 2020 2069 6620  s e:.        if 
+00037d60: 2243 616e 6e6f 7420 6578 7061 6e64 2074  "Cannot expand t
+00037d70: 656e 736f 7222 2069 6e20 7374 7228 6529  ensor" in str(e)
+00037d80: 206f 7220 2253 697a 6520 6d69 736d 6174   or "Size mismat
+00037d90: 6368 2069 6e20 2765 7870 616e 645f 746f  ch in 'expand_to
+00037da0: 2722 2069 6e20 7374 7228 6529 3a0a 2020  '" in str(e):.  
+00037db0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00037dc0: 5479 7065 4572 726f 7228 2254 656e 736f  TypeError("Tenso
+00037dd0: 7273 2063 616e 206f 6e6c 7920 6265 2073  rs can only be s
+00037de0: 7461 636b 6564 2077 6865 6e20 616c 6c20  tacked when all 
+00037df0: 6f66 2074 6865 6d20 6861 7665 2061 2073  of them have a s
+00037e00: 616d 6520 7368 6170 652e 2022 202b 2066  ame shape. " + f
+00037e10: 2243 7572 7265 6e74 6c79 3a20 7b5b 782e  "Currently: {[x.
+00037e20: 7368 6170 6520 666f 7220 7820 696e 2074  shape for x in t
+00037e30: 656e 736f 7273 5d7d 2229 0a20 2020 2020  ensors]}").     
+00037e40: 2020 2065 6c73 653a 2072 6169 7365 2065     else: raise e
+00037e50: 0a20 2020 2069 6620 6372 6f70 3a20 7465  .    if crop: te
+00037e60: 6e73 6f72 7320 3d20 5b78 2069 6620 782e  nsors = [x if x.
+00037e70: 7368 6170 6520 3d3d 2070 6976 6f74 2e73  shape == pivot.s
+00037e80: 6861 7065 2065 6c73 6520 6372 6f70 5f61  hape else crop_a
+00037e90: 7328 782c 2070 6976 6f74 2e73 7061 6365  s(x, pivot.space
+00037ea0: 2920 666f 7220 7820 696e 2074 656e 736f  ) for x in tenso
+00037eb0: 7273 5d0a 2020 2020 0a20 2020 2062 745f  rs].    .    bt_
+00037ec0: 7465 6e73 6f72 7320 3d20 5b74 2066 6f72  tensors = [t for
+00037ed0: 2074 2069 6e20 7465 6e73 6f72 7320 6966   t in tensors if
+00037ee0: 2069 7369 6e73 7461 6e63 6528 742c 2054   isinstance(t, T
+00037ef0: 656e 736f 7229 5d0a 2020 2020 7769 7468  ensor)].    with
+00037f00: 2074 6f72 6368 2e5f 432e 4469 7361 626c   torch._C.Disabl
+00037f10: 6554 6f72 6368 4675 6e63 7469 6f6e 2829  eTorchFunction()
+00037f20: 3a0a 2020 2020 2020 2020 6966 206c 656e  :.        if len
+00037f30: 2862 745f 7465 6e73 6f72 7329 203d 3d20  (bt_tensors) == 
+00037f40: 303a 2072 6574 7572 6e20 746f 7263 682e  0: return torch.
+00037f50: 7374 6163 6b28 7465 6e73 6f72 732c 2064  stack(tensors, d
+00037f60: 696d 5b30 5d2c 206f 7574 3d6f 7574 292e  im[0], out=out).
+00037f70: 6173 5f73 7562 636c 6173 7328 5465 6e73  as_subclass(Tens
+00037f80: 6f72 290a 2020 2020 2020 2020 656c 7365  or).        else
+00037f90: 3a20 7265 7475 726e 2074 6f72 6368 2e73  : return torch.s
+00037fa0: 7461 636b 2874 656e 736f 7273 2c20 6469  tack(tensors, di
+00037fb0: 6d5b 305d 2c20 6f75 743d 6f75 7429 2e61  m[0], out=out).a
+00037fc0: 735f 7375 6263 6c61 7373 2854 656e 736f  s_subclass(Tenso
+00037fd0: 7229 2e73 7065 6369 616c 5f66 726f 6d28  r).special_from(
+00037fe0: 6469 6d29 0a0a 6465 6620 6d65 7368 6772  dim)..def meshgr
+00037ff0: 6964 282a 7465 6e73 6f72 732c 2069 6e64  id(*tensors, ind
+00038000: 6578 696e 673a 2073 7472 203d 204e 6f6e  exing: str = Non
+00038010: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
+00038020: 4372 6561 7465 2074 6865 206d 6573 6820  Create the mesh 
+00038030: 6772 6964 2075 7369 6e67 2031 4420 7465  grid using 1D te
+00038040: 6e73 6f72 732e 200a 0a20 2020 2041 7267  nsors. ..    Arg
+00038050: 733a 0a20 2020 2020 2020 2074 656e 736f  s:.        tenso
+00038060: 7273 2028 7475 706c 6520 6f66 2054 656e  rs (tuple of Ten
+00038070: 736f 7273 293a 2054 6865 2074 656e 736f  sors): The tenso
+00038080: 7273 2075 7365 6420 666f 7220 6d65 7368  rs used for mesh
+00038090: 2067 7269 642e 200a 2020 2020 2020 2020   grid. .        
+000380a0: 2020 2020 6f75 7470 7574 5b6a 5d5b 695f      output[j][i_
+000380b0: 302c 202e 2e2e 2c20 695f 7b6b 2d31 7d5d  0, ..., i_{k-1}]
+000380c0: 203d 2074 656e 736f 7273 5b6a 5d5b 695f   = tensors[j][i_
+000380d0: 7b6a 7d5d 2c0a 2020 2020 2020 2020 2020  {j}],.          
+000380e0: 2020 652e 672e 206f 7574 7075 745f 302c    e.g. output_0,
+000380f0: 206f 7574 7075 745f 3120 3d20 6d65 7368   output_1 = mesh
+00038100: 6772 6964 2861 7261 6e67 6528 3229 2c20  grid(arange(2), 
+00038110: 6172 616e 6765 2833 292c 2069 6e64 6578  arange(3), index
+00038120: 696e 673d 2769 6a27 2920 3d3e 0a20 2020  ing='ij') =>.   
+00038130: 2020 2020 2020 2020 2020 2020 206f 7574               out
+00038140: 7075 745f 3020 3d20 5465 6e73 6f72 285b  put_0 = Tensor([
+00038150: 5b30 2c20 302c 2030 5d2c 0a20 2020 2020  [0, 0, 0],.     
+00038160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038170: 2020 2020 2020 2020 2020 2020 2020 5b31                [1
+00038180: 2c20 312c 2031 5d5d 290a 2020 2020 2020  , 1, 1]]).      
+00038190: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+000381a0: 5f31 203d 2054 656e 736f 7228 5b5b 302c  _1 = Tensor([[0,
+000381b0: 2031 2c20 325d 2c0a 2020 2020 2020 2020   1, 2],.        
+000381c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000381d0: 2020 2020 2020 2020 2020 205b 302c 2031             [0, 1
+000381e0: 2c20 325d 5d29 0a20 2020 2020 2020 2069  , 2]]).        i
+000381f0: 6e64 6578 696e 6720 2873 7472 2c20 6f70  ndexing (str, op
+00038200: 7469 6f6e 616c 293a 2054 6865 2069 6e64  tional): The ind
+00038210: 6578 696e 6720 6372 6974 6572 6961 2e0a  exing criteria..
+00038220: 2020 2020 2020 2020 2020 2020 696e 6465              inde
+00038230: 7869 6e67 203d 2027 696a 2720 6d65 616e  xing = 'ij' mean
+00038240: 7320 7468 6520 696e 6465 7820 666f 7220  s the index for 
+00038250: 616e 2065 6c65 6d65 6e74 2067 6f65 7320  an element goes 
+00038260: 6173 2028 695f 726f 772c 206a 5f63 6f6c  as (i_row, j_col
+00038270: 756d 6e29 2e0a 2020 2020 2020 2020 2020  umn)..          
+00038280: 2020 696e 6465 7869 6e67 203d 2027 7879    indexing = 'xy
+00038290: 2720 6d65 616e 7320 7468 6520 696e 6465  ' means the inde
+000382a0: 7820 666f 7220 616e 2065 6c65 6d65 6e74  x for an element
+000382b0: 2067 6f65 7320 6173 2028 782b 5f63 6f6f   goes as (x+_coo
+000382c0: 7264 696e 6174 6520 2869 6e20 636f 6c75  rdinate (in colu
+000382d0: 6d6e 292c 2079 2d5f 636f 6f72 6469 6e61  mn), y-_coordina
+000382e0: 7465 2028 696e 2072 6f77 2929 2c0a 2020  te (in row)),.  
+000382f0: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+00038300: 7465 2074 6861 7420 795f 636f 6f72 6469  te that y_coordi
+00038310: 6e61 7465 3d30 2066 6f72 2074 6865 2066  nate=0 for the f
+00038320: 6972 7374 2072 6f77 2061 6e64 2069 6e63  irst row and inc
+00038330: 7265 6173 6573 2066 6f72 206c 6f77 6572  reases for lower
+00038340: 2072 6f77 732e 0a20 2020 2020 2020 2020   rows..         
+00038350: 2020 2041 6c74 6572 696e 6720 696e 6465     Altering inde
+00038360: 7869 6e67 2066 726f 6d20 2769 6a27 2061  xing from 'ij' a
+00038370: 6e64 2027 7879 2720 7769 6c6c 2072 6573  nd 'xy' will res
+00038380: 756c 7420 696e 2061 2074 7261 6e73 706f  ult in a transpo
+00038390: 7365 206f 6620 7265 7375 6c74 732e 0a20  se of results.. 
+000383a0: 2020 2020 2020 2020 2020 2044 6566 6175             Defau
+000383b0: 6c74 7320 746f 2027 696a 2720 696e 2050  lts to 'ij' in P
+000383c0: 7954 6f72 6368 203c 2031 2e31 3020 616e  yTorch < 1.10 an
+000383d0: 6420 2778 7927 2069 6e20 6675 7475 7265  d 'xy' in future
+000383e0: 2076 6572 7369 6f6e 7320 2866 6f6c 6c6f   versions (follo
+000383f0: 7769 6e67 2050 7954 6f72 6368 292e 0a20  wing PyTorch).. 
+00038400: 2020 2022 2222 0a20 2020 2061 766f 7563     """.    avouc
+00038410: 6828 616c 6c5f 2869 7369 6e73 7461 6e63  h(all_(isinstanc
+00038420: 6528 782c 2074 6f72 6368 2e54 656e 736f  e(x, torch.Tenso
+00038430: 7229 2061 6e64 2078 2e6e 6469 6d20 3d3d  r) and x.ndim ==
+00038440: 2031 2066 6f72 2078 2069 6e20 7465 6e73   1 for x in tens
+00038450: 6f72 7329 2c20 5479 7065 4572 726f 7228  ors), TypeError(
+00038460: 6622 2762 742e 6d65 7368 6772 6964 2720  f"'bt.meshgrid' 
+00038470: 6361 6e20 6f6e 6c79 2073 7061 6e20 746f  can only span to
+00038480: 7263 682e 5465 6e73 6f72 206f 626a 6563  rch.Tensor objec
+00038490: 7473 2e20 2229 290a 2020 2020 7769 7468  ts. ")).    with
+000384a0: 2074 6f72 6368 2e5f 432e 4469 7361 626c   torch._C.Disabl
+000384b0: 6554 6f72 6368 4675 6e63 7469 6f6e 2829  eTorchFunction()
+000384c0: 3a0a 2020 2020 2020 2020 7265 7420 3d20  :.        ret = 
+000384d0: 7475 706c 6528 742e 6173 5f73 7562 636c  tuple(t.as_subcl
+000384e0: 6173 7328 5465 6e73 6f72 292e 696e 6974  ass(Tensor).init
+000384f0: 5f73 7065 6369 616c 2829 2066 6f72 2074  _special() for t
+00038500: 2069 6e20 746f 7263 682e 6d65 7368 6772   in torch.meshgr
+00038510: 6964 282a 7465 6e73 6f72 732c 2069 6e64  id(*tensors, ind
+00038520: 6578 696e 673d 696e 6465 7869 6e67 2929  exing=indexing))
+00038530: 0a20 2020 2066 6f72 2069 2c20 7420 696e  .    for i, t in
+00038540: 2065 6e75 6d65 7261 7465 2874 656e 736f   enumerate(tenso
+00038550: 7273 293a 0a20 2020 2020 2020 2066 6f72  rs):.        for
+00038560: 2072 2069 6e20 7265 743a 2072 2e61 6464   r in ret: r.add
+00038570: 5f73 7065 6369 616c 5f64 696d 2869 2c20  _special_dim(i, 
+00038580: 742e 7368 6170 6529 0a20 2020 2072 6574  t.shape).    ret
+00038590: 7572 6e20 7265 7420 2320 7375 7070 7265  urn ret # suppre
+000385a0: 7373 3a20 7370 6563 6961 6c5f 6672 6f6d  ss: special_from
+000385b0: 0a0a 4063 6f6c 6c65 6374 5f6d 656d 6f72  ..@collect_memor
+000385c0: 790a 6465 6620 6579 6528 2a73 697a 653a  y.def eye(*size:
+000385d0: 2053 697a 652c 2064 696d 3d4e 6f6e 652c   Size, dim=None,
+000385e0: 206f 7574 3d4e 6f6e 652c 2064 7479 7065   out=None, dtype
+000385f0: 3d4e 6f6e 652c 206c 6179 6f75 743d 746f  =None, layout=to
+00038600: 7263 682e 7374 7269 6465 642c 2064 6576  rch.strided, dev
+00038610: 6963 653d 5f64 6576 6963 652e 6d61 696e  ice=_device.main
+00038620: 5f64 6576 6963 652c 2072 6571 7569 7265  _device, require
+00038630: 735f 6772 6164 3d46 616c 7365 293a 0a20  s_grad=False):. 
+00038640: 2020 2022 2222 0a20 2020 2063 7265 6174     """.    creat
+00038650: 6520 6964 656e 7469 7479 206d 6174 7269  e identity matri
+00038660: 7820 696e 2028 7468 6520 6669 7273 7420  x in (the first 
+00038670: 6176 6169 6c61 626c 6520 636f 6e64 6974  available condit
+00038680: 696f 6e29 3a0a 2020 2020 2831 2920 6665  ion):.    (1) fe
+00038690: 6174 7572 6520 6469 6d65 6e73 696f 6e73  ature dimensions
+000386a0: 2069 6620 7369 7a65 2068 6173 2061 7420   if size has at 
+000386b0: 6c65 6173 7420 6f6e 653b 200a 2020 2020  least one; .    
+000386c0: 2832 2920 7370 6163 6520 6469 6d65 6e73  (2) space dimens
+000386d0: 696f 6e73 2069 6620 7369 7a65 2068 6173  ions if size has
+000386e0: 2061 7420 6c65 6173 7420 6f6e 653b 200a   at least one; .
+000386f0: 2020 2020 2833 2920 7365 7175 656e 6365      (3) sequence
+00038700: 2064 696d 656e 7369 6f6e 7320 6966 2073   dimensions if s
+00038710: 697a 6520 6861 7320 6174 206c 6561 7374  ize has at least
+00038720: 206f 6e65 2e20 0a20 2020 2022 2222 0a20   one. .    """. 
+00038730: 2020 2061 766f 7563 6828 6c65 6e28 7369     avouch(len(si
+00038740: 7a65 2920 3e20 302c 2054 7970 6545 7272  ze) > 0, TypeErr
+00038750: 6f72 2822 6274 2e65 7965 2072 6563 6569  or("bt.eye recei
+00038760: 7665 7320 6174 206c 6561 7374 206f 6e65  ves at least one
+00038770: 2073 697a 6520 696e 7075 742e 2022 2929   size input. "))
+00038780: 0a20 2020 2069 6620 6469 6d20 6973 204e  .    if dim is N
+00038790: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
+000387a0: 7369 7a65 2e68 6173 5f66 6561 7475 7265  size.has_feature
+000387b0: 3a0a 2020 2020 2020 2020 2020 2020 6469  :.            di
+000387c0: 6d20 3d20 6578 6973 745f 6469 6d28 7369  m = exist_dim(si
+000387d0: 7a65 2c20 5b5d 290a 2020 2020 2020 2020  ze, []).        
+000387e0: 2020 2020 6966 206c 656e 2864 696d 2920      if len(dim) 
+000387f0: 3e20 323a 2064 696d 203d 2064 696d 5b2d  > 2: dim = dim[-
+00038800: 323a 5d0a 2020 2020 2020 2020 656c 6966  2:].        elif
+00038810: 2073 697a 652e 6861 735f 7370 6163 653a   size.has_space:
+00038820: 2064 696d 203d 2065 7869 7374 5f64 696d   dim = exist_dim
+00038830: 2873 697a 652c 202e 2e2e 290a 2020 2020  (size, ...).    
+00038840: 2020 2020 656c 6966 2073 697a 652e 6861      elif size.ha
+00038850: 735f 7365 7175 656e 6365 3a20 6469 6d20  s_sequence: dim 
+00038860: 3d20 6578 6973 745f 6469 6d28 7369 7a65  = exist_dim(size
+00038870: 2c20 2727 290a 2020 2020 2020 2020 656c  , '').        el
+00038880: 7365 3a20 7261 6973 6520 5479 7065 4572  se: raise TypeEr
+00038890: 726f 7228 6622 496e 7661 6c69 6420 7369  ror(f"Invalid si
+000388a0: 7a65 207b 7369 7a65 7d20 666f 7220 6274  ze {size} for bt
+000388b0: 2e65 7965 3a20 6174 206c 6561 7374 206f  .eye: at least o
+000388c0: 6e65 206e 6f6e 2d62 6174 6368 2064 696d  ne non-batch dim
+000388d0: 656e 7369 6f6e 206e 6565 6465 642e 2022  ension needed. "
+000388e0: 290a 2020 2020 6966 206c 656e 2864 696d  ).    if len(dim
+000388f0: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
+00038900: 7369 7a65 203d 2073 697a 655b 3a64 696d  size = size[:dim
+00038910: 5b30 5d5d 202b 2073 697a 655b 6469 6d5b  [0]] + size[dim[
+00038920: 305d 3a64 696d 5b30 5d2b 315d 202b 2073  0]:dim[0]+1] + s
+00038930: 697a 655b 6469 6d5b 305d 3a5d 0a20 2020  ize[dim[0]:].   
+00038940: 2020 2020 2064 696d 203d 2028 6469 6d5b       dim = (dim[
+00038950: 305d 2c20 6469 6d5b 305d 2b31 290a 2020  0], dim[0]+1).  
+00038960: 2020 6176 6f75 6368 286c 656e 2864 696d    avouch(len(dim
+00038970: 2920 3d3d 2032 2c20 5479 7065 4572 726f  ) == 2, TypeErro
+00038980: 7228 2262 742e 6579 6520 6361 6e20 6f6e  r("bt.eye can on
+00038990: 6c79 2062 6520 6372 6561 7465 6420 696e  ly be created in
+000389a0: 2074 776f 2d64 696d 656e 7369 6f6e 616c   two-dimensional
+000389b0: 2073 7061 6365 2c20 706c 6561 7365 206d   space, please m
+000389c0: 616b 6520 7375 7265 2074 6865 2073 6861  ake sure the sha
+000389d0: 7065 2068 6173 2032 2073 7061 6365 2064  pe has 2 space d
+000389e0: 696d 656e 7369 6f6e 7320 6f72 2075 7365  imensions or use
+000389f0: 206b 6579 776f 7264 2061 7267 756d 656e   keyword argumen
+00038a00: 7420 2764 696d 2720 746f 2069 6465 6e74  t 'dim' to ident
+00038a10: 6966 7920 7468 656d 2e20 2229 290a 2020  ify them. ")).  
+00038a20: 2020 0a20 2020 206b 7761 7267 7320 3d20    .    kwargs = 
+00038a30: 6469 6374 286f 7574 3d6f 7574 2c20 6474  dict(out=out, dt
+00038a40: 7970 653d 6474 7970 652c 206c 6179 6f75  ype=dtype, layou
+00038a50: 743d 6c61 796f 7574 2c20 6465 7669 6365  t=layout, device
+00038a60: 3d64 6576 6963 652c 2072 6571 7569 7265  =device, require
+00038a70: 735f 6772 6164 3d72 6571 7569 7265 735f  s_grad=requires_
+00038a80: 6772 6164 290a 2020 2020 6966 2064 696d  grad).    if dim
+00038a90: 5b30 5d20 3e20 6469 6d5b 315d 3a20 6469  [0] > dim[1]: di
+00038aa0: 6d20 3d20 6469 6d5b 3a3a 2d31 5d0a 2020  m = dim[::-1].  
+00038ab0: 2020 6e65 775f 7369 7a65 203d 2073 697a    new_size = siz
+00038ac0: 655b 3a64 696d 5b31 5d5d 2e77 6974 685f  e[:dim[1]].with_
+00038ad0: 6469 6d5f 7369 7a65 2864 696d 5b30 5d2c  dim_size(dim[0],
+00038ae0: 206d 696e 5f28 7369 7a65 5b64 696d 5b30   min_(size[dim[0
+00038af0: 5d5d 2c20 7369 7a65 5b64 696d 5b31 5d5d  ]], size[dim[1]]
+00038b00: 2929 202b 2073 697a 655b 6469 6d5b 315d  )) + size[dim[1]
+00038b10: 2b31 3a5d 0a20 2020 2065 7965 5f6f 7574  +1:].    eye_out
+00038b20: 7075 7420 3d20 6f6e 6573 286e 6577 5f73  put = ones(new_s
+00038b30: 697a 652c 202a 2a6b 7761 7267 7329 2e64  ize, **kwargs).d
+00038b40: 6961 6728 6469 6d3d 2864 696d 5b30 5d2c  iag(dim=(dim[0],
+00038b50: 2929 2e6d 6f76 655f 6469 6d28 6469 6d5b  )).move_dim(dim[
+00038b60: 305d 2b31 2c20 6469 6d5b 315d 292e 7370  0]+1, dim[1]).sp
+00038b70: 6563 6961 6c5f 6672 6f6d 2873 697a 6529  ecial_from(size)
+00038b80: 0a20 2020 2069 6620 7369 7a65 5b64 696d  .    if size[dim
+00038b90: 5b31 5d5d 203e 2073 697a 655b 6469 6d5b  [1]] > size[dim[
+00038ba0: 305d 5d3a 0a20 2020 2020 2020 2072 6574  0]]:.        ret
+00038bb0: 7572 6e20 6361 7428 6579 655f 6f75 7470  urn cat(eye_outp
+00038bc0: 7574 2c20 7a65 726f 7328 6579 655f 6f75  ut, zeros(eye_ou
+00038bd0: 7470 7574 2e73 6861 7065 2e77 6974 685f  tput.shape.with_
+00038be0: 6469 6d5f 7369 7a65 2864 696d 5b31 5d2c  dim_size(dim[1],
+00038bf0: 2073 697a 655b 6469 6d5b 315d 5d2d 7369   size[dim[1]]-si
+00038c00: 7a65 5b64 696d 5b30 5d5d 292c 202a 2a6b  ze[dim[0]]), **k
+00038c10: 7761 7267 7329 2c20 6469 6d5b 315d 292e  wargs), dim[1]).
+00038c20: 7370 6563 6961 6c5f 6672 6f6d 2873 697a  special_from(siz
+00038c30: 6529 0a20 2020 2065 6c69 6620 7369 7a65  e).    elif size
+00038c40: 5b64 696d 5b31 5d5d 203c 2073 697a 655b  [dim[1]] < size[
+00038c50: 6469 6d5b 305d 5d3a 0a20 2020 2020 2020  dim[0]]:.       
+00038c60: 2072 6574 7572 6e20 6579 655f 6f75 7470   return eye_outp
+00038c70: 7574 5b28 736c 6963 6528 4e6f 6e65 292c  ut[(slice(None),
+00038c80: 2920 2a20 6469 6d5b 315d 202b 2028 736c  ) * dim[1] + (sl
+00038c90: 6963 6528 302c 2073 697a 655b 6469 6d5b  ice(0, size[dim[
+00038ca0: 315d 5d29 2c29 5d2e 7370 6563 6961 6c5f  1]]),)].special_
+00038cb0: 6672 6f6d 2873 697a 6529 0a20 2020 2065  from(size).    e
+00038cc0: 6c73 653a 2072 6574 7572 6e20 6579 655f  lse: return eye_
+00038cd0: 6f75 7470 7574 2e73 7065 6369 616c 5f66  output.special_f
+00038ce0: 726f 6d28 7369 7a65 290a 0a40 636f 6c6c  rom(size)..@coll
+00038cf0: 6563 745f 6d65 6d6f 7279 0a64 6566 2065  ect_memory.def e
+00038d00: 7965 5f6c 696b 6528 696e 7075 743a 2054  ye_like(input: T
+00038d10: 656e 736f 722c 2064 696d 3d4e 6f6e 6529  ensor, dim=None)
+00038d20: 3a0a 2020 2020 2222 220a 2020 2020 6372  :.    """.    cr
+00038d30: 6561 7465 2069 6465 6e74 6974 7920 6d61  eate identity ma
+00038d40: 7472 6978 2066 726f 6d20 7368 6170 6520  trix from shape 
+00038d50: 6f66 2060 696e 7075 7460 2069 6e20 2874  of `input` in (t
+00038d60: 6865 2066 6972 7374 2061 7661 696c 6162  he first availab
+00038d70: 6c65 2063 6f6e 6469 7469 6f6e 293a 0a20  le condition):. 
+00038d80: 2020 2028 3129 2066 6561 7475 7265 2064     (1) feature d
+00038d90: 696d 656e 7369 6f6e 7320 6966 2073 697a  imensions if siz
+00038da0: 6520 6861 7320 6174 206c 6561 7374 206f  e has at least o
+00038db0: 6e65 3b20 0a20 2020 2028 3229 2073 7061  ne; .    (2) spa
+00038dc0: 6365 2064 696d 656e 7369 6f6e 7320 6966  ce dimensions if
+00038dd0: 2073 697a 6520 6861 7320 6174 206c 6561   size has at lea
+00038de0: 7374 206f 6e65 3b20 0a20 2020 2028 3329  st one; .    (3)
+00038df0: 2073 6571 7565 6e63 6520 6469 6d65 6e73   sequence dimens
+00038e00: 696f 6e73 2069 6620 7369 7a65 2068 6173  ions if size has
+00038e10: 2061 7420 6c65 6173 7420 6f6e 652e 200a   at least one. .
+00038e20: 2020 2020 2222 220a 2020 2020 7265 7475      """.    retu
+00038e30: 726e 2065 7965 2869 6e70 7574 5f73 6861  rn eye(input_sha
+00038e40: 7065 2c20 6469 6d3d 6469 6d2c 2064 7479  pe, dim=dim, dty
+00038e50: 7065 3d69 6e70 7574 2e64 7479 7065 2c20  pe=input.dtype, 
+00038e60: 6465 7669 6365 3d69 6e70 7574 2e64 6576  device=input.dev
+00038e70: 6963 652c 206c 6179 6f75 743d 696e 7075  ice, layout=inpu
+00038e80: 742e 6c61 796f 7574 290a 0a61 6464 6974  t.layout)..addit
+00038e90: 696f 6e61 6c5f 6675 6e63 7469 6f6e 7320  ional_functions 
+00038ea0: 3d20 5b66 2066 6f72 2066 2069 6e20 6c6f  = [f for f in lo
+00038eb0: 6361 6c73 2829 2069 6620 6620 6e6f 7420  cals() if f not 
+00038ec0: 696e 2062 6173 6963 5f6c 6f63 616c 735d  in basic_locals]
+00038ed0: 0a0a 666f 7220 6620 696e 2061 6464 6974  ..for f in addit
+00038ee0: 696f 6e61 6c5f 6675 6e63 7469 6f6e 7320  ional_functions 
+00038ef0: 2b20 6269 7761 795f 6675 6e63 7469 6f6e  + biway_function
+00038f00: 733a 0a20 2020 2066 756e 635f 636f 6465  s:.    func_code
+00038f10: 7320 3d20 6765 745f 7570 6461 7465 645f  s = get_updated_
+00038f20: 636f 6465 2865 7661 6c28 6629 290a 2020  code(eval(f)).  
+00038f30: 2020 6578 6563 626c 6f63 6b28 6675 6e63    execblock(func
+00038f40: 5f63 6f64 6573 290a 2020 2020 6966 2068  _codes).    if h
+00038f50: 6173 6174 7472 2874 6f72 6368 2c20 6629  asattr(torch, f)
+00038f60: 3a20 746f 7263 685f 646f 6320 3d20 6622  : torch_doc = f"
+00038f70: 5468 6520 646f 6375 6d65 6e74 206f 6620  The document of 
+00038f80: 7468 6520 6f72 6967 696e 616c 2066 756e  the original fun
+00038f90: 6374 696f 6e20 6973 3a5c 6e7b 6765 7461  ction is:\n{geta
+00038fa0: 7474 7228 746f 7263 682c 2066 292e 5f5f  ttr(torch, f).__
+00038fb0: 646f 635f 5f7d 220a 2020 2020 656c 7365  doc__}".    else
+00038fc0: 3a20 746f 7263 685f 646f 6320 3d20 2727  : torch_doc = ''
+00038fd0: 0a20 2020 2065 7661 6c28 6629 2e5f 5f64  .    eval(f).__d
+00038fe0: 6f63 5f5f 203d 2066 2222 2241 7574 6f6d  oc__ = f"""Autom
+00038ff0: 6174 6963 616c 6c79 2069 6e68 6572 6974  atically inherit
+00039000: 7465 6420 7061 636b 6167 6520 6675 6e63  ted package func
+00039010: 7469 6f6e 2066 726f 6d20 2774 6f72 6368  tion from 'torch
+00039020: 272e 2054 6865 2061 7574 6f6d 6174 6963  '. The automatic
+00039030: 616c 6c79 2067 656e 6572 6174 6564 2063  ally generated c
+00039040: 6f64 6573 2061 7265 2061 7320 666f 6c6c  odes are as foll
+00039050: 6f77 733a 0a20 2020 2020 2020 207b 6164  ows:.        {ad
+00039060: 645f 6c69 6e65 6e6f 2866 756e 635f 636f  d_lineno(func_co
+00039070: 6465 7329 7d0a 2020 2020 2020 2020 5c6e  des)}.        \n
+00039080: 7b74 6f72 6368 5f64 6f63 7d0a 2020 2020  {torch_doc}.    
+00039090: 2222 220a 656c 7365 3a20 2320 616c 6961  """.else: # alia
+000390a0: 7365 7320 2875 7365 6c65 7373 2027 656c  ses (useless 'el
+000390b0: 7365 2720 7363 6f70 6520 666f 7220 6120  se' scope for a 
+000390c0: 6e65 7720 7365 6374 696f 6e29 0a20 2020  new section).   
+000390d0: 2063 6f6e 6361 7465 6e61 7465 203d 2063   concatenate = c
+000390e0: 6174 0a20 2020 2069 6e76 203d 2069 6e76  at.    inv = inv
+000390f0: 6572 7365 0a20 2020 2074 7220 3d20 7472  erse.    tr = tr
+00039100: 6163 650a 2020 2020 6d61 7472 6978 5f70  ace.    matrix_p
+00039110: 6f77 6572 203d 206d 6174 706f 770a 2020  ower = matpow.  
+00039120: 2020 6d61 7472 6978 5f65 7870 203d 206d    matrix_exp = m
+00039130: 6174 6578 700a 2020 2020 6d61 7472 6978  atexp.    matrix
+00039140: 5f6c 6f67 203d 206d 6174 6c6f 670a 2020  _log = matlog.  
+00039150: 2020 6d61 7472 6978 5f72 616e 6b20 3d20    matrix_rank = 
+00039160: 7261 6e6b 0a20 2020 206d 6174 7269 785f  rank.    matrix_
+00039170: 6e6f 726d 203d 206d 6174 6e6f 726d 0a0a  norm = matnorm..
+00039180: 6465 6620 746f 5f62 7474 656e 736f 7228  def to_bttensor(
+00039190: 6461 7461 2c20 2a2c 2064 7479 7065 3d4e  data, *, dtype=N
+000391a0: 6f6e 652c 2064 6576 6963 653d 4e6f 6e65  one, device=None
+000391b0: 2c20 7265 7175 6972 6573 5f67 7261 643d  , requires_grad=
+000391c0: 4661 6c73 652c 2070 696e 5f6d 656d 6f72  False, pin_memor
+000391d0: 793d 4661 6c73 6529 3a0a 2020 2020 6966  y=False):.    if
+000391e0: 2064 6174 6120 6973 204e 6f6e 653a 2072   data is None: r
+000391f0: 6574 7572 6e0a 2020 2020 656c 6966 206e  eturn.    elif n
+00039200: 6f74 2069 7369 6e73 7461 6e63 6528 6461  ot isinstance(da
+00039210: 7461 2c20 746f 7263 682e 5465 6e73 6f72  ta, torch.Tensor
+00039220: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00039230: 6e20 7465 6e73 6f72 2864 6174 612c 2064  n tensor(data, d
+00039240: 7479 7065 3d64 7479 7065 2c20 6465 7669  type=dtype, devi
+00039250: 6365 3d64 6576 6963 652c 2072 6571 7569  ce=device, requi
+00039260: 7265 735f 6772 6164 3d72 6571 7569 7265  res_grad=require
+00039270: 735f 6772 6164 2c20 7069 6e5f 6d65 6d6f  s_grad, pin_memo
+00039280: 7279 3d70 696e 5f6d 656d 6f72 7929 0a20  ry=pin_memory). 
+00039290: 2020 2065 6c69 6620 6e6f 7420 6973 696e     elif not isin
+000392a0: 7374 616e 6365 2864 6174 612c 2054 656e  stance(data, Ten
+000392b0: 736f 7229 3a0a 2020 2020 2020 2020 7265  sor):.        re
+000392c0: 7475 726e 2064 6174 612e 6173 5f73 7562  turn data.as_sub
+000392d0: 636c 6173 7328 5465 6e73 6f72 292e 696e  class(Tensor).in
+000392e0: 6974 5f73 7065 6369 616c 2829 0a20 2020  it_special().   
+000392f0: 2065 6c73 653a 2072 6574 7572 6e20 6461   else: return da
+00039300: 7461 0a0a 4063 6f6c 6c65 6374 5f6d 656d  ta..@collect_mem
+00039310: 6f72 790a 6465 6620 6261 7463 685f 6172  ory.def batch_ar
+00039320: 616e 6765 282a 7374 6172 745f 7374 6f70  ange(*start_stop
+00039330: 5f73 7465 702c 206f 7574 3d4e 6f6e 652c  _step, out=None,
+00039340: 2064 7479 7065 3d4e 6f6e 652c 206c 6179   dtype=None, lay
+00039350: 6f75 743d 746f 7263 682e 7374 7269 6465  out=torch.stride
+00039360: 642c 2064 6576 6963 653d 5f64 6576 6963  d, device=_devic
+00039370: 652e 6465 7669 6365 2c20 7265 7175 6972  e.device, requir
+00039380: 6573 5f67 7261 643d 4661 6c73 6529 3a0a  es_grad=False):.
+00039390: 2020 2020 7265 7475 726e 2061 7261 6e67      return arang
+000393a0: 6528 2a73 7461 7274 5f73 746f 705f 7374  e(*start_stop_st
+000393b0: 6570 2c20 6f75 743d 6f75 742c 2064 7479  ep, out=out, dty
+000393c0: 7065 3d64 7479 7065 2c20 6c61 796f 7574  pe=dtype, layout
+000393d0: 3d6c 6179 6f75 742c 2064 6576 6963 653d  =layout, device=
+000393e0: 6465 7669 6365 2c20 7265 7175 6972 6573  device, requires
+000393f0: 5f67 7261 643d 7265 7175 6972 6573 5f67  _grad=requires_g
+00039400: 7261 6429 2e77 6974 685f 737a 5f62 6174  rad).with_sz_bat
+00039410: 6368 5f64 696d 2831 290a 0a40 636f 6c6c  ch_dim(1)..@coll
+00039420: 6563 745f 6d65 6d6f 7279 0a40 616c 6961  ect_memory.@alia
+00039430: 7328 2763 6861 6e6e 656c 5f61 7261 6e67  s('channel_arang
+00039440: 6527 290a 6465 6620 6665 6174 7572 655f  e').def feature_
+00039450: 6172 616e 6765 282a 7374 6172 745f 7374  arange(*start_st
+00039460: 6f70 5f73 7465 702c 206f 7574 3d4e 6f6e  op_step, out=Non
+00039470: 652c 2064 7479 7065 3d4e 6f6e 652c 206c  e, dtype=None, l
+00039480: 6179 6f75 743d 746f 7263 682e 7374 7269  ayout=torch.stri
+00039490: 6465 642c 2064 6576 6963 653d 5f64 6576  ded, device=_dev
+000394a0: 6963 652e 6465 7669 6365 2c20 7265 7175  ice.device, requ
+000394b0: 6972 6573 5f67 7261 643d 4661 6c73 6529  ires_grad=False)
+000394c0: 3a0a 2020 2020 7265 7475 726e 2061 7261  :.    return ara
+000394d0: 6e67 6528 2a73 7461 7274 5f73 746f 705f  nge(*start_stop_
+000394e0: 7374 6570 2c20 6f75 743d 6f75 742c 2064  step, out=out, d
+000394f0: 7479 7065 3d64 7479 7065 2c20 6c61 796f  type=dtype, layo
+00039500: 7574 3d6c 6179 6f75 742c 2064 6576 6963  ut=layout, devic
+00039510: 653d 6465 7669 6365 2c20 7265 7175 6972  e=device, requir
+00039520: 6573 5f67 7261 643d 7265 7175 6972 6573  es_grad=requires
+00039530: 5f67 7261 6429 2e77 6974 685f 737a 5f66  _grad).with_sz_f
+00039540: 6561 7475 7265 5f64 696d 2831 290a 0a40  eature_dim(1)..@
+00039550: 636f 6c6c 6563 745f 6d65 6d6f 7279 0a64  collect_memory.d
+00039560: 6566 2073 6571 7565 6e63 655f 6172 616e  ef sequence_aran
+00039570: 6765 282a 7374 6172 745f 7374 6f70 5f73  ge(*start_stop_s
+00039580: 7465 702c 206f 7574 3d4e 6f6e 652c 2064  tep, out=None, d
+00039590: 7479 7065 3d4e 6f6e 652c 206c 6179 6f75  type=None, layou
+000395a0: 743d 746f 7263 682e 7374 7269 6465 642c  t=torch.strided,
+000395b0: 2064 6576 6963 653d 5f64 6576 6963 652e   device=_device.
+000395c0: 6465 7669 6365 2c20 7265 7175 6972 6573  device, requires
+000395d0: 5f67 7261 643d 4661 6c73 6529 3a0a 2020  _grad=False):.  
+000395e0: 2020 7265 7475 726e 2061 7261 6e67 6528    return arange(
+000395f0: 2a73 7461 7274 5f73 746f 705f 7374 6570  *start_stop_step
+00039600: 2c20 6f75 743d 6f75 742c 2064 7479 7065  , out=out, dtype
+00039610: 3d64 7479 7065 2c20 6c61 796f 7574 3d6c  =dtype, layout=l
+00039620: 6179 6f75 742c 2064 6576 6963 653d 6465  ayout, device=de
+00039630: 7669 6365 2c20 7265 7175 6972 6573 5f67  vice, requires_g
+00039640: 7261 643d 7265 7175 6972 6573 5f67 7261  rad=requires_gra
+00039650: 6429 2e77 6974 685f 737a 5f73 6571 7565  d).with_sz_seque
+00039660: 6e63 655f 6469 6d28 2d31 290a 0a64 6566  nce_dim(-1)..def
+00039670: 2062 6174 6368 5f74 656e 736f 7228 6461   batch_tensor(da
+00039680: 7461 2c20 2a2c 2064 7479 7065 3d4e 6f6e  ta, *, dtype=Non
+00039690: 652c 2064 6576 6963 653d 5f64 6576 6963  e, device=_devic
+000396a0: 652e 6465 7669 6365 2c20 7265 7175 6972  e.device, requir
+000396b0: 6573 5f67 7261 643d 4661 6c73 652c 2070  es_grad=False, p
+000396c0: 696e 5f6d 656d 6f72 793d 4661 6c73 6529  in_memory=False)
+000396d0: 3a0a 2020 2020 7365 6c66 203d 2074 656e  :.    self = ten
+000396e0: 736f 7228 6461 7461 2c20 6474 7970 653d  sor(data, dtype=
+000396f0: 6474 7970 652c 2064 6576 6963 653d 6465  dtype, device=de
+00039700: 7669 6365 2c20 7265 7175 6972 6573 5f67  vice, requires_g
+00039710: 7261 643d 7265 7175 6972 6573 5f67 7261  rad=requires_gra
+00039720: 642c 2070 696e 5f6d 656d 6f72 793d 7069  d, pin_memory=pi
+00039730: 6e5f 6d65 6d6f 7279 290a 2020 2020 6176  n_memory).    av
+00039740: 6f75 6368 2873 656c 662e 6e5f 6469 6d20  ouch(self.n_dim 
+00039750: 3d3d 2031 2c20 5479 7065 4572 726f 7228  == 1, TypeError(
+00039760: 6622 4361 6e6e 6f74 2063 7265 6174 6520  f"Cannot create 
+00039770: 2762 6174 6368 5f74 656e 736f 7227 2066  'batch_tensor' f
+00039780: 726f 6d20 7b64 6174 617d 3a20 6469 6d65  rom {data}: dime
+00039790: 6e73 696f 6e20 6973 206e 6f74 2031 2e20  nsion is not 1. 
+000397a0: 2229 290a 2020 2020 7265 7475 726e 2073  ")).    return s
+000397b0: 656c 662e 7769 7468 5f73 7a5f 6261 7463  elf.with_sz_batc
+000397c0: 685f 6469 6d28 3129 0a0a 4061 6c69 6173  h_dim(1)..@alias
+000397d0: 2822 6368 616e 6e65 6c5f 7465 6e73 6f72  ("channel_tensor
+000397e0: 222c 206f 6e65 5f64 696d 5f6f 6e6c 793d  ", one_dim_only=
+000397f0: 5472 7565 290a 6465 6620 6665 6174 7572  True).def featur
+00039800: 655f 7465 6e73 6f72 2864 6174 612c 202a  e_tensor(data, *
+00039810: 2c20 6474 7970 653d 4e6f 6e65 2c20 6465  , dtype=None, de
+00039820: 7669 6365 3d5f 6465 7669 6365 2e64 6576  vice=_device.dev
+00039830: 6963 652c 2072 6571 7569 7265 735f 6772  ice, requires_gr
+00039840: 6164 3d46 616c 7365 2c20 7069 6e5f 6d65  ad=False, pin_me
+00039850: 6d6f 7279 3d46 616c 7365 2c20 6f6e 655f  mory=False, one_
+00039860: 6469 6d5f 6f6e 6c79 3d46 616c 7365 293a  dim_only=False):
+00039870: 0a20 2020 2073 656c 6620 3d20 7465 6e73  .    self = tens
+00039880: 6f72 2864 6174 612c 2064 7479 7065 3d64  or(data, dtype=d
+00039890: 7479 7065 2c20 6465 7669 6365 3d64 6576  type, device=dev
+000398a0: 6963 652c 2072 6571 7569 7265 735f 6772  ice, requires_gr
+000398b0: 6164 3d72 6571 7569 7265 735f 6772 6164  ad=requires_grad
+000398c0: 2c20 7069 6e5f 6d65 6d6f 7279 3d70 696e  , pin_memory=pin
+000398d0: 5f6d 656d 6f72 7929 0a20 2020 2069 6620  _memory).    if 
+000398e0: 6f6e 655f 6469 6d5f 6f6e 6c79 3a20 6176  one_dim_only: av
+000398f0: 6f75 6368 2873 656c 662e 6e5f 6469 6d20  ouch(self.n_dim 
+00039900: 3d3d 2031 2c20 5479 7065 4572 726f 7228  == 1, TypeError(
+00039910: 6622 4361 6e6e 6f74 2063 7265 6174 6520  f"Cannot create 
+00039920: 2763 6861 6e6e 656c 2f66 6561 7475 7265  'channel/feature
+00039930: 5f74 656e 736f 7227 2066 726f 6d20 7b64  _tensor' from {d
+00039940: 6174 617d 3a20 6469 6d65 6e73 696f 6e20  ata}: dimension 
+00039950: 6973 206e 6f74 2031 2e20 2229 290a 2020  is not 1. ")).  
+00039960: 2020 7265 7475 726e 2073 656c 662e 7769    return self.wi
+00039970: 7468 5f73 7a5f 6665 6174 7572 655f 6469  th_sz_feature_di
+00039980: 6d28 7365 6c66 2e6e 5f64 696d 290a 0a40  m(self.n_dim)..@
+00039990: 616c 6961 7328 2274 696d 655f 7465 6e73  alias("time_tens
+000399a0: 6f72 222c 2022 7365 7269 6573 5f74 656e  or", "series_ten
+000399b0: 736f 7222 290a 6465 6620 7365 7175 656e  sor").def sequen
+000399c0: 6365 5f74 656e 736f 7228 6461 7461 2c20  ce_tensor(data, 
+000399d0: 2a2c 2064 7479 7065 3d4e 6f6e 652c 2064  *, dtype=None, d
+000399e0: 6576 6963 653d 5f64 6576 6963 652e 6465  evice=_device.de
+000399f0: 7669 6365 2c20 7265 7175 6972 6573 5f67  vice, requires_g
+00039a00: 7261 643d 4661 6c73 652c 2070 696e 5f6d  rad=False, pin_m
+00039a10: 656d 6f72 793d 4661 6c73 6529 3a0a 2020  emory=False):.  
+00039a20: 2020 7365 6c66 203d 2074 656e 736f 7228    self = tensor(
+00039a30: 6461 7461 2c20 6474 7970 653d 6474 7970  data, dtype=dtyp
+00039a40: 652c 2064 6576 6963 653d 6465 7669 6365  e, device=device
+00039a50: 2c20 7265 7175 6972 6573 5f67 7261 643d  , requires_grad=
+00039a60: 7265 7175 6972 6573 5f67 7261 642c 2070  requires_grad, p
+00039a70: 696e 5f6d 656d 6f72 793d 7069 6e5f 6d65  in_memory=pin_me
+00039a80: 6d6f 7279 290a 2020 2020 7265 7475 726e  mory).    return
+00039a90: 2073 656c 662e 7769 7468 5f73 7a5f 7365   self.with_sz_se
+00039aa0: 7175 656e 6365 5f64 696d 282d 7365 6c66  quence_dim(-self
+00039ab0: 2e6e 5f64 696d 290a 0a63 6c61 7373 205f  .n_dim)..class _
+00039ac0: 5261 6e64 696e 743a 0a0a 2020 2020 6465  Randint:..    de
+00039ad0: 6620 5f5f 696e 6974 5f5f 2873 656c 6629  f __init__(self)
+00039ae0: 3a0a 2020 2020 2020 2020 2222 2250 6c65  :.        """Ple
+00039af0: 6173 6520 7573 6520 7261 6e64 696e 745b  ase use randint[
+00039b00: 6c6f 7765 722c 2075 7070 6572 5d20 746f  lower, upper] to
+00039b10: 2073 7065 6369 6679 2074 6865 2072 616e   specify the ran
+00039b20: 6765 2077 6974 6820 7570 7065 7220 656e  ge with upper en
+00039b30: 6420 6578 636c 7564 6564 2e20 2222 220a  d excluded. """.
+00039b40: 2020 2020 2020 2020 7365 6c66 2e72 616e          self.ran
+00039b50: 6765 203d 2028 302c 2032 290a 0a20 2020  ge = (0, 2)..   
+00039b60: 2064 6566 205f 5f67 6574 6974 656d 5f5f   def __getitem__
+00039b70: 2873 656c 662c 202a 7429 3a0a 2020 2020  (self, *t):.    
+00039b80: 2020 2020 6966 206c 656e 2874 2920 3d3d      if len(t) ==
+00039b90: 2031 2061 6e64 2069 7369 6e73 7461 6e63   1 and isinstanc
+00039ba0: 6528 745b 305d 2c20 736c 6963 6529 3a0a  e(t[0], slice):.
+00039bb0: 2020 2020 2020 2020 2020 2020 7420 3d20              t = 
+00039bc0: 745b 305d 0a20 2020 2020 2020 2020 2020  t[0].           
+00039bd0: 2069 6620 742e 7374 6570 2069 7320 6e6f   if t.step is no
+00039be0: 7420 4e6f 6e65 3a20 7261 6973 6520 5479  t None: raise Ty
+00039bf0: 7065 4572 726f 7228 6622 506c 6561 7365  peError(f"Please
+00039c00: 2075 7365 2072 616e 6469 6e74 5f6c 696b   use randint_lik
+00039c10: 655b 6c6f 7765 723a 7570 7065 725d 2074  e[lower:upper] t
+00039c20: 6f20 7370 6563 6966 7920 7468 6520 7261  o specify the ra
+00039c30: 6e67 6520 7769 7468 2075 7070 6572 2065  nge with upper e
+00039c40: 6e64 2065 7863 6c75 6465 642e 2022 290a  nd excluded. ").
+00039c50: 2020 2020 2020 2020 2020 2020 7420 3d20              t = 
+00039c60: 2874 2e73 7461 7274 2069 6620 742e 7374  (t.start if t.st
+00039c70: 6172 7420 6973 204e 6f6e 6520 656c 7365  art is None else
+00039c80: 2030 2c20 742e 7374 6f70 2069 6620 742e   0, t.stop if t.
+00039c90: 7374 6f70 2069 7320 6e6f 7420 4e6f 6e65  stop is not None
+00039ca0: 2065 6c73 6520 3229 0a20 2020 2020 2020   else 2).       
+00039cb0: 2065 6c69 6620 6c65 6e28 7429 203d 3d20   elif len(t) == 
+00039cc0: 3120 616e 6420 6973 696e 7374 616e 6365  1 and isinstance
+00039cd0: 2874 5b30 5d2c 2074 7570 6c65 293a 2074  (t[0], tuple): t
+00039ce0: 203d 2074 5b30 5d0a 2020 2020 2020 2020   = t[0].        
+00039cf0: 6966 206c 656e 2874 2920 3d3d 2030 3a20  if len(t) == 0: 
+00039d00: 7420 3d20 2830 2c20 3229 0a20 2020 2020  t = (0, 2).     
+00039d10: 2020 2065 6c69 6620 6c65 6e28 7429 203d     elif len(t) =
+00039d20: 3d20 313a 2074 203d 2028 302c 2074 5b30  = 1: t = (0, t[0
+00039d30: 5d29 0a20 2020 2020 2020 2069 6620 6c65  ]).        if le
+00039d40: 6e28 7429 203e 2032 206f 7220 745b 305d  n(t) > 2 or t[0]
+00039d50: 203e 3d20 745b 315d 3a20 7261 6973 6520   >= t[1]: raise 
+00039d60: 5479 7065 4572 726f 7228 6622 506c 6561  TypeError(f"Plea
+00039d70: 7365 2075 7365 2072 616e 6469 6e74 5f6c  se use randint_l
+00039d80: 696b 655b 6c6f 7765 722c 2075 7070 6572  ike[lower, upper
+00039d90: 5d20 746f 2073 7065 6369 6679 2074 6865  ] to specify the
+00039da0: 2072 616e 6765 2077 6974 6820 7570 7065   range with uppe
+00039db0: 7220 656e 6420 6578 636c 7564 6564 2e20  r end excluded. 
+00039dc0: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+00039dd0: 7261 6e67 6520 3d20 740a 2020 2020 2020  range = t.      
+00039de0: 2020 7265 7475 726e 2073 656c 660a 0a20    return self.. 
+00039df0: 2020 2064 6566 205f 5f63 616c 6c5f 5f28     def __call__(
+00039e00: 7365 6c66 2c20 2a73 697a 652c 2067 656e  self, *size, gen
+00039e10: 6572 6174 6f72 3d4e 6f6e 652c 2064 7479  erator=None, dty
+00039e20: 7065 3d4e 6f6e 652c 2064 6576 6963 653d  pe=None, device=
+00039e30: 4e6f 6e65 2c20 7265 7175 6972 6573 5f67  None, requires_g
+00039e40: 7261 643d 4661 6c73 6529 3a0a 2020 2020  rad=False):.    
+00039e50: 2020 2020 6966 206c 656e 2873 697a 6529      if len(size)
+00039e60: 203c 3d20 3320 616e 6420 6973 696e 7374   <= 3 and isinst
+00039e70: 616e 6365 2873 697a 655b 2d31 5d2c 2074  ance(size[-1], t
+00039e80: 7570 6c65 293a 0a20 2020 2020 2020 2020  uple):.         
+00039e90: 2020 202a 742c 2073 697a 6520 3d20 7369     *t, size = si
+00039ea0: 7a65 0a20 2020 2020 2020 2020 2020 2069  ze.            i
+00039eb0: 6620 6c65 6e28 7429 203d 3d20 303a 2074  f len(t) == 0: t
+00039ec0: 203d 2028 302c 2032 290a 2020 2020 2020   = (0, 2).      
+00039ed0: 2020 2020 2020 656c 6966 206c 656e 2874        elif len(t
+00039ee0: 2920 3d3d 2031 3a20 7420 3d20 2830 2c20  ) == 1: t = (0, 
+00039ef0: 745b 305d 290a 2020 2020 2020 2020 2020  t[0]).          
+00039f00: 2020 656c 6966 206c 656e 2874 2920 3e20    elif len(t) > 
+00039f10: 323a 2072 6169 7365 2054 7970 6545 7272  2: raise TypeErr
+00039f20: 6f72 2866 2250 6c65 6173 6520 7573 6520  or(f"Please use 
+00039f30: 7261 6e64 696e 745b 6c6f 7765 722c 2075  randint[lower, u
+00039f40: 7070 6572 5d20 746f 2073 7065 6369 6679  pper] to specify
+00039f50: 2074 6865 2072 616e 6765 2077 6974 6820   the range with 
+00039f60: 7570 7065 7220 656e 6420 6578 636c 7564  upper end exclud
+00039f70: 6564 2e20 2229 0a20 2020 2020 2020 2020  ed. ").         
+00039f80: 2020 2073 656c 662e 7261 6e67 6520 3d20     self.range = 
+00039f90: 740a 2020 2020 2020 2020 7369 7a65 203d  t.        size =
+00039fa0: 2053 697a 6528 2a73 697a 6529 0a20 2020   Size(*size).   
+00039fb0: 2020 2020 2077 6974 6820 746f 7263 682e       with torch.
+00039fc0: 5f43 2e44 6973 6162 6c65 546f 7263 6846  _C.DisableTorchF
+00039fd0: 756e 6374 696f 6e28 293a 0a20 2020 2020  unction():.     
+00039fe0: 2020 2020 2020 2072 6574 7572 6e20 746f         return to
+00039ff0: 7263 682e 7261 6e64 696e 7428 7365 6c66  rch.randint(self
+0003a000: 2e72 616e 6765 5b30 5d2c 2073 656c 662e  .range[0], self.
+0003a010: 7261 6e67 655b 315d 2c20 7369 7a65 2c20  range[1], size, 
+0003a020: 6765 6e65 7261 746f 723d 6765 6e65 7261  generator=genera
+0003a030: 746f 722c 2064 7479 7065 3d64 7479 7065  tor, dtype=dtype
+0003a040: 2c20 6465 7669 6365 3d64 6576 6963 652c  , device=device,
+0003a050: 2072 6571 7569 7265 735f 6772 6164 3d72   requires_grad=r
+0003a060: 6571 7569 7265 735f 6772 6164 292e 6173  equires_grad).as
+0003a070: 5f73 7562 636c 6173 7328 5465 6e73 6f72  _subclass(Tensor
+0003a080: 292e 7370 6563 6961 6c5f 6672 6f6d 2873  ).special_from(s
+0003a090: 697a 6529 0a0a 636c 6173 7320 5f52 616e  ize)..class _Ran
+0003a0a0: 6469 6e74 5f6c 696b 653a 0a0a 2020 2020  dint_like:..    
+0003a0b0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+0003a0c0: 6629 3a0a 2020 2020 2020 2020 2222 2250  f):.        """P
+0003a0d0: 6c65 6173 6520 7573 6520 7261 6e64 696e  lease use randin
+0003a0e0: 745f 6c69 6b65 5b6c 6f77 6572 2c20 7570  t_like[lower, up
+0003a0f0: 7065 725d 2074 6f20 7370 6563 6966 7920  per] to specify 
+0003a100: 7468 6520 7261 6e67 6520 7769 7468 2075  the range with u
+0003a110: 7070 6572 2065 6e64 2065 7863 6c75 6465  pper end exclude
+0003a120: 642e 2022 2222 0a20 2020 2020 2020 2073  d. """.        s
+0003a130: 656c 662e 7261 6e67 6520 3d20 2830 2c20  elf.range = (0, 
+0003a140: 3229 0a0a 2020 2020 6465 6620 5f5f 6765  2)..    def __ge
+0003a150: 7469 7465 6d5f 5f28 7365 6c66 2c20 2a74  titem__(self, *t
+0003a160: 293a 0a20 2020 2020 2020 2069 6620 6c65  ):.        if le
+0003a170: 6e28 7429 203d 3d20 3120 616e 6420 6973  n(t) == 1 and is
+0003a180: 696e 7374 616e 6365 2874 5b30 5d2c 2073  instance(t[0], s
+0003a190: 6c69 6365 293a 0a20 2020 2020 2020 2020  lice):.         
+0003a1a0: 2020 2074 203d 2074 5b30 5d0a 2020 2020     t = t[0].    
+0003a1b0: 2020 2020 2020 2020 6966 2074 2e73 7465          if t.ste
+0003a1c0: 7020 6973 206e 6f74 204e 6f6e 653a 2072  p is not None: r
+0003a1d0: 6169 7365 2054 7970 6545 7272 6f72 2866  aise TypeError(f
+0003a1e0: 2250 6c65 6173 6520 7573 6520 7261 6e64  "Please use rand
+0003a1f0: 696e 745f 6c69 6b65 5b6c 6f77 6572 3a75  int_like[lower:u
+0003a200: 7070 6572 5d20 746f 2073 7065 6369 6679  pper] to specify
+0003a210: 2074 6865 2072 616e 6765 2077 6974 6820   the range with 
+0003a220: 7570 7065 7220 656e 6420 6578 636c 7564  upper end exclud
+0003a230: 6564 2e20 2229 0a20 2020 2020 2020 2020  ed. ").         
+0003a240: 2020 2074 203d 2028 742e 7374 6172 7420     t = (t.start 
+0003a250: 6966 2074 2e73 7461 7274 2069 7320 4e6f  if t.start is No
+0003a260: 6e65 2065 6c73 6520 302c 2074 2e73 746f  ne else 0, t.sto
+0003a270: 7020 6966 2074 2e73 746f 7020 6973 206e  p if t.stop is n
+0003a280: 6f74 204e 6f6e 6520 656c 7365 2032 290a  ot None else 2).
+0003a290: 2020 2020 2020 2020 656c 6966 206c 656e          elif len
+0003a2a0: 2874 2920 3d3d 2031 2061 6e64 2069 7369  (t) == 1 and isi
+0003a2b0: 6e73 7461 6e63 6528 745b 305d 2c20 7475  nstance(t[0], tu
+0003a2c0: 706c 6529 3a20 7420 3d20 745b 305d 0a20  ple): t = t[0]. 
+0003a2d0: 2020 2020 2020 2069 6620 6c65 6e28 7429         if len(t)
+0003a2e0: 203d 3d20 303a 2074 203d 2028 302c 2032   == 0: t = (0, 2
+0003a2f0: 290a 2020 2020 2020 2020 656c 6966 206c  ).        elif l
+0003a300: 656e 2874 2920 3d3d 2031 3a20 7420 3d20  en(t) == 1: t = 
+0003a310: 2830 2c20 745b 305d 290a 2020 2020 2020  (0, t[0]).      
+0003a320: 2020 6966 206c 656e 2874 2920 3e20 3220    if len(t) > 2 
+0003a330: 6f72 2074 5b30 5d20 3e3d 2074 5b31 5d3a  or t[0] >= t[1]:
+0003a340: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
+0003a350: 2866 2250 6c65 6173 6520 7573 6520 7261  (f"Please use ra
+0003a360: 6e64 696e 745f 6c69 6b65 5b6c 6f77 6572  ndint_like[lower
+0003a370: 2c20 7570 7065 725d 2074 6f20 7370 6563  , upper] to spec
+0003a380: 6966 7920 7468 6520 7261 6e67 6520 7769  ify the range wi
+0003a390: 7468 2075 7070 6572 2065 6e64 2065 7863  th upper end exc
+0003a3a0: 6c75 6465 642e 2022 290a 2020 2020 2020  luded. ").      
+0003a3b0: 2020 7365 6c66 2e72 616e 6765 203d 2074    self.range = t
+0003a3c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0003a3d0: 7365 6c66 0a0a 2020 2020 6465 6620 5f5f  self..    def __
+0003a3e0: 6361 6c6c 5f5f 2873 656c 662c 2064 6174  call__(self, dat
+0003a3f0: 612c 202a 742c 206d 656d 6f72 795f 666f  a, *t, memory_fo
+0003a400: 726d 6174 3d4e 6f6e 652c 2064 7479 7065  rmat=None, dtype
+0003a410: 3d4e 6f6e 652c 206c 6179 6f75 743d 4e6f  =None, layout=No
+0003a420: 6e65 2c20 6465 7669 6365 3d4e 6f6e 652c  ne, device=None,
+0003a430: 2070 696e 5f6d 656d 6f72 793d 4661 6c73   pin_memory=Fals
+0003a440: 652c 2072 6571 7569 7265 735f 6772 6164  e, requires_grad
+0003a450: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
+0003a460: 2069 6620 3020 3c20 6c65 6e28 7429 203c   if 0 < len(t) <
+0003a470: 3d20 323a 0a20 2020 2020 2020 2020 2020  = 2:.           
+0003a480: 2069 6620 6c65 6e28 7429 203d 3d20 313a   if len(t) == 1:
+0003a490: 2074 203d 2028 302c 2074 5b30 5d29 0a20   t = (0, t[0]). 
+0003a4a0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0003a4b0: 6c65 6e28 7429 203e 2032 3a20 7261 6973  len(t) > 2: rais
+0003a4c0: 6520 5479 7065 4572 726f 7228 6622 506c  e TypeError(f"Pl
+0003a4d0: 6561 7365 2075 7365 2072 616e 6469 6e74  ease use randint
+0003a4e0: 5b6c 6f77 6572 2c20 7570 7065 725d 2074  [lower, upper] t
+0003a4f0: 6f20 7370 6563 6966 7920 7468 6520 7261  o specify the ra
+0003a500: 6e67 6520 7769 7468 2075 7070 6572 2065  nge with upper e
+0003a510: 6e64 2065 7863 6c75 6465 642e 2022 290a  nd excluded. ").
+0003a520: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0003a530: 2e72 616e 6765 203d 2074 0a20 2020 2020  .range = t.     
+0003a540: 2020 2077 6974 6820 746f 7263 682e 5f43     with torch._C
+0003a550: 2e44 6973 6162 6c65 546f 7263 6846 756e  .DisableTorchFun
+0003a560: 6374 696f 6e28 293a 0a20 2020 2020 2020  ction():.       
+0003a570: 2020 2020 2069 6620 6c61 796f 7574 2069       if layout i
+0003a580: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0003a590: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+0003a5a0: 6f72 6368 2e72 616e 6469 6e74 5f6c 696b  orch.randint_lik
+0003a5b0: 6528 6461 7461 2c20 7365 6c66 2e72 616e  e(data, self.ran
+0003a5c0: 6765 5b30 5d2c 2073 656c 662e 7261 6e67  ge[0], self.rang
+0003a5d0: 655b 315d 2c20 6d65 6d6f 7279 5f66 6f72  e[1], memory_for
+0003a5e0: 6d61 743d 6d65 6d6f 7279 5f66 6f72 6d61  mat=memory_forma
+0003a5f0: 742c 2064 7479 7065 3d64 7479 7065 2c20  t, dtype=dtype, 
+0003a600: 6465 7669 6365 3d64 6576 6963 652c 2070  device=device, p
+0003a610: 696e 5f6d 656d 6f72 793d 7069 6e5f 6d65  in_memory=pin_me
+0003a620: 6d6f 7279 2c20 7265 7175 6972 6573 5f67  mory, requires_g
+0003a630: 7261 643d 7265 7175 6972 6573 5f67 7261  rad=requires_gra
+0003a640: 6429 2e61 735f 7375 6263 6c61 7373 2854  d).as_subclass(T
+0003a650: 656e 736f 7229 2e73 7065 6369 616c 5f66  ensor).special_f
+0003a660: 726f 6d28 6461 7461 2e73 6861 7065 290a  rom(data.shape).
+0003a670: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0003a680: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003a690: 2020 7265 7475 726e 2074 6f72 6368 2e72    return torch.r
+0003a6a0: 616e 6469 6e74 5f6c 696b 6528 6461 7461  andint_like(data
+0003a6b0: 2c20 7365 6c66 2e72 616e 6765 5b30 5d2c  , self.range[0],
+0003a6c0: 2073 656c 662e 7261 6e67 655b 315d 2c20   self.range[1], 
+0003a6d0: 6d65 6d6f 7279 5f66 6f72 6d61 743d 6d65  memory_format=me
+0003a6e0: 6d6f 7279 5f66 6f72 6d61 742c 2064 7479  mory_format, dty
+0003a6f0: 7065 3d64 7479 7065 2c20 6c61 796f 7574  pe=dtype, layout
+0003a700: 3d6c 6179 6f75 742c 2064 6576 6963 653d  =layout, device=
+0003a710: 6465 7669 6365 2c20 7069 6e5f 6d65 6d6f  device, pin_memo
+0003a720: 7279 3d70 696e 5f6d 656d 6f72 792c 2072  ry=pin_memory, r
+0003a730: 6571 7569 7265 735f 6772 6164 3d72 6571  equires_grad=req
+0003a740: 7569 7265 735f 6772 6164 292e 6173 5f73  uires_grad).as_s
+0003a750: 7562 636c 6173 7328 5465 6e73 6f72 292e  ubclass(Tensor).
+0003a760: 7370 6563 6961 6c5f 6672 6f6d 2864 6174  special_from(dat
+0003a770: 612e 7368 6170 6529 0a0a 7261 6e64 696e  a.shape)..randin
+0003a780: 7420 3d20 5f52 616e 6469 6e74 2829 0a72  t = _Randint().r
+0003a790: 616e 6469 6e74 5f6c 696b 6520 3d20 5f52  andint_like = _R
+0003a7a0: 616e 6469 6e74 5f6c 696b 6528 290a 0a23  andint_like()..#
+0003a7b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0003a7c0: 2323 2323 2323 2323 230a 2323 2020 4469  #########.##  Di
+0003a7d0: 7265 6374 2069 6e68 6572 6974 616e 6365  rect inheritance
+0003a7e0: 2020 2323 0a23 2323 2323 2323 2323 2323    ##.###########
+0003a7f0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0003a800: 0a64 7479 7065 203d 2074 6f72 6368 2e64  .dtype = torch.d
+0003a810: 7479 7065 3b20 2020 2020 2020 2020 2020  type;           
+0003a820: 2020 2064 6576 6963 6520 3d20 746f 7263     device = torc
+0003a830: 682e 6465 7669 6365 0a0a 2320 442d 5479  h.device..# D-Ty
+0003a840: 7065 730a 6266 6c6f 6174 3136 203d 2074  pes.bfloat16 = t
+0003a850: 6f72 6368 2e62 666c 6f61 7431 363b 2020  orch.bfloat16;  
+0003a860: 2020 2020 2020 626f 6f6c 203d 2074 6f72        bool = tor
+0003a870: 6368 2e62 6f6f 6c0a 6364 6f75 626c 6520  ch.bool.cdouble 
+0003a880: 3d20 746f 7263 682e 6364 6f75 626c 653b  = torch.cdouble;
+0003a890: 2020 2020 2020 2020 2020 6366 6c6f 6174            cfloat
+0003a8a0: 203d 2074 6f72 6368 2e63 666c 6f61 743b   = torch.cfloat;
+0003a8b0: 2020 2020 2020 2020 2020 2020 2063 6861               cha
+0003a8c0: 6c66 203d 2074 6f72 6368 2e63 6861 6c66  lf = torch.chalf
+0003a8d0: 0a63 6f6d 706c 6578 3132 3820 3d20 746f  .complex128 = to
+0003a8e0: 7263 682e 636f 6d70 6c65 7831 3238 3b20  rch.complex128; 
+0003a8f0: 2020 2063 6f6d 706c 6578 3634 203d 2074     complex64 = t
+0003a900: 6f72 6368 2e63 6f6d 706c 6578 3634 3b20  orch.complex64; 
+0003a910: 2020 2020 2020 636f 6d70 6c65 7833 3220        complex32 
+0003a920: 3d20 746f 7263 682e 636f 6d70 6c65 7833  = torch.complex3
+0003a930: 320a 646f 7562 6c65 203d 2074 6f72 6368  2.double = torch
+0003a940: 2e64 6f75 626c 653b 2020 2020 2020 2020  .double;        
+0003a950: 2020 2020 6861 6c66 203d 2074 6f72 6368      half = torch
+0003a960: 2e68 616c 660a 666c 6f61 7420 3d20 746f  .half.float = to
+0003a970: 7263 682e 666c 6f61 743b 2020 2020 2020  rch.float;      
+0003a980: 2020 2020 2020 2020 666c 6f61 7431 3620          float16 
+0003a990: 3d20 746f 7263 682e 666c 6f61 7431 363b  = torch.float16;
+0003a9a0: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+0003a9b0: 3332 203d 2074 6f72 6368 2e66 6c6f 6174  32 = torch.float
+0003a9c0: 3332 3b20 2020 2020 2020 2020 2020 666c  32;           fl
+0003a9d0: 6f61 7436 3420 3d20 746f 7263 682e 666c  oat64 = torch.fl
+0003a9e0: 6f61 7436 340a 696e 7420 3d20 746f 7263  oat64.int = torc
+0003a9f0: 682e 696e 743b 2020 2020 2020 2020 2020  h.int;          
+0003aa00: 2020 2020 2020 2020 696e 7431 3620 3d20          int16 = 
+0003aa10: 746f 7263 682e 696e 7431 363b 2020 2020  torch.int16;    
+0003aa20: 2020 2020 2020 2020 2020 2069 6e74 3332             int32
+0003aa30: 203d 2074 6f72 6368 2e69 6e74 3332 3b20   = torch.int32; 
+0003aa40: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0003aa50: 7436 3420 3d20 746f 7263 682e 696e 7436  t64 = torch.int6
+0003aa60: 343b 2020 2020 2020 2020 2020 2020 2020  4;              
+0003aa70: 2069 6e74 3820 3d20 746f 7263 682e 696e   int8 = torch.in
+0003aa80: 7438 0a71 696e 7433 3220 3d20 746f 7263  t8.qint32 = torc
+0003aa90: 682e 7169 6e74 3332 3b20 2020 2020 2020  h.qint32;       
+0003aaa0: 2020 2020 2071 696e 7438 203d 2074 6f72       qint8 = tor
+0003aab0: 6368 2e71 696e 7438 3b20 2020 2020 2020  ch.qint8;       
+0003aac0: 2020 2020 2020 2020 7175 696e 7432 7834          quint2x4
+0003aad0: 203d 2074 6f72 6368 2e71 7569 6e74 3278   = torch.quint2x
+0003aae0: 343b 2020 2020 2020 2020 2071 7569 6e74  4;         quint
+0003aaf0: 3478 3220 3d20 746f 7263 682e 7175 696e  4x2 = torch.quin
+0003ab00: 7434 7832 3b20 2020 2020 2020 2020 7175  t4x2;         qu
+0003ab10: 696e 7438 203d 2074 6f72 6368 2e71 7569  int8 = torch.qui
+0003ab20: 6e74 380a 6c6f 6e67 203d 2074 6f72 6368  nt8.long = torch
+0003ab30: 2e6c 6f6e 673b 2020 2020 2020 2020 2020  .long;          
+0003ab40: 2020 2020 2020 7368 6f72 7420 3d20 746f        short = to
+0003ab50: 7263 682e 7368 6f72 743b 2020 2020 2020  rch.short;      
+0003ab60: 2020 2020 2020 2020 2075 696e 7438 203d           uint8 =
+0003ab70: 2074 6f72 6368 2e75 696e 7438 0a0a 2320   torch.uint8..# 
+0003ab80: 6675 6e63 7469 6f6e 730a 6d61 6e75 616c  functions.manual
+0003ab90: 5f73 6565 6420 3d20 746f 7263 682e 6d61  _seed = torch.ma
+0003aba0: 6e75 616c 5f73 6565 640a                 nual_seed.
```

### Comparing `batorch-1.0.53/batorch/tensorfunc.py` & `batorch-1.0.54/batorch/tensorfunc.py`

 * *Files 15% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 
 from pycamia import info_manager
 
 __info__ = info_manager(
     project = "PyCAMIA",
     package = "batorch",
     fileinfo = "Tensor functions for `batorch`.",
-    requires = ["numpy", "torch", "pycamia", "pyoverload", "matplotlib"]
+    requires = ["numpy", "torch", "pycamia", "pyoverload", "matplotlib", "sympy"]
 )
 
 __all__ = """
     batorch_wrapper
     conv
     crop_as
     decimal
@@ -19,14 +19,15 @@
     gaussian_kernel
     image_grid               imagegrid
     mask_center
     one_hot
     pad
     permute_space
     normalize01
+    input_shape
 
     grad_image               Jacobian
     up_scale                 down_scale
     
     upper_matrix             upper_triangular_matrix
     lower_matrix             lower_triangular_matrix
     skew_symmetric           cross_matrix
@@ -44,14 +45,15 @@
 import math, re
 
 with __info__:
     import numpy as np
     import torch
     import batorch as bt
     from functools import wraps
+    from sympy import symbols, Eq, solve
     from pyoverload import *
     from pycamia import avouch, touch, alias, decorator
     from pycamia import get_environ_vars, get_snakenames, get_args_expression
     from pycamia import SPrint, Version, argmin, tokenize, to_tuple
     from matplotlib import pyplot as plt
     
 @decorator
@@ -556,95 +558,247 @@
         new_norm = normalize01(norm.squeeze([]), func=func).view_as(norm)
         non_zero_norm = bt.where(norm == 0, bt.ones_like(norm), norm)
         return data * bt.where(new_norm == 0, bt.ones_like(new_norm), new_norm / non_zero_norm)
     else:
         m = data.quantile(0.05, ..., keepdim=True)
         M = data.quantile(0.95, ..., keepdim=True)
         clamped = bt.min(bt.max(data, m), M)
+        if M.max().item() < 1.1 and m.min().item() > -0.1: return clamped.clamp(0, 1)
         if func.lower() == 'linear':
             return (clamped - m) / (M - m).clamp(bt.eps)
         elif func.lower() == 'sigmoid':
             return 1 / (bt.exp(- math.log(19) * (2 * clamped - M - m) / (M - m).clamp(bt.eps)) + 1)
         else: raise TypeError("Only 'linear' and 'sigmoid' functions are available for argument 'func' in 'normalize01'. ")
 
-# # class Input:
+class input_shape:
     
-# #     def __init__(self, **kwargs):
-# #         """
-# #         Reshape the tensors to the shape_exprs.
-
-# #         Params:
-# #             shape_expr (str): a string containing a shape expression. The expression is in shape format, 
-# #                 except unknown number of dimensions can be specified with '...' and variable can be specified with words.
+    def __init__(self, **kwargs):
+        self.vars = get_environ_vars()
+        self.default_values = kwargs
+        self.exp_val_pair = []
+        self.opt_exp_val_pair = []
+        self.index = 0
+        
+    def get_variables(self, expr):
+        variables = []
+        while True:
+            try: eval(expr); break
+            except NameError as e:
+                name = e.__str__().split("'")[1]
+                variables.append(name)
+                exec(f"{name} = 2")
+        return variables
+    
+    def declose(self, expr):
+        for closure in ('{}', '[]', '""', "''", '()'):
+            if expr.startswith(closure[0]) and expr.endswith(closure[1]):
+                return expr.strip(closure)
+        return expr
+    
+    def split(self, shape_expr, sep=','):
+        return [x.strip() for x in tokenize(shape_expr, sep=sep) if x.strip()]
+    
+    def record_expr_value(self, expr, value):
+        if isinstance(expr, str): expr = [expr]
+        if isinstance(value, int): value = [value]
+        for e, v in zip(expr, value):
+            if v > 1: self.exp_val_pair.append((e, v))
+            else: self.opt_exp_val_pair.append((e, v))
+    
+    def set(self, **kwargs):
+        """
+        set shape information of tensors for a function.
+        
+        Args:
+            kwargs: data_name = shape pairs. 
+            data_name (str): the name of local variable. 
+            shape (str): a string representing the shape of data. The expression is in the shape format. 
+                The unknown number of dimensions can be specified with '...' and variable can be specified with words. 
+        
+        Examples::
+            >>> data = bt.zeros({4}, [3, 3], 24, 25, 36)
+            >>> data2 = bt.zeros({4}, [3])
+            >>> input_shape(n_dim=2).set(
+            ...     data = "({n_batch}, [n_dim+1, n_dim+1], n_1, ..., n_r) [r=n_dim]", 
+            ...     data2 = "({n_batch}, [(n_dim+1) * n_dim / 2])"
+            ... )
+            ...
+            >>> print(n_batch, n_dim, r)
+            4 2 3
+        """
+        self.exp_val_pair = []
+        self.opt_exp_val_pair = []
+        variable_names = []
+        const_eqs = []
+        n_omits = {}
+        for data_name, shape_expr in kwargs.items():
+            data = self.vars[data_name]
+            
+            # get constraint eqs
+            shape_expr, *const_eq_strs = self.split(shape_expr, sep='')
+            is_optional = False
+            for ceq in const_eq_strs:
+                ceq.strip('[]')
+                for x in ceq.split(';'):
+                    x = x.strip().strip('[]')
+                    if x.lower() == 'optional': is_optional = True; continue
+                    left, right = x.split('=')
+                    variable_names.extend(self.get_variables(left))
+                    variable_names.extend(self.get_variables(right))
+                    const_eqs.append(left + '-' + right)
+            avouch(isinstance(data, bt.Tensor) or data is None and is_optional,
+                   TypeError(f"'{data_name}' needs to be a batorch tensor of shape {shape_expr}, instead of type {data.__class__.__name__}"))
+            if data is None: continue
+                    
+            # get variable names
+            variable_names.extend(self.get_variables(shape_expr))
+            
+            # seperate shape terms
+            shape_terms = self.split(shape_expr.strip('()'))
+            element_terms = []
+            ref_shape = bt.Size()
+            opt_shape = bt.Size()
+            for term in shape_terms:
+                eles = self.split(self.declose(term))
+                optional_terms = [x for x in eles if x.endswith(':optional') or x=='n_batch']
+                if len(optional_terms) > 0: opt_shape += bt.Size(eval(term[0] + '-1' + term[-1]))
+                eles = [x[:-9] if x.endswith(':optional') else x for x in eles]
+                element_terms.extend(eles)
+                if self.declose(term) == term:
+                    if term == '...':
+                        n_ele = data.n_space_dim - len([t for t in shape_terms if self.declose(t) == t]) + 1
+                    else: n_ele = 1
+                    ref_shape += bt.Size(-1) * n_ele
+                else:
+                    n_ele = len(eles)
+                    if '...' in eles: n_ele = getattr(data, 'n_%s_dim'%{'{}':'batch','[]':'feature','""':'sequence',"''":'sequence','()':'func'}[term[0] + term[-1]])
+                    ref_shape += bt.Size(eval(term[0] + ', '.join(['-1'] * n_ele) + term[-1]))
+            data_shape = data.shape
+            if data_shape.has_feature: ref_shape = ref_shape.with_feature(data.feature)
+            elif opt_shape.has_feature: ref_shape = ref_shape.with_feature(tuple())
+            if data_shape.has_sequence: ref_shape = ref_shape.with_sequence(data.sequence)
+            elif opt_shape.has_sequence: ref_shape = ref_shape.with_sequence(tuple())
+            if data_shape.has_space: ref_shape = ref_shape.with_space(data.space)
+            elif opt_shape.has_space: ref_shape = ref_shape.with_space(tuple())
+            data_shape = data.unsqueeze_to(ref_shape).shape
+            error = TypeError(f"'{data_name}' with shape {data_shape} does not follow shape {shape_expr}")
+            if '...' in element_terms:
+                i = element_terms.index('...')
+                avouch(0 < i < len(element_terms) - 1, TypeError(f"Ellipsis should be between two elements, not ({shape_expr})"))
+                prev = element_terms[i - 1]
+                post = element_terms[i + 1]
+                _, prev_index = prev.split('_', 1)
+                _, post_index = post.split('_', 1)
+                prev_index = self.declose(prev_index)
+                post_index = self.declose(post_index)
+                variable_names.extend(self.get_variables(prev_index))
+                variable_names.extend(self.get_variables(post_index))
+                
+                self.record_expr_value(element_terms[:i], data_shape)
+                n_omit = len(data_shape) - len(element_terms) + 3
+                avouch(n_omit > 1, error)
+                self.record_expr_value(post_index + '-' + prev_index + '+1', n_omit)
+                self.record_expr_value(element_terms[i + 1:], data_shape[i + n_omit - 2:])
+                n_omits[data_name] = n_omit
+            else:
+                avouch(len(element_terms) == len(data_shape), error)
+                self.record_expr_value(element_terms, data_shape)
                 
-# #         Examples:
-# #         ----------
-# #         >>> a, b = bt.Input(n_dim=3)\
-# #         ...          .set_shape(bt.zeros(3, 4, 5), "({n_batch}, [n_dim], n@1, ..., n@n_dim)")\
-# #         ...          .set_shape(bt.zeros([2], 34), "({n_batch}, m_1)")\
-# #         ...          .init()
-# #         ...
-# #         >>> n_batch, n_dim
-# #         (2, 3)
-# #         >>> a
-# #         Tensor([[[[[...]]]]], shape=batorch.Size({2}, [3], 3, 4, 5))
-# #         >>> b
-# #         Tensor([[...]], shape=batorch.Size({2}, 34))
-# #         >>> m_1, n_1, n_n_dim
-# #         34, 3, 5
-# #         """
-# #         self.env_vars = get_environ_vars()
-# #         self.vars = self.env_vars.locals
-# #         self.vars.update(kwargs)
-# #         self.env_vars.update(kwargs)
-# #         self.data = []
-# #         self.shape_exprs = []
-
-# #     def set_shape(self, data, shape_expr: str):
-# #         self.data.append(data)
-# #         self.shape_exprs.append(shape_expr)
-# #         return self
-
-# #     def init(self):
-# #         print(sum([get_snakenames(x) for x in self.shape_exprs], []))
-# #         # for data, shape_list in zip(self.data, self.shape_exprs):
-# #         #     old_shape = data.shape
-# #         #     dim_pos = [0] * len(shape_list)
-# #         #     pointer = 0
-# #         #     for i, x in enumerate(shape_list):
-# #         #         if x == '...': break
-# #         #         if x.startswith('[') and x.endswith(']'): dim_pos[i] = old_shape.batch_dimension; x = x.strip('[]')
-# #         #         if x.startswith('{') and x.endswith('}'): dim_pos[i] = old_shape.channel_dimension; x = x.strip('{}')
-# #         #         if x.endswith(":optional"): x = x[:-len(":optional")]
-# #         #         dim_pos[i] = pointer; pointer += 1
-# #         #         if pointer in old_shape._special: pointer += 1
-# #         #         if pointer in old_shape._special: pointer += 1 # two lines needed
-# #         #         if is_dig
-# #         #         x = get_snakename(x)
-# #         #         old_value = self.vars.get(x)
-# #         #         new_value = old_shape[dim_pos[i]]
+        if len(variable_names) == 0:
+            if any(eval(expr) != value for expr, value in self.exp_val_pair): raise error
             
-# #         # return tuple(data_list)
-# #         return tuple(self.data)
+        else:
         
-# # def as_shape(self, shape_expr: str):
-# #     env_vars = get_environ_vars()
-# #     loc_vars = env_vars.locals
-# #     shape_list = [x.strip() for x in shape_expr.strip("()").split(',')]
-# #     ibatch, ichannel = None, None
-# #     old_shape = self.shape
-# #     dim_pos = [0] * len(shape_list)
-# #     pointer = 0
-# #     for i, x in enumerate(shape_list):
-# #         if x == '...': break
-# #         if x.startswith('[') and x.endswith(']'): dim_pos[i] = old_shape.batch_dimension; x = x.strip('[]')
-# #         if x.startswith('{') and x.endswith('}'): dim_pos[i] = old_shape.channel_dimension; x = x.strip('{}')
-# #         if x.endswith(":optional"): x = x[:-len(":optional")]
-# #         x = get_snakename(x)
-# #         if x in loc_vars: x = loc_vars[x]
+            # solve the collected equations
+            variable_names = list(set(variable_names))
+            variables = symbols(' '.join(variable_names))
+            exec(', '.join(variable_names) + ' = variables')
+            equations = []
+            for expr, value in self.exp_val_pair:
+                equations.append(Eq(eval(expr), value))
+            for ceq in const_eqs:
+                equations.append(Eq(eval(ceq), 0))
+            variable_values = solve(equations, variables, dict=True)
+            exec('del ' + ', '.join(variable_names))
+            variable_values = [{k.name: int(v) for k, v in vs.items()} for vs in variable_values if all(x.is_Integer and x > 0 for x in vs.values())]
+            
+            if len(variable_values) > 1:
+                names = [n for n in variable_values[0] if len(set([vs[n] for vs in variable_values])) > 1]
+                raise TypeError(f"{names[0] if len(names) == 1 else names} has multiple possible values {list(set([vs[n] for vs in variable_values]))} for {shape_expr} = {data_shape}")
+            elif len(variable_values) == 0: raise error
+            variable_values = variable_values[0]
+            
+            # try to solve the optional equations (due to 1 values)
+            variable_names = [n for n in variable_names if n not in variable_values]
+            if len(variable_names) > 0:
+                new_exp_val_pair = []
+                for expr, value in self.opt_exp_val_pair:
+                    for k, v in variable_values.items():
+                        while True:
+                            res = re.search(rf'([^A-Za-z0-9]|^)({k})([^A-Za-z0-9]|$)', expr)
+                            if res is None: break
+                            i, j = res.span(2)
+                            expr = expr[:i] + str(v) + expr[j:]
+                    if self.get_variables(expr):
+                        new_exp_val_pair.append((expr, value))
+                locals().update(variable_values)
+                variables = symbols(' '.join(variable_names))
+                exec(', '.join(variable_names) + ' = variables')
+                equations = []
+                for expr, value in new_exp_val_pair:
+                    equations.append(Eq(eval(expr), value))
+                new_variable_values = solve(equations, variables, dict=True)
+                exec('del ' + ', '.join(variable_names))
+                if len(new_variable_values) == 1: variable_values.update({k.name: int(v) for k, v in new_variable_values[0].items() if v.is_Integer and v > 0})
+            
+            for k, v in self.default_values:
+                if k not in variable_values: variable_values[k] = v
+            for k, v in variable_values.items(): self.vars.globals[k] = v
+            locals().update(variable_values)
+        
+        for data_name, shape_expr in kwargs.items():
+            shape_expr, *_ = self.split(shape_expr, sep='')
+            shape_expr = shape_expr.replace(':optional', '')
+            data = self.vars[data_name]
+            if data is None: continue
+            if '...' in shape_expr:
+                terms = [x.strip() for x in shape_expr.strip('()').split(',')]
+                i = terms.index('...')
+                if i > 1: left_size = bt.Size(*eval(','.join(terms[:i-1])))
+                else: left_size = bt.Size()
+                if i < len(terms) - 2: right_size = bt.Size(*eval(','.join(terms[i+2:])))
+                else: right_size = bt.Size()
+                size = left_size + (-1,) * n_omits[data_name] + right_size
+            else: size = bt.Size(*eval(shape_expr))
+            self.vars[data_name] = data.expand_to(size)
+            
+    def usage(self, index=None, /, **kwargs):
+        self.index += 1
+        if index is None: index = self.index
+        try:
+            self.set(**kwargs)
+            self.vars.globals['usage'] = index
+        except TypeError: ...
+        return self
+    
+def as_shape(self, shape_expr: str):
+    env_vars = get_environ_vars()
+    loc_vars = env_vars.locals
+    shape_list = [x.strip() for x in shape_expr.strip("()").split(',')]
+    ibatch, ichannel = None, None
+    old_shape = self.shape
+    dim_pos = [0] * len(shape_list)
+    pointer = 0
+    for i, x in enumerate(shape_list):
+        if x == '...': break
+        if x.startswith('[') and x.endswith(']'): dim_pos[i] = old_shape.batch_dimension; x = x.strip('[]')
+        if x.startswith('{') and x.endswith('}'): dim_pos[i] = old_shape.channel_dimension; x = x.strip('{}')
+        if x.endswith(":optional"): x = x[:-len(":optional")]
+        x = get_snakename(x)
+        if x in loc_vars: x = loc_vars[x]
 
 @alias("upper_triangular_matrix")
 @batorch_wrapper
 def upper_matrix(elements: bt.Tensor):
     '''
     elements: ({n_batch}, [n_dim * (n_dim + 1) / 2])
     output: ({n_batch}, [n_dim, n_dim])
```

### Comparing `batorch-1.0.53/batorch.egg-info/SOURCES.txt` & `batorch-1.0.54/batorch.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/micomputing/__init__.py` & `batorch-1.0.54/micomputing/__init__.py`

 * *Files 6% similar despite different names*

```diff
@@ -2,24 +2,24 @@
 from pycamia import info_manager
 
 __info__ = info_manager(
     project = 'PyCAMIA',
     package = 'micomputing',
     author = 'Yuncheng Zhou',
     create = '2021-12',
-    version = '1.1.46',
+    version = '1.1.47',
     contact = 'bertiezhou@163.com',
     keywords = ['medical image', 'image registration', 'image similarities'],
     description = "'micomputing' is a package for medical image computing. ",
     requires = ['numpy', 'torch>=1.5.1', 'batorch', 'matplotlib', 'pycamia', 'pyoverload', 'nibabel', 'pydicom', 'SimpleITK'],
     update = '2023-07-10 20:53:03',
     package_data = True
 ).check()
-__version__ = '1.1.46'
-from .trans import Transformation, ComposedTransformation, CompoundTransformation, interpolation, interpolation_forward, Identity, Id, Rotation90, Rotation180, Rotation270, Reflect, Reflection, Permutedim, DimPermutation, Rescale, Rescaling, rand_Rescaling, Translate, Translation, rand_Translation, Rigid, Rig, rand_Rigidity, rand_Rig, Affine, Aff, rand_Affinity, rand_Aff, PolyAffine, rand_PolyAffine, logEuclidean, logEu, rand_logEuclidean, rand_logEu, LocallyAffine, LARM, rand_LocallyAffine, rand_LARM, FreeFormDeformation, FFD, rand_FreeFormDeformation, rand_FFD, DenseDisplacementField, DDF, rand_DenseDisplacementField, rand_DDF, VelocityField, VF, rand_VelocityField, rand_VF #*
+__version__ = '1.1.47'
+from .trans import Transformation, ComposedTransformation, CompoundTransformation, interpolation, interpolation_forward, Identity, Id, Rotation90, Rotation180, Rotation270, Reflect, Reflection, Permutedim, DimPermutation, Rescale, Rescaling, rand_Rescaling, Translate, Translation, rand_Translation, Rigid, Rig, rand_Rigidity, rand_Rig, Affine, Aff, rand_Affinity, rand_Aff, PolyAffine, rand_PolyAffine, logEuclidean, logEu, rand_logEuclidean, rand_logEu, LocallyAffine, LARM, rand_LocallyAffine, rand_LARM, FreeFormDeformation, FFD, rand_FreeFormDeformation, rand_FFD, DenseDisplacementField, DDF, rand_DenseDisplacementField, rand_DDF, VelocityField, VF, rand_VelocityField, rand_VF, Normalize, Cropping #*
 from . import plot as plt
-from .stdio import IMG, dcm2nii, nii2dcm #*
-from .data import Key, DataObject, Slicer, Dataset #*
-from .network import U_Net, CNN, FCN
+from .stdio import IMG, dcm2nii, nii2dcm, affine2orient #*
+from .data import Key, DataObject, Slicer, Dataset, LossCollector #*
+from .network import U_Net, CNN, FCN, NeuralODE #*
 from .funcs import reorient, rescale, dilate, blur, bending, distance_map, registration, local_prior, center_of_gravity #*
 # from .trans import Transformation, WoldCoordsTransformation, ImageCoordsTransformation, IntensityTransformation, ComposedTransformation, CompoundTransformation, Identity, Id, Rotation90, Rotation180, Rotation270, Reflect, Reflection, Permutedim, DimPermutation, Rescale, Rescaling, Translate, Translation, Rigid, Rig, Affine, Aff, PolyAffine, logEu, LocallyAffine, LARM, FreeFormDeformation, FFD, DenseDisplacementField, DDF, MultiLayerPerception, MLP, Normalize, resample, interpolation, interpolation_forward, Affine2D2Matrix, Quaterns2Matrix, Matrix2Quaterns #*
 from .metrics import metric, ITKMetric, ITKLabelMetric, MutualInformation, NormalizedMutualInformation, KLDivergence, CorrelationOfLocalEstimation, NormalizedVectorInformation, Cos2Theta, SumSquaredDifference, MeanSquaredErrors, PeakSignalToNoiseRatio, CrossEntropy, CrossCorrelation, NormalizedCrossCorrelation, StructuralSimilarity, Dice, DiceScore, DiceScoreCoefficient, LabelDice, LabelDiceScore, LabelDiceScoreCoefficient, ITKDiceScore, ITKJaccardCoefficient, ITKVolumeSimilarity, ITKFalsePositive, ITKFalseNegative, ITKHausdorffDistance, ITKMedianSurfaceDistance, ITKAverageSurfaceDistance, ITKDivergenceOfSurfaceDistance, ITKLabelDiceScore, ITKLabelJaccardCoefficient, ITKLabelVolumeSimilarity, ITKLabelFalsePositive, ITKLabelFalseNegative, ITKLabelHausdorffDistance, ITKLabelMedianSurfaceDistance, ITKLabelAverageSurfaceDistance, ITKLabelDivergenceOfSurfaceDistance, LocalNonOrthogonality, RigidProjectionError, joint_hist #*
```

### Comparing `batorch-1.0.53/micomputing/data.py` & `batorch-1.0.54/micomputing/data.py`

 * *Files 3% similar despite different names*

```diff
@@ -25,14 +25,15 @@
     from pycamia import avouch, touch, to_tuple, arg_tuple, execblock
 
 __all__ = """
     Key
     DataObject
     Slicer
     Dataset
+    LossCollector
 """.split()
     # Subject
     # ImageObject
     # Dataset
     # MedicalDataset
     
 def deapprox(x):
@@ -49,40 +50,65 @@
 			""".split() if op]:
 			exec(f"def {__op__}(self, other): return approx(getattr(deapprox(self), '{__op__}')(deapprox(other)))")
 		def __str__(self): return '' + super().__str__()
 	return approx_T(x)
 
 class SortedDict(dict):
     
-    def __new__(cls, *args, **kwargs):
+    def __init__(self, *args, **kwargs):
         if len(args) > 0 and isinstance(args[0], dict):
-            return SortedDict.__new__dict(*args, **kwargs)
+            return self.__init__dict(*args, **kwargs)
         if len(args) > 1 and not isinstance(args[0], str):
-            return SortedDict.__new__keyvalue(*args, **kwargs)
-        return SortedDict.__new__default(*args, **kwargs)
+            return self.__init__keyvalue(*args, **kwargs)
+        return self.__init__default(*args, **kwargs)
 
-    @classmethod
-    def __new__keyvalue(cls, keys:list=[], values:list=[]):
-        self = super().__new__(cls, zip(keys, values))
+    def __init__keyvalue(self, keys:list=[], values:list=[]):
+        super().__init__(zip(keys, values))
         self.key_order = keys
-        return self
 
-    @classmethod
-    def __new__dict(cls, dic:dict, order=None):
-        self = super().__new__(cls, dic)
+    def __init__dict(self, dic:dict, order=None):
+        super().__init__(dic)
         if order is None: self.key_order = list(dic.keys())
         else: self.key_order = order
-        return self
 
-    @classmethod
-    def __new__default(cls, *args, **kwargs):
-        self = super().__new__(cls, kwargs)
+    def __init__default(self, *args, **kwargs):
+        super().__init__(kwargs)
         if len(args) == 0: self.key_order = list(kwargs.keys())
         else: self.key_order = list(arg_tuple(args))
-        return self
+    
+    # def __init__(self, *args, **kwargs): ...
+    
+    # def __new__(cls, *args, **kwargs):
+    #     if len(args) > 0 and isinstance(args[0], dict):
+    #         return SortedDict.__new__dict(*args, **kwargs)
+    #     if len(args) > 1 and not isinstance(args[0], str):
+    #         return SortedDict.__new__keyvalue(*args, **kwargs)
+    #     return SortedDict.__new__default(*args, **kwargs)
+
+    # @classmethod
+    # def __new__keyvalue(cls, keys:list=[], values:list=[]):
+    #     self = super().__new__(cls, zip(keys, values))
+    #     self.key_order = keys
+    #     return self
+
+    # @classmethod
+    # def __new__dict(cls, dic:dict, order=None):
+    #     self = super().__new__(cls, dic)
+    #     if order is None: self.key_order = list(dic.keys())
+    #     else: self.key_order = order
+    #     return self
+
+    # @classmethod
+    # def __new__default(cls, *args, **kwargs):
+    #     self = super().__new__(cls, kwargs)
+    #     if len(args) == 0: self.key_order = list(kwargs.keys())
+    #     else: self.key_order = list(arg_tuple(args))
+    #     return self
+    
+    # def __init__(self, *args, **kwargs): ...
 
     def sort(self): self.key_order.sort()
 
     def shuffle(self): random.shuffle(self.key_order)
         
     def first(self): return self.key_order[0], self[self.key_order[0]]
 
@@ -130,14 +156,20 @@
         if isinstance(k, slice):
             key_order = self.key_order[k]
             return SortedDict({i: self[i] for i in key_order}, key_order)
         return_value = super().get(k, None)
         if return_value is None and isinstance(k, int): return_value = self[self.get_key(k)]
         return return_value
     
+    def filter(self, new_key_list):
+        return SortedDict(
+            [k for k in new_key_list if k in self.key_order], 
+            [self[k] for k in new_key_list if k in self.key_order]
+        )
+    
 def is_subkey(key_sub, key_cons):
     for k, v in key_cons.items():
         if v == ...: continue
         if isinstance(v, (list, tuple)):
             cv = key.get(k, None)
             if cv in v: ...
             elif cv == v: ...
@@ -498,15 +530,15 @@
         slice_str = ''
         if self.i_slice is not None: slice_str = f" (slice {i_slice})"
         return f"<DataObject at {self.path.filename}{slice_str} [{load_state}]>"
     
     @property
     def data(self):
         if self._data is None: self.load()
-        return self.__getitem__() if self.i_slice is not None else self._data
+        return self.__getitem__(self.i_slice) if self.i_slice is not None else self._data
     
 class Slicer:
     
     def __init__(self, path, loader=None):
         self.data_obj = DataObject(path, loader=loader)
         self.valid_slices = None
         self.slice_pointer = 0
@@ -576,70 +608,71 @@
         elif isinstance(obj, list):
             self.valid_slices = obj
         elif callable(obj): self.valid_slices = obj
         else: raise TypeError(f"Unknown valid slice type {obj}. ")
         return self
 
 class Dataset:
+    """
+    Create a dataset object. 
     
-    def __init__(self, *args, name = None, main_key_name = 'subject_id', batch_pattern = 'unpaired'):
-        """
-        Create a dataset object. 
-        
-        Args:
-            paths (str): The main folders of the dataset. Dataset will browse all the files within. 
-            name (str): The name of the dataset, one can also identify it in the function name of the loading function. 
-            main_key_name (str): The main key defined to distinguish different subjects. Defaults to 'subject_id'. 
-            batch_pattern (str: unpaired/ paired/ random or list[Key]): Whether the images inside are paired. Defaults to 'unpaired'.
-                unpaired: Values with different Key should be taken as independent data. 
-                paired: Only values with different 'main_key' should be regarded as independent data, the input for batch function would be a tuple of such data. 
-                random: Values with different Key are regarded as independent data, but the input for batch function would randomly pick the data of the same non-main_key keys. 
-                list[Key]: A list of Key objects to constraint each element of the batch input. 
-                    unpaired <==> Key()
-                    paired   <==> e.g. [Key(subject_id=..., modality='CT', is_label=False), Key(subject_id=..., modality='T1', is_label=False), Key(subject_id=..., modality='T1', is_label=True)] # ... here is Ellipsis indicating the same subject_id
-                    random   <==> e.g. [Key(modality='CT', is_label=False), Key(modality='T1', is_label=False), Key(modality='T1', is_label=True)]
-            Note: the training/ validation/ test sub-datasets are split according to the 'main_key'.
-        
-        Examples::
-            >>> from micomputing import data
-            >>> @data.Dataset("folderpath1", "folderpath2")
-            ... def <datasetname>(path):
-            ...     '''
-            ...     The main function maps path to a Key-value pair
-            ...     Note that:
-            ...     1) A list should be returned if multiple elements are obtained from a single path, e.g.,
-            ...            return [Key(patient_id = path.split()[1], modality = path.name, slice_id = i), DataObject(path, i_slice=i) for i in range(n_slice)]
-            ...     2) A single pair of Key-value is also allowed. 
-            ...          The value should be replaced by a Slicer object for image slices, which can generate slice data after the image is loaded.
-            ...          In which case the Key object should leave out namescope 'slice_id' by a default value None to be filled afterwards, e.g., 
-            ...            return Key(patient_id = path.split()[1], modality = path.name, slice_id = None), Slicer(path)
-            ...     3) No identical keys are allowed. One needs to set another property even for elements from a single datum, e.g.,
-            ...            Key(..., slice_id = xx), DataObject(path) for '*.dcm' or '*.ima' slice files. 
-            ...     4) None should be returned if the path is to be omitted. 
-            ...     '''
-            ...     return Key(patientID = path.split()[1], modality = path.name), DataObject(path)
-            ... 
-            >>> <datasetname>
-            <datasetname> Dataset (121 images): 
-            ==================================================
-            patientID = 152
-            || modality = MR
-            || modality = CT
-            ...
-            patientID = 174
-            || modality = CT
-        """
+    Args:
+        paths (str): The main folders of the dataset. Dataset will browse all the files within. 
+        name (str): The name of the dataset, one can also identify it in the function name of the loading function. 
+        main_key_name (str): The main key defined to distinguish different subjects. Defaults to 'subject_id'. 
+        batch_pattern (str: unpaired/ paired/ random or list[Key]): Whether the images inside are paired. Defaults to 'unpaired'.
+            unpaired: Values with different Key should be taken as independent data. 
+            paired: Only values with different 'main_key' should be regarded as independent data, the input for batch function would be a tuple of such data. 
+            random: Values with different Key are regarded as independent data, but the input for batch function would randomly pick the data of the same non-main_key keys. 
+            list[Key]: A list of Key objects to constraint each element of the batch input. 
+                unpaired <==> Key()
+                paired   <==> e.g. [Key(subject_id=..., modality='CT', is_label=False), Key(subject_id=..., modality='T1', is_label=False), Key(subject_id=..., modality='T1', is_label=True)] # ... here is Ellipsis indicating the same subject_id
+                random   <==> e.g. [Key(modality='CT', is_label=False), Key(modality='T1', is_label=False), Key(modality='T1', is_label=True)]
+        Note: the training/ validation/ test sub-datasets are split according to the 'main_key'.
+    
+    Examples::
+        >>> from micomputing import data
+        >>> @data.Dataset("folderpath1", "folderpath2")
+        ... def <datasetname>(path):
+        ...     '''
+        ...     The main function maps path to a Key-value pair
+        ...     Note that:
+        ...     1) A list should be returned if multiple elements are obtained from a single path, e.g.,
+        ...            return [Key(patient_id = path.split()[1], modality = path.name, slice_id = i), DataObject(path, i_slice=i) for i in range(n_slice)]
+        ...     2) A single pair of Key-value is also allowed. 
+        ...          The value should be replaced by a Slicer object for image slices, which can generate slice data after the image is loaded.
+        ...          In which case the Key object should leave out namescope 'slice_id' by a default value None to be filled afterwards, e.g., 
+        ...            return Key(patient_id = path.split()[1], modality = path.name, slice_id = None), Slicer(path)
+        ...     3) No identical keys are allowed. One needs to set another property even for elements from a single datum, e.g.,
+        ...            Key(..., slice_id = xx), DataObject(path) for '*.dcm' or '*.ima' slice files. 
+        ...     4) None should be returned if the path is to be omitted. 
+        ...     '''
+        ...     return Key(patientID = path.split()[1], modality = path.name), DataObject(path)
+        ... 
+        >>> <datasetname>
+        <datasetname> Dataset (121 images): 
+        ==================================================
+        patientID = 152
+        || modality = MR
+        || modality = CT
+        ...
+        patientID = 174
+        || modality = CT
+    """
+    
+    def __init__(self, *args, name = None, main_key_name = 'subject_id', batch_pattern = 'unpaired', preprocess = None):
         self.n_slice_record = []
         self.use_slice_elements = False
         self.name = name
         self.main_key_name = main_key_name
         self.batch_pattern = batch_pattern
-        self.subject_index = {}
-        self.batch_index = {}
-        self._training_set = []
+        self.preprocess = preprocess
+        self.subject_index = {}    # {(main key)-key paired dict}
+        self.batch_index = {}      # {batch pattern (in Key): (main key)-(key candidates list) paired sorted dict}
+        self._training_set = []    # list of main keys
         self._validation_set = []
         self._testing_set = []
         if len(args) == 1:
             x = args[0]
             if isinstance(x, dict): self.__init__dict(*args)
             elif isinstance(x, str): self.__init__str(*args)
             else: self.__init__sequence(*args)
@@ -747,21 +780,22 @@
                 if paired: # if the element needs paired
                     candidates = [k for k in self.subject_index[sid] if is_subkey(k, bk(**{bk.main_key_name: sid}))]
                 else: # no paired element needed
                     candidates = [k for k in self.subject_index[sid] if is_subkey(k, bk)]
                 if len(candidates) > 0: self.batch_index[bk][sid] = candidates; continue # subimage found
                 elif paired: remove_list.append(sid) # paired images missing member
         if len(remove_list) == self.n_main_key or any(len(cand) == 0 for cand in self.batch_index.values()):
-            raise TypeError(f"Cannot find required image output following batch pattern {self.batch_pattern} for {self.name} dataset. ")
+            error_bps = [bp for bp, cand in self.batch_index.items() if len(cand) == 0]
+            raise TypeError(f"Cannot find required image output following batch pattern {error_bps} for {self.name} dataset. ")
         for sid in remove_list:
             for k in self.subject_index[sid]: self.data.pop(k, None) # remove from dataset
             for bk in self.batch_pattern: self.batch_index[bk].pop(sid, None) # remove from content index
 
         self.data.sort()
-        self.split_datasets(training=0.7, validation=0.2)
+        # self.split_datasets(training=0.7, validation=0.2, shuffle=shuffle)
     
     @property
     def main_keys(self):
         return list(set(k.main_key for k in self.data.keys()))
     
     @alias("n_subject")
     @property
@@ -797,15 +831,17 @@
                 count += 1
                 if count == 3: str_print('...')
                 if count > self.n_main_key - 2: count = 0
             if should_omit and count > 2: continue
             for i, k in enumerate(d.visible_keys()):
                 if i < first_diff: continue
                 if i < len(d) - 1: str_print(prefix(i), f"{k} = {d[k]}", sep=''); continue
-                skey = f"{k} = {d[k]}: "
+                used = ''
+                if not self.needed_in_batch(d): used = " [not used]"
+                skey = f"{k} = {d[k]}{used}: "
                 str_v = str(v).split('=' * 10)[-1].lstrip('=').strip()
                 str_print(prefix(i), skey, str_v.replace('\n', '\n' + prefix(i) + ' ' * len(skey)), sep='')
         return str_print.text
 
     def setdefault(self, k, v):
         if k not in self.data: self.data[k] = v
 
@@ -864,48 +900,58 @@
     def __getattr__(self, k):
         try: return getattr(super(), k, None)
         except KeyError as e: raise AttributeError(str(e))
 
     def __iter__(self):
         return iter(self.data)
 
-    def split_datasets(self, training = None, validation = None, testing = None):
+    def split_datasets(self, training = None, validation = None, testing = None, shuffle = True):
         """
         Split dataset to training, validation and test sets by ratio. e.g. split_dataset(training=0.8, validation = 0.1)
         """
         self.check_data()
         if validation is None and (training is None or testing is None): validation = 0.
         if testing is None and training is None: testing = 0.
         if training is None: training = 1. - validation - testing
         elif validation is None: validation = 1. - testing - training
         elif testing is None: testing = 1. - training - validation
         avouch(abs(training + testing + validation - 1.) < 1e-3, "Invalid ratios for function 'split_datasets' (Sum is not 1). ")
         main_keys = self.main_keys
         n_train = int(training * len(main_keys))
         n_valid = int(validation * len(main_keys))
-        random.shuffle(main_keys)
-        def add_subimage(main_key_set):
-            return sum((self.subject_index[mk] for mk in main_key_set), [])
-        self._training_set = add_subimage(main_keys[:n_train])
-        self._validation_set = add_subimage(main_keys[n_train:n_train + n_valid])
-        self._testing_set = add_subimage(main_keys[n_train + n_valid:])
+        if shuffle: random.shuffle(main_keys)
+        self._training_set = main_keys[:n_train]
+        self._validation_set = main_keys[n_train:n_train + n_valid]
+        self._testing_set = main_keys[n_train + n_valid:]
+        # def add_subimage(main_key_set):
+        #     return sum((self.subject_index[mk] for mk in main_key_set), [])
+        # self._training_set = add_subimage(main_keys[:n_train])
+        # self._validation_set = add_subimage(main_keys[n_train:n_train + n_valid])
+        # self._testing_set = add_subimage(main_keys[n_train + n_valid:])
         return self
     
     def needed_in_batch(self, key, batch_pattern=None):
         if batch_pattern is None: batch_pattern = self.batch_pattern
         for const in batch_pattern:
             if is_subkey(key, const): return True
         return False
     
     @property
-    def n_training_subject(self): return len(list(set(k.main_key for k in self._training_set))) if self._training_set else None
+    def n_training_subject(self): return len(self._training_set) if self._training_set else None
     @property
-    def n_validation_subject(self): return len(list(set(k.main_key for k in self._validation_set))) if self._validation_set else None
+    def n_validation_subject(self): return len(self._validation_set) if self._validation_set else None
     @property
-    def n_testing_subject(self): return len(list(set(k.main_key for k in self._testing_set))) if self._testing_set else None
+    def n_testing_subject(self): return len(self._testing_set) if self._testing_set else None
+    
+    # @property
+    # def n_training_subject(self): return len(list(set(k.main_key for k in self._training_set))) if self._training_set else None
+    # @property
+    # def n_validation_subject(self): return len(list(set(k.main_key for k in self._validation_set))) if self._validation_set else None
+    # @property
+    # def n_testing_subject(self): return len(list(set(k.main_key for k in self._testing_set))) if self._testing_set else None
     
     @property
     def n_data(self):
         if self.data is None: return
         total_item = 0
         for key in self.data:
             if not self.needed_in_batch(key): continue
@@ -915,52 +961,71 @@
             else: total_item += 1
         return total_item
     @property
     def n_training(self):
         if not self._training_set: return
         total_item = 0
         for key in self.data:
-            if key not in self._training_set: continue
+            if key.main_key not in self._training_set: continue
             if not self.needed_in_batch(key): continue
             if self.use_slice_elements: 
                 if not self.data[key].is_loaded: total_item = total_item + self.estimated_n_slice
                 else: total_item += self.data[key].n_slice
             else: total_item += 1
         return total_item
     @property
     def n_validation(self):
         if not self._validation_set: return
         total_item = 0
         for key in self.data:
-            if key not in self._validation_set: continue
+            if key.main_key not in self._validation_set: continue
             if not self.needed_in_batch(key): continue
             if self.use_slice_elements: 
                 if not self.data[key].is_loaded: total_item = total_item + self.estimated_n_slice
                 else: total_item += self.data[key].n_slice
             else: total_item += 1
         return total_item
     @property
     def n_testing(self):
         if not self._testing_set: return
         total_item = 0
         for key in self.data:
-            if key not in self._testing_set: continue
+            if key.main_key not in self._testing_set: continue
             if not self.needed_in_batch(key): continue
             if self.use_slice_elements: 
                 if not self.data[key].is_loaded: total_item = total_item + self.estimated_n_slice
                 else: total_item += self.data[key].n_slice
             else: total_item += 1
         return total_item
 
     @alias("train_batch")
     def training_batch(self, n, **kwargs): return self.batch('training', n, **kwargs)
     @alias("valid_batch")
     def validation_batch(self, n, **kwargs): return self.batch('validation', n, **kwargs)
     @alias("test_batch")
     def testing_batch(self, n, **kwargs): return self.batch('testing', n, **kwargs)
+
+    @alias("train_batch")
+    def training_batches(self, n, **kwargs):
+        while True:
+            cur_batch = self.batch('training', n, **kwargs)
+            if cur_batch is None: break
+            yield cur_batch
+    @alias("valid_batch")
+    def validation_batches(self, n, **kwargs):
+        while True:
+            cur_batch = self.batch('validation', n, **kwargs)
+            if cur_batch is None: break
+            yield cur_batch
+    @alias("test_batch")
+    def testing_batches(self, n, **kwargs):
+        while True:
+            cur_batch = self.batch('testing', n, **kwargs)
+            if cur_batch is None: break
+            yield cur_batch
     
     def batch(self, stage='training', n_batch=4, shuffle=True, drop_last=True, none_each_epoch=True, restart=False):
         """
         Create a batch data. 
 
         Args:
             stage (str, 'training'|'validation'|'testing'): The stage we are in, determining the subset we are using. Defaults to 'training'.
@@ -972,33 +1037,33 @@
                 Whether to drop the last data which is less than a batch. Defaults to True.
                 [True]: Drop the remaining data.
                 [False]: Use the remaining data to create a batch with a batch size smaller than normal ones. 
             none_each_epoch (bool): Whether to output a None value at the end of each epoch. Defaults to True.
             restart (bool): Manually use a restart of epoch for this batch. Defaults to False.
         """
         self.check_data()
-        if not self._training_set: self.split_datasets(training=0.7, validation=0.2)
+        if not self._training_set: self.split_datasets(training=0.7, validation=0.2, shuffle=shuffle)
         stage = stage.lower()
         if stage == 'training': subset = self._training_set
         elif stage == 'validation': subset = self._validation_set
         elif stage == 'testing': subset = self._testing_set
         
         selected_items = []
         batch_list = []
         new_epoch = False
         release_list = []
         for bp in self.batch_pattern:
-            candidates = self.batch_index[bp]
+            candidates = self.batch_index[bp].filter(subset)
             cur_pointer = 0 if restart else self.batch_pointer[stage].get(bp, 0)
             if cur_pointer == 0 and self.use_slice_elements: cur_pointer = 0, 0
             batch_sids = []
             if bp.main_key == ... and selected_items:
                 if self.use_slice_elements:
-                    batch_list.append([self.data[random.choice(candidates[img.main_key])].slice(slc) for img, slc in selected_items])
-                else: batch_list.append([self.data[random.choice(candidates[img.main_key])] for img in selected_items])
+                    batch_list.append([self.data[random.choice(candidates[img_key])].slice(slc) for img_key, slc in selected_items])
+                else: batch_list.append([self.data[random.choice(candidates[img_key])] for img_key in selected_items])
             else:
                 cum_n_batch = 0
                 if self.use_slice_elements:
                     cur_pointer, slice_pointer = cur_pointer
                     batched_slices = []
                     for i in range(n_batch):
                         image_key = random.choice(candidates[cur_pointer])
@@ -1008,31 +1073,29 @@
                         n_remain_batch = n_batch - len(batched_slices)
                         new_slice_pointer = slice_pointer + n_remain_batch
                         selected_items.extend([(image_key, i) for i in range(slice_pointer, min(new_slice_pointer, sample_image.n_slice))])
                         batched_slices.extend([sample_image.slice(i) for i in range(slice_pointer, min(new_slice_pointer, sample_image.n_slice))])
                         if new_slice_pointer >= sample_image.n_slice: new_slice_pointer = 0; cur_pointer += 1; release_list.append(sample_image)
                         if len(batched_slices) >= n_batch: break
                     batch_list.append(batched_slices)
-                    if cur_pointer >= len(candidates): cur_pointer = 0; new_slice_pointer = 0; new_epoch = True
+                    if len(selected_items) == 0: cur_pointer = 0; new_slice_pointer = 0; new_epoch = True; break
                     self.batch_pointer[stage][bp] = cur_pointer, new_slice_pointer
                 else: 
                     new_pointer = cur_pointer + n_batch
-                    selected_items = random.choice(candidates[cur_pointer: new_pointer])
-                    batch_list.append([self.data[cand] for cand in selected_items])
-                    if new_pointer >= len(candidates): new_pointer = 0; new_epoch = True
+                    selected_items = candidates[cur_pointer: new_pointer]
+                    if len(selected_items) == 0: new_pointer = 0; new_epoch = True; break
+                    batch_list.append([self.data[random.choice(candidates[img_key])] for img_key in selected_items])
                     self.batch_pointer[stage][bp] = new_pointer
 
         is_partial_batch = any(len(x) < n_batch for x in batch_list)
-        if is_partial_batch: new_epoch = True
+        if is_partial_batch and drop_last: new_epoch = True
         if new_epoch: 
             self.batch_pointer = {'training': {}, 'validation': {}, 'testing': {}}
             if shuffle:
                 for bp in self.batch_pattern: self.batch_index[bp].shuffle()
-
-        if is_partial_batch and drop_last:
             for r in release_list: r.release()
             if none_each_epoch: return
             else: return self.batch(stage=stage, n_batch=n_batch, shuffle=shuffle, 
                                     drop_last=drop_last, none_each_epoch=none_each_epoch, restart=restart)
         return_value = self.get_batch(batch_list)
         for r in release_list: r.release()
         return return_value
@@ -1045,22 +1108,37 @@
             batch_list (list): a list of length equal to *.batch_pattern; with each element a list of length n_batch. 
                 The nested elements are DataObjects (Slicer output in major function would result in DataObjects with i_slice). 
         """
         res_list = []
         for output_batch in batch_list:
             ref = output_batch[0]
             if isinstance(ref, DataObject):
-                output_batch = [x.data for x in output_batch]
+                if self.preprocess is None: prepcs = lambda x: x
+                else: prepcs = self.preprocess
+                output_batch = [prepcs(x.data) for x in output_batch]
                 ref = ref.data
             elif isinstance(ref, bt.Tensor): ...
             else: res_list.append(output_batch); continue
             avouch(isinstance(ref, bt.Tensor))
             if ref.has_batch: res_list.append(bt.cat(output_batch, {}, crop=True).detach())
             else: res_list.append(bt.stack(output_batch, {}, crop=True).detach())
         return tuple(res_list)
+    
+class LossCollector:
+    
+    def __init__(self):
+        self.collection = {}
+    
+    def __call__(self, **kwargs):
+        for k, v in kwargs.items():
+            self.collection.setdefault(k, bt.zeros(0))
+            self.collection[k] = bt.cat(self.collection[k], bt.to_bttensor(v, device=self.collection[k].device))
+            
+    def __str__(self):
+        return ', '.join([f"{k} [{v.mean_std}]" for k, v in self.collection.items()])
 
 # class MedicalSubImage(Dataset):
     
 #     def __getitem__(self, k):
 #         try:
 #             if isinstance(k, Subject): return self.data[k.subimage]
 #         except KeyError: raise KeyError(f"Invalid key {k}.")
```

### Comparing `batorch-1.0.53/micomputing/funcs.py` & `batorch-1.0.54/micomputing/funcs.py`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/micomputing/metrics.py` & `batorch-1.0.54/micomputing/metrics.py`

 * *Files 0% similar despite different names*

```diff
@@ -172,15 +172,15 @@
             if Version(bt.__version__) >= '1.9': window = bt.stack(bt.meshgrid(*([bt.arange(-1, 3)] * n_image), indexing='ij'), 0).flatten(1).transpose(0, 1).to(device) # (4 ^ n_image, n_image)
             else: window = bt.stack(bt.meshgrid(*([bt.arange(-1, 3)] * n_image), indexing='ij'), 0).flatten(1).transpose(0, 1).to(device) # (4 ^ n_image, n_image)
             for shift in window:
                 shift = shift.view({1}, [2], 1) # ({1}, [n_image], 1) -> (1, n_image, 1)
                 hist_pos = data_pair * n_bin # ({n_batch}, [n_image], n_data) -> (n_batch, n_image, n_data)
                 index = bt.clamp(bt.floor(hist_pos).long() + shift.long(), 0, n_bin - 1)
                 decimal = hist_pos - bt.floor(hist_pos)
-                value = grad_output[(bt.arange(n_batch).long().unsqueeze(-1).expand(n_batch, n_data).to(device),) + tuple(x.squeeze(1) for x in index.split(1, 1))] # ({n_batch}, n_data) -> (n_batch, n_data)
+                value = grad_output[(bt.arange({n_batch}).long().duplicate(n_data, -1).to(device),) + tuple(x.squeeze(1) for x in index.split(1, 1))] # ({n_batch}, n_data) -> (n_batch, n_data)
                 dEdI1 += value * multi_dBspline(shift, decimal, 0) # ({n_batch}, n_data) -> (n_batch, n_data)
                 dEdI2 += value * multi_dBspline(shift, decimal, 1)
             # dEdI1 = bt.tensor(dEdI1.data).view(Ishape) * n_bin / n_data
             # dEdI2 = bt.tensor(dEdI2.data).view(Ishape) * n_bin / n_data
             n_dim = len(Ishape) - 1
             dEdI1 = dEdI1.data.view(Ishape) * mask * n_bin / mask.flatten(1).sum(1).view((n_batch,) + (1,) * n_dim)
             dEdI2 = dEdI2.data.view(Ishape) * mask * n_bin / mask.flatten(1).sum(1).view((n_batch,) + (1,) * n_dim)
@@ -604,16 +604,16 @@
     The metrics between A and B where A and B are 0-1 masks. 
     The sizes are as follows: 
     A: ({n_batch}, [n_label: optional], n@1, n@2, ..., n@n_dim)
     B: ({n_batch}, [n_label: optional], n@1, n@2, ..., n@n_dim)
     return: ({n_batch}, [n_label: optional])
     '''
     func = 'Metric ' + metric
-    avouch(isinstance(A, bt.Tensor), f"Please use 'babt.Tensor' objects for '{func}' in 'micomputing'. Use X.as_subclass(bt.Tensor) to create one. ")
-    avouch(isinstance(B, bt.Tensor), f"Please use 'babt.Tensor' objects for '{func}' in 'micomputing'. Use X.as_subclass(bt.Tensor) to create one. ")
+    avouch(isinstance(A, bt.Tensor), f"Please use 'bt.Tensor' objects for '{func}' in 'micomputing'. Use X.as_subclass(bt.Tensor) to create one. ")
+    avouch(isinstance(B, bt.Tensor), f"Please use 'bt.Tensor' objects for '{func}' in 'micomputing'. Use X.as_subclass(bt.Tensor) to create one. ")
     avouch(A.has_batch and B.has_batch, f"Please make sure inputs of '{func}' have batch dimensions. Use X.batch_dim = 0 to identify (or X.unsqueeze({{}}) if no existed batch).")
     avouch(A.shape == B.shape, f"Please make sure inputs of '{func}' have the same shape.")
 
     n_batch = A.n_batch
     has_channel = False
     if A.has_channel and B.has_channel:
         has_channel = True
@@ -622,16 +622,16 @@
         B = B.mergedims([], {})
     n_maps = A.n_batch
     filter_A = A.sum(...) != 0
     filter_B = B.sum(...) != 0
     filter_both = filter_A & filter_B
     A = A[filter_both]
     B = B[filter_both]
-    A = np.array(A) != 0
-    B = np.array(B) != 0
+    A = A.numpy() != 0
+    B = B.numpy() != 0
     spacing = to_tuple(spacing)
     n_dim = A.ndim
     n_data = A.shape[0]
     if len(spacing) == 1: spacing *= n_dim
     Overlap_filter = sitk.LabelOverlapMeasuresImageFilter()
     SD_filter = SurfaceDistanceImageFilter()
     Overlap_execs = {
```

### Comparing `batorch-1.0.53/micomputing/micfunctions.so` & `batorch-1.0.54/micomputing/micfunctions.so`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/micomputing/network.py` & `batorch-1.0.54/micomputing/network.py`

 * *Files 23% similar despite different names*

```diff
@@ -11,14 +11,15 @@
     requires = "batorch"
 ).check()
 
 __all__ = """
     U_Net
     CNN
     FCN
+    NeuralODE
 """.split()
     
 import math
 
 with __info__:
     import batorch as bt
     from batorch import nn
@@ -34,38 +35,44 @@
         z = reduction(list_of_items[0], list_of_items[1])
         for i in range(2, len(list_of_items)):
             z = reduction(z, list_of_items[i])
     else: z = list_of_items[0]
     return z
 
 class Convolution_Block(nn.Module):
+    '''
+    Args:
+        dimension (int): The dimension of the images. 
+        in_channels (int): The input channels for the block. 
+        out_channels (int): The output channels for the block. 
+        conv_num (int): The number of convolution layers. 
+        kernel_size (int): The size of the convolution kernels. 
+        padding (int): The image padding for the convolutions. 
+        activation_function (class): The activation function. 
+        final_activation (class): The activation function after the final convolution. 
+        active_args (dict): The arguments for the activation function. 
+        conv_block (str): A string with possible values in ('conv', 'dense', 'residual'), indicating which kind of block the U-Net is using: normal convolution layers, DenseBlock or ResidualBlock. 
+        res_type (function): The combining type for the residual connections.
+    '''
     
     def __init__(self, in_channels, out_channels, **params):
-        '''
-        ::parameters:
-            dimension (int): The dimension of the images. 
-            in_channels (int): The input channels for the block. 
-            out_channels (int): The output channels for the block. 
-            conv_num (int): The number of convolution layers. 
-            kernel_size (int): The size of the convolution kernels. 
-            padding (int): The image padding for the convolutions. 
-            activation_function (class): The activation function. 
-            active_args (dict): The arguments for the activation function. 
-            conv_block (str): A string with possible values in ('conv', 'dense', 'residual'), indicating which kind of block the U-Net is using: normal convolution layers, DenseBlock or ResidualBlock. 
-            res_type (function): The combining type for the residual connections.
-        '''
         super().__init__()
-        default_values = {'dimension': 2, 'conv_num': 1, 'padding': 1, 'kernel_size': 3, 'conv_block': 'conv', 'res_type': bt.add, 'activation_function': nn.ReLU, 'active_args': {}}
+        default_values = {'dimension': 2, 'conv_num': 1, 'padding': 1, 'kernel_size': 3, 'conv_block': 'conv', 'res_type': bt.add, 'activation_function': nn.ReLU, 'final_activation': ..., 'active_args': {}}
         param_values = {}
         param_values.update(default_values)
         param_values.update(params)
         self.__dict__.update(param_values)
         self.in_channels = in_channels
         self.out_channels = out_channels
         
+        if isinstance(self.padding, str): self.padding = {'SAME': self.kernel_size // 2, 'ZERO': 0, 'VALID': 0}.get(self.padding.upper(), self.kernel_size // 2)
+        if self.activation_function is None: self.activation_function = lambda *a, **k: (lambda x: x)
+        if self.final_activation == ...: self.final_activation = self.activation_function
+        if self.final_activation is None: self.final_activation = lambda *a, **k: (lambda x: x)
+        
         self.layers = nn.ModuleList()
         for i in range(self.conv_num):
             ic = self.in_channels if i == 0 else ((self.out_channels * i + self.in_channels) if self.conv_block == 'dense' else self.out_channels)
             conv = eval('nn.Conv%dd' % self.dimension)(ic, self.out_channels, self.kernel_size, 1, self.padding)
             initialize_model, initialize_params = parse(self.initializer)
             eval('nn.init.%s_' % initialize_model)(conv.weight, *initialize_params)
             if self.conv_block != 'dense': self.layers.append(conv)
@@ -75,46 +82,57 @@
             if self.conv_block == 'dense': self.layers.append(conv)
 
     def forward(self, x):
         if self.conv_block == 'dense':
             conv_results = [x]
             conv_layer = True
             for layer in self.layers:
-                if conv_layer: x = layer(bt.cat([bt.crop_as(l, conv_results[-1]) for l in conv_results], 1))
-                else: x = layer(x)
+                try:
+                    if conv_layer: x = layer(bt.cat([bt.crop_as(l, conv_results[-1]) for l in conv_results], 1))
+                    else: x = layer(x)
+                except Exception as e:
+                    raise e.__class__(f"In layer {layer}. " + e.__str__())
                 conv_layer = layer.__class__.__name__.startswith('Conv')
                 if conv_layer: conv_results.append(x)
-            return self.activation_function(**self.active_args)(x)
+            result = self.final_activation(**self.active_args)(x)
         else:
             y = x
-            for layer in self.layers: y = layer(y)
+            for layer in self.layers:
+                try: y = layer(y)
+                except Exception as e:
+                    raise e.__class__(f"In layer {layer}. " + e.__str__())
+            y = y.as_subclass(bt.Tensor).special_from(x)
             if self.conv_block == 'residual': z = self.res_type(bt.crop_as(x, y), y)
             else: z = y
-            return self.activation_function(**self.active_args)(z)
-        
+            result = self.final_activation(**self.active_args)(z)
+        result = result.as_subclass(bt.Tensor).special_from(x)
+        if self.padding == self.kernel_size // 2:
+            return bt.crop_as(result, x)
+        return result
 
 class U_Net(nn.Module):
     '''
-    ::paramerters:
-        dimension (int): The dimension of the images. For conventional U-Net, it is 2. 
-        depth (int): The depth of the U-Net. The conventional U-Net has a depth of 4 there are 4 pooling layers and 4 up-sampling layers.
-        conv_num (int): The number of continuous convolutions in one block. In a conventional U-Net, this is 2. 
-        padding (int or str): Indicate the type of padding used. In a conventional U-Net, padding should be 0 but yet the default value is 'SAME' here. 
-        in_channels (int): The number of channels for the input. In a conventional U-Net, it should be 1.
-        out_channels (int): The number of channels for the output. In a conventional U-Net, it should be 2.
-        block_channels (int): The number of channels for the first block if a number is provided. In a conventional U-Net, it should be 64. 
+    Args:
+        dimension (int): The dimension of the images. Defaults to 2 (see U-Net). 
+        depth (int): The depth of the U-Net. Defaults to 4 indicating 4 pooling layers and 4 up-sampling layers (see U-Net).
+        conv_num (int): The number of continuous convolutions in one block. Defaults to 2. 
+        padding (int or str): Indicate the type of padding used. Defaults to 'SAME' though it is 0 in conventional U-Net. 
+        in_channels (int): The number of channels for the input. Defaults to 1 (see U-Net).
+        out_channels (int): The number of channels for the output. Defaults to 2 (see U-Net).
+        block_channels (int): The number of channels for the first block if a number is provided. Defaults to 64 (see U-Net). 
             If a list is provided, the length should be the same as the number of blocks plus two (2 * depth + 3). It represents the channels before and after each block (with the output channels included). 
             Or else, a function may be provided to compute the output channels given the block index (-1 ~ 2 * depth + 1) [including input_channels at -1 and output_channels at 2 * depth + 1]. 
-        kernel_size (int): The size of the convolution kernels. In a conventional U-Net, it should be 3. 
-        pooling_size (int): The size of the pooling kernels. In a conventional U-Net, it should be 2. 
+        bottleneck_out_channels (int): The number of channels for the bottleneck output. Defaults to 0. 
+        kernel_size (int): The size of the convolution kernels. Defaults to 3 (see U-Net). 
+        pooling_size (int): The size of the pooling kernels. Defaults to 2 (see U-Net). 
         // keep_prob (float): The keep probability for the dropout layers. 
         conv_block (str): A string with possible values in ('conv', 'dense', 'residual'), indicating which kind of block the U-Net is using: normal convolution layers, DenseBlock or ResidualBlock. 
         multi_arms (str): A string with possible values in ('shared(2)', 'seperate(2)'), indicating which kind of encoder arms are used. 
         multi_arms_combine (function): The combining type for multi-arms. See skip_type for details. 
-        skip_type (function): The skip type for the skip connections. The conventional U-Net has a skip connect of catenation (cat). Other possible skip types include torch.mul or torch.add. 
+        skip_type (function): The skip type for the skip connections. Defaults to catenation (cat; see U-Net). Other possible skip types include torch.mul or torch.add. 
         res_type (function): The combining type for the residual connections. It should be torch.add in most occasions. 
         activation_function (class): The activation function used after the convolution layers. Defaults to nn.ReLU. 
         active_args (dict): The arguments for the activation function. Defaults to {}. 
         initializer (str): A string indicating the initialing strategy. Possible values are normal(0, 0.1) or uniform(-0.1, 0.1) or constant(0) (all parameters can be changed)
         with_softmax (bool): Whether a softmax layer is applied at the end of the network. Defaults to True. 
         cum_layers (list): A list consisting two numbers [n, m] indicating that the result would be a summation of the upsamples of the results of the nth to the mth (included) blocks, block_numbers are in range 0 ~ 2 * depth. 
             The negative indices are allowed to indicate the blocks in a inversed order with -1 representing the output for the last block. 
@@ -134,15 +152,14 @@
             self.conv_block = Convolution_Block(**block_params)
 
         def forward(self, x):
             if self.has_pooling: y = self.pooling(x)
             else: y = x
             return self.conv_block(y)
             
-            
     class Decoder_Block(nn.Module):
         
         def __init__(self, list_of_encoders, in_channels, out_channels, params, copies_of_inputs):
             super().__init__()
             block_params = params.copy()
             block_params.update({'in_channels': in_channels, 'out_channels': out_channels})
             self.__dict__.update(block_params)
@@ -159,15 +176,15 @@
             else: to_combine = [bt.crop_as(encoder_result, y) for encoder_result in list_of_encoder_results] + [y]
             joint = combine(to_combine, self.skip_type)
             return self.conv_block(joint)
 
 
     def __init__(self, **params):
         super().__init__()
-        default_values = {'dimension': 2, 'depth': 4, 'conv_num': 2, 'padding': 'SAME', 'in_channels': 1, 'out_channels': 2, 'block_channels': 64, 'kernel_size': 3, 'pooling_size': 2, 'keep_prob': 0.5, 'conv_block': 'conv', 'multi_arms': "shared", 'multi_arms_combine': cat, 'skip_type': cat, 'res_type': bt.add, 'activation_function': nn.ReLU, 'active_args': {}, 'initializer': "normal(0, 0.1)", 'with_softmax': True, 'cum_layers': -1}
+        default_values = {'dimension': 2, 'depth': 4, 'conv_num': 2, 'padding': 'SAME', 'in_channels': 1, 'out_channels': 2, 'block_channels': 64, 'kernel_size': 3, 'pooling_size': 2, 'keep_prob': 0.5, 'conv_block': 'conv', 'multi_arms': "shared", 'multi_arms_combine': cat, 'skip_type': cat, 'res_type': bt.add, 'activation_function': nn.ReLU, 'active_args': {}, 'initializer': "normal(0, 0.1)", 'with_softmax': True, 'cum_layers': -1, 'bottleneck_out_channels': 0}
         param_values = {}
         param_values.update(default_values)
         param_values.update(params)
         self.__dict__.update(param_values)
         
         if isinstance(self.block_channels, int):
             self.block_channels = [self.in_channels] + [self.block_channels << min(i, 2 * self.depth - i) for i in range(2 * self.depth + 1)] + [self.out_channels]
@@ -189,14 +206,18 @@
         self.arm_num = 1 if len(self.arm_num) == 0 else self.arm_num[0]
         if self.arm_type == 'shared': self.dif_arm_num = 1
         else: self.dif_arm_num = self.arm_num
         
         for iarm in range(self.dif_arm_num):
             for k in range(self.depth + 1):
                 setattr(self, 'block%d_%d' % (k, iarm), self.Encoder_Block(self.block_channels(k - 1), self.block_channels(k), k != 0, param_values))
+        
+        if self.bottleneck_out_channels > 0:
+            param_values = {k: v for k, v in param_values.items() if k not in ('in_channels', 'out_channels')}
+            setattr(self, 'bottleneck_out', Convolution_Block(self.block_channels(self.depth) * self.arm_num, self.bottleneck_out_channels, **param_values))
 
         for k in range(self.cum_layers[0], self.depth + 1):
             conv = eval('nn.Conv%dd' % self.dimension)(self.block_channels(k), self.block_channels(2 * self.depth + 1), 1, 1, 0)
             initialize_model, initialize_params = parse(self.initializer)
             eval('nn.init.%s_' % initialize_model)(conv.weight, *initialize_params)
             if k < self.cum_layers[1]:
                 setattr(self, 'block%dout' % k, nn.Sequential(conv, self.activation_function(**self.active_args)))
@@ -219,14 +240,22 @@
                 setattr(self, 'out%dupsample' % k, eval('nn.ConvTranspose%dd' % self.dimension)(
                     self.block_channels(2 * self.depth + 1), self.block_channels(2 * self.depth + 1), self.pooling_size, self.pooling_size, 0
                 ))
             else: setattr(self, 'block%dout' % k, conv)
 
         if self.with_softmax: self.softmax = self.Softmax()
         self.to(bt.get_device().main_device)
+        
+    @property
+    def bottleneck(self):
+        if self.bottleneck_out_channels > 0:
+            result = getattr(self, f'block{self.depth}result', None)
+            if result is None: return
+            return self.bottleneck_out(result).mean(...)
+        else: return
 
     def forward(self, x):
         size = x.size()[1:]
         if len(size) == self.dimension and self.in_channels == 1: x = x.unsqueeze(1)
         elif len(size) == self.dimension + 1 and self.in_channels * self.arm_num == size[0]: pass
         else: raise ValueError(f"The input tensor does not correspond to the U-Net structure: got {size}, but requires ([{self.in_channels * self.arm_num}], n_1, , n_{self.dimension}). ")
         
@@ -271,50 +300,50 @@
         for i in range(2 * self.depth + 1):
             if i <= self.depth:
                 for iarm in range(self.arm_num):
                     yield 'block%d_%dresult' % (i, iarm), (i, iarm)
             else: yield 'block%dresult' % i, i
 
 class CNN(U_Net):
+    '''
+    Args:
+        dimension (int): The dimension of the images. Defaults to 2 (see VGG). 
+        blocks (int): The number of the downsampling blocks. Defaults to 5 blocks (see VGG).
+        conv_num (int or list of length 'blocks'): The number of continuous convolutions in one block. Defaults to [2, 2, 3, 3, 3] (see VGG).
+            If the numbers for all blocks are the same, one can use one integer.
+        padding (int or str): Indicate the type of padding used. Defaults to 'SAME' indicating a same output shape as the input. 
+        in_channels (int): The number of channels for the input. Defaults to 1 (see VGG).
+        out_elements (int): The number of channels for the output, as the number of classification. Defaults to 1000 for 1000 classes.
+        layer_channels (int or list of length 'blocks'): The number of channels for each block. Defaults to [64, 128, 256, 512, 512] (see VGG). 
+            Or else, a function may be provided to compute the output channels given the block index (-1 ~ 2 * depth + 1). 
+        kernel_size (int): The size of the convolution kernels. Defaults to 3 (see VGG). 
+        pooling_size (int): The size of the pooling kernels. Defaults to 2 (see VGG). 
+        // keep_prob (float): The keep probability for the dropout layers. 
+        conv_block (str): A string with possible values in ('conv', 'dense', 'residual'), indicating which kind of block the U-Net is using: normal convolution layers, DenseBlock or ResidualBlock. 
+        multi_arms (str): A string with possible values in ('shared(2)', 'seperate(2)'), indicating which kind of encoder arms are used. 
+        multi_arms_combine (function): The combining type for multi-arms. Defaults to catenation (cat). Other possible skip types include torch.mul or torch.add. 
+        res_type (function): The combining type for the residual connections. It should be torch.add in most occasions. 
+        activation_function (class): The activation function used after the convolution layers. Defaults to nn.ReLU. 
+        active_args (dict): The arguments for the activation function. Defaults to {}. 
+        initializer (str): A string indicating the initialing strategy. Possible values are normal(0, 0.1) or uniform(-0.1, 0.1) or constant(0) (all parameters can be changed)
+        with_softmax (bool): Whether a softmax layer is applied at the end of the network. Defaults to True. 
+    '''
+    
     def __init__(self, dimension = 2, blocks = 5, conv_num = 2, padding = 'SAME', 
         in_channels = 1, out_elements = 2, layer_channels = 64, kernel_size = 3, 
         pooling_size = 2, keep_prob = 0.5, conv_block = 'conv', multi_arms = "shared", 
         multi_arms_combine = cat, res_type = bt.add, activation_function = nn.ReLU,
         active_args = {}, initializer = "normal(0, 0.1)", with_softmax = True):
-        '''
-        ::paramerters:
-            dimension (int): The dimension of the images. For conventional VGG, it is 2. 
-            blocks (int): The number of the downsampling blocks. The conventional VGG has 5 blocks.
-            conv_num (int or list of length 'blocks'): The number of continuous convolutions in one block. In VGG, this is [2, 2, 3, 3, 3]. If the numbers for all blocks are the same, one can use one integer.
-            padding (int or str): Indicate the type of padding used. In a conventional VGG, padding is 'SAME' indicating . 
-            in_channels (int): The number of channels for the input. In a conventional VGG, it should be 1.
-            out_elements (int): The number of channels for the output, as the number of classification. In a conventional VGG, it should be 1000 for 1000 classes.
-            layer_channels (int or list of length 'blocks'): The number of channels for each block. In a VGG, it should be [64, 128, 256, 512, 512]. 
-                Or else, a function may be provided to compute the output channels given the block index (-1 ~ 2 * depth + 1). 
-            kernel_size (int): The size of the convolution kernels. In a conventional U-Net, it should be 3. 
-            pooling_size (int): The size of the pooling kernels. In a conventional U-Net, it should be 2. 
-            // keep_prob (float): The keep probability for the dropout layers. 
-            conv_block (str): A string with possible values in ('conv', 'dense', 'residual'), indicating which kind of block the U-Net is using: normal convolution layers, DenseBlock or ResidualBlock. 
-            multi_arms (str): A string with possible values in ('shared(2)', 'seperate(2)'), indicating which kind of encoder arms are used. 
-            multi_arms_combine (function): The combining type for multi-arms. See skip_type for details. 
-            skip_type (function): The skip type for the skip connections. The conventional U-Net has a skip connect of catenation (cat). Other possible skip types include torch.mul or torch.add. 
-            res_type (function): The combining type for the residual connections. It should be torch.add in most occasions. 
-            activation_function (class): The activation function used after the convolution layers. Defaults to nn.ReLU. 
-            active_args (dict): The arguments for the activation function. Defaults to {}. 
-            initializer (str): A string indicating the initialing strategy. Possible values are normal(0, 0.1) or uniform(-0.1, 0.1) or constant(0) (all parameters can be changed)
-            with_softmax (bool): Whether a softmax layer is applied at the end of the network. Defaults to True. 
-            cum_layers (list): A list consisting two numbers [n, m] indicating that the result would be a summation of the upsamples of the results of the nth to the mth (included) blocks, block_numbers are in range 0 ~ 2 * depth. The negative indices are allowed to indicate the blocks in a inversed order with -1 representing the output for the last block. 
-        '''
         depth = blocks - 1
         if isinstance(layer_channels, int):
             maxlc = layer_channels
             layer_channels = [in_channels]
-            multiplier = int(math.pow(maxlc / in_channels, 1 / (depth + 1)))
+            multiplier = math.pow(maxlc / in_channels, 1 / (depth + 1))
             for i in range(depth):
-                layer_channels.append(layer_channels[-1] * multiplier)
+                layer_channels.append(int(layer_channels[-1] * multiplier))
             layer_channels.append(maxlc)
             layer_channels.extend([0] * depth)
             layer_channels.append(out_elements)
         super().__init__(dimension = dimension, depth = depth, conv_num = conv_num, 
             padding = padding, in_channels = in_channels, out_channels = out_elements, 
             block_channels = layer_channels, kernel_size = kernel_size, 
             pooling_size = pooling_size, keep_prob = keep_prob, conv_block = conv_block,
@@ -327,26 +356,44 @@
         self.with_softmax = False
         if wsm: r = self.softmax(super().forward(x).flatten(2).mean(-1))
         else: r = super().forward(x).flatten(2).mean(-1)
         self.with_softmax = wsm
         return r
         
 class FCN(nn.Module):
+    '''
+    Fully connected network, with hidden layers of increased and then decreased sizes. 
+        For layer_elements = 64 and layers = 8 and in_elements = out_elements = 8, 
+        the layer sizes are [8, 16, 32, 64, 64, 32, 16, 8]. 
+    
+    Args:
+        layers (int): Indicate the number of fully connected layers. 
+        in_elements (int): The number of elements for the input. Defaults to 1.
+        out_elements (int): The number of elements for the output, as the number of classification. Defaults to 1000 for 1000 classes.
+        layer_elements (int or list of length 'layers'): The number of channels for each block. In a VGG, it should be [64, 128, 256, 512, 512]. 
+            Or else, a function may be provided to compute the output channels given the block index (-1 ~ 2 * depth + 1). 
+        kernel_size (int): The size of the convolution kernels. Defaults to 3. 
+        keep_prob (float): The keep probability for the dropout layers. 
+        activation_function (class): The activation function used after the convolution layers. Defaults to nn.ReLU. 
+        active_args (dict): The arguments for the activation function. Defaults to {}. 
+        initializer (str): A string indicating the initialing strategy. Possible values are normal(0, 0.1) or uniform(-0.1, 0.1) or constant(0) (all parameters can be changed)
+        with_softmax (bool): Whether a softmax layer is applied at the end of the network. Defaults to True. 
+    '''
 
     class Softmax(nn.Module):
         def forward(self, x): return nn.functional.softmax(x, 1)
     def __init__(self, layers = 4, in_elements = 1, out_elements = 2, layer_elements = 64, 
         keep_prob = 0.5, activation_function = nn.ReLU, active_args = {}, 
         initializer = "normal(0, 0.1)", with_softmax = True):
         if isinstance(layer_elements, int):
             maxlc = layer_elements
             layer_elements = [in_elements]
-            multiplier = int(bt.pow(maxlc / in_elements, 1 / (layers // 2 + 1)))
+            multiplier = bt.pow(maxlc / in_elements, 1 / (layers // 2 - 1))
             for i in range(layers // 2 - 1):
-                layer_elements.append(layer_elements[-1] * multiplier)
+                layer_elements.append(int(layer_elements[-1] * multiplier))
             layer_elements.append(maxlc)
             if layers % 2 == 0: layer_elements.extend(layer_elements[-2::-1])
             else: layer_elements.extend(layer_elements[::-1])
             layer_elements[-1] = out_elements
         if isinstance(layer_elements, list):
             lc = layer_elements.copy()
             layer_elements = lambda i: lc[i]
@@ -362,15 +409,178 @@
             elif with_softmax:
                 self.layers.append(self.Softmax())
         self.struct = nn.Sequential(*self.layers)
         self.to(bt.get_device().main_device)
 
     def forward(self, x):
         return self.struct(x)
-
+    
+class NeuralODE(nn.Module):
+    '''
+    Neural ODE structue. 
+    => [dual stream: reference maps] dual_channels
+    => [main stream: inputs] main_channels
+    
+    Args:
+        dimension (int): The dimension of the images. 
+        layers (int): The number accumulated layers. 
+        conv_num (int): The number of continuous convolutions in each layer. Defaults to 2. 
+        dual_channels (int): The number of channels for the dual stream ODE. Defaults to 0, indicating no dual network.
+        main_channels (int): The number of channels for the main stream ODE. Defaults to 2.
+        kernel_size (int): The size of the convolution kernels. Defaults to 3. 
+        padding (int or str): Indicate the type of padding used. Defaults to 'SAME' indicating a same output shape as the input. 
+        conv_block (str): A string with possible values in ('conv', 'dense', 'residual'), indicating which kind of block for the layers: normal convolution layers, DenseBlock or ResidualBlock. 
+        res_type (function): The combining type for the residual connections. It should be torch.add in most occasions. 
+        activation_function (class): The activation function used after the convolution layers. Defaults to nn.ReLU. 
+        final_activation (class): The activation function after the final convolution. Defaults to self.activation_function. 
+        active_args (dict): The arguments for the activation function. Defaults to {}. 
+        initializer (str): A string indicating the initialing strategy. Possible values are normal(0, 0.1) or uniform(-0.1, 0.1) or constant(0) (all parameters can be changed)
+        regularization (func): The regularization term for the delta terms. 
+    '''
+    
+    class Softmax(nn.Module):
+        def forward(self, x): return nn.functional.softmax(x, 1)
+    
+    def __init__(self, dimension = 2, layers = 10, conv_num = 2, kernel_size = 3, padding = 1, 
+        dual_channels = 0, main_channels = 2, conv_block = 'conv', res_type = bt.add, 
+        activation_function = nn.ReLU, final_activation = ..., active_args = {}, initializer = "normal(0, 0.1)", 
+        shared = True, dual_ODE = True, time_channels = 1, auto_grad = False, regularization = None):
+        super().__init__()
+        
+        if dual_channels == True: dual_channels = 64
+        
+        params = dict(dimension=dimension, conv_num=conv_num, kernel_size=kernel_size, padding=padding, 
+            activation_function=activation_function, final_activation=final_activation, active_args=active_args, conv_block=conv_block, res_type=res_type, initializer=initializer)
+        if dual_channels > 0:
+            if dual_ODE:
+                if shared:
+                    self.dual_march_func = Convolution_Block(in_channels=dual_channels + time_channels, out_channels=dual_channels, **params)
+                    self.dual_march = [self.dual_march_func] * layers
+                else:
+                    self.dual_march = []
+                    for i in range(layers):
+                        setattr(self, f'dual_march_func_{i}', Convolution_Block(in_channels=dual_channels + time_channels, out_channels=dual_channels, **params))
+                        self.dual_march.append(getattr(self, f'dual_march_func_{i}'))
+        if shared:
+            self.main_march_func = Convolution_Block(in_channels=main_channels + dual_channels + time_channels, out_channels=main_channels, **params)
+            self.main_march = [self.main_march_func] * layers
+        else:
+            self.main_march = []
+            for i in range(layers):
+                setattr(self, f'main_march_func_{i}', Convolution_Block(in_channels=main_channels + dual_channels + time_channels, out_channels=main_channels, **params))
+                self.main_march.append(getattr(self, f'main_march_func_{i}'))
+        self.layers = layers
+        self.shared = shared
+        self.dual_ODE = dual_ODE
+        self.auto_grad = auto_grad
+        self.dual_channels = dual_channels
+        self.time_channels = time_channels
+        self.regularization = regularization
+    
+    def time(self, i, n_channel):
+        return (i / self.layers) * bt.ones(self.reference.shape.with_feature((n_channel,)), dtype=self.reference.dtype, device=self.reference.device)
+    
+    def integral(self, init_x, diff_func, time_inv = False):
+        x = init_x
+        for i in range(self.layers):
+            i = self.layers - i - 1 if time_inv else i
+            x = [(u - v) if time_inv else (u + v) for u, v in zip(x, diff_func(x, i))]
+        return x
+    
+    def march(self, x, march_funcs, i):
+        if self.time_channels > 0:
+            t = self.time(i, n_channel=self.time_channels)
+            return march_funcs[i](bt.cat(x, t, [])) / self.layers
+        return march_funcs[i](x) / self.layers
+    
+    def forward_diff_func(self, x, i):
+        if self.dual_channels > 0:
+            main_x, dual_x = x
+            delta_main_x = self.march(bt.cat(main_x, dual_x, []), self.main_march, i)
+            if self.dual_ODE: # DSNODE
+                delta_dual_x = self.march(dual_x, self.dual_march, i)
+            else: delta_dual_x = bt.zeros_like(dual_x)
+            return delta_main_x, delta_dual_x # SNODE / DSNODE
+        return [self.march(x[0], self.main_march, i)] # UNODE
+    
+    def forward_func(self, init_x, dual_init_x=None):
+        self.reference = init_x
+        if self.dual_channels > 0:
+            self.output, self.dual = self.integral([init_x, dual_init_x], self.forward_diff_func)
+        else: self.output, = self.integral([init_x], self.forward_diff_func)
+        return self.output
+    
+    def UNODE_backward_diff_func(self, x, i):
+        main_x, d_main = x
+        with bt.enable_grad():
+            main_x = main_x.detach().requires_grad_(True)
+            delta_main_x = self.march(main_x, self.main_march, i)
+            if self.regularization is not None:
+                self.regularization(delta_main_x).backward()
+            delta_main_x.backward(d_main.detach())
+        return delta_main_x.detach(), -main_x.grad
+    
+    def SNODE_backward_diff_func(self, x, i):
+        main_x, d_main, d_dual = x
+        with bt.enable_grad():
+            main_x = main_x.detach().requires_grad_(True)
+            dual_x = self.dual.detach().requires_grad_(True)
+            delta_main_x = self.march(bt.cat(main_x, dual_x, []), self.main_march, i)
+            if self.regularization is not None:
+                self.regularization(delta_main_x).backward()
+            delta_main_x.backward(d_main.detach())
+        return delta_main_x.detach(), -main_x.grad, -dual_x.grad
+    
+    def DSNODE_backward_diff_func(self, x, i):
+        main_x, dual_x, d_main, d_dual = x
+        with bt.enable_grad():
+            main_x = main_x.detach().requires_grad_(True)
+            dual_x = dual_x.detach().requires_grad_(True)
+            delta_main_x = self.march(bt.cat(main_x, dual_x, []), self.main_march, i)
+            delta_dual_x = self.march(dual_x, self.dual_march, i)
+            if self.regularization is not None:
+                self.regularization(delta_main_x).backward()
+            delta_dual_x.backward(d_dual.detach())
+            delta_main_x.backward(d_main.detach())
+        return delta_main_x.detach(), delta_dual_x.detach(), -main_x.grad, -dual_x.grad
+    
+    def backward(self, output_grad):
+        output_grad = output_grad.as_subclass(bt.Tensor).view(self.output.shape)
+        inits = []
+        if self.dual_channels > 0:
+            if self.dual_ODE:
+                inits = [self.output, self.dual, output_grad, bt.zeros_like(self.dual)]
+                ret = self.integral(inits, self.DSNODE_backward_diff_func, time_inv=True)[2:]
+            else:
+                inits = [self.output, output_grad, bt.zeros_like(self.dual)]
+                ret = self.integral(inits, self.SNODE_backward_diff_func, time_inv=True)[1:]
+        else:
+            inits = [self.output, output_grad]
+            ret = self.integral(inits, self.UNODE_backward_diff_func, time_inv=True)[1:]
+        # for mlayer in ([self.main_march[0]] if self.shared else self.main_march):
+        #     for p in mlayer.parameters(): p.grad = -p.grad
+        # if self.dual_channels > 0:
+        #     for mlayer in ([self.dual_march[0]] if self.shared else self.dual_march):
+        #         for p in mlayer.parameters(): p.grad = -p.grad
+        return ret
+    
+    class Autograd_Func(bt.autograd.Function):
+        @staticmethod
+        def forward(ctx, self, init_x, dual_init_x=None):
+            ctx.self = self
+            return self.forward_func(init_x, dual_init_x=dual_init_x)
+        
+        @staticmethod
+        def backward(ctx, output_grad):
+            return None, *ctx.self.backward(output_grad)
+    
+    def forward(self, init_x, dual_init_x=None):
+        if self.auto_grad: return self.forward_func(init_x, dual_init_x=dual_init_x)
+        if self.dual_channels == 0: return self.Autograd_Func.apply(self, init_x)
+        return self.Autograd_Func.apply(self, init_x, dual_init_x)
 
 if __name__ == "__main__":
 #    unet = U_Net(multi_arms="seperate(3)", block_channels=16)
 #    print(unet(bt.rand(10, 3, 100, 100)).size())
 #    print(*[x + ' ' + str(unet[i].size()) for x, i in unet], sep='\n')
     unet = U_Net(
         dimension=3,
```

### Comparing `batorch-1.0.53/micomputing/stdio.py` & `batorch-1.0.54/micomputing/stdio.py`

 * *Files 6% similar despite different names*

```diff
@@ -11,14 +11,15 @@
     requires = ["nibabel", "pydicom"]
 )
 
 __all__ = """
     IMG
     dcm2nii
     nii2dcm
+    affine2orient
 """.split()
 
 import os
 from datetime import datetime as dt
 
 with __info__:
     import SimpleITK as sitk
@@ -74,14 +75,27 @@
 with run("DCM", "NII"), run.all_tags:
     def dcm2nii(file1, file2):
         IMG(file1).astype(IMG.nii).save(file2)
 
     def nii2dcm(file1, file2):
         IMG(file1).astype(IMG.dcm).save(file2)
         
+def affine2orient(affine):
+    aff_abs = np.abs(affine[:-1, :-1])
+    n_dim = aff_abs.shape[-1]
+    orient = [''] * n_dim
+    for d in range(n_dim):
+        k = aff_abs.argmax()
+        i = k // n_dim
+        j = k - i * n_dim
+        orient[j] = ['RL', 'AP', 'SI'][i][affine[i, j] > 0]
+        aff_abs[i] = 0
+        aff_abs[:, j] = 0
+    return ''.join(orient)
+        
 class Spacing(tuple): ...
 
 class IMG:
     
     with run("PNG"), run.use_tag: png = PNG = 'PNG'
     with run("DCM"), run.use_tag: dcm = DCM = 'DCM'
     with run(sitk_supported_modalities), run.all_tags:
@@ -108,15 +122,15 @@
         if not done:
             if not path.exists(): raise FileNotFoundError(f"Cannot find file/folder {path}. ")
             self.ftype = kwargs.get('astype', None)
             if self.ftype is None: raise TypeError(f"micomputing.IMG failed to recognize type of {path}. Use `astype=IMG.nii` or other image format to identify it. ")
             with run(sitk_supported_modalities), run.any_tag:
                 if self.ftype in sitk_supported_modalities: self.__init_sitk__(path, **kwargs); done =True
             with run("DCM"), run.use_tag:
-                if self.ftype == "DCM": self.__init_dcm__(path, **kwargs); done =True
+                if self.ftype in ("DCM", "IMA"): self.__init_dcm__(path, **kwargs); done =True
         if len(self.basics) <= 0: self.basics = basic_tags.copy()
 
     @overload
     def __init__(self, x: sitk.Image, **kwargs):
         self.unresolved_warning = False
         self.has_series = False
         self.ftype = kwargs.get('ftype', None)
@@ -532,19 +546,15 @@
     def shape(self):
         if self.has_series: raise Error('Property')("No property 'shape' for micomputing.IMG with series. ")
         return tuple(self.image.GetSize())
     
     @property
     def orientation(self):
         if self.has_series: raise Error('Property')("No property 'orientation' for micomputing.IMG with series. ")
-        affine = self.affine
-        dim_ord = np.abs(affine[:-1, :-1]).argmax(0).tolist()
-        try: dx = np.array([affine[dim_ord[d], d] for d in range(len(dim_ord))])
-        except ValueError: raise TypeError(f"Invalid affine matrix: {affine}")
-        return ''.join([['RL', 'AP', 'SI'][i][j] for i, j in zip(dim_ord, dx > 0)])
+        return affine2orient(self.affine)
 
     def reorient(self, orient='LPI'):
         if self.has_series: raise Error('Property')("Cannot reorient for micomputing.IMG with series. ")
         axis = {'L':'LR', 'R':'LR', 'A':'AP', 'P':'AP', 'I':'SI', 'S':'SI'}
         from .funcs import reorient
         from .trans import Translation, Reflection, DimPermutation, ComposedTransformation
         orient_axis = [axis[i] for i in self.orientation]
@@ -783,22 +793,21 @@
                 used_path = []
                 for sid in ids:
                     info = infos[sid]
                     p = get_path(sid)
                     if p is None: continue
                     if isdir(p):
                         if not os.path.exists(p): os.mkdir(p)
-                        if self.has_series:
-                            extra = info.copy()
-                            for k in IMG.basic_info: extra.pop(k)
-                            if len(extra) > 0: extra_str = ''.join([f"_{get_alphas(k)}{get_digits(str(v)) if get_digits(str(v)) else get_alphas(str(v))}" for k, v in extra.items()])
-                            else: extra_str = ''
-                            default_name = f"{info['SeriesTime']}_{info['SeriesDescription']}_{info['SeriesNumber']}"
-                            p = os.path.join(p, default_name)
-                            if p in used_path: p += extra_str
+                        extra = info.copy()
+                        for k in IMG.basic_info: extra.pop(k)
+                        if len(extra) > 0: extra_str = ''.join([f"_{get_alphas(k)}{get_digits(str(v)) if get_digits(str(v)) else get_alphas(str(v))}" for k, v in extra.items()])
+                        else: extra_str = ''
+                        default_name = f"{info['SeriesTime']}_{info['SeriesDescription']}_{info['SeriesNumber']}"
+                        p = os.path.join(p, default_name)
+                        if p in used_path: p += extra_str
                         p //= ext
                     if p in used_path:
                         if avoid_conflict:
                             if p | ext: p = p[:-len(ext)]
                             i = 1
                             while True:
                                 if p + f' ({i})' + ext in used_path: i += 1
```

### Comparing `batorch-1.0.53/micomputing/test_dismap.py` & `batorch-1.0.54/micomputing/test_dismap.py`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/micomputing/trans.py` & `batorch-1.0.54/micomputing/trans.py`

 * *Files 2% similar despite different names*

```diff
@@ -30,14 +30,16 @@
     Affine                 Aff         rand_Affinity               rand_Aff
     PolyAffine                         rand_PolyAffine
     logEuclidean           logEu       rand_logEuclidean           rand_logEu
     LocallyAffine          LARM        rand_LocallyAffine          rand_LARM
     FreeFormDeformation    FFD         rand_FreeFormDeformation    rand_FFD
     DenseDisplacementField DDF         rand_DenseDisplacementField rand_DDF
     VelocityField          VF          rand_VelocityField          rand_VF
+    
+    Normalize              Cropping
 """.split()
 #     FreeFormDeformation FFD
 #     DenseDisplacementField DDF
 #     MultiLayerPerception MLP
     
 #     Normalize
     
@@ -70,14 +72,15 @@
 #     return isinstance(x, (WorldCoordsTransformation, ImageCoordsTransformation)) \
 #         or isinstance(x, ComposedTransformation) and x.mode == "spatial"
 
 # def is_world_coords_transformation(x):
 #     return isinstance(x, Transformation) or isinstance(x, ComposedTransformation) and x.mode == "spatial"
 
 def perform_reshape(shape, reshape_args):
+    if len(reshape_args) == 1: return tuple(reshape_args[0])
     n_dim = len(shape)
     padding, scale, *pairs = reshape_args
     if len(scale) == 1: scale *= n_dim
     if len(padding) == 1: padding *= n_dim
     padding = tuple(p if isinstance(p, tuple) else (p, p) for p in padding)
     target_space = [int(x * y + a + b) for x, y, (a, b) in zip(shape, scale, padding)]
     for p, q in pairs: target_space[p], target_space[q] = target_space[q], target_space[p]
@@ -222,15 +225,15 @@
         self.target = None
         self.params = params
         self.kwparams = kwparams
         self.n_dim = None
         self.n_batch = None
         self.reshape = [(0,), (1,)]
         """
-        e.g. [((dl1, dl1), (dl2, dl2), (dl3, dl3)), (s[0], s[1], s[2]), (d[0], d[1]), (d[2], d[3])] means:
+        e.g. [((dl[0], dl[0]), (dl[1], dl[1]), (dl[2], dl[2])), (s[0], s[1], s[2]), (d[0], d[1]), (d[2], d[3])] means:
             1) transpose dimensions d[2] and d[3]; followed by d[0] with d[1];
             2) rescale at dimension d with s[d];
             3) crop(* < 0) or pad(* > 0) a side by dl[d],
                 where #=+ for the larger side and #=- for the lower side;
         The shape transformation goes from left to right. Only the firt two transformation can be a tuple with length other than 2, 
             meaning scaling and padding instead of transpose. Having a length 1, e.g. (*,), stands for isotropic scaling or padding;
             being (1,) means no scaling, (0,) means no padding.
@@ -305,15 +308,15 @@
                 return_image = True
                 input_images = X
                 if to_shape is None: to_shape = X.space
                 X = bt.image_grid(*perform_reshape(to_shape, self.reshape)).duplicate(self.n_batch if self.n_batch is not None else 1, {})
                 domain = 'image-space'
         else: # domain in ('physical-space', 'image-space')
             avouch(X.has_channel, f"Please use batorch tensor of size ({{n_batch:optional}}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim] for {self.__name__}, instead of {X.shape}. ")
-            avouch(X.n_channel == n_dim, f"[n_dim]D {self.__name__} does not take coordinates of size {X.shape}")
+            avouch(X.n_channel == n_dim, f"{n_dim}D {self.__name__} does not take coordinates of size {X.shape}")
 
         Y = X.clone().float()
         if not Y.has_batch:
             if self.n_batch is not None: Y = Y.duplicate(self.n_batch, {})
             else: Y = Y.unsqueeze({})
         elif Y.n_batch == 1 and self.n_batch is not None: Y = Y.amplify(self.n_batch, {})
         
@@ -347,15 +350,15 @@
     __affine__ = NotImplemented
     __inv__ = NotImplemented
     
     @staticmethod
     def __get_affine__(x):
         if isinstance(x, str): x = IMG(x)
         if isinstance(x, IMG): x = x.affine
-        x = bt.to_bttensor(x)
+        x = bt.to_bttensor(x).auto_device()
         avouch(2 <= x.n_dim <= 3, TypeError(f"Invalid affine matrix represented by shape {x.shape}. "))
         avouch(not x.has_func and not x.has_sequence, TypeError(f"Invalid affine matrix represented by shape {x.shape}, only batch/feature dimensions are allowed. "))
         if x.n_dim == 3: x.special_from(bt.Size({1}, [1, 1]))
         else: x.special_from(bt.Size([1, 1]))
         avouch(x.feature[0] == x.feature[1], TypeError(f"Invalid affine matrix represented by shape {x.shape}: should be of shape (n_dim+1, n_dim+1). "))
         return x
     
@@ -764,47 +767,47 @@
     
     def force_inv(self, *size):
         if self.inv != NotImplemented: return self.inv()
         else: return self.num_inv(*size)
 
 @alias("CompoundTransformation")
 class ComposedTransformation(Transformation):
+    """
+    Create a composed transformation. 
+
+    Note: The composed transformation `T` consist of a list of transformations, `[T, T, , T]`. 
+        If domain = image/physical-space, backward = True (represented by image-space transformations):
+            T(X) = T(T(  (T(X)))) for coordinates X, i.e., IT = ITT  T.
+        If domain = image/physical-space, backward = False (represented by image-space transformations):
+            I(T(x)) = I(x);  ; IT(x) = I(x), i.e., ITT  T = I; IT = I.
+        If domain = non-spatial:
+            T(X) = T(T(  (T(I)))) for images I, i.e., TI = TT  TI. 
+        Always remember, transformation is performed in order T, T,  , T, 
+            except continuous coordinate transformations go backward. 
+
+    Args:
+        trans_list (list or tuple): The list of transformations, operating one by one onto an image. 
+            A series of backward transformations would be equivalent to a composition of functions from right to left.
+    
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+            OR Images to be transformed. 
+            size: ({n_batch:optional}, [n_channel:optional], n_1, n_2, ..., n_r) [r=n_dim]
+    """
     
     @staticmethod
     def __flat__(trans_list):
         flat_trans_list = []
         for t in trans_list:
             if not isinstance(t, ComposedTransformation): flat_trans_list.append(t)
             else: flat_trans_list.extend(ComposedTransformation.__flat__(t.trans_list))
         return flat_trans_list
 
     def __init__(self, *trans_list, domain=None, backward=None):
-        """
-        Create a composed transformation. 
-
-        Note: The composed transformation `T` consist of a list of transformations, `[T, T, , T]`. 
-            If domain = image/physical-space, backward = True (represented by image-space transformations):
-                T(X) = T(T(  (T(X)))) for coordinates X, i.e., IT = ITT  T.
-            If domain = image/physical-space, backward = False (represented by image-space transformations):
-                I(T(x)) = I(x);  ; IT(x) = I(x), i.e., ITT  T = I; IT = I.
-            If domain = non-spatial:
-                T(X) = T(T(  (T(I)))) for images I, i.e., TI = TT  TI. 
-            Always remember, transformation is performed in order T, T,  , T, 
-                except continuous coordinate transformations go backward. 
-
-        Args:
-            trans_list (list or tuple): The list of transformations, operating one by one onto an image. 
-                A series of backward transformations would be equivalent to a composition of functions from right to left.
-        
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-                OR Images to be transformed. 
-                size: ({n_batch:optional}, [n_channel:optional], n_1, n_2, ..., n_r) [r=n_dim]
-        """
         super().__init__()
         
         ##  find uniform n_dim & n_batch ##
         ###################################
         n_dims = set([t.n_dim for t in trans_list if t.n_dim is not None])
         n_batches = set([t.n_batch for t in trans_list if t.n_batch is not None])
         if 1 in n_batches: n_batches.remove(1)
@@ -835,14 +838,16 @@
         self.backward = backward
 
         ##  combine the reshape property ##
         ###################################
         accum = [(0,), (1,)]
         add_pad = lambda x, y: tuple(a+b for a, b in zip(x if isinstance(x, tuple) else (x, x), y if isinstance(y, tuple) else (y, y)))
         for t in self.trans_list:
+            if len(t.reshape) == 1: accum = t.reshape; continue
+            if len(accum) == 1: accum = [perform_reshape(accum[0], t.reshape)]; continue
             padding_a, scale_a, *pairs_a = accum
             padding_t, scale_t, *pairs_t = t.reshape
 
             if len(padding_a) == 1: padding_a *= len(padding_t)
             else:
                 padding_a = list(padding_a)
                 for p, q in pairs_t[::-1]: padding_a[p], padding_a[q] = padding_a[q], padding_a[p]
@@ -927,71 +932,81 @@
     def source(self, _): ...
 
     @property
     def target(self): return self.trans_list[-1].target
     @target.setter
     def target(self, _): ...
 
-    def __call__(self, X, domain=None, **kwargs):
+    def __call__(self, X, domain=None, use_implementation=None, to_shape=None, **kwargs):
         """
         Perform composed transformation. 
         
         domain = physical/image-space::
             X (bt.Tensor): Coordinates to be transformed.
                 size: ({n_batch: optional}, [r], n_1, n_2, ..., n_r) [r=n_dim]
             Returns (bt.Tensor): The transformed coordinates.
                 size: ({n_batch}, [r], n_1, n_2, ..., n_r) [r=n_dim]
         domain = non-spatial::
             X (bt.Tensor): Images to be transformed.
                 size: ({n_batch: optional}, [n_channel:optional], n_1, n_2, ..., n_r) [r=n_dim]
             Returns (bt.Tensor): The transformed images.
                 size: ({n_batch}, [n_channel:optional], n_1, n_2, ..., n_r) [r=n_dim]
+        
+        Other Args:
+            use_implementation (str): The implementation function used to perform transformation. Defaults to the implementation for self.domain. 
+            to_shape (tuple): The output shape for the non-spatial transformation. 
         """
+        if not (X.has_channel and X.n_channel == X.n_space_dim): domain = 'non-spatial'
         if domain is None: domain = self.domain
 
         accum_spatial_trans = []
         for t in self.trans_list + [None]:
             if t is not None and t.domain != 'non-spatial' and (t.backward or t.inv != NotImplemented): accum_spatial_trans.append(t); continue
             if len(accum_spatial_trans) > 0:
                 n_img = sum(t.domain == 'image-space' or (t.source is not None and t.target is not None) for t in accum_spatial_trans)
                 n_phy = sum(t.domain == 'physical-space' or (t.source is not None and t.target is not None) for t in accum_spatial_trans)
                 if n_img == len(accum_spatial_trans) and n_phy == len(accum_spatial_trans):
-                    n_img = sum(t.core_domain == 'image-space' for t in accum_spatial_trans)
-                    n_phy = sum(t.core_domain == 'physical-space' for t in accum_spatial_trans)
-                    if n_img > n_phy: cur_domain = 'image-space'
+                    n_img = sum(t.domain == 'image-space' for t in accum_spatial_trans)
+                    n_phy = sum(t.domain == 'physical-space' for t in accum_spatial_trans)
+                    if n_img > n_phy: core_domain = 'image-space'
                     else: core_domain = 'physical-space'
+                elif n_img == len(accum_spatial_trans): core_domain = 'image-space'
+                elif n_phy == len(accum_spatial_trans): core_domain = 'physical-space'
                 else: core_domain = domain
 
+                return_image = False
                 if domain == 'non-spatial':
                     return_image = True
                     input_images = X
-                    X = bt.image_grid(*perform_reshape(X.space, self.reshape)).duplicate(self.n_batch if self.n_batch is not None else 1, {})
+                    if to_shape is None: to_shape = X.space
+                    X = bt.image_grid(*perform_reshape(to_shape, self.reshape)).duplicate(self.n_batch if self.n_batch is not None else 1, {})
                     domain = 'image-space'
-
+                
                 if domain == core_domain:
                     for st in accum_spatial_trans[::-1]:
                         if st.backward: X = st(X, domain=core_domain)
                         else: X = st.inv()(X, domain=core_domain)
                 else:
                     source = self.source
                     target = self.target
                     avouch(source is not None and target is not None, "Cannot perform image/physical-space transformation for image coordinates without source/target information. ")
 
                     taffine = Transformation.__get_affine__(target)
                     saffine = Transformation.__get_affine__(source)
                     if domain == 'image-space': saffine = saffine.inv()
                     else: taffine = taffine.inv()
-                    X = bt.matmul(taffine, X)
+                    X = (bt.matmul(prev_affine[..., :n_dim, :n_dim], X.flatten(...).add_special_dim(-1, [])) + prev_affine[..., :n_dim, n_dim:]).view_as(X)
                     for st in accum_spatial_trans[::-1]:
                         if st.backward: X = st(X, domain=core_domain)
                         else: X = st.inv()(X, domain=core_domain)
-                    X = bt.matmul(saffine, X)
+                    X = (bt.matmul(post_affine[..., :n_dim, :n_dim], X.flatten(...).add_special_dim(-1, [])) + post_affine[..., :n_dim, n_dim:]).view_as(X)
                 
                 if return_image: X = interpolation(input_images, target_space=X, **kwargs)
-            X = t(X, domain=domain)
+            if t is not None:
+                X = t(X, domain=domain)
         return X
 
     @req_spatial
     def affine(self, n_dim=None):
         # avouch(self.is_spatial, "Cannot get `affine` from composed transformation with non-spatial transformation. ")
         comp = self.compose()
         avouch(len(comp) == 1, "Error in calling `affine`: Only the composition of linear transformations can result in an affine matrix.")
@@ -1031,53 +1046,54 @@
         dic['trans_list'] = [t.to_dict() for t in self.trans_list]
         return dic
 
 # ########### Spatial Transformations ###########
 
 @alias("Id")
 class Identity(Transformation):
+    """
+    Identity transformation.
+        
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates. (Same as X for Identity)
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+    """
 
     def __init__(self, **kwargs):
-        """
-        Identity transformation.
-            
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed coordinates. (Same as X for Identity)
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-        """
         super().__init__(**kwargs)
 
     def __affine__(self, n_dim=None):
         if n_dim is None: return
         return bt.eye([n_dim + 1]).unsqueeze({})
 
     def __call_image_space__(self, X): return X
 
     def __inv__(self): return Identity()
 
 class Rotation90(Transformation):
+    """
+    Transformation that rotates an image of `image_size` by 90 degrees.
+    
+    Note: The rotation is for coordinates, hence the image rotates clockwise. 
+    
+    Args:
+        dim1, dim2 (int): The plane we rotate on. Direction of the rotation is from `dim1` to `dim2`.
+            i.e. counter-clockwise rotation with dim1 as x-axis and dim2 as y-axis: [dim1, dim2] coordinates (x, y) becomes (ymax-y, x).
+        image_size (tuple or bt.Tensor): The size of the image, or the image itself. 
+        
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates.
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+    """
+
     def __init__(self, dim1, dim2, image_size=None, resize_image=True, **kwargs):
-        """
-        Transformation that rotates an image of `image_size` by 90 degrees.
-        
-        Note: The rotation is for coordinates, hence the image rotates clockwise. 
-        
-        Args:
-            dim1, dim2 (int): The plane we rotate on. Direction of the rotation is from `dim1` to `dim2`.
-                i.e. counter-clockwise rotation with dim1 as x-axis and dim2 as y-axis: [dim1, dim2] coordinates (x, y) becomes (ymax-y, x).
-            image_size (tuple or bt.Tensor): The size of the image, or the image itself. 
-            
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed coordinates.
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-        """
         super().__init__(dim1=dim1, dim2=dim2, image_size=image_size, resize_image=resize_image, **kwargs)
 
         self.dim1, self.dim2 = dim1, dim2
         if isinstance(image_size, bt.torch.Tensor): image_size = image_size.shape
         self.image_size = image_size
         if image_size is not None: self.n_dim = len(image_size)
         if resize_image: self.reshape = [(0,), (1,), (dim1, dim2)]
@@ -1107,31 +1123,32 @@
         aff[dim2][dim2] = 0.
         aff[dim2][dim1] = 1.
         return aff.unsqueeze({})
     
     def __inv__(self): return Rotation270(self.dim1, self.dim2, image_size = self.image_size, resize_image = self.resize_image)
 
 class Rotation270(Transformation):
+    """
+    Transformation that rotates an image by 270 degrees.
+    
+    Note: The rotation is for coordinates, hence the image rotates clockwise. 
+    
+    Args:
+        dim1, dim2 (int): The plane we rotate on. Direction of the rotation is from `dim1` to `dim2`.
+            i.e. counter-clockwise rotation with dim1 as x-axis and dim2 as y-axis: [dim1, dim2] coordinates (x, y) becomes (y, xmax-x).
+        image_size (tuple or bt.Tensor): The size of the image, or the image itself. 
+        
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates.
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+    """
+    
     def __init__(self, dim1, dim2, image_size=None, resize_image=True, **kwargs):
-        """
-        Transformation that rotates an image by 270 degrees.
-        
-        Note: The rotation is for coordinates, hence the image rotates clockwise. 
-        
-        Args:
-            dim1, dim2 (int): The plane we rotate on. Direction of the rotation is from `dim1` to `dim2`.
-                i.e. counter-clockwise rotation with dim1 as x-axis and dim2 as y-axis: [dim1, dim2] coordinates (x, y) becomes (y, xmax-x).
-            image_size (tuple or bt.Tensor): The size of the image, or the image itself. 
-            
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed coordinates.
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-        """
         super().__init__(dim1=dim1, dim2=dim2, image_size=image_size, resize_image=resize_image, **kwargs)
 
         self.dim1, self.dim2 = dim1, dim2
         if isinstance(image_size, bt.torch.Tensor): image_size = image_size.shape
         self.image_size = image_size
         if image_size is not None: self.n_dim = len(image_size)
         if resize_image: self.reshape = [(0,), (1,), (dim1, dim2)]
@@ -1161,29 +1178,30 @@
         aff[dim2][dim1] = -1.
         aff[dim2][-1] = float(self.image_size[dim1])
         return aff.unsqueeze({})
     
     def __inv__(self): return Rotation90(self.dim1, self.dim2, image_size = self.image_size, resize_image = self.resize_image)
 
 class Rotation180(Transformation):
+    """
+    Transformation that rotates an image by 180 degrees.
+    
+    Args:
+        dim1, dim2 (int): The plane we rotate on. It is also the central symmetry.
+            i.e. rotation with dim1 as x-axis and dim2 as y-axis: [dim1, dim2] coordinates (x, y) becomes (xmax-x, ymax-y).
+        image_size (tuple or bt.Tensor): The size of the image, or the image itself. 
+        
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates.
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+    """
+    
     def __init__(self, dim1, dim2, image_size=None, **kwargs):
-        """
-        Transformation that rotates an image by 180 degrees.
-        
-        Args:
-            dim1, dim2 (int): The plane we rotate on. It is also the central symmetry.
-                i.e. rotation with dim1 as x-axis and dim2 as y-axis: [dim1, dim2] coordinates (x, y) becomes (xmax-x, ymax-y).
-            image_size (tuple or bt.Tensor): The size of the image, or the image itself. 
-            
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed coordinates.
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-        """
         super().__init__(dim1=dim1, dim2=dim2, image_size=image_size, **kwargs)
 
         self.dim1, self.dim2 = dim1, dim2
         if isinstance(image_size, bt.torch.Tensor): image_size = image_size.shape
         self.image_size = image_size
         if image_size is not None: self.n_dim = len(image_size)
 
@@ -1210,29 +1228,30 @@
         aff[dim2][-1] = float(self.image_size[dim2])
         return aff.unsqueeze({})
 
     def __inv__(self): return Rotation180(self.dim1, self.dim2, image_size = self.image_size)
 
 @alias("Reflect")
 class Reflection(Transformation):
+    """
+    Transformation that reflects an image along dimension dim.
+    
+    Args:
+        dims (int's): The dimension we reflect the image along. 
+            i.e. reflection on dims: coordinate x at dim (in dims) becomes x_max-x.
+        image_size (tuple or bt.Tensor): The size of the image, or the image itself. 
+        
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates.
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+    """
+    
     def __init__(self, *dims, image_size=None, **kwargs):
-        """
-        Transformation that reflects an image along dimension dim.
-        
-        Args:
-            dims (int's): The dimension we reflect the image along. 
-                i.e. reflection on dims: coordinate x at dim (in dims) becomes x_max-x.
-            image_size (tuple or bt.Tensor): The size of the image, or the image itself. 
-            
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed coordinates.
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-        """
         super().__init__(dims=dims, image_size=image_size, **kwargs)
 
         if len(dims) == 1 and isinstance(dims[0], (list, tuple)): dims = dims[0]
         self.dims = dims
         if isinstance(image_size, bt.torch.Tensor): image_size = image_size.shape
         self.image_size = image_size
         if image_size is not None: self.n_dim = len(image_size)
@@ -1257,38 +1276,39 @@
         for dim in self.dims:
             aff[dim][dim] = -1.
             aff[dim][-1] = float(self.image_size[dim])
         return aff.unsqueeze({})
 
 @alias("Permutedim")
 class DimPermutation(Transformation):
-    def __init__(self, *dims, resize_image=True, **kwargs):
-        """
-        Permute the dimensions for an image, similar to np.transpose or torch/batorch.permute.
-        
-        Args:
-            dims (list or tuple or bt.Tensor): The dimension permuation. 
-                size: length(n_dim) or ({n_batch:optional}, [n_dim]).
+    """
+    Permute the dimensions for an image, similar to np.transpose or torch/batorch.permute.
+    
+    Args:
+        dims (list or tuple or bt.Tensor): The dimension permuation. 
+            size: length(n_dim) or ({n_batch:optional}, [n_dim]).
 
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed coordinates.
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-        """
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates.
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+    """
+    
+    def __init__(self, *dims, resize_image=True, **kwargs):
         if len(dims) == 1: dims = dims[0]
         if isinstance(dims, tuple): dims = list(dims)
-        dims = bt.to_bttensor(dims).squeeze()
-        dims = dims.long()
-        if dims.n_dim <= 1: dims = dims.unsqueeze({})
-        if dims.n_dim == 2:
-            if not dims.has_batch: dims.batch_dimension = 0
-            if not dims.has_channel: dims.channel_dimension = 0 if dims.batch_dimension > 0 else 1
-        avouch(dims.has_batch and dims.has_channel, f"Please use batorch tensor of size \
-            ({{n_batch:optional}}, [n_dim]) for Translation parameters, instead of {dims.shape}. ")
+        dims = bt.to_bttensor(dims).squeeze().long()
+        bt.input_shape().set(dims = "({n_batch}, [n_dim])")
+        # if dims.n_dim <= 1: dims = dims.unsqueeze({})
+        # if dims.n_dim == 2:
+        #     if not dims.has_batch: dims.batch_dimension = 0
+        #     if not dims.has_channel: dims.channel_dimension = 0 if dims.batch_dimension > 0 else 1
+        # avouch(dims.has_batch and dims.has_channel, f"Please use batorch tensor of size \
+        #     ({{n_batch:optional}}, [n_dim]) for Translation parameters, instead of {dims.shape}. ")
         super().__init__(dims, resize_image=resize_image, **kwargs)
 
         self.dims = dims
         self.n_dim = dims.n_channel
         self.resize_image = resize_image
         if resize_image:
             if dims.n_batch > 1:
@@ -1338,43 +1358,45 @@
             ibatch = bt.arange({n_batch})
             perms[ibatch, idx] = i
             coeffs[ibatch, idx] = 0
         return perms
 
 @alias("Rescale")
 class Rescaling(Transformation):
+    """
+    Scale an image.
+    
+    Note: The scaling is for image coordinates, hence the image would shrink if scale > 1. 
+    
+    Args:
+        scale (float or tuple or bt.Tensor): The scaling for all dimensions (float) 
+            or for each dimension (tuple). >1 means enlarging the coordinates.
+            size: ({n_batch:optional}, [n_dim]) for bt.Tensor.
+        
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates.
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+    """
+    
     def __init__(self, *scale, resize_image=True, **kwargs):
-        """
-        Scale an image.
-        
-        Note: The scaling is for image coordinates, hence the image would shrink if scale > 1. 
-        
-        Args:
-            scale (float or tuple or bt.Tensor): The scaling for all dimensions (float) 
-                or for each dimension (tuple). >1 means enlarging the coordinates.
-                size: ({n_batch:optional}, [n_dim]) for bt.Tensor.
-            
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed coordinates.
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-        """
         if len(scale) == 1 and isinstance(scale[0], (int, float)): scale = scale[0] * bt.ones({1}, [1])
         else:
             if len(scale) == 1: scale = scale[0]
             if isinstance(scale, tuple): scale = list(scale)
             if not isinstance(scale, bt.Tensor): scale = bt.to_bttensor(scale).squeeze()
-            if scale.n_dim <= 1: scale = scale.unsqueeze({})
-            if scale.n_dim == 2:
-                if not scale.has_batch: scale.batch_dimension = 0
-                if not scale.has_channel: scale.channel_dimension = 0 if scale.batch_dimension > 0 else 1
-        avouch(scale.has_batch and scale.has_channel, f"Please use batorch tensor of size \
-            ({{n_batch:optional}}, [n_dim]) for Scaling parameters, instead of {scale.shape}. ")
-        bt.to_device(scale)
+            bt.input_shape().set(scale = "({n_batch}, [n_dim])")
+        #     if scale.n_dim <= 1: scale = scale.unsqueeze({})
+        #     if scale.n_dim == 2:
+        #         if not scale.has_batch: scale.batch_dimension = 0
+        #         if not scale.has_channel: scale.channel_dimension = 0 if scale.batch_dimension > 0 else 1
+        # avouch(scale.has_batch and scale.has_channel, f"Please use batorch tensor of size \
+        #     ({{n_batch:optional}}, [n_dim]) for Scaling parameters, instead of {scale.shape}. ")
+        # bt.to_device(scale)
         super().__init__(scale, resize_image=resize_image, **kwargs)
 
         self.scale = scale
         if self.scale.n_channel > 1: self.n_dim = self.scale.n_channel
         if resize_image:
             avouch((scale - scale[:1]).abs().sum() < eps, "The batch should have a common rescaler if 'resize_image=True', they are being reshaped uniformly.")
             self.reshape = [(0,), tuple((1/scale[0]).tolist())]
@@ -1405,39 +1427,42 @@
         return std * bt.randn([len(shape)]).duplicate(n_batch, {}) + 1,
 
 def rand_Rescaling(image, std=1e-1, **kwargs):
     return Rescaling(*Rescaling.random_init_params(*image.space, n_batch=image.n_batch, std=std), **kwargs)
 
 @alias("Translate")
 class Translation(Transformation):
-    def __init__(self, *translation, **kwargs):
-        """
-        Translate an image.
-        
-        Note: The translation is for coordinates, hence the image would go in the opposite direction. 
+    """
+    Translate an image.
+    
+    Note: The translation is for coordinates, hence the image would go in the opposite direction. 
+    
+    Args:
+        translation (tuple or bt.Tensor): The translation of the coordinates.
+            size: length(n_dim) or ({n_batch:optional}, [n_dim])
         
-        Args:
-            translation (tuple or bt.Tensor): The translation of the coordinates.
-                size: length(n_dim) or ({n_batch:optional}, [n_dim])
-            
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed coordinates.
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-        """
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch:optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates.
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+    """
+    
+    def __init__(self, *translation, **kwargs):
         if len(translation) == 1: translation = translation[0]
         if isinstance(translation, tuple): translation = list(translation)
         translation = bt.to_bttensor(translation).squeeze()
-        if translation.n_dim <= 1: translation = translation.unsqueeze({})
-        if translation.n_dim == 2:
-            if not translation.has_batch: translation.batch_dimension = 0
-            if not translation.has_channel: translation.channel_dimension = 0 if translation.batch_dimension > 0 else 1
-        avouch(translation.has_batch and translation.has_channel, f"Please use batorch tensor of size \
-            ({{n_batch:optional}}, [n_dim]) for Translation parameters, instead of {translation.shape}. ")
+        if translation.n_dim == 1: translation.channel_dim = 0
+        bt.input_shape().set(translation = "({n_batch}, [n_dim])")
+        # if translation.n_dim <= 1: translation = translation.unsqueeze({})
+        # if translation.n_dim == 2:
+        #     if not translation.has_batch: translation.batch_dimension = 0
+        #     if not translation.has_channel: translation.channel_dimension = 0 if translation.batch_dimension > 0 else 1
+        # avouch(translation.has_batch and translation.has_channel, f"Please use batorch tensor of size \
+        #     ({{n_batch:optional}}, [n_dim]) for Translation parameters, instead of {translation.shape}. ")
         super().__init__(translation, **kwargs)
 
         self.translation = translation
         self.n_dim = self.translation.n_channel
         self.batch_param.append('translation')
 
     def __call_image_space__(self, X):
@@ -1460,116 +1485,142 @@
         return std * bt.randn({n_batch}, [len(shape)]),
 
 def rand_Translation(image, std=5, **kwargs):
     return Translation(*Translation.random_init_params(*image.space, n_batch=image.n_batch, std=std), **kwargs)
 
 @alias("Rig")
 class Rigid(Transformation):
+    """
+    Rigid transformation with respect to parameters.
+    !!Attention: It's domain is 'physical-space' by default. 
+    
+    Args (usage 1):
+        angle (bt.Tensor or np.numpy): the [clockwise] rotation angles about the axises (or z direction for 2D). It is counter-clockwise for image.
+            size: ({n_batch},)
+        axis (bt.Tensor or np.numpy): the rotation axises, normalized vectors, None for 2D. 
+            size: ({n_batch}, [n_dim])
+        translation (bt.Tensor or np.numpy): the translations after the rotation, zeros by default. 
+            size: ({n_batch}, [n_dim])
+        center (bt.Tensor or np.numpy): the center for the rotations, zeros by default. 
+            size: ({n_batch}, [n_dim])
+        trans_stretch (float): scaling of translation movement, commonly needed in iterative parameter training, 1 by default. 5 seems to be a good choice. 
+    
+    Args (usage 2):
+        matrix (bt.Tensor or np.numpy): the affine matrix, it should be orthogonal or will be projected by Procrustes Problem. 
+            size: ({n_batch}, [n_dim + 1, n_dim + 1])
+        trans_stretch (float): scaling of translation movement, commonly needed in iterative parameter training, 1 by default. 5 seems to be a good choice. 
+        
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates.
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+    """
+    
     def __init__(self, angle, axis=None, translation=None, center=None, trans_stretch=None, **kwargs):
-        """
-        Rigid transformation with respect to parameters.
-        !!Attention: It's domain is 'physical-space' by default. 
-        
-        Args (usage 1):
-            angle (bt.Tensor or np.numpy): the [clockwise] rotation angles about the axises (or z direction for 2D). It is counter-clockwise for image.
-                size: ({n_batch},)
-            axis (bt.Tensor or np.numpy): the rotation axises, normalized vectors, None for 2D. 
-                size: ({n_batch}, [n_dim])
-            translation (bt.Tensor or np.numpy): the translations after the rotation, zeros by default. 
-                size: ({n_batch}, [n_dim])
-            center (bt.Tensor or np.numpy): the center for the rotations, zeros by default. 
-                size: ({n_batch}, [n_dim])
-            trans_stretch (float): scaling of translation movement, commonly needed in iterative parameter training, 1 by default. 5 seems to be a good choice. 
-        
-        Args (usage 2):
-            matrix (bt.Tensor or np.numpy): the affine matrix, it should be orthogonal or will be projected by Procrustes Problem. 
-                size: ({n_batch}, [n_dim + 1, n_dim + 1])
-            trans_stretch (float): scaling of translation movement, commonly needed in iterative parameter training, 1 by default. 5 seems to be a good choice. 
-            
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed coordinates.
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-        """
         angle = bt.to_bttensor(angle)
-        if angle.n_dim <= 0 and not angle.has_batch: angle = angle.unsqueeze({})
-        if angle.n_dim == 1 and not angle.has_batch: angle = angle.with_batchdim(0)
-        if angle.n_dim == 2 and not angle.has_batch: angle = angle.unsqueeze({})
-        if angle.n_dim == 3 and not angle.has_batch and angle.shape[1] == angle.shape[2]: angle.batch_dimension = 0
-        avouch(angle.has_batch, f"Please use batorch tensor of size ({{n_batch}},) for Rigid rotation angles, instead of {angle.shape}. ")
-        n_batch = angle.n_batch
-        n_dim = None
-        if angle.n_dim >= 2:
+        bt.input_shape().usage(
+            angle = "({n_batch},)", 
+            axis = "({n_batch}, [n_dim]) [optional]", 
+            translation = "({n_batch}, [n_dim])", 
+            center = "({n_batch}, [n_dim])"
+        ).usage(angle = "({n_batch}, [n_dim + 1, n_dim + 1])")
+        if usage == 2:
             matrix = angle
-            n_dim = matrix.size(-1) - 1
             center = bt.zeros({n_batch}, [n_dim])
             translation = matrix[..., :-1, -1].with_channeldim(1)
             A = matrix[..., :-1, :-1]
             avouch(bt.norm(A.T @ A - bt.eye(A)).sum() < 1e-4, "Please make sure that matrix input for Rigid is orthogonal. Use Affine instead if it is not. ")
-            # I = bt.eye(A)
-            # Z_left = (A - I)[..., :-1] # ({n_batch}, n_dim, n_dim-1)
-            # Z_right = (A - I)[..., -1] # ({n_batch}, n_dim)
-            # ZTZ = Z_left.T @ Z_left
-            # if n_dim == 2:
-            #     axis = None
-            #     angle = bt.where(bt.abs(bt.det(ZTZ)) < 1e-6, bt.zeros({n_batch}), bt.acos(1 - ZTZ / 2).squeeze(-1, -1))
-            # elif n_dim == 3:
-            #     invZTZ = bt.inv(bt.where(bt.abs(bt.det(ZTZ)).unsqueeze(-1, -1) < 1e-6, bt.eye(ZTZ), ZTZ))
-            #     vector = bt.cat(- invZTZ @ Z_left.T @ Z_right, bt.ones({n_batch}, 1), 1).with_channeldim(1)
-            #     angle = bt.where(bt.abs(bt.det(ZTZ)) < 1e-6, bt.zeros({n_batch}), vector.norm())
-            #     axis = bt.where((bt.abs(bt.det(ZTZ)) < 1e-6).duplicate(n_dim, []), bt.channel_tensor(bt.one_hot(0, n_dim)).duplicate(n_batch, {}), vector / angle)
             if n_dim == 2:
                 axis = None
                 angle = bt.acos(A[..., 0, 0]) * bt.sign(A[..., 0, 1])
             elif n_dim == 3:
                 anti_sym = (A - A.T) / 2
                 sym = (A + A.T) / 2 - bt.eye(A)
                 angle = bt.acos(((anti_sym @ anti_sym) / sym).mean() - 1)
                 axis = bt.uncross_matrix(anti_sym)
                 axis /= bt.sin(angle)
             else:
                 raise Error("NotImplemented")(f"Rigid transformation in micomputing does not support [n_dim] dimensional transforms (2 & 3D only). " + 
                                             "Please contact the developers if there are feasible algorithms (Error Code: T333). Thank you. ")
-
-        if translation is not None:
-            translation = bt.to_bttensor(translation)
-            if translation.n_dim <= 1 and not translation.has_batch: translation = translation.unsqueeze({})
-            if translation.n_dim == 2 and not translation.has_batch: translation = translation.with_batchdim((1 - translation.channel_dimension) if translation.has_channel else 0)
-            if translation.n_dim == 2 and not translation.has_channel: translation = translation.with_channeldim(1 - translation.batch_dimension)
-            avouch(translation.has_batch and translation.has_channel, f"Please use batorch tensor of size ({{n_batch}}, [n_dim]) for Rigid translation, instead of {translation.shape}. ")
-            if n_batch == 1 and translation.n_batch > 1: n_batch = translation.n_batch
-            if n_dim is None: n_dim = translation.n_channel
-            else: avouch(n_dim == translation.n_channel, "Systematic error. Please contact the developers for details (Error Code: T332). ")
-            n_dim = translation.n_channel
-        if center is not None:
-            center = bt.to_bttensor(center)
-            if center.n_dim <= 1 and not center.has_batch: center = center.unsqueeze({})
-            if center.n_dim == 2 and not center.has_batch: center = center.with_batchdim((1 - center.channel_dimension) if center.has_channel else 0)
-            if center.n_dim == 2 and not center.has_channel: center = center.with_channeldim(1 - center.batch_dimension)
-            avouch(center.has_batch and center.has_channel, f"Please use batorch tensor of size ({{n_batch}}, [n_dim]) for Rigid center, instead of {center.shape}. ")
-            if n_batch == 1 and center.n_batch > 1: n_batch = center.n_batch
-            if n_dim is None: n_dim = center.n_channel
-            else: avouch(n_dim == center.n_channel, f"Center({center.n_channel}D) and translation([n_dim]D) in trans.Rigid should have the same dimension. ")
-            n_dim = center.n_channel
-        if axis is not None:
-            axis = bt.to_bttensor(axis)
-            if axis.n_dim <= 1 and not axis.has_batch: axis = axis.unsqueeze({})
-            if axis.n_dim == 2 and not axis.has_batch: axis = axis.with_batchdim((1 - axis.channel_dimension) if axis.has_channel else 0)
-            if axis.n_dim == 2 and not axis.has_channel: axis = axis.with_channeldim(1 - axis.batch_dimension)
-            avouch(axis.has_batch and axis.has_channel, f"Please use batorch tensor of size ({{n_batch}}, [n_dim]) for Rigid axises, instead of {axis.shape}. ")
-            if ((axis.norm() - 1) ** 2).sum().sum() >= 1e-2:
-                print("warning: param. axises for 'Rigid' transformation should be norm-1 vectors, auto-normalization would be performed. Please contact the developers if it is necessary to be non-unit vectors (Error Code: T331). ")
-                axis = axis / axis.norm()
-            if n_batch == 1 and axis.n_batch > 1: n_batch = axis.n_batch
-            if n_dim is None: n_dim = axis.n_channel
-            else: avouch(n_dim == axis.n_channel, f"Translation({n_dim}D) and axises({axis.n_channel}D)) in trans.Rigid should have the same dimension. ")
-        if n_dim is None: n_dim = 2 if axis is None else 3
-        if translation is None: translation = bt.zeros({n_batch}, [n_dim])
-        if center is None: center = bt.zeros({n_batch}, [n_dim])
+        
+        # if angle.n_dim <= 0 and not angle.has_batch: angle = angle.unsqueeze({})
+        # if angle.n_dim == 1 and not angle.has_batch: angle = angle.with_batchdim(0)
+        # if angle.n_dim == 2 and not angle.has_batch: angle = angle.unsqueeze({})
+        # if angle.n_dim == 3 and not angle.has_batch and angle.shape[1] == angle.shape[2]: angle.batch_dimension = 0
+        # avouch(angle.has_batch, f"Please use batorch tensor of size ({{n_batch}},) for Rigid rotation angles, instead of {angle.shape}. ")
+        # n_batch = angle.n_batch
+        # n_dim = None
+        # if angle.n_dim >= 2:
+        #     matrix = angle
+        #     n_dim = matrix.size(-1) - 1
+        #     center = bt.zeros({n_batch}, [n_dim])
+        #     translation = matrix[..., :-1, -1].with_channeldim(1)
+        #     A = matrix[..., :-1, :-1]
+        #     avouch(bt.norm(A.T @ A - bt.eye(A)).sum() < 1e-4, "Please make sure that matrix input for Rigid is orthogonal. Use Affine instead if it is not. ")
+        #     # I = bt.eye(A)
+        #     # Z_left = (A - I)[..., :-1] # ({n_batch}, n_dim, n_dim-1)
+        #     # Z_right = (A - I)[..., -1] # ({n_batch}, n_dim)
+        #     # ZTZ = Z_left.T @ Z_left
+        #     # if n_dim == 2:
+        #     #     axis = None
+        #     #     angle = bt.where(bt.abs(bt.det(ZTZ)) < 1e-6, bt.zeros({n_batch}), bt.acos(1 - ZTZ / 2).squeeze(-1, -1))
+        #     # elif n_dim == 3:
+        #     #     invZTZ = bt.inv(bt.where(bt.abs(bt.det(ZTZ)).unsqueeze(-1, -1) < 1e-6, bt.eye(ZTZ), ZTZ))
+        #     #     vector = bt.cat(- invZTZ @ Z_left.T @ Z_right, bt.ones({n_batch}, 1), 1).with_channeldim(1)
+        #     #     angle = bt.where(bt.abs(bt.det(ZTZ)) < 1e-6, bt.zeros({n_batch}), vector.norm())
+        #     #     axis = bt.where((bt.abs(bt.det(ZTZ)) < 1e-6).duplicate(n_dim, []), bt.channel_tensor(bt.one_hot(0, n_dim)).duplicate(n_batch, {}), vector / angle)
+        #     if n_dim == 2:
+        #         axis = None
+        #         angle = bt.acos(A[..., 0, 0]) * bt.sign(A[..., 0, 1])
+        #     elif n_dim == 3:
+        #         anti_sym = (A - A.T) / 2
+        #         sym = (A + A.T) / 2 - bt.eye(A)
+        #         angle = bt.acos(((anti_sym @ anti_sym) / sym).mean() - 1)
+        #         axis = bt.uncross_matrix(anti_sym)
+        #         axis /= bt.sin(angle)
+        #     else:
+        #         raise Error("NotImplemented")(f"Rigid transformation in micomputing does not support [n_dim] dimensional transforms (2 & 3D only). " + 
+        #                                     "Please contact the developers if there are feasible algorithms (Error Code: T333). Thank you. ")
+
+        # if translation is not None:
+        #     translation = bt.to_bttensor(translation)
+        #     if translation.n_dim <= 1 and not translation.has_batch: translation = translation.unsqueeze({})
+        #     if translation.n_dim == 2 and not translation.has_batch: translation = translation.with_batchdim((1 - translation.channel_dimension) if translation.has_channel else 0)
+        #     if translation.n_dim == 2 and not translation.has_channel: translation = translation.with_channeldim(1 - translation.batch_dimension)
+        #     avouch(translation.has_batch and translation.has_channel, f"Please use batorch tensor of size ({{n_batch}}, [n_dim]) for Rigid translation, instead of {translation.shape}. ")
+        #     if n_batch == 1 and translation.n_batch > 1: n_batch = translation.n_batch
+        #     if n_dim is None: n_dim = translation.n_channel
+        #     else: avouch(n_dim == translation.n_channel, "Systematic error. Please contact the developers for details (Error Code: T332). ")
+        #     n_dim = translation.n_channel
+        # if center is not None:
+        #     center = bt.to_bttensor(center)
+        #     if center.n_dim <= 1 and not center.has_batch: center = center.unsqueeze({})
+        #     if center.n_dim == 2 and not center.has_batch: center = center.with_batchdim((1 - center.channel_dimension) if center.has_channel else 0)
+        #     if center.n_dim == 2 and not center.has_channel: center = center.with_channeldim(1 - center.batch_dimension)
+        #     avouch(center.has_batch and center.has_channel, f"Please use batorch tensor of size ({{n_batch}}, [n_dim]) for Rigid center, instead of {center.shape}. ")
+        #     if n_batch == 1 and center.n_batch > 1: n_batch = center.n_batch
+        #     if n_dim is None: n_dim = center.n_channel
+        #     else: avouch(n_dim == center.n_channel, f"Center({center.n_channel}D) and translation([n_dim]D) in trans.Rigid should have the same dimension. ")
+        #     n_dim = center.n_channel
+        # if axis is not None:
+        #     axis = bt.to_bttensor(axis)
+        #     if axis.n_dim <= 1 and not axis.has_batch: axis = axis.unsqueeze({})
+        #     if axis.n_dim == 2 and not axis.has_batch: axis = axis.with_batchdim((1 - axis.channel_dimension) if axis.has_channel else 0)
+        #     if axis.n_dim == 2 and not axis.has_channel: axis = axis.with_channeldim(1 - axis.batch_dimension)
+        #     avouch(axis.has_batch and axis.has_channel, f"Please use batorch tensor of size ({{n_batch}}, [n_dim]) for Rigid axises, instead of {axis.shape}. ")
+        #     if ((axis.norm() - 1) ** 2).sum().sum() >= 1e-2:
+        #         print("warning: param. axises for 'Rigid' transformation should be norm-1 vectors, auto-normalization would be performed. Please contact the developers if it is necessary to be non-unit vectors (Error Code: T331). ")
+        #         axis = axis / axis.norm()
+        #     if n_batch == 1 and axis.n_batch > 1: n_batch = axis.n_batch
+        #     if n_dim is None: n_dim = axis.n_channel
+        #     else: avouch(n_dim == axis.n_channel, f"Translation({n_dim}D) and axises({axis.n_channel}D)) in trans.Rigid should have the same dimension. ")
+        # if n_dim is None: n_dim = 2 if axis is None else 3
+        # if translation is None: translation = bt.zeros({n_batch}, [n_dim])
+        # if center is None: center = bt.zeros({n_batch}, [n_dim])
         
         # Now we create the matrix
         angle = angle.float()
         center = center.float()
         translation = translation.float()
         if n_dim == 2:
             A = bt.stack(bt.cos(angle), bt.sin(angle), -bt.sin(angle), bt.cos(angle), -1).splitdim(-1, [2, 2])
@@ -1627,41 +1678,37 @@
 
 @alias("rand_Rig")
 def rand_Rigidity(image, std=1e-1, trans_std=5, **kwargs):
     return Rigid(*Rigid.random_init_params(*image.space, n_batch=image.n_batch, std=std, trans_std=trans_std), **kwargs)
 
 @alias("Aff")
 class Affine(Transformation):
+    """
+    Affine transformation with respect to transformation matrix.
+    
+    Args:
+        matrix (bt.Tensor or np.numpy): the affine matrix. 
+            size: ({n_batch}, [n_dim + 1, n_dim + 1])
+        trans_stretch (float): scaling of translation movement, commonly needed in iterative parameter training, 1 by default. 5 seems to be a good choice. 
+        domain (str: 'image-space'|'physical-space'): the coordinate domain that the transformation is in. 
+        
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates.
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+    """
+    
     def __init__(self, matrix, trans_stretch=None, **kwargs):
-        """
-        Affine transformation with respect to transformation matrix.
-        
-        Args:
-            matrix (bt.Tensor or np.numpy): the affine matrix. 
-                size: ({n_batch}, [n_dim + 1, n_dim + 1])
-            trans_stretch (float): scaling of translation movement, commonly needed in iterative parameter training, 1 by default. 5 seems to be a good choice. 
-            domain (str: 'image-space'|'physical-space'): the coordinate domain that the transformation is in. 
-            
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed coordinates.
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-        """
         matrix = bt.to_bttensor(matrix)
-        n_dim = matrix.size(-1) - 1
-        if matrix.n_dim <= 2: matrix = matrix.unsqueeze({})
-        if not matrix.has_batch: matrix.with_batchdim(0)
-        if matrix.n_dim == 3: matrix.with_n_feature_dim(2)
-        avouch(matrix.n_dim == 3 and matrix.has_batch and matrix.n_feature_dim == 2,
-               f"Please use batorch tensor of size ({{n_batch}}, [n_dim + 1, n_dim + 1]) for Affine parameters, instead of {matrix.shape}. ")
+        bt.input_shape().set(matrix = "({n_batch}, [n_dim + 1, n_dim + 1])")
         if trans_stretch is not None: matrix[..., :n_dim, -1] *= trans_stretch
         super().__init__(matrix, trans_stretch=trans_stretch, **kwargs)
 
-        self.n_dim = matrix.size(-1) - 1
+        self.n_dim = n_dim
         self.trans_stretch = trans_stretch
         self.matrix = matrix
         self.batch_param.append('matrix')
 
     def __call_image_space__(self, X):
         matrix = self.matrix.float()
         n_dim = self.n_dim
@@ -1695,55 +1742,61 @@
 
 @alias("rand_Aff")
 def rand_Affinity(image, std=1e-1, trans_std=5, **kwargs):
     return Affine(*Affine.random_init_params(*image.space, n_batch=image.n_batch, std=std, trans_std=trans_std), **kwargs)
 
 @alias("logEu", "logEuclidean")
 class PolyAffine(Transformation):
-    def __init__(self, dmatrices, masks, order=2, level=4, is_inv=False, trans_stretch=None, **kwargs):
-        """
-        Poly affine transformation with respect to transformation matrices [1].
-        Note that dmatrices for this tranformation IS NOT the actual affine matrices, but IS a differentiation instead.
-        
-        Args:
-            dmatrices (bt.Tensor or np.numpy): One affine matrix for each region. 
-                size: ({n_batch}, [n_region], [n_dim + 1, n_dim + 1])
-            masks (bt.Tensor or np.numpy): One 0-1 mask for each region. 
-                size: ({n_batch}, [n_region], n_1, n_2, ..., n_r) [r=n_dim]
-            order (int): the order of interpolation coefficient. The influence of an affine decays at a rate of 1 / distance. Defaults to 2. 
-            level (int): the level of velocity integration. The dmatrix is regarded as 1 / 2 of true matrix. Defaults to 4. 
-            trans_stretch (float): scaling of translation movement, commonly needed in iterative parameter training, 1 by default. 5 seems to be a good choice. 
-            
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed coordinates.
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+    """
+    Poly affine transformation with respect to transformation matrices [1].
+    Note that dmatrices for this tranformation IS NOT the actual affine matrices, but IS a differentiation instead.
+    
+    Args:
+        dmatrices (bt.Tensor or np.numpy): One affine matrix for each region. 
+            size: ({n_batch}, [n_region], [n_dim + 1, n_dim + 1])
+        masks (bt.Tensor or np.numpy): One 0-1 mask for each region. 
+            size: ({n_batch}, [n_region], n_1, n_2, ..., n_r) [r=n_dim]
+        order (int): the order of interpolation coefficient. The influence of an affine decays at a rate of 1 / distance. Defaults to 2. 
+        level (int): the level of velocity integration. The dmatrix is regarded as 1 / 2 of true matrix. Defaults to 4. 
+        trans_stretch (float): scaling of translation movement, commonly needed in iterative parameter training, 1 by default. 5 seems to be a good choice. 
+        
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates.
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
 
-        [1] Arsigny V , Commowick O , Ayache N , et al. A Fast and Log-Euclidean Polyaffine Framework for Locally 
-            Linear Registration[J]. Journal of Mathematical Imaging & Vision, 2009, 33(2):222-238.
-        """
+    [1] Arsigny V , Commowick O , Ayache N , et al. A Fast and Log-Euclidean Polyaffine Framework for Locally 
+        Linear Registration[J]. Journal of Mathematical Imaging & Vision, 2009, 33(2):222-238.
+    """
+    
+    def __init__(self, dmatrices, masks, order=2, level=4, is_inv=False, trans_stretch=None, **kwargs):
         from .funcs import distance_map
         dmatrices = bt.to_bttensor(dmatrices)
-        if dmatrices.n_dim <= 3 and not dmatrices.has_batch: dmatrices = dmatrices.unsqueeze({})
-        if dmatrices.n_feature_dim < 3 and not dmatrices.has_feature: dmatrices = dmatrices.unsqueeze([1])
-        if dmatrices.n_dim == 4 and dmatrices.shape[2] == dmatrices.shape[3]:
-            if not dmatrices.has_batch: dmatrices.batch_dimension = 0
-            if not dmatrices.has_feature: dmatrices.n_feature_dim = 3
-        avouch(dmatrices.has_batch and dmatrices.n_feature_dim == 3, "Please use batorch tensor of size ({n_batch}, [n_region]," +
-               f"[n_dim + 1, n_dim + 1]) for PolyAffine parameters, instead of {dmatrices.shape}. ")
-        n_dim = dmatrices.size(-1) - 1
-        if trans_stretch is not None: dmatrices[..., :n_dim, -1] *= trans_stretch
-        masks = bt.to_bttensor(masks)
-        if masks.n_dim <= n_dim + 1 and not masks.has_batch: masks = masks.unsqueeze({})
-        if masks.n_dim <= n_dim + 1 and not masks.has_channel: masks = masks.unsqueeze([])
-        if masks.n_dim == n_dim + 2 and not masks.has_batch: masks.batch_dimension = 0
-        if masks.n_dim == n_dim + 2 and not masks.has_channel: masks.channel_dimension = 1
-        avouch(masks.has_batch and masks.has_channel, "Please use batorch tensor of size ({n_batch}, [n_region]," +
-               f"n_1, n_2, ..., n_r) [r=n_dim] for PolyAffine parameters, instead of {masks.shape}. ")
+        masks = bt.to_bttensor(masks).int()
+        bt.input_shape().set(
+            dmatrices = "({n_batch}, [n_region], [n_dim + 1, n_dim + 1])", 
+            masks = "({n_batch}, [n_region], n_1, ..., n_r) [r=n_dim]"
+        )
+        # if dmatrices.n_dim <= 3 and not dmatrices.has_batch: dmatrices = dmatrices.unsqueeze({})
+        # if dmatrices.n_feature_dim < 3 and not dmatrices.has_feature: dmatrices = dmatrices.unsqueeze([1])
+        # if dmatrices.n_dim == 4 and dmatrices.shape[2] == dmatrices.shape[3]:
+        #     if not dmatrices.has_batch: dmatrices.batch_dimension = 0
+        #     if not dmatrices.has_feature: dmatrices.n_feature_dim = 3
+        # avouch(dmatrices.has_batch and dmatrices.n_feature_dim == 3, "Please use batorch tensor of size ({n_batch}, [n_region]," +
+        #        f"[n_dim + 1, n_dim + 1]) for PolyAffine parameters, instead of {dmatrices.shape}. ")
+        # n_dim = dmatrices.size(-1) - 1
+        # if trans_stretch is not None: dmatrices[..., :n_dim, -1] *= trans_stretch
+        # masks = bt.to_bttensor(masks)
+        # if masks.n_dim <= n_dim + 1 and not masks.has_batch: masks = masks.unsqueeze({})
+        # if masks.n_dim <= n_dim + 1 and not masks.has_channel: masks = masks.unsqueeze([])
+        # if masks.n_dim == n_dim + 2 and not masks.has_batch: masks.batch_dimension = 0
+        # if masks.n_dim == n_dim + 2 and not masks.has_channel: masks.channel_dimension = 1
+        # avouch(masks.has_batch and masks.has_channel, "Please use batorch tensor of size ({n_batch}, [n_region]," +
+        #        f"n_1, n_2, ..., n_r) [r=n_dim] for PolyAffine parameters, instead of {masks.shape}. ")
 
         # preprocess masks ({n_batch}, [n_region], n_1, n_2, ..., n_r) [r=n_dim]
         n_batch = masks.n_batch
         n_region = masks.n_channel
         dis = distance_map(masks)
         dis = (dis + 1).clamp(0)
         # import micomputing.plot as plt
@@ -1833,53 +1886,59 @@
         
 @alias("rand_logEu", "rand_logEuclidean")
 def rand_PolyAffine(image, n_region=3, std=1e-2, trans_std=1, **kwargs):
     return PolyAffine(*PolyAffine.random_init_params(*image.space, n_batch=image.n_batch, n_region=n_region, std=std, trans_std=trans_std), **kwargs)
 
 @alias("LARM")
 class LocallyAffine(Transformation):
-    def __init__(self, matrices, masks, order=2, trans_stretch=None, avoid_conflict=True, **kwargs):
-        """
-        Locally affine transformation with respect to transformation matrices [1].
-        
-        Args:
-            matrices (bt.Tensor or np.numpy): One affine matrix for each region. 
-                size: ({n_batch}, [n_region], [n_dim + 1, n_dim + 1])
-            masks (bt.Tensor or np.numpy): One 0-1 mask for each region. 
-                size: ({n_batch}, [n_region], n_1, n_2, ..., n_r) [r=n_dim]
-            order (int): the order of interpolation coefficient. The influence of an affine decays at a rate of 1 / distance^order.
-            trans_stretch (float): scaling of translation movement, commonly needed in iterative parameter training, 1 by default. 5 seems to be a good choice. 
-            
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed coordinates.
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+    """
+    Locally affine transformation with respect to transformation matrices [1].
+    
+    Args:
+        matrices (bt.Tensor or np.numpy): One affine matrix for each region. 
+            size: ({n_batch}, [n_region], [n_dim + 1, n_dim + 1])
+        masks (bt.Tensor or np.numpy): One 0-1 mask for each region. 
+            size: ({n_batch}, [n_region], n_1, n_2, ..., n_r) [r=n_dim]
+        order (int): the order of interpolation coefficient. The influence of an affine decays at a rate of 1 / distance^order.
+        trans_stretch (float): scaling of translation movement, commonly needed in iterative parameter training, 1 by default. 5 seems to be a good choice. 
+        
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates.
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
 
-        [1] Zhuang X , Rhode K , Arridge S , et al. An Atlas-Based Segmentation Propagation Framework Using Locally Affine 
-            Registration - Application to Automatic Whole Heart Segmentation[J]. Springer, Berlin, Heidelberg, 2008.
-        """
+    [1] Zhuang X , Rhode K , Arridge S , et al. An Atlas-Based Segmentation Propagation Framework Using Locally Affine 
+        Registration - Application to Automatic Whole Heart Segmentation[J]. Springer, Berlin, Heidelberg, 2008.
+    """
+    
+    def __init__(self, matrices, masks, order=2, trans_stretch=None, avoid_conflict=True, **kwargs):
         from .funcs import dilate, distance_map
         matrices = bt.to_bttensor(matrices)
-        if matrices.n_dim <= 3 and not matrices.has_batch: matrices = matrices.unsqueeze({})
-        if matrices.n_dim <= 3 and not matrices.has_channel: matrices = matrices.unsqueeze([1])
-        if matrices.n_dim == 4 and matrices.shape[2] == matrices.shape[3]:
-            if not matrices.has_batch: matrices.batch_dimension = 0
-            if not matrices.has_feature: matrices.n_feature_dim = 3
-        avouch(matrices.has_batch and matrices.n_feature_dim == 3, "Please use batorch tensor of size ({n_batch}, [n_region]," +
-               f"[n_dim + 1, n_dim + 1]) for LocallyAffine parameters, instead of {matrices.shape}. ")
-        n_dim = matrices.size(-1) - 1
-        if trans_stretch is not None: matrices[..., :n_dim, -1] *= trans_stretch
         masks = bt.to_bttensor(masks).int()
-        if masks.n_dim <= n_dim + 1 and not masks.has_batch: masks = masks.unsqueeze({})
-        if masks.n_dim <= n_dim + 1 and not masks.has_channel: masks = masks.unsqueeze([])
-        if masks.n_dim == n_dim + 2 and not masks.has_batch: masks.batch_dimension = 0
-        if masks.n_dim == n_dim + 2 and not masks.has_channel: masks.channel_dimension = 1
-        avouch(masks.has_batch and masks.has_channel, "Please use batorch tensor of size ({n_batch}, [n_region]," + 
-               f"n_1, n_2, ..., n_r) [r=n_dim] for LocallyAffine parameters, instead of {masks.shape}. ")
+        bt.input_shape().set(
+            matrices = "({n_batch}, [n_region], [n_dim + 1, n_dim + 1])", 
+            masks = "({n_batch}, [n_region], n_1, ..., n_r) [r=n_dim]"
+        )
+        # if matrices.n_dim <= 3 and not matrices.has_batch: matrices = matrices.unsqueeze({})
+        # if matrices.n_dim <= 3 and not matrices.has_channel: matrices = matrices.unsqueeze([1])
+        # if matrices.n_dim == 4 and matrices.shape[2] == matrices.shape[3]:
+        #     if not matrices.has_batch: matrices.batch_dimension = 0
+        #     if not matrices.has_feature: matrices.n_feature_dim = 3
+        # avouch(matrices.has_batch and matrices.n_feature_dim == 3, "Please use batorch tensor of size ({n_batch}, [n_region]," +
+        #        f"[n_dim + 1, n_dim + 1]) for LocallyAffine parameters, instead of {matrices.shape}. ")
+        # n_dim = matrices.size(-1) - 1
+        # if trans_stretch is not None: matrices[..., :n_dim, -1] *= trans_stretch
+        # masks = bt.to_bttensor(masks).int()
+        # if masks.n_dim <= n_dim + 1 and not masks.has_batch: masks = masks.unsqueeze({})
+        # if masks.n_dim <= n_dim + 1 and not masks.has_channel: masks = masks.unsqueeze([])
+        # if masks.n_dim == n_dim + 2 and not masks.has_batch: masks.batch_dimension = 0
+        # if masks.n_dim == n_dim + 2 and not masks.has_channel: masks.channel_dimension = 1
+        # avouch(masks.has_batch and masks.has_channel, "Please use batorch tensor of size ({n_batch}, [n_region]," + 
+        #        f"n_1, n_2, ..., n_r) [r=n_dim] for LocallyAffine parameters, instead of {masks.shape}. ")
 
         # preprocess masks
         n_batch = matrices.n_batch
         n_region = matrices.size(1)
         if avoid_conflict:
             Gi = Affine(matrices.mergedims([0], {}))
             GiVi = interpolation(masks.mergedims([], {}), Gi.inv(), method='Nearest').splitdim({}, {n_batch}, [n_region]) # ({n_batch}, [n_region], n_1, n_2, ..., n_r) [r=n_dim]
@@ -1958,52 +2017,53 @@
     
 @alias("rand_LARM")
 def rand_LocallyAffine(image, n_region=3, std=1e-1, trans_std=5, **kwargs):
     return LocallyAffine(*LocallyAffine.random_init_params(*image.space, n_batch=image.n_batch, n_region=n_region, std=std, trans_std=trans_std), **kwargs)
 
 @alias("FFD")
 class FreeFormDeformation(Transformation):
+    """
+    Free Form Deformation (FFD) transformation [1].
+    
+    Args:
+        offsets (bt.Tensor): the FFD offsets. 
+            size: ({n_batch}, [n_dim], m_1, m_2, ..., m_r) [r=n_dim]
+            for m_1 x m_2 x ... x m_r grid of control points
+        spacing (int or tuple): FFD spacing; spacing between FFD control points, in px. Defaults to 1px. 
+        origin (int or tuple): FFD origin; coordinate for the (0, 0, 0) control point. Defaults to (0, 0, 0). 
+        
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates.
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+            
+    [1] Rueckert D , Sonoda L I , Hayes C , et al. Nonrigid registration using free-form deformations: 
+        application to breast MR images[J]. IEEE Transactions on Medical Imaging, 1999(8).
+    """
 
     def __init__(self, offsets, spacing=1, origin=0, **kwargs):
-        """
-        Free Form Deformation (FFD) transformation [1].
-        
-        Args:
-            offsets (bt.Tensor): the FFD offsets. 
-                size: ({n_batch}, [n_dim], m_1, m_2, ..., m_r) [r=n_dim]
-                for m_1 x m_2 x ... x m_r grid of control points
-            spacing (int or tuple): FFD spacing; spacing between FFD control points, in px. Defaults to 1px. 
-            origin (int or tuple): FFD origin; coordinate for the (0, 0, 0) control point. Defaults to (0, 0, 0). 
-            
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed coordinates.
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-                
-        [1] Rueckert D , Sonoda L I , Hayes C , et al. Nonrigid registration using free-form deformations: 
-            application to breast MR images[J]. IEEE Transactions on Medical Imaging, 1999(8).
-        """
         offsets = bt.to_bttensor(offsets)
-        if not offsets.has_channel:
-            if offsets.size(0) == offsets.n_dim - 1:
-                n_dim = offsets.size(0)
-                offsets.channel_dimension = 0
-                offsets = offsets.unsqueeze({})
-            elif offsets.size(1) == offsets.n_dim - 2:
-                n_dim = offsets.size(1)
-                offsets.channel_dimension = 1
-            else: raise TypeError(f"FFD parameters with size {offsets.shape} donot match ({{n_batch}}, [n_dim], m_1, m_2, ..., m_r) [r=n_dim]. ")
-        if not offsets.has_batch:
-            n_dim = offsets.n_channel
-            if offsets.n_dim <= n_dim + 1: offsets = offsets.unsqueeze({})
-            else: offsets.batch_dimension = 0
-        avouch(offsets.has_batch and offsets.has_channel, f"Please use batorch tensor of size \
-            ({{n_batch}}, [n_dim], m_1, m_2, ..., m_r) [r=n_dim] for FFD parameters, instead of {offsets.shape}. ")
-        n_dim = offsets.n_channel
+        bt.input_shape().set(offsets = "({n_batch}, [n_dim], m_1, ..., m_r) [r=n_dim]")
+        # if not offsets.has_channel:
+        #     if offsets.size(0) == offsets.n_dim - 1:
+        #         n_dim = offsets.size(0)
+        #         offsets.channel_dimension = 0
+        #         offsets = offsets.unsqueeze({})
+        #     elif offsets.size(1) == offsets.n_dim - 2:
+        #         n_dim = offsets.size(1)
+        #         offsets.channel_dimension = 1
+        #     else: raise TypeError(f"FFD parameters with size {offsets.shape} donot match ({{n_batch}}, [n_dim], m_1, m_2, ..., m_r) [r=n_dim]. ")
+        # if not offsets.has_batch:
+        #     n_dim = offsets.n_channel
+        #     if offsets.n_dim <= n_dim + 1: offsets = offsets.unsqueeze({})
+        #     else: offsets.batch_dimension = 0
+        # avouch(offsets.has_batch and offsets.has_channel, f"Please use batorch tensor of size \
+        #     ({{n_batch}}, [n_dim], m_1, m_2, ..., m_r) [r=n_dim] for FFD parameters, instead of {offsets.shape}. ")
+        # n_dim = offsets.n_channel
         spacing = to_tuple(spacing)
         origin = to_tuple(origin)
         if len(spacing) == 1: spacing *= n_dim
         if len(origin) == 1: origin *= n_dim
         super().__init__(offsets, spacing=spacing, origin=origin, **kwargs)
 
         self.n_dim = n_dim
@@ -2075,48 +2135,50 @@
 @alias("rand_FFD")
 def rand_FreeFormDeformation(image, spacing=None, std=10, **kwargs):
     if spacing is None: spacing = 1 << (int(math.log2(min(image.space))) - 3)
     return FreeFormDeformation(*FreeFormDeformation.random_init_params(*image.space, spacing=spacing, n_batch=image.n_batch, std=std), spacing=spacing, **kwargs)
 
 @alias("DDF")
 class DenseDisplacementField(Transformation):
+    """
+    Dense Displacement Field (DDF) transformation.
+    
+    Args:
+        displacements (bt.Tensor): the displacement of each voxel (or pixel). 
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        shape (bt.Size or tuple): the shape of displacement (needed if input displacement is a transformation). 
+        interpolate (bool): Whether to force interpolation in apply. 
+
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates.
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+    """
+    
     def __init__(self, displacements, shape=None, interpolate=False, **kwargs):
-        """
-        Dense Displacement Field (DDF) transformation.
-        
-        Args:
-            displacements (bt.Tensor): the displacement of each voxel (or pixel). 
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            shape (bt.Size or tuple): the shape of displacement (needed if input displacement is a transformation). 
-            interpolate (bool): Whether to force interpolation in apply. 
-
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed coordinates.
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-        """
         if isinstance(displacements, Transformation): displacements = displacements.toDDF(shape)
-        displacements = bt.to_bttensor(displacements)
-        if not displacements.has_channel:
-            if displacements.size(0) == displacements.n_dim - 1:
-                n_dim = displacements.size(0)
-                displacements.channel_dimension = 0
-                displacements = displacements.unsqueeze({})
-            elif displacements.size(1) == displacements.n_dim - 2:
-                n_dim = displacements.size(1)
-                displacements.channel_dimension = 1
-            else: raise TypeError(f"DDF parameters with size {displacements.shape} donot match ({{n_batch}}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]. ")
-        if not displacements.has_batch:
-            n_dim = displacements.n_channel
-            if displacements.n_dim <= n_dim + 1: displacements = displacements.unsqueeze({})
-            else: displacements.batch_dimension = 0
-        displacements = displacements.float()
-        avouch(displacements.has_batch and displacements.has_channel, f"Please use batorch tensor of size \
-            ({{n_batch}}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim] for DDF parameters, instead of {displacements.shape}. ")
+        displacements = bt.to_bttensor(displacements).float()
+        bt.input_shape().set(displacements = "({n_batch}, [n_dim], n_1, ..., n_r) [r=n_dim]")
+        # if not displacements.has_channel:
+        #     if displacements.size(0) == displacements.n_dim - 1:
+        #         n_dim = displacements.size(0)
+        #         displacements.channel_dimension = 0
+        #         displacements = displacements.unsqueeze({})
+        #     elif displacements.size(1) == displacements.n_dim - 2:
+        #         n_dim = displacements.size(1)
+        #         displacements.channel_dimension = 1
+        #     else: raise TypeError(f"DDF parameters with size {displacements.shape} donot match ({{n_batch}}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]. ")
+        # if not displacements.has_batch:
+        #     n_dim = displacements.n_channel
+        #     if displacements.n_dim <= n_dim + 1: displacements = displacements.unsqueeze({})
+        #     else: displacements.batch_dimension = 0
+        # displacements = displacements.float()
+        # avouch(displacements.has_batch and displacements.has_channel, f"Please use batorch tensor of size \
+        #     ({{n_batch}}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim] for DDF parameters, instead of {displacements.shape}. ")
         super().__init__(displacements, shape=shape, interpolate=interpolate, **kwargs)
         self.n_dim = displacements.n_channel
         self.displacements = displacements
         self.interpolate = interpolate
         self.batch_param.append('displacements')
 
     # parameter alias
@@ -2144,50 +2206,52 @@
 
 @alias("rand_DDF")
 def rand_DenseDisplacementField(image, std=1, **kwargs):
     return DenseDisplacementField(*DenseDisplacementField.random_init_params(*image.space, n_batch=image.n_batch, std=std), **kwargs)
 
 @alias("VF")
 class VelocityField(Transformation):
+    """
+    Velocity Field (VF) transformation.
+    
+    Args:
+        scaled_velocities (bt.Tensor): the velocity at each voxel (or pixel), scaled to displacement level. 
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        shape (bt.Size or tuple): the shape of velocity (needed if input is a transformation). 
+        interpolate (bool): Whether to force interpolation in apply. 
+        level (int): the level of velocity, the transformation in delta time 1 / 2 is,
+            dT = V / 2. Therefore, the total transformation is dT  dT for 2 times.
+
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates.
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+    """
+    
     def __init__(self, scaled_velocities, shape=None, interpolate=False, level=4, **kwargs):
-        """
-        Velocity Field (VF) transformation.
-        
-        Args:
-            scaled_velocities (bt.Tensor): the velocity at each voxel (or pixel), scaled to displacement level. 
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            shape (bt.Size or tuple): the shape of velocity (needed if input is a transformation). 
-            interpolate (bool): Whether to force interpolation in apply. 
-            level (int): the level of velocity, the transformation in delta time 1 / 2 is,
-                dT = V / 2. Therefore, the total transformation is dT  dT for 2 times.
-
-        Args for __call__:
-            X (bt.Tensor): Coordinates to be transformed.
-                size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed coordinates.
-                size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-        """
         if isinstance(scaled_velocities, Transformation): scaled_velocities = scaled_velocities.toDDF(shape)
-        scaled_velocities = bt.to_bttensor(scaled_velocities)
-        if not scaled_velocities.has_channel:
-            if scaled_velocities.size(0) == scaled_velocities.n_dim - 1:
-                n_dim = scaled_velocities.size(0)
-                scaled_velocities.channel_dimension = 0
-                scaled_velocities = scaled_velocities.unsqueeze({})
-            elif scaled_velocities.size(1) == scaled_velocities.n_dim - 2:
-                n_dim = scaled_velocities.size(1)
-                scaled_velocities.channel_dimension = 1
-            else: raise TypeError(f"DDF parameters with size {scaled_velocities.shape} donot match ({{n_batch}}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]. ")
-        if not scaled_velocities.has_batch:
-            n_dim = scaled_velocities.n_channel
-            if scaled_velocities.n_dim <= n_dim + 1: scaled_velocities = scaled_velocities.unsqueeze({})
-            else: scaled_velocities.batch_dimension = 0
-        scaled_velocities = scaled_velocities.float()
-        avouch(scaled_velocities.has_batch and scaled_velocities.has_channel, f"Please use batorch tensor of size \
-            ({{n_batch}}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim] for DDF parameters, instead of {scaled_velocities.shape}. ")
+        scaled_velocities = bt.to_bttensor(scaled_velocities).float()
+        bt.input_shape().set(scaled_velocities = "({n_batch}, [n_dim], n_1, ..., n_r) [r=n_dim]")
+        # if not scaled_velocities.has_channel:
+        #     if scaled_velocities.size(0) == scaled_velocities.n_dim - 1:
+        #         n_dim = scaled_velocities.size(0)
+        #         scaled_velocities.channel_dimension = 0
+        #         scaled_velocities = scaled_velocities.unsqueeze({})
+        #     elif scaled_velocities.size(1) == scaled_velocities.n_dim - 2:
+        #         n_dim = scaled_velocities.size(1)
+        #         scaled_velocities.channel_dimension = 1
+        #     else: raise TypeError(f"DDF parameters with size {scaled_velocities.shape} donot match ({{n_batch}}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]. ")
+        # if not scaled_velocities.has_batch:
+        #     n_dim = scaled_velocities.n_channel
+        #     if scaled_velocities.n_dim <= n_dim + 1: scaled_velocities = scaled_velocities.unsqueeze({})
+        #     else: scaled_velocities.batch_dimension = 0
+        # scaled_velocities = scaled_velocities.float()
+        # avouch(scaled_velocities.has_batch and scaled_velocities.has_channel, f"Please use batorch tensor of size \
+        #     ({{n_batch}}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim] for DDF parameters, instead of {scaled_velocities.shape}. ")
         super().__init__(scaled_velocities, shape=shape, interpolate=interpolate, level=level, **kwargs)
         self.n_dim = scaled_velocities.n_channel
         self.scaled_velocities = scaled_velocities
         self.interpolate = interpolate
         self.level = level
         self.batch_param.append('scaled_velocities')
     
@@ -2214,87 +2278,97 @@
         if not self.interpolate and X.space == displacements.space and X.n_channel == displacements.n_channel: return X + displacements
         else: return X + interpolation(displacements, target_space=X)
 
 @alias("rand_VF")
 def rand_VelocityField(image, std=10, level=4, **kwargs):
     return VelocityField(*VelocityField.random_init_params(*image.space, n_batch=image.n_batch, std=std), level=level, **kwargs)
 
-# @alias("MLP")
-# class MultiLayerPerception(Transformation):
-#     def __init__(self, weights, hidden_layers=[], active_function=None, trans_stretch=1, residual=True):
-#         """
-#         A transformation defined by a MLP. 
-        
-#         Args:
-#             weights (bt.Tensor): the weights for the perception network. 
-#                 size: ({n_batch}, n_dim * n_hl_1 + n_hl_1 + sum(i=1..k-1){n_hl_i * n_hl_{i+1} + n_hl_{i+1}} + n_hl_k * n_dim + n_dim)
-#                 where k is the number of hidden layers and n_hl_i is the length of the i-th hidden layer. 
-#             hidden_layers (list of int): the lengths for the hidden layers, i.e. [n_hl_1, n_hl_2, ..., n_hl_k]
-#                 It is by default '[]' so that the default MLP is an affine transformation. 
-#             active_function (class): the active_function. 
-#             trans_stretch (float): scaling of translation movement, commonly needed in iterative parameter training, 1 by default. 5 seems to be a good choice. 
-            
-#         Args for __call__:
-#             X (bt.Tensor): Coordinates to be transformed.
-#                 size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-#             Returns (bt.Tensor): The transformed coordinates.
-#                 size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
-#         """
-#         self.hidden_layers = hidden_layers
-#         if not weights.has_batch:
-#             if weights.n_dim == 2: weights.batch_dim = 0
-#             else: weights = weights.unsqueeze([])
-#         self.weights = weights
-#         self.trans_stretch = trans_stretch
-#         super().__init__(weights, hidden_layers = hidden_layers, trans_stretch = trans_stretch, residual = residual)
-#         dim_const = weights.size(-1) - sum(hidden_layers) - sum(x * y for x, y in zip(hidden_layers[:-1], hidden_layers[1:]))
-#         dim_coeff = hidden_layers[0] + hidden_layers[-1] + 1
-#         avouch(dim_const % dim_coeff == 0, f"Wrong weight length for hidden layers of sizes {hidden_layers}, {dim_coeff} x n_dim + {dim_const} expected, but got {weights.size(-1)}.")
-#         self.n_dim = dim_const // dim_coeff
-#         self.n_batch = weights.n_batch
-#         self.layers = []
-#         p = 0
-#         for i in range(len(hidden_layers) + 1):
-#             in_features = self.n_dim if i == 0 else hidden_layers[i - 1]
-#             out_features = self.n_dim if i == len(hidden_layers) else hidden_layers[i]
-#             layer_weights = weights[..., p:p+out_features*in_features].view([self.n_batch], out_features, in_features)
-#             p += out_features * in_features
-#             layer_bias = weights[..., p:p+out_features].view([self.n_batch], out_features)
-#             p += out_features
-#             self.layers.append((layer_weights, layer_bias))
-#         self.active_function = active_function
-#         self.residual = residual
-#         if self.active_function is None: self.active_function = bt.nn.ReLU
+@alias("MLP")
+class MultiLayerPerception(Transformation):
+    """
+    A transformation defined by a MLP. 
     
-#     @classmethod
-#     def get_weight_length(cls, n_dim, *hidden_layers):
-#         hidden_layers = arg_tuple(hidden_layers)
-#         return n_dim * (hidden_layers[0] + hidden_layers[-1] + 1) \
-#             + sum(hidden_layers) + sum(x * y for x, y in zip(hidden_layers[:-1], hidden_layers[1:]))
+    Args:
+        weights (bt.Tensor): the weights for the perception network. 
+            size: ({n_batch}, n_dim * n_hl_1 + n_hl_1 + sum(i=1..k-1){n_hl_i * n_hl_{i+1} + n_hl_{i+1}} + n_hl_k * n_dim + n_dim)
+            where k is the number of hidden layers and n_hl_i is the length of the i-th hidden layer. 
+        hidden_layers (list of int): the lengths for the hidden layers, i.e. [n_hl_1, n_hl_2, ..., n_hl_k]
+            It is by default '[]' so that the default MLP is an affine transformation. 
+        active_function (class): the active_function. 
+        trans_stretch (float): scaling of translation movement, commonly needed in iterative parameter training, 1 by default. 5 seems to be a good choice. 
+        
+    Args for __call__:
+        X (bt.Tensor): Coordinates to be transformed.
+            size: ({n_batch: optional}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed coordinates.
+            size: ({n_batch}, [n_dim], n_1, n_2, ..., n_r) [r=n_dim]
+    """
     
-#     @property
-#     def n_weight_length(self):
-#         return MultiLayerPerception.get_weight_length(self.n_dim, self.hidden_layers)
+    def __init__(self, weights, hidden_layers=[], active_function=None, trans_stretch=1, residual=True):
+        self.hidden_layers = hidden_layers
+        n_hl = sum(x * y for x, y in zip(hidden_layers[:-1], hidden_layers[1:])) + sum(hidden_layers)
+        n_hl_1 = hidden_layers[0]
+        n_hl_k = hidden_layers[-1]
+        bt.input_shape(n_hl=n_hl, n_hl_1=n_hl_1, n_hl_k=n_hl_k).set(weights = "({n_batch}, n_dim * n_hl_1 + n_hl + n_hl_k * n_dim + n_dim)")
+        # if not weights.has_batch:
+        #     if weights.n_dim == 2: weights.batch_dim = 0
+        #     else: weights = weights.unsqueeze([])
+        self.weights = weights
+        self.trans_stretch = trans_stretch
+        super().__init__(weights, hidden_layers = hidden_layers, trans_stretch = trans_stretch, residual = residual)
+        dim_const = weights.size(-1) - n_hl
+        dim_coeff = n_hl_1 + n_hl_k + 1
+        avouch(dim_const % dim_coeff == 0, f"Wrong weight length for hidden layers of sizes {hidden_layers}, {dim_coeff} x n_dim + {dim_const} expected, but got {weights.size(-1)}.")
+        self.n_dim = dim_const // dim_coeff
+        self.n_batch = weights.n_batch
+        self.layers = []
+        p = 0
+        for i in range(len(hidden_layers) + 1):
+            in_features = self.n_dim if i == 0 else hidden_layers[i - 1]
+            out_features = self.n_dim if i == len(hidden_layers) else hidden_layers[i]
+            layer_weights = weights[..., p:p+out_features*in_features].view({self.n_batch}, out_features, in_features)
+            p += out_features * in_features
+            layer_bias = weights[..., p:p+out_features].view({self.n_batch}, out_features)
+            p += out_features
+            self.layers.append((layer_weights, layer_bias))
+        self.active_function = active_function
+        self.residual = residual
+        if self.active_function is None: self.active_function = bt.nn.ReLU
     
-#     @classmethod
-#     def random_init_params(cls, n_dim, *hidden_layers, n_batch=1, std=1e-4):
-#         hidden_layers = arg_tuple(hidden_layers)
-#         n_length = MultiLayerPerception.get_weight_length(n_dim, hidden_layers)
-#         return std * bt.randn({n_batch}, n_length)
+    @classmethod
+    def get_weight_length(cls, n_dim, *hidden_layers):
+        hidden_layers = arg_tuple(hidden_layers)
+        return n_dim * (hidden_layers[0] + hidden_layers[-1] + 1) \
+            + sum(hidden_layers) + sum(x * y for x, y in zip(hidden_layers[:-1], hidden_layers[1:]))
     
-#     def __call__(self, X):
-#         if not X.has_space: X = X.unsqueeze(-1)
-#         Y = X.flatten(...).channel_dim_(None)
-#         for i, (weights, bias) in enumerate(self.layers):
-#             Y = weights @ Y
-#             if i < len(self.layers) - 1: Y = self.active_function()(Y + bias.unsqueeze(-1))
-#             else: Y += self.trans_stretch * bias.unsqueeze(-1)
-#         if self.residual:
-#             return X + Y.view_as(X).channel_dimension_(1)
-#         else: return Y.view_as(X).channel_dimension_(1)
+    @property
+    def n_weight_length(self):
+        return MultiLayerPerception.get_weight_length(self.n_dim, self.hidden_layers)
+    
+    @classmethod
+    def random_init_params(cls, n_dim, *hidden_layers, n_batch=1, std=1e-4):
+        hidden_layers = arg_tuple(hidden_layers)
+        n_length = MultiLayerPerception.get_weight_length(n_dim, hidden_layers)
+        return std * bt.randn({n_batch}, n_length)
+    
+    def __call__(self, X):
+        if not X.has_space: X = X.unsqueeze(-1)
+        Y = X.flatten(...).with_feature_dim(None)
+        for i, (weights, bias) in enumerate(self.layers):
+            Y = weights @ Y
+            if i < len(self.layers) - 1: Y = self.active_function()(Y + bias.unsqueeze(-1))
+            else: Y += self.trans_stretch * bias.unsqueeze(-1)
+        if self.residual:
+            return X + Y.view_as(X)
+        else: return Y.view_as(X)
+
+@alias("rand_MLP")
+def rand_MultiLayerPerception(image, std=10, level=4, **kwargs):
+    hl = [40, 40]
+    return MultiLayerPerception(*MultiLayerPerception.random_init_params(image.n_dim, *hl, n_batch=image.n_batch, std=std), hidden_layers=hl, **kwargs)
 
 # @alias("SAT")
 # class SelfAttentionTransformation(Transformation):
 #     def __init__(self, weights, hidden_layers=[], active_function=None, trans_stretch=1, residual=True):
 #         """
 #         A transformation defined by a Network with self-attention structure. 
         
@@ -2676,28 +2750,29 @@
 #                 if not X.has_channel: X.channel_dimension = 0 if X._batch_dimension > 0 else 1
 #         avouch(X.has_batch and X.has_channel, f"Please use batorch tensor of size \
 #             ({{n_batch}}, [n_channel/n_feature:optional], m_1, m_2, ..., m_r) [r=n_dim] for \
 #                 {self.__name__}, instead of {X.shape}. ")
 #         return X.clone()
 
 class Normalize(Transformation):
-    def __init__(self, *_range):
-        """
-        Normalize the intensity of an image.
+    """
+    Normalize the intensity of an image.
+    
+    Args:
+        _range = (low, high) (int or float or bt.Tensor): The lowest (and highest) intensity. 
+            size: length(2) or ({n_batch:optional}, [n_channel:optional], (2))
         
-        Args:
-            _range = (low, high) (int or float or bt.Tensor): The lowest (and highest) intensity. 
-                size: length(2) or ({n_batch:optional}, [n_channel:optional], (2))
-            
-        Args for __call__:
-            X (bt.Tensor): Image to be transformed.
-                size: ({n_batch:optional}, [n_channel:optional], n_1, n_2, ..., n_r) [r=n_dim]
-            Returns (bt.Tensor): The transformed image.
-                size: ({n_batch}, [n_channel], n_1, n_2, ..., n_r) [r=n_dim]
-        """
+    Args for __call__:
+        X (bt.Tensor): Image to be transformed.
+            size: ({n_batch:optional}, [n_channel:optional], n_1, n_2, ..., n_r) [r=n_dim]
+        Returns (bt.Tensor): The transformed image.
+            size: ({n_batch}, [n_channel], n_1, n_2, ..., n_r) [r=n_dim]
+    """
+
+    def __init__(self, *_range):
         if len(_range) == 0: _range = None
         elif len(_range) == 1 and isinstance(_range[0], (list, tuple)): _range = bt.tensor(list(_range[0])).with_funcdim(True)
         elif len(_range) == 1 and isinstance(_range[0], bt.Tensor): _range = _range[0]
         elif len(_range) == 1 and isinstance(_range[0], int): _range = bt.tensor((0, _range)).with_funcdim(True)
         elif len(_range) == 2 and all(isinstance(r, int) for r in _range): _range = bt.channel_tensor(_range).with_funcdim(True)
         else: raise TypeError(f"Invalid range for Normalize: {_range}. ")
         if _range is None: pass
@@ -2708,14 +2783,15 @@
             if not _range.has_batch: _range.unsqueeze_({})
             if not _range.has_feature: _range.unsqueeze_([])
             avouch(_range.has_batch and _range.has_channel and _range.has_func and _range.func_size == 2, f"Please use batorch tensor of size \
                 ({{n_batch:optional}}, [n_channel:optional], (2)) for Normalizing parameters, instead of {_range.shape}. ")
         super().__init__(_range)
         self.range = _range
         self._range = None
+        self.domain = 'non-spatial'
 
     def __call_non_spatial__(self, X):
         _range = self.range
         if _range is None:
             _range = bt.quantile(X.flatten(...).float(), bt.to_bttensor([0.025, 0.975]), -1).movedim(0, -1)
             self._range = _range
         return ((X - _range[..., 0]) / (_range[..., 1] - _range[..., 0])).clamp(0., 1.)
@@ -2723,14 +2799,32 @@
     def __inv__(self):
         if self.range is not None: _range = self.range
         elif self._range is not None: _range = self._range
         else: return Normalize(None)
         den = _range[..., 1] - _range[..., 0]
         _range = bt.stack(-_range[..., 0], 1-_range[..., 0], [-1]) / den
         return Normalize(_range)
+    
+class Cropping(Transformation):
+    """
+    Cropping transformation.
+        
+    Args for __call__:
+        Img (bt.Tensor): Image to be cropped.
+            size: ({n_batch:optional}, [n_channel:optional], n_1, n_2, ..., n_r)
+        Returns (bt.Tensor): The transformed coordinates. 
+            size: ({n_batch}, [n_channel:optional], n_1, n_2, ..., n_r)
+    """
+    def __init__(self, shape, **kwargs):
+        super().__init__(shape=shape, **kwargs)
+        self.reshape = [shape]
+        self.domain = 'non-spatial'
+        
+    def __call_non_spatial__(self, X):
+        return bt.crop_as(X, self.shape)
 
 # ############# Supporting Functions ############
 
 def Bspline(i, U):
     """
     Cubic B-spline function. 
     Note: As long as i and U have the same size, any shape of tensors would do.
```

### Comparing `batorch-1.0.53/micomputing/zxhtools/TRS.py` & `batorch-1.0.54/micomputing/zxhtools/TRS.py`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/micomputing/zxhtools/__pycache__/AFF.cpython-39.pyc` & `batorch-1.0.54/micomputing/zxhtools/__pycache__/AFF.cpython-39.pyc`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/micomputing/zxhtools/__pycache__/FFD.cpython-39.pyc` & `batorch-1.0.54/micomputing/zxhtools/__pycache__/FFD.cpython-39.pyc`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/micomputing/zxhtools/__pycache__/TRS.cpython-311.pyc` & `batorch-1.0.54/micomputing/zxhtools/__pycache__/TRS.cpython-311.pyc`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/micomputing/zxhtools/__pycache__/TRS.cpython-37.pyc` & `batorch-1.0.54/micomputing/zxhtools/__pycache__/TRS.cpython-37.pyc`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/micomputing/zxhtools/__pycache__/TRS.cpython-39.pyc` & `batorch-1.0.54/micomputing/zxhtools/__pycache__/TRS.cpython-39.pyc`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/micomputing/zxhtools/__pycache__/exec.cpython-311.pyc` & `batorch-1.0.54/micomputing/zxhtools/__pycache__/exec.cpython-311.pyc`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/micomputing/zxhtools/exec.py` & `batorch-1.0.54/micomputing/zxhtools/exec.py`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/micomputing/zxhtools/image2.FFD` & `batorch-1.0.54/micomputing/zxhtools/image2.FFD`

 * *Files identical despite different names*

### Comparing `batorch-1.0.53/setup_batorch.py` & `batorch-1.0.54/setup_batorch.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,18 +1,18 @@
 from setuptools import setup, find_packages
 
 setup(
 	name = 'batorch',
-	version = '1.0.53',
+	version = '1.0.54',
 	keywords = ['pip', 'pymyc', 'batorch', 'torch', 'batch', 'batched data'],
 	description = "'batorch' is an extension of package torch, for tensors with batch dimensions. ",
 	long_description = None,
 	long_description_content_type = 'text/markdown',
 	license = 'MIT Licence',
 	url = 'https://github.com/Bertie97/PyZMyc/batorch',
 	author = 'Yuncheng Zhou',
 	author_email = 'bertiezhou@163.com',
 	packages = find_packages(),
 	include_package_data = False,
 	platforms = 'any',
-	install_requires = ['pycamia', 'torch', 'pynvml', 'matplotlib', 'psutil']
+	install_requires = ['pycamia', 'torch', 'pynvml', 'matplotlib', 'psutil', 'numpy', 'pyoverload', 'sympy']
 )
```

