# Comparing `tmp/antspymm-1.3.5.tar.gz` & `tmp/antspymm-1.3.6.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "antspymm-1.3.5.tar", last modified: Wed May  8 20:05:28 2024, max compression
+gzip compressed data, was "antspymm-1.3.6.tar", last modified: Wed May 22 14:55:45 2024, max compression
```

## Comparing `antspymm-1.3.5.tar` & `antspymm-1.3.6.tar`

### file list

```diff
@@ -1,63 +1,66 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-08 20:05:28.909239 antspymm-1.3.5/
--rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-05-08 20:05:24.000000 antspymm-1.3.5/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)       33 2024-05-08 20:05:24.000000 antspymm-1.3.5/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    14586 2024-05-08 20:05:28.909239 antspymm-1.3.5/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)    13954 2024-05-08 20:05:24.000000 antspymm-1.3.5/README.md
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-08 20:05:28.881239 antspymm-1.3.5/antspymm/
--rw-r--r--   0 runner    (1001) docker     (127)     4462 2024-05-08 20:05:24.000000 antspymm-1.3.5/antspymm/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)   479710 2024-05-08 20:05:24.000000 antspymm-1.3.5/antspymm/mm.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-08 20:05:28.909239 antspymm-1.3.5/antspymm.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    14586 2024-05-08 20:05:28.000000 antspymm-1.3.5/antspymm.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     1423 2024-05-08 20:05:28.000000 antspymm-1.3.5/antspymm.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-08 20:05:28.000000 antspymm-1.3.5/antspymm.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-08 20:05:28.000000 antspymm-1.3.5/antspymm.egg-info/not-zip-safe
--rw-r--r--   0 runner    (1001) docker     (127)      110 2024-05-08 20:05:28.000000 antspymm-1.3.5/antspymm.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        9 2024-05-08 20:05:28.000000 antspymm-1.3.5/antspymm.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-08 20:05:28.905239 antspymm-1.3.5/docs/
--rw-r--r--   0 runner    (1001) docker     (127)     1508 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/adni_rsfmri_2_nrg_conversion.py
--rw-r--r--   0 runner    (1001) docker     (127)   594290 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/antspymm_data_dictionary.csv
--rw-r--r--   0 runner    (1001) docker     (127)      567 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/bids_cohort_example.py
--rw-r--r--   0 runner    (1001) docker     (127)     3342 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/blind_qc.Rmd
--rw-r--r--   0 runner    (1001) docker     (127)  1055592 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/blind_qc.html
--rw-r--r--   0 runner    (1001) docker     (127)     1445 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/convert_adni_dti_to_nrg.R
--rw-r--r--   0 runner    (1001) docker     (127)   450556 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/deepnbm.jpg
--rw-r--r--   0 runner    (1001) docker     (127)   525580 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/example_antspymm_output.csv
--rw-r--r--   0 runner    (1001) docker     (127)     1296 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/example_run_from_directory.py
--rw-r--r--   0 runner    (1001) docker     (127)    28375 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/make_dict_table.Rmd
--rw-r--r--   0 runner    (1001) docker     (127)  9773579 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/make_dict_table.html
--rw-r--r--   0 runner    (1001) docker     (127)      632 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/nrg_cohort_example.py
--rw-r--r--   0 runner    (1001) docker     (127)     5369 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/ptbp_nrg.py
--rw-r--r--   0 runner    (1001) docker     (127)     5971 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/roi_visualization.py
--rw-r--r--   0 runner    (1001) docker     (127)     1732 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/roi_visualization_ppmi.py
--rw-r--r--   0 runner    (1001) docker     (127)     1965 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/step1_blind_qc.py
--rw-r--r--   0 runner    (1001) docker     (127)     3781 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/step2_outlierness.py
--rw-r--r--   0 runner    (1001) docker     (127)     7481 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/step3_mm_nrg_csv.py
--rw-r--r--   0 runner    (1001) docker     (127)      961 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/step4_aggregate.py
--rw-r--r--   0 runner    (1001) docker     (127)     3643 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/ukbb_to_nrg_processing.py
--rw-r--r--   0 runner    (1001) docker     (127)     4546 2024-05-08 20:05:24.000000 antspymm-1.3.5/docs/ukbb_to_nrg_processing2.py
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-08 20:05:28.909239 antspymm-1.3.5/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (127)      826 2024-05-08 20:05:24.000000 antspymm-1.3.5/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-08 20:05:28.909239 antspymm-1.3.5/tests/
--rw-r--r--   0 runner    (1001) docker     (127)     1855 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/blind_qc.py
--rw-r--r--   0 runner    (1001) docker     (127)     5589 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/mm.py
--rw-r--r--   0 runner    (1001) docker     (127)     2087 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/mm_nrg.py
--rw-r--r--   0 runner    (1001) docker     (127)     1563 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/outlierness.py
--rw-r--r--   0 runner    (1001) docker     (127)      830 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/parallel_study_aggregation_example.py
--rw-r--r--   0 runner    (1001) docker     (127)      440 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_bids_2_nrg.py
--rw-r--r--   0 runner    (1001) docker     (127)     2650 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_deformation_gradient_reo.py
--rw-r--r--   0 runner    (1001) docker     (127)      394 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_dti_recon.py
--rw-r--r--   0 runner    (1001) docker     (127)     1500 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_dti_reg.py
--rw-r--r--   0 runner    (1001) docker     (127)     3924 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_dwi_rebasing.py
--rw-r--r--   0 runner    (1001) docker     (127)     1275 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_dwi_run.py
--rw-r--r--   0 runner    (1001) docker     (127)     1751 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_dwi_run_ptbp_scrub.py
--rw-r--r--   0 runner    (1001) docker     (127)      445 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_flair_run.py
--rw-r--r--   0 runner    (1001) docker     (127)     3364 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_joint_dti_recon.py
--rw-r--r--   0 runner    (1001) docker     (127)     1497 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_mm_csv.py
--rw-r--r--   0 runner    (1001) docker     (127)     2900 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_nrg_validation.py
--rw-r--r--   0 runner    (1001) docker     (127)     2272 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_perfusion_ptbp.py
--rw-r--r--   0 runner    (1001) docker     (127)     1707 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_perfusion_run.py
--rw-r--r--   0 runner    (1001) docker     (127)     2101 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_rsfmri_run.py
--rw-r--r--   0 runner    (1001) docker     (127)     1903 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_rsfmri_run_minimal.py
--rw-r--r--   0 runner    (1001) docker     (127)      762 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/test_ukbb_rsfmri.py
--rw-r--r--   0 runner    (1001) docker     (127)      597 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/testsr.py
--rw-r--r--   0 runner    (1001) docker     (127)     1439 2024-05-08 20:05:24.000000 antspymm-1.3.5/tests/visualize_tractogram.py
+drwxr-xr-x   0 stnava     (501) staff       (20)        0 2024-05-22 14:55:45.258956 antspymm-1.3.6/
+-rw-r--r--   0 stnava     (501) staff       (20)    11357 2021-11-01 09:20:32.000000 antspymm-1.3.6/LICENSE
+-rw-r--r--   0 stnava     (501) staff       (20)       33 2023-01-29 13:38:57.000000 antspymm-1.3.6/MANIFEST.in
+-rw-r--r--   0 stnava     (501) staff       (20)    14679 2024-05-22 14:55:45.258758 antspymm-1.3.6/PKG-INFO
+-rw-r--r--   0 stnava     (501) staff       (20)    14070 2024-05-22 14:48:42.000000 antspymm-1.3.6/README.md
+drwxr-xr-x   0 stnava     (501) staff       (20)        0 2024-05-22 14:55:45.246771 antspymm-1.3.6/antspymm/
+-rw-r--r--   0 stnava     (501) staff       (20)     4462 2024-04-16 12:46:37.000000 antspymm-1.3.6/antspymm/__init__.py
+-rw-rw-r--   0 stnava     (501) staff       (20)   479806 2024-05-21 21:14:55.000000 antspymm-1.3.6/antspymm/mm.py
+drwxr-xr-x   0 stnava     (501) staff       (20)        0 2024-05-22 14:55:45.258556 antspymm-1.3.6/antspymm.egg-info/
+-rw-r--r--   0 stnava     (501) staff       (20)    14679 2024-05-22 14:55:45.000000 antspymm-1.3.6/antspymm.egg-info/PKG-INFO
+-rw-r--r--   0 stnava     (501) staff       (20)     1506 2024-05-22 14:55:45.000000 antspymm-1.3.6/antspymm.egg-info/SOURCES.txt
+-rw-r--r--   0 stnava     (501) staff       (20)        1 2024-05-22 14:55:45.000000 antspymm-1.3.6/antspymm.egg-info/dependency_links.txt
+-rw-r--r--   0 stnava     (501) staff       (20)      127 2024-05-22 14:55:45.000000 antspymm-1.3.6/antspymm.egg-info/requires.txt
+-rw-r--r--   0 stnava     (501) staff       (20)        9 2024-05-22 14:55:45.000000 antspymm-1.3.6/antspymm.egg-info/top_level.txt
+drwxr-xr-x   0 stnava     (501) staff       (20)        0 2024-05-22 14:55:45.255803 antspymm-1.3.6/docs/
+-rw-rw-r--   0 stnava     (501) staff       (20)     1508 2024-02-11 18:56:11.000000 antspymm-1.3.6/docs/adni_rsfmri_2_nrg_conversion.py
+-rw-r--r--   0 stnava     (501) staff       (20)   594290 2024-04-04 15:02:46.000000 antspymm-1.3.6/docs/antspymm_data_dictionary.csv
+-rw-r--r--   0 stnava     (501) staff       (20)      567 2023-04-12 13:06:30.000000 antspymm-1.3.6/docs/bids_cohort_example.py
+-rw-r--r--   0 stnava     (501) staff       (20)     3342 2023-06-07 13:26:50.000000 antspymm-1.3.6/docs/blind_qc.Rmd
+-rw-r--r--   0 stnava     (501) staff       (20)  1055592 2023-06-07 13:27:14.000000 antspymm-1.3.6/docs/blind_qc.html
+-rw-r--r--   0 stnava     (501) staff       (20)     1445 2023-06-07 15:29:23.000000 antspymm-1.3.6/docs/convert_adni_dti_to_nrg.R
+-rw-r--r--   0 stnava     (501) staff       (20)   450556 2024-02-09 15:00:37.000000 antspymm-1.3.6/docs/deepnbm.jpg
+-rw-r--r--   0 stnava     (501) staff       (20)   525580 2024-02-09 12:45:10.000000 antspymm-1.3.6/docs/example_antspymm_output.csv
+-rw-r--r--   0 stnava     (501) staff       (20)     1296 2023-04-08 18:52:17.000000 antspymm-1.3.6/docs/example_run_from_directory.py
+-rw-r--r--   0 stnava     (501) staff       (20)    28375 2024-03-21 13:09:40.000000 antspymm-1.3.6/docs/make_dict_table.Rmd
+-rw-r--r--   0 stnava     (501) staff       (20)  9773579 2024-04-04 15:03:07.000000 antspymm-1.3.6/docs/make_dict_table.html
+-rw-r--r--   0 stnava     (501) staff       (20)      632 2023-04-12 13:06:30.000000 antspymm-1.3.6/docs/nrg_cohort_example.py
+-rw-r--r--   0 stnava     (501) staff       (20)     5369 2023-12-14 01:09:41.000000 antspymm-1.3.6/docs/ptbp_nrg.py
+-rw-r--r--   0 stnava     (501) staff       (20)     1887 2024-04-19 12:10:37.000000 antspymm-1.3.6/docs/release_notes.py
+-rw-r--r--   0 stnava     (501) staff       (20)     5971 2024-04-04 18:38:45.000000 antspymm-1.3.6/docs/roi_visualization.py
+-rw-r--r--   0 stnava     (501) staff       (20)     1276 2024-04-05 13:16:10.000000 antspymm-1.3.6/docs/roi_visualization_limbic.py
+-rw-r--r--   0 stnava     (501) staff       (20)     1732 2023-12-14 01:09:41.000000 antspymm-1.3.6/docs/roi_visualization_ppmi.py
+-rw-rw-r--   0 stnava     (501) staff       (20)     1965 2024-05-04 12:48:31.000000 antspymm-1.3.6/docs/step1_blind_qc.py
+-rw-rw-r--   0 stnava     (501) staff       (20)     3781 2024-05-04 12:49:31.000000 antspymm-1.3.6/docs/step2_outlierness.py
+-rw-rw-r--   0 stnava     (501) staff       (20)     7481 2024-05-02 20:41:29.000000 antspymm-1.3.6/docs/step3_mm_nrg_csv.py
+-rw-rw-r--   0 stnava     (501) staff       (20)      961 2024-05-04 12:51:51.000000 antspymm-1.3.6/docs/step4_aggregate.py
+-rw-r--r--   0 stnava     (501) staff       (20)     3643 2023-04-15 22:47:31.000000 antspymm-1.3.6/docs/ukbb_to_nrg_processing.py
+-rw-r--r--   0 stnava     (501) staff       (20)     4546 2023-04-16 12:24:12.000000 antspymm-1.3.6/docs/ukbb_to_nrg_processing2.py
+-rw-r--r--   0 stnava     (501) staff       (20)      689 2024-05-22 14:55:26.000000 antspymm-1.3.6/pyproject.toml
+-rw-r--r--   0 stnava     (501) staff       (20)       38 2024-05-22 14:55:45.258991 antspymm-1.3.6/setup.cfg
+drwxr-xr-x   0 stnava     (501) staff       (20)        0 2024-05-22 14:55:45.258419 antspymm-1.3.6/tests/
+-rw-r--r--   0 stnava     (501) staff       (20)     1855 2023-12-14 01:09:41.000000 antspymm-1.3.6/tests/blind_qc.py
+-rw-r--r--   0 stnava     (501) staff       (20)     5589 2022-10-21 12:35:02.000000 antspymm-1.3.6/tests/mm.py
+-rw-r--r--   0 stnava     (501) staff       (20)     2087 2022-12-17 20:51:01.000000 antspymm-1.3.6/tests/mm_nrg.py
+-rw-r--r--   0 stnava     (501) staff       (20)     1563 2023-12-14 01:09:41.000000 antspymm-1.3.6/tests/outlierness.py
+-rw-rw-r--   0 stnava     (501) staff       (20)      830 2023-05-19 09:24:27.000000 antspymm-1.3.6/tests/parallel_study_aggregation_example.py
+-rw-r--r--   0 stnava     (501) staff       (20)      109 2024-05-22 12:43:52.000000 antspymm-1.3.6/tests/test_00_setup.py
+-rw-r--r--   0 stnava     (501) staff       (20)      440 2023-03-15 12:39:26.000000 antspymm-1.3.6/tests/test_bids_2_nrg.py
+-rw-r--r--   0 stnava     (501) staff       (20)     2732 2024-05-22 12:40:43.000000 antspymm-1.3.6/tests/test_deformation_gradient_reo.py
+-rw-r--r--   0 stnava     (501) staff       (20)      379 2024-05-22 12:41:40.000000 antspymm-1.3.6/tests/test_dti_recon.py
+-rw-r--r--   0 stnava     (501) staff       (20)     1500 2023-05-01 14:47:40.000000 antspymm-1.3.6/tests/test_dti_reg.py
+-rw-r--r--   0 stnava     (501) staff       (20)     3924 2023-08-11 16:02:30.000000 antspymm-1.3.6/tests/test_dwi_rebasing.py
+-rw-r--r--   0 stnava     (501) staff       (20)     1275 2024-01-21 23:24:12.000000 antspymm-1.3.6/tests/test_dwi_run.py
+-rw-r--r--   0 stnava     (501) staff       (20)     1751 2024-01-21 23:24:12.000000 antspymm-1.3.6/tests/test_dwi_run_ptbp_scrub.py
+-rw-r--r--   0 stnava     (501) staff       (20)      445 2023-02-05 00:06:28.000000 antspymm-1.3.6/tests/test_flair_run.py
+-rw-r--r--   0 stnava     (501) staff       (20)     3364 2024-04-16 11:44:43.000000 antspymm-1.3.6/tests/test_joint_dti_recon.py
+-rw-r--r--   0 stnava     (501) staff       (20)     1497 2023-03-15 12:44:41.000000 antspymm-1.3.6/tests/test_mm_csv.py
+-rw-r--r--   0 stnava     (501) staff       (20)     2900 2024-03-05 23:58:34.000000 antspymm-1.3.6/tests/test_nrg_validation.py
+-rw-r--r--   0 stnava     (501) staff       (20)     2272 2024-02-03 14:52:35.000000 antspymm-1.3.6/tests/test_perfusion_ptbp.py
+-rw-r--r--   0 stnava     (501) staff       (20)     1443 2024-01-12 17:41:30.000000 antspymm-1.3.6/tests/test_perfusion_ptbp2.py
+-rw-r--r--   0 stnava     (501) staff       (20)     1707 2023-12-14 01:09:41.000000 antspymm-1.3.6/tests/test_perfusion_run.py
+-rw-r--r--   0 stnava     (501) staff       (20)     2101 2022-11-16 16:52:51.000000 antspymm-1.3.6/tests/test_rsfmri_run.py
+-rw-r--r--   0 stnava     (501) staff       (20)     1903 2024-01-21 23:28:21.000000 antspymm-1.3.6/tests/test_rsfmri_run_minimal.py
+-rw-r--r--   0 stnava     (501) staff       (20)      762 2023-05-05 18:29:30.000000 antspymm-1.3.6/tests/test_ukbb_rsfmri.py
+-rw-r--r--   0 stnava     (501) staff       (20)      597 2021-11-02 19:50:00.000000 antspymm-1.3.6/tests/testsr.py
+-rw-r--r--   0 stnava     (501) staff       (20)     1439 2023-03-02 15:01:53.000000 antspymm-1.3.6/tests/visualize_tractogram.py
```

### Comparing `antspymm-1.3.5/LICENSE` & `antspymm-1.3.6/LICENSE`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/PKG-INFO` & `antspymm-1.3.6/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,22 +1,22 @@
 Metadata-Version: 2.1
 Name: antspymm
-Version: 1.3.5
+Version: 1.3.6
 Summary: multi-channel/time-series medical image processing with antspyx
-Home-page: https://github.com/stnava/ANTsPyMM
-Author: Avants, Gosselin, Tustison, Reardon
-Author-email: stnava@gmail.com
+Author-email: "Avants, Gosselin, Tustison, Reardon" <stnava@gmail.com>
 License: Apache 2.0
-Description-Content-Type: text/markdown; charset=UTF-8; variant=GFM
+Requires-Python: >=3.8
+Description-Content-Type: text/markdown
 License-File: LICENSE
 Requires-Dist: h5py>=2.10.0
 Requires-Dist: numpy>=1.19.4
 Requires-Dist: pandas>=1.0.1
 Requires-Dist: antspyx
-Requires-Dist: antspyt1w>=0.2.3
+Requires-Dist: antspynet>=0.2.5
+Requires-Dist: antspyt1w>=0.9.3
 Requires-Dist: pathlib
 Requires-Dist: dipy
 Requires-Dist: nibabel
 Requires-Dist: scipy
 Requires-Dist: siq
 Requires-Dist: scikit-learn
 
@@ -31,15 +31,15 @@
 
 this package also keeps track of the latest preferred algorithm variations for
 production environments.
 
 install the `dev` version by calling (within the source directory):
 
 ```
-python setup.py install
+python3 -m  build .
 ```
 
 or install the latest release via 
 
 ```
 pip install antspymm
 ```
@@ -446,13 +446,16 @@
 ```python
 import ssl
 ssl._create_default_https_context = ssl._create_unverified_context
 ```
 
 ## to publish a release
 
+before doing this - make sure you have a recent run of `pip-compile pyproject.toml`
+
 ```
 rm -r -f build/ antspymm.egg-info/ dist/
-python3 setup.py sdist bdist_wheel
-twine upload --repository antspymm dist/*
+python3 -m  build .
+python3 -m pip install --upgrade twine
+python3 -m twine upload --repository antspymm dist/*
 ```
```

### Comparing `antspymm-1.3.5/README.md` & `antspymm-1.3.6/README.md`

 * *Files 3% similar despite different names*

```diff
@@ -9,15 +9,15 @@
 
 this package also keeps track of the latest preferred algorithm variations for
 production environments.
 
 install the `dev` version by calling (within the source directory):
 
 ```
-python setup.py install
+python3 -m  build .
 ```
 
 or install the latest release via 
 
 ```
 pip install antspymm
 ```
@@ -424,13 +424,16 @@
 ```python
 import ssl
 ssl._create_default_https_context = ssl._create_unverified_context
 ```
 
 ## to publish a release
 
+before doing this - make sure you have a recent run of `pip-compile pyproject.toml`
+
 ```
 rm -r -f build/ antspymm.egg-info/ dist/
-python3 setup.py sdist bdist_wheel
-twine upload --repository antspymm dist/*
+python3 -m  build .
+python3 -m pip install --upgrade twine
+python3 -m twine upload --repository antspymm dist/*
 ```
```

### Comparing `antspymm-1.3.5/antspymm/__init__.py` & `antspymm-1.3.6/antspymm/__init__.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/antspymm/mm.py` & `antspymm-1.3.6/antspymm/mm.py`

 * *Files 0% similar despite different names*

```diff
@@ -20035,9948 +20035,9954 @@
 0004e420: 6974 6820 6120 636f 6e73 6973 7465 6e74  ith a consistent
 0004e430: 2061 6e64 2072 6563 656e 7420 6170 7072   and recent appr
 0004e440: 6f61 6368 2023 2323 2323 2323 2323 2323  oach ###########
 0004e450: 230a 2020 2020 6d79 7820 3d20 616e 7473  #.    myx = ants
 0004e460: 7079 7431 772e 696e 7370 6563 745f 7261  pyt1w.inspect_ra
 0004e470: 775f 7431 2820 7431 2c20 6869 6572 666e  w_t1( t1, hierfn
 0004e480: 202b 2027 7262 7027 202c 206f 7074 696f   + 'rbp' , optio
-0004e490: 6e3d 2762 6f74 6827 2029 200a 2020 2020  n='both' ) .    
-0004e4a0: 6465 6c20 6d79 780a 2020 2020 6869 6572  del myx.    hier
-0004e4b0: 203d 2061 6e74 7370 7974 3177 2e72 6561   = antspyt1w.rea
-0004e4c0: 645f 6869 6572 6172 6368 6963 616c 2820  d_hierarchical( 
-0004e4d0: 6869 6572 666e 2029 0a20 2020 2069 6620  hierfn ).    if 
-0004e4e0: 6578 6973 7473 2820 6869 6572 666e 202b  exists( hierfn +
-0004e4f0: 2027 6d6d 7769 6465 2e63 7376 2720 2920   'mmwide.csv' ) 
-0004e500: 3a0a 2020 2020 2020 2020 7431 7769 6465  :.        t1wide
-0004e510: 203d 2070 642e 7265 6164 5f63 7376 2820   = pd.read_csv( 
-0004e520: 6869 6572 666e 202b 2027 6d6d 7769 6465  hierfn + 'mmwide
-0004e530: 2e63 7376 2720 290a 2020 2020 656c 6966  .csv' ).    elif
-0004e540: 206e 6f74 2074 6573 746c 6f6f 703a 0a20   not testloop:. 
-0004e550: 2020 2020 2020 2074 3177 6964 6520 3d20         t1wide = 
+0004e490: 6e3d 2762 6f74 6827 2029 0a20 2020 206d  n='both' ).    m
+0004e4a0: 7978 5b27 6272 6169 6e27 5d2e 746f 5f63  yx['brain'].to_c
+0004e4b0: 7376 2820 6869 6572 666e 202b 2027 7262  sv( hierfn + 'rb
+0004e4c0: 702e 6373 7627 2c20 696e 6465 783d 4661  p.csv', index=Fa
+0004e4d0: 6c73 6520 290a 2020 2020 6d79 785b 2762  lse ).    myx['b
+0004e4e0: 7261 696e 275d 2e74 6f5f 6373 7628 2068  rain'].to_csv( h
+0004e4f0: 6965 7266 6e20 2b20 2772 6270 6272 6169  ierfn + 'rbpbrai
+0004e500: 6e2e 6373 7627 2c20 696e 6465 783d 4661  n.csv', index=Fa
+0004e510: 6c73 6520 290a 2020 2020 6465 6c20 6d79  lse ).    del my
+0004e520: 780a 2020 2020 6869 6572 203d 2061 6e74  x.    hier = ant
+0004e530: 7370 7974 3177 2e72 6561 645f 6869 6572  spyt1w.read_hier
+0004e540: 6172 6368 6963 616c 2820 6869 6572 666e  archical( hierfn
+0004e550: 2029 0a20 2020 2074 3177 6964 6520 3d20   ).    t1wide = 
 0004e560: 616e 7473 7079 7431 772e 6d65 7267 655f  antspyt1w.merge_
 0004e570: 6869 6572 6172 6368 6963 616c 5f63 7376  hierarchical_csv
 0004e580: 735f 746f 5f77 6964 655f 666f 726d 6174  s_to_wide_format
-0004e590: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0004e5a0: 2020 6869 6572 5b27 6461 7461 6672 616d    hier['datafram
-0004e5b0: 6573 275d 2c20 6964 656e 7469 6669 6572  es'], identifier
-0004e5c0: 3d4e 6f6e 6520 290a 2020 2020 7267 7261  =None ).    rgra
-0004e5d0: 6465 203d 2073 7472 2820 7431 7769 6465  de = str( t1wide
-0004e5e0: 5b27 7265 736e 6574 4772 6164 6527 5d2e  ['resnetGrade'].
-0004e5f0: 696c 6f63 5b30 5d20 290a 2020 2020 6966  iloc[0] ).    if
-0004e600: 2074 3177 6964 655b 2772 6573 6e65 7447   t1wide['resnetG
-0004e610: 7261 6465 275d 2e69 6c6f 635b 305d 203c  rade'].iloc[0] <
-0004e620: 2030 2e32 303a 0a20 2020 2020 2020 2077   0.20:.        w
-0004e630: 6172 6e69 6e67 732e 7761 726e 2827 5431  arnings.warn('T1
-0004e640: 7720 7175 616c 6974 7920 6368 6563 6b20  w quality check 
-0004e650: 696e 6469 6361 7465 7320 6661 696c 7572  indicates failur
-0004e660: 653a 2027 202b 2072 6772 6164 6520 2b20  e: ' + rgrade + 
-0004e670: 2220 7769 6c6c 206e 6f74 2070 726f 6365  " will not proce
-0004e680: 7373 2e22 2029 0a20 2020 2020 2020 2072  ss." ).        r
-0004e690: 6574 7572 6e0a 2020 2020 656c 7365 3a0a  eturn.    else:.
-0004e6a0: 2020 2020 2020 2020 7072 696e 7428 2754          print('T
-0004e6b0: 3177 2071 7561 6c69 7479 2063 6865 636b  1w quality check
-0004e6c0: 2069 6e64 6963 6174 6573 2073 7563 6365   indicates succe
-0004e6d0: 7373 3a20 2720 2b20 7267 7261 6465 202b  ss: ' + rgrade +
-0004e6e0: 2022 2077 696c 6c20 7072 6f63 6573 732e   " will process.
-0004e6f0: 2220 290a 0a20 2020 2069 6620 7372 6d6f  " )..    if srmo
-0004e700: 6465 6c5f 5431 2069 7320 6e6f 7420 4661  del_T1 is not Fa
-0004e710: 6c73 6520 3a0a 2020 2020 2020 2020 6869  lse :.        hi
-0004e720: 6572 666e 7465 7374 203d 2068 6965 7266  erfntest = hierf
-0004e730: 6e53 5220 2b20 276d 746c 2e63 7376 270a  nSR + 'mtl.csv'.
-0004e740: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-0004e750: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0004e760: 7072 696e 7428 2068 6965 7266 6e74 6573  print( hierfntes
-0004e770: 7420 290a 2020 2020 2020 2020 6869 6572  t ).        hier
-0004e780: 6578 6973 7473 203d 2065 7869 7374 7328  exists = exists(
-0004e790: 2068 6965 7266 6e74 6573 7420 2920 2320   hierfntest ) # 
-0004e7a0: 4649 584d 4520 7368 6f75 6c64 2074 6573  FIXME should tes
-0004e7b0: 7420 7468 6973 2065 7870 6c69 6369 746c  t this explicitl
-0004e7c0: 7920 6275 7420 7765 2061 7373 756d 6520  y but we assume 
-0004e7d0: 6974 2068 6572 650a 2020 2020 2020 2020  it here.        
-0004e7e0: 6966 206e 6f74 2068 6965 7265 7869 7374  if not hierexist
-0004e7f0: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
-0004e800: 7562 6a65 6374 7072 6f70 6174 6820 3d20  ubjectpropath = 
-0004e810: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
-0004e820: 2068 6965 7266 6e53 5220 290a 2020 2020   hierfnSR ).    
-0004e830: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-0004e840: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0004e850: 2020 2020 7072 696e 7428 2073 7562 6a65      print( subje
-0004e860: 6374 7072 6f70 6174 6820 290a 2020 2020  ctpropath ).    
-0004e870: 2020 2020 2020 2020 6f73 2e6d 616b 6564          os.maked
-0004e880: 6972 7328 2073 7562 6a65 6374 7072 6f70  irs( subjectprop
-0004e890: 6174 682c 2065 7869 7374 5f6f 6b3d 5472  ath, exist_ok=Tr
-0004e8a0: 7565 2020 290a 2020 2020 2020 2020 2020  ue  ).          
-0004e8b0: 2020 2320 6869 6572 6172 6368 6963 616c    # hierarchical
-0004e8c0: 5f74 6f5f 7372 2874 3168 6965 722c 2073  _to_sr(t1hier, s
-0004e8d0: 725f 6d6f 6465 6c2c 2074 6973 7375 655f  r_model, tissue_
-0004e8e0: 7372 3d46 616c 7365 2c20 626c 656e 6469  sr=False, blendi
-0004e8f0: 6e67 3d30 2e35 2c20 7665 7262 6f73 653d  ng=0.5, verbose=
-0004e900: 4661 6c73 6529 0a20 2020 2020 2020 2020  False).         
-0004e910: 2020 2062 6573 7475 7020 3d20 7369 712e     bestup = siq.
-0004e920: 6f70 7469 6d69 7a65 5f75 7073 616d 706c  optimize_upsampl
-0004e930: 696e 675f 7368 6170 6528 2061 6e74 732e  ing_shape( ants.
-0004e940: 6765 745f 7370 6163 696e 6728 7431 292c  get_spacing(t1),
-0004e950: 206d 6f64 616c 6974 793d 2754 3127 2029   modality='T1' )
-0004e960: 0a20 2020 2020 2020 2020 2020 206d 646c  .            mdl
-0004e970: 666e 203d 2065 785f 7061 7468 6d6d 202b  fn = ex_pathmm +
-0004e980: 2022 7369 715f 6465 6661 756c 745f 7369   "siq_default_si
-0004e990: 7372 5f22 202b 2062 6573 7475 7020 2b20  sr_" + bestup + 
-0004e9a0: 225f 3263 6861 6e5f 6665 6174 7667 674c  "_2chan_featvggL
-0004e9b0: 365f 706f 7374 7365 675f 6265 7374 5f6d  6_postseg_best_m
-0004e9c0: 646c 2e68 3522 0a20 2020 2020 2020 2020  dl.h5".         
-0004e9d0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0004e9e0: 2820 7372 6d6f 6465 6c5f 5431 2c20 7374  ( srmodel_T1, st
-0004e9f0: 7220 293a 0a20 2020 2020 2020 2020 2020  r ):.           
-0004ea00: 2020 2020 206d 646c 666e 203d 206f 732e       mdlfn = os.
-0004ea10: 7061 7468 2e6a 6f69 6e28 2065 785f 7061  path.join( ex_pa
-0004ea20: 7468 6d6d 2c20 7372 6d6f 6465 6c5f 5431  thmm, srmodel_T1
-0004ea30: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
-0004ea40: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-0004ea50: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0004ea60: 2820 6d64 6c66 6e20 290a 2020 2020 2020  ( mdlfn ).      
-0004ea70: 2020 2020 2020 6966 2065 7869 7374 7328        if exists(
-0004ea80: 206d 646c 666e 2029 3a0a 2020 2020 2020   mdlfn ):.      
-0004ea90: 2020 2020 2020 2020 2020 7372 6d6f 6465            srmode
-0004eaa0: 6c5f 5431 5f6d 646c 203d 2074 662e 6b65  l_T1_mdl = tf.ke
-0004eab0: 7261 732e 6d6f 6465 6c73 2e6c 6f61 645f  ras.models.load_
-0004eac0: 6d6f 6465 6c28 206d 646c 666e 2c20 636f  model( mdlfn, co
-0004ead0: 6d70 696c 653d 4661 6c73 6520 290a 2020  mpile=False ).  
-0004eae0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0004eaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004eb00: 7072 696e 7428 206d 646c 666e 202b 2022  print( mdlfn + "
-0004eb10: 2064 6f65 7320 6e6f 7420 6578 6973 7420   does not exist 
-0004eb20: 2d20 7769 6c6c 206e 6f74 2072 756e 2e22  - will not run."
-0004eb30: 290a 2020 2020 2020 2020 2020 2020 6869  ).            hi
-0004eb40: 6572 5352 203d 2061 6e74 7370 7974 3177  erSR = antspyt1w
-0004eb50: 2e68 6965 7261 7263 6869 6361 6c5f 746f  .hierarchical_to
-0004eb60: 5f73 7228 2068 6965 722c 2073 726d 6f64  _sr( hier, srmod
-0004eb70: 656c 5f54 315f 6d64 6c2c 2062 6c65 6e64  el_T1_mdl, blend
-0004eb80: 696e 673d 4e6f 6e65 2c20 7469 7373 7565  ing=None, tissue
-0004eb90: 5f73 723d 4661 6c73 6520 290a 2020 2020  _sr=False ).    
-0004eba0: 2020 2020 2020 2020 616e 7473 7079 7431          antspyt1
-0004ebb0: 772e 7772 6974 655f 6869 6572 6172 6368  w.write_hierarch
-0004ebc0: 6963 616c 2820 6869 6572 5352 2c20 6869  ical( hierSR, hi
-0004ebd0: 6572 666e 5352 2029 0a20 2020 2020 2020  erfnSR ).       
-0004ebe0: 2020 2020 2074 3177 6964 6553 5220 3d20       t1wideSR = 
-0004ebf0: 616e 7473 7079 7431 772e 6d65 7267 655f  antspyt1w.merge_
-0004ec00: 6869 6572 6172 6368 6963 616c 5f63 7376  hierarchical_csv
-0004ec10: 735f 746f 5f77 6964 655f 666f 726d 6174  s_to_wide_format
-0004ec20: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0004ec30: 2020 2020 2020 6869 6572 5352 5b27 6461        hierSR['da
-0004ec40: 7461 6672 616d 6573 275d 2c20 6964 656e  taframes'], iden
-0004ec50: 7469 6669 6572 3d4e 6f6e 6520 290a 2020  tifier=None ).  
-0004ec60: 2020 2020 2020 2020 2020 7431 7769 6465            t1wide
-0004ec70: 5352 2e74 6f5f 6373 7628 2068 6965 7266  SR.to_csv( hierf
-0004ec80: 6e53 5220 2b20 276d 6d77 6964 652e 6373  nSR + 'mmwide.cs
-0004ec90: 7627 2029 0a20 2020 2068 6965 7220 3d20  v' ).    hier = 
-0004eca0: 616e 7473 7079 7431 772e 7265 6164 5f68  antspyt1w.read_h
-0004ecb0: 6965 7261 7263 6869 6361 6c28 2068 6965  ierarchical( hie
-0004ecc0: 7266 6e20 290a 2020 2020 6966 2065 7869  rfn ).    if exi
-0004ecd0: 7374 7328 2068 6965 7266 6e20 2b20 276d  sts( hierfn + 'm
-0004ece0: 6d77 6964 652e 6373 7627 2029 203a 0a20  mwide.csv' ) :. 
-0004ecf0: 2020 2020 2020 2074 3177 6964 6520 3d20         t1wide = 
-0004ed00: 7064 2e72 6561 645f 6373 7628 2068 6965  pd.read_csv( hie
-0004ed10: 7266 6e20 2b20 276d 6d77 6964 652e 6373  rfn + 'mmwide.cs
-0004ed20: 7627 2029 0a20 2020 2065 6c69 6620 6e6f  v' ).    elif no
-0004ed30: 7420 7465 7374 6c6f 6f70 3a0a 2020 2020  t testloop:.    
-0004ed40: 2020 2020 7431 7769 6465 203d 2061 6e74      t1wide = ant
-0004ed50: 7370 7974 3177 2e6d 6572 6765 5f68 6965  spyt1w.merge_hie
-0004ed60: 7261 7263 6869 6361 6c5f 6373 7673 5f74  rarchical_csvs_t
-0004ed70: 6f5f 7769 6465 5f66 6f72 6d61 7428 0a20  o_wide_format(. 
-0004ed80: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-0004ed90: 6965 725b 2764 6174 6166 7261 6d65 7327  ier['dataframes'
-0004eda0: 5d2c 2069 6465 6e74 6966 6965 723d 4e6f  ], identifier=No
-0004edb0: 6e65 2029 0a20 2020 2069 6620 6e6f 7420  ne ).    if not 
-0004edc0: 7465 7374 6c6f 6f70 3a0a 2020 2020 2020  testloop:.      
-0004edd0: 2020 7431 696d 6762 726e 203d 2068 6965    t1imgbrn = hie
-0004ede0: 725b 2762 7261 696e 5f6e 345f 646e 7a27  r['brain_n4_dnz'
-0004edf0: 5d0a 2020 2020 2020 2020 7431 6174 726f  ].        t1atro
-0004ee00: 706f 7320 3d20 6869 6572 5b27 646b 745f  pos = hier['dkt_
-0004ee10: 7061 7263 275d 5b27 7469 7373 7565 5f73  parc']['tissue_s
-0004ee20: 6567 6d65 6e74 6174 696f 6e27 5d0a 0a20  egmentation'].. 
-0004ee30: 2020 2069 6620 6e6f 7420 6578 6973 7473     if not exists
-0004ee40: 2820 7265 676f 7574 202b 2022 6c6f 676a  ( regout + "logj
-0004ee50: 6163 6f62 6961 6e2e 6e69 692e 677a 2220  acobian.nii.gz" 
-0004ee60: 2920 6f72 206e 6f74 2065 7869 7374 7328  ) or not exists(
-0004ee70: 2072 6567 6f75 742b 2731 5761 7270 2e6e   regout+'1Warp.n
-0004ee80: 6969 2e67 7a27 2029 3a0a 2020 2020 2020  ii.gz' ):.      
-0004ee90: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-0004eea0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0004eeb0: 2773 7461 7274 2074 3120 7265 6769 7374  'start t1 regist
-0004eec0: 7261 7469 6f6e 2729 0a20 2020 2020 2020  ration').       
-0004eed0: 2065 785f 7061 7468 203d 206f 732e 7061   ex_path = os.pa
-0004eee0: 7468 2e65 7870 616e 6475 7365 7228 2022  th.expanduser( "
-0004eef0: 7e2f 2e61 6e74 7370 7974 3177 2f22 2029  ~/.antspyt1w/" )
-0004ef00: 0a20 2020 2020 2020 2074 656d 706c 6174  .        templat
-0004ef10: 6566 6e20 3d20 6578 5f70 6174 6820 2b20  efn = ex_path + 
-0004ef20: 2743 4954 3136 385f 5431 775f 3730 3075  'CIT168_T1w_700u
-0004ef30: 6d5f 7061 645f 6164 6e69 2e6e 6969 2e67  m_pad_adni.nii.g
-0004ef40: 7a27 0a20 2020 2020 2020 2074 656d 706c  z'.        templ
-0004ef50: 6174 6520 3d20 6d6d 5f72 6561 6428 2074  ate = mm_read( t
-0004ef60: 656d 706c 6174 6566 6e20 290a 2020 2020  emplatefn ).    
-0004ef70: 2020 2020 7465 6d70 6c61 7465 203d 2061      template = a
-0004ef80: 6e74 732e 7265 7361 6d70 6c65 5f69 6d61  nts.resample_ima
-0004ef90: 6765 2820 7465 6d70 6c61 7465 2c20 5b31  ge( template, [1
-0004efa0: 2c31 2c31 5d2c 2075 7365 5f76 6f78 656c  ,1,1], use_voxel
-0004efb0: 733d 4661 6c73 6520 290a 2020 2020 2020  s=False ).      
-0004efc0: 2020 7431 7265 6720 3d20 616e 7473 2e72    t1reg = ants.r
-0004efd0: 6567 6973 7472 6174 696f 6e28 2074 656d  egistration( tem
-0004efe0: 706c 6174 652c 200a 2020 2020 2020 2020  plate, .        
-0004eff0: 2020 2020 6869 6572 5b27 6272 6169 6e5f      hier['brain_
-0004f000: 6e34 5f64 6e7a 275d 2c0a 2020 2020 2020  n4_dnz'],.      
-0004f010: 2020 2020 2020 2261 6e74 7352 6567 6973        "antsRegis
-0004f020: 7472 6174 696f 6e53 794e 5175 6963 6b52  trationSyNQuickR
-0004f030: 6570 726f 5b73 5d22 2c20 6f75 7470 7265  epro[s]", outpre
-0004f040: 6669 7820 3d20 7265 676f 7574 2c20 7665  fix = regout, ve
-0004f050: 7262 6f73 653d 4661 6c73 6520 290a 2020  rbose=False ).  
-0004f060: 2020 2020 2020 6d79 6a61 6320 3d20 616e        myjac = an
-0004f070: 7473 2e63 7265 6174 655f 6a61 636f 6269  ts.create_jacobi
-0004f080: 616e 5f64 6574 6572 6d69 6e61 6e74 5f69  an_determinant_i
-0004f090: 6d61 6765 2820 7465 6d70 6c61 7465 2c0a  mage( template,.
-0004f0a0: 2020 2020 2020 2020 2020 2020 7431 7265              t1re
-0004f0b0: 675b 2766 7764 7472 616e 7366 6f72 6d73  g['fwdtransforms
-0004f0c0: 275d 5b30 5d2c 2064 6f5f 6c6f 673d 5472  '][0], do_log=Tr
-0004f0d0: 7565 2c20 6765 6f6d 3d54 7275 6520 290a  ue, geom=True ).
-0004f0e0: 2020 2020 2020 2020 696d 6167 655f 7772          image_wr
-0004f0f0: 6974 655f 7769 7468 5f74 6875 6d62 6e61  ite_with_thumbna
-0004f100: 696c 2820 6d79 6a61 632c 2072 6567 6f75  il( myjac, regou
-0004f110: 7420 2b20 226c 6f67 6a61 636f 6269 616e  t + "logjacobian
-0004f120: 2e6e 6969 2e67 7a22 2c20 7468 756d 623d  .nii.gz", thumb=
-0004f130: 4661 6c73 6520 290a 2020 2020 2020 2020  False ).        
-0004f140: 6966 2076 6973 7561 6c69 7a65 3a0a 2020  if visualize:.  
-0004f150: 2020 2020 2020 2020 2020 616e 7473 2e70            ants.p
-0004f160: 6c6f 7428 2061 6e74 732e 694d 6174 6828  lot( ants.iMath(
-0004f170: 7431 7265 675b 2777 6172 7065 646d 6f76  t1reg['warpedmov
-0004f180: 6f75 7427 5d2c 224e 6f72 6d61 6c69 7a65  out'],"Normalize
-0004f190: 2229 2c20 2061 7869 733d 322c 206e 736c  "),  axis=2, nsl
-0004f1a0: 6963 6573 3d32 312c 206e 636f 6c3d 372c  ices=21, ncol=7,
-0004f1b0: 2063 726f 703d 5472 7565 2c20 7469 746c   crop=True, titl
-0004f1c0: 653d 2777 6172 7065 6420 746f 2074 656d  e='warped to tem
-0004f1d0: 706c 6174 6527 2c20 6669 6c65 6e61 6d65  plate', filename
-0004f1e0: 3d72 6567 6f75 742b 2274 6f74 656d 706c  =regout+"totempl
-0004f1f0: 6174 652e 706e 6722 2029 0a20 2020 2020  ate.png" ).     
-0004f200: 2020 2020 2020 2061 6e74 732e 706c 6f74         ants.plot
-0004f210: 2820 616e 7473 2e69 4d61 7468 286d 796a  ( ants.iMath(myj
-0004f220: 6163 2c22 4e6f 726d 616c 697a 6522 292c  ac,"Normalize"),
-0004f230: 2020 6178 6973 3d32 2c20 6e73 6c69 6365    axis=2, nslice
-0004f240: 733d 3231 2c20 6e63 6f6c 3d37 2c20 6372  s=21, ncol=7, cr
-0004f250: 6f70 3d54 7275 652c 2074 6974 6c65 3d27  op=True, title='
-0004f260: 6a61 636f 6269 616e 272c 2066 696c 656e  jacobian', filen
-0004f270: 616d 653d 7265 676f 7574 2b22 6a61 636f  ame=regout+"jaco
-0004f280: 6269 616e 2e70 6e67 2220 290a 0a20 2020  bian.png" )..   
-0004f290: 2069 6620 6e6f 726d 616c 697a 6174 696f   if normalizatio
-0004f2a0: 6e5f 7465 6d70 6c61 7465 5f6f 7574 7075  n_template_outpu
-0004f2b0: 7420 6973 206e 6f74 204e 6f6e 6520 616e  t is not None an
-0004f2c0: 6420 6e6f 726d 616c 697a 6174 696f 6e5f  d normalization_
-0004f2d0: 7465 6d70 6c61 7465 2069 7320 6e6f 7420  template is not 
-0004f2e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
-0004f2f0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-0004f300: 2020 2020 2020 7072 696e 7428 2262 6567        print("beg
-0004f310: 696e 2067 726f 7570 2074 656d 706c 6174  in group templat
-0004f320: 6520 7265 6769 7374 7261 7469 6f6e 2229  e registration")
-0004f330: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0004f340: 6578 6973 7473 2820 6e6f 726d 6f75 742b  exists( normout+
-0004f350: 2730 4765 6e65 7269 6341 6666 696e 652e  '0GenericAffine.
-0004f360: 6d61 7427 2029 3a0a 2020 2020 2020 2020  mat' ):.        
-0004f370: 2020 2020 6966 206e 6f72 6d61 6c69 7a61      if normaliza
-0004f380: 7469 6f6e 5f74 656d 706c 6174 655f 7370  tion_template_sp
-0004f390: 6163 696e 6720 6973 206e 6f74 204e 6f6e  acing is not Non
-0004f3a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0004f3b0: 2020 206e 6f72 6d61 6c69 7a61 7469 6f6e     normalization
-0004f3c0: 5f74 656d 706c 6174 655f 7272 3d61 6e74  _template_rr=ant
-0004f3d0: 732e 7265 7361 6d70 6c65 5f69 6d61 6765  s.resample_image
-0004f3e0: 286e 6f72 6d61 6c69 7a61 7469 6f6e 5f74  (normalization_t
-0004f3f0: 656d 706c 6174 652c 6e6f 726d 616c 697a  emplate,normaliz
-0004f400: 6174 696f 6e5f 7465 6d70 6c61 7465 5f73  ation_template_s
-0004f410: 7061 6369 6e67 290a 2020 2020 2020 2020  pacing).        
-0004f420: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0004f430: 2020 2020 2020 2020 2020 6e6f 726d 616c            normal
-0004f440: 697a 6174 696f 6e5f 7465 6d70 6c61 7465  ization_template
-0004f450: 5f72 723d 6e6f 726d 616c 697a 6174 696f  _rr=normalizatio
-0004f460: 6e5f 7465 6d70 6c61 7465 0a20 2020 2020  n_template.     
-0004f470: 2020 2020 2020 2067 7265 6720 3d20 616e         greg = an
-0004f480: 7473 2e72 6567 6973 7472 6174 696f 6e28  ts.registration(
-0004f490: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-0004f4a0: 2020 6e6f 726d 616c 697a 6174 696f 6e5f    normalization_
-0004f4b0: 7465 6d70 6c61 7465 5f72 722c 200a 2020  template_rr, .  
-0004f4c0: 2020 2020 2020 2020 2020 2020 2020 6869                hi
-0004f4d0: 6572 5b27 6272 6169 6e5f 6e34 5f64 6e7a  er['brain_n4_dnz
-0004f4e0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-0004f4f0: 2020 2020 6e6f 726d 616c 697a 6174 696f      normalizatio
-0004f500: 6e5f 7465 6d70 6c61 7465 5f74 7261 6e73  n_template_trans
-0004f510: 666f 726d 5f74 7970 652c 0a20 2020 2020  form_type,.     
-0004f520: 2020 2020 2020 2020 2020 206f 7574 7072             outpr
-0004f530: 6566 6978 203d 206e 6f72 6d6f 7574 2c20  efix = normout, 
-0004f540: 7665 7262 6f73 653d 4661 6c73 6520 290a  verbose=False ).
-0004f550: 2020 2020 2020 2020 2020 2020 6d79 6a61              myja
-0004f560: 6320 3d20 616e 7473 2e63 7265 6174 655f  c = ants.create_
-0004f570: 6a61 636f 6269 616e 5f64 6574 6572 6d69  jacobian_determi
-0004f580: 6e61 6e74 5f69 6d61 6765 2820 7465 6d70  nant_image( temp
-0004f590: 6c61 7465 2c0a 2020 2020 2020 2020 2020  late,.          
-0004f5a0: 2020 2020 2020 2020 2020 6772 6567 5b27            greg['
-0004f5b0: 6677 6474 7261 6e73 666f 726d 7327 5d5b  fwdtransforms'][
-0004f5c0: 305d 2c20 646f 5f6c 6f67 3d54 7275 652c  0], do_log=True,
-0004f5d0: 2067 656f 6d3d 5472 7565 2029 0a20 2020   geom=True ).   
-0004f5e0: 2020 2020 2020 2020 2069 6d61 6765 5f77           image_w
-0004f5f0: 7269 7465 5f77 6974 685f 7468 756d 626e  rite_with_thumbn
-0004f600: 6169 6c28 206d 796a 6163 2c20 6e6f 726d  ail( myjac, norm
-0004f610: 6f75 7420 2b20 226c 6f67 6a61 636f 6269  out + "logjacobi
-0004f620: 616e 2e6e 6969 2e67 7a22 2c20 7468 756d  an.nii.gz", thum
-0004f630: 623d 4661 6c73 6520 290a 2020 2020 2020  b=False ).      
-0004f640: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-0004f650: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0004f660: 2020 7072 696e 7428 2265 6e64 2067 726f    print("end gro
-0004f670: 7570 2074 656d 706c 6174 6520 7265 6769  up template regi
-0004f680: 7374 7261 7469 6f6e 2229 0a20 2020 2020  stration").     
-0004f690: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0004f6a0: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-0004f6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004f6c0: 2070 7269 6e74 2822 6772 6f75 7020 7465   print("group te
-0004f6d0: 6d70 6c61 7465 2072 6567 6973 7472 6174  mplate registrat
-0004f6e0: 696f 6e20 616c 7265 6164 7920 646f 6e65  ion already done
-0004f6f0: 2229 0a0a 2020 2020 2320 6c6f 6f70 206f  ")..    # loop o
-0004f700: 7665 7220 6d6f 6461 6c69 7469 6573 2061  ver modalities a
-0004f710: 6e64 2074 6865 6e20 756e 6971 7565 2069  nd then unique i
-0004f720: 6d61 6765 2049 4473 0a20 2020 2023 2077  mage IDs.    # w
-0004f730: 6520 7472 6561 7420 4e4d 2069 6e20 6120  e treat NM in a 
-0004f740: 2273 7065 6369 616c 2220 7761 7920 2d2d  "special" way --
-0004f750: 2061 6767 7265 6761 7469 6e67 2072 6570   aggregating rep
-0004f760: 6561 7473 0a20 2020 2023 206f 7468 6572  eats.    # other
-0004f770: 206d 6f64 616c 6974 6965 7320 2862 6579   modalities (bey
-0004f780: 6f6e 6420 5431 2920 6172 6520 7472 6561  ond T1) are trea
-0004f790: 7465 6420 696e 6469 7669 6475 616c 6c79  ted individually
-0004f7a0: 0a20 2020 2066 6f72 206f 7665 726d 6f64  .    for overmod
-0004f7b0: 5820 696e 206e 7267 5f6d 6f64 616c 6974  X in nrg_modalit
-0004f7c0: 795f 6c69 7374 3a0a 2020 2020 2020 2020  y_list:.        
-0004f7d0: 2320 6465 6669 6e65 2031 2e20 696e 7075  # define 1. inpu
-0004f7e0: 7420 696d 6167 6573 2032 2e20 6f75 7470  t images 2. outp
-0004f7f0: 7574 2070 7265 6669 780a 2020 2020 2020  ut prefix.      
-0004f800: 2020 6d79 646f 6320 3d20 646f 6373 616d    mydoc = docsam
-0004f810: 736f 6e28 206f 7665 726d 6f64 582c 2073  son( overmodX, s
-0004f820: 7475 6479 6373 763d 7374 7564 7963 7376  tudycsv=studycsv
-0004f830: 2c20 6f75 7470 7574 6469 723d 6f75 7470  , outputdir=outp
-0004f840: 7574 6469 722c 2070 726f 6a69 643d 7072  utdir, projid=pr
-0004f850: 6f6a 6964 2c20 7369 643d 7369 642c 2064  ojid, sid=sid, d
-0004f860: 7469 643d 6474 6964 2c20 6d79 7365 703d  tid=dtid, mysep=
-0004f870: 6d79 7365 702c 7431 6969 643d 7431 6969  mysep,t1iid=t1ii
-0004f880: 6455 7365 2029 0a20 2020 2020 2020 206d  dUse ).        m
-0004f890: 7969 6d67 7372 203d 206d 7964 6f63 5b27  yimgsr = mydoc['
-0004f8a0: 696d 6167 6573 275d 0a20 2020 2020 2020  images'].       
-0004f8b0: 206d 796d 6d20 3d20 6d79 646f 635b 276f   mymm = mydoc['o
-0004f8c0: 7574 7072 6566 6978 275d 0a20 2020 2020  utprefix'].     
-0004f8d0: 2020 206d 796d 6f64 203d 206d 7964 6f63     mymod = mydoc
-0004f8e0: 5b27 6d6f 6461 6c69 7479 275d 0a20 2020  ['modality'].   
-0004f8f0: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-0004f900: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-0004f910: 6e74 2820 6d79 646f 6320 290a 2020 2020  nt( mydoc ).    
-0004f920: 2020 2020 6966 206c 656e 286d 7969 6d67      if len(myimg
-0004f930: 7372 2920 3e20 303a 0a20 2020 2020 2020  sr) > 0:.       
-0004f940: 2020 2020 2064 6f77 7269 7465 3d46 616c       dowrite=Fal
-0004f950: 7365 0a20 2020 2020 2020 2020 2020 2069  se.            i
-0004f960: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-0004f970: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0004f980: 2820 276f 7665 726d 6f64 5820 6973 203a  ( 'overmodX is :
-0004f990: 2027 202b 206f 7665 726d 6f64 5820 290a   ' + overmodX ).
-0004f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f9b0: 7072 696e 7428 2027 6578 616d 706c 6520  print( 'example 
-0004f9c0: 696d 6167 6520 6e61 6d65 2069 7320 3a20  image name is : 
-0004f9d0: 2720 2029 0a20 2020 2020 2020 2020 2020  '  ).           
-0004f9e0: 2020 2020 2070 7269 6e74 2820 6d79 696d       print( myim
-0004f9f0: 6773 7220 290a 2020 2020 2020 2020 2020  gsr ).          
-0004fa00: 2020 6966 206f 7665 726d 6f64 5820 3d3d    if overmodX ==
-0004fa10: 2027 4e4d 3244 4d54 273a 0a20 2020 2020   'NM2DMT':.     
-0004fa20: 2020 2020 2020 2020 2020 2073 7562 6a65             subje
-0004fa30: 6374 7072 6f70 6174 6820 3d20 6f73 2e70  ctpropath = os.p
-0004fa40: 6174 682e 6469 726e 616d 6528 206d 7964  ath.dirname( myd
-0004fa50: 6f63 5b27 6f75 7470 7265 6669 7827 5d20  oc['outprefix'] 
-0004fa60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0004fa70: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-0004fa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004fa90: 2020 7072 696e 7428 2273 7562 6a65 6374    print("subject
-0004faa0: 7072 6f70 6174 6820 6973 2229 0a20 2020  propath is").   
-0004fab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004fac0: 2070 7269 6e74 2873 7562 6a65 6374 7072   print(subjectpr
-0004fad0: 6f70 6174 6829 0a20 2020 2020 2020 2020  opath).         
-0004fae0: 2020 2020 2020 2020 2020 206f 732e 6d61             os.ma
-0004faf0: 6b65 6469 7273 2820 7375 626a 6563 7470  kedirs( subjectp
-0004fb00: 726f 7061 7468 2c20 6578 6973 745f 6f6b  ropath, exist_ok
-0004fb10: 3d54 7275 6520 2029 0a20 2020 2020 2020  =True  ).       
-0004fb20: 2020 2020 2020 2020 206d 7969 6d67 7372           myimgsr
-0004fb30: 3220 3d20 6d79 696d 6773 720a 2020 2020  2 = myimgsr.    
-0004fb40: 2020 2020 2020 2020 2020 2020 6d79 696d              myim
-0004fb50: 6773 7232 2e73 6f72 7428 290a 2020 2020  gsr2.sort().    
-0004fb60: 2020 2020 2020 2020 2020 2020 6973 3464              is4d
-0004fb70: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-0004fb80: 2020 2020 2020 2020 2074 656d 7020 3d20           temp = 
-0004fb90: 616e 7473 2e69 6d61 6765 5f72 6561 6428  ants.image_read(
-0004fba0: 206d 7969 6d67 7372 325b 305d 2029 0a20   myimgsr2[0] ). 
-0004fbb0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0004fbc0: 6620 7465 6d70 2e64 696d 656e 7369 6f6e  f temp.dimension
-0004fbd0: 203d 3d20 343a 0a20 2020 2020 2020 2020   == 4:.         
-0004fbe0: 2020 2020 2020 2020 2020 2069 7334 6420             is4d 
-0004fbf0: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-0004fc00: 2020 2020 2020 2069 6620 6c65 6e28 206d         if len( m
-0004fc10: 7969 6d67 7372 3220 2920 3d3d 2031 2061  yimgsr2 ) == 1 a
-0004fc20: 6e64 206e 6f74 2069 7334 643a 2023 2063  nd not is4d: # c
-0004fc30: 6865 636b 2064 696d 656e 7369 6f6e 0a20  heck dimension. 
-0004fc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004fc50: 2020 206d 7969 6d67 7372 3220 3d20 6d79     myimgsr2 = my
-0004fc60: 696d 6773 7232 202b 206d 7969 6d67 7372  imgsr2 + myimgsr
-0004fc70: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
-0004fc80: 2020 6d79 6d6d 6f75 7420 3d20 6d61 6b65    mymmout = make
-0004fc90: 7769 6465 6f75 7428 206d 796d 6d20 290a  wideout( mymm ).
-0004fca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004fcb0: 6966 2076 6572 626f 7365 2061 6e64 206e  if verbose and n
-0004fcc0: 6f74 2065 7869 7374 7328 206d 796d 6d6f  ot exists( mymmo
-0004fcd0: 7574 2029 3a0a 2020 2020 2020 2020 2020  ut ):.          
-0004fce0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0004fcf0: 2022 4e4d 2022 202b 206d 796d 6d20 202b   "NM " + mymm  +
-0004fd00: 2027 2065 7865 6375 7469 6f6e 2027 290a   ' execution ').
+0004e590: 280a 2020 2020 2020 2020 6869 6572 5b27  (.        hier['
+0004e5a0: 6461 7461 6672 616d 6573 275d 2c20 6964  dataframes'], id
+0004e5b0: 656e 7469 6669 6572 3d4e 6f6e 6520 290a  entifier=None ).
+0004e5c0: 2020 2020 7267 7261 6465 203d 2073 7472      rgrade = str
+0004e5d0: 2820 7431 7769 6465 5b27 7265 736e 6574  ( t1wide['resnet
+0004e5e0: 4772 6164 6527 5d2e 696c 6f63 5b30 5d20  Grade'].iloc[0] 
+0004e5f0: 290a 2020 2020 6966 2074 3177 6964 655b  ).    if t1wide[
+0004e600: 2772 6573 6e65 7447 7261 6465 275d 2e69  'resnetGrade'].i
+0004e610: 6c6f 635b 305d 203c 2030 2e32 303a 0a20  loc[0] < 0.20:. 
+0004e620: 2020 2020 2020 2077 6172 6e69 6e67 732e         warnings.
+0004e630: 7761 726e 2827 5431 7720 7175 616c 6974  warn('T1w qualit
+0004e640: 7920 6368 6563 6b20 696e 6469 6361 7465  y check indicate
+0004e650: 7320 6661 696c 7572 653a 2027 202b 2072  s failure: ' + r
+0004e660: 6772 6164 6520 2b20 2220 7769 6c6c 206e  grade + " will n
+0004e670: 6f74 2070 726f 6365 7373 2e22 2029 0a20  ot process." ). 
+0004e680: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+0004e690: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0004e6a0: 7072 696e 7428 2754 3177 2071 7561 6c69  print('T1w quali
+0004e6b0: 7479 2063 6865 636b 2069 6e64 6963 6174  ty check indicat
+0004e6c0: 6573 2073 7563 6365 7373 3a20 2720 2b20  es success: ' + 
+0004e6d0: 7267 7261 6465 202b 2022 2077 696c 6c20  rgrade + " will 
+0004e6e0: 7072 6f63 6573 732e 2220 290a 0a20 2020  process." )..   
+0004e6f0: 2069 6620 7372 6d6f 6465 6c5f 5431 2069   if srmodel_T1 i
+0004e700: 7320 6e6f 7420 4661 6c73 6520 3a0a 2020  s not False :.  
+0004e710: 2020 2020 2020 6869 6572 666e 7465 7374        hierfntest
+0004e720: 203d 2068 6965 7266 6e53 5220 2b20 276d   = hierfnSR + 'm
+0004e730: 746c 2e63 7376 270a 2020 2020 2020 2020  tl.csv'.        
+0004e740: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+0004e750: 2020 2020 2020 2020 7072 696e 7428 2068          print( h
+0004e760: 6965 7266 6e74 6573 7420 290a 2020 2020  ierfntest ).    
+0004e770: 2020 2020 6869 6572 6578 6973 7473 203d      hierexists =
+0004e780: 2065 7869 7374 7328 2068 6965 7266 6e74   exists( hierfnt
+0004e790: 6573 7420 2920 2320 4649 584d 4520 7368  est ) # FIXME sh
+0004e7a0: 6f75 6c64 2074 6573 7420 7468 6973 2065  ould test this e
+0004e7b0: 7870 6c69 6369 746c 7920 6275 7420 7765  xplicitly but we
+0004e7c0: 2061 7373 756d 6520 6974 2068 6572 650a   assume it here.
+0004e7d0: 2020 2020 2020 2020 6966 206e 6f74 2068          if not h
+0004e7e0: 6965 7265 7869 7374 733a 0a20 2020 2020  ierexists:.     
+0004e7f0: 2020 2020 2020 2073 7562 6a65 6374 7072         subjectpr
+0004e800: 6f70 6174 6820 3d20 6f73 2e70 6174 682e  opath = os.path.
+0004e810: 6469 726e 616d 6528 2068 6965 7266 6e53  dirname( hierfnS
+0004e820: 5220 290a 2020 2020 2020 2020 2020 2020  R ).            
+0004e830: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+0004e840: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0004e850: 7428 2073 7562 6a65 6374 7072 6f70 6174  t( subjectpropat
+0004e860: 6820 290a 2020 2020 2020 2020 2020 2020  h ).            
+0004e870: 6f73 2e6d 616b 6564 6972 7328 2073 7562  os.makedirs( sub
+0004e880: 6a65 6374 7072 6f70 6174 682c 2065 7869  jectpropath, exi
+0004e890: 7374 5f6f 6b3d 5472 7565 2020 290a 2020  st_ok=True  ).  
+0004e8a0: 2020 2020 2020 2020 2020 2320 6869 6572            # hier
+0004e8b0: 6172 6368 6963 616c 5f74 6f5f 7372 2874  archical_to_sr(t
+0004e8c0: 3168 6965 722c 2073 725f 6d6f 6465 6c2c  1hier, sr_model,
+0004e8d0: 2074 6973 7375 655f 7372 3d46 616c 7365   tissue_sr=False
+0004e8e0: 2c20 626c 656e 6469 6e67 3d30 2e35 2c20  , blending=0.5, 
+0004e8f0: 7665 7262 6f73 653d 4661 6c73 6529 0a20  verbose=False). 
+0004e900: 2020 2020 2020 2020 2020 2062 6573 7475             bestu
+0004e910: 7020 3d20 7369 712e 6f70 7469 6d69 7a65  p = siq.optimize
+0004e920: 5f75 7073 616d 706c 696e 675f 7368 6170  _upsampling_shap
+0004e930: 6528 2061 6e74 732e 6765 745f 7370 6163  e( ants.get_spac
+0004e940: 696e 6728 7431 292c 206d 6f64 616c 6974  ing(t1), modalit
+0004e950: 793d 2754 3127 2029 0a20 2020 2020 2020  y='T1' ).       
+0004e960: 2020 2020 206d 646c 666e 203d 2065 785f       mdlfn = ex_
+0004e970: 7061 7468 6d6d 202b 2022 7369 715f 6465  pathmm + "siq_de
+0004e980: 6661 756c 745f 7369 7372 5f22 202b 2062  fault_sisr_" + b
+0004e990: 6573 7475 7020 2b20 225f 3263 6861 6e5f  estup + "_2chan_
+0004e9a0: 6665 6174 7667 674c 365f 706f 7374 7365  featvggL6_postse
+0004e9b0: 675f 6265 7374 5f6d 646c 2e68 3522 0a20  g_best_mdl.h5". 
+0004e9c0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0004e9d0: 696e 7374 616e 6365 2820 7372 6d6f 6465  instance( srmode
+0004e9e0: 6c5f 5431 2c20 7374 7220 293a 0a20 2020  l_T1, str ):.   
+0004e9f0: 2020 2020 2020 2020 2020 2020 206d 646c               mdl
+0004ea00: 666e 203d 206f 732e 7061 7468 2e6a 6f69  fn = os.path.joi
+0004ea10: 6e28 2065 785f 7061 7468 6d6d 2c20 7372  n( ex_pathmm, sr
+0004ea20: 6d6f 6465 6c5f 5431 2029 0a20 2020 2020  model_T1 ).     
+0004ea30: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+0004ea40: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0004ea50: 2020 2070 7269 6e74 2820 6d64 6c66 6e20     print( mdlfn 
+0004ea60: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0004ea70: 2065 7869 7374 7328 206d 646c 666e 2029   exists( mdlfn )
+0004ea80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0004ea90: 2020 7372 6d6f 6465 6c5f 5431 5f6d 646c    srmodel_T1_mdl
+0004eaa0: 203d 2074 662e 6b65 7261 732e 6d6f 6465   = tf.keras.mode
+0004eab0: 6c73 2e6c 6f61 645f 6d6f 6465 6c28 206d  ls.load_model( m
+0004eac0: 646c 666e 2c20 636f 6d70 696c 653d 4661  dlfn, compile=Fa
+0004ead0: 6c73 6520 290a 2020 2020 2020 2020 2020  lse ).          
+0004eae0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0004eaf0: 2020 2020 2020 2020 7072 696e 7428 206d          print( m
+0004eb00: 646c 666e 202b 2022 2064 6f65 7320 6e6f  dlfn + " does no
+0004eb10: 7420 6578 6973 7420 2d20 7769 6c6c 206e  t exist - will n
+0004eb20: 6f74 2072 756e 2e22 290a 2020 2020 2020  ot run.").      
+0004eb30: 2020 2020 2020 6869 6572 5352 203d 2061        hierSR = a
+0004eb40: 6e74 7370 7974 3177 2e68 6965 7261 7263  ntspyt1w.hierarc
+0004eb50: 6869 6361 6c5f 746f 5f73 7228 2068 6965  hical_to_sr( hie
+0004eb60: 722c 2073 726d 6f64 656c 5f54 315f 6d64  r, srmodel_T1_md
+0004eb70: 6c2c 2062 6c65 6e64 696e 673d 4e6f 6e65  l, blending=None
+0004eb80: 2c20 7469 7373 7565 5f73 723d 4661 6c73  , tissue_sr=Fals
+0004eb90: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
+0004eba0: 616e 7473 7079 7431 772e 7772 6974 655f  antspyt1w.write_
+0004ebb0: 6869 6572 6172 6368 6963 616c 2820 6869  hierarchical( hi
+0004ebc0: 6572 5352 2c20 6869 6572 666e 5352 2029  erSR, hierfnSR )
+0004ebd0: 0a20 2020 2020 2020 2020 2020 2074 3177  .            t1w
+0004ebe0: 6964 6553 5220 3d20 616e 7473 7079 7431  ideSR = antspyt1
+0004ebf0: 772e 6d65 7267 655f 6869 6572 6172 6368  w.merge_hierarch
+0004ec00: 6963 616c 5f63 7376 735f 746f 5f77 6964  ical_csvs_to_wid
+0004ec10: 655f 666f 726d 6174 280a 2020 2020 2020  e_format(.      
+0004ec20: 2020 2020 2020 2020 2020 2020 2020 6869                hi
+0004ec30: 6572 5352 5b27 6461 7461 6672 616d 6573  erSR['dataframes
+0004ec40: 275d 2c20 6964 656e 7469 6669 6572 3d4e  '], identifier=N
+0004ec50: 6f6e 6520 290a 2020 2020 2020 2020 2020  one ).          
+0004ec60: 2020 7431 7769 6465 5352 2e74 6f5f 6373    t1wideSR.to_cs
+0004ec70: 7628 2068 6965 7266 6e53 5220 2b20 276d  v( hierfnSR + 'm
+0004ec80: 6d77 6964 652e 6373 7627 2029 0a20 2020  mwide.csv' ).   
+0004ec90: 2068 6965 7220 3d20 616e 7473 7079 7431   hier = antspyt1
+0004eca0: 772e 7265 6164 5f68 6965 7261 7263 6869  w.read_hierarchi
+0004ecb0: 6361 6c28 2068 6965 7266 6e20 290a 2020  cal( hierfn ).  
+0004ecc0: 2020 6966 2065 7869 7374 7328 2068 6965    if exists( hie
+0004ecd0: 7266 6e20 2b20 276d 6d77 6964 652e 6373  rfn + 'mmwide.cs
+0004ece0: 7627 2029 203a 0a20 2020 2020 2020 2074  v' ) :.        t
+0004ecf0: 3177 6964 6520 3d20 7064 2e72 6561 645f  1wide = pd.read_
+0004ed00: 6373 7628 2068 6965 7266 6e20 2b20 276d  csv( hierfn + 'm
+0004ed10: 6d77 6964 652e 6373 7627 2029 0a20 2020  mwide.csv' ).   
+0004ed20: 2065 6c69 6620 6e6f 7420 7465 7374 6c6f   elif not testlo
+0004ed30: 6f70 3a0a 2020 2020 2020 2020 7431 7769  op:.        t1wi
+0004ed40: 6465 203d 2061 6e74 7370 7974 3177 2e6d  de = antspyt1w.m
+0004ed50: 6572 6765 5f68 6965 7261 7263 6869 6361  erge_hierarchica
+0004ed60: 6c5f 6373 7673 5f74 6f5f 7769 6465 5f66  l_csvs_to_wide_f
+0004ed70: 6f72 6d61 7428 0a20 2020 2020 2020 2020  ormat(.         
+0004ed80: 2020 2020 2020 2068 6965 725b 2764 6174         hier['dat
+0004ed90: 6166 7261 6d65 7327 5d2c 2069 6465 6e74  aframes'], ident
+0004eda0: 6966 6965 723d 4e6f 6e65 2029 0a20 2020  ifier=None ).   
+0004edb0: 2069 6620 6e6f 7420 7465 7374 6c6f 6f70   if not testloop
+0004edc0: 3a0a 2020 2020 2020 2020 7431 696d 6762  :.        t1imgb
+0004edd0: 726e 203d 2068 6965 725b 2762 7261 696e  rn = hier['brain
+0004ede0: 5f6e 345f 646e 7a27 5d0a 2020 2020 2020  _n4_dnz'].      
+0004edf0: 2020 7431 6174 726f 706f 7320 3d20 6869    t1atropos = hi
+0004ee00: 6572 5b27 646b 745f 7061 7263 275d 5b27  er['dkt_parc']['
+0004ee10: 7469 7373 7565 5f73 6567 6d65 6e74 6174  tissue_segmentat
+0004ee20: 696f 6e27 5d0a 0a20 2020 2069 6620 6e6f  ion']..    if no
+0004ee30: 7420 6578 6973 7473 2820 7265 676f 7574  t exists( regout
+0004ee40: 202b 2022 6c6f 676a 6163 6f62 6961 6e2e   + "logjacobian.
+0004ee50: 6e69 692e 677a 2220 2920 6f72 206e 6f74  nii.gz" ) or not
+0004ee60: 2065 7869 7374 7328 2072 6567 6f75 742b   exists( regout+
+0004ee70: 2731 5761 7270 2e6e 6969 2e67 7a27 2029  '1Warp.nii.gz' )
+0004ee80: 3a0a 2020 2020 2020 2020 6966 2076 6572  :.        if ver
+0004ee90: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+0004eea0: 2020 7072 696e 7428 2773 7461 7274 2074    print('start t
+0004eeb0: 3120 7265 6769 7374 7261 7469 6f6e 2729  1 registration')
+0004eec0: 0a20 2020 2020 2020 2065 785f 7061 7468  .        ex_path
+0004eed0: 203d 206f 732e 7061 7468 2e65 7870 616e   = os.path.expan
+0004eee0: 6475 7365 7228 2022 7e2f 2e61 6e74 7370  duser( "~/.antsp
+0004eef0: 7974 3177 2f22 2029 0a20 2020 2020 2020  yt1w/" ).       
+0004ef00: 2074 656d 706c 6174 6566 6e20 3d20 6578   templatefn = ex
+0004ef10: 5f70 6174 6820 2b20 2743 4954 3136 385f  _path + 'CIT168_
+0004ef20: 5431 775f 3730 3075 6d5f 7061 645f 6164  T1w_700um_pad_ad
+0004ef30: 6e69 2e6e 6969 2e67 7a27 0a20 2020 2020  ni.nii.gz'.     
+0004ef40: 2020 2074 656d 706c 6174 6520 3d20 6d6d     template = mm
+0004ef50: 5f72 6561 6428 2074 656d 706c 6174 6566  _read( templatef
+0004ef60: 6e20 290a 2020 2020 2020 2020 7465 6d70  n ).        temp
+0004ef70: 6c61 7465 203d 2061 6e74 732e 7265 7361  late = ants.resa
+0004ef80: 6d70 6c65 5f69 6d61 6765 2820 7465 6d70  mple_image( temp
+0004ef90: 6c61 7465 2c20 5b31 2c31 2c31 5d2c 2075  late, [1,1,1], u
+0004efa0: 7365 5f76 6f78 656c 733d 4661 6c73 6520  se_voxels=False 
+0004efb0: 290a 2020 2020 2020 2020 7431 7265 6720  ).        t1reg 
+0004efc0: 3d20 616e 7473 2e72 6567 6973 7472 6174  = ants.registrat
+0004efd0: 696f 6e28 2074 656d 706c 6174 652c 200a  ion( template, .
+0004efe0: 2020 2020 2020 2020 2020 2020 6869 6572              hier
+0004eff0: 5b27 6272 6169 6e5f 6e34 5f64 6e7a 275d  ['brain_n4_dnz']
+0004f000: 2c0a 2020 2020 2020 2020 2020 2020 2261  ,.            "a
+0004f010: 6e74 7352 6567 6973 7472 6174 696f 6e53  ntsRegistrationS
+0004f020: 794e 5175 6963 6b52 6570 726f 5b73 5d22  yNQuickRepro[s]"
+0004f030: 2c20 6f75 7470 7265 6669 7820 3d20 7265  , outprefix = re
+0004f040: 676f 7574 2c20 7665 7262 6f73 653d 4661  gout, verbose=Fa
+0004f050: 6c73 6520 290a 2020 2020 2020 2020 6d79  lse ).        my
+0004f060: 6a61 6320 3d20 616e 7473 2e63 7265 6174  jac = ants.creat
+0004f070: 655f 6a61 636f 6269 616e 5f64 6574 6572  e_jacobian_deter
+0004f080: 6d69 6e61 6e74 5f69 6d61 6765 2820 7465  minant_image( te
+0004f090: 6d70 6c61 7465 2c0a 2020 2020 2020 2020  mplate,.        
+0004f0a0: 2020 2020 7431 7265 675b 2766 7764 7472      t1reg['fwdtr
+0004f0b0: 616e 7366 6f72 6d73 275d 5b30 5d2c 2064  ansforms'][0], d
+0004f0c0: 6f5f 6c6f 673d 5472 7565 2c20 6765 6f6d  o_log=True, geom
+0004f0d0: 3d54 7275 6520 290a 2020 2020 2020 2020  =True ).        
+0004f0e0: 696d 6167 655f 7772 6974 655f 7769 7468  image_write_with
+0004f0f0: 5f74 6875 6d62 6e61 696c 2820 6d79 6a61  _thumbnail( myja
+0004f100: 632c 2072 6567 6f75 7420 2b20 226c 6f67  c, regout + "log
+0004f110: 6a61 636f 6269 616e 2e6e 6969 2e67 7a22  jacobian.nii.gz"
+0004f120: 2c20 7468 756d 623d 4661 6c73 6520 290a  , thumb=False ).
+0004f130: 2020 2020 2020 2020 6966 2076 6973 7561          if visua
+0004f140: 6c69 7a65 3a0a 2020 2020 2020 2020 2020  lize:.          
+0004f150: 2020 616e 7473 2e70 6c6f 7428 2061 6e74    ants.plot( ant
+0004f160: 732e 694d 6174 6828 7431 7265 675b 2777  s.iMath(t1reg['w
+0004f170: 6172 7065 646d 6f76 6f75 7427 5d2c 224e  arpedmovout'],"N
+0004f180: 6f72 6d61 6c69 7a65 2229 2c20 2061 7869  ormalize"),  axi
+0004f190: 733d 322c 206e 736c 6963 6573 3d32 312c  s=2, nslices=21,
+0004f1a0: 206e 636f 6c3d 372c 2063 726f 703d 5472   ncol=7, crop=Tr
+0004f1b0: 7565 2c20 7469 746c 653d 2777 6172 7065  ue, title='warpe
+0004f1c0: 6420 746f 2074 656d 706c 6174 6527 2c20  d to template', 
+0004f1d0: 6669 6c65 6e61 6d65 3d72 6567 6f75 742b  filename=regout+
+0004f1e0: 2274 6f74 656d 706c 6174 652e 706e 6722  "totemplate.png"
+0004f1f0: 2029 0a20 2020 2020 2020 2020 2020 2061   ).            a
+0004f200: 6e74 732e 706c 6f74 2820 616e 7473 2e69  nts.plot( ants.i
+0004f210: 4d61 7468 286d 796a 6163 2c22 4e6f 726d  Math(myjac,"Norm
+0004f220: 616c 697a 6522 292c 2020 6178 6973 3d32  alize"),  axis=2
+0004f230: 2c20 6e73 6c69 6365 733d 3231 2c20 6e63  , nslices=21, nc
+0004f240: 6f6c 3d37 2c20 6372 6f70 3d54 7275 652c  ol=7, crop=True,
+0004f250: 2074 6974 6c65 3d27 6a61 636f 6269 616e   title='jacobian
+0004f260: 272c 2066 696c 656e 616d 653d 7265 676f  ', filename=rego
+0004f270: 7574 2b22 6a61 636f 6269 616e 2e70 6e67  ut+"jacobian.png
+0004f280: 2220 290a 0a20 2020 2069 6620 6e6f 726d  " )..    if norm
+0004f290: 616c 697a 6174 696f 6e5f 7465 6d70 6c61  alization_templa
+0004f2a0: 7465 5f6f 7574 7075 7420 6973 206e 6f74  te_output is not
+0004f2b0: 204e 6f6e 6520 616e 6420 6e6f 726d 616c   None and normal
+0004f2c0: 697a 6174 696f 6e5f 7465 6d70 6c61 7465  ization_template
+0004f2d0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0004f2e0: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
+0004f2f0: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+0004f300: 696e 7428 2262 6567 696e 2067 726f 7570  int("begin group
+0004f310: 2074 656d 706c 6174 6520 7265 6769 7374   template regist
+0004f320: 7261 7469 6f6e 2229 0a20 2020 2020 2020  ration").       
+0004f330: 2069 6620 6e6f 7420 6578 6973 7473 2820   if not exists( 
+0004f340: 6e6f 726d 6f75 742b 2730 4765 6e65 7269  normout+'0Generi
+0004f350: 6341 6666 696e 652e 6d61 7427 2029 3a0a  cAffine.mat' ):.
+0004f360: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0004f370: 6f72 6d61 6c69 7a61 7469 6f6e 5f74 656d  ormalization_tem
+0004f380: 706c 6174 655f 7370 6163 696e 6720 6973  plate_spacing is
+0004f390: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0004f3a0: 2020 2020 2020 2020 2020 206e 6f72 6d61             norma
+0004f3b0: 6c69 7a61 7469 6f6e 5f74 656d 706c 6174  lization_templat
+0004f3c0: 655f 7272 3d61 6e74 732e 7265 7361 6d70  e_rr=ants.resamp
+0004f3d0: 6c65 5f69 6d61 6765 286e 6f72 6d61 6c69  le_image(normali
+0004f3e0: 7a61 7469 6f6e 5f74 656d 706c 6174 652c  zation_template,
+0004f3f0: 6e6f 726d 616c 697a 6174 696f 6e5f 7465  normalization_te
+0004f400: 6d70 6c61 7465 5f73 7061 6369 6e67 290a  mplate_spacing).
+0004f410: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0004f420: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0004f430: 2020 6e6f 726d 616c 697a 6174 696f 6e5f    normalization_
+0004f440: 7465 6d70 6c61 7465 5f72 723d 6e6f 726d  template_rr=norm
+0004f450: 616c 697a 6174 696f 6e5f 7465 6d70 6c61  alization_templa
+0004f460: 7465 0a20 2020 2020 2020 2020 2020 2067  te.            g
+0004f470: 7265 6720 3d20 616e 7473 2e72 6567 6973  reg = ants.regis
+0004f480: 7472 6174 696f 6e28 200a 2020 2020 2020  tration( .      
+0004f490: 2020 2020 2020 2020 2020 6e6f 726d 616c            normal
+0004f4a0: 697a 6174 696f 6e5f 7465 6d70 6c61 7465  ization_template
+0004f4b0: 5f72 722c 200a 2020 2020 2020 2020 2020  _rr, .          
+0004f4c0: 2020 2020 2020 6869 6572 5b27 6272 6169        hier['brai
+0004f4d0: 6e5f 6e34 5f64 6e7a 275d 2c0a 2020 2020  n_n4_dnz'],.    
+0004f4e0: 2020 2020 2020 2020 2020 2020 6e6f 726d              norm
+0004f4f0: 616c 697a 6174 696f 6e5f 7465 6d70 6c61  alization_templa
+0004f500: 7465 5f74 7261 6e73 666f 726d 5f74 7970  te_transform_typ
+0004f510: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0004f520: 2020 206f 7574 7072 6566 6978 203d 206e     outprefix = n
+0004f530: 6f72 6d6f 7574 2c20 7665 7262 6f73 653d  ormout, verbose=
+0004f540: 4661 6c73 6520 290a 2020 2020 2020 2020  False ).        
+0004f550: 2020 2020 6d79 6a61 6320 3d20 616e 7473      myjac = ants
+0004f560: 2e63 7265 6174 655f 6a61 636f 6269 616e  .create_jacobian
+0004f570: 5f64 6574 6572 6d69 6e61 6e74 5f69 6d61  _determinant_ima
+0004f580: 6765 2820 7465 6d70 6c61 7465 2c0a 2020  ge( template,.  
+0004f590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f5a0: 2020 6772 6567 5b27 6677 6474 7261 6e73    greg['fwdtrans
+0004f5b0: 666f 726d 7327 5d5b 305d 2c20 646f 5f6c  forms'][0], do_l
+0004f5c0: 6f67 3d54 7275 652c 2067 656f 6d3d 5472  og=True, geom=Tr
+0004f5d0: 7565 2029 0a20 2020 2020 2020 2020 2020  ue ).           
+0004f5e0: 2069 6d61 6765 5f77 7269 7465 5f77 6974   image_write_wit
+0004f5f0: 685f 7468 756d 626e 6169 6c28 206d 796a  h_thumbnail( myj
+0004f600: 6163 2c20 6e6f 726d 6f75 7420 2b20 226c  ac, normout + "l
+0004f610: 6f67 6a61 636f 6269 616e 2e6e 6969 2e67  ogjacobian.nii.g
+0004f620: 7a22 2c20 7468 756d 623d 4661 6c73 6520  z", thumb=False 
+0004f630: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0004f640: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+0004f650: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0004f660: 2265 6e64 2067 726f 7570 2074 656d 706c  "end group templ
+0004f670: 6174 6520 7265 6769 7374 7261 7469 6f6e  ate registration
+0004f680: 2229 0a20 2020 2020 2020 2065 6c73 653a  ").        else:
+0004f690: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0004f6a0: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+0004f6b0: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+0004f6c0: 6772 6f75 7020 7465 6d70 6c61 7465 2072  group template r
+0004f6d0: 6567 6973 7472 6174 696f 6e20 616c 7265  egistration alre
+0004f6e0: 6164 7920 646f 6e65 2229 0a0a 2020 2020  ady done")..    
+0004f6f0: 2320 6c6f 6f70 206f 7665 7220 6d6f 6461  # loop over moda
+0004f700: 6c69 7469 6573 2061 6e64 2074 6865 6e20  lities and then 
+0004f710: 756e 6971 7565 2069 6d61 6765 2049 4473  unique image IDs
+0004f720: 0a20 2020 2023 2077 6520 7472 6561 7420  .    # we treat 
+0004f730: 4e4d 2069 6e20 6120 2273 7065 6369 616c  NM in a "special
+0004f740: 2220 7761 7920 2d2d 2061 6767 7265 6761  " way -- aggrega
+0004f750: 7469 6e67 2072 6570 6561 7473 0a20 2020  ting repeats.   
+0004f760: 2023 206f 7468 6572 206d 6f64 616c 6974   # other modalit
+0004f770: 6965 7320 2862 6579 6f6e 6420 5431 2920  ies (beyond T1) 
+0004f780: 6172 6520 7472 6561 7465 6420 696e 6469  are treated indi
+0004f790: 7669 6475 616c 6c79 0a20 2020 2066 6f72  vidually.    for
+0004f7a0: 206f 7665 726d 6f64 5820 696e 206e 7267   overmodX in nrg
+0004f7b0: 5f6d 6f64 616c 6974 795f 6c69 7374 3a0a  _modality_list:.
+0004f7c0: 2020 2020 2020 2020 2320 6465 6669 6e65          # define
+0004f7d0: 2031 2e20 696e 7075 7420 696d 6167 6573   1. input images
+0004f7e0: 2032 2e20 6f75 7470 7574 2070 7265 6669   2. output prefi
+0004f7f0: 780a 2020 2020 2020 2020 6d79 646f 6320  x.        mydoc 
+0004f800: 3d20 646f 6373 616d 736f 6e28 206f 7665  = docsamson( ove
+0004f810: 726d 6f64 582c 2073 7475 6479 6373 763d  rmodX, studycsv=
+0004f820: 7374 7564 7963 7376 2c20 6f75 7470 7574  studycsv, output
+0004f830: 6469 723d 6f75 7470 7574 6469 722c 2070  dir=outputdir, p
+0004f840: 726f 6a69 643d 7072 6f6a 6964 2c20 7369  rojid=projid, si
+0004f850: 643d 7369 642c 2064 7469 643d 6474 6964  d=sid, dtid=dtid
+0004f860: 2c20 6d79 7365 703d 6d79 7365 702c 7431  , mysep=mysep,t1
+0004f870: 6969 643d 7431 6969 6455 7365 2029 0a20  iid=t1iidUse ). 
+0004f880: 2020 2020 2020 206d 7969 6d67 7372 203d         myimgsr =
+0004f890: 206d 7964 6f63 5b27 696d 6167 6573 275d   mydoc['images']
+0004f8a0: 0a20 2020 2020 2020 206d 796d 6d20 3d20  .        mymm = 
+0004f8b0: 6d79 646f 635b 276f 7574 7072 6566 6978  mydoc['outprefix
+0004f8c0: 275d 0a20 2020 2020 2020 206d 796d 6f64  '].        mymod
+0004f8d0: 203d 206d 7964 6f63 5b27 6d6f 6461 6c69   = mydoc['modali
+0004f8e0: 7479 275d 0a20 2020 2020 2020 2069 6620  ty'].        if 
+0004f8f0: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+0004f900: 2020 2020 2070 7269 6e74 2820 6d79 646f       print( mydo
+0004f910: 6320 290a 2020 2020 2020 2020 6966 206c  c ).        if l
+0004f920: 656e 286d 7969 6d67 7372 2920 3e20 303a  en(myimgsr) > 0:
+0004f930: 0a20 2020 2020 2020 2020 2020 2064 6f77  .            dow
+0004f940: 7269 7465 3d46 616c 7365 0a20 2020 2020  rite=False.     
+0004f950: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+0004f960: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0004f970: 2020 2070 7269 6e74 2820 276f 7665 726d     print( 'overm
+0004f980: 6f64 5820 6973 203a 2027 202b 206f 7665  odX is : ' + ove
+0004f990: 726d 6f64 5820 290a 2020 2020 2020 2020  rmodX ).        
+0004f9a0: 2020 2020 2020 2020 7072 696e 7428 2027          print( '
+0004f9b0: 6578 616d 706c 6520 696d 6167 6520 6e61  example image na
+0004f9c0: 6d65 2069 7320 3a20 2720 2029 0a20 2020  me is : '  ).   
+0004f9d0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0004f9e0: 6e74 2820 6d79 696d 6773 7220 290a 2020  nt( myimgsr ).  
+0004f9f0: 2020 2020 2020 2020 2020 6966 206f 7665            if ove
+0004fa00: 726d 6f64 5820 3d3d 2027 4e4d 3244 4d54  rmodX == 'NM2DMT
+0004fa10: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+0004fa20: 2020 2064 6f77 7269 7465 203d 2054 7275     dowrite = Tru
+0004fa30: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0004fa40: 2020 7669 7375 616c 697a 6520 3d20 5472    visualize = Tr
+0004fa50: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+0004fa60: 2020 2073 7562 6a65 6374 7072 6f70 6174     subjectpropat
+0004fa70: 6820 3d20 6f73 2e70 6174 682e 6469 726e  h = os.path.dirn
+0004fa80: 616d 6528 206d 7964 6f63 5b27 6f75 7470  ame( mydoc['outp
+0004fa90: 7265 6669 7827 5d20 290a 2020 2020 2020  refix'] ).      
+0004faa0: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+0004fab0: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+0004fac0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0004fad0: 2273 7562 6a65 6374 7072 6f70 6174 6820  "subjectpropath 
+0004fae0: 6973 2229 0a20 2020 2020 2020 2020 2020  is").           
+0004faf0: 2020 2020 2020 2020 2070 7269 6e74 2873           print(s
+0004fb00: 7562 6a65 6374 7072 6f70 6174 6829 0a20  ubjectpropath). 
+0004fb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fb20: 2020 206f 732e 6d61 6b65 6469 7273 2820     os.makedirs( 
+0004fb30: 7375 626a 6563 7470 726f 7061 7468 2c20  subjectpropath, 
+0004fb40: 6578 6973 745f 6f6b 3d54 7275 6520 2029  exist_ok=True  )
+0004fb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004fb60: 206d 7969 6d67 7372 3220 3d20 6d79 696d   myimgsr2 = myim
+0004fb70: 6773 720a 2020 2020 2020 2020 2020 2020  gsr.            
+0004fb80: 2020 2020 6d79 696d 6773 7232 2e73 6f72      myimgsr2.sor
+0004fb90: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+0004fba0: 2020 2020 6973 3464 203d 2046 616c 7365      is4d = False
+0004fbb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004fbc0: 2074 656d 7020 3d20 616e 7473 2e69 6d61   temp = ants.ima
+0004fbd0: 6765 5f72 6561 6428 206d 7969 6d67 7372  ge_read( myimgsr
+0004fbe0: 325b 305d 2029 0a20 2020 2020 2020 2020  2[0] ).         
+0004fbf0: 2020 2020 2020 2069 6620 7465 6d70 2e64         if temp.d
+0004fc00: 696d 656e 7369 6f6e 203d 3d20 343a 0a20  imension == 4:. 
+0004fc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fc20: 2020 2069 7334 6420 3d20 5472 7565 0a20     is4d = True. 
+0004fc30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0004fc40: 6620 6c65 6e28 206d 7969 6d67 7372 3220  f len( myimgsr2 
+0004fc50: 2920 3d3d 2031 2061 6e64 206e 6f74 2069  ) == 1 and not i
+0004fc60: 7334 643a 2023 2063 6865 636b 2064 696d  s4d: # check dim
+0004fc70: 656e 7369 6f6e 0a20 2020 2020 2020 2020  ension.         
+0004fc80: 2020 2020 2020 2020 2020 206d 7969 6d67             myimg
+0004fc90: 7372 3220 3d20 6d79 696d 6773 7232 202b  sr2 = myimgsr2 +
+0004fca0: 206d 7969 6d67 7372 320a 2020 2020 2020   myimgsr2.      
+0004fcb0: 2020 2020 2020 2020 2020 6d79 6d6d 6f75            mymmou
+0004fcc0: 7420 3d20 6d61 6b65 7769 6465 6f75 7428  t = makewideout(
+0004fcd0: 206d 796d 6d20 290a 2020 2020 2020 2020   mymm ).        
+0004fce0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+0004fcf0: 7365 2061 6e64 206e 6f74 2065 7869 7374  se and not exist
+0004fd00: 7328 206d 796d 6d6f 7574 2029 3a0a 2020  s( mymmout ):.  
 0004fd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004fd20: 656c 6966 2076 6572 626f 7365 2061 6e64  elif verbose and
-0004fd30: 2065 7869 7374 7328 206d 796d 6d6f 7574   exists( mymmout
-0004fd40: 2029 203a 0a20 2020 2020 2020 2020 2020   ) :.           
-0004fd50: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
-0004fd60: 224e 4d20 2220 2b20 6d79 6d6d 202b 2027  "NM " + mymm + '
-0004fd70: 2063 6f6d 706c 6574 6520 2720 290a 2020   complete ' ).  
-0004fd80: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0004fd90: 2065 7869 7374 7328 206d 796d 6d6f 7574   exists( mymmout
-0004fda0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-0004fdb0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-0004fdc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004fdd0: 2069 6620 6973 3464 3a0a 2020 2020 2020   if is4d:.      
-0004fde0: 2020 2020 2020 2020 2020 2020 2020 6e6d                nm
-0004fdf0: 6c69 7374 203d 2061 6e74 732e 6e64 696d  list = ants.ndim
-0004fe00: 6167 655f 746f 5f6c 6973 7428 206d 6d5f  age_to_list( mm_
-0004fe10: 7265 6164 2820 6d79 696d 6773 7232 5b30  read( myimgsr2[0
-0004fe20: 5d20 2920 290a 2020 2020 2020 2020 2020  ] ) ).          
-0004fe30: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0004fe40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004fe50: 6e6d 6c69 7374 203d 205b 5d0a 2020 2020  nmlist = [].    
-0004fe60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004fe70: 666f 7220 7a7a 2069 6e20 6d79 696d 6773  for zz in myimgs
-0004fe80: 7232 3a0a 2020 2020 2020 2020 2020 2020  r2:.            
-0004fe90: 2020 2020 2020 2020 2020 2020 6e6d 6c69              nmli
-0004fea0: 7374 2e61 7070 656e 6428 206d 6d5f 7265  st.append( mm_re
-0004feb0: 6164 2820 7a7a 2029 2029 0a20 2020 2020  ad( zz ) ).     
-0004fec0: 2020 2020 2020 2020 2020 2073 726d 6f64             srmod
-0004fed0: 656c 5f4e 4d5f 6d64 6c20 3d20 4e6f 6e65  el_NM_mdl = None
-0004fee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004fef0: 2069 6620 7372 6d6f 6465 6c5f 4e4d 2069   if srmodel_NM i
-0004ff00: 7320 6e6f 7420 4661 6c73 653a 0a20 2020  s not False:.   
-0004ff10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ff20: 2062 6573 7475 7020 3d20 7369 712e 6f70   bestup = siq.op
-0004ff30: 7469 6d69 7a65 5f75 7073 616d 706c 696e  timize_upsamplin
-0004ff40: 675f 7368 6170 6528 2061 6e74 732e 6765  g_shape( ants.ge
-0004ff50: 745f 7370 6163 696e 6728 6e6d 6c69 7374  t_spacing(nmlist
-0004ff60: 5b30 5d29 2c20 6d6f 6461 6c69 7479 3d27  [0]), modality='
-0004ff70: 4e4d 272c 2072 6f75 6e64 6974 3d54 7275  NM', roundit=Tru
-0004ff80: 6520 290a 2020 2020 2020 2020 2020 2020  e ).            
-0004ff90: 2020 2020 2020 2020 6d64 6c66 6e20 3d20          mdlfn = 
-0004ffa0: 6578 5f70 6174 686d 6d20 2b20 2273 6971  ex_pathmm + "siq
-0004ffb0: 5f64 6566 6175 6c74 5f73 6973 725f 2220  _default_sisr_" 
-0004ffc0: 2b20 6265 7374 7570 202b 2022 5f31 6368  + bestup + "_1ch
-0004ffd0: 616e 5f66 6561 7476 6767 4c36 5f62 6573  an_featvggL6_bes
-0004ffe0: 745f 6d64 6c2e 6835 220a 2020 2020 2020  t_mdl.h5".      
-0004fff0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00050000: 2069 7369 6e73 7461 6e63 6528 2073 726d   isinstance( srm
-00050010: 6f64 656c 5f4e 4d2c 2073 7472 2029 3a0a  odel_NM, str ):.
-00050020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050030: 2020 2020 2020 2020 7372 6d6f 6465 6c5f          srmodel_
-00050040: 4e4d 203d 2072 652e 7375 6228 2022 6265  NM = re.sub( "be
-00050050: 7374 7570 222c 2062 6573 7475 702c 2073  stup", bestup, s
-00050060: 726d 6f64 656c 5f4e 4d20 290a 2020 2020  rmodel_NM ).    
-00050070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050080: 2020 2020 6d64 6c66 6e20 3d20 6f73 2e70      mdlfn = os.p
-00050090: 6174 682e 6a6f 696e 2820 6578 5f70 6174  ath.join( ex_pat
-000500a0: 686d 6d2c 2073 726d 6f64 656c 5f4e 4d20  hmm, srmodel_NM 
-000500b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000500c0: 2020 2020 2020 6966 2065 7869 7374 7328        if exists(
-000500d0: 206d 646c 666e 2029 3a0a 2020 2020 2020   mdlfn ):.      
-000500e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000500f0: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-00050100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050110: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00050120: 6d64 6c66 6e29 0a20 2020 2020 2020 2020  mdlfn).         
-00050130: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00050140: 726d 6f64 656c 5f4e 4d5f 6d64 6c20 3d20  rmodel_NM_mdl = 
-00050150: 7466 2e6b 6572 6173 2e6d 6f64 656c 732e  tf.keras.models.
-00050160: 6c6f 6164 5f6d 6f64 656c 2820 6d64 6c66  load_model( mdlf
-00050170: 6e2c 2063 6f6d 7069 6c65 3d46 616c 7365  n, compile=False
-00050180: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00050190: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000501a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000501b0: 2020 2020 2020 7072 696e 7428 206d 646c        print( mdl
-000501c0: 666e 202b 2022 2064 6f65 7320 6e6f 7420  fn + " does not 
-000501d0: 6578 6973 7420 2d20 776f 6e74 2075 7365  exist - wont use
-000501e0: 2053 5222 290a 2020 2020 2020 2020 2020   SR").          
-000501f0: 2020 2020 2020 6966 206e 6f74 2074 6573        if not tes
-00050200: 746c 6f6f 703a 0a20 2020 2020 2020 2020  tloop:.         
-00050210: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00050220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050230: 2020 2020 2020 2020 7461 6250 726f 2c20          tabPro, 
-00050240: 6e6f 726d 5072 6f20 3d20 6d6d 2820 7431  normPro = mm( t1
-00050250: 2c20 6869 6572 2c0a 2020 2020 2020 2020  , hier,.        
+0004fd20: 2020 7072 696e 7428 2022 4e4d 2022 202b    print( "NM " +
+0004fd30: 206d 796d 6d20 202b 2027 2065 7865 6375   mymm  + ' execu
+0004fd40: 7469 6f6e 2027 290a 2020 2020 2020 2020  tion ').        
+0004fd50: 2020 2020 2020 2020 656c 6966 2076 6572          elif ver
+0004fd60: 626f 7365 2061 6e64 2065 7869 7374 7328  bose and exists(
+0004fd70: 206d 796d 6d6f 7574 2029 203a 0a20 2020   mymmout ) :.   
+0004fd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fd90: 2070 7269 6e74 2820 224e 4d20 2220 2b20   print( "NM " + 
+0004fda0: 6d79 6d6d 202b 2027 2063 6f6d 706c 6574  mymm + ' complet
+0004fdb0: 6520 2720 290a 2020 2020 2020 2020 2020  e ' ).          
+0004fdc0: 2020 2020 2020 6966 2065 7869 7374 7328        if exists(
+0004fdd0: 206d 796d 6d6f 7574 2029 3a0a 2020 2020   mymmout ):.    
+0004fde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fdf0: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+0004fe00: 2020 2020 2020 2020 2069 6620 6973 3464           if is4d
+0004fe10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0004fe20: 2020 2020 2020 6e6d 6c69 7374 203d 2061        nmlist = a
+0004fe30: 6e74 732e 6e64 696d 6167 655f 746f 5f6c  nts.ndimage_to_l
+0004fe40: 6973 7428 206d 6d5f 7265 6164 2820 6d79  ist( mm_read( my
+0004fe50: 696d 6773 7232 5b30 5d20 2920 290a 2020  imgsr2[0] ) ).  
+0004fe60: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0004fe70: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0004fe80: 2020 2020 2020 2020 6e6d 6c69 7374 203d          nmlist =
+0004fe90: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+0004fea0: 2020 2020 2020 2020 666f 7220 7a7a 2069          for zz i
+0004feb0: 6e20 6d79 696d 6773 7232 3a0a 2020 2020  n myimgsr2:.    
+0004fec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fed0: 2020 2020 6e6d 6c69 7374 2e61 7070 656e      nmlist.appen
+0004fee0: 6428 206d 6d5f 7265 6164 2820 7a7a 2029  d( mm_read( zz )
+0004fef0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0004ff00: 2020 2073 726d 6f64 656c 5f4e 4d5f 6d64     srmodel_NM_md
+0004ff10: 6c20 3d20 4e6f 6e65 0a20 2020 2020 2020  l = None.       
+0004ff20: 2020 2020 2020 2020 2069 6620 7372 6d6f           if srmo
+0004ff30: 6465 6c5f 4e4d 2069 7320 6e6f 7420 4661  del_NM is not Fa
+0004ff40: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0004ff50: 2020 2020 2020 2020 2062 6573 7475 7020           bestup 
+0004ff60: 3d20 7369 712e 6f70 7469 6d69 7a65 5f75  = siq.optimize_u
+0004ff70: 7073 616d 706c 696e 675f 7368 6170 6528  psampling_shape(
+0004ff80: 2061 6e74 732e 6765 745f 7370 6163 696e   ants.get_spacin
+0004ff90: 6728 6e6d 6c69 7374 5b30 5d29 2c20 6d6f  g(nmlist[0]), mo
+0004ffa0: 6461 6c69 7479 3d27 4e4d 272c 2072 6f75  dality='NM', rou
+0004ffb0: 6e64 6974 3d54 7275 6520 290a 2020 2020  ndit=True ).    
+0004ffc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ffd0: 6d64 6c66 6e20 3d20 6578 5f70 6174 686d  mdlfn = ex_pathm
+0004ffe0: 6d20 2b20 2273 6971 5f64 6566 6175 6c74  m + "siq_default
+0004fff0: 5f73 6973 725f 2220 2b20 6265 7374 7570  _sisr_" + bestup
+00050000: 202b 2022 5f31 6368 616e 5f66 6561 7476   + "_1chan_featv
+00050010: 6767 4c36 5f62 6573 745f 6d64 6c2e 6835  ggL6_best_mdl.h5
+00050020: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00050030: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00050040: 6e63 6528 2073 726d 6f64 656c 5f4e 4d2c  nce( srmodel_NM,
+00050050: 2073 7472 2029 3a0a 2020 2020 2020 2020   str ):.        
+00050060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050070: 7372 6d6f 6465 6c5f 4e4d 203d 2072 652e  srmodel_NM = re.
+00050080: 7375 6228 2022 6265 7374 7570 222c 2062  sub( "bestup", b
+00050090: 6573 7475 702c 2073 726d 6f64 656c 5f4e  estup, srmodel_N
+000500a0: 4d20 290a 2020 2020 2020 2020 2020 2020  M ).            
+000500b0: 2020 2020 2020 2020 2020 2020 6d64 6c66              mdlf
+000500c0: 6e20 3d20 6f73 2e70 6174 682e 6a6f 696e  n = os.path.join
+000500d0: 2820 6578 5f70 6174 686d 6d2c 2073 726d  ( ex_pathmm, srm
+000500e0: 6f64 656c 5f4e 4d20 290a 2020 2020 2020  odel_NM ).      
+000500f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00050100: 2065 7869 7374 7328 206d 646c 666e 2029   exists( mdlfn )
+00050110: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00050120: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+00050130: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+00050140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050150: 2020 7072 696e 7428 6d64 6c66 6e29 0a20    print(mdlfn). 
+00050160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050170: 2020 2020 2020 2073 726d 6f64 656c 5f4e         srmodel_N
+00050180: 4d5f 6d64 6c20 3d20 7466 2e6b 6572 6173  M_mdl = tf.keras
+00050190: 2e6d 6f64 656c 732e 6c6f 6164 5f6d 6f64  .models.load_mod
+000501a0: 656c 2820 6d64 6c66 6e2c 2063 6f6d 7069  el( mdlfn, compi
+000501b0: 6c65 3d46 616c 7365 2020 290a 2020 2020  le=False  ).    
+000501c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000501d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000501e0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000501f0: 696e 7428 206d 646c 666e 202b 2022 2064  int( mdlfn + " d
+00050200: 6f65 7320 6e6f 7420 6578 6973 7420 2d20  oes not exist - 
+00050210: 776f 6e74 2075 7365 2053 5222 290a 2020  wont use SR").  
+00050220: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00050230: 206e 6f74 2074 6573 746c 6f6f 703a 0a20   not testloop:. 
+00050240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050250: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
 00050260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050270: 2020 2020 6e6d 5f69 6d61 6765 5f6c 6973      nm_image_lis
-00050280: 7420 3d20 6e6d 6c69 7374 2c0a 2020 2020  t = nmlist,.    
+00050270: 7461 6250 726f 2c20 6e6f 726d 5072 6f20  tabPro, normPro 
+00050280: 3d20 6d6d 2820 7431 2c20 6869 6572 2c0a  = mm( t1, hier,.
 00050290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000502a0: 2020 2020 2020 2020 7372 6d6f 6465 6c3d          srmodel=
-000502b0: 7372 6d6f 6465 6c5f 4e4d 5f6d 646c 2c0a  srmodel_NM_mdl,.
-000502c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000502d0: 2020 2020 2020 2020 2020 2020 646f 5f74              do_t
-000502e0: 7261 6374 6f67 7261 7068 793d 4661 6c73  ractography=Fals
-000502f0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00050300: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00050310: 6f5f 6b6b 3d46 616c 7365 2c0a 2020 2020  o_kk=False,.    
-00050320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050330: 2020 2020 2020 2020 646f 5f6e 6f72 6d61          do_norma
-00050340: 6c69 7a61 7469 6f6e 3d74 656d 706c 6174  lization=templat
-00050350: 6554 782c 0a20 2020 2020 2020 2020 2020  eTx,.           
+000502a0: 2020 2020 2020 2020 2020 2020 6e6d 5f69              nm_i
+000502b0: 6d61 6765 5f6c 6973 7420 3d20 6e6d 6c69  mage_list = nmli
+000502c0: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
+000502d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000502e0: 7372 6d6f 6465 6c3d 7372 6d6f 6465 6c5f  srmodel=srmodel_
+000502f0: 4e4d 5f6d 646c 2c0a 2020 2020 2020 2020  NM_mdl,.        
+00050300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050310: 2020 2020 646f 5f74 7261 6374 6f67 7261      do_tractogra
+00050320: 7068 793d 4661 6c73 652c 0a20 2020 2020  phy=False,.     
+00050330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050340: 2020 2020 2020 2064 6f5f 6b6b 3d46 616c         do_kk=Fal
+00050350: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
 00050360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050370: 2067 726f 7570 5f74 656d 706c 6174 6520   group_template 
-00050380: 3d20 6e6f 726d 616c 697a 6174 696f 6e5f  = normalization_
-00050390: 7465 6d70 6c61 7465 2c0a 2020 2020 2020  template,.      
-000503a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000503b0: 2020 2020 2020 6772 6f75 705f 7472 616e        group_tran
-000503c0: 7366 6f72 6d20 3d20 6772 6f75 7054 782c  sform = groupTx,
-000503d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000503e0: 2020 2020 2020 2020 2020 2020 2074 6573               tes
-000503f0: 745f 7275 6e3d 7465 7374 5f72 756e 2c0a  t_run=test_run,.
-00050400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050410: 2020 2020 2020 2020 2020 2020 7665 7262              verb
-00050420: 6f73 653d 5472 7565 2029 0a20 2020 2020  ose=True ).     
-00050430: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00050440: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-00050450: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-00050460: 2020 2020 2020 2020 2020 2020 2020 6572                er
-00050470: 726f 725f 696e 666f 203d 2074 7261 6365  ror_info = trace
-00050480: 6261 636b 2e66 6f72 6d61 745f 6578 6328  back.format_exc(
-00050490: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000504a0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-000504b0: 6572 726f 725f 696e 666f 290a 2020 2020  error_info).    
-000504c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000504d0: 2020 2020 7669 7375 616c 697a 653d 4661      visualize=Fa
-000504e0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-000504f0: 2020 2020 2020 2020 2020 2020 646f 7772              dowr
-00050500: 6974 653d 4661 6c73 650a 2020 2020 2020  ite=False.      
-00050510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050520: 2020 7072 696e 7428 6622 616e 7473 7079    print(f"antspy
-00050530: 6d6d 6572 726f 7220 6f63 6375 7272 6564  mmerror occurred
-00050540: 2077 6869 6c65 2070 726f 6365 7373 696e   while processin
-00050550: 6720 7b6f 7665 726d 6f64 587d 3a20 7b65  g {overmodX}: {e
-00050560: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
-00050570: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-00050580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00050590: 2020 2020 2069 6620 6e6f 7420 7465 7374       if not test
-000505a0: 5f72 756e 3a0a 2020 2020 2020 2020 2020  _run:.          
-000505b0: 2020 2020 2020 2020 2020 2020 2020 7772                wr
-000505c0: 6974 655f 6d6d 2820 6f75 7470 7574 5f70  ite_mm( output_p
-000505d0: 7265 6669 783d 6d79 6d6d 2c20 6d6d 3d74  refix=mymm, mm=t
-000505e0: 6162 5072 6f2c 206d 6d5f 6e6f 726d 3d6e  abPro, mm_norm=n
-000505f0: 6f72 6d50 726f 2c20 7431 7769 6465 3d4e  ormPro, t1wide=N
-00050600: 6f6e 652c 2073 6570 6172 6174 6f72 3d6d  one, separator=m
-00050610: 7973 6570 2029 0a20 2020 2020 2020 2020  ysep ).         
-00050620: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00050630: 6d70 726f 203d 2074 6162 5072 6f5b 274e  mpro = tabPro['N
-00050640: 4d27 5d0a 2020 2020 2020 2020 2020 2020  M'].            
-00050650: 2020 2020 2020 2020 2020 2020 6d79 736c              mysl
-00050660: 203d 2072 616e 6765 2820 6e6d 7072 6f5b   = range( nmpro[
-00050670: 274e 4d5f 6176 6727 5d2e 7368 6170 655b  'NM_avg'].shape[
-00050680: 325d 2029 0a20 2020 2020 2020 2020 2020  2] ).           
-00050690: 2020 2020 2020 2020 2069 6620 7669 7375           if visu
-000506a0: 616c 697a 653a 0a20 2020 2020 2020 2020  alize:.         
-000506b0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000506c0: 7973 6c20 3d20 7261 6e67 6528 206e 6d70  ysl = range( nmp
-000506d0: 726f 5b27 4e4d 5f61 7667 275d 2e73 6861  ro['NM_avg'].sha
-000506e0: 7065 5b32 5d20 290a 2020 2020 2020 2020  pe[2] ).        
+00050370: 646f 5f6e 6f72 6d61 6c69 7a61 7469 6f6e  do_normalization
+00050380: 3d74 656d 706c 6174 6554 782c 0a20 2020  =templateTx,.   
+00050390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000503a0: 2020 2020 2020 2020 2067 726f 7570 5f74           group_t
+000503b0: 656d 706c 6174 6520 3d20 6e6f 726d 616c  emplate = normal
+000503c0: 697a 6174 696f 6e5f 7465 6d70 6c61 7465  ization_template
+000503d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000503e0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
+000503f0: 6f75 705f 7472 616e 7366 6f72 6d20 3d20  oup_transform = 
+00050400: 6772 6f75 7054 782c 0a20 2020 2020 2020  groupTx,.       
+00050410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050420: 2020 2020 2074 6573 745f 7275 6e3d 7465       test_run=te
+00050430: 7374 5f72 756e 2c0a 2020 2020 2020 2020  st_run,.        
+00050440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050450: 2020 2020 7665 7262 6f73 653d 5472 7565      verbose=True
+00050460: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00050470: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+00050480: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+00050490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000504a0: 2020 2020 2020 6572 726f 725f 696e 666f        error_info
+000504b0: 203d 2074 7261 6365 6261 636b 2e66 6f72   = traceback.for
+000504c0: 6d61 745f 6578 6328 290a 2020 2020 2020  mat_exc().      
+000504d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000504e0: 2020 7072 696e 7428 6572 726f 725f 696e    print(error_in
+000504f0: 666f 290a 2020 2020 2020 2020 2020 2020  fo).            
+00050500: 2020 2020 2020 2020 2020 2020 7669 7375              visu
+00050510: 616c 697a 653d 4661 6c73 650a 2020 2020  alize=False.    
+00050520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050530: 2020 2020 646f 7772 6974 653d 4661 6c73      dowrite=Fals
+00050540: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00050550: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00050560: 6622 616e 7473 7079 6d6d 6572 726f 7220  f"antspymmerror 
+00050570: 6f63 6375 7272 6564 2077 6869 6c65 2070  occurred while p
+00050580: 726f 6365 7373 696e 6720 7b6f 7665 726d  rocessing {overm
+00050590: 6f64 587d 3a20 7b65 7d22 290a 2020 2020  odX}: {e}").    
+000505a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000505b0: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
+000505c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000505d0: 6e6f 7420 7465 7374 5f72 756e 3a0a 2020  not test_run:.  
+000505e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000505f0: 2020 2020 2020 6966 2064 6f77 7269 7465        if dowrite
+00050600: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00050610: 2020 2020 2020 2020 2020 2020 2020 7772                wr
+00050620: 6974 655f 6d6d 2820 6f75 7470 7574 5f70  ite_mm( output_p
+00050630: 7265 6669 783d 6d79 6d6d 2c20 6d6d 3d74  refix=mymm, mm=t
+00050640: 6162 5072 6f2c 0a20 2020 2020 2020 2020  abPro,.         
+00050650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050660: 2020 2020 2020 206d 6d5f 6e6f 726d 3d6e         mm_norm=n
+00050670: 6f72 6d50 726f 2c20 7431 7769 6465 3d4e  ormPro, t1wide=N
+00050680: 6f6e 652c 2073 6570 6172 6174 6f72 3d6d  one, separator=m
+00050690: 7973 6570 2029 0a20 2020 2020 2020 2020  ysep ).         
+000506a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000506b0: 6620 7669 7375 616c 697a 6520 3a0a 2020  f visualize :.  
+000506c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000506d0: 2020 2020 2020 2020 2020 6e6d 7072 6f20            nmpro 
+000506e0: 3d20 7461 6250 726f 5b27 4e4d 275d 0a20  = tabPro['NM']. 
 000506f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050700: 616e 7473 2e70 6c6f 7428 206e 6d70 726f  ants.plot( nmpro
-00050710: 5b27 4e4d 5f61 7667 275d 2c20 206e 6d70  ['NM_avg'],  nmp
-00050720: 726f 5b27 7431 5f74 6f5f 4e4d 275d 2c20  ro['t1_to_NM'], 
-00050730: 736c 6963 6573 3d6d 7973 6c2c 2061 7869  slices=mysl, axi
-00050740: 733d 322c 2074 6974 6c65 3d27 6e6d 202b  s=2, title='nm +
-00050750: 2074 3127 2c20 6669 6c65 6e61 6d65 3d6d   t1', filename=m
-00050760: 796d 6d2b 6d79 7365 702b 224e 4d61 7667  ymm+mysep+"NMavg
-00050770: 2e70 6e67 2220 290a 2020 2020 2020 2020  .png" ).        
-00050780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050790: 6d79 736c 203d 2072 616e 6765 2820 6e6d  mysl = range( nm
-000507a0: 7072 6f5b 274e 4d5f 6176 675f 6372 6f70  pro['NM_avg_crop
-000507b0: 7065 6427 5d2e 7368 6170 655b 325d 2029  ped'].shape[2] )
-000507c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000507d0: 2020 2020 2020 2020 2061 6e74 732e 706c           ants.pl
-000507e0: 6f74 2820 6e6d 7072 6f5b 274e 4d5f 6176  ot( nmpro['NM_av
-000507f0: 675f 6372 6f70 7065 6427 5d2c 2061 7869  g_cropped'], axi
-00050800: 733d 322c 2073 6c69 6365 733d 6d79 736c  s=2, slices=mysl
-00050810: 2c20 6f76 6572 6c61 795f 616c 7068 613d  , overlay_alpha=
-00050820: 302e 332c 2074 6974 6c65 3d27 6e6d 2063  0.3, title='nm c
-00050830: 726f 7027 2c20 6669 6c65 6e61 6d65 3d6d  rop', filename=m
-00050840: 796d 6d2b 6d79 7365 702b 224e 4d61 7667  ymm+mysep+"NMavg
-00050850: 6372 6f70 2e70 6e67 2220 290a 2020 2020  crop.png" ).    
-00050860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050870: 2020 2020 616e 7473 2e70 6c6f 7428 206e      ants.plot( n
-00050880: 6d70 726f 5b27 4e4d 5f61 7667 5f63 726f  mpro['NM_avg_cro
-00050890: 7070 6564 275d 2c20 6e6d 7072 6f5b 2774  pped'], nmpro['t
-000508a0: 315f 746f 5f4e 4d27 5d2c 2061 7869 733d  1_to_NM'], axis=
-000508b0: 322c 2073 6c69 6365 733d 6d79 736c 2c20  2, slices=mysl, 
-000508c0: 6f76 6572 6c61 795f 616c 7068 613d 302e  overlay_alpha=0.
-000508d0: 332c 2074 6974 6c65 3d27 6e6d 2063 726f  3, title='nm cro
-000508e0: 7020 2b20 7431 272c 2066 696c 656e 616d  p + t1', filenam
-000508f0: 653d 6d79 6d6d 2b6d 7973 6570 2b22 4e4d  e=mymm+mysep+"NM
-00050900: 6176 6763 726f 7074 312e 706e 6722 2029  avgcropt1.png" )
-00050910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00050920: 2020 2020 2020 2020 2061 6e74 732e 706c           ants.pl
-00050930: 6f74 2820 6e6d 7072 6f5b 274e 4d5f 6176  ot( nmpro['NM_av
-00050940: 675f 6372 6f70 7065 6427 5d2c 206e 6d70  g_cropped'], nmp
-00050950: 726f 5b27 4e4d 5f6c 6162 656c 7327 5d2c  ro['NM_labels'],
-00050960: 2061 7869 733d 322c 2073 6c69 6365 733d   axis=2, slices=
-00050970: 6d79 736c 2c20 7469 746c 653d 276e 6d20  mysl, title='nm 
-00050980: 6372 6f70 202b 206c 6162 656c 7327 2c20  crop + labels', 
-00050990: 6669 6c65 6e61 6d65 3d6d 796d 6d2b 6d79  filename=mymm+my
-000509a0: 7365 702b 224e 4d61 7667 6372 6f70 6c61  sep+"NMavgcropla
-000509b0: 6265 6c73 2e70 6e67 2220 290a 2020 2020  bels.png" ).    
-000509c0: 2020 2020 2020 2020 656c 7365 203a 0a20          else :. 
-000509d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000509e0: 6620 6c65 6e28 206d 7969 6d67 7372 2029  f len( myimgsr )
-000509f0: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
-00050a00: 2020 2020 2020 2020 2020 646f 7772 6974            dowrit
-00050a10: 653d 4661 6c73 650a 2020 2020 2020 2020  e=False.        
-00050a20: 2020 2020 2020 2020 2020 2020 6d79 696d              myim
-00050a30: 6763 6f75 6e74 3d30 0a20 2020 2020 2020  gcount=0.       
-00050a40: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00050a50: 6c65 6e28 206d 7969 6d67 7372 2029 203e  len( myimgsr ) >
-00050a60: 2030 203a 0a20 2020 2020 2020 2020 2020   0 :.           
-00050a70: 2020 2020 2020 2020 2020 2020 206d 7969               myi
-00050a80: 6d67 203d 206d 7969 6d67 7372 5b6d 7969  mg = myimgsr[myi
-00050a90: 6d67 636f 756e 745d 0a20 2020 2020 2020  mgcount].       
-00050aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050ab0: 2073 7562 6a65 6374 7072 6f70 6174 6820   subjectpropath 
-00050ac0: 3d20 6f73 2e70 6174 682e 6469 726e 616d  = os.path.dirnam
-00050ad0: 6528 206d 7964 6f63 5b27 6f75 7470 7265  e( mydoc['outpre
-00050ae0: 6669 7827 5d20 290a 2020 2020 2020 2020  fix'] ).        
-00050af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050b00: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-00050b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050b20: 2020 2020 2020 2020 7072 696e 7428 2273          print("s
-00050b30: 7562 6a65 6374 7072 6f70 6174 6820 6973  ubjectpropath is
-00050b40: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00050b50: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00050b60: 7269 6e74 2873 7562 6a65 6374 7072 6f70  rint(subjectprop
-00050b70: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-00050b80: 2020 2020 2020 2020 2020 2020 206f 732e               os.
-00050b90: 6d61 6b65 6469 7273 2820 7375 626a 6563  makedirs( subjec
-00050ba0: 7470 726f 7061 7468 2c20 6578 6973 745f  tpropath, exist_
-00050bb0: 6f6b 3d54 7275 6520 2029 0a20 2020 2020  ok=True  ).     
-00050bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050bd0: 2020 206d 796d 6d6f 7574 203d 206d 616b     mymmout = mak
-00050be0: 6577 6964 656f 7574 2820 6d79 6d6d 2029  ewideout( mymm )
-00050bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00050c00: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
-00050c10: 6f73 6520 616e 6420 6e6f 7420 6578 6973  ose and not exis
-00050c20: 7473 2820 6d79 6d6d 6f75 7420 293a 0a20  ts( mymmout ):. 
-00050c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050c40: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00050c50: 2822 4d6f 6461 6c69 7479 2073 7065 6369  ("Modality speci
-00050c60: 6669 6320 7072 6f63 6573 7369 6e67 3a20  fic processing: 
-00050c70: 2220 2b20 6d79 6d6f 6420 2b20 2220 6578  " + mymod + " ex
-00050c80: 6563 7574 696f 6e20 2220 290a 2020 2020  ecution " ).    
+00050700: 2020 2020 2020 2020 2020 206d 7973 6c20             mysl 
+00050710: 3d20 7261 6e67 6528 206e 6d70 726f 5b27  = range( nmpro['
+00050720: 4e4d 5f61 7667 275d 2e73 6861 7065 5b32  NM_avg'].shape[2
+00050730: 5d20 290a 2020 2020 2020 2020 2020 2020  ] ).            
+00050740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050750: 616e 7473 2e70 6c6f 7428 206e 6d70 726f  ants.plot( nmpro
+00050760: 5b27 4e4d 5f61 7667 275d 2c20 206e 6d70  ['NM_avg'],  nmp
+00050770: 726f 5b27 7431 5f74 6f5f 4e4d 275d 2c20  ro['t1_to_NM'], 
+00050780: 736c 6963 6573 3d6d 7973 6c2c 2061 7869  slices=mysl, axi
+00050790: 733d 322c 2074 6974 6c65 3d27 6e6d 202b  s=2, title='nm +
+000507a0: 2074 3127 2c20 6669 6c65 6e61 6d65 3d6d   t1', filename=m
+000507b0: 796d 6d2b 6d79 7365 702b 224e 4d61 7667  ymm+mysep+"NMavg
+000507c0: 2e70 6e67 2220 290a 2020 2020 2020 2020  .png" ).        
+000507d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000507e0: 2020 2020 6d79 736c 203d 2072 616e 6765      mysl = range
+000507f0: 2820 6e6d 7072 6f5b 274e 4d5f 6176 675f  ( nmpro['NM_avg_
+00050800: 6372 6f70 7065 6427 5d2e 7368 6170 655b  cropped'].shape[
+00050810: 325d 2029 0a20 2020 2020 2020 2020 2020  2] ).           
+00050820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050830: 2061 6e74 732e 706c 6f74 2820 6e6d 7072   ants.plot( nmpr
+00050840: 6f5b 274e 4d5f 6176 675f 6372 6f70 7065  o['NM_avg_croppe
+00050850: 6427 5d2c 2061 7869 733d 322c 2073 6c69  d'], axis=2, sli
+00050860: 6365 733d 6d79 736c 2c20 6f76 6572 6c61  ces=mysl, overla
+00050870: 795f 616c 7068 613d 302e 332c 2074 6974  y_alpha=0.3, tit
+00050880: 6c65 3d27 6e6d 2063 726f 7027 2c20 6669  le='nm crop', fi
+00050890: 6c65 6e61 6d65 3d6d 796d 6d2b 6d79 7365  lename=mymm+myse
+000508a0: 702b 224e 4d61 7667 6372 6f70 2e70 6e67  p+"NMavgcrop.png
+000508b0: 2220 290a 2020 2020 2020 2020 2020 2020  " ).            
+000508c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000508d0: 616e 7473 2e70 6c6f 7428 206e 6d70 726f  ants.plot( nmpro
+000508e0: 5b27 4e4d 5f61 7667 5f63 726f 7070 6564  ['NM_avg_cropped
+000508f0: 275d 2c20 6e6d 7072 6f5b 2774 315f 746f  '], nmpro['t1_to
+00050900: 5f4e 4d27 5d2c 2061 7869 733d 322c 2073  _NM'], axis=2, s
+00050910: 6c69 6365 733d 6d79 736c 2c20 6f76 6572  lices=mysl, over
+00050920: 6c61 795f 616c 7068 613d 302e 332c 2074  lay_alpha=0.3, t
+00050930: 6974 6c65 3d27 6e6d 2063 726f 7020 2b20  itle='nm crop + 
+00050940: 7431 272c 2066 696c 656e 616d 653d 6d79  t1', filename=my
+00050950: 6d6d 2b6d 7973 6570 2b22 4e4d 6176 6763  mm+mysep+"NMavgc
+00050960: 726f 7074 312e 706e 6722 2029 0a20 2020  ropt1.png" ).   
+00050970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050980: 2020 2020 2020 2020 2061 6e74 732e 706c           ants.pl
+00050990: 6f74 2820 6e6d 7072 6f5b 274e 4d5f 6176  ot( nmpro['NM_av
+000509a0: 675f 6372 6f70 7065 6427 5d2c 206e 6d70  g_cropped'], nmp
+000509b0: 726f 5b27 4e4d 5f6c 6162 656c 7327 5d2c  ro['NM_labels'],
+000509c0: 2061 7869 733d 322c 2073 6c69 6365 733d   axis=2, slices=
+000509d0: 6d79 736c 2c20 7469 746c 653d 276e 6d20  mysl, title='nm 
+000509e0: 6372 6f70 202b 206c 6162 656c 7327 2c20  crop + labels', 
+000509f0: 6669 6c65 6e61 6d65 3d6d 796d 6d2b 6d79  filename=mymm+my
+00050a00: 7365 702b 224e 4d61 7667 6372 6f70 6c61  sep+"NMavgcropla
+00050a10: 6265 6c73 2e70 6e67 2220 290a 2020 2020  bels.png" ).    
+00050a20: 2020 2020 2020 2020 656c 7365 203a 0a20          else :. 
+00050a30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00050a40: 6620 6c65 6e28 206d 7969 6d67 7372 2029  f len( myimgsr )
+00050a50: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
+00050a60: 2020 2020 2020 2020 2020 646f 7772 6974            dowrit
+00050a70: 653d 4661 6c73 650a 2020 2020 2020 2020  e=False.        
+00050a80: 2020 2020 2020 2020 2020 2020 6d79 696d              myim
+00050a90: 6763 6f75 6e74 3d30 0a20 2020 2020 2020  gcount=0.       
+00050aa0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00050ab0: 6c65 6e28 206d 7969 6d67 7372 2029 203e  len( myimgsr ) >
+00050ac0: 2030 203a 0a20 2020 2020 2020 2020 2020   0 :.           
+00050ad0: 2020 2020 2020 2020 2020 2020 206d 7969               myi
+00050ae0: 6d67 203d 206d 7969 6d67 7372 5b6d 7969  mg = myimgsr[myi
+00050af0: 6d67 636f 756e 745d 0a20 2020 2020 2020  mgcount].       
+00050b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050b10: 2073 7562 6a65 6374 7072 6f70 6174 6820   subjectpropath 
+00050b20: 3d20 6f73 2e70 6174 682e 6469 726e 616d  = os.path.dirnam
+00050b30: 6528 206d 7964 6f63 5b27 6f75 7470 7265  e( mydoc['outpre
+00050b40: 6669 7827 5d20 290a 2020 2020 2020 2020  fix'] ).        
+00050b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050b60: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+00050b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050b80: 2020 2020 2020 2020 7072 696e 7428 2273          print("s
+00050b90: 7562 6a65 6374 7072 6f70 6174 6820 6973  ubjectpropath is
+00050ba0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+00050bb0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00050bc0: 7269 6e74 2873 7562 6a65 6374 7072 6f70  rint(subjectprop
+00050bd0: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+00050be0: 2020 2020 2020 2020 2020 2020 206f 732e               os.
+00050bf0: 6d61 6b65 6469 7273 2820 7375 626a 6563  makedirs( subjec
+00050c00: 7470 726f 7061 7468 2c20 6578 6973 745f  tpropath, exist_
+00050c10: 6f6b 3d54 7275 6520 2029 0a20 2020 2020  ok=True  ).     
+00050c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050c30: 2020 206d 796d 6d6f 7574 203d 206d 616b     mymmout = mak
+00050c40: 6577 6964 656f 7574 2820 6d79 6d6d 2029  ewideout( mymm )
+00050c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00050c60: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
+00050c70: 6f73 6520 616e 6420 6e6f 7420 6578 6973  ose and not exis
+00050c80: 7473 2820 6d79 6d6d 6f75 7420 293a 0a20  ts( mymmout ):. 
 00050c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050ca0: 2020 2020 2020 2020 7072 696e 7428 206d          print( m
-00050cb0: 796d 6d20 290a 2020 2020 2020 2020 2020  ymm ).          
-00050cc0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00050cd0: 6966 2076 6572 626f 7365 2061 6e64 2065  if verbose and e
-00050ce0: 7869 7374 7328 206d 796d 6d6f 7574 2029  xists( mymmout )
-00050cf0: 203a 0a20 2020 2020 2020 2020 2020 2020   :.             
-00050d00: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00050d10: 7269 6e74 2822 4d6f 6461 6c69 7479 2073  rint("Modality s
-00050d20: 7065 6369 6669 6320 7072 6f63 6573 7369  pecific processi
-00050d30: 6e67 3a20 2220 2b20 6d79 6d6f 6420 2b20  ng: " + mymod + 
-00050d40: 2220 636f 6d70 6c65 7465 2022 2029 0a20  " complete " ). 
-00050d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050d60: 2020 2020 2020 2069 6620 6578 6973 7473         if exists
-00050d70: 2820 6d79 6d6d 6f75 7420 2920 3a0a 2020  ( mymmout ) :.  
-00050d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050d90: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00050da0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-00050db0: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
-00050dc0: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
-00050dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050de0: 2020 2070 7269 6e74 2873 7562 6a65 6374     print(subject
-00050df0: 7072 6f70 6174 6829 0a20 2020 2020 2020  propath).       
-00050e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050e10: 2020 2020 2070 7269 6e74 2820 6d79 696d       print( myim
-00050e20: 6720 290a 2020 2020 2020 2020 2020 2020  g ).            
-00050e30: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00050e40: 6f74 2074 6573 746c 6f6f 703a 0a20 2020  ot testloop:.   
-00050e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050e60: 2020 2020 2020 2020 2069 6d67 203d 206d           img = m
-00050e70: 6d5f 7265 6164 2820 6d79 696d 6720 290a  m_read( myimg ).
-00050e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050e90: 2020 2020 2020 2020 2020 2020 6973 6861              isha
-00050ea0: 7065 6c65 6e20 3d20 6c65 6e28 2069 6d67  pelen = len( img
-00050eb0: 2e73 6861 7065 2029 0a20 2020 2020 2020  .shape ).       
-00050ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050ed0: 2020 2020 2069 6620 6d79 6d6f 6420 3d3d       if mymod ==
-00050ee0: 2027 5431 7727 2061 6e64 2069 7368 6170   'T1w' and ishap
-00050ef0: 656c 656e 203d 3d20 333a 2023 2066 6f72  elen == 3: # for
-00050f00: 2061 2072 6561 6c20 7275 6e2c 2073 6574   a real run, set
-00050f10: 2074 6f20 5472 7565 0a20 2020 2020 2020   to True.       
+00050ca0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00050cb0: 2822 4d6f 6461 6c69 7479 2073 7065 6369  ("Modality speci
+00050cc0: 6669 6320 7072 6f63 6573 7369 6e67 3a20  fic processing: 
+00050cd0: 2220 2b20 6d79 6d6f 6420 2b20 2220 6578  " + mymod + " ex
+00050ce0: 6563 7574 696f 6e20 2220 290a 2020 2020  ecution " ).    
+00050cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050d00: 2020 2020 2020 2020 7072 696e 7428 206d          print( m
+00050d10: 796d 6d20 290a 2020 2020 2020 2020 2020  ymm ).          
+00050d20: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00050d30: 6966 2076 6572 626f 7365 2061 6e64 2065  if verbose and e
+00050d40: 7869 7374 7328 206d 796d 6d6f 7574 2029  xists( mymmout )
+00050d50: 203a 0a20 2020 2020 2020 2020 2020 2020   :.             
+00050d60: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00050d70: 7269 6e74 2822 4d6f 6461 6c69 7479 2073  rint("Modality s
+00050d80: 7065 6369 6669 6320 7072 6f63 6573 7369  pecific processi
+00050d90: 6e67 3a20 2220 2b20 6d79 6d6f 6420 2b20  ng: " + mymod + 
+00050da0: 2220 636f 6d70 6c65 7465 2022 2029 0a20  " complete " ). 
+00050db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050dc0: 2020 2020 2020 2069 6620 6578 6973 7473         if exists
+00050dd0: 2820 6d79 6d6d 6f75 7420 2920 3a0a 2020  ( mymmout ) :.  
+00050de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050df0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00050e00: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00050e10: 2020 2020 2020 2020 2020 2069 6620 7665             if ve
+00050e20: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
+00050e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050e40: 2020 2070 7269 6e74 2873 7562 6a65 6374     print(subject
+00050e50: 7072 6f70 6174 6829 0a20 2020 2020 2020  propath).       
+00050e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050e70: 2020 2020 2070 7269 6e74 2820 6d79 696d       print( myim
+00050e80: 6720 290a 2020 2020 2020 2020 2020 2020  g ).            
+00050e90: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00050ea0: 6f74 2074 6573 746c 6f6f 703a 0a20 2020  ot testloop:.   
+00050eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050ec0: 2020 2020 2020 2020 2069 6d67 203d 206d           img = m
+00050ed0: 6d5f 7265 6164 2820 6d79 696d 6720 290a  m_read( myimg ).
+00050ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050ef0: 2020 2020 2020 2020 2020 2020 6973 6861              isha
+00050f00: 7065 6c65 6e20 3d20 6c65 6e28 2069 6d67  pelen = len( img
+00050f10: 2e73 6861 7065 2029 0a20 2020 2020 2020  .shape ).       
 00050f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050f30: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00050f40: 6578 6973 7473 2820 6d79 6d6d 202b 206d  exists( mymm + m
-00050f50: 7973 6570 202b 2022 6b6b 5f6e 6f72 6d2e  ysep + "kk_norm.
-00050f60: 6e69 692e 677a 2220 293a 0a20 2020 2020  nii.gz" ):.     
-00050f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050f80: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00050f90: 6f77 7269 7465 3d54 7275 650a 2020 2020  owrite=True.    
-00050fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050fc0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+00050f30: 2020 2020 2069 6620 6d79 6d6f 6420 3d3d       if mymod ==
+00050f40: 2027 5431 7727 2061 6e64 2069 7368 6170   'T1w' and ishap
+00050f50: 656c 656e 203d 3d20 333a 2023 2066 6f72  elen == 3: # for
+00050f60: 2061 2072 6561 6c20 7275 6e2c 2073 6574   a real run, set
+00050f70: 2074 6f20 5472 7565 0a20 2020 2020 2020   to True.       
+00050f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050f90: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00050fa0: 6578 6973 7473 2820 6d79 6d6d 202b 206d  exists( mymm + m
+00050fb0: 7973 6570 202b 2022 6b6b 5f6e 6f72 6d2e  ysep + "kk_norm.
+00050fc0: 6e69 692e 677a 2220 293a 0a20 2020 2020  nii.gz" ):.     
 00050fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050ff0: 2020 2020 7072 696e 7428 2773 7461 7274      print('start
-00051000: 206b 6b27 290a 2020 2020 2020 2020 2020   kk').          
+00050fe0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00050ff0: 6f77 7269 7465 3d54 7275 650a 2020 2020  owrite=True.    
+00051000: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00051010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051020: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00051020: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
 00051030: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00051040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051050: 2020 2020 2020 2074 6162 5072 6f2c 206e         tabPro, n
-00051060: 6f72 6d50 726f 203d 206d 6d28 2074 312c  ormPro = mm( t1,
-00051070: 2068 6965 722c 0a20 2020 2020 2020 2020   hier,.         
-00051080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051050: 2020 2020 7072 696e 7428 2773 7461 7274      print('start
+00051060: 206b 6b27 290a 2020 2020 2020 2020 2020   kk').          
+00051070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051080: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
 00051090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000510a0: 2020 2073 726d 6f64 656c 3d4e 6f6e 652c     srmodel=None,
-000510b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000510c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000510d0: 2020 2020 2020 2020 2020 2020 2064 6f5f               do_
-000510e0: 7472 6163 746f 6772 6170 6879 3d46 616c  tractography=Fal
-000510f0: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
-00051100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051120: 646f 5f6b 6b3d 5472 7565 2c0a 2020 2020  do_kk=True,.    
-00051130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051150: 2020 2020 2020 2020 646f 5f6e 6f72 6d61          do_norma
-00051160: 6c69 7a61 7469 6f6e 3d74 656d 706c 6174  lization=templat
-00051170: 6554 782c 0a20 2020 2020 2020 2020 2020  eTx,.           
-00051180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000510a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000510b0: 2020 2020 2020 2074 6162 5072 6f2c 206e         tabPro, n
+000510c0: 6f72 6d50 726f 203d 206d 6d28 2074 312c  ormPro = mm( t1,
+000510d0: 2068 6965 722c 0a20 2020 2020 2020 2020   hier,.         
+000510e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000510f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051100: 2020 2073 726d 6f64 656c 3d4e 6f6e 652c     srmodel=None,
+00051110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00051120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051130: 2020 2020 2020 2020 2020 2020 2064 6f5f               do_
+00051140: 7472 6163 746f 6772 6170 6879 3d46 616c  tractography=Fal
+00051150: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+00051160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051180: 646f 5f6b 6b3d 5472 7565 2c0a 2020 2020  do_kk=True,.    
 00051190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000511a0: 2067 726f 7570 5f74 656d 706c 6174 6520   group_template 
-000511b0: 3d20 6e6f 726d 616c 697a 6174 696f 6e5f  = normalization_
-000511c0: 7465 6d70 6c61 7465 2c0a 2020 2020 2020  template,.      
-000511d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000511a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000511b0: 2020 2020 2020 2020 646f 5f6e 6f72 6d61          do_norma
+000511c0: 6c69 7a61 7469 6f6e 3d74 656d 706c 6174  lization=templat
+000511d0: 6554 782c 0a20 2020 2020 2020 2020 2020  eTx,.           
 000511e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000511f0: 2020 2020 2020 6772 6f75 705f 7472 616e        group_tran
-00051200: 7366 6f72 6d20 3d20 6772 6f75 7054 782c  sform = groupTx,
-00051210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00051220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051230: 2020 2020 2020 2020 2020 2020 2074 6573               tes
-00051240: 745f 7275 6e3d 7465 7374 5f72 756e 2c0a  t_run=test_run,.
-00051250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051270: 2020 2020 2020 2020 2020 2020 7665 7262              verb
-00051280: 6f73 653d 5472 7565 2029 0a20 2020 2020  ose=True ).     
-00051290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000512a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000512b0: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-000512c0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-000512d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000512e0: 2020 2020 2020 2020 2020 2020 2020 6572                er
-000512f0: 726f 725f 696e 666f 203d 2074 7261 6365  ror_info = trace
-00051300: 6261 636b 2e66 6f72 6d61 745f 6578 6328  back.format_exc(
-00051310: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00051320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051330: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00051340: 6572 726f 725f 696e 666f 290a 2020 2020  error_info).    
-00051350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051370: 2020 2020 7669 7375 616c 697a 653d 4661      visualize=Fa
-00051380: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-00051390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000513a0: 2020 2020 2020 2020 2020 2020 646f 7772              dowr
-000513b0: 6974 653d 4661 6c73 650a 2020 2020 2020  ite=False.      
+000511f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051200: 2067 726f 7570 5f74 656d 706c 6174 6520   group_template 
+00051210: 3d20 6e6f 726d 616c 697a 6174 696f 6e5f  = normalization_
+00051220: 7465 6d70 6c61 7465 2c0a 2020 2020 2020  template,.      
+00051230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051250: 2020 2020 2020 6772 6f75 705f 7472 616e        group_tran
+00051260: 7366 6f72 6d20 3d20 6772 6f75 7054 782c  sform = groupTx,
+00051270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00051280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051290: 2020 2020 2020 2020 2020 2020 2074 6573               tes
+000512a0: 745f 7275 6e3d 7465 7374 5f72 756e 2c0a  t_run=test_run,.
+000512b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000512c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000512d0: 2020 2020 2020 2020 2020 2020 7665 7262              verb
+000512e0: 6f73 653d 5472 7565 2029 0a20 2020 2020  ose=True ).     
+000512f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051300: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00051310: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00051320: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00051330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051340: 2020 2020 2020 2020 2020 2020 2020 6572                er
+00051350: 726f 725f 696e 666f 203d 2074 7261 6365  ror_info = trace
+00051360: 6261 636b 2e66 6f72 6d61 745f 6578 6328  back.format_exc(
+00051370: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00051380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051390: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+000513a0: 6572 726f 725f 696e 666f 290a 2020 2020  error_info).    
+000513b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000513c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000513d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000513e0: 2020 7072 696e 7428 6622 616e 7473 7079    print(f"antspy
-000513f0: 6d6d 6572 726f 7220 6f63 6375 7272 6564  mmerror occurred
-00051400: 2077 6869 6c65 2070 726f 6365 7373 696e   while processin
-00051410: 6720 7b6f 7665 726d 6f64 587d 3a20 7b65  g {overmodX}: {e
-00051420: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
+000513d0: 2020 2020 7669 7375 616c 697a 653d 4661      visualize=Fa
+000513e0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+000513f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051400: 2020 2020 2020 2020 2020 2020 646f 7772              dowr
+00051410: 6974 653d 4661 6c73 650a 2020 2020 2020  ite=False.      
+00051420: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00051430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051440: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-00051450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00051460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051470: 2020 2020 2069 6620 7669 7375 616c 697a       if visualiz
-00051480: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00051440: 2020 7072 696e 7428 6622 616e 7473 7079    print(f"antspy
+00051450: 6d6d 6572 726f 7220 6f63 6375 7272 6564  mmerror occurred
+00051460: 2077 6869 6c65 2070 726f 6365 7373 696e   while processin
+00051470: 6720 7b6f 7665 726d 6f64 587d 3a20 7b65  g {overmodX}: {e
+00051480: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
 00051490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000514a0: 2020 2020 2020 2020 2020 206d 6178 736c             maxsl
-000514b0: 6963 6520 3d20 6e70 2e6d 696e 2820 5b32  ice = np.min( [2
-000514c0: 312c 2068 6965 725b 2762 7261 696e 5f6e  1, hier['brain_n
-000514d0: 345f 646e 7a27 5d2e 7368 6170 655b 325d  4_dnz'].shape[2]
-000514e0: 205d 2029 0a20 2020 2020 2020 2020 2020   ] ).           
+000514a0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+000514b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000514c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000514d0: 2020 2020 2069 6620 7669 7375 616c 697a       if visualiz
+000514e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
 000514f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051500: 2020 2020 2020 2020 2020 2020 2061 6e74               ant
-00051510: 732e 706c 6f74 2820 6869 6572 5b27 6272  s.plot( hier['br
-00051520: 6169 6e5f 6e34 5f64 6e7a 275d 2c20 2061  ain_n4_dnz'],  a
-00051530: 7869 733d 322c 206e 736c 6963 6573 3d6d  xis=2, nslices=m
-00051540: 6178 736c 6963 652c 206e 636f 6c3d 372c  axslice, ncol=7,
-00051550: 2063 726f 703d 5472 7565 2c20 7469 746c   crop=True, titl
-00051560: 653d 2762 7261 696e 2065 7874 7261 6374  e='brain extract
-00051570: 696f 6e27 2c20 6669 6c65 6e61 6d65 3d6d  ion', filename=m
-00051580: 796d 6d2b 6d79 7365 702b 2262 7261 696e  ymm+mysep+"brain
-00051590: 6578 7472 6163 7469 6f6e 2e70 6e67 2220  extraction.png" 
-000515a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000515b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000515c0: 2020 2020 2020 2020 2020 616e 7473 2e70            ants.p
-000515d0: 6c6f 7428 2074 6162 5072 6f5b 276b 6b27  lot( tabPro['kk'
-000515e0: 5d5b 2774 6869 636b 6e65 7373 5f69 6d61  ]['thickness_ima
-000515f0: 6765 275d 2c20 6178 6973 3d32 2c20 6e73  ge'], axis=2, ns
-00051600: 6c69 6365 733d 6d61 7873 6c69 6365 2c20  lices=maxslice, 
-00051610: 6e63 6f6c 3d37 2c20 6372 6f70 3d54 7275  ncol=7, crop=Tru
-00051620: 652c 2074 6974 6c65 3d27 6b6b 272c 0a20  e, title='kk',. 
-00051630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051650: 2020 2020 2020 2063 6d61 703d 2770 6c61         cmap='pla
-00051660: 736d 6127 2c20 6669 6c65 6e61 6d65 3d6d  sma', filename=m
-00051670: 796d 6d2b 6d79 7365 702b 226b 6b74 6869  ymm+mysep+"kkthi
-00051680: 636b 6e65 7373 2e70 6e67 2220 290a 2020  ckness.png" ).  
+00051500: 2020 2020 2020 2020 2020 206d 6178 736c             maxsl
+00051510: 6963 6520 3d20 6e70 2e6d 696e 2820 5b32  ice = np.min( [2
+00051520: 312c 2068 6965 725b 2762 7261 696e 5f6e  1, hier['brain_n
+00051530: 345f 646e 7a27 5d2e 7368 6170 655b 325d  4_dnz'].shape[2]
+00051540: 205d 2029 0a20 2020 2020 2020 2020 2020   ] ).           
+00051550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051560: 2020 2020 2020 2020 2020 2020 2061 6e74               ant
+00051570: 732e 706c 6f74 2820 6869 6572 5b27 6272  s.plot( hier['br
+00051580: 6169 6e5f 6e34 5f64 6e7a 275d 2c20 2061  ain_n4_dnz'],  a
+00051590: 7869 733d 322c 206e 736c 6963 6573 3d6d  xis=2, nslices=m
+000515a0: 6178 736c 6963 652c 206e 636f 6c3d 372c  axslice, ncol=7,
+000515b0: 2063 726f 703d 5472 7565 2c20 7469 746c   crop=True, titl
+000515c0: 653d 2762 7261 696e 2065 7874 7261 6374  e='brain extract
+000515d0: 696f 6e27 2c20 6669 6c65 6e61 6d65 3d6d  ion', filename=m
+000515e0: 796d 6d2b 6d79 7365 702b 2262 7261 696e  ymm+mysep+"brain
+000515f0: 6578 7472 6163 7469 6f6e 2e70 6e67 2220  extraction.png" 
+00051600: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00051610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051620: 2020 2020 2020 2020 2020 616e 7473 2e70            ants.p
+00051630: 6c6f 7428 2074 6162 5072 6f5b 276b 6b27  lot( tabPro['kk'
+00051640: 5d5b 2774 6869 636b 6e65 7373 5f69 6d61  ]['thickness_ima
+00051650: 6765 275d 2c20 6178 6973 3d32 2c20 6e73  ge'], axis=2, ns
+00051660: 6c69 6365 733d 6d61 7873 6c69 6365 2c20  lices=maxslice, 
+00051670: 6e63 6f6c 3d37 2c20 6372 6f70 3d54 7275  ncol=7, crop=Tru
+00051680: 652c 2074 6974 6c65 3d27 6b6b 272c 0a20  e, title='kk',. 
 00051690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000516a0: 2020 2020 2020 2020 2020 6966 206d 796d            if mym
-000516b0: 6f64 203d 3d20 2754 3246 6c61 6972 2720  od == 'T2Flair' 
-000516c0: 616e 6420 6973 6861 7065 6c65 6e20 3d3d  and ishapelen ==
-000516d0: 2033 2061 6e64 206e 702e 6d69 6e28 696d   3 and np.min(im
-000516e0: 672e 7368 6170 6529 203e 2031 353a 0a20  g.shape) > 15:. 
+000516a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000516b0: 2020 2020 2020 2063 6d61 703d 2770 6c61         cmap='pla
+000516c0: 736d 6127 2c20 6669 6c65 6e61 6d65 3d6d  sma', filename=m
+000516d0: 796d 6d2b 6d79 7365 702b 226b 6b74 6869  ymm+mysep+"kkthi
+000516e0: 636b 6e65 7373 2e70 6e67 2220 290a 2020  ckness.png" ).  
 000516f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051700: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00051710: 6f77 7269 7465 3d54 7275 650a 2020 2020  owrite=True.    
-00051720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051730: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00051740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00051700: 2020 2020 2020 2020 2020 6966 206d 796d            if mym
+00051710: 6f64 203d 3d20 2754 3246 6c61 6972 2720  od == 'T2Flair' 
+00051720: 616e 6420 6973 6861 7065 6c65 6e20 3d3d  and ishapelen ==
+00051730: 2033 2061 6e64 206e 702e 6d69 6e28 696d   3 and np.min(im
+00051740: 672e 7368 6170 6529 203e 2031 353a 0a20  g.shape) > 15:. 
 00051750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051760: 2020 2020 2074 6162 5072 6f2c 206e 6f72       tabPro, nor
-00051770: 6d50 726f 203d 206d 6d28 2074 312c 2068  mPro = mm( t1, h
-00051780: 6965 722c 0a20 2020 2020 2020 2020 2020  ier,.           
-00051790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000517a0: 2020 2020 2020 2020 2020 2020 2066 6c61               fla
-000517b0: 6972 5f69 6d61 6765 203d 2069 6d67 2c0a  ir_image = img,.
-000517c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000517d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000517e0: 2020 2020 2020 2020 7372 6d6f 6465 6c3d          srmodel=
-000517f0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00051800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051810: 2020 2020 2020 2020 2020 2020 2020 646f                do
-00051820: 5f74 7261 6374 6f67 7261 7068 793d 4661  _tractography=Fa
-00051830: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
-00051840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051850: 2020 2020 2020 2020 2020 2020 2064 6f5f               do_
-00051860: 6b6b 3d46 616c 7365 2c0a 2020 2020 2020  kk=False,.      
-00051870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051890: 2020 646f 5f6e 6f72 6d61 6c69 7a61 7469    do_normalizati
-000518a0: 6f6e 3d74 656d 706c 6174 6554 782c 0a20  on=templateTx,. 
-000518b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000518c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000518d0: 2020 2020 2020 2067 726f 7570 5f74 656d         group_tem
-000518e0: 706c 6174 6520 3d20 6e6f 726d 616c 697a  plate = normaliz
-000518f0: 6174 696f 6e5f 7465 6d70 6c61 7465 2c0a  ation_template,.
-00051900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051760: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00051770: 6f77 7269 7465 3d54 7275 650a 2020 2020  owrite=True.    
+00051780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051790: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+000517a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000517b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000517c0: 2020 2020 2074 6162 5072 6f2c 206e 6f72       tabPro, nor
+000517d0: 6d50 726f 203d 206d 6d28 2074 312c 2068  mPro = mm( t1, h
+000517e0: 6965 722c 0a20 2020 2020 2020 2020 2020  ier,.           
+000517f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051800: 2020 2020 2020 2020 2020 2020 2066 6c61               fla
+00051810: 6972 5f69 6d61 6765 203d 2069 6d67 2c0a  ir_image = img,.
+00051820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051840: 2020 2020 2020 2020 7372 6d6f 6465 6c3d          srmodel=
+00051850: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00051860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051870: 2020 2020 2020 2020 2020 2020 2020 646f                do
+00051880: 5f74 7261 6374 6f67 7261 7068 793d 4661  _tractography=Fa
+00051890: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
+000518a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000518b0: 2020 2020 2020 2020 2020 2020 2064 6f5f               do_
+000518c0: 6b6b 3d46 616c 7365 2c0a 2020 2020 2020  kk=False,.      
+000518d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000518e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000518f0: 2020 646f 5f6e 6f72 6d61 6c69 7a61 7469    do_normalizati
+00051900: 6f6e 3d74 656d 706c 6174 6554 782c 0a20  on=templateTx,. 
 00051910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051920: 2020 2020 2020 2020 6772 6f75 705f 7472          group_tr
-00051930: 616e 7366 6f72 6d20 3d20 6772 6f75 7054  ansform = groupT
-00051940: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-00051950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051960: 2020 2020 2020 2020 2020 2074 6573 745f             test_
-00051970: 7275 6e3d 7465 7374 5f72 756e 2c0a 2020  run=test_run,.  
-00051980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000519a0: 2020 2020 2020 7665 7262 6f73 653d 5472        verbose=Tr
-000519b0: 7565 2029 0a20 2020 2020 2020 2020 2020  ue ).           
-000519c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000519d0: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-000519e0: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
+00051920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051930: 2020 2020 2020 2067 726f 7570 5f74 656d         group_tem
+00051940: 706c 6174 6520 3d20 6e6f 726d 616c 697a  plate = normaliz
+00051950: 6174 696f 6e5f 7465 6d70 6c61 7465 2c0a  ation_template,.
+00051960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051980: 2020 2020 2020 2020 6772 6f75 705f 7472          group_tr
+00051990: 616e 7366 6f72 6d20 3d20 6772 6f75 7054  ansform = groupT
+000519a0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+000519b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000519c0: 2020 2020 2020 2020 2020 2074 6573 745f             test_
+000519d0: 7275 6e3d 7465 7374 5f72 756e 2c0a 2020  run=test_run,.  
+000519e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000519f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051a10: 2020 2020 6572 726f 725f 696e 666f 203d      error_info =
-00051a20: 2074 7261 6365 6261 636b 2e66 6f72 6d61   traceback.forma
-00051a30: 745f 6578 6328 290a 2020 2020 2020 2020  t_exc().        
-00051a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051a00: 2020 2020 2020 7665 7262 6f73 653d 5472        verbose=Tr
+00051a10: 7565 2029 0a20 2020 2020 2020 2020 2020  ue ).           
+00051a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051a30: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+00051a40: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
 00051a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051a60: 7072 696e 7428 6572 726f 725f 696e 666f  print(error_info
-00051a70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00051a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051a90: 2020 2020 2020 2020 2020 7669 7375 616c            visual
-00051aa0: 697a 653d 4661 6c73 650a 2020 2020 2020  ize=False.      
+00051a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051a70: 2020 2020 6572 726f 725f 696e 666f 203d      error_info =
+00051a80: 2074 7261 6365 6261 636b 2e66 6f72 6d61   traceback.forma
+00051a90: 745f 6578 6328 290a 2020 2020 2020 2020  t_exc().        
+00051aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00051ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051ad0: 2020 646f 7772 6974 653d 4661 6c73 650a    dowrite=False.
+00051ac0: 7072 696e 7428 6572 726f 725f 696e 666f  print(error_info
+00051ad0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
 00051ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051b00: 2020 2020 2020 2020 7072 696e 7428 6622          print(f"
-00051b10: 616e 7473 7079 6d6d 6572 726f 7220 6f63  antspymmerror oc
-00051b20: 6375 7272 6564 2077 6869 6c65 2070 726f  curred while pro
-00051b30: 6365 7373 696e 6720 7b6f 7665 726d 6f64  cessing {overmod
-00051b40: 587d 3a20 7b65 7d22 290a 2020 2020 2020  X}: {e}").      
+00051af0: 2020 2020 2020 2020 2020 7669 7375 616c            visual
+00051b00: 697a 653d 4661 6c73 650a 2020 2020 2020  ize=False.      
+00051b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051b30: 2020 646f 7772 6974 653d 4661 6c73 650a    dowrite=False.
+00051b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00051b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051b70: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
-00051b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051b90: 2020 2020 2020 2069 6620 7669 7375 616c         if visual
-00051ba0: 697a 653a 0a20 2020 2020 2020 2020 2020  ize:.           
+00051b60: 2020 2020 2020 2020 7072 696e 7428 6622          print(f"
+00051b70: 616e 7473 7079 6d6d 6572 726f 7220 6f63  antspymmerror oc
+00051b80: 6375 7272 6564 2077 6869 6c65 2070 726f  curred while pro
+00051b90: 6365 7373 696e 6720 7b6f 7665 726d 6f64  cessing {overmod
+00051ba0: 587d 3a20 7b65 7d22 290a 2020 2020 2020  X}: {e}").      
 00051bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051bc0: 2020 2020 2020 2020 206d 6178 736c 6963           maxslic
-00051bd0: 6520 3d20 6e70 2e6d 696e 2820 5b32 312c  e = np.min( [21,
-00051be0: 2069 6d67 2e73 6861 7065 5b32 5d20 5d20   img.shape[2] ] 
-00051bf0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00051c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051c10: 2020 2020 2020 616e 7473 2e70 6c6f 745f        ants.plot_
-00051c20: 6f72 7468 6f28 2069 6d67 2c20 6372 6f70  ortho( img, crop
-00051c30: 3d54 7275 652c 2074 6974 6c65 3d27 466c  =True, title='Fl
-00051c40: 6169 7227 2c20 6669 6c65 6e61 6d65 3d6d  air', filename=m
-00051c50: 796d 6d2b 6d79 7365 702b 2266 6c61 6972  ymm+mysep+"flair
-00051c60: 2e70 6e67 222c 2066 6c61 743d 5472 7565  .png", flat=True
-00051c70: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00051c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051c90: 2020 2020 2020 2061 6e74 732e 706c 6f74         ants.plot
-00051ca0: 5f6f 7274 686f 2820 696d 672c 2074 6162  _ortho( img, tab
-00051cb0: 5072 6f5b 2766 6c61 6972 275d 5b27 574d  Pro['flair']['WM
-00051cc0: 485f 7072 6f62 6162 696c 6974 795f 6d61  H_probability_ma
-00051cd0: 7027 5d2c 2063 726f 703d 5472 7565 2c20  p'], crop=True, 
-00051ce0: 7469 746c 653d 2746 6c61 6972 202b 2057  title='Flair + W
-00051cf0: 4d48 272c 2066 696c 656e 616d 653d 6d79  MH', filename=my
-00051d00: 6d6d 2b6d 7973 6570 2b22 666c 6169 7257  mm+mysep+"flairW
-00051d10: 4d48 2e70 6e67 222c 2066 6c61 743d 5472  MH.png", flat=Tr
-00051d20: 7565 2029 0a20 2020 2020 2020 2020 2020  ue ).           
-00051d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051d40: 2020 2020 2020 2020 2069 6620 7461 6250           if tabP
-00051d50: 726f 5b27 666c 6169 7227 5d5b 2757 4d48  ro['flair']['WMH
-00051d60: 5f70 6f73 7465 7269 6f72 5f70 726f 6261  _posterior_proba
-00051d70: 6269 6c69 7479 5f6d 6170 275d 2069 7320  bility_map'] is 
-00051d80: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00051bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051bd0: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
+00051be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051bf0: 2020 2020 2020 2069 6620 7669 7375 616c         if visual
+00051c00: 697a 653a 0a20 2020 2020 2020 2020 2020  ize:.           
+00051c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051c20: 2020 2020 2020 2020 206d 6178 736c 6963           maxslic
+00051c30: 6520 3d20 6e70 2e6d 696e 2820 5b32 312c  e = np.min( [21,
+00051c40: 2069 6d67 2e73 6861 7065 5b32 5d20 5d20   img.shape[2] ] 
+00051c50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00051c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051c70: 2020 2020 2020 616e 7473 2e70 6c6f 745f        ants.plot_
+00051c80: 6f72 7468 6f28 2069 6d67 2c20 6372 6f70  ortho( img, crop
+00051c90: 3d54 7275 652c 2074 6974 6c65 3d27 466c  =True, title='Fl
+00051ca0: 6169 7227 2c20 6669 6c65 6e61 6d65 3d6d  air', filename=m
+00051cb0: 796d 6d2b 6d79 7365 702b 2266 6c61 6972  ymm+mysep+"flair
+00051cc0: 2e70 6e67 222c 2066 6c61 743d 5472 7565  .png", flat=True
+00051cd0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00051ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051cf0: 2020 2020 2020 2061 6e74 732e 706c 6f74         ants.plot
+00051d00: 5f6f 7274 686f 2820 696d 672c 2074 6162  _ortho( img, tab
+00051d10: 5072 6f5b 2766 6c61 6972 275d 5b27 574d  Pro['flair']['WM
+00051d20: 485f 7072 6f62 6162 696c 6974 795f 6d61  H_probability_ma
+00051d30: 7027 5d2c 2063 726f 703d 5472 7565 2c20  p'], crop=True, 
+00051d40: 7469 746c 653d 2746 6c61 6972 202b 2057  title='Flair + W
+00051d50: 4d48 272c 2066 696c 656e 616d 653d 6d79  MH', filename=my
+00051d60: 6d6d 2b6d 7973 6570 2b22 666c 6169 7257  mm+mysep+"flairW
+00051d70: 4d48 2e70 6e67 222c 2066 6c61 743d 5472  MH.png", flat=Tr
+00051d80: 7565 2029 0a20 2020 2020 2020 2020 2020  ue ).           
 00051d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051db0: 2020 616e 7473 2e70 6c6f 745f 6f72 7468    ants.plot_orth
-00051dc0: 6f28 2069 6d67 2c20 7461 6250 726f 5b27  o( img, tabPro['
-00051dd0: 666c 6169 7227 5d5b 2757 4d48 5f70 6f73  flair']['WMH_pos
-00051de0: 7465 7269 6f72 5f70 726f 6261 6269 6c69  terior_probabili
-00051df0: 7479 5f6d 6170 275d 2c20 2063 726f 703d  ty_map'],  crop=
-00051e00: 5472 7565 2c20 7469 746c 653d 2746 6c61  True, title='Fla
-00051e10: 6972 202b 2070 7269 6f72 2057 4d48 272c  ir + prior WMH',
-00051e20: 2066 696c 656e 616d 653d 6d79 6d6d 2b6d   filename=mymm+m
-00051e30: 7973 6570 2b22 666c 6169 7270 7269 6f72  ysep+"flairprior
-00051e40: 574d 482e 706e 6722 2c20 666c 6174 3d54  WMH.png", flat=T
-00051e50: 7275 6520 290a 2020 2020 2020 2020 2020  rue ).          
-00051e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051e70: 2020 6966 2028 206d 796d 6f64 203d 3d20    if ( mymod == 
-00051e80: 2772 7366 4d52 495f 4c52 2720 6f72 206d  'rsfMRI_LR' or m
-00051e90: 796d 6f64 203d 3d20 2772 7366 4d52 495f  ymod == 'rsfMRI_
-00051ea0: 524c 2720 6f72 206d 796d 6f64 203d 3d20  RL' or mymod == 
-00051eb0: 2772 7366 4d52 4927 2029 2020 616e 6420  'rsfMRI' )  and 
-00051ec0: 6973 6861 7065 6c65 6e20 3d3d 2034 3a0a  ishapelen == 4:.
-00051ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051ef0: 696d 6732 203d 204e 6f6e 650a 2020 2020  img2 = None.    
-00051f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051f10: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-00051f20: 656e 2820 6d79 696d 6773 7220 2920 3e20  en( myimgsr ) > 
-00051f30: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00051da0: 2020 2020 2020 2020 2069 6620 7461 6250           if tabP
+00051db0: 726f 5b27 666c 6169 7227 5d5b 2757 4d48  ro['flair']['WMH
+00051dc0: 5f70 6f73 7465 7269 6f72 5f70 726f 6261  _posterior_proba
+00051dd0: 6269 6c69 7479 5f6d 6170 275d 2069 7320  bility_map'] is 
+00051de0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00051df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051e10: 2020 616e 7473 2e70 6c6f 745f 6f72 7468    ants.plot_orth
+00051e20: 6f28 2069 6d67 2c20 7461 6250 726f 5b27  o( img, tabPro['
+00051e30: 666c 6169 7227 5d5b 2757 4d48 5f70 6f73  flair']['WMH_pos
+00051e40: 7465 7269 6f72 5f70 726f 6261 6269 6c69  terior_probabili
+00051e50: 7479 5f6d 6170 275d 2c20 2063 726f 703d  ty_map'],  crop=
+00051e60: 5472 7565 2c20 7469 746c 653d 2746 6c61  True, title='Fla
+00051e70: 6972 202b 2070 7269 6f72 2057 4d48 272c  ir + prior WMH',
+00051e80: 2066 696c 656e 616d 653d 6d79 6d6d 2b6d   filename=mymm+m
+00051e90: 7973 6570 2b22 666c 6169 7270 7269 6f72  ysep+"flairprior
+00051ea0: 574d 482e 706e 6722 2c20 666c 6174 3d54  WMH.png", flat=T
+00051eb0: 7275 6520 290a 2020 2020 2020 2020 2020  rue ).          
+00051ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051ed0: 2020 6966 2028 206d 796d 6f64 203d 3d20    if ( mymod == 
+00051ee0: 2772 7366 4d52 495f 4c52 2720 6f72 206d  'rsfMRI_LR' or m
+00051ef0: 796d 6f64 203d 3d20 2772 7366 4d52 495f  ymod == 'rsfMRI_
+00051f00: 524c 2720 6f72 206d 796d 6f64 203d 3d20  RL' or mymod == 
+00051f10: 2772 7366 4d52 4927 2029 2020 616e 6420  'rsfMRI' )  and 
+00051f20: 6973 6861 7065 6c65 6e20 3d3d 2034 3a0a  ishapelen == 4:.
+00051f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00051f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051f50: 2020 2020 2020 2069 6d67 3220 3d20 6d6d         img2 = mm
-00051f60: 5f72 6561 6428 206d 7969 6d67 7372 5b6d  _read( myimgsr[m
-00051f70: 7969 6d67 636f 756e 742b 315d 2029 0a20  yimgcount+1] ). 
-00051f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051fa0: 2020 2069 7368 6170 656c 656e 3220 3d20     ishapelen2 = 
-00051fb0: 6c65 6e28 2069 6d67 322e 7368 6170 6520  len( img2.shape 
-00051fc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00051fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051fe0: 2020 2020 2020 6966 2069 7368 6170 656c        if ishapel
-00051ff0: 656e 3220 213d 2034 206f 7220 3120 696e  en2 != 4 or 1 in
-00052000: 2069 6d67 322e 7368 6170 653a 0a20 2020   img2.shape:.   
-00052010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052030: 2020 2020 2069 6d67 3220 3d20 4e6f 6e65       img2 = None
-00052040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00052050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052060: 2069 6620 3120 696e 2069 6d67 2e73 6861   if 1 in img.sha
-00052070: 7065 3a0a 2020 2020 2020 2020 2020 2020  pe:.            
+00051f50: 696d 6732 203d 204e 6f6e 650a 2020 2020  img2 = None.    
+00051f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051f70: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+00051f80: 656e 2820 6d79 696d 6773 7220 2920 3e20  en( myimgsr ) > 
+00051f90: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00051fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051fb0: 2020 2020 2020 2069 6d67 3220 3d20 6d6d         img2 = mm
+00051fc0: 5f72 6561 6428 206d 7969 6d67 7372 5b6d  _read( myimgsr[m
+00051fd0: 7969 6d67 636f 756e 742b 315d 2029 0a20  yimgcount+1] ). 
+00051fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052000: 2020 2069 7368 6170 656c 656e 3220 3d20     ishapelen2 = 
+00052010: 6c65 6e28 2069 6d67 322e 7368 6170 6520  len( img2.shape 
+00052020: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00052030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052040: 2020 2020 2020 6966 2069 7368 6170 656c        if ishapel
+00052050: 656e 3220 213d 2034 206f 7220 3120 696e  en2 != 4 or 1 in
+00052060: 2069 6d67 322e 7368 6170 653a 0a20 2020   img2.shape:.   
+00052070: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00052080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052090: 2020 2020 2020 2020 7761 726e 696e 6773          warnings
-000520a0: 2e77 6172 6e28 2027 7273 664d 5249 2069  .warn( 'rsfMRI i
-000520b0: 6d61 6765 2073 6861 7065 2073 7567 6765  mage shape sugge
-000520c0: 7374 7320 6974 2069 7320 616e 2069 6e63  sts it is an inc
-000520d0: 6f72 7265 6374 6c79 2063 6f6e 7665 7274  orrectly convert
-000520e0: 6564 206d 6f73 6169 6320 696d 6167 6520  ed mosaic image 
-000520f0: 2d20 7769 6c6c 206e 6f74 2070 726f 6365  - will not proce
-00052100: 7373 2e27 290a 2020 2020 2020 2020 2020  ss.').          
-00052110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052120: 2020 2020 2020 2020 2020 646f 7772 6974            dowrit
-00052130: 653d 4661 6c73 650a 2020 2020 2020 2020  e=False.        
-00052140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052150: 2020 2020 2020 2020 2020 2020 7461 6250              tabP
-00052160: 726f 3d7b 2772 7366 273a 4e6f 6e65 7d0a  ro={'rsf':None}.
+00052090: 2020 2020 2069 6d67 3220 3d20 4e6f 6e65       img2 = None
+000520a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000520b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000520c0: 2069 6620 3120 696e 2069 6d67 2e73 6861   if 1 in img.sha
+000520d0: 7065 3a0a 2020 2020 2020 2020 2020 2020  pe:.            
+000520e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000520f0: 2020 2020 2020 2020 7761 726e 696e 6773          warnings
+00052100: 2e77 6172 6e28 2027 7273 664d 5249 2069  .warn( 'rsfMRI i
+00052110: 6d61 6765 2073 6861 7065 2073 7567 6765  mage shape sugge
+00052120: 7374 7320 6974 2069 7320 616e 2069 6e63  sts it is an inc
+00052130: 6f72 7265 6374 6c79 2063 6f6e 7665 7274  orrectly convert
+00052140: 6564 206d 6f73 6169 6320 696d 6167 6520  ed mosaic image 
+00052150: 2d20 7769 6c6c 206e 6f74 2070 726f 6365  - will not proce
+00052160: 7373 2e27 290a 2020 2020 2020 2020 2020  ss.').          
 00052170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052190: 2020 2020 6e6f 726d 5072 6f3d 7b27 7273      normPro={'rs
-000521a0: 6627 3a4e 6f6e 657d 0a20 2020 2020 2020  f':None}.       
-000521b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000521c0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00052180: 2020 2020 2020 2020 2020 646f 7772 6974            dowrit
+00052190: 653d 4661 6c73 650a 2020 2020 2020 2020  e=False.        
+000521a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000521b0: 2020 2020 2020 2020 2020 2020 7461 6250              tabP
+000521c0: 726f 3d7b 2772 7366 273a 4e6f 6e65 7d0a  ro={'rsf':None}.
 000521d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000521e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000521f0: 2020 2064 6f77 7269 7465 3d54 7275 650a     dowrite=True.
-00052200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000521f0: 2020 2020 6e6f 726d 5072 6f3d 7b27 7273      normPro={'rs
+00052200: 6627 3a4e 6f6e 657d 0a20 2020 2020 2020  f':None}.       
 00052210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052220: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00052220: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
 00052230: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00052240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052250: 2074 6162 5072 6f2c 206e 6f72 6d50 726f   tabPro, normPro
-00052260: 203d 206d 6d28 2074 312c 2068 6965 722c   = mm( t1, hier,
-00052270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00052280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052290: 2020 2020 2020 2020 2020 2020 2072 7366               rsf
-000522a0: 5f69 6d61 6765 3d5b 696d 672c 696d 6732  _image=[img,img2
-000522b0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000522c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000522d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000522e0: 726d 6f64 656c 3d4e 6f6e 652c 0a20 2020  rmodel=None,.   
-000522f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052310: 2020 2020 2020 2020 2064 6f5f 7472 6163           do_trac
-00052320: 746f 6772 6170 6879 3d46 616c 7365 2c0a  tography=False,.
-00052330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052350: 2020 2020 2020 2020 2020 2020 646f 5f6b              do_k
-00052360: 6b3d 4661 6c73 652c 0a20 2020 2020 2020  k=False,.       
-00052370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052390: 2020 2020 2064 6f5f 6e6f 726d 616c 697a       do_normaliz
-000523a0: 6174 696f 6e3d 7465 6d70 6c61 7465 5478  ation=templateTx
-000523b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000523c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000523d0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-000523e0: 6f75 705f 7465 6d70 6c61 7465 203d 206e  oup_template = n
-000523f0: 6f72 6d61 6c69 7a61 7469 6f6e 5f74 656d  ormalization_tem
-00052400: 706c 6174 652c 0a20 2020 2020 2020 2020  plate,.         
-00052410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052250: 2020 2064 6f77 7269 7465 3d54 7275 650a     dowrite=True.
+00052260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052280: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00052290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000522a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000522b0: 2074 6162 5072 6f2c 206e 6f72 6d50 726f   tabPro, normPro
+000522c0: 203d 206d 6d28 2074 312c 2068 6965 722c   = mm( t1, hier,
+000522d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000522e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000522f0: 2020 2020 2020 2020 2020 2020 2072 7366               rsf
+00052300: 5f69 6d61 6765 3d5b 696d 672c 696d 6732  _image=[img,img2
+00052310: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00052320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052330: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00052340: 726d 6f64 656c 3d4e 6f6e 652c 0a20 2020  rmodel=None,.   
+00052350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052370: 2020 2020 2020 2020 2064 6f5f 7472 6163           do_trac
+00052380: 746f 6772 6170 6879 3d46 616c 7365 2c0a  tography=False,.
+00052390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000523a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000523b0: 2020 2020 2020 2020 2020 2020 646f 5f6b              do_k
+000523c0: 6b3d 4661 6c73 652c 0a20 2020 2020 2020  k=False,.       
+000523d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000523e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000523f0: 2020 2020 2064 6f5f 6e6f 726d 616c 697a       do_normaliz
+00052400: 6174 696f 6e3d 7465 6d70 6c61 7465 5478  ation=templateTx
+00052410: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00052420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052430: 2020 2067 726f 7570 5f74 7261 6e73 666f     group_transfo
-00052440: 726d 203d 2067 726f 7570 5478 2c0a 2020  rm = groupTx,.  
-00052450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052470: 2020 2020 2020 2020 2020 7273 665f 7570            rsf_up
-00052480: 7361 6d70 6c69 6e67 203d 2072 7366 5f75  sampling = rsf_u
-00052490: 7073 616d 706c 696e 672c 0a20 2020 2020  psampling,.     
-000524a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052430: 2020 2020 2020 2020 2020 2020 2020 6772                gr
+00052440: 6f75 705f 7465 6d70 6c61 7465 203d 206e  oup_template = n
+00052450: 6f72 6d61 6c69 7a61 7469 6f6e 5f74 656d  ormalization_tem
+00052460: 706c 6174 652c 0a20 2020 2020 2020 2020  plate,.         
+00052470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052490: 2020 2067 726f 7570 5f74 7261 6e73 666f     group_transfo
+000524a0: 726d 203d 2067 726f 7570 5478 2c0a 2020  rm = groupTx,.  
 000524b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000524c0: 2020 2020 2020 2074 6573 745f 7275 6e3d         test_run=
-000524d0: 7465 7374 5f72 756e 2c0a 2020 2020 2020  test_run,.      
-000524e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000524f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052500: 2020 2020 2020 7665 7262 6f73 653d 5472        verbose=Tr
-00052510: 7565 2029 0a20 2020 2020 2020 2020 2020  ue ).           
-00052520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052530: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00052540: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+000524c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000524d0: 2020 2020 2020 2020 2020 7273 665f 7570            rsf_up
+000524e0: 7361 6d70 6c69 6e67 203d 2072 7366 5f75  sampling = rsf_u
+000524f0: 7073 616d 706c 696e 672c 0a20 2020 2020  psampling,.     
+00052500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052520: 2020 2020 2020 2074 6573 745f 7275 6e3d         test_run=
+00052530: 7465 7374 5f72 756e 2c0a 2020 2020 2020  test_run,.      
+00052540: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00052550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052570: 2020 2020 2020 2020 6572 726f 725f 696e          error_in
-00052580: 666f 203d 2074 7261 6365 6261 636b 2e66  fo = traceback.f
-00052590: 6f72 6d61 745f 6578 6328 290a 2020 2020  ormat_exc().    
-000525a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052560: 2020 2020 2020 7665 7262 6f73 653d 5472        verbose=Tr
+00052570: 7565 2029 0a20 2020 2020 2020 2020 2020  ue ).           
+00052580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052590: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+000525a0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
 000525b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000525c0: 2020 2020 7072 696e 7428 6572 726f 725f      print(error_
-000525d0: 696e 666f 290a 2020 2020 2020 2020 2020  info).          
-000525e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000525f0: 2020 2020 2020 2020 2020 2020 2020 7669                vi
-00052600: 7375 616c 697a 653d 4661 6c73 650a 2020  sualize=False.  
+000525c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000525d0: 2020 2020 2020 2020 6572 726f 725f 696e          error_in
+000525e0: 666f 203d 2074 7261 6365 6261 636b 2e66  fo = traceback.f
+000525f0: 6f72 6d61 745f 6578 6328 290a 2020 2020  ormat_exc().    
+00052600: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00052610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052630: 2020 2020 2020 646f 7772 6974 653d 4661        dowrite=Fa
-00052640: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-00052650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052660: 2020 2020 2020 2020 2020 2020 7461 6250              tabP
-00052670: 726f 3d7b 2772 7366 273a 4e6f 6e65 7d0a  ro={'rsf':None}.
+00052620: 2020 2020 7072 696e 7428 6572 726f 725f      print(error_
+00052630: 696e 666f 290a 2020 2020 2020 2020 2020  info).          
+00052640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052650: 2020 2020 2020 2020 2020 2020 2020 7669                vi
+00052660: 7375 616c 697a 653d 4661 6c73 650a 2020  sualize=False.  
+00052670: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00052680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000526a0: 2020 2020 2020 2020 6e6f 726d 5072 6f3d          normPro=
-000526b0: 7b27 7273 6627 3a4e 6f6e 657d 0a20 2020  {'rsf':None}.   
-000526c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000526d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000526e0: 2020 2020 2070 7269 6e74 2866 2261 6e74       print(f"ant
-000526f0: 7370 796d 6d65 7272 6f72 206f 6363 7572  spymmerror occur
-00052700: 7265 6420 7768 696c 6520 7072 6f63 6573  red while proces
-00052710: 7369 6e67 207b 6f76 6572 6d6f 6458 7d3a  sing {overmodX}:
-00052720: 207b 657d 2229 0a20 2020 2020 2020 2020   {e}").         
+00052690: 2020 2020 2020 646f 7772 6974 653d 4661        dowrite=Fa
+000526a0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+000526b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000526c0: 2020 2020 2020 2020 2020 2020 7461 6250              tabP
+000526d0: 726f 3d7b 2772 7366 273a 4e6f 6e65 7d0a  ro={'rsf':None}.
+000526e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000526f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052700: 2020 2020 2020 2020 6e6f 726d 5072 6f3d          normPro=
+00052710: 7b27 7273 6627 3a4e 6f6e 657d 0a20 2020  {'rsf':None}.   
+00052720: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00052730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052740: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00052750: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
-00052760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052770: 2020 2020 6966 2074 6162 5072 6f5b 2772      if tabPro['r
-00052780: 7366 275d 2069 7320 6e6f 7420 4e6f 6e65  sf'] is not None
-00052790: 2061 6e64 2076 6973 7561 6c69 7a65 3a0a   and visualize:.
-000527a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000527b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000527c0: 2020 2020 666f 7220 7470 726f 2069 6e20      for tpro in 
-000527d0: 7461 6250 726f 5b27 7273 6627 5d3a 2023  tabPro['rsf']: #
-000527e0: 2046 4958 4d45 5253 460a 2020 2020 2020   FIXMERSF.      
-000527f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052740: 2020 2020 2070 7269 6e74 2866 2261 6e74       print(f"ant
+00052750: 7370 796d 6d65 7272 6f72 206f 6363 7572  spymmerror occur
+00052760: 7265 6420 7768 696c 6520 7072 6f63 6573  red while proces
+00052770: 7369 6e67 207b 6f76 6572 6d6f 6458 7d3a  sing {overmodX}:
+00052780: 207b 657d 2229 0a20 2020 2020 2020 2020   {e}").         
+00052790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000527a0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000527b0: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
+000527c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000527d0: 2020 2020 6966 2074 6162 5072 6f5b 2772      if tabPro['r
+000527e0: 7366 275d 2069 7320 6e6f 7420 4e6f 6e65  sf'] is not None
+000527f0: 2061 6e64 2076 6973 7561 6c69 7a65 3a0a   and visualize:.
 00052800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052810: 2020 6d61 7873 6c69 6365 203d 206e 702e    maxslice = np.
-00052820: 6d69 6e28 205b 3231 2c20 7470 726f 5b27  min( [21, tpro['
-00052830: 6d65 616e 426f 6c64 275d 2e73 6861 7065  meanBold'].shape
-00052840: 5b32 5d20 5d20 290a 2020 2020 2020 2020  [2] ] ).        
+00052810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052820: 2020 2020 666f 7220 7470 726f 2069 6e20      for tpro in 
+00052830: 7461 6250 726f 5b27 7273 6627 5d3a 2023  tabPro['rsf']: #
+00052840: 2046 4958 4d45 5253 460a 2020 2020 2020   FIXMERSF.      
 00052850: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00052860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052870: 7470 726f 7072 6566 6978 203d 206d 796d  tproprefix = mym
-00052880: 6d2b 6d79 7365 702b 7374 7228 7470 726f  m+mysep+str(tpro
-00052890: 5b27 7061 7261 6d73 6574 275d 292b 6d79  ['paramset'])+my
-000528a0: 7365 700a 2020 2020 2020 2020 2020 2020  sep.            
+00052870: 2020 6d61 7873 6c69 6365 203d 206e 702e    maxslice = np.
+00052880: 6d69 6e28 205b 3231 2c20 7470 726f 5b27  min( [21, tpro['
+00052890: 6d65 616e 426f 6c64 275d 2e73 6861 7065  meanBold'].shape
+000528a0: 5b32 5d20 5d20 290a 2020 2020 2020 2020  [2] ] ).        
 000528b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000528c0: 2020 2020 2020 2020 2020 2020 616e 7473              ants
-000528d0: 2e70 6c6f 7428 2074 7072 6f5b 276d 6561  .plot( tpro['mea
-000528e0: 6e42 6f6c 6427 5d2c 0a20 2020 2020 2020  nBold'],.       
-000528f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052910: 2020 2020 2061 7869 733d 322c 206e 736c       axis=2, nsl
-00052920: 6963 6573 3d6d 6178 736c 6963 652c 206e  ices=maxslice, n
-00052930: 636f 6c3d 372c 2063 726f 703d 5472 7565  col=7, crop=True
-00052940: 2c20 7469 746c 653d 276d 6561 6e42 4f4c  , title='meanBOL
-00052950: 4427 2c20 6669 6c65 6e61 6d65 3d74 7072  D', filename=tpr
-00052960: 6f70 7265 6669 782b 226d 6561 6e42 4f4c  oprefix+"meanBOL
-00052970: 442e 706e 6722 2029 0a20 2020 2020 2020  D.png" ).       
-00052980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000529a0: 2061 6e74 732e 706c 6f74 2820 7470 726f   ants.plot( tpro
-000529b0: 5b27 6d65 616e 426f 6c64 275d 2c20 616e  ['meanBold'], an
-000529c0: 7473 2e69 4d61 7468 2874 7072 6f5b 2761  ts.iMath(tpro['a
-000529d0: 6c66 6627 5d2c 224e 6f72 6d61 6c69 7a65  lff'],"Normalize
-000529e0: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+000528c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000528d0: 7470 726f 7072 6566 6978 203d 206d 796d  tproprefix = mym
+000528e0: 6d2b 6d79 7365 702b 7374 7228 7470 726f  m+mysep+str(tpro
+000528f0: 5b27 7061 7261 6d73 6574 275d 292b 6d79  ['paramset'])+my
+00052900: 7365 700a 2020 2020 2020 2020 2020 2020  sep.            
+00052910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052920: 2020 2020 2020 2020 2020 2020 616e 7473              ants
+00052930: 2e70 6c6f 7428 2074 7072 6f5b 276d 6561  .plot( tpro['mea
+00052940: 6e42 6f6c 6427 5d2c 0a20 2020 2020 2020  nBold'],.       
+00052950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052970: 2020 2020 2061 7869 733d 322c 206e 736c       axis=2, nsl
+00052980: 6963 6573 3d6d 6178 736c 6963 652c 206e  ices=maxslice, n
+00052990: 636f 6c3d 372c 2063 726f 703d 5472 7565  col=7, crop=True
+000529a0: 2c20 7469 746c 653d 276d 6561 6e42 4f4c  , title='meanBOL
+000529b0: 4427 2c20 6669 6c65 6e61 6d65 3d74 7072  D', filename=tpr
+000529c0: 6f70 7265 6669 782b 226d 6561 6e42 4f4c  oprefix+"meanBOL
+000529d0: 442e 706e 6722 2029 0a20 2020 2020 2020  D.png" ).       
+000529e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000529f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052a10: 6178 6973 3d32 2c20 6e73 6c69 6365 733d  axis=2, nslices=
-00052a20: 6d61 7873 6c69 6365 2c20 6e63 6f6c 3d37  maxslice, ncol=7
-00052a30: 2c20 6372 6f70 3d54 7275 652c 2074 6974  , crop=True, tit
-00052a40: 6c65 3d27 414c 4646 272c 2066 696c 656e  le='ALFF', filen
-00052a50: 616d 653d 7470 726f 7072 6566 6978 2b22  ame=tproprefix+"
-00052a60: 626f 6c64 414c 4646 2e70 6e67 2220 290a  boldALFF.png" ).
-00052a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052a90: 2020 2020 2020 2020 616e 7473 2e70 6c6f          ants.plo
-00052aa0: 7428 2074 7072 6f5b 276d 6561 6e42 6f6c  t( tpro['meanBol
-00052ab0: 6427 5d2c 2061 6e74 732e 694d 6174 6828  d'], ants.iMath(
-00052ac0: 7470 726f 5b27 6661 6c66 6627 5d2c 224e  tpro['falff'],"N
-00052ad0: 6f72 6d61 6c69 7a65 2229 2c0a 2020 2020  ormalize"),.    
+00052a00: 2061 6e74 732e 706c 6f74 2820 7470 726f   ants.plot( tpro
+00052a10: 5b27 6d65 616e 426f 6c64 275d 2c20 616e  ['meanBold'], an
+00052a20: 7473 2e69 4d61 7468 2874 7072 6f5b 2761  ts.iMath(tpro['a
+00052a30: 6c66 6627 5d2c 224e 6f72 6d61 6c69 7a65  lff'],"Normalize
+00052a40: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00052a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052a70: 6178 6973 3d32 2c20 6e73 6c69 6365 733d  axis=2, nslices=
+00052a80: 6d61 7873 6c69 6365 2c20 6e63 6f6c 3d37  maxslice, ncol=7
+00052a90: 2c20 6372 6f70 3d54 7275 652c 2074 6974  , crop=True, tit
+00052aa0: 6c65 3d27 414c 4646 272c 2066 696c 656e  le='ALFF', filen
+00052ab0: 616d 653d 7470 726f 7072 6566 6978 2b22  ame=tproprefix+"
+00052ac0: 626f 6c64 414c 4646 2e70 6e67 2220 290a  boldALFF.png" ).
+00052ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00052ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052b00: 2020 2020 2020 2020 6178 6973 3d32 2c20          axis=2, 
-00052b10: 6e73 6c69 6365 733d 6d61 7873 6c69 6365  nslices=maxslice
-00052b20: 2c20 6e63 6f6c 3d37 2c20 6372 6f70 3d54  , ncol=7, crop=T
-00052b30: 7275 652c 2074 6974 6c65 3d27 6641 4c46  rue, title='fALF
-00052b40: 4627 2c20 6669 6c65 6e61 6d65 3d74 7072  F', filename=tpr
-00052b50: 6f70 7265 6669 782b 2262 6f6c 6466 414c  oprefix+"boldfAL
-00052b60: 4646 2e70 6e67 2220 290a 2020 2020 2020  FF.png" ).      
-00052b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052b90: 2020 6466 6e3d 7470 726f 5b27 6466 6e6e    dfn=tpro['dfnn
-00052ba0: 616d 6527 5d0a 2020 2020 2020 2020 2020  ame'].          
-00052bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052bc0: 2020 2020 2020 2020 2020 2020 2020 616e                an
-00052bd0: 7473 2e70 6c6f 7428 2074 7072 6f5b 276d  ts.plot( tpro['m
-00052be0: 6561 6e42 6f6c 6427 5d2c 2074 7072 6f5b  eanBold'], tpro[
-00052bf0: 6466 6e5d 2c0a 2020 2020 2020 2020 2020  dfn],.          
-00052c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052af0: 2020 2020 2020 2020 616e 7473 2e70 6c6f          ants.plo
+00052b00: 7428 2074 7072 6f5b 276d 6561 6e42 6f6c  t( tpro['meanBol
+00052b10: 6427 5d2c 2061 6e74 732e 694d 6174 6828  d'], ants.iMath(
+00052b20: 7470 726f 5b27 6661 6c66 6627 5d2c 224e  tpro['falff'],"N
+00052b30: 6f72 6d61 6c69 7a65 2229 2c0a 2020 2020  ormalize"),.    
+00052b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052b60: 2020 2020 2020 2020 6178 6973 3d32 2c20          axis=2, 
+00052b70: 6e73 6c69 6365 733d 6d61 7873 6c69 6365  nslices=maxslice
+00052b80: 2c20 6e63 6f6c 3d37 2c20 6372 6f70 3d54  , ncol=7, crop=T
+00052b90: 7275 652c 2074 6974 6c65 3d27 6641 4c46  rue, title='fALF
+00052ba0: 4627 2c20 6669 6c65 6e61 6d65 3d74 7072  F', filename=tpr
+00052bb0: 6f70 7265 6669 782b 2262 6f6c 6466 414c  oprefix+"boldfAL
+00052bc0: 4646 2e70 6e67 2220 290a 2020 2020 2020  FF.png" ).      
+00052bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052bf0: 2020 6466 6e3d 7470 726f 5b27 6466 6e6e    dfn=tpro['dfnn
+00052c00: 616d 6527 5d0a 2020 2020 2020 2020 2020  ame'].          
 00052c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052c20: 2020 6178 6973 3d32 2c20 6e73 6c69 6365    axis=2, nslice
-00052c30: 733d 6d61 7873 6c69 6365 2c20 6e63 6f6c  s=maxslice, ncol
-00052c40: 3d37 2c20 6372 6f70 3d54 7275 652c 2074  =7, crop=True, t
-00052c50: 6974 6c65 3d64 666e 2c20 6669 6c65 6e61  itle=dfn, filena
-00052c60: 6d65 3d74 7072 6f70 7265 6669 782b 2262  me=tproprefix+"b
-00052c70: 6f6c 6444 6566 6175 6c74 4d6f 6465 2e70  oldDefaultMode.p
-00052c80: 6e67 2220 290a 2020 2020 2020 2020 2020  ng" ).          
-00052c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052ca0: 2020 6966 2028 206d 796d 6f64 203d 3d20    if ( mymod == 
-00052cb0: 2770 6572 6627 2029 2061 6e64 2069 7368  'perf' ) and ish
-00052cc0: 6170 656c 656e 203d 3d20 343a 0a20 2020  apelen == 4:.   
-00052cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052ce0: 2020 2020 2020 2020 2020 2020 2064 6f77               dow
-00052cf0: 7269 7465 3d54 7275 650a 2020 2020 2020  rite=True.      
-00052d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052d10: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00052d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052c20: 2020 2020 2020 2020 2020 2020 2020 616e                an
+00052c30: 7473 2e70 6c6f 7428 2074 7072 6f5b 276d  ts.plot( tpro['m
+00052c40: 6561 6e42 6f6c 6427 5d2c 2074 7072 6f5b  eanBold'], tpro[
+00052c50: 6466 6e5d 2c0a 2020 2020 2020 2020 2020  dfn],.          
+00052c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052c80: 2020 6178 6973 3d32 2c20 6e73 6c69 6365    axis=2, nslice
+00052c90: 733d 6d61 7873 6c69 6365 2c20 6e63 6f6c  s=maxslice, ncol
+00052ca0: 3d37 2c20 6372 6f70 3d54 7275 652c 2074  =7, crop=True, t
+00052cb0: 6974 6c65 3d64 666e 2c20 6669 6c65 6e61  itle=dfn, filena
+00052cc0: 6d65 3d74 7072 6f70 7265 6669 782b 2262  me=tproprefix+"b
+00052cd0: 6f6c 6444 6566 6175 6c74 4d6f 6465 2e70  oldDefaultMode.p
+00052ce0: 6e67 2220 290a 2020 2020 2020 2020 2020  ng" ).          
+00052cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052d00: 2020 6966 2028 206d 796d 6f64 203d 3d20    if ( mymod == 
+00052d10: 2770 6572 6627 2029 2061 6e64 2069 7368  'perf' ) and ish
+00052d20: 6170 656c 656e 203d 3d20 343a 0a20 2020  apelen == 4:.   
 00052d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052d40: 2020 2074 6162 5072 6f2c 206e 6f72 6d50     tabPro, normP
-00052d50: 726f 203d 206d 6d28 2074 312c 2068 6965  ro = mm( t1, hie
-00052d60: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-00052d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052d80: 2020 2020 2020 2020 2020 2070 6572 6675             perfu
-00052d90: 7369 6f6e 5f69 6d61 6765 3d69 6d67 2c0a  sion_image=img,.
-00052da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052dc0: 2020 2020 2020 2020 7372 6d6f 6465 6c3d          srmodel=
-00052dd0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00052de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052df0: 2020 2020 2020 2020 2020 2020 2020 646f                do
-00052e00: 5f74 7261 6374 6f67 7261 7068 793d 4661  _tractography=Fa
-00052e10: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
-00052e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052e30: 2020 2020 2020 2020 2020 2020 2064 6f5f               do_
-00052e40: 6b6b 3d46 616c 7365 2c0a 2020 2020 2020  kk=False,.      
-00052e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052e70: 2020 646f 5f6e 6f72 6d61 6c69 7a61 7469    do_normalizati
-00052e80: 6f6e 3d74 656d 706c 6174 6554 782c 0a20  on=templateTx,. 
-00052e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052eb0: 2020 2020 2020 2067 726f 7570 5f74 656d         group_tem
-00052ec0: 706c 6174 6520 3d20 6e6f 726d 616c 697a  plate = normaliz
-00052ed0: 6174 696f 6e5f 7465 6d70 6c61 7465 2c0a  ation_template,.
-00052ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052d40: 2020 2020 2020 2020 2020 2020 2064 6f77               dow
+00052d50: 7269 7465 3d54 7275 650a 2020 2020 2020  rite=True.      
+00052d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052d70: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00052d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052da0: 2020 2074 6162 5072 6f2c 206e 6f72 6d50     tabPro, normP
+00052db0: 726f 203d 206d 6d28 2074 312c 2068 6965  ro = mm( t1, hie
+00052dc0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+00052dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052de0: 2020 2020 2020 2020 2020 2070 6572 6675             perfu
+00052df0: 7369 6f6e 5f69 6d61 6765 3d69 6d67 2c0a  sion_image=img,.
+00052e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052e20: 2020 2020 2020 2020 7372 6d6f 6465 6c3d          srmodel=
+00052e30: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00052e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052e50: 2020 2020 2020 2020 2020 2020 2020 646f                do
+00052e60: 5f74 7261 6374 6f67 7261 7068 793d 4661  _tractography=Fa
+00052e70: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
+00052e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052e90: 2020 2020 2020 2020 2020 2020 2064 6f5f               do_
+00052ea0: 6b6b 3d46 616c 7365 2c0a 2020 2020 2020  kk=False,.      
+00052eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052ed0: 2020 646f 5f6e 6f72 6d61 6c69 7a61 7469    do_normalizati
+00052ee0: 6f6e 3d74 656d 706c 6174 6554 782c 0a20  on=templateTx,. 
 00052ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052f00: 2020 2020 2020 2020 6772 6f75 705f 7472          group_tr
-00052f10: 616e 7366 6f72 6d20 3d20 6772 6f75 7054  ansform = groupT
-00052f20: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-00052f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052f40: 2020 2020 2020 2020 2020 2074 6573 745f             test_
-00052f50: 7275 6e3d 7465 7374 5f72 756e 2c0a 2020  run=test_run,.  
-00052f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052f80: 2020 2020 2020 7065 7266 7573 696f 6e5f        perfusion_
-00052f90: 7472 696d 3d70 6572 6675 7369 6f6e 5f74  trim=perfusion_t
-00052fa0: 7269 6d2c 0a20 2020 2020 2020 2020 2020  rim,.           
-00052fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052fc0: 2020 2020 2020 2020 2020 2020 2070 6572               per
-00052fd0: 6675 7369 6f6e 5f6d 305f 696d 6167 653d  fusion_m0_image=
-00052fe0: 7065 7266 7573 696f 6e5f 6d30 5f69 6d61  perfusion_m0_ima
-00052ff0: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
-00053000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053010: 2020 2020 2020 2020 2020 2020 7065 7266              perf
-00053020: 7573 696f 6e5f 6d30 3d70 6572 6675 7369  usion_m0=perfusi
-00053030: 6f6e 5f6d 302c 0a20 2020 2020 2020 2020  on_m0,.         
-00053040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053050: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-00053060: 6572 626f 7365 3d54 7275 6520 290a 2020  erbose=True ).  
-00053070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053080: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00053090: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-000530a0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-000530b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000530c0: 2020 2020 2020 2020 2020 2020 2065 7272               err
-000530d0: 6f72 5f69 6e66 6f20 3d20 7472 6163 6562  or_info = traceb
-000530e0: 6163 6b2e 666f 726d 6174 5f65 7863 2829  ack.format_exc()
-000530f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00053100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053110: 2020 2020 2020 2020 2070 7269 6e74 2865           print(e
-00053120: 7272 6f72 5f69 6e66 6f29 0a20 2020 2020  rror_info).     
-00053130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053150: 2020 2076 6973 7561 6c69 7a65 3d46 616c     visualize=Fal
-00053160: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-00053170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053180: 2020 2020 2020 2020 2020 2064 6f77 7269             dowri
-00053190: 7465 3d46 616c 7365 0a20 2020 2020 2020  te=False.       
+00052f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052f10: 2020 2020 2020 2067 726f 7570 5f74 656d         group_tem
+00052f20: 706c 6174 6520 3d20 6e6f 726d 616c 697a  plate = normaliz
+00052f30: 6174 696f 6e5f 7465 6d70 6c61 7465 2c0a  ation_template,.
+00052f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052f60: 2020 2020 2020 2020 6772 6f75 705f 7472          group_tr
+00052f70: 616e 7366 6f72 6d20 3d20 6772 6f75 7054  ansform = groupT
+00052f80: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+00052f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052fa0: 2020 2020 2020 2020 2020 2074 6573 745f             test_
+00052fb0: 7275 6e3d 7465 7374 5f72 756e 2c0a 2020  run=test_run,.  
+00052fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052fe0: 2020 2020 2020 7065 7266 7573 696f 6e5f        perfusion_
+00052ff0: 7472 696d 3d70 6572 6675 7369 6f6e 5f74  trim=perfusion_t
+00053000: 7269 6d2c 0a20 2020 2020 2020 2020 2020  rim,.           
+00053010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053020: 2020 2020 2020 2020 2020 2020 2070 6572               per
+00053030: 6675 7369 6f6e 5f6d 305f 696d 6167 653d  fusion_m0_image=
+00053040: 7065 7266 7573 696f 6e5f 6d30 5f69 6d61  perfusion_m0_ima
+00053050: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
+00053060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053070: 2020 2020 2020 2020 2020 2020 7065 7266              perf
+00053080: 7573 696f 6e5f 6d30 3d70 6572 6675 7369  usion_m0=perfusi
+00053090: 6f6e 5f6d 302c 0a20 2020 2020 2020 2020  on_m0,.         
+000530a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000530b0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+000530c0: 6572 626f 7365 3d54 7275 6520 290a 2020  erbose=True ).  
+000530d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000530e0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+000530f0: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+00053100: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+00053110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053120: 2020 2020 2020 2020 2020 2020 2065 7272               err
+00053130: 6f72 5f69 6e66 6f20 3d20 7472 6163 6562  or_info = traceb
+00053140: 6163 6b2e 666f 726d 6174 5f65 7863 2829  ack.format_exc()
+00053150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00053160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053170: 2020 2020 2020 2020 2070 7269 6e74 2865           print(e
+00053180: 7272 6f72 5f69 6e66 6f29 0a20 2020 2020  rror_info).     
+00053190: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000531a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000531b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000531c0: 2074 6162 5072 6f3d 7b27 7065 7266 273a   tabPro={'perf':
-000531d0: 4e6f 6e65 7d0a 2020 2020 2020 2020 2020  None}.          
-000531e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000531f0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00053200: 696e 7428 6622 616e 7473 7079 6d6d 6572  int(f"antspymmer
-00053210: 726f 7220 6f63 6375 7272 6564 2077 6869  ror occurred whi
-00053220: 6c65 2070 726f 6365 7373 696e 6720 7b6f  le processing {o
-00053230: 7665 726d 6f64 587d 3a20 7b65 7d22 290a  vermodX}: {e}").
+000531b0: 2020 2076 6973 7561 6c69 7a65 3d46 616c     visualize=Fal
+000531c0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+000531d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000531e0: 2020 2020 2020 2020 2020 2064 6f77 7269             dowri
+000531f0: 7465 3d46 616c 7365 0a20 2020 2020 2020  te=False.       
+00053200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053220: 2074 6162 5072 6f3d 7b27 7065 7266 273a   tabPro={'perf':
+00053230: 4e6f 6e65 7d0a 2020 2020 2020 2020 2020  None}.          
 00053240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053260: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-00053270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053280: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00053290: 7461 6250 726f 5b27 7065 7266 275d 2069  tabPro['perf'] i
-000532a0: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2076  s not None and v
-000532b0: 6973 7561 6c69 7a65 3a0a 2020 2020 2020  isualize:.      
-000532c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000532d0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-000532e0: 7873 6c69 6365 203d 206e 702e 6d69 6e28  xslice = np.min(
-000532f0: 205b 3231 2c20 7461 6250 726f 5b27 7065   [21, tabPro['pe
-00053300: 7266 275d 5b27 6d65 616e 426f 6c64 275d  rf']['meanBold']
-00053310: 2e73 6861 7065 5b32 5d20 5d20 290a 2020  .shape[2] ] ).  
+00053250: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00053260: 696e 7428 6622 616e 7473 7079 6d6d 6572  int(f"antspymmer
+00053270: 726f 7220 6f63 6375 7272 6564 2077 6869  ror occurred whi
+00053280: 6c65 2070 726f 6365 7373 696e 6720 7b6f  le processing {o
+00053290: 7665 726d 6f64 587d 3a20 7b65 7d22 290a  vermodX}: {e}").
+000532a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000532b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000532c0: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
+000532d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000532e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000532f0: 7461 6250 726f 5b27 7065 7266 275d 2069  tabPro['perf'] i
+00053300: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2076  s not None and v
+00053310: 6973 7561 6c69 7a65 3a0a 2020 2020 2020  isualize:.      
 00053320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053340: 2020 616e 7473 2e70 6c6f 7428 2074 6162    ants.plot( tab
-00053350: 5072 6f5b 2770 6572 6627 5d5b 2770 6572  Pro['perf']['per
-00053360: 6675 7369 6f6e 275d 2c0a 2020 2020 2020  fusion'],.      
-00053370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053330: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00053340: 7873 6c69 6365 203d 206e 702e 6d69 6e28  xslice = np.min(
+00053350: 205b 3231 2c20 7461 6250 726f 5b27 7065   [21, tabPro['pe
+00053360: 7266 275d 5b27 6d65 616e 426f 6c64 275d  rf']['meanBold']
+00053370: 2e73 6861 7065 5b32 5d20 5d20 290a 2020  .shape[2] ] ).  
 00053380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053390: 2020 6178 6973 3d32 2c20 6e73 6c69 6365    axis=2, nslice
-000533a0: 733d 6d61 7873 6c69 6365 2c20 6e63 6f6c  s=maxslice, ncol
-000533b0: 3d37 2c20 6372 6f70 3d54 7275 652c 2074  =7, crop=True, t
-000533c0: 6974 6c65 3d27 7065 7266 7573 696f 6e20  itle='perfusion 
-000533d0: 696d 6167 6527 2c20 6669 6c65 6e61 6d65  image', filename
-000533e0: 3d6d 796d 6d2b 6d79 7365 702b 2270 6572  =mymm+mysep+"per
-000533f0: 6675 7369 6f6e 2e70 6e67 2220 290a 2020  fusion.png" ).  
-00053400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053420: 2020 616e 7473 2e70 6c6f 7428 2074 6162    ants.plot( tab
-00053430: 5072 6f5b 2770 6572 6627 5d5b 2763 6266  Pro['perf']['cbf
-00053440: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-00053450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053460: 2020 2020 2020 2020 2020 2020 6178 6973              axis
-00053470: 3d32 2c20 6e73 6c69 6365 733d 6d61 7873  =2, nslices=maxs
-00053480: 6c69 6365 2c20 6e63 6f6c 3d37 2c20 6372  lice, ncol=7, cr
-00053490: 6f70 3d54 7275 652c 2074 6974 6c65 3d27  op=True, title='
-000534a0: 4342 4620 696d 6167 6527 2c20 6669 6c65  CBF image', file
-000534b0: 6e61 6d65 3d6d 796d 6d2b 6d79 7365 702b  name=mymm+mysep+
-000534c0: 2263 6266 2e70 6e67 2220 290a 2020 2020  "cbf.png" ).    
-000534d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000534e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000534f0: 616e 7473 2e70 6c6f 7428 2074 6162 5072  ants.plot( tabPr
-00053500: 6f5b 2770 6572 6627 5d5b 276d 3027 5d2c  o['perf']['m0'],
-00053510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00053520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053530: 2020 2020 2020 2020 2061 7869 733d 322c           axis=2,
-00053540: 206e 736c 6963 6573 3d6d 6178 736c 6963   nslices=maxslic
-00053550: 652c 206e 636f 6c3d 372c 2063 726f 703d  e, ncol=7, crop=
-00053560: 5472 7565 2c20 7469 746c 653d 274d 3020  True, title='M0 
-00053570: 696d 6167 6527 2c20 6669 6c65 6e61 6d65  image', filename
-00053580: 3d6d 796d 6d2b 6d79 7365 702b 226d 302e  =mymm+mysep+"m0.
-00053590: 706e 6722 2029 0a20 2020 2020 2020 2020  png" ).         
-000535a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000535b0: 2020 2069 6620 2820 6d79 6d6f 6420 3d3d     if ( mymod ==
-000535c0: 2027 4454 495f 4c52 2720 6f72 206d 796d   'DTI_LR' or mym
-000535d0: 6f64 203d 3d20 2744 5449 5f52 4c27 206f  od == 'DTI_RL' o
-000535e0: 7220 6d79 6d6f 6420 3d3d 2027 4454 4927  r mymod == 'DTI'
-000535f0: 2029 2061 6e64 2069 7368 6170 656c 656e   ) and ishapelen
-00053600: 203d 3d20 343a 0a20 2020 2020 2020 2020   == 4:.         
-00053610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053620: 2020 2020 2020 2062 7661 6c66 6e20 3d20         bvalfn = 
-00053630: 7265 2e73 7562 2820 272e 6e69 692e 677a  re.sub( '.nii.gz
-00053640: 272c 2027 2e62 7661 6c27 202c 206d 7969  ', '.bval' , myi
-00053650: 6d67 2029 0a20 2020 2020 2020 2020 2020  mg ).           
-00053660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053670: 2020 2020 2062 7665 6366 6e20 3d20 7265       bvecfn = re
-00053680: 2e73 7562 2820 272e 6e69 692e 677a 272c  .sub( '.nii.gz',
-00053690: 2027 2e62 7665 6327 202c 206d 7969 6d67   '.bvec' , myimg
-000536a0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-000536b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000536c0: 2020 2069 6d67 4c69 7374 203d 205b 2069     imgList = [ i
-000536d0: 6d67 205d 0a20 2020 2020 2020 2020 2020  mg ].           
-000536e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000536f0: 2020 2020 2062 7661 6c66 6e4c 6973 7420       bvalfnList 
-00053700: 3d20 5b20 6276 616c 666e 205d 0a20 2020  = [ bvalfn ].   
+00053390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000533a0: 2020 616e 7473 2e70 6c6f 7428 2074 6162    ants.plot( tab
+000533b0: 5072 6f5b 2770 6572 6627 5d5b 2770 6572  Pro['perf']['per
+000533c0: 6675 7369 6f6e 275d 2c0a 2020 2020 2020  fusion'],.      
+000533d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000533e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000533f0: 2020 6178 6973 3d32 2c20 6e73 6c69 6365    axis=2, nslice
+00053400: 733d 6d61 7873 6c69 6365 2c20 6e63 6f6c  s=maxslice, ncol
+00053410: 3d37 2c20 6372 6f70 3d54 7275 652c 2074  =7, crop=True, t
+00053420: 6974 6c65 3d27 7065 7266 7573 696f 6e20  itle='perfusion 
+00053430: 696d 6167 6527 2c20 6669 6c65 6e61 6d65  image', filename
+00053440: 3d6d 796d 6d2b 6d79 7365 702b 2270 6572  =mymm+mysep+"per
+00053450: 6675 7369 6f6e 2e70 6e67 2220 290a 2020  fusion.png" ).  
+00053460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053480: 2020 616e 7473 2e70 6c6f 7428 2074 6162    ants.plot( tab
+00053490: 5072 6f5b 2770 6572 6627 5d5b 2763 6266  Pro['perf']['cbf
+000534a0: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
+000534b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000534c0: 2020 2020 2020 2020 2020 2020 6178 6973              axis
+000534d0: 3d32 2c20 6e73 6c69 6365 733d 6d61 7873  =2, nslices=maxs
+000534e0: 6c69 6365 2c20 6e63 6f6c 3d37 2c20 6372  lice, ncol=7, cr
+000534f0: 6f70 3d54 7275 652c 2074 6974 6c65 3d27  op=True, title='
+00053500: 4342 4620 696d 6167 6527 2c20 6669 6c65  CBF image', file
+00053510: 6e61 6d65 3d6d 796d 6d2b 6d79 7365 702b  name=mymm+mysep+
+00053520: 2263 6266 2e70 6e67 2220 290a 2020 2020  "cbf.png" ).    
+00053530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053550: 616e 7473 2e70 6c6f 7428 2074 6162 5072  ants.plot( tabPr
+00053560: 6f5b 2770 6572 6627 5d5b 276d 3027 5d2c  o['perf']['m0'],
+00053570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00053580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053590: 2020 2020 2020 2020 2061 7869 733d 322c           axis=2,
+000535a0: 206e 736c 6963 6573 3d6d 6178 736c 6963   nslices=maxslic
+000535b0: 652c 206e 636f 6c3d 372c 2063 726f 703d  e, ncol=7, crop=
+000535c0: 5472 7565 2c20 7469 746c 653d 274d 3020  True, title='M0 
+000535d0: 696d 6167 6527 2c20 6669 6c65 6e61 6d65  image', filename
+000535e0: 3d6d 796d 6d2b 6d79 7365 702b 226d 302e  =mymm+mysep+"m0.
+000535f0: 706e 6722 2029 0a20 2020 2020 2020 2020  png" ).         
+00053600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053610: 2020 2069 6620 2820 6d79 6d6f 6420 3d3d     if ( mymod ==
+00053620: 2027 4454 495f 4c52 2720 6f72 206d 796d   'DTI_LR' or mym
+00053630: 6f64 203d 3d20 2744 5449 5f52 4c27 206f  od == 'DTI_RL' o
+00053640: 7220 6d79 6d6f 6420 3d3d 2027 4454 4927  r mymod == 'DTI'
+00053650: 2029 2061 6e64 2069 7368 6170 656c 656e   ) and ishapelen
+00053660: 203d 3d20 343a 0a20 2020 2020 2020 2020   == 4:.         
+00053670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053680: 2020 2020 2020 2062 7661 6c66 6e20 3d20         bvalfn = 
+00053690: 7265 2e73 7562 2820 272e 6e69 692e 677a  re.sub( '.nii.gz
+000536a0: 272c 2027 2e62 7661 6c27 202c 206d 7969  ', '.bval' , myi
+000536b0: 6d67 2029 0a20 2020 2020 2020 2020 2020  mg ).           
+000536c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000536d0: 2020 2020 2062 7665 6366 6e20 3d20 7265       bvecfn = re
+000536e0: 2e73 7562 2820 272e 6e69 692e 677a 272c  .sub( '.nii.gz',
+000536f0: 2027 2e62 7665 6327 202c 206d 7969 6d67   '.bvec' , myimg
+00053700: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
 00053710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053720: 2020 2020 2020 2020 2020 2020 2062 7665               bve
-00053730: 6366 6e4c 6973 7420 3d20 5b20 6276 6563  cfnList = [ bvec
-00053740: 666e 205d 0a20 2020 2020 2020 2020 2020  fn ].           
-00053750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053760: 2020 2020 206d 6973 7369 6e67 5f64 7469       missing_dti
-00053770: 5f64 6174 613d 4661 6c73 6520 2320 6276  _data=False # bv
-00053780: 616c 2c20 6276 6563 206f 7220 696d 6167  al, bvec or imag
-00053790: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-000537a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000537b0: 2020 2069 6620 6c65 6e28 206d 7969 6d67     if len( myimg
-000537c0: 7372 2029 203d 3d20 323a 2020 2320 6669  sr ) == 2:  # fi
-000537d0: 6e64 2044 5449 5f52 4c0a 2020 2020 2020  nd DTI_RL.      
-000537e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000537f0: 2020 2020 2020 2020 2020 2020 2020 6474                dt
-00053800: 696c 7266 6e20 3d20 6d79 696d 6773 725b  ilrfn = myimgsr[
-00053810: 6d79 696d 6763 6f75 6e74 2b31 5d0a 2020  myimgcount+1].  
-00053820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053840: 2020 6966 2065 7869 7374 7328 2064 7469    if exists( dti
-00053850: 6c72 666e 2029 3a0a 2020 2020 2020 2020  lrfn ):.        
-00053860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053880: 6276 616c 666e 524c 203d 2072 652e 7375  bvalfnRL = re.su
-00053890: 6228 2027 2e6e 6969 2e67 7a27 2c20 272e  b( '.nii.gz', '.
-000538a0: 6276 616c 2720 2c20 6474 696c 7266 6e20  bval' , dtilrfn 
-000538b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00053720: 2020 2069 6d67 4c69 7374 203d 205b 2069     imgList = [ i
+00053730: 6d67 205d 0a20 2020 2020 2020 2020 2020  mg ].           
+00053740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053750: 2020 2020 2062 7661 6c66 6e4c 6973 7420       bvalfnList 
+00053760: 3d20 5b20 6276 616c 666e 205d 0a20 2020  = [ bvalfn ].   
+00053770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053780: 2020 2020 2020 2020 2020 2020 2062 7665               bve
+00053790: 6366 6e4c 6973 7420 3d20 5b20 6276 6563  cfnList = [ bvec
+000537a0: 666e 205d 0a20 2020 2020 2020 2020 2020  fn ].           
+000537b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000537c0: 2020 2020 206d 6973 7369 6e67 5f64 7469       missing_dti
+000537d0: 5f64 6174 613d 4661 6c73 6520 2320 6276  _data=False # bv
+000537e0: 616c 2c20 6276 6563 206f 7220 696d 6167  al, bvec or imag
+000537f0: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+00053800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053810: 2020 2069 6620 6c65 6e28 206d 7969 6d67     if len( myimg
+00053820: 7372 2029 203d 3d20 323a 2020 2320 6669  sr ) == 2:  # fi
+00053830: 6e64 2044 5449 5f52 4c0a 2020 2020 2020  nd DTI_RL.      
+00053840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053850: 2020 2020 2020 2020 2020 2020 2020 6474                dt
+00053860: 696c 7266 6e20 3d20 6d79 696d 6773 725b  ilrfn = myimgsr[
+00053870: 6d79 696d 6763 6f75 6e74 2b31 5d0a 2020  myimgcount+1].  
+00053880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000538a0: 2020 6966 2065 7869 7374 7328 2064 7469    if exists( dti
+000538b0: 6c72 666e 2029 3a0a 2020 2020 2020 2020  lrfn ):.        
 000538c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000538d0: 2020 2020 2020 2020 2020 6276 6563 666e            bvecfn
-000538e0: 524c 203d 2072 652e 7375 6228 2027 2e6e  RL = re.sub( '.n
-000538f0: 6969 2e67 7a27 2c20 272e 6276 6563 2720  ii.gz', '.bvec' 
-00053900: 2c20 6474 696c 7266 6e20 290a 2020 2020  , dtilrfn ).    
-00053910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000538d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000538e0: 6276 616c 666e 524c 203d 2072 652e 7375  bvalfnRL = re.su
+000538f0: 6228 2027 2e6e 6969 2e67 7a27 2c20 272e  b( '.nii.gz', '.
+00053900: 6276 616c 2720 2c20 6474 696c 7266 6e20  bval' , dtilrfn 
+00053910: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
 00053920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053930: 2020 2020 696d 6752 4c20 3d20 616e 7473      imgRL = ants
-00053940: 2e69 6d61 6765 5f72 6561 6428 2064 7469  .image_read( dti
-00053950: 6c72 666e 2029 0a20 2020 2020 2020 2020  lrfn ).         
-00053960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053970: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00053980: 6d67 4c69 7374 2e61 7070 656e 6428 2069  mgList.append( i
-00053990: 6d67 524c 2029 0a20 2020 2020 2020 2020  mgRL ).         
-000539a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000539b0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-000539c0: 7661 6c66 6e4c 6973 742e 6170 7065 6e64  valfnList.append
-000539d0: 2820 6276 616c 666e 524c 2029 0a20 2020  ( bvalfnRL ).   
-000539e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000539f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053a00: 2020 2020 2062 7665 6366 6e4c 6973 742e       bvecfnList.
-00053a10: 6170 7065 6e64 2820 6276 6563 666e 524c  append( bvecfnRL
-00053a20: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00053a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053a40: 2020 2065 6c69 6620 6c65 6e28 206d 7969     elif len( myi
-00053a50: 6d67 7372 2029 203d 3d20 333a 2020 2320  mgsr ) == 3:  # 
-00053a60: 6669 6e64 2044 5449 5f52 4c0a 2020 2020  find DTI_RL.    
-00053a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053a90: 7072 696e 7428 2244 5449 2074 7269 6e69  print("DTI trini
-00053aa0: 7479 2229 0a20 2020 2020 2020 2020 2020  ty").           
-00053ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053ac0: 2020 2020 2020 2020 2064 7469 6c72 666e           dtilrfn
-00053ad0: 203d 206d 7969 6d67 7372 5b6d 7969 6d67   = myimgsr[myimg
-00053ae0: 636f 756e 742b 315d 0a20 2020 2020 2020  count+1].       
-00053af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053b00: 2020 2020 2020 2020 2020 2020 2064 7469               dti
-00053b10: 6c72 666e 3220 3d20 6d79 696d 6773 725b  lrfn2 = myimgsr[
-00053b20: 6d79 696d 6763 6f75 6e74 2b32 5d0a 2020  myimgcount+2].  
-00053b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053b50: 2020 6966 2065 7869 7374 7328 2064 7469    if exists( dti
-00053b60: 6c72 666e 2029 2061 6e64 2065 7869 7374  lrfn ) and exist
-00053b70: 7328 2064 7469 6c72 666e 3220 293a 0a20  s( dtilrfn2 ):. 
-00053b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053930: 2020 2020 2020 2020 2020 6276 6563 666e            bvecfn
+00053940: 524c 203d 2072 652e 7375 6228 2027 2e6e  RL = re.sub( '.n
+00053950: 6969 2e67 7a27 2c20 272e 6276 6563 2720  ii.gz', '.bvec' 
+00053960: 2c20 6474 696c 7266 6e20 290a 2020 2020  , dtilrfn ).    
+00053970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053990: 2020 2020 696d 6752 4c20 3d20 616e 7473      imgRL = ants
+000539a0: 2e69 6d61 6765 5f72 6561 6428 2064 7469  .image_read( dti
+000539b0: 6c72 666e 2029 0a20 2020 2020 2020 2020  lrfn ).         
+000539c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000539d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000539e0: 6d67 4c69 7374 2e61 7070 656e 6428 2069  mgList.append( i
+000539f0: 6d67 524c 2029 0a20 2020 2020 2020 2020  mgRL ).         
+00053a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053a10: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00053a20: 7661 6c66 6e4c 6973 742e 6170 7065 6e64  valfnList.append
+00053a30: 2820 6276 616c 666e 524c 2029 0a20 2020  ( bvalfnRL ).   
+00053a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053a60: 2020 2020 2062 7665 6366 6e4c 6973 742e       bvecfnList.
+00053a70: 6170 7065 6e64 2820 6276 6563 666e 524c  append( bvecfnRL
+00053a80: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00053a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053aa0: 2020 2065 6c69 6620 6c65 6e28 206d 7969     elif len( myi
+00053ab0: 6d67 7372 2029 203d 3d20 333a 2020 2320  mgsr ) == 3:  # 
+00053ac0: 6669 6e64 2044 5449 5f52 4c0a 2020 2020  find DTI_RL.    
+00053ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053af0: 7072 696e 7428 2244 5449 2074 7269 6e69  print("DTI trini
+00053b00: 7479 2229 0a20 2020 2020 2020 2020 2020  ty").           
+00053b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053b20: 2020 2020 2020 2020 2064 7469 6c72 666e           dtilrfn
+00053b30: 203d 206d 7969 6d67 7372 5b6d 7969 6d67   = myimgsr[myimg
+00053b40: 636f 756e 742b 315d 0a20 2020 2020 2020  count+1].       
+00053b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053b60: 2020 2020 2020 2020 2020 2020 2064 7469               dti
+00053b70: 6c72 666e 3220 3d20 6d79 696d 6773 725b  lrfn2 = myimgsr[
+00053b80: 6d79 696d 6763 6f75 6e74 2b32 5d0a 2020  myimgcount+2].  
 00053b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053ba0: 2020 2020 2020 2062 7661 6c66 6e52 4c20         bvalfnRL 
-00053bb0: 3d20 7265 2e73 7562 2820 272e 6e69 692e  = re.sub( '.nii.
-00053bc0: 677a 272c 2027 2e62 7661 6c27 202c 2064  gz', '.bval' , d
-00053bd0: 7469 6c72 666e 2029 0a20 2020 2020 2020  tilrfn ).       
+00053ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053bb0: 2020 6966 2065 7869 7374 7328 2064 7469    if exists( dti
+00053bc0: 6c72 666e 2029 2061 6e64 2065 7869 7374  lrfn ) and exist
+00053bd0: 7328 2064 7469 6c72 666e 3220 293a 0a20  s( dtilrfn2 ):. 
 00053be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00053bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053c00: 2062 7665 6366 6e52 4c20 3d20 7265 2e73   bvecfnRL = re.s
-00053c10: 7562 2820 272e 6e69 692e 677a 272c 2027  ub( '.nii.gz', '
-00053c20: 2e62 7665 6327 202c 2064 7469 6c72 666e  .bvec' , dtilrfn
-00053c30: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00053c00: 2020 2020 2020 2062 7661 6c66 6e52 4c20         bvalfnRL 
+00053c10: 3d20 7265 2e73 7562 2820 272e 6e69 692e  = re.sub( '.nii.
+00053c20: 677a 272c 2027 2e62 7661 6c27 202c 2064  gz', '.bval' , d
+00053c30: 7469 6c72 666e 2029 0a20 2020 2020 2020  tilrfn ).       
 00053c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053c50: 2020 2020 2020 2020 2020 2062 7661 6c66             bvalf
-00053c60: 6e52 4c32 203d 2072 652e 7375 6228 2027  nRL2 = re.sub( '
-00053c70: 2e6e 6969 2e67 7a27 2c20 272e 6276 616c  .nii.gz', '.bval
-00053c80: 2720 2c20 6474 696c 7266 6e32 2029 0a20  ' , dtilrfn2 ). 
-00053c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053c60: 2062 7665 6366 6e52 4c20 3d20 7265 2e73   bvecfnRL = re.s
+00053c70: 7562 2820 272e 6e69 692e 677a 272c 2027  ub( '.nii.gz', '
+00053c80: 2e62 7665 6327 202c 2064 7469 6c72 666e  .bvec' , dtilrfn
+00053c90: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
 00053ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053cb0: 2020 2020 2020 2062 7665 6366 6e52 4c32         bvecfnRL2
-00053cc0: 203d 2072 652e 7375 6228 2027 2e6e 6969   = re.sub( '.nii
-00053cd0: 2e67 7a27 2c20 272e 6276 6563 2720 2c20  .gz', '.bvec' , 
-00053ce0: 6474 696c 7266 6e32 2029 0a20 2020 2020  dtilrfn2 ).     
+00053cb0: 2020 2020 2020 2020 2020 2062 7661 6c66             bvalf
+00053cc0: 6e52 4c32 203d 2072 652e 7375 6228 2027  nRL2 = re.sub( '
+00053cd0: 2e6e 6969 2e67 7a27 2c20 272e 6276 616c  .nii.gz', '.bval
+00053ce0: 2720 2c20 6474 696c 7266 6e32 2029 0a20  ' , dtilrfn2 ). 
 00053cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00053d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053d10: 2020 2069 6d67 524c 203d 2061 6e74 732e     imgRL = ants.
-00053d20: 696d 6167 655f 7265 6164 2820 6474 696c  image_read( dtil
-00053d30: 7266 6e20 290a 2020 2020 2020 2020 2020  rfn ).          
-00053d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053d50: 2020 2020 2020 2020 2020 2020 2020 696d                im
-00053d60: 6752 4c32 203d 2061 6e74 732e 696d 6167  gRL2 = ants.imag
-00053d70: 655f 7265 6164 2820 6474 696c 7266 6e32  e_read( dtilrfn2
-00053d80: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00053d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053da0: 2020 2020 2020 2020 2020 2062 7661 6c73             bvals
-00053db0: 2c20 6276 6563 7320 3d20 7265 6164 5f62  , bvecs = read_b
-00053dc0: 7661 6c73 5f62 7665 6373 2820 6276 616c  vals_bvecs( bval
-00053dd0: 666e 524c 202c 2062 7665 6366 6e52 4c20  fnRL , bvecfnRL 
+00053d10: 2020 2020 2020 2062 7665 6366 6e52 4c32         bvecfnRL2
+00053d20: 203d 2072 652e 7375 6228 2027 2e6e 6969   = re.sub( '.nii
+00053d30: 2e67 7a27 2c20 272e 6276 6563 2720 2c20  .gz', '.bvec' , 
+00053d40: 6474 696c 7266 6e32 2029 0a20 2020 2020  dtilrfn2 ).     
+00053d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053d70: 2020 2069 6d67 524c 203d 2061 6e74 732e     imgRL = ants.
+00053d80: 696d 6167 655f 7265 6164 2820 6474 696c  image_read( dtil
+00053d90: 7266 6e20 290a 2020 2020 2020 2020 2020  rfn ).          
+00053da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053db0: 2020 2020 2020 2020 2020 2020 2020 696d                im
+00053dc0: 6752 4c32 203d 2061 6e74 732e 696d 6167  gRL2 = ants.imag
+00053dd0: 655f 7265 6164 2820 6474 696c 7266 6e32  e_read( dtilrfn2
 00053de0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
 00053df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053e00: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00053e10: 2820 6276 616c 732e 6d61 7828 2920 290a  ( bvals.max() ).
-00053e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053e40: 2020 2020 2020 2020 6276 616c 7332 2c20          bvals2, 
-00053e50: 6276 6563 7332 203d 2072 6561 645f 6276  bvecs2 = read_bv
-00053e60: 616c 735f 6276 6563 7328 2062 7661 6c66  als_bvecs( bvalf
-00053e70: 6e52 4c32 202c 2062 7665 6366 6e52 4c32  nRL2 , bvecfnRL2
-00053e80: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00053e00: 2020 2020 2020 2020 2020 2062 7661 6c73             bvals
+00053e10: 2c20 6276 6563 7320 3d20 7265 6164 5f62  , bvecs = read_b
+00053e20: 7661 6c73 5f62 7665 6373 2820 6276 616c  vals_bvecs( bval
+00053e30: 666e 524c 202c 2062 7665 6366 6e52 4c20  fnRL , bvecfnRL 
+00053e40: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00053e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053e60: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00053e70: 2820 6276 616c 732e 6d61 7828 2920 290a  ( bvals.max() ).
+00053e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00053e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053ea0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00053eb0: 7428 2062 7661 6c73 322e 6d61 7828 2920  t( bvals2.max() 
-00053ec0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00053ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053ee0: 2020 2020 2020 2020 2020 7465 6d70 203d            temp =
-00053ef0: 206d 6572 6765 5f64 7769 5f64 6174 6128   merge_dwi_data(
-00053f00: 2069 6d67 524c 2c20 6276 616c 732c 2062   imgRL, bvals, b
-00053f10: 7665 6373 2c20 696d 6752 4c32 2c20 6276  vecs, imgRL2, bv
-00053f20: 616c 7332 2c20 6276 6563 7332 2020 290a  als2, bvecs2  ).
+00053ea0: 2020 2020 2020 2020 6276 616c 7332 2c20          bvals2, 
+00053eb0: 6276 6563 7332 203d 2072 6561 645f 6276  bvecs2 = read_bv
+00053ec0: 616c 735f 6276 6563 7328 2062 7661 6c66  als_bvecs( bvalf
+00053ed0: 6e52 4c32 202c 2062 7665 6366 6e52 4c32  nRL2 , bvecfnRL2
+00053ee0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00053ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053f00: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00053f10: 7428 2062 7661 6c73 322e 6d61 7828 2920  t( bvals2.max() 
+00053f20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
 00053f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053f50: 2020 2020 2020 2020 696d 674c 6973 742e          imgList.
-00053f60: 6170 7065 6e64 2820 7465 6d70 5b30 5d20  append( temp[0] 
-00053f70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00053f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053f90: 2020 2020 2020 2020 2020 6276 616c 666e            bvalfn
-00053fa0: 4c69 7374 2e61 7070 656e 6428 206d 796d  List.append( mym
-00053fb0: 6d2b 6d79 7365 702b 276a 6f69 6e65 642e  m+mysep+'joined.
-00053fc0: 6276 616c 2720 290a 2020 2020 2020 2020  bval' ).        
-00053fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053f40: 2020 2020 2020 2020 2020 7465 6d70 203d            temp =
+00053f50: 206d 6572 6765 5f64 7769 5f64 6174 6128   merge_dwi_data(
+00053f60: 2069 6d67 524c 2c20 6276 616c 732c 2062   imgRL, bvals, b
+00053f70: 7665 6373 2c20 696d 6752 4c32 2c20 6276  vecs, imgRL2, bv
+00053f80: 616c 7332 2c20 6276 6563 7332 2020 290a  als2, bvecs2  ).
+00053f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053fb0: 2020 2020 2020 2020 696d 674c 6973 742e          imgList.
+00053fc0: 6170 7065 6e64 2820 7465 6d70 5b30 5d20  append( temp[0] 
+00053fd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
 00053fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053ff0: 6276 6563 666e 4c69 7374 2e61 7070 656e  bvecfnList.appen
-00054000: 6428 206d 796d 6d2b 6d79 7365 702b 276a  d( mymm+mysep+'j
-00054010: 6f69 6e65 642e 6276 6563 2720 290a 2020  oined.bvec' ).  
-00054020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053ff0: 2020 2020 2020 2020 2020 6276 616c 666e            bvalfn
+00054000: 4c69 7374 2e61 7070 656e 6428 206d 796d  List.append( mym
+00054010: 6d2b 6d79 7365 702b 276a 6f69 6e65 642e  m+mysep+'joined.
+00054020: 6276 616c 2720 290a 2020 2020 2020 2020  bval' ).        
 00054030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054040: 2020 2020 2020 7772 6974 655f 6276 616c        write_bval
-00054050: 735f 6276 6563 7328 2074 656d 705b 315d  s_bvecs( temp[1]
-00054060: 2c20 7465 6d70 5b32 5d2c 206d 796d 6d2b  , temp[2], mymm+
-00054070: 6d79 7365 702b 276a 6f69 6e65 6427 2029  mysep+'joined' )
-00054080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00054040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054050: 6276 6563 666e 4c69 7374 2e61 7070 656e  bvecfnList.appen
+00054060: 6428 206d 796d 6d2b 6d79 7365 702b 276a  d( mymm+mysep+'j
+00054070: 6f69 6e65 642e 6276 6563 2720 290a 2020  oined.bvec' ).  
+00054080: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00054090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000540a0: 2020 2020 2020 2020 2062 7661 6c73 582c           bvalsX,
-000540b0: 2062 7665 6373 5820 3d20 7265 6164 5f62   bvecsX = read_b
-000540c0: 7661 6c73 5f62 7665 6373 2820 6276 616c  vals_bvecs( bval
-000540d0: 666e 524c 3220 2c20 6276 6563 666e 524c  fnRL2 , bvecfnRL
-000540e0: 3220 2029 0a20 2020 2020 2020 2020 2020  2  ).           
+000540a0: 2020 2020 2020 7772 6974 655f 6276 616c        write_bval
+000540b0: 735f 6276 6563 7328 2074 656d 705b 315d  s_bvecs( temp[1]
+000540c0: 2c20 7465 6d70 5b32 5d2c 206d 796d 6d2b  , temp[2], mymm+
+000540d0: 6d79 7365 702b 276a 6f69 6e65 6427 2029  mysep+'joined' )
+000540e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 000540f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054100: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00054110: 6e74 2820 6276 616c 7358 2e6d 6178 2829  nt( bvalsX.max()
-00054120: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00054130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054140: 2020 2023 2063 6865 636b 2065 7869 7374     # check exist
-00054150: 656e 6365 206f 6620 616c 6c20 6669 6c65  ence of all file
-00054160: 7320 6578 7065 6374 6564 202e 2e2e 0a20  s expected .... 
-00054170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054180: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00054190: 6f72 2064 7469 6578 2069 6e20 6276 616c  or dtiex in bval
-000541a0: 666e 4c69 7374 2b62 7665 6366 6e4c 6973  fnList+bvecfnLis
-000541b0: 742b 6d79 696d 6773 723a 0a20 2020 2020  t+myimgsr:.     
-000541c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000541d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000541e0: 6620 6e6f 7420 6578 6973 7473 2864 7469  f not exists(dti
-000541f0: 6578 293a 0a20 2020 2020 2020 2020 2020  ex):.           
-00054200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054210: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00054220: 6e74 2827 6d6d 5f63 7376 3a20 6d69 7373  nt('mm_csv: miss
-00054230: 696e 6720 6474 6920 6461 7461 2027 202b  ing dti data ' +
-00054240: 2064 7469 6578 2029 0a20 2020 2020 2020   dtiex ).       
-00054250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054100: 2020 2020 2020 2020 2062 7661 6c73 582c           bvalsX,
+00054110: 2062 7665 6373 5820 3d20 7265 6164 5f62   bvecsX = read_b
+00054120: 7661 6c73 5f62 7665 6373 2820 6276 616c  vals_bvecs( bval
+00054130: 666e 524c 3220 2c20 6276 6563 666e 524c  fnRL2 , bvecfnRL
+00054140: 3220 2029 0a20 2020 2020 2020 2020 2020  2  ).           
+00054150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054160: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00054170: 6e74 2820 6276 616c 7358 2e6d 6178 2829  nt( bvalsX.max()
+00054180: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00054190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000541a0: 2020 2023 2063 6865 636b 2065 7869 7374     # check exist
+000541b0: 656e 6365 206f 6620 616c 6c20 6669 6c65  ence of all file
+000541c0: 7320 6578 7065 6374 6564 202e 2e2e 0a20  s expected .... 
+000541d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000541e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000541f0: 6f72 2064 7469 6578 2069 6e20 6276 616c  or dtiex in bval
+00054200: 666e 4c69 7374 2b62 7665 6366 6e4c 6973  fnList+bvecfnLis
+00054210: 742b 6d79 696d 6773 723a 0a20 2020 2020  t+myimgsr:.     
+00054220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054230: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00054240: 6620 6e6f 7420 6578 6973 7473 2864 7469  f not exists(dti
+00054250: 6578 293a 0a20 2020 2020 2020 2020 2020  ex):.           
 00054260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054270: 206d 6973 7369 6e67 5f64 7469 5f64 6174   missing_dti_dat
-00054280: 613d 5472 7565 0a20 2020 2020 2020 2020  a=True.         
-00054290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000542a0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000542b0: 6f77 7269 7465 3d46 616c 7365 0a20 2020  owrite=False.   
+00054270: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00054280: 6e74 2827 6d6d 5f63 7376 3a20 6d69 7373  nt('mm_csv: miss
+00054290: 696e 6720 6474 6920 6461 7461 2027 202b  ing dti data ' +
+000542a0: 2064 7469 6578 2029 0a20 2020 2020 2020   dtiex ).       
+000542b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000542c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000542d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000542e0: 6e6f 7420 6d69 7373 696e 675f 6474 695f  not missing_dti_
-000542f0: 6461 7461 3a0a 2020 2020 2020 2020 2020  data:.          
-00054300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054310: 2020 2020 2020 2020 2020 646f 7772 6974            dowrit
-00054320: 653d 5472 7565 0a20 2020 2020 2020 2020  e=True.         
-00054330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054340: 2020 2020 2020 2020 2020 2073 726d 6f64             srmod
-00054350: 656c 5f44 5449 5f6d 646c 3d4e 6f6e 650a  el_DTI_mdl=None.
+000542d0: 206d 6973 7369 6e67 5f64 7469 5f64 6174   missing_dti_dat
+000542e0: 613d 5472 7565 0a20 2020 2020 2020 2020  a=True.         
+000542f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054300: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00054310: 6f77 7269 7465 3d46 616c 7365 0a20 2020  owrite=False.   
+00054320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054330: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00054340: 6e6f 7420 6d69 7373 696e 675f 6474 695f  not missing_dti_
+00054350: 6461 7461 3a0a 2020 2020 2020 2020 2020  data:.          
 00054360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054380: 2020 2020 6966 2073 726d 6f64 656c 5f44      if srmodel_D
-00054390: 5449 2069 7320 6e6f 7420 4661 6c73 653a  TI is not False:
-000543a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000543b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000543c0: 2020 2020 2020 2020 2074 656d 7020 3d20           temp = 
-000543d0: 616e 7473 2e67 6574 5f73 7061 6369 6e67  ants.get_spacing
-000543e0: 2869 6d67 290a 2020 2020 2020 2020 2020  (img).          
-000543f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054400: 2020 2020 2020 2020 2020 2020 2020 6474                dt
-00054410: 7370 633d 5b74 656d 705b 305d 2c74 656d  spc=[temp[0],tem
-00054420: 705b 315d 2c74 656d 705b 325d 5d0a 2020  p[1],temp[2]].  
-00054430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054450: 2020 2020 2020 6265 7374 7570 203d 2073        bestup = s
-00054460: 6971 2e6f 7074 696d 697a 655f 7570 7361  iq.optimize_upsa
-00054470: 6d70 6c69 6e67 5f73 6861 7065 2820 6474  mpling_shape( dt
-00054480: 7370 632c 206d 6f64 616c 6974 793d 2744  spc, modality='D
-00054490: 5449 2720 290a 2020 2020 2020 2020 2020  TI' ).          
+00054370: 2020 2020 2020 2020 2020 646f 7772 6974            dowrit
+00054380: 653d 5472 7565 0a20 2020 2020 2020 2020  e=True.         
+00054390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000543a0: 2020 2020 2020 2020 2020 2073 726d 6f64             srmod
+000543b0: 656c 5f44 5449 5f6d 646c 3d4e 6f6e 650a  el_DTI_mdl=None.
+000543c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000543d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000543e0: 2020 2020 6966 2073 726d 6f64 656c 5f44      if srmodel_D
+000543f0: 5449 2069 7320 6e6f 7420 4661 6c73 653a  TI is not False:
+00054400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00054410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054420: 2020 2020 2020 2020 2074 656d 7020 3d20           temp = 
+00054430: 616e 7473 2e67 6574 5f73 7061 6369 6e67  ants.get_spacing
+00054440: 2869 6d67 290a 2020 2020 2020 2020 2020  (img).          
+00054450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054460: 2020 2020 2020 2020 2020 2020 2020 6474                dt
+00054470: 7370 633d 5b74 656d 705b 305d 2c74 656d  spc=[temp[0],tem
+00054480: 705b 315d 2c74 656d 705b 325d 5d0a 2020  p[1],temp[2]].  
+00054490: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000544a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000544b0: 2020 2020 2020 2020 2020 2020 2020 6d64                md
-000544c0: 6c66 6e20 3d20 6578 5f70 6174 686d 6d20  lfn = ex_pathmm 
-000544d0: 2b20 2273 6971 5f64 6566 6175 6c74 5f73  + "siq_default_s
-000544e0: 6973 725f 2220 2b20 6265 7374 7570 202b  isr_" + bestup +
-000544f0: 2022 5f31 6368 616e 5f66 6561 7476 6767   "_1chan_featvgg
-00054500: 4c36 5f62 6573 745f 6d64 6c2e 6835 220a  L6_best_mdl.h5".
-00054510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054530: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00054540: 7461 6e63 6528 2073 726d 6f64 656c 5f44  tance( srmodel_D
-00054550: 5449 2c20 7374 7220 293a 0a20 2020 2020  TI, str ):.     
-00054560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000544b0: 2020 2020 2020 6265 7374 7570 203d 2073        bestup = s
+000544c0: 6971 2e6f 7074 696d 697a 655f 7570 7361  iq.optimize_upsa
+000544d0: 6d70 6c69 6e67 5f73 6861 7065 2820 6474  mpling_shape( dt
+000544e0: 7370 632c 206d 6f64 616c 6974 793d 2744  spc, modality='D
+000544f0: 5449 2720 290a 2020 2020 2020 2020 2020  TI' ).          
+00054500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054510: 2020 2020 2020 2020 2020 2020 2020 6d64                md
+00054520: 6c66 6e20 3d20 6578 5f70 6174 686d 6d20  lfn = ex_pathmm 
+00054530: 2b20 2273 6971 5f64 6566 6175 6c74 5f73  + "siq_default_s
+00054540: 6973 725f 2220 2b20 6265 7374 7570 202b  isr_" + bestup +
+00054550: 2022 5f31 6368 616e 5f66 6561 7476 6767   "_1chan_featvgg
+00054560: 4c36 5f62 6573 745f 6d64 6c2e 6835 220a  L6_best_mdl.h5".
 00054570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054580: 2020 2020 2020 2073 726d 6f64 656c 5f44         srmodel_D
-00054590: 5449 203d 2072 652e 7375 6228 2022 6265  TI = re.sub( "be
-000545a0: 7374 7570 222c 2062 6573 7475 702c 2073  stup", bestup, s
-000545b0: 726d 6f64 656c 5f44 5449 2029 0a20 2020  rmodel_DTI ).   
+00054580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054590: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+000545a0: 7461 6e63 6528 2073 726d 6f64 656c 5f44  tance( srmodel_D
+000545b0: 5449 2c20 7374 7220 293a 0a20 2020 2020  TI, str ):.     
 000545c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000545d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000545e0: 2020 2020 2020 2020 206d 646c 666e 203d           mdlfn =
-000545f0: 206f 732e 7061 7468 2e6a 6f69 6e28 2065   os.path.join( e
-00054600: 785f 7061 7468 6d6d 2c20 7372 6d6f 6465  x_pathmm, srmode
-00054610: 6c5f 4454 4920 290a 2020 2020 2020 2020  l_DTI ).        
+000545e0: 2020 2020 2020 2073 726d 6f64 656c 5f44         srmodel_D
+000545f0: 5449 203d 2072 652e 7375 6228 2022 6265  TI = re.sub( "be
+00054600: 7374 7570 222c 2062 6573 7475 702c 2073  stup", bestup, s
+00054610: 726d 6f64 656c 5f44 5449 2029 0a20 2020  rmodel_DTI ).   
 00054620: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00054630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054640: 6966 2065 7869 7374 7328 206d 646c 666e  if exists( mdlfn
-00054650: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-00054660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054680: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+00054640: 2020 2020 2020 2020 206d 646c 666e 203d           mdlfn =
+00054650: 206f 732e 7061 7468 2e6a 6f69 6e28 2065   os.path.join( e
+00054660: 785f 7061 7468 6d6d 2c20 7372 6d6f 6465  x_pathmm, srmode
+00054670: 6c5f 4454 4920 290a 2020 2020 2020 2020  l_DTI ).        
+00054680: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00054690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000546a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000546b0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-000546c0: 7428 6d64 6c66 6e29 0a20 2020 2020 2020  t(mdlfn).       
+000546a0: 6966 2065 7869 7374 7328 206d 646c 666e  if exists( mdlfn
+000546b0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+000546c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000546d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000546e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000546f0: 2020 2020 2073 726d 6f64 656c 5f44 5449       srmodel_DTI
-00054700: 5f6d 646c 203d 2074 662e 6b65 7261 732e  _mdl = tf.keras.
-00054710: 6d6f 6465 6c73 2e6c 6f61 645f 6d6f 6465  models.load_mode
-00054720: 6c28 206d 646c 666e 2c20 636f 6d70 696c  l( mdlfn, compil
-00054730: 653d 4661 6c73 6520 290a 2020 2020 2020  e=False ).      
+000546e0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+000546f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054710: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00054720: 7428 6d64 6c66 6e29 0a20 2020 2020 2020  t(mdlfn).       
+00054730: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00054740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054760: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00054770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054790: 2020 2020 7072 696e 7428 6d64 6c66 6e20      print(mdlfn 
-000547a0: 2b20 2220 646f 6573 206e 6f74 2065 7869  + " does not exi
-000547b0: 7374 202d 2077 6f6e 7420 7573 6520 5352  st - wont use SR
-000547c0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+00054750: 2020 2020 2073 726d 6f64 656c 5f44 5449       srmodel_DTI
+00054760: 5f6d 646c 203d 2074 662e 6b65 7261 732e  _mdl = tf.keras.
+00054770: 6d6f 6465 6c73 2e6c 6f61 645f 6d6f 6465  models.load_mode
+00054780: 6c28 206d 646c 666e 2c20 636f 6d70 696c  l( mdlfn, compil
+00054790: 653d 4661 6c73 6520 290a 2020 2020 2020  e=False ).      
+000547a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000547b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000547c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
 000547d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000547e0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-000547f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054810: 2020 2020 7461 6250 726f 2c20 6e6f 726d      tabPro, norm
-00054820: 5072 6f20 3d20 6d6d 2820 7431 2c20 6869  Pro = mm( t1, hi
-00054830: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
-00054840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000547e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000547f0: 2020 2020 7072 696e 7428 6d64 6c66 6e20      print(mdlfn 
+00054800: 2b20 2220 646f 6573 206e 6f74 2065 7869  + " does not exi
+00054810: 7374 202d 2077 6f6e 7420 7573 6520 5352  st - wont use SR
+00054820: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+00054830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054840: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
 00054850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054860: 6477 5f69 6d61 6765 3d69 6d67 4c69 7374  dw_image=imgList
-00054870: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00054880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054890: 2020 2020 2020 2020 2020 2020 2020 6276                bv
-000548a0: 616c 7320 3d20 6276 616c 666e 4c69 7374  als = bvalfnList
-000548b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000548c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000548d0: 2020 2020 2020 2020 2020 2020 2020 6276                bv
-000548e0: 6563 7320 3d20 6276 6563 666e 4c69 7374  ecs = bvecfnList
-000548f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00054900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054910: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00054920: 6d6f 6465 6c3d 7372 6d6f 6465 6c5f 4454  model=srmodel_DT
-00054930: 495f 6d64 6c2c 0a20 2020 2020 2020 2020  I_mdl,.         
-00054940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054960: 2020 2064 6f5f 7472 6163 746f 6772 6170     do_tractograp
-00054970: 6879 3d6e 6f74 2074 6573 745f 7275 6e2c  hy=not test_run,
-00054980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00054990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000549a0: 2020 2020 2020 2020 2020 2020 2064 6f5f               do_
-000549b0: 6b6b 3d46 616c 7365 2c0a 2020 2020 2020  kk=False,.      
-000549c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000549d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000549e0: 2020 2020 2020 646f 5f6e 6f72 6d61 6c69        do_normali
-000549f0: 7a61 7469 6f6e 3d74 656d 706c 6174 6554  zation=templateT
-00054a00: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-00054a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054a20: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00054a30: 726f 7570 5f74 656d 706c 6174 6520 3d20  roup_template = 
-00054a40: 6e6f 726d 616c 697a 6174 696f 6e5f 7465  normalization_te
-00054a50: 6d70 6c61 7465 2c0a 2020 2020 2020 2020  mplate,.        
-00054a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054870: 2020 2020 7461 6250 726f 2c20 6e6f 726d      tabPro, norm
+00054880: 5072 6f20 3d20 6d6d 2820 7431 2c20 6869  Pro = mm( t1, hi
+00054890: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+000548a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000548b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000548c0: 6477 5f69 6d61 6765 3d69 6d67 4c69 7374  dw_image=imgList
+000548d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000548e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000548f0: 2020 2020 2020 2020 2020 2020 2020 6276                bv
+00054900: 616c 7320 3d20 6276 616c 666e 4c69 7374  als = bvalfnList
+00054910: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00054920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054930: 2020 2020 2020 2020 2020 2020 2020 6276                bv
+00054940: 6563 7320 3d20 6276 6563 666e 4c69 7374  ecs = bvecfnList
+00054950: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00054960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054970: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+00054980: 6d6f 6465 6c3d 7372 6d6f 6465 6c5f 4454  model=srmodel_DT
+00054990: 495f 6d64 6c2c 0a20 2020 2020 2020 2020  I_mdl,.         
+000549a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000549b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000549c0: 2020 2064 6f5f 7472 6163 746f 6772 6170     do_tractograp
+000549d0: 6879 3d6e 6f74 2074 6573 745f 7275 6e2c  hy=not test_run,
+000549e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000549f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054a00: 2020 2020 2020 2020 2020 2020 2064 6f5f               do_
+00054a10: 6b6b 3d46 616c 7365 2c0a 2020 2020 2020  kk=False,.      
+00054a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054a40: 2020 2020 2020 646f 5f6e 6f72 6d61 6c69        do_normali
+00054a50: 7a61 7469 6f6e 3d74 656d 706c 6174 6554  zation=templateT
+00054a60: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
 00054a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054a80: 2020 2020 6772 6f75 705f 7472 616e 7366      group_transf
-00054a90: 6f72 6d20 3d20 6772 6f75 7054 782c 0a20  orm = groupTx,. 
-00054aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054ac0: 2020 2020 2020 2020 2020 2064 7469 5f6d             dti_m
-00054ad0: 6f74 696f 6e5f 636f 7272 6563 7420 3d20  otion_correct = 
-00054ae0: 6474 695f 6d6f 7469 6f6e 5f63 6f72 7265  dti_motion_corre
-00054af0: 6374 2c0a 2020 2020 2020 2020 2020 2020  ct,.            
+00054a80: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00054a90: 726f 7570 5f74 656d 706c 6174 6520 3d20  roup_template = 
+00054aa0: 6e6f 726d 616c 697a 6174 696f 6e5f 7465  normalization_te
+00054ab0: 6d70 6c61 7465 2c0a 2020 2020 2020 2020  mplate,.        
+00054ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054ae0: 2020 2020 6772 6f75 705f 7472 616e 7366      group_transf
+00054af0: 6f72 6d20 3d20 6772 6f75 7054 782c 0a20  orm = groupTx,. 
 00054b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00054b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054b20: 6474 695f 6465 6e6f 6973 6520 3d20 6474  dti_denoise = dt
-00054b30: 695f 6465 6e6f 6973 652c 0a20 2020 2020  i_denoise,.     
-00054b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054b60: 2020 2020 2020 2074 6573 745f 7275 6e3d         test_run=
-00054b70: 7465 7374 5f72 756e 2c0a 2020 2020 2020  test_run,.      
-00054b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054ba0: 2020 2020 2020 7665 7262 6f73 653d 5472        verbose=Tr
-00054bb0: 7565 2029 0a20 2020 2020 2020 2020 2020  ue ).           
-00054bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054bd0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00054be0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+00054b20: 2020 2020 2020 2020 2020 2064 7469 5f6d             dti_m
+00054b30: 6f74 696f 6e5f 636f 7272 6563 7420 3d20  otion_correct = 
+00054b40: 6474 695f 6d6f 7469 6f6e 5f63 6f72 7265  dti_motion_corre
+00054b50: 6374 2c0a 2020 2020 2020 2020 2020 2020  ct,.            
+00054b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054b80: 6474 695f 6465 6e6f 6973 6520 3d20 6474  dti_denoise = dt
+00054b90: 695f 6465 6e6f 6973 652c 0a20 2020 2020  i_denoise,.     
+00054ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054bc0: 2020 2020 2020 2074 6573 745f 7275 6e3d         test_run=
+00054bd0: 7465 7374 5f72 756e 2c0a 2020 2020 2020  test_run,.      
+00054be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00054bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054c10: 2020 2020 2020 2020 2020 2020 6572 726f              erro
-00054c20: 725f 696e 666f 203d 2074 7261 6365 6261  r_info = traceba
-00054c30: 636b 2e66 6f72 6d61 745f 6578 6328 290a  ck.format_exc().
-00054c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054c00: 2020 2020 2020 7665 7262 6f73 653d 5472        verbose=Tr
+00054c10: 7565 2029 0a20 2020 2020 2020 2020 2020  ue ).           
+00054c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054c30: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00054c40: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
 00054c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054c60: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00054c70: 7428 6572 726f 725f 696e 666f 290a 2020  t(error_info).  
-00054c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054ca0: 2020 2020 2020 2020 2020 7669 7375 616c            visual
-00054cb0: 697a 653d 4661 6c73 650a 2020 2020 2020  ize=False.      
-00054cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054ce0: 2020 2020 2020 646f 7772 6974 653d 4661        dowrite=Fa
-00054cf0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-00054d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054d20: 7461 6250 726f 3d7b 2744 5449 273a 4e6f  tabPro={'DTI':No
-00054d30: 6e65 7d0a 2020 2020 2020 2020 2020 2020  ne}.            
-00054d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054d60: 7072 696e 7428 6622 616e 7473 7079 6d6d  print(f"antspymm
-00054d70: 6572 726f 7220 6f63 6375 7272 6564 2077  error occurred w
-00054d80: 6869 6c65 2070 726f 6365 7373 696e 6720  hile processing 
-00054d90: 7b6f 7665 726d 6f64 587d 3a20 7b65 7d22  {overmodX}: {e}"
-00054da0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00054c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054c70: 2020 2020 2020 2020 2020 2020 6572 726f              erro
+00054c80: 725f 696e 666f 203d 2074 7261 6365 6261  r_info = traceba
+00054c90: 636b 2e66 6f72 6d61 745f 6578 6328 290a  ck.format_exc().
+00054ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054cc0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00054cd0: 7428 6572 726f 725f 696e 666f 290a 2020  t(error_info).  
+00054ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054d00: 2020 2020 2020 2020 2020 7669 7375 616c            visual
+00054d10: 697a 653d 4661 6c73 650a 2020 2020 2020  ize=False.      
+00054d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054d40: 2020 2020 2020 646f 7772 6974 653d 4661        dowrite=Fa
+00054d50: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+00054d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054d80: 7461 6250 726f 3d7b 2744 5449 273a 4e6f  tabPro={'DTI':No
+00054d90: 6e65 7d0a 2020 2020 2020 2020 2020 2020  ne}.            
+00054da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00054db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054dc0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00054dd0: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
-00054de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054df0: 2020 2020 2020 206d 7964 7469 203d 2074         mydti = t
-00054e00: 6162 5072 6f5b 2744 5449 275d 0a20 2020  abPro['DTI'].   
+00054dc0: 7072 696e 7428 6622 616e 7473 7079 6d6d  print(f"antspymm
+00054dd0: 6572 726f 7220 6f63 6375 7272 6564 2077  error occurred w
+00054de0: 6869 6c65 2070 726f 6365 7373 696e 6720  hile processing 
+00054df0: 7b6f 7665 726d 6f64 587d 3a20 7b65 7d22  {overmodX}: {e}"
+00054e00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
 00054e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054e30: 2069 6620 7669 7375 616c 697a 6520 616e   if visualize an
-00054e40: 6420 7461 6250 726f 5b27 4454 4927 5d20  d tabPro['DTI'] 
-00054e50: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00054e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054e20: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00054e30: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
+00054e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054e50: 2020 2020 2020 206d 7964 7469 203d 2074         mydti = t
+00054e60: 6162 5072 6f5b 2744 5449 275d 0a20 2020  abPro['DTI'].   
 00054e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054e80: 2020 2020 206d 6178 736c 6963 6520 3d20       maxslice = 
-00054e90: 6e70 2e6d 696e 2820 5b32 312c 206d 7964  np.min( [21, myd
-00054ea0: 7469 5b27 7265 636f 6e5f 6661 275d 205d  ti['recon_fa'] ]
-00054eb0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00054e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054e90: 2069 6620 7669 7375 616c 697a 6520 616e   if visualize an
+00054ea0: 6420 7461 6250 726f 5b27 4454 4927 5d20  d tabPro['DTI'] 
+00054eb0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
 00054ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054ed0: 2020 2020 2020 2020 2020 2061 6e74 732e             ants.
-00054ee0: 706c 6f74 2820 6d79 6474 695b 2772 6563  plot( mydti['rec
-00054ef0: 6f6e 5f66 6127 5d2c 2020 6178 6973 3d32  on_fa'],  axis=2
-00054f00: 2c20 6e73 6c69 6365 733d 6d61 7873 6c69  , nslices=maxsli
-00054f10: 6365 2c20 6e63 6f6c 3d37 2c20 6372 6f70  ce, ncol=7, crop
-00054f20: 3d54 7275 652c 2074 6974 6c65 3d27 4641  =True, title='FA
-00054f30: 272c 2066 696c 656e 616d 653d 6d79 6d6d  ', filename=mymm
-00054f40: 2b6d 7973 6570 2b22 4641 6265 7474 6572  +mysep+"FAbetter
-00054f50: 2e70 6e67 2220 2029 0a20 2020 2020 2020  .png"  ).       
-00054f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054f80: 2061 6e74 732e 706c 6f74 2820 6d79 6474   ants.plot( mydt
-00054f90: 695b 2772 6563 6f6e 5f66 6127 5d2c 206d  i['recon_fa'], m
-00054fa0: 7964 7469 5b27 6a68 755f 6c61 6265 6c73  ydti['jhu_labels
-00054fb0: 275d 2c20 6178 6973 3d32 2c20 6e73 6c69  '], axis=2, nsli
-00054fc0: 6365 733d 6d61 7873 6c69 6365 2c20 6e63  ces=maxslice, nc
-00054fd0: 6f6c 3d37 2c20 6372 6f70 3d54 7275 652c  ol=7, crop=True,
-00054fe0: 2074 6974 6c65 3d27 4641 202b 204a 4855   title='FA + JHU
-00054ff0: 272c 2066 696c 656e 616d 653d 6d79 6d6d  ', filename=mymm
-00055000: 2b6d 7973 6570 2b22 4641 4a48 552e 706e  +mysep+"FAJHU.pn
-00055010: 6722 2020 290a 2020 2020 2020 2020 2020  g"  ).          
-00055020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00055030: 2020 2020 2020 2020 2020 2020 2020 616e                an
-00055040: 7473 2e70 6c6f 7428 206d 7964 7469 5b27  ts.plot( mydti['
-00055050: 7265 636f 6e5f 6d64 275d 2c20 2061 7869  recon_md'],  axi
-00055060: 733d 322c 206e 736c 6963 6573 3d6d 6178  s=2, nslices=max
-00055070: 736c 6963 652c 206e 636f 6c3d 372c 2063  slice, ncol=7, c
-00055080: 726f 703d 5472 7565 2c20 7469 746c 653d  rop=True, title=
-00055090: 274d 4427 2c20 6669 6c65 6e61 6d65 3d6d  'MD', filename=m
-000550a0: 796d 6d2b 6d79 7365 702b 224d 442e 706e  ymm+mysep+"MD.pn
-000550b0: 6722 2020 290a 2020 2020 2020 2020 2020  g"  ).          
-000550c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000550d0: 2020 6966 2064 6f77 7269 7465 3a0a 2020    if dowrite:.  
-000550e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000550f0: 2020 2020 2020 2020 2020 2020 2020 7772                wr
-00055100: 6974 655f 6d6d 2820 6f75 7470 7574 5f70  ite_mm( output_p
-00055110: 7265 6669 783d 6d79 6d6d 2c20 6d6d 3d74  refix=mymm, mm=t
-00055120: 6162 5072 6f2c 206d 6d5f 6e6f 726d 3d6e  abPro, mm_norm=n
-00055130: 6f72 6d50 726f 2c20 7431 7769 6465 3d74  ormPro, t1wide=t
-00055140: 3177 6964 652c 2073 6570 6172 6174 6f72  1wide, separator
-00055150: 3d6d 7973 6570 2029 0a20 2020 2020 2020  =mysep ).       
-00055160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00055170: 2020 2020 2020 2020 2066 6f72 206d 796b           for myk
-00055180: 6579 2069 6e20 6e6f 726d 5072 6f2e 6b65  ey in normPro.ke
-00055190: 7973 2829 3a0a 2020 2020 2020 2020 2020  ys():.          
-000551a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000551b0: 2020 2020 2020 2020 2020 6966 206e 6f72            if nor
-000551c0: 6d50 726f 5b6d 796b 6579 5d20 6973 206e  mPro[mykey] is n
-000551d0: 6f74 204e 6f6e 6520 616e 6420 6e6f 726d  ot None and norm
-000551e0: 5072 6f5b 6d79 6b65 795d 2e63 6f6d 706f  Pro[mykey].compo
-000551f0: 6e65 6e74 7320 3d3d 2031 3a0a 2020 2020  nents == 1:.    
+00054ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054ee0: 2020 2020 206d 6178 736c 6963 6520 3d20       maxslice = 
+00054ef0: 6e70 2e6d 696e 2820 5b32 312c 206d 7964  np.min( [21, myd
+00054f00: 7469 5b27 7265 636f 6e5f 6661 275d 205d  ti['recon_fa'] ]
+00054f10: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00054f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054f30: 2020 2020 2020 2020 2020 2061 6e74 732e             ants.
+00054f40: 706c 6f74 2820 6d79 6474 695b 2772 6563  plot( mydti['rec
+00054f50: 6f6e 5f66 6127 5d2c 2020 6178 6973 3d32  on_fa'],  axis=2
+00054f60: 2c20 6e73 6c69 6365 733d 6d61 7873 6c69  , nslices=maxsli
+00054f70: 6365 2c20 6e63 6f6c 3d37 2c20 6372 6f70  ce, ncol=7, crop
+00054f80: 3d54 7275 652c 2074 6974 6c65 3d27 4641  =True, title='FA
+00054f90: 272c 2066 696c 656e 616d 653d 6d79 6d6d  ', filename=mymm
+00054fa0: 2b6d 7973 6570 2b22 4641 6265 7474 6572  +mysep+"FAbetter
+00054fb0: 2e70 6e67 2220 2029 0a20 2020 2020 2020  .png"  ).       
+00054fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054fe0: 2061 6e74 732e 706c 6f74 2820 6d79 6474   ants.plot( mydt
+00054ff0: 695b 2772 6563 6f6e 5f66 6127 5d2c 206d  i['recon_fa'], m
+00055000: 7964 7469 5b27 6a68 755f 6c61 6265 6c73  ydti['jhu_labels
+00055010: 275d 2c20 6178 6973 3d32 2c20 6e73 6c69  '], axis=2, nsli
+00055020: 6365 733d 6d61 7873 6c69 6365 2c20 6e63  ces=maxslice, nc
+00055030: 6f6c 3d37 2c20 6372 6f70 3d54 7275 652c  ol=7, crop=True,
+00055040: 2074 6974 6c65 3d27 4641 202b 204a 4855   title='FA + JHU
+00055050: 272c 2066 696c 656e 616d 653d 6d79 6d6d  ', filename=mymm
+00055060: 2b6d 7973 6570 2b22 4641 4a48 552e 706e  +mysep+"FAJHU.pn
+00055070: 6722 2020 290a 2020 2020 2020 2020 2020  g"  ).          
+00055080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055090: 2020 2020 2020 2020 2020 2020 2020 616e                an
+000550a0: 7473 2e70 6c6f 7428 206d 7964 7469 5b27  ts.plot( mydti['
+000550b0: 7265 636f 6e5f 6d64 275d 2c20 2061 7869  recon_md'],  axi
+000550c0: 733d 322c 206e 736c 6963 6573 3d6d 6178  s=2, nslices=max
+000550d0: 736c 6963 652c 206e 636f 6c3d 372c 2063  slice, ncol=7, c
+000550e0: 726f 703d 5472 7565 2c20 7469 746c 653d  rop=True, title=
+000550f0: 274d 4427 2c20 6669 6c65 6e61 6d65 3d6d  'MD', filename=m
+00055100: 796d 6d2b 6d79 7365 702b 224d 442e 706e  ymm+mysep+"MD.pn
+00055110: 6722 2020 290a 2020 2020 2020 2020 2020  g"  ).          
+00055120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055130: 2020 6966 2064 6f77 7269 7465 3a0a 2020    if dowrite:.  
+00055140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055150: 2020 2020 2020 2020 2020 2020 2020 7772                wr
+00055160: 6974 655f 6d6d 2820 6f75 7470 7574 5f70  ite_mm( output_p
+00055170: 7265 6669 783d 6d79 6d6d 2c20 6d6d 3d74  refix=mymm, mm=t
+00055180: 6162 5072 6f2c 206d 6d5f 6e6f 726d 3d6e  abPro, mm_norm=n
+00055190: 6f72 6d50 726f 2c20 7431 7769 6465 3d74  ormPro, t1wide=t
+000551a0: 3177 6964 652c 2073 6570 6172 6174 6f72  1wide, separator
+000551b0: 3d6d 7973 6570 2029 0a20 2020 2020 2020  =mysep ).       
+000551c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000551d0: 2020 2020 2020 2020 2066 6f72 206d 796b           for myk
+000551e0: 6579 2069 6e20 6e6f 726d 5072 6f2e 6b65  ey in normPro.ke
+000551f0: 7973 2829 3a0a 2020 2020 2020 2020 2020  ys():.          
 00055200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00055210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00055220: 2020 2020 6966 2076 6973 7561 6c69 7a65      if visualize
-00055230: 2061 6e64 2046 616c 7365 3a0a 2020 2020   and False:.    
-00055240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00055250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00055260: 2020 2020 2020 2020 616e 7473 2e70 6c6f          ants.plo
-00055270: 7428 2074 656d 706c 6174 652c 206e 6f72  t( template, nor
-00055280: 6d50 726f 5b6d 796b 6579 5d2c 2061 7869  mPro[mykey], axi
-00055290: 733d 322c 206e 736c 6963 6573 3d32 312c  s=2, nslices=21,
-000552a0: 206e 636f 6c3d 372c 2063 726f 703d 5472   ncol=7, crop=Tr
-000552b0: 7565 2c20 7469 746c 653d 6d79 6b65 792c  ue, title=mykey,
-000552c0: 2066 696c 656e 616d 653d 6d79 6d6d 2b6d   filename=mymm+m
-000552d0: 7973 6570 2b6d 796b 6579 2b22 2e70 6e67  ysep+mykey+".png
-000552e0: 2220 2020 290a 2020 2020 2020 2020 6966  "   ).        if
-000552f0: 206f 7665 726d 6f64 5820 3d3d 206e 7267   overmodX == nrg
-00055300: 5f6d 6f64 616c 6974 795f 6c69 7374 5b20  _modality_list[ 
-00055310: 6c65 6e28 206e 7267 5f6d 6f64 616c 6974  len( nrg_modalit
-00055320: 795f 6c69 7374 2029 202d 2031 205d 3a0a  y_list ) - 1 ]:.
-00055330: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00055340: 726e 0a20 2020 2020 2020 2069 6620 7665  rn.        if ve
-00055350: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
-00055360: 2020 2070 7269 6e74 2822 646f 6e65 2077     print("done w
-00055370: 6974 6820 2220 2b20 6f76 6572 6d6f 6458  ith " + overmodX
-00055380: 2029 0a20 2020 2069 6620 7665 7262 6f73   ).    if verbos
-00055390: 653a 0a20 2020 2020 2020 2070 7269 6e74  e:.        print
-000553a0: 2822 6d6d 5f6e 7267 2063 6f6d 706c 6574  ("mm_nrg complet
-000553b0: 652e 2229 0a20 2020 2072 6574 7572 6e0a  e.").    return.
-000553c0: 0a64 6566 2073 7065 635f 7461 7065 7228  .def spec_taper(
-000553d0: 782c 2070 3d30 2e31 293a 0a20 2020 2066  x, p=0.1):.    f
-000553e0: 726f 6d20 7363 6970 7920 696d 706f 7274  rom scipy import
-000553f0: 2073 7461 7473 2c20 7369 676e 616c 2c20   stats, signal, 
-00055400: 6666 740a 2020 2020 6672 6f6d 2073 7461  fft.    from sta
-00055410: 7473 6d6f 6465 6c73 2e72 6567 7265 7373  tsmodels.regress
-00055420: 696f 6e2e 6c69 6e65 6172 5f6d 6f64 656c  ion.linear_model
-00055430: 2069 6d70 6f72 7420 7975 6c65 5f77 616c   import yule_wal
-00055440: 6b65 720a 2020 2020 2222 220a 2020 2020  ker.    """.    
-00055450: 436f 6d70 7574 6573 2061 2074 6170 6572  Computes a taper
-00055460: 6564 2076 6572 7369 6f6e 206f 6620 782c  ed version of x,
-00055470: 2077 6974 6820 7461 7065 7269 6e67 2070   with tapering p
-00055480: 2e0a 0a20 2020 2041 6461 7074 6564 2066  ...    Adapted f
-00055490: 726f 6d20 5227 7320 7374 6174 733a 3a73  rom R's stats::s
-000554a0: 7065 632e 7461 7065 7220 6174 2068 7474  pec.taper at htt
-000554b0: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
-000554c0: 7465 6c6d 6f2d 636f 7272 6561 2f74 696d  telmo-correa/tim
-000554d0: 652d 7365 7269 6573 2d61 6e61 6c79 7369  e-series-analysi
-000554e0: 732f 626c 6f62 2f6d 6173 7465 722f 5079  s/blob/master/Py
-000554f0: 7468 6f6e 2f73 7065 6374 7275 6d2e 7079  thon/spectrum.py
-00055500: 0a0a 2020 2020 2222 220a 0a20 2020 2070  ..    """..    p
-00055510: 203d 206e 702e 725f 5b70 5d0a 2020 2020   = np.r_[p].    
-00055520: 6173 7365 7274 206e 702e 616c 6c28 2870  assert np.all((p
-00055530: 203e 3d20 3029 2026 2028 7020 3c20 302e   >= 0) & (p < 0.
-00055540: 3529 292c 2022 2770 2720 6d75 7374 2062  5)), "'p' must b
-00055550: 6520 6265 7477 6565 6e20 3020 616e 6420  e between 0 and 
-00055560: 302e 3522 0a0a 2020 2020 7820 3d20 6e70  0.5"..    x = np
-00055570: 2e72 5f5b 785d 2e61 7374 7970 6528 2766  .r_[x].astype('f
-00055580: 6c6f 6174 3634 2729 0a20 2020 206f 7269  loat64').    ori
-00055590: 6769 6e61 6c5f 7368 6170 6520 3d20 782e  ginal_shape = x.
-000555a0: 7368 6170 650a 0a20 2020 2061 7373 6572  shape..    asser
-000555b0: 7420 6c65 6e28 6f72 6967 696e 616c 5f73  t len(original_s
-000555c0: 6861 7065 2920 3c3d 2032 2c20 2227 7827  hape) <= 2, "'x'
-000555d0: 206d 7573 7420 6861 7665 2061 7420 6d6f   must have at mo
-000555e0: 7374 2032 2064 696d 656e 7369 6f6e 7322  st 2 dimensions"
-000555f0: 0a20 2020 2077 6869 6c65 206c 656e 2878  .    while len(x
-00055600: 2e73 6861 7065 2920 3c20 323a 0a20 2020  .shape) < 2:.   
-00055610: 2020 2020 2078 203d 206e 702e 6578 7061       x = np.expa
-00055620: 6e64 5f64 696d 7328 782c 2061 7869 733d  nd_dims(x, axis=
-00055630: 3129 0a0a 2020 2020 6e72 2c20 6e63 203d  1)..    nr, nc =
-00055640: 2078 2e73 6861 7065 0a20 2020 2069 6620   x.shape.    if 
-00055650: 6c65 6e28 7029 203d 3d20 313a 0a20 2020  len(p) == 1:.   
-00055660: 2020 2020 2070 203d 2070 202a 206e 702e       p = p * np.
-00055670: 6f6e 6573 286e 6329 0a20 2020 2065 6c73  ones(nc).    els
-00055680: 653a 0a20 2020 2020 2020 2061 7373 6572  e:.        asser
-00055690: 7420 6c65 6e28 7029 203d 3d20 6e63 2c20  t len(p) == nc, 
-000556a0: 226c 656e 6774 6820 6f66 2027 7027 206d  "length of 'p' m
-000556b0: 7573 7420 6265 2031 206f 7220 6571 7561  ust be 1 or equa
-000556c0: 6c20 7468 6520 6e75 6d62 6572 206f 6620  l the number of 
-000556d0: 636f 6c75 6d6e 7320 6f66 2027 7827 220a  columns of 'x'".
-000556e0: 0a20 2020 2066 6f72 2069 2069 6e20 7261  .    for i in ra
-000556f0: 6e67 6528 6e63 293a 0a20 2020 2020 2020  nge(nc):.       
-00055700: 206d 203d 2069 6e74 286e 702e 666c 6f6f   m = int(np.floo
-00055710: 7228 6e72 202a 2070 5b69 5d29 290a 2020  r(nr * p[i])).  
-00055720: 2020 2020 2020 6966 206d 203d 3d20 303a        if m == 0:
-00055730: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00055740: 7469 6e75 650a 2020 2020 2020 2020 7720  tinue.        w 
-00055750: 3d20 302e 3520 2a20 2831 202d 206e 702e  = 0.5 * (1 - np.
-00055760: 636f 7328 6e70 2e70 6920 2a20 6e70 2e61  cos(np.pi * np.a
-00055770: 7261 6e67 6528 312c 2032 202a 206d 2c20  range(1, 2 * m, 
-00055780: 7374 6570 3d32 292f 2832 202a 206d 2929  step=2)/(2 * m))
-00055790: 290a 2020 2020 2020 2020 785b 3a2c 2069  ).        x[:, i
-000557a0: 5d20 3d20 6e70 2e72 5f5b 772c 206e 702e  ] = np.r_[w, np.
-000557b0: 6f6e 6573 286e 7220 2d20 3220 2a20 6d29  ones(nr - 2 * m)
-000557c0: 2c20 775b 3a3a 2d31 5d5d 202a 2078 5b3a  , w[::-1]] * x[:
-000557d0: 2c20 695d 0a0a 2020 2020 7820 3d20 6e70  , i]..    x = np
-000557e0: 2e72 6573 6861 7065 2878 2c20 6f72 6967  .reshape(x, orig
-000557f0: 696e 616c 5f73 6861 7065 290a 2020 2020  inal_shape).    
-00055800: 7265 7475 726e 2078 0a0a 6465 6620 706c  return x..def pl
-00055810: 6f74 5f73 7065 6328 7370 6563 5f72 6573  ot_spec(spec_res
-00055820: 2c20 636f 7665 7261 6765 3d4e 6f6e 652c  , coverage=None,
-00055830: 2061 783d 4e6f 6e65 2c20 7469 746c 653d   ax=None, title=
-00055840: 4e6f 6e65 293a 0a20 2020 2069 6d70 6f72  None):.    impor
-00055850: 7420 6d61 7470 6c6f 746c 6962 2e70 7970  t matplotlib.pyp
-00055860: 6c6f 7420 6173 2070 6c74 0a20 2020 2022  lot as plt.    "
-00055870: 2222 436f 6e76 656e 6965 6e63 6520 706c  ""Convenience pl
-00055880: 6f74 7469 6e67 206d 6574 686f 642c 2061  otting method, a
-00055890: 6c73 6f20 696e 636c 7564 6573 2063 6f6e  lso includes con
-000558a0: 6669 6465 6e63 6520 6372 6f73 7320 696e  fidence cross in
-000558b0: 2074 6865 2073 616d 6520 7374 796c 6520   the same style 
-000558c0: 6173 2052 2e0a 0a20 2020 204e 6f74 6520  as R...    Note 
-000558d0: 7468 6174 2074 6865 206c 6f63 6174 696f  that the locatio
-000558e0: 6e20 6f66 2074 6865 2063 726f 7373 2069  n of the cross i
-000558f0: 7320 6972 7265 6c65 7661 6e74 3b20 6f6e  s irrelevant; on
-00055900: 6c79 2077 6964 7468 2061 6e64 2068 6569  ly width and hei
-00055910: 6768 7420 6d61 7474 6572 2e22 2222 0a20  ght matter.""". 
-00055920: 2020 2066 2c20 5078 7820 3d20 7370 6563     f, Pxx = spec
-00055930: 5f72 6573 5b27 6672 6571 275d 2c20 7370  _res['freq'], sp
-00055940: 6563 5f72 6573 5b27 7370 6563 275d 0a0a  ec_res['spec']..
-00055950: 2020 2020 6966 2063 6f76 6572 6167 6520      if coverage 
-00055960: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00055970: 2020 2020 2063 6920 3d20 7370 6563 5f63       ci = spec_c
-00055980: 6928 7370 6563 5f72 6573 5b27 6466 275d  i(spec_res['df']
-00055990: 2c20 636f 7665 7261 6765 3d63 6f76 6572  , coverage=cover
-000559a0: 6167 6529 0a20 2020 2020 2020 2063 6f6e  age).        con
-000559b0: 665f 7820 3d20 286d 6178 2873 7065 635f  f_x = (max(spec_
-000559c0: 7265 735b 2766 7265 7127 5d29 202d 2073  res['freq']) - s
-000559d0: 7065 635f 7265 735b 2762 616e 6477 6964  pec_res['bandwid
-000559e0: 7468 275d 2920 2b20 6e70 2e72 5f5b 2d30  th']) + np.r_[-0
-000559f0: 2e35 2c20 302e 355d 202a 2073 7065 635f  .5, 0.5] * spec_
-00055a00: 7265 735b 2762 616e 6477 6964 7468 275d  res['bandwidth']
-00055a10: 0a20 2020 2020 2020 2063 6f6e 665f 7920  .        conf_y 
-00055a20: 3d20 6d61 7828 7370 6563 5f72 6573 5b27  = max(spec_res['
-00055a30: 7370 6563 275d 2920 2f20 6369 5b31 5d0a  spec']) / ci[1].
-00055a40: 0a20 2020 2069 6620 6178 2069 7320 4e6f  .    if ax is No
-00055a50: 6e65 3a0a 2020 2020 2020 2020 6178 203d  ne:.        ax =
-00055a60: 2070 6c74 2e67 6361 2829 0a0a 2020 2020   plt.gca()..    
-00055a70: 6178 2e70 6c6f 7428 662c 2050 7878 2c20  ax.plot(f, Pxx, 
-00055a80: 636f 6c6f 723d 2743 3027 290a 2020 2020  color='C0').    
-00055a90: 6178 2e73 6574 5f78 6c61 6265 6c28 2746  ax.set_xlabel('F
-00055aa0: 7265 7175 656e 6379 2729 0a20 2020 2061  requency').    a
-00055ab0: 782e 7365 745f 796c 6162 656c 2827 4c6f  x.set_ylabel('Lo
-00055ac0: 6720 5370 6563 7472 756d 2729 0a20 2020  g Spectrum').   
-00055ad0: 2061 782e 7365 745f 7973 6361 6c65 2827   ax.set_yscale('
-00055ae0: 6c6f 6727 290a 2020 2020 6966 2063 6f76  log').    if cov
-00055af0: 6572 6167 6520 6973 206e 6f74 204e 6f6e  erage is not Non
-00055b00: 653a 0a20 2020 2020 2020 2061 782e 706c  e:.        ax.pl
-00055b10: 6f74 286e 702e 6d65 616e 2863 6f6e 665f  ot(np.mean(conf_
-00055b20: 7829 202a 206e 702e 725f 5b31 2c20 315d  x) * np.r_[1, 1]
-00055b30: 2c20 636f 6e66 5f79 202a 2063 692c 2063  , conf_y * ci, c
-00055b40: 6f6c 6f72 3d27 7265 6427 290a 2020 2020  olor='red').    
-00055b50: 2020 2020 6178 2e70 6c6f 7428 636f 6e66      ax.plot(conf
-00055b60: 5f78 2c20 6e70 2e6d 6561 6e28 636f 6e66  _x, np.mean(conf
-00055b70: 5f79 2920 2a20 6e70 2e72 5f5b 312c 2031  _y) * np.r_[1, 1
-00055b80: 5d2c 2063 6f6c 6f72 3d27 7265 6427 290a  ], color='red').
-00055b90: 0a20 2020 2061 782e 7365 745f 7469 746c  .    ax.set_titl
-00055ba0: 6528 7370 6563 5f72 6573 5b27 6d65 7468  e(spec_res['meth
-00055bb0: 6f64 275d 2069 6620 7469 746c 6520 6973  od'] if title is
-00055bc0: 204e 6f6e 6520 656c 7365 2074 6974 6c65   None else title
-00055bd0: 290a 0a64 6566 2073 7065 635f 6369 2864  )..def spec_ci(d
-00055be0: 662c 2063 6f76 6572 6167 653d 302e 3935  f, coverage=0.95
-00055bf0: 293a 0a20 2020 2066 726f 6d20 7363 6970  ):.    from scip
-00055c00: 7920 696d 706f 7274 2073 7461 7473 2c20  y import stats, 
-00055c10: 7369 676e 616c 2c20 6666 740a 2020 2020  signal, fft.    
-00055c20: 6672 6f6d 2073 7461 7473 6d6f 6465 6c73  from statsmodels
-00055c30: 2e72 6567 7265 7373 696f 6e2e 6c69 6e65  .regression.line
-00055c40: 6172 5f6d 6f64 656c 2069 6d70 6f72 7420  ar_model import 
-00055c50: 7975 6c65 5f77 616c 6b65 720a 2020 2020  yule_walker.    
-00055c60: 2222 220a 2020 2020 436f 6d70 7574 6573  """.    Computes
-00055c70: 2074 6865 2063 6f6e 6669 6465 6e63 6520   the confidence 
-00055c80: 696e 7465 7276 616c 2066 6f72 2061 2073  interval for a s
-00055c90: 7065 6374 7261 6c20 6669 742c 2062 6173  pectral fit, bas
-00055ca0: 6564 206f 6e20 7468 6520 6e75 6d62 6572  ed on the number
-00055cb0: 206f 6620 6465 6772 6565 7320 6f66 2066   of degrees of f
-00055cc0: 7265 6564 6f6d 2e0a 0a20 2020 2041 6461  reedom...    Ada
-00055cd0: 7074 6564 2066 726f 6d20 5227 7320 7374  pted from R's st
-00055ce0: 6174 733a 3a70 6c6f 742e 7370 6563 2061  ats::plot.spec a
-00055cf0: 7420 6874 7470 733a 2f2f 6769 7468 7562  t https://github
-00055d00: 2e63 6f6d 2f74 656c 6d6f 2d63 6f72 7265  .com/telmo-corre
-00055d10: 612f 7469 6d65 2d73 6572 6965 732d 616e  a/time-series-an
-00055d20: 616c 7973 6973 2f62 6c6f 622f 6d61 7374  alysis/blob/mast
-00055d30: 6572 2f50 7974 686f 6e2f 7370 6563 7472  er/Python/spectr
-00055d40: 756d 2e70 790a 0a20 2020 2022 2222 0a0a  um.py..    """..
-00055d50: 2020 2020 6173 7365 7274 2063 6f76 6572      assert cover
-00055d60: 6167 6520 3e3d 2030 2061 6e64 2063 6f76  age >= 0 and cov
-00055d70: 6572 6167 6520 3c20 312c 2022 636f 7665  erage < 1, "cove
-00055d80: 7261 6765 2070 726f 6261 6269 6c69 7479  rage probability
-00055d90: 206f 7574 206f 6620 7261 6e67 6520 5b30   out of range [0
-00055da0: 2c20 3129 220a 0a20 2020 2074 6169 6c20  , 1)"..    tail 
-00055db0: 3d20 3120 2d20 636f 7665 7261 6765 0a0a  = 1 - coverage..
-00055dc0: 2020 2020 7068 6920 3d20 7374 6174 732e      phi = stats.
-00055dd0: 6368 6932 2e63 6466 2878 3d64 662c 2064  chi2.cdf(x=df, d
-00055de0: 663d 6466 290a 2020 2020 7570 7065 725f  f=df).    upper_
-00055df0: 7175 616e 7469 6c65 203d 2031 202d 2074  quantile = 1 - t
-00055e00: 6169 6c20 2a20 2831 202d 2070 6869 290a  ail * (1 - phi).
-00055e10: 2020 2020 6c6f 7765 725f 7175 616e 7469      lower_quanti
-00055e20: 6c65 203d 2074 6169 6c20 2a20 7068 690a  le = tail * phi.
-00055e30: 0a20 2020 2072 6574 7572 6e20 6466 202f  .    return df /
-00055e40: 2073 7461 7473 2e63 6869 322e 7070 6628   stats.chi2.ppf(
-00055e50: 5b75 7070 6572 5f71 7561 6e74 696c 652c  [upper_quantile,
-00055e60: 206c 6f77 6572 5f71 7561 6e74 696c 655d   lower_quantile]
-00055e70: 2c20 6466 3d64 6629 0a0a 6465 6620 7370  , df=df)..def sp
-00055e80: 6563 5f70 6772 616d 2878 2c20 7866 7265  ec_pgram(x, xfre
-00055e90: 713d 312c 2073 7061 6e73 3d4e 6f6e 652c  q=1, spans=None,
-00055ea0: 206b 6572 6e65 6c3d 4e6f 6e65 2c20 7461   kernel=None, ta
-00055eb0: 7065 723d 302e 312c 2070 6164 3d30 2c20  per=0.1, pad=0, 
-00055ec0: 6661 7374 3d54 7275 652c 2064 656d 6561  fast=True, demea
-00055ed0: 6e3d 4661 6c73 652c 2064 6574 7265 6e64  n=False, detrend
-00055ee0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-00055ef0: 2020 2020 2020 706c 6f74 3d54 7275 652c        plot=True,
-00055f00: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-00055f10: 2222 220a 2020 2020 436f 6d70 7574 6573  """.    Computes
-00055f20: 2074 6865 2073 7065 6374 7261 6c20 6465   the spectral de
-00055f30: 6e73 6974 7920 6573 7469 6d61 7465 2075  nsity estimate u
-00055f40: 7369 6e67 2061 2070 6572 696f 646f 6772  sing a periodogr
-00055f50: 616d 2e20 204f 7074 696f 6e61 6c6c 792c  am.  Optionally,
-00055f60: 2069 7420 616c 736f 3a0a 2020 2020 2d20   it also:.    - 
-00055f70: 5573 6573 2061 2070 726f 7669 6465 6420  Uses a provided 
-00055f80: 6b65 726e 656c 2077 696e 646f 772c 206f  kernel window, o
-00055f90: 7220 6120 7365 7175 656e 6365 206f 6620  r a sequence of 
-00055fa0: 7370 616e 7320 666f 7220 636f 6e76 6f6c  spans for convol
-00055fb0: 7574 6564 206d 6f64 6966 6965 6420 4461  uted modified Da
-00055fc0: 6e69 656c 6c20 6b65 726e 656c 732e 0a20  niell kernels.. 
-00055fd0: 2020 202d 2054 6170 6572 7320 7468 6520     - Tapers the 
-00055fe0: 7374 6172 7420 616e 6420 656e 6420 6f66  start and end of
-00055ff0: 2074 6865 2073 6572 6965 7320 746f 2061   the series to a
-00056000: 766f 6964 2065 6e64 2d6f 662d 7369 676e  void end-of-sign
-00056010: 616c 2065 6666 6563 7473 2e0a 2020 2020  al effects..    
-00056020: 2d20 5061 6473 2074 6865 2070 726f 7669  - Pads the provi
-00056030: 6465 6420 7365 7269 6573 2062 6566 6f72  ded series befor
-00056040: 6520 636f 6d70 7574 6174 696f 6e2c 2061  e computation, a
-00056050: 6464 696e 6720 7061 642a 286c 656e 6774  dding pad*(lengt
-00056060: 6820 6f66 2073 6572 6965 7329 207a 6572  h of series) zer
-00056070: 6f73 2061 7420 7468 6520 656e 642e 0a20  os at the end.. 
-00056080: 2020 202d 2050 6164 7320 7468 6520 7072     - Pads the pr
-00056090: 6f76 6964 6564 2073 6572 6965 7320 6265  ovided series be
-000560a0: 666f 7265 2063 6f6d 7075 7461 7469 6f6e  fore computation
-000560b0: 2074 6f20 7370 6565 6420 7570 2046 4654   to speed up FFT
-000560c0: 2063 616c 6375 6c61 7469 6f6e 2e0a 2020   calculation..  
-000560d0: 2020 2d20 5065 7266 6f72 6d73 2064 656d    - Performs dem
-000560e0: 6561 6e69 6e67 206f 7220 6465 7472 656e  eaning or detren
-000560f0: 6469 6e67 206f 6e20 7468 6520 7365 7269  ding on the seri
-00056100: 6573 2e0a 2020 2020 2d20 506c 6f74 7320  es..    - Plots 
-00056110: 7265 7375 6c74 732e 0a0a 2020 2020 496d  results...    Im
-00056120: 706c 656d 656e 7465 6420 746f 2065 6e73  plemented to ens
-00056130: 7572 6520 636f 6d70 6174 6962 696c 6974  ure compatibilit
-00056140: 7920 7769 7468 2052 2773 2073 7065 6374  y with R's spect
-00056150: 7261 6c20 6675 6e63 7469 6f6e 732c 2061  ral functions, a
-00056160: 7320 6f70 706f 7365 6420 746f 2072 6575  s opposed to reu
-00056170: 7369 6e67 2073 6369 7079 2773 2070 6572  sing scipy's per
-00056180: 696f 646f 6772 616d 2e0a 0a20 2020 2041  iodogram...    A
-00056190: 6461 7074 6564 2066 726f 6d20 5227 7320  dapted from R's 
-000561a0: 7374 6174 733a 3a73 7065 632e 7067 7261  stats::spec.pgra
-000561b0: 6d20 6174 2068 7474 7073 3a2f 2f67 6974  m at https://git
-000561c0: 6875 622e 636f 6d2f 7465 6c6d 6f2d 636f  hub.com/telmo-co
-000561d0: 7272 6561 2f74 696d 652d 7365 7269 6573  rrea/time-series
-000561e0: 2d61 6e61 6c79 7369 732f 626c 6f62 2f6d  -analysis/blob/m
-000561f0: 6173 7465 722f 5079 7468 6f6e 2f73 7065  aster/Python/spe
-00056200: 6374 7275 6d2e 7079 0a0a 2020 2020 6578  ctrum.py..    ex
-00056210: 616d 706c 653a 0a0a 2020 2020 696d 706f  ample:..    impo
-00056220: 7274 206e 756d 7079 2061 7320 6e70 0a20  rt numpy as np. 
-00056230: 2020 2069 6d70 6f72 7420 616e 7473 7079     import antspy
-00056240: 6d6d 0a20 2020 206d 7978 203d 206e 702e  mm.    myx = np.
-00056250: 7261 6e64 6f6d 2e72 616e 6428 3130 302c  random.rand(100,
-00056260: 3129 0a20 2020 206d 7973 7065 6320 3d20  1).    myspec = 
-00056270: 616e 7473 7079 6d6d 2e73 7065 635f 7067  antspymm.spec_pg
-00056280: 7261 6d28 6d79 782c 302e 3529 0a0a 2020  ram(myx,0.5)..  
-00056290: 2020 2222 220a 2020 2020 6672 6f6d 2073    """.    from s
-000562a0: 6369 7079 2069 6d70 6f72 7420 7374 6174  cipy import stat
-000562b0: 732c 2073 6967 6e61 6c2c 2066 6674 0a20  s, signal, fft. 
-000562c0: 2020 2066 726f 6d20 7374 6174 736d 6f64     from statsmod
-000562d0: 656c 732e 7265 6772 6573 7369 6f6e 2e6c  els.regression.l
-000562e0: 696e 6561 725f 6d6f 6465 6c20 696d 706f  inear_model impo
-000562f0: 7274 2079 756c 655f 7761 6c6b 6572 0a20  rt yule_walker. 
-00056300: 2020 2064 6566 2064 616e 6965 6c6c 5f77     def daniell_w
-00056310: 696e 646f 775f 6d6f 6469 6669 6564 286d  indow_modified(m
-00056320: 293a 0a20 2020 2020 2020 2022 2222 2053  ):.        """ S
-00056330: 696e 676c 652d 7061 7373 206d 6f64 6966  ingle-pass modif
-00056340: 6965 6420 4461 6e69 656c 6c20 6b65 726e  ied Daniell kern
-00056350: 656c 2077 696e 646f 772e 0a0a 2020 2020  el window...    
-00056360: 2020 2020 5765 6967 6874 2069 7320 6e6f      Weight is no
-00056370: 726d 616c 697a 6564 2074 6f20 6164 6420  rmalized to add 
-00056380: 7570 2074 6f20 312c 2061 6e64 2061 6c6c  up to 1, and all
-00056390: 2076 616c 7565 7320 6172 6520 7468 6520   values are the 
-000563a0: 7361 6d65 2c20 6f74 6865 7220 7468 616e  same, other than
-000563b0: 2074 6865 2066 6972 7374 2061 6e64 2074   the first and t
-000563c0: 6865 0a20 2020 2020 2020 206c 6173 742c  he.        last,
-000563d0: 2077 6869 6368 2061 7265 2064 6976 6964   which are divid
-000563e0: 6564 2062 7920 322e 0a20 2020 2020 2020  ed by 2..       
-000563f0: 2022 2222 0a20 2020 2020 2020 2064 6566   """.        def
-00056400: 2077 286b 293a 0a20 2020 2020 2020 2020   w(k):.         
-00056410: 2020 2072 6574 7572 6e20 6e70 2e77 6865     return np.whe
-00056420: 7265 286e 702e 6162 7328 6b29 203c 206d  re(np.abs(k) < m
-00056430: 2c20 3120 2f20 2832 2a6d 292c 206e 702e  , 1 / (2*m), np.
-00056440: 7768 6572 6528 6e70 2e61 6273 286b 2920  where(np.abs(k) 
-00056450: 3d3d 206d 2c20 312f 2834 2a6d 292c 2030  == m, 1/(4*m), 0
-00056460: 2929 0a0a 2020 2020 2020 2020 7265 7475  ))..        retu
-00056470: 726e 2077 286e 702e 6172 616e 6765 282d  rn w(np.arange(-
-00056480: 6d2c 206d 2b31 2929 0a0a 2020 2020 6465  m, m+1))..    de
-00056490: 6620 6461 6e69 656c 6c5f 7769 6e64 6f77  f daniell_window
-000564a0: 5f63 6f6e 766f 6c76 6528 7629 3a0a 2020  _convolve(v):.  
-000564b0: 2020 2020 2020 2222 2220 436f 6e76 6f6c        """ Convol
-000564c0: 7665 6420 7665 7273 696f 6e20 6f66 206d  ved version of m
-000564d0: 756c 7469 706c 6520 6d6f 6469 6669 6564  ultiple modified
-000564e0: 2044 616e 6965 6c6c 206b 6572 6e65 6c20   Daniell kernel 
-000564f0: 7769 6e64 6f77 732e 0a0a 2020 2020 2020  windows...      
-00056500: 2020 5061 7261 6d65 7465 7220 7620 7368    Parameter v sh
-00056510: 6f75 6c64 2062 6520 616e 2069 7465 7261  ould be an itera
-00056520: 626c 6520 6f66 206d 2076 616c 7565 732e  ble of m values.
-00056530: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
-00056540: 2020 2020 2020 6966 206c 656e 2876 2920        if len(v) 
-00056550: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-00056560: 2020 7265 7475 726e 206e 702e 725f 5b31    return np.r_[1
-00056570: 5d0a 0a20 2020 2020 2020 2069 6620 6c65  ]..        if le
-00056580: 6e28 7629 203d 3d20 313a 0a20 2020 2020  n(v) == 1:.     
-00056590: 2020 2020 2020 2072 6574 7572 6e20 6461         return da
-000565a0: 6e69 656c 6c5f 7769 6e64 6f77 5f6d 6f64  niell_window_mod
-000565b0: 6966 6965 6428 765b 305d 290a 0a20 2020  ified(v[0])..   
-000565c0: 2020 2020 2072 6574 7572 6e20 7369 676e       return sign
-000565d0: 616c 2e63 6f6e 766f 6c76 6528 6461 6e69  al.convolve(dani
-000565e0: 656c 6c5f 7769 6e64 6f77 5f6d 6f64 6966  ell_window_modif
-000565f0: 6965 6428 765b 305d 292c 2064 616e 6965  ied(v[0]), danie
-00056600: 6c6c 5f77 696e 646f 775f 636f 6e76 6f6c  ll_window_convol
-00056610: 7665 2876 5b31 3a5d 2929 0a0a 2020 2020  ve(v[1:]))..    
-00056620: 2320 456e 7375 7265 2077 6520 6361 6e20  # Ensure we can 
-00056630: 7374 6f72 6520 6e6f 6e2d 696e 7465 6765  store non-intege
-00056640: 7273 2069 6e20 782c 2061 6e64 2074 6861  rs in x, and tha
-00056650: 7420 6974 2069 7320 6120 6e75 6d70 7920  t it is a numpy 
-00056660: 6f62 6a65 6374 0a20 2020 2078 203d 206e  object.    x = n
-00056670: 702e 725f 5b78 5d2e 6173 7479 7065 2827  p.r_[x].astype('
-00056680: 666c 6f61 7436 3427 290a 2020 2020 6f72  float64').    or
-00056690: 6967 696e 616c 5f73 6861 7065 203d 2078  iginal_shape = x
-000566a0: 2e73 6861 7065 0a0a 2020 2020 2320 456e  .shape..    # En
-000566b0: 7375 7265 2063 6f72 7265 6374 2064 696d  sure correct dim
-000566c0: 656e 7369 6f6e 730a 2020 2020 6173 7365  ensions.    asse
-000566d0: 7274 206c 656e 286f 7269 6769 6e61 6c5f  rt len(original_
-000566e0: 7368 6170 6529 203c 3d20 322c 2022 2778  shape) <= 2, "'x
-000566f0: 2720 6d75 7374 2068 6176 6520 6174 206d  ' must have at m
-00056700: 6f73 7420 3220 6469 6d65 6e73 696f 6e73  ost 2 dimensions
-00056710: 220a 2020 2020 7768 696c 6520 6c65 6e28  ".    while len(
-00056720: 782e 7368 6170 6529 203c 2032 3a0a 2020  x.shape) < 2:.  
-00056730: 2020 2020 2020 7820 3d20 6e70 2e65 7870        x = np.exp
-00056740: 616e 645f 6469 6d73 2878 2c20 6178 6973  and_dims(x, axis
-00056750: 3d31 290a 0a20 2020 204e 2c20 6e73 6572  =1)..    N, nser
-00056760: 203d 2078 2e73 6861 7065 0a20 2020 204e   = x.shape.    N
-00056770: 3020 3d20 4e0a 0a20 2020 2023 2045 6e73  0 = N..    # Ens
-00056780: 7572 6520 6f6e 6c79 206f 6e65 206f 6620  ure only one of 
-00056790: 7370 616e 732c 206b 6572 6e65 6c20 6973  spans, kernel is
-000567a0: 2070 726f 7669 6465 642c 2061 6e64 2062   provided, and b
-000567b0: 7569 6c64 2074 6865 206b 6572 6e65 6c20  uild the kernel 
-000567c0: 7769 6e64 6f77 2069 6620 6e65 6564 6564  window if needed
-000567d0: 0a20 2020 2061 7373 6572 7420 2873 7061  .    assert (spa
-000567e0: 6e73 2069 7320 4e6f 6e65 2920 6f72 2028  ns is None) or (
-000567f0: 6b65 726e 656c 2069 7320 4e6f 6e65 292c  kernel is None),
-00056800: 2022 6d75 7374 2073 7065 6369 6679 206f   "must specify o
-00056810: 6e6c 7920 6f6e 6520 6f66 2027 7370 616e  nly one of 'span
-00056820: 7327 206f 7220 276b 6572 6e65 6c27 220a  s' or 'kernel'".
-00056830: 2020 2020 6966 2073 7061 6e73 2069 7320      if spans is 
-00056840: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00056850: 2020 6b65 726e 656c 203d 2064 616e 6965    kernel = danie
-00056860: 6c6c 5f77 696e 646f 775f 636f 6e76 6f6c  ll_window_convol
-00056870: 7665 286e 702e 666c 6f6f 725f 6469 7669  ve(np.floor_divi
-00056880: 6465 286e 702e 725f 5b73 7061 6e73 5d2c  de(np.r_[spans],
-00056890: 2032 2929 0a0a 2020 2020 2320 4465 7472   2))..    # Detr
-000568a0: 656e 6420 6f72 2064 656d 6561 6e20 7468  end or demean th
-000568b0: 6520 7365 7269 6573 0a20 2020 2069 6620  e series.    if 
-000568c0: 6465 7472 656e 643a 0a20 2020 2020 2020  detrend:.       
-000568d0: 2074 203d 206e 702e 6172 616e 6765 284e   t = np.arange(N
-000568e0: 2920 2d20 284e 202d 2031 292f 320a 2020  ) - (N - 1)/2.  
-000568f0: 2020 2020 2020 7375 6d74 3220 3d20 4e20        sumt2 = N 
-00056900: 2a20 284e 2a2a 3220 2d20 3129 2f31 320a  * (N**2 - 1)/12.
-00056910: 2020 2020 2020 2020 7820 2d3d 2028 6e70          x -= (np
-00056920: 2e72 6570 6561 7428 6e70 2e65 7870 616e  .repeat(np.expan
-00056930: 645f 6469 6d73 286e 702e 6d65 616e 2878  d_dims(np.mean(x
-00056940: 2c20 6178 6973 3d30 292c 2030 292c 204e  , axis=0), 0), N
-00056950: 2c20 6178 6973 3d30 2920 2b20 6e70 2e6f  , axis=0) + np.o
-00056960: 7574 6572 286e 702e 7375 6d28 782e 5420  uter(np.sum(x.T 
-00056970: 2a20 742c 2061 7869 733d 3129 2c20 742f  * t, axis=1), t/
-00056980: 7375 6d74 3229 2e54 290a 2020 2020 656c  sumt2).T).    el
-00056990: 6966 2064 656d 6561 6e3a 0a20 2020 2020  if demean:.     
-000569a0: 2020 2078 202d 3d20 6e70 2e6d 6561 6e28     x -= np.mean(
-000569b0: 782c 2061 7869 733d 3029 0a0a 2020 2020  x, axis=0)..    
-000569c0: 2320 436f 6d70 7574 6520 7461 7065 7220  # Compute taper 
-000569d0: 616e 6420 7461 7065 7220 6164 6a75 7374  and taper adjust
-000569e0: 6d65 6e74 2076 6172 6961 626c 6573 0a20  ment variables. 
-000569f0: 2020 2078 203d 2073 7065 635f 7461 7065     x = spec_tape
-00056a00: 7228 782c 2074 6170 6572 290a 2020 2020  r(x, taper).    
-00056a10: 7532 203d 2028 3120 2d20 2835 2f38 2920  u2 = (1 - (5/8) 
-00056a20: 2a20 7461 7065 7220 2a20 3229 0a20 2020  * taper * 2).   
-00056a30: 2075 3420 3d20 2831 202d 2028 3933 2f31   u4 = (1 - (93/1
-00056a40: 3238 2920 2a20 7461 7065 7220 2a20 3229  28) * taper * 2)
-00056a50: 0a0a 2020 2020 2320 5061 6420 7468 6520  ..    # Pad the 
-00056a60: 7365 7269 6573 2077 6974 6820 636f 7069  series with copi
-00056a70: 6573 206f 6620 7468 6520 7361 6d65 2073  es of the same s
-00056a80: 6861 7065 2c20 6275 7420 6669 6c6c 6564  hape, but filled
-00056a90: 2077 6974 6820 7a65 726f 6573 0a20 2020   with zeroes.   
-00056aa0: 2069 6620 7061 6420 3e20 303a 0a20 2020   if pad > 0:.   
-00056ab0: 2020 2020 2078 203d 206e 702e 725f 5b78       x = np.r_[x
-00056ac0: 2c20 6e70 2e7a 6572 6f73 2828 7061 6420  , np.zeros((pad 
-00056ad0: 2a20 782e 7368 6170 655b 305d 2c20 782e  * x.shape[0], x.
-00056ae0: 7368 6170 655b 315d 2929 5d0a 2020 2020  shape[1]))].    
-00056af0: 2020 2020 4e20 3d20 782e 7368 6170 655b      N = x.shape[
-00056b00: 305d 0a0a 2020 2020 2320 4675 7274 6865  0]..    # Furthe
-00056b10: 7220 7061 6420 7468 6520 7365 7269 6573  r pad the series
-00056b20: 2074 6f20 6163 6365 6c65 7261 7465 2046   to accelerate F
-00056b30: 4654 2063 6f6d 7075 7461 7469 6f6e 0a20  FT computation. 
-00056b40: 2020 2069 6620 6661 7374 3a0a 2020 2020     if fast:.    
-00056b50: 2020 2020 6e65 774e 203d 2066 6674 2e6e      newN = fft.n
-00056b60: 6578 745f 6661 7374 5f6c 656e 284e 2c20  ext_fast_len(N, 
-00056b70: 5472 7565 290a 2020 2020 2020 2020 7820  True).        x 
-00056b80: 3d20 6e70 2e72 5f5b 782c 206e 702e 7a65  = np.r_[x, np.ze
-00056b90: 726f 7328 286e 6577 4e20 2d20 4e2c 2078  ros((newN - N, x
-00056ba0: 2e73 6861 7065 5b31 5d29 295d 0a20 2020  .shape[1]))].   
-00056bb0: 2020 2020 204e 203d 206e 6577 4e0a 0a20       N = newN.. 
-00056bc0: 2020 2023 2043 6f6d 7075 7465 2074 6865     # Compute the
-00056bd0: 2046 6f75 7269 6572 2066 7265 7175 656e   Fourier frequen
-00056be0: 6369 6573 2028 5227 7320 7370 6563 2e70  cies (R's spec.p
-00056bf0: 6772 616d 2063 6f6e 7665 6e74 696f 6e20  gram convention 
-00056c00: 7374 796c 6529 0a20 2020 204e 7370 6563  style).    Nspec
-00056c10: 203d 2069 6e74 286e 702e 666c 6f6f 7228   = int(np.floor(
-00056c20: 4e2f 3229 290a 2020 2020 6672 6571 203d  N/2)).    freq =
-00056c30: 2028 6e70 2e61 7261 6e67 6528 4e73 7065   (np.arange(Nspe
-00056c40: 6329 202b 2031 2920 2a20 7866 7265 7120  c) + 1) * xfreq 
-00056c50: 2f20 4e0a 0a20 2020 2023 2054 7261 6e73  / N..    # Trans
-00056c60: 6c61 7469 6f6e 7320 746f 206b 6565 7020  lations to keep 
-00056c70: 7361 6d65 2072 6f77 202f 2063 6f6c 756d  same row / colum
-00056c80: 6e20 636f 6e76 656e 7469 6f6e 2061 7320  n convention as 
-00056c90: 7374 6174 733a 3a6d 7666 6674 0a20 2020  stats::mvfft.   
-00056ca0: 2078 6666 7420 3d20 6666 742e 6666 7428   xfft = fft.fft(
-00056cb0: 782e 5429 2e54 0a0a 2020 2020 2320 436f  x.T).T..    # Co
-00056cc0: 6d70 7574 6520 7468 6520 7065 7269 6f64  mpute the period
-00056cd0: 6f67 7261 6d20 666f 7220 6561 6368 2069  ogram for each i
-00056ce0: 2c20 6a0a 2020 2020 7067 7261 6d20 3d20  , j.    pgram = 
-00056cf0: 6e70 2e65 6d70 7479 2828 4e2c 206e 7365  np.empty((N, nse
-00056d00: 722c 206e 7365 7229 2c20 6474 7970 653d  r, nser), dtype=
-00056d10: 2763 6f6d 706c 6578 2729 0a20 2020 2066  'complex').    f
-00056d20: 6f72 2069 2069 6e20 7261 6e67 6528 6e73  or i in range(ns
-00056d30: 6572 293a 0a20 2020 2020 2020 2066 6f72  er):.        for
-00056d40: 206a 2069 6e20 7261 6e67 6528 6e73 6572   j in range(nser
-00056d50: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
-00056d60: 6772 616d 5b3a 2c20 692c 206a 5d20 3d20  gram[:, i, j] = 
-00056d70: 7866 6674 5b3a 2c20 695d 202a 206e 702e  xfft[:, i] * np.
-00056d80: 636f 6e6a 2878 6666 745b 3a2c 206a 5d29  conj(xfft[:, j])
-00056d90: 202f 2028 4e30 202a 2078 6672 6571 290a   / (N0 * xfreq).
-00056da0: 2020 2020 2020 2020 2020 2020 7067 7261              pgra
-00056db0: 6d5b 302c 2069 2c20 6a5d 203d 2030 2e35  m[0, i, j] = 0.5
-00056dc0: 202a 2028 7067 7261 6d5b 312c 2069 2c20   * (pgram[1, i, 
-00056dd0: 6a5d 202b 2070 6772 616d 5b2d 312c 2069  j] + pgram[-1, i
-00056de0: 2c20 6a5d 290a 0a20 2020 2069 6620 6b65  , j])..    if ke
-00056df0: 726e 656c 2069 7320 4e6f 6e65 3a0a 2020  rnel is None:.  
-00056e00: 2020 2020 2020 2320 5661 6c75 6573 2070        # Values p
-00056e10: 7265 2d61 646a 7573 746d 656e 740a 2020  re-adjustment.  
-00056e20: 2020 2020 2020 6466 203d 2032 0a20 2020        df = 2.   
-00056e30: 2020 2020 2062 616e 6477 6964 7468 203d       bandwidth =
-00056e40: 206e 702e 7371 7274 2831 202f 2031 3229   np.sqrt(1 / 12)
-00056e50: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00056e60: 2020 2064 6566 2063 6f6e 765f 6369 7263     def conv_circ
-00056e70: 756c 6172 2873 6967 6e61 6c2c 206b 6572  ular(signal, ker
-00056e80: 6e65 6c29 3a0a 2020 2020 2020 2020 2020  nel):.          
-00056e90: 2020 2222 220a 2020 2020 2020 2020 2020    """.          
-00056ea0: 2020 5065 7266 6f72 6d73 2031 4420 6369    Performs 1D ci
-00056eb0: 7263 756c 6172 2063 6f6e 766f 6c75 7469  rcular convoluti
-00056ec0: 6f6e 2c20 696e 2074 6865 2073 616d 6520  on, in the same 
-00056ed0: 7374 796c 6520 6173 2052 3a3a 6b65 726e  style as R::kern
-00056ee0: 6170 706c 792c 0a20 2020 2020 2020 2020  apply,.         
-00056ef0: 2020 2061 7373 756d 696e 6720 7468 6520     assuming the 
-00056f00: 6b65 726e 656c 2077 696e 646f 7720 6973  kernel window is
-00056f10: 2063 656e 7465 7265 6420 6174 2030 2e0a   centered at 0..
-00056f20: 2020 2020 2020 2020 2020 2020 2222 220a              """.
-00056f30: 2020 2020 2020 2020 2020 2020 7061 6420              pad 
-00056f40: 3d20 6c65 6e28 7369 676e 616c 2920 2d20  = len(signal) - 
-00056f50: 6c65 6e28 6b65 726e 656c 290a 2020 2020  len(kernel).    
-00056f60: 2020 2020 2020 2020 6861 6c66 5f77 696e          half_win
-00056f70: 646f 7720 3d20 696e 7428 286c 656e 286b  dow = int((len(k
-00056f80: 6572 6e65 6c29 202b 2031 2920 2f20 3229  ernel) + 1) / 2)
-00056f90: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
-00056fa0: 6578 6573 203d 2072 616e 6765 282d 6861  exes = range(-ha
-00056fb0: 6c66 5f77 696e 646f 772c 206c 656e 2873  lf_window, len(s
-00056fc0: 6967 6e61 6c29 202d 2068 616c 665f 7769  ignal) - half_wi
-00056fd0: 6e64 6f77 290a 2020 2020 2020 2020 2020  ndow).          
-00056fe0: 2020 6f72 6967 5f63 6f6e 7620 3d20 6e70    orig_conv = np
-00056ff0: 2e72 6561 6c28 6666 742e 6966 6674 2866  .real(fft.ifft(f
-00057000: 6674 2e66 6674 2873 6967 6e61 6c29 202a  ft.fft(signal) *
-00057010: 2066 6674 2e66 6674 286e 702e 725f 5b6e   fft.fft(np.r_[n
-00057020: 702e 7a65 726f 7328 7061 6429 2c20 6b65  p.zeros(pad), ke
-00057030: 726e 656c 5d29 2929 0a20 2020 2020 2020  rnel]))).       
-00057040: 2020 2020 2072 6574 7572 6e20 6f72 6967       return orig
-00057050: 5f63 6f6e 762e 7461 6b65 2869 6e64 6578  _conv.take(index
-00057060: 6573 2c20 6d6f 6465 3d27 7772 6170 2729  es, mode='wrap')
-00057070: 0a0a 2020 2020 2020 2020 2320 436f 6e76  ..        # Conv
-00057080: 6f6c 7665 2070 6772 616d 2077 6974 6820  olve pgram with 
-00057090: 6b65 726e 656c 2077 6974 6820 6369 7263  kernel with circ
-000570a0: 756c 6172 2063 6f6e 760a 2020 2020 2020  ular conv.      
-000570b0: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-000570c0: 286e 7365 7229 3a0a 2020 2020 2020 2020  (nser):.        
-000570d0: 2020 2020 666f 7220 6a20 696e 2072 616e      for j in ran
-000570e0: 6765 286e 7365 7229 3a0a 2020 2020 2020  ge(nser):.      
-000570f0: 2020 2020 2020 2020 2020 7067 7261 6d5b            pgram[
-00057100: 3a2c 2069 2c20 6a5d 203d 2063 6f6e 765f  :, i, j] = conv_
-00057110: 6369 7263 756c 6172 2870 6772 616d 5b3a  circular(pgram[:
-00057120: 2c20 692c 206a 5d2c 206b 6572 6e65 6c29  , i, j], kernel)
-00057130: 0a0a 2020 2020 2020 2020 6466 203d 2032  ..        df = 2
-00057140: 202f 206e 702e 7375 6d28 6b65 726e 656c   / np.sum(kernel
-00057150: 2a2a 3229 0a20 2020 2020 2020 206d 203d  **2).        m =
-00057160: 2028 6c65 6e28 6b65 726e 656c 2920 2d20   (len(kernel) - 
-00057170: 3129 2f32 0a20 2020 2020 2020 206b 203d  1)/2.        k =
-00057180: 206e 702e 6172 616e 6765 282d 6d2c 206d   np.arange(-m, m
-00057190: 2b31 290a 2020 2020 2020 2020 6261 6e64  +1).        band
-000571a0: 7769 6474 6820 3d20 6e70 2e73 7172 7428  width = np.sqrt(
-000571b0: 6e70 2e73 756d 2828 312f 3132 202b 206b  np.sum((1/12 + k
-000571c0: 2a2a 3229 202a 206b 6572 6e65 6c29 290a  **2) * kernel)).
-000571d0: 0a20 2020 2064 6620 3d20 6466 2f28 7534  .    df = df/(u4
-000571e0: 2f75 322a 2a32 292a 284e 302f 4e29 0a20  /u2**2)*(N0/N). 
-000571f0: 2020 2062 616e 6477 6964 7468 203d 2062     bandwidth = b
-00057200: 616e 6477 6964 7468 202a 2078 6672 6571  andwidth * xfreq
-00057210: 2f4e 0a0a 2020 2020 2320 5265 6d6f 7665  /N..    # Remove
-00057220: 2070 6164 6465 6420 7265 7375 6c74 730a   padded results.
-00057230: 2020 2020 7067 7261 6d20 3d20 7067 7261      pgram = pgra
-00057240: 6d5b 313a 284e 7370 6563 2b31 292c 203a  m[1:(Nspec+1), :
-00057250: 2c20 3a5d 0a0a 2020 2020 7370 6563 203d  , :]..    spec =
-00057260: 206e 702e 656d 7074 7928 284e 7370 6563   np.empty((Nspec
-00057270: 2c20 6e73 6572 2929 0a20 2020 2066 6f72  , nser)).    for
-00057280: 2069 2069 6e20 7261 6e67 6528 6e73 6572   i in range(nser
-00057290: 293a 0a20 2020 2020 2020 2073 7065 635b  ):.        spec[
-000572a0: 3a2c 2069 5d20 3d20 6e70 2e72 6561 6c28  :, i] = np.real(
-000572b0: 7067 7261 6d5b 3a2c 2069 2c20 695d 290a  pgram[:, i, i]).
-000572c0: 0a20 2020 2069 6620 6e73 6572 203d 3d20  .    if nser == 
-000572d0: 313a 0a20 2020 2020 2020 2063 6f68 203d  1:.        coh =
-000572e0: 204e 6f6e 650a 2020 2020 2020 2020 7068   None.        ph
-000572f0: 6173 6520 3d20 4e6f 6e65 0a20 2020 2065  ase = None.    e
-00057300: 6c73 653a 0a20 2020 2020 2020 2063 6f68  lse:.        coh
-00057310: 203d 206e 702e 656d 7074 7928 284e 7370   = np.empty((Nsp
-00057320: 6563 2c20 696e 7428 6e73 6572 202a 2028  ec, int(nser * (
-00057330: 6e73 6572 202d 2031 292f 3229 2929 0a20  nser - 1)/2))). 
-00057340: 2020 2020 2020 2070 6861 7365 203d 206e         phase = n
-00057350: 702e 656d 7074 7928 284e 7370 6563 2c20  p.empty((Nspec, 
-00057360: 696e 7428 6e73 6572 202a 2028 6e73 6572  int(nser * (nser
-00057370: 202d 2031 292f 3229 2929 0a20 2020 2020   - 1)/2))).     
-00057380: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-00057390: 6528 6e73 6572 293a 0a20 2020 2020 2020  e(nser):.       
-000573a0: 2020 2020 2066 6f72 206a 2069 6e20 7261       for j in ra
-000573b0: 6e67 6528 692b 312c 206e 7365 7229 3a0a  nge(i+1, nser):.
-000573c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000573d0: 696e 6465 7820 3d20 696e 7428 6920 2b20  index = int(i + 
-000573e0: 6a2a 286a 2d31 292f 3229 0a20 2020 2020  j*(j-1)/2).     
-000573f0: 2020 2020 2020 2020 2020 2063 6f68 5b3a             coh[:
-00057400: 2c20 696e 6465 785d 203d 206e 702e 6162  , index] = np.ab
-00057410: 7328 7067 7261 6d5b 3a2c 2069 2c20 6a5d  s(pgram[:, i, j]
-00057420: 292a 2a32 202f 2028 7370 6563 5b3a 2c20  )**2 / (spec[:, 
-00057430: 695d 202a 2073 7065 635b 3a2c 206a 5d29  i] * spec[:, j])
-00057440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00057450: 2070 6861 7365 5b3a 2c20 696e 6465 785d   phase[:, index]
-00057460: 203d 206e 702e 616e 676c 6528 7067 7261   = np.angle(pgra
-00057470: 6d5b 3a2c 2069 2c20 6a5d 290a 0a20 2020  m[:, i, j])..   
-00057480: 2073 7065 6320 3d20 7370 6563 202f 2075   spec = spec / u
-00057490: 320a 2020 2020 7370 6563 203d 2073 7065  2.    spec = spe
-000574a0: 632e 7371 7565 657a 6528 290a 0a20 2020  c.squeeze()..   
-000574b0: 2072 6573 756c 7473 203d 207b 0a20 2020   results = {.   
-000574c0: 2020 2020 2027 6672 6571 273a 2066 7265       'freq': fre
-000574d0: 712c 0a20 2020 2020 2020 2027 7370 6563  q,.        'spec
-000574e0: 273a 2073 7065 632c 0a20 2020 2020 2020  ': spec,.       
-000574f0: 2027 636f 6827 3a20 636f 682c 0a20 2020   'coh': coh,.   
-00057500: 2020 2020 2027 7068 6173 6527 3a20 7068       'phase': ph
-00057510: 6173 652c 0a20 2020 2020 2020 2027 6b65  ase,.        'ke
-00057520: 726e 656c 273a 206b 6572 6e65 6c2c 0a20  rnel': kernel,. 
-00057530: 2020 2020 2020 2027 6466 273a 2064 662c         'df': df,
-00057540: 0a20 2020 2020 2020 2027 6261 6e64 7769  .        'bandwi
-00057550: 6474 6827 3a20 6261 6e64 7769 6474 682c  dth': bandwidth,
-00057560: 0a20 2020 2020 2020 2027 6e2e 7573 6564  .        'n.used
-00057570: 273a 204e 2c0a 2020 2020 2020 2020 276f  ': N,.        'o
-00057580: 7269 672e 6e27 3a20 4e30 2c0a 2020 2020  rig.n': N0,.    
-00057590: 2020 2020 2774 6170 6572 273a 2074 6170      'taper': tap
-000575a0: 6572 2c0a 2020 2020 2020 2020 2770 6164  er,.        'pad
-000575b0: 273a 2070 6164 2c0a 2020 2020 2020 2020  ': pad,.        
-000575c0: 2764 6574 7265 6e64 273a 2064 6574 7265  'detrend': detre
-000575d0: 6e64 2c0a 2020 2020 2020 2020 2764 656d  nd,.        'dem
-000575e0: 6561 6e27 3a20 6465 6d65 616e 2c0a 2020  ean': demean,.  
-000575f0: 2020 2020 2020 276d 6574 686f 6427 3a20        'method': 
-00057600: 2752 6177 2050 6572 696f 646f 6772 616d  'Raw Periodogram
-00057610: 2720 6966 206b 6572 6e65 6c20 6973 204e  ' if kernel is N
-00057620: 6f6e 6520 656c 7365 2027 536d 6f6f 7468  one else 'Smooth
-00057630: 6564 2050 6572 696f 646f 6772 616d 270a  ed Periodogram'.
-00057640: 2020 2020 7d0a 0a20 2020 2069 6620 706c      }..    if pl
-00057650: 6f74 3a0a 2020 2020 2020 2020 706c 6f74  ot:.        plot
-00057660: 5f73 7065 6328 7265 7375 6c74 732c 2063  _spec(results, c
-00057670: 6f76 6572 6167 653d 302e 3935 2c20 2a2a  overage=0.95, **
-00057680: 6b77 6172 6773 290a 0a20 2020 2072 6574  kwargs)..    ret
-00057690: 7572 6e20 7265 7375 6c74 730a 0a64 6566  urn results..def
-000576a0: 2061 6c66 666d 6170 2820 782c 2066 6c6f   alffmap( x, flo
-000576b0: 3d30 2e30 312c 2066 6869 3d30 2e31 2c20  =0.01, fhi=0.1, 
-000576c0: 7472 3d31 2c20 6465 7472 656e 6420 3d20  tr=1, detrend = 
-000576d0: 5472 7565 2029 3a0a 2020 2020 2222 220a  True ):.    """.
-000576e0: 2020 2020 416d 706c 6974 7564 6520 6f66      Amplitude of
-000576f0: 204c 6f77 2046 7265 7175 656e 6379 2046   Low Frequency F
-00057700: 6c75 6374 7561 7469 6f6e 7320 2841 4c46  luctuations (ALF
-00057710: 463b 205a 616e 6720 6574 2061 6c2e 2c20  F; Zang et al., 
-00057720: 3230 3037 2920 616e 640a 2020 2020 6672  2007) and.    fr
-00057730: 6163 7469 6f6e 616c 2041 6d70 6c69 7475  actional Amplitu
-00057740: 6465 206f 6620 4c6f 7720 4672 6571 7565  de of Low Freque
-00057750: 6e63 7920 466c 7563 7475 6174 696f 6e73  ncy Fluctuations
-00057760: 2028 662f 414c 4646 3b20 5a6f 7520 6574   (f/ALFF; Zou et
-00057770: 2061 6c2e 2c20 3230 3038 290a 2020 2020   al., 2008).    
-00057780: 6172 6520 7265 6c61 7465 6420 6d65 6173  are related meas
-00057790: 7572 6573 2074 6861 7420 7175 616e 7469  ures that quanti
-000577a0: 6679 2074 6865 2061 6d70 6c69 7475 6465  fy the amplitude
-000577b0: 206f 6620 6c6f 7720 6672 6571 7565 6e63   of low frequenc
-000577c0: 790a 2020 2020 6f73 6369 6c6c 6174 696f  y.    oscillatio
-000577d0: 6e73 2028 4c46 4f73 292e 2020 5468 6973  ns (LFOs).  This
-000577e0: 2066 756e 6374 696f 6e20 6f75 7470 7574   function output
-000577f0: 7320 414c 4646 2061 6e64 2066 414c 4646  s ALFF and fALFF
-00057800: 2066 6f72 2074 6865 2069 6e70 7574 2e0a   for the input..
-00057810: 2020 2020 7361 6d65 2066 756e 6374 696f      same functio
-00057820: 6e20 696e 2041 4e54 7352 2e0a 0a20 2020  n in ANTsR...   
-00057830: 2078 2069 6e70 7574 2076 6563 746f 7220   x input vector 
-00057840: 666f 7220 7468 6520 7469 6d65 2073 6572  for the time ser
-00057850: 6965 7320 6f66 2069 6e74 6572 6573 740a  ies of interest.
-00057860: 2020 2020 666c 6f20 6c6f 7720 6672 6571      flo low freq
-00057870: 7565 6e63 792c 2074 7970 6963 616c 6c79  uency, typically
-00057880: 2030 2e30 310a 2020 2020 6668 6920 6869   0.01.    fhi hi
-00057890: 6768 2066 7265 7175 656e 6379 2c20 7479  gh frequency, ty
-000578a0: 7069 6361 6c6c 7920 302e 310a 2020 2020  pically 0.1.    
-000578b0: 7472 2074 6865 2070 6572 696f 6420 6173  tr the period as
-000578c0: 736f 6369 6174 6564 2077 6974 6820 7468  sociated with th
-000578d0: 6520 7665 6374 6f72 2078 2028 696e 7665  e vector x (inve
-000578e0: 7273 6520 6f66 2066 7265 7175 656e 6379  rse of frequency
-000578f0: 290a 2020 2020 6465 7472 656e 6420 6465  ).    detrend de
-00057900: 7472 656e 6420 7468 6520 696e 7075 7420  trend the input 
-00057910: 7469 6d65 2073 6572 6965 730a 0a20 2020  time series..   
-00057920: 2072 6574 7572 6e20 7665 6374 6f72 2069   return vector i
-00057930: 7320 6f75 7470 7574 2073 686f 7769 6e67  s output showing
-00057940: 2041 4c46 4620 616e 6420 6641 4c46 4620   ALFF and fALFF 
-00057950: 7661 6c75 6573 0a20 2020 2022 2222 0a20  values.    """. 
-00057960: 2020 2074 656d 7020 3d20 7370 6563 5f70     temp = spec_p
-00057970: 6772 616d 2820 782c 2078 6672 6571 3d31  gram( x, xfreq=1
-00057980: 2e30 2f74 722c 2064 656d 6561 6e3d 4661  .0/tr, demean=Fa
-00057990: 6c73 652c 2064 6574 7265 6e64 3d64 6574  lse, detrend=det
-000579a0: 7265 6e64 2c20 7461 7065 723d 302c 2066  rend, taper=0, f
-000579b0: 6173 743d 5472 7565 2c20 706c 6f74 3d46  ast=True, plot=F
-000579c0: 616c 7365 2029 0a20 2020 2066 7365 6c65  alse ).    fsele
-000579d0: 6374 203d 206e 702e 6c6f 6769 6361 6c5f  ct = np.logical_
-000579e0: 616e 6428 2074 656d 705b 2766 7265 7127  and( temp['freq'
-000579f0: 5d20 3e3d 2066 6c6f 2c20 7465 6d70 5b27  ] >= flo, temp['
-00057a00: 6672 6571 275d 203c 3d20 6668 6920 290a  freq'] <= fhi ).
-00057a10: 2020 2020 6465 6e6f 6d20 3d20 2874 656d      denom = (tem
-00057a20: 705b 2773 7065 6327 5d29 2e73 756d 2829  p['spec']).sum()
-00057a30: 0a20 2020 206e 756d 6572 203d 2028 7465  .    numer = (te
-00057a40: 6d70 5b27 7370 6563 275d 5b66 7365 6c65  mp['spec'][fsele
-00057a50: 6374 5d29 2e73 756d 2829 0a20 2020 2072  ct]).sum().    r
-00057a60: 6574 7572 6e20 7b20 2027 616c 6666 273a  eturn {  'alff':
-00057a70: 6e75 6d65 722c 2027 6661 6c66 6627 3a20  numer, 'falff': 
-00057a80: 6e75 6d65 722f 6465 6e6f 6d20 7d0a 0a0a  numer/denom }...
-00057a90: 6465 6620 616c 6666 5f69 6d61 6765 2820  def alff_image( 
-00057aa0: 782c 206d 6173 6b2c 2066 6c6f 3d30 2e30  x, mask, flo=0.0
-00057ab0: 312c 2066 6869 3d30 2e31 2c20 6e75 6973  1, fhi=0.1, nuis
-00057ac0: 616e 6365 3d4e 6f6e 6520 293a 0a20 2020  ance=None ):.   
-00057ad0: 2022 2222 0a20 2020 2041 6d70 6c69 7475   """.    Amplitu
-00057ae0: 6465 206f 6620 4c6f 7720 4672 6571 7565  de of Low Freque
-00057af0: 6e63 7920 466c 7563 7475 6174 696f 6e73  ncy Fluctuations
-00057b00: 2028 414c 4646 3b20 5a61 6e67 2065 7420   (ALFF; Zang et 
-00057b10: 616c 2e2c 2032 3030 3729 2061 6e64 0a20  al., 2007) and. 
-00057b20: 2020 2066 7261 6374 696f 6e61 6c20 416d     fractional Am
-00057b30: 706c 6974 7564 6520 6f66 204c 6f77 2046  plitude of Low F
-00057b40: 7265 7175 656e 6379 2046 6c75 6374 7561  requency Fluctua
-00057b50: 7469 6f6e 7320 2866 2f41 4c46 463b 205a  tions (f/ALFF; Z
-00057b60: 6f75 2065 7420 616c 2e2c 2032 3030 3829  ou et al., 2008)
-00057b70: 0a20 2020 2061 7265 2072 656c 6174 6564  .    are related
-00057b80: 206d 6561 7375 7265 7320 7468 6174 2071   measures that q
-00057b90: 7561 6e74 6966 7920 7468 6520 616d 706c  uantify the ampl
-00057ba0: 6974 7564 6520 6f66 206c 6f77 2066 7265  itude of low fre
-00057bb0: 7175 656e 6379 0a20 2020 206f 7363 696c  quency.    oscil
-00057bc0: 6c61 7469 6f6e 7320 284c 464f 7329 2e20  lations (LFOs). 
-00057bd0: 2054 6869 7320 6675 6e63 7469 6f6e 206f   This function o
-00057be0: 7574 7075 7473 2041 4c46 4620 616e 6420  utputs ALFF and 
-00057bf0: 6641 4c46 4620 666f 7220 7468 6520 696e  fALFF for the in
-00057c00: 7075 742e 0a0a 2020 2020 7820 2d20 696e  put...    x - in
-00057c10: 7075 7420 636c 6561 6e20 7265 7374 696e  put clean restin
-00057c20: 6720 7374 6174 6520 666d 7269 0a20 2020  g state fmri.   
-00057c30: 206d 6173 6b20 2d20 6d61 736b 206f 7665   mask - mask ove
-00057c40: 7220 7768 6963 6820 746f 2063 6f6d 7075  r which to compu
-00057c50: 7465 2066 2f61 6c66 660a 2020 2020 666c  te f/alff.    fl
-00057c60: 6f20 2d20 6c6f 7720 6672 6571 7565 6e63  o - low frequenc
-00057c70: 792c 2074 7970 6963 616c 6c79 2030 2e30  y, typically 0.0
-00057c80: 310a 2020 2020 6668 6920 2d20 6869 6768  1.    fhi - high
-00057c90: 2066 7265 7175 656e 6379 2c20 7479 7069   frequency, typi
-00057ca0: 6361 6c6c 7920 302e 310a 2020 2020 6e75  cally 0.1.    nu
-00057cb0: 6973 616e 6365 202d 206f 7074 696f 6e61  isance - optiona
-00057cc0: 6c20 6e75 6973 616e 6365 206d 6174 7269  l nuisance matri
-00057cd0: 780a 0a20 2020 2072 6574 7572 6e20 6469  x..    return di
-00057ce0: 6374 696f 6e61 7279 2077 6974 6820 414c  ctionary with AL
-00057cf0: 4646 2061 6e64 2066 414c 4646 2069 6d61  FF and fALFF ima
-00057d00: 6765 730a 2020 2020 2222 220a 2020 2020  ges.    """.    
-00057d10: 786d 6174 203d 2061 6e74 732e 7469 6d65  xmat = ants.time
-00057d20: 7365 7269 6573 5f74 6f5f 6d61 7472 6978  series_to_matrix
-00057d30: 2820 782c 206d 6173 6b20 290a 2020 2020  ( x, mask ).    
-00057d40: 6966 206e 7569 7361 6e63 6520 6973 206e  if nuisance is n
-00057d50: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00057d60: 2078 6d61 7420 3d20 616e 7473 2e72 6567   xmat = ants.reg
-00057d70: 7265 7373 5f63 6f6d 706f 6e65 6e74 7328  ress_components(
-00057d80: 2078 6d61 742c 206e 7569 7361 6e63 6520   xmat, nuisance 
-00057d90: 290a 2020 2020 616c 6666 7665 6320 3d20  ).    alffvec = 
-00057da0: 786d 6174 5b30 2c3a 5d2a 300a 2020 2020  xmat[0,:]*0.    
-00057db0: 6661 6c66 6676 6563 203d 2078 6d61 745b  falffvec = xmat[
-00057dc0: 302c 3a5d 2a30 0a20 2020 206d 7974 7220  0,:]*0.    mytr 
-00057dd0: 3d20 616e 7473 2e67 6574 5f73 7061 6369  = ants.get_spaci
-00057de0: 6e67 2820 7820 295b 335d 0a20 2020 2066  ng( x )[3].    f
-00057df0: 6f72 206e 2069 6e20 7261 6e67 6528 2078  or n in range( x
-00057e00: 6d61 742e 7368 6170 655b 315d 2029 3a0a  mat.shape[1] ):.
-00057e10: 2020 2020 2020 2020 7465 6d70 203d 2061          temp = a
-00057e20: 6c66 666d 6170 2820 786d 6174 5b3a 2c6e  lffmap( xmat[:,n
-00057e30: 5d2c 2066 6c6f 3d66 6c6f 2c20 6668 693d  ], flo=flo, fhi=
-00057e40: 6668 692c 2074 723d 6d79 7472 2029 0a20  fhi, tr=mytr ). 
-00057e50: 2020 2020 2020 2061 6c66 6676 6563 5b6e         alffvec[n
-00057e60: 5d3d 7465 6d70 5b27 616c 6666 275d 0a20  ]=temp['alff']. 
-00057e70: 2020 2020 2020 2066 616c 6666 7665 635b         falffvec[
-00057e80: 6e5d 3d74 656d 705b 2766 616c 6666 275d  n]=temp['falff']
-00057e90: 0a20 2020 2061 6c66 6669 3d61 6e74 732e  .    alffi=ants.
-00057ea0: 6d61 6b65 5f69 6d61 6765 2820 6d61 736b  make_image( mask
-00057eb0: 2c20 616c 6666 7665 6320 290a 2020 2020  , alffvec ).    
-00057ec0: 6661 6c66 6669 3d61 6e74 732e 6d61 6b65  falffi=ants.make
-00057ed0: 5f69 6d61 6765 2820 6d61 736b 2c20 6661  _image( mask, fa
-00057ee0: 6c66 6676 6563 2029 0a20 2020 2061 6c66  lffvec ).    alf
-00057ef0: 6674 7269 6d6d 6564 6d65 616e 203d 2063  ftrimmedmean = c
-00057f00: 616c 6375 6c61 7465 5f74 7269 6d6d 6564  alculate_trimmed
-00057f10: 5f6d 6561 6e28 2061 6c66 6676 6563 2c20  _mean( alffvec, 
-00057f20: 302e 3031 2029 0a20 2020 2066 616c 6666  0.01 ).    falff
-00057f30: 7472 696d 6d65 646d 6561 6e20 3d20 6361  trimmedmean = ca
-00057f40: 6c63 756c 6174 655f 7472 696d 6d65 645f  lculate_trimmed_
-00057f50: 6d65 616e 2820 6661 6c66 6676 6563 2c20  mean( falffvec, 
-00057f60: 302e 3031 2029 0a20 2020 2061 6c66 6669  0.01 ).    alffi
-00057f70: 3d61 6c66 6669 202f 2061 6c66 6674 7269  =alffi / alfftri
-00057f80: 6d6d 6564 6d65 616e 0a20 2020 2066 616c  mmedmean.    fal
-00057f90: 6666 693d 6661 6c66 6669 202f 2066 616c  ffi=falffi / fal
-00057fa0: 6666 7472 696d 6d65 646d 6561 6e0a 2020  fftrimmedmean.  
-00057fb0: 2020 7265 7475 726e 207b 2020 2761 6c66    return {  'alf
-00057fc0: 6627 3a20 616c 6666 692c 2027 6661 6c66  f': alffi, 'falf
-00057fd0: 6627 3a20 6661 6c66 6669 207d 0a0a 0a64  f': falffi }...d
-00057fe0: 6566 2064 6f77 6e32 6973 6f28 2078 2c20  ef down2iso( x, 
-00057ff0: 696e 7465 7270 6f6c 6174 696f 6e3d 276c  interpolation='l
-00058000: 696e 6561 7227 2c20 7461 6b65 6d69 6e3d  inear', takemin=
-00058010: 4661 6c73 6520 293a 0a20 2020 2022 2222  False ):.    """
-00058020: 0a20 2020 2077 696c 6c20 646f 776e 7361  .    will downsa
-00058030: 6d70 6c65 2061 6e20 616e 6973 6f74 726f  mple an anisotro
-00058040: 7069 6320 696d 6167 6520 746f 2061 6e20  pic image to an 
-00058050: 6973 6f74 726f 7069 6320 7265 736f 6c75  isotropic resolu
-00058060: 7469 6f6e 0a0a 2020 2020 783a 2069 6e70  tion..    x: inp
-00058070: 7574 2069 6d61 6765 0a0a 2020 2020 696e  ut image..    in
-00058080: 7465 7270 6f6c 6174 696f 6e3a 206c 696e  terpolation: lin
-00058090: 6561 7220 6f72 206e 6561 7265 7374 6e65  ear or nearestne
-000580a0: 6967 6862 6f72 0a0a 2020 2020 7461 6b65  ighbor..    take
-000580b0: 6d69 6e20 3a20 626f 6f6c 6561 6e20 6d61  min : boolean ma
-000580c0: 7020 746f 206d 696e 2073 7061 6365 3b20  p to min space; 
-000580d0: 6f74 6865 7277 6973 6520 6d61 780a 0a20  otherwise max.. 
-000580e0: 2020 2072 6574 7572 6e20 696d 6167 6520     return image 
-000580f0: 646f 776e 7361 6d70 6c65 6420 746f 2069  downsampled to i
-00058100: 736f 7472 6f70 6963 2072 6573 6f6c 7574  sotropic resolut
-00058110: 696f 6e0a 2020 2020 2222 220a 2020 2020  ion.    """.    
-00058120: 7370 6320 3d20 616e 7473 2e67 6574 5f73  spc = ants.get_s
-00058130: 7061 6369 6e67 2820 7820 290a 2020 2020  pacing( x ).    
-00058140: 6966 2074 616b 656d 696e 3a0a 2020 2020  if takemin:.    
-00058150: 2020 2020 6e65 7773 7063 203d 206e 702e      newspc = np.
-00058160: 6173 6172 7261 7928 7370 6329 2e6d 696e  asarray(spc).min
-00058170: 2829 0a20 2020 2065 6c73 653a 0a20 2020  ().    else:.   
-00058180: 2020 2020 206e 6577 7370 6320 3d20 6e70       newspc = np
-00058190: 2e61 7361 7272 6179 2873 7063 292e 6d61  .asarray(spc).ma
-000581a0: 7828 290a 2020 2020 6e65 7773 7063 203d  x().    newspc =
-000581b0: 206e 702e 7265 7065 6174 2820 6e65 7773   np.repeat( news
-000581c0: 7063 2c20 782e 6469 6d65 6e73 696f 6e20  pc, x.dimension 
-000581d0: 290a 2020 2020 6966 2069 6e74 6572 706f  ).    if interpo
-000581e0: 6c61 7469 6f6e 203d 3d20 276c 696e 6561  lation == 'linea
-000581f0: 7227 3a0a 2020 2020 2020 2020 7873 203d  r':.        xs =
-00058200: 2061 6e74 732e 7265 7361 6d70 6c65 5f69   ants.resample_i
-00058210: 6d61 6765 2820 782c 206e 6577 7370 632c  mage( x, newspc,
-00058220: 2069 6e74 6572 705f 7479 7065 3d30 290a   interp_type=0).
-00058230: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00058240: 2020 7873 203d 2061 6e74 732e 7265 7361    xs = ants.resa
-00058250: 6d70 6c65 5f69 6d61 6765 2820 782c 206e  mple_image( x, n
-00058260: 6577 7370 632c 2069 6e74 6572 705f 7479  ewspc, interp_ty
-00058270: 7065 3d31 290a 2020 2020 7265 7475 726e  pe=1).    return
-00058280: 2078 730a 0a0a 6465 6620 7265 6164 5f6d   xs...def read_m
-00058290: 6d5f 6373 7628 2078 2c20 6973 5f74 313d  m_csv( x, is_t1=
-000582a0: 4661 6c73 652c 2063 6f6c 7072 6566 6978  False, colprefix
-000582b0: 3d4e 6f6e 652c 2073 6570 6172 6174 6f72  =None, separator
-000582c0: 3d27 2d27 2c20 7665 7262 6f73 653d 4661  ='-', verbose=Fa
-000582d0: 6c73 6520 293a 0a20 2020 2073 706c 6974  lse ):.    split
-000582e0: 7465 723d 6f73 2e70 6174 682e 6261 7365  ter=os.path.base
-000582f0: 6e61 6d65 2878 292e 7370 6c69 7428 2073  name(x).split( s
-00058300: 6570 6172 6174 6f72 2029 0a20 2020 206c  eparator ).    l
-00058310: 656e 7370 6c69 7420 3d20 6c65 6e28 2073  ensplit = len( s
-00058320: 706c 6974 7465 7220 292d 310a 2020 2020  plitter )-1.    
-00058330: 7465 6d70 203d 206f 732e 7061 7468 2e62  temp = os.path.b
-00058340: 6173 656e 616d 6528 7829 0a20 2020 2074  asename(x).    t
-00058350: 656d 7020 3d20 6f73 2e70 6174 682e 7370  emp = os.path.sp
-00058360: 6c69 7465 7874 2874 656d 7029 5b30 5d0a  litext(temp)[0].
-00058370: 2020 2020 7465 6d70 203d 2072 652e 7375      temp = re.su
-00058380: 6228 7365 7061 7261 746f 722b 276d 6d77  b(separator+'mmw
-00058390: 6964 6527 2c27 272c 7465 6d70 290a 2020  ide','',temp).  
-000583a0: 2020 6964 636f 6c73 203d 205b 2775 5f68    idcols = ['u_h
-000583b0: 6965 725f 6964 272c 2773 6964 272c 2776  ier_id','sid','v
-000583c0: 6973 6974 6461 7465 272c 276d 6f64 616c  isitdate','modal
-000583d0: 6974 7927 2c27 6d6d 696d 6167 6575 6964  ity','mmimageuid
-000583e0: 272c 2774 3169 6d61 6765 7569 6427 5d0a  ','t1imageuid'].
-000583f0: 2020 2020 6466 203d 2070 642e 4461 7461      df = pd.Data
-00058400: 4672 616d 6528 2063 6f6c 756d 6e73 203d  Frame( columns =
-00058410: 2069 6463 6f6c 732c 2069 6e64 6578 3d72   idcols, index=r
-00058420: 616e 6765 2831 2920 290a 2020 2020 7661  ange(1) ).    va
-00058430: 6c73 746f 6164 6420 3d20 5b74 656d 705d  lstoadd = [temp]
-00058440: 202b 2073 706c 6974 7465 725b 313a 286c   + splitter[1:(l
-00058450: 656e 7370 6c69 742d 3129 5d0a 2020 2020  ensplit-1)].    
-00058460: 6966 2069 735f 7431 3a0a 2020 2020 2020  if is_t1:.      
-00058470: 2020 7661 6c73 746f 6164 6420 3d20 7661    valstoadd = va
-00058480: 6c73 746f 6164 6420 2b20 5b73 706c 6974  lstoadd + [split
-00058490: 7465 725b 286c 656e 7370 6c69 742d 3129  ter[(lensplit-1)
-000584a0: 5d2c 7370 6c69 7474 6572 5b28 6c65 6e73  ],splitter[(lens
-000584b0: 706c 6974 2d31 295d 5d0a 2020 2020 656c  plit-1)]].    el
-000584c0: 7365 3a0a 2020 2020 2020 2020 7370 6c69  se:.        spli
-000584d0: 7432 3d73 706c 6974 7465 725b 286c 656e  t2=splitter[(len
-000584e0: 7370 6c69 742d 3129 5d2e 7370 6c69 7428  split-1)].split(
-000584f0: 2022 5f22 2029 0a20 2020 2020 2020 2069   "_" ).        i
-00058500: 6620 6c65 6e28 7370 6c69 7432 2920 3d3d  f len(split2) ==
-00058510: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-00058520: 7370 6c69 7432 2e61 7070 656e 6428 2073  split2.append( s
-00058530: 706c 6974 325b 305d 2029 0a20 2020 2020  plit2[0] ).     
-00058540: 2020 2069 6620 6c65 6e28 7661 6c73 746f     if len(valsto
-00058550: 6164 6429 203d 3d20 333a 0a20 2020 2020  add) == 3:.     
-00058560: 2020 2020 2020 2076 616c 7374 6f61 6464         valstoadd
-00058570: 203d 2076 616c 7374 6f61 6464 202b 205b   = valstoadd + [
-00058580: 7370 6c69 7432 5b30 5d5d 202b 205b 6d61  split2[0]] + [ma
-00058590: 7468 2e6e 616e 5d20 2b20 5b73 706c 6974  th.nan] + [split
-000585a0: 325b 315d 5d0a 2020 2020 2020 2020 656c  2[1]].        el
-000585b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000585c0: 7661 6c73 746f 6164 6420 3d20 7661 6c73  valstoadd = vals
-000585d0: 746f 6164 6420 2b20 5b73 706c 6974 325b  toadd + [split2[
-000585e0: 305d 2c73 706c 6974 325b 315d 5d0a 2020  0],split2[1]].  
-000585f0: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-00058600: 2020 2020 2020 7072 696e 7428 2076 616c        print( val
-00058610: 7374 6f61 6464 2029 0a20 2020 2064 662e  stoadd ).    df.
-00058620: 696c 6f63 5b30 5d20 3d20 7661 6c73 746f  iloc[0] = valsto
-00058630: 6164 640a 2020 2020 6966 2076 6572 626f  add.    if verbo
-00058640: 7365 3a0a 2020 2020 2020 2020 7072 696e  se:.        prin
-00058650: 7428 2022 7265 6164 2078 6466 3a20 2220  t( "read xdf: " 
-00058660: 2b20 7820 290a 2020 2020 7864 6620 3d20  + x ).    xdf = 
-00058670: 7064 2e72 6561 645f 6373 7628 2078 2029  pd.read_csv( x )
-00058680: 0a20 2020 2064 662e 7265 7365 745f 696e  .    df.reset_in
-00058690: 6465 7828 290a 2020 2020 7864 662e 7265  dex().    xdf.re
-000586a0: 7365 745f 696e 6465 7828 6472 6f70 3d54  set_index(drop=T
-000586b0: 7275 6529 0a20 2020 2069 6620 2255 6e6e  rue).    if "Unn
-000586c0: 616d 6564 3a20 3022 2069 6e20 7864 662e  amed: 0" in xdf.
-000586d0: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
-000586e0: 2068 6f6c 6465 723d 7864 662e 706f 7028   holder=xdf.pop(
-000586f0: 2022 556e 6e61 6d65 643a 2030 2220 290a   "Unnamed: 0" ).
-00058700: 2020 2020 6966 2022 556e 6e61 6d65 643a      if "Unnamed:
-00058710: 2031 2220 696e 2078 6466 2e63 6f6c 756d   1" in xdf.colum
-00058720: 6e73 3a0a 2020 2020 2020 2020 686f 6c64  ns:.        hold
-00058730: 6572 3d78 6466 2e70 6f70 2820 2255 6e6e  er=xdf.pop( "Unn
-00058740: 616d 6564 3a20 3122 2029 0a20 2020 2069  amed: 1" ).    i
-00058750: 6620 2275 5f68 6965 725f 6964 2e31 2220  f "u_hier_id.1" 
-00058760: 696e 2078 6466 2e63 6f6c 756d 6e73 3a0a  in xdf.columns:.
-00058770: 2020 2020 2020 2020 686f 6c64 6572 3d78          holder=x
-00058780: 6466 2e70 6f70 2820 2275 5f68 6965 725f  df.pop( "u_hier_
-00058790: 6964 2e31 2220 290a 2020 2020 6966 2022  id.1" ).    if "
-000587a0: 755f 6869 6572 5f69 6422 2069 6e20 7864  u_hier_id" in xd
-000587b0: 662e 636f 6c75 6d6e 733a 0a20 2020 2020  f.columns:.     
-000587c0: 2020 2068 6f6c 6465 723d 7864 662e 706f     holder=xdf.po
-000587d0: 7028 2022 755f 6869 6572 5f69 6422 2029  p( "u_hier_id" )
-000587e0: 0a20 2020 2069 6620 6e6f 7420 6973 5f74  .    if not is_t
-000587f0: 313a 0a20 2020 2020 2020 2069 6620 2772  1:.        if 'r
-00058800: 6573 6e65 7447 7261 6465 2720 696e 2078  esnetGrade' in x
-00058810: 6466 2e63 6f6c 756d 6e73 3a0a 2020 2020  df.columns:.    
-00058820: 2020 2020 2020 2020 696e 6465 785f 6e6f          index_no
-00058830: 203d 2078 6466 2e63 6f6c 756d 6e73 2e67   = xdf.columns.g
-00058840: 6574 5f6c 6f63 2827 7265 736e 6574 4772  et_loc('resnetGr
-00058850: 6164 6527 290a 2020 2020 2020 2020 2020  ade').          
-00058860: 2020 7864 6620 3d20 7864 662e 6472 6f70    xdf = xdf.drop
-00058870: 2820 7864 662e 636f 6c75 6d6e 735b 7261  ( xdf.columns[ra
-00058880: 6e67 6528 696e 6465 785f 6e6f 2b31 295d  nge(index_no+1)]
-00058890: 202c 2061 7869 733d 3129 0a0a 2020 2020   , axis=1)..    
-000588a0: 6966 2078 6466 2e73 6861 7065 5b30 5d20  if xdf.shape[0] 
-000588b0: 3d3d 2032 3a0a 2020 2020 2020 2020 7864  == 2:.        xd
-000588c0: 6663 6f6c 7320 3d20 7864 662e 636f 6c75  fcols = xdf.colu
-000588d0: 6d6e 730a 2020 2020 2020 2020 7864 6620  mns.        xdf 
-000588e0: 3d20 7864 662e 696c 6f63 5b31 5d0a 2020  = xdf.iloc[1].  
-000588f0: 2020 2020 2020 6464 6e75 6d20 3d20 7864        ddnum = xd
-00058900: 662e 746f 5f6e 756d 7079 2829 0a20 2020  f.to_numpy().   
-00058910: 2020 2020 2064 646e 756d 203d 2064 646e       ddnum = ddn
-00058920: 756d 2e72 6573 6861 7065 285b 312c 6464  um.reshape([1,dd
-00058930: 6e75 6d2e 7368 6170 655b 305d 5d29 0a20  num.shape[0]]). 
-00058940: 2020 2020 2020 206e 6577 636f 6c6e 616d         newcolnam
-00058950: 6573 203d 2078 6466 2e69 6e64 6578 2e74  es = xdf.index.t
-00058960: 6f5f 6c69 7374 2829 0a20 2020 2020 2020  o_list().       
-00058970: 2069 6620 6c65 6e28 6e65 7763 6f6c 6e61   if len(newcolna
-00058980: 6d65 7329 2021 3d20 6464 6e75 6d2e 7368  mes) != ddnum.sh
-00058990: 6170 655b 315d 3a0a 2020 2020 2020 2020  ape[1]:.        
-000589a0: 2020 2020 7072 696e 7428 2243 616e 6e6f      print("Canno
-000589b0: 7420 4d65 7267 6520 3a20 5368 6170 6520  t Merge : Shape 
-000589c0: 4d69 734d 6174 6368 2022 202b 2073 7472  MisMatch " + str
-000589d0: 2820 6c65 6e28 6e65 7763 6f6c 6e61 6d65  ( len(newcolname
-000589e0: 7329 2029 202b 2022 2022 202b 2073 7472  s) ) + " " + str
-000589f0: 2864 646e 756d 2e73 6861 7065 5b31 5d29  (ddnum.shape[1])
-00058a00: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00058a10: 2020 2020 2020 2020 2020 2020 7864 6620              xdf 
-00058a20: 3d20 7064 2e44 6174 6146 7261 6d65 2864  = pd.DataFrame(d
-00058a30: 646e 756d 2c20 636f 6c75 6d6e 733d 7864  dnum, columns=xd
-00058a40: 6663 6f6c 7320 290a 2020 2020 6966 2078  fcols ).    if x
-00058a50: 6466 2e73 6861 7065 5b31 5d20 3d3d 2030  df.shape[1] == 0
-00058a60: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00058a70: 204e 6f6e 650a 2020 2020 6966 2063 6f6c   None.    if col
-00058a80: 7072 6566 6978 2069 7320 6e6f 7420 4e6f  prefix is not No
-00058a90: 6e65 3a0a 2020 2020 2020 2020 7864 662e  ne:.        xdf.
-00058aa0: 636f 6c75 6d6e 733d 636f 6c70 7265 6669  columns=colprefi
-00058ab0: 7820 2b20 7864 662e 636f 6c75 6d6e 730a  x + xdf.columns.
-00058ac0: 2020 2020 7265 7475 726e 2070 642e 636f      return pd.co
-00058ad0: 6e63 6174 2820 5b64 662c 7864 665d 2c20  ncat( [df,xdf], 
-00058ae0: 6178 6973 3d31 2c20 6967 6e6f 7265 5f69  axis=1, ignore_i
-00058af0: 6e64 6578 3d46 616c 7365 2029 0a0a 6465  ndex=False )..de
-00058b00: 6620 6d65 7267 655f 7769 6465 735f 746f  f merge_wides_to
-00058b10: 5f73 7475 6479 5f64 6174 6166 7261 6d65  _study_dataframe
-00058b20: 2820 7364 662c 2070 726f 6365 7373 696e  ( sdf, processin
-00058b30: 675f 6469 722c 2073 6570 6172 6174 6f72  g_dir, separator
-00058b40: 3d27 2d27 2c20 7369 645f 6973 5f69 6e74  ='-', sid_is_int
-00058b50: 3d54 7275 652c 2069 645f 6973 5f69 6e74  =True, id_is_int
-00058b60: 3d54 7275 652c 2064 6174 655f 6973 5f69  =True, date_is_i
-00058b70: 6e74 3d54 7275 652c 2072 6570 6f72 745f  nt=True, report_
-00058b80: 6d69 7373 696e 673d 4661 6c73 652c 0a70  missing=False,.p
-00058b90: 726f 6772 6573 733d 4661 6c73 652c 2076  rogress=False, v
-00058ba0: 6572 626f 7365 3d46 616c 7365 2029 3a0a  erbose=False ):.
-00058bb0: 2020 2020 2222 220a 2020 2020 6578 7465      """.    exte
-00058bc0: 6e64 2061 2073 7475 6479 2064 6174 6120  nd a study data 
-00058bd0: 6672 616d 6520 7769 7468 2077 6964 6520  frame with wide 
-00058be0: 6f75 7470 7574 730a 0a20 2020 2073 6466  outputs..    sdf
-00058bf0: 203a 2074 6865 2069 6e70 7574 2073 7475   : the input stu
-00058c00: 6479 2064 6174 6166 7261 6d65 2066 726f  dy dataframe fro
-00058c10: 6d20 616e 7473 7079 6d6d 2051 4320 6f75  m antspymm QC ou
-00058c20: 7470 7574 0a0a 2020 2020 7072 6f63 6573  tput..    proces
-00058c30: 7369 6e67 5f64 6972 3a20 2074 6865 2064  sing_dir:  the d
-00058c40: 6972 6563 746f 7279 206c 6f63 6174 696f  irectory locatio
-00058c50: 6e20 6f66 2074 6865 2070 726f 6365 7373  n of the process
-00058c60: 6564 2064 6174 6120 0a0a 2020 2020 7365  ed data ..    se
-00058c70: 7061 7261 746f 7220 3a20 7374 7269 6e67  parator : string
-00058c80: 2075 7375 616c 6c79 2027 2d27 206f 7220   usually '-' or 
-00058c90: 275f 270a 0a20 2020 2073 6964 5f69 735f  '_'..    sid_is_
-00058ca0: 696e 7420 3a20 626f 6f6c 6561 6e20 7365  int : boolean se
-00058cb0: 7420 746f 2054 7275 6520 746f 2063 6173  t to True to cas
-00058cc0: 7420 756e 6971 7565 2073 7562 6a65 6374  t unique subject
-00058cd0: 2069 6473 2074 6f20 696e 743b 2063 616e   ids to int; can
-00058ce0: 2062 6520 7573 6566 756c 2069 6620 7468   be useful if th
-00058cf0: 6579 2061 7265 2069 6e61 6476 6572 7465  ey are inadverte
-00058d00: 6e74 6c79 2073 746f 7265 6420 6173 2066  ntly stored as f
-00058d10: 6c6f 6174 2062 7920 7061 6e64 6173 0a0a  loat by pandas..
-00058d20: 2020 2020 6461 7465 5f69 735f 696e 7420      date_is_int 
-00058d30: 3a20 626f 6f6c 6561 6e20 7365 7420 746f  : boolean set to
-00058d40: 2054 7275 6520 746f 2063 6173 7420 6461   True to cast da
-00058d50: 7465 2074 6f20 696e 743b 2063 616e 2062  te to int; can b
-00058d60: 6520 7573 6566 756c 2069 6620 7468 6579  e useful if they
-00058d70: 2061 7265 2069 6e61 6476 6572 7465 6e74   are inadvertent
-00058d80: 6c79 2073 746f 7265 6420 6173 2066 6c6f  ly stored as flo
-00058d90: 6174 2062 7920 7061 6e64 6173 0a0a 2020  at by pandas..  
-00058da0: 2020 6964 5f69 735f 696e 7420 3a20 626f    id_is_int : bo
-00058db0: 6f6c 6561 6e20 7365 7420 746f 2054 7275  olean set to Tru
-00058dc0: 6520 746f 2063 6173 7420 756e 6971 7565  e to cast unique
-00058dd0: 2069 6d61 6765 2069 6473 2074 6f20 696e   image ids to in
-00058de0: 743b 2063 616e 2062 6520 7573 6566 756c  t; can be useful
-00058df0: 2069 6620 7468 6579 2061 7265 2069 6e61   if they are ina
-00058e00: 6476 6572 7465 6e74 6c79 2073 746f 7265  dvertently store
-00058e10: 6420 6173 2066 6c6f 6174 2062 7920 7061  d as float by pa
-00058e20: 6e64 6173 0a0a 2020 2020 7265 706f 7274  ndas..    report
-00058e30: 5f6d 6973 7369 6e67 203a 2062 6f6f 6c65  _missing : boole
-00058e40: 616e 2063 6f6d 6269 6e65 6420 7769 7468  an combined with
-00058e50: 2076 6572 626f 7365 2077 696c 6c20 7265   verbose will re
-00058e60: 706f 7274 206d 6973 7369 6e67 206d 6f64  port missing mod
-00058e70: 616c 6974 6965 730a 0a20 2020 2070 726f  alities..    pro
-00058e80: 6772 6573 7320 3a20 696e 7465 6765 7220  gress : integer 
-00058e90: 7265 706f 7274 7320 7065 7263 656e 7420  reports percent 
-00058ea0: 7072 6f67 7265 7373 206d 6f64 756c 6f20  progress modulo 
-00058eb0: 7072 6f67 7265 7373 2076 616c 7565 200a  progress value .
-00058ec0: 0a20 2020 2076 6572 626f 7365 203a 2062  .    verbose : b
-00058ed0: 6f6f 6c65 616e 0a20 2020 2022 2222 0a20  oolean.    """. 
-00058ee0: 2020 2066 726f 6d20 6f73 2e70 6174 6820     from os.path 
-00058ef0: 696d 706f 7274 2065 7869 7374 730a 2020  import exists.  
-00058f00: 2020 6d75 7374 6861 7665 636f 6c73 203d    musthavecols =
-00058f10: 205b 2770 726f 6a65 6374 4944 272c 2027   ['projectID', '
-00058f20: 7375 626a 6563 7449 4427 2c27 6461 7465  subjectID','date
-00058f30: 272c 2769 6d61 6765 4944 275d 0a20 2020  ','imageID'].   
-00058f40: 2066 6f72 206b 2069 6e20 7261 6e67 6528   for k in range(
-00058f50: 6c65 6e28 6d75 7374 6861 7665 636f 6c73  len(musthavecols
-00058f60: 2929 3a0a 2020 2020 2020 2020 6966 206e  )):.        if n
-00058f70: 6f74 206d 7573 7468 6176 6563 6f6c 735b  ot musthavecols[
-00058f80: 6b5d 2069 6e20 7364 662e 6b65 7973 2829  k] in sdf.keys()
-00058f90: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00058fa0: 6973 6520 5661 6c75 6545 7272 6f72 2827  ise ValueError('
-00058fb0: 7364 6620 6973 206d 6973 7369 6e67 2063  sdf is missing c
-00058fc0: 6f6c 756d 6e20 2720 2b6d 7573 7468 6176  olumn ' +musthav
-00058fd0: 6563 6f6c 735b 6b5d 202b 2027 2069 6e20  ecols[k] + ' in 
-00058fe0: 6d65 7267 655f 7769 6465 735f 746f 5f73  merge_wides_to_s
-00058ff0: 7475 6479 5f64 6174 6166 7261 6d65 2720  tudy_dataframe' 
-00059000: 290a 2020 2020 706f 7373 6962 6c65 5f69  ).    possible_i
-00059010: 6964 7320 3d20 5b20 2769 6d61 6765 4944  ids = [ 'imageID
-00059020: 272c 2027 696d 6167 6549 4427 2c20 2769  ', 'imageID', 'i
-00059030: 6d61 6765 4944 272c 2027 666c 6169 7269  mageID', 'flairi
-00059040: 6427 2c20 2764 7469 6431 272c 2027 6474  d', 'dtid1', 'dt
-00059050: 6964 3227 2c20 2772 7366 6964 3127 2c20  id2', 'rsfid1', 
-00059060: 2772 7366 6964 3227 2c20 276e 6d69 6431  'rsfid2', 'nmid1
-00059070: 272c 2027 6e6d 6964 3227 2c20 276e 6d69  ', 'nmid2', 'nmi
-00059080: 6433 272c 2027 6e6d 6964 3427 2c20 276e  d3', 'nmid4', 'n
-00059090: 6d69 6435 272c 2027 6e6d 6964 3627 2c20  mid5', 'nmid6', 
-000590a0: 276e 6d69 6437 272c 2027 6e6d 6964 3827  'nmid7', 'nmid8'
-000590b0: 2c20 276e 6d69 6439 272c 2027 6e6d 6964  , 'nmid9', 'nmid
-000590c0: 3130 272c 2027 7065 7266 6964 2720 5d0a  10', 'perfid' ].
-000590d0: 2020 2020 6d6f 6461 6c69 7479 5f69 6473      modality_ids
-000590e0: 203d 205b 2027 5431 7748 6965 7261 7263   = [ 'T1wHierarc
-000590f0: 6869 6361 6c27 2c20 2754 3177 4869 6572  hical', 'T1wHier
-00059100: 6172 6368 6963 616c 5352 272c 2027 5431  archicalSR', 'T1
-00059110: 7727 2c20 2754 3246 6c61 6972 272c 2027  w', 'T2Flair', '
-00059120: 4454 4927 2c20 2744 5449 272c 2027 7273  DTI', 'DTI', 'rs
-00059130: 664d 5249 272c 2027 7273 664d 5249 272c  fMRI', 'rsfMRI',
-00059140: 2027 4e4d 3244 4d54 272c 2027 4e4d 3244   'NM2DMT', 'NM2D
-00059150: 4d54 272c 2027 4e4d 3244 4d54 272c 2027  MT', 'NM2DMT', '
-00059160: 4e4d 3244 4d54 272c 2027 4e4d 3244 4d54  NM2DMT', 'NM2DMT
-00059170: 272c 2027 4e4d 3244 4d54 272c 2027 4e4d  ', 'NM2DMT', 'NM
-00059180: 3244 4d54 272c 2027 4e4d 3244 4d54 272c  2DMT', 'NM2DMT',
-00059190: 2027 4e4d 3244 4d54 272c 2027 4e4d 3244   'NM2DMT', 'NM2D
-000591a0: 4d54 272c 2027 7065 7266 275d 0a20 2020  MT', 'perf'].   
-000591b0: 2061 6c6c 6466 3d70 642e 4461 7461 4672   alldf=pd.DataFr
-000591c0: 616d 6528 290a 2020 2020 666f 7220 6d79  ame().    for my
-000591d0: 6b20 696e 2073 6466 2e69 6e64 6578 3a0a  k in sdf.index:.
-000591e0: 2020 2020 2020 2020 6966 2070 726f 6772          if progr
-000591f0: 6573 7320 3e20 3020 616e 6420 696e 7428  ess > 0 and int(
-00059200: 6d79 6b29 2025 2069 6e74 2870 726f 6772  myk) % int(progr
-00059210: 6573 7329 203d 3d20 303a 0a20 2020 2020  ess) == 0:.     
-00059220: 2020 2020 2020 2070 7269 6e74 2820 7374         print( st
-00059230: 7228 2072 6f75 6e64 2820 6d79 6b2f 7364  r( round( myk/sd
-00059240: 662e 7368 6170 655b 305d 2a31 3030 2e30  f.shape[0]*100.0
-00059250: 2929 202b 2022 252e 2e2e 222c 2065 6e64  )) + "%...", end
-00059260: 3d27 272c 2066 6c75 7368 3d54 7275 6529  ='', flush=True)
-00059270: 0a20 2020 2020 2020 2069 6620 7665 7262  .        if verb
-00059280: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-00059290: 2070 7269 6e74 2820 2244 4f52 4f57 2022   print( "DOROW "
-000592a0: 202b 2073 7472 286d 796b 2920 2b20 2720   + str(myk) + ' 
-000592b0: 6f66 2027 202b 2073 7472 2820 7364 662e  of ' + str( sdf.
-000592c0: 7368 6170 655b 305d 2029 2029 0a20 2020  shape[0] ) ).   
-000592d0: 2020 2020 2063 7376 726f 7720 3d20 7364       csvrow = sd
-000592e0: 662e 6c6f 635b 7364 662e 696e 6465 7820  f.loc[sdf.index 
-000592f0: 3d3d 206d 796b 5d2e 6472 6f70 6e61 2861  == myk].dropna(a
-00059300: 7869 733d 3129 0a20 2020 2020 2020 2063  xis=1).        c
-00059310: 743d 2d31 0a20 2020 2020 2020 2066 6f72  t=-1.        for
-00059320: 2069 6964 6b65 7920 696e 2070 6f73 7369   iidkey in possi
-00059330: 626c 655f 6969 6473 3a0a 2020 2020 2020  ble_iids:.      
-00059340: 2020 2020 2020 6374 3d63 742b 310a 2020        ct=ct+1.  
-00059350: 2020 2020 2020 2020 2020 6d6f 645f 6e61            mod_na
-00059360: 6d65 203d 206d 6f64 616c 6974 795f 6964  me = modality_id
-00059370: 735b 6374 5d0a 2020 2020 2020 2020 2020  s[ct].          
-00059380: 2020 6966 2069 6964 6b65 7920 696e 2063    if iidkey in c
-00059390: 7376 726f 772e 6b65 7973 2829 3a0a 2020  svrow.keys():.  
-000593a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000593b0: 2069 645f 6973 5f69 6e74 3a0a 2020 2020   id_is_int:.    
-000593c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000593d0: 6969 6420 3d20 7374 7228 2069 6e74 2820  iid = str( int( 
-000593e0: 6373 7672 6f77 5b69 6964 6b65 795d 2e69  csvrow[iidkey].i
-000593f0: 6c6f 635b 305d 2029 2029 0a20 2020 2020  loc[0] ) ).     
-00059400: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00059410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00059420: 2020 2020 2069 6964 203d 2073 7472 2820       iid = str( 
-00059430: 6373 7672 6f77 5b69 6964 6b65 795d 2e69  csvrow[iidkey].i
-00059440: 6c6f 635b 305d 2029 0a20 2020 2020 2020  loc[0] ).       
-00059450: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
-00059460: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-00059470: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
-00059480: 2269 6964 6b65 7920 2220 2b20 6969 646b  "iidkey " + iidk
-00059490: 6579 202b 2022 206d 6f64 616c 6974 7920  ey + " modality 
-000594a0: 2220 2b20 6d6f 645f 6e61 6d65 202b 2027  " + mod_name + '
-000594b0: 2069 6964 2027 2b20 6969 6420 290a 2020   iid '+ iid ).  
-000594c0: 2020 2020 2020 2020 2020 2020 2020 7069                pi
-000594d0: 643d 7374 7228 6373 7672 6f77 5b27 7072  d=str(csvrow['pr
-000594e0: 6f6a 6563 7449 4427 5d2e 696c 6f63 5b30  ojectID'].iloc[0
-000594f0: 5d20 290a 2020 2020 2020 2020 2020 2020  ] ).            
-00059500: 2020 2020 6966 2073 6964 5f69 735f 696e      if sid_is_in
-00059510: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00059520: 2020 2020 2020 2073 6964 3d73 7472 2869         sid=str(i
-00059530: 6e74 2863 7376 726f 775b 2773 7562 6a65  nt(csvrow['subje
-00059540: 6374 4944 275d 2e69 6c6f 635b 305d 2029  ctID'].iloc[0] )
-00059550: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00059560: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00059570: 2020 2020 2020 2020 2020 2020 7369 643d              sid=
-00059580: 7374 7228 6373 7672 6f77 5b27 7375 626a  str(csvrow['subj
-00059590: 6563 7449 4427 5d2e 696c 6f63 5b30 5d20  ectID'].iloc[0] 
-000595a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000595b0: 2020 6966 2064 6174 655f 6973 5f69 6e74    if date_is_int
-000595c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000595d0: 2020 2020 2020 6474 3d73 7472 2869 6e74        dt=str(int
-000595e0: 2863 7376 726f 775b 2764 6174 6527 5d2e  (csvrow['date'].
-000595f0: 696c 6f63 5b30 5d29 290a 2020 2020 2020  iloc[0])).      
-00059600: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00059610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059620: 2020 2020 6474 3d73 7472 2863 7376 726f      dt=str(csvro
-00059630: 775b 2764 6174 6527 5d2e 696c 6f63 5b30  w['date'].iloc[0
-00059640: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-00059650: 2020 2069 6620 6964 5f69 735f 696e 743a     if id_is_int:
-00059660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00059670: 2020 2020 2074 3169 6964 3d73 7472 2869       t1iid=str(i
-00059680: 6e74 2863 7376 726f 775b 2769 6d61 6765  nt(csvrow['image
-00059690: 4944 275d 2e69 6c6f 635b 305d 2929 0a20  ID'].iloc[0])). 
-000596a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000596b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000596c0: 2020 2020 2020 2020 2074 3169 6964 3d73           t1iid=s
-000596d0: 7472 2863 7376 726f 775b 2769 6d61 6765  tr(csvrow['image
-000596e0: 4944 275d 2e69 6c6f 635b 305d 290a 2020  ID'].iloc[0]).  
-000596f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00059700: 2074 3169 6964 2021 3d20 6969 643a 0a20   t1iid != iid:. 
-00059710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059720: 2020 2069 6964 6a3d 6969 642b 225f 222b     iidj=iid+"_"+
-00059730: 7431 6969 640a 2020 2020 2020 2020 2020  t1iid.          
-00059740: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00059750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059760: 6969 646a 3d69 6964 0a20 2020 2020 2020  iidj=iid.       
-00059770: 2020 2020 2020 2020 2072 6f6f 7469 6420           rootid 
-00059780: 3d20 7069 6420 2b73 6570 6172 6174 6f72  = pid +separator
-00059790: 2b20 7369 6420 2b73 6570 6172 6174 6f72  + sid +separator
-000597a0: 2b64 742b 7365 7061 7261 746f 722b 6d6f  +dt+separator+mo
-000597b0: 645f 6e61 6d65 2b73 6570 6172 6174 6f72  d_name+separator
-000597c0: 2b69 6964 6a0a 2020 2020 2020 2020 2020  +iidj.          
-000597d0: 2020 2020 2020 6d79 6578 7420 3d20 726f        myext = ro
-000597e0: 6f74 6964 202b 7365 7061 7261 746f 722b  otid +separator+
-000597f0: 276d 6d77 6964 652e 6373 7627 0a20 2020  'mmwide.csv'.   
-00059800: 2020 2020 2020 2020 2020 2020 206e 7267               nrg
-00059810: 7769 6465 666e 3d6f 732e 7061 7468 2e6a  widefn=os.path.j
-00059820: 6f69 6e28 2070 726f 6365 7373 696e 675f  oin( processing_
-00059830: 6469 722c 2070 6964 2c20 7369 642c 2064  dir, pid, sid, d
-00059840: 742c 206d 6f64 5f6e 616d 652c 2069 6964  t, mod_name, iid
-00059850: 2c20 6d79 6578 7420 290a 2020 2020 2020  , myext ).      
-00059860: 2020 2020 2020 2020 2020 6d6f 6464 6572            modder
-00059870: 7375 6220 3d20 6d6f 645f 6e61 6d65 0a20  sub = mod_name. 
-00059880: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00059890: 735f 7431 3d46 616c 7365 0a20 2020 2020  s_t1=False.     
-000598a0: 2020 2020 2020 2020 2020 2069 6620 6d6f             if mo
-000598b0: 645f 6e61 6d65 203d 3d20 2754 3177 4869  d_name == 'T1wHi
-000598c0: 6572 6172 6368 6963 616c 273a 0a20 2020  erarchical':.   
-000598d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000598e0: 2069 735f 7431 3d54 7275 650a 2020 2020   is_t1=True.    
-000598f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059900: 6d6f 6464 6572 7375 623d 2754 3148 6965  moddersub='T1Hie
-00059910: 7227 0a20 2020 2020 2020 2020 2020 2020  r'.             
-00059920: 2020 2065 6c69 6620 6d6f 645f 6e61 6d65     elif mod_name
-00059930: 203d 3d20 2754 3177 4869 6572 6172 6368   == 'T1wHierarch
-00059940: 6963 616c 5352 273a 0a20 2020 2020 2020  icalSR':.       
-00059950: 2020 2020 2020 2020 2020 2020 2069 735f               is_
-00059960: 7431 3d54 7275 650a 2020 2020 2020 2020  t1=True.        
-00059970: 2020 2020 2020 2020 2020 2020 6d6f 6464              modd
-00059980: 6572 7375 623d 2754 3148 5352 270a 2020  ersub='T1HSR'.  
-00059990: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000599a0: 2065 7869 7374 7328 206e 7267 7769 6465   exists( nrgwide
-000599b0: 666e 2029 3a0a 2020 2020 2020 2020 2020  fn ):.          
-000599c0: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
-000599d0: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-000599e0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-000599f0: 696e 7428 206e 7267 7769 6465 666e 202b  int( nrgwidefn +
-00059a00: 2022 2065 7869 7374 7322 290a 2020 2020   " exists").    
-00059a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059a20: 6d6d 3d72 6561 645f 6d6d 5f63 7376 2820  mm=read_mm_csv( 
-00059a30: 6e72 6777 6964 6566 6e2c 2063 6f6c 7072  nrgwidefn, colpr
-00059a40: 6566 6978 3d6d 6f64 6465 7273 7562 2b27  efix=moddersub+'
-00059a50: 5f27 2c20 6973 5f74 313d 6973 5f74 312c  _', is_t1=is_t1,
-00059a60: 2073 6570 6172 6174 6f72 3d73 6570 6172   separator=separ
-00059a70: 6174 6f72 2c20 7665 7262 6f73 653d 7665  ator, verbose=ve
-00059a80: 7262 6f73 6520 290a 2020 2020 2020 2020  rbose ).        
-00059a90: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-00059aa0: 6d20 6973 206e 6f74 204e 6f6e 653a 0a20  m is not None:. 
-00059ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059ac0: 2020 2020 2020 2069 6620 6d6f 645f 6e61         if mod_na
-00059ad0: 6d65 203d 3d20 2754 3177 4869 6572 6172  me == 'T1wHierar
-00059ae0: 6368 6963 616c 273a 0a20 2020 2020 2020  chical':.       
-00059af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059b00: 2020 2020 2061 3d6c 6973 7428 2063 7376       a=list( csv
-00059b10: 726f 772e 6b65 7973 2829 2029 0a20 2020  row.keys() ).   
-00059b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059b30: 2020 2020 2020 2020 2062 3d6c 6973 7428           b=list(
-00059b40: 206d 6d2e 6b65 7973 2829 2029 0a20 2020   mm.keys() ).   
+00055210: 2020 2020 2020 2020 2020 6966 206e 6f72            if nor
+00055220: 6d50 726f 5b6d 796b 6579 5d20 6973 206e  mPro[mykey] is n
+00055230: 6f74 204e 6f6e 6520 616e 6420 6e6f 726d  ot None and norm
+00055240: 5072 6f5b 6d79 6b65 795d 2e63 6f6d 706f  Pro[mykey].compo
+00055250: 6e65 6e74 7320 3d3d 2031 3a0a 2020 2020  nents == 1:.    
+00055260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055280: 2020 2020 6966 2076 6973 7561 6c69 7a65      if visualize
+00055290: 2061 6e64 2046 616c 7365 3a0a 2020 2020   and False:.    
+000552a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000552b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000552c0: 2020 2020 2020 2020 616e 7473 2e70 6c6f          ants.plo
+000552d0: 7428 2074 656d 706c 6174 652c 206e 6f72  t( template, nor
+000552e0: 6d50 726f 5b6d 796b 6579 5d2c 2061 7869  mPro[mykey], axi
+000552f0: 733d 322c 206e 736c 6963 6573 3d32 312c  s=2, nslices=21,
+00055300: 206e 636f 6c3d 372c 2063 726f 703d 5472   ncol=7, crop=Tr
+00055310: 7565 2c20 7469 746c 653d 6d79 6b65 792c  ue, title=mykey,
+00055320: 2066 696c 656e 616d 653d 6d79 6d6d 2b6d   filename=mymm+m
+00055330: 7973 6570 2b6d 796b 6579 2b22 2e70 6e67  ysep+mykey+".png
+00055340: 2220 2020 290a 2020 2020 2020 2020 6966  "   ).        if
+00055350: 206f 7665 726d 6f64 5820 3d3d 206e 7267   overmodX == nrg
+00055360: 5f6d 6f64 616c 6974 795f 6c69 7374 5b20  _modality_list[ 
+00055370: 6c65 6e28 206e 7267 5f6d 6f64 616c 6974  len( nrg_modalit
+00055380: 795f 6c69 7374 2029 202d 2031 205d 3a0a  y_list ) - 1 ]:.
+00055390: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000553a0: 726e 0a20 2020 2020 2020 2069 6620 7665  rn.        if ve
+000553b0: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
+000553c0: 2020 2070 7269 6e74 2822 646f 6e65 2077     print("done w
+000553d0: 6974 6820 2220 2b20 6f76 6572 6d6f 6458  ith " + overmodX
+000553e0: 2029 0a20 2020 2069 6620 7665 7262 6f73   ).    if verbos
+000553f0: 653a 0a20 2020 2020 2020 2070 7269 6e74  e:.        print
+00055400: 2822 6d6d 5f6e 7267 2063 6f6d 706c 6574  ("mm_nrg complet
+00055410: 652e 2229 0a20 2020 2072 6574 7572 6e0a  e.").    return.
+00055420: 0a64 6566 2073 7065 635f 7461 7065 7228  .def spec_taper(
+00055430: 782c 2070 3d30 2e31 293a 0a20 2020 2066  x, p=0.1):.    f
+00055440: 726f 6d20 7363 6970 7920 696d 706f 7274  rom scipy import
+00055450: 2073 7461 7473 2c20 7369 676e 616c 2c20   stats, signal, 
+00055460: 6666 740a 2020 2020 6672 6f6d 2073 7461  fft.    from sta
+00055470: 7473 6d6f 6465 6c73 2e72 6567 7265 7373  tsmodels.regress
+00055480: 696f 6e2e 6c69 6e65 6172 5f6d 6f64 656c  ion.linear_model
+00055490: 2069 6d70 6f72 7420 7975 6c65 5f77 616c   import yule_wal
+000554a0: 6b65 720a 2020 2020 2222 220a 2020 2020  ker.    """.    
+000554b0: 436f 6d70 7574 6573 2061 2074 6170 6572  Computes a taper
+000554c0: 6564 2076 6572 7369 6f6e 206f 6620 782c  ed version of x,
+000554d0: 2077 6974 6820 7461 7065 7269 6e67 2070   with tapering p
+000554e0: 2e0a 0a20 2020 2041 6461 7074 6564 2066  ...    Adapted f
+000554f0: 726f 6d20 5227 7320 7374 6174 733a 3a73  rom R's stats::s
+00055500: 7065 632e 7461 7065 7220 6174 2068 7474  pec.taper at htt
+00055510: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
+00055520: 7465 6c6d 6f2d 636f 7272 6561 2f74 696d  telmo-correa/tim
+00055530: 652d 7365 7269 6573 2d61 6e61 6c79 7369  e-series-analysi
+00055540: 732f 626c 6f62 2f6d 6173 7465 722f 5079  s/blob/master/Py
+00055550: 7468 6f6e 2f73 7065 6374 7275 6d2e 7079  thon/spectrum.py
+00055560: 0a0a 2020 2020 2222 220a 0a20 2020 2070  ..    """..    p
+00055570: 203d 206e 702e 725f 5b70 5d0a 2020 2020   = np.r_[p].    
+00055580: 6173 7365 7274 206e 702e 616c 6c28 2870  assert np.all((p
+00055590: 203e 3d20 3029 2026 2028 7020 3c20 302e   >= 0) & (p < 0.
+000555a0: 3529 292c 2022 2770 2720 6d75 7374 2062  5)), "'p' must b
+000555b0: 6520 6265 7477 6565 6e20 3020 616e 6420  e between 0 and 
+000555c0: 302e 3522 0a0a 2020 2020 7820 3d20 6e70  0.5"..    x = np
+000555d0: 2e72 5f5b 785d 2e61 7374 7970 6528 2766  .r_[x].astype('f
+000555e0: 6c6f 6174 3634 2729 0a20 2020 206f 7269  loat64').    ori
+000555f0: 6769 6e61 6c5f 7368 6170 6520 3d20 782e  ginal_shape = x.
+00055600: 7368 6170 650a 0a20 2020 2061 7373 6572  shape..    asser
+00055610: 7420 6c65 6e28 6f72 6967 696e 616c 5f73  t len(original_s
+00055620: 6861 7065 2920 3c3d 2032 2c20 2227 7827  hape) <= 2, "'x'
+00055630: 206d 7573 7420 6861 7665 2061 7420 6d6f   must have at mo
+00055640: 7374 2032 2064 696d 656e 7369 6f6e 7322  st 2 dimensions"
+00055650: 0a20 2020 2077 6869 6c65 206c 656e 2878  .    while len(x
+00055660: 2e73 6861 7065 2920 3c20 323a 0a20 2020  .shape) < 2:.   
+00055670: 2020 2020 2078 203d 206e 702e 6578 7061       x = np.expa
+00055680: 6e64 5f64 696d 7328 782c 2061 7869 733d  nd_dims(x, axis=
+00055690: 3129 0a0a 2020 2020 6e72 2c20 6e63 203d  1)..    nr, nc =
+000556a0: 2078 2e73 6861 7065 0a20 2020 2069 6620   x.shape.    if 
+000556b0: 6c65 6e28 7029 203d 3d20 313a 0a20 2020  len(p) == 1:.   
+000556c0: 2020 2020 2070 203d 2070 202a 206e 702e       p = p * np.
+000556d0: 6f6e 6573 286e 6329 0a20 2020 2065 6c73  ones(nc).    els
+000556e0: 653a 0a20 2020 2020 2020 2061 7373 6572  e:.        asser
+000556f0: 7420 6c65 6e28 7029 203d 3d20 6e63 2c20  t len(p) == nc, 
+00055700: 226c 656e 6774 6820 6f66 2027 7027 206d  "length of 'p' m
+00055710: 7573 7420 6265 2031 206f 7220 6571 7561  ust be 1 or equa
+00055720: 6c20 7468 6520 6e75 6d62 6572 206f 6620  l the number of 
+00055730: 636f 6c75 6d6e 7320 6f66 2027 7827 220a  columns of 'x'".
+00055740: 0a20 2020 2066 6f72 2069 2069 6e20 7261  .    for i in ra
+00055750: 6e67 6528 6e63 293a 0a20 2020 2020 2020  nge(nc):.       
+00055760: 206d 203d 2069 6e74 286e 702e 666c 6f6f   m = int(np.floo
+00055770: 7228 6e72 202a 2070 5b69 5d29 290a 2020  r(nr * p[i])).  
+00055780: 2020 2020 2020 6966 206d 203d 3d20 303a        if m == 0:
+00055790: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+000557a0: 7469 6e75 650a 2020 2020 2020 2020 7720  tinue.        w 
+000557b0: 3d20 302e 3520 2a20 2831 202d 206e 702e  = 0.5 * (1 - np.
+000557c0: 636f 7328 6e70 2e70 6920 2a20 6e70 2e61  cos(np.pi * np.a
+000557d0: 7261 6e67 6528 312c 2032 202a 206d 2c20  range(1, 2 * m, 
+000557e0: 7374 6570 3d32 292f 2832 202a 206d 2929  step=2)/(2 * m))
+000557f0: 290a 2020 2020 2020 2020 785b 3a2c 2069  ).        x[:, i
+00055800: 5d20 3d20 6e70 2e72 5f5b 772c 206e 702e  ] = np.r_[w, np.
+00055810: 6f6e 6573 286e 7220 2d20 3220 2a20 6d29  ones(nr - 2 * m)
+00055820: 2c20 775b 3a3a 2d31 5d5d 202a 2078 5b3a  , w[::-1]] * x[:
+00055830: 2c20 695d 0a0a 2020 2020 7820 3d20 6e70  , i]..    x = np
+00055840: 2e72 6573 6861 7065 2878 2c20 6f72 6967  .reshape(x, orig
+00055850: 696e 616c 5f73 6861 7065 290a 2020 2020  inal_shape).    
+00055860: 7265 7475 726e 2078 0a0a 6465 6620 706c  return x..def pl
+00055870: 6f74 5f73 7065 6328 7370 6563 5f72 6573  ot_spec(spec_res
+00055880: 2c20 636f 7665 7261 6765 3d4e 6f6e 652c  , coverage=None,
+00055890: 2061 783d 4e6f 6e65 2c20 7469 746c 653d   ax=None, title=
+000558a0: 4e6f 6e65 293a 0a20 2020 2069 6d70 6f72  None):.    impor
+000558b0: 7420 6d61 7470 6c6f 746c 6962 2e70 7970  t matplotlib.pyp
+000558c0: 6c6f 7420 6173 2070 6c74 0a20 2020 2022  lot as plt.    "
+000558d0: 2222 436f 6e76 656e 6965 6e63 6520 706c  ""Convenience pl
+000558e0: 6f74 7469 6e67 206d 6574 686f 642c 2061  otting method, a
+000558f0: 6c73 6f20 696e 636c 7564 6573 2063 6f6e  lso includes con
+00055900: 6669 6465 6e63 6520 6372 6f73 7320 696e  fidence cross in
+00055910: 2074 6865 2073 616d 6520 7374 796c 6520   the same style 
+00055920: 6173 2052 2e0a 0a20 2020 204e 6f74 6520  as R...    Note 
+00055930: 7468 6174 2074 6865 206c 6f63 6174 696f  that the locatio
+00055940: 6e20 6f66 2074 6865 2063 726f 7373 2069  n of the cross i
+00055950: 7320 6972 7265 6c65 7661 6e74 3b20 6f6e  s irrelevant; on
+00055960: 6c79 2077 6964 7468 2061 6e64 2068 6569  ly width and hei
+00055970: 6768 7420 6d61 7474 6572 2e22 2222 0a20  ght matter.""". 
+00055980: 2020 2066 2c20 5078 7820 3d20 7370 6563     f, Pxx = spec
+00055990: 5f72 6573 5b27 6672 6571 275d 2c20 7370  _res['freq'], sp
+000559a0: 6563 5f72 6573 5b27 7370 6563 275d 0a0a  ec_res['spec']..
+000559b0: 2020 2020 6966 2063 6f76 6572 6167 6520      if coverage 
+000559c0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+000559d0: 2020 2020 2063 6920 3d20 7370 6563 5f63       ci = spec_c
+000559e0: 6928 7370 6563 5f72 6573 5b27 6466 275d  i(spec_res['df']
+000559f0: 2c20 636f 7665 7261 6765 3d63 6f76 6572  , coverage=cover
+00055a00: 6167 6529 0a20 2020 2020 2020 2063 6f6e  age).        con
+00055a10: 665f 7820 3d20 286d 6178 2873 7065 635f  f_x = (max(spec_
+00055a20: 7265 735b 2766 7265 7127 5d29 202d 2073  res['freq']) - s
+00055a30: 7065 635f 7265 735b 2762 616e 6477 6964  pec_res['bandwid
+00055a40: 7468 275d 2920 2b20 6e70 2e72 5f5b 2d30  th']) + np.r_[-0
+00055a50: 2e35 2c20 302e 355d 202a 2073 7065 635f  .5, 0.5] * spec_
+00055a60: 7265 735b 2762 616e 6477 6964 7468 275d  res['bandwidth']
+00055a70: 0a20 2020 2020 2020 2063 6f6e 665f 7920  .        conf_y 
+00055a80: 3d20 6d61 7828 7370 6563 5f72 6573 5b27  = max(spec_res['
+00055a90: 7370 6563 275d 2920 2f20 6369 5b31 5d0a  spec']) / ci[1].
+00055aa0: 0a20 2020 2069 6620 6178 2069 7320 4e6f  .    if ax is No
+00055ab0: 6e65 3a0a 2020 2020 2020 2020 6178 203d  ne:.        ax =
+00055ac0: 2070 6c74 2e67 6361 2829 0a0a 2020 2020   plt.gca()..    
+00055ad0: 6178 2e70 6c6f 7428 662c 2050 7878 2c20  ax.plot(f, Pxx, 
+00055ae0: 636f 6c6f 723d 2743 3027 290a 2020 2020  color='C0').    
+00055af0: 6178 2e73 6574 5f78 6c61 6265 6c28 2746  ax.set_xlabel('F
+00055b00: 7265 7175 656e 6379 2729 0a20 2020 2061  requency').    a
+00055b10: 782e 7365 745f 796c 6162 656c 2827 4c6f  x.set_ylabel('Lo
+00055b20: 6720 5370 6563 7472 756d 2729 0a20 2020  g Spectrum').   
+00055b30: 2061 782e 7365 745f 7973 6361 6c65 2827   ax.set_yscale('
+00055b40: 6c6f 6727 290a 2020 2020 6966 2063 6f76  log').    if cov
+00055b50: 6572 6167 6520 6973 206e 6f74 204e 6f6e  erage is not Non
+00055b60: 653a 0a20 2020 2020 2020 2061 782e 706c  e:.        ax.pl
+00055b70: 6f74 286e 702e 6d65 616e 2863 6f6e 665f  ot(np.mean(conf_
+00055b80: 7829 202a 206e 702e 725f 5b31 2c20 315d  x) * np.r_[1, 1]
+00055b90: 2c20 636f 6e66 5f79 202a 2063 692c 2063  , conf_y * ci, c
+00055ba0: 6f6c 6f72 3d27 7265 6427 290a 2020 2020  olor='red').    
+00055bb0: 2020 2020 6178 2e70 6c6f 7428 636f 6e66      ax.plot(conf
+00055bc0: 5f78 2c20 6e70 2e6d 6561 6e28 636f 6e66  _x, np.mean(conf
+00055bd0: 5f79 2920 2a20 6e70 2e72 5f5b 312c 2031  _y) * np.r_[1, 1
+00055be0: 5d2c 2063 6f6c 6f72 3d27 7265 6427 290a  ], color='red').
+00055bf0: 0a20 2020 2061 782e 7365 745f 7469 746c  .    ax.set_titl
+00055c00: 6528 7370 6563 5f72 6573 5b27 6d65 7468  e(spec_res['meth
+00055c10: 6f64 275d 2069 6620 7469 746c 6520 6973  od'] if title is
+00055c20: 204e 6f6e 6520 656c 7365 2074 6974 6c65   None else title
+00055c30: 290a 0a64 6566 2073 7065 635f 6369 2864  )..def spec_ci(d
+00055c40: 662c 2063 6f76 6572 6167 653d 302e 3935  f, coverage=0.95
+00055c50: 293a 0a20 2020 2066 726f 6d20 7363 6970  ):.    from scip
+00055c60: 7920 696d 706f 7274 2073 7461 7473 2c20  y import stats, 
+00055c70: 7369 676e 616c 2c20 6666 740a 2020 2020  signal, fft.    
+00055c80: 6672 6f6d 2073 7461 7473 6d6f 6465 6c73  from statsmodels
+00055c90: 2e72 6567 7265 7373 696f 6e2e 6c69 6e65  .regression.line
+00055ca0: 6172 5f6d 6f64 656c 2069 6d70 6f72 7420  ar_model import 
+00055cb0: 7975 6c65 5f77 616c 6b65 720a 2020 2020  yule_walker.    
+00055cc0: 2222 220a 2020 2020 436f 6d70 7574 6573  """.    Computes
+00055cd0: 2074 6865 2063 6f6e 6669 6465 6e63 6520   the confidence 
+00055ce0: 696e 7465 7276 616c 2066 6f72 2061 2073  interval for a s
+00055cf0: 7065 6374 7261 6c20 6669 742c 2062 6173  pectral fit, bas
+00055d00: 6564 206f 6e20 7468 6520 6e75 6d62 6572  ed on the number
+00055d10: 206f 6620 6465 6772 6565 7320 6f66 2066   of degrees of f
+00055d20: 7265 6564 6f6d 2e0a 0a20 2020 2041 6461  reedom...    Ada
+00055d30: 7074 6564 2066 726f 6d20 5227 7320 7374  pted from R's st
+00055d40: 6174 733a 3a70 6c6f 742e 7370 6563 2061  ats::plot.spec a
+00055d50: 7420 6874 7470 733a 2f2f 6769 7468 7562  t https://github
+00055d60: 2e63 6f6d 2f74 656c 6d6f 2d63 6f72 7265  .com/telmo-corre
+00055d70: 612f 7469 6d65 2d73 6572 6965 732d 616e  a/time-series-an
+00055d80: 616c 7973 6973 2f62 6c6f 622f 6d61 7374  alysis/blob/mast
+00055d90: 6572 2f50 7974 686f 6e2f 7370 6563 7472  er/Python/spectr
+00055da0: 756d 2e70 790a 0a20 2020 2022 2222 0a0a  um.py..    """..
+00055db0: 2020 2020 6173 7365 7274 2063 6f76 6572      assert cover
+00055dc0: 6167 6520 3e3d 2030 2061 6e64 2063 6f76  age >= 0 and cov
+00055dd0: 6572 6167 6520 3c20 312c 2022 636f 7665  erage < 1, "cove
+00055de0: 7261 6765 2070 726f 6261 6269 6c69 7479  rage probability
+00055df0: 206f 7574 206f 6620 7261 6e67 6520 5b30   out of range [0
+00055e00: 2c20 3129 220a 0a20 2020 2074 6169 6c20  , 1)"..    tail 
+00055e10: 3d20 3120 2d20 636f 7665 7261 6765 0a0a  = 1 - coverage..
+00055e20: 2020 2020 7068 6920 3d20 7374 6174 732e      phi = stats.
+00055e30: 6368 6932 2e63 6466 2878 3d64 662c 2064  chi2.cdf(x=df, d
+00055e40: 663d 6466 290a 2020 2020 7570 7065 725f  f=df).    upper_
+00055e50: 7175 616e 7469 6c65 203d 2031 202d 2074  quantile = 1 - t
+00055e60: 6169 6c20 2a20 2831 202d 2070 6869 290a  ail * (1 - phi).
+00055e70: 2020 2020 6c6f 7765 725f 7175 616e 7469      lower_quanti
+00055e80: 6c65 203d 2074 6169 6c20 2a20 7068 690a  le = tail * phi.
+00055e90: 0a20 2020 2072 6574 7572 6e20 6466 202f  .    return df /
+00055ea0: 2073 7461 7473 2e63 6869 322e 7070 6628   stats.chi2.ppf(
+00055eb0: 5b75 7070 6572 5f71 7561 6e74 696c 652c  [upper_quantile,
+00055ec0: 206c 6f77 6572 5f71 7561 6e74 696c 655d   lower_quantile]
+00055ed0: 2c20 6466 3d64 6629 0a0a 6465 6620 7370  , df=df)..def sp
+00055ee0: 6563 5f70 6772 616d 2878 2c20 7866 7265  ec_pgram(x, xfre
+00055ef0: 713d 312c 2073 7061 6e73 3d4e 6f6e 652c  q=1, spans=None,
+00055f00: 206b 6572 6e65 6c3d 4e6f 6e65 2c20 7461   kernel=None, ta
+00055f10: 7065 723d 302e 312c 2070 6164 3d30 2c20  per=0.1, pad=0, 
+00055f20: 6661 7374 3d54 7275 652c 2064 656d 6561  fast=True, demea
+00055f30: 6e3d 4661 6c73 652c 2064 6574 7265 6e64  n=False, detrend
+00055f40: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
+00055f50: 2020 2020 2020 706c 6f74 3d54 7275 652c        plot=True,
+00055f60: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+00055f70: 2222 220a 2020 2020 436f 6d70 7574 6573  """.    Computes
+00055f80: 2074 6865 2073 7065 6374 7261 6c20 6465   the spectral de
+00055f90: 6e73 6974 7920 6573 7469 6d61 7465 2075  nsity estimate u
+00055fa0: 7369 6e67 2061 2070 6572 696f 646f 6772  sing a periodogr
+00055fb0: 616d 2e20 204f 7074 696f 6e61 6c6c 792c  am.  Optionally,
+00055fc0: 2069 7420 616c 736f 3a0a 2020 2020 2d20   it also:.    - 
+00055fd0: 5573 6573 2061 2070 726f 7669 6465 6420  Uses a provided 
+00055fe0: 6b65 726e 656c 2077 696e 646f 772c 206f  kernel window, o
+00055ff0: 7220 6120 7365 7175 656e 6365 206f 6620  r a sequence of 
+00056000: 7370 616e 7320 666f 7220 636f 6e76 6f6c  spans for convol
+00056010: 7574 6564 206d 6f64 6966 6965 6420 4461  uted modified Da
+00056020: 6e69 656c 6c20 6b65 726e 656c 732e 0a20  niell kernels.. 
+00056030: 2020 202d 2054 6170 6572 7320 7468 6520     - Tapers the 
+00056040: 7374 6172 7420 616e 6420 656e 6420 6f66  start and end of
+00056050: 2074 6865 2073 6572 6965 7320 746f 2061   the series to a
+00056060: 766f 6964 2065 6e64 2d6f 662d 7369 676e  void end-of-sign
+00056070: 616c 2065 6666 6563 7473 2e0a 2020 2020  al effects..    
+00056080: 2d20 5061 6473 2074 6865 2070 726f 7669  - Pads the provi
+00056090: 6465 6420 7365 7269 6573 2062 6566 6f72  ded series befor
+000560a0: 6520 636f 6d70 7574 6174 696f 6e2c 2061  e computation, a
+000560b0: 6464 696e 6720 7061 642a 286c 656e 6774  dding pad*(lengt
+000560c0: 6820 6f66 2073 6572 6965 7329 207a 6572  h of series) zer
+000560d0: 6f73 2061 7420 7468 6520 656e 642e 0a20  os at the end.. 
+000560e0: 2020 202d 2050 6164 7320 7468 6520 7072     - Pads the pr
+000560f0: 6f76 6964 6564 2073 6572 6965 7320 6265  ovided series be
+00056100: 666f 7265 2063 6f6d 7075 7461 7469 6f6e  fore computation
+00056110: 2074 6f20 7370 6565 6420 7570 2046 4654   to speed up FFT
+00056120: 2063 616c 6375 6c61 7469 6f6e 2e0a 2020   calculation..  
+00056130: 2020 2d20 5065 7266 6f72 6d73 2064 656d    - Performs dem
+00056140: 6561 6e69 6e67 206f 7220 6465 7472 656e  eaning or detren
+00056150: 6469 6e67 206f 6e20 7468 6520 7365 7269  ding on the seri
+00056160: 6573 2e0a 2020 2020 2d20 506c 6f74 7320  es..    - Plots 
+00056170: 7265 7375 6c74 732e 0a0a 2020 2020 496d  results...    Im
+00056180: 706c 656d 656e 7465 6420 746f 2065 6e73  plemented to ens
+00056190: 7572 6520 636f 6d70 6174 6962 696c 6974  ure compatibilit
+000561a0: 7920 7769 7468 2052 2773 2073 7065 6374  y with R's spect
+000561b0: 7261 6c20 6675 6e63 7469 6f6e 732c 2061  ral functions, a
+000561c0: 7320 6f70 706f 7365 6420 746f 2072 6575  s opposed to reu
+000561d0: 7369 6e67 2073 6369 7079 2773 2070 6572  sing scipy's per
+000561e0: 696f 646f 6772 616d 2e0a 0a20 2020 2041  iodogram...    A
+000561f0: 6461 7074 6564 2066 726f 6d20 5227 7320  dapted from R's 
+00056200: 7374 6174 733a 3a73 7065 632e 7067 7261  stats::spec.pgra
+00056210: 6d20 6174 2068 7474 7073 3a2f 2f67 6974  m at https://git
+00056220: 6875 622e 636f 6d2f 7465 6c6d 6f2d 636f  hub.com/telmo-co
+00056230: 7272 6561 2f74 696d 652d 7365 7269 6573  rrea/time-series
+00056240: 2d61 6e61 6c79 7369 732f 626c 6f62 2f6d  -analysis/blob/m
+00056250: 6173 7465 722f 5079 7468 6f6e 2f73 7065  aster/Python/spe
+00056260: 6374 7275 6d2e 7079 0a0a 2020 2020 6578  ctrum.py..    ex
+00056270: 616d 706c 653a 0a0a 2020 2020 696d 706f  ample:..    impo
+00056280: 7274 206e 756d 7079 2061 7320 6e70 0a20  rt numpy as np. 
+00056290: 2020 2069 6d70 6f72 7420 616e 7473 7079     import antspy
+000562a0: 6d6d 0a20 2020 206d 7978 203d 206e 702e  mm.    myx = np.
+000562b0: 7261 6e64 6f6d 2e72 616e 6428 3130 302c  random.rand(100,
+000562c0: 3129 0a20 2020 206d 7973 7065 6320 3d20  1).    myspec = 
+000562d0: 616e 7473 7079 6d6d 2e73 7065 635f 7067  antspymm.spec_pg
+000562e0: 7261 6d28 6d79 782c 302e 3529 0a0a 2020  ram(myx,0.5)..  
+000562f0: 2020 2222 220a 2020 2020 6672 6f6d 2073    """.    from s
+00056300: 6369 7079 2069 6d70 6f72 7420 7374 6174  cipy import stat
+00056310: 732c 2073 6967 6e61 6c2c 2066 6674 0a20  s, signal, fft. 
+00056320: 2020 2066 726f 6d20 7374 6174 736d 6f64     from statsmod
+00056330: 656c 732e 7265 6772 6573 7369 6f6e 2e6c  els.regression.l
+00056340: 696e 6561 725f 6d6f 6465 6c20 696d 706f  inear_model impo
+00056350: 7274 2079 756c 655f 7761 6c6b 6572 0a20  rt yule_walker. 
+00056360: 2020 2064 6566 2064 616e 6965 6c6c 5f77     def daniell_w
+00056370: 696e 646f 775f 6d6f 6469 6669 6564 286d  indow_modified(m
+00056380: 293a 0a20 2020 2020 2020 2022 2222 2053  ):.        """ S
+00056390: 696e 676c 652d 7061 7373 206d 6f64 6966  ingle-pass modif
+000563a0: 6965 6420 4461 6e69 656c 6c20 6b65 726e  ied Daniell kern
+000563b0: 656c 2077 696e 646f 772e 0a0a 2020 2020  el window...    
+000563c0: 2020 2020 5765 6967 6874 2069 7320 6e6f      Weight is no
+000563d0: 726d 616c 697a 6564 2074 6f20 6164 6420  rmalized to add 
+000563e0: 7570 2074 6f20 312c 2061 6e64 2061 6c6c  up to 1, and all
+000563f0: 2076 616c 7565 7320 6172 6520 7468 6520   values are the 
+00056400: 7361 6d65 2c20 6f74 6865 7220 7468 616e  same, other than
+00056410: 2074 6865 2066 6972 7374 2061 6e64 2074   the first and t
+00056420: 6865 0a20 2020 2020 2020 206c 6173 742c  he.        last,
+00056430: 2077 6869 6368 2061 7265 2064 6976 6964   which are divid
+00056440: 6564 2062 7920 322e 0a20 2020 2020 2020  ed by 2..       
+00056450: 2022 2222 0a20 2020 2020 2020 2064 6566   """.        def
+00056460: 2077 286b 293a 0a20 2020 2020 2020 2020   w(k):.         
+00056470: 2020 2072 6574 7572 6e20 6e70 2e77 6865     return np.whe
+00056480: 7265 286e 702e 6162 7328 6b29 203c 206d  re(np.abs(k) < m
+00056490: 2c20 3120 2f20 2832 2a6d 292c 206e 702e  , 1 / (2*m), np.
+000564a0: 7768 6572 6528 6e70 2e61 6273 286b 2920  where(np.abs(k) 
+000564b0: 3d3d 206d 2c20 312f 2834 2a6d 292c 2030  == m, 1/(4*m), 0
+000564c0: 2929 0a0a 2020 2020 2020 2020 7265 7475  ))..        retu
+000564d0: 726e 2077 286e 702e 6172 616e 6765 282d  rn w(np.arange(-
+000564e0: 6d2c 206d 2b31 2929 0a0a 2020 2020 6465  m, m+1))..    de
+000564f0: 6620 6461 6e69 656c 6c5f 7769 6e64 6f77  f daniell_window
+00056500: 5f63 6f6e 766f 6c76 6528 7629 3a0a 2020  _convolve(v):.  
+00056510: 2020 2020 2020 2222 2220 436f 6e76 6f6c        """ Convol
+00056520: 7665 6420 7665 7273 696f 6e20 6f66 206d  ved version of m
+00056530: 756c 7469 706c 6520 6d6f 6469 6669 6564  ultiple modified
+00056540: 2044 616e 6965 6c6c 206b 6572 6e65 6c20   Daniell kernel 
+00056550: 7769 6e64 6f77 732e 0a0a 2020 2020 2020  windows...      
+00056560: 2020 5061 7261 6d65 7465 7220 7620 7368    Parameter v sh
+00056570: 6f75 6c64 2062 6520 616e 2069 7465 7261  ould be an itera
+00056580: 626c 6520 6f66 206d 2076 616c 7565 732e  ble of m values.
+00056590: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+000565a0: 2020 2020 2020 6966 206c 656e 2876 2920        if len(v) 
+000565b0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+000565c0: 2020 7265 7475 726e 206e 702e 725f 5b31    return np.r_[1
+000565d0: 5d0a 0a20 2020 2020 2020 2069 6620 6c65  ]..        if le
+000565e0: 6e28 7629 203d 3d20 313a 0a20 2020 2020  n(v) == 1:.     
+000565f0: 2020 2020 2020 2072 6574 7572 6e20 6461         return da
+00056600: 6e69 656c 6c5f 7769 6e64 6f77 5f6d 6f64  niell_window_mod
+00056610: 6966 6965 6428 765b 305d 290a 0a20 2020  ified(v[0])..   
+00056620: 2020 2020 2072 6574 7572 6e20 7369 676e       return sign
+00056630: 616c 2e63 6f6e 766f 6c76 6528 6461 6e69  al.convolve(dani
+00056640: 656c 6c5f 7769 6e64 6f77 5f6d 6f64 6966  ell_window_modif
+00056650: 6965 6428 765b 305d 292c 2064 616e 6965  ied(v[0]), danie
+00056660: 6c6c 5f77 696e 646f 775f 636f 6e76 6f6c  ll_window_convol
+00056670: 7665 2876 5b31 3a5d 2929 0a0a 2020 2020  ve(v[1:]))..    
+00056680: 2320 456e 7375 7265 2077 6520 6361 6e20  # Ensure we can 
+00056690: 7374 6f72 6520 6e6f 6e2d 696e 7465 6765  store non-intege
+000566a0: 7273 2069 6e20 782c 2061 6e64 2074 6861  rs in x, and tha
+000566b0: 7420 6974 2069 7320 6120 6e75 6d70 7920  t it is a numpy 
+000566c0: 6f62 6a65 6374 0a20 2020 2078 203d 206e  object.    x = n
+000566d0: 702e 725f 5b78 5d2e 6173 7479 7065 2827  p.r_[x].astype('
+000566e0: 666c 6f61 7436 3427 290a 2020 2020 6f72  float64').    or
+000566f0: 6967 696e 616c 5f73 6861 7065 203d 2078  iginal_shape = x
+00056700: 2e73 6861 7065 0a0a 2020 2020 2320 456e  .shape..    # En
+00056710: 7375 7265 2063 6f72 7265 6374 2064 696d  sure correct dim
+00056720: 656e 7369 6f6e 730a 2020 2020 6173 7365  ensions.    asse
+00056730: 7274 206c 656e 286f 7269 6769 6e61 6c5f  rt len(original_
+00056740: 7368 6170 6529 203c 3d20 322c 2022 2778  shape) <= 2, "'x
+00056750: 2720 6d75 7374 2068 6176 6520 6174 206d  ' must have at m
+00056760: 6f73 7420 3220 6469 6d65 6e73 696f 6e73  ost 2 dimensions
+00056770: 220a 2020 2020 7768 696c 6520 6c65 6e28  ".    while len(
+00056780: 782e 7368 6170 6529 203c 2032 3a0a 2020  x.shape) < 2:.  
+00056790: 2020 2020 2020 7820 3d20 6e70 2e65 7870        x = np.exp
+000567a0: 616e 645f 6469 6d73 2878 2c20 6178 6973  and_dims(x, axis
+000567b0: 3d31 290a 0a20 2020 204e 2c20 6e73 6572  =1)..    N, nser
+000567c0: 203d 2078 2e73 6861 7065 0a20 2020 204e   = x.shape.    N
+000567d0: 3020 3d20 4e0a 0a20 2020 2023 2045 6e73  0 = N..    # Ens
+000567e0: 7572 6520 6f6e 6c79 206f 6e65 206f 6620  ure only one of 
+000567f0: 7370 616e 732c 206b 6572 6e65 6c20 6973  spans, kernel is
+00056800: 2070 726f 7669 6465 642c 2061 6e64 2062   provided, and b
+00056810: 7569 6c64 2074 6865 206b 6572 6e65 6c20  uild the kernel 
+00056820: 7769 6e64 6f77 2069 6620 6e65 6564 6564  window if needed
+00056830: 0a20 2020 2061 7373 6572 7420 2873 7061  .    assert (spa
+00056840: 6e73 2069 7320 4e6f 6e65 2920 6f72 2028  ns is None) or (
+00056850: 6b65 726e 656c 2069 7320 4e6f 6e65 292c  kernel is None),
+00056860: 2022 6d75 7374 2073 7065 6369 6679 206f   "must specify o
+00056870: 6e6c 7920 6f6e 6520 6f66 2027 7370 616e  nly one of 'span
+00056880: 7327 206f 7220 276b 6572 6e65 6c27 220a  s' or 'kernel'".
+00056890: 2020 2020 6966 2073 7061 6e73 2069 7320      if spans is 
+000568a0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+000568b0: 2020 6b65 726e 656c 203d 2064 616e 6965    kernel = danie
+000568c0: 6c6c 5f77 696e 646f 775f 636f 6e76 6f6c  ll_window_convol
+000568d0: 7665 286e 702e 666c 6f6f 725f 6469 7669  ve(np.floor_divi
+000568e0: 6465 286e 702e 725f 5b73 7061 6e73 5d2c  de(np.r_[spans],
+000568f0: 2032 2929 0a0a 2020 2020 2320 4465 7472   2))..    # Detr
+00056900: 656e 6420 6f72 2064 656d 6561 6e20 7468  end or demean th
+00056910: 6520 7365 7269 6573 0a20 2020 2069 6620  e series.    if 
+00056920: 6465 7472 656e 643a 0a20 2020 2020 2020  detrend:.       
+00056930: 2074 203d 206e 702e 6172 616e 6765 284e   t = np.arange(N
+00056940: 2920 2d20 284e 202d 2031 292f 320a 2020  ) - (N - 1)/2.  
+00056950: 2020 2020 2020 7375 6d74 3220 3d20 4e20        sumt2 = N 
+00056960: 2a20 284e 2a2a 3220 2d20 3129 2f31 320a  * (N**2 - 1)/12.
+00056970: 2020 2020 2020 2020 7820 2d3d 2028 6e70          x -= (np
+00056980: 2e72 6570 6561 7428 6e70 2e65 7870 616e  .repeat(np.expan
+00056990: 645f 6469 6d73 286e 702e 6d65 616e 2878  d_dims(np.mean(x
+000569a0: 2c20 6178 6973 3d30 292c 2030 292c 204e  , axis=0), 0), N
+000569b0: 2c20 6178 6973 3d30 2920 2b20 6e70 2e6f  , axis=0) + np.o
+000569c0: 7574 6572 286e 702e 7375 6d28 782e 5420  uter(np.sum(x.T 
+000569d0: 2a20 742c 2061 7869 733d 3129 2c20 742f  * t, axis=1), t/
+000569e0: 7375 6d74 3229 2e54 290a 2020 2020 656c  sumt2).T).    el
+000569f0: 6966 2064 656d 6561 6e3a 0a20 2020 2020  if demean:.     
+00056a00: 2020 2078 202d 3d20 6e70 2e6d 6561 6e28     x -= np.mean(
+00056a10: 782c 2061 7869 733d 3029 0a0a 2020 2020  x, axis=0)..    
+00056a20: 2320 436f 6d70 7574 6520 7461 7065 7220  # Compute taper 
+00056a30: 616e 6420 7461 7065 7220 6164 6a75 7374  and taper adjust
+00056a40: 6d65 6e74 2076 6172 6961 626c 6573 0a20  ment variables. 
+00056a50: 2020 2078 203d 2073 7065 635f 7461 7065     x = spec_tape
+00056a60: 7228 782c 2074 6170 6572 290a 2020 2020  r(x, taper).    
+00056a70: 7532 203d 2028 3120 2d20 2835 2f38 2920  u2 = (1 - (5/8) 
+00056a80: 2a20 7461 7065 7220 2a20 3229 0a20 2020  * taper * 2).   
+00056a90: 2075 3420 3d20 2831 202d 2028 3933 2f31   u4 = (1 - (93/1
+00056aa0: 3238 2920 2a20 7461 7065 7220 2a20 3229  28) * taper * 2)
+00056ab0: 0a0a 2020 2020 2320 5061 6420 7468 6520  ..    # Pad the 
+00056ac0: 7365 7269 6573 2077 6974 6820 636f 7069  series with copi
+00056ad0: 6573 206f 6620 7468 6520 7361 6d65 2073  es of the same s
+00056ae0: 6861 7065 2c20 6275 7420 6669 6c6c 6564  hape, but filled
+00056af0: 2077 6974 6820 7a65 726f 6573 0a20 2020   with zeroes.   
+00056b00: 2069 6620 7061 6420 3e20 303a 0a20 2020   if pad > 0:.   
+00056b10: 2020 2020 2078 203d 206e 702e 725f 5b78       x = np.r_[x
+00056b20: 2c20 6e70 2e7a 6572 6f73 2828 7061 6420  , np.zeros((pad 
+00056b30: 2a20 782e 7368 6170 655b 305d 2c20 782e  * x.shape[0], x.
+00056b40: 7368 6170 655b 315d 2929 5d0a 2020 2020  shape[1]))].    
+00056b50: 2020 2020 4e20 3d20 782e 7368 6170 655b      N = x.shape[
+00056b60: 305d 0a0a 2020 2020 2320 4675 7274 6865  0]..    # Furthe
+00056b70: 7220 7061 6420 7468 6520 7365 7269 6573  r pad the series
+00056b80: 2074 6f20 6163 6365 6c65 7261 7465 2046   to accelerate F
+00056b90: 4654 2063 6f6d 7075 7461 7469 6f6e 0a20  FT computation. 
+00056ba0: 2020 2069 6620 6661 7374 3a0a 2020 2020     if fast:.    
+00056bb0: 2020 2020 6e65 774e 203d 2066 6674 2e6e      newN = fft.n
+00056bc0: 6578 745f 6661 7374 5f6c 656e 284e 2c20  ext_fast_len(N, 
+00056bd0: 5472 7565 290a 2020 2020 2020 2020 7820  True).        x 
+00056be0: 3d20 6e70 2e72 5f5b 782c 206e 702e 7a65  = np.r_[x, np.ze
+00056bf0: 726f 7328 286e 6577 4e20 2d20 4e2c 2078  ros((newN - N, x
+00056c00: 2e73 6861 7065 5b31 5d29 295d 0a20 2020  .shape[1]))].   
+00056c10: 2020 2020 204e 203d 206e 6577 4e0a 0a20       N = newN.. 
+00056c20: 2020 2023 2043 6f6d 7075 7465 2074 6865     # Compute the
+00056c30: 2046 6f75 7269 6572 2066 7265 7175 656e   Fourier frequen
+00056c40: 6369 6573 2028 5227 7320 7370 6563 2e70  cies (R's spec.p
+00056c50: 6772 616d 2063 6f6e 7665 6e74 696f 6e20  gram convention 
+00056c60: 7374 796c 6529 0a20 2020 204e 7370 6563  style).    Nspec
+00056c70: 203d 2069 6e74 286e 702e 666c 6f6f 7228   = int(np.floor(
+00056c80: 4e2f 3229 290a 2020 2020 6672 6571 203d  N/2)).    freq =
+00056c90: 2028 6e70 2e61 7261 6e67 6528 4e73 7065   (np.arange(Nspe
+00056ca0: 6329 202b 2031 2920 2a20 7866 7265 7120  c) + 1) * xfreq 
+00056cb0: 2f20 4e0a 0a20 2020 2023 2054 7261 6e73  / N..    # Trans
+00056cc0: 6c61 7469 6f6e 7320 746f 206b 6565 7020  lations to keep 
+00056cd0: 7361 6d65 2072 6f77 202f 2063 6f6c 756d  same row / colum
+00056ce0: 6e20 636f 6e76 656e 7469 6f6e 2061 7320  n convention as 
+00056cf0: 7374 6174 733a 3a6d 7666 6674 0a20 2020  stats::mvfft.   
+00056d00: 2078 6666 7420 3d20 6666 742e 6666 7428   xfft = fft.fft(
+00056d10: 782e 5429 2e54 0a0a 2020 2020 2320 436f  x.T).T..    # Co
+00056d20: 6d70 7574 6520 7468 6520 7065 7269 6f64  mpute the period
+00056d30: 6f67 7261 6d20 666f 7220 6561 6368 2069  ogram for each i
+00056d40: 2c20 6a0a 2020 2020 7067 7261 6d20 3d20  , j.    pgram = 
+00056d50: 6e70 2e65 6d70 7479 2828 4e2c 206e 7365  np.empty((N, nse
+00056d60: 722c 206e 7365 7229 2c20 6474 7970 653d  r, nser), dtype=
+00056d70: 2763 6f6d 706c 6578 2729 0a20 2020 2066  'complex').    f
+00056d80: 6f72 2069 2069 6e20 7261 6e67 6528 6e73  or i in range(ns
+00056d90: 6572 293a 0a20 2020 2020 2020 2066 6f72  er):.        for
+00056da0: 206a 2069 6e20 7261 6e67 6528 6e73 6572   j in range(nser
+00056db0: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
+00056dc0: 6772 616d 5b3a 2c20 692c 206a 5d20 3d20  gram[:, i, j] = 
+00056dd0: 7866 6674 5b3a 2c20 695d 202a 206e 702e  xfft[:, i] * np.
+00056de0: 636f 6e6a 2878 6666 745b 3a2c 206a 5d29  conj(xfft[:, j])
+00056df0: 202f 2028 4e30 202a 2078 6672 6571 290a   / (N0 * xfreq).
+00056e00: 2020 2020 2020 2020 2020 2020 7067 7261              pgra
+00056e10: 6d5b 302c 2069 2c20 6a5d 203d 2030 2e35  m[0, i, j] = 0.5
+00056e20: 202a 2028 7067 7261 6d5b 312c 2069 2c20   * (pgram[1, i, 
+00056e30: 6a5d 202b 2070 6772 616d 5b2d 312c 2069  j] + pgram[-1, i
+00056e40: 2c20 6a5d 290a 0a20 2020 2069 6620 6b65  , j])..    if ke
+00056e50: 726e 656c 2069 7320 4e6f 6e65 3a0a 2020  rnel is None:.  
+00056e60: 2020 2020 2020 2320 5661 6c75 6573 2070        # Values p
+00056e70: 7265 2d61 646a 7573 746d 656e 740a 2020  re-adjustment.  
+00056e80: 2020 2020 2020 6466 203d 2032 0a20 2020        df = 2.   
+00056e90: 2020 2020 2062 616e 6477 6964 7468 203d       bandwidth =
+00056ea0: 206e 702e 7371 7274 2831 202f 2031 3229   np.sqrt(1 / 12)
+00056eb0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00056ec0: 2020 2064 6566 2063 6f6e 765f 6369 7263     def conv_circ
+00056ed0: 756c 6172 2873 6967 6e61 6c2c 206b 6572  ular(signal, ker
+00056ee0: 6e65 6c29 3a0a 2020 2020 2020 2020 2020  nel):.          
+00056ef0: 2020 2222 220a 2020 2020 2020 2020 2020    """.          
+00056f00: 2020 5065 7266 6f72 6d73 2031 4420 6369    Performs 1D ci
+00056f10: 7263 756c 6172 2063 6f6e 766f 6c75 7469  rcular convoluti
+00056f20: 6f6e 2c20 696e 2074 6865 2073 616d 6520  on, in the same 
+00056f30: 7374 796c 6520 6173 2052 3a3a 6b65 726e  style as R::kern
+00056f40: 6170 706c 792c 0a20 2020 2020 2020 2020  apply,.         
+00056f50: 2020 2061 7373 756d 696e 6720 7468 6520     assuming the 
+00056f60: 6b65 726e 656c 2077 696e 646f 7720 6973  kernel window is
+00056f70: 2063 656e 7465 7265 6420 6174 2030 2e0a   centered at 0..
+00056f80: 2020 2020 2020 2020 2020 2020 2222 220a              """.
+00056f90: 2020 2020 2020 2020 2020 2020 7061 6420              pad 
+00056fa0: 3d20 6c65 6e28 7369 676e 616c 2920 2d20  = len(signal) - 
+00056fb0: 6c65 6e28 6b65 726e 656c 290a 2020 2020  len(kernel).    
+00056fc0: 2020 2020 2020 2020 6861 6c66 5f77 696e          half_win
+00056fd0: 646f 7720 3d20 696e 7428 286c 656e 286b  dow = int((len(k
+00056fe0: 6572 6e65 6c29 202b 2031 2920 2f20 3229  ernel) + 1) / 2)
+00056ff0: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
+00057000: 6578 6573 203d 2072 616e 6765 282d 6861  exes = range(-ha
+00057010: 6c66 5f77 696e 646f 772c 206c 656e 2873  lf_window, len(s
+00057020: 6967 6e61 6c29 202d 2068 616c 665f 7769  ignal) - half_wi
+00057030: 6e64 6f77 290a 2020 2020 2020 2020 2020  ndow).          
+00057040: 2020 6f72 6967 5f63 6f6e 7620 3d20 6e70    orig_conv = np
+00057050: 2e72 6561 6c28 6666 742e 6966 6674 2866  .real(fft.ifft(f
+00057060: 6674 2e66 6674 2873 6967 6e61 6c29 202a  ft.fft(signal) *
+00057070: 2066 6674 2e66 6674 286e 702e 725f 5b6e   fft.fft(np.r_[n
+00057080: 702e 7a65 726f 7328 7061 6429 2c20 6b65  p.zeros(pad), ke
+00057090: 726e 656c 5d29 2929 0a20 2020 2020 2020  rnel]))).       
+000570a0: 2020 2020 2072 6574 7572 6e20 6f72 6967       return orig
+000570b0: 5f63 6f6e 762e 7461 6b65 2869 6e64 6578  _conv.take(index
+000570c0: 6573 2c20 6d6f 6465 3d27 7772 6170 2729  es, mode='wrap')
+000570d0: 0a0a 2020 2020 2020 2020 2320 436f 6e76  ..        # Conv
+000570e0: 6f6c 7665 2070 6772 616d 2077 6974 6820  olve pgram with 
+000570f0: 6b65 726e 656c 2077 6974 6820 6369 7263  kernel with circ
+00057100: 756c 6172 2063 6f6e 760a 2020 2020 2020  ular conv.      
+00057110: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+00057120: 286e 7365 7229 3a0a 2020 2020 2020 2020  (nser):.        
+00057130: 2020 2020 666f 7220 6a20 696e 2072 616e      for j in ran
+00057140: 6765 286e 7365 7229 3a0a 2020 2020 2020  ge(nser):.      
+00057150: 2020 2020 2020 2020 2020 7067 7261 6d5b            pgram[
+00057160: 3a2c 2069 2c20 6a5d 203d 2063 6f6e 765f  :, i, j] = conv_
+00057170: 6369 7263 756c 6172 2870 6772 616d 5b3a  circular(pgram[:
+00057180: 2c20 692c 206a 5d2c 206b 6572 6e65 6c29  , i, j], kernel)
+00057190: 0a0a 2020 2020 2020 2020 6466 203d 2032  ..        df = 2
+000571a0: 202f 206e 702e 7375 6d28 6b65 726e 656c   / np.sum(kernel
+000571b0: 2a2a 3229 0a20 2020 2020 2020 206d 203d  **2).        m =
+000571c0: 2028 6c65 6e28 6b65 726e 656c 2920 2d20   (len(kernel) - 
+000571d0: 3129 2f32 0a20 2020 2020 2020 206b 203d  1)/2.        k =
+000571e0: 206e 702e 6172 616e 6765 282d 6d2c 206d   np.arange(-m, m
+000571f0: 2b31 290a 2020 2020 2020 2020 6261 6e64  +1).        band
+00057200: 7769 6474 6820 3d20 6e70 2e73 7172 7428  width = np.sqrt(
+00057210: 6e70 2e73 756d 2828 312f 3132 202b 206b  np.sum((1/12 + k
+00057220: 2a2a 3229 202a 206b 6572 6e65 6c29 290a  **2) * kernel)).
+00057230: 0a20 2020 2064 6620 3d20 6466 2f28 7534  .    df = df/(u4
+00057240: 2f75 322a 2a32 292a 284e 302f 4e29 0a20  /u2**2)*(N0/N). 
+00057250: 2020 2062 616e 6477 6964 7468 203d 2062     bandwidth = b
+00057260: 616e 6477 6964 7468 202a 2078 6672 6571  andwidth * xfreq
+00057270: 2f4e 0a0a 2020 2020 2320 5265 6d6f 7665  /N..    # Remove
+00057280: 2070 6164 6465 6420 7265 7375 6c74 730a   padded results.
+00057290: 2020 2020 7067 7261 6d20 3d20 7067 7261      pgram = pgra
+000572a0: 6d5b 313a 284e 7370 6563 2b31 292c 203a  m[1:(Nspec+1), :
+000572b0: 2c20 3a5d 0a0a 2020 2020 7370 6563 203d  , :]..    spec =
+000572c0: 206e 702e 656d 7074 7928 284e 7370 6563   np.empty((Nspec
+000572d0: 2c20 6e73 6572 2929 0a20 2020 2066 6f72  , nser)).    for
+000572e0: 2069 2069 6e20 7261 6e67 6528 6e73 6572   i in range(nser
+000572f0: 293a 0a20 2020 2020 2020 2073 7065 635b  ):.        spec[
+00057300: 3a2c 2069 5d20 3d20 6e70 2e72 6561 6c28  :, i] = np.real(
+00057310: 7067 7261 6d5b 3a2c 2069 2c20 695d 290a  pgram[:, i, i]).
+00057320: 0a20 2020 2069 6620 6e73 6572 203d 3d20  .    if nser == 
+00057330: 313a 0a20 2020 2020 2020 2063 6f68 203d  1:.        coh =
+00057340: 204e 6f6e 650a 2020 2020 2020 2020 7068   None.        ph
+00057350: 6173 6520 3d20 4e6f 6e65 0a20 2020 2065  ase = None.    e
+00057360: 6c73 653a 0a20 2020 2020 2020 2063 6f68  lse:.        coh
+00057370: 203d 206e 702e 656d 7074 7928 284e 7370   = np.empty((Nsp
+00057380: 6563 2c20 696e 7428 6e73 6572 202a 2028  ec, int(nser * (
+00057390: 6e73 6572 202d 2031 292f 3229 2929 0a20  nser - 1)/2))). 
+000573a0: 2020 2020 2020 2070 6861 7365 203d 206e         phase = n
+000573b0: 702e 656d 7074 7928 284e 7370 6563 2c20  p.empty((Nspec, 
+000573c0: 696e 7428 6e73 6572 202a 2028 6e73 6572  int(nser * (nser
+000573d0: 202d 2031 292f 3229 2929 0a20 2020 2020   - 1)/2))).     
+000573e0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+000573f0: 6528 6e73 6572 293a 0a20 2020 2020 2020  e(nser):.       
+00057400: 2020 2020 2066 6f72 206a 2069 6e20 7261       for j in ra
+00057410: 6e67 6528 692b 312c 206e 7365 7229 3a0a  nge(i+1, nser):.
+00057420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00057430: 696e 6465 7820 3d20 696e 7428 6920 2b20  index = int(i + 
+00057440: 6a2a 286a 2d31 292f 3229 0a20 2020 2020  j*(j-1)/2).     
+00057450: 2020 2020 2020 2020 2020 2063 6f68 5b3a             coh[:
+00057460: 2c20 696e 6465 785d 203d 206e 702e 6162  , index] = np.ab
+00057470: 7328 7067 7261 6d5b 3a2c 2069 2c20 6a5d  s(pgram[:, i, j]
+00057480: 292a 2a32 202f 2028 7370 6563 5b3a 2c20  )**2 / (spec[:, 
+00057490: 695d 202a 2073 7065 635b 3a2c 206a 5d29  i] * spec[:, j])
+000574a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000574b0: 2070 6861 7365 5b3a 2c20 696e 6465 785d   phase[:, index]
+000574c0: 203d 206e 702e 616e 676c 6528 7067 7261   = np.angle(pgra
+000574d0: 6d5b 3a2c 2069 2c20 6a5d 290a 0a20 2020  m[:, i, j])..   
+000574e0: 2073 7065 6320 3d20 7370 6563 202f 2075   spec = spec / u
+000574f0: 320a 2020 2020 7370 6563 203d 2073 7065  2.    spec = spe
+00057500: 632e 7371 7565 657a 6528 290a 0a20 2020  c.squeeze()..   
+00057510: 2072 6573 756c 7473 203d 207b 0a20 2020   results = {.   
+00057520: 2020 2020 2027 6672 6571 273a 2066 7265       'freq': fre
+00057530: 712c 0a20 2020 2020 2020 2027 7370 6563  q,.        'spec
+00057540: 273a 2073 7065 632c 0a20 2020 2020 2020  ': spec,.       
+00057550: 2027 636f 6827 3a20 636f 682c 0a20 2020   'coh': coh,.   
+00057560: 2020 2020 2027 7068 6173 6527 3a20 7068       'phase': ph
+00057570: 6173 652c 0a20 2020 2020 2020 2027 6b65  ase,.        'ke
+00057580: 726e 656c 273a 206b 6572 6e65 6c2c 0a20  rnel': kernel,. 
+00057590: 2020 2020 2020 2027 6466 273a 2064 662c         'df': df,
+000575a0: 0a20 2020 2020 2020 2027 6261 6e64 7769  .        'bandwi
+000575b0: 6474 6827 3a20 6261 6e64 7769 6474 682c  dth': bandwidth,
+000575c0: 0a20 2020 2020 2020 2027 6e2e 7573 6564  .        'n.used
+000575d0: 273a 204e 2c0a 2020 2020 2020 2020 276f  ': N,.        'o
+000575e0: 7269 672e 6e27 3a20 4e30 2c0a 2020 2020  rig.n': N0,.    
+000575f0: 2020 2020 2774 6170 6572 273a 2074 6170      'taper': tap
+00057600: 6572 2c0a 2020 2020 2020 2020 2770 6164  er,.        'pad
+00057610: 273a 2070 6164 2c0a 2020 2020 2020 2020  ': pad,.        
+00057620: 2764 6574 7265 6e64 273a 2064 6574 7265  'detrend': detre
+00057630: 6e64 2c0a 2020 2020 2020 2020 2764 656d  nd,.        'dem
+00057640: 6561 6e27 3a20 6465 6d65 616e 2c0a 2020  ean': demean,.  
+00057650: 2020 2020 2020 276d 6574 686f 6427 3a20        'method': 
+00057660: 2752 6177 2050 6572 696f 646f 6772 616d  'Raw Periodogram
+00057670: 2720 6966 206b 6572 6e65 6c20 6973 204e  ' if kernel is N
+00057680: 6f6e 6520 656c 7365 2027 536d 6f6f 7468  one else 'Smooth
+00057690: 6564 2050 6572 696f 646f 6772 616d 270a  ed Periodogram'.
+000576a0: 2020 2020 7d0a 0a20 2020 2069 6620 706c      }..    if pl
+000576b0: 6f74 3a0a 2020 2020 2020 2020 706c 6f74  ot:.        plot
+000576c0: 5f73 7065 6328 7265 7375 6c74 732c 2063  _spec(results, c
+000576d0: 6f76 6572 6167 653d 302e 3935 2c20 2a2a  overage=0.95, **
+000576e0: 6b77 6172 6773 290a 0a20 2020 2072 6574  kwargs)..    ret
+000576f0: 7572 6e20 7265 7375 6c74 730a 0a64 6566  urn results..def
+00057700: 2061 6c66 666d 6170 2820 782c 2066 6c6f   alffmap( x, flo
+00057710: 3d30 2e30 312c 2066 6869 3d30 2e31 2c20  =0.01, fhi=0.1, 
+00057720: 7472 3d31 2c20 6465 7472 656e 6420 3d20  tr=1, detrend = 
+00057730: 5472 7565 2029 3a0a 2020 2020 2222 220a  True ):.    """.
+00057740: 2020 2020 416d 706c 6974 7564 6520 6f66      Amplitude of
+00057750: 204c 6f77 2046 7265 7175 656e 6379 2046   Low Frequency F
+00057760: 6c75 6374 7561 7469 6f6e 7320 2841 4c46  luctuations (ALF
+00057770: 463b 205a 616e 6720 6574 2061 6c2e 2c20  F; Zang et al., 
+00057780: 3230 3037 2920 616e 640a 2020 2020 6672  2007) and.    fr
+00057790: 6163 7469 6f6e 616c 2041 6d70 6c69 7475  actional Amplitu
+000577a0: 6465 206f 6620 4c6f 7720 4672 6571 7565  de of Low Freque
+000577b0: 6e63 7920 466c 7563 7475 6174 696f 6e73  ncy Fluctuations
+000577c0: 2028 662f 414c 4646 3b20 5a6f 7520 6574   (f/ALFF; Zou et
+000577d0: 2061 6c2e 2c20 3230 3038 290a 2020 2020   al., 2008).    
+000577e0: 6172 6520 7265 6c61 7465 6420 6d65 6173  are related meas
+000577f0: 7572 6573 2074 6861 7420 7175 616e 7469  ures that quanti
+00057800: 6679 2074 6865 2061 6d70 6c69 7475 6465  fy the amplitude
+00057810: 206f 6620 6c6f 7720 6672 6571 7565 6e63   of low frequenc
+00057820: 790a 2020 2020 6f73 6369 6c6c 6174 696f  y.    oscillatio
+00057830: 6e73 2028 4c46 4f73 292e 2020 5468 6973  ns (LFOs).  This
+00057840: 2066 756e 6374 696f 6e20 6f75 7470 7574   function output
+00057850: 7320 414c 4646 2061 6e64 2066 414c 4646  s ALFF and fALFF
+00057860: 2066 6f72 2074 6865 2069 6e70 7574 2e0a   for the input..
+00057870: 2020 2020 7361 6d65 2066 756e 6374 696f      same functio
+00057880: 6e20 696e 2041 4e54 7352 2e0a 0a20 2020  n in ANTsR...   
+00057890: 2078 2069 6e70 7574 2076 6563 746f 7220   x input vector 
+000578a0: 666f 7220 7468 6520 7469 6d65 2073 6572  for the time ser
+000578b0: 6965 7320 6f66 2069 6e74 6572 6573 740a  ies of interest.
+000578c0: 2020 2020 666c 6f20 6c6f 7720 6672 6571      flo low freq
+000578d0: 7565 6e63 792c 2074 7970 6963 616c 6c79  uency, typically
+000578e0: 2030 2e30 310a 2020 2020 6668 6920 6869   0.01.    fhi hi
+000578f0: 6768 2066 7265 7175 656e 6379 2c20 7479  gh frequency, ty
+00057900: 7069 6361 6c6c 7920 302e 310a 2020 2020  pically 0.1.    
+00057910: 7472 2074 6865 2070 6572 696f 6420 6173  tr the period as
+00057920: 736f 6369 6174 6564 2077 6974 6820 7468  sociated with th
+00057930: 6520 7665 6374 6f72 2078 2028 696e 7665  e vector x (inve
+00057940: 7273 6520 6f66 2066 7265 7175 656e 6379  rse of frequency
+00057950: 290a 2020 2020 6465 7472 656e 6420 6465  ).    detrend de
+00057960: 7472 656e 6420 7468 6520 696e 7075 7420  trend the input 
+00057970: 7469 6d65 2073 6572 6965 730a 0a20 2020  time series..   
+00057980: 2072 6574 7572 6e20 7665 6374 6f72 2069   return vector i
+00057990: 7320 6f75 7470 7574 2073 686f 7769 6e67  s output showing
+000579a0: 2041 4c46 4620 616e 6420 6641 4c46 4620   ALFF and fALFF 
+000579b0: 7661 6c75 6573 0a20 2020 2022 2222 0a20  values.    """. 
+000579c0: 2020 2074 656d 7020 3d20 7370 6563 5f70     temp = spec_p
+000579d0: 6772 616d 2820 782c 2078 6672 6571 3d31  gram( x, xfreq=1
+000579e0: 2e30 2f74 722c 2064 656d 6561 6e3d 4661  .0/tr, demean=Fa
+000579f0: 6c73 652c 2064 6574 7265 6e64 3d64 6574  lse, detrend=det
+00057a00: 7265 6e64 2c20 7461 7065 723d 302c 2066  rend, taper=0, f
+00057a10: 6173 743d 5472 7565 2c20 706c 6f74 3d46  ast=True, plot=F
+00057a20: 616c 7365 2029 0a20 2020 2066 7365 6c65  alse ).    fsele
+00057a30: 6374 203d 206e 702e 6c6f 6769 6361 6c5f  ct = np.logical_
+00057a40: 616e 6428 2074 656d 705b 2766 7265 7127  and( temp['freq'
+00057a50: 5d20 3e3d 2066 6c6f 2c20 7465 6d70 5b27  ] >= flo, temp['
+00057a60: 6672 6571 275d 203c 3d20 6668 6920 290a  freq'] <= fhi ).
+00057a70: 2020 2020 6465 6e6f 6d20 3d20 2874 656d      denom = (tem
+00057a80: 705b 2773 7065 6327 5d29 2e73 756d 2829  p['spec']).sum()
+00057a90: 0a20 2020 206e 756d 6572 203d 2028 7465  .    numer = (te
+00057aa0: 6d70 5b27 7370 6563 275d 5b66 7365 6c65  mp['spec'][fsele
+00057ab0: 6374 5d29 2e73 756d 2829 0a20 2020 2072  ct]).sum().    r
+00057ac0: 6574 7572 6e20 7b20 2027 616c 6666 273a  eturn {  'alff':
+00057ad0: 6e75 6d65 722c 2027 6661 6c66 6627 3a20  numer, 'falff': 
+00057ae0: 6e75 6d65 722f 6465 6e6f 6d20 7d0a 0a0a  numer/denom }...
+00057af0: 6465 6620 616c 6666 5f69 6d61 6765 2820  def alff_image( 
+00057b00: 782c 206d 6173 6b2c 2066 6c6f 3d30 2e30  x, mask, flo=0.0
+00057b10: 312c 2066 6869 3d30 2e31 2c20 6e75 6973  1, fhi=0.1, nuis
+00057b20: 616e 6365 3d4e 6f6e 6520 293a 0a20 2020  ance=None ):.   
+00057b30: 2022 2222 0a20 2020 2041 6d70 6c69 7475   """.    Amplitu
+00057b40: 6465 206f 6620 4c6f 7720 4672 6571 7565  de of Low Freque
+00057b50: 6e63 7920 466c 7563 7475 6174 696f 6e73  ncy Fluctuations
+00057b60: 2028 414c 4646 3b20 5a61 6e67 2065 7420   (ALFF; Zang et 
+00057b70: 616c 2e2c 2032 3030 3729 2061 6e64 0a20  al., 2007) and. 
+00057b80: 2020 2066 7261 6374 696f 6e61 6c20 416d     fractional Am
+00057b90: 706c 6974 7564 6520 6f66 204c 6f77 2046  plitude of Low F
+00057ba0: 7265 7175 656e 6379 2046 6c75 6374 7561  requency Fluctua
+00057bb0: 7469 6f6e 7320 2866 2f41 4c46 463b 205a  tions (f/ALFF; Z
+00057bc0: 6f75 2065 7420 616c 2e2c 2032 3030 3829  ou et al., 2008)
+00057bd0: 0a20 2020 2061 7265 2072 656c 6174 6564  .    are related
+00057be0: 206d 6561 7375 7265 7320 7468 6174 2071   measures that q
+00057bf0: 7561 6e74 6966 7920 7468 6520 616d 706c  uantify the ampl
+00057c00: 6974 7564 6520 6f66 206c 6f77 2066 7265  itude of low fre
+00057c10: 7175 656e 6379 0a20 2020 206f 7363 696c  quency.    oscil
+00057c20: 6c61 7469 6f6e 7320 284c 464f 7329 2e20  lations (LFOs). 
+00057c30: 2054 6869 7320 6675 6e63 7469 6f6e 206f   This function o
+00057c40: 7574 7075 7473 2041 4c46 4620 616e 6420  utputs ALFF and 
+00057c50: 6641 4c46 4620 666f 7220 7468 6520 696e  fALFF for the in
+00057c60: 7075 742e 0a0a 2020 2020 7820 2d20 696e  put...    x - in
+00057c70: 7075 7420 636c 6561 6e20 7265 7374 696e  put clean restin
+00057c80: 6720 7374 6174 6520 666d 7269 0a20 2020  g state fmri.   
+00057c90: 206d 6173 6b20 2d20 6d61 736b 206f 7665   mask - mask ove
+00057ca0: 7220 7768 6963 6820 746f 2063 6f6d 7075  r which to compu
+00057cb0: 7465 2066 2f61 6c66 660a 2020 2020 666c  te f/alff.    fl
+00057cc0: 6f20 2d20 6c6f 7720 6672 6571 7565 6e63  o - low frequenc
+00057cd0: 792c 2074 7970 6963 616c 6c79 2030 2e30  y, typically 0.0
+00057ce0: 310a 2020 2020 6668 6920 2d20 6869 6768  1.    fhi - high
+00057cf0: 2066 7265 7175 656e 6379 2c20 7479 7069   frequency, typi
+00057d00: 6361 6c6c 7920 302e 310a 2020 2020 6e75  cally 0.1.    nu
+00057d10: 6973 616e 6365 202d 206f 7074 696f 6e61  isance - optiona
+00057d20: 6c20 6e75 6973 616e 6365 206d 6174 7269  l nuisance matri
+00057d30: 780a 0a20 2020 2072 6574 7572 6e20 6469  x..    return di
+00057d40: 6374 696f 6e61 7279 2077 6974 6820 414c  ctionary with AL
+00057d50: 4646 2061 6e64 2066 414c 4646 2069 6d61  FF and fALFF ima
+00057d60: 6765 730a 2020 2020 2222 220a 2020 2020  ges.    """.    
+00057d70: 786d 6174 203d 2061 6e74 732e 7469 6d65  xmat = ants.time
+00057d80: 7365 7269 6573 5f74 6f5f 6d61 7472 6978  series_to_matrix
+00057d90: 2820 782c 206d 6173 6b20 290a 2020 2020  ( x, mask ).    
+00057da0: 6966 206e 7569 7361 6e63 6520 6973 206e  if nuisance is n
+00057db0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00057dc0: 2078 6d61 7420 3d20 616e 7473 2e72 6567   xmat = ants.reg
+00057dd0: 7265 7373 5f63 6f6d 706f 6e65 6e74 7328  ress_components(
+00057de0: 2078 6d61 742c 206e 7569 7361 6e63 6520   xmat, nuisance 
+00057df0: 290a 2020 2020 616c 6666 7665 6320 3d20  ).    alffvec = 
+00057e00: 786d 6174 5b30 2c3a 5d2a 300a 2020 2020  xmat[0,:]*0.    
+00057e10: 6661 6c66 6676 6563 203d 2078 6d61 745b  falffvec = xmat[
+00057e20: 302c 3a5d 2a30 0a20 2020 206d 7974 7220  0,:]*0.    mytr 
+00057e30: 3d20 616e 7473 2e67 6574 5f73 7061 6369  = ants.get_spaci
+00057e40: 6e67 2820 7820 295b 335d 0a20 2020 2066  ng( x )[3].    f
+00057e50: 6f72 206e 2069 6e20 7261 6e67 6528 2078  or n in range( x
+00057e60: 6d61 742e 7368 6170 655b 315d 2029 3a0a  mat.shape[1] ):.
+00057e70: 2020 2020 2020 2020 7465 6d70 203d 2061          temp = a
+00057e80: 6c66 666d 6170 2820 786d 6174 5b3a 2c6e  lffmap( xmat[:,n
+00057e90: 5d2c 2066 6c6f 3d66 6c6f 2c20 6668 693d  ], flo=flo, fhi=
+00057ea0: 6668 692c 2074 723d 6d79 7472 2029 0a20  fhi, tr=mytr ). 
+00057eb0: 2020 2020 2020 2061 6c66 6676 6563 5b6e         alffvec[n
+00057ec0: 5d3d 7465 6d70 5b27 616c 6666 275d 0a20  ]=temp['alff']. 
+00057ed0: 2020 2020 2020 2066 616c 6666 7665 635b         falffvec[
+00057ee0: 6e5d 3d74 656d 705b 2766 616c 6666 275d  n]=temp['falff']
+00057ef0: 0a20 2020 2061 6c66 6669 3d61 6e74 732e  .    alffi=ants.
+00057f00: 6d61 6b65 5f69 6d61 6765 2820 6d61 736b  make_image( mask
+00057f10: 2c20 616c 6666 7665 6320 290a 2020 2020  , alffvec ).    
+00057f20: 6661 6c66 6669 3d61 6e74 732e 6d61 6b65  falffi=ants.make
+00057f30: 5f69 6d61 6765 2820 6d61 736b 2c20 6661  _image( mask, fa
+00057f40: 6c66 6676 6563 2029 0a20 2020 2061 6c66  lffvec ).    alf
+00057f50: 6674 7269 6d6d 6564 6d65 616e 203d 2063  ftrimmedmean = c
+00057f60: 616c 6375 6c61 7465 5f74 7269 6d6d 6564  alculate_trimmed
+00057f70: 5f6d 6561 6e28 2061 6c66 6676 6563 2c20  _mean( alffvec, 
+00057f80: 302e 3031 2029 0a20 2020 2066 616c 6666  0.01 ).    falff
+00057f90: 7472 696d 6d65 646d 6561 6e20 3d20 6361  trimmedmean = ca
+00057fa0: 6c63 756c 6174 655f 7472 696d 6d65 645f  lculate_trimmed_
+00057fb0: 6d65 616e 2820 6661 6c66 6676 6563 2c20  mean( falffvec, 
+00057fc0: 302e 3031 2029 0a20 2020 2061 6c66 6669  0.01 ).    alffi
+00057fd0: 3d61 6c66 6669 202f 2061 6c66 6674 7269  =alffi / alfftri
+00057fe0: 6d6d 6564 6d65 616e 0a20 2020 2066 616c  mmedmean.    fal
+00057ff0: 6666 693d 6661 6c66 6669 202f 2066 616c  ffi=falffi / fal
+00058000: 6666 7472 696d 6d65 646d 6561 6e0a 2020  fftrimmedmean.  
+00058010: 2020 7265 7475 726e 207b 2020 2761 6c66    return {  'alf
+00058020: 6627 3a20 616c 6666 692c 2027 6661 6c66  f': alffi, 'falf
+00058030: 6627 3a20 6661 6c66 6669 207d 0a0a 0a64  f': falffi }...d
+00058040: 6566 2064 6f77 6e32 6973 6f28 2078 2c20  ef down2iso( x, 
+00058050: 696e 7465 7270 6f6c 6174 696f 6e3d 276c  interpolation='l
+00058060: 696e 6561 7227 2c20 7461 6b65 6d69 6e3d  inear', takemin=
+00058070: 4661 6c73 6520 293a 0a20 2020 2022 2222  False ):.    """
+00058080: 0a20 2020 2077 696c 6c20 646f 776e 7361  .    will downsa
+00058090: 6d70 6c65 2061 6e20 616e 6973 6f74 726f  mple an anisotro
+000580a0: 7069 6320 696d 6167 6520 746f 2061 6e20  pic image to an 
+000580b0: 6973 6f74 726f 7069 6320 7265 736f 6c75  isotropic resolu
+000580c0: 7469 6f6e 0a0a 2020 2020 783a 2069 6e70  tion..    x: inp
+000580d0: 7574 2069 6d61 6765 0a0a 2020 2020 696e  ut image..    in
+000580e0: 7465 7270 6f6c 6174 696f 6e3a 206c 696e  terpolation: lin
+000580f0: 6561 7220 6f72 206e 6561 7265 7374 6e65  ear or nearestne
+00058100: 6967 6862 6f72 0a0a 2020 2020 7461 6b65  ighbor..    take
+00058110: 6d69 6e20 3a20 626f 6f6c 6561 6e20 6d61  min : boolean ma
+00058120: 7020 746f 206d 696e 2073 7061 6365 3b20  p to min space; 
+00058130: 6f74 6865 7277 6973 6520 6d61 780a 0a20  otherwise max.. 
+00058140: 2020 2072 6574 7572 6e20 696d 6167 6520     return image 
+00058150: 646f 776e 7361 6d70 6c65 6420 746f 2069  downsampled to i
+00058160: 736f 7472 6f70 6963 2072 6573 6f6c 7574  sotropic resolut
+00058170: 696f 6e0a 2020 2020 2222 220a 2020 2020  ion.    """.    
+00058180: 7370 6320 3d20 616e 7473 2e67 6574 5f73  spc = ants.get_s
+00058190: 7061 6369 6e67 2820 7820 290a 2020 2020  pacing( x ).    
+000581a0: 6966 2074 616b 656d 696e 3a0a 2020 2020  if takemin:.    
+000581b0: 2020 2020 6e65 7773 7063 203d 206e 702e      newspc = np.
+000581c0: 6173 6172 7261 7928 7370 6329 2e6d 696e  asarray(spc).min
+000581d0: 2829 0a20 2020 2065 6c73 653a 0a20 2020  ().    else:.   
+000581e0: 2020 2020 206e 6577 7370 6320 3d20 6e70       newspc = np
+000581f0: 2e61 7361 7272 6179 2873 7063 292e 6d61  .asarray(spc).ma
+00058200: 7828 290a 2020 2020 6e65 7773 7063 203d  x().    newspc =
+00058210: 206e 702e 7265 7065 6174 2820 6e65 7773   np.repeat( news
+00058220: 7063 2c20 782e 6469 6d65 6e73 696f 6e20  pc, x.dimension 
+00058230: 290a 2020 2020 6966 2069 6e74 6572 706f  ).    if interpo
+00058240: 6c61 7469 6f6e 203d 3d20 276c 696e 6561  lation == 'linea
+00058250: 7227 3a0a 2020 2020 2020 2020 7873 203d  r':.        xs =
+00058260: 2061 6e74 732e 7265 7361 6d70 6c65 5f69   ants.resample_i
+00058270: 6d61 6765 2820 782c 206e 6577 7370 632c  mage( x, newspc,
+00058280: 2069 6e74 6572 705f 7479 7065 3d30 290a   interp_type=0).
+00058290: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000582a0: 2020 7873 203d 2061 6e74 732e 7265 7361    xs = ants.resa
+000582b0: 6d70 6c65 5f69 6d61 6765 2820 782c 206e  mple_image( x, n
+000582c0: 6577 7370 632c 2069 6e74 6572 705f 7479  ewspc, interp_ty
+000582d0: 7065 3d31 290a 2020 2020 7265 7475 726e  pe=1).    return
+000582e0: 2078 730a 0a0a 6465 6620 7265 6164 5f6d   xs...def read_m
+000582f0: 6d5f 6373 7628 2078 2c20 6973 5f74 313d  m_csv( x, is_t1=
+00058300: 4661 6c73 652c 2063 6f6c 7072 6566 6978  False, colprefix
+00058310: 3d4e 6f6e 652c 2073 6570 6172 6174 6f72  =None, separator
+00058320: 3d27 2d27 2c20 7665 7262 6f73 653d 4661  ='-', verbose=Fa
+00058330: 6c73 6520 293a 0a20 2020 2073 706c 6974  lse ):.    split
+00058340: 7465 723d 6f73 2e70 6174 682e 6261 7365  ter=os.path.base
+00058350: 6e61 6d65 2878 292e 7370 6c69 7428 2073  name(x).split( s
+00058360: 6570 6172 6174 6f72 2029 0a20 2020 206c  eparator ).    l
+00058370: 656e 7370 6c69 7420 3d20 6c65 6e28 2073  ensplit = len( s
+00058380: 706c 6974 7465 7220 292d 310a 2020 2020  plitter )-1.    
+00058390: 7465 6d70 203d 206f 732e 7061 7468 2e62  temp = os.path.b
+000583a0: 6173 656e 616d 6528 7829 0a20 2020 2074  asename(x).    t
+000583b0: 656d 7020 3d20 6f73 2e70 6174 682e 7370  emp = os.path.sp
+000583c0: 6c69 7465 7874 2874 656d 7029 5b30 5d0a  litext(temp)[0].
+000583d0: 2020 2020 7465 6d70 203d 2072 652e 7375      temp = re.su
+000583e0: 6228 7365 7061 7261 746f 722b 276d 6d77  b(separator+'mmw
+000583f0: 6964 6527 2c27 272c 7465 6d70 290a 2020  ide','',temp).  
+00058400: 2020 6964 636f 6c73 203d 205b 2775 5f68    idcols = ['u_h
+00058410: 6965 725f 6964 272c 2773 6964 272c 2776  ier_id','sid','v
+00058420: 6973 6974 6461 7465 272c 276d 6f64 616c  isitdate','modal
+00058430: 6974 7927 2c27 6d6d 696d 6167 6575 6964  ity','mmimageuid
+00058440: 272c 2774 3169 6d61 6765 7569 6427 5d0a  ','t1imageuid'].
+00058450: 2020 2020 6466 203d 2070 642e 4461 7461      df = pd.Data
+00058460: 4672 616d 6528 2063 6f6c 756d 6e73 203d  Frame( columns =
+00058470: 2069 6463 6f6c 732c 2069 6e64 6578 3d72   idcols, index=r
+00058480: 616e 6765 2831 2920 290a 2020 2020 7661  ange(1) ).    va
+00058490: 6c73 746f 6164 6420 3d20 5b74 656d 705d  lstoadd = [temp]
+000584a0: 202b 2073 706c 6974 7465 725b 313a 286c   + splitter[1:(l
+000584b0: 656e 7370 6c69 742d 3129 5d0a 2020 2020  ensplit-1)].    
+000584c0: 6966 2069 735f 7431 3a0a 2020 2020 2020  if is_t1:.      
+000584d0: 2020 7661 6c73 746f 6164 6420 3d20 7661    valstoadd = va
+000584e0: 6c73 746f 6164 6420 2b20 5b73 706c 6974  lstoadd + [split
+000584f0: 7465 725b 286c 656e 7370 6c69 742d 3129  ter[(lensplit-1)
+00058500: 5d2c 7370 6c69 7474 6572 5b28 6c65 6e73  ],splitter[(lens
+00058510: 706c 6974 2d31 295d 5d0a 2020 2020 656c  plit-1)]].    el
+00058520: 7365 3a0a 2020 2020 2020 2020 7370 6c69  se:.        spli
+00058530: 7432 3d73 706c 6974 7465 725b 286c 656e  t2=splitter[(len
+00058540: 7370 6c69 742d 3129 5d2e 7370 6c69 7428  split-1)].split(
+00058550: 2022 5f22 2029 0a20 2020 2020 2020 2069   "_" ).        i
+00058560: 6620 6c65 6e28 7370 6c69 7432 2920 3d3d  f len(split2) ==
+00058570: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00058580: 7370 6c69 7432 2e61 7070 656e 6428 2073  split2.append( s
+00058590: 706c 6974 325b 305d 2029 0a20 2020 2020  plit2[0] ).     
+000585a0: 2020 2069 6620 6c65 6e28 7661 6c73 746f     if len(valsto
+000585b0: 6164 6429 203d 3d20 333a 0a20 2020 2020  add) == 3:.     
+000585c0: 2020 2020 2020 2076 616c 7374 6f61 6464         valstoadd
+000585d0: 203d 2076 616c 7374 6f61 6464 202b 205b   = valstoadd + [
+000585e0: 7370 6c69 7432 5b30 5d5d 202b 205b 6d61  split2[0]] + [ma
+000585f0: 7468 2e6e 616e 5d20 2b20 5b73 706c 6974  th.nan] + [split
+00058600: 325b 315d 5d0a 2020 2020 2020 2020 656c  2[1]].        el
+00058610: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00058620: 7661 6c73 746f 6164 6420 3d20 7661 6c73  valstoadd = vals
+00058630: 746f 6164 6420 2b20 5b73 706c 6974 325b  toadd + [split2[
+00058640: 305d 2c73 706c 6974 325b 315d 5d0a 2020  0],split2[1]].  
+00058650: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+00058660: 2020 2020 2020 7072 696e 7428 2076 616c        print( val
+00058670: 7374 6f61 6464 2029 0a20 2020 2064 662e  stoadd ).    df.
+00058680: 696c 6f63 5b30 5d20 3d20 7661 6c73 746f  iloc[0] = valsto
+00058690: 6164 640a 2020 2020 6966 2076 6572 626f  add.    if verbo
+000586a0: 7365 3a0a 2020 2020 2020 2020 7072 696e  se:.        prin
+000586b0: 7428 2022 7265 6164 2078 6466 3a20 2220  t( "read xdf: " 
+000586c0: 2b20 7820 290a 2020 2020 7864 6620 3d20  + x ).    xdf = 
+000586d0: 7064 2e72 6561 645f 6373 7628 2078 2029  pd.read_csv( x )
+000586e0: 0a20 2020 2064 662e 7265 7365 745f 696e  .    df.reset_in
+000586f0: 6465 7828 290a 2020 2020 7864 662e 7265  dex().    xdf.re
+00058700: 7365 745f 696e 6465 7828 6472 6f70 3d54  set_index(drop=T
+00058710: 7275 6529 0a20 2020 2069 6620 2255 6e6e  rue).    if "Unn
+00058720: 616d 6564 3a20 3022 2069 6e20 7864 662e  amed: 0" in xdf.
+00058730: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
+00058740: 2068 6f6c 6465 723d 7864 662e 706f 7028   holder=xdf.pop(
+00058750: 2022 556e 6e61 6d65 643a 2030 2220 290a   "Unnamed: 0" ).
+00058760: 2020 2020 6966 2022 556e 6e61 6d65 643a      if "Unnamed:
+00058770: 2031 2220 696e 2078 6466 2e63 6f6c 756d   1" in xdf.colum
+00058780: 6e73 3a0a 2020 2020 2020 2020 686f 6c64  ns:.        hold
+00058790: 6572 3d78 6466 2e70 6f70 2820 2255 6e6e  er=xdf.pop( "Unn
+000587a0: 616d 6564 3a20 3122 2029 0a20 2020 2069  amed: 1" ).    i
+000587b0: 6620 2275 5f68 6965 725f 6964 2e31 2220  f "u_hier_id.1" 
+000587c0: 696e 2078 6466 2e63 6f6c 756d 6e73 3a0a  in xdf.columns:.
+000587d0: 2020 2020 2020 2020 686f 6c64 6572 3d78          holder=x
+000587e0: 6466 2e70 6f70 2820 2275 5f68 6965 725f  df.pop( "u_hier_
+000587f0: 6964 2e31 2220 290a 2020 2020 6966 2022  id.1" ).    if "
+00058800: 755f 6869 6572 5f69 6422 2069 6e20 7864  u_hier_id" in xd
+00058810: 662e 636f 6c75 6d6e 733a 0a20 2020 2020  f.columns:.     
+00058820: 2020 2068 6f6c 6465 723d 7864 662e 706f     holder=xdf.po
+00058830: 7028 2022 755f 6869 6572 5f69 6422 2029  p( "u_hier_id" )
+00058840: 0a20 2020 2069 6620 6e6f 7420 6973 5f74  .    if not is_t
+00058850: 313a 0a20 2020 2020 2020 2069 6620 2772  1:.        if 'r
+00058860: 6573 6e65 7447 7261 6465 2720 696e 2078  esnetGrade' in x
+00058870: 6466 2e63 6f6c 756d 6e73 3a0a 2020 2020  df.columns:.    
+00058880: 2020 2020 2020 2020 696e 6465 785f 6e6f          index_no
+00058890: 203d 2078 6466 2e63 6f6c 756d 6e73 2e67   = xdf.columns.g
+000588a0: 6574 5f6c 6f63 2827 7265 736e 6574 4772  et_loc('resnetGr
+000588b0: 6164 6527 290a 2020 2020 2020 2020 2020  ade').          
+000588c0: 2020 7864 6620 3d20 7864 662e 6472 6f70    xdf = xdf.drop
+000588d0: 2820 7864 662e 636f 6c75 6d6e 735b 7261  ( xdf.columns[ra
+000588e0: 6e67 6528 696e 6465 785f 6e6f 2b31 295d  nge(index_no+1)]
+000588f0: 202c 2061 7869 733d 3129 0a0a 2020 2020   , axis=1)..    
+00058900: 6966 2078 6466 2e73 6861 7065 5b30 5d20  if xdf.shape[0] 
+00058910: 3d3d 2032 3a0a 2020 2020 2020 2020 7864  == 2:.        xd
+00058920: 6663 6f6c 7320 3d20 7864 662e 636f 6c75  fcols = xdf.colu
+00058930: 6d6e 730a 2020 2020 2020 2020 7864 6620  mns.        xdf 
+00058940: 3d20 7864 662e 696c 6f63 5b31 5d0a 2020  = xdf.iloc[1].  
+00058950: 2020 2020 2020 6464 6e75 6d20 3d20 7864        ddnum = xd
+00058960: 662e 746f 5f6e 756d 7079 2829 0a20 2020  f.to_numpy().   
+00058970: 2020 2020 2064 646e 756d 203d 2064 646e       ddnum = ddn
+00058980: 756d 2e72 6573 6861 7065 285b 312c 6464  um.reshape([1,dd
+00058990: 6e75 6d2e 7368 6170 655b 305d 5d29 0a20  num.shape[0]]). 
+000589a0: 2020 2020 2020 206e 6577 636f 6c6e 616d         newcolnam
+000589b0: 6573 203d 2078 6466 2e69 6e64 6578 2e74  es = xdf.index.t
+000589c0: 6f5f 6c69 7374 2829 0a20 2020 2020 2020  o_list().       
+000589d0: 2069 6620 6c65 6e28 6e65 7763 6f6c 6e61   if len(newcolna
+000589e0: 6d65 7329 2021 3d20 6464 6e75 6d2e 7368  mes) != ddnum.sh
+000589f0: 6170 655b 315d 3a0a 2020 2020 2020 2020  ape[1]:.        
+00058a00: 2020 2020 7072 696e 7428 2243 616e 6e6f      print("Canno
+00058a10: 7420 4d65 7267 6520 3a20 5368 6170 6520  t Merge : Shape 
+00058a20: 4d69 734d 6174 6368 2022 202b 2073 7472  MisMatch " + str
+00058a30: 2820 6c65 6e28 6e65 7763 6f6c 6e61 6d65  ( len(newcolname
+00058a40: 7329 2029 202b 2022 2022 202b 2073 7472  s) ) + " " + str
+00058a50: 2864 646e 756d 2e73 6861 7065 5b31 5d29  (ddnum.shape[1])
+00058a60: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00058a70: 2020 2020 2020 2020 2020 2020 7864 6620              xdf 
+00058a80: 3d20 7064 2e44 6174 6146 7261 6d65 2864  = pd.DataFrame(d
+00058a90: 646e 756d 2c20 636f 6c75 6d6e 733d 7864  dnum, columns=xd
+00058aa0: 6663 6f6c 7320 290a 2020 2020 6966 2078  fcols ).    if x
+00058ab0: 6466 2e73 6861 7065 5b31 5d20 3d3d 2030  df.shape[1] == 0
+00058ac0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00058ad0: 204e 6f6e 650a 2020 2020 6966 2063 6f6c   None.    if col
+00058ae0: 7072 6566 6978 2069 7320 6e6f 7420 4e6f  prefix is not No
+00058af0: 6e65 3a0a 2020 2020 2020 2020 7864 662e  ne:.        xdf.
+00058b00: 636f 6c75 6d6e 733d 636f 6c70 7265 6669  columns=colprefi
+00058b10: 7820 2b20 7864 662e 636f 6c75 6d6e 730a  x + xdf.columns.
+00058b20: 2020 2020 7265 7475 726e 2070 642e 636f      return pd.co
+00058b30: 6e63 6174 2820 5b64 662c 7864 665d 2c20  ncat( [df,xdf], 
+00058b40: 6178 6973 3d31 2c20 6967 6e6f 7265 5f69  axis=1, ignore_i
+00058b50: 6e64 6578 3d46 616c 7365 2029 0a0a 6465  ndex=False )..de
+00058b60: 6620 6d65 7267 655f 7769 6465 735f 746f  f merge_wides_to
+00058b70: 5f73 7475 6479 5f64 6174 6166 7261 6d65  _study_dataframe
+00058b80: 2820 7364 662c 2070 726f 6365 7373 696e  ( sdf, processin
+00058b90: 675f 6469 722c 2073 6570 6172 6174 6f72  g_dir, separator
+00058ba0: 3d27 2d27 2c20 7369 645f 6973 5f69 6e74  ='-', sid_is_int
+00058bb0: 3d54 7275 652c 2069 645f 6973 5f69 6e74  =True, id_is_int
+00058bc0: 3d54 7275 652c 2064 6174 655f 6973 5f69  =True, date_is_i
+00058bd0: 6e74 3d54 7275 652c 2072 6570 6f72 745f  nt=True, report_
+00058be0: 6d69 7373 696e 673d 4661 6c73 652c 0a70  missing=False,.p
+00058bf0: 726f 6772 6573 733d 4661 6c73 652c 2076  rogress=False, v
+00058c00: 6572 626f 7365 3d46 616c 7365 2029 3a0a  erbose=False ):.
+00058c10: 2020 2020 2222 220a 2020 2020 6578 7465      """.    exte
+00058c20: 6e64 2061 2073 7475 6479 2064 6174 6120  nd a study data 
+00058c30: 6672 616d 6520 7769 7468 2077 6964 6520  frame with wide 
+00058c40: 6f75 7470 7574 730a 0a20 2020 2073 6466  outputs..    sdf
+00058c50: 203a 2074 6865 2069 6e70 7574 2073 7475   : the input stu
+00058c60: 6479 2064 6174 6166 7261 6d65 2066 726f  dy dataframe fro
+00058c70: 6d20 616e 7473 7079 6d6d 2051 4320 6f75  m antspymm QC ou
+00058c80: 7470 7574 0a0a 2020 2020 7072 6f63 6573  tput..    proces
+00058c90: 7369 6e67 5f64 6972 3a20 2074 6865 2064  sing_dir:  the d
+00058ca0: 6972 6563 746f 7279 206c 6f63 6174 696f  irectory locatio
+00058cb0: 6e20 6f66 2074 6865 2070 726f 6365 7373  n of the process
+00058cc0: 6564 2064 6174 6120 0a0a 2020 2020 7365  ed data ..    se
+00058cd0: 7061 7261 746f 7220 3a20 7374 7269 6e67  parator : string
+00058ce0: 2075 7375 616c 6c79 2027 2d27 206f 7220   usually '-' or 
+00058cf0: 275f 270a 0a20 2020 2073 6964 5f69 735f  '_'..    sid_is_
+00058d00: 696e 7420 3a20 626f 6f6c 6561 6e20 7365  int : boolean se
+00058d10: 7420 746f 2054 7275 6520 746f 2063 6173  t to True to cas
+00058d20: 7420 756e 6971 7565 2073 7562 6a65 6374  t unique subject
+00058d30: 2069 6473 2074 6f20 696e 743b 2063 616e   ids to int; can
+00058d40: 2062 6520 7573 6566 756c 2069 6620 7468   be useful if th
+00058d50: 6579 2061 7265 2069 6e61 6476 6572 7465  ey are inadverte
+00058d60: 6e74 6c79 2073 746f 7265 6420 6173 2066  ntly stored as f
+00058d70: 6c6f 6174 2062 7920 7061 6e64 6173 0a0a  loat by pandas..
+00058d80: 2020 2020 6461 7465 5f69 735f 696e 7420      date_is_int 
+00058d90: 3a20 626f 6f6c 6561 6e20 7365 7420 746f  : boolean set to
+00058da0: 2054 7275 6520 746f 2063 6173 7420 6461   True to cast da
+00058db0: 7465 2074 6f20 696e 743b 2063 616e 2062  te to int; can b
+00058dc0: 6520 7573 6566 756c 2069 6620 7468 6579  e useful if they
+00058dd0: 2061 7265 2069 6e61 6476 6572 7465 6e74   are inadvertent
+00058de0: 6c79 2073 746f 7265 6420 6173 2066 6c6f  ly stored as flo
+00058df0: 6174 2062 7920 7061 6e64 6173 0a0a 2020  at by pandas..  
+00058e00: 2020 6964 5f69 735f 696e 7420 3a20 626f    id_is_int : bo
+00058e10: 6f6c 6561 6e20 7365 7420 746f 2054 7275  olean set to Tru
+00058e20: 6520 746f 2063 6173 7420 756e 6971 7565  e to cast unique
+00058e30: 2069 6d61 6765 2069 6473 2074 6f20 696e   image ids to in
+00058e40: 743b 2063 616e 2062 6520 7573 6566 756c  t; can be useful
+00058e50: 2069 6620 7468 6579 2061 7265 2069 6e61   if they are ina
+00058e60: 6476 6572 7465 6e74 6c79 2073 746f 7265  dvertently store
+00058e70: 6420 6173 2066 6c6f 6174 2062 7920 7061  d as float by pa
+00058e80: 6e64 6173 0a0a 2020 2020 7265 706f 7274  ndas..    report
+00058e90: 5f6d 6973 7369 6e67 203a 2062 6f6f 6c65  _missing : boole
+00058ea0: 616e 2063 6f6d 6269 6e65 6420 7769 7468  an combined with
+00058eb0: 2076 6572 626f 7365 2077 696c 6c20 7265   verbose will re
+00058ec0: 706f 7274 206d 6973 7369 6e67 206d 6f64  port missing mod
+00058ed0: 616c 6974 6965 730a 0a20 2020 2070 726f  alities..    pro
+00058ee0: 6772 6573 7320 3a20 696e 7465 6765 7220  gress : integer 
+00058ef0: 7265 706f 7274 7320 7065 7263 656e 7420  reports percent 
+00058f00: 7072 6f67 7265 7373 206d 6f64 756c 6f20  progress modulo 
+00058f10: 7072 6f67 7265 7373 2076 616c 7565 200a  progress value .
+00058f20: 0a20 2020 2076 6572 626f 7365 203a 2062  .    verbose : b
+00058f30: 6f6f 6c65 616e 0a20 2020 2022 2222 0a20  oolean.    """. 
+00058f40: 2020 2066 726f 6d20 6f73 2e70 6174 6820     from os.path 
+00058f50: 696d 706f 7274 2065 7869 7374 730a 2020  import exists.  
+00058f60: 2020 6d75 7374 6861 7665 636f 6c73 203d    musthavecols =
+00058f70: 205b 2770 726f 6a65 6374 4944 272c 2027   ['projectID', '
+00058f80: 7375 626a 6563 7449 4427 2c27 6461 7465  subjectID','date
+00058f90: 272c 2769 6d61 6765 4944 275d 0a20 2020  ','imageID'].   
+00058fa0: 2066 6f72 206b 2069 6e20 7261 6e67 6528   for k in range(
+00058fb0: 6c65 6e28 6d75 7374 6861 7665 636f 6c73  len(musthavecols
+00058fc0: 2929 3a0a 2020 2020 2020 2020 6966 206e  )):.        if n
+00058fd0: 6f74 206d 7573 7468 6176 6563 6f6c 735b  ot musthavecols[
+00058fe0: 6b5d 2069 6e20 7364 662e 6b65 7973 2829  k] in sdf.keys()
+00058ff0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00059000: 6973 6520 5661 6c75 6545 7272 6f72 2827  ise ValueError('
+00059010: 7364 6620 6973 206d 6973 7369 6e67 2063  sdf is missing c
+00059020: 6f6c 756d 6e20 2720 2b6d 7573 7468 6176  olumn ' +musthav
+00059030: 6563 6f6c 735b 6b5d 202b 2027 2069 6e20  ecols[k] + ' in 
+00059040: 6d65 7267 655f 7769 6465 735f 746f 5f73  merge_wides_to_s
+00059050: 7475 6479 5f64 6174 6166 7261 6d65 2720  tudy_dataframe' 
+00059060: 290a 2020 2020 706f 7373 6962 6c65 5f69  ).    possible_i
+00059070: 6964 7320 3d20 5b20 2769 6d61 6765 4944  ids = [ 'imageID
+00059080: 272c 2027 696d 6167 6549 4427 2c20 2769  ', 'imageID', 'i
+00059090: 6d61 6765 4944 272c 2027 666c 6169 7269  mageID', 'flairi
+000590a0: 6427 2c20 2764 7469 6431 272c 2027 6474  d', 'dtid1', 'dt
+000590b0: 6964 3227 2c20 2772 7366 6964 3127 2c20  id2', 'rsfid1', 
+000590c0: 2772 7366 6964 3227 2c20 276e 6d69 6431  'rsfid2', 'nmid1
+000590d0: 272c 2027 6e6d 6964 3227 2c20 276e 6d69  ', 'nmid2', 'nmi
+000590e0: 6433 272c 2027 6e6d 6964 3427 2c20 276e  d3', 'nmid4', 'n
+000590f0: 6d69 6435 272c 2027 6e6d 6964 3627 2c20  mid5', 'nmid6', 
+00059100: 276e 6d69 6437 272c 2027 6e6d 6964 3827  'nmid7', 'nmid8'
+00059110: 2c20 276e 6d69 6439 272c 2027 6e6d 6964  , 'nmid9', 'nmid
+00059120: 3130 272c 2027 7065 7266 6964 2720 5d0a  10', 'perfid' ].
+00059130: 2020 2020 6d6f 6461 6c69 7479 5f69 6473      modality_ids
+00059140: 203d 205b 2027 5431 7748 6965 7261 7263   = [ 'T1wHierarc
+00059150: 6869 6361 6c27 2c20 2754 3177 4869 6572  hical', 'T1wHier
+00059160: 6172 6368 6963 616c 5352 272c 2027 5431  archicalSR', 'T1
+00059170: 7727 2c20 2754 3246 6c61 6972 272c 2027  w', 'T2Flair', '
+00059180: 4454 4927 2c20 2744 5449 272c 2027 7273  DTI', 'DTI', 'rs
+00059190: 664d 5249 272c 2027 7273 664d 5249 272c  fMRI', 'rsfMRI',
+000591a0: 2027 4e4d 3244 4d54 272c 2027 4e4d 3244   'NM2DMT', 'NM2D
+000591b0: 4d54 272c 2027 4e4d 3244 4d54 272c 2027  MT', 'NM2DMT', '
+000591c0: 4e4d 3244 4d54 272c 2027 4e4d 3244 4d54  NM2DMT', 'NM2DMT
+000591d0: 272c 2027 4e4d 3244 4d54 272c 2027 4e4d  ', 'NM2DMT', 'NM
+000591e0: 3244 4d54 272c 2027 4e4d 3244 4d54 272c  2DMT', 'NM2DMT',
+000591f0: 2027 4e4d 3244 4d54 272c 2027 4e4d 3244   'NM2DMT', 'NM2D
+00059200: 4d54 272c 2027 7065 7266 275d 0a20 2020  MT', 'perf'].   
+00059210: 2061 6c6c 6466 3d70 642e 4461 7461 4672   alldf=pd.DataFr
+00059220: 616d 6528 290a 2020 2020 666f 7220 6d79  ame().    for my
+00059230: 6b20 696e 2073 6466 2e69 6e64 6578 3a0a  k in sdf.index:.
+00059240: 2020 2020 2020 2020 6966 2070 726f 6772          if progr
+00059250: 6573 7320 3e20 3020 616e 6420 696e 7428  ess > 0 and int(
+00059260: 6d79 6b29 2025 2069 6e74 2870 726f 6772  myk) % int(progr
+00059270: 6573 7329 203d 3d20 303a 0a20 2020 2020  ess) == 0:.     
+00059280: 2020 2020 2020 2070 7269 6e74 2820 7374         print( st
+00059290: 7228 2072 6f75 6e64 2820 6d79 6b2f 7364  r( round( myk/sd
+000592a0: 662e 7368 6170 655b 305d 2a31 3030 2e30  f.shape[0]*100.0
+000592b0: 2929 202b 2022 252e 2e2e 222c 2065 6e64  )) + "%...", end
+000592c0: 3d27 272c 2066 6c75 7368 3d54 7275 6529  ='', flush=True)
+000592d0: 0a20 2020 2020 2020 2069 6620 7665 7262  .        if verb
+000592e0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+000592f0: 2070 7269 6e74 2820 2244 4f52 4f57 2022   print( "DOROW "
+00059300: 202b 2073 7472 286d 796b 2920 2b20 2720   + str(myk) + ' 
+00059310: 6f66 2027 202b 2073 7472 2820 7364 662e  of ' + str( sdf.
+00059320: 7368 6170 655b 305d 2029 2029 0a20 2020  shape[0] ) ).   
+00059330: 2020 2020 2063 7376 726f 7720 3d20 7364       csvrow = sd
+00059340: 662e 6c6f 635b 7364 662e 696e 6465 7820  f.loc[sdf.index 
+00059350: 3d3d 206d 796b 5d2e 6472 6f70 6e61 2861  == myk].dropna(a
+00059360: 7869 733d 3129 0a20 2020 2020 2020 2063  xis=1).        c
+00059370: 743d 2d31 0a20 2020 2020 2020 2066 6f72  t=-1.        for
+00059380: 2069 6964 6b65 7920 696e 2070 6f73 7369   iidkey in possi
+00059390: 626c 655f 6969 6473 3a0a 2020 2020 2020  ble_iids:.      
+000593a0: 2020 2020 2020 6374 3d63 742b 310a 2020        ct=ct+1.  
+000593b0: 2020 2020 2020 2020 2020 6d6f 645f 6e61            mod_na
+000593c0: 6d65 203d 206d 6f64 616c 6974 795f 6964  me = modality_id
+000593d0: 735b 6374 5d0a 2020 2020 2020 2020 2020  s[ct].          
+000593e0: 2020 6966 2069 6964 6b65 7920 696e 2063    if iidkey in c
+000593f0: 7376 726f 772e 6b65 7973 2829 3a0a 2020  svrow.keys():.  
+00059400: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00059410: 2069 645f 6973 5f69 6e74 3a0a 2020 2020   id_is_int:.    
+00059420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059430: 6969 6420 3d20 7374 7228 2069 6e74 2820  iid = str( int( 
+00059440: 6373 7672 6f77 5b69 6964 6b65 795d 2e69  csvrow[iidkey].i
+00059450: 6c6f 635b 305d 2029 2029 0a20 2020 2020  loc[0] ) ).     
+00059460: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00059470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00059480: 2020 2020 2069 6964 203d 2073 7472 2820       iid = str( 
+00059490: 6373 7672 6f77 5b69 6964 6b65 795d 2e69  csvrow[iidkey].i
+000594a0: 6c6f 635b 305d 2029 0a20 2020 2020 2020  loc[0] ).       
+000594b0: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
+000594c0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+000594d0: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
+000594e0: 2269 6964 6b65 7920 2220 2b20 6969 646b  "iidkey " + iidk
+000594f0: 6579 202b 2022 206d 6f64 616c 6974 7920  ey + " modality 
+00059500: 2220 2b20 6d6f 645f 6e61 6d65 202b 2027  " + mod_name + '
+00059510: 2069 6964 2027 2b20 6969 6420 290a 2020   iid '+ iid ).  
+00059520: 2020 2020 2020 2020 2020 2020 2020 7069                pi
+00059530: 643d 7374 7228 6373 7672 6f77 5b27 7072  d=str(csvrow['pr
+00059540: 6f6a 6563 7449 4427 5d2e 696c 6f63 5b30  ojectID'].iloc[0
+00059550: 5d20 290a 2020 2020 2020 2020 2020 2020  ] ).            
+00059560: 2020 2020 6966 2073 6964 5f69 735f 696e      if sid_is_in
+00059570: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00059580: 2020 2020 2020 2073 6964 3d73 7472 2869         sid=str(i
+00059590: 6e74 2863 7376 726f 775b 2773 7562 6a65  nt(csvrow['subje
+000595a0: 6374 4944 275d 2e69 6c6f 635b 305d 2029  ctID'].iloc[0] )
+000595b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000595c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000595d0: 2020 2020 2020 2020 2020 2020 7369 643d              sid=
+000595e0: 7374 7228 6373 7672 6f77 5b27 7375 626a  str(csvrow['subj
+000595f0: 6563 7449 4427 5d2e 696c 6f63 5b30 5d20  ectID'].iloc[0] 
+00059600: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00059610: 2020 6966 2064 6174 655f 6973 5f69 6e74    if date_is_int
+00059620: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00059630: 2020 2020 2020 6474 3d73 7472 2869 6e74        dt=str(int
+00059640: 2863 7376 726f 775b 2764 6174 6527 5d2e  (csvrow['date'].
+00059650: 696c 6f63 5b30 5d29 290a 2020 2020 2020  iloc[0])).      
+00059660: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00059670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059680: 2020 2020 6474 3d73 7472 2863 7376 726f      dt=str(csvro
+00059690: 775b 2764 6174 6527 5d2e 696c 6f63 5b30  w['date'].iloc[0
+000596a0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+000596b0: 2020 2069 6620 6964 5f69 735f 696e 743a     if id_is_int:
+000596c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000596d0: 2020 2020 2074 3169 6964 3d73 7472 2869       t1iid=str(i
+000596e0: 6e74 2863 7376 726f 775b 2769 6d61 6765  nt(csvrow['image
+000596f0: 4944 275d 2e69 6c6f 635b 305d 2929 0a20  ID'].iloc[0])). 
+00059700: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00059710: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00059720: 2020 2020 2020 2020 2074 3169 6964 3d73           t1iid=s
+00059730: 7472 2863 7376 726f 775b 2769 6d61 6765  tr(csvrow['image
+00059740: 4944 275d 2e69 6c6f 635b 305d 290a 2020  ID'].iloc[0]).  
+00059750: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00059760: 2074 3169 6964 2021 3d20 6969 643a 0a20   t1iid != iid:. 
+00059770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059780: 2020 2069 6964 6a3d 6969 642b 225f 222b     iidj=iid+"_"+
+00059790: 7431 6969 640a 2020 2020 2020 2020 2020  t1iid.          
+000597a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000597b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000597c0: 6969 646a 3d69 6964 0a20 2020 2020 2020  iidj=iid.       
+000597d0: 2020 2020 2020 2020 2072 6f6f 7469 6420           rootid 
+000597e0: 3d20 7069 6420 2b73 6570 6172 6174 6f72  = pid +separator
+000597f0: 2b20 7369 6420 2b73 6570 6172 6174 6f72  + sid +separator
+00059800: 2b64 742b 7365 7061 7261 746f 722b 6d6f  +dt+separator+mo
+00059810: 645f 6e61 6d65 2b73 6570 6172 6174 6f72  d_name+separator
+00059820: 2b69 6964 6a0a 2020 2020 2020 2020 2020  +iidj.          
+00059830: 2020 2020 2020 6d79 6578 7420 3d20 726f        myext = ro
+00059840: 6f74 6964 202b 7365 7061 7261 746f 722b  otid +separator+
+00059850: 276d 6d77 6964 652e 6373 7627 0a20 2020  'mmwide.csv'.   
+00059860: 2020 2020 2020 2020 2020 2020 206e 7267               nrg
+00059870: 7769 6465 666e 3d6f 732e 7061 7468 2e6a  widefn=os.path.j
+00059880: 6f69 6e28 2070 726f 6365 7373 696e 675f  oin( processing_
+00059890: 6469 722c 2070 6964 2c20 7369 642c 2064  dir, pid, sid, d
+000598a0: 742c 206d 6f64 5f6e 616d 652c 2069 6964  t, mod_name, iid
+000598b0: 2c20 6d79 6578 7420 290a 2020 2020 2020  , myext ).      
+000598c0: 2020 2020 2020 2020 2020 6d6f 6464 6572            modder
+000598d0: 7375 6220 3d20 6d6f 645f 6e61 6d65 0a20  sub = mod_name. 
+000598e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000598f0: 735f 7431 3d46 616c 7365 0a20 2020 2020  s_t1=False.     
+00059900: 2020 2020 2020 2020 2020 2069 6620 6d6f             if mo
+00059910: 645f 6e61 6d65 203d 3d20 2754 3177 4869  d_name == 'T1wHi
+00059920: 6572 6172 6368 6963 616c 273a 0a20 2020  erarchical':.   
+00059930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059940: 2069 735f 7431 3d54 7275 650a 2020 2020   is_t1=True.    
+00059950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059960: 6d6f 6464 6572 7375 623d 2754 3148 6965  moddersub='T1Hie
+00059970: 7227 0a20 2020 2020 2020 2020 2020 2020  r'.             
+00059980: 2020 2065 6c69 6620 6d6f 645f 6e61 6d65     elif mod_name
+00059990: 203d 3d20 2754 3177 4869 6572 6172 6368   == 'T1wHierarch
+000599a0: 6963 616c 5352 273a 0a20 2020 2020 2020  icalSR':.       
+000599b0: 2020 2020 2020 2020 2020 2020 2069 735f               is_
+000599c0: 7431 3d54 7275 650a 2020 2020 2020 2020  t1=True.        
+000599d0: 2020 2020 2020 2020 2020 2020 6d6f 6464              modd
+000599e0: 6572 7375 623d 2754 3148 5352 270a 2020  ersub='T1HSR'.  
+000599f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00059a00: 2065 7869 7374 7328 206e 7267 7769 6465   exists( nrgwide
+00059a10: 666e 2029 3a0a 2020 2020 2020 2020 2020  fn ):.          
+00059a20: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+00059a30: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+00059a40: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00059a50: 696e 7428 206e 7267 7769 6465 666e 202b  int( nrgwidefn +
+00059a60: 2022 2065 7869 7374 7322 290a 2020 2020   " exists").    
+00059a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059a80: 6d6d 3d72 6561 645f 6d6d 5f63 7376 2820  mm=read_mm_csv( 
+00059a90: 6e72 6777 6964 6566 6e2c 2063 6f6c 7072  nrgwidefn, colpr
+00059aa0: 6566 6978 3d6d 6f64 6465 7273 7562 2b27  efix=moddersub+'
+00059ab0: 5f27 2c20 6973 5f74 313d 6973 5f74 312c  _', is_t1=is_t1,
+00059ac0: 2073 6570 6172 6174 6f72 3d73 6570 6172   separator=separ
+00059ad0: 6174 6f72 2c20 7665 7262 6f73 653d 7665  ator, verbose=ve
+00059ae0: 7262 6f73 6520 290a 2020 2020 2020 2020  rbose ).        
+00059af0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00059b00: 6d20 6973 206e 6f74 204e 6f6e 653a 0a20  m is not None:. 
+00059b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059b20: 2020 2020 2020 2069 6620 6d6f 645f 6e61         if mod_na
+00059b30: 6d65 203d 3d20 2754 3177 4869 6572 6172  me == 'T1wHierar
+00059b40: 6368 6963 616c 273a 0a20 2020 2020 2020  chical':.       
 00059b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059b60: 2020 2020 2020 2020 2061 6269 6e74 6572           abinter
-00059b70: 7365 6374 3d6c 6973 7428 7365 7428 6229  sect=list(set(b)
-00059b80: 2e69 6e74 6572 7365 6374 696f 6e28 2073  .intersection( s
-00059b90: 6574 2861 2920 2920 290a 2020 2020 2020  et(a) ) ).      
-00059ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059bb0: 2020 2020 2020 6966 206c 656e 2820 6162        if len( ab
-00059bc0: 696e 7465 7273 6563 7420 2029 203e 2030  intersect  ) > 0
-00059bd0: 203a 0a20 2020 2020 2020 2020 2020 2020   :.             
-00059be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059bf0: 2020 2066 6f72 2071 7120 696e 2061 6269     for qq in abi
-00059c00: 6e74 6572 7365 6374 3a0a 2020 2020 2020  ntersect:.      
-00059c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059c20: 2020 2020 2020 2020 2020 2020 2020 6d6d                mm
-00059c30: 2e70 6f70 2820 7171 2029 0a20 2020 2020  .pop( qq ).     
+00059b60: 2020 2020 2061 3d6c 6973 7428 2063 7376       a=list( csv
+00059b70: 726f 772e 6b65 7973 2829 2029 0a20 2020  row.keys() ).   
+00059b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059b90: 2020 2020 2020 2020 2062 3d6c 6973 7428           b=list(
+00059ba0: 206d 6d2e 6b65 7973 2829 2029 0a20 2020   mm.keys() ).   
+00059bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059bc0: 2020 2020 2020 2020 2061 6269 6e74 6572           abinter
+00059bd0: 7365 6374 3d6c 6973 7428 7365 7428 6229  sect=list(set(b)
+00059be0: 2e69 6e74 6572 7365 6374 696f 6e28 2073  .intersection( s
+00059bf0: 6574 2861 2920 2920 290a 2020 2020 2020  et(a) ) ).      
+00059c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059c10: 2020 2020 2020 6966 206c 656e 2820 6162        if len( ab
+00059c20: 696e 7465 7273 6563 7420 2029 203e 2030  intersect  ) > 0
+00059c30: 203a 0a20 2020 2020 2020 2020 2020 2020   :.             
 00059c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059c50: 2020 2023 206d 6d2e 696e 6465 783d 6373     # mm.index=cs
-00059c60: 7672 6f77 2e69 6e64 6578 0a20 2020 2020  vrow.index.     
+00059c50: 2020 2066 6f72 2071 7120 696e 2061 6269     for qq in abi
+00059c60: 6e74 6572 7365 6374 3a0a 2020 2020 2020  ntersect:.      
 00059c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059c80: 2020 2075 6964 6e61 6d65 203d 206d 6f64     uidname = mod
-00059c90: 5f6e 616d 6520 2b20 275f 6d6d 7769 6465  _name + '_mmwide
-00059ca0: 5f66 696c 656e 616d 6527 0a20 2020 2020  _filename'.     
-00059cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059cc0: 2020 206d 6d5b 2075 6964 6e61 6d65 205d     mm[ uidname ]
-00059cd0: 203d 2072 6f6f 7469 640a 2020 2020 2020   = rootid.      
-00059ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059cf0: 2020 6373 7672 6f77 3d70 642e 636f 6e63    csvrow=pd.conc
-00059d00: 6174 2820 5b63 7376 726f 772c 6d6d 5d2c  at( [csvrow,mm],
-00059d10: 2061 7869 733d 312c 2069 676e 6f72 655f   axis=1, ignore_
-00059d20: 696e 6465 783d 4661 6c73 6520 290a 2020  index=False ).  
-00059d30: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00059d40: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00059d50: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-00059d60: 7365 2061 6e64 2072 6570 6f72 745f 6d69  se and report_mi
-00059d70: 7373 696e 673a 0a20 2020 2020 2020 2020  ssing:.         
-00059d80: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00059d90: 7269 6e74 2820 6e72 6777 6964 6566 6e20  rint( nrgwidefn 
-00059da0: 2b20 2220 6162 7365 6e74 2229 0a20 2020  + " absent").   
-00059db0: 2020 2020 2069 6620 616c 6c64 662e 7368       if alldf.sh
-00059dc0: 6170 655b 305d 203d 3d20 303a 0a20 2020  ape[0] == 0:.   
-00059dd0: 2020 2020 2020 2020 2061 6c6c 6466 203d           alldf =
-00059de0: 2063 7376 726f 772e 636f 7079 2829 0a20   csvrow.copy(). 
-00059df0: 2020 2020 2020 2020 2020 2061 6c6c 6466             alldf
-00059e00: 203d 2061 6c6c 6466 2e6c 6f63 5b3a 2c7e   = alldf.loc[:,~
-00059e10: 616c 6c64 662e 636f 6c75 6d6e 732e 6475  alldf.columns.du
-00059e20: 706c 6963 6174 6564 2829 5d0a 2020 2020  plicated()].    
-00059e30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00059e40: 2020 2020 2020 6373 7672 6f77 3d63 7376        csvrow=csv
-00059e50: 726f 772e 6c6f 635b 3a2c 7e63 7376 726f  row.loc[:,~csvro
-00059e60: 772e 636f 6c75 6d6e 732e 6475 706c 6963  w.columns.duplic
-00059e70: 6174 6564 2829 5d0a 2020 2020 2020 2020  ated()].        
-00059e80: 2020 2020 616c 6c64 6620 3d20 616c 6c64      alldf = alld
-00059e90: 662e 6c6f 635b 3a2c 7e61 6c6c 6466 2e63  f.loc[:,~alldf.c
-00059ea0: 6f6c 756d 6e73 2e64 7570 6c69 6361 7465  olumns.duplicate
-00059eb0: 6428 295d 0a20 2020 2020 2020 2020 2020  d()].           
-00059ec0: 2061 6c6c 6466 203d 2070 642e 636f 6e63   alldf = pd.conc
-00059ed0: 6174 2820 5b61 6c6c 6466 2c20 6373 7672  at( [alldf, csvr
-00059ee0: 6f77 5d2c 2061 7869 733d 302c 2069 676e  ow], axis=0, ign
-00059ef0: 6f72 655f 696e 6465 783d 5472 7565 2029  ore_index=True )
-00059f00: 0a20 2020 2072 6574 7572 6e20 616c 6c64  .    return alld
-00059f10: 660a 0a64 6566 2061 7373 656d 626c 655f  f..def assemble_
-00059f20: 6d6f 6461 6c69 7479 5f73 7065 6369 6669  modality_specifi
-00059f30: 635f 6461 7461 6672 616d 6573 2820 6d6d  c_dataframes( mm
-00059f40: 5f77 6964 655f 6373 7673 2c20 6869 6572  _wide_csvs, hier
-00059f50: 6466 696e 2c20 6e72 675f 6d6f 6461 6c69  dfin, nrg_modali
-00059f60: 7479 2c20 7365 7061 7261 746f 723d 272d  ty, separator='-
-00059f70: 272c 2070 726f 6772 6573 733d 4e6f 6e65  ', progress=None
-00059f80: 2c20 7665 7262 6f73 653d 4661 6c73 6520  , verbose=False 
-00059f90: 293a 0a20 2020 206d 6f64 6465 7273 7562  ):.    moddersub
-00059fa0: 203d 2072 652e 7375 6228 2022 5b2a 5d22   = re.sub( "[*]"
-00059fb0: 2c22 222c 6e72 675f 6d6f 6461 6c69 7479  ,"",nrg_modality
-00059fc0: 290a 2020 2020 6e6d 6466 3d70 642e 4461  ).    nmdf=pd.Da
-00059fd0: 7461 4672 616d 6528 290a 2020 2020 666f  taFrame().    fo
-00059fe0: 7220 6b20 696e 2072 616e 6765 2820 6869  r k in range( hi
-00059ff0: 6572 6466 696e 2e73 6861 7065 5b30 5d20  erdfin.shape[0] 
-0005a000: 293a 0a20 2020 2020 2020 2069 6620 7072  ):.        if pr
-0005a010: 6f67 7265 7373 2069 7320 6e6f 7420 4e6f  ogress is not No
-0005a020: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0005a030: 6966 206b 2025 2070 726f 6772 6573 7320  if k % progress 
-0005a040: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-0005a050: 2020 2020 2020 7072 6f67 6765 7220 3d20        progger = 
-0005a060: 7374 7228 206e 702e 726f 756e 6428 206b  str( np.round( k
-0005a070: 202f 2068 6965 7264 6669 6e2e 7368 6170   / hierdfin.shap
-0005a080: 655b 305d 202a 2031 3030 2029 2029 0a20  e[0] * 100 ) ). 
-0005a090: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0005a0a0: 7269 6e74 2820 7072 6f67 6765 722c 2065  rint( progger, e
-0005a0b0: 6e64 203d 222e 2e2e 222c 2066 6c75 7368  nd ="...", flush
-0005a0c0: 3d54 7275 6529 0a20 2020 2020 2020 2074  =True).        t
-0005a0d0: 656d 7020 3d20 6d6d 5f77 6964 655f 6373  emp = mm_wide_cs
-0005a0e0: 7673 5b6b 5d0a 2020 2020 2020 2020 6d79  vs[k].        my
-0005a0f0: 7061 7274 7366 203d 2074 656d 702e 7370  partsf = temp.sp
-0005a100: 6c69 7428 2254 3177 4869 6572 6172 6368  lit("T1wHierarch
-0005a110: 6963 616c 2229 0a20 2020 2020 2020 206d  ical").        m
-0005a120: 7970 6172 7473 203d 206d 7970 6172 7473  yparts = myparts
-0005a130: 665b 305d 0a20 2020 2020 2020 2074 3169  f[0].        t1i
-0005a140: 6964 203d 2073 7472 286d 7970 6172 7473  id = str(myparts
-0005a150: 665b 315d 2e73 706c 6974 2822 2f22 295b  f[1].split("/")[
-0005a160: 315d 290a 2020 2020 2020 2020 666e 736e  1]).        fnsn
-0005a170: 6d20 3d20 676c 6f62 2e67 6c6f 6228 6d79  m = glob.glob(my
-0005a180: 7061 7274 732b 222f 2220 2b20 6e72 675f  parts+"/" + nrg_
-0005a190: 6d6f 6461 6c69 7479 202b 2022 2f2a 2f2a  modality + "/*/*
-0005a1a0: 2220 2b20 7431 6969 6420 2b20 222a 7769  " + t1iid + "*wi
-0005a1b0: 6465 2e63 7376 2229 0a20 2020 2020 2020  de.csv").       
-0005a1c0: 2069 6620 6c65 6e28 2066 6e73 6e6d 2029   if len( fnsnm )
-0005a1d0: 203e 2030 203a 0a20 2020 2020 2020 2020   > 0 :.         
-0005a1e0: 2020 2066 6f72 2079 2069 6e20 666e 736e     for y in fnsn
-0005a1f0: 6d3a 0a20 2020 2020 2020 2020 2020 2020  m:.             
-0005a200: 2020 2074 656d 703d 7265 6164 5f6d 6d5f     temp=read_mm_
-0005a210: 6373 7628 2079 2c20 636f 6c70 7265 6669  csv( y, colprefi
-0005a220: 783d 6d6f 6464 6572 7375 622b 275f 272c  x=moddersub+'_',
-0005a230: 2069 735f 7431 3d46 616c 7365 2c20 7365   is_t1=False, se
-0005a240: 7061 7261 746f 723d 7365 7061 7261 746f  parator=separato
-0005a250: 722c 2076 6572 626f 7365 3d76 6572 626f  r, verbose=verbo
-0005a260: 7365 2029 0a20 2020 2020 2020 2020 2020  se ).           
-0005a270: 2020 2020 2069 6620 7465 6d70 2069 7320       if temp is 
-0005a280: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0005a290: 2020 2020 2020 2020 2020 2020 2020 6e6d                nm
-0005a2a0: 6466 3d70 642e 636f 6e63 6174 2820 5b6e  df=pd.concat( [n
-0005a2b0: 6d64 662c 2074 656d 705d 2c20 6178 6973  mdf, temp], axis
-0005a2c0: 3d30 2c20 6967 6e6f 7265 5f69 6e64 6578  =0, ignore_index
-0005a2d0: 3d46 616c 7365 2029 0a20 2020 2072 6574  =False ).    ret
-0005a2e0: 7572 6e20 6e6d 6466 0a0a 6465 6620 6269  urn nmdf..def bi
-0005a2f0: 6e64 5f77 6964 655f 6d6d 5f63 7376 7328  nd_wide_mm_csvs(
-0005a300: 206d 6d5f 7769 6465 5f63 7376 732c 206d   mm_wide_csvs, m
-0005a310: 6572 6765 3d54 7275 652c 2073 6570 6172  erge=True, separ
-0005a320: 6174 6f72 3d27 2d27 2c20 7665 7262 6f73  ator='-', verbos
-0005a330: 6520 3d20 3020 2920 3a0a 2020 2020 2222  e = 0 ) :.    ""
-0005a340: 220a 2020 2020 7769 6c6c 2063 6f6e 7665  ".    will conve
-0005a350: 7274 2061 206c 6973 7420 6f66 2074 3177  rt a list of t1w
-0005a360: 2068 6965 7261 7263 6869 6361 6c20 6373   hierarchical cs
-0005a370: 7620 6669 6c65 6e61 6d65 7320 746f 2061  v filenames to a
-0005a380: 206d 6572 6765 6420 6461 7461 6672 616d   merged datafram
-0005a390: 650a 0a20 2020 2072 6574 7572 6e73 2061  e..    returns a
-0005a3a0: 2070 6169 7220 6f66 2064 6174 6120 6672   pair of data fr
-0005a3b0: 616d 6573 2c20 7468 6520 6c65 6674 2073  ames, the left s
-0005a3c0: 6964 6520 6861 7669 6e67 2061 6c6c 2065  ide having all e
-0005a3d0: 6e74 7269 6573 2061 6e64 2074 6865 0a20  ntries and the. 
-0005a3e0: 2020 2020 2020 2072 6967 6874 2073 6964         right sid
-0005a3f0: 6520 6861 7669 6e67 2072 6f77 2061 7665  e having row ave
-0005a400: 7261 6765 6420 656e 7472 6965 7320 692e  raged entries i.
-0005a410: 652e 2075 6e69 7175 6520 7661 6c75 6573  e. unique values
-0005a420: 2066 6f72 2065 6163 6820 7669 7369 740a   for each visit.
-0005a430: 0a20 2020 2073 6574 206d 6572 6765 2074  .    set merge t
-0005a440: 6f20 4661 6c73 6520 746f 2072 6574 7572  o False to retur
-0005a450: 6e20 696e 6469 7669 6475 616c 2064 6174  n individual dat
-0005a460: 6166 7261 6d65 7320 2820 666f 7220 6465  aframes ( for de
-0005a470: 6275 6767 696e 6720 290a 0a20 2020 2072  bugging )..    r
-0005a480: 6574 7572 6e20 616c 6c64 6174 612c 2072  eturn alldata, r
-0005a490: 6f77 5f61 7665 7261 6765 645f 6461 7461  ow_averaged_data
-0005a4a0: 0a20 2020 2022 2222 0a20 2020 206d 6d5f  .    """.    mm_
-0005a4b0: 7769 6465 5f63 7376 732e 736f 7274 2829  wide_csvs.sort()
-0005a4c0: 0a20 2020 2069 6620 6e6f 7420 6d6d 5f77  .    if not mm_w
-0005a4d0: 6964 655f 6373 7673 3a0a 2020 2020 2020  ide_csvs:.      
-0005a4e0: 2020 7072 696e 7428 224e 6f20 6669 6c65    print("No file
-0005a4f0: 7320 666f 756e 6420 7769 7468 2073 7065  s found with spe
-0005a500: 6369 6669 6564 2070 6174 7465 726e 2229  cified pattern")
-0005a510: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
-0005a520: 2020 2020 2320 312e 2072 6f77 2d62 696e      # 1. row-bin
-0005a530: 6420 7468 6520 7431 7768 6965 7220 6461  d the t1whier da
-0005a540: 7461 0a20 2020 2023 2032 2e20 7361 6d65  ta.    # 2. same
-0005a550: 2066 6f72 2065 6163 6820 6f74 6865 7220   for each other 
-0005a560: 6d6f 6461 6c69 7479 0a20 2020 2023 2033  modality.    # 3
-0005a570: 2e20 6d65 7267 6520 7468 6520 6d6f 6461  . merge the moda
-0005a580: 6c69 7469 6573 2062 7920 7468 6520 6b65  lities by the ke
-0005a590: 7973 0a20 2020 2068 6965 7264 6620 3d20  ys.    hierdf = 
-0005a5a0: 7064 2e44 6174 6146 7261 6d65 2829 0a20  pd.DataFrame(). 
-0005a5b0: 2020 2066 6f72 2079 2069 6e20 6d6d 5f77     for y in mm_w
-0005a5c0: 6964 655f 6373 7673 3a0a 2020 2020 2020  ide_csvs:.      
-0005a5d0: 2020 7465 6d70 3d72 6561 645f 6d6d 5f63    temp=read_mm_c
-0005a5e0: 7376 2820 792c 2063 6f6c 7072 6566 6978  sv( y, colprefix
-0005a5f0: 3d27 5431 4869 6572 5f27 2c20 7365 7061  ='T1Hier_', sepa
-0005a600: 7261 746f 723d 7365 7061 7261 746f 722c  rator=separator,
-0005a610: 2069 735f 7431 3d54 7275 6520 290a 2020   is_t1=True ).  
-0005a620: 2020 2020 2020 6966 2074 656d 7020 6973        if temp is
-0005a630: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0005a640: 2020 2020 2020 2068 6965 7264 663d 7064         hierdf=pd
-0005a650: 2e63 6f6e 6361 7428 205b 6869 6572 6466  .concat( [hierdf
-0005a660: 2c20 7465 6d70 5d2c 2061 7869 733d 302c  , temp], axis=0,
-0005a670: 2069 676e 6f72 655f 696e 6465 783d 4661   ignore_index=Fa
-0005a680: 6c73 6520 290a 2020 2020 6966 2076 6572  lse ).    if ver
-0005a690: 626f 7365 203e 2030 3a0a 2020 2020 2020  bose > 0:.      
-0005a6a0: 2020 6d79 7072 6f3d 3530 0a20 2020 2065    mypro=50.    e
-0005a6b0: 6c73 653a 0a20 2020 2020 2020 206d 7970  lse:.        myp
-0005a6c0: 726f 3d4e 6f6e 650a 2020 2020 6966 2076  ro=None.    if v
-0005a6d0: 6572 626f 7365 203e 2030 3a0a 2020 2020  erbose > 0:.    
-0005a6e0: 2020 2020 7072 696e 7428 2274 6869 636b      print("thick
-0005a6f0: 6e65 7373 2229 0a20 2020 2074 686b 6466  ness").    thkdf
-0005a700: 203d 2061 7373 656d 626c 655f 6d6f 6461   = assemble_moda
-0005a710: 6c69 7479 5f73 7065 6369 6669 635f 6461  lity_specific_da
-0005a720: 7461 6672 616d 6573 2820 6d6d 5f77 6964  taframes( mm_wid
-0005a730: 655f 6373 7673 2c20 6869 6572 6466 2c20  e_csvs, hierdf, 
-0005a740: 2754 3177 272c 2070 726f 6772 6573 733d  'T1w', progress=
-0005a750: 6d79 7072 6f2c 2076 6572 626f 7365 3d76  mypro, verbose=v
-0005a760: 6572 626f 7365 3d3d 3229 0a20 2020 2069  erbose==2).    i
-0005a770: 6620 7665 7262 6f73 6520 3e20 303a 0a20  f verbose > 0:. 
-0005a780: 2020 2020 2020 2070 7269 6e74 2822 666c         print("fl
-0005a790: 6169 7222 290a 2020 2020 666c 6169 7264  air").    flaird
-0005a7a0: 6620 3d20 6173 7365 6d62 6c65 5f6d 6f64  f = assemble_mod
-0005a7b0: 616c 6974 795f 7370 6563 6966 6963 5f64  ality_specific_d
-0005a7c0: 6174 6166 7261 6d65 7328 206d 6d5f 7769  ataframes( mm_wi
-0005a7d0: 6465 5f63 7376 732c 2068 6965 7264 662c  de_csvs, hierdf,
-0005a7e0: 2027 5432 466c 6169 7227 2c20 7072 6f67   'T2Flair', prog
-0005a7f0: 7265 7373 3d6d 7970 726f 2c20 7665 7262  ress=mypro, verb
-0005a800: 6f73 653d 7665 7262 6f73 653d 3d32 290a  ose=verbose==2).
-0005a810: 2020 2020 6966 2076 6572 626f 7365 203e      if verbose >
-0005a820: 2030 3a0a 2020 2020 2020 2020 7072 696e   0:.        prin
-0005a830: 7428 224e 4d22 290a 2020 2020 6e6d 6466  t("NM").    nmdf
-0005a840: 203d 2061 7373 656d 626c 655f 6d6f 6461   = assemble_moda
-0005a850: 6c69 7479 5f73 7065 6369 6669 635f 6461  lity_specific_da
-0005a860: 7461 6672 616d 6573 2820 6d6d 5f77 6964  taframes( mm_wid
-0005a870: 655f 6373 7673 2c20 6869 6572 6466 2c20  e_csvs, hierdf, 
-0005a880: 274e 4d32 444d 5427 2c20 7072 6f67 7265  'NM2DMT', progre
-0005a890: 7373 3d6d 7970 726f 2c20 7665 7262 6f73  ss=mypro, verbos
-0005a8a0: 653d 7665 7262 6f73 653d 3d32 290a 2020  e=verbose==2).  
-0005a8b0: 2020 6966 2076 6572 626f 7365 203e 2030    if verbose > 0
-0005a8c0: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
-0005a8d0: 2272 7366 2229 0a20 2020 2072 7366 6466  "rsf").    rsfdf
-0005a8e0: 203d 2061 7373 656d 626c 655f 6d6f 6461   = assemble_moda
-0005a8f0: 6c69 7479 5f73 7065 6369 6669 635f 6461  lity_specific_da
-0005a900: 7461 6672 616d 6573 2820 6d6d 5f77 6964  taframes( mm_wid
-0005a910: 655f 6373 7673 2c20 6869 6572 6466 2c20  e_csvs, hierdf, 
-0005a920: 2772 7366 4d52 492a 272c 2070 726f 6772  'rsfMRI*', progr
-0005a930: 6573 733d 6d79 7072 6f2c 2076 6572 626f  ess=mypro, verbo
-0005a940: 7365 3d76 6572 626f 7365 3d3d 3229 0a20  se=verbose==2). 
-0005a950: 2020 2069 6620 7665 7262 6f73 6520 3e20     if verbose > 
-0005a960: 303a 0a20 2020 2020 2020 2070 7269 6e74  0:.        print
-0005a970: 2822 6474 6922 290a 2020 2020 6474 6964  ("dti").    dtid
-0005a980: 6620 3d20 6173 7365 6d62 6c65 5f6d 6f64  f = assemble_mod
-0005a990: 616c 6974 795f 7370 6563 6966 6963 5f64  ality_specific_d
-0005a9a0: 6174 6166 7261 6d65 7328 206d 6d5f 7769  ataframes( mm_wi
-0005a9b0: 6465 5f63 7376 732c 2068 6965 7264 662c  de_csvs, hierdf,
-0005a9c0: 2027 4454 492a 272c 2070 726f 6772 6573   'DTI*', progres
-0005a9d0: 733d 6d79 7072 6f2c 2076 6572 626f 7365  s=mypro, verbose
-0005a9e0: 3d76 6572 626f 7365 3d3d 3220 290a 2020  =verbose==2 ).  
-0005a9f0: 2020 6966 206e 6f74 206d 6572 6765 3a0a    if not merge:.
-0005aa00: 2020 2020 2020 2020 7265 7475 726e 2068          return h
-0005aa10: 6965 7264 662c 2074 686b 6466 2c20 666c  ierdf, thkdf, fl
-0005aa20: 6169 7264 662c 206e 6d64 662c 2072 7366  airdf, nmdf, rsf
-0005aa30: 6466 2c20 6474 6964 660a 2020 2020 6869  df, dtidf.    hi
-0005aa40: 6572 6466 6d69 7820 3d20 6869 6572 6466  erdfmix = hierdf
-0005aa50: 2e63 6f70 7928 290a 2020 2020 6d6f 6461  .copy().    moda
-0005aa60: 6c69 7479 5f64 665f 7375 6666 6978 6573  lity_df_suffixes
-0005aa70: 203d 205b 0a20 2020 2020 2020 2028 7468   = [.        (th
-0005aa80: 6b64 662c 2022 5f74 686b 2229 2c0a 2020  kdf, "_thk"),.  
-0005aa90: 2020 2020 2020 2866 6c61 6972 6466 2c20        (flairdf, 
-0005aaa0: 225f 666c 6169 7222 292c 0a20 2020 2020  "_flair"),.     
-0005aab0: 2020 2028 6e6d 6466 2c20 225f 6e6d 2229     (nmdf, "_nm")
-0005aac0: 2c0a 2020 2020 2020 2020 2872 7366 6466  ,.        (rsfdf
-0005aad0: 2c20 225f 7273 6622 292c 0a20 2020 2020  , "_rsf"),.     
-0005aae0: 2020 2028 6474 6964 662c 2022 5f64 7469     (dtidf, "_dti
-0005aaf0: 2229 2c0a 2020 2020 5d0a 2020 2020 666f  "),.    ].    fo
-0005ab00: 7220 7061 6972 2069 6e20 6d6f 6461 6c69  r pair in modali
-0005ab10: 7479 5f64 665f 7375 6666 6978 6573 3a0a  ty_df_suffixes:.
-0005ab20: 2020 2020 2020 2020 6869 6572 6466 6d69          hierdfmi
-0005ab30: 7820 3d20 6d65 7267 655f 6d6d 5f64 6174  x = merge_mm_dat
-0005ab40: 6166 7261 6d65 2868 6965 7264 666d 6978  aframe(hierdfmix
-0005ab50: 2c20 7061 6972 5b30 5d2c 2070 6169 725b  , pair[0], pair[
-0005ab60: 315d 290a 2020 2020 6869 6572 6466 6d69  1]).    hierdfmi
-0005ab70: 7820 3d20 6869 6572 6466 6d69 782e 7265  x = hierdfmix.re
-0005ab80: 706c 6163 6528 7227 5e5c 732a 2427 2c20  place(r'^\s*$', 
-0005ab90: 6e70 2e6e 616e 2c20 7265 6765 783d 5472  np.nan, regex=Tr
-0005aba0: 7565 290a 2020 2020 7265 7475 726e 2068  ue).    return h
-0005abb0: 6965 7264 666d 6978 2c20 6869 6572 6466  ierdfmix, hierdf
-0005abc0: 6d69 782e 6772 6f75 7062 7928 2275 5f68  mix.groupby("u_h
-0005abd0: 6965 725f 6964 222c 2061 735f 696e 6465  ier_id", as_inde
-0005abe0: 783d 4661 6c73 6529 2e6d 6561 6e28 6e75  x=False).mean(nu
-0005abf0: 6d65 7269 635f 6f6e 6c79 3d54 7275 6529  meric_only=True)
-0005ac00: 0a0a 6465 6620 6d65 7267 655f 6d6d 5f64  ..def merge_mm_d
-0005ac10: 6174 6166 7261 6d65 2868 6965 7264 662c  ataframe(hierdf,
-0005ac20: 206d 6d64 662c 206d 6d5f 7375 6666 6978   mmdf, mm_suffix
-0005ac30: 293a 0a20 2020 2074 7279 3a0a 2020 2020  ):.    try:.    
-0005ac40: 2020 2020 6869 6572 6466 203d 2068 6965      hierdf = hie
-0005ac50: 7264 662e 6d65 7267 6528 6d6d 6466 2c20  rdf.merge(mmdf, 
-0005ac60: 6f6e 3d5b 2773 6964 272c 2027 7669 7369  on=['sid', 'visi
-0005ac70: 7464 6174 6527 2c20 2774 3169 6d61 6765  tdate', 't1image
-0005ac80: 7569 6427 5d2c 2073 7566 6669 7865 733d  uid'], suffixes=
-0005ac90: 2822 222c 6d6d 5f73 7566 6669 7829 2c68  ("",mm_suffix),h
-0005aca0: 6f77 3d27 6c65 6674 2729 0a20 2020 2020  ow='left').     
-0005acb0: 2020 2072 6574 7572 6e20 6869 6572 6466     return hierdf
-0005acc0: 0a20 2020 2065 7863 6570 7420 4b65 7945  .    except KeyE
-0005acd0: 7272 6f72 3a0a 2020 2020 2020 2020 7265  rror:.        re
-0005ace0: 7475 726e 2068 6965 7264 660a 0a64 6566  turn hierdf..def
-0005acf0: 2061 7567 6d65 6e74 5f69 6d61 6765 2820   augment_image( 
-0005ad00: 782c 2020 6d61 785f 726f 743d 3130 2c20  x,  max_rot=10, 
-0005ad10: 6e7a 7364 3d31 2029 3a0a 2020 2020 7252  nzsd=1 ):.    rR
-0005ad20: 6f74 4765 6e65 7261 746f 7220 3d20 616e  otGenerator = an
-0005ad30: 7473 2e63 6f6e 7472 6962 2e52 616e 646f  ts.contrib.Rando
-0005ad40: 6d52 6f74 6174 6533 4428 2028 206d 6178  mRotate3D( ( max
-0005ad50: 5f72 6f74 2a28 2d31 2e30 292c 206d 6178  _rot*(-1.0), max
-0005ad60: 5f72 6f74 2029 2c20 7265 6665 7265 6e63  _rot ), referenc
-0005ad70: 653d 7820 290a 2020 2020 7478 203d 2072  e=x ).    tx = r
-0005ad80: 526f 7447 656e 6572 6174 6f72 2e74 7261  RotGenerator.tra
-0005ad90: 6e73 666f 726d 2829 0a20 2020 2069 7478  nsform().    itx
-0005ada0: 203d 2061 6e74 732e 696e 7665 7274 5f61   = ants.invert_a
-0005adb0: 6e74 735f 7472 616e 7366 6f72 6d28 7478  nts_transform(tx
-0005adc0: 290a 2020 2020 7920 3d20 616e 7473 2e61  ).    y = ants.a
-0005add0: 7070 6c79 5f61 6e74 735f 7472 616e 7366  pply_ants_transf
-0005ade0: 6f72 6d5f 746f 5f69 6d61 6765 2820 7478  orm_to_image( tx
-0005adf0: 2c20 782c 2078 2c20 696e 7465 7270 6f6c  , x, x, interpol
-0005ae00: 6174 696f 6e3d 276c 696e 6561 7227 290a  ation='linear').
-0005ae10: 2020 2020 7920 3d20 616e 7473 2e61 6464      y = ants.add
-0005ae20: 5f6e 6f69 7365 5f74 6f5f 696d 6167 6528  _noise_to_image(
-0005ae30: 2079 2c27 6164 6469 7469 7665 6761 7573   y,'additivegaus
-0005ae40: 7369 616e 272c 205b 302c 6e7a 7364 5d20  sian', [0,nzsd] 
-0005ae50: 290a 2020 2020 7265 7475 726e 2079 2c20  ).    return y, 
-0005ae60: 7478 2c20 6974 780a 0a64 6566 2062 6f6f  tx, itx..def boo
-0005ae70: 745f 776d 6828 2066 6c61 6972 2c20 7431  t_wmh( flair, t1
-0005ae80: 2c20 7431 7365 672c 206d 6d66 726f 6d63  , t1seg, mmfromc
-0005ae90: 6f6e 7665 7868 756c 6c20 3d20 302e 302c  onvexhull = 0.0,
-0005aea0: 2073 7472 6963 743d 5472 7565 2c0a 2020   strict=True,.  
-0005aeb0: 2020 2020 2020 7072 6f62 6162 696c 6974        probabilit
-0005aec0: 795f 6d61 736b 3d4e 6f6e 652c 2070 7269  y_mask=None, pri
-0005aed0: 6f72 5f70 726f 6261 6269 6c69 7479 3d4e  or_probability=N
-0005aee0: 6f6e 652c 206e 5f73 696d 756c 6174 696f  one, n_simulatio
-0005aef0: 6e73 3d31 362c 0a20 2020 2020 2020 2076  ns=16,.        v
-0005af00: 6572 626f 7365 3d46 616c 7365 2029 203a  erbose=False ) :
-0005af10: 0a20 2020 2069 6620 7665 7262 6f73 6520  .    if verbose 
-0005af20: 616e 6420 7072 696f 725f 7072 6f62 6162  and prior_probab
-0005af30: 696c 6974 7920 6973 204e 6f6e 653a 0a20  ility is None:. 
-0005af40: 2020 2020 2020 2070 7269 6e74 2822 6175         print("au
-0005af50: 676d 656e 7465 6420 666c 6169 7222 290a  gmented flair").
-0005af60: 2020 2020 6966 2076 6572 626f 7365 2061      if verbose a
-0005af70: 6e64 2070 7269 6f72 5f70 726f 6261 6269  nd prior_probabi
-0005af80: 6c69 7479 2069 7320 6e6f 7420 4e6f 6e65  lity is not None
-0005af90: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
-0005afa0: 2261 7567 6d65 6e74 6564 2066 6c61 6972  "augmented flair
-0005afb0: 2077 6974 6820 7072 696f 7222 290a 2020   with prior").  
-0005afc0: 2020 776d 685f 7375 6d5f 6175 6720 3d20    wmh_sum_aug = 
-0005afd0: 300a 2020 2020 776d 685f 7375 6d5f 7072  0.    wmh_sum_pr
-0005afe0: 696f 725f 6175 6720 3d20 300a 2020 2020  ior_aug = 0.    
-0005aff0: 6175 6770 726f 6220 3d20 666c 6169 7220  augprob = flair 
-0005b000: 2a20 302e 300a 2020 2020 6175 6770 726f  * 0.0.    augpro
-0005b010: 625f 7072 696f 7220 3d20 4e6f 6e65 0a20  b_prior = None. 
-0005b020: 2020 2069 6620 7072 696f 725f 7072 6f62     if prior_prob
-0005b030: 6162 696c 6974 7920 6973 206e 6f74 204e  ability is not N
-0005b040: 6f6e 653a 0a20 2020 2020 2020 2061 7567  one:.        aug
-0005b050: 7072 6f62 5f70 7269 6f72 203d 2066 6c61  prob_prior = fla
-0005b060: 6972 202a 2030 2e30 0a20 2020 2066 6f72  ir * 0.0.    for
-0005b070: 206e 2069 6e20 7261 6e67 6528 6e5f 7369   n in range(n_si
-0005b080: 6d75 6c61 7469 6f6e 7329 3a0a 2020 2020  mulations):.    
-0005b090: 2020 2020 6175 6766 6c61 6972 2c20 7478      augflair, tx
-0005b0a0: 2c20 6974 7820 3d20 6175 676d 656e 745f  , itx = augment_
-0005b0b0: 696d 6167 6528 2061 6e74 732e 694d 6174  image( ants.iMat
-0005b0c0: 6828 666c 6169 722c 224e 6f72 6d61 6c69  h(flair,"Normali
-0005b0d0: 7a65 2229 2c20 352c 2030 2e30 3120 290a  ze"), 5, 0.01 ).
-0005b0e0: 2020 2020 2020 2020 6c6f 6377 6d68 203d          locwmh =
-0005b0f0: 2077 6d68 2820 6175 6766 6c61 6972 2c20   wmh( augflair, 
-0005b100: 7431 2c20 7431 7365 672c 206d 6d66 726f  t1, t1seg, mmfro
-0005b110: 6d63 6f6e 7665 7868 756c 6c20 3d20 6d6d  mconvexhull = mm
-0005b120: 6672 6f6d 636f 6e76 6578 6875 6c6c 2c0a  fromconvexhull,.
-0005b130: 2020 2020 2020 2020 2020 2020 7374 7269              stri
-0005b140: 6374 3d73 7472 6963 742c 2070 726f 6261  ct=strict, proba
-0005b150: 6269 6c69 7479 5f6d 6173 6b3d 4e6f 6e65  bility_mask=None
-0005b160: 2c20 7072 696f 725f 7072 6f62 6162 696c  , prior_probabil
-0005b170: 6974 793d 7072 696f 725f 7072 6f62 6162  ity=prior_probab
-0005b180: 696c 6974 7920 290a 2020 2020 2020 2020  ility ).        
-0005b190: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-0005b1a0: 2020 2020 2020 2020 7072 696e 7428 2022          print( "
-0005b1b0: 666c 6169 7220 7369 6d3a 2022 202b 2073  flair sim: " + s
-0005b1c0: 7472 286e 2920 2b20 2220 766f 6c3a 2022  tr(n) + " vol: "
-0005b1d0: 202b 2073 7472 2820 6c6f 6377 6d68 5b27   + str( locwmh['
-0005b1e0: 776d 685f 6d61 7373 275d 2029 2b20 2220  wmh_mass'] )+ " 
-0005b1f0: 766f 6c2d 7072 696f 723a 2022 202b 2073  vol-prior: " + s
-0005b200: 7472 2820 6c6f 6377 6d68 5b27 776d 685f  tr( locwmh['wmh_
-0005b210: 6d61 7373 5f70 7269 6f72 275d 2029 2b20  mass_prior'] )+ 
-0005b220: 2220 736e 723a 2022 202b 2073 7472 2820  " snr: " + str( 
-0005b230: 6c6f 6377 6d68 5b27 776d 685f 534e 5227  locwmh['wmh_SNR'
-0005b240: 5d20 2920 290a 2020 2020 2020 2020 776d  ] ) ).        wm
-0005b250: 685f 7375 6d5f 6175 6720 3d20 776d 685f  h_sum_aug = wmh_
-0005b260: 7375 6d5f 6175 6720 2b20 6c6f 6377 6d68  sum_aug + locwmh
-0005b270: 5b27 776d 685f 6d61 7373 275d 0a20 2020  ['wmh_mass'].   
-0005b280: 2020 2020 2077 6d68 5f73 756d 5f70 7269       wmh_sum_pri
-0005b290: 6f72 5f61 7567 203d 2077 6d68 5f73 756d  or_aug = wmh_sum
-0005b2a0: 5f70 7269 6f72 5f61 7567 202b 206c 6f63  _prior_aug + loc
-0005b2b0: 776d 685b 2777 6d68 5f6d 6173 735f 7072  wmh['wmh_mass_pr
-0005b2c0: 696f 7227 5d0a 2020 2020 2020 2020 7465  ior'].        te
-0005b2d0: 6d70 203d 206c 6f63 776d 685b 2757 4d48  mp = locwmh['WMH
-0005b2e0: 5f70 726f 6261 6269 6c69 7479 5f6d 6170  _probability_map
-0005b2f0: 275d 0a20 2020 2020 2020 2061 7567 7072  '].        augpr
-0005b300: 6f62 203d 2061 7567 7072 6f62 202b 2061  ob = augprob + a
-0005b310: 6e74 732e 6170 706c 795f 616e 7473 5f74  nts.apply_ants_t
-0005b320: 7261 6e73 666f 726d 5f74 6f5f 696d 6167  ransform_to_imag
-0005b330: 6528 2069 7478 2c20 7465 6d70 2c20 666c  e( itx, temp, fl
-0005b340: 6169 722c 2069 6e74 6572 706f 6c61 7469  air, interpolati
-0005b350: 6f6e 3d27 6c69 6e65 6172 2729 0a20 2020  on='linear').   
-0005b360: 2020 2020 2069 6620 7072 696f 725f 7072       if prior_pr
-0005b370: 6f62 6162 696c 6974 7920 6973 206e 6f74  obability is not
-0005b380: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0005b390: 2020 2074 656d 7020 3d20 6c6f 6377 6d68     temp = locwmh
-0005b3a0: 5b27 574d 485f 706f 7374 6572 696f 725f  ['WMH_posterior_
-0005b3b0: 7072 6f62 6162 696c 6974 795f 6d61 7027  probability_map'
-0005b3c0: 5d0a 2020 2020 2020 2020 2020 2020 6175  ].            au
-0005b3d0: 6770 726f 625f 7072 696f 7220 3d20 6175  gprob_prior = au
-0005b3e0: 6770 726f 625f 7072 696f 7220 2b20 616e  gprob_prior + an
-0005b3f0: 7473 2e61 7070 6c79 5f61 6e74 735f 7472  ts.apply_ants_tr
-0005b400: 616e 7366 6f72 6d5f 746f 5f69 6d61 6765  ansform_to_image
-0005b410: 2820 6974 782c 2074 656d 702c 2066 6c61  ( itx, temp, fla
-0005b420: 6972 2c20 696e 7465 7270 6f6c 6174 696f  ir, interpolatio
-0005b430: 6e3d 276c 696e 6561 7227 290a 2020 2020  n='linear').    
-0005b440: 6175 6770 726f 6220 3d20 6175 6770 726f  augprob = augpro
-0005b450: 6220 2a20 2831 2e30 2f66 6c6f 6174 2820  b * (1.0/float( 
-0005b460: 6e5f 7369 6d75 6c61 7469 6f6e 7320 2929  n_simulations ))
-0005b470: 0a20 2020 2069 6620 7072 696f 725f 7072  .    if prior_pr
-0005b480: 6f62 6162 696c 6974 7920 6973 206e 6f74  obability is not
-0005b490: 204e 6f6e 653a 0a20 2020 2020 2020 2061   None:.        a
-0005b4a0: 7567 7072 6f62 5f70 7269 6f72 203d 2061  ugprob_prior = a
-0005b4b0: 7567 7072 6f62 5f70 7269 6f72 202a 2028  ugprob_prior * (
-0005b4c0: 312e 302f 666c 6f61 7428 206e 5f73 696d  1.0/float( n_sim
-0005b4d0: 756c 6174 696f 6e73 2029 290a 2020 2020  ulations )).    
-0005b4e0: 776d 685f 7375 6d5f 6175 6720 3d20 776d  wmh_sum_aug = wm
-0005b4f0: 685f 7375 6d5f 6175 6720 2f20 666c 6f61  h_sum_aug / floa
-0005b500: 7428 206e 5f73 696d 756c 6174 696f 6e73  t( n_simulations
-0005b510: 2029 0a20 2020 2077 6d68 5f73 756d 5f70   ).    wmh_sum_p
-0005b520: 7269 6f72 5f61 7567 203d 2077 6d68 5f73  rior_aug = wmh_s
-0005b530: 756d 5f70 7269 6f72 5f61 7567 202f 2066  um_prior_aug / f
-0005b540: 6c6f 6174 2820 6e5f 7369 6d75 6c61 7469  loat( n_simulati
-0005b550: 6f6e 7320 290a 2020 2020 7265 7475 726e  ons ).    return
-0005b560: 7b0a 2020 2020 2020 2766 6c61 6972 2720  {.      'flair' 
-0005b570: 3a20 616e 7473 2e69 4d61 7468 2866 6c61  : ants.iMath(fla
-0005b580: 6972 2c22 4e6f 726d 616c 697a 6522 292c  ir,"Normalize"),
-0005b590: 0a20 2020 2020 2027 574d 485f 7072 6f62  .      'WMH_prob
-0005b5a0: 6162 696c 6974 795f 6d61 7027 203a 2061  ability_map' : a
-0005b5b0: 7567 7072 6f62 2c0a 2020 2020 2020 2757  ugprob,.      'W
-0005b5c0: 4d48 5f70 6f73 7465 7269 6f72 5f70 726f  MH_posterior_pro
-0005b5d0: 6261 6269 6c69 7479 5f6d 6170 2720 3a20  bability_map' : 
-0005b5e0: 6175 6770 726f 625f 7072 696f 722c 0a20  augprob_prior,. 
-0005b5f0: 2020 2020 2027 776d 685f 6d61 7373 273a       'wmh_mass':
-0005b600: 2077 6d68 5f73 756d 5f61 7567 2c0a 2020   wmh_sum_aug,.  
-0005b610: 2020 2020 2777 6d68 5f6d 6173 735f 7072      'wmh_mass_pr
-0005b620: 696f 7227 3a20 776d 685f 7375 6d5f 7072  ior': wmh_sum_pr
-0005b630: 696f 725f 6175 672c 0a20 2020 2020 2027  ior_aug,.      '
-0005b640: 776d 685f 6576 7227 3a20 6c6f 6377 6d68  wmh_evr': locwmh
-0005b650: 5b27 776d 685f 6576 7227 5d2c 0a20 2020  ['wmh_evr'],.   
-0005b660: 2020 2027 776d 685f 534e 5227 3a20 6c6f     'wmh_SNR': lo
-0005b670: 6377 6d68 5b27 776d 685f 534e 5227 5d20  cwmh['wmh_SNR'] 
-0005b680: 207d 0a0a 0a64 6566 2074 6872 6561 6465   }...def threade
-0005b690: 645f 6269 6e64 5f77 6964 655f 6d6d 5f63  d_bind_wide_mm_c
-0005b6a0: 7376 7328 206d 6d5f 7769 6465 5f63 7376  svs( mm_wide_csv
-0005b6b0: 732c 206e 5f77 6f72 6b65 7273 2029 3a0a  s, n_workers ):.
-0005b6c0: 2020 2020 6672 6f6d 2063 6f6e 6375 7272      from concurr
-0005b6d0: 656e 742e 6675 7475 7265 7320 696d 706f  ent.futures impo
-0005b6e0: 7274 2061 735f 636f 6d70 6c65 7465 640a  rt as_completed.
-0005b6f0: 2020 2020 6672 6f6d 2063 6f6e 6375 7272      from concurr
-0005b700: 656e 7420 696d 706f 7274 2066 7574 7572  ent import futur
-0005b710: 6573 0a20 2020 2069 6d70 6f72 7420 636f  es.    import co
-0005b720: 6e63 7572 7265 6e74 2e66 7574 7572 6573  ncurrent.futures
-0005b730: 0a20 2020 2064 6566 2063 6875 6e6b 7328  .    def chunks(
-0005b740: 6c2c 206e 293a 0a20 2020 2020 2020 2022  l, n):.        "
-0005b750: 2222 5969 656c 6420 6e20 6e75 6d62 6572  ""Yield n number
-0005b760: 206f 6620 7365 7175 656e 7469 616c 2063   of sequential c
-0005b770: 6875 6e6b 7320 6672 6f6d 206c 2e22 2222  hunks from l."""
-0005b780: 0a20 2020 2020 2020 2064 2c20 7220 3d20  .        d, r = 
-0005b790: 6469 766d 6f64 286c 656e 286c 292c 206e  divmod(len(l), n
-0005b7a0: 290a 2020 2020 2020 2020 666f 7220 6920  ).        for i 
-0005b7b0: 696e 2072 616e 6765 286e 293a 0a20 2020  in range(n):.   
-0005b7c0: 2020 2020 2020 2020 2073 6920 3d20 2864           si = (d
-0005b7d0: 2b31 292a 2869 2069 6620 6920 3c20 7220  +1)*(i if i < r 
-0005b7e0: 656c 7365 2072 2920 2b20 642a 2830 2069  else r) + d*(0 i
-0005b7f0: 6620 6920 3c20 7220 656c 7365 2069 202d  f i < r else i -
-0005b800: 2072 290a 2020 2020 2020 2020 2020 2020   r).            
-0005b810: 7969 656c 6420 6c5b 7369 3a73 692b 2864  yield l[si:si+(d
-0005b820: 2b31 2069 6620 6920 3c20 7220 656c 7365  +1 if i < r else
-0005b830: 2064 295d 0a20 2020 2069 6d70 6f72 7420   d)].    import 
-0005b840: 6e75 6d70 7920 6173 206e 700a 2020 2020  numpy as np.    
-0005b850: 6e65 7778 203d 206c 6973 7428 2063 6875  newx = list( chu
-0005b860: 6e6b 7328 206d 6d5f 7769 6465 5f63 7376  nks( mm_wide_csv
-0005b870: 732c 206e 5f77 6f72 6b65 7273 2029 2029  s, n_workers ) )
-0005b880: 0a20 2020 2069 6d70 6f72 7420 7061 6e64  .    import pand
-0005b890: 6173 2061 7320 7064 0a20 2020 2061 6c6c  as as pd.    all
-0005b8a0: 6466 203d 2070 642e 4461 7461 4672 616d  df = pd.DataFram
-0005b8b0: 6528 290a 2020 2020 616c 6c64 6661 7667  e().    alldfavg
-0005b8c0: 203d 2070 642e 4461 7461 4672 616d 6528   = pd.DataFrame(
-0005b8d0: 290a 2020 2020 7769 7468 2066 7574 7572  ).    with futur
-0005b8e0: 6573 2e54 6872 6561 6450 6f6f 6c45 7865  es.ThreadPoolExe
-0005b8f0: 6375 746f 7228 6d61 785f 776f 726b 6572  cutor(max_worker
-0005b900: 733d 6e5f 776f 726b 6572 7329 2061 7320  s=n_workers) as 
-0005b910: 6578 6563 7574 6f72 3a0a 2020 2020 2020  executor:.      
-0005b920: 2020 746f 5f64 6f20 3d20 5b5d 0a20 2020    to_do = [].   
-0005b930: 2020 2020 2066 6f72 2067 726f 7570 2069       for group i
-0005b940: 6e20 7261 6e67 6528 6c65 6e28 6e65 7778  n range(len(newx
-0005b950: 2929 203a 0a20 2020 2020 2020 2020 2020  )) :.           
-0005b960: 2066 7574 7572 6520 3d20 6578 6563 7574   future = execut
-0005b970: 6f72 2e73 7562 6d69 7428 6269 6e64 5f77  or.submit(bind_w
-0005b980: 6964 655f 6d6d 5f63 7376 732c 206e 6577  ide_mm_csvs, new
-0005b990: 785b 6772 6f75 705d 2029 0a20 2020 2020  x[group] ).     
-0005b9a0: 2020 2020 2020 2074 6f5f 646f 2e61 7070         to_do.app
-0005b9b0: 656e 6428 6675 7475 7265 290a 2020 2020  end(future).    
-0005b9c0: 2020 2020 7265 7375 6c74 7320 3d20 5b5d      results = []
-0005b9d0: 0a20 2020 2020 2020 2066 6f72 2066 7574  .        for fut
-0005b9e0: 7572 6520 696e 2066 7574 7572 6573 2e61  ure in futures.a
-0005b9f0: 735f 636f 6d70 6c65 7465 6428 746f 5f64  s_completed(to_d
-0005ba00: 6f29 3a0a 2020 2020 2020 2020 2020 2020  o):.            
-0005ba10: 7265 7330 2c20 7265 7331 203d 2066 7574  res0, res1 = fut
-0005ba20: 7572 652e 7265 7375 6c74 2829 0a20 2020  ure.result().   
-0005ba30: 2020 2020 2020 2020 2061 6c6c 6466 3d70           alldf=p
-0005ba40: 642e 636f 6e63 6174 2820 205b 616c 6c64  d.concat(  [alld
-0005ba50: 662c 2072 6573 3020 5d2c 2061 7869 733d  f, res0 ], axis=
-0005ba60: 302c 2069 676e 6f72 655f 696e 6465 783d  0, ignore_index=
-0005ba70: 4661 6c73 6520 290a 2020 2020 2020 2020  False ).        
-0005ba80: 2020 2020 616c 6c64 6661 7667 3d70 642e      alldfavg=pd.
-0005ba90: 636f 6e63 6174 2820 205b 616c 6c64 6661  concat(  [alldfa
-0005baa0: 7667 2c20 7265 7331 205d 2c20 6178 6973  vg, res1 ], axis
-0005bab0: 3d30 2c20 6967 6e6f 7265 5f69 6e64 6578  =0, ignore_index
-0005bac0: 3d46 616c 7365 2029 0a20 2020 2072 6574  =False ).    ret
-0005bad0: 7572 6e20 616c 6c64 662c 2061 6c6c 6466  urn alldf, alldf
-0005bae0: 6176 670a 0a0a 6465 6620 6765 745f 6e61  avg...def get_na
-0005baf0: 6d65 735f 6672 6f6d 5f64 6174 615f 6672  mes_from_data_fr
-0005bb00: 616d 6528 782c 2064 656d 6f67 496e 2c20  ame(x, demogIn, 
-0005bb10: 6578 636c 7573 696f 6e73 3d4e 6f6e 6529  exclusions=None)
-0005bb20: 3a0a 2020 2020 2222 220a 2020 2020 6461  :.    """.    da
-0005bb30: 7461 203d 207b 274e 616d 6527 3a5b 2754  ta = {'Name':['T
-0005bb40: 6f6d 272c 2027 6e69 636b 272c 2027 6b72  om', 'nick', 'kr
-0005bb50: 6973 6827 2c20 276a 6163 6b27 5d2c 2027  ish', 'jack'], '
-0005bb60: 4167 6527 3a5b 3230 2c20 3231 2c20 3139  Age':[20, 21, 19
-0005bb70: 2c20 3138 5d7d 0a20 2020 2061 6e74 7370  , 18]}.    antsp
-0005bb80: 796d 6d2e 6765 745f 6e61 6d65 735f 6672  ymm.get_names_fr
-0005bb90: 6f6d 5f64 6174 615f 6672 616d 6528 205b  om_data_frame( [
-0005bba0: 2765 275d 2c20 6466 2029 0a20 2020 2061  'e'], df ).    a
-0005bbb0: 6e74 7370 796d 6d2e 6765 745f 6e61 6d65  ntspymm.get_name
-0005bbc0: 735f 6672 6f6d 5f64 6174 615f 6672 616d  s_from_data_fram
-0005bbd0: 6528 205b 2761 272c 2765 275d 2c20 6466  e( ['a','e'], df
-0005bbe0: 2029 0a20 2020 2061 6e74 7370 796d 6d2e   ).    antspymm.
-0005bbf0: 6765 745f 6e61 6d65 735f 6672 6f6d 5f64  get_names_from_d
-0005bc00: 6174 615f 6672 616d 6528 205b 2765 275d  ata_frame( ['e']
-0005bc10: 2c20 6466 2c20 6578 636c 7573 696f 6e73  , df, exclusions
-0005bc20: 3d27 4e27 2029 0a20 2020 2022 2222 0a20  ='N' ).    """. 
-0005bc30: 2020 2023 2043 6865 636b 2069 6620 7820     # Check if x 
-0005bc40: 6973 2061 2073 7472 696e 6720 616e 6420  is a string and 
-0005bc50: 636f 6e76 6572 7420 6974 2074 6f20 6120  convert it to a 
-0005bc60: 6c69 7374 0a20 2020 2069 6620 6973 696e  list.    if isin
-0005bc70: 7374 616e 6365 2878 2c20 7374 7229 3a0a  stance(x, str):.
-0005bc80: 2020 2020 2020 2020 7820 3d20 5b78 5d0a          x = [x].
-0005bc90: 2020 2020 6465 6620 6765 745f 756e 6971      def get_uniq
-0005bca0: 7565 2820 7171 2029 3a0a 2020 2020 2020  ue( qq ):.      
-0005bcb0: 2020 756e 6971 7565 203d 205b 5d0a 2020    unique = [].  
-0005bcc0: 2020 2020 2020 666f 7220 6e75 6d62 6572        for number
-0005bcd0: 2069 6e20 7171 3a0a 2020 2020 2020 2020   in qq:.        
-0005bce0: 2020 2020 6966 206e 756d 6265 7220 696e      if number in
-0005bcf0: 2075 6e69 7175 653a 0a20 2020 2020 2020   unique:.       
-0005bd00: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-0005bd10: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
-0005bd20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0005bd30: 2020 2020 756e 6971 7565 2e61 7070 656e      unique.appen
-0005bd40: 6428 6e75 6d62 6572 290a 2020 2020 2020  d(number).      
-0005bd50: 2020 7265 7475 726e 2075 6e69 7175 650a    return unique.
-0005bd60: 2020 2020 6f75 746e 616d 6573 203d 206c      outnames = l
-0005bd70: 6973 7428 6465 6d6f 6749 6e2e 636f 6c75  ist(demogIn.colu
-0005bd80: 6d6e 735b 6465 6d6f 6749 6e2e 636f 6c75  mns[demogIn.colu
-0005bd90: 6d6e 732e 7374 722e 636f 6e74 6169 6e73  mns.str.contains
-0005bda0: 2878 5b30 5d29 5d29 0a20 2020 2069 6620  (x[0])]).    if 
-0005bdb0: 6c65 6e28 7829 203e 2031 3a0a 2020 2020  len(x) > 1:.    
-0005bdc0: 2020 2020 666f 7220 7920 696e 2078 5b31      for y in x[1
-0005bdd0: 3a5d 3a0a 2020 2020 2020 2020 2020 2020  :]:.            
-0005bde0: 6f75 746e 616d 6573 203d 205b 6920 666f  outnames = [i fo
-0005bdf0: 7220 6920 696e 206f 7574 6e61 6d65 7320  r i in outnames 
-0005be00: 6966 2079 2069 6e20 695d 0a20 2020 206f  if y in i].    o
-0005be10: 7574 6e61 6d65 7320 3d20 6765 745f 756e  utnames = get_un
-0005be20: 6971 7565 2820 6f75 746e 616d 6573 2029  ique( outnames )
-0005be30: 0a20 2020 2069 6620 6578 636c 7573 696f  .    if exclusio
-0005be40: 6e73 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ns is not None:.
-0005be50: 2020 2020 2020 2020 746f 6578 636c 7564          toexclud
-0005be60: 6520 3d20 5b6e 616d 6520 666f 7220 6e61  e = [name for na
-0005be70: 6d65 2069 6e20 6f75 746e 616d 6573 2069  me in outnames i
-0005be80: 6620 6578 636c 7573 696f 6e73 5b30 5d20  f exclusions[0] 
-0005be90: 696e 206e 616d 6520 5d0a 2020 2020 2020  in name ].      
-0005bea0: 2020 6966 206c 656e 2865 7863 6c75 7369    if len(exclusi
-0005beb0: 6f6e 7329 203e 2031 3a0a 2020 2020 2020  ons) > 1:.      
-0005bec0: 2020 2020 2020 666f 7220 7a7a 2069 6e20        for zz in 
-0005bed0: 6578 636c 7573 696f 6e73 5b31 3a5d 3a0a  exclusions[1:]:.
-0005bee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005bef0: 746f 6578 636c 7564 652e 6578 7465 6e64  toexclude.extend
-0005bf00: 285b 6e61 6d65 2066 6f72 206e 616d 6520  ([name for name 
-0005bf10: 696e 206f 7574 6e61 6d65 7320 6966 207a  in outnames if z
-0005bf20: 7a20 696e 206e 616d 6520 5d29 0a20 2020  z in name ]).   
-0005bf30: 2020 2020 2069 6620 6c65 6e28 746f 6578       if len(toex
-0005bf40: 636c 7564 6529 203e 2030 3a0a 2020 2020  clude) > 0:.    
-0005bf50: 2020 2020 2020 2020 6f75 746e 616d 6573          outnames
-0005bf60: 203d 205b 6e61 6d65 2066 6f72 206e 616d   = [name for nam
-0005bf70: 6520 696e 206f 7574 6e61 6d65 7320 6966  e in outnames if
-0005bf80: 206e 616d 6520 6e6f 7420 696e 2074 6f65   name not in toe
-0005bf90: 7863 6c75 6465 5d0a 2020 2020 7265 7475  xclude].    retu
-0005bfa0: 726e 206f 7574 6e61 6d65 730a 0a0a 6465  rn outnames...de
-0005bfb0: 6620 6176 6572 6167 655f 6d6d 5f64 6628  f average_mm_df(
-0005bfc0: 206a 6d6d 5f69 6e2c 2064 6961 676e 6f73   jmm_in, diagnos
-0005bfd0: 7469 635f 6e3d 3235 2c20 636f 7272 5f74  tic_n=25, corr_t
-0005bfe0: 6872 6573 683d 302e 392c 2076 6572 626f  hresh=0.9, verbo
-0005bff0: 7365 3d46 616c 7365 2029 3a0a 2020 2020  se=False ):.    
-0005c000: 2222 220a 2020 2020 6a6d 726f 7761 7667  """.    jmrowavg
-0005c010: 2c20 6a6d 6d63 6f6c 6176 672c 2064 6961  , jmmcolavg, dia
-0005c020: 676e 6f73 7469 6373 203d 2061 6e74 7370  gnostics = antsp
-0005c030: 796d 6d2e 6176 6572 6167 655f 6d6d 5f64  ymm.average_mm_d
-0005c040: 6628 206a 6d6d 5f69 6e2c 2076 6572 626f  f( jmm_in, verbo
-0005c050: 7365 3d54 7275 6520 290a 2020 2020 2222  se=True ).    ""
-0005c060: 220a 0a20 2020 206a 6d6d 203d 206a 6d6d  "..    jmm = jmm
-0005c070: 5f69 6e2e 636f 7079 2829 0a20 2020 2064  _in.copy().    d
-0005c080: 7863 6f6c 733d 5b27 7375 626a 6563 7469  xcols=['subjecti
-0005c090: 6431 272c 2773 7562 6a65 6374 6964 3227  d1','subjectid2'
-0005c0a0: 2c27 6d6f 6461 6c69 7479 6964 272c 276a  ,'modalityid','j
-0005c0b0: 6f69 6e69 6427 2c27 636f 7272 656c 6174  oinid','correlat
-0005c0c0: 696f 6e27 2c27 6469 7374 616e 6365 275d  ion','distance']
-0005c0d0: 0a20 2020 206a 6f69 6e44 6961 676e 6f73  .    joinDiagnos
-0005c0e0: 7469 6373 203d 2070 642e 4461 7461 4672  tics = pd.DataFr
-0005c0f0: 616d 6528 2063 6f6c 756d 6e73 203d 2064  ame( columns = d
-0005c100: 7863 6f6c 7320 290a 2020 2020 6e61 6e4c  xcols ).    nanL
-0005c110: 6973 743d 5b6d 6174 682e 6e61 6e5d 0a20  ist=[math.nan]. 
-0005c120: 2020 2064 6566 2072 6f62 2878 2c20 793d     def rob(x, y=
-0005c130: 302e 3939 293a 0a20 2020 2020 2020 2078  0.99):.        x
-0005c140: 5b78 203e 206e 702e 7175 616e 7469 6c65  [x > np.quantile
-0005c150: 2878 2c20 792c 206e 616e 5f70 6f6c 6963  (x, y, nan_polic
-0005c160: 793d 226f 6d69 7422 295d 203d 206e 702e  y="omit")] = np.
-0005c170: 6e61 6e0a 2020 2020 2020 2020 7265 7475  nan.        retu
-0005c180: 726e 2078 0a0a 2020 2020 6a6d 6d20 3d20  rn x..    jmm = 
-0005c190: 6a6d 6d2e 7265 706c 6163 6528 7227 5e5c  jmm.replace(r'^\
-0005c1a0: 732a 2427 2c20 6e70 2e6e 616e 2c20 7265  s*$', np.nan, re
-0005c1b0: 6765 783d 5472 7565 290a 0a20 2020 2069  gex=True)..    i
-0005c1c0: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-0005c1d0: 2020 2070 7269 6e74 2822 646f 2072 7366     print("do rsf
-0005c1e0: 4d52 4922 290a 2020 2020 2320 6865 7265  MRI").    # here
-0005c1f0: 202d 2077 6520 6669 7273 7420 6861 7665   - we first have
-0005c200: 2074 6f20 6176 6572 6167 6520 7769 7468   to average with
-0005c210: 696e 2065 6163 6820 726f 770a 2020 2020  in each row.    
-0005c220: 6474 3020 3d20 6765 745f 6e61 6d65 735f  dt0 = get_names_
-0005c230: 6672 6f6d 5f64 6174 615f 6672 616d 6528  from_data_frame(
-0005c240: 5b22 7273 664d 5249 225d 2c20 6a6d 6d2c  ["rsfMRI"], jmm,
-0005c250: 2065 7863 6c75 7369 6f6e 733d 5b22 556e   exclusions=["Un
-0005c260: 6e61 6d65 6422 2c20 2272 7366 4d52 495f  named", "rsfMRI_
-0005c270: 4c52 222c 2022 7273 664d 5249 5f52 4c22  LR", "rsfMRI_RL"
-0005c280: 5d29 0a20 2020 2064 7431 203d 2067 6574  ]).    dt1 = get
-0005c290: 5f6e 616d 6573 5f66 726f 6d5f 6461 7461  _names_from_data
-0005c2a0: 5f66 7261 6d65 285b 2272 7366 4d52 495f  _frame(["rsfMRI_
-0005c2b0: 524c 225d 2c20 6a6d 6d2c 2065 7863 6c75  RL"], jmm, exclu
-0005c2c0: 7369 6f6e 733d 5b22 556e 6e61 6d65 6422  sions=["Unnamed"
-0005c2d0: 5d29 0a20 2020 2069 6620 6c65 6e28 2064  ]).    if len( d
-0005c2e0: 7430 2029 203e 2030 2061 6e64 206c 656e  t0 ) > 0 and len
-0005c2f0: 2820 6474 3120 2920 3e20 303a 0a20 2020  ( dt1 ) > 0:.   
-0005c300: 2020 2020 2066 6c69 6420 3d20 6474 305b       flid = dt0[
-0005c310: 305d 0a20 2020 2020 2020 2077 726f 7773  0].        wrows
-0005c320: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
-0005c330: 7220 6920 696e 2072 616e 6765 286a 6d6d  r i in range(jmm
-0005c340: 2e73 6861 7065 5b30 5d29 3a0a 2020 2020  .shape[0]):.    
-0005c350: 2020 2020 2020 2020 6966 206e 6f74 2070          if not p
-0005c360: 642e 6973 6e61 286a 6d6d 5b64 7430 5b31  d.isna(jmm[dt0[1
-0005c370: 5d5d 5b69 5d29 206f 7220 6e6f 7420 7064  ]][i]) or not pd
-0005c380: 2e69 736e 6128 6a6d 6d5b 6474 315b 315d  .isna(jmm[dt1[1]
-0005c390: 5d5b 695d 2920 3a0a 2020 2020 2020 2020  ][i]) :.        
-0005c3a0: 2020 2020 2020 2020 7772 6f77 732e 6170          wrows.ap
-0005c3b0: 7065 6e64 2869 290a 2020 2020 2020 2020  pend(i).        
-0005c3c0: 666f 7220 6b20 696e 2077 726f 7773 3a0a  for k in wrows:.
-0005c3d0: 2020 2020 2020 2020 2020 2020 7631 203d              v1 =
-0005c3e0: 206a 6d6d 2e69 6c6f 635b 6b5d 5b64 7430   jmm.iloc[k][dt0
-0005c3f0: 5b31 3a5d 5d2e 6173 7479 7065 2866 6c6f  [1:]].astype(flo
-0005c400: 6174 290a 2020 2020 2020 2020 2020 2020  at).            
-0005c410: 7632 203d 206a 6d6d 2e69 6c6f 635b 6b5d  v2 = jmm.iloc[k]
-0005c420: 5b64 7431 5b31 3a5d 5d2e 6173 7479 7065  [dt1[1:]].astype
-0005c430: 2866 6c6f 6174 290a 2020 2020 2020 2020  (float).        
-0005c440: 2020 2020 7676 6563 203d 205b 7631 5b30      vvec = [v1[0
-0005c450: 5d2c 2076 325b 305d 5d0a 2020 2020 2020  ], v2[0]].      
-0005c460: 2020 2020 2020 6966 2061 6e79 287e 6e70        if any(~np
-0005c470: 2e69 736e 616e 2876 7665 6329 293a 0a20  .isnan(vvec)):. 
-0005c480: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0005c490: 796e 6e61 203d 205b 6920 666f 7220 692c  ynna = [i for i,
-0005c4a0: 2078 2069 6e20 656e 756d 6572 6174 6528   x in enumerate(
-0005c4b0: 7676 6563 2920 6966 207e 6e70 2e69 736e  vvec) if ~np.isn
-0005c4c0: 616e 2878 295d 0a20 2020 2020 2020 2020  an(x)].         
-0005c4d0: 2020 2020 2020 206a 6d6d 2e69 6c6f 635b         jmm.iloc[
-0005c4e0: 6b5d 5b64 7430 5b30 5d5d 203d 2027 7273  k][dt0[0]] = 'rs
-0005c4f0: 664d 5249 270a 2020 2020 2020 2020 2020  fMRI'.          
-0005c500: 2020 2020 2020 6966 206c 656e 286d 796e        if len(myn
-0005c510: 6e61 2920 3d3d 2031 3a0a 2020 2020 2020  na) == 1:.      
-0005c520: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0005c530: 206d 796e 6e61 5b30 5d20 3d3d 2030 3a0a   mynna[0] == 0:.
-0005c540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c550: 2020 2020 2020 2020 6a6d 6d2e 696c 6f63          jmm.iloc
-0005c560: 5b6b 5d5b 6474 305b 313a 5d5d 203d 2076  [k][dt0[1:]] = v
-0005c570: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-0005c580: 2020 2020 2020 6966 206d 796e 6e61 5b30        if mynna[0
-0005c590: 5d20 3d3d 2031 3a0a 2020 2020 2020 2020  ] == 1:.        
+00059c80: 2020 2020 2020 2020 2020 2020 2020 6d6d                mm
+00059c90: 2e70 6f70 2820 7171 2029 0a20 2020 2020  .pop( qq ).     
+00059ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059cb0: 2020 2023 206d 6d2e 696e 6465 783d 6373     # mm.index=cs
+00059cc0: 7672 6f77 2e69 6e64 6578 0a20 2020 2020  vrow.index.     
+00059cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059ce0: 2020 2075 6964 6e61 6d65 203d 206d 6f64     uidname = mod
+00059cf0: 5f6e 616d 6520 2b20 275f 6d6d 7769 6465  _name + '_mmwide
+00059d00: 5f66 696c 656e 616d 6527 0a20 2020 2020  _filename'.     
+00059d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059d20: 2020 206d 6d5b 2075 6964 6e61 6d65 205d     mm[ uidname ]
+00059d30: 203d 2072 6f6f 7469 640a 2020 2020 2020   = rootid.      
+00059d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059d50: 2020 6373 7672 6f77 3d70 642e 636f 6e63    csvrow=pd.conc
+00059d60: 6174 2820 5b63 7376 726f 772c 6d6d 5d2c  at( [csvrow,mm],
+00059d70: 2061 7869 733d 312c 2069 676e 6f72 655f   axis=1, ignore_
+00059d80: 696e 6465 783d 4661 6c73 6520 290a 2020  index=False ).  
+00059d90: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00059da0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00059db0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+00059dc0: 7365 2061 6e64 2072 6570 6f72 745f 6d69  se and report_mi
+00059dd0: 7373 696e 673a 0a20 2020 2020 2020 2020  ssing:.         
+00059de0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00059df0: 7269 6e74 2820 6e72 6777 6964 6566 6e20  rint( nrgwidefn 
+00059e00: 2b20 2220 6162 7365 6e74 2229 0a20 2020  + " absent").   
+00059e10: 2020 2020 2069 6620 616c 6c64 662e 7368       if alldf.sh
+00059e20: 6170 655b 305d 203d 3d20 303a 0a20 2020  ape[0] == 0:.   
+00059e30: 2020 2020 2020 2020 2061 6c6c 6466 203d           alldf =
+00059e40: 2063 7376 726f 772e 636f 7079 2829 0a20   csvrow.copy(). 
+00059e50: 2020 2020 2020 2020 2020 2061 6c6c 6466             alldf
+00059e60: 203d 2061 6c6c 6466 2e6c 6f63 5b3a 2c7e   = alldf.loc[:,~
+00059e70: 616c 6c64 662e 636f 6c75 6d6e 732e 6475  alldf.columns.du
+00059e80: 706c 6963 6174 6564 2829 5d0a 2020 2020  plicated()].    
+00059e90: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00059ea0: 2020 2020 2020 6373 7672 6f77 3d63 7376        csvrow=csv
+00059eb0: 726f 772e 6c6f 635b 3a2c 7e63 7376 726f  row.loc[:,~csvro
+00059ec0: 772e 636f 6c75 6d6e 732e 6475 706c 6963  w.columns.duplic
+00059ed0: 6174 6564 2829 5d0a 2020 2020 2020 2020  ated()].        
+00059ee0: 2020 2020 616c 6c64 6620 3d20 616c 6c64      alldf = alld
+00059ef0: 662e 6c6f 635b 3a2c 7e61 6c6c 6466 2e63  f.loc[:,~alldf.c
+00059f00: 6f6c 756d 6e73 2e64 7570 6c69 6361 7465  olumns.duplicate
+00059f10: 6428 295d 0a20 2020 2020 2020 2020 2020  d()].           
+00059f20: 2061 6c6c 6466 203d 2070 642e 636f 6e63   alldf = pd.conc
+00059f30: 6174 2820 5b61 6c6c 6466 2c20 6373 7672  at( [alldf, csvr
+00059f40: 6f77 5d2c 2061 7869 733d 302c 2069 676e  ow], axis=0, ign
+00059f50: 6f72 655f 696e 6465 783d 5472 7565 2029  ore_index=True )
+00059f60: 0a20 2020 2072 6574 7572 6e20 616c 6c64  .    return alld
+00059f70: 660a 0a64 6566 2061 7373 656d 626c 655f  f..def assemble_
+00059f80: 6d6f 6461 6c69 7479 5f73 7065 6369 6669  modality_specifi
+00059f90: 635f 6461 7461 6672 616d 6573 2820 6d6d  c_dataframes( mm
+00059fa0: 5f77 6964 655f 6373 7673 2c20 6869 6572  _wide_csvs, hier
+00059fb0: 6466 696e 2c20 6e72 675f 6d6f 6461 6c69  dfin, nrg_modali
+00059fc0: 7479 2c20 7365 7061 7261 746f 723d 272d  ty, separator='-
+00059fd0: 272c 2070 726f 6772 6573 733d 4e6f 6e65  ', progress=None
+00059fe0: 2c20 7665 7262 6f73 653d 4661 6c73 6520  , verbose=False 
+00059ff0: 293a 0a20 2020 206d 6f64 6465 7273 7562  ):.    moddersub
+0005a000: 203d 2072 652e 7375 6228 2022 5b2a 5d22   = re.sub( "[*]"
+0005a010: 2c22 222c 6e72 675f 6d6f 6461 6c69 7479  ,"",nrg_modality
+0005a020: 290a 2020 2020 6e6d 6466 3d70 642e 4461  ).    nmdf=pd.Da
+0005a030: 7461 4672 616d 6528 290a 2020 2020 666f  taFrame().    fo
+0005a040: 7220 6b20 696e 2072 616e 6765 2820 6869  r k in range( hi
+0005a050: 6572 6466 696e 2e73 6861 7065 5b30 5d20  erdfin.shape[0] 
+0005a060: 293a 0a20 2020 2020 2020 2069 6620 7072  ):.        if pr
+0005a070: 6f67 7265 7373 2069 7320 6e6f 7420 4e6f  ogress is not No
+0005a080: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0005a090: 6966 206b 2025 2070 726f 6772 6573 7320  if k % progress 
+0005a0a0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+0005a0b0: 2020 2020 2020 7072 6f67 6765 7220 3d20        progger = 
+0005a0c0: 7374 7228 206e 702e 726f 756e 6428 206b  str( np.round( k
+0005a0d0: 202f 2068 6965 7264 6669 6e2e 7368 6170   / hierdfin.shap
+0005a0e0: 655b 305d 202a 2031 3030 2029 2029 0a20  e[0] * 100 ) ). 
+0005a0f0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0005a100: 7269 6e74 2820 7072 6f67 6765 722c 2065  rint( progger, e
+0005a110: 6e64 203d 222e 2e2e 222c 2066 6c75 7368  nd ="...", flush
+0005a120: 3d54 7275 6529 0a20 2020 2020 2020 2074  =True).        t
+0005a130: 656d 7020 3d20 6d6d 5f77 6964 655f 6373  emp = mm_wide_cs
+0005a140: 7673 5b6b 5d0a 2020 2020 2020 2020 6d79  vs[k].        my
+0005a150: 7061 7274 7366 203d 2074 656d 702e 7370  partsf = temp.sp
+0005a160: 6c69 7428 2254 3177 4869 6572 6172 6368  lit("T1wHierarch
+0005a170: 6963 616c 2229 0a20 2020 2020 2020 206d  ical").        m
+0005a180: 7970 6172 7473 203d 206d 7970 6172 7473  yparts = myparts
+0005a190: 665b 305d 0a20 2020 2020 2020 2074 3169  f[0].        t1i
+0005a1a0: 6964 203d 2073 7472 286d 7970 6172 7473  id = str(myparts
+0005a1b0: 665b 315d 2e73 706c 6974 2822 2f22 295b  f[1].split("/")[
+0005a1c0: 315d 290a 2020 2020 2020 2020 666e 736e  1]).        fnsn
+0005a1d0: 6d20 3d20 676c 6f62 2e67 6c6f 6228 6d79  m = glob.glob(my
+0005a1e0: 7061 7274 732b 222f 2220 2b20 6e72 675f  parts+"/" + nrg_
+0005a1f0: 6d6f 6461 6c69 7479 202b 2022 2f2a 2f2a  modality + "/*/*
+0005a200: 2220 2b20 7431 6969 6420 2b20 222a 7769  " + t1iid + "*wi
+0005a210: 6465 2e63 7376 2229 0a20 2020 2020 2020  de.csv").       
+0005a220: 2069 6620 6c65 6e28 2066 6e73 6e6d 2029   if len( fnsnm )
+0005a230: 203e 2030 203a 0a20 2020 2020 2020 2020   > 0 :.         
+0005a240: 2020 2066 6f72 2079 2069 6e20 666e 736e     for y in fnsn
+0005a250: 6d3a 0a20 2020 2020 2020 2020 2020 2020  m:.             
+0005a260: 2020 2074 656d 703d 7265 6164 5f6d 6d5f     temp=read_mm_
+0005a270: 6373 7628 2079 2c20 636f 6c70 7265 6669  csv( y, colprefi
+0005a280: 783d 6d6f 6464 6572 7375 622b 275f 272c  x=moddersub+'_',
+0005a290: 2069 735f 7431 3d46 616c 7365 2c20 7365   is_t1=False, se
+0005a2a0: 7061 7261 746f 723d 7365 7061 7261 746f  parator=separato
+0005a2b0: 722c 2076 6572 626f 7365 3d76 6572 626f  r, verbose=verbo
+0005a2c0: 7365 2029 0a20 2020 2020 2020 2020 2020  se ).           
+0005a2d0: 2020 2020 2069 6620 7465 6d70 2069 7320       if temp is 
+0005a2e0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0005a2f0: 2020 2020 2020 2020 2020 2020 2020 6e6d                nm
+0005a300: 6466 3d70 642e 636f 6e63 6174 2820 5b6e  df=pd.concat( [n
+0005a310: 6d64 662c 2074 656d 705d 2c20 6178 6973  mdf, temp], axis
+0005a320: 3d30 2c20 6967 6e6f 7265 5f69 6e64 6578  =0, ignore_index
+0005a330: 3d46 616c 7365 2029 0a20 2020 2072 6574  =False ).    ret
+0005a340: 7572 6e20 6e6d 6466 0a0a 6465 6620 6269  urn nmdf..def bi
+0005a350: 6e64 5f77 6964 655f 6d6d 5f63 7376 7328  nd_wide_mm_csvs(
+0005a360: 206d 6d5f 7769 6465 5f63 7376 732c 206d   mm_wide_csvs, m
+0005a370: 6572 6765 3d54 7275 652c 2073 6570 6172  erge=True, separ
+0005a380: 6174 6f72 3d27 2d27 2c20 7665 7262 6f73  ator='-', verbos
+0005a390: 6520 3d20 3020 2920 3a0a 2020 2020 2222  e = 0 ) :.    ""
+0005a3a0: 220a 2020 2020 7769 6c6c 2063 6f6e 7665  ".    will conve
+0005a3b0: 7274 2061 206c 6973 7420 6f66 2074 3177  rt a list of t1w
+0005a3c0: 2068 6965 7261 7263 6869 6361 6c20 6373   hierarchical cs
+0005a3d0: 7620 6669 6c65 6e61 6d65 7320 746f 2061  v filenames to a
+0005a3e0: 206d 6572 6765 6420 6461 7461 6672 616d   merged datafram
+0005a3f0: 650a 0a20 2020 2072 6574 7572 6e73 2061  e..    returns a
+0005a400: 2070 6169 7220 6f66 2064 6174 6120 6672   pair of data fr
+0005a410: 616d 6573 2c20 7468 6520 6c65 6674 2073  ames, the left s
+0005a420: 6964 6520 6861 7669 6e67 2061 6c6c 2065  ide having all e
+0005a430: 6e74 7269 6573 2061 6e64 2074 6865 0a20  ntries and the. 
+0005a440: 2020 2020 2020 2072 6967 6874 2073 6964         right sid
+0005a450: 6520 6861 7669 6e67 2072 6f77 2061 7665  e having row ave
+0005a460: 7261 6765 6420 656e 7472 6965 7320 692e  raged entries i.
+0005a470: 652e 2075 6e69 7175 6520 7661 6c75 6573  e. unique values
+0005a480: 2066 6f72 2065 6163 6820 7669 7369 740a   for each visit.
+0005a490: 0a20 2020 2073 6574 206d 6572 6765 2074  .    set merge t
+0005a4a0: 6f20 4661 6c73 6520 746f 2072 6574 7572  o False to retur
+0005a4b0: 6e20 696e 6469 7669 6475 616c 2064 6174  n individual dat
+0005a4c0: 6166 7261 6d65 7320 2820 666f 7220 6465  aframes ( for de
+0005a4d0: 6275 6767 696e 6720 290a 0a20 2020 2072  bugging )..    r
+0005a4e0: 6574 7572 6e20 616c 6c64 6174 612c 2072  eturn alldata, r
+0005a4f0: 6f77 5f61 7665 7261 6765 645f 6461 7461  ow_averaged_data
+0005a500: 0a20 2020 2022 2222 0a20 2020 206d 6d5f  .    """.    mm_
+0005a510: 7769 6465 5f63 7376 732e 736f 7274 2829  wide_csvs.sort()
+0005a520: 0a20 2020 2069 6620 6e6f 7420 6d6d 5f77  .    if not mm_w
+0005a530: 6964 655f 6373 7673 3a0a 2020 2020 2020  ide_csvs:.      
+0005a540: 2020 7072 696e 7428 224e 6f20 6669 6c65    print("No file
+0005a550: 7320 666f 756e 6420 7769 7468 2073 7065  s found with spe
+0005a560: 6369 6669 6564 2070 6174 7465 726e 2229  cified pattern")
+0005a570: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
+0005a580: 2020 2020 2320 312e 2072 6f77 2d62 696e      # 1. row-bin
+0005a590: 6420 7468 6520 7431 7768 6965 7220 6461  d the t1whier da
+0005a5a0: 7461 0a20 2020 2023 2032 2e20 7361 6d65  ta.    # 2. same
+0005a5b0: 2066 6f72 2065 6163 6820 6f74 6865 7220   for each other 
+0005a5c0: 6d6f 6461 6c69 7479 0a20 2020 2023 2033  modality.    # 3
+0005a5d0: 2e20 6d65 7267 6520 7468 6520 6d6f 6461  . merge the moda
+0005a5e0: 6c69 7469 6573 2062 7920 7468 6520 6b65  lities by the ke
+0005a5f0: 7973 0a20 2020 2068 6965 7264 6620 3d20  ys.    hierdf = 
+0005a600: 7064 2e44 6174 6146 7261 6d65 2829 0a20  pd.DataFrame(). 
+0005a610: 2020 2066 6f72 2079 2069 6e20 6d6d 5f77     for y in mm_w
+0005a620: 6964 655f 6373 7673 3a0a 2020 2020 2020  ide_csvs:.      
+0005a630: 2020 7465 6d70 3d72 6561 645f 6d6d 5f63    temp=read_mm_c
+0005a640: 7376 2820 792c 2063 6f6c 7072 6566 6978  sv( y, colprefix
+0005a650: 3d27 5431 4869 6572 5f27 2c20 7365 7061  ='T1Hier_', sepa
+0005a660: 7261 746f 723d 7365 7061 7261 746f 722c  rator=separator,
+0005a670: 2069 735f 7431 3d54 7275 6520 290a 2020   is_t1=True ).  
+0005a680: 2020 2020 2020 6966 2074 656d 7020 6973        if temp is
+0005a690: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0005a6a0: 2020 2020 2020 2068 6965 7264 663d 7064         hierdf=pd
+0005a6b0: 2e63 6f6e 6361 7428 205b 6869 6572 6466  .concat( [hierdf
+0005a6c0: 2c20 7465 6d70 5d2c 2061 7869 733d 302c  , temp], axis=0,
+0005a6d0: 2069 676e 6f72 655f 696e 6465 783d 4661   ignore_index=Fa
+0005a6e0: 6c73 6520 290a 2020 2020 6966 2076 6572  lse ).    if ver
+0005a6f0: 626f 7365 203e 2030 3a0a 2020 2020 2020  bose > 0:.      
+0005a700: 2020 6d79 7072 6f3d 3530 0a20 2020 2065    mypro=50.    e
+0005a710: 6c73 653a 0a20 2020 2020 2020 206d 7970  lse:.        myp
+0005a720: 726f 3d4e 6f6e 650a 2020 2020 6966 2076  ro=None.    if v
+0005a730: 6572 626f 7365 203e 2030 3a0a 2020 2020  erbose > 0:.    
+0005a740: 2020 2020 7072 696e 7428 2274 6869 636b      print("thick
+0005a750: 6e65 7373 2229 0a20 2020 2074 686b 6466  ness").    thkdf
+0005a760: 203d 2061 7373 656d 626c 655f 6d6f 6461   = assemble_moda
+0005a770: 6c69 7479 5f73 7065 6369 6669 635f 6461  lity_specific_da
+0005a780: 7461 6672 616d 6573 2820 6d6d 5f77 6964  taframes( mm_wid
+0005a790: 655f 6373 7673 2c20 6869 6572 6466 2c20  e_csvs, hierdf, 
+0005a7a0: 2754 3177 272c 2070 726f 6772 6573 733d  'T1w', progress=
+0005a7b0: 6d79 7072 6f2c 2076 6572 626f 7365 3d76  mypro, verbose=v
+0005a7c0: 6572 626f 7365 3d3d 3229 0a20 2020 2069  erbose==2).    i
+0005a7d0: 6620 7665 7262 6f73 6520 3e20 303a 0a20  f verbose > 0:. 
+0005a7e0: 2020 2020 2020 2070 7269 6e74 2822 666c         print("fl
+0005a7f0: 6169 7222 290a 2020 2020 666c 6169 7264  air").    flaird
+0005a800: 6620 3d20 6173 7365 6d62 6c65 5f6d 6f64  f = assemble_mod
+0005a810: 616c 6974 795f 7370 6563 6966 6963 5f64  ality_specific_d
+0005a820: 6174 6166 7261 6d65 7328 206d 6d5f 7769  ataframes( mm_wi
+0005a830: 6465 5f63 7376 732c 2068 6965 7264 662c  de_csvs, hierdf,
+0005a840: 2027 5432 466c 6169 7227 2c20 7072 6f67   'T2Flair', prog
+0005a850: 7265 7373 3d6d 7970 726f 2c20 7665 7262  ress=mypro, verb
+0005a860: 6f73 653d 7665 7262 6f73 653d 3d32 290a  ose=verbose==2).
+0005a870: 2020 2020 6966 2076 6572 626f 7365 203e      if verbose >
+0005a880: 2030 3a0a 2020 2020 2020 2020 7072 696e   0:.        prin
+0005a890: 7428 224e 4d22 290a 2020 2020 6e6d 6466  t("NM").    nmdf
+0005a8a0: 203d 2061 7373 656d 626c 655f 6d6f 6461   = assemble_moda
+0005a8b0: 6c69 7479 5f73 7065 6369 6669 635f 6461  lity_specific_da
+0005a8c0: 7461 6672 616d 6573 2820 6d6d 5f77 6964  taframes( mm_wid
+0005a8d0: 655f 6373 7673 2c20 6869 6572 6466 2c20  e_csvs, hierdf, 
+0005a8e0: 274e 4d32 444d 5427 2c20 7072 6f67 7265  'NM2DMT', progre
+0005a8f0: 7373 3d6d 7970 726f 2c20 7665 7262 6f73  ss=mypro, verbos
+0005a900: 653d 7665 7262 6f73 653d 3d32 290a 2020  e=verbose==2).  
+0005a910: 2020 6966 2076 6572 626f 7365 203e 2030    if verbose > 0
+0005a920: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
+0005a930: 2272 7366 2229 0a20 2020 2072 7366 6466  "rsf").    rsfdf
+0005a940: 203d 2061 7373 656d 626c 655f 6d6f 6461   = assemble_moda
+0005a950: 6c69 7479 5f73 7065 6369 6669 635f 6461  lity_specific_da
+0005a960: 7461 6672 616d 6573 2820 6d6d 5f77 6964  taframes( mm_wid
+0005a970: 655f 6373 7673 2c20 6869 6572 6466 2c20  e_csvs, hierdf, 
+0005a980: 2772 7366 4d52 492a 272c 2070 726f 6772  'rsfMRI*', progr
+0005a990: 6573 733d 6d79 7072 6f2c 2076 6572 626f  ess=mypro, verbo
+0005a9a0: 7365 3d76 6572 626f 7365 3d3d 3229 0a20  se=verbose==2). 
+0005a9b0: 2020 2069 6620 7665 7262 6f73 6520 3e20     if verbose > 
+0005a9c0: 303a 0a20 2020 2020 2020 2070 7269 6e74  0:.        print
+0005a9d0: 2822 6474 6922 290a 2020 2020 6474 6964  ("dti").    dtid
+0005a9e0: 6620 3d20 6173 7365 6d62 6c65 5f6d 6f64  f = assemble_mod
+0005a9f0: 616c 6974 795f 7370 6563 6966 6963 5f64  ality_specific_d
+0005aa00: 6174 6166 7261 6d65 7328 206d 6d5f 7769  ataframes( mm_wi
+0005aa10: 6465 5f63 7376 732c 2068 6965 7264 662c  de_csvs, hierdf,
+0005aa20: 2027 4454 492a 272c 2070 726f 6772 6573   'DTI*', progres
+0005aa30: 733d 6d79 7072 6f2c 2076 6572 626f 7365  s=mypro, verbose
+0005aa40: 3d76 6572 626f 7365 3d3d 3220 290a 2020  =verbose==2 ).  
+0005aa50: 2020 6966 206e 6f74 206d 6572 6765 3a0a    if not merge:.
+0005aa60: 2020 2020 2020 2020 7265 7475 726e 2068          return h
+0005aa70: 6965 7264 662c 2074 686b 6466 2c20 666c  ierdf, thkdf, fl
+0005aa80: 6169 7264 662c 206e 6d64 662c 2072 7366  airdf, nmdf, rsf
+0005aa90: 6466 2c20 6474 6964 660a 2020 2020 6869  df, dtidf.    hi
+0005aaa0: 6572 6466 6d69 7820 3d20 6869 6572 6466  erdfmix = hierdf
+0005aab0: 2e63 6f70 7928 290a 2020 2020 6d6f 6461  .copy().    moda
+0005aac0: 6c69 7479 5f64 665f 7375 6666 6978 6573  lity_df_suffixes
+0005aad0: 203d 205b 0a20 2020 2020 2020 2028 7468   = [.        (th
+0005aae0: 6b64 662c 2022 5f74 686b 2229 2c0a 2020  kdf, "_thk"),.  
+0005aaf0: 2020 2020 2020 2866 6c61 6972 6466 2c20        (flairdf, 
+0005ab00: 225f 666c 6169 7222 292c 0a20 2020 2020  "_flair"),.     
+0005ab10: 2020 2028 6e6d 6466 2c20 225f 6e6d 2229     (nmdf, "_nm")
+0005ab20: 2c0a 2020 2020 2020 2020 2872 7366 6466  ,.        (rsfdf
+0005ab30: 2c20 225f 7273 6622 292c 0a20 2020 2020  , "_rsf"),.     
+0005ab40: 2020 2028 6474 6964 662c 2022 5f64 7469     (dtidf, "_dti
+0005ab50: 2229 2c0a 2020 2020 5d0a 2020 2020 666f  "),.    ].    fo
+0005ab60: 7220 7061 6972 2069 6e20 6d6f 6461 6c69  r pair in modali
+0005ab70: 7479 5f64 665f 7375 6666 6978 6573 3a0a  ty_df_suffixes:.
+0005ab80: 2020 2020 2020 2020 6869 6572 6466 6d69          hierdfmi
+0005ab90: 7820 3d20 6d65 7267 655f 6d6d 5f64 6174  x = merge_mm_dat
+0005aba0: 6166 7261 6d65 2868 6965 7264 666d 6978  aframe(hierdfmix
+0005abb0: 2c20 7061 6972 5b30 5d2c 2070 6169 725b  , pair[0], pair[
+0005abc0: 315d 290a 2020 2020 6869 6572 6466 6d69  1]).    hierdfmi
+0005abd0: 7820 3d20 6869 6572 6466 6d69 782e 7265  x = hierdfmix.re
+0005abe0: 706c 6163 6528 7227 5e5c 732a 2427 2c20  place(r'^\s*$', 
+0005abf0: 6e70 2e6e 616e 2c20 7265 6765 783d 5472  np.nan, regex=Tr
+0005ac00: 7565 290a 2020 2020 7265 7475 726e 2068  ue).    return h
+0005ac10: 6965 7264 666d 6978 2c20 6869 6572 6466  ierdfmix, hierdf
+0005ac20: 6d69 782e 6772 6f75 7062 7928 2275 5f68  mix.groupby("u_h
+0005ac30: 6965 725f 6964 222c 2061 735f 696e 6465  ier_id", as_inde
+0005ac40: 783d 4661 6c73 6529 2e6d 6561 6e28 6e75  x=False).mean(nu
+0005ac50: 6d65 7269 635f 6f6e 6c79 3d54 7275 6529  meric_only=True)
+0005ac60: 0a0a 6465 6620 6d65 7267 655f 6d6d 5f64  ..def merge_mm_d
+0005ac70: 6174 6166 7261 6d65 2868 6965 7264 662c  ataframe(hierdf,
+0005ac80: 206d 6d64 662c 206d 6d5f 7375 6666 6978   mmdf, mm_suffix
+0005ac90: 293a 0a20 2020 2074 7279 3a0a 2020 2020  ):.    try:.    
+0005aca0: 2020 2020 6869 6572 6466 203d 2068 6965      hierdf = hie
+0005acb0: 7264 662e 6d65 7267 6528 6d6d 6466 2c20  rdf.merge(mmdf, 
+0005acc0: 6f6e 3d5b 2773 6964 272c 2027 7669 7369  on=['sid', 'visi
+0005acd0: 7464 6174 6527 2c20 2774 3169 6d61 6765  tdate', 't1image
+0005ace0: 7569 6427 5d2c 2073 7566 6669 7865 733d  uid'], suffixes=
+0005acf0: 2822 222c 6d6d 5f73 7566 6669 7829 2c68  ("",mm_suffix),h
+0005ad00: 6f77 3d27 6c65 6674 2729 0a20 2020 2020  ow='left').     
+0005ad10: 2020 2072 6574 7572 6e20 6869 6572 6466     return hierdf
+0005ad20: 0a20 2020 2065 7863 6570 7420 4b65 7945  .    except KeyE
+0005ad30: 7272 6f72 3a0a 2020 2020 2020 2020 7265  rror:.        re
+0005ad40: 7475 726e 2068 6965 7264 660a 0a64 6566  turn hierdf..def
+0005ad50: 2061 7567 6d65 6e74 5f69 6d61 6765 2820   augment_image( 
+0005ad60: 782c 2020 6d61 785f 726f 743d 3130 2c20  x,  max_rot=10, 
+0005ad70: 6e7a 7364 3d31 2029 3a0a 2020 2020 7252  nzsd=1 ):.    rR
+0005ad80: 6f74 4765 6e65 7261 746f 7220 3d20 616e  otGenerator = an
+0005ad90: 7473 2e63 6f6e 7472 6962 2e52 616e 646f  ts.contrib.Rando
+0005ada0: 6d52 6f74 6174 6533 4428 2028 206d 6178  mRotate3D( ( max
+0005adb0: 5f72 6f74 2a28 2d31 2e30 292c 206d 6178  _rot*(-1.0), max
+0005adc0: 5f72 6f74 2029 2c20 7265 6665 7265 6e63  _rot ), referenc
+0005add0: 653d 7820 290a 2020 2020 7478 203d 2072  e=x ).    tx = r
+0005ade0: 526f 7447 656e 6572 6174 6f72 2e74 7261  RotGenerator.tra
+0005adf0: 6e73 666f 726d 2829 0a20 2020 2069 7478  nsform().    itx
+0005ae00: 203d 2061 6e74 732e 696e 7665 7274 5f61   = ants.invert_a
+0005ae10: 6e74 735f 7472 616e 7366 6f72 6d28 7478  nts_transform(tx
+0005ae20: 290a 2020 2020 7920 3d20 616e 7473 2e61  ).    y = ants.a
+0005ae30: 7070 6c79 5f61 6e74 735f 7472 616e 7366  pply_ants_transf
+0005ae40: 6f72 6d5f 746f 5f69 6d61 6765 2820 7478  orm_to_image( tx
+0005ae50: 2c20 782c 2078 2c20 696e 7465 7270 6f6c  , x, x, interpol
+0005ae60: 6174 696f 6e3d 276c 696e 6561 7227 290a  ation='linear').
+0005ae70: 2020 2020 7920 3d20 616e 7473 2e61 6464      y = ants.add
+0005ae80: 5f6e 6f69 7365 5f74 6f5f 696d 6167 6528  _noise_to_image(
+0005ae90: 2079 2c27 6164 6469 7469 7665 6761 7573   y,'additivegaus
+0005aea0: 7369 616e 272c 205b 302c 6e7a 7364 5d20  sian', [0,nzsd] 
+0005aeb0: 290a 2020 2020 7265 7475 726e 2079 2c20  ).    return y, 
+0005aec0: 7478 2c20 6974 780a 0a64 6566 2062 6f6f  tx, itx..def boo
+0005aed0: 745f 776d 6828 2066 6c61 6972 2c20 7431  t_wmh( flair, t1
+0005aee0: 2c20 7431 7365 672c 206d 6d66 726f 6d63  , t1seg, mmfromc
+0005aef0: 6f6e 7665 7868 756c 6c20 3d20 302e 302c  onvexhull = 0.0,
+0005af00: 2073 7472 6963 743d 5472 7565 2c0a 2020   strict=True,.  
+0005af10: 2020 2020 2020 7072 6f62 6162 696c 6974        probabilit
+0005af20: 795f 6d61 736b 3d4e 6f6e 652c 2070 7269  y_mask=None, pri
+0005af30: 6f72 5f70 726f 6261 6269 6c69 7479 3d4e  or_probability=N
+0005af40: 6f6e 652c 206e 5f73 696d 756c 6174 696f  one, n_simulatio
+0005af50: 6e73 3d31 362c 0a20 2020 2020 2020 2076  ns=16,.        v
+0005af60: 6572 626f 7365 3d46 616c 7365 2029 203a  erbose=False ) :
+0005af70: 0a20 2020 2069 6620 7665 7262 6f73 6520  .    if verbose 
+0005af80: 616e 6420 7072 696f 725f 7072 6f62 6162  and prior_probab
+0005af90: 696c 6974 7920 6973 204e 6f6e 653a 0a20  ility is None:. 
+0005afa0: 2020 2020 2020 2070 7269 6e74 2822 6175         print("au
+0005afb0: 676d 656e 7465 6420 666c 6169 7222 290a  gmented flair").
+0005afc0: 2020 2020 6966 2076 6572 626f 7365 2061      if verbose a
+0005afd0: 6e64 2070 7269 6f72 5f70 726f 6261 6269  nd prior_probabi
+0005afe0: 6c69 7479 2069 7320 6e6f 7420 4e6f 6e65  lity is not None
+0005aff0: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
+0005b000: 2261 7567 6d65 6e74 6564 2066 6c61 6972  "augmented flair
+0005b010: 2077 6974 6820 7072 696f 7222 290a 2020   with prior").  
+0005b020: 2020 776d 685f 7375 6d5f 6175 6720 3d20    wmh_sum_aug = 
+0005b030: 300a 2020 2020 776d 685f 7375 6d5f 7072  0.    wmh_sum_pr
+0005b040: 696f 725f 6175 6720 3d20 300a 2020 2020  ior_aug = 0.    
+0005b050: 6175 6770 726f 6220 3d20 666c 6169 7220  augprob = flair 
+0005b060: 2a20 302e 300a 2020 2020 6175 6770 726f  * 0.0.    augpro
+0005b070: 625f 7072 696f 7220 3d20 4e6f 6e65 0a20  b_prior = None. 
+0005b080: 2020 2069 6620 7072 696f 725f 7072 6f62     if prior_prob
+0005b090: 6162 696c 6974 7920 6973 206e 6f74 204e  ability is not N
+0005b0a0: 6f6e 653a 0a20 2020 2020 2020 2061 7567  one:.        aug
+0005b0b0: 7072 6f62 5f70 7269 6f72 203d 2066 6c61  prob_prior = fla
+0005b0c0: 6972 202a 2030 2e30 0a20 2020 2066 6f72  ir * 0.0.    for
+0005b0d0: 206e 2069 6e20 7261 6e67 6528 6e5f 7369   n in range(n_si
+0005b0e0: 6d75 6c61 7469 6f6e 7329 3a0a 2020 2020  mulations):.    
+0005b0f0: 2020 2020 6175 6766 6c61 6972 2c20 7478      augflair, tx
+0005b100: 2c20 6974 7820 3d20 6175 676d 656e 745f  , itx = augment_
+0005b110: 696d 6167 6528 2061 6e74 732e 694d 6174  image( ants.iMat
+0005b120: 6828 666c 6169 722c 224e 6f72 6d61 6c69  h(flair,"Normali
+0005b130: 7a65 2229 2c20 352c 2030 2e30 3120 290a  ze"), 5, 0.01 ).
+0005b140: 2020 2020 2020 2020 6c6f 6377 6d68 203d          locwmh =
+0005b150: 2077 6d68 2820 6175 6766 6c61 6972 2c20   wmh( augflair, 
+0005b160: 7431 2c20 7431 7365 672c 206d 6d66 726f  t1, t1seg, mmfro
+0005b170: 6d63 6f6e 7665 7868 756c 6c20 3d20 6d6d  mconvexhull = mm
+0005b180: 6672 6f6d 636f 6e76 6578 6875 6c6c 2c0a  fromconvexhull,.
+0005b190: 2020 2020 2020 2020 2020 2020 7374 7269              stri
+0005b1a0: 6374 3d73 7472 6963 742c 2070 726f 6261  ct=strict, proba
+0005b1b0: 6269 6c69 7479 5f6d 6173 6b3d 4e6f 6e65  bility_mask=None
+0005b1c0: 2c20 7072 696f 725f 7072 6f62 6162 696c  , prior_probabil
+0005b1d0: 6974 793d 7072 696f 725f 7072 6f62 6162  ity=prior_probab
+0005b1e0: 696c 6974 7920 290a 2020 2020 2020 2020  ility ).        
+0005b1f0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+0005b200: 2020 2020 2020 2020 7072 696e 7428 2022          print( "
+0005b210: 666c 6169 7220 7369 6d3a 2022 202b 2073  flair sim: " + s
+0005b220: 7472 286e 2920 2b20 2220 766f 6c3a 2022  tr(n) + " vol: "
+0005b230: 202b 2073 7472 2820 6c6f 6377 6d68 5b27   + str( locwmh['
+0005b240: 776d 685f 6d61 7373 275d 2029 2b20 2220  wmh_mass'] )+ " 
+0005b250: 766f 6c2d 7072 696f 723a 2022 202b 2073  vol-prior: " + s
+0005b260: 7472 2820 6c6f 6377 6d68 5b27 776d 685f  tr( locwmh['wmh_
+0005b270: 6d61 7373 5f70 7269 6f72 275d 2029 2b20  mass_prior'] )+ 
+0005b280: 2220 736e 723a 2022 202b 2073 7472 2820  " snr: " + str( 
+0005b290: 6c6f 6377 6d68 5b27 776d 685f 534e 5227  locwmh['wmh_SNR'
+0005b2a0: 5d20 2920 290a 2020 2020 2020 2020 776d  ] ) ).        wm
+0005b2b0: 685f 7375 6d5f 6175 6720 3d20 776d 685f  h_sum_aug = wmh_
+0005b2c0: 7375 6d5f 6175 6720 2b20 6c6f 6377 6d68  sum_aug + locwmh
+0005b2d0: 5b27 776d 685f 6d61 7373 275d 0a20 2020  ['wmh_mass'].   
+0005b2e0: 2020 2020 2077 6d68 5f73 756d 5f70 7269       wmh_sum_pri
+0005b2f0: 6f72 5f61 7567 203d 2077 6d68 5f73 756d  or_aug = wmh_sum
+0005b300: 5f70 7269 6f72 5f61 7567 202b 206c 6f63  _prior_aug + loc
+0005b310: 776d 685b 2777 6d68 5f6d 6173 735f 7072  wmh['wmh_mass_pr
+0005b320: 696f 7227 5d0a 2020 2020 2020 2020 7465  ior'].        te
+0005b330: 6d70 203d 206c 6f63 776d 685b 2757 4d48  mp = locwmh['WMH
+0005b340: 5f70 726f 6261 6269 6c69 7479 5f6d 6170  _probability_map
+0005b350: 275d 0a20 2020 2020 2020 2061 7567 7072  '].        augpr
+0005b360: 6f62 203d 2061 7567 7072 6f62 202b 2061  ob = augprob + a
+0005b370: 6e74 732e 6170 706c 795f 616e 7473 5f74  nts.apply_ants_t
+0005b380: 7261 6e73 666f 726d 5f74 6f5f 696d 6167  ransform_to_imag
+0005b390: 6528 2069 7478 2c20 7465 6d70 2c20 666c  e( itx, temp, fl
+0005b3a0: 6169 722c 2069 6e74 6572 706f 6c61 7469  air, interpolati
+0005b3b0: 6f6e 3d27 6c69 6e65 6172 2729 0a20 2020  on='linear').   
+0005b3c0: 2020 2020 2069 6620 7072 696f 725f 7072       if prior_pr
+0005b3d0: 6f62 6162 696c 6974 7920 6973 206e 6f74  obability is not
+0005b3e0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0005b3f0: 2020 2074 656d 7020 3d20 6c6f 6377 6d68     temp = locwmh
+0005b400: 5b27 574d 485f 706f 7374 6572 696f 725f  ['WMH_posterior_
+0005b410: 7072 6f62 6162 696c 6974 795f 6d61 7027  probability_map'
+0005b420: 5d0a 2020 2020 2020 2020 2020 2020 6175  ].            au
+0005b430: 6770 726f 625f 7072 696f 7220 3d20 6175  gprob_prior = au
+0005b440: 6770 726f 625f 7072 696f 7220 2b20 616e  gprob_prior + an
+0005b450: 7473 2e61 7070 6c79 5f61 6e74 735f 7472  ts.apply_ants_tr
+0005b460: 616e 7366 6f72 6d5f 746f 5f69 6d61 6765  ansform_to_image
+0005b470: 2820 6974 782c 2074 656d 702c 2066 6c61  ( itx, temp, fla
+0005b480: 6972 2c20 696e 7465 7270 6f6c 6174 696f  ir, interpolatio
+0005b490: 6e3d 276c 696e 6561 7227 290a 2020 2020  n='linear').    
+0005b4a0: 6175 6770 726f 6220 3d20 6175 6770 726f  augprob = augpro
+0005b4b0: 6220 2a20 2831 2e30 2f66 6c6f 6174 2820  b * (1.0/float( 
+0005b4c0: 6e5f 7369 6d75 6c61 7469 6f6e 7320 2929  n_simulations ))
+0005b4d0: 0a20 2020 2069 6620 7072 696f 725f 7072  .    if prior_pr
+0005b4e0: 6f62 6162 696c 6974 7920 6973 206e 6f74  obability is not
+0005b4f0: 204e 6f6e 653a 0a20 2020 2020 2020 2061   None:.        a
+0005b500: 7567 7072 6f62 5f70 7269 6f72 203d 2061  ugprob_prior = a
+0005b510: 7567 7072 6f62 5f70 7269 6f72 202a 2028  ugprob_prior * (
+0005b520: 312e 302f 666c 6f61 7428 206e 5f73 696d  1.0/float( n_sim
+0005b530: 756c 6174 696f 6e73 2029 290a 2020 2020  ulations )).    
+0005b540: 776d 685f 7375 6d5f 6175 6720 3d20 776d  wmh_sum_aug = wm
+0005b550: 685f 7375 6d5f 6175 6720 2f20 666c 6f61  h_sum_aug / floa
+0005b560: 7428 206e 5f73 696d 756c 6174 696f 6e73  t( n_simulations
+0005b570: 2029 0a20 2020 2077 6d68 5f73 756d 5f70   ).    wmh_sum_p
+0005b580: 7269 6f72 5f61 7567 203d 2077 6d68 5f73  rior_aug = wmh_s
+0005b590: 756d 5f70 7269 6f72 5f61 7567 202f 2066  um_prior_aug / f
+0005b5a0: 6c6f 6174 2820 6e5f 7369 6d75 6c61 7469  loat( n_simulati
+0005b5b0: 6f6e 7320 290a 2020 2020 7265 7475 726e  ons ).    return
+0005b5c0: 7b0a 2020 2020 2020 2766 6c61 6972 2720  {.      'flair' 
+0005b5d0: 3a20 616e 7473 2e69 4d61 7468 2866 6c61  : ants.iMath(fla
+0005b5e0: 6972 2c22 4e6f 726d 616c 697a 6522 292c  ir,"Normalize"),
+0005b5f0: 0a20 2020 2020 2027 574d 485f 7072 6f62  .      'WMH_prob
+0005b600: 6162 696c 6974 795f 6d61 7027 203a 2061  ability_map' : a
+0005b610: 7567 7072 6f62 2c0a 2020 2020 2020 2757  ugprob,.      'W
+0005b620: 4d48 5f70 6f73 7465 7269 6f72 5f70 726f  MH_posterior_pro
+0005b630: 6261 6269 6c69 7479 5f6d 6170 2720 3a20  bability_map' : 
+0005b640: 6175 6770 726f 625f 7072 696f 722c 0a20  augprob_prior,. 
+0005b650: 2020 2020 2027 776d 685f 6d61 7373 273a       'wmh_mass':
+0005b660: 2077 6d68 5f73 756d 5f61 7567 2c0a 2020   wmh_sum_aug,.  
+0005b670: 2020 2020 2777 6d68 5f6d 6173 735f 7072      'wmh_mass_pr
+0005b680: 696f 7227 3a20 776d 685f 7375 6d5f 7072  ior': wmh_sum_pr
+0005b690: 696f 725f 6175 672c 0a20 2020 2020 2027  ior_aug,.      '
+0005b6a0: 776d 685f 6576 7227 3a20 6c6f 6377 6d68  wmh_evr': locwmh
+0005b6b0: 5b27 776d 685f 6576 7227 5d2c 0a20 2020  ['wmh_evr'],.   
+0005b6c0: 2020 2027 776d 685f 534e 5227 3a20 6c6f     'wmh_SNR': lo
+0005b6d0: 6377 6d68 5b27 776d 685f 534e 5227 5d20  cwmh['wmh_SNR'] 
+0005b6e0: 207d 0a0a 0a64 6566 2074 6872 6561 6465   }...def threade
+0005b6f0: 645f 6269 6e64 5f77 6964 655f 6d6d 5f63  d_bind_wide_mm_c
+0005b700: 7376 7328 206d 6d5f 7769 6465 5f63 7376  svs( mm_wide_csv
+0005b710: 732c 206e 5f77 6f72 6b65 7273 2029 3a0a  s, n_workers ):.
+0005b720: 2020 2020 6672 6f6d 2063 6f6e 6375 7272      from concurr
+0005b730: 656e 742e 6675 7475 7265 7320 696d 706f  ent.futures impo
+0005b740: 7274 2061 735f 636f 6d70 6c65 7465 640a  rt as_completed.
+0005b750: 2020 2020 6672 6f6d 2063 6f6e 6375 7272      from concurr
+0005b760: 656e 7420 696d 706f 7274 2066 7574 7572  ent import futur
+0005b770: 6573 0a20 2020 2069 6d70 6f72 7420 636f  es.    import co
+0005b780: 6e63 7572 7265 6e74 2e66 7574 7572 6573  ncurrent.futures
+0005b790: 0a20 2020 2064 6566 2063 6875 6e6b 7328  .    def chunks(
+0005b7a0: 6c2c 206e 293a 0a20 2020 2020 2020 2022  l, n):.        "
+0005b7b0: 2222 5969 656c 6420 6e20 6e75 6d62 6572  ""Yield n number
+0005b7c0: 206f 6620 7365 7175 656e 7469 616c 2063   of sequential c
+0005b7d0: 6875 6e6b 7320 6672 6f6d 206c 2e22 2222  hunks from l."""
+0005b7e0: 0a20 2020 2020 2020 2064 2c20 7220 3d20  .        d, r = 
+0005b7f0: 6469 766d 6f64 286c 656e 286c 292c 206e  divmod(len(l), n
+0005b800: 290a 2020 2020 2020 2020 666f 7220 6920  ).        for i 
+0005b810: 696e 2072 616e 6765 286e 293a 0a20 2020  in range(n):.   
+0005b820: 2020 2020 2020 2020 2073 6920 3d20 2864           si = (d
+0005b830: 2b31 292a 2869 2069 6620 6920 3c20 7220  +1)*(i if i < r 
+0005b840: 656c 7365 2072 2920 2b20 642a 2830 2069  else r) + d*(0 i
+0005b850: 6620 6920 3c20 7220 656c 7365 2069 202d  f i < r else i -
+0005b860: 2072 290a 2020 2020 2020 2020 2020 2020   r).            
+0005b870: 7969 656c 6420 6c5b 7369 3a73 692b 2864  yield l[si:si+(d
+0005b880: 2b31 2069 6620 6920 3c20 7220 656c 7365  +1 if i < r else
+0005b890: 2064 295d 0a20 2020 2069 6d70 6f72 7420   d)].    import 
+0005b8a0: 6e75 6d70 7920 6173 206e 700a 2020 2020  numpy as np.    
+0005b8b0: 6e65 7778 203d 206c 6973 7428 2063 6875  newx = list( chu
+0005b8c0: 6e6b 7328 206d 6d5f 7769 6465 5f63 7376  nks( mm_wide_csv
+0005b8d0: 732c 206e 5f77 6f72 6b65 7273 2029 2029  s, n_workers ) )
+0005b8e0: 0a20 2020 2069 6d70 6f72 7420 7061 6e64  .    import pand
+0005b8f0: 6173 2061 7320 7064 0a20 2020 2061 6c6c  as as pd.    all
+0005b900: 6466 203d 2070 642e 4461 7461 4672 616d  df = pd.DataFram
+0005b910: 6528 290a 2020 2020 616c 6c64 6661 7667  e().    alldfavg
+0005b920: 203d 2070 642e 4461 7461 4672 616d 6528   = pd.DataFrame(
+0005b930: 290a 2020 2020 7769 7468 2066 7574 7572  ).    with futur
+0005b940: 6573 2e54 6872 6561 6450 6f6f 6c45 7865  es.ThreadPoolExe
+0005b950: 6375 746f 7228 6d61 785f 776f 726b 6572  cutor(max_worker
+0005b960: 733d 6e5f 776f 726b 6572 7329 2061 7320  s=n_workers) as 
+0005b970: 6578 6563 7574 6f72 3a0a 2020 2020 2020  executor:.      
+0005b980: 2020 746f 5f64 6f20 3d20 5b5d 0a20 2020    to_do = [].   
+0005b990: 2020 2020 2066 6f72 2067 726f 7570 2069       for group i
+0005b9a0: 6e20 7261 6e67 6528 6c65 6e28 6e65 7778  n range(len(newx
+0005b9b0: 2929 203a 0a20 2020 2020 2020 2020 2020  )) :.           
+0005b9c0: 2066 7574 7572 6520 3d20 6578 6563 7574   future = execut
+0005b9d0: 6f72 2e73 7562 6d69 7428 6269 6e64 5f77  or.submit(bind_w
+0005b9e0: 6964 655f 6d6d 5f63 7376 732c 206e 6577  ide_mm_csvs, new
+0005b9f0: 785b 6772 6f75 705d 2029 0a20 2020 2020  x[group] ).     
+0005ba00: 2020 2020 2020 2074 6f5f 646f 2e61 7070         to_do.app
+0005ba10: 656e 6428 6675 7475 7265 290a 2020 2020  end(future).    
+0005ba20: 2020 2020 7265 7375 6c74 7320 3d20 5b5d      results = []
+0005ba30: 0a20 2020 2020 2020 2066 6f72 2066 7574  .        for fut
+0005ba40: 7572 6520 696e 2066 7574 7572 6573 2e61  ure in futures.a
+0005ba50: 735f 636f 6d70 6c65 7465 6428 746f 5f64  s_completed(to_d
+0005ba60: 6f29 3a0a 2020 2020 2020 2020 2020 2020  o):.            
+0005ba70: 7265 7330 2c20 7265 7331 203d 2066 7574  res0, res1 = fut
+0005ba80: 7572 652e 7265 7375 6c74 2829 0a20 2020  ure.result().   
+0005ba90: 2020 2020 2020 2020 2061 6c6c 6466 3d70           alldf=p
+0005baa0: 642e 636f 6e63 6174 2820 205b 616c 6c64  d.concat(  [alld
+0005bab0: 662c 2072 6573 3020 5d2c 2061 7869 733d  f, res0 ], axis=
+0005bac0: 302c 2069 676e 6f72 655f 696e 6465 783d  0, ignore_index=
+0005bad0: 4661 6c73 6520 290a 2020 2020 2020 2020  False ).        
+0005bae0: 2020 2020 616c 6c64 6661 7667 3d70 642e      alldfavg=pd.
+0005baf0: 636f 6e63 6174 2820 205b 616c 6c64 6661  concat(  [alldfa
+0005bb00: 7667 2c20 7265 7331 205d 2c20 6178 6973  vg, res1 ], axis
+0005bb10: 3d30 2c20 6967 6e6f 7265 5f69 6e64 6578  =0, ignore_index
+0005bb20: 3d46 616c 7365 2029 0a20 2020 2072 6574  =False ).    ret
+0005bb30: 7572 6e20 616c 6c64 662c 2061 6c6c 6466  urn alldf, alldf
+0005bb40: 6176 670a 0a0a 6465 6620 6765 745f 6e61  avg...def get_na
+0005bb50: 6d65 735f 6672 6f6d 5f64 6174 615f 6672  mes_from_data_fr
+0005bb60: 616d 6528 782c 2064 656d 6f67 496e 2c20  ame(x, demogIn, 
+0005bb70: 6578 636c 7573 696f 6e73 3d4e 6f6e 6529  exclusions=None)
+0005bb80: 3a0a 2020 2020 2222 220a 2020 2020 6461  :.    """.    da
+0005bb90: 7461 203d 207b 274e 616d 6527 3a5b 2754  ta = {'Name':['T
+0005bba0: 6f6d 272c 2027 6e69 636b 272c 2027 6b72  om', 'nick', 'kr
+0005bbb0: 6973 6827 2c20 276a 6163 6b27 5d2c 2027  ish', 'jack'], '
+0005bbc0: 4167 6527 3a5b 3230 2c20 3231 2c20 3139  Age':[20, 21, 19
+0005bbd0: 2c20 3138 5d7d 0a20 2020 2061 6e74 7370  , 18]}.    antsp
+0005bbe0: 796d 6d2e 6765 745f 6e61 6d65 735f 6672  ymm.get_names_fr
+0005bbf0: 6f6d 5f64 6174 615f 6672 616d 6528 205b  om_data_frame( [
+0005bc00: 2765 275d 2c20 6466 2029 0a20 2020 2061  'e'], df ).    a
+0005bc10: 6e74 7370 796d 6d2e 6765 745f 6e61 6d65  ntspymm.get_name
+0005bc20: 735f 6672 6f6d 5f64 6174 615f 6672 616d  s_from_data_fram
+0005bc30: 6528 205b 2761 272c 2765 275d 2c20 6466  e( ['a','e'], df
+0005bc40: 2029 0a20 2020 2061 6e74 7370 796d 6d2e   ).    antspymm.
+0005bc50: 6765 745f 6e61 6d65 735f 6672 6f6d 5f64  get_names_from_d
+0005bc60: 6174 615f 6672 616d 6528 205b 2765 275d  ata_frame( ['e']
+0005bc70: 2c20 6466 2c20 6578 636c 7573 696f 6e73  , df, exclusions
+0005bc80: 3d27 4e27 2029 0a20 2020 2022 2222 0a20  ='N' ).    """. 
+0005bc90: 2020 2023 2043 6865 636b 2069 6620 7820     # Check if x 
+0005bca0: 6973 2061 2073 7472 696e 6720 616e 6420  is a string and 
+0005bcb0: 636f 6e76 6572 7420 6974 2074 6f20 6120  convert it to a 
+0005bcc0: 6c69 7374 0a20 2020 2069 6620 6973 696e  list.    if isin
+0005bcd0: 7374 616e 6365 2878 2c20 7374 7229 3a0a  stance(x, str):.
+0005bce0: 2020 2020 2020 2020 7820 3d20 5b78 5d0a          x = [x].
+0005bcf0: 2020 2020 6465 6620 6765 745f 756e 6971      def get_uniq
+0005bd00: 7565 2820 7171 2029 3a0a 2020 2020 2020  ue( qq ):.      
+0005bd10: 2020 756e 6971 7565 203d 205b 5d0a 2020    unique = [].  
+0005bd20: 2020 2020 2020 666f 7220 6e75 6d62 6572        for number
+0005bd30: 2069 6e20 7171 3a0a 2020 2020 2020 2020   in qq:.        
+0005bd40: 2020 2020 6966 206e 756d 6265 7220 696e      if number in
+0005bd50: 2075 6e69 7175 653a 0a20 2020 2020 2020   unique:.       
+0005bd60: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+0005bd70: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
+0005bd80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0005bd90: 2020 2020 756e 6971 7565 2e61 7070 656e      unique.appen
+0005bda0: 6428 6e75 6d62 6572 290a 2020 2020 2020  d(number).      
+0005bdb0: 2020 7265 7475 726e 2075 6e69 7175 650a    return unique.
+0005bdc0: 2020 2020 6f75 746e 616d 6573 203d 206c      outnames = l
+0005bdd0: 6973 7428 6465 6d6f 6749 6e2e 636f 6c75  ist(demogIn.colu
+0005bde0: 6d6e 735b 6465 6d6f 6749 6e2e 636f 6c75  mns[demogIn.colu
+0005bdf0: 6d6e 732e 7374 722e 636f 6e74 6169 6e73  mns.str.contains
+0005be00: 2878 5b30 5d29 5d29 0a20 2020 2069 6620  (x[0])]).    if 
+0005be10: 6c65 6e28 7829 203e 2031 3a0a 2020 2020  len(x) > 1:.    
+0005be20: 2020 2020 666f 7220 7920 696e 2078 5b31      for y in x[1
+0005be30: 3a5d 3a0a 2020 2020 2020 2020 2020 2020  :]:.            
+0005be40: 6f75 746e 616d 6573 203d 205b 6920 666f  outnames = [i fo
+0005be50: 7220 6920 696e 206f 7574 6e61 6d65 7320  r i in outnames 
+0005be60: 6966 2079 2069 6e20 695d 0a20 2020 206f  if y in i].    o
+0005be70: 7574 6e61 6d65 7320 3d20 6765 745f 756e  utnames = get_un
+0005be80: 6971 7565 2820 6f75 746e 616d 6573 2029  ique( outnames )
+0005be90: 0a20 2020 2069 6620 6578 636c 7573 696f  .    if exclusio
+0005bea0: 6e73 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ns is not None:.
+0005beb0: 2020 2020 2020 2020 746f 6578 636c 7564          toexclud
+0005bec0: 6520 3d20 5b6e 616d 6520 666f 7220 6e61  e = [name for na
+0005bed0: 6d65 2069 6e20 6f75 746e 616d 6573 2069  me in outnames i
+0005bee0: 6620 6578 636c 7573 696f 6e73 5b30 5d20  f exclusions[0] 
+0005bef0: 696e 206e 616d 6520 5d0a 2020 2020 2020  in name ].      
+0005bf00: 2020 6966 206c 656e 2865 7863 6c75 7369    if len(exclusi
+0005bf10: 6f6e 7329 203e 2031 3a0a 2020 2020 2020  ons) > 1:.      
+0005bf20: 2020 2020 2020 666f 7220 7a7a 2069 6e20        for zz in 
+0005bf30: 6578 636c 7573 696f 6e73 5b31 3a5d 3a0a  exclusions[1:]:.
+0005bf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005bf50: 746f 6578 636c 7564 652e 6578 7465 6e64  toexclude.extend
+0005bf60: 285b 6e61 6d65 2066 6f72 206e 616d 6520  ([name for name 
+0005bf70: 696e 206f 7574 6e61 6d65 7320 6966 207a  in outnames if z
+0005bf80: 7a20 696e 206e 616d 6520 5d29 0a20 2020  z in name ]).   
+0005bf90: 2020 2020 2069 6620 6c65 6e28 746f 6578       if len(toex
+0005bfa0: 636c 7564 6529 203e 2030 3a0a 2020 2020  clude) > 0:.    
+0005bfb0: 2020 2020 2020 2020 6f75 746e 616d 6573          outnames
+0005bfc0: 203d 205b 6e61 6d65 2066 6f72 206e 616d   = [name for nam
+0005bfd0: 6520 696e 206f 7574 6e61 6d65 7320 6966  e in outnames if
+0005bfe0: 206e 616d 6520 6e6f 7420 696e 2074 6f65   name not in toe
+0005bff0: 7863 6c75 6465 5d0a 2020 2020 7265 7475  xclude].    retu
+0005c000: 726e 206f 7574 6e61 6d65 730a 0a0a 6465  rn outnames...de
+0005c010: 6620 6176 6572 6167 655f 6d6d 5f64 6628  f average_mm_df(
+0005c020: 206a 6d6d 5f69 6e2c 2064 6961 676e 6f73   jmm_in, diagnos
+0005c030: 7469 635f 6e3d 3235 2c20 636f 7272 5f74  tic_n=25, corr_t
+0005c040: 6872 6573 683d 302e 392c 2076 6572 626f  hresh=0.9, verbo
+0005c050: 7365 3d46 616c 7365 2029 3a0a 2020 2020  se=False ):.    
+0005c060: 2222 220a 2020 2020 6a6d 726f 7761 7667  """.    jmrowavg
+0005c070: 2c20 6a6d 6d63 6f6c 6176 672c 2064 6961  , jmmcolavg, dia
+0005c080: 676e 6f73 7469 6373 203d 2061 6e74 7370  gnostics = antsp
+0005c090: 796d 6d2e 6176 6572 6167 655f 6d6d 5f64  ymm.average_mm_d
+0005c0a0: 6628 206a 6d6d 5f69 6e2c 2076 6572 626f  f( jmm_in, verbo
+0005c0b0: 7365 3d54 7275 6520 290a 2020 2020 2222  se=True ).    ""
+0005c0c0: 220a 0a20 2020 206a 6d6d 203d 206a 6d6d  "..    jmm = jmm
+0005c0d0: 5f69 6e2e 636f 7079 2829 0a20 2020 2064  _in.copy().    d
+0005c0e0: 7863 6f6c 733d 5b27 7375 626a 6563 7469  xcols=['subjecti
+0005c0f0: 6431 272c 2773 7562 6a65 6374 6964 3227  d1','subjectid2'
+0005c100: 2c27 6d6f 6461 6c69 7479 6964 272c 276a  ,'modalityid','j
+0005c110: 6f69 6e69 6427 2c27 636f 7272 656c 6174  oinid','correlat
+0005c120: 696f 6e27 2c27 6469 7374 616e 6365 275d  ion','distance']
+0005c130: 0a20 2020 206a 6f69 6e44 6961 676e 6f73  .    joinDiagnos
+0005c140: 7469 6373 203d 2070 642e 4461 7461 4672  tics = pd.DataFr
+0005c150: 616d 6528 2063 6f6c 756d 6e73 203d 2064  ame( columns = d
+0005c160: 7863 6f6c 7320 290a 2020 2020 6e61 6e4c  xcols ).    nanL
+0005c170: 6973 743d 5b6d 6174 682e 6e61 6e5d 0a20  ist=[math.nan]. 
+0005c180: 2020 2064 6566 2072 6f62 2878 2c20 793d     def rob(x, y=
+0005c190: 302e 3939 293a 0a20 2020 2020 2020 2078  0.99):.        x
+0005c1a0: 5b78 203e 206e 702e 7175 616e 7469 6c65  [x > np.quantile
+0005c1b0: 2878 2c20 792c 206e 616e 5f70 6f6c 6963  (x, y, nan_polic
+0005c1c0: 793d 226f 6d69 7422 295d 203d 206e 702e  y="omit")] = np.
+0005c1d0: 6e61 6e0a 2020 2020 2020 2020 7265 7475  nan.        retu
+0005c1e0: 726e 2078 0a0a 2020 2020 6a6d 6d20 3d20  rn x..    jmm = 
+0005c1f0: 6a6d 6d2e 7265 706c 6163 6528 7227 5e5c  jmm.replace(r'^\
+0005c200: 732a 2427 2c20 6e70 2e6e 616e 2c20 7265  s*$', np.nan, re
+0005c210: 6765 783d 5472 7565 290a 0a20 2020 2069  gex=True)..    i
+0005c220: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+0005c230: 2020 2070 7269 6e74 2822 646f 2072 7366     print("do rsf
+0005c240: 4d52 4922 290a 2020 2020 2320 6865 7265  MRI").    # here
+0005c250: 202d 2077 6520 6669 7273 7420 6861 7665   - we first have
+0005c260: 2074 6f20 6176 6572 6167 6520 7769 7468   to average with
+0005c270: 696e 2065 6163 6820 726f 770a 2020 2020  in each row.    
+0005c280: 6474 3020 3d20 6765 745f 6e61 6d65 735f  dt0 = get_names_
+0005c290: 6672 6f6d 5f64 6174 615f 6672 616d 6528  from_data_frame(
+0005c2a0: 5b22 7273 664d 5249 225d 2c20 6a6d 6d2c  ["rsfMRI"], jmm,
+0005c2b0: 2065 7863 6c75 7369 6f6e 733d 5b22 556e   exclusions=["Un
+0005c2c0: 6e61 6d65 6422 2c20 2272 7366 4d52 495f  named", "rsfMRI_
+0005c2d0: 4c52 222c 2022 7273 664d 5249 5f52 4c22  LR", "rsfMRI_RL"
+0005c2e0: 5d29 0a20 2020 2064 7431 203d 2067 6574  ]).    dt1 = get
+0005c2f0: 5f6e 616d 6573 5f66 726f 6d5f 6461 7461  _names_from_data
+0005c300: 5f66 7261 6d65 285b 2272 7366 4d52 495f  _frame(["rsfMRI_
+0005c310: 524c 225d 2c20 6a6d 6d2c 2065 7863 6c75  RL"], jmm, exclu
+0005c320: 7369 6f6e 733d 5b22 556e 6e61 6d65 6422  sions=["Unnamed"
+0005c330: 5d29 0a20 2020 2069 6620 6c65 6e28 2064  ]).    if len( d
+0005c340: 7430 2029 203e 2030 2061 6e64 206c 656e  t0 ) > 0 and len
+0005c350: 2820 6474 3120 2920 3e20 303a 0a20 2020  ( dt1 ) > 0:.   
+0005c360: 2020 2020 2066 6c69 6420 3d20 6474 305b       flid = dt0[
+0005c370: 305d 0a20 2020 2020 2020 2077 726f 7773  0].        wrows
+0005c380: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
+0005c390: 7220 6920 696e 2072 616e 6765 286a 6d6d  r i in range(jmm
+0005c3a0: 2e73 6861 7065 5b30 5d29 3a0a 2020 2020  .shape[0]):.    
+0005c3b0: 2020 2020 2020 2020 6966 206e 6f74 2070          if not p
+0005c3c0: 642e 6973 6e61 286a 6d6d 5b64 7430 5b31  d.isna(jmm[dt0[1
+0005c3d0: 5d5d 5b69 5d29 206f 7220 6e6f 7420 7064  ]][i]) or not pd
+0005c3e0: 2e69 736e 6128 6a6d 6d5b 6474 315b 315d  .isna(jmm[dt1[1]
+0005c3f0: 5d5b 695d 2920 3a0a 2020 2020 2020 2020  ][i]) :.        
+0005c400: 2020 2020 2020 2020 7772 6f77 732e 6170          wrows.ap
+0005c410: 7065 6e64 2869 290a 2020 2020 2020 2020  pend(i).        
+0005c420: 666f 7220 6b20 696e 2077 726f 7773 3a0a  for k in wrows:.
+0005c430: 2020 2020 2020 2020 2020 2020 7631 203d              v1 =
+0005c440: 206a 6d6d 2e69 6c6f 635b 6b5d 5b64 7430   jmm.iloc[k][dt0
+0005c450: 5b31 3a5d 5d2e 6173 7479 7065 2866 6c6f  [1:]].astype(flo
+0005c460: 6174 290a 2020 2020 2020 2020 2020 2020  at).            
+0005c470: 7632 203d 206a 6d6d 2e69 6c6f 635b 6b5d  v2 = jmm.iloc[k]
+0005c480: 5b64 7431 5b31 3a5d 5d2e 6173 7479 7065  [dt1[1:]].astype
+0005c490: 2866 6c6f 6174 290a 2020 2020 2020 2020  (float).        
+0005c4a0: 2020 2020 7676 6563 203d 205b 7631 5b30      vvec = [v1[0
+0005c4b0: 5d2c 2076 325b 305d 5d0a 2020 2020 2020  ], v2[0]].      
+0005c4c0: 2020 2020 2020 6966 2061 6e79 287e 6e70        if any(~np
+0005c4d0: 2e69 736e 616e 2876 7665 6329 293a 0a20  .isnan(vvec)):. 
+0005c4e0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0005c4f0: 796e 6e61 203d 205b 6920 666f 7220 692c  ynna = [i for i,
+0005c500: 2078 2069 6e20 656e 756d 6572 6174 6528   x in enumerate(
+0005c510: 7676 6563 2920 6966 207e 6e70 2e69 736e  vvec) if ~np.isn
+0005c520: 616e 2878 295d 0a20 2020 2020 2020 2020  an(x)].         
+0005c530: 2020 2020 2020 206a 6d6d 2e69 6c6f 635b         jmm.iloc[
+0005c540: 6b5d 5b64 7430 5b30 5d5d 203d 2027 7273  k][dt0[0]] = 'rs
+0005c550: 664d 5249 270a 2020 2020 2020 2020 2020  fMRI'.          
+0005c560: 2020 2020 2020 6966 206c 656e 286d 796e        if len(myn
+0005c570: 6e61 2920 3d3d 2031 3a0a 2020 2020 2020  na) == 1:.      
+0005c580: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0005c590: 206d 796e 6e61 5b30 5d20 3d3d 2030 3a0a   mynna[0] == 0:.
 0005c5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c5b0: 6a6d 6d2e 696c 6f63 5b6b 5d5b 6474 305b  jmm.iloc[k][dt0[
-0005c5c0: 313a 5d5d 203d 2076 320a 2020 2020 2020  1:]] = v2.      
-0005c5d0: 2020 2020 2020 2020 2020 656c 6966 206c            elif l
-0005c5e0: 656e 286d 796e 6e61 2920 3e20 313a 0a20  en(mynna) > 1:. 
-0005c5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c600: 2020 2069 6620 6c65 6e28 7632 2920 3e20     if len(v2) > 
-0005c610: 6469 6167 6e6f 7374 6963 5f6e 3a0a 2020  diagnostic_n:.  
-0005c620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c630: 2020 2020 2020 7631 6478 3d76 315b 303a        v1dx=v1[0:
-0005c640: 6469 6167 6e6f 7374 6963 5f6e 5d0a 2020  diagnostic_n].  
+0005c5b0: 2020 2020 2020 2020 6a6d 6d2e 696c 6f63          jmm.iloc
+0005c5c0: 5b6b 5d5b 6474 305b 313a 5d5d 203d 2076  [k][dt0[1:]] = v
+0005c5d0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+0005c5e0: 2020 2020 2020 6966 206d 796e 6e61 5b30        if mynna[0
+0005c5f0: 5d20 3d3d 2031 3a0a 2020 2020 2020 2020  ] == 1:.        
+0005c600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005c610: 6a6d 6d2e 696c 6f63 5b6b 5d5b 6474 305b  jmm.iloc[k][dt0[
+0005c620: 313a 5d5d 203d 2076 320a 2020 2020 2020  1:]] = v2.      
+0005c630: 2020 2020 2020 2020 2020 656c 6966 206c            elif l
+0005c640: 656e 286d 796e 6e61 2920 3e20 313a 0a20  en(mynna) > 1:. 
 0005c650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c660: 2020 2020 2020 7632 6478 3d76 325b 303a        v2dx=v2[0:
-0005c670: 6469 6167 6e6f 7374 6963 5f6e 5d0a 2020  diagnostic_n].  
+0005c660: 2020 2069 6620 6c65 6e28 7632 2920 3e20     if len(v2) > 
+0005c670: 6469 6167 6e6f 7374 6963 5f6e 3a0a 2020  diagnostic_n:.  
 0005c680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c690: 2020 656c 7365 203a 0a20 2020 2020 2020    else :.       
-0005c6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c6b0: 2076 3164 783d 7631 0a20 2020 2020 2020   v1dx=v1.       
-0005c6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c6d0: 2076 3264 783d 7632 0a20 2020 2020 2020   v2dx=v2.       
-0005c6e0: 2020 2020 2020 2020 2020 2020 206a 6f69               joi
-0005c6f0: 6e44 6961 676e 6f73 7469 6373 4c6f 6320  nDiagnosticsLoc 
-0005c700: 3d20 7064 2e44 6174 6146 7261 6d65 2820  = pd.DataFrame( 
-0005c710: 636f 6c75 6d6e 7320 3d20 6478 636f 6c73  columns = dxcols
-0005c720: 2c20 696e 6465 783d 7261 6e67 6528 3129  , index=range(1)
-0005c730: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0005c740: 2020 2020 2020 206d 7963 6f72 7220 3d20         mycorr = 
-0005c750: 6e70 2e63 6f72 7263 6f65 6628 2076 3164  np.corrcoef( v1d
-0005c760: 782e 7661 6c75 6573 2c20 7632 6478 2e76  x.values, v2dx.v
-0005c770: 616c 7565 7320 295b 302c 315d 0a20 2020  alues )[0,1].   
-0005c780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c790: 206d 7965 7272 3d6e 702e 7371 7274 286e   myerr=np.sqrt(n
-0005c7a0: 702e 6d65 616e 2828 7631 6478 2e76 616c  p.mean((v1dx.val
-0005c7b0: 7565 7320 2d20 7632 6478 2e76 616c 7565  ues - v2dx.value
-0005c7c0: 7329 2a2a 3229 290a 2020 2020 2020 2020  s)**2)).        
-0005c7d0: 2020 2020 2020 2020 2020 2020 6a6f 696e              join
-0005c7e0: 4469 6167 6e6f 7374 6963 734c 6f63 2e69  DiagnosticsLoc.i
-0005c7f0: 6c6f 635b 305d 203d 205b 6a6d 6d2e 6c6f  loc[0] = [jmm.lo
-0005c800: 635b 6b2c 2775 5f68 6965 725f 6964 275d  c[k,'u_hier_id']
-0005c810: 2c6d 6174 682e 6e61 6e2c 2772 7366 4d52  ,math.nan,'rsfMR
-0005c820: 4927 2c27 636f 6c61 7667 272c 6d79 636f  I','colavg',myco
-0005c830: 7272 2c6d 7965 7272 5d0a 2020 2020 2020  rr,myerr].      
-0005c840: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0005c850: 206d 7963 6f72 7220 3e20 636f 7272 5f74   mycorr > corr_t
-0005c860: 6872 6573 683a 0a20 2020 2020 2020 2020  hresh:.         
-0005c870: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-0005c880: 6d6d 2e6c 6f63 5b6b 2c20 6474 305b 313a  mm.loc[k, dt0[1:
-0005c890: 5d5d 203d 2076 312e 7661 6c75 6573 2a30  ]] = v1.values*0
-0005c8a0: 2e35 202b 2076 322e 7661 6c75 6573 2a30  .5 + v2.values*0
-0005c8b0: 2e35 0a20 2020 2020 2020 2020 2020 2020  .5.             
-0005c8c0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0005c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c8e0: 2020 2020 206a 6d6d 2e6c 6f63 5b6b 2c20       jmm.loc[k, 
-0005c8f0: 6474 305b 313a 5d5d 203d 206e 616e 4c69  dt0[1:]] = nanLi
-0005c900: 7374 202a 206c 656e 2876 3129 0a20 2020  st * len(v1).   
-0005c910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c920: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+0005c690: 2020 2020 2020 7631 6478 3d76 315b 303a        v1dx=v1[0:
+0005c6a0: 6469 6167 6e6f 7374 6963 5f6e 5d0a 2020  diagnostic_n].  
+0005c6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005c6c0: 2020 2020 2020 7632 6478 3d76 325b 303a        v2dx=v2[0:
+0005c6d0: 6469 6167 6e6f 7374 6963 5f6e 5d0a 2020  diagnostic_n].  
+0005c6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005c6f0: 2020 656c 7365 203a 0a20 2020 2020 2020    else :.       
+0005c700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005c710: 2076 3164 783d 7631 0a20 2020 2020 2020   v1dx=v1.       
+0005c720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005c730: 2076 3264 783d 7632 0a20 2020 2020 2020   v2dx=v2.       
+0005c740: 2020 2020 2020 2020 2020 2020 206a 6f69               joi
+0005c750: 6e44 6961 676e 6f73 7469 6373 4c6f 6320  nDiagnosticsLoc 
+0005c760: 3d20 7064 2e44 6174 6146 7261 6d65 2820  = pd.DataFrame( 
+0005c770: 636f 6c75 6d6e 7320 3d20 6478 636f 6c73  columns = dxcols
+0005c780: 2c20 696e 6465 783d 7261 6e67 6528 3129  , index=range(1)
+0005c790: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0005c7a0: 2020 2020 2020 206d 7963 6f72 7220 3d20         mycorr = 
+0005c7b0: 6e70 2e63 6f72 7263 6f65 6628 2076 3164  np.corrcoef( v1d
+0005c7c0: 782e 7661 6c75 6573 2c20 7632 6478 2e76  x.values, v2dx.v
+0005c7d0: 616c 7565 7320 295b 302c 315d 0a20 2020  alues )[0,1].   
+0005c7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005c7f0: 206d 7965 7272 3d6e 702e 7371 7274 286e   myerr=np.sqrt(n
+0005c800: 702e 6d65 616e 2828 7631 6478 2e76 616c  p.mean((v1dx.val
+0005c810: 7565 7320 2d20 7632 6478 2e76 616c 7565  ues - v2dx.value
+0005c820: 7329 2a2a 3229 290a 2020 2020 2020 2020  s)**2)).        
+0005c830: 2020 2020 2020 2020 2020 2020 6a6f 696e              join
+0005c840: 4469 6167 6e6f 7374 6963 734c 6f63 2e69  DiagnosticsLoc.i
+0005c850: 6c6f 635b 305d 203d 205b 6a6d 6d2e 6c6f  loc[0] = [jmm.lo
+0005c860: 635b 6b2c 2775 5f68 6965 725f 6964 275d  c[k,'u_hier_id']
+0005c870: 2c6d 6174 682e 6e61 6e2c 2772 7366 4d52  ,math.nan,'rsfMR
+0005c880: 4927 2c27 636f 6c61 7667 272c 6d79 636f  I','colavg',myco
+0005c890: 7272 2c6d 7965 7272 5d0a 2020 2020 2020  rr,myerr].      
+0005c8a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0005c8b0: 206d 7963 6f72 7220 3e20 636f 7272 5f74   mycorr > corr_t
+0005c8c0: 6872 6573 683a 0a20 2020 2020 2020 2020  hresh:.         
+0005c8d0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+0005c8e0: 6d6d 2e6c 6f63 5b6b 2c20 6474 305b 313a  mm.loc[k, dt0[1:
+0005c8f0: 5d5d 203d 2076 312e 7661 6c75 6573 2a30  ]] = v1.values*0
+0005c900: 2e35 202b 2076 322e 7661 6c75 6573 2a30  .5 + v2.values*0
+0005c910: 2e35 0a20 2020 2020 2020 2020 2020 2020  .5.             
+0005c920: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
 0005c930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c940: 2020 2020 2070 7269 6e74 2820 6a6f 696e       print( join
-0005c950: 4469 6167 6e6f 7374 6963 734c 6f63 2029  DiagnosticsLoc )
-0005c960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005c970: 2020 2020 206a 6f69 6e44 6961 676e 6f73       joinDiagnos
-0005c980: 7469 6373 203d 2070 642e 636f 6e63 6174  tics = pd.concat
-0005c990: 2820 5b6a 6f69 6e44 6961 676e 6f73 7469  ( [joinDiagnosti
-0005c9a0: 6373 2c20 6a6f 696e 4469 6167 6e6f 7374  cs, joinDiagnost
-0005c9b0: 6963 734c 6f63 5d2c 2061 7869 733d 302c  icsLoc], axis=0,
-0005c9c0: 2069 676e 6f72 655f 696e 6465 783d 4661   ignore_index=Fa
-0005c9d0: 6c73 6520 290a 0a20 2020 2069 6620 7665  lse )..    if ve
-0005c9e0: 7262 6f73 653a 0a20 2020 2020 2020 2070  rbose:.        p
-0005c9f0: 7269 6e74 2822 646f 2044 5449 2229 0a20  rint("do DTI"). 
-0005ca00: 2020 2023 2068 6572 6520 2d20 7765 2066     # here - we f
-0005ca10: 6972 7374 2068 6176 6520 746f 2061 7665  irst have to ave
-0005ca20: 7261 6765 2077 6974 6869 6e20 6561 6368  rage within each
-0005ca30: 2072 6f77 0a20 2020 2064 7430 203d 2067   row.    dt0 = g
-0005ca40: 6574 5f6e 616d 6573 5f66 726f 6d5f 6461  et_names_from_da
-0005ca50: 7461 5f66 7261 6d65 285b 2244 5449 225d  ta_frame(["DTI"]
-0005ca60: 2c20 6a6d 6d2c 2065 7863 6c75 7369 6f6e  , jmm, exclusion
-0005ca70: 733d 5b22 556e 6e61 6d65 6422 2c20 2244  s=["Unnamed", "D
-0005ca80: 5449 5f4c 5222 2c20 2244 5449 5f52 4c22  TI_LR", "DTI_RL"
-0005ca90: 5d29 0a20 2020 2064 7431 203d 2067 6574  ]).    dt1 = get
-0005caa0: 5f6e 616d 6573 5f66 726f 6d5f 6461 7461  _names_from_data
-0005cab0: 5f66 7261 6d65 285b 2244 5449 5f4c 5222  _frame(["DTI_LR"
-0005cac0: 5d2c 206a 6d6d 2c20 6578 636c 7573 696f  ], jmm, exclusio
-0005cad0: 6e73 3d5b 2255 6e6e 616d 6564 225d 290a  ns=["Unnamed"]).
-0005cae0: 2020 2020 6474 3220 3d20 6765 745f 6e61      dt2 = get_na
-0005caf0: 6d65 735f 6672 6f6d 5f64 6174 615f 6672  mes_from_data_fr
-0005cb00: 616d 6528 205b 2244 5449 5f52 4c22 5d2c  ame( ["DTI_RL"],
-0005cb10: 206a 6d6d 2c20 6578 636c 7573 696f 6e73   jmm, exclusions
-0005cb20: 3d5b 2255 6e6e 616d 6564 225d 290a 2020  =["Unnamed"]).  
-0005cb30: 2020 666c 6964 203d 2064 7430 5b30 5d0a    flid = dt0[0].
-0005cb40: 2020 2020 7772 6f77 7320 3d20 5b5d 0a20      wrows = []. 
-0005cb50: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-0005cb60: 6528 6a6d 6d2e 7368 6170 655b 305d 293a  e(jmm.shape[0]):
-0005cb70: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0005cb80: 7064 2e69 736e 6128 6a6d 6d5b 6474 305b  pd.isna(jmm[dt0[
-0005cb90: 315d 5d5b 695d 2920 6f72 206e 6f74 2070  1]][i]) or not p
-0005cba0: 642e 6973 6e61 286a 6d6d 5b64 7431 5b31  d.isna(jmm[dt1[1
-0005cbb0: 5d5d 5b69 5d29 206f 7220 6e6f 7420 7064  ]][i]) or not pd
-0005cbc0: 2e69 736e 6128 6a6d 6d5b 6474 325b 315d  .isna(jmm[dt2[1]
-0005cbd0: 5d5b 695d 293a 0a20 2020 2020 2020 2020  ][i]):.         
-0005cbe0: 2020 2077 726f 7773 2e61 7070 656e 6428     wrows.append(
-0005cbf0: 6929 0a20 2020 2066 6f72 206b 2069 6e20  i).    for k in 
-0005cc00: 7772 6f77 733a 0a20 2020 2020 2020 2076  wrows:.        v
-0005cc10: 3120 3d20 6a6d 6d2e 6c6f 635b 6b2c 2064  1 = jmm.loc[k, d
-0005cc20: 7430 5b31 3a5d 5d2e 6173 7479 7065 2866  t0[1:]].astype(f
-0005cc30: 6c6f 6174 290a 2020 2020 2020 2020 7632  loat).        v2
-0005cc40: 203d 206a 6d6d 2e6c 6f63 5b6b 2c20 6474   = jmm.loc[k, dt
-0005cc50: 315b 313a 5d5d 2e61 7374 7970 6528 666c  1[1:]].astype(fl
-0005cc60: 6f61 7429 0a20 2020 2020 2020 2076 3320  oat).        v3 
-0005cc70: 3d20 6a6d 6d2e 6c6f 635b 6b2c 2064 7432  = jmm.loc[k, dt2
-0005cc80: 5b31 3a5d 5d2e 6173 7479 7065 2866 6c6f  [1:]].astype(flo
-0005cc90: 6174 290a 2020 2020 2020 2020 6368 6563  at).        chec
-0005cca0: 6b63 6f6c 203d 2064 7430 5b35 5d0a 2020  kcol = dt0[5].  
-0005ccb0: 2020 2020 2020 6966 206e 6f74 206e 702e        if not np.
-0005ccc0: 6973 6e61 6e28 7631 5b63 6865 636b 636f  isnan(v1[checkco
-0005ccd0: 6c5d 293a 0a20 2020 2020 2020 2020 2020  l]):.           
-0005cce0: 2069 6620 7631 5b63 6865 636b 636f 6c5d   if v1[checkcol]
-0005ccf0: 203c 2030 2e32 353a 0a20 2020 2020 2020   < 0.25:.       
-0005cd00: 2020 2020 2020 2020 2076 312e 7265 706c           v1.repl
-0005cd10: 6163 6528 6e70 2e6e 616e 2c20 696e 706c  ace(np.nan, inpl
-0005cd20: 6163 653d 5472 7565 290a 2020 2020 2020  ace=True).      
-0005cd30: 2020 6368 6563 6b63 6f6c 203d 2064 7431    checkcol = dt1
-0005cd40: 5b35 5d0a 2020 2020 2020 2020 6966 206e  [5].        if n
-0005cd50: 6f74 206e 702e 6973 6e61 6e28 7632 5b63  ot np.isnan(v2[c
-0005cd60: 6865 636b 636f 6c5d 293a 0a20 2020 2020  heckcol]):.     
-0005cd70: 2020 2020 2020 2069 6620 7632 5b63 6865         if v2[che
-0005cd80: 636b 636f 6c5d 203c 2030 2e32 353a 0a20  ckcol] < 0.25:. 
-0005cd90: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-0005cda0: 322e 7265 706c 6163 6528 6e70 2e6e 616e  2.replace(np.nan
-0005cdb0: 2c20 696e 706c 6163 653d 5472 7565 290a  , inplace=True).
-0005cdc0: 2020 2020 2020 2020 6368 6563 6b63 6f6c          checkcol
-0005cdd0: 203d 2064 7432 5b35 5d0a 2020 2020 2020   = dt2[5].      
-0005cde0: 2020 6966 206e 6f74 206e 702e 6973 6e61    if not np.isna
-0005cdf0: 6e28 7633 5b63 6865 636b 636f 6c5d 293a  n(v3[checkcol]):
-0005ce00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0005ce10: 7633 5b63 6865 636b 636f 6c5d 203c 2030  v3[checkcol] < 0
-0005ce20: 2e32 353a 0a20 2020 2020 2020 2020 2020  .25:.           
-0005ce30: 2020 2020 2076 332e 7265 706c 6163 6528       v3.replace(
-0005ce40: 6e70 2e6e 616e 2c20 696e 706c 6163 653d  np.nan, inplace=
-0005ce50: 5472 7565 290a 2020 2020 2020 2020 7676  True).        vv
-0005ce60: 6563 203d 205b 7631 5b30 5d2c 2076 325b  ec = [v1[0], v2[
-0005ce70: 305d 2c20 7633 5b30 5d5d 0a20 2020 2020  0], v3[0]].     
-0005ce80: 2020 2069 6620 616e 7928 7e6e 702e 6973     if any(~np.is
-0005ce90: 6e61 6e28 7676 6563 2929 3a0a 2020 2020  nan(vvec)):.    
-0005cea0: 2020 2020 2020 2020 6d79 6e6e 6120 3d20          mynna = 
-0005ceb0: 5b69 2066 6f72 2069 2c20 7820 696e 2065  [i for i, x in e
-0005cec0: 6e75 6d65 7261 7465 2876 7665 6329 2069  numerate(vvec) i
-0005ced0: 6620 7e6e 702e 6973 6e61 6e28 7829 5d0a  f ~np.isnan(x)].
-0005cee0: 2020 2020 2020 2020 2020 2020 6a6d 6d2e              jmm.
-0005cef0: 6c6f 635b 6b2c 2064 7430 5b30 5d5d 203d  loc[k, dt0[0]] =
-0005cf00: 2027 4454 4927 0a20 2020 2020 2020 2020   'DTI'.         
-0005cf10: 2020 2069 6620 6c65 6e28 6d79 6e6e 6129     if len(mynna)
-0005cf20: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
-0005cf30: 2020 2020 2020 2069 6620 6d79 6e6e 615b         if mynna[
-0005cf40: 305d 203d 3d20 303a 0a20 2020 2020 2020  0] == 0:.       
-0005cf50: 2020 2020 2020 2020 2020 2020 206a 6d6d               jmm
-0005cf60: 2e6c 6f63 5b6b 2c20 6474 305b 313a 5d5d  .loc[k, dt0[1:]]
-0005cf70: 203d 2076 310a 2020 2020 2020 2020 2020   = v1.          
-0005cf80: 2020 2020 2020 6966 206d 796e 6e61 5b30        if mynna[0
-0005cf90: 5d20 3d3d 2031 3a0a 2020 2020 2020 2020  ] == 1:.        
-0005cfa0: 2020 2020 2020 2020 2020 2020 6a6d 6d2e              jmm.
-0005cfb0: 6c6f 635b 6b2c 2064 7430 5b31 3a5d 5d20  loc[k, dt0[1:]] 
-0005cfc0: 3d20 7632 0a20 2020 2020 2020 2020 2020  = v2.           
-0005cfd0: 2020 2020 2069 6620 6d79 6e6e 615b 305d       if mynna[0]
-0005cfe0: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
-0005cff0: 2020 2020 2020 2020 2020 206a 6d6d 2e6c             jmm.l
-0005d000: 6f63 5b6b 2c20 6474 305b 313a 5d5d 203d  oc[k, dt0[1:]] =
-0005d010: 2076 330a 2020 2020 2020 2020 2020 2020   v3.            
-0005d020: 656c 6966 206c 656e 286d 796e 6e61 2920  elif len(mynna) 
-0005d030: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
-0005d040: 2020 2020 2069 6620 6d79 6e6e 615b 305d       if mynna[0]
-0005d050: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-0005d060: 2020 2020 2020 2020 2020 206a 6d6d 2e6c             jmm.l
-0005d070: 6f63 5b6b 2c20 6474 305b 313a 5d5d 203d  oc[k, dt0[1:]] =
-0005d080: 2076 310a 2020 2020 2020 2020 2020 2020   v1.            
-0005d090: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0005d0a0: 2020 2020 2020 2020 2020 2020 2020 6a6f                jo
-0005d0b0: 696e 4469 6167 6e6f 7374 6963 734c 6f63  inDiagnosticsLoc
-0005d0c0: 203d 2070 642e 4461 7461 4672 616d 6528   = pd.DataFrame(
-0005d0d0: 2063 6f6c 756d 6e73 203d 2064 7863 6f6c   columns = dxcol
-0005d0e0: 732c 2069 6e64 6578 3d72 616e 6765 2831  s, index=range(1
-0005d0f0: 2920 290a 2020 2020 2020 2020 2020 2020  ) ).            
-0005d100: 2020 2020 2020 2020 6d79 636f 7272 203d          mycorr =
-0005d110: 206e 702e 636f 7272 636f 6566 2820 7632   np.corrcoef( v2
-0005d120: 5b30 3a64 6961 676e 6f73 7469 635f 6e5d  [0:diagnostic_n]
-0005d130: 2e76 616c 7565 732c 2076 335b 303a 6469  .values, v3[0:di
-0005d140: 6167 6e6f 7374 6963 5f6e 5d2e 7661 6c75  agnostic_n].valu
-0005d150: 6573 2029 5b30 2c31 5d0a 2020 2020 2020  es )[0,1].      
-0005d160: 2020 2020 2020 2020 2020 2020 2020 6d79                my
-0005d170: 6572 723d 6e70 2e73 7172 7428 6e70 2e6d  err=np.sqrt(np.m
-0005d180: 6561 6e28 2876 325b 303a 6469 6167 6e6f  ean((v2[0:diagno
-0005d190: 7374 6963 5f6e 5d2e 7661 6c75 6573 202d  stic_n].values -
-0005d1a0: 2076 335b 303a 6469 6167 6e6f 7374 6963   v3[0:diagnostic
-0005d1b0: 5f6e 5d2e 7661 6c75 6573 292a 2a32 2929  _n].values)**2))
-0005d1c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005d1d0: 2020 2020 206a 6f69 6e44 6961 676e 6f73       joinDiagnos
-0005d1e0: 7469 6373 4c6f 632e 696c 6f63 5b30 5d20  ticsLoc.iloc[0] 
-0005d1f0: 3d20 5b6a 6d6d 2e6c 6f63 5b6b 2c27 755f  = [jmm.loc[k,'u_
-0005d200: 6869 6572 5f69 6427 5d2c 6d61 7468 2e6e  hier_id'],math.n
-0005d210: 616e 2c27 4454 4927 2c27 636f 6c61 7667  an,'DTI','colavg
-0005d220: 272c 6d79 636f 7272 2c6d 7965 7272 5d0a  ',mycorr,myerr].
-0005d230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d240: 2020 2020 6966 206d 7963 6f72 7220 3e20      if mycorr > 
-0005d250: 636f 7272 5f74 6872 6573 683a 0a20 2020  corr_thresh:.   
-0005d260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d270: 2020 2020 206a 6d6d 2e6c 6f63 5b6b 2c20       jmm.loc[k, 
-0005d280: 6474 305b 313a 5d5d 203d 2076 322e 7661  dt0[1:]] = v2.va
-0005d290: 6c75 6573 2a30 2e35 202b 2076 332e 7661  lues*0.5 + v3.va
-0005d2a0: 6c75 6573 2a30 2e35 0a20 2020 2020 2020  lues*0.5.       
-0005d2b0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0005d2c0: 653a 2023 0a20 2020 2020 2020 2020 2020  e: #.           
-0005d2d0: 2020 2020 2020 2020 2020 2020 206a 6d6d               jmm
-0005d2e0: 2e6c 6f63 5b6b 2c20 6474 305b 313a 5d5d  .loc[k, dt0[1:]]
-0005d2f0: 203d 206e 616e 4c69 7374 202a 206c 656e   = nanList * len
-0005d300: 2820 6474 305b 313a 5d20 290a 2020 2020  ( dt0[1:] ).    
-0005d310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d320: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-0005d330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d340: 2020 2020 7072 696e 7428 206a 6f69 6e44      print( joinD
-0005d350: 6961 676e 6f73 7469 6373 4c6f 6320 290a  iagnosticsLoc ).
-0005d360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d370: 2020 2020 6a6f 696e 4469 6167 6e6f 7374      joinDiagnost
-0005d380: 6963 7320 3d20 7064 2e63 6f6e 6361 7428  ics = pd.concat(
-0005d390: 205b 6a6f 696e 4469 6167 6e6f 7374 6963   [joinDiagnostic
-0005d3a0: 732c 206a 6f69 6e44 6961 676e 6f73 7469  s, joinDiagnosti
-0005d3b0: 6373 4c6f 635d 2c20 6178 6973 3d30 2c20  csLoc], axis=0, 
-0005d3c0: 6967 6e6f 7265 5f69 6e64 6578 3d46 616c  ignore_index=Fal
-0005d3d0: 7365 2029 0a0a 0a20 2020 2023 2066 6972  se )...    # fir
-0005d3e0: 7374 2074 6173 6b20 2d20 736f 7274 2062  st task - sort b
-0005d3f0: 7920 755f 6869 6572 5f69 640a 2020 2020  y u_hier_id.    
-0005d400: 6a6d 6d20 3d20 6a6d 6d2e 736f 7274 5f76  jmm = jmm.sort_v
-0005d410: 616c 7565 7328 2022 755f 6869 6572 5f69  alues( "u_hier_i
-0005d420: 6422 2029 0a20 2020 2023 2067 6574 2072  d" ).    # get r
-0005d430: 6964 206f 6620 6a75 6e6b 2063 6f6c 756d  id of junk colum
-0005d440: 6e73 0a20 2020 2062 6164 6e61 6d65 7320  ns.    badnames 
-0005d450: 3d20 6765 745f 6e61 6d65 735f 6672 6f6d  = get_names_from
-0005d460: 5f64 6174 615f 6672 616d 6528 205b 2755  _data_frame( ['U
-0005d470: 6e6e 616d 6564 275d 2c20 6a6d 6d20 290a  nnamed'], jmm ).
-0005d480: 2020 2020 6a6d 6d3d 6a6d 6d2e 6472 6f70      jmm=jmm.drop
-0005d490: 2862 6164 6e61 6d65 732c 2061 7869 733d  (badnames, axis=
-0005d4a0: 3129 0a20 2020 206a 6d6d 3d6a 6d6d 2e73  1).    jmm=jmm.s
-0005d4b0: 6574 5f69 6e64 6578 2822 755f 6869 6572  et_index("u_hier
-0005d4c0: 5f69 6422 2c64 726f 703d 4661 6c73 6529  _id",drop=False)
-0005d4d0: 0a20 2020 2023 2032 6e64 202d 2067 6574  .    # 2nd - get
-0005d4e0: 2072 6964 206f 6620 6475 706c 6963 6174   rid of duplicat
-0005d4f0: 6564 2075 5f68 6965 725f 6964 0a20 2020  ed u_hier_id.   
-0005d500: 206a 6d6d 556e 6971 203d 206a 6d6d 2e64   jmmUniq = jmm.d
-0005d510: 726f 705f 6475 706c 6963 6174 6573 2820  rop_duplicates( 
-0005d520: 7375 6273 6574 3d22 755f 6869 6572 5f69  subset="u_hier_i
-0005d530: 6422 2029 2023 2066 6173 7420 616e 6420  d" ) # fast and 
-0005d540: 6561 7379 0a20 2020 2023 2066 6f72 2065  easy.    # for e
-0005d550: 6163 6820 6d6f 6461 6c69 7479 2c20 636f  ach modality, co
-0005d560: 756e 7420 7768 6963 6820 6964 7320 6861  unt which ids ha
-0005d570: 7665 206d 6f72 6520 7468 616e 206f 6e65  ve more than one
-0005d580: 0a20 2020 206d 6f64 5f6e 616d 6573 203d  .    mod_names =
-0005d590: 2067 6574 5f76 616c 6964 5f6d 6f64 616c   get_valid_modal
-0005d5a0: 6974 6965 7328 290a 2020 2020 666f 7220  ities().    for 
-0005d5b0: 6d6f 645f 6e61 6d65 2069 6e20 6d6f 645f  mod_name in mod_
-0005d5c0: 6e61 6d65 733a 0a20 2020 2020 2020 2066  names:.        f
-0005d5d0: 6c5f 6e61 6d65 7320 3d20 6765 745f 6e61  l_names = get_na
-0005d5e0: 6d65 735f 6672 6f6d 5f64 6174 615f 6672  mes_from_data_fr
-0005d5f0: 616d 6528 5b6d 6f64 5f6e 616d 655d 2c20  ame([mod_name], 
-0005d600: 6a6d 6d2c 0a20 2020 2020 2020 2020 2020  jmm,.           
-0005d610: 2065 7863 6c75 7369 6f6e 733d 5b27 556e   exclusions=['Un
-0005d620: 6e61 6d65 6427 2c22 4454 495f 4c52 222c  named',"DTI_LR",
-0005d630: 2244 5449 5f52 4c22 2c22 7273 664d 5249  "DTI_RL","rsfMRI
-0005d640: 5f52 4c22 2c22 7273 664d 5249 5f4c 5222  _RL","rsfMRI_LR"
-0005d650: 5d29 0a20 2020 2020 2020 2069 6620 6c65  ]).        if le
-0005d660: 6e28 2066 6c5f 6e61 6d65 7320 2920 3e20  n( fl_names ) > 
-0005d670: 313a 0a20 2020 2020 2020 2020 2020 2069  1:.            i
-0005d680: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-0005d690: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0005d6a0: 286d 6f64 5f6e 616d 6529 0a20 2020 2020  (mod_name).     
-0005d6b0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0005d6c0: 2866 6c5f 6e61 6d65 7329 0a20 2020 2020  (fl_names).     
-0005d6d0: 2020 2020 2020 2066 6c5f 6964 203d 2066         fl_id = f
-0005d6e0: 6c5f 6e61 6d65 735b 305d 0a20 2020 2020  l_names[0].     
-0005d6f0: 2020 2020 2020 206e 5f6e 616d 6573 203d         n_names =
-0005d700: 206c 656e 2866 6c5f 6e61 6d65 7329 0a20   len(fl_names). 
-0005d710: 2020 2020 2020 2020 2020 206c 6f63 7665             locve
-0005d720: 6320 3d20 6a6d 6d5b 666c 5f6e 616d 6573  c = jmm[fl_names
-0005d730: 5b6e 5f6e 616d 6573 2d31 5d5d 2e61 7374  [n_names-1]].ast
-0005d740: 7970 6528 666c 6f61 7429 0a20 2020 2020  ype(float).     
-0005d750: 2020 2020 2020 2062 6f6f 6c76 6563 3d7e         boolvec=~
-0005d760: 7064 2e69 736e 6128 6c6f 6376 6563 290a  pd.isna(locvec).
-0005d770: 2020 2020 2020 2020 2020 2020 6a6d 6d73              jmms
-0005d780: 7562 203d 206a 6d6d 5b62 6f6f 6c76 6563  ub = jmm[boolvec
-0005d790: 5d5b 205b 2775 5f68 6965 725f 6964 275d  ][ ['u_hier_id']
-0005d7a0: 2b66 6c5f 6e61 6d65 735d 0a20 2020 2020  +fl_names].     
-0005d7b0: 2020 2020 2020 206d 795f 7462 6c20 3d20         my_tbl = 
-0005d7c0: 436f 756e 7465 7228 6a6d 6d73 7562 5b27  Counter(jmmsub['
-0005d7d0: 755f 6869 6572 5f69 6427 5d29 0a20 2020  u_hier_id']).   
-0005d7e0: 2020 2020 2020 2020 2067 746f 6176 6720           gtoavg 
-0005d7f0: 3d20 5b6e 616d 6520 666f 7220 6e61 6d65  = [name for name
-0005d800: 2069 6e20 6d79 5f74 626c 2e6b 6579 7328   in my_tbl.keys(
-0005d810: 2920 6966 206d 795f 7462 6c5b 6e61 6d65  ) if my_tbl[name
-0005d820: 5d20 3d3d 2031 5d0a 2020 2020 2020 2020  ] == 1].        
-0005d830: 2020 2020 6774 6f61 7667 4731 203d 205b      gtoavgG1 = [
-0005d840: 6e61 6d65 2066 6f72 206e 616d 6520 696e  name for name in
-0005d850: 206d 795f 7462 6c2e 6b65 7973 2829 2069   my_tbl.keys() i
-0005d860: 6620 6d79 5f74 626c 5b6e 616d 655d 203e  f my_tbl[name] >
-0005d870: 2031 5d0a 2020 2020 2020 2020 2020 2020   1].            
-0005d880: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-0005d890: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0005d8a0: 7428 224a 6f69 6e20 3122 290a 2020 2020  t("Join 1").    
-0005d8b0: 2020 2020 2020 2020 6a6d 6d73 7562 3120          jmmsub1 
-0005d8c0: 3d20 6a6d 6d73 7562 2e6c 6f63 5b6a 6d6d  = jmmsub.loc[jmm
-0005d8d0: 7375 625b 2775 5f68 6965 725f 6964 275d  sub['u_hier_id']
-0005d8e0: 2e69 7369 6e28 6774 6f61 7667 295d 5b5b  .isin(gtoavg)][[
-0005d8f0: 2775 5f68 6965 725f 6964 275d 2b66 6c5f  'u_hier_id']+fl_
-0005d900: 6e61 6d65 735d 0a20 2020 2020 2020 2020  names].         
-0005d910: 2020 2066 6f72 2075 2069 6e20 6774 6f61     for u in gtoa
-0005d920: 7667 3a0a 2020 2020 2020 2020 2020 2020  vg:.            
-0005d930: 2020 2020 6a6d 6d55 6e69 712e 6c6f 635b      jmmUniq.loc[
-0005d940: 755d 5b66 6c5f 6e61 6d65 735b 313a 5d5d  u][fl_names[1:]]
-0005d950: 203d 206a 6d6d 7375 6231 2e6c 6f63 5b75   = jmmsub1.loc[u
-0005d960: 5d5b 666c 5f6e 616d 6573 5b31 3a5d 5d0a  ][fl_names[1:]].
-0005d970: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-0005d980: 6572 626f 7365 2061 6e64 206c 656e 2867  erbose and len(g
-0005d990: 746f 6176 6747 3129 203e 2031 3a0a 2020  toavgG1) > 1:.  
-0005d9a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0005d9b0: 696e 7428 224a 6f69 6e20 3e31 2229 0a20  int("Join >1"). 
-0005d9c0: 2020 2020 2020 2020 2020 206a 6d6d 7375             jmmsu
-0005d9d0: 6247 3120 3d20 6a6d 6d73 7562 2e6c 6f63  bG1 = jmmsub.loc
-0005d9e0: 5b6a 6d6d 7375 625b 2775 5f68 6965 725f  [jmmsub['u_hier_
-0005d9f0: 6964 275d 2e69 7369 6e28 6774 6f61 7667  id'].isin(gtoavg
-0005da00: 4731 295d 5b5b 2775 5f68 6965 725f 6964  G1)][['u_hier_id
-0005da10: 275d 2b66 6c5f 6e61 6d65 735d 0a20 2020  ']+fl_names].   
-0005da20: 2020 2020 2020 2020 2066 6f72 2075 2069           for u i
-0005da30: 6e20 6774 6f61 7667 4731 3a0a 2020 2020  n gtoavgG1:.    
-0005da40: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
-0005da50: 203d 206a 6d6d 7375 6247 312e 6c6f 635b   = jmmsubG1.loc[
-0005da60: 755d 5b20 5b27 755f 6869 6572 5f69 6427  u][ ['u_hier_id'
-0005da70: 5d2b 666c 5f6e 616d 6573 205d 0a20 2020  ]+fl_names ].   
-0005da80: 2020 2020 2020 2020 2020 2020 2064 726f               dro
-0005da90: 706e 616d 6573 203d 2067 6574 5f6e 616d  pnames = get_nam
-0005daa0: 6573 5f66 726f 6d5f 6461 7461 5f66 7261  es_from_data_fra
-0005dab0: 6d65 2820 5b27 4d4d 2e49 4427 5d2c 2074  me( ['MM.ID'], t
-0005dac0: 656d 7020 290a 2020 2020 2020 2020 2020  emp ).          
-0005dad0: 2020 2020 2020 7465 6d70 5665 6320 3d20        tempVec = 
-0005dae0: 7465 6d70 2e64 726f 7028 636f 6c75 6d6e  temp.drop(column
-0005daf0: 733d 6472 6f70 6e61 6d65 7329 0a20 2020  s=dropnames).   
-0005db00: 2020 2020 2020 2020 2020 2020 206a 6f69               joi
-0005db10: 6e44 6961 676e 6f73 7469 6373 4c6f 6320  nDiagnosticsLoc 
-0005db20: 3d20 7064 2e44 6174 6146 7261 6d65 2820  = pd.DataFrame( 
-0005db30: 636f 6c75 6d6e 7320 3d20 6478 636f 6c73  columns = dxcols
-0005db40: 2c20 696e 6465 783d 7261 6e67 6528 3129  , index=range(1)
-0005db50: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0005db60: 2020 2069 6431 3d74 656d 705b 666c 5f69     id1=temp[fl_i
-0005db70: 645d 2e69 6c6f 635b 305d 0a20 2020 2020  d].iloc[0].     
-0005db80: 2020 2020 2020 2020 2020 2069 6432 3d74             id2=t
-0005db90: 656d 705b 666c 5f69 645d 2e69 6c6f 635b  emp[fl_id].iloc[
-0005dba0: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
-0005dbb0: 2020 2076 313d 7465 6d70 5665 632e 696c     v1=tempVec.il
-0005dbc0: 6f63 5b30 5d5b 313a 5d2e 6173 7479 7065  oc[0][1:].astype
-0005dbd0: 2866 6c6f 6174 292e 746f 5f6e 756d 7079  (float).to_numpy
-0005dbe0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-0005dbf0: 2020 2076 323d 7465 6d70 5665 632e 696c     v2=tempVec.il
-0005dc00: 6f63 5b31 5d5b 313a 5d2e 6173 7479 7065  oc[1][1:].astype
-0005dc10: 2866 6c6f 6174 292e 746f 5f6e 756d 7079  (float).to_numpy
-0005dc20: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-0005dc30: 2020 2069 6620 6c65 6e28 7632 2920 3e20     if len(v2) > 
-0005dc40: 6469 6167 6e6f 7374 6963 5f6e 3a0a 2020  diagnostic_n:.  
-0005dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005dc60: 2020 7631 3d76 315b 303a 6469 6167 6e6f    v1=v1[0:diagno
-0005dc70: 7374 6963 5f6e 5d0a 2020 2020 2020 2020  stic_n].        
-0005dc80: 2020 2020 2020 2020 2020 2020 7632 3d76              v2=v
-0005dc90: 325b 303a 6469 6167 6e6f 7374 6963 5f6e  2[0:diagnostic_n
-0005dca0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0005dcb0: 2020 6d79 636f 7272 203d 206e 702e 636f    mycorr = np.co
-0005dcc0: 7272 636f 6566 2820 7631 2c20 7632 2029  rrcoef( v1, v2 )
-0005dcd0: 5b30 2c31 5d0a 2020 2020 2020 2020 2020  [0,1].          
-0005dce0: 2020 2020 2020 2320 6d79 636f 7272 3d74        # mycorr=t
-0005dcf0: 656d 7061 7272 5b6e 702e 7472 6975 5f69  emparr[np.triu_i
-0005dd00: 6e64 6963 6573 5f66 726f 6d28 7465 6d70  ndices_from(temp
-0005dd10: 6172 722c 206b 3d31 295d 2e6d 6561 6e28  arr, k=1)].mean(
-0005dd20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0005dd30: 2020 6d79 6572 723d 6e70 2e73 7172 7428    myerr=np.sqrt(
-0005dd40: 6e70 2e6d 6561 6e28 2876 3120 2d20 7632  np.mean((v1 - v2
-0005dd50: 292a 2a32 2929 0a20 2020 2020 2020 2020  )**2)).         
-0005dd60: 2020 2020 2020 206a 6f69 6e44 6961 676e         joinDiagn
-0005dd70: 6f73 7469 6373 4c6f 632e 696c 6f63 5b30  osticsLoc.iloc[0
-0005dd80: 5d20 3d20 5b69 6431 2c69 6432 2c6d 6f64  ] = [id1,id2,mod
-0005dd90: 5f6e 616d 652c 2772 6f77 6176 6727 2c6d  _name,'rowavg',m
-0005dda0: 7963 6f72 722c 6d79 6572 725d 0a20 2020  ycorr,myerr].   
-0005ddb0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0005ddc0: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-0005ddd0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0005dde0: 6e74 2820 6a6f 696e 4469 6167 6e6f 7374  nt( joinDiagnost
-0005ddf0: 6963 734c 6f63 2029 0a20 2020 2020 2020  icsLoc ).       
-0005de00: 2020 2020 2020 2020 2074 656d 7020 3d20           temp = 
-0005de10: 6a6d 6d73 7562 4731 2e6c 6f63 5b75 5d5b  jmmsubG1.loc[u][
-0005de20: 666c 5f6e 616d 6573 5b31 3a5d 5d2e 6173  fl_names[1:]].as
-0005de30: 7479 7065 2866 6c6f 6174 290a 2020 2020  type(float).    
-0005de40: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-0005de50: 7963 6f72 7220 3e20 636f 7272 5f74 6872  ycorr > corr_thr
-0005de60: 6573 6820 6f72 206c 656e 2820 7631 2029  esh or len( v1 )
-0005de70: 203c 2031 303a 0a20 2020 2020 2020 2020   < 10:.         
-0005de80: 2020 2020 2020 2020 2020 206a 6d6d 556e             jmmUn
-0005de90: 6971 2e6c 6f63 5b75 5d5b 666c 5f6e 616d  iq.loc[u][fl_nam
-0005dea0: 6573 5b31 3a5d 5d20 3d20 7465 6d70 2e6d  es[1:]] = temp.m
-0005deb0: 6561 6e28 6178 6973 3d30 290a 2020 2020  ean(axis=0).    
-0005dec0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0005ded0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0005dee0: 2020 2020 2020 6a6d 6d55 6e69 712e 6c6f        jmmUniq.lo
-0005def0: 635b 755d 5b66 6c5f 6e61 6d65 735b 313a  c[u][fl_names[1:
-0005df00: 5d5d 203d 206e 616e 4c69 7374 202a 2074  ]] = nanList * t
-0005df10: 656d 702e 7368 6170 655b 315d 0a20 2020  emp.shape[1].   
-0005df20: 2020 2020 2020 2020 2020 2020 206a 6f69               joi
-0005df30: 6e44 6961 676e 6f73 7469 6373 203d 2070  nDiagnostics = p
-0005df40: 642e 636f 6e63 6174 2820 5b6a 6f69 6e44  d.concat( [joinD
-0005df50: 6961 676e 6f73 7469 6373 2c20 6a6f 696e  iagnostics, join
-0005df60: 4469 6167 6e6f 7374 6963 734c 6f63 5d2c  DiagnosticsLoc],
-0005df70: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-0005df80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005df90: 2020 2020 2020 2020 2020 2020 2020 6178                ax
-0005dfa0: 6973 3d30 2c20 6967 6e6f 7265 5f69 6e64  is=0, ignore_ind
-0005dfb0: 6578 3d46 616c 7365 2029 0a0a 2020 2020  ex=False )..    
-0005dfc0: 7265 7475 726e 206a 6d6d 556e 6971 2c20  return jmmUniq, 
-0005dfd0: 6a6d 6d2c 206a 6f69 6e44 6961 676e 6f73  jmm, joinDiagnos
-0005dfe0: 7469 6373 0a0a 0a0a 6465 6620 7175 6963  tics....def quic
-0005dff0: 6b5f 7669 7a5f 6d6d 5f6e 7267 280a 2020  k_viz_mm_nrg(.  
-0005e000: 2020 736f 7572 6365 6469 722c 2023 2072    sourcedir, # r
-0005e010: 6f6f 7420 666f 6c64 6572 0a20 2020 2070  oot folder.    p
-0005e020: 726f 6a65 6374 6964 2c20 2320 7072 6f6a  rojectid, # proj
-0005e030: 6563 7420 6e61 6d65 0a20 2020 2073 6964  ect name.    sid
-0005e040: 202c 2023 2073 7562 6a65 6374 2075 6e69   , # subject uni
-0005e050: 7175 6520 6964 0a20 2020 2064 7469 642c  que id.    dtid,
-0005e060: 2023 2064 6174 650a 2020 2020 6578 7472   # date.    extr
-0005e070: 6163 745f 6272 6169 6e3d 5472 7565 2c0a  act_brain=True,.
-0005e080: 2020 2020 736c 6963 655f 6661 6374 6f72      slice_factor
-0005e090: 203d 2030 2e35 352c 0a20 2020 2073 686f   = 0.55,.    sho
-0005e0a0: 775f 6974 203d 204e 6f6e 652c 2023 206f  w_it = None, # o
-0005e0b0: 7574 7075 7420 7061 7468 0a20 2020 2076  utput path.    v
-0005e0c0: 6572 626f 7365 203d 2054 7275 650a 293a  erbose = True.):
-0005e0d0: 0a20 2020 2022 2222 0a20 2020 2054 6869  .    """.    Thi
-0005e0e0: 7320 6675 6e63 7469 6f6e 2063 7265 6174  s function creat
-0005e0f0: 6573 2076 6973 7561 6c69 7a61 7469 6f6e  es visualization
-0005e100: 7320 6f66 2062 7261 696e 2069 6d61 6765  s of brain image
-0005e110: 7320 666f 7220 6120 7370 6563 6966 6963  s for a specific
-0005e120: 2073 7562 6a65 6374 2069 6e20 6120 7072   subject in a pr
-0005e130: 6f6a 6563 7420 7573 696e 6720 414e 5473  oject using ANTs
-0005e140: 5079 2e0a 0a20 2020 2041 7267 733a 0a0a  Py...    Args:..
-0005e150: 2020 2020 736f 7572 6365 6469 7220 2873      sourcedir (s
-0005e160: 7472 293a 2052 6f6f 7420 666f 6c64 6572  tr): Root folder
-0005e170: 2e0a 2020 2020 0a20 2020 2070 726f 6a65  ..    .    proje
-0005e180: 6374 6964 2028 7374 7229 3a20 5072 6f6a  ctid (str): Proj
-0005e190: 6563 7420 6e61 6d65 2e0a 2020 2020 0a20  ect name..    . 
-0005e1a0: 2020 2073 6964 2028 7374 7229 3a20 5375     sid (str): Su
-0005e1b0: 626a 6563 7420 756e 6971 7565 2069 642e  bject unique id.
-0005e1c0: 0a20 2020 200a 2020 2020 6474 6964 2028  .    .    dtid (
-0005e1d0: 7374 7229 3a20 4461 7465 2e0a 2020 2020  str): Date..    
-0005e1e0: 0a20 2020 2065 7874 7261 6374 5f62 7261  .    extract_bra
-0005e1f0: 696e 2028 626f 6f6c 293a 2049 6620 5472  in (bool): If Tr
-0005e200: 7565 2c20 7468 6520 6675 6e63 7469 6f6e  ue, the function
-0005e210: 2065 7874 7261 6374 7320 7468 6520 6272   extracts the br
-0005e220: 6169 6e20 6672 6f6d 2074 6865 2054 3177  ain from the T1w
-0005e230: 2069 6d61 6765 2e20 4465 6661 756c 7420   image. Default 
-0005e240: 6973 2054 7275 652e 0a20 2020 200a 2020  is True..    .  
-0005e250: 2020 736c 6963 655f 6661 6374 6f72 2028    slice_factor (
-0005e260: 666c 6f61 7429 3a20 5468 6520 736c 6963  float): The slic
-0005e270: 6520 746f 2062 6520 7669 7375 616c 697a  e to be visualiz
-0005e280: 6564 2069 7320 6465 7465 726d 696e 6564  ed is determined
-0005e290: 2062 7920 6d75 6c74 6970 6c79 696e 6720   by multiplying 
-0005e2a0: 7468 6520 696d 6167 6520 7369 7a65 2062  the image size b
-0005e2b0: 7920 7468 6973 2066 6163 746f 722e 2044  y this factor. D
-0005e2c0: 6566 6175 6c74 2069 7320 302e 3535 2e0a  efault is 0.55..
-0005e2d0: 2020 2020 0a20 2020 2073 686f 775f 6974      .    show_it
-0005e2e0: 2028 7374 7229 3a20 4f75 7470 7574 2070   (str): Output p
-0005e2f0: 6174 682e 2049 6620 6e6f 7420 4e6f 6e65  ath. If not None
-0005e300: 2c20 7468 6520 7669 7375 616c 697a 6174  , the visualizat
-0005e310: 696f 6e73 2077 696c 6c20 6265 2073 6176  ions will be sav
-0005e320: 6564 2061 7420 7468 6973 206c 6f63 6174  ed at this locat
-0005e330: 696f 6e2e 2044 6566 6175 6c74 2069 7320  ion. Default is 
-0005e340: 4e6f 6e65 2e0a 2020 2020 0a20 2020 2076  None..    .    v
-0005e350: 6572 626f 7365 2028 626f 6f6c 293a 2049  erbose (bool): I
-0005e360: 6620 5472 7565 2c20 696e 666f 726d 6174  f True, informat
-0005e370: 696f 6e20 7769 6c6c 2062 6520 7072 696e  ion will be prin
-0005e380: 7465 6420 7768 696c 6520 7275 6e6e 696e  ted while runnin
-0005e390: 6720 7468 6520 6675 6e63 7469 6f6e 2e20  g the function. 
-0005e3a0: 4465 6661 756c 7420 6973 2054 7275 652e  Default is True.
-0005e3b0: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
-0005e3c0: 2020 2076 697a 6c69 7374 2028 6c69 7374     vizlist (list
-0005e3d0: 293a 204c 6973 7420 6f66 2069 6d61 6765  ): List of image
-0005e3e0: 2076 6973 7561 6c69 7a61 7469 6f6e 732e   visualizations.
-0005e3f0: 0a0a 2020 2020 2222 220a 2020 2020 6969  ..    """.    ii
-0005e400: 643d 272a 270a 2020 2020 696d 706f 7274  d='*'.    import
-0005e410: 2067 6c6f 6220 6173 2067 6c6f 620a 2020   glob as glob.  
-0005e420: 2020 6672 6f6d 206f 732e 7061 7468 2069    from os.path i
-0005e430: 6d70 6f72 7420 6578 6973 7473 0a20 2020  mport exists.   
-0005e440: 2069 6d70 6f72 7420 616e 7473 0a20 2020   import ants.   
-0005e450: 2065 785f 7061 7468 203d 206f 732e 7061   ex_path = os.pa
-0005e460: 7468 2e65 7870 616e 6475 7365 7228 2022  th.expanduser( "
-0005e470: 7e2f 2e61 6e74 7370 7974 3177 2f22 2029  ~/.antspyt1w/" )
-0005e480: 0a20 2020 2065 785f 7061 7468 6d6d 203d  .    ex_pathmm =
-0005e490: 206f 732e 7061 7468 2e65 7870 616e 6475   os.path.expandu
-0005e4a0: 7365 7228 2022 7e2f 2e61 6e74 7370 796d  ser( "~/.antspym
-0005e4b0: 6d2f 2220 290a 2020 2020 7465 6d70 6c61  m/" ).    templa
-0005e4c0: 7465 666e 203d 2065 785f 7061 7468 202b  tefn = ex_path +
-0005e4d0: 2027 4349 5431 3638 5f54 3177 5f37 3030   'CIT168_T1w_700
-0005e4e0: 756d 5f70 6164 5f61 646e 692e 6e69 692e  um_pad_adni.nii.
-0005e4f0: 677a 270a 2020 2020 6966 206e 6f74 2065  gz'.    if not e
-0005e500: 7869 7374 7328 2074 656d 706c 6174 6566  xists( templatef
-0005e510: 6e20 293a 0a20 2020 2020 2020 2070 7269  n ):.        pri
-0005e520: 6e74 2820 222a 2a6d 6973 7369 6e67 2066  nt( "**missing f
-0005e530: 696c 6573 2a2a 203d 3e20 6361 6c6c 2067  iles** => call g
-0005e540: 6574 5f64 6174 6120 6672 6f6d 206c 6174  et_data from lat
-0005e550: 6573 7420 616e 7473 7079 7431 7720 616e  est antspyt1w an
-0005e560: 6420 616e 7473 7079 6d6d 2e22 2029 0a20  d antspymm." ). 
-0005e570: 2020 2020 2020 2061 6e74 7370 7974 3177         antspyt1w
-0005e580: 2e67 6574 5f64 6174 6128 2066 6f72 6365  .get_data( force
-0005e590: 5f64 6f77 6e6c 6f61 643d 5472 7565 2029  _download=True )
-0005e5a0: 0a20 2020 2020 2020 2067 6574 5f64 6174  .        get_dat
-0005e5b0: 6128 2066 6f72 6365 5f64 6f77 6e6c 6f61  a( force_downloa
-0005e5c0: 643d 5472 7565 2029 0a20 2020 2074 656d  d=True ).    tem
-0005e5d0: 7020 3d20 736f 7572 6365 6469 722e 7370  p = sourcedir.sp
-0005e5e0: 6c69 7428 2022 2f22 2029 0a20 2020 2073  lit( "/" ).    s
-0005e5f0: 706c 6974 436f 756e 7420 3d20 6c65 6e28  plitCount = len(
-0005e600: 2074 656d 7020 290a 2020 2020 7465 6d70   temp ).    temp
-0005e610: 6c61 7465 203d 206d 6d5f 7265 6164 2820  late = mm_read( 
-0005e620: 7465 6d70 6c61 7465 666e 2029 2023 2052  templatefn ) # R
-0005e630: 6561 6420 696e 2074 656d 706c 6174 650a  ead in template.
-0005e640: 2020 2020 7375 626a 6563 7472 6f6f 7470      subjectrootp
-0005e650: 6174 6820 3d20 6f73 2e70 6174 682e 6a6f  ath = os.path.jo
-0005e660: 696e 2873 6f75 7263 6564 6972 2c20 7072  in(sourcedir, pr
-0005e670: 6f6a 6563 7469 642c 2073 6964 2c20 6474  ojectid, sid, dt
-0005e680: 6964 290a 2020 2020 6d79 696d 6773 496e  id).    myimgsIn
-0005e690: 7075 7420 3d20 676c 6f62 2e67 6c6f 6228  put = glob.glob(
-0005e6a0: 2073 7562 6a65 6374 726f 6f74 7061 7468   subjectrootpath
-0005e6b0: 2b22 2f2a 2220 290a 2020 2020 6d79 696d  +"/*" ).    myim
-0005e6c0: 6773 496e 7075 742e 736f 7274 2820 290a  gsInput.sort( ).
-0005e6d0: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
-0005e6e0: 2020 2020 2020 2020 7072 696e 7428 206d          print( m
-0005e6f0: 7969 6d67 7349 6e70 7574 2029 0a20 2020  yimgsInput ).   
-0005e700: 2074 315f 7365 6172 6368 5f70 6174 6820   t1_search_path 
-0005e710: 3d20 6f73 2e70 6174 682e 6a6f 696e 2873  = os.path.join(s
-0005e720: 7562 6a65 6374 726f 6f74 7061 7468 2c20  ubjectrootpath, 
-0005e730: 2254 3177 222c 2022 2a22 2c20 222a 6e69  "T1w", "*", "*ni
-0005e740: 692e 677a 2229 0a20 2020 2069 6620 7665  i.gz").    if ve
-0005e750: 7262 6f73 653a 0a20 2020 2020 2020 2070  rbose:.        p
-0005e760: 7269 6e74 2866 2274 3120 7365 6172 6368  rint(f"t1 search
-0005e770: 2070 6174 683a 207b 7431 5f73 6561 7263   path: {t1_searc
-0005e780: 685f 7061 7468 7d22 290a 2020 2020 7431  h_path}").    t1
-0005e790: 666e 203d 2067 6c6f 622e 676c 6f62 2874  fn = glob.glob(t
-0005e7a0: 315f 7365 6172 6368 5f70 6174 6829 0a20  1_search_path). 
-0005e7b0: 2020 2074 3166 6e2e 736f 7274 2829 0a20     t1fn.sort(). 
-0005e7c0: 2020 2069 6620 6c65 6e28 2074 3166 6e20     if len( t1fn 
-0005e7d0: 2920 3c20 313a 0a20 2020 2020 2020 2072  ) < 1:.        r
-0005e7e0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0005e7f0: 2771 7569 636b 5f76 697a 5f6d 6d5f 6e72  'quick_viz_mm_nr
-0005e800: 6720 6361 6e6e 6f74 2066 696e 6420 7468  g cannot find th
-0005e810: 6520 5431 7720 4020 2720 2b20 7375 626a  e T1w @ ' + subj
-0005e820: 6563 7472 6f6f 7470 6174 6820 290a 2020  ectrootpath ).  
-0005e830: 2020 7431 666e 203d 2074 3166 6e5b 305d    t1fn = t1fn[0]
-0005e840: 0a20 2020 2074 3120 3d20 6d6d 5f72 6561  .    t1 = mm_rea
-0005e850: 6428 2074 3166 6e20 290a 2020 2020 6e69  d( t1fn ).    ni
-0005e860: 6d61 6765 7320 3d20 6c65 6e28 6d79 696d  mages = len(myim
-0005e870: 6773 496e 7075 7429 0a20 2020 2076 697a  gsInput).    viz
-0005e880: 6c69 7374 3d5b 5d0a 2020 2020 6966 2076  list=[].    if v
-0005e890: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-0005e8a0: 7072 696e 7428 2020 2220 7765 2068 6176  print(  " we hav
-0005e8b0: 6520 3a20 2220 2b20 7374 7228 6e69 6d61  e : " + str(nima
-0005e8c0: 6765 7329 202b 2022 206d 6f64 616c 6974  ges) + " modalit
-0005e8d0: 6965 732e 2020 7769 6c6c 2076 6973 7561  ies.  will visua
-0005e8e0: 6c69 7a65 2054 3120 4e4d 2072 7366 4d52  lize T1 NM rsfMR
-0005e8f0: 4920 4454 4942 3020 4454 4944 5749 2046  I DTIB0 DTIDWI F
-0005e900: 4c41 4952 2229 0a20 2020 2023 206e 7267  LAIR").    # nrg
-0005e910: 5f6d 6f64 616c 6974 795f 6c69 7374 203d  _modality_list =
-0005e920: 205b 2254 3177 222c 2022 4e4d 3244 4d54   ["T1w", "NM2DMT
-0005e930: 222c 2022 7273 664d 5249 222c 2272 7366  ", "rsfMRI","rsf
-0005e940: 4d52 495f 4c52 222c 2272 7366 4d52 495f  MRI_LR","rsfMRI_
-0005e950: 524c 222c 2244 5449 222c 2244 5449 5f4c  RL","DTI","DTI_L
-0005e960: 5222 2c20 2254 3246 6c61 6972 2220 5d2c  R", "T2Flair" ],
-0005e970: 0a20 2020 206e 7267 5f6d 6f64 616c 6974  .    nrg_modalit
-0005e980: 795f 6c69 7374 203d 205b 2027 5431 7727  y_list = [ 'T1w'
-0005e990: 2c20 274e 4d32 444d 5427 2c20 2772 7366  , 'NM2DMT', 'rsf
-0005e9a0: 4d52 4927 2c20 2744 5749 3127 2c20 2744  MRI', 'DWI1', 'D
-0005e9b0: 5749 3227 2c20 2754 3246 6c61 6972 2720  WI2', 'T2Flair' 
-0005e9c0: 5d0a 2020 2020 666f 7220 6e72 674e 756d  ].    for nrgNum
-0005e9d0: 2069 6e20 5b30 2c31 2c32 2c33 2c34 2c35   in [0,1,2,3,4,5
-0005e9e0: 5d3a 0a20 2020 2020 2020 206f 7665 726d  ]:.        overm
-0005e9f0: 6f64 5820 3d20 6e72 675f 6d6f 6461 6c69  odX = nrg_modali
-0005ea00: 7479 5f6c 6973 745b 6e72 674e 756d 5d0a  ty_list[nrgNum].
-0005ea10: 2020 2020 2020 2020 6966 206f 7665 726d          if overm
-0005ea20: 6f64 5820 3d3d 2027 5431 7727 3a0a 2020  odX == 'T1w':.  
-0005ea30: 2020 2020 2020 2020 2020 6d6f 645f 7365            mod_se
-0005ea40: 6172 6368 5f70 6174 6820 3d20 6f73 2e70  arch_path = os.p
-0005ea50: 6174 682e 6a6f 696e 2873 7562 6a65 6374  ath.join(subject
-0005ea60: 726f 6f74 7061 7468 2c20 6f76 6572 6d6f  rootpath, overmo
-0005ea70: 6458 2c20 6969 642c 2022 2a6e 6969 2e67  dX, iid, "*nii.g
-0005ea80: 7a22 290a 2020 2020 2020 2020 2020 2020  z").            
-0005ea90: 6d79 696d 6773 7220 3d20 676c 6f62 2e67  myimgsr = glob.g
-0005eaa0: 6c6f 6228 6d6f 645f 7365 6172 6368 5f70  lob(mod_search_p
-0005eab0: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-0005eac0: 2069 6620 6c65 6e28 206d 7969 6d67 7372   if len( myimgsr
-0005ead0: 2029 203d 3d20 303a 0a20 2020 2020 2020   ) == 0:.       
-0005eae0: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
-0005eaf0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-0005eb00: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
-0005eb10: 4e6f 2074 3120 696d 6167 6573 3a20 2220  No t1 images: " 
-0005eb20: 2b20 7369 6420 2b20 6474 6964 2029 0a20  + sid + dtid ). 
-0005eb30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0005eb40: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
-0005eb50: 2020 2020 2020 206d 7969 6d67 7372 2e73         myimgsr.s
-0005eb60: 6f72 7428 290a 2020 2020 2020 2020 2020  ort().          
-0005eb70: 2020 6d79 696d 6773 723d 6d79 696d 6773    myimgsr=myimgs
-0005eb80: 725b 305d 0a20 2020 2020 2020 2020 2020  r[0].           
-0005eb90: 2076 696d 673d 616e 7473 2e69 6d61 6765   vimg=ants.image
-0005eba0: 5f72 6561 6428 206d 7969 6d67 7372 2029  _read( myimgsr )
-0005ebb0: 0a20 2020 2020 2020 2065 6c69 6620 6f76  .        elif ov
-0005ebc0: 6572 6d6f 6458 203d 3d20 2744 5749 3127  ermodX == 'DWI1'
-0005ebd0: 3a0a 2020 2020 2020 2020 2020 2020 6d6f  :.            mo
-0005ebe0: 645f 7365 6172 6368 5f70 6174 6820 3d20  d_search_path = 
-0005ebf0: 6f73 2e70 6174 682e 6a6f 696e 2873 7562  os.path.join(sub
-0005ec00: 6a65 6374 726f 6f74 7061 7468 2c20 2744  jectrootpath, 'D
-0005ec10: 5449 2a27 2c20 222a 222c 2022 2a6e 6969  TI*', "*", "*nii
-0005ec20: 2e67 7a22 290a 2020 2020 2020 2020 2020  .gz").          
-0005ec30: 2020 6d79 696d 6773 7220 3d20 676c 6f62    myimgsr = glob
-0005ec40: 2e67 6c6f 6228 6d6f 645f 7365 6172 6368  .glob(mod_search
-0005ec50: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
-0005ec60: 2020 2069 6620 6c65 6e28 206d 7969 6d67     if len( myimg
-0005ec70: 7372 2029 203e 2030 3a0a 2020 2020 2020  sr ) > 0:.      
-0005ec80: 2020 2020 2020 2020 2020 6d79 696d 6773            myimgs
-0005ec90: 722e 736f 7274 2829 0a20 2020 2020 2020  r.sort().       
-0005eca0: 2020 2020 2020 2020 206d 7969 6d67 7372           myimgsr
-0005ecb0: 3d6d 7969 6d67 7372 5b30 5d0a 2020 2020  =myimgsr[0].    
-0005ecc0: 2020 2020 2020 2020 2020 2020 7669 6d67              vimg
-0005ecd0: 3d61 6e74 732e 696d 6167 655f 7265 6164  =ants.image_read
-0005ece0: 2820 6d79 696d 6773 7220 290a 2020 2020  ( myimgsr ).    
-0005ecf0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0005ed00: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0005ed10: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-0005ed20: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0005ed30: 696e 7428 224e 6f20 2220 2b20 6f76 6572  int("No " + over
-0005ed40: 6d6f 6458 290a 2020 2020 2020 2020 2020  modX).          
-0005ed50: 2020 2020 2020 7669 6d67 203d 206e 6f69        vimg = noi
-0005ed60: 7a69 6d67 0a20 2020 2020 2020 2065 6c69  zimg.        eli
-0005ed70: 6620 6f76 6572 6d6f 6458 203d 3d20 2744  f overmodX == 'D
-0005ed80: 5749 3227 3a0a 2020 2020 2020 2020 2020  WI2':.          
-0005ed90: 2020 6d6f 645f 7365 6172 6368 5f70 6174    mod_search_pat
-0005eda0: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
-0005edb0: 2873 7562 6a65 6374 726f 6f74 7061 7468  (subjectrootpath
-0005edc0: 2c20 2744 5449 2a27 2c20 222a 222c 2022  , 'DTI*', "*", "
-0005edd0: 2a6e 6969 2e67 7a22 290a 2020 2020 2020  *nii.gz").      
-0005ede0: 2020 2020 2020 6d79 696d 6773 7220 3d20        myimgsr = 
-0005edf0: 676c 6f62 2e67 6c6f 6228 6d6f 645f 7365  glob.glob(mod_se
-0005ee00: 6172 6368 5f70 6174 6829 0a20 2020 2020  arch_path).     
-0005ee10: 2020 2020 2020 2069 6620 6c65 6e28 206d         if len( m
-0005ee20: 7969 6d67 7372 2029 203e 2030 3a0a 2020  yimgsr ) > 0:.  
-0005ee30: 2020 2020 2020 2020 2020 2020 2020 6d79                my
-0005ee40: 696d 6773 722e 736f 7274 2829 0a20 2020  imgsr.sort().   
-0005ee50: 2020 2020 2020 2020 2020 2020 206d 7969               myi
-0005ee60: 6d67 7372 3d6d 7969 6d67 7372 5b6c 656e  mgsr=myimgsr[len
-0005ee70: 286d 7969 6d67 7372 292d 315d 0a20 2020  (myimgsr)-1].   
-0005ee80: 2020 2020 2020 2020 2020 2020 2076 696d               vim
-0005ee90: 673d 616e 7473 2e69 6d61 6765 5f72 6561  g=ants.image_rea
-0005eea0: 6428 206d 7969 6d67 7372 2029 0a20 2020  d( myimgsr ).   
-0005eeb0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0005eec0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0005eed0: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-0005eee0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0005eef0: 7269 6e74 2822 4e6f 2022 202b 206f 7665  rint("No " + ove
-0005ef00: 726d 6f64 5829 0a20 2020 2020 2020 2020  rmodX).         
-0005ef10: 2020 2020 2020 2076 696d 6720 3d20 6e6f         vimg = no
-0005ef20: 697a 696d 670a 2020 2020 2020 2020 656c  izimg.        el
-0005ef30: 6966 206f 7665 726d 6f64 5820 3d3d 2027  if overmodX == '
-0005ef40: 4e4d 3244 4d54 273a 0a20 2020 2020 2020  NM2DMT':.       
-0005ef50: 2020 2020 206d 6f64 5f73 6561 7263 685f       mod_search_
-0005ef60: 7061 7468 203d 206f 732e 7061 7468 2e6a  path = os.path.j
-0005ef70: 6f69 6e28 7375 626a 6563 7472 6f6f 7470  oin(subjectrootp
-0005ef80: 6174 682c 206f 7665 726d 6f64 582c 2022  ath, overmodX, "
-0005ef90: 2a22 2c20 222a 6e69 692e 677a 2229 0a20  *", "*nii.gz"). 
-0005efa0: 2020 2020 2020 2020 2020 206d 7969 6d67             myimg
-0005efb0: 7372 203d 2067 6c6f 622e 676c 6f62 286d  sr = glob.glob(m
-0005efc0: 6f64 5f73 6561 7263 685f 7061 7468 290a  od_search_path).
-0005efd0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-0005efe0: 656e 2820 6d79 696d 6773 7220 2920 3e20  en( myimgsr ) > 
-0005eff0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-0005f000: 2020 206d 7969 6d67 7372 2e73 6f72 7428     myimgsr.sort(
-0005f010: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0005f020: 2020 6d79 696d 6773 7230 3d6d 7969 6d67    myimgsr0=myimg
-0005f030: 7372 5b30 5d0a 2020 2020 2020 2020 2020  sr[0].          
-0005f040: 2020 2020 2020 7669 6d67 3d61 6e74 732e        vimg=ants.
-0005f050: 696d 6167 655f 7265 6164 2820 6d79 696d  image_read( myim
-0005f060: 6773 7230 2029 0a20 2020 2020 2020 2020  gsr0 ).         
-0005f070: 2020 2020 2020 2066 6f72 206b 2069 6e20         for k in 
-0005f080: 7261 6e67 6528 312c 6c65 6e28 6d79 696d  range(1,len(myim
-0005f090: 6773 7229 293a 0a20 2020 2020 2020 2020  gsr)):.         
-0005f0a0: 2020 2020 2020 2020 2020 2074 656d 7020             temp 
-0005f0b0: 3d20 616e 7473 2e69 6d61 6765 5f72 6561  = ants.image_rea
-0005f0c0: 6428 206d 7969 6d67 7372 5b6b 5d29 0a20  d( myimgsr[k]). 
-0005f0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f0e0: 2020 2076 696d 673d 7669 6d67 2b61 6e74     vimg=vimg+ant
-0005f0f0: 732e 7265 7361 6d70 6c65 5f69 6d61 6765  s.resample_image
-0005f100: 5f74 6f5f 7461 7267 6574 2874 656d 702c  _to_target(temp,
-0005f110: 7669 6d67 290a 2020 2020 2020 2020 2020  vimg).          
-0005f120: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0005f130: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-0005f140: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0005f150: 2020 2020 2020 2020 7072 696e 7428 224e          print("N
-0005f160: 6f20 2220 2b20 6f76 6572 6d6f 6458 290a  o " + overmodX).
-0005f170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f180: 7669 6d67 203d 206e 6f69 7a69 6d67 0a20  vimg = noizimg. 
-0005f190: 2020 2020 2020 2065 6c69 6620 6f76 6572         elif over
-0005f1a0: 6d6f 6458 203d 3d20 2772 7366 4d52 4927  modX == 'rsfMRI'
-0005f1b0: 3a0a 2020 2020 2020 2020 2020 2020 6d6f  :.            mo
-0005f1c0: 645f 7365 6172 6368 5f70 6174 6820 3d20  d_search_path = 
-0005f1d0: 6f73 2e70 6174 682e 6a6f 696e 2873 7562  os.path.join(sub
-0005f1e0: 6a65 6374 726f 6f74 7061 7468 2c20 2772  jectrootpath, 'r
-0005f1f0: 7366 4d52 492a 272c 2022 2a22 2c20 222a  sfMRI*', "*", "*
-0005f200: 6e69 692e 677a 2229 0a20 2020 2020 2020  nii.gz").       
-0005f210: 2020 2020 206d 7969 6d67 7372 203d 2067       myimgsr = g
-0005f220: 6c6f 622e 676c 6f62 286d 6f64 5f73 6561  lob.glob(mod_sea
-0005f230: 7263 685f 7061 7468 290a 2020 2020 2020  rch_path).      
-0005f240: 2020 2020 2020 6966 206c 656e 2820 6d79        if len( my
-0005f250: 696d 6773 7220 2920 3e20 303a 0a20 2020  imgsr ) > 0:.   
-0005f260: 2020 2020 2020 2020 2020 2020 206d 7969               myi
-0005f270: 6d67 7372 2e73 6f72 7428 290a 2020 2020  mgsr.sort().    
-0005f280: 2020 2020 2020 2020 2020 2020 6d79 696d              myim
-0005f290: 6773 723d 6d79 696d 6773 725b 305d 0a20  gsr=myimgsr[0]. 
-0005f2a0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-0005f2b0: 696d 673d 6d6d 5f72 6561 645f 746f 5f33  img=mm_read_to_3
-0005f2c0: 6428 206d 7969 6d67 7372 2029 0a20 2020  d( myimgsr ).   
-0005f2d0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0005f2e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0005f2f0: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-0005f300: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0005f310: 7269 6e74 2822 4e6f 2022 202b 206f 7665  rint("No " + ove
-0005f320: 726d 6f64 5829 0a20 2020 2020 2020 2020  rmodX).         
-0005f330: 2020 2020 2020 2076 696d 6720 3d20 6e6f         vimg = no
-0005f340: 697a 696d 670a 2020 2020 2020 2020 656c  izimg.        el
-0005f350: 7365 203a 0a20 2020 2020 2020 2020 2020  se :.           
-0005f360: 206d 6f64 5f73 6561 7263 685f 7061 7468   mod_search_path
-0005f370: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-0005f380: 7375 626a 6563 7472 6f6f 7470 6174 682c  subjectrootpath,
-0005f390: 206f 7665 726d 6f64 582c 2022 2a22 2c20   overmodX, "*", 
-0005f3a0: 222a 6e69 692e 677a 2229 0a20 2020 2020  "*nii.gz").     
-0005f3b0: 2020 2020 2020 206d 7969 6d67 7372 203d         myimgsr =
-0005f3c0: 2067 6c6f 622e 676c 6f62 286d 6f64 5f73   glob.glob(mod_s
-0005f3d0: 6561 7263 685f 7061 7468 290a 2020 2020  earch_path).    
-0005f3e0: 2020 2020 2020 2020 6966 206c 656e 2820          if len( 
-0005f3f0: 6d79 696d 6773 7220 2920 3e20 303a 0a20  myimgsr ) > 0:. 
-0005f400: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0005f410: 7969 6d67 7372 2e73 6f72 7428 290a 2020  yimgsr.sort().  
-0005f420: 2020 2020 2020 2020 2020 2020 2020 6d79                my
-0005f430: 696d 6773 723d 6d79 696d 6773 725b 305d  imgsr=myimgsr[0]
-0005f440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005f450: 2076 696d 673d 616e 7473 2e69 6d61 6765   vimg=ants.image
-0005f460: 5f72 6561 6428 206d 7969 6d67 7372 2029  _read( myimgsr )
-0005f470: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0005f480: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0005f490: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
-0005f4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f4b0: 2020 2070 7269 6e74 2822 4e6f 2022 202b     print("No " +
-0005f4c0: 206f 7665 726d 6f64 5829 0a20 2020 2020   overmodX).     
-0005f4d0: 2020 2020 2020 2020 2020 2076 696d 6720             vimg 
-0005f4e0: 3d20 6e6f 697a 696d 670a 2020 2020 2020  = noizimg.      
-0005f4f0: 2020 6966 2054 7275 653a 0a20 2020 2020    if True:.     
-0005f500: 2020 2020 2020 2069 6620 6578 7472 6163         if extrac
-0005f510: 745f 6272 6169 6e20 616e 6420 6f76 6572  t_brain and over
-0005f520: 6d6f 6458 203d 3d20 2754 3177 273a 0a20  modX == 'T1w':. 
-0005f530: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-0005f540: 696d 6720 3d20 7669 6d67 202a 2061 6e74  img = vimg * ant
-0005f550: 7370 7974 3177 2e62 7261 696e 5f65 7874  spyt1w.brain_ext
-0005f560: 7261 6374 696f 6e28 7669 6d67 290a 2020  raction(vimg).  
-0005f570: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
-0005f580: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-0005f590: 2020 2020 2020 7072 696e 7428 6622 6d6f        print(f"mo
-0005f5a0: 6461 6c69 7479 2073 6561 7263 6820 7061  dality search pa
-0005f5b0: 7468 3a20 7b6d 7969 6d67 7372 7d22 202b  th: {myimgsr}" +
-0005f5c0: 2022 206e 756d 3a20 2220 2b20 7374 7228   " num: " + str(
-0005f5d0: 6e72 674e 756d 2929 0a20 2020 2020 2020  nrgNum)).       
-0005f5e0: 2020 2020 2069 6620 6c65 6e28 2076 696d       if len( vim
-0005f5f0: 672e 7368 6170 6520 2920 3d3d 2034 2061  g.shape ) == 4 a
-0005f600: 6e64 2028 206f 7665 726d 6f64 5820 3d3d  nd ( overmodX ==
-0005f610: 2022 4457 4932 2220 2029 3a0a 2020 2020   "DWI2"  ):.    
-0005f620: 2020 2020 2020 2020 2020 2020 7474 6230              ttb0
-0005f630: 2c20 7474 6477 3d67 6574 5f61 7665 7261  , ttdw=get_avera
-0005f640: 6765 5f64 7769 5f62 3028 7669 6d67 290a  ge_dwi_b0(vimg).
-0005f650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f660: 7669 6d67 203d 2074 7464 770a 2020 2020  vimg = ttdw.    
-0005f670: 2020 2020 2020 2020 656c 6966 206c 656e          elif len
-0005f680: 2820 7669 6d67 2e73 6861 7065 2029 203d  ( vimg.shape ) =
-0005f690: 3d20 3420 616e 6420 6f76 6572 6d6f 6458  = 4 and overmodX
-0005f6a0: 203d 3d20 2244 5749 3122 3a0a 2020 2020   == "DWI1":.    
-0005f6b0: 2020 2020 2020 2020 2020 2020 7474 6230              ttb0
-0005f6c0: 2c20 7474 6477 3d67 6574 5f61 7665 7261  , ttdw=get_avera
-0005f6d0: 6765 5f64 7769 5f62 3028 7669 6d67 290a  ge_dwi_b0(vimg).
-0005f6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f6f0: 7669 6d67 203d 2074 7462 300a 2020 2020  vimg = ttb0.    
-0005f700: 2020 2020 2020 2020 656c 6966 206c 656e          elif len
-0005f710: 2820 7669 6d67 2e73 6861 7065 2029 203d  ( vimg.shape ) =
-0005f720: 3d20 3420 3a0a 2020 2020 2020 2020 2020  = 4 :.          
-0005f730: 2020 2020 2020 7669 6d67 3d61 6e74 732e        vimg=ants.
-0005f740: 6765 745f 6176 6572 6167 655f 6f66 5f74  get_average_of_t
-0005f750: 696d 6573 6572 6965 7328 7669 6d67 290a  imeseries(vimg).
-0005f760: 2020 2020 2020 2020 2020 2020 6d73 6b3d              msk=
-0005f770: 616e 7473 2e67 6574 5f6d 6173 6b28 7669  ants.get_mask(vi
-0005f780: 6d67 290a 2020 2020 2020 2020 2020 2020  mg).            
-0005f790: 7669 6d67 3d61 6e74 732e 6372 6f70 5f69  vimg=ants.crop_i
-0005f7a0: 6d61 6765 2876 696d 672c 6d73 6b29 0a20  mage(vimg,msk). 
-0005f7b0: 2020 2020 2020 2020 2020 2069 6620 6f76             if ov
-0005f7c0: 6572 6d6f 6458 203d 3d20 2754 3177 273a  ermodX == 'T1w':
-0005f7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005f7e0: 2072 6566 696d 673d 616e 7473 2e69 6d61   refimg=ants.ima
-0005f7f0: 6765 5f63 6c6f 6e65 2820 7669 6d67 2029  ge_clone( vimg )
-0005f800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005f810: 206e 6f69 7a69 6d67 203d 2061 6e74 732e   noizimg = ants.
-0005f820: 6164 645f 6e6f 6973 655f 746f 5f69 6d61  add_noise_to_ima
-0005f830: 6765 2820 7265 6669 6d67 2a30 2c20 2761  ge( refimg*0, 'a
-0005f840: 6464 6974 6976 6567 6175 7373 6961 6e27  dditivegaussian'
-0005f850: 2c20 5b31 3030 2c31 5d20 290a 2020 2020  , [100,1] ).    
-0005f860: 2020 2020 2020 2020 2020 2020 7669 7a6c              vizl
-0005f870: 6973 742e 6170 7065 6e64 2820 7669 6d67  ist.append( vimg
-0005f880: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
-0005f890: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0005f8a0: 2020 2020 2076 696d 6720 3d20 616e 7473       vimg = ants
-0005f8b0: 2e72 6573 616d 706c 655f 696d 6167 655f  .resample_image_
-0005f8c0: 746f 5f74 6172 6765 7428 2076 696d 672c  to_target( vimg,
-0005f8d0: 2072 6566 696d 6720 290a 2020 2020 2020   refimg ).      
-0005f8e0: 2020 2020 2020 2020 2020 7669 6d67 203d            vimg =
-0005f8f0: 2061 6e74 732e 694d 6174 6828 2076 696d   ants.iMath( vim
-0005f900: 672c 2027 5472 756e 6361 7465 496e 7465  g, 'TruncateInte
-0005f910: 6e73 6974 7927 2c30 2e30 312c 302e 3938  nsity',0.01,0.98
-0005f920: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0005f930: 2020 7669 7a6c 6973 742e 6170 7065 6e64    vizlist.append
-0005f940: 2820 616e 7473 2e69 4d61 7468 2820 7669  ( ants.iMath( vi
-0005f950: 6d67 2c20 274e 6f72 6d61 6c69 7a65 2720  mg, 'Normalize' 
-0005f960: 2920 2a20 3235 3520 290a 0a20 2020 206c  ) * 255 )..    l
-0005f970: 6973 746c 656e 203d 206c 656e 2820 7669  istlen = len( vi
-0005f980: 7a6c 6973 7420 290a 2020 2020 7669 7a6c  zlist ).    vizl
-0005f990: 6973 7420 3d20 6e70 2e61 7361 7272 6179  ist = np.asarray
-0005f9a0: 2820 7669 7a6c 6973 7420 290a 2020 2020  ( vizlist ).    
-0005f9b0: 6966 2073 686f 775f 6974 2069 7320 6e6f  if show_it is no
-0005f9c0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0005f9d0: 6669 6c65 6e61 6d65 6f75 743d 4e6f 6e65  filenameout=None
-0005f9e0: 0a20 2020 2020 2020 2069 6620 7665 7262  .        if verb
-0005f9f0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-0005fa00: 2070 7269 6e74 2820 7368 6f77 5f69 7420   print( show_it 
-0005fa10: 290a 2020 2020 2020 2020 666f 7220 6120  ).        for a 
-0005fa20: 696e 205b 302c 312c 325d 3a0a 2020 2020  in [0,1,2]:.    
-0005fa30: 2020 2020 2020 2020 6e3d 696e 7428 6e70          n=int(np
-0005fa40: 2e72 6f75 6e64 2820 7265 6669 6d67 2e73  .round( refimg.s
-0005fa50: 6861 7065 5b61 5d20 2a20 736c 6963 655f  hape[a] * slice_
-0005fa60: 6661 6374 6f72 2029 290a 2020 2020 2020  factor )).      
-0005fa70: 2020 2020 2020 736c 6963 6573 3d6e 702e        slices=np.
-0005fa80: 7265 7065 6174 2820 696e 7428 6e29 2c20  repeat( int(n), 
-0005fa90: 6c69 7374 6c65 6e20 2029 0a20 2020 2020  listlen  ).     
-0005faa0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0005fab0: 616e 6365 2873 686f 775f 6974 2c73 7472  ance(show_it,str
-0005fac0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0005fad0: 2020 2066 696c 656e 616d 656f 7574 3d73     filenameout=s
-0005fae0: 686f 775f 6974 2b27 5f61 7827 2b73 7472  how_it+'_ax'+str
-0005faf0: 2869 6e74 2861 2929 2b27 5f73 6c27 2b73  (int(a))+'_sl'+s
-0005fb00: 7472 286e 292b 272e 706e 6727 0a20 2020  tr(n)+'.png'.   
-0005fb10: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0005fb20: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-0005fb30: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0005fb40: 6e74 2820 6669 6c65 6e61 6d65 6f75 7420  nt( filenameout 
-0005fb50: 290a 2020 2020 2020 2020 2020 2020 616e  ).            an
-0005fb60: 7473 2e70 6c6f 745f 6772 6964 2876 697a  ts.plot_grid(viz
-0005fb70: 6c69 7374 2e72 6573 6861 7065 2832 2c33  list.reshape(2,3
-0005fb80: 292c 2073 6c69 6365 732e 7265 7368 6170  ), slices.reshap
-0005fb90: 6528 322c 3329 2c20 7469 746c 653d 274d  e(2,3), title='M
-0005fba0: 4d20 5375 626a 6563 7420 2720 2b20 7369  M Subject ' + si
-0005fbb0: 6420 2b20 2720 2720 2b20 6474 6964 2c20  d + ' ' + dtid, 
-0005fbc0: 7266 6163 6563 6f6c 6f72 3d27 7768 6974  rfacecolor='whit
-0005fbd0: 6527 2c20 6178 6573 3d61 2c20 6669 6c65  e', axes=a, file
-0005fbe0: 6e61 6d65 3d66 696c 656e 616d 656f 7574  name=filenameout
-0005fbf0: 2029 0a20 2020 2069 6620 7665 7262 6f73   ).    if verbos
-0005fc00: 653a 0a20 2020 2020 2020 2070 7269 6e74  e:.        print
-0005fc10: 2822 7669 7a20 636f 6d70 6c65 7465 2e22  ("viz complete."
-0005fc20: 290a 2020 2020 7265 7475 726e 2076 697a  ).    return viz
-0005fc30: 6c69 7374 0a0a 0a64 6566 2062 6c69 6e64  list...def blind
-0005fc40: 5f69 6d61 6765 5f61 7373 6573 736d 656e  _image_assessmen
-0005fc50: 7428 0a20 2020 2069 6d61 6765 2c0a 2020  t(.    image,.  
-0005fc60: 2020 7669 7a5f 6669 6c65 6e61 6d65 3d4e    viz_filename=N
-0005fc70: 6f6e 652c 0a20 2020 2074 6974 6c65 3d46  one,.    title=F
-0005fc80: 616c 7365 2c0a 2020 2020 7075 6c6c 5f72  alse,.    pull_r
-0005fc90: 616e 6b3d 4661 6c73 652c 0a20 2020 2072  ank=False,.    r
-0005fca0: 6573 616d 706c 653d 4e6f 6e65 2c0a 2020  esample=None,.  
-0005fcb0: 2020 6e5f 746f 5f73 6b69 7020 3d20 3130    n_to_skip = 10
-0005fcc0: 2c0a 2020 2020 7665 7262 6f73 653d 4661  ,.    verbose=Fa
-0005fcd0: 6c73 650a 293a 0a20 2020 2022 2222 0a20  lse.):.    """. 
-0005fce0: 2020 2071 7569 636b 2062 6c69 6e64 2069     quick blind i
-0005fcf0: 6d61 6765 2061 7373 6573 736d 656e 7420  mage assessment 
-0005fd00: 616e 6420 7472 6970 6c61 6e61 7220 7669  and triplanar vi
-0005fd10: 7375 616c 697a 6174 696f 6e20 6f66 2061  sualization of a
-0005fd20: 6e20 696d 6167 6520 2e2e 2e20 3444 2069  n image ... 4D i
-0005fd30: 6e70 7574 2077 696c 6c20 6265 2076 6973  nput will be vis
-0005fd40: 7561 6c69 7a65 6420 616e 6420 6173 7365  ualized and asse
-0005fd50: 7373 6564 2069 6e20 3344 2e20 2070 726f  ssed in 3D.  pro
-0005fd60: 6475 6365 7320 6120 706e 6720 616e 6420  duces a png and 
-0005fd70: 6373 7620 7768 6572 6520 6373 7620 636f  csv where csv co
-0005fd80: 6e74 6169 6e73 3a0a 0a20 2020 202a 2072  ntains:..    * r
-0005fd90: 6566 6c65 6374 696f 6e20 6572 726f 7220  eflection error 
-0005fda0: 2820 6573 7469 6d61 7465 7320 6173 796d  ( estimates asym
-0005fdb0: 6d65 7472 7920 290a 0a20 2020 202a 2062  metry )..    * b
-0005fdc0: 7269 7371 2028 2062 6c69 6e64 2071 7561  risq ( blind qua
-0005fdd0: 6c69 7479 2061 7373 6573 736d 656e 7420  lity assessment 
-0005fde0: 290a 0a20 2020 202a 2070 6174 6368 2065  )..    * patch e
-0005fdf0: 6967 656e 7661 6c75 6520 7261 7469 6f20  igenvalue ratio 
-0005fe00: 2820 626c 696e 6420 7175 616c 6974 7920  ( blind quality 
-0005fe10: 6173 7365 7373 6d65 6e74 2029 0a0a 2020  assessment )..  
-0005fe20: 2020 2a20 5053 4e52 2061 6e64 2053 5349    * PSNR and SSI
-0005fe30: 4d20 7673 2061 2073 6d6f 6f74 6865 6420  M vs a smoothed 
-0005fe40: 7265 6665 7265 6e63 6520 2834 4420 6f72  reference (4D or
-0005fe50: 2033 4420 6170 7072 6f70 7269 6174 6529   3D appropriate)
-0005fe60: 0a0a 2020 2020 2a20 6d61 736b 2076 6f6c  ..    * mask vol
-0005fe70: 756d 6520 2820 6573 7469 6d61 7465 7320  ume ( estimates 
-0005fe80: 666f 7265 6772 6f75 6e64 206f 626a 6563  foreground objec
-0005fe90: 7420 7369 7a65 2029 0a0a 2020 2020 2a20  t size )..    * 
-0005fea0: 7370 6163 696e 670a 0a20 2020 202a 2064  spacing..    * d
-0005feb0: 696d 656e 7369 6f6e 2061 6674 6572 2063  imension after c
-0005fec0: 726f 7070 696e 6720 6279 206d 6173 6b0a  ropping by mask.
-0005fed0: 0a20 2020 2069 6d61 6765 203a 2063 6861  .    image : cha
-0005fee0: 7261 6374 6572 206f 7220 696d 6167 6520  racter or image 
-0005fef0: 6f62 6a65 6374 2075 7375 616c 6c79 2061  object usually a
-0005ff00: 206e 6966 7469 2069 6d61 6765 0a0a 2020   nifti image..  
-0005ff10: 2020 7669 7a5f 6669 6c65 6e61 6d65 203a    viz_filename :
-0005ff20: 2063 6861 7261 6374 6572 2066 6f72 2061   character for a
-0005ff30: 2070 6e67 206f 7574 7075 7420 696d 6167   png output imag
-0005ff40: 650a 0a20 2020 2074 6974 6c65 203a 2064  e..    title : d
-0005ff50: 6973 706c 6179 2061 2073 756d 6d61 7279  isplay a summary
-0005ff60: 2074 6974 6c65 206f 6e20 7468 6520 706e   title on the pn
-0005ff70: 670a 0a20 2020 2070 756c 6c5f 7261 6e6b  g..    pull_rank
-0005ff80: 203a 2062 6f6f 6c65 616e 0a0a 2020 2020   : boolean..    
-0005ff90: 7265 7361 6d70 6c65 203a 204e 6f6e 652c  resample : None,
-0005ffa0: 206e 756d 6572 6963 206d 6178 206f 7220   numeric max or 
-0005ffb0: 6d69 6e2c 2072 6573 616d 706c 6573 2069  min, resamples i
-0005ffc0: 6d61 6765 2074 6f20 6973 6f74 726f 7079  mage to isotropy
-0005ffd0: 0a0a 2020 2020 6e5f 746f 5f73 6b69 7020  ..    n_to_skip 
-0005ffe0: 3a20 3130 2062 7920 6465 6661 756c 743b  : 10 by default;
-0005fff0: 2073 616d 706c 6573 2074 696d 6520 7365   samples time se
-00060000: 7269 6573 2065 7665 7279 206e 5f74 6f5f  ries every n_to_
-00060010: 736b 6970 2076 6f6c 756d 650a 0a20 2020  skip volume..   
-00060020: 2076 6572 626f 7365 203a 2062 6f6f 6c65   verbose : boole
-00060030: 616e 0a0a 2020 2020 2222 220a 2020 2020  an..    """.    
-00060040: 696d 706f 7274 2067 6c6f 6220 6173 2067  import glob as g
-00060050: 6c6f 620a 2020 2020 6672 6f6d 206f 732e  lob.    from os.
-00060060: 7061 7468 2069 6d70 6f72 7420 6578 6973  path import exis
-00060070: 7473 0a20 2020 2069 6d70 6f72 7420 616e  ts.    import an
-00060080: 7473 0a20 2020 2069 6d70 6f72 7420 6d61  ts.    import ma
-00060090: 7470 6c6f 746c 6962 2e70 7970 6c6f 7420  tplotlib.pyplot 
-000600a0: 6173 2070 6c74 0a20 2020 2066 726f 6d20  as plt.    from 
-000600b0: 5049 4c20 696d 706f 7274 2049 6d61 6765  PIL import Image
-000600c0: 0a20 2020 2066 726f 6d20 7061 7468 6c69  .    from pathli
-000600d0: 6220 696d 706f 7274 2050 6174 680a 2020  b import Path.  
-000600e0: 2020 696d 706f 7274 206a 736f 6e0a 2020    import json.  
-000600f0: 2020 696d 706f 7274 2072 650a 2020 2020    import re.    
-00060100: 6672 6f6d 2064 6970 792e 696f 2e67 7261  from dipy.io.gra
-00060110: 6469 656e 7473 2069 6d70 6f72 7420 7265  dients import re
-00060120: 6164 5f62 7661 6c73 5f62 7665 6373 0a20  ad_bvals_bvecs. 
-00060130: 2020 206d 7973 7465 6d3d 2727 0a20 2020     mystem=''.   
-00060140: 2069 6620 6973 696e 7374 616e 6365 2869   if isinstance(i
-00060150: 6d61 6765 2c6c 6973 7429 3a0a 2020 2020  mage,list):.    
-00060160: 2020 2020 6973 6669 6c65 6e61 6d65 3d69      isfilename=i
-00060170: 7369 6e73 7461 6e63 6528 2069 6d61 6765  sinstance( image
-00060180: 5b30 5d2c 2073 7472 290a 2020 2020 2020  [0], str).      
-00060190: 2020 696d 6167 6520 3d20 696d 6167 655b    image = image[
-000601a0: 305d 0a20 2020 2065 6c73 653a 0a20 2020  0].    else:.   
-000601b0: 2020 2020 2069 7366 696c 656e 616d 653d       isfilename=
-000601c0: 6973 696e 7374 616e 6365 2820 696d 6167  isinstance( imag
-000601d0: 652c 2073 7472 290a 2020 2020 6f75 7464  e, str).    outd
-000601e0: 6620 3d20 7064 2e44 6174 6146 7261 6d65  f = pd.DataFrame
-000601f0: 2829 0a20 2020 206d 796d 6574 6120 3d20  ().    mymeta = 
-00060200: 4e6f 6e65 0a20 2020 204d 6167 6e65 7469  None.    Magneti
-00060210: 6346 6965 6c64 5374 7265 6e67 7468 203d  cFieldStrength =
-00060220: 204e 6f6e 650a 2020 2020 696d 6167 655f   None.    image_
-00060230: 6669 6c65 6e61 6d65 3d27 270a 2020 2020  filename=''.    
-00060240: 6966 2069 7366 696c 656e 616d 653a 0a20  if isfilename:. 
-00060250: 2020 2020 2020 2069 6d61 6765 5f66 696c         image_fil
-00060260: 656e 616d 6520 3d20 696d 6167 650a 2020  ename = image.  
-00060270: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00060280: 6e63 6528 696d 6167 652c 6c69 7374 293a  nce(image,list):
-00060290: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
-000602a0: 6765 5f66 696c 656e 616d 653d 696d 6167  ge_filename=imag
-000602b0: 655b 305d 0a20 2020 2020 2020 206a 736f  e[0].        jso
-000602c0: 6e5f 6e61 6d65 203d 2072 652e 7375 6228  n_name = re.sub(
-000602d0: 222e 6e69 692e 677a 222c 222e 6a73 6f6e  ".nii.gz",".json
-000602e0: 222c 696d 6167 655f 6669 6c65 6e61 6d65  ",image_filename
-000602f0: 290a 2020 2020 2020 2020 6966 2065 7869  ).        if exi
-00060300: 7374 7328 206a 736f 6e5f 6e61 6d65 2029  sts( json_name )
-00060310: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
-00060320: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00060330: 2020 2077 6974 6820 6f70 656e 286a 736f     with open(jso
-00060340: 6e5f 6e61 6d65 2c20 2772 2729 2061 7320  n_name, 'r') as 
-00060350: 6663 635f 6669 6c65 3a0a 2020 2020 2020  fcc_file:.      
-00060360: 2020 2020 2020 2020 2020 2020 2020 6d79                my
-00060370: 6d65 7461 203d 206a 736f 6e2e 6c6f 6164  meta = json.load
-00060380: 2866 6363 5f66 696c 6529 0a20 2020 2020  (fcc_file).     
-00060390: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000603a0: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-000603b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000603c0: 2020 2070 7269 6e74 286a 736f 6e2e 6475     print(json.du
-000603d0: 6d70 7328 6d79 6d65 7461 2c20 696e 6465  mps(mymeta, inde
-000603e0: 6e74 3d34 2929 0a20 2020 2020 2020 2020  nt=4)).         
-000603f0: 2020 2020 2020 2020 2020 2066 6363 5f66             fcc_f
-00060400: 696c 652e 636c 6f73 6528 290a 2020 2020  ile.close().    
-00060410: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
-00060420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060430: 7061 7373 0a20 2020 2020 2020 206d 7973  pass.        mys
-00060440: 7465 6d3d 5061 7468 2820 696d 6167 6520  tem=Path( image 
-00060450: 292e 7374 656d 0a20 2020 2020 2020 206d  ).stem.        m
-00060460: 7973 7465 6d3d 5061 7468 2820 6d79 7374  ystem=Path( myst
-00060470: 656d 2029 2e73 7465 6d0a 2020 2020 2020  em ).stem.      
-00060480: 2020 696d 6167 655f 7265 6665 7265 6e63    image_referenc
-00060490: 6520 3d20 616e 7473 2e69 6d61 6765 5f72  e = ants.image_r
-000604a0: 6561 6428 2069 6d61 6765 2029 0a20 2020  ead( image ).   
-000604b0: 2020 2020 2069 6d61 6765 203d 2061 6e74       image = ant
-000604c0: 732e 696d 6167 655f 7265 6164 2820 696d  s.image_read( im
-000604d0: 6167 6520 290a 2020 2020 656c 7365 3a0a  age ).    else:.
-000604e0: 2020 2020 2020 2020 696d 6167 655f 7265          image_re
-000604f0: 6665 7265 6e63 6520 3d20 616e 7473 2e69  ference = ants.i
-00060500: 6d61 6765 5f63 6c6f 6e65 2820 696d 6167  mage_clone( imag
-00060510: 6520 290a 2020 2020 6e74 696d 6570 6f69  e ).    ntimepoi
-00060520: 6e74 7320 3d20 310a 2020 2020 6276 616c  nts = 1.    bval
-00060530: 7565 4d61 783d 4e6f 6e65 0a20 2020 2062  ueMax=None.    b
-00060540: 7665 636e 6f72 6d3d 4e6f 6e65 0a20 2020  vecnorm=None.   
-00060550: 2069 6620 696d 6167 655f 7265 6665 7265   if image_refere
-00060560: 6e63 652e 6469 6d65 6e73 696f 6e20 3d3d  nce.dimension ==
-00060570: 2034 3a0a 2020 2020 2020 2020 6e74 696d   4:.        ntim
-00060580: 6570 6f69 6e74 7320 3d20 696d 6167 655f  epoints = image_
-00060590: 7265 6665 7265 6e63 652e 7368 6170 655b  reference.shape[
-000605a0: 335d 0a20 2020 2020 2020 2069 6620 2244  3].        if "D
-000605b0: 5449 2220 696e 2069 6d61 6765 5f66 696c  TI" in image_fil
-000605c0: 656e 616d 653a 0a20 2020 2020 2020 2020  ename:.         
-000605d0: 2020 206d 7954 5373 6567 203d 2073 6567     myTSseg = seg
-000605e0: 6d65 6e74 5f74 696d 6573 6572 6965 735f  ment_timeseries_
-000605f0: 6279 5f6d 6561 6e76 616c 7565 2820 696d  by_meanvalue( im
-00060600: 6167 655f 7265 6665 7265 6e63 6520 290a  age_reference ).
-00060610: 2020 2020 2020 2020 2020 2020 696d 6167              imag
-00060620: 655f 6230 2c20 696d 6167 655f 6477 6920  e_b0, image_dwi 
-00060630: 3d20 6765 745f 6176 6572 6167 655f 6477  = get_average_dw
-00060640: 695f 6230 2820 696d 6167 655f 7265 6665  i_b0( image_refe
-00060650: 7265 6e63 652c 2066 6173 743d 5472 7565  rence, fast=True
-00060660: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
-00060670: 6d61 6765 5f62 3020 3d20 616e 7473 2e69  mage_b0 = ants.i
-00060680: 4d61 7468 2820 696d 6167 655f 6230 2c20  Math( image_b0, 
-00060690: 274e 6f72 6d61 6c69 7a65 2720 290a 2020  'Normalize' ).  
-000606a0: 2020 2020 2020 2020 2020 696d 6167 655f            image_
-000606b0: 6477 6920 3d20 616e 7473 2e69 4d61 7468  dwi = ants.iMath
-000606c0: 2820 696d 6167 655f 6477 692c 2027 4e6f  ( image_dwi, 'No
-000606d0: 726d 616c 697a 6527 2029 0a20 2020 2020  rmalize' ).     
-000606e0: 2020 2020 2020 2062 7661 6c5f 6e61 6d65         bval_name
-000606f0: 203d 2072 652e 7375 6228 222e 6e69 692e   = re.sub(".nii.
-00060700: 677a 222c 222e 6276 616c 222c 696d 6167  gz",".bval",imag
-00060710: 655f 6669 6c65 6e61 6d65 290a 2020 2020  e_filename).    
-00060720: 2020 2020 2020 2020 6276 6563 5f6e 616d          bvec_nam
-00060730: 6520 3d20 7265 2e73 7562 2822 2e6e 6969  e = re.sub(".nii
-00060740: 2e67 7a22 2c22 2e62 7665 6322 2c69 6d61  .gz",".bvec",ima
-00060750: 6765 5f66 696c 656e 616d 6529 0a20 2020  ge_filename).   
-00060760: 2020 2020 2020 2020 2069 6620 6578 6973           if exis
-00060770: 7473 2820 6276 616c 5f6e 616d 6520 2920  ts( bval_name ) 
-00060780: 616e 6420 6578 6973 7473 2820 6276 6563  and exists( bvec
-00060790: 5f6e 616d 6520 293a 0a20 2020 2020 2020  _name ):.       
-000607a0: 2020 2020 2020 2020 2062 7661 6c73 2c20           bvals, 
-000607b0: 6276 6563 7320 3d20 7265 6164 5f62 7661  bvecs = read_bva
-000607c0: 6c73 5f62 7665 6373 2820 6276 616c 5f6e  ls_bvecs( bval_n
-000607d0: 616d 6520 2c20 6276 6563 5f6e 616d 6520  ame , bvec_name 
-000607e0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-000607f0: 2020 2062 7661 6c75 654d 6178 203d 2062     bvalueMax = b
-00060800: 7661 6c73 2e6d 6178 2829 0a20 2020 2020  vals.max().     
-00060810: 2020 2020 2020 2020 2020 2062 7665 636e             bvecn
-00060820: 6f72 6d20 3d20 6e70 2e6c 696e 616c 672e  orm = np.linalg.
-00060830: 6e6f 726d 2862 7665 6373 2c61 7869 733d  norm(bvecs,axis=
-00060840: 3129 2e72 6573 6861 7065 2820 6276 6563  1).reshape( bvec
-00060850: 732e 7368 6170 655b 305d 2c31 2029 0a20  s.shape[0],1 ). 
-00060860: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00060870: 7665 636e 6f72 6d20 3d20 6276 6563 6e6f  vecnorm = bvecno
-00060880: 726d 2e6d 6178 2829 0a20 2020 2020 2020  rm.max().       
-00060890: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000608a0: 2020 2069 6d61 6765 5f62 3020 3d20 616e     image_b0 = an
-000608b0: 7473 2e67 6574 5f61 7665 7261 6765 5f6f  ts.get_average_o
-000608c0: 665f 7469 6d65 7365 7269 6573 2820 696d  f_timeseries( im
-000608d0: 6167 655f 7265 6665 7265 6e63 6520 292e  age_reference ).
-000608e0: 694d 6174 6828 224e 6f72 6d61 6c69 7a65  iMath("Normalize
-000608f0: 2229 0a20 2020 2065 6c73 653a 0a20 2020  ").    else:.   
-00060900: 2020 2020 2069 6d61 6765 5f63 6f6d 7061       image_compa
-00060910: 7265 203d 2061 6e74 732e 736d 6f6f 7468  re = ants.smooth
-00060920: 5f69 6d61 6765 2820 696d 6167 655f 7265  _image( image_re
-00060930: 6665 7265 6e63 652c 2033 2c20 7369 676d  ference, 3, sigm
-00060940: 615f 696e 5f70 6879 7369 6361 6c5f 636f  a_in_physical_co
-00060950: 6f72 6469 6e61 7465 733d 4661 6c73 6520  ordinates=False 
-00060960: 290a 2020 2020 666f 7220 6a6a 6a20 696e  ).    for jjj in
-00060970: 2072 616e 6765 2830 2c6e 7469 6d65 706f   range(0,ntimepo
-00060980: 696e 7473 2c6e 5f74 6f5f 736b 6970 293a  ints,n_to_skip):
-00060990: 0a20 2020 2020 2020 206d 6f64 616c 6974  .        modalit
-000609a0: 793d 2775 6e6b 6e6f 776e 270a 2020 2020  y='unknown'.    
-000609b0: 2020 2020 6966 2022 7273 664d 5249 2220      if "rsfMRI" 
-000609c0: 696e 2069 6d61 6765 5f66 696c 656e 616d  in image_filenam
-000609d0: 653a 0a20 2020 2020 2020 2020 2020 206d  e:.            m
-000609e0: 6f64 616c 6974 793d 2772 7366 4d52 4927  odality='rsfMRI'
-000609f0: 0a20 2020 2020 2020 2065 6c69 6620 2254  .        elif "T
-00060a00: 3177 2220 696e 2069 6d61 6765 5f66 696c  1w" in image_fil
-00060a10: 656e 616d 653a 0a20 2020 2020 2020 2020  ename:.         
-00060a20: 2020 206d 6f64 616c 6974 793d 2754 3177     modality='T1w
-00060a30: 270a 2020 2020 2020 2020 656c 6966 2022  '.        elif "
-00060a40: 5432 466c 6169 7222 2069 6e20 696d 6167  T2Flair" in imag
-00060a50: 655f 6669 6c65 6e61 6d65 3a0a 2020 2020  e_filename:.    
-00060a60: 2020 2020 2020 2020 6d6f 6461 6c69 7479          modality
-00060a70: 3d27 5432 466c 6169 7227 0a20 2020 2020  ='T2Flair'.     
-00060a80: 2020 2065 6c69 6620 224e 4d32 444d 5422     elif "NM2DMT"
-00060a90: 2069 6e20 696d 6167 655f 6669 6c65 6e61   in image_filena
-00060aa0: 6d65 3a0a 2020 2020 2020 2020 2020 2020  me:.            
-00060ab0: 6d6f 6461 6c69 7479 3d27 4e4d 3244 4d54  modality='NM2DMT
-00060ac0: 270a 2020 2020 2020 2020 6966 2069 6d61  '.        if ima
-00060ad0: 6765 5f72 6566 6572 656e 6365 2e64 696d  ge_reference.dim
-00060ae0: 656e 7369 6f6e 203d 3d20 343a 0a20 2020  ension == 4:.   
-00060af0: 2020 2020 2020 2020 2069 6d61 6765 203d           image =
-00060b00: 2061 6e74 732e 736c 6963 655f 696d 6167   ants.slice_imag
-00060b10: 6528 2069 6d61 6765 5f72 6566 6572 656e  e( image_referen
-00060b20: 6365 2c20 6964 783d 696e 7428 6a6a 6a29  ce, idx=int(jjj)
-00060b30: 2c20 6178 6973 3d33 2029 0a20 2020 2020  , axis=3 ).     
-00060b40: 2020 2020 2020 2069 6620 2244 5449 2220         if "DTI" 
-00060b50: 696e 2069 6d61 6765 5f66 696c 656e 616d  in image_filenam
-00060b60: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00060b70: 2020 2069 6620 6a6a 6a20 696e 206d 7954     if jjj in myT
-00060b80: 5373 6567 5b27 6869 6768 6572 6d65 616e  Sseg['highermean
-00060b90: 7327 5d3a 0a20 2020 2020 2020 2020 2020  s']:.           
-00060ba0: 2020 2020 2020 2020 2069 6d61 6765 5f63           image_c
-00060bb0: 6f6d 7061 7265 203d 2061 6e74 732e 696d  ompare = ants.im
-00060bc0: 6167 655f 636c 6f6e 6528 2069 6d61 6765  age_clone( image
-00060bd0: 5f62 3020 290a 2020 2020 2020 2020 2020  _b0 ).          
-00060be0: 2020 2020 2020 2020 2020 6d6f 6461 6c69            modali
-00060bf0: 7479 3d27 4454 4962 3027 0a20 2020 2020  ty='DTIb0'.     
-00060c00: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00060c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00060c20: 2020 2020 2069 6d61 6765 5f63 6f6d 7061       image_compa
-00060c30: 7265 203d 2061 6e74 732e 696d 6167 655f  re = ants.image_
-00060c40: 636c 6f6e 6528 2069 6d61 6765 5f64 7769  clone( image_dwi
-00060c50: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00060c60: 2020 2020 2020 206d 6f64 616c 6974 793d         modality=
-00060c70: 2744 5449 6477 6927 0a20 2020 2020 2020  'DTIdwi'.       
-00060c80: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00060c90: 2020 2020 2020 2020 2020 2069 6d61 6765             image
-00060ca0: 5f63 6f6d 7061 7265 203d 2061 6e74 732e  _compare = ants.
-00060cb0: 696d 6167 655f 636c 6f6e 6528 2069 6d61  image_clone( ima
-00060cc0: 6765 5f62 3020 290a 2020 2020 2020 2020  ge_b0 ).        
-00060cd0: 2320 696d 6167 6520 3d20 616e 7473 2e69  # image = ants.i
-00060ce0: 4d61 7468 2820 696d 6167 652c 2027 5472  Math( image, 'Tr
-00060cf0: 756e 6361 7465 496e 7465 6e73 6974 7927  uncateIntensity'
-00060d00: 2c30 2e30 312c 302e 3939 3529 0a20 2020  ,0.01,0.995).   
-00060d10: 2020 2020 206d 696e 7370 6320 3d20 6e70       minspc = np
-00060d20: 2e6d 696e 2861 6e74 732e 6765 745f 7370  .min(ants.get_sp
-00060d30: 6163 696e 6728 696d 6167 6529 290a 2020  acing(image)).  
-00060d40: 2020 2020 2020 6d61 7873 7063 203d 206e        maxspc = n
-00060d50: 702e 6d61 7828 616e 7473 2e67 6574 5f73  p.max(ants.get_s
-00060d60: 7061 6369 6e67 2869 6d61 6765 2929 0a20  pacing(image)). 
-00060d70: 2020 2020 2020 2069 6620 7265 7361 6d70         if resamp
-00060d80: 6c65 2069 7320 6e6f 7420 4e6f 6e65 3a0a  le is not None:.
-00060d90: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-00060da0: 6573 616d 706c 6520 3d3d 2027 6d69 6e27  esample == 'min'
-00060db0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00060dc0: 2020 6966 206d 696e 7370 6320 3c20 3165    if minspc < 1e
-00060dd0: 2d31 323a 0a20 2020 2020 2020 2020 2020  -12:.           
-00060de0: 2020 2020 2020 2020 206d 696e 7370 6320           minspc 
-00060df0: 3d20 6e70 2e6d 6178 2861 6e74 732e 6765  = np.max(ants.ge
-00060e00: 745f 7370 6163 696e 6728 696d 6167 6529  t_spacing(image)
-00060e10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00060e20: 2020 6e65 7773 7063 203d 206e 702e 7265    newspc = np.re
-00060e30: 7065 6174 2820 6d69 6e73 7063 2c20 3320  peat( minspc, 3 
-00060e40: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00060e50: 6966 2072 6573 616d 706c 6520 3d3d 2027  if resample == '
-00060e60: 6d61 7827 3a0a 2020 2020 2020 2020 2020  max':.          
-00060e70: 2020 2020 2020 6e65 7773 7063 203d 206e        newspc = n
-00060e80: 702e 7265 7065 6174 2820 6d61 7873 7063  p.repeat( maxspc
-00060e90: 2c20 3320 290a 2020 2020 2020 2020 2020  , 3 ).          
-00060ea0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00060eb0: 2020 2020 2020 2020 6e65 7773 7063 203d          newspc =
-00060ec0: 206e 702e 7265 7065 6174 2820 7265 7361   np.repeat( resa
-00060ed0: 6d70 6c65 2c20 3320 290a 2020 2020 2020  mple, 3 ).      
-00060ee0: 2020 2020 2020 696d 6167 6520 3d20 616e        image = an
-00060ef0: 7473 2e72 6573 616d 706c 655f 696d 6167  ts.resample_imag
-00060f00: 6528 2069 6d61 6765 2c20 6e65 7773 7063  e( image, newspc
-00060f10: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
-00060f20: 6d61 6765 5f63 6f6d 7061 7265 203d 2061  mage_compare = a
-00060f30: 6e74 732e 7265 7361 6d70 6c65 5f69 6d61  nts.resample_ima
-00060f40: 6765 2820 696d 6167 655f 636f 6d70 6172  ge( image_compar
-00060f50: 652c 206e 6577 7370 6320 290a 2020 2020  e, newspc ).    
-00060f60: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00060f70: 2020 2020 2020 2320 6368 6563 6b20 666f        # check fo
-00060f80: 7220 7370 6320 636c 6f73 6520 746f 207a  r spc close to z
-00060f90: 6572 6f0a 2020 2020 2020 2020 2020 2020  ero.            
-00060fa0: 7370 6320 3d20 6c69 7374 2861 6e74 732e  spc = list(ants.
-00060fb0: 6765 745f 7370 6163 696e 6728 696d 6167  get_spacing(imag
-00060fc0: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
-00060fd0: 666f 7220 7370 636b 2069 6e20 7261 6e67  for spck in rang
-00060fe0: 6528 6c65 6e28 7370 6329 293a 0a20 2020  e(len(spc)):.   
-00060ff0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00061000: 7370 635b 7370 636b 5d20 3c20 3165 2d31  spc[spck] < 1e-1
-00061010: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
-00061020: 2020 2020 2020 2073 7063 5b73 7063 6b5d         spc[spck]
-00061030: 3d31 0a20 2020 2020 2020 2020 2020 2061  =1.            a
-00061040: 6e74 732e 7365 745f 7370 6163 696e 6728  nts.set_spacing(
-00061050: 2069 6d61 6765 2c20 7370 6320 290a 2020   image, spc ).  
-00061060: 2020 2020 2020 2020 2020 616e 7473 2e73            ants.s
-00061070: 6574 5f73 7061 6369 6e67 2820 696d 6167  et_spacing( imag
-00061080: 655f 636f 6d70 6172 652c 2073 7063 2029  e_compare, spc )
-00061090: 0a20 2020 2020 2020 2023 2069 6620 224e  .        # if "N
-000610a0: 4d32 444d 5422 2069 6e20 696d 6167 655f  M2DMT" in image_
-000610b0: 6669 6c65 6e61 6d65 206f 7220 2246 4958  filename or "FIX
-000610c0: 4d45 2220 696e 2069 6d61 6765 5f66 696c  ME" in image_fil
-000610d0: 656e 616d 6520 6f72 2022 5350 4543 5422  ename or "SPECT"
-000610e0: 2069 6e20 696d 6167 655f 6669 6c65 6e61   in image_filena
-000610f0: 6d65 206f 7220 2255 4e4b 4e4f 574e 2220  me or "UNKNOWN" 
-00061100: 696e 2069 6d61 6765 5f66 696c 656e 616d  in image_filenam
-00061110: 653a 0a20 2020 2020 2020 206d 696e 7370  e:.        minsp
-00061120: 6320 3d20 6e70 2e6d 696e 2861 6e74 732e  c = np.min(ants.
-00061130: 6765 745f 7370 6163 696e 6728 696d 6167  get_spacing(imag
-00061140: 6529 290a 2020 2020 2020 2020 6d61 7873  e)).        maxs
-00061150: 7063 203d 206e 702e 6d61 7828 616e 7473  pc = np.max(ants
-00061160: 2e67 6574 5f73 7061 6369 6e67 2869 6d61  .get_spacing(ima
-00061170: 6765 2929 0a20 2020 2020 2020 206d 736b  ge)).        msk
-00061180: 203d 2061 6e74 732e 7468 7265 7368 6f6c   = ants.threshol
-00061190: 645f 696d 6167 6528 2061 6e74 732e 694d  d_image( ants.iM
-000611a0: 6174 6828 696d 6167 652c 274e 6f72 6d61  ath(image,'Norma
-000611b0: 6c69 7a65 2729 2c20 302e 3135 2c20 312e  lize'), 0.15, 1.
-000611c0: 3020 290a 2020 2020 2020 2020 2320 656c  0 ).        # el
-000611d0: 7365 3a0a 2020 2020 2020 2020 2320 2020  se:.        #   
-000611e0: 206d 736b 203d 2061 6e74 732e 6765 745f   msk = ants.get_
-000611f0: 6d61 736b 2820 696d 6167 6520 290a 2020  mask( image ).  
-00061200: 2020 2020 2020 6d73 6b20 3d20 616e 7473        msk = ants
-00061210: 2e6d 6f72 7068 6f6c 6f67 7928 6d73 6b2c  .morphology(msk,
-00061220: 2022 636c 6f73 6522 2c20 3320 290a 2020   "close", 3 ).  
-00061230: 2020 2020 2020 6267 6d73 6b20 3d20 6d73        bgmsk = ms
-00061240: 6b2a 302b 312d 6d73 6b0a 2020 2020 2020  k*0+1-msk.      
-00061250: 2020 6d73 6b64 696c 203d 2061 6e74 732e    mskdil = ants.
-00061260: 694d 6174 6828 6d73 6b2c 2022 4d44 222c  iMath(msk, "MD",
-00061270: 2034 2029 0a20 2020 2020 2020 2023 2061   4 ).        # a
-00061280: 6e74 732e 706c 6f74 5f6f 7274 686f 2820  nts.plot_ortho( 
-00061290: 696d 6167 652c 206d 736b 2c20 6372 6f70  image, msk, crop
-000612a0: 3d46 616c 7365 2029 0a20 2020 2020 2020  =False ).       
-000612b0: 206e 766f 7820 3d20 696e 7428 206d 736b   nvox = int( msk
-000612c0: 2e73 756d 2829 2029 0a20 2020 2020 2020  .sum() ).       
-000612d0: 2073 7063 203d 2061 6e74 732e 6765 745f   spc = ants.get_
-000612e0: 7370 6163 696e 6728 2069 6d61 6765 2029  spacing( image )
-000612f0: 0a20 2020 2020 2020 206f 7267 203d 2061  .        org = a
-00061300: 6e74 732e 6765 745f 6f72 6967 696e 2820  nts.get_origin( 
-00061310: 696d 6167 6520 290a 2020 2020 2020 2020  image ).        
-00061320: 6966 2028 206e 766f 7820 3e20 3020 293a  if ( nvox > 0 ):
-00061330: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
-00061340: 6765 203d 2061 6e74 732e 6372 6f70 5f69  ge = ants.crop_i
-00061350: 6d61 6765 2820 696d 6167 652c 206d 736b  mage( image, msk
-00061360: 6469 6c20 292e 694d 6174 6828 224e 6f72  dil ).iMath("Nor
-00061370: 6d61 6c69 7a65 2229 0a20 2020 2020 2020  malize").       
-00061380: 2020 2020 206d 736b 203d 2061 6e74 732e       msk = ants.
-00061390: 6372 6f70 5f69 6d61 6765 2820 6d73 6b2c  crop_image( msk,
-000613a0: 206d 736b 6469 6c20 292e 694d 6174 6828   mskdil ).iMath(
-000613b0: 224e 6f72 6d61 6c69 7a65 2229 0a20 2020  "Normalize").   
-000613c0: 2020 2020 2020 2020 2062 676d 736b 203d           bgmsk =
-000613d0: 2061 6e74 732e 6372 6f70 5f69 6d61 6765   ants.crop_image
-000613e0: 2820 6267 6d73 6b2c 206d 736b 6469 6c20  ( bgmsk, mskdil 
-000613f0: 292e 694d 6174 6828 224e 6f72 6d61 6c69  ).iMath("Normali
-00061400: 7a65 2229 0a20 2020 2020 2020 2020 2020  ze").           
-00061410: 2069 6d61 6765 5f63 6f6d 7061 7265 203d   image_compare =
-00061420: 2061 6e74 732e 6372 6f70 5f69 6d61 6765   ants.crop_image
-00061430: 2820 696d 6167 655f 636f 6d70 6172 652c  ( image_compare,
-00061440: 206d 736b 6469 6c20 292e 694d 6174 6828   mskdil ).iMath(
-00061450: 224e 6f72 6d61 6c69 7a65 2229 2020 2020  "Normalize")    
-00061460: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00061470: 2020 2020 6e70 6174 6368 203d 2069 6e74      npatch = int
-00061480: 2820 6e70 2e72 6f75 6e64 2820 2030 2e31  ( np.round(  0.1
-00061490: 202a 206e 766f 7820 2920 290a 2020 2020   * nvox ) ).    
-000614a0: 2020 2020 2020 2020 6e70 6174 6368 203d          npatch =
-000614b0: 206e 702e 6d69 6e28 2020 5b35 3132 2c6e   np.min(  [512,n
-000614c0: 7061 7463 6820 5d20 290a 2020 2020 2020  patch ] ).      
-000614d0: 2020 2020 2020 7061 7463 685f 7368 6170        patch_shap
-000614e0: 6520 3d20 5b5d 0a20 2020 2020 2020 2020  e = [].         
-000614f0: 2020 2066 6f72 206b 2069 6e20 7261 6e67     for k in rang
-00061500: 6528 2033 2029 3a0a 2020 2020 2020 2020  e( 3 ):.        
-00061510: 2020 2020 2020 2020 7020 3d20 696e 7428          p = int(
-00061520: 2033 322e 3020 2f20 616e 7473 2e67 6574   32.0 / ants.get
-00061530: 5f73 7061 6369 6e67 2820 696d 6167 6520  _spacing( image 
-00061540: 2029 5b6b 5d20 290a 2020 2020 2020 2020   )[k] ).        
-00061550: 2020 2020 2020 2020 6966 2070 203e 2069          if p > i
-00061560: 6e74 2820 6e70 2e72 6f75 6e64 2820 696d  nt( np.round( im
-00061570: 6167 652e 7368 6170 655b 6b5d 202a 2030  age.shape[k] * 0
-00061580: 2e35 2029 2029 3a0a 2020 2020 2020 2020  .5 ) ):.        
-00061590: 2020 2020 2020 2020 2020 2020 7020 3d20              p = 
-000615a0: 696e 7428 206e 702e 726f 756e 6428 2069  int( np.round( i
-000615b0: 6d61 6765 2e73 6861 7065 5b6b 5d20 2a20  mage.shape[k] * 
-000615c0: 302e 3520 2920 290a 2020 2020 2020 2020  0.5 ) ).        
-000615d0: 2020 2020 2020 2020 7061 7463 685f 7368          patch_sh
-000615e0: 6170 652e 6170 7065 6e64 2820 7020 290a  ape.append( p ).
-000615f0: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-00061600: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-00061610: 2020 2020 2020 2020 7072 696e 7428 696d          print(im
-00061620: 6167 6529 0a20 2020 2020 2020 2020 2020  age).           
-00061630: 2020 2020 2070 7269 6e74 2820 7061 7463       print( patc
-00061640: 685f 7368 6170 6520 290a 2020 2020 2020  h_shape ).      
-00061650: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00061660: 206e 7061 7463 6820 290a 2020 2020 2020   npatch ).      
-00061670: 2020 2020 2020 6d79 6576 7220 3d20 6d61        myevr = ma
-00061680: 7468 2e6e 616e 2023 2064 6f6e 7420 7761  th.nan # dont wa
-00061690: 6e74 2074 6f20 6661 696c 2069 6620 736f  nt to fail if so
-000616a0: 6d65 7468 696e 6720 6f64 6420 6861 7070  mething odd happ
-000616b0: 656e 7320 696e 2070 6174 6368 2065 7874  ens in patch ext
-000616c0: 7261 6374 696f 6e0a 2020 2020 2020 2020  raction.        
-000616d0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-000616e0: 2020 2020 2020 2020 206d 7965 7672 203d           myevr =
-000616f0: 2061 6e74 7370 7974 3177 2e70 6174 6368   antspyt1w.patch
-00061700: 5f65 6967 656e 7661 6c75 655f 7261 7469  _eigenvalue_rati
-00061710: 6f28 2069 6d61 6765 2c20 6e70 6174 6368  o( image, npatch
-00061720: 2c20 7061 7463 685f 7368 6170 652c 0a20  , patch_shape,. 
-00061730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061740: 2020 2065 7664 6570 7468 203d 2030 2e39     evdepth = 0.9
-00061750: 2c20 6d61 736b 3d6d 736b 2029 0a20 2020  , mask=msk ).   
-00061760: 2020 2020 2020 2020 2065 7863 6570 743a           except:
-00061770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00061780: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
-00061790: 2020 6966 2070 756c 6c5f 7261 6e6b 3a0a    if pull_rank:.
-000617a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000617b0: 696d 6167 6520 3d20 616e 7473 2e72 616e  image = ants.ran
-000617c0: 6b5f 696e 7465 6e73 6974 7928 696d 6167  k_intensity(imag
-000617d0: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
-000617e0: 6d61 6765 7265 666c 6563 7420 3d20 616e  magereflect = an
-000617f0: 7473 2e72 6566 6c65 6374 5f69 6d61 6765  ts.reflect_image
-00061800: 2869 6d61 6765 2c20 6178 6973 3d30 290a  (image, axis=0).
-00061810: 2020 2020 2020 2020 2020 2020 6173 796d              asym
-00061820: 5f65 7272 203d 2028 2069 6d61 6765 202d  _err = ( image -
-00061830: 2069 6d61 6765 7265 666c 6563 7420 292e   imagereflect ).
-00061840: 6162 7328 292e 6d65 616e 2829 0a20 2020  abs().mean().   
-00061850: 2020 2020 2020 2020 2023 2065 7374 696d           # estim
-00061860: 6174 6520 6e6f 6973 6520 6279 2063 656e  ate noise by cen
-00061870: 7465 7220 6372 6f70 7069 6e67 2c20 6465  ter cropping, de
-00061880: 6e6f 697a 696e 6720 616e 6420 7461 6b69  noizing and taki
-00061890: 6e67 206d 6167 6e69 7475 6465 206f 6620  ng magnitude of 
-000618a0: 6469 6666 6572 656e 6365 0a20 2020 2020  difference.     
-000618b0: 2020 2020 2020 206e 6f63 726f 703d 4661         nocrop=Fa
-000618c0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-000618d0: 6966 2069 6d61 6765 2e64 696d 656e 7369  if image.dimensi
-000618e0: 6f6e 203d 3d20 333a 0a20 2020 2020 2020  on == 3:.       
-000618f0: 2020 2020 2020 2020 2069 6620 696d 6167           if imag
-00061900: 652e 7368 6170 655b 325d 203d 3d20 313a  e.shape[2] == 1:
-00061910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00061920: 2020 2020 206e 6f63 726f 703d 5472 7565       nocrop=True
-00061930: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00061940: 2020 2020 2069 6620 6d61 7873 7063 2f6d       if maxspc/m
-00061950: 696e 7370 6320 3e20 3130 3a0a 2020 2020  inspc > 10:.    
-00061960: 2020 2020 2020 2020 2020 2020 6e6f 6372              nocr
-00061970: 6f70 3d54 7275 650a 2020 2020 2020 2020  op=True.        
-00061980: 2020 2020 6966 206e 6f63 726f 703a 0a20      if nocrop:. 
-00061990: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000619a0: 7963 6320 3d20 616e 7473 2e69 6d61 6765  ycc = ants.image
-000619b0: 5f63 6c6f 6e65 2820 696d 6167 6520 290a  _clone( image ).
-000619c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000619d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000619e0: 2020 6d79 6363 203d 2061 6e74 7370 7974    mycc = antspyt
-000619f0: 3177 2e73 7065 6369 616c 5f63 726f 7028  1w.special_crop(
-00061a00: 2069 6d61 6765 2c0a 2020 2020 2020 2020   image,.        
-00061a10: 2020 2020 2020 2020 2020 2020 616e 7473              ants
-00061a20: 2e67 6574 5f63 656e 7465 725f 6f66 5f6d  .get_center_of_m
-00061a30: 6173 7328 206d 736b 202a 3020 2b20 3120  ass( msk *0 + 1 
-00061a40: 292c 2070 6174 6368 5f73 6861 7065 2029  ), patch_shape )
-00061a50: 0a20 2020 2020 2020 2020 2020 206d 7963  .            myc
-00061a60: 6364 203d 2061 6e74 732e 6465 6e6f 6973  cd = ants.denois
-00061a70: 655f 696d 6167 6528 206d 7963 632c 2070  e_image( mycc, p
-00061a80: 3d32 2c72 3d32 2c6e 6f69 7365 5f6d 6f64  =2,r=2,noise_mod
-00061a90: 656c 3d27 4761 7573 7369 616e 2720 290a  el='Gaussian' ).
-00061aa0: 2020 2020 2020 2020 2020 2020 6e6f 697a              noiz
-00061ab0: 6c65 7665 6c20 3d20 2820 6d79 6363 202d  level = ( mycc -
-00061ac0: 206d 7963 6364 2029 2e61 6273 2829 2e6d   myccd ).abs().m
-00061ad0: 6561 6e28 290a 2020 2020 2320 2020 2020  ean().    #     
-00061ae0: 2020 2061 6e74 732e 706c 6f74 5f6f 7274     ants.plot_ort
-00061af0: 686f 2820 696d 6167 652c 2063 726f 703d  ho( image, crop=
-00061b00: 4661 6c73 652c 2066 696c 656e 616d 653d  False, filename=
-00061b10: 7669 7a5f 6669 6c65 6e61 6d65 2c20 666c  viz_filename, fl
-00061b20: 6174 3d54 7275 652c 2078 797a 5f6c 696e  at=True, xyz_lin
-00061b30: 6573 3d46 616c 7365 2c20 6f72 6965 6e74  es=False, orient
-00061b40: 5f6c 6162 656c 733d 4661 6c73 652c 2078  _labels=False, x
-00061b50: 797a 5f70 6164 3d30 2029 0a20 2020 2023  yz_pad=0 ).    #
-00061b60: 2020 2020 2020 2020 6672 6f6d 2062 7269          from bri
-00061b70: 7371 7565 2069 6d70 6f72 7420 4252 4953  sque import BRIS
-00061b80: 5155 450a 2020 2020 2320 2020 2020 2020  QUE.    #       
-00061b90: 206f 626a 203d 2042 5249 5351 5545 2875   obj = BRISQUE(u
-00061ba0: 726c 3d46 616c 7365 290a 2020 2020 2320  rl=False).    # 
-00061bb0: 2020 2020 2020 206d 7962 7269 7371 203d         mybrisq =
-00061bc0: 206f 626a 2e73 636f 7265 2820 6e70 2e61   obj.score( np.a
-00061bd0: 7272 6179 2820 496d 6167 652e 6f70 656e  rray( Image.open
-00061be0: 2820 7669 7a5f 6669 6c65 6e61 6d65 2029  ( viz_filename )
-00061bf0: 2920 290a 2020 2020 2020 2020 2020 2020  ) ).            
-00061c00: 6d73 6b5f 766f 6c20 3d20 6d73 6b2e 7375  msk_vol = msk.su
-00061c10: 6d28 2920 2a20 6e70 2e70 726f 6428 2073  m() * np.prod( s
-00061c20: 7063 2029 0a20 2020 2020 2020 2020 2020  pc ).           
-00061c30: 2062 6773 7464 203d 2069 6d61 6765 5b20   bgstd = image[ 
-00061c40: 6267 6d73 6b20 3d3d 2031 205d 2e73 7464  bgmsk == 1 ].std
-00061c50: 2829 0a20 2020 2020 2020 2020 2020 2066  ().            f
-00061c60: 676d 6561 6e20 3d20 696d 6167 655b 206d  gmean = image[ m
-00061c70: 736b 203d 3d20 3120 5d2e 6d65 616e 2829  sk == 1 ].mean()
-00061c80: 0a20 2020 2020 2020 2020 2020 2062 676d  .            bgm
-00061c90: 6561 6e20 3d20 696d 6167 655b 2062 676d  ean = image[ bgm
-00061ca0: 736b 203d 3d20 3120 5d2e 6d65 616e 2829  sk == 1 ].mean()
-00061cb0: 0a20 2020 2020 2020 2020 2020 2073 6e72  .            snr
-00061cc0: 7265 6620 3d20 6667 6d65 616e 202f 2062  ref = fgmean / b
-00061cd0: 6773 7464 0a20 2020 2020 2020 2020 2020  gstd.           
-00061ce0: 2063 6e72 7265 6620 3d20 2820 6667 6d65   cnrref = ( fgme
-00061cf0: 616e 202d 2062 676d 6561 6e20 2920 2f20  an - bgmean ) / 
-00061d00: 6267 7374 640a 2020 2020 2020 2020 2020  bgstd.          
-00061d10: 2020 7073 6e72 7265 6620 3d20 616e 7473    psnrref = ants
-00061d20: 7079 6e65 742e 7073 6e72 2820 2069 6d61  pynet.psnr(  ima
-00061d30: 6765 5f63 6f6d 7061 7265 2c20 696d 6167  ge_compare, imag
-00061d40: 6520 2029 0a20 2020 2020 2020 2020 2020  e  ).           
-00061d50: 2073 7369 6d72 6566 203d 2061 6e74 7370   ssimref = antsp
-00061d60: 796e 6574 2e73 7369 6d28 2020 696d 6167  ynet.ssim(  imag
-00061d70: 655f 636f 6d70 6172 652c 2069 6d61 6765  e_compare, image
-00061d80: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00061d90: 6966 206e 6f63 726f 703a 0a20 2020 2020  if nocrop:.     
-00061da0: 2020 2020 2020 2020 2020 206d 796d 6920             mymi 
-00061db0: 3d20 6d61 7468 2e69 6e66 0a20 2020 2020  = math.inf.     
-00061dc0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00061dd0: 2020 2020 2020 2020 2020 2020 206d 796d               mym
-00061de0: 6920 3d20 616e 7473 2e69 6d61 6765 5f6d  i = ants.image_m
-00061df0: 7574 7561 6c5f 696e 666f 726d 6174 696f  utual_informatio
-00061e00: 6e28 2069 6d61 6765 5f63 6f6d 7061 7265  n( image_compare
-00061e10: 2c20 696d 6167 6520 290a 2020 2020 2020  , image ).      
-00061e20: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00061e30: 2020 2020 6d73 6b5f 766f 6c20 3d20 300a      msk_vol = 0.
-00061e40: 2020 2020 2020 2020 2020 2020 6d79 6576              myev
-00061e50: 7220 3d20 6d79 6d69 203d 2073 7369 6d72  r = mymi = ssimr
-00061e60: 6566 203d 2070 736e 7272 6566 203d 2063  ef = psnrref = c
-00061e70: 6e72 7265 6620 3d20 6173 796d 5f65 7272  nrref = asym_err
-00061e80: 203d 206e 6f69 7a6c 6576 656c 203d 206d   = noizlevel = m
-00061e90: 6174 682e 6e61 6e0a 2020 2020 2020 2020  ath.nan.        
-00061ea0: 2020 2020 0a20 2020 2020 2020 206d 7269      .        mri
-00061eb0: 7365 7269 6573 3d4e 6f6e 650a 2020 2020  series=None.    
-00061ec0: 2020 2020 6d72 696d 6667 3d4e 6f6e 650a      mrimfg=None.
-00061ed0: 2020 2020 2020 2020 6d72 696d 6f64 656c          mrimodel
-00061ee0: 3d4e 6f6e 650a 2020 2020 2020 2020 6d72  =None.        mr
-00061ef0: 6953 4152 3d4e 6f6e 650a 2020 2020 2020  iSAR=None.      
-00061f00: 2020 4261 6e64 7769 6474 6850 6572 5069    BandwidthPerPi
-00061f10: 7865 6c50 6861 7365 456e 636f 6465 3d4e  xelPhaseEncode=N
-00061f20: 6f6e 650a 2020 2020 2020 2020 5069 7865  one.        Pixe
-00061f30: 6c42 616e 6477 6964 7468 3d4e 6f6e 650a  lBandwidth=None.
-00061f40: 2020 2020 2020 2020 6966 206d 796d 6574          if mymet
-00061f50: 6120 6973 206e 6f74 204e 6f6e 653a 0a20  a is not None:. 
-00061f60: 2020 2020 2020 2020 2020 2023 206d 7269             # mri
-00061f70: 7365 7269 6573 3d6d 796d 6574 615b 2727  series=mymeta[''
-00061f80: 5d0a 2020 2020 2020 2020 2020 2020 7472  ].            tr
-00061f90: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00061fa0: 2020 206d 7269 6d66 673d 6d79 6d65 7461     mrimfg=mymeta
-00061fb0: 5b27 4d61 6e75 6661 6374 7572 6572 275d  ['Manufacturer']
-00061fc0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00061fd0: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
-00061fe0: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
-00061ff0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00062000: 2020 2020 2020 2020 2020 206d 7269 6d6f             mrimo
-00062010: 6465 6c3d 6d79 6d65 7461 5b27 4d61 6e75  del=mymeta['Manu
-00062020: 6661 6374 7572 6572 734d 6f64 656c 4e61  facturersModelNa
-00062030: 6d65 275d 0a20 2020 2020 2020 2020 2020  me'].           
-00062040: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
-00062050: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-00062060: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00062070: 2020 2020 2020 2020 2020 2020 2020 204d                 M
-00062080: 6167 6e65 7469 6346 6965 6c64 5374 7265  agneticFieldStre
-00062090: 6e67 7468 3d6d 796d 6574 615b 274d 6167  ngth=mymeta['Mag
-000620a0: 6e65 7469 6346 6965 6c64 5374 7265 6e67  neticFieldStreng
-000620b0: 7468 275d 0a20 2020 2020 2020 2020 2020  th'].           
-000620c0: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
-000620d0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-000620e0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-000620f0: 2020 2020 2020 2020 2020 2020 2020 2050                 P
-00062100: 6978 656c 4261 6e64 7769 6474 683d 6d79  ixelBandwidth=my
-00062110: 6d65 7461 5b27 5069 7865 6c42 616e 6477  meta['PixelBandw
-00062120: 6964 7468 275d 0a20 2020 2020 2020 2020  idth'].         
-00062130: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-00062140: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00062150: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00062160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00062170: 2042 616e 6477 6964 7468 5065 7250 6978   BandwidthPerPix
-00062180: 656c 5068 6173 6545 6e63 6f64 653d 6d79  elPhaseEncode=my
-00062190: 6d65 7461 5b27 4261 6e64 7769 6474 6850  meta['BandwidthP
-000621a0: 6572 5069 7865 6c50 6861 7365 456e 636f  erPixelPhaseEnco
-000621b0: 6465 275d 0a20 2020 2020 2020 2020 2020  de'].           
-000621c0: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
-000621d0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-000621e0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-000621f0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00062200: 7269 5341 523d 6d79 6d65 7461 5b27 5341  riSAR=mymeta['SA
-00062210: 5227 5d0a 2020 2020 2020 2020 2020 2020  R'].            
-00062220: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-00062230: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-00062240: 2020 2020 2074 746c 3d6d 7973 7465 6d20       ttl=mystem 
-00062250: 2b20 2720 270a 2020 2020 2020 2020 7474  + ' '.        tt
-00062260: 6c3d 2727 0a20 2020 2020 2020 2074 746c  l=''.        ttl
-00062270: 3d74 746c 202b 2022 4e5a 3a20 2220 2b20  =ttl + "NZ: " + 
-00062280: 227b 3a30 2e34 667d 222e 666f 726d 6174  "{:0.4f}".format
-00062290: 286e 6f69 7a6c 6576 656c 2920 2b20 2220  (noizlevel) + " 
-000622a0: 534e 523a 2022 202b 2022 7b3a 302e 3466  SNR: " + "{:0.4f
-000622b0: 7d22 2e66 6f72 6d61 7428 736e 7272 6566  }".format(snrref
-000622c0: 2920 2b20 2220 434e 523a 2022 202b 2022  ) + " CNR: " + "
-000622d0: 7b3a 302e 3466 7d22 2e66 6f72 6d61 7428  {:0.4f}".format(
-000622e0: 636e 7272 6566 2920 2b20 2220 5053 3a20  cnrref) + " PS: 
-000622f0: 2220 2b20 227b 3a30 2e34 667d 222e 666f  " + "{:0.4f}".fo
-00062300: 726d 6174 2870 736e 7272 6566 292b 2022  rmat(psnrref)+ "
-00062310: 2053 533a 2022 202b 2022 7b3a 302e 3466   SS: " + "{:0.4f
-00062320: 7d22 2e66 6f72 6d61 7428 7373 696d 7265  }".format(ssimre
-00062330: 6629 202b 2022 2045 5652 3a20 2220 2b20  f) + " EVR: " + 
-00062340: 227b 3a30 2e34 667d 222e 666f 726d 6174  "{:0.4f}".format
-00062350: 286d 7965 7672 292b 2022 204d 493a 2022  (myevr)+ " MI: "
-00062360: 202b 2022 7b3a 302e 3466 7d22 2e66 6f72   + "{:0.4f}".for
-00062370: 6d61 7428 6d79 6d69 290a 2020 2020 2020  mat(mymi).      
-00062380: 2020 6966 2076 697a 5f66 696c 656e 616d    if viz_filenam
-00062390: 6520 6973 206e 6f74 204e 6f6e 6520 616e  e is not None an
-000623a0: 6420 2820 6a6a 6a20 3d3d 2030 206f 7220  d ( jjj == 0 or 
-000623b0: 286a 6a6a 2025 2033 3020 3d3d 2030 2920  (jjj % 30 == 0) 
-000623c0: 2920 616e 6420 696d 6167 652e 7368 6170  ) and image.shap
-000623d0: 655b 325d 203c 2036 3835 3a0a 2020 2020  e[2] < 685:.    
-000623e0: 2020 2020 2020 2020 7669 7a5f 6669 6c65          viz_file
-000623f0: 6e61 6d65 5f75 7365 203d 2072 652e 7375  name_use = re.su
-00062400: 6228 2022 2e70 6e67 222c 2022 5f73 6c69  b( ".png", "_sli
-00062410: 6365 222b 7374 7228 6a6a 6a29 2e7a 6669  ce"+str(jjj).zfi
-00062420: 6c6c 2834 292b 222e 706e 6722 2c20 7669  ll(4)+".png", vi
-00062430: 7a5f 6669 6c65 6e61 6d65 2029 0a20 2020  z_filename ).   
-00062440: 2020 2020 2020 2020 2061 6e74 732e 706c           ants.pl
-00062450: 6f74 5f6f 7274 686f 2820 696d 6167 652c  ot_ortho( image,
-00062460: 2063 726f 703d 4661 6c73 652c 2066 696c   crop=False, fil
-00062470: 656e 616d 653d 7669 7a5f 6669 6c65 6e61  ename=viz_filena
-00062480: 6d65 5f75 7365 2c20 666c 6174 3d54 7275  me_use, flat=Tru
-00062490: 652c 2078 797a 5f6c 696e 6573 3d46 616c  e, xyz_lines=Fal
-000624a0: 7365 2c20 6f72 6965 6e74 5f6c 6162 656c  se, orient_label
-000624b0: 733d 4661 6c73 652c 2078 797a 5f70 6164  s=False, xyz_pad
-000624c0: 3d30 2c20 2074 6974 6c65 3d74 746c 2c20  =0,  title=ttl, 
-000624d0: 7469 746c 6566 6f6e 7473 697a 653d 3132  titlefontsize=12
-000624e0: 2c20 7469 746c 655f 6479 3d2d 302e 3032  , title_dy=-0.02
-000624f0: 2c74 6578 7466 6f6e 7463 6f6c 6f72 3d27  ,textfontcolor='
-00062500: 7265 6427 2029 0a20 2020 2020 2020 2064  red' ).        d
-00062510: 6620 3d20 7064 2e44 6174 6146 7261 6d65  f = pd.DataFrame
-00062520: 285b 5b20 0a20 2020 2020 2020 2020 2020  ([[ .           
-00062530: 206d 7973 7465 6d2c 200a 2020 2020 2020   mystem, .      
-00062540: 2020 2020 2020 696d 6167 655f 7265 6665        image_refe
-00062550: 7265 6e63 652e 6469 6d65 6e73 696f 6e2c  rence.dimension,
-00062560: 200a 2020 2020 2020 2020 2020 2020 6e6f   .            no
-00062570: 697a 6c65 7665 6c2c 2073 6e72 7265 662c  izlevel, snrref,
-00062580: 2063 6e72 7265 662c 2070 736e 7272 6566   cnrref, psnrref
-00062590: 2c20 7373 696d 7265 662c 206d 796d 692c  , ssimref, mymi,
-000625a0: 2061 7379 6d5f 6572 722c 206d 7965 7672   asym_err, myevr
-000625b0: 2c20 6d73 6b5f 766f 6c2c 200a 2020 2020  , msk_vol, .    
-000625c0: 2020 2020 2020 2020 7370 635b 305d 2c20          spc[0], 
-000625d0: 7370 635b 315d 2c20 7370 635b 325d 2c6f  spc[1], spc[2],o
-000625e0: 7267 5b30 5d2c 206f 7267 5b31 5d2c 206f  rg[0], org[1], o
-000625f0: 7267 5b32 5d2c 200a 2020 2020 2020 2020  rg[2], .        
-00062600: 2020 2020 696d 6167 652e 7368 6170 655b      image.shape[
-00062610: 305d 2c20 696d 6167 652e 7368 6170 655b  0], image.shape[
-00062620: 315d 2c20 696d 6167 652e 7368 6170 655b  1], image.shape[
-00062630: 325d 2c20 6e74 696d 6570 6f69 6e74 732c  2], ntimepoints,
-00062640: 200a 2020 2020 2020 2020 2020 2020 6a6a   .            jj
-00062650: 6a2c 206d 6f64 616c 6974 792c 206d 7269  j, modality, mri
-00062660: 7365 7269 6573 2c20 6d72 696d 6667 2c20  series, mrimfg, 
-00062670: 6d72 696d 6f64 656c 2c20 4d61 676e 6574  mrimodel, Magnet
-00062680: 6963 4669 656c 6453 7472 656e 6774 682c  icFieldStrength,
-00062690: 206d 7269 5341 522c 2050 6978 656c 4261   mriSAR, PixelBa
-000626a0: 6e64 7769 6474 682c 2042 616e 6477 6964  ndwidth, Bandwid
-000626b0: 7468 5065 7250 6978 656c 5068 6173 6545  thPerPixelPhaseE
-000626c0: 6e63 6f64 652c 2062 7661 6c75 654d 6178  ncode, bvalueMax
-000626d0: 2c20 6276 6563 6e6f 726d 205d 5d2c 200a  , bvecnorm ]], .
-000626e0: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
-000626f0: 6d6e 733d 5b0a 2020 2020 2020 2020 2020  mns=[.          
-00062700: 2020 2020 2020 2766 696c 656e 616d 6527        'filename'
-00062710: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-00062720: 2020 2027 6469 6d65 6e73 696f 6e61 6c69     'dimensionali
-00062730: 7479 272c 0a20 2020 2020 2020 2020 2020  ty',.           
-00062740: 2020 2020 2027 6e6f 6973 6527 2c20 2773       'noise', 's
-00062750: 6e72 272c 2027 636e 7227 2c20 2770 736e  nr', 'cnr', 'psn
-00062760: 7227 2c20 2773 7369 6d27 2c20 276d 6927  r', 'ssim', 'mi'
-00062770: 2c20 2772 6566 6c65 6374 696f 6e5f 6572  , 'reflection_er
-00062780: 7227 2c20 2745 5652 272c 2027 6d73 6b5f  r', 'EVR', 'msk_
-00062790: 766f 6c27 2c20 2773 7063 3027 2c27 7370  vol', 'spc0','sp
-000627a0: 6331 272c 2773 7063 3227 2c27 6f72 6730  c1','spc2','org0
-000627b0: 272c 276f 7267 3127 2c27 6f72 6732 272c  ','org1','org2',
-000627c0: 2764 696d 7827 2c27 6469 6d79 272c 2764  'dimx','dimy','d
-000627d0: 696d 7a27 2c27 6469 6d74 272c 2773 6c69  imz','dimt','sli
-000627e0: 6365 272c 276d 6f64 616c 6974 7927 2c20  ce','modality', 
-000627f0: 276d 7269 7365 7269 6573 272c 2027 6d72  'mriseries', 'mr
-00062800: 696d 6667 272c 2027 6d72 696d 6f64 656c  imfg', 'mrimodel
-00062810: 272c 2027 6d72 694d 6167 6e65 7469 6346  ', 'mriMagneticF
-00062820: 6965 6c64 5374 7265 6e67 7468 272c 2027  ieldStrength', '
-00062830: 6d72 6953 4152 272c 2027 6d72 6950 6978  mriSAR', 'mriPix
-00062840: 656c 4261 6e64 7769 6474 6827 2c20 276d  elBandwidth', 'm
-00062850: 7269 5069 7865 6c42 616e 6477 6964 7468  riPixelBandwidth
-00062860: 5045 272c 2027 6474 695f 6276 616c 7565  PE', 'dti_bvalue
-00062870: 4d61 7827 2c20 2764 7469 5f62 7665 636e  Max', 'dti_bvecn
-00062880: 6f72 6d27 205d 290a 2020 2020 2020 2020  orm' ]).        
-00062890: 6f75 7464 6620 3d20 7064 2e63 6f6e 6361  outdf = pd.conca
-000628a0: 7428 205b 6f75 7464 662c 2064 6620 5d2c  t( [outdf, df ],
-000628b0: 2061 7869 733d 302c 2069 676e 6f72 655f   axis=0, ignore_
-000628c0: 696e 6465 783d 4661 6c73 6520 290a 2020  index=False ).  
-000628d0: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-000628e0: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-000628f0: 696e 7428 206f 7574 6466 2029 0a20 2020  int( outdf ).   
-00062900: 2069 6620 7669 7a5f 6669 6c65 6e61 6d65   if viz_filename
-00062910: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00062920: 2020 2020 2020 6373 7666 6e20 3d20 7265        csvfn = re
-00062930: 2e73 7562 2820 2270 6e67 222c 2022 6373  .sub( "png", "cs
-00062940: 7622 2c20 7669 7a5f 6669 6c65 6e61 6d65  v", viz_filename
-00062950: 2029 0a20 2020 2020 2020 206f 7574 6466   ).        outdf
-00062960: 2e74 6f5f 6373 7628 2063 7376 666e 2029  .to_csv( csvfn )
-00062970: 0a20 2020 2072 6574 7572 6e20 6f75 7464  .    return outd
-00062980: 660a 0a64 6566 2072 656d 6f76 655f 756e  f..def remove_un
-00062990: 7761 6e74 6564 5f63 6f6c 756d 6e73 2864  wanted_columns(d
-000629a0: 6629 3a0a 2020 2020 2320 4964 656e 7469  f):.    # Identi
-000629b0: 6679 2063 6f6c 756d 6e73 2074 6f20 6472  fy columns to dr
-000629c0: 6f70 3a20 7468 6f73 6520 6e61 6d65 6420  op: those named 
-000629d0: 2758 2720 6f72 2073 7461 7274 696e 6720  'X' or starting 
-000629e0: 7769 7468 2027 556e 6e61 6d65 6427 0a20  with 'Unnamed'. 
-000629f0: 2020 2063 6f6c 735f 746f 5f64 726f 7020     cols_to_drop 
-00062a00: 3d20 5b63 6f6c 2066 6f72 2063 6f6c 2069  = [col for col i
-00062a10: 6e20 6466 2e63 6f6c 756d 6e73 2069 6620  n df.columns if 
-00062a20: 636f 6c20 3d3d 2027 5827 206f 7220 636f  col == 'X' or co
-00062a30: 6c2e 7374 6172 7473 7769 7468 2827 556e  l.startswith('Un
-00062a40: 6e61 6d65 6427 295d 0a20 2020 200a 2020  named')].    .  
-00062a50: 2020 2320 4472 6f70 2074 6865 2069 6465    # Drop the ide
-00062a60: 6e74 6966 6965 6420 636f 6c75 6d6e 7320  ntified columns 
-00062a70: 6672 6f6d 2074 6865 2044 6174 6146 7261  from the DataFra
-00062a80: 6d65 2c20 6966 2061 6e79 0a20 2020 2064  me, if any.    d
-00062a90: 665f 636c 6561 6e65 6420 3d20 6466 2e64  f_cleaned = df.d
-00062aa0: 726f 7028 636f 6c75 6d6e 733d 636f 6c73  rop(columns=cols
-00062ab0: 5f74 6f5f 6472 6f70 2c20 6572 726f 7273  _to_drop, errors
-00062ac0: 3d27 6967 6e6f 7265 2729 0a20 2020 200a  ='ignore').    .
-00062ad0: 2020 2020 7265 7475 726e 2064 665f 636c      return df_cl
-00062ae0: 6561 6e65 640a 0a64 6566 2070 726f 6365  eaned..def proce
-00062af0: 7373 5f64 6174 6166 7261 6d65 5f67 656e  ss_dataframe_gen
-00062b00: 6572 616c 697a 6564 2864 662c 2067 726f  eralized(df, gro
-00062b10: 7570 5f62 795f 636f 6c75 6d6e 293a 0a20  up_by_column):. 
-00062b20: 2020 2023 204d 616b 6520 7375 7265 2074     # Make sure t
-00062b30: 6865 2067 726f 7570 5f62 795f 636f 6c75  he group_by_colu
-00062b40: 6d6e 2069 7320 6578 636c 7564 6564 2066  mn is excluded f
-00062b50: 726f 6d20 626f 7468 206e 756d 6572 6963  rom both numeric
-00062b60: 2061 6e64 206f 7468 6572 2063 6f6c 756d   and other colum
-00062b70: 6e73 2063 616c 6375 6c61 7469 6f6e 730a  ns calculations.
-00062b80: 2020 2020 6e75 6d65 7269 635f 636f 6c73      numeric_cols
-00062b90: 203d 2064 662e 7365 6c65 6374 5f64 7479   = df.select_dty
-00062ba0: 7065 7328 696e 636c 7564 653d 276e 756d  pes(include='num
-00062bb0: 6265 7227 292e 636f 6c75 6d6e 732e 6469  ber').columns.di
-00062bc0: 6666 6572 656e 6365 285b 6772 6f75 705f  fference([group_
-00062bd0: 6279 5f63 6f6c 756d 6e5d 290a 2020 2020  by_column]).    
-00062be0: 6f74 6865 725f 636f 6c73 203d 2064 662e  other_cols = df.
-00062bf0: 636f 6c75 6d6e 732e 6469 6666 6572 656e  columns.differen
-00062c00: 6365 286e 756d 6572 6963 5f63 6f6c 7329  ce(numeric_cols)
-00062c10: 2e64 6966 6665 7265 6e63 6528 5b67 726f  .difference([gro
-00062c20: 7570 5f62 795f 636f 6c75 6d6e 5d29 0a20  up_by_column]). 
-00062c30: 2020 200a 2020 2020 2320 4465 6669 6e65     .    # Define
-00062c40: 2061 6767 7265 6761 7469 6f6e 2066 756e   aggregation fun
-00062c50: 6374 696f 6e73 3a20 6d65 616e 2066 6f72  ctions: mean for
-00062c60: 206e 756d 6572 6963 2063 6f6c 732c 206d   numeric cols, m
-00062c70: 6f64 6520 666f 7220 6f74 6865 7220 636f  ode for other co
-00062c80: 6c73 0a20 2020 2023 2055 7064 6174 6520  ls.    # Update 
-00062c90: 746f 2068 616e 646c 6520 656d 7074 7920  to handle empty 
-00062ca0: 6d6f 6465 2072 6573 756c 7473 2073 6166  mode results saf
-00062cb0: 656c 790a 2020 2020 6167 675f 6469 6374  ely.    agg_dict
-00062cc0: 203d 207b 636f 6c3a 2027 6d65 616e 2720   = {col: 'mean' 
-00062cd0: 666f 7220 636f 6c20 696e 206e 756d 6572  for col in numer
-00062ce0: 6963 5f63 6f6c 737d 0a20 2020 2061 6767  ic_cols}.    agg
-00062cf0: 5f64 6963 742e 7570 6461 7465 287b 0a20  _dict.update({. 
-00062d00: 2020 2020 2020 2063 6f6c 3a20 6c61 6d62         col: lamb
-00062d10: 6461 2078 3a20 7064 2e53 6572 6965 732e  da x: pd.Series.
-00062d20: 6d6f 6465 2878 292e 696c 6f63 5b30 5d20  mode(x).iloc[0] 
-00062d30: 6966 206e 6f74 2070 642e 5365 7269 6573  if not pd.Series
-00062d40: 2e6d 6f64 6528 7829 2e65 6d70 7479 2065  .mode(x).empty e
-00062d50: 6c73 6520 4e6f 6e65 2066 6f72 2063 6f6c  lse None for col
-00062d60: 2069 6e20 6f74 6865 725f 636f 6c73 0a20   in other_cols. 
-00062d70: 2020 207d 2920 2020 200a 2020 2020 2320     })    .    # 
-00062d80: 4772 6f75 7020 6279 2074 6865 2073 7065  Group by the spe
-00062d90: 6369 6669 6564 2063 6f6c 756d 6e2c 2061  cified column, a
-00062da0: 7070 6c79 696e 6720 6469 6666 6572 656e  pplying differen
-00062db0: 7420 6167 6772 6567 6174 696f 6e20 6675  t aggregation fu
-00062dc0: 6e63 7469 6f6e 7320 746f 2064 6966 6665  nctions to diffe
-00062dd0: 7265 6e74 2063 6f6c 756d 6e73 0a20 2020  rent columns.   
-00062de0: 2070 726f 6365 7373 6564 5f64 6620 3d20   processed_df = 
-00062df0: 6466 2e67 726f 7570 6279 2867 726f 7570  df.groupby(group
-00062e00: 5f62 795f 636f 6c75 6d6e 2c20 6173 5f69  _by_column, as_i
-00062e10: 6e64 6578 3d46 616c 7365 292e 6167 6728  ndex=False).agg(
-00062e20: 6167 675f 6469 6374 290a 2020 2020 7265  agg_dict).    re
-00062e30: 7475 726e 2070 726f 6365 7373 6564 5f64  turn processed_d
-00062e40: 660a 0a64 6566 2061 7665 7261 6765 5f62  f..def average_b
-00062e50: 6c69 6e64 5f71 635f 6279 5f6d 6f64 616c  lind_qc_by_modal
-00062e60: 6974 7928 7163 5f66 756c 6c2c 7665 7262  ity(qc_full,verb
-00062e70: 6f73 653d 4661 6c73 6529 3a0a 2020 2020  ose=False):.    
-00062e80: 2222 220a 2020 2020 4176 6572 6167 6573  """.    Averages
-00062e90: 2074 696d 6520 7365 7269 6573 2071 6320   time series qc 
-00062ea0: 7265 7375 6c74 7320 746f 2079 6965 6c64  results to yield
-00062eb0: 206f 6e65 2065 6e74 7279 2070 6572 2069   one entry per i
-00062ec0: 6d61 6765 2e20 7468 6973 2061 6c73 6f20  mage. this also 
-00062ed0: 6669 6c74 6572 7320 746f 2022 6b6e 6f77  filters to "know
-00062ee0: 6e22 2063 6f6c 756d 6e73 2e0a 0a20 2020  n" columns...   
-00062ef0: 2041 7267 733a 0a20 2020 2071 635f 6675   Args:.    qc_fu
-00062f00: 6c6c 3a20 7061 6e64 6173 2064 6174 6166  ll: pandas dataf
-00062f10: 7261 6d65 2063 6f6e 7461 696e 696e 6720  rame containing 
-00062f20: 7468 6520 6675 6c6c 2071 6320 6461 7461  the full qc data
-00062f30: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-00062f40: 2020 2020 7061 6e64 6173 2064 6174 6166      pandas dataf
-00062f50: 7261 6d65 2063 6f6e 7461 696e 696e 6720  rame containing 
-00062f60: 7468 6520 7072 6f63 6573 7365 6420 7163  the processed qc
-00062f70: 2064 6174 612e 0a20 2020 2022 2222 0a20   data..    """. 
-00062f80: 2020 2071 635f 6675 6c6c 203d 2072 656d     qc_full = rem
-00062f90: 6f76 655f 756e 7761 6e74 6564 5f63 6f6c  ove_unwanted_col
-00062fa0: 756d 6e73 2820 7163 5f66 756c 6c20 290a  umns( qc_full ).
-00062fb0: 2020 2020 2320 4765 7420 756e 6971 7565      # Get unique
-00062fc0: 206d 6f64 616c 6974 6965 730a 2020 2020   modalities.    
-00062fd0: 6d6f 6461 6c69 7469 6573 203d 2071 635f  modalities = qc_
-00062fe0: 6675 6c6c 5b27 6d6f 6461 6c69 7479 275d  full['modality']
-00062ff0: 2e75 6e69 7175 6528 290a 2020 2020 6d6f  .unique().    mo
-00063000: 6461 6c69 7469 6573 203d 206d 6f64 616c  dalities = modal
-00063010: 6974 6965 735b 6d6f 6461 6c69 7469 6573  ities[modalities
-00063020: 2021 3d20 2775 6e6b 6e6f 776e 275d 0a20   != 'unknown']. 
-00063030: 2020 2023 2047 6574 2075 6e69 7175 6520     # Get unique 
-00063040: 6964 730a 2020 2020 7569 6420 3d20 7163  ids.    uid = qc
-00063050: 5f66 756c 6c5b 2766 696c 656e 616d 6527  _full['filename'
-00063060: 5d0a 2020 2020 746f 5f61 7665 7261 6765  ].    to_average
-00063070: 203d 2075 6964 2e75 6e69 7175 6528 290a   = uid.unique().
-00063080: 2020 2020 6d65 7461 203d 2070 642e 4461      meta = pd.Da
-00063090: 7461 4672 616d 6528 636f 6c75 6d6e 733d  taFrame(columns=
-000630a0: 7163 5f66 756c 6c2e 636f 6c75 6d6e 7320  qc_full.columns 
-000630b0: 290a 2020 2020 2320 5072 6f63 6573 7320  ).    # Process 
-000630c0: 6561 6368 2075 6e69 7175 6520 6964 0a20  each unique id. 
-000630d0: 2020 206e 203d 206c 656e 2874 6f5f 6176     n = len(to_av
-000630e0: 6572 6167 6529 0a20 2020 2066 6f72 206b  erage).    for k
-000630f0: 2069 6e20 7261 6e67 6528 6e29 3a0a 2020   in range(n):.  
-00063100: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-00063110: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00063120: 206b 2025 2031 3030 203d 3d20 303a 0a20   k % 100 == 0:. 
-00063130: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00063140: 726f 6767 6572 203d 2073 7472 2820 6e70  rogger = str( np
-00063150: 2e72 6f75 6e64 2820 6b20 2f20 6e20 2a20  .round( k / n * 
-00063160: 3130 3020 2920 290a 2020 2020 2020 2020  100 ) ).        
-00063170: 2020 2020 2020 2020 7072 696e 7428 2070          print( p
-00063180: 726f 6767 6572 2c20 656e 6420 3d22 2e2e  rogger, end ="..
-00063190: 2e22 2c20 666c 7573 683d 5472 7565 290a  .", flush=True).
-000631a0: 2020 2020 2020 2020 6d31 7365 6c20 3d20          m1sel = 
-000631b0: 7569 6420 3d3d 2074 6f5f 6176 6572 6167  uid == to_averag
-000631c0: 655b 6b5d 0a20 2020 2020 2020 2069 6620  e[k].        if 
-000631d0: 7375 6d28 6d31 7365 6c29 203e 2031 3a0a  sum(m1sel) > 1:.
-000631e0: 2020 2020 2020 2020 2020 2020 2320 4966              # If
-000631f0: 206d 6f72 6520 7468 616e 206f 6e65 2065   more than one e
-00063200: 6e74 7279 2066 6f72 2069 642c 2074 616b  ntry for id, tak
-00063210: 6520 7468 6520 6176 6572 6167 6520 6f66  e the average of
-00063220: 2063 6f6e 7469 6e75 6f75 7320 636f 6c75   continuous colu
-00063230: 6d6e 732c 0a20 2020 2020 2020 2020 2020  mns,.           
-00063240: 2023 206d 6178 696d 756d 206f 6620 7468   # maximum of th
-00063250: 6520 736c 6963 6520 636f 6c75 6d6e 2c20  e slice column, 
-00063260: 616e 6420 7468 6520 6669 7273 7420 656e  and the first en
-00063270: 7472 7920 6f66 2074 6865 206f 7468 6572  try of the other
-00063280: 2063 6f6c 756d 6e73 0a20 2020 2020 2020   columns.       
-00063290: 2020 2020 206d 6673 7562 203d 2070 726f       mfsub = pro
-000632a0: 6365 7373 5f64 6174 6166 7261 6d65 5f67  cess_dataframe_g
-000632b0: 656e 6572 616c 697a 6564 2871 635f 6675  eneralized(qc_fu
-000632c0: 6c6c 5b6d 3173 656c 5d2c 2766 696c 656e  ll[m1sel],'filen
-000632d0: 616d 6527 290a 2020 2020 2020 2020 656c  ame').        el
-000632e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000632f0: 6d66 7375 6220 3d20 7163 5f66 756c 6c5b  mfsub = qc_full[
-00063300: 6d31 7365 6c5d 0a20 2020 2020 2020 206d  m1sel].        m
-00063310: 6574 612e 6c6f 635b 6b5d 203d 206d 6673  eta.loc[k] = mfs
-00063320: 7562 2e69 6c6f 635b 305d 0a20 2020 206d  ub.iloc[0].    m
-00063330: 6574 615b 276d 6f64 616c 6974 7927 5d20  eta['modality'] 
-00063340: 3d20 6d65 7461 5b27 6d6f 6461 6c69 7479  = meta['modality
-00063350: 275d 2e72 6570 6c61 6365 285b 2744 5449  '].replace(['DTI
-00063360: 6477 6927 2c20 2744 5449 6230 275d 2c20  dwi', 'DTIb0'], 
-00063370: 2744 5449 272c 2072 6567 6578 3d54 7275  'DTI', regex=Tru
-00063380: 6529 0a20 2020 2072 6574 7572 6e20 6d65  e).    return me
-00063390: 7461 0a0a 6465 6620 776d 6828 2066 6c61  ta..def wmh( fla
-000633a0: 6972 2c20 7431 2c20 7431 7365 672c 0a20  ir, t1, t1seg,. 
-000633b0: 2020 206d 6d66 726f 6d63 6f6e 7665 7868     mmfromconvexh
-000633c0: 756c 6c20 3d20 332e 302c 0a20 2020 2073  ull = 3.0,.    s
-000633d0: 7472 6963 743d 5472 7565 2c0a 2020 2020  trict=True,.    
-000633e0: 7072 6f62 6162 696c 6974 795f 6d61 736b  probability_mask
-000633f0: 3d4e 6f6e 652c 0a20 2020 2070 7269 6f72  =None,.    prior
-00063400: 5f70 726f 6261 6269 6c69 7479 3d4e 6f6e  _probability=Non
-00063410: 652c 0a20 2020 206d 6f64 656c 3d27 7379  e,.    model='sy
-00063420: 7375 272c 0a20 2020 2076 6572 626f 7365  su',.    verbose
-00063430: 3d46 616c 7365 2029 203a 0a20 2020 2022  =False ) :.    "
-00063440: 2222 0a20 2020 204f 7574 7075 7473 2074  "".    Outputs t
-00063450: 6865 2057 4d48 2070 726f 6261 6269 6c69  he WMH probabili
-00063460: 7479 206d 6173 6b20 616e 6420 6120 7375  ty mask and a su
-00063470: 6d6d 6172 7920 7369 6e67 6c65 206d 6561  mmary single mea
-00063480: 7375 7265 6d65 6e74 0a0a 2020 2020 4172  surement..    Ar
-00063490: 6775 6d65 6e74 730a 2020 2020 2d2d 2d2d  guments.    ----
-000634a0: 2d2d 2d2d 2d0a 2020 2020 666c 6169 7220  -----.    flair 
-000634b0: 3a20 414e 5473 496d 6167 650a 2020 2020  : ANTsImage.    
-000634c0: 2020 2020 696e 7075 7420 332d 4420 464c      input 3-D FL
-000634d0: 4149 5220 6272 6169 6e20 696d 6167 6520  AIR brain image 
-000634e0: 286e 6f74 2073 6b75 6c6c 2d73 7472 6970  (not skull-strip
-000634f0: 7065 6429 2e0a 0a20 2020 2074 3120 3a20  ped)...    t1 : 
-00063500: 414e 5473 496d 6167 650a 2020 2020 2020  ANTsImage.      
-00063510: 2020 696e 7075 7420 332d 4420 5431 2062    input 3-D T1 b
-00063520: 7261 696e 2069 6d61 6765 2028 6e6f 7420  rain image (not 
-00063530: 736b 756c 6c2d 7374 7269 7070 6564 292e  skull-stripped).
-00063540: 0a0a 2020 2020 7431 7365 6720 3a20 414e  ..    t1seg : AN
-00063550: 5473 496d 6167 650a 2020 2020 2020 2020  TsImage.        
-00063560: 5431 2073 6567 6d65 6e74 6174 696f 6e20  T1 segmentation 
-00063570: 696d 6167 650a 0a20 2020 206d 6d66 726f  image..    mmfro
-00063580: 6d63 6f6e 7665 7868 756c 6c20 3a20 666c  mconvexhull : fl
-00063590: 6f61 740a 2020 2020 2020 2020 7265 7374  oat.        rest
-000635a0: 7269 6374 2057 4d48 2074 6f20 7265 6769  rict WMH to regi
-000635b0: 6f6e 7320 7468 6174 2061 7265 2057 4d20  ons that are WM 
-000635c0: 6f72 206d 6d66 726f 6d63 6f6e 7665 7868  or mmfromconvexh
-000635d0: 756c 6c20 6d6d 2061 7761 7920 6672 6f6d  ull mm away from
-000635e0: 2074 6865 0a20 2020 2020 2020 2063 6f6e   the.        con
-000635f0: 7665 7820 6875 6c6c 206f 6620 7468 6520  vex hull of the 
-00063600: 6365 7265 6272 756d 2e20 2020 7765 2063  cerebrum.   we c
-00063610: 686f 6f73 6520 6120 6465 6661 756c 7420  hoose a default 
-00063620: 7661 6c75 6520 6261 7365 6420 6f6e 0a20  value based on. 
-00063630: 2020 2020 2020 2046 6967 7572 6520 3420         Figure 4 
-00063640: 6672 6f6d 3a0a 2020 2020 2020 2020 6874  from:.        ht
-00063650: 7470 733a 2f2f 7777 772e 6e63 6269 2e6e  tps://www.ncbi.n
-00063660: 6c6d 2e6e 6968 2e67 6f76 2f70 6d63 2f61  lm.nih.gov/pmc/a
-00063670: 7274 6963 6c65 732f 504d 4336 3234 3035  rticles/PMC62405
-00063680: 3739 2f70 6466 2f66 6e61 6769 2d31 302d  79/pdf/fnagi-10-
-00063690: 3030 3333 392e 7064 660a 0a20 2020 2073  00339.pdf..    s
-000636a0: 7472 6963 743a 2062 6f6f 6c65 616e 202d  trict: boolean -
-000636b0: 2069 6620 5472 7565 2c20 6f6e 6c79 2075   if True, only u
-000636c0: 7365 2063 6f6e 7665 7820 6875 6c6c 2064  se convex hull d
-000636d0: 6973 7461 6e63 650a 0a20 2020 2070 726f  istance..    pro
-000636e0: 6261 6269 6c69 7479 5f6d 6173 6b20 3a20  bability_mask : 
-000636f0: 4e6f 6e65 202d 2075 7365 2074 6f20 636f  None - use to co
-00063700: 6d70 7574 6520 776d 6820 6a75 7374 206f  mpute wmh just o
-00063710: 6e63 6520 2d20 7468 656e 2074 6869 7320  nce - then this 
-00063720: 6675 6e63 7469 6f6e 0a20 2020 2020 2020  function.       
-00063730: 206a 7573 7420 646f 6573 2072 6566 696e   just does refin
-00063740: 656d 656e 7420 616e 6420 7375 6d6d 6172  ement and summar
-00063750: 790a 0a20 2020 2070 7269 6f72 5f70 726f  y..    prior_pro
-00063760: 6261 6269 6c69 7479 203a 206f 7074 696f  bability : optio
-00063770: 6e61 6c20 7072 696f 7220 7072 6f62 6162  nal prior probab
-00063780: 696c 6974 7920 696d 6167 6520 696e 2073  ility image in s
-00063790: 7061 6365 206f 6620 7468 6520 696e 7075  pace of the inpu
-000637a0: 7420 7431 0a0a 2020 2020 6d6f 6465 6c20  t t1..    model 
-000637b0: 3a20 6569 7468 6572 2073 7973 7520 6f72  : either sysu or
-000637c0: 2068 7970 6572 0a0a 2020 2020 7665 7262   hyper..    verb
-000637d0: 6f73 6520 3a20 626f 6f6c 6561 6e0a 0a20  ose : boolean.. 
-000637e0: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
-000637f0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2057 4d48  --------.    WMH
-00063800: 2070 726f 6261 6269 6c69 7479 206d 6170   probability map
-00063810: 2061 6e64 2061 2073 756d 6d61 7279 2073   and a summary s
-00063820: 696e 676c 6520 6d65 6173 7572 656d 656e  ingle measuremen
-00063830: 7420 7768 6963 6820 6973 2074 6865 2073  t which is the s
-00063840: 756d 206f 6620 7468 6520 574d 4820 6d61  um of the WMH ma
-00063850: 700a 0a20 2020 2022 2222 0a20 2020 2069  p..    """.    i
-00063860: 6d70 6f72 7420 6e75 6d70 7920 6173 206e  mport numpy as n
-00063870: 700a 2020 2020 696d 706f 7274 206d 6174  p.    import mat
-00063880: 680a 2020 2020 7431 5f32 5f66 6c61 6972  h.    t1_2_flair
-00063890: 5f72 6567 203d 2061 6e74 732e 7265 6769  _reg = ants.regi
-000638a0: 7374 7261 7469 6f6e 2866 6c61 6972 2c20  stration(flair, 
-000638b0: 7431 2c20 7479 7065 5f6f 665f 7472 616e  t1, type_of_tran
-000638c0: 7366 6f72 6d20 3d20 2752 6967 6964 2729  sform = 'Rigid')
-000638d0: 2023 2052 6567 6973 7465 7220 5431 2074   # Register T1 t
-000638e0: 6f20 466c 6169 720a 2020 2020 6966 2070  o Flair.    if p
-000638f0: 726f 6261 6269 6c69 7479 5f6d 6173 6b20  robability_mask 
-00063900: 6973 204e 6f6e 6520 616e 6420 6d6f 6465  is None and mode
-00063910: 6c20 3d3d 2027 7379 7375 273a 0a20 2020  l == 'sysu':.   
-00063920: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-00063930: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00063940: 6e74 2827 7379 7375 2729 0a20 2020 2020  nt('sysu').     
-00063950: 2020 2070 726f 6261 6269 6c69 7479 5f6d     probability_m
-00063960: 6173 6b20 3d20 616e 7473 7079 6e65 742e  ask = antspynet.
-00063970: 7379 7375 5f6d 6564 6961 5f77 6d68 5f73  sysu_media_wmh_s
-00063980: 6567 6d65 6e74 6174 696f 6e28 2066 6c61  egmentation( fla
-00063990: 6972 2029 0a20 2020 2065 6c69 6620 7072  ir ).    elif pr
-000639a0: 6f62 6162 696c 6974 795f 6d61 736b 2069  obability_mask i
-000639b0: 7320 4e6f 6e65 2061 6e64 206d 6f64 656c  s None and model
-000639c0: 203d 3d20 2768 7970 6572 273a 0a20 2020   == 'hyper':.   
-000639d0: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-000639e0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-000639f0: 6e74 2827 6879 7065 7227 290a 2020 2020  nt('hyper').    
-00063a00: 2020 2020 7072 6f62 6162 696c 6974 795f      probability_
-00063a10: 6d61 736b 203d 2061 6e74 7370 796e 6574  mask = antspynet
-00063a20: 2e68 7970 6572 6d61 7070 3372 5f73 6567  .hypermapp3r_seg
-00063a30: 6d65 6e74 6174 696f 6e28 2074 315f 325f  mentation( t1_2_
-00063a40: 666c 6169 725f 7265 675b 2777 6172 7065  flair_reg['warpe
-00063a50: 646d 6f76 6f75 7427 5d2c 2066 6c61 6972  dmovout'], flair
-00063a60: 2029 0a20 2020 2023 2074 315f 325f 666c   ).    # t1_2_fl
-00063a70: 6169 725f 7265 6720 3d20 7472 615f 696e  air_reg = tra_in
-00063a80: 6974 6961 6c69 7a65 7228 2066 6c61 6972  itializer( flair
-00063a90: 2c20 7431 2c20 6e5f 7369 6d75 6c61 7469  , t1, n_simulati
-00063aa0: 6f6e 733d 342c 206d 6178 5f72 6f74 6174  ons=4, max_rotat
-00063ab0: 696f 6e3d 352c 2074 7261 6e73 666f 726d  ion=5, transform
-00063ac0: 3d5b 2772 6967 6964 275d 2c20 7665 7262  =['rigid'], verb
-00063ad0: 6f73 653d 4661 6c73 6520 290a 2020 2020  ose=False ).    
-00063ae0: 7072 696f 725f 7072 6f62 6162 696c 6974  prior_probabilit
-00063af0: 795f 666c 6169 7220 3d20 4e6f 6e65 0a20  y_flair = None. 
-00063b00: 2020 2069 6620 7072 696f 725f 7072 6f62     if prior_prob
-00063b10: 6162 696c 6974 7920 6973 206e 6f74 204e  ability is not N
-00063b20: 6f6e 653a 0a20 2020 2020 2020 2070 7269  one:.        pri
-00063b30: 6f72 5f70 726f 6261 6269 6c69 7479 5f66  or_probability_f
-00063b40: 6c61 6972 203d 2061 6e74 732e 6170 706c  lair = ants.appl
-00063b50: 795f 7472 616e 7366 6f72 6d73 2820 666c  y_transforms( fl
-00063b60: 6169 722c 2070 7269 6f72 5f70 726f 6261  air, prior_proba
-00063b70: 6269 6c69 7479 2c0a 2020 2020 2020 2020  bility,.        
-00063b80: 2020 2020 7431 5f32 5f66 6c61 6972 5f72      t1_2_flair_r
-00063b90: 6567 5b27 6677 6474 7261 6e73 666f 726d  eg['fwdtransform
-00063ba0: 7327 5d20 290a 2020 2020 776d 7365 675f  s'] ).    wmseg_
-00063bb0: 6d61 736b 203d 2061 6e74 732e 7468 7265  mask = ants.thre
-00063bc0: 7368 6f6c 645f 696d 6167 6528 2074 3173  shold_image( t1s
-00063bd0: 6567 2c0a 2020 2020 2020 2020 6c6f 775f  eg,.        low_
-00063be0: 7468 7265 7368 203d 2033 2c20 6869 6768  thresh = 3, high
-00063bf0: 5f74 6872 6573 6820 3d20 3329 2e69 4d61  _thresh = 3).iMa
-00063c00: 7468 2822 4669 6c6c 486f 6c65 7322 290a  th("FillHoles").
-00063c10: 2020 2020 776d 7365 675f 6d61 736b 5f75      wmseg_mask_u
-00063c20: 7365 203d 2061 6e74 732e 696d 6167 655f  se = ants.image_
-00063c30: 636c 6f6e 6528 2077 6d73 6567 5f6d 6173  clone( wmseg_mas
-00063c40: 6b20 290a 2020 2020 6469 7374 6d61 736b  k ).    distmask
-00063c50: 203d 204e 6f6e 650a 2020 2020 6966 206d   = None.    if m
-00063c60: 6d66 726f 6d63 6f6e 7665 7868 756c 6c20  mfromconvexhull 
-00063c70: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-00063c80: 2063 6f6e 7665 7868 756c 6c20 3d20 616e   convexhull = an
-00063c90: 7473 2e74 6872 6573 686f 6c64 5f69 6d61  ts.threshold_ima
-00063ca0: 6765 2820 7431 7365 672c 2031 2c20 3420  ge( t1seg, 1, 4 
-00063cb0: 290a 2020 2020 2020 2020 2020 2020 7370  ).            sp
-00063cc0: 6332 766f 7820 3d20 6e70 2e70 726f 6428  c2vox = np.prod(
-00063cd0: 2061 6e74 732e 6765 745f 7370 6163 696e   ants.get_spacin
-00063ce0: 6728 2074 3173 6567 2029 2029 0a20 2020  g( t1seg ) ).   
-00063cf0: 2020 2020 2020 2020 2076 6f78 6469 7374           voxdist
-00063d00: 203d 2030 2e30 0a20 2020 2020 2020 2020   = 0.0.         
-00063d10: 2020 206d 7973 7063 203d 2061 6e74 732e     myspc = ants.
-00063d20: 6765 745f 7370 6163 696e 6728 2074 3173  get_spacing( t1s
-00063d30: 6567 2029 0a20 2020 2020 2020 2020 2020  eg ).           
-00063d40: 2066 6f72 206b 2069 6e20 7261 6e67 6528   for k in range(
-00063d50: 2074 3173 6567 2e64 696d 656e 7369 6f6e   t1seg.dimension
-00063d60: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-00063d70: 2020 2020 766f 7864 6973 7420 3d20 766f      voxdist = vo
-00063d80: 7864 6973 7420 2b20 6d79 7370 635b 6b5d  xdist + myspc[k]
-00063d90: 202a 206d 7973 7063 5b6b 5d0a 2020 2020   * myspc[k].    
-00063da0: 2020 2020 2020 2020 766f 7864 6973 7420          voxdist 
-00063db0: 3d20 6d61 7468 2e73 7172 7428 2076 6f78  = math.sqrt( vox
-00063dc0: 6469 7374 2029 0a20 2020 2020 2020 2020  dist ).         
-00063dd0: 2020 206e 6d6f 7270 6820 3d20 726f 756e     nmorph = roun
-00063de0: 6428 2032 2e30 202f 2076 6f78 6469 7374  d( 2.0 / voxdist
-00063df0: 2029 0a20 2020 2020 2020 2020 2020 2063   ).            c
-00063e00: 6f6e 7665 7868 756c 6c20 3d20 616e 7473  onvexhull = ants
-00063e10: 2e6d 6f72 7068 6f6c 6f67 7928 2063 6f6e  .morphology( con
-00063e20: 7665 7868 756c 6c2c 2022 636c 6f73 6522  vexhull, "close"
-00063e30: 2c20 6e6d 6f72 7068 2029 2e69 4d61 7468  , nmorph ).iMath
-00063e40: 2822 4669 6c6c 486f 6c65 7322 290a 2020  ("FillHoles").  
-00063e50: 2020 2020 2020 2020 2020 6469 7374 203d            dist =
-00063e60: 2061 6e74 732e 694d 6174 6828 2063 6f6e   ants.iMath( con
-00063e70: 7665 7868 756c 6c2c 2022 4d61 7572 6572  vexhull, "Maurer
-00063e80: 4469 7374 616e 6365 2220 2920 2a20 2d31  Distance" ) * -1
-00063e90: 2e30 0a20 2020 2020 2020 2020 2020 2064  .0.            d
-00063ea0: 6973 746d 6173 6b20 3d20 616e 7473 2e74  istmask = ants.t
-00063eb0: 6872 6573 686f 6c64 5f69 6d61 6765 2820  hreshold_image( 
-00063ec0: 6469 7374 2c20 6d6d 6672 6f6d 636f 6e76  dist, mmfromconv
-00063ed0: 6578 6875 6c6c 2c20 312e 6538 3020 290a  exhull, 1.e80 ).
-00063ee0: 2020 2020 2020 2020 2020 2020 776d 7365              wmse
-00063ef0: 675f 6d61 736b 203d 2077 6d73 6567 5f6d  g_mask = wmseg_m
-00063f00: 6173 6b20 2b20 6469 7374 6d61 736b 0a20  ask + distmask. 
-00063f10: 2020 2020 2020 2020 2020 2069 6620 7374             if st
-00063f20: 7269 6374 3a0a 2020 2020 2020 2020 2020  rict:.          
-00063f30: 2020 2020 2020 776d 7365 675f 6d61 736b        wmseg_mask
-00063f40: 5f75 7365 203d 2061 6e74 732e 7468 7265  _use = ants.thre
-00063f50: 7368 6f6c 645f 696d 6167 6528 2077 6d73  shold_image( wms
-00063f60: 6567 5f6d 6173 6b2c 2032 2c20 3220 290a  eg_mask, 2, 2 ).
-00063f70: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00063f80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00063f90: 2020 776d 7365 675f 6d61 736b 5f75 7365    wmseg_mask_use
-00063fa0: 203d 2061 6e74 732e 7468 7265 7368 6f6c   = ants.threshol
-00063fb0: 645f 696d 6167 6528 2077 6d73 6567 5f6d  d_image( wmseg_m
-00063fc0: 6173 6b2c 2031 2c20 3220 290a 2020 2020  ask, 1, 2 ).    
-00063fd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00063fe0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00063ff0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00064000: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00064010: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-00064020: 2020 2077 6d73 6567 5f32 5f66 6c61 6972     wmseg_2_flair
-00064030: 203d 2061 6e74 732e 6170 706c 795f 7472   = ants.apply_tr
-00064040: 616e 7366 6f72 6d73 2866 6c61 6972 2c20  ansforms(flair, 
-00064050: 776d 7365 675f 6d61 736b 5f75 7365 2c0a  wmseg_mask_use,.
-00064060: 2020 2020 2020 2020 7472 616e 7366 6f72          transfor
-00064070: 6d6c 6973 7420 3d20 7431 5f32 5f66 6c61  mlist = t1_2_fla
-00064080: 6972 5f72 6567 5b27 6677 6474 7261 6e73  ir_reg['fwdtrans
-00064090: 666f 726d 7327 5d2c 0a20 2020 2020 2020  forms'],.       
-000640a0: 2069 6e74 6572 706f 6c61 746f 7220 3d20   interpolator = 
-000640b0: 276e 6561 7265 7374 4e65 6967 6862 6f72  'nearestNeighbor
-000640c0: 2720 290a 2020 2020 7365 675f 325f 666c  ' ).    seg_2_fl
-000640d0: 6169 7220 3d20 616e 7473 2e61 7070 6c79  air = ants.apply
-000640e0: 5f74 7261 6e73 666f 726d 7328 666c 6169  _transforms(flai
-000640f0: 722c 2074 3173 6567 2c0a 2020 2020 2020  r, t1seg,.      
-00064100: 2020 7472 616e 7366 6f72 6d6c 6973 7420    transformlist 
-00064110: 3d20 7431 5f32 5f66 6c61 6972 5f72 6567  = t1_2_flair_reg
-00064120: 5b27 6677 6474 7261 6e73 666f 726d 7327  ['fwdtransforms'
-00064130: 5d2c 0a20 2020 2020 2020 2069 6e74 6572  ],.        inter
-00064140: 706f 6c61 746f 7220 3d20 276e 6561 7265  polator = 'neare
-00064150: 7374 4e65 6967 6862 6f72 2720 290a 2020  stNeighbor' ).  
-00064160: 2020 6373 666d 6173 6b20 3d20 616e 7473    csfmask = ants
-00064170: 2e74 6872 6573 686f 6c64 5f69 6d61 6765  .threshold_image
-00064180: 2873 6567 5f32 5f66 6c61 6972 2c31 2c31  (seg_2_flair,1,1
-00064190: 290a 2020 2020 666c 6169 7273 6e72 203d  ).    flairsnr =
-000641a0: 206d 6173 6b5f 736e 7228 2066 6c61 6972   mask_snr( flair
-000641b0: 2c20 6373 666d 6173 6b2c 2077 6d73 6567  , csfmask, wmseg
-000641c0: 5f32 5f66 6c61 6972 2c20 6269 6173 5f63  _2_flair, bias_c
-000641d0: 6f72 7265 6374 203d 2046 616c 7365 2029  orrect = False )
-000641e0: 0a20 2020 2070 726f 6261 6269 6c69 7479  .    probability
-000641f0: 5f6d 6173 6b5f 574d 203d 2077 6d73 6567  _mask_WM = wmseg
-00064200: 5f32 5f66 6c61 6972 202a 2070 726f 6261  _2_flair * proba
-00064210: 6269 6c69 7479 5f6d 6173 6b20 2320 5265  bility_mask # Re
-00064220: 6d6f 7665 2057 4d48 2073 6967 6e61 6c20  move WMH signal 
-00064230: 6f75 7473 6964 6520 6f66 2057 4d0a 2020  outside of WM.  
-00064240: 2020 776d 685f 7375 6d20 3d20 6e70 2e70    wmh_sum = np.p
-00064250: 726f 6428 2061 6e74 732e 6765 745f 7370  rod( ants.get_sp
-00064260: 6163 696e 6728 2066 6c61 6972 2029 2029  acing( flair ) )
-00064270: 202a 2070 726f 6261 6269 6c69 7479 5f6d   * probability_m
-00064280: 6173 6b5f 574d 2e73 756d 2829 0a20 2020  ask_WM.sum().   
-00064290: 2077 6d68 5f73 756d 5f70 7269 6f72 203d   wmh_sum_prior =
-000642a0: 206d 6174 682e 6e61 6e0a 2020 2020 7072   math.nan.    pr
-000642b0: 6f62 6162 696c 6974 795f 6d61 736b 5f70  obability_mask_p
-000642c0: 6f73 7465 7269 6f72 203d 204e 6f6e 650a  osterior = None.
-000642d0: 2020 2020 6966 2070 7269 6f72 5f70 726f      if prior_pro
-000642e0: 6261 6269 6c69 7479 5f66 6c61 6972 2069  bability_flair i
-000642f0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00064300: 2020 2020 7072 6f62 6162 696c 6974 795f      probability_
-00064310: 6d61 736b 5f70 6f73 7465 7269 6f72 203d  mask_posterior =
-00064320: 2070 7269 6f72 5f70 726f 6261 6269 6c69   prior_probabili
-00064330: 7479 5f66 6c61 6972 202a 2070 726f 6261  ty_flair * proba
-00064340: 6269 6c69 7479 5f6d 6173 6b20 2320 7573  bility_mask # us
-00064350: 6520 7072 696f 720a 2020 2020 2020 2020  e prior.        
-00064360: 776d 685f 7375 6d5f 7072 696f 7220 3d20  wmh_sum_prior = 
-00064370: 6e70 2e70 726f 6428 2061 6e74 732e 6765  np.prod( ants.ge
-00064380: 745f 7370 6163 696e 6728 666c 6169 7229  t_spacing(flair)
-00064390: 2029 202a 2070 726f 6261 6269 6c69 7479   ) * probability
-000643a0: 5f6d 6173 6b5f 706f 7374 6572 696f 722e  _mask_posterior.
-000643b0: 7375 6d28 290a 2020 2020 6966 206d 6174  sum().    if mat
-000643c0: 682e 6973 6e61 6e28 2077 6d68 5f73 756d  h.isnan( wmh_sum
-000643d0: 2029 3a0a 2020 2020 2020 2020 776d 685f   ):.        wmh_
-000643e0: 7375 6d3d 300a 2020 2020 6966 206d 6174  sum=0.    if mat
-000643f0: 682e 6973 6e61 6e28 2077 6d68 5f73 756d  h.isnan( wmh_sum
-00064400: 5f70 7269 6f72 2029 3a0a 2020 2020 2020  _prior ):.      
-00064410: 2020 776d 685f 7375 6d5f 7072 696f 723d    wmh_sum_prior=
-00064420: 300a 2020 2020 666c 6169 725f 6576 7220  0.    flair_evr 
-00064430: 3d20 616e 7473 7079 7431 772e 7061 7463  = antspyt1w.patc
-00064440: 685f 6569 6765 6e76 616c 7565 5f72 6174  h_eigenvalue_rat
-00064450: 696f 2820 666c 6169 722c 2035 3132 2c20  io( flair, 512, 
-00064460: 5b31 362c 3136 2c31 365d 2c20 6576 6465  [16,16,16], evde
-00064470: 7074 6820 3d20 302e 392c 206d 6173 6b3d  pth = 0.9, mask=
-00064480: 776d 7365 675f 325f 666c 6169 7220 290a  wmseg_2_flair ).
-00064490: 2020 2020 7265 7475 726e 7b0a 2020 2020      return{.    
-000644a0: 2020 2020 2757 4d48 5f70 726f 6261 6269      'WMH_probabi
-000644b0: 6c69 7479 5f6d 6170 5f72 6177 273a 2070  lity_map_raw': p
-000644c0: 726f 6261 6269 6c69 7479 5f6d 6173 6b2c  robability_mask,
-000644d0: 0a20 2020 2020 2020 2027 574d 485f 7072  .        'WMH_pr
-000644e0: 6f62 6162 696c 6974 795f 6d61 7027 203a  obability_map' :
-000644f0: 2070 726f 6261 6269 6c69 7479 5f6d 6173   probability_mas
-00064500: 6b5f 574d 2c0a 2020 2020 2020 2020 2757  k_WM,.        'W
-00064510: 4d48 5f70 6f73 7465 7269 6f72 5f70 726f  MH_posterior_pro
-00064520: 6261 6269 6c69 7479 5f6d 6170 2720 3a20  bability_map' : 
-00064530: 7072 6f62 6162 696c 6974 795f 6d61 736b  probability_mask
-00064540: 5f70 6f73 7465 7269 6f72 2c0a 2020 2020  _posterior,.    
-00064550: 2020 2020 2777 6d68 5f6d 6173 7327 3a20      'wmh_mass': 
-00064560: 776d 685f 7375 6d2c 0a20 2020 2020 2020  wmh_sum,.       
-00064570: 2027 776d 685f 6d61 7373 5f70 7269 6f72   'wmh_mass_prior
-00064580: 273a 2077 6d68 5f73 756d 5f70 7269 6f72  ': wmh_sum_prior
-00064590: 2c0a 2020 2020 2020 2020 2777 6d68 5f65  ,.        'wmh_e
-000645a0: 7672 2720 3a20 666c 6169 725f 6576 722c  vr' : flair_evr,
-000645b0: 0a20 2020 2020 2020 2027 776d 685f 534e  .        'wmh_SN
-000645c0: 5227 203a 2066 6c61 6972 736e 722c 0a20  R' : flairsnr,. 
-000645d0: 2020 2020 2020 2027 636f 6e76 6578 6875         'convexhu
-000645e0: 6c6c 5f6d 6173 6b27 3a20 6469 7374 6d61  ll_mask': distma
-000645f0: 736b 207d 0a0a 0a64 6566 2072 6570 6c61  sk }...def repla
-00064600: 6365 5f65 6c65 6d65 6e74 735f 696e 5f6e  ce_elements_in_n
-00064610: 756d 7079 5f61 7272 6179 286f 7269 6769  umpy_array(origi
-00064620: 6e61 6c5f 6172 7261 792c 2069 6e64 6963  nal_array, indic
-00064630: 6573 5f74 6f5f 7265 706c 6163 652c 206e  es_to_replace, n
-00064640: 6577 5f76 616c 7565 293a 0a20 2020 2022  ew_value):.    "
-00064650: 2222 0a20 2020 2052 6570 6c61 6365 2073  "".    Replace s
-00064660: 7065 6369 6669 6564 2065 6c65 6d65 6e74  pecified element
-00064670: 7320 6f72 2072 6f77 7320 696e 2061 206e  s or rows in a n
-00064680: 756d 7079 2061 7272 6179 2077 6974 6820  umpy array with 
-00064690: 6120 6e65 7720 7661 6c75 652e 0a0a 2020  a new value...  
-000646a0: 2020 5061 7261 6d65 7465 7273 3a0a 2020    Parameters:.  
-000646b0: 2020 6f72 6967 696e 616c 5f61 7272 6179    original_array
-000646c0: 2028 6e75 6d70 792e 6e64 6172 7261 7929   (numpy.ndarray)
-000646d0: 3a20 4120 6e75 6d70 7920 6172 7261 7920  : A numpy array 
-000646e0: 696e 2077 6869 6368 2065 6c65 6d65 6e74  in which element
-000646f0: 7320 6f72 2072 6f77 7320 6172 6520 746f  s or rows are to
-00064700: 2062 6520 7265 706c 6163 6564 2e0a 2020   be replaced..  
-00064710: 2020 696e 6469 6365 735f 746f 5f72 6570    indices_to_rep
-00064720: 6c61 6365 2028 6c69 7374 206f 7220 6e75  lace (list or nu
-00064730: 6d70 792e 6e64 6172 7261 7929 3a20 496e  mpy.ndarray): In
-00064740: 6469 6365 7320 6f66 2065 6c65 6d65 6e74  dices of element
-00064750: 7320 6f72 2072 6f77 7320 746f 2062 6520  s or rows to be 
-00064760: 7265 706c 6163 6564 2e0a 2020 2020 6e65  replaced..    ne
-00064770: 775f 7661 6c75 653a 2054 6865 206e 6577  w_value: The new
-00064780: 2076 616c 7565 2074 6f20 7265 706c 6163   value to replac
-00064790: 6520 7468 6520 7370 6563 6966 6965 6420  e the specified 
-000647a0: 656c 656d 656e 7473 206f 7220 726f 7773  elements or rows
-000647b0: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-000647c0: 2020 2020 6e75 6d70 792e 6e64 6172 7261      numpy.ndarra
-000647d0: 793a 2041 206e 6577 206e 756d 7079 2061  y: A new numpy a
-000647e0: 7272 6179 2077 6974 6820 7468 6520 7370  rray with the sp
-000647f0: 6563 6966 6965 6420 656c 656d 656e 7473  ecified elements
-00064800: 206f 7220 726f 7773 2072 6570 6c61 6365   or rows replace
-00064810: 642e 2049 6620 7468 6520 696e 7075 7420  d. If the input 
-00064820: 6172 7261 7920 6973 204e 6f6e 652c 0a20  array is None,. 
-00064830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00064840: 2020 7468 6520 6675 6e63 7469 6f6e 2072    the function r
-00064850: 6574 7572 6e73 204e 6f6e 652e 0a20 2020  eturns None..   
-00064860: 2022 2222 0a0a 2020 2020 6966 206f 7269   """..    if ori
-00064870: 6769 6e61 6c5f 6172 7261 7920 6973 204e  ginal_array is N
-00064880: 6f6e 653a 0a20 2020 2020 2020 2072 6574  one:.        ret
-00064890: 7572 6e20 4e6f 6e65 0a0a 2020 2020 6d61  urn None..    ma
-000648a0: 785f 696e 6465 7820 3d20 6f72 6967 696e  x_index = origin
-000648b0: 616c 5f61 7272 6179 2e73 697a 6520 6966  al_array.size if
-000648c0: 206f 7269 6769 6e61 6c5f 6172 7261 792e   original_array.
-000648d0: 6e64 696d 203d 3d20 3120 656c 7365 206f  ndim == 1 else o
-000648e0: 7269 6769 6e61 6c5f 6172 7261 792e 7368  riginal_array.sh
-000648f0: 6170 655b 305d 0a0a 2020 2020 2320 4669  ape[0]..    # Fi
-00064900: 6c74 6572 206f 7574 2069 6e76 616c 6964  lter out invalid
-00064910: 2069 6e64 6963 6573 2061 6e64 2063 6865   indices and che
-00064920: 636b 2066 6f72 2061 6e79 206f 7574 2d6f  ck for any out-o
-00064930: 662d 626f 756e 6473 2069 6e64 6963 6573  f-bounds indices
-00064940: 0a20 2020 2076 616c 6964 5f69 6e64 6963  .    valid_indic
-00064950: 6573 203d 205b 5d0a 2020 2020 666f 7220  es = [].    for 
-00064960: 6964 7820 696e 2069 6e64 6963 6573 5f74  idx in indices_t
-00064970: 6f5f 7265 706c 6163 653a 0a20 2020 2020  o_replace:.     
-00064980: 2020 2069 6620 6964 7820 3c20 6d61 785f     if idx < max_
-00064990: 696e 6465 783a 0a20 2020 2020 2020 2020  index:.         
-000649a0: 2020 2076 616c 6964 5f69 6e64 6963 6573     valid_indices
-000649b0: 2e61 7070 656e 6428 6964 7829 0a20 2020  .append(idx).   
-000649c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000649d0: 2020 2020 2020 2077 6172 6e69 6e67 732e         warnings.
-000649e0: 7761 726e 2866 2257 6172 6e69 6e67 3a20  warn(f"Warning: 
-000649f0: 496e 6465 7820 7b69 6478 7d20 6973 206f  Index {idx} is o
-00064a00: 7574 206f 6620 626f 756e 6473 2061 6e64  ut of bounds and
-00064a10: 2077 696c 6c20 6265 2069 676e 6f72 6564   will be ignored
-00064a20: 2e22 290a 0a20 2020 2069 6620 6f72 6967  .")..    if orig
-00064a30: 696e 616c 5f61 7272 6179 2e6e 6469 6d20  inal_array.ndim 
-00064a40: 3d3d 2031 3a0a 2020 2020 2020 2020 2320  == 1:.        # 
-00064a50: 5265 706c 6163 6520 656c 656d 656e 7473  Replace elements
-00064a60: 2069 6e20 6120 3144 2061 7272 6179 0a20   in a 1D array. 
-00064a70: 2020 2020 2020 206f 7269 6769 6e61 6c5f         original_
-00064a80: 6172 7261 795b 7661 6c69 645f 696e 6469  array[valid_indi
-00064a90: 6365 735d 203d 206e 6577 5f76 616c 7565  ces] = new_value
-00064aa0: 0a20 2020 2065 6c69 6620 6f72 6967 696e  .    elif origin
-00064ab0: 616c 5f61 7272 6179 2e6e 6469 6d20 3d3d  al_array.ndim ==
-00064ac0: 2032 3a0a 2020 2020 2020 2020 2320 5265   2:.        # Re
-00064ad0: 706c 6163 6520 726f 7773 2069 6e20 6120  place rows in a 
-00064ae0: 3244 2061 7272 6179 0a20 2020 2020 2020  2D array.       
-00064af0: 206f 7269 6769 6e61 6c5f 6172 7261 795b   original_array[
-00064b00: 7661 6c69 645f 696e 6469 6365 732c 203a  valid_indices, :
-00064b10: 5d20 3d20 6e65 775f 7661 6c75 650a 2020  ] = new_value.  
-00064b20: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00064b30: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00064b40: 2822 6f72 6967 696e 616c 5f61 7272 6179  ("original_array
-00064b50: 206d 7573 7420 6265 2065 6974 6865 7220   must be either 
-00064b60: 3144 206f 7220 3244 2e22 290a 0a20 2020  1D or 2D.")..   
-00064b70: 2072 6574 7572 6e20 6f72 6967 696e 616c   return original
-00064b80: 5f61 7272 6179 0a0a 0a0a 6465 6620 7265  _array....def re
-00064b90: 6d6f 7665 5f65 6c65 6d65 6e74 735f 6672  move_elements_fr
-00064ba0: 6f6d 5f6e 756d 7079 5f61 7272 6179 286f  om_numpy_array(o
-00064bb0: 7269 6769 6e61 6c5f 6172 7261 792c 2069  riginal_array, i
-00064bc0: 6e64 6963 6573 5f74 6f5f 7265 6d6f 7665  ndices_to_remove
-00064bd0: 293a 0a20 2020 2022 2222 0a20 2020 2052  ):.    """.    R
-00064be0: 656d 6f76 6520 7370 6563 6966 6965 6420  emove specified 
-00064bf0: 656c 656d 656e 7473 206f 7220 726f 7773  elements or rows
-00064c00: 2066 726f 6d20 6120 6e75 6d70 7920 6172   from a numpy ar
-00064c10: 7261 792e 0a0a 2020 2020 5061 7261 6d65  ray...    Parame
-00064c20: 7465 7273 3a0a 2020 2020 6f72 6967 696e  ters:.    origin
-00064c30: 616c 5f61 7272 6179 2028 6e75 6d70 792e  al_array (numpy.
-00064c40: 6e64 6172 7261 7929 3a20 4120 6e75 6d70  ndarray): A nump
-00064c50: 7920 6172 7261 7920 6672 6f6d 2077 6869  y array from whi
-00064c60: 6368 2065 6c65 6d65 6e74 7320 6f72 2072  ch elements or r
-00064c70: 6f77 7320 6172 6520 746f 2062 6520 7265  ows are to be re
-00064c80: 6d6f 7665 642e 0a20 2020 2069 6e64 6963  moved..    indic
-00064c90: 6573 5f74 6f5f 7265 6d6f 7665 2028 6c69  es_to_remove (li
-00064ca0: 7374 206f 7220 6e75 6d70 792e 6e64 6172  st or numpy.ndar
-00064cb0: 7261 7929 3a20 496e 6469 6365 7320 6f66  ray): Indices of
-00064cc0: 2065 6c65 6d65 6e74 7320 6f72 2072 6f77   elements or row
-00064cd0: 7320 746f 2062 6520 7265 6d6f 7665 642e  s to be removed.
-00064ce0: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
-00064cf0: 2020 206e 756d 7079 2e6e 6461 7272 6179     numpy.ndarray
-00064d00: 3a20 4120 6e65 7720 6e75 6d70 7920 6172  : A new numpy ar
-00064d10: 7261 7920 7769 7468 2074 6865 2073 7065  ray with the spe
-00064d20: 6369 6669 6564 2065 6c65 6d65 6e74 7320  cified elements 
-00064d30: 6f72 2072 6f77 7320 7265 6d6f 7665 642e  or rows removed.
-00064d40: 2049 6620 7468 6520 696e 7075 7420 6172   If the input ar
-00064d50: 7261 7920 6973 204e 6f6e 652c 0a20 2020  ray is None,.   
-00064d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00064d70: 7468 6520 6675 6e63 7469 6f6e 2072 6574  the function ret
-00064d80: 7572 6e73 204e 6f6e 652e 0a20 2020 2022  urns None..    "
-00064d90: 2222 0a0a 2020 2020 6966 206f 7269 6769  ""..    if origi
-00064da0: 6e61 6c5f 6172 7261 7920 6973 204e 6f6e  nal_array is Non
-00064db0: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
-00064dc0: 6e20 4e6f 6e65 0a0a 2020 2020 6966 206f  n None..    if o
-00064dd0: 7269 6769 6e61 6c5f 6172 7261 792e 6e64  riginal_array.nd
-00064de0: 696d 203d 3d20 313a 0a20 2020 2020 2020  im == 1:.       
-00064df0: 2023 2052 656d 6f76 6520 656c 656d 656e   # Remove elemen
-00064e00: 7473 2066 726f 6d20 6120 3144 2061 7272  ts from a 1D arr
-00064e10: 6179 0a20 2020 2020 2020 2072 6574 7572  ay.        retur
-00064e20: 6e20 6e70 2e64 656c 6574 6528 6f72 6967  n np.delete(orig
-00064e30: 696e 616c 5f61 7272 6179 2c20 696e 6469  inal_array, indi
-00064e40: 6365 735f 746f 5f72 656d 6f76 6529 0a20  ces_to_remove). 
-00064e50: 2020 2065 6c69 6620 6f72 6967 696e 616c     elif original
-00064e60: 5f61 7272 6179 2e6e 6469 6d20 3d3d 2032  _array.ndim == 2
-00064e70: 3a0a 2020 2020 2020 2020 2320 5265 6d6f  :.        # Remo
-00064e80: 7665 2072 6f77 7320 6672 6f6d 2061 2032  ve rows from a 2
-00064e90: 4420 6172 7261 790a 2020 2020 2020 2020  D array.        
-00064ea0: 7265 7475 726e 206e 702e 6465 6c65 7465  return np.delete
-00064eb0: 286f 7269 6769 6e61 6c5f 6172 7261 792c  (original_array,
-00064ec0: 2069 6e64 6963 6573 5f74 6f5f 7265 6d6f   indices_to_remo
-00064ed0: 7665 2c20 6178 6973 3d30 290a 2020 2020  ve, axis=0).    
-00064ee0: 656c 7365 3a0a 2020 2020 2020 2020 7261  else:.        ra
-00064ef0: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
-00064f00: 6f72 6967 696e 616c 5f61 7272 6179 206d  original_array m
-00064f10: 7573 7420 6265 2065 6974 6865 7220 3144  ust be either 1D
-00064f20: 206f 7220 3244 2e22 290a 0a64 6566 2072   or 2D.")..def r
-00064f30: 656d 6f76 655f 766f 6c75 6d65 735f 6672  emove_volumes_fr
-00064f40: 6f6d 5f74 696d 6573 6572 6965 7328 7469  om_timeseries(ti
-00064f50: 6d65 5f73 6572 6965 732c 2076 6f6c 756d  me_series, volum
-00064f60: 6573 5f74 6f5f 7265 6d6f 7665 293a 0a20  es_to_remove):. 
-00064f70: 2020 2022 2222 0a20 2020 2052 656d 6f76     """.    Remov
-00064f80: 6520 7370 6563 6966 6965 6420 766f 6c75  e specified volu
-00064f90: 6d65 7320 6672 6f6d 2061 2074 696d 6520  mes from a time 
-00064fa0: 7365 7269 6573 2e0a 0a20 2020 203a 7061  series...    :pa
-00064fb0: 7261 6d20 7469 6d65 5f73 6572 6965 733a  ram time_series:
-00064fc0: 2041 4e54 7349 6d61 6765 2072 6570 7265   ANTsImage repre
-00064fd0: 7365 6e74 696e 6720 7468 6520 7469 6d65  senting the time
-00064fe0: 2073 6572 6965 7320 2834 4420 696d 6167   series (4D imag
-00064ff0: 6529 2e0a 2020 2020 3a70 6172 616d 2076  e)..    :param v
-00065000: 6f6c 756d 6573 5f74 6f5f 7265 6d6f 7665  olumes_to_remove
-00065010: 3a20 4c69 7374 206f 6620 766f 6c75 6d65  : List of volume
-00065020: 2069 6e64 6963 6573 2074 6f20 7265 6d6f   indices to remo
-00065030: 7665 2e0a 2020 2020 3a72 6574 7572 6e3a  ve..    :return:
-00065040: 2041 4e54 7349 6d61 6765 2077 6974 6820   ANTsImage with 
-00065050: 7370 6563 6966 6965 6420 766f 6c75 6d65  specified volume
-00065060: 7320 7265 6d6f 7665 642e 0a20 2020 2022  s removed..    "
-00065070: 2222 0a20 2020 2069 6620 6e6f 7420 6973  "".    if not is
-00065080: 696e 7374 616e 6365 2874 696d 655f 7365  instance(time_se
-00065090: 7269 6573 2c20 616e 7473 2e41 4e54 7349  ries, ants.ANTsI
-000650a0: 6d61 6765 293a 0a20 2020 2020 2020 2072  mage):.        r
-000650b0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-000650c0: 2274 696d 655f 7365 7269 6573 206d 7573  "time_series mus
-000650d0: 7420 6265 2061 6e20 414e 5473 496d 6167  t be an ANTsImag
-000650e0: 652e 2229 0a0a 2020 2020 6966 2074 696d  e.")..    if tim
-000650f0: 655f 7365 7269 6573 2e64 696d 656e 7369  e_series.dimensi
-00065100: 6f6e 2021 3d20 343a 0a20 2020 2020 2020  on != 4:.       
-00065110: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00065120: 7228 2274 696d 655f 7365 7269 6573 206d  r("time_series m
-00065130: 7573 7420 6265 2061 2034 4420 696d 6167  ust be a 4D imag
-00065140: 652e 2229 0a0a 2020 2020 2320 4372 6561  e.")..    # Crea
-00065150: 7465 2061 2062 6f6f 6c65 616e 2069 6e64  te a boolean ind
-00065160: 6578 2066 6f72 2076 6f6c 756d 6573 2074  ex for volumes t
-00065170: 6f20 6b65 6570 0a20 2020 2076 6f6c 756d  o keep.    volum
-00065180: 6573 5f74 6f5f 6b65 6570 203d 205b 6920  es_to_keep = [i 
-00065190: 666f 7220 6920 696e 2072 616e 6765 2874  for i in range(t
-000651a0: 696d 655f 7365 7269 6573 2e73 6861 7065  ime_series.shape
-000651b0: 5b33 5d29 2069 6620 6920 6e6f 7420 696e  [3]) if i not in
-000651c0: 2076 6f6c 756d 6573 5f74 6f5f 7265 6d6f   volumes_to_remo
-000651d0: 7665 5d0a 0a20 2020 2023 2053 656c 6563  ve]..    # Selec
-000651e0: 7420 7468 6520 766f 6c75 6d65 7320 746f  t the volumes to
-000651f0: 206b 6565 700a 2020 2020 6669 6c74 6572   keep.    filter
-00065200: 6564 5f74 696d 655f 7365 7269 6573 203d  ed_time_series =
-00065210: 2061 6e74 732e 6672 6f6d 5f6e 756d 7079   ants.from_numpy
-00065220: 2820 7469 6d65 5f73 6572 6965 735b 2e2e  ( time_series[..
-00065230: 2e2c 2076 6f6c 756d 6573 5f74 6f5f 6b65  ., volumes_to_ke
-00065240: 6570 5d20 290a 0a20 2020 2072 6574 7572  ep] )..    retur
-00065250: 6e20 616e 7473 2e63 6f70 795f 696d 6167  n ants.copy_imag
-00065260: 655f 696e 666f 2820 7469 6d65 5f73 6572  e_info( time_ser
-00065270: 6965 732c 2066 696c 7465 7265 645f 7469  ies, filtered_ti
-00065280: 6d65 5f73 6572 6965 7320 290a 0a64 6566  me_series )..def
-00065290: 2072 656d 6f76 655f 656c 656d 656e 7473   remove_elements
-000652a0: 5f66 726f 6d5f 6c69 7374 286f 7269 6769  _from_list(origi
-000652b0: 6e61 6c5f 6c69 7374 2c20 656c 656d 656e  nal_list, elemen
-000652c0: 7473 5f74 6f5f 7265 6d6f 7665 293a 0a20  ts_to_remove):. 
-000652d0: 2020 2022 2222 0a20 2020 2052 656d 6f76     """.    Remov
-000652e0: 6520 7370 6563 6966 6965 6420 656c 656d  e specified elem
-000652f0: 656e 7473 2066 726f 6d20 6120 6c69 7374  ents from a list
-00065300: 2e0a 0a20 2020 2050 6172 616d 6574 6572  ...    Parameter
-00065310: 733a 0a20 2020 206f 7269 6769 6e61 6c5f  s:.    original_
-00065320: 6c69 7374 2028 6c69 7374 293a 2054 6865  list (list): The
-00065330: 206f 7269 6769 6e61 6c20 6c69 7374 2066   original list f
-00065340: 726f 6d20 7768 6963 6820 656c 656d 656e  rom which elemen
-00065350: 7473 2077 696c 6c20 6265 2072 656d 6f76  ts will be remov
-00065360: 6564 2e0a 2020 2020 656c 656d 656e 7473  ed..    elements
-00065370: 5f74 6f5f 7265 6d6f 7665 2028 6c69 7374  _to_remove (list
-00065380: 293a 2041 206c 6973 7420 6f66 2065 6c65  ): A list of ele
-00065390: 6d65 6e74 7320 7468 6174 206e 6565 6420  ments that need 
-000653a0: 746f 2062 6520 7265 6d6f 7665 6420 6672  to be removed fr
-000653b0: 6f6d 2074 6865 206f 7269 6769 6e61 6c20  om the original 
-000653c0: 6c69 7374 2e0a 0a20 2020 2052 6574 7572  list...    Retur
-000653d0: 6e73 3a0a 2020 2020 6c69 7374 3a20 4120  ns:.    list: A 
-000653e0: 6e65 7720 6c69 7374 2077 6974 6820 7468  new list with th
-000653f0: 6520 7370 6563 6966 6965 6420 656c 656d  e specified elem
-00065400: 656e 7473 2072 656d 6f76 6564 2e0a 2020  ents removed..  
-00065410: 2020 2222 220a 2020 2020 7265 7475 726e    """.    return
-00065420: 205b 656c 656d 656e 7420 666f 7220 656c   [element for el
-00065430: 656d 656e 7420 696e 206f 7269 6769 6e61  ement in origina
-00065440: 6c5f 6c69 7374 2069 6620 656c 656d 656e  l_list if elemen
-00065450: 7420 6e6f 7420 696e 2065 6c65 6d65 6e74  t not in element
-00065460: 735f 746f 5f72 656d 6f76 655d 0a0a 0a64  s_to_remove]...d
-00065470: 6566 2069 6d70 7574 655f 7469 6d65 7365  ef impute_timese
-00065480: 7269 6573 2874 696d 655f 7365 7269 6573  ries(time_series
-00065490: 2c20 766f 6c75 6d65 735f 746f 5f69 6d70  , volumes_to_imp
-000654a0: 7574 652c 206d 6574 686f 643d 276c 696e  ute, method='lin
-000654b0: 6561 7227 2c20 7665 7262 6f73 653d 4661  ear', verbose=Fa
-000654c0: 6c73 6529 3a0a 2020 2020 2222 220a 2020  lse):.    """.  
-000654d0: 2020 496d 7075 7465 2073 7065 6369 6669    Impute specifi
-000654e0: 6564 2076 6f6c 756d 6573 2066 726f 6d20  ed volumes from 
-000654f0: 6120 7469 6d65 2073 6572 6965 7320 7769  a time series wi
-00065500: 7468 2069 6e74 6572 706f 6c61 7465 6420  th interpolated 
-00065510: 7661 6c75 6573 2e0a 0a20 2020 203a 7061  values...    :pa
-00065520: 7261 6d20 7469 6d65 5f73 6572 6965 733a  ram time_series:
-00065530: 2041 4e54 7349 6d61 6765 2072 6570 7265   ANTsImage repre
-00065540: 7365 6e74 696e 6720 7468 6520 7469 6d65  senting the time
-00065550: 2073 6572 6965 7320 2834 4420 696d 6167   series (4D imag
-00065560: 6529 2e0a 2020 2020 3a70 6172 616d 2076  e)..    :param v
-00065570: 6f6c 756d 6573 5f74 6f5f 696d 7075 7465  olumes_to_impute
-00065580: 3a20 4c69 7374 206f 6620 766f 6c75 6d65  : List of volume
-00065590: 2069 6e64 6963 6573 2074 6f20 696d 7075   indices to impu
-000655a0: 7465 2e0a 2020 2020 3a70 6172 616d 206d  te..    :param m
-000655b0: 6574 686f 643a 2049 6e74 6572 706f 6c61  ethod: Interpola
-000655c0: 7469 6f6e 206d 6574 686f 6420 2827 6c69  tion method ('li
-000655d0: 6e65 6172 2720 6f72 206f 7468 6572 206d  near' or other m
-000655e0: 6574 686f 6473 2069 6620 696d 706c 656d  ethods if implem
-000655f0: 656e 7465 6429 2e0a 2020 2020 3a70 6172  ented)..    :par
-00065600: 616d 2076 6572 626f 7365 3a20 626f 6f6c  am verbose: bool
-00065610: 6561 6e0a 2020 2020 3a72 6574 7572 6e3a  ean.    :return:
-00065620: 2041 4e54 7349 6d61 6765 2077 6974 6820   ANTsImage with 
-00065630: 7370 6563 6966 6965 6420 766f 6c75 6d65  specified volume
-00065640: 7320 696d 7075 7465 642e 0a20 2020 2022  s imputed..    "
-00065650: 2222 0a20 2020 2069 6620 6e6f 7420 6973  "".    if not is
-00065660: 696e 7374 616e 6365 2874 696d 655f 7365  instance(time_se
-00065670: 7269 6573 2c20 616e 7473 2e41 4e54 7349  ries, ants.ANTsI
-00065680: 6d61 6765 293a 0a20 2020 2020 2020 2072  mage):.        r
-00065690: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-000656a0: 2274 696d 655f 7365 7269 6573 206d 7573  "time_series mus
-000656b0: 7420 6265 2061 6e20 414e 5473 496d 6167  t be an ANTsImag
-000656c0: 652e 2229 0a0a 2020 2020 6966 2074 696d  e.")..    if tim
-000656d0: 655f 7365 7269 6573 2e64 696d 656e 7369  e_series.dimensi
-000656e0: 6f6e 2021 3d20 343a 0a20 2020 2020 2020  on != 4:.       
-000656f0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00065700: 7228 2274 696d 655f 7365 7269 6573 206d  r("time_series m
-00065710: 7573 7420 6265 2061 2034 4420 696d 6167  ust be a 4D imag
-00065720: 652e 2229 0a0a 2020 2020 2320 436f 6e76  e.")..    # Conv
-00065730: 6572 7420 7469 6d65 5f73 6572 6965 7320  ert time_series 
-00065740: 746f 206e 756d 7079 2066 6f72 206d 616e  to numpy for man
-00065750: 6970 756c 6174 696f 6e0a 2020 2020 7469  ipulation.    ti
-00065760: 6d65 5f73 6572 6965 735f 6e70 203d 2074  me_series_np = t
-00065770: 696d 655f 7365 7269 6573 2e6e 756d 7079  ime_series.numpy
-00065780: 2829 0a20 2020 2074 6f74 616c 5f76 6f6c  ().    total_vol
-00065790: 756d 6573 203d 2074 696d 655f 7365 7269  umes = time_seri
-000657a0: 6573 5f6e 702e 7368 6170 655b 335d 0a0a  es_np.shape[3]..
-000657b0: 2020 2020 2320 4372 6561 7465 2061 2063      # Create a c
-000657c0: 6f6d 706c 656d 656e 7420 6c69 7374 206f  omplement list o
-000657d0: 6620 766f 6c75 6d65 7320 6e6f 7420 746f  f volumes not to
-000657e0: 2069 6d70 7574 650a 2020 2020 766f 6c75   impute.    volu
-000657f0: 6d65 735f 6e6f 745f 746f 5f69 6d70 7574  mes_not_to_imput
-00065800: 6520 3d20 5b69 2066 6f72 2069 2069 6e20  e = [i for i in 
-00065810: 7261 6e67 6528 746f 7461 6c5f 766f 6c75  range(total_volu
-00065820: 6d65 7329 2069 6620 6920 6e6f 7420 696e  mes) if i not in
-00065830: 2076 6f6c 756d 6573 5f74 6f5f 696d 7075   volumes_to_impu
-00065840: 7465 5d0a 0a20 2020 2023 2044 6566 696e  te]..    # Defin
-00065850: 6520 7468 6520 6c6f 7765 7220 616e 6420  e the lower and 
-00065860: 7570 7065 7220 626f 756e 6473 0a20 2020  upper bounds.   
-00065870: 206d 696e 5f76 616c 6964 5f69 6e64 6578   min_valid_index
-00065880: 203d 206d 696e 2876 6f6c 756d 6573 5f6e   = min(volumes_n
-00065890: 6f74 5f74 6f5f 696d 7075 7465 290a 2020  ot_to_impute).  
-000658a0: 2020 6d61 785f 7661 6c69 645f 696e 6465    max_valid_inde
-000658b0: 7820 3d20 6d61 7828 766f 6c75 6d65 735f  x = max(volumes_
-000658c0: 6e6f 745f 746f 5f69 6d70 7574 6529 0a0a  not_to_impute)..
-000658d0: 2020 2020 666f 7220 766f 6c5f 6964 7820      for vol_idx 
-000658e0: 696e 2076 6f6c 756d 6573 5f74 6f5f 696d  in volumes_to_im
-000658f0: 7075 7465 3a0a 2020 2020 2020 2020 2320  pute:.        # 
-00065900: 456e 7375 7265 2074 6865 2076 6f6c 756d  Ensure the volum
-00065910: 6520 696e 6465 7820 6973 2077 6974 6869  e index is withi
-00065920: 6e20 7468 6520 7661 6c69 6420 7261 6e67  n the valid rang
-00065930: 650a 2020 2020 2020 2020 6966 2076 6f6c  e.        if vol
-00065940: 5f69 6478 203c 2030 206f 7220 766f 6c5f  _idx < 0 or vol_
-00065950: 6964 7820 3e3d 2074 6f74 616c 5f76 6f6c  idx >= total_vol
-00065960: 756d 6573 3a0a 2020 2020 2020 2020 2020  umes:.          
-00065970: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00065980: 6f72 2866 2256 6f6c 756d 6520 696e 6465  or(f"Volume inde
-00065990: 7820 7b76 6f6c 5f69 6478 7d20 6973 206f  x {vol_idx} is o
-000659a0: 7574 206f 6620 626f 756e 6473 2e22 290a  ut of bounds.").
-000659b0: 0a20 2020 2020 2020 2023 2046 696e 6420  .        # Find 
-000659c0: 7468 6520 6e65 6172 6573 7420 7661 6c69  the nearest vali
-000659d0: 6420 6c6f 7765 7220 696e 6465 7820 7769  d lower index wi
-000659e0: 7468 696e 2074 6865 2062 6f75 6e64 730a  thin the bounds.
-000659f0: 2020 2020 2020 2020 6c6f 7765 725f 6361          lower_ca
-00065a00: 6e64 6964 6174 6573 203d 205b 7620 666f  ndidates = [v fo
-00065a10: 7220 7620 696e 2076 6f6c 756d 6573 5f6e  r v in volumes_n
-00065a20: 6f74 5f74 6f5f 696d 7075 7465 2069 6620  ot_to_impute if 
-00065a30: 7620 3c3d 2076 6f6c 5f69 6478 5d0a 2020  v <= vol_idx].  
-00065a40: 2020 2020 2020 6c6f 7765 725f 6964 7820        lower_idx 
-00065a50: 3d20 6d61 7828 6c6f 7765 725f 6361 6e64  = max(lower_cand
-00065a60: 6964 6174 6573 2920 6966 206c 6f77 6572  idates) if lower
-00065a70: 5f63 616e 6469 6461 7465 7320 656c 7365  _candidates else
-00065a80: 206d 696e 5f76 616c 6964 5f69 6e64 6578   min_valid_index
-00065a90: 0a0a 2020 2020 2020 2020 2320 4669 6e64  ..        # Find
-00065aa0: 2074 6865 206e 6561 7265 7374 2076 616c   the nearest val
-00065ab0: 6964 2075 7070 6572 2069 6e64 6578 2077  id upper index w
-00065ac0: 6974 6869 6e20 7468 6520 626f 756e 6473  ithin the bounds
-00065ad0: 0a20 2020 2020 2020 2075 7070 6572 5f63  .        upper_c
-00065ae0: 616e 6469 6461 7465 7320 3d20 5b76 2066  andidates = [v f
-00065af0: 6f72 2076 2069 6e20 766f 6c75 6d65 735f  or v in volumes_
-00065b00: 6e6f 745f 746f 5f69 6d70 7574 6520 6966  not_to_impute if
-00065b10: 2076 203e 3d20 766f 6c5f 6964 785d 0a20   v >= vol_idx]. 
-00065b20: 2020 2020 2020 2075 7070 6572 5f69 6478         upper_idx
-00065b30: 203d 206d 696e 2875 7070 6572 5f63 616e   = min(upper_can
-00065b40: 6469 6461 7465 7329 2069 6620 7570 7065  didates) if uppe
-00065b50: 725f 6361 6e64 6964 6174 6573 2065 6c73  r_candidates els
-00065b60: 6520 6d61 785f 7661 6c69 645f 696e 6465  e max_valid_inde
-00065b70: 780a 0a20 2020 2020 2020 2069 6620 7665  x..        if ve
-00065b80: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
-00065b90: 2020 2070 7269 6e74 2866 2249 6d70 7574     print(f"Imput
-00065ba0: 696e 6720 766f 6c75 6d65 207b 766f 6c5f  ing volume {vol_
-00065bb0: 6964 787d 2075 7369 6e67 2069 6e64 6963  idx} using indic
-00065bc0: 6573 207b 6c6f 7765 725f 6964 787d 2061  es {lower_idx} a
-00065bd0: 6e64 207b 7570 7065 725f 6964 787d 2229  nd {upper_idx}")
-00065be0: 0a0a 2020 2020 2020 2020 6966 206d 6574  ..        if met
-00065bf0: 686f 6420 3d3d 2027 6c69 6e65 6172 273a  hod == 'linear':
-00065c00: 0a20 2020 2020 2020 2020 2020 2023 204c  .            # L
-00065c10: 696e 6561 7220 696e 7465 7270 6f6c 6174  inear interpolat
-00065c20: 696f 6e20 6265 7477 6565 6e20 7468 6520  ion between the 
-00065c30: 7477 6f20 6e65 6172 6573 7420 766f 6c75  two nearest volu
-00065c40: 6d65 730a 2020 2020 2020 2020 2020 2020  mes.            
-00065c50: 6c6f 7765 725f 766f 6c75 6d65 203d 2074  lower_volume = t
-00065c60: 696d 655f 7365 7269 6573 5f6e 705b 2e2e  ime_series_np[..
-00065c70: 2e2c 206c 6f77 6572 5f69 6478 5d0a 2020  ., lower_idx].  
-00065c80: 2020 2020 2020 2020 2020 7570 7065 725f            upper_
-00065c90: 766f 6c75 6d65 203d 2074 696d 655f 7365  volume = time_se
-00065ca0: 7269 6573 5f6e 705b 2e2e 2e2c 2075 7070  ries_np[..., upp
-00065cb0: 6572 5f69 6478 5d0a 2020 2020 2020 2020  er_idx].        
-00065cc0: 2020 2020 696e 7465 7270 6f6c 6174 6564      interpolated
-00065cd0: 5f76 6f6c 756d 6520 3d20 286c 6f77 6572  _volume = (lower
-00065ce0: 5f76 6f6c 756d 6520 2b20 7570 7065 725f  _volume + upper_
-00065cf0: 766f 6c75 6d65 2920 2f20 320a 2020 2020  volume) / 2.    
-00065d00: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00065d10: 2020 2020 2020 2320 506c 6163 6568 6f6c        # Placehol
-00065d20: 6465 7220 666f 7220 6f74 6865 7220 696e  der for other in
-00065d30: 7465 7270 6f6c 6174 696f 6e20 6d65 7468  terpolation meth
-00065d40: 6f64 730a 2020 2020 2020 2020 2020 2020  ods.            
-00065d50: 7261 6973 6520 4e6f 7449 6d70 6c65 6d65  raise NotImpleme
-00065d60: 6e74 6564 4572 726f 7228 2243 7572 7265  ntedError("Curre
-00065d70: 6e74 6c79 2c20 6f6e 6c79 206c 696e 6561  ntly, only linea
-00065d80: 7220 696e 7465 7270 6f6c 6174 696f 6e20  r interpolation 
-00065d90: 6973 2069 6d70 6c65 6d65 6e74 6564 2e22  is implemented."
-00065da0: 290a 0a20 2020 2020 2020 2023 2052 6570  )..        # Rep
-00065db0: 6c61 6365 2074 6865 2073 7065 6369 6669  lace the specifi
-00065dc0: 6564 2076 6f6c 756d 6520 7769 7468 2074  ed volume with t
-00065dd0: 6865 2069 6e74 6572 706f 6c61 7465 6420  he interpolated 
-00065de0: 766f 6c75 6d65 0a20 2020 2020 2020 2074  volume.        t
-00065df0: 696d 655f 7365 7269 6573 5f6e 705b 2e2e  ime_series_np[..
-00065e00: 2e2c 2076 6f6c 5f69 6478 5d20 3d20 696e  ., vol_idx] = in
-00065e10: 7465 7270 6f6c 6174 6564 5f76 6f6c 756d  terpolated_volum
-00065e20: 650a 0a20 2020 2023 2043 6f6e 7665 7274  e..    # Convert
-00065e30: 2074 6865 206e 756d 7079 2061 7272 6179   the numpy array
-00065e40: 2062 6163 6b20 746f 2041 4e54 7349 6d61   back to ANTsIma
-00065e50: 6765 0a20 2020 2069 6d70 7574 6564 5f74  ge.    imputed_t
-00065e60: 696d 655f 7365 7269 6573 203d 2061 6e74  ime_series = ant
-00065e70: 732e 6672 6f6d 5f6e 756d 7079 2874 696d  s.from_numpy(tim
-00065e80: 655f 7365 7269 6573 5f6e 7029 0a20 2020  e_series_np).   
-00065e90: 2069 6d70 7574 6564 5f74 696d 655f 7365   imputed_time_se
-00065ea0: 7269 6573 203d 2061 6e74 732e 636f 7079  ries = ants.copy
-00065eb0: 5f69 6d61 6765 5f69 6e66 6f28 7469 6d65  _image_info(time
-00065ec0: 5f73 6572 6965 732c 2069 6d70 7574 6564  _series, imputed
-00065ed0: 5f74 696d 655f 7365 7269 6573 290a 0a20  _time_series).. 
-00065ee0: 2020 2072 6574 7572 6e20 696d 7075 7465     return impute
-00065ef0: 645f 7469 6d65 5f73 6572 6965 730a 0a64  d_time_series..d
-00065f00: 6566 2069 6d70 7574 655f 6477 6928 2064  ef impute_dwi( d
-00065f10: 7769 2c20 7468 7265 7368 6f6c 6420 3d20  wi, threshold = 
-00065f20: 302e 3230 2c20 696d 7075 7465 6230 3d46  0.20, imputeb0=F
-00065f30: 616c 7365 2c20 6d61 736b 3d4e 6f6e 652c  alse, mask=None,
-00065f40: 2076 6572 626f 7365 3d46 616c 7365 2029   verbose=False )
-00065f50: 3a0a 2020 2020 2222 220a 2020 2020 4964  :.    """.    Id
-00065f60: 656e 7469 6679 2062 6164 2076 6f6c 756d  entify bad volum
-00065f70: 6573 2069 6e20 6120 6477 6920 616e 6420  es in a dwi and 
-00065f80: 696d 7075 7465 2074 6865 6d20 6675 6c6c  impute them full
-00065f90: 7920 6175 746f 6d61 7469 6361 6c6c 792e  y automatically.
-00065fa0: 0a0a 2020 2020 3a70 6172 616d 2064 7769  ..    :param dwi
-00065fb0: 3a20 414e 5473 496d 6167 6520 7265 7072  : ANTsImage repr
-00065fc0: 6573 656e 7469 6e67 2074 6865 2074 696d  esenting the tim
-00065fd0: 6520 7365 7269 6573 2028 3444 2069 6d61  e series (4D ima
-00065fe0: 6765 292e 0a20 2020 203a 7061 7261 6d20  ge)..    :param 
-00065ff0: 7468 7265 7368 6f6c 643a 2074 6872 6573  threshold: thres
-00066000: 686f 6c64 2028 302c 3129 2066 6f72 206f  hold (0,1) for o
-00066010: 7574 6c69 6572 6e65 7373 2028 6c6f 7765  utlierness (lowe
-00066020: 7220 6d65 616e 7320 696d 7075 7465 206d  r means impute m
-00066030: 6f72 6520 6461 7461 290a 2020 2020 3a70  ore data).    :p
-00066040: 6172 616d 2069 6d70 7574 6562 303a 2062  aram imputeb0: b
-00066050: 6f6f 6c65 616e 2077 696c 6c20 696d 7075  oolean will impu
-00066060: 7465 2074 6865 2062 3020 7769 7468 2064  te the b0 with d
-00066070: 7769 2069 6620 5472 7565 0a20 2020 203a  wi if True.    :
-00066080: 7061 7261 6d20 6d61 736b 3a20 7265 7374  param mask: rest
-00066090: 7269 6374 7320 746f 2061 2072 6567 696f  ricts to a regio
-000660a0: 6e20 6f66 2069 6e74 6572 6573 740a 2020  n of interest.  
-000660b0: 2020 3a70 6172 616d 2076 6572 626f 7365    :param verbose
-000660c0: 3a20 626f 6f6c 6561 6e0a 2020 2020 3a72  : boolean.    :r
-000660d0: 6574 7572 6e3a 2041 4e54 7349 6d61 6765  eturn: ANTsImage
-000660e0: 2061 7574 6f6d 6174 6963 616c 6c79 2069   automatically i
-000660f0: 6d70 7574 6564 2e0a 2020 2020 2222 220a  mputed..    """.
-00066100: 2020 2020 6c69 7374 3120 3d20 7365 676d      list1 = segm
-00066110: 656e 745f 7469 6d65 7365 7269 6573 5f62  ent_timeseries_b
-00066120: 795f 6d65 616e 7661 6c75 6528 2064 7769  y_meanvalue( dwi
-00066130: 2029 5b27 6869 6768 6572 6d65 616e 7327   )['highermeans'
-00066140: 5d0a 2020 2020 6966 2069 6d70 7574 6562  ].    if imputeb
-00066150: 303a 0a20 2020 2020 2020 2064 7769 6220  0:.        dwib 
-00066160: 3d20 696d 7075 7465 5f74 696d 6573 6572  = impute_timeser
-00066170: 6965 7328 2064 7769 2c20 6c69 7374 3120  ies( dwi, list1 
-00066180: 2920 2320 666f 6375 7320 6f6e 2074 6865  ) # focus on the
-00066190: 2064 7769 202d 206e 6f74 2074 6865 2062   dwi - not the b
-000661a0: 300a 2020 2020 2020 2020 6c6f 6f70 6564  0.        looped
-000661b0: 2c20 6c69 7374 3220 3d20 6c6f 6f70 5f74  , list2 = loop_t
-000661c0: 696d 6573 6572 6965 735f 6365 6e73 6f72  imeseries_censor
-000661d0: 696e 6728 2064 7769 622c 2074 6872 6573  ing( dwib, thres
-000661e0: 686f 6c64 2c20 6d61 736b 2029 0a20 2020  hold, mask ).   
-000661f0: 2065 6c73 653a 0a20 2020 2020 2020 206c   else:.        l
-00066200: 6f6f 7065 642c 206c 6973 7432 203d 206c  ooped, list2 = l
-00066210: 6f6f 705f 7469 6d65 7365 7269 6573 5f63  oop_timeseries_c
-00066220: 656e 736f 7269 6e67 2820 6477 692c 2074  ensoring( dwi, t
-00066230: 6872 6573 686f 6c64 2c20 6d61 736b 2029  hreshold, mask )
-00066240: 0a20 2020 2069 6620 7665 7262 6f73 653a  .    if verbose:
-00066250: 0a20 2020 2020 2020 2070 7269 6e74 2820  .        print( 
-00066260: 6c69 7374 3120 290a 2020 2020 2020 2020  list1 ).        
-00066270: 7072 696e 7428 206c 6973 7432 2029 0a20  print( list2 ). 
-00066280: 2020 2063 6f6d 706c 656d 656e 7420 3d20     complement = 
-00066290: 7265 6d6f 7665 5f65 6c65 6d65 6e74 735f  remove_elements_
-000662a0: 6672 6f6d 5f6c 6973 7428 206c 6973 7432  from_list( list2
-000662b0: 2c20 6c69 7374 3120 290a 2020 2020 6966  , list1 ).    if
-000662c0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-000662d0: 2020 7072 696e 7428 2022 496d 7075 7469    print( "Imputi
-000662e0: 6e67 3a22 290a 2020 2020 2020 2020 7072  ng:").        pr
-000662f0: 696e 7428 2063 6f6d 706c 656d 656e 7420  int( complement 
-00066300: 290a 2020 2020 6966 206c 656e 2820 636f  ).    if len( co
-00066310: 6d70 6c65 6d65 6e74 2029 203d 3d20 303a  mplement ) == 0:
-00066320: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00066330: 6477 690a 2020 2020 7265 7475 726e 2069  dwi.    return i
-00066340: 6d70 7574 655f 7469 6d65 7365 7269 6573  mpute_timeseries
-00066350: 2820 6477 692c 2063 6f6d 706c 656d 656e  ( dwi, complemen
-00066360: 7420 290a 0a64 6566 2063 656e 736f 725f  t )..def censor_
-00066370: 6477 6928 2064 7769 2c20 6276 616c 2c20  dwi( dwi, bval, 
-00066380: 6276 6563 2c20 7468 7265 7368 6f6c 6420  bvec, threshold 
-00066390: 3d20 302e 3230 2c20 696d 7075 7465 6230  = 0.20, imputeb0
-000663a0: 3d46 616c 7365 2c20 6d61 736b 3d4e 6f6e  =False, mask=Non
-000663b0: 652c 2076 6572 626f 7365 3d46 616c 7365  e, verbose=False
-000663c0: 2029 3a0a 2020 2020 2222 220a 2020 2020   ):.    """.    
-000663d0: 4964 656e 7469 6679 2062 6164 2076 6f6c  Identify bad vol
-000663e0: 756d 6573 2069 6e20 6120 6477 6920 616e  umes in a dwi an
-000663f0: 6420 696d 7075 7465 2074 6865 6d20 6675  d impute them fu
-00066400: 6c6c 7920 6175 746f 6d61 7469 6361 6c6c  lly automaticall
-00066410: 792e 0a0a 2020 2020 3a70 6172 616d 2064  y...    :param d
-00066420: 7769 3a20 414e 5473 496d 6167 6520 7265  wi: ANTsImage re
-00066430: 7072 6573 656e 7469 6e67 2074 6865 2074  presenting the t
-00066440: 696d 6520 7365 7269 6573 2028 3444 2069  ime series (4D i
-00066450: 6d61 6765 292e 0a20 2020 203a 7061 7261  mage)..    :para
-00066460: 6d20 6276 616c 3a20 6276 616c 2061 7272  m bval: bval arr
-00066470: 6179 0a20 2020 203a 7061 7261 6d20 6276  ay.    :param bv
-00066480: 6563 3a20 6276 6563 2061 7272 6179 0a20  ec: bvec array. 
-00066490: 2020 203a 7061 7261 6d20 7468 7265 7368     :param thresh
-000664a0: 6f6c 643a 2074 6872 6573 686f 6c64 2028  old: threshold (
-000664b0: 302c 3129 2066 6f72 206f 7574 6c69 6572  0,1) for outlier
-000664c0: 6e65 7373 2028 6c6f 7765 7220 6d65 616e  ness (lower mean
-000664d0: 7320 696d 7075 7465 206d 6f72 6520 6461  s impute more da
-000664e0: 7461 290a 2020 2020 3a70 6172 616d 2069  ta).    :param i
-000664f0: 6d70 7574 6562 303a 2062 6f6f 6c65 616e  mputeb0: boolean
-00066500: 2077 696c 6c20 696d 7075 7465 2074 6865   will impute the
-00066510: 2062 3020 7769 7468 2064 7769 2069 6620   b0 with dwi if 
-00066520: 5472 7565 0a20 2020 203a 7061 7261 6d20  True.    :param 
-00066530: 6d61 736b 3a20 7265 7374 7269 6374 7320  mask: restricts 
-00066540: 746f 2061 2072 6567 696f 6e20 6f66 2069  to a region of i
-00066550: 6e74 6572 6573 740a 2020 2020 3a70 6172  nterest.    :par
-00066560: 616d 2076 6572 626f 7365 3a20 626f 6f6c  am verbose: bool
-00066570: 6561 6e0a 2020 2020 3a72 6574 7572 6e3a  ean.    :return:
-00066580: 2041 4e54 7349 6d61 6765 2061 7574 6f6d   ANTsImage autom
-00066590: 6174 6963 616c 6c79 2069 6d70 7574 6564  atically imputed
-000665a0: 2e0a 2020 2020 2222 220a 2020 2020 6c69  ..    """.    li
-000665b0: 7374 3120 3d20 7365 676d 656e 745f 7469  st1 = segment_ti
-000665c0: 6d65 7365 7269 6573 5f62 795f 6d65 616e  meseries_by_mean
-000665d0: 7661 6c75 6528 2064 7769 2029 5b27 6869  value( dwi )['hi
-000665e0: 6768 6572 6d65 616e 7327 5d0a 2020 2020  ghermeans'].    
-000665f0: 6966 2069 6d70 7574 6562 303a 0a20 2020  if imputeb0:.   
-00066600: 2020 2020 2064 7769 6220 3d20 696d 7075       dwib = impu
-00066610: 7465 5f74 696d 6573 6572 6965 7328 2064  te_timeseries( d
-00066620: 7769 2c20 6c69 7374 3120 2920 2320 666f  wi, list1 ) # fo
-00066630: 6375 7320 6f6e 2074 6865 2064 7769 202d  cus on the dwi -
-00066640: 206e 6f74 2074 6865 2062 300a 2020 2020   not the b0.    
-00066650: 2020 2020 6c6f 6f70 6564 2c20 6c69 7374      looped, list
-00066660: 3220 3d20 6c6f 6f70 5f74 696d 6573 6572  2 = loop_timeser
-00066670: 6965 735f 6365 6e73 6f72 696e 6728 2064  ies_censoring( d
-00066680: 7769 622c 2074 6872 6573 686f 6c64 2c20  wib, threshold, 
-00066690: 6d61 736b 2029 0a20 2020 2065 6c73 653a  mask ).    else:
-000666a0: 0a20 2020 2020 2020 206c 6f6f 7065 642c  .        looped,
-000666b0: 206c 6973 7432 203d 206c 6f6f 705f 7469   list2 = loop_ti
-000666c0: 6d65 7365 7269 6573 5f63 656e 736f 7269  meseries_censori
-000666d0: 6e67 2820 6477 692c 2074 6872 6573 686f  ng( dwi, thresho
-000666e0: 6c64 2c20 6d61 736b 2029 0a20 2020 2069  ld, mask ).    i
-000666f0: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-00066700: 2020 2070 7269 6e74 2820 6c69 7374 3120     print( list1 
-00066710: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
-00066720: 206c 6973 7432 2029 0a20 2020 2063 6f6d   list2 ).    com
-00066730: 706c 656d 656e 7420 3d20 7265 6d6f 7665  plement = remove
-00066740: 5f65 6c65 6d65 6e74 735f 6672 6f6d 5f6c  _elements_from_l
-00066750: 6973 7428 206c 6973 7432 2c20 6c69 7374  ist( list2, list
-00066760: 3120 290a 2020 2020 6966 2076 6572 626f  1 ).    if verbo
-00066770: 7365 3a0a 2020 2020 2020 2020 7072 696e  se:.        prin
-00066780: 7428 2022 6365 6e73 6f72 696e 673a 2229  t( "censoring:")
-00066790: 0a20 2020 2020 2020 2070 7269 6e74 2820  .        print( 
-000667a0: 636f 6d70 6c65 6d65 6e74 2029 0a20 2020  complement ).   
-000667b0: 2069 6620 6c65 6e28 2063 6f6d 706c 656d   if len( complem
-000667c0: 656e 7420 2920 3d3d 2030 3a0a 2020 2020  ent ) == 0:.    
-000667d0: 2020 2020 7265 7475 726e 2064 7769 2c20      return dwi, 
-000667e0: 6276 616c 2c20 6276 6563 0a20 2020 2072  bval, bvec.    r
-000667f0: 6574 7572 6e20 7265 6d6f 7665 5f76 6f6c  eturn remove_vol
-00066800: 756d 6573 5f66 726f 6d5f 7469 6d65 7365  umes_from_timese
-00066810: 7269 6573 2820 6477 692c 2063 6f6d 706c  ries( dwi, compl
-00066820: 656d 656e 7420 292c 2072 656d 6f76 655f  ement ), remove_
-00066830: 656c 656d 656e 7473 5f66 726f 6d5f 6e75  elements_from_nu
-00066840: 6d70 795f 6172 7261 7928 2062 7661 6c2c  mpy_array( bval,
-00066850: 2063 6f6d 706c 656d 656e 7420 292c 2072   complement ), r
-00066860: 656d 6f76 655f 656c 656d 656e 7473 5f66  emove_elements_f
-00066870: 726f 6d5f 6e75 6d70 795f 6172 7261 7928  rom_numpy_array(
-00066880: 2062 7665 632c 2063 6f6d 706c 656d 656e   bvec, complemen
-00066890: 7420 290a 0a0a 6465 6620 666c 6174 7465  t )...def flatte
-000668a0: 6e5f 7469 6d65 5f73 6572 6965 7328 7469  n_time_series(ti
-000668b0: 6d65 5f73 6572 6965 7329 3a0a 2020 2020  me_series):.    
-000668c0: 2222 220a 2020 2020 466c 6174 7465 6e20  """.    Flatten 
-000668d0: 6120 3444 2074 696d 6520 7365 7269 6573  a 4D time series
-000668e0: 2069 6e74 6f20 6120 3244 2061 7272 6179   into a 2D array
-000668f0: 2e0a 2020 2020 0a20 2020 203a 7061 7261  ..    .    :para
-00066900: 6d20 7469 6d65 5f73 6572 6965 733a 2041  m time_series: A
-00066910: 2034 4420 6e75 6d70 7920 6172 7261 7920   4D numpy array 
-00066920: 7768 6572 6520 7468 6520 6c61 7374 2064  where the last d
-00066930: 696d 656e 7369 6f6e 2069 7320 7469 6d65  imension is time
-00066940: 2e0a 2020 2020 3a72 6574 7572 6e3a 2041  ..    :return: A
-00066950: 2032 4420 6e75 6d70 7920 6172 7261 7920   2D numpy array 
-00066960: 7768 6572 6520 6561 6368 2072 6f77 2069  where each row i
-00066970: 7320 6120 666c 6174 7465 6e65 6420 766f  s a flattened vo
-00066980: 6c75 6d65 2e0a 2020 2020 2222 220a 2020  lume..    """.  
-00066990: 2020 6e5f 766f 6c75 6d65 7320 3d20 7469    n_volumes = ti
-000669a0: 6d65 5f73 6572 6965 732e 7368 6170 655b  me_series.shape[
-000669b0: 335d 0a20 2020 2072 6574 7572 6e20 7469  3].    return ti
-000669c0: 6d65 5f73 6572 6965 732e 7265 7368 6170  me_series.reshap
-000669d0: 6528 2d31 2c20 6e5f 766f 6c75 6d65 7329  e(-1, n_volumes)
-000669e0: 2e54 0a0a 6465 6620 6361 6c63 756c 6174  .T..def calculat
-000669f0: 655f 6c6f 6f70 5f73 636f 7265 7328 666c  e_loop_scores(fl
-00066a00: 6174 7465 6e65 645f 7365 7269 6573 2c20  attened_series, 
-00066a10: 6e5f 6e65 6967 6862 6f72 733d 3230 293a  n_neighbors=20):
-00066a20: 0a20 2020 2022 2222 0a20 2020 2043 616c  .    """.    Cal
-00066a30: 6375 6c61 7465 204c 6f63 616c 204f 7574  culate Local Out
-00066a40: 6c69 6572 2050 726f 6261 6269 6c69 7469  lier Probabiliti
-00066a50: 6573 2066 6f72 2065 6163 6820 766f 6c75  es for each volu
-00066a60: 6d65 2e0a 2020 2020 0a20 2020 203a 7061  me..    .    :pa
-00066a70: 7261 6d20 666c 6174 7465 6e65 645f 7365  ram flattened_se
-00066a80: 7269 6573 3a20 4120 3244 206e 756d 7079  ries: A 2D numpy
-00066a90: 2061 7272 6179 2066 726f 6d20 666c 6174   array from flat
-00066aa0: 7465 6e5f 7469 6d65 5f73 6572 6965 732e  ten_time_series.
-00066ab0: 0a20 2020 203a 7061 7261 6d20 6e5f 6e65  .    :param n_ne
-00066ac0: 6967 6862 6f72 733a 204e 756d 6265 7220  ighbors: Number 
-00066ad0: 6f66 206e 6569 6768 626f 7273 2074 6f20  of neighbors to 
-00066ae0: 7573 6520 666f 7220 6361 6c63 756c 6174  use for calculat
-00066af0: 696e 6720 4c4f 4620 7363 6f72 6573 2e0a  ing LOF scores..
-00066b00: 2020 2020 3a72 6574 7572 6e3a 2041 6e20      :return: An 
-00066b10: 6172 7261 7920 6f66 204c 6f4f 5020 7363  array of LoOP sc
-00066b20: 6f72 6573 2e0a 2020 2020 2222 220a 2020  ores..    """.  
-00066b30: 2020 6672 6f6d 2050 794e 6f6d 616c 7920    from PyNomaly 
-00066b40: 696d 706f 7274 206c 6f6f 700a 2020 2020  import loop.    
-00066b50: 6672 6f6d 2073 6b6c 6561 726e 2e6e 6569  from sklearn.nei
-00066b60: 6768 626f 7273 2069 6d70 6f72 7420 4e65  ghbors import Ne
-00066b70: 6172 6573 744e 6569 6768 626f 7273 0a20  arestNeighbors. 
-00066b80: 2020 2066 726f 6d20 736b 6c65 6172 6e2e     from sklearn.
-00066b90: 7072 6570 726f 6365 7373 696e 6720 696d  preprocessing im
-00066ba0: 706f 7274 2053 7461 6e64 6172 6453 6361  port StandardSca
-00066bb0: 6c65 720a 2020 2020 2320 7265 706c 6163  ler.    # replac
-00066bc0: 6520 6e61 6e73 2077 6974 6820 7a65 726f  e nans with zero
-00066bd0: 0a20 2020 2066 6c61 7474 656e 6564 5f73  .    flattened_s
-00066be0: 6572 6965 733d 6e70 2e6e 616e 5f74 6f5f  eries=np.nan_to_
-00066bf0: 6e75 6d28 666c 6174 7465 6e65 645f 7365  num(flattened_se
-00066c00: 7269 6573 2c20 6e61 6e3d 3029 0a20 2020  ries, nan=0).   
-00066c10: 2073 6361 6c65 7220 3d20 5374 616e 6461   scaler = Standa
-00066c20: 7264 5363 616c 6572 2829 0a20 2020 2073  rdScaler().    s
-00066c30: 6361 6c65 722e 6669 7428 666c 6174 7465  caler.fit(flatte
-00066c40: 6e65 645f 7365 7269 6573 290a 2020 2020  ned_series).    
-00066c50: 6461 7461 203d 2073 6361 6c65 722e 7472  data = scaler.tr
-00066c60: 616e 7366 6f72 6d28 666c 6174 7465 6e65  ansform(flattene
-00066c70: 645f 7365 7269 6573 290a 2020 2020 6461  d_series).    da
-00066c80: 7461 3d6e 702e 6e61 6e5f 746f 5f6e 756d  ta=np.nan_to_num
-00066c90: 2864 6174 612c 206e 616e 3d30 290a 2020  (data, nan=0).  
-00066ca0: 2020 6966 206e 5f6e 6569 6768 626f 7273    if n_neighbors
-00066cb0: 203e 2069 6e74 2866 6c61 7474 656e 6564   > int(flattened
-00066cc0: 5f73 6572 6965 732e 7368 6170 655b 305d  _series.shape[0]
-00066cd0: 2f32 2e30 293a 0a20 2020 2020 2020 206e  /2.0):.        n
-00066ce0: 5f6e 6569 6768 626f 7273 203d 2069 6e74  _neighbors = int
-00066cf0: 2866 6c61 7474 656e 6564 5f73 6572 6965  (flattened_serie
-00066d00: 732e 7368 6170 655b 305d 2f32 2e30 290a  s.shape[0]/2.0).
-00066d10: 2020 2020 6e65 6967 6820 3d20 4e65 6172      neigh = Near
-00066d20: 6573 744e 6569 6768 626f 7273 286e 5f6e  estNeighbors(n_n
-00066d30: 6569 6768 626f 7273 3d6e 5f6e 6569 6768  eighbors=n_neigh
-00066d40: 626f 7273 2c20 6d65 7472 6963 3d27 6d69  bors, metric='mi
-00066d50: 6e6b 6f77 736b 6927 290a 2020 2020 6e65  nkowski').    ne
-00066d60: 6967 682e 6669 7428 6461 7461 290a 2020  igh.fit(data).  
-00066d70: 2020 642c 2069 6478 203d 206e 6569 6768    d, idx = neigh
-00066d80: 2e6b 6e65 6967 6862 6f72 7328 6461 7461  .kneighbors(data
-00066d90: 2c20 7265 7475 726e 5f64 6973 7461 6e63  , return_distanc
-00066da0: 653d 5472 7565 290a 2020 2020 6d20 3d20  e=True).    m = 
-00066db0: 6c6f 6f70 2e4c 6f63 616c 4f75 746c 6965  loop.LocalOutlie
-00066dc0: 7250 726f 6261 6269 6c69 7479 2864 6973  rProbability(dis
-00066dd0: 7461 6e63 655f 6d61 7472 6978 3d64 2c20  tance_matrix=d, 
-00066de0: 6e65 6967 6862 6f72 5f6d 6174 7269 783d  neighbor_matrix=
-00066df0: 6964 782c 206e 5f6e 6569 6768 626f 7273  idx, n_neighbors
-00066e00: 3d6e 5f6e 6569 6768 626f 7273 292e 6669  =n_neighbors).fi
-00066e10: 7428 290a 2020 2020 7265 7475 726e 206d  t().    return m
-00066e20: 2e6c 6f63 616c 5f6f 7574 6c69 6572 5f70  .local_outlier_p
-00066e30: 726f 6261 6269 6c69 7469 6573 5b3a 5d0a  robabilities[:].
-00066e40: 0a64 6566 2073 636f 7265 5f66 6d72 695f  .def score_fmri_
-00066e50: 6365 6e73 6f72 696e 6728 6362 6674 732c  censoring(cbfts,
-00066e60: 2063 7366 5f73 6567 2c20 676d 5f73 6567   csf_seg, gm_seg
-00066e70: 2c20 776d 5f73 6567 2029 3a0a 2020 2020  , wm_seg ):.    
-00066e80: 2222 220a 2020 2020 5072 6f63 6573 7320  """.    Process 
-00066e90: 4342 4620 7469 6d65 2073 6572 6965 7320  CBF time series 
-00066ea0: 746f 2072 656d 6f76 6520 6869 6768 2d6c  to remove high-l
-00066eb0: 6576 6572 6167 6520 706f 696e 7473 2e0a  everage points..
-00066ec0: 2020 2020 4465 7269 7665 6420 6672 6f6d      Derived from
-00066ed0: 2074 6865 2053 434f 5245 2061 6c67 6f72   the SCORE algor
-00066ee0: 6974 686d 2062 7920 5375 6469 7074 6f20  ithm by Sudipto 
-00066ef0: 446f 6c75 6920 6574 2e20 616c 2e0a 0a20  Dolui et. al... 
-00066f00: 2020 2050 6172 616d 6574 6572 733a 0a20     Parameters:. 
-00066f10: 2020 2063 6266 7473 2028 414e 5473 496d     cbfts (ANTsIm
-00066f20: 6167 6529 3a20 3444 2041 4e54 7349 6d61  age): 4D ANTsIma
-00066f30: 6765 206f 6620 4342 4620 7469 6d65 2073  ge of CBF time s
-00066f40: 6572 6965 732e 0a20 2020 2063 7366 5f73  eries..    csf_s
-00066f50: 6567 2028 414e 5473 496d 6167 6529 3a20  eg (ANTsImage): 
-00066f60: 4353 4620 6269 6e61 7279 206d 6170 2e0a  CSF binary map..
-00066f70: 2020 2020 676d 5f73 6567 2028 414e 5473      gm_seg (ANTs
-00066f80: 496d 6167 6529 3a20 4772 6179 206d 6174  Image): Gray mat
-00066f90: 7465 7220 6269 6e61 7279 206d 6170 2e0a  ter binary map..
-00066fa0: 2020 2020 776d 5f73 6567 2028 414e 5473      wm_seg (ANTs
-00066fb0: 496d 6167 6529 3a20 574d 2062 696e 6172  Image): WM binar
-00066fc0: 7920 6d61 702e 0a0a 2020 2020 5265 7475  y map...    Retu
-00066fd0: 726e 733a 0a20 2020 2041 4e54 7349 6d61  rns:.    ANTsIma
-00066fe0: 6765 3a20 5072 6f63 6573 7365 6420 4342  ge: Processed CB
-00066ff0: 4620 7469 6d65 2073 6572 6965 732e 0a20  F time series.. 
-00067000: 2020 206e 6461 7272 6179 3a20 496e 6465     ndarray: Inde
-00067010: 7820 6f66 2072 656d 6f76 6564 2076 6f6c  x of removed vol
-00067020: 756d 6573 2e0a 2020 2020 2222 220a 2020  umes..    """.  
-00067030: 2020 0a20 2020 206e 5f67 6d5f 766f 7865    .    n_gm_voxe
-00067040: 6c73 203d 206e 702e 7375 6d28 676d 5f73  ls = np.sum(gm_s
-00067050: 6567 2e6e 756d 7079 2829 2920 2d20 310a  eg.numpy()) - 1.
-00067060: 2020 2020 6e5f 776d 5f76 6f78 656c 7320      n_wm_voxels 
-00067070: 3d20 6e70 2e73 756d 2877 6d5f 7365 672e  = np.sum(wm_seg.
-00067080: 6e75 6d70 7928 2929 202d 2031 0a20 2020  numpy()) - 1.   
-00067090: 206e 5f63 7366 5f76 6f78 656c 7320 3d20   n_csf_voxels = 
-000670a0: 6e70 2e73 756d 2863 7366 5f73 6567 2e6e  np.sum(csf_seg.n
-000670b0: 756d 7079 2829 2920 2d20 310a 2020 2020  umpy()) - 1.    
-000670c0: 6d61 736b 3169 6d67 203d 2067 6d5f 7365  mask1img = gm_se
-000670d0: 6720 2b20 776d 5f73 6567 202b 2063 7366  g + wm_seg + csf
-000670e0: 5f73 6567 0a20 2020 206d 6173 6b31 203d  _seg.    mask1 =
-000670f0: 2028 6d61 736b 3169 6d67 3d3d 3129 2e6e   (mask1img==1).n
-00067100: 756d 7079 2829 0a20 2020 200a 2020 2020  umpy().    .    
-00067110: 6362 6674 735f 6e70 203d 2063 6266 7473  cbfts_np = cbfts
-00067120: 2e6e 756d 7079 2829 0a20 2020 2067 6d62  .numpy().    gmb
-00067130: 6f6f 6c20 3d20 2867 6d5f 7365 673d 3d31  ool = (gm_seg==1
-00067140: 292e 6e75 6d70 7928 290a 2020 2020 6373  ).numpy().    cs
-00067150: 6662 6f6f 6c20 3d20 2863 7366 5f73 6567  fbool = (csf_seg
-00067160: 3d3d 3129 2e6e 756d 7079 2829 0a20 2020  ==1).numpy().   
-00067170: 2077 6d62 6f6f 6c20 3d20 2877 6d5f 7365   wmbool = (wm_se
-00067180: 673d 3d31 292e 6e75 6d70 7928 290a 2020  g==1).numpy().  
-00067190: 2020 676d 5f63 6266 5f74 7320 3d20 616e    gm_cbf_ts = an
-000671a0: 7473 2e74 696d 6573 6572 6965 735f 746f  ts.timeseries_to
-000671b0: 5f6d 6174 7269 7828 2063 6266 7473 2c20  _matrix( cbfts, 
-000671c0: 676d 5f73 6567 2029 0a20 2020 2067 6d5f  gm_seg ).    gm_
-000671d0: 6362 665f 7473 203d 206e 702e 7371 7565  cbf_ts = np.sque
-000671e0: 657a 6528 6e70 2e6d 6561 6e28 676d 5f63  eze(np.mean(gm_c
-000671f0: 6266 5f74 732c 2061 7869 733d 3129 290a  bf_ts, axis=1)).
-00067200: 2020 2020 0a20 2020 206d 6564 6961 6e5f      .    median_
-00067210: 676d 5f63 6266 203d 206e 702e 6d65 6469  gm_cbf = np.medi
-00067220: 616e 2867 6d5f 6362 665f 7473 290a 2020  an(gm_cbf_ts).  
-00067230: 2020 6d61 645f 676d 5f63 6266 203d 206e    mad_gm_cbf = n
-00067240: 702e 6d65 6469 616e 286e 702e 6162 7328  p.median(np.abs(
-00067250: 676d 5f63 6266 5f74 7320 2d20 6d65 6469  gm_cbf_ts - medi
-00067260: 616e 5f67 6d5f 6362 6629 2920 2f20 302e  an_gm_cbf)) / 0.
-00067270: 3637 350a 2020 2020 696e 6478 203d 206e  675.    indx = n
-00067280: 702e 6162 7328 676d 5f63 6266 5f74 7320  p.abs(gm_cbf_ts 
-00067290: 2d20 6d65 6469 616e 5f67 6d5f 6362 6629  - median_gm_cbf)
-000672a0: 203e 2028 322e 3520 2a20 6d61 645f 676d   > (2.5 * mad_gm
-000672b0: 5f63 6266 290a 2020 2020 0a20 2020 2023  _cbf).    .    #
-000672c0: 2074 6865 2073 7061 7469 616c 206d 6561   the spatial mea
-000672d0: 6e0a 2020 2020 7370 6174 6d65 616e 6e70  n.    spatmeannp
-000672e0: 203d 206e 702e 6d65 616e 2863 6266 7473   = np.mean(cbfts
-000672f0: 5f6e 705b 3a2c 203a 2c20 3a2c 207e 696e  _np[:, :, :, ~in
-00067300: 6478 5d2c 2061 7869 733d 3329 0a20 2020  dx], axis=3).   
-00067310: 2073 7061 746d 6561 6e20 3d20 616e 7473   spatmean = ants
-00067320: 2e66 726f 6d5f 6e75 6d70 7928 2073 7061  .from_numpy( spa
-00067330: 746d 6561 6e6e 7020 290a 2020 2020 5620  tmeannp ).    V 
-00067340: 3d20 280a 2020 2020 2020 2020 6e5f 676d  = (.        n_gm
-00067350: 5f76 6f78 656c 7320 2a20 6e70 2e76 6172  _voxels * np.var
-00067360: 2873 7061 746d 6561 6e6e 705b 676d 626f  (spatmeannp[gmbo
-00067370: 6f6c 5d29 0a20 2020 2020 2020 202b 206e  ol]).        + n
-00067380: 5f77 6d5f 766f 7865 6c73 202a 206e 702e  _wm_voxels * np.
-00067390: 7661 7228 7370 6174 6d65 616e 6e70 5b77  var(spatmeannp[w
-000673a0: 6d62 6f6f 6c5d 290a 2020 2020 2020 2020  mbool]).        
-000673b0: 2b20 6e5f 6373 665f 766f 7865 6c73 202a  + n_csf_voxels *
-000673c0: 206e 702e 7661 7228 7370 6174 6d65 616e   np.var(spatmean
-000673d0: 6e70 5b63 7366 626f 6f6c 5d29 0a20 2020  np[csfbool]).   
-000673e0: 2029 0a20 2020 2056 3120 3d20 6d61 7468   ).    V1 = math
-000673f0: 2e69 6e66 0a20 2020 2063 743d 300a 2020  .inf.    ct=0.  
-00067400: 2020 7768 696c 6520 5620 3c20 5631 3a0a    while V < V1:.
-00067410: 2020 2020 2020 2020 6374 3d63 742b 310a          ct=ct+1.
-00067420: 2020 2020 2020 2020 5631 203d 2056 0a20          V1 = V. 
-00067430: 2020 2020 2020 2043 4320 3d20 6e70 2e7a         CC = np.z
-00067440: 6572 6f73 2863 6266 7473 5f6e 702e 7368  eros(cbfts_np.sh
-00067450: 6170 655b 335d 290a 2020 2020 2020 2020  ape[3]).        
-00067460: 666f 7220 7320 696e 2072 616e 6765 2863  for s in range(c
-00067470: 6266 7473 5f6e 702e 7368 6170 655b 335d  bfts_np.shape[3]
-00067480: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-00067490: 6620 696e 6478 5b73 5d3a 0a20 2020 2020  f indx[s]:.     
-000674a0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-000674b0: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
-000674c0: 746d 7031 203d 2061 6e74 732e 6672 6f6d  tmp1 = ants.from
-000674d0: 5f6e 756d 7079 2820 6362 6674 735f 6e70  _numpy( cbfts_np
-000674e0: 5b3a 2c20 3a2c 203a 2c20 735d 2029 0a20  [:, :, :, s] ). 
-000674f0: 2020 2020 2020 2020 2020 2043 435b 735d             CC[s]
-00067500: 203d 2061 6e74 732e 696d 6167 655f 7369   = ants.image_si
-00067510: 6d69 6c61 7269 7479 2820 7370 6174 6d65  milarity( spatme
-00067520: 616e 2c20 746d 7031 2c20 6d65 7472 6963  an, tmp1, metric
-00067530: 5f74 7970 653d 2743 6f72 7265 6c61 7469  _type='Correlati
-00067540: 6f6e 272c 2066 6978 6564 5f6d 6173 6b3d  on', fixed_mask=
-00067550: 6d61 736b 3169 6d67 2029 0a20 2020 2020  mask1img ).     
-00067560: 2020 2069 6e78 203d 206e 702e 6172 676d     inx = np.argm
-00067570: 696e 2843 4329 0a20 2020 2020 2020 2069  in(CC).        i
-00067580: 6e64 785b 696e 785d 203d 2054 7275 650a  ndx[inx] = True.
-00067590: 2020 2020 2020 2020 7370 6174 6d65 616e          spatmean
-000675a0: 6e70 203d 206e 702e 6d65 616e 2863 6266  np = np.mean(cbf
-000675b0: 7473 5f6e 705b 3a2c 203a 2c20 3a2c 207e  ts_np[:, :, :, ~
-000675c0: 696e 6478 5d2c 2061 7869 733d 3329 0a20  indx], axis=3). 
-000675d0: 2020 2020 2020 2073 7061 746d 6561 6e20         spatmean 
-000675e0: 3d20 616e 7473 2e66 726f 6d5f 6e75 6d70  = ants.from_nump
-000675f0: 7928 2073 7061 746d 6561 6e6e 7020 290a  y( spatmeannp ).
-00067600: 2020 2020 2020 2020 5620 3d20 280a 2020          V = (.  
-00067610: 2020 2020 2020 2020 6e5f 676d 5f76 6f78          n_gm_vox
-00067620: 656c 7320 2a20 6e70 2e76 6172 2873 7061  els * np.var(spa
-00067630: 746d 6561 6e6e 705b 676d 626f 6f6c 5d29  tmeannp[gmbool])
-00067640: 202b 200a 2020 2020 2020 2020 2020 6e5f   + .          n_
-00067650: 776d 5f76 6f78 656c 7320 2a20 6e70 2e76  wm_voxels * np.v
-00067660: 6172 2873 7061 746d 6561 6e6e 705b 776d  ar(spatmeannp[wm
-00067670: 626f 6f6c 5d29 202b 200a 2020 2020 2020  bool]) + .      
-00067680: 2020 2020 6e5f 6373 665f 766f 7865 6c73      n_csf_voxels
-00067690: 202a 206e 702e 7661 7228 7370 6174 6d65   * np.var(spatme
-000676a0: 616e 6e70 5b63 7366 626f 6f6c 5d29 0a20  annp[csfbool]). 
-000676b0: 2020 2020 2020 2029 0a20 2020 2063 6266         ).    cbf
-000676c0: 7473 5f72 6563 6f6e 203d 2063 6266 7473  ts_recon = cbfts
-000676d0: 5f6e 705b 3a2c 203a 2c20 3a2c 207e 696e  _np[:, :, :, ~in
-000676e0: 6478 5d0a 2020 2020 6362 6674 735f 7265  dx].    cbfts_re
-000676f0: 636f 6e20 3d20 6e70 2e6e 616e 5f74 6f5f  con = np.nan_to_
-00067700: 6e75 6d28 6362 6674 735f 7265 636f 6e29  num(cbfts_recon)
-00067710: 0a20 2020 2063 6266 7473 5f72 6563 6f6e  .    cbfts_recon
-00067720: 5f61 6e74 7320 3d20 616e 7473 2e66 726f  _ants = ants.fro
-00067730: 6d5f 6e75 6d70 7928 6362 6674 735f 7265  m_numpy(cbfts_re
-00067740: 636f 6e29 0a20 2020 2063 6266 7473 5f72  con).    cbfts_r
-00067750: 6563 6f6e 5f61 6e74 7320 3d20 616e 7473  econ_ants = ants
-00067760: 2e63 6f70 795f 696d 6167 655f 696e 666f  .copy_image_info
-00067770: 2863 6266 7473 2c20 6362 6674 735f 7265  (cbfts, cbfts_re
-00067780: 636f 6e5f 616e 7473 290a 2020 2020 7265  con_ants).    re
-00067790: 7475 726e 2063 6266 7473 5f72 6563 6f6e  turn cbfts_recon
-000677a0: 5f61 6e74 732c 2069 6e64 780a 0a64 6566  _ants, indx..def
-000677b0: 206c 6f6f 705f 7469 6d65 7365 7269 6573   loop_timeseries
-000677c0: 5f63 656e 736f 7269 6e67 2878 2c20 7468  _censoring(x, th
-000677d0: 7265 7368 6f6c 643d 302e 352c 206d 6173  reshold=0.5, mas
-000677e0: 6b3d 4e6f 6e65 2c20 7665 7262 6f73 653d  k=None, verbose=
-000677f0: 4661 6c73 6529 3a0a 2020 2020 2222 220a  False):.    """.
-00067800: 2020 2020 4365 6e73 6f72 2068 6967 6820      Censor high 
-00067810: 6c65 7665 7261 6765 2076 6f6c 756d 6573  leverage volumes
-00067820: 2066 726f 6d20 6120 7469 6d65 2073 6572   from a time ser
-00067830: 6965 7320 7573 696e 6720 4c6f 6361 6c20  ies using Local 
-00067840: 4f75 746c 6965 7220 5072 6f62 6162 696c  Outlier Probabil
-00067850: 6974 6965 7320 284c 6f4f 5029 2e0a 0a20  ities (LoOP)... 
-00067860: 2020 2050 6172 616d 6574 6572 733a 0a20     Parameters:. 
-00067870: 2020 2078 2028 414e 5473 496d 6167 6529     x (ANTsImage)
-00067880: 3a20 4120 3444 2074 696d 6520 7365 7269  : A 4D time seri
-00067890: 6573 2069 6d61 6765 2e0a 2020 2020 7468  es image..    th
-000678a0: 7265 7368 6f6c 6420 2866 6c6f 6174 293a  reshold (float):
-000678b0: 2054 6872 6573 686f 6c64 2066 6f72 2064   Threshold for d
-000678c0: 6574 6572 6d69 6e69 6e67 2068 6967 6820  etermining high 
-000678d0: 6c65 7665 7261 6765 2076 6f6c 756d 6573  leverage volumes
-000678e0: 2062 6173 6564 206f 6e20 4c6f 4f50 2073   based on LoOP s
-000678f0: 636f 7265 732e 0a20 2020 206d 6173 6b20  cores..    mask 
-00067900: 2861 6e74 7349 6d61 6765 293a 2072 6573  (antsImage): res
-00067910: 7472 6963 7473 2074 6f20 6120 524f 490a  tricts to a ROI.
-00067920: 2020 2020 7665 7262 6f73 6520 2862 6f6f      verbose (boo
-00067930: 6c29 0a0a 2020 2020 5265 7475 726e 733a  l)..    Returns:
-00067940: 0a20 2020 2074 7570 6c65 3a20 4120 7475  .    tuple: A tu
-00067950: 706c 6520 636f 6e74 6169 6e69 6e67 2074  ple containing t
-00067960: 6865 2063 656e 736f 7265 6420 7469 6d65  he censored time
-00067970: 2073 6572 6965 7320 2841 4e54 7349 6d61   series (ANTsIma
-00067980: 6765 2920 616e 6420 7468 6520 696e 6469  ge) and the indi
-00067990: 6365 7320 6f66 2074 6865 2068 6967 6820  ces of the high 
-000679a0: 6c65 7665 7261 6765 2076 6f6c 756d 6573  leverage volumes
-000679b0: 2e0a 2020 2020 2222 220a 2020 2020 696d  ..    """.    im
-000679c0: 706f 7274 2077 6172 6e69 6e67 730a 2020  port warnings.  
-000679d0: 2020 6966 2078 2e73 6861 7065 5b33 5d20    if x.shape[3] 
-000679e0: 3c20 3230 3a20 2320 6a75 7374 2061 2067  < 20: # just a g
-000679f0: 7565 7373 2061 7420 7768 6174 2077 6520  uess at what we 
-00067a00: 6e65 6564 2068 6572 6520 2e2e 2e0a 2020  need here ....  
-00067a10: 2020 2020 2020 7761 726e 696e 6773 2e77        warnings.w
-00067a20: 6172 6e28 2257 6172 6e69 6e67 3a20 7468  arn("Warning: th
-00067a30: 6520 7469 6d65 2064 696d 656e 7369 6f6e  e time dimension
-00067a40: 2069 7320 3c20 3230 202d 2074 6f6f 2066   is < 20 - too f
-00067a50: 6577 2073 616d 706c 6573 2066 6f72 206c  ew samples for l
-00067a60: 6f6f 702e 206a 7573 7420 7265 7475 726e  oop. just return
-00067a70: 2074 6865 206f 7269 6769 6e61 6c20 6461   the original da
-00067a80: 7461 2e22 290a 2020 2020 2020 2020 7265  ta.").        re
-00067a90: 7475 726e 2078 2c20 5b5d 0a20 2020 2069  turn x, [].    i
-00067aa0: 6620 6d61 736b 2069 7320 4e6f 6e65 3a0a  f mask is None:.
-00067ab0: 2020 2020 2020 2020 666c 6174 7465 6e65          flattene
-00067ac0: 645f 7365 7269 6573 203d 2066 6c61 7474  d_series = flatt
-00067ad0: 656e 5f74 696d 655f 7365 7269 6573 2878  en_time_series(x
-00067ae0: 2e6e 756d 7079 2829 290a 2020 2020 656c  .numpy()).    el
-00067af0: 7365 3a0a 2020 2020 2020 2020 666c 6174  se:.        flat
-00067b00: 7465 6e65 645f 7365 7269 6573 203d 2061  tened_series = a
-00067b10: 6e74 732e 7469 6d65 7365 7269 6573 5f74  nts.timeseries_t
-00067b20: 6f5f 6d61 7472 6978 2820 782c 206d 6173  o_matrix( x, mas
-00067b30: 6b20 290a 2020 2020 6c6f 6f70 5f73 636f  k ).    loop_sco
-00067b40: 7265 7320 3d20 6361 6c63 756c 6174 655f  res = calculate_
-00067b50: 6c6f 6f70 5f73 636f 7265 7328 666c 6174  loop_scores(flat
-00067b60: 7465 6e65 645f 7365 7269 6573 290a 2020  tened_series).  
-00067b70: 2020 6869 6768 5f6c 6576 6572 6167 655f    high_leverage_
-00067b80: 766f 6c75 6d65 7320 3d20 6e70 2e77 6865  volumes = np.whe
-00067b90: 7265 286c 6f6f 705f 7363 6f72 6573 203e  re(loop_scores >
-00067ba0: 2074 6872 6573 686f 6c64 295b 305d 0a20   threshold)[0]. 
-00067bb0: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
-00067bc0: 2020 2020 2020 2070 7269 6e74 2822 4c4f         print("LO
-00067bd0: 4f50 2048 6967 6820 4c65 7665 7261 6765  OP High Leverage
-00067be0: 2056 6f6c 756d 6573 3a22 2c20 6869 6768   Volumes:", high
-00067bf0: 5f6c 6576 6572 6167 655f 766f 6c75 6d65  _leverage_volume
-00067c00: 7329 0a20 2020 206e 6577 5f61 736c 203d  s).    new_asl =
-00067c10: 2072 656d 6f76 655f 766f 6c75 6d65 735f   remove_volumes_
-00067c20: 6672 6f6d 5f74 696d 6573 6572 6965 7328  from_timeseries(
-00067c30: 782c 2068 6967 685f 6c65 7665 7261 6765  x, high_leverage
-00067c40: 5f76 6f6c 756d 6573 290a 2020 2020 7265  _volumes).    re
-00067c50: 7475 726e 206e 6577 5f61 736c 2c20 6869  turn new_asl, hi
-00067c60: 6768 5f6c 6576 6572 6167 655f 766f 6c75  gh_leverage_volu
-00067c70: 6d65 730a 0a0a 6465 6620 6e6f 7665 6c74  mes...def novelt
-00067c80: 795f 6465 7465 6374 696f 6e5f 6565 2864  y_detection_ee(d
-00067c90: 665f 7472 6169 6e2c 2064 665f 7465 7374  f_train, df_test
-00067ca0: 2c20 636f 6e74 616d 696e 6174 696f 6e3d  , contamination=
-00067cb0: 302e 3035 293a 0a20 2020 2022 2222 0a20  0.05):.    """. 
-00067cc0: 2020 2054 6869 7320 6675 6e63 7469 6f6e     This function
-00067cd0: 2070 6572 666f 726d 7320 6e6f 7665 6c74   performs novelt
-00067ce0: 7920 6465 7465 6374 696f 6e20 7573 696e  y detection usin
-00067cf0: 6720 456c 6c69 7074 6963 2045 6e76 656c  g Elliptic Envel
-00067d00: 6f70 652e 0a0a 2020 2020 5061 7261 6d65  ope...    Parame
-00067d10: 7465 7273 3a0a 0a20 2020 202d 2064 665f  ters:..    - df_
-00067d20: 7472 6169 6e20 2870 616e 6461 7320 6461  train (pandas da
-00067d30: 7461 6672 616d 6529 3a20 7472 6169 6e69  taframe): traini
-00067d40: 6e67 2064 6174 6120 7573 6564 2074 6f20  ng data used to 
-00067d50: 6669 7420 7468 6520 6d6f 6465 6c0a 0a20  fit the model.. 
-00067d60: 2020 202d 2064 665f 7465 7374 2028 7061     - df_test (pa
-00067d70: 6e64 6173 2064 6174 6166 7261 6d65 293a  ndas dataframe):
-00067d80: 2074 6573 7420 6461 7461 2075 7365 6420   test data used 
-00067d90: 746f 2070 7265 6469 6374 206e 6f76 656c  to predict novel
-00067da0: 7469 6573 0a0a 2020 2020 2d20 636f 6e74  ties..    - cont
-00067db0: 616d 696e 6174 696f 6e20 2866 6c6f 6174  amination (float
-00067dc0: 293a 2070 6172 616d 6574 6572 2063 6f6e  ): parameter con
-00067dd0: 7472 6f6c 6c69 6e67 2074 6865 2070 726f  trolling the pro
-00067de0: 706f 7274 696f 6e20 6f66 206f 7574 6c69  portion of outli
-00067df0: 6572 7320 696e 2074 6865 2064 6174 6120  ers in the data 
-00067e00: 2864 6566 6175 6c74 3a20 302e 3035 290a  (default: 0.05).
-00067e10: 0a20 2020 2052 6574 7572 6e73 3a0a 0a20  .    Returns:.. 
-00067e20: 2020 2070 7265 6469 6374 696f 6e73 2028     predictions (
-00067e30: 7061 6e64 6173 2073 6572 6965 7329 3a20  pandas series): 
-00067e40: 7072 6564 6963 7465 6420 6c61 6265 6c73  predicted labels
-00067e50: 2066 6f72 2074 6865 2074 6573 7420 6461   for the test da
-00067e60: 7461 2028 3120 666f 7220 6e6f 7665 6c74  ta (1 for novelt
-00067e70: 6965 732c 2030 2066 6f72 2069 6e6c 6965  ies, 0 for inlie
-00067e80: 7273 290a 2020 2020 2222 220a 2020 2020  rs).    """.    
-00067e90: 696d 706f 7274 2070 616e 6461 7320 6173  import pandas as
-00067ea0: 2070 640a 2020 2020 6672 6f6d 2073 6b6c   pd.    from skl
-00067eb0: 6561 726e 2e63 6f76 6172 6961 6e63 6520  earn.covariance 
-00067ec0: 696d 706f 7274 2045 6c6c 6970 7469 6345  import EllipticE
-00067ed0: 6e76 656c 6f70 650a 2020 2020 2320 4669  nvelope.    # Fi
-00067ee0: 7420 7468 6520 6d6f 6465 6c20 6f6e 2074  t the model on t
-00067ef0: 6865 2074 7261 696e 696e 6720 6461 7461  he training data
-00067f00: 0a20 2020 2063 6c66 203d 2045 6c6c 6970  .    clf = Ellip
-00067f10: 7469 6345 6e76 656c 6f70 6528 636f 6e74  ticEnvelope(cont
-00067f20: 616d 696e 6174 696f 6e3d 636f 6e74 616d  amination=contam
-00067f30: 696e 6174 696f 6e2c 7375 7070 6f72 745f  ination,support_
-00067f40: 6672 6163 7469 6f6e 3d31 290a 2020 2020  fraction=1).    
-00067f50: 6466 5f74 7261 696e 5b20 6466 5f74 7261  df_train[ df_tra
-00067f60: 696e 203d 3d20 6d61 7468 2e69 6e66 205d  in == math.inf ]
-00067f70: 203d 2030 0a20 2020 2064 665f 7465 7374   = 0.    df_test
-00067f80: 5b20 6466 5f74 6573 7420 3d3d 206d 6174  [ df_test == mat
-00067f90: 682e 696e 6620 5d20 3d20 300a 2020 2020  h.inf ] = 0.    
-00067fa0: 6672 6f6d 2073 6b6c 6561 726e 2e70 7265  from sklearn.pre
-00067fb0: 7072 6f63 6573 7369 6e67 2069 6d70 6f72  processing impor
-00067fc0: 7420 5374 616e 6461 7264 5363 616c 6572  t StandardScaler
-00067fd0: 0a20 2020 2073 6361 6c65 7220 3d20 5374  .    scaler = St
-00067fe0: 616e 6461 7264 5363 616c 6572 2829 0a20  andardScaler(). 
-00067ff0: 2020 2073 6361 6c65 722e 6669 7428 6466     scaler.fit(df
-00068000: 5f74 7261 696e 290a 2020 2020 636c 662e  _train).    clf.
-00068010: 6669 7428 7363 616c 6572 2e74 7261 6e73  fit(scaler.trans
-00068020: 666f 726d 2864 665f 7472 6169 6e29 290a  form(df_train)).
-00068030: 2020 2020 7072 6564 6963 7469 6f6e 7320      predictions 
-00068040: 3d20 636c 662e 7072 6564 6963 7428 7363  = clf.predict(sc
-00068050: 616c 6572 2e74 7261 6e73 666f 726d 2864  aler.transform(d
-00068060: 665f 7465 7374 2929 0a20 2020 2070 7265  f_test)).    pre
-00068070: 6469 6374 696f 6e73 5b70 7265 6469 6374  dictions[predict
-00068080: 696f 6e73 3d3d 315d 3d30 0a20 2020 2070  ions==1]=0.    p
-00068090: 7265 6469 6374 696f 6e73 5b70 7265 6469  redictions[predi
-000680a0: 6374 696f 6e73 3d3d 2d31 5d3d 310a 2020  ctions==-1]=1.  
-000680b0: 2020 6966 2073 7472 2874 7970 6528 6466    if str(type(df
-000680c0: 5f74 7261 696e 2929 3d3d 223c 636c 6173  _train))=="<clas
-000680d0: 7320 2770 616e 6461 732e 636f 7265 2e66  s 'pandas.core.f
-000680e0: 7261 6d65 2e44 6174 6146 7261 6d65 273e  rame.DataFrame'>
-000680f0: 223a 0a20 2020 2020 2020 2072 6574 7572  ":.        retur
-00068100: 6e20 7064 2e53 6572 6965 7328 7072 6564  n pd.Series(pred
-00068110: 6963 7469 6f6e 732c 2069 6e64 6578 3d64  ictions, index=d
-00068120: 665f 7465 7374 2e69 6e64 6578 290a 2020  f_test.index).  
-00068130: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00068140: 7265 7475 726e 2070 642e 5365 7269 6573  return pd.Series
-00068150: 2870 7265 6469 6374 696f 6e73 290a 0a0a  (predictions)...
-00068160: 0a64 6566 206e 6f76 656c 7479 5f64 6574  .def novelty_det
-00068170: 6563 7469 6f6e 5f73 766d 2864 665f 7472  ection_svm(df_tr
-00068180: 6169 6e2c 2064 665f 7465 7374 2c20 6e75  ain, df_test, nu
-00068190: 3d30 2e30 352c 206b 6572 6e65 6c3d 2772  =0.05, kernel='r
-000681a0: 6266 2729 3a0a 2020 2020 2222 220a 2020  bf'):.    """.  
-000681b0: 2020 5468 6973 2066 756e 6374 696f 6e20    This function 
-000681c0: 7065 7266 6f72 6d73 206e 6f76 656c 7479  performs novelty
-000681d0: 2064 6574 6563 7469 6f6e 2075 7369 6e67   detection using
-000681e0: 204f 6e65 2d43 6c61 7373 2053 564d 2e0a   One-Class SVM..
-000681f0: 0a20 2020 2050 6172 616d 6574 6572 733a  .    Parameters:
-00068200: 0a0a 2020 2020 2d20 6466 5f74 7261 696e  ..    - df_train
-00068210: 2028 7061 6e64 6173 2064 6174 6166 7261   (pandas datafra
-00068220: 6d65 293a 2074 7261 696e 696e 6720 6461  me): training da
-00068230: 7461 2075 7365 6420 746f 2066 6974 2074  ta used to fit t
-00068240: 6865 206d 6f64 656c 0a0a 2020 2020 2d20  he model..    - 
-00068250: 6466 5f74 6573 7420 2870 616e 6461 7320  df_test (pandas 
-00068260: 6461 7461 6672 616d 6529 3a20 7465 7374  dataframe): test
-00068270: 2064 6174 6120 7573 6564 2074 6f20 7072   data used to pr
-00068280: 6564 6963 7420 6e6f 7665 6c74 6965 730a  edict novelties.
-00068290: 0a20 2020 202d 206e 7520 2866 6c6f 6174  .    - nu (float
-000682a0: 293a 2070 6172 616d 6574 6572 2063 6f6e  ): parameter con
-000682b0: 7472 6f6c 6c69 6e67 2074 6865 2066 7261  trolling the fra
-000682c0: 6374 696f 6e20 6f66 2074 7261 696e 696e  ction of trainin
-000682d0: 6720 6572 726f 7273 2061 6e64 2074 6865  g errors and the
-000682e0: 2066 7261 6374 696f 6e20 6f66 2073 7570   fraction of sup
-000682f0: 706f 7274 2076 6563 746f 7273 2028 6465  port vectors (de
-00068300: 6661 756c 743a 2030 2e30 3529 0a0a 2020  fault: 0.05)..  
-00068310: 2020 2d20 6b65 726e 656c 2028 7374 7229    - kernel (str)
-00068320: 3a20 6b65 726e 656c 2074 7970 6520 7573  : kernel type us
-00068330: 6564 2069 6e20 7468 6520 5356 4d20 616c  ed in the SVM al
-00068340: 676f 7269 7468 6d20 2864 6566 6175 6c74  gorithm (default
-00068350: 3a20 2772 6266 2729 0a0a 2020 2020 5265  : 'rbf')..    Re
-00068360: 7475 726e 733a 0a0a 2020 2020 7072 6564  turns:..    pred
-00068370: 6963 7469 6f6e 7320 2870 616e 6461 7320  ictions (pandas 
-00068380: 7365 7269 6573 293a 2070 7265 6469 6374  series): predict
-00068390: 6564 206c 6162 656c 7320 666f 7220 7468  ed labels for th
-000683a0: 6520 7465 7374 2064 6174 6120 2831 2066  e test data (1 f
-000683b0: 6f72 206e 6f76 656c 7469 6573 2c20 3020  or novelties, 0 
-000683c0: 666f 7220 696e 6c69 6572 7329 0a20 2020  for inliers).   
-000683d0: 2022 2222 0a20 2020 2066 726f 6d20 736b   """.    from sk
-000683e0: 6c65 6172 6e2e 7376 6d20 696d 706f 7274  learn.svm import
-000683f0: 204f 6e65 436c 6173 7353 564d 0a20 2020   OneClassSVM.   
-00068400: 2023 2046 6974 2074 6865 206d 6f64 656c   # Fit the model
-00068410: 206f 6e20 7468 6520 7472 6169 6e69 6e67   on the training
-00068420: 2064 6174 610a 2020 2020 6466 5f74 7261   data.    df_tra
-00068430: 696e 5b20 6466 5f74 7261 696e 203d 3d20  in[ df_train == 
-00068440: 6d61 7468 2e69 6e66 205d 203d 2030 0a20  math.inf ] = 0. 
-00068450: 2020 2064 665f 7465 7374 5b20 6466 5f74     df_test[ df_t
-00068460: 6573 7420 3d3d 206d 6174 682e 696e 6620  est == math.inf 
-00068470: 5d20 3d20 300a 2020 2020 636c 6620 3d20  ] = 0.    clf = 
-00068480: 4f6e 6543 6c61 7373 5356 4d28 6e75 3d6e  OneClassSVM(nu=n
-00068490: 752c 206b 6572 6e65 6c3d 6b65 726e 656c  u, kernel=kernel
-000684a0: 290a 2020 2020 6672 6f6d 2073 6b6c 6561  ).    from sklea
-000684b0: 726e 2e70 7265 7072 6f63 6573 7369 6e67  rn.preprocessing
-000684c0: 2069 6d70 6f72 7420 5374 616e 6461 7264   import Standard
-000684d0: 5363 616c 6572 0a20 2020 2073 6361 6c65  Scaler.    scale
-000684e0: 7220 3d20 5374 616e 6461 7264 5363 616c  r = StandardScal
-000684f0: 6572 2829 0a20 2020 2073 6361 6c65 722e  er().    scaler.
-00068500: 6669 7428 6466 5f74 7261 696e 290a 2020  fit(df_train).  
-00068510: 2020 636c 662e 6669 7428 7363 616c 6572    clf.fit(scaler
-00068520: 2e74 7261 6e73 666f 726d 2864 665f 7472  .transform(df_tr
-00068530: 6169 6e29 290a 2020 2020 7072 6564 6963  ain)).    predic
-00068540: 7469 6f6e 7320 3d20 636c 662e 7072 6564  tions = clf.pred
-00068550: 6963 7428 7363 616c 6572 2e74 7261 6e73  ict(scaler.trans
-00068560: 666f 726d 2864 665f 7465 7374 2929 0a20  form(df_test)). 
-00068570: 2020 2070 7265 6469 6374 696f 6e73 5b70     predictions[p
-00068580: 7265 6469 6374 696f 6e73 3d3d 315d 3d30  redictions==1]=0
-00068590: 0a20 2020 2070 7265 6469 6374 696f 6e73  .    predictions
-000685a0: 5b70 7265 6469 6374 696f 6e73 3d3d 2d31  [predictions==-1
-000685b0: 5d3d 310a 2020 2020 6966 2073 7472 2874  ]=1.    if str(t
-000685c0: 7970 6528 6466 5f74 7261 696e 2929 3d3d  ype(df_train))==
-000685d0: 223c 636c 6173 7320 2770 616e 6461 732e  "<class 'pandas.
-000685e0: 636f 7265 2e66 7261 6d65 2e44 6174 6146  core.frame.DataF
-000685f0: 7261 6d65 273e 223a 0a20 2020 2020 2020  rame'>":.       
-00068600: 2072 6574 7572 6e20 7064 2e53 6572 6965   return pd.Serie
-00068610: 7328 7072 6564 6963 7469 6f6e 732c 2069  s(predictions, i
-00068620: 6e64 6578 3d64 665f 7465 7374 2e69 6e64  ndex=df_test.ind
-00068630: 6578 290a 2020 2020 656c 7365 3a0a 2020  ex).    else:.  
-00068640: 2020 2020 2020 7265 7475 726e 2070 642e        return pd.
-00068650: 5365 7269 6573 2870 7265 6469 6374 696f  Series(predictio
-00068660: 6e73 290a 0a0a 0a64 6566 206e 6f76 656c  ns)....def novel
-00068670: 7479 5f64 6574 6563 7469 6f6e 5f6c 6f66  ty_detection_lof
-00068680: 2864 665f 7472 6169 6e2c 2064 665f 7465  (df_train, df_te
-00068690: 7374 2c20 6e5f 6e65 6967 6862 6f72 733d  st, n_neighbors=
-000686a0: 3230 293a 0a20 2020 2022 2222 0a20 2020  20):.    """.   
-000686b0: 2054 6869 7320 6675 6e63 7469 6f6e 2070   This function p
-000686c0: 6572 666f 726d 7320 6e6f 7665 6c74 7920  erforms novelty 
-000686d0: 6465 7465 6374 696f 6e20 7573 696e 6720  detection using 
-000686e0: 4c6f 6361 6c20 4f75 746c 6965 7220 4661  Local Outlier Fa
-000686f0: 6374 6f72 2028 4c4f 4629 2e0a 0a20 2020  ctor (LOF)...   
-00068700: 2050 6172 616d 6574 6572 733a 0a0a 2020   Parameters:..  
-00068710: 2020 2d20 6466 5f74 7261 696e 2028 7061    - df_train (pa
-00068720: 6e64 6173 2064 6174 6166 7261 6d65 293a  ndas dataframe):
-00068730: 2074 7261 696e 696e 6720 6461 7461 2075   training data u
-00068740: 7365 6420 746f 2066 6974 2074 6865 206d  sed to fit the m
-00068750: 6f64 656c 0a0a 2020 2020 2d20 6466 5f74  odel..    - df_t
-00068760: 6573 7420 2870 616e 6461 7320 6461 7461  est (pandas data
-00068770: 6672 616d 6529 3a20 7465 7374 2064 6174  frame): test dat
-00068780: 6120 7573 6564 2074 6f20 7072 6564 6963  a used to predic
-00068790: 7420 6e6f 7665 6c74 6965 730a 0a20 2020  t novelties..   
-000687a0: 202d 206e 5f6e 6569 6768 626f 7273 2028   - n_neighbors (
-000687b0: 696e 7429 3a20 6e75 6d62 6572 206f 6620  int): number of 
-000687c0: 6e65 6967 6862 6f72 7320 7573 6564 2074  neighbors used t
-000687d0: 6f20 636f 6d70 7574 6520 7468 6520 4c4f  o compute the LO
-000687e0: 4620 2864 6566 6175 6c74 3a20 3230 290a  F (default: 20).
-000687f0: 0a20 2020 2052 6574 7572 6e73 3a0a 0a20  .    Returns:.. 
-00068800: 2020 202d 2070 7265 6469 6374 696f 6e73     - predictions
-00068810: 2028 7061 6e64 6173 2073 6572 6965 7329   (pandas series)
-00068820: 3a20 7072 6564 6963 7465 6420 6c61 6265  : predicted labe
-00068830: 6c73 2066 6f72 2074 6865 2074 6573 7420  ls for the test 
-00068840: 6461 7461 2028 3120 666f 7220 6e6f 7665  data (1 for nove
-00068850: 6c74 6965 732c 2030 2066 6f72 2069 6e6c  lties, 0 for inl
-00068860: 6965 7273 290a 0a20 2020 2022 2222 0a20  iers)..    """. 
-00068870: 2020 2066 726f 6d20 736b 6c65 6172 6e2e     from sklearn.
-00068880: 6e65 6967 6862 6f72 7320 696d 706f 7274  neighbors import
-00068890: 204c 6f63 616c 4f75 746c 6965 7246 6163   LocalOutlierFac
-000688a0: 746f 720a 2020 2020 2320 4669 7420 7468  tor.    # Fit th
-000688b0: 6520 6d6f 6465 6c20 6f6e 2074 6865 2074  e model on the t
-000688c0: 7261 696e 696e 6720 6461 7461 0a20 2020  raining data.   
-000688d0: 2064 665f 7472 6169 6e5b 2064 665f 7472   df_train[ df_tr
-000688e0: 6169 6e20 3d3d 206d 6174 682e 696e 6620  ain == math.inf 
-000688f0: 5d20 3d20 300a 2020 2020 6466 5f74 6573  ] = 0.    df_tes
-00068900: 745b 2064 665f 7465 7374 203d 3d20 6d61  t[ df_test == ma
-00068910: 7468 2e69 6e66 205d 203d 2030 0a20 2020  th.inf ] = 0.   
-00068920: 2063 6c66 203d 204c 6f63 616c 4f75 746c   clf = LocalOutl
-00068930: 6965 7246 6163 746f 7228 6e5f 6e65 6967  ierFactor(n_neig
-00068940: 6862 6f72 733d 6e5f 6e65 6967 6862 6f72  hbors=n_neighbor
-00068950: 732c 2061 6c67 6f72 6974 686d 3d27 6175  s, algorithm='au
-00068960: 746f 272c 636f 6e74 616d 696e 6174 696f  to',contaminatio
-00068970: 6e3d 2761 7574 6f27 2c20 6e6f 7665 6c74  n='auto', novelt
-00068980: 793d 5472 7565 290a 2020 2020 6672 6f6d  y=True).    from
-00068990: 2073 6b6c 6561 726e 2e70 7265 7072 6f63   sklearn.preproc
-000689a0: 6573 7369 6e67 2069 6d70 6f72 7420 5374  essing import St
-000689b0: 616e 6461 7264 5363 616c 6572 0a20 2020  andardScaler.   
-000689c0: 2073 6361 6c65 7220 3d20 5374 616e 6461   scaler = Standa
-000689d0: 7264 5363 616c 6572 2829 0a20 2020 2073  rdScaler().    s
-000689e0: 6361 6c65 722e 6669 7428 6466 5f74 7261  caler.fit(df_tra
-000689f0: 696e 290a 2020 2020 636c 662e 6669 7428  in).    clf.fit(
-00068a00: 7363 616c 6572 2e74 7261 6e73 666f 726d  scaler.transform
-00068a10: 2864 665f 7472 6169 6e29 290a 2020 2020  (df_train)).    
-00068a20: 7072 6564 6963 7469 6f6e 7320 3d20 636c  predictions = cl
-00068a30: 662e 7072 6564 6963 7428 7363 616c 6572  f.predict(scaler
-00068a40: 2e74 7261 6e73 666f 726d 2864 665f 7465  .transform(df_te
-00068a50: 7374 2929 0a20 2020 2070 7265 6469 6374  st)).    predict
-00068a60: 696f 6e73 5b70 7265 6469 6374 696f 6e73  ions[predictions
-00068a70: 3d3d 315d 3d30 0a20 2020 2070 7265 6469  ==1]=0.    predi
-00068a80: 6374 696f 6e73 5b70 7265 6469 6374 696f  ctions[predictio
-00068a90: 6e73 3d3d 2d31 5d3d 310a 2020 2020 6966  ns==-1]=1.    if
-00068aa0: 2073 7472 2874 7970 6528 6466 5f74 7261   str(type(df_tra
-00068ab0: 696e 2929 3d3d 223c 636c 6173 7320 2770  in))=="<class 'p
-00068ac0: 616e 6461 732e 636f 7265 2e66 7261 6d65  andas.core.frame
-00068ad0: 2e44 6174 6146 7261 6d65 273e 223a 0a20  .DataFrame'>":. 
-00068ae0: 2020 2020 2020 2072 6574 7572 6e20 7064         return pd
-00068af0: 2e53 6572 6965 7328 7072 6564 6963 7469  .Series(predicti
-00068b00: 6f6e 732c 2069 6e64 6578 3d64 665f 7465  ons, index=df_te
-00068b10: 7374 2e69 6e64 6578 290a 2020 2020 656c  st.index).    el
-00068b20: 7365 3a0a 2020 2020 2020 2020 7265 7475  se:.        retu
-00068b30: 726e 2070 642e 5365 7269 6573 2870 7265  rn pd.Series(pre
-00068b40: 6469 6374 696f 6e73 290a 0a0a 6465 6620  dictions)...def 
-00068b50: 6e6f 7665 6c74 795f 6465 7465 6374 696f  novelty_detectio
-00068b60: 6e5f 6c6f 6f70 2864 665f 7472 6169 6e2c  n_loop(df_train,
-00068b70: 2064 665f 7465 7374 2c20 6e5f 6e65 6967   df_test, n_neig
-00068b80: 6862 6f72 733d 3230 2c20 6469 7374 616e  hbors=20, distan
-00068b90: 6365 5f6d 6574 7269 633d 276d 696e 6b6f  ce_metric='minko
-00068ba0: 7773 6b69 2729 3a0a 2020 2020 2222 220a  wski'):.    """.
-00068bb0: 2020 2020 5468 6973 2066 756e 6374 696f      This functio
-00068bc0: 6e20 7065 7266 6f72 6d73 206e 6f76 656c  n performs novel
-00068bd0: 7479 2064 6574 6563 7469 6f6e 2075 7369  ty detection usi
-00068be0: 6e67 204c 6f63 616c 204f 7574 6c69 6572  ng Local Outlier
-00068bf0: 2046 6163 746f 7220 284c 4f46 292e 0a0a   Factor (LOF)...
-00068c00: 2020 2020 5061 7261 6d65 7465 7273 3a0a      Parameters:.
-00068c10: 0a20 2020 202d 2064 665f 7472 6169 6e20  .    - df_train 
-00068c20: 2870 616e 6461 7320 6461 7461 6672 616d  (pandas datafram
-00068c30: 6529 3a20 7472 6169 6e69 6e67 2064 6174  e): training dat
-00068c40: 6120 7573 6564 2074 6f20 6669 7420 7468  a used to fit th
-00068c50: 6520 6d6f 6465 6c0a 0a20 2020 202d 2064  e model..    - d
-00068c60: 665f 7465 7374 2028 7061 6e64 6173 2064  f_test (pandas d
-00068c70: 6174 6166 7261 6d65 293a 2074 6573 7420  ataframe): test 
-00068c80: 6461 7461 2075 7365 6420 746f 2070 7265  data used to pre
-00068c90: 6469 6374 206e 6f76 656c 7469 6573 0a0a  dict novelties..
-00068ca0: 2020 2020 2d20 6e5f 6e65 6967 6862 6f72      - n_neighbor
-00068cb0: 7320 2869 6e74 293a 206e 756d 6265 7220  s (int): number 
-00068cc0: 6f66 206e 6569 6768 626f 7273 2075 7365  of neighbors use
-00068cd0: 6420 746f 2063 6f6d 7075 7465 2074 6865  d to compute the
-00068ce0: 204c 4f4f 5020 2864 6566 6175 6c74 3a20   LOOP (default: 
-00068cf0: 3230 290a 0a20 2020 202d 2064 6973 7461  20)..    - dista
-00068d00: 6e63 655f 6d65 7472 6963 203a 2064 6566  nce_metric : def
-00068d10: 6175 6c74 206d 696e 6b6f 7773 6b69 0a0a  ault minkowski..
-00068d20: 2020 2020 5265 7475 726e 733a 0a0a 2020      Returns:..  
-00068d30: 2020 2d20 7072 6564 6963 7469 6f6e 7320    - predictions 
-00068d40: 2870 616e 6461 7320 7365 7269 6573 293a  (pandas series):
-00068d50: 2070 7265 6469 6374 6564 206c 6162 656c   predicted label
-00068d60: 7320 666f 7220 7468 6520 7465 7374 2064  s for the test d
-00068d70: 6174 6120 2831 2066 6f72 206e 6f76 656c  ata (1 for novel
-00068d80: 7469 6573 2c20 3020 666f 7220 696e 6c69  ties, 0 for inli
-00068d90: 6572 7329 0a0a 2020 2020 2222 220a 2020  ers)..    """.  
-00068da0: 2020 6672 6f6d 2050 794e 6f6d 616c 7920    from PyNomaly 
-00068db0: 696d 706f 7274 206c 6f6f 700a 2020 2020  import loop.    
-00068dc0: 6672 6f6d 2073 6b6c 6561 726e 2e6e 6569  from sklearn.nei
-00068dd0: 6768 626f 7273 2069 6d70 6f72 7420 4e65  ghbors import Ne
-00068de0: 6172 6573 744e 6569 6768 626f 7273 0a20  arestNeighbors. 
-00068df0: 2020 2066 726f 6d20 736b 6c65 6172 6e2e     from sklearn.
-00068e00: 7072 6570 726f 6365 7373 696e 6720 696d  preprocessing im
-00068e10: 706f 7274 2053 7461 6e64 6172 6453 6361  port StandardSca
-00068e20: 6c65 720a 2020 2020 7363 616c 6572 203d  ler.    scaler =
-00068e30: 2053 7461 6e64 6172 6453 6361 6c65 7228   StandardScaler(
-00068e40: 290a 2020 2020 7363 616c 6572 2e66 6974  ).    scaler.fit
-00068e50: 2864 665f 7472 6169 6e29 0a20 2020 2064  (df_train).    d
-00068e60: 6174 6120 3d20 6e70 2e76 7374 6163 6b28  ata = np.vstack(
-00068e70: 205b 7363 616c 6572 2e74 7261 6e73 666f   [scaler.transfo
-00068e80: 726d 2864 665f 7465 7374 292c 7363 616c  rm(df_test),scal
-00068e90: 6572 2e74 7261 6e73 666f 726d 2864 665f  er.transform(df_
-00068ea0: 7472 6169 6e29 5d29 0a20 2020 206e 6569  train)]).    nei
-00068eb0: 6768 203d 204e 6561 7265 7374 4e65 6967  gh = NearestNeig
-00068ec0: 6862 6f72 7328 6e5f 6e65 6967 6862 6f72  hbors(n_neighbor
-00068ed0: 733d 6e5f 6e65 6967 6862 6f72 732c 206d  s=n_neighbors, m
-00068ee0: 6574 7269 633d 6469 7374 616e 6365 5f6d  etric=distance_m
-00068ef0: 6574 7269 6329 0a20 2020 206e 6569 6768  etric).    neigh
-00068f00: 2e66 6974 2864 6174 6129 0a20 2020 2064  .fit(data).    d
-00068f10: 2c20 6964 7820 3d20 6e65 6967 682e 6b6e  , idx = neigh.kn
-00068f20: 6569 6768 626f 7273 2864 6174 612c 2072  eighbors(data, r
-00068f30: 6574 7572 6e5f 6469 7374 616e 6365 3d54  eturn_distance=T
-00068f40: 7275 6529 0a20 2020 206d 203d 206c 6f6f  rue).    m = loo
-00068f50: 702e 4c6f 6361 6c4f 7574 6c69 6572 5072  p.LocalOutlierPr
-00068f60: 6f62 6162 696c 6974 7928 6469 7374 616e  obability(distan
-00068f70: 6365 5f6d 6174 7269 783d 642c 206e 6569  ce_matrix=d, nei
-00068f80: 6768 626f 725f 6d61 7472 6978 3d69 6478  ghbor_matrix=idx
-00068f90: 2c20 6e5f 6e65 6967 6862 6f72 733d 6e5f  , n_neighbors=n_
-00068fa0: 6e65 6967 6862 6f72 7329 2e66 6974 2829  neighbors).fit()
-00068fb0: 0a20 2020 2072 6574 7572 6e20 6d2e 6c6f  .    return m.lo
-00068fc0: 6361 6c5f 6f75 746c 6965 725f 7072 6f62  cal_outlier_prob
-00068fd0: 6162 696c 6974 6965 735b 7261 6e67 6528  abilities[range(
-00068fe0: 6466 5f74 6573 742e 7368 6170 655b 305d  df_test.shape[0]
-00068ff0: 295d 0a0a 0a0a 6465 6620 6e6f 7665 6c74  )]....def novelt
-00069000: 795f 6465 7465 6374 696f 6e5f 7175 616e  y_detection_quan
-00069010: 7469 6c65 2864 665f 7472 6169 6e2c 2064  tile(df_train, d
-00069020: 665f 7465 7374 293a 0a20 2020 2022 2222  f_test):.    """
-00069030: 0a20 2020 2054 6869 7320 6675 6e63 7469  .    This functi
-00069040: 6f6e 2070 6572 666f 726d 7320 6e6f 7665  on performs nove
-00069050: 6c74 7920 6465 7465 6374 696f 6e20 7573  lty detection us
-00069060: 696e 6720 7175 616e 7469 6c65 7320 666f  ing quantiles fo
-00069070: 7220 6561 6368 2063 6f6c 756d 6e2e 0a0a  r each column...
-00069080: 2020 2020 5061 7261 6d65 7465 7273 3a0a      Parameters:.
-00069090: 0a20 2020 202d 2064 665f 7472 6169 6e20  .    - df_train 
-000690a0: 2870 616e 6461 7320 6461 7461 6672 616d  (pandas datafram
-000690b0: 6529 3a20 7472 6169 6e69 6e67 2064 6174  e): training dat
-000690c0: 6120 7573 6564 2074 6f20 6669 7420 7468  a used to fit th
-000690d0: 6520 6d6f 6465 6c0a 0a20 2020 202d 2064  e model..    - d
-000690e0: 665f 7465 7374 2028 7061 6e64 6173 2064  f_test (pandas d
-000690f0: 6174 6166 7261 6d65 293a 2074 6573 7420  ataframe): test 
-00069100: 6461 7461 2075 7365 6420 746f 2070 7265  data used to pre
-00069110: 6469 6374 206e 6f76 656c 7469 6573 0a0a  dict novelties..
-00069120: 2020 2020 5265 7475 726e 733a 0a0a 2020      Returns:..  
-00069130: 2020 2d20 7175 616e 7469 6c65 7320 666f    - quantiles fo
-00069140: 7220 7468 6520 7465 7374 2073 616d 706c  r the test sampl
-00069150: 6520 6174 2065 6163 6820 636f 6c75 6d6e  e at each column
-00069160: 2077 6865 7265 2076 616c 7565 7320 7261   where values ra
-00069170: 6e67 6520 696e 205b 302c 315d 0a20 2020  nge in [0,1].   
-00069180: 2020 2020 2061 6e64 2068 6967 6865 7220       and higher 
-00069190: 7661 6c75 6573 206d 6561 6e20 7468 6520  values mean the 
-000691a0: 636f 6c75 6d6e 2069 7320 636c 6f73 6572  column is closer
-000691b0: 2074 6f20 7468 6520 6564 6765 206f 6620   to the edge of 
-000691c0: 7468 6520 6469 7374 7269 6275 7469 6f6e  the distribution
-000691d0: 0a0a 2020 2020 2222 220a 2020 2020 6d79  ..    """.    my
-000691e0: 7173 203d 2064 665f 7465 7374 2e63 6f70  qs = df_test.cop
-000691f0: 7928 290a 2020 2020 6e20 3d20 6466 5f74  y().    n = df_t
-00069200: 7261 696e 2e73 6861 7065 5b30 5d0a 2020  rain.shape[0].  
-00069210: 2020 6466 5f74 7261 696e 6b65 7973 203d    df_trainkeys =
-00069220: 2064 665f 7472 6169 6e2e 6b65 7973 2829   df_train.keys()
-00069230: 0a20 2020 2066 6f72 206b 2069 6e20 7261  .    for k in ra
-00069240: 6e67 6528 2064 665f 7472 6169 6e2e 7368  nge( df_train.sh
-00069250: 6170 655b 315d 2029 3a0a 2020 2020 2020  ape[1] ):.      
-00069260: 2020 6d79 6b65 7920 3d20 6466 5f74 7261    mykey = df_tra
-00069270: 696e 6b65 7973 5b6b 5d0a 2020 2020 2020  inkeys[k].      
-00069280: 2020 7465 6d70 203d 2028 6d79 7173 5b6d    temp = (myqs[m
-00069290: 796b 6579 5d5b 305d 203e 2020 6466 5f74  ykey][0] >  df_t
-000692a0: 7261 696e 5b6d 796b 6579 5d29 2e73 756d  rain[mykey]).sum
-000692b0: 2829 202f 206e 0a20 2020 2020 2020 206d  () / n.        m
-000692c0: 7971 735b 6d79 6b65 795d 203d 2061 6273  yqs[mykey] = abs
-000692d0: 2820 7465 6d70 202d 2030 2e35 2029 202f  ( temp - 0.5 ) /
-000692e0: 2030 2e35 0a20 2020 2072 6574 7572 6e20   0.5.    return 
-000692f0: 6d79 7173 0a0a 6465 6620 6272 6169 6e6d  myqs..def brainm
-00069300: 6170 5f66 6967 7572 6528 7374 6174 6973  ap_figure(statis
-00069310: 7469 6361 6c5f 6466 2c20 6461 7461 5f64  tical_df, data_d
-00069320: 6963 7469 6f6e 6172 795f 7061 7468 2c20  ictionary_path, 
-00069330: 6f75 7470 7574 5f70 7265 6669 782c 2062  output_prefix, b
-00069340: 7261 696e 5f69 6d61 6765 2c20 6f76 6572  rain_image, over
-00069350: 6c61 795f 636d 6170 3d27 6277 7227 2c20  lay_cmap='bwr', 
-00069360: 6e73 6c69 6365 733d 3231 2c20 6e63 6f6c  nslices=21, ncol
-00069370: 3d37 2c20 6564 6765 5f69 6d61 6765 5f64  =7, edge_image_d
-00069380: 696c 6174 696f 6e20 3d20 302c 2062 6c61  ilation = 0, bla
-00069390: 636b 5f62 673d 5472 7565 2c20 6178 6573  ck_bg=True, axes
-000693a0: 203d 205b 302c 312c 325d 2c20 6669 7865   = [0,1,2], fixe
-000693b0: 645f 6f76 6572 6c61 795f 7261 6e67 653d  d_overlay_range=
-000693c0: 4e6f 6e65 2c20 6372 6f70 3d35 2c20 7665  None, crop=5, ve
-000693d0: 7262 6f73 653d 4661 6c73 6520 293a 0a20  rbose=False ):. 
-000693e0: 2020 2022 2222 0a20 2020 2043 7265 6174     """.    Creat
-000693f0: 6520 6669 6775 7265 7320 6261 7365 6420  e figures based 
-00069400: 6f6e 2073 7461 7469 7374 6963 616c 2064  on statistical d
-00069410: 6174 6120 616e 6420 616e 2075 6e64 6572  ata and an under
-00069420: 6c79 696e 6720 6272 6169 6e20 696d 6167  lying brain imag
-00069430: 652e 0a0a 2020 2020 4173 7375 6d65 7320  e...    Assumes 
-00069440: 626f 7468 207e 2f2e 616e 7473 7079 7431  both ~/.antspyt1
-00069450: 7720 616e 6420 7e2f 2e61 6e74 7370 796d  w and ~/.antspym
-00069460: 6d20 6461 7461 2069 7320 6176 6169 6c61  m data is availa
-00069470: 626c 650a 0a20 2020 2050 6172 616d 6574  ble..    Paramet
-00069480: 6572 733a 0a20 2020 202d 2073 7461 7469  ers:.    - stati
-00069490: 7374 6963 616c 5f64 6620 2870 616e 6461  stical_df (panda
-000694a0: 7320 6461 7461 6672 616d 6529 3a20 7769  s dataframe): wi
-000694b0: 7468 2032 2063 6f6c 756d 6e73 206e 616d  th 2 columns nam
-000694c0: 6564 2061 6e61 7420 616e 6420 7661 6c75  ed anat and valu
-000694d0: 6573 0a20 2020 2020 2020 2074 6865 2061  es.        the a
-000694e0: 6e61 7420 636f 6c75 6d6e 2073 686f 756c  nat column shoul
-000694f0: 6420 6861 7665 206e 616d 6573 2074 6861  d have names tha
-00069500: 7420 6d65 6574 202a 7061 7274 6961 6c20  t meet *partial 
-00069510: 6d61 7463 6869 6e67 2a20 6372 6974 6572  matching* criter
-00069520: 696f 6e20 0a20 2020 2020 2020 2077 6974  ion .        wit
-00069530: 6820 7265 7370 6563 7420 746f 2072 6567  h respect to reg
-00069540: 696f 6e73 2074 6861 7420 6172 6520 6d65  ions that are me
-00069550: 6173 7572 6564 2069 6e20 616e 7473 7079  asured in antspy
-00069560: 6d6d 2e20 2020 7661 6c75 6520 7769 6c6c  mm.   value will
-00069570: 2062 6520 0a20 2020 2020 2020 2074 6865   be .        the
-00069580: 2076 616c 7565 2074 6f20 6265 2064 6973   value to be dis
-00069590: 706c 6179 6564 2e20 2020 6966 2074 776f  played.   if two
-000695a0: 2065 7861 6d70 6c65 7320 6f66 2061 2067   examples of a g
-000695b0: 6976 656e 2072 6567 696f 6e20 6578 6973  iven region exis
-000695c0: 7420 696e 200a 2020 2020 2020 2020 7374  t in .        st
-000695d0: 6174 6973 7469 6361 6c5f 6466 2c20 7468  atistical_df, th
-000695e0: 656e 2074 6865 206c 6172 6765 7374 2061  en the largest a
-000695f0: 6273 6f6c 7574 6520 7661 6c75 6520 7769  bsolute value wi
-00069600: 6c6c 2062 6520 7461 6b65 6e20 666f 7220  ll be taken for 
-00069610: 6469 7370 6c61 792e 0a20 2020 202d 2064  display..    - d
-00069620: 6174 615f 6469 6374 696f 6e61 7279 5f70  ata_dictionary_p
-00069630: 6174 6820 2873 7472 293a 2050 6174 6820  ath (str): Path 
-00069640: 746f 2074 6865 2064 6174 6120 6469 6374  to the data dict
-00069650: 696f 6e61 7279 2043 5356 2066 696c 652e  ionary CSV file.
-00069660: 0a20 2020 202d 206f 7574 7075 745f 7072  .    - output_pr
-00069670: 6566 6978 2028 7374 7229 3a20 5072 6566  efix (str): Pref
-00069680: 6978 2066 6f72 2074 6865 206f 7574 7075  ix for the outpu
-00069690: 7420 6669 6775 7265 2066 696c 656e 616d  t figure filenam
-000696a0: 6573 2e0a 2020 2020 2d20 6272 6169 6e5f  es..    - brain_
-000696b0: 696d 6167 6520 2861 6e74 7349 6d61 6765  image (antsImage
-000696c0: 293a 2074 6865 2062 7261 696e 2069 6d61  ): the brain ima
-000696d0: 6765 206f 6e20 7768 6963 6820 7265 7375  ge on which resu
-000696e0: 6c74 7320 7769 6c6c 206f 7665 726c 6179  lts will overlay
-000696f0: 2e0a 2020 2020 2d20 6f76 6572 6c61 795f  ..    - overlay_
-00069700: 636d 6170 2028 7374 7229 3a20 7365 6520  cmap (str): see 
-00069710: 6d61 7470 6c6f 746c 6962 0a20 2020 202d  matplotlib.    -
-00069720: 206e 736c 6963 6573 2028 696e 7429 3a20   nslices (int): 
-00069730: 6e75 6d62 6572 206f 6620 736c 6963 6573  number of slices
-00069740: 2074 6f20 7368 6f77 0a20 2020 202d 206e   to show.    - n
-00069750: 636f 6c20 2869 6e74 293a 206e 756d 6265  col (int): numbe
-00069760: 7220 6f66 2063 6f6c 756d 6e73 2074 6f20  r of columns to 
-00069770: 7368 6f77 0a20 2020 202d 2065 6467 655f  show.    - edge_
-00069780: 696d 6167 655f 6469 6c61 7469 6f6e 2028  image_dilation (
-00069790: 696e 7429 3a20 696e 7465 6765 7220 6772  int): integer gr
-000697a0: 6561 7465 7220 7468 616e 206f 7220 6571  eater than or eq
-000697b0: 7561 6c20 746f 207a 6572 6f0a 2020 2020  ual to zero.    
-000697c0: 2d20 626c 6163 6b5f 6267 2028 626f 6f6c  - black_bg (bool
-000697d0: 293a 2062 6f6f 6c65 616e 0a20 2020 202d  ): boolean.    -
-000697e0: 2061 7865 7320 286c 6973 7429 3a20 696e   axes (list): in
-000697f0: 7465 6765 7220 6c69 7374 2074 7970 6963  teger list typic
-00069800: 616c 6c79 205b 302c 312c 325d 2073 6167  ally [0,1,2] sag
-00069810: 6974 7461 6c20 636f 726f 6e61 6c20 6178  ittal coronal ax
-00069820: 6961 6c0a 2020 2020 2d20 6669 7865 645f  ial.    - fixed_
-00069830: 6f76 6572 6c61 795f 7261 6e67 6520 286c  overlay_range (l
-00069840: 6973 7429 3a20 7363 616c 6172 2070 6169  ist): scalar pai
-00069850: 7220 7769 6c6c 2074 7279 2074 6f20 6b65  r will try to ke
-00069860: 6570 2061 2063 6f6e 7374 616e 7420 6362  ep a constant cb
-00069870: 6172 2061 6e64 2077 696c 6c20 7472 756e  ar and will trun
-00069880: 6361 7465 2074 6865 206f 7665 726c 6179  cate the overlay
-00069890: 2061 7420 7468 6573 6520 6d69 6e2f 6d61   at these min/ma
-000698a0: 7820 7661 6c75 6573 0a20 2020 202d 2063  x values.    - c
-000698b0: 726f 7020 2869 6e74 293a 2063 726f 7073  rop (int): crops
-000698c0: 2074 6865 2069 6d61 6765 2074 6f20 6469   the image to di
-000698d0: 7370 6c61 7920 6279 2074 6865 2065 7874  splay by the ext
-000698e0: 656e 7420 6f66 2074 6865 206f 7665 726c  ent of the overl
-000698f0: 6179 3b20 6c61 7267 6572 2076 616c 7565  ay; larger value
-00069900: 7320 6469 6c61 7465 2074 6865 206d 6173  s dilate the mas
-00069910: 6b73 206d 6f72 652e 0a20 2020 202d 2076  ks more..    - v
-00069920: 6572 626f 7365 2028 626f 6f6c 293a 2062  erbose (bool): b
-00069930: 6f6f 6c65 616e 0a0a 2020 2020 5265 7475  oolean..    Retu
-00069940: 726e 733a 0a20 2020 2061 6e20 696d 6167  rns:.    an imag
-00069950: 6520 7769 7468 2076 616c 7565 7320 6d61  e with values ma
-00069960: 7070 6564 2074 6f20 7468 6520 6173 736f  pped to the asso
-00069970: 6369 6174 6564 2072 6567 696f 6e73 0a20  ciated regions. 
-00069980: 2020 2022 2222 0a20 2020 2069 6d70 6f72     """.    impor
-00069990: 7420 7265 0a0a 2020 2020 2320 5265 6164  t re..    # Read
-000699a0: 2074 6865 2073 7461 7469 7374 6963 616c   the statistical
-000699b0: 2066 696c 650a 2020 2020 7a7a 203d 2073   file.    zz = s
-000699c0: 7461 7469 7374 6963 616c 5f64 6620 0a20  tatistical_df . 
-000699d0: 2020 200a 2020 2020 2320 5265 6164 2074     .    # Read t
-000699e0: 6865 2064 6174 6120 6469 6374 696f 6e61  he data dictiona
-000699f0: 7279 2066 726f 6d20 6120 4353 5620 6669  ry from a CSV fi
-00069a00: 6c65 0a20 2020 206d 7964 6963 7420 3d20  le.    mydict = 
-00069a10: 7064 2e72 6561 645f 6373 7628 6461 7461  pd.read_csv(data
-00069a20: 5f64 6963 7469 6f6e 6172 795f 7061 7468  _dictionary_path
-00069a30: 290a 2020 2020 6d79 6469 6374 203d 206d  ).    mydict = m
-00069a40: 7964 6963 745b 7e6d 7964 6963 745b 274d  ydict[~mydict['M
-00069a50: 6561 7375 7265 6d65 6e74 275d 2e73 7472  easurement'].str
-00069a60: 2e63 6f6e 7461 696e 7328 2274 7261 6374  .contains("tract
-00069a70: 6f67 7261 7068 792d 6261 7365 6420 636f  ography-based co
-00069a80: 6e6e 6563 7469 7669 7479 222c 206e 613d  nnectivity", na=
-00069a90: 4661 6c73 6529 5d0a 0a20 2020 2073 7461  False)]..    sta
-00069aa0: 7469 7374 6963 616c 5f64 665b 2761 6e61  tistical_df['ana
-00069ab0: 7427 5d20 3d20 7374 6174 6973 7469 6361  t'] = statistica
-00069ac0: 6c5f 6466 5b27 616e 6174 275d 2e73 7472  l_df['anat'].str
-00069ad0: 2e72 6570 6c61 6365 2822 5f22 2c20 222e  .replace("_", ".
-00069ae0: 222c 2072 6567 6578 3d54 7275 6529 0a0a  ", regex=True)..
-00069af0: 2020 2020 2320 4c6f 6164 2069 6d61 6765      # Load image
-00069b00: 2061 6e64 2070 726f 6365 7373 2069 740a   and process it.
-00069b10: 2020 2020 6564 6765 696d 6720 3d20 616e      edgeimg = an
-00069b20: 7473 2e69 4d61 7468 2862 7261 696e 5f69  ts.iMath(brain_i
-00069b30: 6d61 6765 2c22 4e6f 726d 616c 697a 6522  mage,"Normalize"
-00069b40: 290a 2020 2020 6966 2065 6467 655f 696d  ).    if edge_im
-00069b50: 6167 655f 6469 6c61 7469 6f6e 203e 2030  age_dilation > 0
-00069b60: 3a0a 2020 2020 2020 2020 6564 6765 696d  :.        edgeim
-00069b70: 6720 3d20 616e 7473 2e69 4d61 7468 2820  g = ants.iMath( 
-00069b80: 6564 6765 696d 672c 2022 4d44 222c 2065  edgeimg, "MD", e
-00069b90: 6467 655f 696d 6167 655f 6469 6c61 7469  dge_image_dilati
-00069ba0: 6f6e 290a 0a20 2020 2023 2044 6566 696e  on)..    # Defin
-00069bb0: 6520 6c69 7374 7320 616e 6420 6461 7461  e lists and data
-00069bc0: 2066 7261 6d65 730a 2020 2020 706f 7374   frames.    post
-00069bd0: 6669 7820 3d20 5b27 6266 272c 2027 6369  fix = ['bf', 'ci
-00069be0: 7431 3638 6c61 6227 2c20 276d 746c 272c  t168lab', 'mtl',
-00069bf0: 2027 6365 7265 6265 6c6c 756d 272c 2027   'cerebellum', '
-00069c00: 646b 745f 636f 7274 6578 272c 2762 7261  dkt_cortex','bra
-00069c10: 696e 7374 656d 272c 274a 4855 5f77 6d27  instem','JHU_wm'
-00069c20: 2c27 7965 6f27 5d0a 2020 2020 6174 6c61  ,'yeo'].    atla
-00069c30: 7320 3d20 5b27 4246 272c 2027 4349 5431  s = ['BF', 'CIT1
-00069c40: 3638 272c 2027 4d54 4c27 2c20 2754 7573  68', 'MTL', 'Tus
-00069c50: 7469 736f 6e43 6f62 7261 272c 2027 6465  tisonCobra', 'de
-00069c60: 7369 6b61 6e2d 6b69 6c6c 6961 6e79 2d74  sikan-killiany-t
-00069c70: 6f75 7276 696c 6c65 272c 2762 7261 696e  ourville','brain
-00069c80: 7374 656d 272c 274a 4855 5f77 6d27 2c27  stem','JHU_wm','
-00069c90: 7965 6f27 5d0a 2020 2020 706f 7374 6465  yeo'].    postde
-00069ca0: 7363 203d 205b 276e 626d 3343 4831 3327  sc = ['nbm3CH13'
-00069cb0: 2c20 2743 4954 3136 385f 5265 696e 665f  , 'CIT168_Reinf_
-00069cc0: 4c65 6172 6e5f 7631 5f6c 6162 656c 5f64  Learn_v1_label_d
-00069cd0: 6573 6372 6970 7469 6f6e 735f 7061 6427  escriptions_pad'
-00069ce0: 2c20 276d 746c 5f64 6573 6372 6970 7469  , 'mtl_descripti
-00069cf0: 6f6e 272c 2027 6365 7265 6265 6c6c 756d  on', 'cerebellum
-00069d00: 272c 2027 646b 7427 2c27 4349 5431 3638  ', 'dkt','CIT168
-00069d10: 5f54 3177 5f37 3030 756d 5f70 6164 5f61  _T1w_700um_pad_a
-00069d20: 646e 695f 6272 6169 6e73 7465 6d27 2c27  dni_brainstem','
-00069d30: 4641 5f4a 4855 5f6c 6162 656c 735f 6564  FA_JHU_labels_ed
-00069d40: 6974 6564 272c 2770 706d 695f 7465 6d70  ited','ppmi_temp
-00069d50: 6c61 7465 5f35 3030 5061 7263 656c 735f  late_500Parcels_
-00069d60: 5965 6f32 3031 315f 3137 4e65 7477 6f72  Yeo2011_17Networ
-00069d70: 6b73 5f32 3032 335f 686f 6d6f 746f 7069  ks_2023_homotopi
-00069d80: 6327 5d0a 2020 2020 7374 6174 6466 203d  c'].    statdf =
-00069d90: 2070 642e 4461 7461 4672 616d 6528 7b27   pd.DataFrame({'
-00069da0: 696d 6727 3a20 706f 7374 6669 782c 2027  img': postfix, '
-00069db0: 6174 6c61 7327 3a20 6174 6c61 732c 2027  atlas': atlas, '
-00069dc0: 6373 7664 6573 6372 6970 7427 3a20 706f  csvdescript': po
-00069dd0: 7374 6465 7363 7d29 0a20 2020 2074 656d  stdesc}).    tem
-00069de0: 706c 6174 6570 7265 6669 7820 3d20 277e  plateprefix = '~
-00069df0: 2f2e 616e 7473 7079 6d6d 2f50 504d 495f  /.antspymm/PPMI_
-00069e00: 7465 6d70 6c61 7465 305f 270a 2020 2020  template0_'.    
-00069e10: 2320 4974 6572 6174 6520 7468 726f 7567  # Iterate throug
-00069e20: 6820 636f 6c75 6d6e 7320 616e 6420 6372  h columns and cr
-00069e30: 6561 7465 2066 6967 7572 6573 0a20 2020  eate figures.   
-00069e40: 2063 6f6c 3276 697a 203d 2027 7661 6c75   col2viz = 'valu
-00069e50: 6573 270a 2020 2020 6966 2054 7275 653a  es'.    if True:
-00069e60: 0a20 2020 2020 2020 2061 6e61 7474 6f73  .        anattos
-00069e70: 686f 7720 3d20 7a7a 5b27 616e 6174 275d  how = zz['anat']
-00069e80: 2e75 6e69 7175 6528 290a 2020 2020 2020  .unique().      
-00069e90: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-00069ea0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00069eb0: 636f 6c32 7669 7a29 0a20 2020 2020 2020  col2viz).       
-00069ec0: 2020 2020 2070 7269 6e74 2861 6e61 7474       print(anatt
-00069ed0: 6f73 686f 7729 0a20 2020 2020 2020 2023  oshow).        #
-00069ee0: 2052 6573 7420 6f66 2079 6f75 7220 636f   Rest of your co
-00069ef0: 6465 2066 6f72 2066 6967 7572 6520 6372  de for figure cr
-00069f00: 6561 7469 6f6e 2067 6f65 7320 6865 7265  eation goes here
-00069f10: 2e2e 2e0a 2020 2020 2020 2020 6164 6465  ....        adde
-00069f20: 6d20 3d20 6564 6765 696d 6720 2a20 300a  m = edgeimg * 0.
-00069f30: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
-00069f40: 2072 616e 6765 286c 656e 2861 6e61 7474   range(len(anatt
-00069f50: 6f73 686f 7729 293a 0a20 2020 2020 2020  oshow)):.       
-00069f60: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-00069f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00069f80: 2070 7269 6e74 2873 7472 286b 2920 2b20   print(str(k) + 
-00069f90: 2022 2022 202b 2061 6e61 7474 6f73 686f   " " + anattosho
-00069fa0: 775b 6b5d 2020 290a 2020 2020 2020 2020  w[k]  ).        
-00069fb0: 2020 2020 6d79 7375 6220 3d20 7a7a 5b7a      mysub = zz[z
-00069fc0: 7a5b 2761 6e61 7427 5d2e 7374 722e 636f  z['anat'].str.co
-00069fd0: 6e74 6169 6e73 2861 6e61 7474 6f73 686f  ntains(anattosho
-00069fe0: 775b 6b5d 295d 0a20 2020 2020 2020 2020  w[k])].         
-00069ff0: 2020 2061 6e61 7473 6561 723d 7265 2e73     anatsear=re.s
-0006a000: 7562 2822 6474 692e 6661 222c 2222 2c61  ub("dti.fa","",a
-0006a010: 6e61 7474 6f73 686f 775b 6b5d 290a 2020  nattoshow[k]).  
-0006a020: 2020 2020 2020 2020 2020 616e 6174 7365            anatse
-0006a030: 6172 3d72 652e 7375 6228 2263 6266 2e22  ar=re.sub("cbf."
-0006a040: 2c22 222c 616e 6174 7365 6172 290a 2020  ,"",anatsear).  
-0006a050: 2020 2020 2020 2020 2020 616e 6174 7365            anatse
-0006a060: 6172 3d72 652e 7375 6228 2274 312e 766f  ar=re.sub("t1.vo
-0006a070: 6c61 7379 6d22 2c22 222c 616e 6174 7365  lasym","",anatse
-0006a080: 6172 290a 2020 2020 2020 2020 2020 2020  ar).            
-0006a090: 616e 6174 7365 6172 3d72 652e 7375 6228  anatsear=re.sub(
-0006a0a0: 2274 312e 7468 6b61 7379 6d22 2c22 222c  "t1.thkasym","",
-0006a0b0: 616e 6174 7365 6172 290a 2020 2020 2020  anatsear).      
-0006a0c0: 2020 2020 2020 616e 6174 7365 6172 3d72        anatsear=r
-0006a0d0: 652e 7375 6228 2274 312e 6172 6561 6173  e.sub("t1.areaas
-0006a0e0: 796d 222c 2222 2c61 6e61 7473 6561 7229  ym","",anatsear)
-0006a0f0: 0a20 2020 2020 2020 2020 2020 2061 6e61  .            ana
-0006a100: 7473 6561 723d 7265 2e73 7562 2822 7431  tsear=re.sub("t1
-0006a110: 2e76 6f6c 2e22 2c22 222c 616e 6174 7365  .vol.","",anatse
-0006a120: 6172 290a 2020 2020 2020 2020 2020 2020  ar).            
-0006a130: 616e 6174 7365 6172 3d72 652e 7375 6228  anatsear=re.sub(
-0006a140: 2274 312e 7468 6b2e 222c 2222 2c61 6e61  "t1.thk.","",ana
-0006a150: 7473 6561 7229 0a20 2020 2020 2020 2020  tsear).         
-0006a160: 2020 2061 6e61 7473 6561 723d 7265 2e73     anatsear=re.s
-0006a170: 7562 2822 7431 2e61 7265 612e 222c 2222  ub("t1.area.",""
-0006a180: 2c61 6e61 7473 6561 7229 0a20 2020 2020  ,anatsear).     
-0006a190: 2020 2020 2020 2061 6e61 7473 6561 723d         anatsear=
-0006a1a0: 7265 2e73 7562 2822 6173 796d 6470 2e22  re.sub("asymdp."
-0006a1b0: 2c22 222c 616e 6174 7365 6172 290a 2020  ,"",anatsear).  
-0006a1c0: 2020 2020 2020 2020 2020 616e 6174 7365            anatse
-0006a1d0: 6172 3d72 652e 7375 6228 2261 7379 6d2e  ar=re.sub("asym.
-0006a1e0: 222c 2222 2c61 6e61 7473 6561 7229 0a20  ","",anatsear). 
-0006a1f0: 2020 2020 2020 2020 2020 2061 6e61 7473             anats
-0006a200: 6561 723d 7265 2e73 7562 2822 6474 692e  ear=re.sub("dti.
-0006a210: 6d64 2e22 2c22 222c 616e 6174 7365 6172  md.","",anatsear
-0006a220: 290a 2020 2020 2020 2020 2020 2020 616e  ).            an
-0006a230: 6174 7365 6172 3d72 652e 7375 6228 2264  atsear=re.sub("d
-0006a240: 7469 2e66 612e 222c 2222 2c61 6e61 7473  ti.fa.","",anats
-0006a250: 6561 7229 0a20 2020 2020 2020 2020 2020  ear).           
-0006a260: 2061 6e61 7473 6561 723d 7265 2e73 7562   anatsear=re.sub
-0006a270: 2822 6474 692e 6d64 222c 2222 2c61 6e61  ("dti.md","",ana
-0006a280: 7473 6561 7229 0a20 2020 2020 2020 2020  tsear).         
-0006a290: 2020 2061 6e61 7473 6561 723d 7265 2e73     anatsear=re.s
-0006a2a0: 7562 2822 6474 692e 6d65 616e 2e6d 642e  ub("dti.mean.md.
-0006a2b0: 222c 2222 2c61 6e61 7473 6561 7229 0a20  ","",anatsear). 
-0006a2c0: 2020 2020 2020 2020 2020 2061 6e61 7473             anats
-0006a2d0: 6561 723d 7265 2e73 7562 2822 6474 692e  ear=re.sub("dti.
-0006a2e0: 6d65 616e 2e66 612e 222c 2222 2c61 6e61  mean.fa.","",ana
-0006a2f0: 7473 6561 7229 0a20 2020 2020 2020 2020  tsear).         
-0006a300: 2020 2061 6e61 7473 6561 723d 7265 2e73     anatsear=re.s
-0006a310: 7562 2822 6c72 6176 6722 2c22 222c 616e  ub("lravg","",an
-0006a320: 6174 7365 6172 290a 2020 2020 2020 2020  atsear).        
-0006a330: 2020 2020 6174 6c61 7373 6561 7263 6820      atlassearch 
-0006a340: 3d20 6d79 6469 6374 5b27 7469 6479 6e61  = mydict['tidyna
-0006a350: 6d65 7327 5d2e 7374 722e 636f 6e74 6169  mes'].str.contai
-0006a360: 6e73 2861 6e61 7473 6561 7229 0a20 2020  ns(anatsear).   
-0006a370: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
-0006a380: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-0006a390: 2020 2020 2070 7269 6e74 2820 2220 616e       print( " an
-0006a3a0: 6174 7365 6172 2022 202b 2061 6e61 7473  atsear " + anats
-0006a3b0: 6561 7220 2b20 2220 6174 6c61 7373 6561  ear + " atlassea
-0006a3c0: 7263 6820 2220 290a 2020 2020 2020 2020  rch " ).        
-0006a3d0: 2020 2020 6966 2061 746c 6173 7365 6172      if atlassear
-0006a3e0: 6368 2e73 756d 2829 203e 2030 3a0a 2020  ch.sum() > 0:.  
-0006a3f0: 2020 2020 2020 2020 2020 2020 2020 7768                wh
-0006a400: 6963 6861 746c 6173 203d 206d 7964 6963  ichatlas = mydic
-0006a410: 745b 6174 6c61 7373 6561 7263 685d 5b27  t[atlassearch]['
-0006a420: 4174 6c61 7327 5d2e 696c 6f63 5b30 5d0a  Atlas'].iloc[0].
-0006a430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a440: 6f67 6c61 6265 6c6e 616d 6520 3d20 6d79  oglabelname = my
-0006a450: 6469 6374 5b61 746c 6173 7365 6172 6368  dict[atlassearch
-0006a460: 5d5b 274c 6162 656c 275d 2e69 6c6f 635b  ]['Label'].iloc[
-0006a470: 305d 0a20 2020 2020 2020 2020 2020 2065  0].            e
-0006a480: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0006a490: 2020 2020 2070 7269 6e74 2861 6e61 7473       print(anats
-0006a4a0: 6561 7229 0a20 2020 2020 2020 2020 2020  ear).           
-0006a4b0: 2020 2020 206f 676c 6162 656c 6e61 6d65       oglabelname
-0006a4c0: 3d27 756e 6b6e 6f77 6e27 0a20 2020 2020  ='unknown'.     
-0006a4d0: 2020 2020 2020 2020 2020 2077 6869 6368             which
-0006a4e0: 6174 6c61 733d 4e6f 6e65 0a20 2020 2020  atlas=None.     
-0006a4f0: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-0006a500: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0006a510: 2020 2070 7269 6e74 2822 6f67 6c61 6265     print("oglabe
-0006a520: 6c6e 616d 6520 2220 2b20 6f67 6c61 6265  lname " + oglabe
-0006a530: 6c6e 616d 6520 2b20 2220 7768 6963 6861  lname + " whicha
-0006a540: 746c 6173 2022 202b 2073 7472 2877 6869  tlas " + str(whi
-0006a550: 6368 6174 6c61 7329 2029 0a20 2020 2020  chatlas) ).     
-0006a560: 2020 2020 2020 2076 616c 7332 7669 7a20         vals2viz 
-0006a570: 3d20 6d79 7375 625b 636f 6c32 7669 7a5d  = mysub[col2viz]
-0006a580: 2e61 6767 285b 276d 696e 272c 2027 6d61  .agg(['min', 'ma
-0006a590: 7827 5d29 0a20 2020 2020 2020 2020 2020  x']).           
-0006a5a0: 2076 616c 7332 7669 7a20 3d20 7661 6c73   vals2viz = vals
-0006a5b0: 3276 697a 5b61 6273 2876 616c 7332 7669  2viz[abs(vals2vi
-0006a5c0: 7a29 2e69 6478 6d61 7828 295d 0a20 2020  z).idxmax()].   
-0006a5d0: 2020 2020 2020 2020 206d 7965 7874 203d           myext =
-0006a5e0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-0006a5f0: 2020 6966 2027 646b 7463 6f72 7465 7827    if 'dktcortex'
-0006a600: 2069 6e20 616e 6174 746f 7368 6f77 5b6b   in anattoshow[k
-0006a610: 5d20 6f72 2077 6869 6368 6174 6c61 7320  ] or whichatlas 
-0006a620: 3d3d 2027 6465 7369 6b61 6e2d 6b69 6c6c  == 'desikan-kill
-0006a630: 6961 6e79 2d74 6f75 7276 696c 6c65 2720  iany-tourville' 
-0006a640: 6f72 2027 6474 6b72 6567 696f 6e73 2720  or 'dtkregions' 
-0006a650: 696e 2061 6e61 7474 6f73 686f 775b 6b5d  in anattoshow[k]
-0006a660: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0006a670: 2020 6d79 6578 7420 3d20 2764 6b74 5f63    myext = 'dkt_c
-0006a680: 6f72 7465 7827 0a20 2020 2020 2020 2020  ortex'.         
-0006a690: 2020 2065 6c69 6620 2763 6974 3136 3827     elif 'cit168'
-0006a6a0: 2069 6e20 616e 6174 746f 7368 6f77 5b6b   in anattoshow[k
-0006a6b0: 5d20 6f72 2077 6869 6368 6174 6c61 7320  ] or whichatlas 
-0006a6c0: 3d3d 2027 4349 5431 3638 273a 0a20 2020  == 'CIT168':.   
-0006a6d0: 2020 2020 2020 2020 2020 2020 206d 7965               mye
-0006a6e0: 7874 203d 2027 6369 7431 3638 6c61 6227  xt = 'cit168lab'
-0006a6f0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-0006a700: 6620 276d 746c 2720 696e 2061 6e61 7474  f 'mtl' in anatt
-0006a710: 6f73 686f 775b 6b5d 3a0a 2020 2020 2020  oshow[k]:.      
-0006a720: 2020 2020 2020 2020 2020 6d79 6578 7420            myext 
-0006a730: 3d20 276d 746c 270a 2020 2020 2020 2020  = 'mtl'.        
-0006a740: 2020 2020 2020 2020 6f67 6c61 6265 6c6e          oglabeln
-0006a750: 616d 653d 7265 2e73 7562 2827 6d74 6c27  ame=re.sub('mtl'
-0006a760: 2c20 2727 2c61 6e61 7473 6561 7229 0a20  , '',anatsear). 
-0006a770: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0006a780: 2763 6572 6562 656c 6c75 6d27 2069 6e20  'cerebellum' in 
-0006a790: 616e 6174 746f 7368 6f77 5b6b 5d3a 0a20  anattoshow[k]:. 
-0006a7a0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0006a7b0: 7965 7874 203d 2027 6365 7265 6265 6c6c  yext = 'cerebell
-0006a7c0: 756d 270a 2020 2020 2020 2020 2020 2020  um'.            
-0006a7d0: 2020 2020 6f67 6c61 6265 6c6e 616d 653d      oglabelname=
-0006a7e0: 7265 2e73 7562 2827 6365 7265 6265 6c6c  re.sub('cerebell
-0006a7f0: 756d 272c 2027 272c 616e 6174 7365 6172  um', '',anatsear
-0006a800: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0006a810: 2020 2320 6f67 6c61 6265 6c6e 616d 653d    # oglabelname=
-0006a820: 6f67 6c61 6265 6c6e 616d 655b 323a 5d0a  oglabelname[2:].
-0006a830: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-0006a840: 2027 6272 6169 6e73 7465 6d27 2069 6e20   'brainstem' in 
-0006a850: 616e 6174 746f 7368 6f77 5b6b 5d3a 0a20  anattoshow[k]:. 
-0006a860: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0006a870: 7965 7874 203d 2027 6272 6169 6e73 7465  yext = 'brainste
-0006a880: 6d27 0a20 2020 2020 2020 2020 2020 2065  m'.            e
-0006a890: 6c69 6620 616e 7928 6974 656d 2069 6e20  lif any(item in 
-0006a8a0: 616e 6174 746f 7368 6f77 5b6b 5d20 666f  anattoshow[k] fo
-0006a8b0: 7220 6974 656d 2069 6e20 5b27 6e62 6d27  r item in ['nbm'
-0006a8c0: 2c20 2762 6627 5d29 3a0a 2020 2020 2020  , 'bf']):.      
-0006a8d0: 2020 2020 2020 2020 2020 6d79 6578 7420            myext 
-0006a8e0: 3d20 2762 6627 0a20 2020 2020 2020 2020  = 'bf'.         
-0006a8f0: 2020 2020 2020 206f 676c 6162 656c 6e61         oglabelna
-0006a900: 6d65 3d72 652e 7375 6228 7227 5c2e 272c  me=re.sub(r'\.',
-0006a910: 2027 5f27 2c61 6e61 7473 6561 7229 0a20   '_',anatsear). 
-0006a920: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0006a930: 7768 6963 6861 746c 6173 203d 3d20 276a  whichatlas == 'j
-0006a940: 6f68 6e73 2068 6f70 6b69 6e73 2077 6869  ohns hopkins whi
-0006a950: 7465 206d 6174 7465 7227 3a0a 2020 2020  te matter':.    
-0006a960: 2020 2020 2020 2020 2020 2020 6d79 6578              myex
-0006a970: 7420 3d20 274a 4855 5f77 6d27 0a20 2020  t = 'JHU_wm'.   
-0006a980: 2020 2020 2020 2020 2065 6c69 6620 7768           elif wh
-0006a990: 6963 6861 746c 6173 203d 3d20 2764 6573  ichatlas == 'des
-0006a9a0: 696b 616e 2d6b 696c 6c69 616e 792d 746f  ikan-killiany-to
-0006a9b0: 7572 7669 6c6c 6527 3a0a 2020 2020 2020  urville':.      
-0006a9c0: 2020 2020 2020 2020 2020 6d79 6578 7420            myext 
-0006a9d0: 3d20 2764 6b74 5f63 6f72 7465 7827 0a20  = 'dkt_cortex'. 
-0006a9e0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0006a9f0: 7768 6963 6861 746c 6173 203d 3d20 2743  whichatlas == 'C
-0006aa00: 4954 3136 3827 3a0a 2020 2020 2020 2020  IT168':.        
-0006aa10: 2020 2020 2020 2020 6d79 6578 7420 3d20          myext = 
-0006aa20: 2763 6974 3136 386c 6162 270a 2020 2020  'cit168lab'.    
-0006aa30: 2020 2020 2020 2020 656c 6966 2077 6869          elif whi
-0006aa40: 6368 6174 6c61 7320 3d3d 2027 4246 273a  chatlas == 'BF':
-0006aa50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006aa60: 206d 7965 7874 203d 2027 6266 270a 2020   myext = 'bf'.  
-0006aa70: 2020 2020 2020 2020 2020 2020 2020 6f67                og
-0006aa80: 6c61 6265 6c6e 616d 653d 7265 2e73 7562  labelname=re.sub
-0006aa90: 2827 6266 272c 2027 272c 6f67 6c61 6265  ('bf', '',oglabe
-0006aaa0: 6c6e 616d 6529 0a20 2020 2020 2020 2020  lname).         
-0006aab0: 2020 2065 6c69 6620 7768 6963 6861 746c     elif whichatl
-0006aac0: 6173 203d 3d20 2779 656f 5f68 6f6d 6f74  as == 'yeo_homot
-0006aad0: 6f70 6963 273a 0a20 2020 2020 2020 2020  opic':.         
-0006aae0: 2020 2020 2020 206d 7965 7874 203d 2027         myext = '
-0006aaf0: 7965 6f27 0a20 2020 2020 2020 2020 2020  yeo'.           
-0006ab00: 2069 6620 6d79 6578 7420 6973 204e 6f6e   if myext is Non
-0006ab10: 6520 616e 6420 7665 7262 6f73 653a 0a20  e and verbose:. 
-0006ab20: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0006ab30: 6620 7768 6963 6861 746c 6173 2069 7320  f whichatlas is 
-0006ab40: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0006ab50: 2020 2020 2020 2020 2020 7768 6963 6861            whicha
-0006ab60: 746c 6173 3d27 4e6f 6e65 270a 2020 2020  tlas='None'.    
-0006ab70: 2020 2020 2020 2020 2020 2020 6966 2061              if a
-0006ab80: 6e61 7474 6f73 686f 775b 6b5d 2069 7320  nattoshow[k] is 
-0006ab90: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0006aba0: 2020 2020 2020 2020 2020 616e 6174 746f            anatto
-0006abb0: 7368 6f77 5b6b 5d3d 274e 6f6e 6527 0a20  show[k]='None'. 
-0006abc0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0006abd0: 7269 6e74 2820 224d 5945 5854 2022 202b  rint( "MYEXT " +
-0006abe0: 2061 6e61 7474 6f73 686f 775b 6b5d 202b   anattoshow[k] +
-0006abf0: 2027 2075 6e66 6f75 6e64 2027 202b 2077   ' unfound ' + w
-0006ac00: 6869 6368 6174 6c61 7320 290a 2020 2020  hichatlas ).    
-0006ac10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0006ac20: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0006ac30: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-0006ac40: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0006ac50: 696e 7428 2022 4d59 4558 5420 2220 2b20  int( "MYEXT " + 
-0006ac60: 6d79 6578 7420 290a 0a20 2020 2020 2020  myext )..       
-0006ac70: 2020 2020 2069 6620 6d79 6578 7420 3d3d       if myext ==
-0006ac80: 2027 6369 7431 3638 6c61 6227 3a0a 2020   'cit168lab':.  
-0006ac90: 2020 2020 2020 2020 2020 2020 2020 6f67                og
-0006aca0: 6c61 6265 6c6e 616d 653d 7265 2e73 7562  labelname=re.sub
-0006acb0: 2822 6369 7431 3638 222c 2222 2c6f 676c  ("cit168","",ogl
-0006acc0: 6162 656c 6e61 6d65 290a 2020 2020 2020  abelname).      
-0006acd0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-0006ace0: 2020 2066 6f72 206a 2069 6e20 706f 7374     for j in post
-0006acf0: 6669 783a 0a20 2020 2020 2020 2020 2020  fix:.           
-0006ad00: 2020 2020 2069 6620 6a20 3d3d 2022 646b       if j == "dk
-0006ad10: 745f 636f 7274 6578 223a 0a20 2020 2020  t_cortex":.     
-0006ad20: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-0006ad30: 203d 2027 646b 7463 6f72 7465 7827 0a20   = 'dktcortex'. 
-0006ad40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0006ad50: 6620 6a20 3d3d 2022 6465 6570 5f63 6974  f j == "deep_cit
-0006ad60: 3136 386c 6162 223a 0a20 2020 2020 2020  168lab":.       
-0006ad70: 2020 2020 2020 2020 2020 2020 206a 203d               j =
-0006ad80: 2027 6465 6570 5f63 6974 3136 3827 0a20   'deep_cit168'. 
-0006ad90: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0006ada0: 6e61 7474 6f73 686f 775b 6b5d 203d 2061  nattoshow[k] = a
-0006adb0: 6e61 7474 6f73 686f 775b 6b5d 2e72 6570  nattoshow[k].rep
-0006adc0: 6c61 6365 286a 2c20 2222 290a 2020 2020  lace(j, "").    
-0006add0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-0006ade0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0006adf0: 2020 2020 7072 696e 7428 2061 6e61 7474      print( anatt
-0006ae00: 6f73 686f 775b 6b5d 202b 2022 2022 202b  oshow[k] + " " +
-0006ae10: 2073 7472 2820 7661 6c73 3276 697a 2029   str( vals2viz )
-0006ae20: 2029 0a20 2020 2020 2020 2020 2020 206d   ).            m
-0006ae30: 7961 746c 6173 203d 2061 746c 6173 5b70  yatlas = atlas[p
-0006ae40: 6f73 7466 6978 2e69 6e64 6578 286d 7965  ostfix.index(mye
-0006ae50: 7874 295d 0a20 2020 2020 2020 2020 2020  xt)].           
-0006ae60: 2063 6f72 7265 6374 6465 7363 7269 7074   correctdescript
-0006ae70: 203d 2070 6f73 7464 6573 635b 706f 7374   = postdesc[post
-0006ae80: 6669 782e 696e 6465 7828 6d79 6578 7429  fix.index(myext)
-0006ae90: 5d0a 2020 2020 2020 2020 2020 2020 6c6f  ].            lo
-0006aea0: 6366 696c 656e 616d 6520 3d20 2074 656d  cfilename =  tem
-0006aeb0: 706c 6174 6570 7265 6669 7820 2b20 6d79  plateprefix + my
-0006aec0: 6578 7420 2b20 272e 6e69 692e 677a 270a  ext + '.nii.gz'.
-0006aed0: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-0006aee0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-0006aef0: 2020 2020 2020 2020 7072 696e 7428 206c          print( l
-0006af00: 6f63 6669 6c65 6e61 6d65 2029 0a20 2020  ocfilename ).   
-0006af10: 2020 2020 2020 2020 2069 6620 6d79 6578           if myex
-0006af20: 7420 3d3d 2027 7965 6f27 3a0a 2020 2020  t == 'yeo':.    
-0006af30: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
-0006af40: 6265 6c6e 616d 653d 6f67 6c61 6265 6c6e  belname=oglabeln
-0006af50: 616d 652e 6c6f 7765 7228 290a 2020 2020  ame.lower().    
-0006af60: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
-0006af70: 6265 6c6e 616d 653d 7265 2e73 7562 2822  belname=re.sub("
-0006af80: 7273 666d 7269 5f66 636e 7870 726f 3132  rsfmri_fcnxpro12
-0006af90: 325f 222c 2222 2c6f 676c 6162 656c 6e61  2_","",oglabelna
-0006afa0: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0006afb0: 2020 2020 6f67 6c61 6265 6c6e 616d 653d      oglabelname=
-0006afc0: 7265 2e73 7562 2822 7273 666d 7269 5f66  re.sub("rsfmri_f
-0006afd0: 636e 7870 726f 3132 395f 222c 2222 2c6f  cnxpro129_","",o
-0006afe0: 676c 6162 656c 6e61 6d65 290a 2020 2020  glabelname).    
-0006aff0: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
-0006b000: 6265 6c6e 616d 653d 7265 2e73 7562 2822  belname=re.sub("
-0006b010: 7273 666d 7269 5f66 636e 7870 726f 3133  rsfmri_fcnxpro13
-0006b020: 345f 222c 2222 2c6f 676c 6162 656c 6e61  4_","",oglabelna
-0006b030: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0006b040: 2020 2020 6c6f 6366 696c 656e 616d 6520      locfilename 
-0006b050: 3d20 227e 2f2e 616e 7473 7079 6d6d 2f70  = "~/.antspymm/p
-0006b060: 706d 695f 7465 6d70 6c61 7465 5f35 3030  pmi_template_500
-0006b070: 5061 7263 656c 735f 5965 6f32 3031 315f  Parcels_Yeo2011_
-0006b080: 3137 4e65 7477 6f72 6b73 5f32 3032 335f  17Networks_2023_
-0006b090: 686f 6d6f 746f 7069 632e 6e69 692e 677a  homotopic.nii.gz
-0006b0a0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0006b0b0: 2020 6174 6c61 7344 6573 6372 6970 7420    atlasDescript 
-0006b0c0: 3d20 7064 2e72 6561 645f 6373 7628 6622  = pd.read_csv(f"
-0006b0d0: 7e2f 2e61 6e74 7370 796d 6d2f 7b63 6f72  ~/.antspymm/{cor
-0006b0e0: 7265 6374 6465 7363 7269 7074 7d2e 6373  rectdescript}.cs
-0006b0f0: 7622 290a 2020 2020 2020 2020 2020 2020  v").            
-0006b100: 2020 2020 6174 6c61 7344 6573 6372 6970      atlasDescrip
-0006b110: 742e 7265 6e61 6d65 2863 6f6c 756d 6e73  t.rename(columns
-0006b120: 3d7b 2753 7973 7465 6d4e 616d 6527 3a20  ={'SystemName': 
-0006b130: 2744 6573 6372 6970 7469 6f6e 277d 2c20  'Description'}, 
-0006b140: 696e 706c 6163 653d 5472 7565 290a 2020  inplace=True).  
-0006b150: 2020 2020 2020 2020 2020 2020 2020 6174                at
-0006b160: 6c61 7344 6573 6372 6970 742e 7265 6e61  lasDescript.rena
-0006b170: 6d65 2863 6f6c 756d 6e73 3d7b 2752 4f49  me(columns={'ROI
-0006b180: 273a 2027 4c61 6265 6c27 7d2c 2069 6e70  ': 'Label'}, inp
-0006b190: 6c61 6365 3d54 7275 6529 0a20 2020 2020  lace=True).     
-0006b1a0: 2020 2020 2020 2020 2020 2061 746c 6173             atlas
-0006b1b0: 4465 7363 7269 7074 5b27 4465 7363 7269  Descript['Descri
-0006b1c0: 7074 696f 6e27 5d20 3d20 6174 6c61 7344  ption'] = atlasD
-0006b1d0: 6573 6372 6970 745b 2744 6573 6372 6970  escript['Descrip
-0006b1e0: 7469 6f6e 275d 2e73 7472 2e6c 6f77 6572  tion'].str.lower
-0006b1f0: 2829 0a20 2020 2020 2020 2020 2020 2065  ().            e
-0006b200: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0006b210: 2020 2020 2061 746c 6173 4465 7363 7269       atlasDescri
-0006b220: 7074 203d 2070 642e 7265 6164 5f63 7376  pt = pd.read_csv
-0006b230: 2866 227e 2f2e 616e 7473 7079 7431 772f  (f"~/.antspyt1w/
-0006b240: 7b63 6f72 7265 6374 6465 7363 7269 7074  {correctdescript
-0006b250: 7d2e 6373 7622 290a 2020 2020 2020 2020  }.csv").        
-0006b260: 2020 2020 2020 2020 6174 6c61 7344 6573          atlasDes
-0006b270: 6372 6970 745b 2744 6573 6372 6970 7469  cript['Descripti
-0006b280: 6f6e 275d 203d 2061 746c 6173 4465 7363  on'] = atlasDesc
-0006b290: 7269 7074 5b27 4465 7363 7269 7074 696f  ript['Descriptio
-0006b2a0: 6e27 5d2e 7374 722e 6c6f 7765 7228 290a  n'].str.lower().
-0006b2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b2c0: 6174 6c61 7344 6573 6372 6970 745b 2744  atlasDescript['D
-0006b2d0: 6573 6372 6970 7469 6f6e 275d 203d 2061  escription'] = a
-0006b2e0: 746c 6173 4465 7363 7269 7074 5b27 4465  tlasDescript['De
-0006b2f0: 7363 7269 7074 696f 6e27 5d2e 7374 722e  scription'].str.
-0006b300: 7265 706c 6163 6528 2220 222c 2022 5f22  replace(" ", "_"
-0006b310: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0006b320: 2020 6174 6c61 7344 6573 6372 6970 745b    atlasDescript[
-0006b330: 2744 6573 6372 6970 7469 6f6e 275d 203d  'Description'] =
-0006b340: 2061 746c 6173 4465 7363 7269 7074 5b27   atlasDescript['
-0006b350: 4465 7363 7269 7074 696f 6e27 5d2e 7374  Description'].st
-0006b360: 722e 7265 706c 6163 6528 225f 6c65 6674  r.replace("_left
-0006b370: 5f22 2c20 225f 2229 0a20 2020 2020 2020  _", "_").       
-0006b380: 2020 2020 2020 2020 2061 746c 6173 4465           atlasDe
-0006b390: 7363 7269 7074 5b27 4465 7363 7269 7074  script['Descript
-0006b3a0: 696f 6e27 5d20 3d20 6174 6c61 7344 6573  ion'] = atlasDes
-0006b3b0: 6372 6970 745b 2744 6573 6372 6970 7469  cript['Descripti
-0006b3c0: 6f6e 275d 2e73 7472 2e72 6570 6c61 6365  on'].str.replace
-0006b3d0: 2822 5f72 6967 6874 5f22 2c20 225f 2229  ("_right_", "_")
-0006b3e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006b3f0: 2061 746c 6173 4465 7363 7269 7074 5b27   atlasDescript['
-0006b400: 4465 7363 7269 7074 696f 6e27 5d20 3d20  Description'] = 
-0006b410: 6174 6c61 7344 6573 6372 6970 745b 2744  atlasDescript['D
-0006b420: 6573 6372 6970 7469 6f6e 275d 2e73 7472  escription'].str
-0006b430: 2e72 6570 6c61 6365 2822 5f6c 6566 7422  .replace("_left"
-0006b440: 2c20 2222 290a 2020 2020 2020 2020 2020  , "").          
-0006b450: 2020 2020 2020 6174 6c61 7344 6573 6372        atlasDescr
-0006b460: 6970 745b 2744 6573 6372 6970 7469 6f6e  ipt['Description
-0006b470: 275d 203d 2061 746c 6173 4465 7363 7269  '] = atlasDescri
-0006b480: 7074 5b27 4465 7363 7269 7074 696f 6e27  pt['Description'
-0006b490: 5d2e 7374 722e 7265 706c 6163 6528 225f  ].str.replace("_
-0006b4a0: 7269 6768 7422 2c20 2222 290a 2020 2020  right", "").    
-0006b4b0: 2020 2020 2020 2020 2020 2020 6174 6c61              atla
-0006b4c0: 7344 6573 6372 6970 745b 2744 6573 6372  sDescript['Descr
-0006b4d0: 6970 7469 6f6e 275d 203d 2061 746c 6173  iption'] = atlas
-0006b4e0: 4465 7363 7269 7074 5b27 4465 7363 7269  Descript['Descri
-0006b4f0: 7074 696f 6e27 5d2e 7374 722e 7265 706c  ption'].str.repl
-0006b500: 6163 6528 226c 6566 745f 222c 2022 2229  ace("left_", "")
-0006b510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006b520: 2061 746c 6173 4465 7363 7269 7074 5b27   atlasDescript['
-0006b530: 4465 7363 7269 7074 696f 6e27 5d20 3d20  Description'] = 
-0006b540: 6174 6c61 7344 6573 6372 6970 745b 2744  atlasDescript['D
-0006b550: 6573 6372 6970 7469 6f6e 275d 2e73 7472  escription'].str
-0006b560: 2e72 6570 6c61 6365 2822 7269 6768 745f  .replace("right_
-0006b570: 222c 2022 2229 0a20 2020 2020 2020 2020  ", "").         
-0006b580: 2020 2020 2020 2061 746c 6173 4465 7363         atlasDesc
-0006b590: 7269 7074 5b27 4465 7363 7269 7074 696f  ript['Descriptio
-0006b5a0: 6e27 5d20 3d20 6174 6c61 7344 6573 6372  n'] = atlasDescr
-0006b5b0: 6970 745b 2744 6573 6372 6970 7469 6f6e  ipt['Description
-0006b5c0: 275d 2e73 7472 2e72 6570 6c61 6365 2822  '].str.replace("
-0006b5d0: 2f22 2c22 2e22 290a 2020 2020 2020 2020  /",".").        
-0006b5e0: 2020 2020 2020 2020 6966 206d 7965 7874          if myext
-0006b5f0: 203d 3d20 274a 4855 5f77 6d27 3a0a 2020   == 'JHU_wm':.  
-0006b600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b610: 2020 6174 6c61 7344 6573 6372 6970 745b    atlasDescript[
-0006b620: 2744 6573 6372 6970 7469 6f6e 275d 203d  'Description'] =
-0006b630: 2061 746c 6173 4465 7363 7269 7074 5b27   atlasDescript['
-0006b640: 4465 7363 7269 7074 696f 6e27 5d2e 7374  Description'].st
-0006b650: 722e 7265 706c 6163 6528 2266 612d 222c  r.replace("fa-",
-0006b660: 2022 2229 0a20 2020 2020 2020 2020 2020   "").           
-0006b670: 2020 2020 2020 2020 2061 746c 6173 4465           atlasDe
-0006b680: 7363 7269 7074 5b27 4465 7363 7269 7074  script['Descript
-0006b690: 696f 6e27 5d20 3d20 6174 6c61 7344 6573  ion'] = atlasDes
-0006b6a0: 6372 6970 745b 2744 6573 6372 6970 7469  cript['Descripti
-0006b6b0: 6f6e 275d 2e73 7472 2e72 6570 6c61 6365  on'].str.replace
-0006b6c0: 2822 2d6c 6566 742d 222c 2022 2229 0a20  ("-left-", ""). 
-0006b6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b6e0: 2020 2061 746c 6173 4465 7363 7269 7074     atlasDescript
-0006b6f0: 5b27 4465 7363 7269 7074 696f 6e27 5d20  ['Description'] 
-0006b700: 3d20 6174 6c61 7344 6573 6372 6970 745b  = atlasDescript[
-0006b710: 2744 6573 6372 6970 7469 6f6e 275d 2e73  'Description'].s
-0006b720: 7472 2e72 6570 6c61 6365 2822 2d72 6967  tr.replace("-rig
-0006b730: 6874 2d22 2c20 2222 290a 2020 2020 2020  ht-", "").      
-0006b740: 2020 2020 2020 2020 2020 6966 206d 7965            if mye
-0006b750: 7874 203d 3d20 2763 6572 6562 656c 6c75  xt == 'cerebellu
-0006b760: 6d27 3a0a 2020 2020 2020 2020 2020 2020  m':.            
-0006b770: 2020 2020 2020 2020 6174 6c61 7344 6573          atlasDes
-0006b780: 6372 6970 745b 2744 6573 6372 6970 7469  cript['Descripti
-0006b790: 6f6e 275d 203d 2061 746c 6173 4465 7363  on'] = atlasDesc
-0006b7a0: 7269 7074 5b27 4465 7363 7269 7074 696f  ript['Descriptio
-0006b7b0: 6e27 5d2e 7374 722e 7265 706c 6163 6528  n'].str.replace(
-0006b7c0: 226c 5f22 2c20 2222 290a 2020 2020 2020  "l_", "").      
-0006b7d0: 2020 2020 2020 2020 2020 2020 2020 6174                at
-0006b7e0: 6c61 7344 6573 6372 6970 745b 2744 6573  lasDescript['Des
-0006b7f0: 6372 6970 7469 6f6e 275d 203d 2061 746c  cription'] = atl
-0006b800: 6173 4465 7363 7269 7074 5b27 4465 7363  asDescript['Desc
-0006b810: 7269 7074 696f 6e27 5d2e 7374 722e 7265  ription'].str.re
-0006b820: 706c 6163 6528 2272 5f22 2c20 2222 290a  place("r_", "").
-0006b830: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0006b840: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-0006b850: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
-0006b860: 6174 6c61 7344 6573 6372 6970 7420 290a  atlasDescript ).
-0006b870: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
-0006b880: 6265 6c6e 616d 6520 3d20 6f67 6c61 6265  belname = oglabe
-0006b890: 6c6e 616d 652e 6c6f 7765 7228 290a 2020  lname.lower().  
-0006b8a0: 2020 2020 2020 2020 2020 6f67 6c61 6265            oglabe
-0006b8b0: 6c6e 616d 6520 3d20 7265 2e73 7562 2822  lname = re.sub("
-0006b8c0: 2022 2c20 225f 222c 6f67 6c61 6265 6c6e   ", "_",oglabeln
-0006b8d0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-0006b8e0: 206f 676c 6162 656c 6e61 6d65 203d 2072   oglabelname = r
-0006b8f0: 652e 7375 6228 225f 6c65 6674 5f22 2c20  e.sub("_left_", 
-0006b900: 225f 222c 6f67 6c61 6265 6c6e 616d 6529  "_",oglabelname)
-0006b910: 0a20 2020 2020 2020 2020 2020 206f 676c  .            ogl
-0006b920: 6162 656c 6e61 6d65 203d 2072 652e 7375  abelname = re.su
-0006b930: 6228 225f 7269 6768 745f 222c 2022 5f22  b("_right_", "_"
-0006b940: 2c6f 676c 6162 656c 6e61 6d65 290a 2020  ,oglabelname).  
-0006b950: 2020 2020 2020 2020 2020 6f67 6c61 6265            oglabe
-0006b960: 6c6e 616d 6520 3d20 7265 2e73 7562 2822  lname = re.sub("
-0006b970: 5f6c 6566 7422 2c20 2222 2c6f 676c 6162  _left", "",oglab
-0006b980: 656c 6e61 6d65 290a 2020 2020 2020 2020  elname).        
-0006b990: 2020 2020 6f67 6c61 6265 6c6e 616d 6520      oglabelname 
-0006b9a0: 3d20 7265 2e73 7562 2822 5f72 6967 6874  = re.sub("_right
-0006b9b0: 222c 2022 222c 6f67 6c61 6265 6c6e 616d  ", "",oglabelnam
-0006b9c0: 6529 0a20 2020 2020 2020 2020 2020 206f  e).            o
-0006b9d0: 676c 6162 656c 6e61 6d65 203d 2072 652e  glabelname = re.
-0006b9e0: 7375 6228 2274 3168 6965 725f 766f 6c5f  sub("t1hier_vol_
-0006b9f0: 222c 2022 222c 6f67 6c61 6265 6c6e 616d  ", "",oglabelnam
-0006ba00: 6529 0a20 2020 2020 2020 2020 2020 206f  e).            o
-0006ba10: 676c 6162 656c 6e61 6d65 203d 2072 652e  glabelname = re.
-0006ba20: 7375 6228 2274 3168 6965 725f 6172 6561  sub("t1hier_area
-0006ba30: 5f22 2c20 2222 2c6f 676c 6162 656c 6e61  _", "",oglabelna
-0006ba40: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0006ba50: 6f67 6c61 6265 6c6e 616d 6520 3d20 7265  oglabelname = re
-0006ba60: 2e73 7562 2822 7431 6869 6572 5f74 686b  .sub("t1hier_thk
-0006ba70: 5f22 2c20 2222 2c6f 676c 6162 656c 6e61  _", "",oglabelna
-0006ba80: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0006ba90: 6f67 6c61 6265 6c6e 616d 6520 3d20 7265  oglabelname = re
-0006baa0: 2e73 7562 2822 646b 7472 6567 696f 6e73  .sub("dktregions
-0006bab0: 222c 2022 222c 6f67 6c61 6265 6c6e 616d  ", "",oglabelnam
-0006bac0: 6529 0a20 2020 2020 2020 2020 2020 206f  e).            o
-0006bad0: 676c 6162 656c 6e61 6d65 203d 2072 652e  glabelname = re.
-0006bae0: 7375 6228 2264 6b74 636f 7274 6578 222c  sub("dktcortex",
-0006baf0: 2022 222c 6f67 6c61 6265 6c6e 616d 6529   "",oglabelname)
-0006bb00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0006bb10: 6d79 6578 7420 3d3d 2027 4a48 555f 776d  myext == 'JHU_wm
-0006bb20: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-0006bb30: 2020 206f 676c 6162 656c 6e61 6d65 203d     oglabelname =
-0006bb40: 2072 652e 7375 6228 2264 7469 5f6d 6561   re.sub("dti_mea
-0006bb50: 6e5f 6661 2e22 2c20 2222 2c6f 676c 6162  n_fa.", "",oglab
-0006bb60: 656c 6e61 6d65 290a 2020 2020 2020 2020  elname).        
-0006bb70: 2020 2020 2020 2020 6f67 6c61 6265 6c6e          oglabeln
-0006bb80: 616d 6520 3d20 7265 2e73 7562 2822 6474  ame = re.sub("dt
-0006bb90: 695f 6d65 616e 5f6d 642e 222c 2022 222c  i_mean_md.", "",
-0006bba0: 6f67 6c61 6265 6c6e 616d 6529 0a20 2020  oglabelname).   
-0006bbb0: 2020 2020 2020 2020 2020 2020 206f 676c               ogl
-0006bbc0: 6162 656c 6e61 6d65 203d 2072 652e 7375  abelname = re.su
-0006bbd0: 6228 222e 6c65 6674 2e22 2c20 2222 2c6f  b(".left.", "",o
-0006bbe0: 676c 6162 656c 6e61 6d65 290a 2020 2020  glabelname).    
-0006bbf0: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
-0006bc00: 6265 6c6e 616d 6520 3d20 7265 2e73 7562  belname = re.sub
-0006bc10: 2822 2e72 6967 6874 2e22 2c20 2222 2c6f  (".right.", "",o
-0006bc20: 676c 6162 656c 6e61 6d65 290a 2020 2020  glabelname).    
-0006bc30: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
-0006bc40: 6265 6c6e 616d 6520 3d20 7265 2e73 7562  belname = re.sub
-0006bc50: 2822 2e6c 7261 7667 2e22 2c20 2222 2c6f  (".lravg.", "",o
-0006bc60: 676c 6162 656c 6e61 6d65 290a 2020 2020  glabelname).    
-0006bc70: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
-0006bc80: 6265 6c6e 616d 6520 3d20 7265 2e73 7562  belname = re.sub
-0006bc90: 2822 2e61 7379 6d2e 222c 2022 222c 6f67  (".asym.", "",og
-0006bca0: 6c61 6265 6c6e 616d 6529 0a0a 2020 2020  labelname)..    
-0006bcb0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-0006bcc0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0006bcd0: 2020 2020 7072 696e 7428 226f 676c 6162      print("oglab
-0006bce0: 656c 6e61 6d65 2022 202b 206f 676c 6162  elname " + oglab
-0006bcf0: 656c 6e61 6d65 2029 0a0a 2020 2020 2020  elname )..      
-0006bd00: 2020 2020 2020 6966 206d 7965 7874 203d        if myext =
-0006bd10: 3d20 2763 6572 6562 656c 6c75 6d27 3a0a  = 'cerebellum':.
-0006bd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006bd30: 6966 206e 6f74 2061 746c 6173 4465 7363  if not atlasDesc
-0006bd40: 7269 7074 2e65 6d70 7479 2061 6e64 2027  ript.empty and '
-0006bd50: 4465 7363 7269 7074 696f 6e27 2069 6e20  Description' in 
-0006bd60: 6174 6c61 7344 6573 6372 6970 742e 636f  atlasDescript.co
-0006bd70: 6c75 6d6e 733a 0a20 2020 2020 2020 2020  lumns:.         
-0006bd80: 2020 2020 2020 2020 2020 2061 746c 6173             atlas
-0006bd90: 4465 7363 7269 7074 5b27 4465 7363 7269  Descript['Descri
-0006bda0: 7074 696f 6e27 5d20 3d20 6174 6c61 7344  ption'] = atlasD
-0006bdb0: 6573 6372 6970 745b 2744 6573 6372 6970  escript['Descrip
-0006bdc0: 7469 6f6e 275d 2e73 7472 2e72 6570 6c61  tion'].str.repla
-0006bdd0: 6365 2822 6c5f 222c 2022 2229 0a20 2020  ce("l_", "").   
-0006bde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006bdf0: 2061 746c 6173 4465 7363 7269 7074 5b27   atlasDescript['
-0006be00: 4465 7363 7269 7074 696f 6e27 5d20 3d20  Description'] = 
-0006be10: 6174 6c61 7344 6573 6372 6970 745b 2744  atlasDescript['D
-0006be20: 6573 6372 6970 7469 6f6e 275d 2e73 7472  escription'].str
-0006be30: 2e72 6570 6c61 6365 2822 725f 222c 2022  .replace("r_", "
-0006be40: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-0006be50: 2020 2020 2020 206f 676c 6162 656c 6e61         oglabelna
-0006be60: 6d65 3d72 652e 7375 6228 2272 6176 6722  me=re.sub("ravg"
-0006be70: 2c22 222c 6f67 6c61 6265 6c6e 616d 6529  ,"",oglabelname)
-0006be80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006be90: 2020 2020 206f 676c 6162 656c 6e61 6d65       oglabelname
-0006bea0: 3d72 652e 7375 6228 226c 6176 6722 2c22  =re.sub("lavg","
-0006beb0: 222c 6f67 6c61 6265 6c6e 616d 6529 0a20  ",oglabelname). 
-0006bec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006bed0: 2020 2077 6869 6368 696e 6465 7820 3d20     whichindex = 
-0006bee0: 6174 6c61 7344 6573 6372 6970 742e 696e  atlasDescript.in
-0006bef0: 6465 785b 6174 6c61 7344 6573 6372 6970  dex[atlasDescrip
-0006bf00: 745b 2744 6573 6372 6970 7469 6f6e 275d  t['Description']
-0006bf10: 203d 3d20 6f67 6c61 6265 6c6e 616d 655d   == oglabelname]
-0006bf20: 2e76 616c 7565 735b 305d 0a20 2020 2020  .values[0].     
-0006bf30: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0006bf40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006bf50: 2020 2020 2069 6620 6174 6c61 7344 6573       if atlasDes
-0006bf60: 6372 6970 742e 656d 7074 793a 0a20 2020  cript.empty:.   
-0006bf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006bf80: 2020 2020 2070 7269 6e74 2822 5468 6520       print("The 
-0006bf90: 4461 7461 4672 616d 6520 2761 746c 6173  DataFrame 'atlas
-0006bfa0: 4465 7363 7269 7074 2720 6973 2065 6d70  Descript' is emp
-0006bfb0: 7479 2e22 290a 2020 2020 2020 2020 2020  ty.").          
-0006bfc0: 2020 2020 2020 2020 2020 6966 2027 4465            if 'De
-0006bfd0: 7363 7269 7074 696f 6e27 206e 6f74 2069  scription' not i
-0006bfe0: 6e20 6174 6c61 7344 6573 6372 6970 742e  n atlasDescript.
-0006bff0: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
-0006c000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c010: 2070 7269 6e74 2822 5468 6520 636f 6c75   print("The colu
-0006c020: 6d6e 2027 4465 7363 7269 7074 696f 6e27  mn 'Description'
-0006c030: 2064 6f65 7320 6e6f 7420 6578 6973 7420   does not exist 
-0006c040: 696e 2027 6174 6c61 7344 6573 6372 6970  in 'atlasDescrip
-0006c050: 7427 2e22 290a 2020 2020 2020 2020 2020  t'.").          
-0006c060: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0006c070: 2020 2020 2020 2020 7768 6963 6869 6e64          whichind
-0006c080: 6578 203d 2061 746c 6173 4465 7363 7269  ex = atlasDescri
-0006c090: 7074 2e69 6e64 6578 5b61 746c 6173 4465  pt.index[atlasDe
-0006c0a0: 7363 7269 7074 5b27 4465 7363 7269 7074  script['Descript
-0006c0b0: 696f 6e27 5d2e 7374 722e 636f 6e74 6169  ion'].str.contai
-0006c0c0: 6e73 286f 676c 6162 656c 6e61 6d65 295d  ns(oglabelname)]
-0006c0d0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0006c0e0: 2074 7970 6528 7768 6963 6869 6e64 6578   type(whichindex
-0006c0f0: 2920 6973 206e 702e 696e 7436 343a 0a20  ) is np.int64:. 
-0006c100: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0006c110: 6162 656c 6e75 6d73 203d 2061 746c 6173  abelnums = atlas
-0006c120: 4465 7363 7269 7074 2e6c 6f63 5b77 6869  Descript.loc[whi
-0006c130: 6368 696e 6465 782c 2027 4c61 6265 6c27  chindex, 'Label'
-0006c140: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
-0006c150: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0006c160: 2020 2020 6c61 6265 6c6e 756d 7320 3d20      labelnums = 
-0006c170: 6c69 7374 2861 746c 6173 4465 7363 7269  list(atlasDescri
-0006c180: 7074 2e6c 6f63 5b77 6869 6368 696e 6465  pt.loc[whichinde
-0006c190: 782c 2027 4c61 6265 6c27 5d29 0a0a 2020  x, 'Label'])..  
-0006c1a0: 2020 2020 2020 2020 2020 6966 206d 7965            if mye
-0006c1b0: 7874 203d 3d20 2779 656f 273a 0a20 2020  xt == 'yeo':.   
-0006c1c0: 2020 2020 2020 2020 2020 2020 2070 6172               par
-0006c1d0: 7473 203d 2072 652e 6669 6e64 616c 6c28  ts = re.findall(
-0006c1e0: 7227 5c44 2b27 2c20 6f67 6c61 6265 6c6e  r'\D+', oglabeln
-0006c1f0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-0006c200: 2020 2020 206f 676c 6162 656c 6e61 6d65       oglabelname
-0006c210: 203d 205b 7061 7274 2e72 6570 6c61 6365   = [part.replace
-0006c220: 2827 5f27 2c20 2727 2920 666f 7220 7061  ('_', '') for pa
-0006c230: 7274 2069 6e20 7061 7274 7320 6966 2070  rt in parts if p
-0006c240: 6172 742e 7265 706c 6163 6528 275f 272c  art.replace('_',
-0006c250: 2027 2729 5d0a 2020 2020 2020 2020 2020   '')].          
-0006c260: 2020 2020 2020 6669 6c74 6572 6564 5f64        filtered_d
-0006c270: 6620 3d20 6174 6c61 7344 6573 6372 6970  f = atlasDescrip
-0006c280: 745b 6174 6c61 7344 6573 6372 6970 745b  t[atlasDescript[
-0006c290: 2744 6573 6372 6970 7469 6f6e 275d 2e69  'Description'].i
-0006c2a0: 7369 6e28 6f67 6c61 6265 6c6e 616d 6529  sin(oglabelname)
-0006c2b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0006c2c0: 2020 6c61 6265 6c6e 756d 7320 3d20 6669    labelnums = fi
-0006c2d0: 6c74 6572 6564 5f64 665b 274c 6162 656c  ltered_df['Label
-0006c2e0: 275d 2e74 6f6c 6973 7428 290a 0a20 2020  '].tolist()..   
-0006c2f0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0006c300: 6973 696e 7374 616e 6365 286c 6162 656c  isinstance(label
-0006c310: 6e75 6d73 2c20 6c69 7374 293a 0a20 2020  nums, list):.   
-0006c320: 2020 2020 2020 2020 2020 2020 206c 6162               lab
-0006c330: 656c 6e75 6d73 3d5b 6c61 6265 6c6e 756d  elnums=[labelnum
-0006c340: 735d 0a20 2020 2020 2020 2020 2020 2061  s].            a
-0006c350: 6464 656d 6973 7a65 726f 203d 2061 6e74  ddemiszero = ant
-0006c360: 732e 7468 7265 7368 6f6c 645f 696d 6167  s.threshold_imag
-0006c370: 6528 6164 6465 6d2c 2030 2c20 3029 0a20  e(addem, 0, 0). 
-0006c380: 2020 2020 2020 2020 2020 2074 656d 7020             temp 
-0006c390: 3d20 616e 7473 2e69 6d61 6765 5f72 6561  = ants.image_rea
-0006c3a0: 6428 6c6f 6366 696c 656e 616d 6529 0a20  d(locfilename). 
-0006c3b0: 2020 2020 2020 2020 2020 2074 656d 7020             temp 
-0006c3c0: 3d20 616e 7473 2e6d 6173 6b5f 696d 6167  = ants.mask_imag
-0006c3d0: 6528 7465 6d70 2c20 7465 6d70 2c20 6c65  e(temp, temp, le
-0006c3e0: 7665 6c3d 6c61 6265 6c6e 756d 732c 2062  vel=labelnums, b
-0006c3f0: 696e 6172 697a 653d 5472 7565 290a 2020  inarize=True).  
-0006c400: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
-0006c410: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
-0006c420: 2020 2020 2020 7072 696e 7428 2244 4542        print("DEB
-0006c430: 5547 2229 0a20 2020 2020 2020 2020 2020  UG").           
-0006c440: 2020 2020 2070 7269 6e74 2820 2074 656d       print(  tem
-0006c450: 702e 7375 6d28 2920 2920 0a20 2020 2020  p.sum() ) .     
-0006c460: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0006c470: 2820 6c61 6265 6c6e 756d 7320 290a 2020  ( labelnums ).  
-0006c480: 2020 2020 2020 2020 2020 7465 6d70 5b74            temp[t
-0006c490: 656d 7020 3d3d 2031 5d20 3d20 2876 616c  emp == 1] = (val
-0006c4a0: 7332 7669 7a29 0a20 2020 2020 2020 2020  s2viz).         
-0006c4b0: 2020 2074 656d 705b 6164 6465 6d69 737a     temp[addemisz
-0006c4c0: 6572 6f20 3d3d 2030 5d20 3d20 300a 2020  ero == 0] = 0.  
-0006c4d0: 2020 2020 2020 2020 2020 6164 6465 6d20            addem 
-0006c4e0: 3d20 6164 6465 6d20 2b20 7465 6d70 0a0a  = addem + temp..
-0006c4f0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-0006c500: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0006c510: 7072 696e 7428 2744 6f6e 6520 4164 6469  print('Done Addi
-0006c520: 6e67 2729 0a20 2020 2020 2020 2066 6f72  ng').        for
-0006c530: 2061 7878 2069 6e20 6178 6573 3a0a 2020   axx in axes:.  
-0006c540: 2020 2020 2020 2020 2020 6669 6766 6e3d            figfn=
-0006c550: 6f75 7470 7574 5f70 7265 6669 782b 6622  output_prefix+f"
-0006c560: 6669 677b 636f 6c32 7669 7a7d 6178 7b61  fig{col2viz}ax{a
-0006c570: 7878 7d5f 7079 2e6a 7067 220a 2020 2020  xx}_py.jpg".    
-0006c580: 2020 2020 2020 2020 6966 2063 726f 7020          if crop 
-0006c590: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-0006c5a0: 2020 2020 2063 6d61 736b 203d 2061 6e74       cmask = ant
-0006c5b0: 732e 7468 7265 7368 6f6c 645f 696d 6167  s.threshold_imag
-0006c5c0: 6528 2061 6464 656d 2c31 652d 352c 2031  e( addem,1e-5, 1
-0006c5d0: 6539 2029 2e69 4d61 7468 2822 4d44 222c  e9 ).iMath("MD",
-0006c5e0: 6372 6f70 2920 2b20 616e 7473 2e74 6872  crop) + ants.thr
-0006c5f0: 6573 686f 6c64 5f69 6d61 6765 2820 6164  eshold_image( ad
-0006c600: 6465 6d2c 2d31 6539 2c20 2d31 652d 3520  dem,-1e9, -1e-5 
-0006c610: 292e 694d 6174 6828 224d 4422 2c63 726f  ).iMath("MD",cro
-0006c620: 7029 0a20 2020 2020 2020 2020 2020 2020  p).             
-0006c630: 2020 2061 6464 656d 4320 3d20 616e 7473     addemC = ants
-0006c640: 2e63 726f 705f 696d 6167 6528 2061 6464  .crop_image( add
-0006c650: 656d 2c20 636d 6173 6b20 290a 2020 2020  em, cmask ).    
-0006c660: 2020 2020 2020 2020 2020 2020 6564 6765              edge
-0006c670: 696d 6743 203d 2061 6e74 732e 6372 6f70  imgC = ants.crop
-0006c680: 5f69 6d61 6765 2820 6564 6765 696d 672c  _image( edgeimg,
-0006c690: 2063 6d61 736b 2029 0a20 2020 2020 2020   cmask ).       
-0006c6a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0006c6b0: 2020 2020 2020 2020 2020 2061 6464 656d             addem
-0006c6c0: 4320 3d20 6164 6465 6d0a 2020 2020 2020  C = addem.      
-0006c6d0: 2020 2020 2020 2020 2020 6564 6765 696d            edgeim
-0006c6e0: 6743 203d 2065 6467 6569 6d67 0a20 2020  gC = edgeimg.   
-0006c6f0: 2020 2020 2020 2020 2069 6620 6669 7865           if fixe
-0006c700: 645f 6f76 6572 6c61 795f 7261 6e67 6520  d_overlay_range 
-0006c710: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0006c720: 2020 2020 2020 2020 2020 2020 2061 6464               add
-0006c730: 656d 435b 303a 332c 303a 332c 303a 335d  emC[0:3,0:3,0:3]
-0006c740: 3d66 6978 6564 5f6f 7665 726c 6179 5f72  =fixed_overlay_r
-0006c750: 616e 6765 5b30 5d0a 2020 2020 2020 2020  ange[0].        
-0006c760: 2020 2020 2020 2020 6164 6465 6d43 5b34          addemC[4
-0006c770: 3a37 2c34 3a37 2c34 3a37 5d3d 6669 7865  :7,4:7,4:7]=fixe
-0006c780: 645f 6f76 6572 6c61 795f 7261 6e67 655b  d_overlay_range[
-0006c790: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
-0006c7a0: 2020 2061 6464 656d 435b 2061 6464 656d     addemC[ addem
-0006c7b0: 4320 3c3d 2066 6978 6564 5f6f 7665 726c  C <= fixed_overl
-0006c7c0: 6179 5f72 616e 6765 5b30 5d20 5d20 3d20  ay_range[0] ] = 
-0006c7d0: 3020 2320 6669 7865 645f 6f76 6572 6c61  0 # fixed_overla
-0006c7e0: 795f 7261 6e67 655b 305d 0a20 2020 2020  y_range[0].     
-0006c7f0: 2020 2020 2020 2020 2020 2061 6464 656d             addem
-0006c800: 435b 2061 6464 656d 4320 3e3d 2066 6978  C[ addemC >= fix
-0006c810: 6564 5f6f 7665 726c 6179 5f72 616e 6765  ed_overlay_range
-0006c820: 5b31 5d20 5d20 3d20 6669 7865 645f 6f76  [1] ] = fixed_ov
-0006c830: 6572 6c61 795f 7261 6e67 655b 315d 0a20  erlay_range[1]. 
-0006c840: 2020 2020 2020 2020 2020 2061 6e74 732e             ants.
-0006c850: 706c 6f74 2865 6467 6569 6d67 432c 2061  plot(edgeimgC, a
-0006c860: 6464 656d 432c 2061 7869 733d 6178 782c  ddemC, axis=axx,
-0006c870: 206e 736c 6963 6573 3d6e 736c 6963 6573   nslices=nslices
-0006c880: 2c20 6e63 6f6c 3d6e 636f 6c2c 2020 2020  , ncol=ncol,    
-0006c890: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-0006c8a0: 2020 2020 6f76 6572 6c61 795f 636d 6170      overlay_cmap
-0006c8b0: 3d6f 7665 726c 6179 5f63 6d61 702c 2072  =overlay_cmap, r
-0006c8c0: 6573 616d 706c 653d 4661 6c73 652c 206f  esample=False, o
-0006c8d0: 7665 726c 6179 5f61 6c70 6861 3d31 2e30  verlay_alpha=1.0
-0006c8e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0006c8f0: 2020 6669 6c65 6e61 6d65 3d66 6967 666e    filename=figfn
-0006c900: 2c20 6362 6172 3d61 7878 3d3d 6178 6573  , cbar=axx==axes
-0006c910: 5b30 5d2c 2063 726f 703d 5472 7565 2c20  [0], crop=True, 
-0006c920: 626c 6163 6b5f 6267 3d62 6c61 636b 5f62  black_bg=black_b
-0006c930: 6720 290a 2020 2020 2020 2020 6966 2076  g ).        if v
-0006c940: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-0006c950: 2020 2020 7072 696e 7428 6622 7b63 6f6c      print(f"{col
-0006c960: 3276 697a 7d20 646f 6e65 2229 0a20 2020  2viz} done").   
-0006c970: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
-0006c980: 2020 2020 2070 7269 6e74 2822 444f 4e45       print("DONE
-0006c990: 2062 7261 696e 206d 6170 2066 6967 7572   brain map figur
-0006c9a0: 6573 2229 0a20 2020 2072 6574 7572 6e20  es").    return 
-0006c9b0: 6164 6465 6d0a 0a64 6566 2066 696c 7465  addem..def filte
-0006c9c0: 725f 6466 2869 6e64 662c 206d 7970 7265  r_df(indf, mypre
-0006c9d0: 6669 7829 3a0a 2020 2020 2222 220a 2020  fix):.    """.  
-0006c9e0: 2020 5072 6f63 6573 7320 616e 6420 6669    Process and fi
-0006c9f0: 6c74 6572 2061 2070 616e 6461 7320 4461  lter a pandas Da
-0006ca00: 7461 4672 616d 652c 2072 656d 6f76 696e  taFrame, removin
-0006ca10: 6720 6365 7274 6169 6e20 636f 6c75 6d6e  g certain column
-0006ca20: 732c 200a 2020 2020 6669 6c74 6572 696e  s, .    filterin
-0006ca30: 6720 6261 7365 6420 6f6e 2064 6174 6120  g based on data 
-0006ca40: 7479 7065 732c 2063 6f6d 7075 7469 6e67  types, computing
-0006ca50: 2074 6865 206d 6561 6e20 6f66 206e 756d   the mean of num
-0006ca60: 6572 6963 2063 6f6c 756d 6e73 2c20 0a20  eric columns, . 
-0006ca70: 2020 2061 6e64 2061 6464 696e 6720 6120     and adding a 
-0006ca80: 7072 6566 6978 2074 6f20 636f 6c75 6d6e  prefix to column
-0006ca90: 206e 616d 6573 2e0a 0a20 2020 2050 6172   names...    Par
-0006caa0: 616d 6574 6572 733a 0a20 2020 2069 6e64  ameters:.    ind
-0006cab0: 6620 2870 616e 6461 732e 4461 7461 4672  f (pandas.DataFr
-0006cac0: 616d 6529 3a20 5468 6520 696e 7075 7420  ame): The input 
-0006cad0: 4461 7461 4672 616d 6520 746f 2062 6520  DataFrame to be 
-0006cae0: 7072 6f63 6573 7365 642e 0a20 2020 206d  processed..    m
-0006caf0: 7970 7265 6669 7820 2873 7472 293a 2041  yprefix (str): A
-0006cb00: 2073 7472 696e 6720 7072 6566 6978 2074   string prefix t
-0006cb10: 6f20 6265 2061 6464 6564 2074 6f20 7468  o be added to th
-0006cb20: 6520 636f 6c75 6d6e 206e 616d 6573 200a  e column names .
-0006cb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cb40: 2020 2020 6f66 2074 6865 2070 726f 6365      of the proce
-0006cb50: 7373 6564 2044 6174 6146 7261 6d65 2e0a  ssed DataFrame..
-0006cb60: 0a20 2020 2053 7465 7073 3a0a 2020 2020  .    Steps:.    
-0006cb70: 312e 2052 656d 6f76 6573 2063 6f6c 756d  1. Removes colum
-0006cb80: 6e73 2077 6974 6820 6e61 6d65 7320 636f  ns with names co
-0006cb90: 6e74 6169 6e69 6e67 2027 556e 6e61 6d65  ntaining 'Unname
-0006cba0: 6427 2e0a 2020 2020 322e 2049 6620 7468  d'..    2. If th
-0006cbb0: 6520 4461 7461 4672 616d 6520 6861 7320  e DataFrame has 
-0006cbc0: 6e6f 2072 6f77 732c 2069 7420 7265 7475  no rows, it retu
-0006cbd0: 726e 7320 7468 6520 656d 7074 7920 4461  rns the empty Da
-0006cbe0: 7461 4672 616d 652e 0a20 2020 2033 2e20  taFrame..    3. 
-0006cbf0: 4669 6c74 6572 7320 6f75 7420 636f 6c75  Filters out colu
-0006cc00: 6d6e 7320 6261 7365 6420 6f6e 2074 6865  mns based on the
-0006cc10: 2074 7970 6520 6f66 2074 6865 2066 6972   type of the fir
-0006cc20: 7374 2065 6c65 6d65 6e74 2c20 0a20 2020  st element, .   
-0006cc30: 2020 2020 6b65 6570 696e 6720 7468 6f73      keeping thos
-0006cc40: 6520 7468 6174 2061 7265 206f 6620 7479  e that are of ty
-0006cc50: 7065 2060 6f62 6a65 6374 602c 2060 696e  pe `object`, `in
-0006cc60: 7460 2c20 6f72 2060 666c 6f61 7460 2e0a  t`, or `float`..
-0006cc70: 2020 2020 342e 2052 656d 6f76 6573 2063      4. Removes c
-0006cc80: 6f6c 756d 6e73 2074 6861 7420 6172 6520  olumns that are 
-0006cc90: 6f66 2060 6f62 6a65 6374 6020 6474 7970  of `object` dtyp
-0006cca0: 652e 0a20 2020 2035 2e20 4361 6c63 756c  e..    5. Calcul
-0006ccb0: 6174 6573 2074 6865 206d 6561 6e20 6f66  ates the mean of
-0006ccc0: 2074 6865 2072 656d 6169 6e69 6e67 2063   the remaining c
-0006ccd0: 6f6c 756d 6e73 2c20 736b 6970 7069 6e67  olumns, skipping
-0006cce0: 204e 614e 2076 616c 7565 732e 0a20 2020   NaN values..   
-0006ccf0: 2036 2e20 4164 6473 2074 6865 2073 7065   6. Adds the spe
-0006cd00: 6369 6669 6564 2060 6d79 7072 6566 6978  cified `myprefix
-0006cd10: 6020 746f 2074 6865 2063 6f6c 756d 6e20  ` to the column 
-0006cd20: 6e61 6d65 732e 0a0a 2020 2020 5265 7475  names...    Retu
-0006cd30: 726e 733a 0a20 2020 2070 616e 6461 732e  rns:.    pandas.
-0006cd40: 4461 7461 4672 616d 653a 2041 2074 7261  DataFrame: A tra
-0006cd50: 6e73 666f 726d 6564 2044 6174 6146 7261  nsformed DataFra
-0006cd60: 6d65 2077 6974 6820 6120 7369 6e67 6c65  me with a single
-0006cd70: 2072 6f77 2063 6f6e 7461 696e 696e 6720   row containing 
-0006cd80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006cd90: 2020 2020 2020 2074 6865 206d 6561 6e20         the mean 
-0006cda0: 7661 6c75 6573 206f 6620 7468 6520 6669  values of the fi
-0006cdb0: 6c74 6572 6564 2063 6f6c 756d 6e73 2c20  ltered columns, 
-0006cdc0: 616e 6420 7769 7468 200a 2020 2020 2020  and with .      
-0006cdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cde0: 636f 6c75 6d6e 206e 616d 6573 2070 7265  column names pre
-0006cdf0: 6669 7865 6420 6173 2073 7065 6369 6669  fixed as specifi
-0006ce00: 6564 2e0a 2020 2020 2222 220a 2020 2020  ed..    """.    
-0006ce10: 696e 6466 203d 2069 6e64 662e 6c6f 635b  indf = indf.loc[
-0006ce20: 3a2c 207e 696e 6466 2e63 6f6c 756d 6e73  :, ~indf.columns
-0006ce30: 2e73 7472 2e63 6f6e 7461 696e 7328 2755  .str.contains('U
-0006ce40: 6e6e 616d 6564 2a27 2c20 6e61 3d46 616c  nnamed*', na=Fal
-0006ce50: 7365 2c20 7265 6765 783d 5472 7565 295d  se, regex=True)]
-0006ce60: 0a20 2020 2069 6620 696e 6466 2e73 6861  .    if indf.sha
-0006ce70: 7065 5b30 5d20 3d3d 2030 3a0a 2020 2020  pe[0] == 0:.    
-0006ce80: 2020 2020 7265 7475 726e 2069 6e64 660a      return indf.
-0006ce90: 2020 2020 6e75 6d73 203d 205b 6973 696e      nums = [isin
-0006cea0: 7374 616e 6365 2869 6e64 665b 636f 6c5d  stance(indf[col]
-0006ceb0: 2e69 6c6f 635b 305d 2c20 286f 626a 6563  .iloc[0], (objec
-0006cec0: 742c 2069 6e74 2c20 666c 6f61 7429 2920  t, int, float)) 
-0006ced0: 666f 7220 636f 6c20 696e 2069 6e64 662e  for col in indf.
-0006cee0: 636f 6c75 6d6e 735d 0a20 2020 2069 6e64  columns].    ind
-0006cef0: 6620 3d20 696e 6466 2e6c 6f63 5b3a 2c20  f = indf.loc[:, 
-0006cf00: 6e75 6d73 5d0a 2020 2020 696e 6466 203d  nums].    indf =
-0006cf10: 2069 6e64 662e 6c6f 635b 3a2c 2069 6e64   indf.loc[:, ind
-0006cf20: 662e 6474 7970 6573 2021 3d20 276f 626a  f.dtypes != 'obj
-0006cf30: 6563 7427 5d0a 2020 2020 696e 6466 203d  ect'].    indf =
-0006cf40: 2070 642e 4461 7461 4672 616d 6528 696e   pd.DataFrame(in
-0006cf50: 6466 2e6d 6561 6e28 6178 6973 3d30 2c20  df.mean(axis=0, 
-0006cf60: 736b 6970 6e61 3d54 7275 6529 292e 540a  skipna=True)).T.
-0006cf70: 2020 2020 696e 6466 203d 2069 6e64 662e      indf = indf.
-0006cf80: 6164 645f 7072 6566 6978 286d 7970 7265  add_prefix(mypre
-0006cf90: 6669 7829 0a20 2020 2072 6574 7572 6e20  fix).    return 
-0006cfa0: 696e 6466 0a0a 0a64 6566 2061 6767 7265  indf...def aggre
-0006cfb0: 6761 7465 5f61 6e74 7370 796d 6d5f 7265  gate_antspymm_re
-0006cfc0: 7375 6c74 7328 696e 7075 745f 6373 762c  sults(input_csv,
-0006cfd0: 2073 7562 6a65 6374 5f63 6f6c 3d27 7375   subject_col='su
-0006cfe0: 626a 6563 7449 4427 2c20 6461 7465 5f63  bjectID', date_c
-0006cff0: 6f6c 3d27 6461 7465 272c 2069 6d61 6765  ol='date', image
-0006d000: 5f63 6f6c 3d27 696d 6167 6549 4427 2c20  _col='imageID', 
-0006d010: 6461 7465 5f63 6f6c 756d 6e3d 2773 6573  date_column='ses
-0006d020: 2d31 272c 2062 6173 655f 7061 7468 3d22  -1', base_path="
-0006d030: 2e2f 5072 6f63 6573 7365 642f 414e 5473  ./Processed/ANTs
-0006d040: 4578 7041 7274 2f22 2c20 6869 6572 7661  ExpArt/", hierva
-0006d050: 7269 6162 6c65 3d27 5431 7748 6965 7261  riable='T1wHiera
-0006d060: 7263 6869 6361 6c27 2c20 7661 6c69 645f  rchical', valid_
-0006d070: 6d6f 6461 6c69 7469 6573 3d4e 6f6e 652c  modalities=None,
-0006d080: 2076 6572 626f 7365 3d46 616c 7365 2029   verbose=False )
-0006d090: 3a0a 2020 2020 2222 220a 2020 2020 4167  :.    """.    Ag
-0006d0a0: 6772 6567 6174 6520 414e 5473 5079 4d4d  gregate ANTsPyMM
-0006d0b0: 2072 6573 756c 7473 2066 726f 6d20 7468   results from th
-0006d0c0: 6520 7370 6563 6966 6965 6420 4353 5620  e specified CSV 
-0006d0d0: 6669 6c65 2061 6e64 2073 6176 6520 7468  file and save th
-0006d0e0: 6520 6167 6772 6567 6174 6564 2072 6573  e aggregated res
-0006d0f0: 756c 7473 2074 6f20 6120 6e65 7720 4353  ults to a new CS
-0006d100: 5620 6669 6c65 2e0a 0a20 2020 2050 6172  V file...    Par
-0006d110: 616d 6574 6572 733a 0a20 2020 202d 2069  ameters:.    - i
-0006d120: 6e70 7574 5f63 7376 2028 7374 7229 3a20  nput_csv (str): 
-0006d130: 4669 6c65 2070 6174 6820 6f66 2074 6865  File path of the
-0006d140: 2069 6e70 7574 2043 5356 2066 696c 6520   input CSV file 
-0006d150: 636f 6e74 6169 6e69 6e67 2041 4e54 7350  containing ANTsP
-0006d160: 794d 4d20 5143 2072 6573 756c 7473 2061  yMM QC results a
-0006d170: 7665 7261 6765 6420 616e 6420 7769 7468  veraged and with
-0006d180: 206f 7574 6c69 6572 206d 6561 7375 7265   outlier measure
-0006d190: 6d65 6e74 732e 0a20 2020 202d 2073 7562  ments..    - sub
-0006d1a0: 6a65 6374 5f63 6f6c 2028 7374 7229 3a20  ject_col (str): 
-0006d1b0: 4e61 6d65 206f 6620 7468 6520 636f 6c75  Name of the colu
-0006d1c0: 6d6e 2074 6f20 7374 6f72 6520 7375 626a  mn to store subj
-0006d1d0: 6563 7420 4944 732e 0a20 2020 202d 2064  ect IDs..    - d
-0006d1e0: 6174 655f 636f 6c20 2873 7472 293a 204e  ate_col (str): N
-0006d1f0: 616d 6520 6f66 2074 6865 2063 6f6c 756d  ame of the colum
-0006d200: 6e20 746f 2073 746f 7265 2064 6174 6520  n to store date 
-0006d210: 696e 666f 726d 6174 696f 6e2e 0a20 2020  information..   
-0006d220: 202d 2069 6d61 6765 5f63 6f6c 2028 7374   - image_col (st
-0006d230: 7229 3a20 4e61 6d65 206f 6620 7468 6520  r): Name of the 
-0006d240: 636f 6c75 6d6e 2074 6f20 7374 6f72 6520  column to store 
-0006d250: 696d 6167 6520 4944 732e 0a20 2020 202d  image IDs..    -
-0006d260: 2064 6174 655f 636f 6c75 6d6e 2028 7374   date_column (st
-0006d270: 7229 3a20 4e61 6d65 206f 6620 7468 6520  r): Name of the 
-0006d280: 636f 6c75 6d6e 2072 6570 7265 7365 6e74  column represent
-0006d290: 696e 6720 7468 6520 6461 7465 2069 6e66  ing the date inf
-0006d2a0: 6f72 6d61 7469 6f6e 2e0a 2020 2020 2d20  ormation..    - 
-0006d2b0: 6261 7365 5f70 6174 6820 2873 7472 293a  base_path (str):
-0006d2c0: 2042 6173 6520 7061 7468 2066 6f72 2073   Base path for s
-0006d2d0: 6561 7263 6820 7061 7468 732e 2044 6566  earch paths. Def
-0006d2e0: 6175 6c74 7320 746f 2022 2e2f 5072 6f63  aults to "./Proc
-0006d2f0: 6573 7365 642f 414e 5473 4578 7041 7274  essed/ANTsExpArt
-0006d300: 2f22 2e0a 2020 2020 2d20 6869 6572 7661  /"..    - hierva
-0006d310: 7269 6162 6c65 2028 7374 7229 203a 2074  riable (str) : t
-0006d320: 6865 2073 7472 696e 6720 7661 7269 6162  he string variab
-0006d330: 6c65 2064 656e 6f74 696e 6720 7468 6520  le denoting the 
-0006d340: 4869 6572 6172 6368 6963 616c 206f 7574  Hierarchical out
-0006d350: 7075 740a 2020 2020 2d20 7661 6c69 645f  put.    - valid_
-0006d360: 6d6f 6461 6c69 7469 6573 2028 7374 7220  modalities (str 
-0006d370: 6172 7261 7929 203a 2069 6465 6e74 6966  array) : identif
-0006d380: 6965 7320 666f 7220 6561 6368 206d 6f64  ies for each mod
-0006d390: 616c 6974 793b 2069 6620 4e6f 6e65 2077  ality; if None w
-0006d3a0: 696c 6c20 6265 2072 6570 6c61 6365 6420  ill be replaced 
-0006d3b0: 6279 2067 6574 5f76 616c 6964 5f6d 6f64  by get_valid_mod
-0006d3c0: 616c 6974 6965 7328 6c6f 6e67 3d54 7275  alities(long=Tru
-0006d3d0: 6529 0a20 2020 202d 2076 6572 626f 7365  e).    - verbose
-0006d3e0: 203a 2062 6f6f 6c65 616e 0a0a 2020 2020   : boolean..    
-0006d3f0: 4e6f 7465 3a0a 2020 2020 5468 6973 2066  Note:.    This f
-0006d400: 756e 6374 696f 6e20 6973 2074 6573 7465  unction is teste
-0006d410: 6420 756e 6465 7220 6c69 6d69 7465 6420  d under limited 
-0006d420: 6369 7263 756d 7374 616e 6365 732e 2055  circumstances. U
-0006d430: 7365 2077 6974 6820 6361 7574 696f 6e2e  se with caution.
-0006d440: 0a0a 2020 2020 4578 616d 706c 6520 7573  ..    Example us
-0006d450: 6167 653a 0a20 2020 2061 6767 5f64 6620  age:.    agg_df 
-0006d460: 3d20 6167 6772 6567 6174 655f 616e 7473  = aggregate_ants
-0006d470: 7079 6d6d 5f72 6573 756c 7473 2822 7163  pymm_results("qc
-0006d480: 6466 616f 6c2e 6373 7622 2c20 7375 626a  dfaol.csv", subj
-0006d490: 6563 745f 636f 6c3d 2773 7562 6a65 6374  ect_col='subject
-0006d4a0: 4944 272c 2064 6174 655f 636f 6c3d 2764  ID', date_col='d
-0006d4b0: 6174 6527 2c20 696d 6167 655f 636f 6c3d  ate', image_col=
-0006d4c0: 2769 6d61 6765 4944 272c 2064 6174 655f  'imageID', date_
-0006d4d0: 636f 6c75 6d6e 3d27 7365 732d 3127 2c20  column='ses-1', 
-0006d4e0: 6261 7365 5f70 6174 683d 222e 2f59 6f75  base_path="./You
-0006d4f0: 722f 4375 7374 6f6d 2f50 6174 682f 2229  r/Custom/Path/")
-0006d500: 0a0a 2020 2020 4175 7468 6f72 3a0a 2020  ..    Author:.  
-0006d510: 2020 4176 616e 7473 2061 6e64 2043 6861    Avants and Cha
-0006d520: 7447 5054 0a20 2020 2022 2222 0a20 2020  tGPT.    """.   
-0006d530: 2069 6d70 6f72 7420 7061 6e64 6173 2061   import pandas a
-0006d540: 7320 7064 0a20 2020 2069 6d70 6f72 7420  s pd.    import 
-0006d550: 6e75 6d70 7920 6173 206e 700a 2020 2020  numpy as np.    
-0006d560: 6672 6f6d 2067 6c6f 6220 696d 706f 7274  from glob import
-0006d570: 2067 6c6f 620a 0a20 2020 2064 6566 206d   glob..    def m
-0006d580: 7972 6561 645f 6373 7628 782c 2063 6e6d  yread_csv(x, cnm
-0006d590: 7329 3a0a 2020 2020 2020 2020 2222 220a  s):.        """.
-0006d5a0: 2020 2020 2020 2020 5265 6164 7320 6120          Reads a 
-0006d5b0: 4353 5620 6669 6c65 2061 6e64 2072 6574  CSV file and ret
-0006d5c0: 7572 6e73 2061 2044 6174 6146 7261 6d65  urns a DataFrame
-0006d5d0: 2065 7863 6c75 6469 6e67 2073 7065 6369   excluding speci
-0006d5e0: 6669 6564 2063 6f6c 756d 6e73 2e0a 0a20  fied columns... 
-0006d5f0: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
-0006d600: 733a 0a20 2020 2020 2020 202d 2078 2028  s:.        - x (
-0006d610: 7374 7229 3a20 4669 6c65 2070 6174 6820  str): File path 
-0006d620: 6f66 2074 6865 2069 6e70 7574 2043 5356  of the input CSV
-0006d630: 2066 696c 6520 6465 7363 7269 6269 6e67   file describing
-0006d640: 2074 6865 2062 6c69 6e64 2051 4320 6f75   the blind QC ou
-0006d650: 7470 7574 0a20 2020 2020 2020 202d 2063  tput.        - c
-0006d660: 6e6d 7320 286c 6973 7429 3a20 4c69 7374  nms (list): List
-0006d670: 206f 6620 636f 6c75 6d6e 206e 616d 6573   of column names
-0006d680: 2074 6f20 6578 636c 7564 6520 6672 6f6d   to exclude from
-0006d690: 2074 6865 2044 6174 6146 7261 6d65 2e0a   the DataFrame..
-0006d6a0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-0006d6b0: 3a0a 2020 2020 2020 2020 7064 2e44 6174  :.        pd.Dat
-0006d6c0: 6146 7261 6d65 3a20 4461 7461 4672 616d  aFrame: DataFram
-0006d6d0: 6520 7769 7468 2073 7065 6369 6669 6564  e with specified
-0006d6e0: 2063 6f6c 756d 6e73 2065 7863 6c75 6465   columns exclude
-0006d6f0: 642e 0a20 2020 2020 2020 2022 2222 0a20  d..        """. 
-0006d700: 2020 2020 2020 2064 6620 3d20 7064 2e72         df = pd.r
-0006d710: 6561 645f 6373 7628 7829 0a20 2020 2020  ead_csv(x).     
-0006d720: 2020 2072 6574 7572 6e20 6466 2e6c 6f63     return df.loc
-0006d730: 5b3a 2c20 7e64 662e 636f 6c75 6d6e 732e  [:, ~df.columns.
-0006d740: 6973 696e 2863 6e6d 7329 5d0a 0a20 2020  isin(cnms)]..   
-0006d750: 2069 6d70 6f72 7420 7761 726e 696e 6773   import warnings
-0006d760: 0a20 2020 2023 2057 6172 6e69 6e67 206d  .    # Warning m
-0006d770: 6573 7361 6765 2066 6f72 2075 6e74 6573  essage for untes
-0006d780: 7465 6420 6675 6e63 7469 6f6e 0a20 2020  ted function.   
-0006d790: 2077 6172 6e69 6e67 732e 7761 726e 2822   warnings.warn("
-0006d7a0: 5761 726e 696e 673a 2054 6869 7320 6675  Warning: This fu
-0006d7b0: 6e63 7469 6f6e 2069 7320 6e6f 7420 7765  nction is not we
-0006d7c0: 6c6c 2074 6573 7465 642e 2055 7365 2077  ll tested. Use w
-0006d7d0: 6974 6820 6361 7574 696f 6e2e 2229 0a0a  ith caution.")..
-0006d7e0: 2020 2020 6966 2076 616c 6964 5f6d 6f64      if valid_mod
-0006d7f0: 616c 6974 6965 7320 6973 204e 6f6e 653a  alities is None:
-0006d800: 0a20 2020 2020 2020 2076 616c 6964 5f6d  .        valid_m
-0006d810: 6f64 616c 6974 6965 7320 3d20 6765 745f  odalities = get_
-0006d820: 7661 6c69 645f 6d6f 6461 6c69 7469 6573  valid_modalities
-0006d830: 2827 6c6f 6e67 2729 0a0a 2020 2020 2320  ('long')..    # 
-0006d840: 5265 6164 2074 6865 2069 6e70 7574 2043  Read the input C
-0006d850: 5356 2066 696c 650a 2020 2020 6466 203d  SV file.    df =
-0006d860: 2070 642e 7265 6164 5f63 7376 2869 6e70   pd.read_csv(inp
-0006d870: 7574 5f63 7376 290a 0a20 2020 2023 2046  ut_csv)..    # F
-0006d880: 696c 7465 7220 726f 7773 2077 6865 7265  ilter rows where
-0006d890: 206d 6f64 616c 6974 7920 6973 2027 5431   modality is 'T1
-0006d8a0: 7727 0a20 2020 2064 6620 3d20 6466 5b64  w'.    df = df[d
-0006d8b0: 665b 276d 6f64 616c 6974 7927 5d20 3d3d  f['modality'] ==
-0006d8c0: 2027 5431 7727 5d0a 2020 2020 6261 646e   'T1w'].    badn
-0006d8d0: 616d 6573 203d 2067 6574 5f6e 616d 6573  ames = get_names
-0006d8e0: 5f66 726f 6d5f 6461 7461 5f66 7261 6d65  _from_data_frame
-0006d8f0: 2820 5b27 556e 6e61 6d65 6427 5d2c 2064  ( ['Unnamed'], d
-0006d900: 6620 290a 2020 2020 6466 3d64 662e 6472  f ).    df=df.dr
-0006d910: 6f70 2862 6164 6e61 6d65 732c 2061 7869  op(badnames, axi
-0006d920: 733d 3129 0a0a 2020 2020 2320 4164 6420  s=1)..    # Add 
-0006d930: 6e65 7720 636f 6c75 6d6e 7320 666f 7220  new columns for 
-0006d940: 7375 626a 6563 7420 4944 2c20 6461 7465  subject ID, date
-0006d950: 2c20 616e 6420 696d 6167 6520 4944 0a20  , and image ID. 
-0006d960: 2020 2064 665b 7375 626a 6563 745f 636f     df[subject_co
-0006d970: 6c5d 203d 206e 702e 6e61 6e0a 2020 2020  l] = np.nan.    
-0006d980: 6466 5b64 6174 655f 636f 6c5d 203d 2064  df[date_col] = d
-0006d990: 6174 655f 636f 6c75 6d6e 0a20 2020 2064  ate_column.    d
-0006d9a0: 665b 696d 6167 655f 636f 6c5d 203d 206e  f[image_col] = n
-0006d9b0: 702e 6e61 6e0a 2020 2020 6466 203d 2064  p.nan.    df = d
-0006d9c0: 662e 6173 7479 7065 287b 7375 626a 6563  f.astype({subjec
-0006d9d0: 745f 636f 6c3a 2073 7472 2c20 6461 7465  t_col: str, date
-0006d9e0: 5f63 6f6c 3a20 7374 722c 2069 6d61 6765  _col: str, image
-0006d9f0: 5f63 6f6c 3a20 7374 7220 7d29 0a0a 2320  _col: str })..# 
-0006da00: 2020 2069 6620 7665 7262 6f73 653a 0a23     if verbose:.#
-0006da10: 2020 2020 2020 2020 7072 696e 7428 2064          print( d
-0006da20: 662e 7368 6170 6520 290a 2320 2020 2020  f.shape ).#     
-0006da30: 2020 2070 7269 6e74 2820 6466 2e64 7479     print( df.dty
-0006da40: 7065 7320 290a 0a20 2020 2023 2070 7265  pes )..    # pre
-0006da50: 6669 6c74 6572 2064 6620 666f 7220 6461  filter df for da
-0006da60: 7461 2074 6861 7420 6578 6973 7473 0a20  ta that exists. 
-0006da70: 2020 206b 6565 7020 3d20 6e70 2e74 696c     keep = np.til
-0006da80: 6528 2046 616c 7365 2c20 6466 2e73 6861  e( False, df.sha
-0006da90: 7065 5b30 5d20 290a 2020 2020 666f 7220  pe[0] ).    for 
-0006daa0: 7820 696e 2072 616e 6765 2864 662e 7368  x in range(df.sh
-0006dab0: 6170 655b 305d 293a 0a20 2020 2020 2020  ape[0]):.       
-0006dac0: 2074 656d 7020 3d20 6466 5b27 6669 6c65   temp = df['file
-0006dad0: 6e61 6d65 275d 2e69 6c6f 635b 785d 2e73  name'].iloc[x].s
-0006dae0: 706c 6974 2822 5f22 290a 2020 2020 2020  plit("_").      
-0006daf0: 2020 2320 4765 6e65 7261 6c69 7a65 6420    # Generalized 
-0006db00: 7365 6172 6368 2070 6174 6873 0a20 2020  search paths.   
-0006db10: 2020 2020 2070 6174 685f 7465 6d70 6c61       path_templa
-0006db20: 7465 203d 2066 227b 6261 7365 5f70 6174  te = f"{base_pat
-0006db30: 687d 7b74 656d 705b 305d 7d2f 7b64 6174  h}{temp[0]}/{dat
-0006db40: 655f 636f 6c75 6d6e 7d2f 2a2f 2a2f 2a22  e_column}/*/*/*"
-0006db50: 0a20 2020 2020 2020 2068 6965 7266 6e20  .        hierfn 
-0006db60: 3d20 736f 7274 6564 2867 6c6f 6228 2070  = sorted(glob( p
-0006db70: 6174 685f 7465 6d70 6c61 7465 202b 2022  ath_template + "
-0006db80: 2d22 202b 2068 6965 7276 6172 6961 626c  -" + hiervariabl
-0006db90: 6520 2b20 222d 2a77 6964 652e 6373 7622  e + "-*wide.csv"
-0006dba0: 2029 2029 0a20 2020 2020 2020 2069 6620   ) ).        if 
-0006dbb0: 6c65 6e28 2068 6965 7266 6e20 2920 3e20  len( hierfn ) > 
-0006dbc0: 303a 0a20 2020 2020 2020 2020 2020 206b  0:.            k
-0006dbd0: 6565 705b 785d 3d54 7275 650a 0a20 2020  eep[x]=True..   
-0006dbe0: 200a 2020 2020 6466 3d64 665b 6b65 6570   .    df=df[keep
-0006dbf0: 5d0a 2020 2020 0a20 2020 2069 6620 7665  ].    .    if ve
-0006dc00: 7262 6f73 653a 0a20 2020 2020 2020 2070  rbose:.        p
-0006dc10: 7269 6e74 2820 226f 7269 6769 6e61 6c20  rint( "original 
-0006dc20: 696e 7075 7420 6861 6420 7368 6170 6520  input had shape 
-0006dc30: 2220 2b20 7374 7228 2064 662e 7368 6170  " + str( df.shap
-0006dc40: 655b 305d 2029 202b 2022 2028 5431 206f  e[0] ) + " (T1 o
-0006dc50: 6e6c 7929 2061 6e64 2077 6520 6669 6e64  nly) and we find
-0006dc60: 2022 202b 2073 7472 2820 286b 6565 7029   " + str( (keep)
-0006dc70: 2e73 756d 2829 2029 202b 2022 2077 6974  .sum() ) + " wit
-0006dc80: 6820 6869 6572 6172 6368 6963 616c 206f  h hierarchical o
-0006dc90: 7574 7075 7420 6465 6669 6e65 6420 6279  utput defined by
-0006dca0: 2076 6172 6961 626c 653a 2022 202b 2068   variable: " + h
-0006dcb0: 6965 7276 6172 6961 626c 6520 290a 2020  iervariable ).  
-0006dcc0: 2020 2020 2020 7072 696e 7428 2064 662e        print( df.
-0006dcd0: 7368 6170 6520 290a 0a20 2020 206d 7963  shape )..    myc
-0006dce0: 7420 3d20 300a 2020 2020 666f 7220 7820  t = 0.    for x 
-0006dcf0: 696e 2072 616e 6765 2820 6466 2e73 6861  in range( df.sha
-0006dd00: 7065 5b30 5d29 3a0a 2020 2020 2020 2020  pe[0]):.        
-0006dd10: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-0006dd20: 2020 2020 2020 2020 7072 696e 7428 6622          print(f"
-0006dd30: 7b78 7d2e 2e2e 2229 0a20 2020 2020 2020  {x}...").       
-0006dd40: 206c 6f63 696e 6420 3d20 6466 2e69 6e64   locind = df.ind
-0006dd50: 6578 5b78 5d0a 2020 2020 2020 2020 7465  ex[x].        te
-0006dd60: 6d70 203d 2064 665b 2766 696c 656e 616d  mp = df['filenam
-0006dd70: 6527 5d2e 696c 6f63 5b78 5d2e 7370 6c69  e'].iloc[x].spli
-0006dd80: 7428 225f 2229 0a20 2020 2020 2020 2069  t("_").        i
-0006dd90: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-0006dda0: 2020 2020 2020 2070 7269 6e74 2820 7465         print( te
-0006ddb0: 6d70 2029 0a20 2020 2020 2020 2064 665b  mp ).        df[
-0006ddc0: 7375 626a 6563 745f 636f 6c5d 2e69 6c6f  subject_col].ilo
-0006ddd0: 635b 785d 3d74 656d 705b 305d 0a20 2020  c[x]=temp[0].   
-0006dde0: 2020 2020 2064 665b 6461 7465 5f63 6f6c       df[date_col
-0006ddf0: 5d2e 696c 6f63 5b78 5d3d 6461 7465 5f63  ].iloc[x]=date_c
-0006de00: 6f6c 756d 6e0a 2020 2020 2020 2020 6466  olumn.        df
-0006de10: 5b69 6d61 6765 5f63 6f6c 5d2e 696c 6f63  [image_col].iloc
-0006de20: 5b78 5d3d 7465 6d70 5b31 5d0a 0a20 2020  [x]=temp[1]..   
-0006de30: 2020 2020 2023 2047 656e 6572 616c 697a       # Generaliz
-0006de40: 6564 2073 6561 7263 6820 7061 7468 730a  ed search paths.
-0006de50: 2020 2020 2020 2020 7061 7468 5f74 656d          path_tem
-0006de60: 706c 6174 6520 3d20 6622 7b62 6173 655f  plate = f"{base_
-0006de70: 7061 7468 7d7b 7465 6d70 5b30 5d7d 2f7b  path}{temp[0]}/{
-0006de80: 6461 7465 5f63 6f6c 756d 6e7d 2f2a 2f2a  date_column}/*/*
-0006de90: 2f2a 220a 2020 2020 2020 2020 6966 2076  /*".        if v
-0006dea0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-0006deb0: 2020 2020 7072 696e 7428 7061 7468 5f74      print(path_t
-0006dec0: 656d 706c 6174 6529 0a20 2020 2020 2020  emplate).       
-0006ded0: 2068 6965 7266 6e20 3d20 736f 7274 6564   hierfn = sorted
-0006dee0: 2867 6c6f 6228 2070 6174 685f 7465 6d70  (glob( path_temp
-0006def0: 6c61 7465 202b 2022 2d22 202b 2068 6965  late + "-" + hie
-0006df00: 7276 6172 6961 626c 6520 2b20 222d 2a77  rvariable + "-*w
-0006df10: 6964 652e 6373 7622 2029 2029 0a20 2020  ide.csv" ) ).   
-0006df20: 2020 2020 2069 6620 6c65 6e28 2068 6965       if len( hie
-0006df30: 7266 6e20 2920 3e20 303a 0a20 2020 2020  rfn ) > 0:.     
-0006df40: 2020 2020 2020 2068 6466 3d74 3164 663d         hdf=t1df=
-0006df50: 6474 6466 3d72 7364 663d 7065 7266 6466  dtdf=rsdf=perfdf
-0006df60: 3d6e 6d64 663d 666c 6169 7264 663d 4e6f  =nmdf=flairdf=No
-0006df70: 6e65 0a20 2020 2020 2020 2020 2020 2069  ne.            i
-0006df80: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-0006df90: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0006dfa0: 2868 6965 7266 6e29 0a20 2020 2020 2020  (hierfn).       
-0006dfb0: 2020 2020 2068 6466 203d 2070 642e 7265       hdf = pd.re
-0006dfc0: 6164 5f63 7376 2868 6965 7266 6e5b 305d  ad_csv(hierfn[0]
-0006dfd0: 290a 2020 2020 2020 2020 2020 2020 6261  ).            ba
-0006dfe0: 646e 616d 6573 203d 2067 6574 5f6e 616d  dnames = get_nam
-0006dff0: 6573 5f66 726f 6d5f 6461 7461 5f66 7261  es_from_data_fra
-0006e000: 6d65 2820 5b27 556e 6e61 6d65 6427 5d2c  me( ['Unnamed'],
-0006e010: 2068 6466 2029 0a20 2020 2020 2020 2020   hdf ).         
-0006e020: 2020 2068 6466 3d68 6466 2e64 726f 7028     hdf=hdf.drop(
-0006e030: 6261 646e 616d 6573 2c20 6178 6973 3d31  badnames, axis=1
-0006e040: 290a 2020 2020 2020 2020 2020 2020 6e75  ).            nu
-0006e050: 6d73 203d 205b 6973 696e 7374 616e 6365  ms = [isinstance
-0006e060: 2868 6466 5b63 6f6c 5d2e 696c 6f63 5b30  (hdf[col].iloc[0
-0006e070: 5d2c 2028 696e 742c 2066 6c6f 6174 2929  ], (int, float))
-0006e080: 2066 6f72 2063 6f6c 2069 6e20 6864 662e   for col in hdf.
-0006e090: 636f 6c75 6d6e 735d 0a20 2020 2020 2020  columns].       
-0006e0a0: 2020 2020 2063 6f72 656e 616d 6573 203d       corenames =
-0006e0b0: 206c 6973 7428 6e70 2e61 7272 6179 2868   list(np.array(h
-0006e0c0: 6466 2e63 6f6c 756d 6e73 295b 6e75 6d73  df.columns)[nums
-0006e0d0: 5d29 0a20 2020 2020 2020 2020 2020 2068  ]).            h
-0006e0e0: 6466 2e6c 6f63 5b3a 2c20 6e75 6d73 5d20  df.loc[:, nums] 
-0006e0f0: 3d20 6864 662e 6c6f 635b 3a2c 206e 756d  = hdf.loc[:, num
-0006e100: 735d 2e61 6464 5f70 7265 6669 7828 2254  s].add_prefix("T
-0006e110: 3148 6965 725f 2229 0a20 2020 2020 2020  1Hier_").       
-0006e120: 2020 2020 206d 7963 7420 3d20 6d79 6374       myct = myct
-0006e130: 202b 2031 0a20 2020 2020 2020 2020 2020   + 1.           
-0006e140: 2064 666c 6973 7420 3d20 5b68 6466 5d0a   dflist = [hdf].
-0006e150: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0006e160: 206d 796d 6f64 2069 6e20 7661 6c69 645f   mymod in valid_
-0006e170: 6d6f 6461 6c69 7469 6573 3a0a 2020 2020  modalities:.    
-0006e180: 2020 2020 2020 2020 2020 2020 7431 7766              t1wf
-0006e190: 6e20 3d20 736f 7274 6564 2867 6c6f 6228  n = sorted(glob(
-0006e1a0: 2070 6174 685f 7465 6d70 6c61 7465 2b20   path_template+ 
-0006e1b0: 222d 2220 2b20 6d79 6d6f 6420 2b20 222d  "-" + mymod + "-
-0006e1c0: 2a77 6964 652e 6373 7622 2029 2029 0a20  *wide.csv" ) ). 
-0006e1d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0006e1e0: 6620 6c65 6e28 2074 3177 666e 2029 203e  f len( t1wfn ) >
-0006e1f0: 2030 203a 0a20 2020 2020 2020 2020 2020   0 :.           
-0006e200: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
-0006e210: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-0006e220: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0006e230: 6e74 2874 3177 666e 290a 2020 2020 2020  nt(t1wfn).      
-0006e240: 2020 2020 2020 2020 2020 2020 2020 7431                t1
-0006e250: 6466 203d 206d 7972 6561 645f 6373 7628  df = myread_csv(
-0006e260: 7431 7766 6e5b 305d 2c20 636f 7265 6e61  t1wfn[0], corena
-0006e270: 6d65 7329 0a20 2020 2020 2020 2020 2020  mes).           
-0006e280: 2020 2020 2020 2020 2074 3164 6620 3d20           t1df = 
-0006e290: 6669 6c74 6572 5f64 6628 2074 3164 662c  filter_df( t1df,
-0006e2a0: 206d 796d 6f64 2b27 5f27 290a 2020 2020   mymod+'_').    
-0006e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e2c0: 6466 6c69 7374 203d 2064 666c 6973 7420  dflist = dflist 
-0006e2d0: 2b20 5b74 3164 665d 0a20 2020 2020 2020  + [t1df].       
-0006e2e0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0006e2f0: 2020 2020 2020 6864 6620 3d20 7064 2e63        hdf = pd.c
-0006e300: 6f6e 6361 7428 2064 666c 6973 742c 2061  oncat( dflist, a
-0006e310: 7869 733d 312c 2069 676e 6f72 655f 696e  xis=1, ignore_in
-0006e320: 6465 783d 4661 6c73 6520 290a 2020 2020  dex=False ).    
-0006e330: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-0006e340: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0006e350: 2020 2020 7072 696e 7428 2064 662e 6c6f      print( df.lo
-0006e360: 635b 6c6f 6369 6e64 2c27 6669 6c65 6e61  c[locind,'filena
-0006e370: 6d65 275d 2029 0a20 2020 2020 2020 2020  me'] ).         
-0006e380: 2020 2069 6620 6d79 6374 203d 3d20 313a     if myct == 1:
-0006e390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006e3a0: 2073 7562 6466 203d 2064 662e 696c 6f63   subdf = df.iloc
-0006e3b0: 5b5b 785d 5d0a 2020 2020 2020 2020 2020  [[x]].          
-0006e3c0: 2020 2020 2020 6864 662e 696e 6465 7820        hdf.index 
-0006e3d0: 3d20 7375 6264 662e 696e 6465 782e 636f  = subdf.index.co
-0006e3e0: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
-0006e3f0: 2020 2020 2064 6620 3d20 7064 2e63 6f6e       df = pd.con
-0006e400: 6361 7428 205b 6466 2c68 6466 5d2c 2061  cat( [df,hdf], a
-0006e410: 7869 733d 312c 2069 676e 6f72 655f 696e  xis=1, ignore_in
-0006e420: 6465 783d 4661 6c73 6520 290a 2020 2020  dex=False ).    
-0006e430: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0006e440: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0006e450: 6d6d 636f 6c73 203d 206c 6973 7428 7365  mmcols = list(se
-0006e460: 7428 6864 662e 636f 6c75 6d6e 7329 2e69  t(hdf.columns).i
-0006e470: 6e74 6572 7365 6374 696f 6e28 6466 2e63  ntersection(df.c
-0006e480: 6f6c 756d 6e73 2929 0a20 2020 2020 2020  olumns)).       
-0006e490: 2020 2020 2020 2020 2064 662e 6c6f 635b           df.loc[
-0006e4a0: 6c6f 6369 6e64 2c20 636f 6d6d 636f 6c73  locind, commcols
-0006e4b0: 5d20 3d20 6864 662e 6c6f 635b 302c 2063  ] = hdf.loc[0, c
-0006e4c0: 6f6d 6d63 6f6c 735d 0a20 2020 2062 6164  ommcols].    bad
-0006e4d0: 6e61 6d65 7320 3d20 6765 745f 6e61 6d65  names = get_name
-0006e4e0: 735f 6672 6f6d 5f64 6174 615f 6672 616d  s_from_data_fram
-0006e4f0: 6528 205b 2755 6e6e 616d 6564 275d 2c20  e( ['Unnamed'], 
-0006e500: 6466 2029 0a20 2020 2064 663d 6466 2e64  df ).    df=df.d
-0006e510: 726f 7028 6261 646e 616d 6573 2c20 6178  rop(badnames, ax
-0006e520: 6973 3d31 290a 2020 2020 7265 7475 726e  is=1).    return
-0006e530: 2820 6466 2029 0a0a 6465 6620 6669 6e64  ( df )..def find
-0006e540: 5f6d 6f73 745f 7265 6365 6e74 5f66 696c  _most_recent_fil
-0006e550: 6528 6669 6c65 5f6c 6973 7429 3a0a 2020  e(file_list):.  
-0006e560: 2020 2222 220a 2020 2020 4669 6e64 7320    """.    Finds 
-0006e570: 616e 6420 7265 7475 726e 7320 7468 6520  and returns the 
-0006e580: 6d6f 7374 2072 6563 656e 746c 7920 6d6f  most recently mo
-0006e590: 6469 6669 6564 2066 696c 6520 6672 6f6d  dified file from
-0006e5a0: 2061 206c 6973 7420 6f66 2066 696c 6520   a list of file 
-0006e5b0: 7061 7468 732e 0a20 2020 200a 2020 2020  paths..    .    
-0006e5c0: 5061 7261 6d65 7465 7273 3a0a 2020 2020  Parameters:.    
-0006e5d0: 2d20 6669 6c65 5f6c 6973 743a 2041 206c  - file_list: A l
-0006e5e0: 6973 7420 6f66 2073 7472 696e 6773 2c20  ist of strings, 
-0006e5f0: 7768 6572 6520 6561 6368 2073 7472 696e  where each strin
-0006e600: 6720 6973 2061 2070 6174 6820 746f 2061  g is a path to a
-0006e610: 2066 696c 652e 0a20 2020 200a 2020 2020   file..    .    
-0006e620: 5265 7475 726e 733a 0a20 2020 202d 2054  Returns:.    - T
-0006e630: 6865 2070 6174 6820 746f 2074 6865 206d  he path to the m
-0006e640: 6f73 7420 7265 6365 6e74 6c79 206d 6f64  ost recently mod
-0006e650: 6966 6965 6420 6669 6c65 2069 6e20 7468  ified file in th
-0006e660: 6520 6c69 7374 2c20 6f72 204e 6f6e 6520  e list, or None 
-0006e670: 6966 2074 6865 206c 6973 7420 6973 2065  if the list is e
-0006e680: 6d70 7479 206f 7220 636f 6e74 6169 6e73  mpty or contains
-0006e690: 206e 6f20 7661 6c69 6420 6669 6c65 732e   no valid files.
-0006e6a0: 0a20 2020 2022 2222 0a20 2020 2023 2046  .    """.    # F
-0006e6b0: 696c 7465 7220 6f75 7420 6974 656d 7320  ilter out items 
-0006e6c0: 7468 6174 2061 7265 206e 6f74 2066 696c  that are not fil
-0006e6d0: 6573 206f 7220 646f 206e 6f74 2065 7869  es or do not exi
-0006e6e0: 7374 0a20 2020 2076 616c 6964 5f66 696c  st.    valid_fil
-0006e6f0: 6573 203d 205b 6620 666f 7220 6620 696e  es = [f for f in
-0006e700: 2066 696c 655f 6c69 7374 2069 6620 6f73   file_list if os
-0006e710: 2e70 6174 682e 6973 6669 6c65 2866 295d  .path.isfile(f)]
-0006e720: 0a20 2020 200a 2020 2020 2320 4368 6563  .    .    # Chec
-0006e730: 6b20 6966 2074 6865 2066 696c 7465 7265  k if the filtere
-0006e740: 6420 6c69 7374 2069 7320 6e6f 7420 656d  d list is not em
-0006e750: 7074 790a 2020 2020 6966 2076 616c 6964  pty.    if valid
-0006e760: 5f66 696c 6573 3a0a 2020 2020 2020 2020  _files:.        
-0006e770: 2320 4669 6e64 2074 6865 2066 696c 6520  # Find the file 
-0006e780: 7769 7468 2074 6865 206c 6174 6573 7420  with the latest 
-0006e790: 6d6f 6469 6669 6361 7469 6f6e 2074 696d  modification tim
-0006e7a0: 650a 2020 2020 2020 2020 6d6f 7374 5f72  e.        most_r
-0006e7b0: 6563 656e 745f 6669 6c65 203d 206d 6178  ecent_file = max
-0006e7c0: 2876 616c 6964 5f66 696c 6573 2c20 6b65  (valid_files, ke
-0006e7d0: 793d 6f73 2e70 6174 682e 6765 746d 7469  y=os.path.getmti
-0006e7e0: 6d65 290a 2020 2020 2020 2020 7265 7475  me).        retu
-0006e7f0: 726e 205b 6d6f 7374 5f72 6563 656e 745f  rn [most_recent_
-0006e800: 6669 6c65 5d0a 2020 2020 656c 7365 3a0a  file].    else:.
-0006e810: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-0006e820: 6f6e 650a 2020 2020 0a64 6566 2061 6767  one.    .def agg
-0006e830: 7265 6761 7465 5f61 6e74 7370 796d 6d5f  regate_antspymm_
-0006e840: 7265 7375 6c74 735f 7364 6628 0a20 2020  results_sdf(.   
-0006e850: 2073 7475 6479 5f64 662c 200a 2020 2020   study_df, .    
-0006e860: 7072 6f6a 6563 745f 636f 6c3d 2770 726f  project_col='pro
-0006e870: 6a65 6374 4944 272c 0a20 2020 2073 7562  jectID',.    sub
-0006e880: 6a65 6374 5f63 6f6c 3d27 7375 626a 6563  ject_col='subjec
-0006e890: 7449 4427 2c20 0a20 2020 2064 6174 655f  tID', .    date_
-0006e8a0: 636f 6c3d 2764 6174 6527 2c20 0a20 2020  col='date', .   
-0006e8b0: 2069 6d61 6765 5f63 6f6c 3d27 696d 6167   image_col='imag
-0006e8c0: 6549 4427 2c20 0a20 2020 2062 6173 655f  eID', .    base_
-0006e8d0: 7061 7468 3d22 2e2f 222c 200a 2020 2020  path="./", .    
-0006e8e0: 6869 6572 7661 7269 6162 6c65 3d27 5431  hiervariable='T1
-0006e8f0: 7748 6965 7261 7263 6869 6361 6c27 2c20  wHierarchical', 
-0006e900: 0a20 2020 2073 706c 6974 7365 703d 272d  .    splitsep='-
-0006e910: 272c 0a20 2020 2069 6473 6570 3d27 2d27  ',.    idsep='-'
-0006e920: 2c0a 2020 2020 7769 6c64 5f63 6172 645f  ,.    wild_card_
-0006e930: 6d6f 6461 6c69 7479 5f69 643d 4661 6c73  modality_id=Fals
-0006e940: 652c 0a20 2020 2073 6563 6f6e 645f 7370  e,.    second_sp
-0006e950: 6c69 743d 4661 6c73 652c 0a20 2020 2076  lit=False,.    v
-0006e960: 6572 626f 7365 3d46 616c 7365 2029 3a0a  erbose=False ):.
-0006e970: 2020 2020 2222 220a 2020 2020 4167 6772      """.    Aggr
-0006e980: 6567 6174 6520 414e 5473 5079 4d4d 2072  egate ANTsPyMM r
-0006e990: 6573 756c 7473 2066 726f 6d20 7468 6520  esults from the 
-0006e9a0: 7370 6563 6966 6965 6420 7374 7564 7920  specified study 
-0006e9b0: 6461 7461 2066 7261 6d65 2061 6e64 2073  data frame and s
-0006e9c0: 746f 7265 2074 6865 2061 6767 7265 6761  tore the aggrega
-0006e9d0: 7465 6420 7265 7375 6c74 7320 696e 2061  ted results in a
-0006e9e0: 206e 6577 2064 6174 6120 6672 616d 652e   new data frame.
-0006e9f0: 2020 5468 6973 2061 7373 756d 6573 2064    This assumes d
-0006ea00: 6174 6120 6973 206f 7267 616e 697a 6564  ata is organized
-0006ea10: 206f 6e20 6469 736b 200a 2020 2020 6173   on disk .    as
-0006ea20: 2066 6f6c 6c6f 7773 3a20 2072 6f6f 7464   follows:  rootd
-0006ea30: 6972 2f70 726f 6a65 6374 4944 2f73 7562  ir/projectID/sub
-0006ea40: 6a65 6374 4944 2f64 6174 652f 6f75 7470  jectID/date/outp
-0006ea50: 7574 6964 2f69 6d61 6765 6964 2f20 7768  utid/imageid/ wh
-0006ea60: 6572 6520 0a20 2020 206f 7574 7075 7469  ere .    outputi
-0006ea70: 6420 6973 206d 6f64 616c 6974 792d 7370  d is modality-sp
-0006ea80: 6563 6966 6963 2061 6e64 2063 7265 6174  ecific and creat
-0006ea90: 6564 2062 7920 414e 5473 5079 4d4d 2070  ed by ANTsPyMM p
-0006eaa0: 726f 6365 7373 696e 672e 0a0a 2020 2020  rocessing...    
-0006eab0: 5061 7261 6d65 7465 7273 3a0a 2020 2020  Parameters:.    
-0006eac0: 2d20 7374 7564 795f 6466 2028 7061 6e64  - study_df (pand
-0006ead0: 6173 2064 6629 3a20 7061 6e64 6173 2064  as df): pandas d
-0006eae0: 6174 6120 6672 616d 652c 206f 7574 7075  ata frame, outpu
-0006eaf0: 7420 6f66 2067 656e 6572 6174 655f 6d6d  t of generate_mm
-0006eb00: 5f64 6174 6166 7261 6d65 2e0a 2020 2020  _dataframe..    
-0006eb10: 2d20 7072 6f6a 6563 745f 636f 6c20 2873  - project_col (s
-0006eb20: 7472 293a 204e 616d 6520 6f66 2074 6865  tr): Name of the
-0006eb30: 2063 6f6c 756d 6e20 7468 6174 2073 746f   column that sto
-0006eb40: 7265 7320 7468 6520 7072 6f6a 6563 7420  res the project 
-0006eb50: 4944 0a20 2020 202d 2073 7562 6a65 6374  ID.    - subject
-0006eb60: 5f63 6f6c 2028 7374 7229 3a20 4e61 6d65  _col (str): Name
-0006eb70: 206f 6620 7468 6520 636f 6c75 6d6e 2074   of the column t
-0006eb80: 6f20 7374 6f72 6520 7375 626a 6563 7420  o store subject 
-0006eb90: 4944 732e 0a20 2020 202d 2064 6174 655f  IDs..    - date_
-0006eba0: 636f 6c20 2873 7472 293a 204e 616d 6520  col (str): Name 
-0006ebb0: 6f66 2074 6865 2063 6f6c 756d 6e20 746f  of the column to
-0006ebc0: 2073 746f 7265 2064 6174 6520 696e 666f   store date info
-0006ebd0: 726d 6174 696f 6e2e 0a20 2020 202d 2069  rmation..    - i
-0006ebe0: 6d61 6765 5f63 6f6c 2028 7374 7229 3a20  mage_col (str): 
-0006ebf0: 4e61 6d65 206f 6620 7468 6520 636f 6c75  Name of the colu
-0006ec00: 6d6e 2074 6f20 7374 6f72 6520 696d 6167  mn to store imag
-0006ec10: 6520 4944 732e 0a20 2020 202d 2062 6173  e IDs..    - bas
-0006ec20: 655f 7061 7468 2028 7374 7229 3a20 4261  e_path (str): Ba
-0006ec30: 7365 2070 6174 6820 666f 7220 7365 6172  se path for sear
-0006ec40: 6368 696e 6720 666f 7220 7072 6f63 6573  ching for proces
-0006ec50: 7369 6e67 206f 7574 7075 7473 206f 6620  sing outputs of 
-0006ec60: 414e 5473 5079 4d4d 2e0a 2020 2020 2d20  ANTsPyMM..    - 
-0006ec70: 6869 6572 7661 7269 6162 6c65 2028 7374  hiervariable (st
-0006ec80: 7229 203a 2074 6865 2073 7472 696e 6720  r) : the string 
-0006ec90: 7661 7269 6162 6c65 2064 656e 6f74 696e  variable denotin
-0006eca0: 6720 7468 6520 4869 6572 6172 6368 6963  g the Hierarchic
-0006ecb0: 616c 206f 7574 7075 740a 2020 2020 2d20  al output.    - 
-0006ecc0: 7370 6c69 7473 6570 2028 7374 7229 3a20  splitsep (str): 
-0006ecd0: 2074 6865 2073 6570 6172 6174 6f72 2075   the separator u
-0006ece0: 7365 6420 746f 2073 706c 6974 2074 6865  sed to split the
-0006ecf0: 2066 696c 656e 616d 650a 2020 2020 2d20   filename.    - 
-0006ed00: 6964 7365 7020 2873 7472 293a 2074 6865  idsep (str): the
-0006ed10: 2073 6570 6172 6174 6f72 2075 7365 6420   separator used 
-0006ed20: 746f 2070 6172 7469 7469 6f6e 2073 7562  to partition sub
-0006ed30: 6a65 6374 6964 2064 6174 6520 616e 6420  jectid date and 
-0006ed40: 696d 6167 6569 6420 0a20 2020 2020 2020  imageid .       
-0006ed50: 2066 6f72 2065 7861 6d70 6c65 2c20 6966   for example, if
-0006ed60: 2069 6473 6570 2069 7320 2d20 7468 656e   idsep is - then
-0006ed70: 2077 6520 6861 7665 2073 7562 6a65 6374   we have subject
-0006ed80: 6964 2d64 6174 652d 696d 6167 6569 640a  id-date-imageid.
-0006ed90: 2020 2020 2d20 7769 6c64 5f63 6172 645f      - wild_card_
-0006eda0: 6d6f 6461 6c69 7479 5f69 6420 2862 6f6f  modality_id (boo
-0006edb0: 6c29 3a20 6b65 6570 2069 6620 4661 6c73  l): keep if Fals
-0006edc0: 6520 666f 7220 7361 6665 7220 6578 6563  e for safer exec
-0006edd0: 7574 696f 6e0a 2020 2020 2d20 7365 636f  ution.    - seco
-0006ede0: 6e64 5f73 706c 6974 2028 626f 6f6c 293a  nd_split (bool):
-0006edf0: 2074 6869 7320 6973 2061 2068 6163 6b20   this is a hack 
-0006ee00: 7468 6174 2077 696c 6c20 7370 6c69 7420  that will split 
-0006ee10: 7468 6520 696d 6167 6549 4420 6279 202e  the imageID by .
-0006ee20: 2061 6e64 206b 6565 7020 7468 6520 6669   and keep the fi
-0006ee30: 7273 7420 7061 7274 206f 6620 7468 6520  rst part of the 
-0006ee40: 7370 6c69 743b 206d 6179 2062 6520 6e65  split; may be ne
-0006ee50: 6564 6564 2077 6865 6e20 7468 6520 696e  eded when the in
-0006ee60: 7075 7420 6669 6c65 6e61 6d65 7320 636f  put filenames co
-0006ee70: 6e74 6169 6e20 2e0a 2020 2020 2d20 7665  ntain ..    - ve
-0006ee80: 7262 6f73 6520 3a20 626f 6f6c 6561 6e0a  rbose : boolean.
-0006ee90: 0a20 2020 204e 6f74 653a 0a20 2020 2054  .    Note:.    T
-0006eea0: 6869 7320 6675 6e63 7469 6f6e 2069 7320  his function is 
-0006eeb0: 7465 7374 6564 2075 6e64 6572 206c 696d  tested under lim
-0006eec0: 6974 6564 2063 6972 6375 6d73 7461 6e63  ited circumstanc
-0006eed0: 6573 2e20 5573 6520 7769 7468 2063 6175  es. Use with cau
-0006eee0: 7469 6f6e 2e0a 2020 2020 4f6e 6520 7061  tion..    One pa
-0006eef0: 7274 6963 756c 6172 2067 6f74 6368 6120  rticular gotcha 
-0006ef00: 6973 2069 6620 7468 6520 696d 6167 6549  is if the imageI
-0006ef10: 4420 6973 2073 746f 7265 6420 6173 2061  D is stored as a
-0006ef20: 206e 756d 6572 6963 2076 616c 7565 2069   numeric value i
-0006ef30: 6e20 7468 6520 6461 7461 6672 616d 6520  n the dataframe 
-0006ef40: 0a20 2020 2062 7574 2069 7320 6d65 616e  .    but is mean
-0006ef50: 7420 746f 2062 6520 6120 7374 7269 6e67  t to be a string
-0006ef60: 2e20 2045 2e67 2e20 2730 3030 2720 2873  .  E.g. '000' (s
-0006ef70: 7472 696e 6729 2077 6f75 6c64 2062 6520  tring) would be 
-0006ef80: 696e 7465 7270 7265 7465 6420 6173 2030  interpreted as 0
-0006ef90: 2069 6e20 7468 6520 0a20 2020 2066 696c   in the .    fil
-0006efa0: 6520 6e61 6d65 2067 6c6f 622e 2020 5468  e name glob.  Th
-0006efb0: 6973 2077 6f75 6c64 206d 6973 7320 7468  is would miss th
-0006efc0: 6520 6578 7461 6e74 2028 6f6e 2064 6973  e extant (on dis
-0006efd0: 6b29 2063 7376 2e0a 0a20 2020 2045 7861  k) csv...    Exa
-0006efe0: 6d70 6c65 2075 7361 6765 3a0a 2020 2020  mple usage:.    
-0006eff0: 6167 675f 6466 203d 2061 6767 7265 6761  agg_df = aggrega
-0006f000: 7465 5f61 6e74 7370 796d 6d5f 7265 7375  te_antspymm_resu
-0006f010: 6c74 735f 7364 6628 2073 7475 6479 6466  lts_sdf( studydf
-0006f020: 2c20 7375 626a 6563 745f 636f 6c3d 2773  , subject_col='s
-0006f030: 7562 6a65 6374 4944 272c 2064 6174 655f  ubjectID', date_
-0006f040: 636f 6c3d 2764 6174 6527 2c20 696d 6167  col='date', imag
-0006f050: 655f 636f 6c3d 2769 6d61 6765 4944 272c  e_col='imageID',
-0006f060: 2062 6173 655f 7061 7468 3d22 2e2f 596f   base_path="./Yo
-0006f070: 7572 2f43 7573 746f 6d2f 5061 7468 2f22  ur/Custom/Path/"
-0006f080: 290a 0a20 2020 2041 7574 686f 723a 0a20  )..    Author:. 
-0006f090: 2020 2041 7661 6e74 7320 616e 6420 4368     Avants and Ch
-0006f0a0: 6174 4750 540a 2020 2020 2222 220a 2020  atGPT.    """.  
-0006f0b0: 2020 696d 706f 7274 2070 616e 6461 7320    import pandas 
-0006f0c0: 6173 2070 640a 2020 2020 696d 706f 7274  as pd.    import
-0006f0d0: 206e 756d 7079 2061 7320 6e70 0a20 2020   numpy as np.   
-0006f0e0: 2066 726f 6d20 676c 6f62 2069 6d70 6f72   from glob impor
-0006f0f0: 7420 676c 6f62 0a0a 2020 2020 6465 6620  t glob..    def 
-0006f100: 7072 6f67 7265 7373 5f72 6570 6f72 7465  progress_reporte
-0006f110: 7228 6375 7272 656e 745f 7374 6570 2c20  r(current_step, 
-0006f120: 746f 7461 6c5f 7374 6570 732c 2077 6964  total_steps, wid
-0006f130: 7468 3d35 3029 3a0a 2020 2020 2020 2020  th=50):.        
-0006f140: 2320 4361 6c63 756c 6174 6520 7468 6520  # Calculate the 
-0006f150: 7072 6f70 6f72 7469 6f6e 206f 6620 7072  proportion of pr
-0006f160: 6f67 7265 7373 0a20 2020 2020 2020 2070  ogress.        p
-0006f170: 726f 6772 6573 7320 3d20 6375 7272 656e  rogress = curren
-0006f180: 745f 7374 6570 202f 2074 6f74 616c 5f73  t_step / total_s
-0006f190: 7465 7073 0a20 2020 2020 2020 2023 2043  teps.        # C
-0006f1a0: 616c 6375 6c61 7465 2074 6865 206e 756d  alculate the num
-0006f1b0: 6265 7220 6f66 2027 6669 6c6c 6564 2720  ber of 'filled' 
-0006f1c0: 6368 6172 6163 7465 7273 2069 6e20 7468  characters in th
-0006f1d0: 6520 7072 6f67 7265 7373 2062 6172 0a20  e progress bar. 
-0006f1e0: 2020 2020 2020 2066 696c 6c65 645f 6c65         filled_le
-0006f1f0: 6e67 7468 203d 2069 6e74 2877 6964 7468  ngth = int(width
-0006f200: 202a 2070 726f 6772 6573 7329 0a20 2020   * progress).   
-0006f210: 2020 2020 2023 2043 7265 6174 6520 7468       # Create th
-0006f220: 6520 7072 6f67 7265 7373 2062 6172 2073  e progress bar s
-0006f230: 7472 696e 670a 2020 2020 2020 2020 6261  tring.        ba
-0006f240: 7220 3d20 27e2 9688 2720 2a20 6669 6c6c  r = '...' * fill
-0006f250: 6564 5f6c 656e 6774 6820 2b20 272d 2720  ed_length + '-' 
-0006f260: 2a20 2877 6964 7468 202d 2066 696c 6c65  * (width - fille
-0006f270: 645f 6c65 6e67 7468 290a 2020 2020 2020  d_length).      
-0006f280: 2020 2320 5072 696e 7420 7468 6520 7072    # Print the pr
-0006f290: 6f67 7265 7373 2062 6172 2077 6974 6820  ogress bar with 
-0006f2a0: 7065 7263 656e 7461 6765 0a20 2020 2020  percentage.     
-0006f2b0: 2020 2070 7269 6e74 2866 275c 7250 726f     print(f'\rPro
-0006f2c0: 6772 6573 733a 207c 7b62 6172 7d7c 207b  gress: |{bar}| {
-0006f2d0: 696e 7428 3130 3020 2a20 7072 6f67 7265  int(100 * progre
-0006f2e0: 7373 297d 2527 2c20 656e 643d 275c 7227  ss)}%', end='\r'
-0006f2f0: 290a 2020 2020 2020 2020 2320 5072 696e  ).        # Prin
-0006f300: 7420 6120 6e65 7720 6c69 6e65 2077 6865  t a new line whe
-0006f310: 6e20 7468 6520 7072 6f67 7265 7373 2069  n the progress i
-0006f320: 7320 636f 6d70 6c65 7465 0a20 2020 2020  s complete.     
-0006f330: 2020 2069 6620 6375 7272 656e 745f 7374     if current_st
-0006f340: 6570 203d 3d20 746f 7461 6c5f 7374 6570  ep == total_step
-0006f350: 733a 0a20 2020 2020 2020 2020 2020 2070  s:.            p
-0006f360: 7269 6e74 2829 0a0a 2020 2020 6465 6620  rint()..    def 
-0006f370: 6d79 7265 6164 5f63 7376 2878 2c20 636e  myread_csv(x, cn
-0006f380: 6d73 293a 0a20 2020 2020 2020 2022 2222  ms):.        """
-0006f390: 0a20 2020 2020 2020 2052 6561 6473 2061  .        Reads a
-0006f3a0: 2043 5356 2066 696c 6520 616e 6420 7265   CSV file and re
-0006f3b0: 7475 726e 7320 6120 4461 7461 4672 616d  turns a DataFram
-0006f3c0: 6520 6578 636c 7564 696e 6720 7370 6563  e excluding spec
-0006f3d0: 6966 6965 6420 636f 6c75 6d6e 732e 0a0a  ified columns...
-0006f3e0: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
-0006f3f0: 7273 3a0a 2020 2020 2020 2020 2d20 7820  rs:.        - x 
-0006f400: 2873 7472 293a 2046 696c 6520 7061 7468  (str): File path
-0006f410: 206f 6620 7468 6520 696e 7075 7420 4353   of the input CS
-0006f420: 5620 6669 6c65 2064 6573 6372 6962 696e  V file describin
-0006f430: 6720 7468 6520 626c 696e 6420 5143 206f  g the blind QC o
-0006f440: 7574 7075 740a 2020 2020 2020 2020 2d20  utput.        - 
-0006f450: 636e 6d73 2028 6c69 7374 293a 204c 6973  cnms (list): Lis
-0006f460: 7420 6f66 2063 6f6c 756d 6e20 6e61 6d65  t of column name
-0006f470: 7320 746f 2065 7863 6c75 6465 2066 726f  s to exclude fro
-0006f480: 6d20 7468 6520 4461 7461 4672 616d 652e  m the DataFrame.
-0006f490: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
-0006f4a0: 733a 0a20 2020 2020 2020 2070 642e 4461  s:.        pd.Da
-0006f4b0: 7461 4672 616d 653a 2044 6174 6146 7261  taFrame: DataFra
-0006f4c0: 6d65 2077 6974 6820 7370 6563 6966 6965  me with specifie
-0006f4d0: 6420 636f 6c75 6d6e 7320 6578 636c 7564  d columns exclud
-0006f4e0: 6564 2e0a 2020 2020 2020 2020 2222 220a  ed..        """.
-0006f4f0: 2020 2020 2020 2020 6466 203d 2070 642e          df = pd.
-0006f500: 7265 6164 5f63 7376 2878 290a 2020 2020  read_csv(x).    
-0006f510: 2020 2020 7265 7475 726e 2064 662e 6c6f      return df.lo
-0006f520: 635b 3a2c 207e 6466 2e63 6f6c 756d 6e73  c[:, ~df.columns
-0006f530: 2e69 7369 6e28 636e 6d73 295d 0a0a 2020  .isin(cnms)]..  
-0006f540: 2020 696d 706f 7274 2077 6172 6e69 6e67    import warning
-0006f550: 730a 2020 2020 2320 5761 726e 696e 6720  s.    # Warning 
-0006f560: 6d65 7373 6167 6520 666f 7220 756e 7465  message for unte
-0006f570: 7374 6564 2066 756e 6374 696f 6e0a 2020  sted function.  
-0006f580: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
-0006f590: 2257 6172 6e69 6e67 3a20 5468 6973 2066  "Warning: This f
-0006f5a0: 756e 6374 696f 6e20 6973 206e 6f74 2077  unction is not w
-0006f5b0: 656c 6c20 7465 7374 6564 2e20 5573 6520  ell tested. Use 
-0006f5c0: 7769 7468 2063 6175 7469 6f6e 2e22 290a  with caution.").
-0006f5d0: 0a20 2020 2076 6d6f 6464 6963 7420 3d20  .    vmoddict = 
-0006f5e0: 7b7d 0a20 2020 2023 2041 6464 206b 6579  {}.    # Add key
-0006f5f0: 2d76 616c 7565 2070 6169 7273 0a20 2020  -value pairs.   
-0006f600: 2076 6d6f 6464 6963 745b 2769 6d61 6765   vmoddict['image
-0006f610: 4944 275d 203d 2027 5431 7727 0a20 2020  ID'] = 'T1w'.   
-0006f620: 2076 6d6f 6464 6963 745b 2766 6c61 6972   vmoddict['flair
-0006f630: 6964 275d 203d 2027 5432 466c 6169 7227  id'] = 'T2Flair'
-0006f640: 0a20 2020 2076 6d6f 6464 6963 745b 2770  .    vmoddict['p
-0006f650: 6572 6669 6427 5d20 3d20 2770 6572 6627  erfid'] = 'perf'
-0006f660: 0a20 2020 2076 6d6f 6464 6963 745b 2772  .    vmoddict['r
-0006f670: 7366 6964 3127 5d20 3d20 2772 7366 4d52  sfid1'] = 'rsfMR
-0006f680: 4927 0a23 2020 2020 766d 6f64 6469 6374  I'.#    vmoddict
-0006f690: 5b27 7273 6669 6432 275d 203d 2027 7273  ['rsfid2'] = 'rs
-0006f6a0: 664d 5249 270a 2020 2020 766d 6f64 6469  fMRI'.    vmoddi
-0006f6b0: 6374 5b27 6474 6964 3127 5d20 3d20 2744  ct['dtid1'] = 'D
-0006f6c0: 5449 270a 2320 2020 2076 6d6f 6464 6963  TI'.#    vmoddic
-0006f6d0: 745b 2764 7469 6432 275d 203d 2027 4454  t['dtid2'] = 'DT
-0006f6e0: 4927 0a20 2020 2076 6d6f 6464 6963 745b  I'.    vmoddict[
-0006f6f0: 276e 6d69 6431 275d 203d 2027 4e4d 3244  'nmid1'] = 'NM2D
-0006f700: 4d54 270a 2320 2020 2076 6d6f 6464 6963  MT'.#    vmoddic
-0006f710: 745b 276e 6d69 6432 275d 203d 2027 4e4d  t['nmid2'] = 'NM
-0006f720: 3244 4d54 270a 0a20 2020 2023 2046 696c  2DMT'..    # Fil
-0006f730: 7465 7220 726f 7773 2077 6865 7265 206d  ter rows where m
-0006f740: 6f64 616c 6974 7920 6973 2027 5431 7727  odality is 'T1w'
-0006f750: 0a20 2020 2064 6620 3d20 7374 7564 795f  .    df = study_
-0006f760: 6466 5b20 7374 7564 795f 6466 5b27 6d6f  df[ study_df['mo
-0006f770: 6461 6c69 7479 275d 203d 3d20 2754 3177  dality'] == 'T1w
-0006f780: 275d 0a20 2020 2062 6164 6e61 6d65 7320  '].    badnames 
-0006f790: 3d20 6765 745f 6e61 6d65 735f 6672 6f6d  = get_names_from
-0006f7a0: 5f64 6174 615f 6672 616d 6528 205b 2755  _data_frame( ['U
-0006f7b0: 6e6e 616d 6564 275d 2c20 6466 2029 0a20  nnamed'], df ). 
-0006f7c0: 2020 2064 663d 6466 2e64 726f 7028 6261     df=df.drop(ba
-0006f7d0: 646e 616d 6573 2c20 6178 6973 3d31 290a  dnames, axis=1).
-0006f7e0: 2020 2020 2320 7072 6566 696c 7465 7220      # prefilter 
-0006f7f0: 6466 2066 6f72 2064 6174 6120 7468 6174  df for data that
-0006f800: 2065 7869 7374 730a 2020 2020 6b65 6570   exists.    keep
-0006f810: 203d 206e 702e 7469 6c65 2820 4661 6c73   = np.tile( Fals
-0006f820: 652c 2064 662e 7368 6170 655b 305d 2029  e, df.shape[0] )
-0006f830: 0a20 2020 2066 6f72 2078 2069 6e20 7261  .    for x in ra
-0006f840: 6e67 6528 6466 2e73 6861 7065 5b30 5d29  nge(df.shape[0])
-0006f850: 3a0a 2020 2020 2020 2020 6d79 666e 203d  :.        myfn =
-0006f860: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
-0006f870: 6528 2064 665b 2766 696c 656e 616d 6527  e( df['filename'
-0006f880: 5d2e 696c 6f63 5b78 5d20 290a 2020 2020  ].iloc[x] ).    
-0006f890: 2020 2020 7465 6d70 203d 206d 7966 6e2e      temp = myfn.
-0006f8a0: 7370 6c69 7428 2073 706c 6974 7365 7020  split( splitsep 
-0006f8b0: 290a 2020 2020 2020 2020 2320 4765 6e65  ).        # Gene
-0006f8c0: 7261 6c69 7a65 6420 7365 6172 6368 2070  ralized search p
-0006f8d0: 6174 6873 0a20 2020 2020 2020 2073 6964  aths.        sid
-0006f8e0: 3020 3d20 7374 7228 2074 656d 705b 315d  0 = str( temp[1]
-0006f8f0: 2029 0a20 2020 2020 2020 2073 6964 203d   ).        sid =
-0006f900: 2073 7472 2820 6466 5b73 7562 6a65 6374   str( df[subject
-0006f910: 5f63 6f6c 5d2e 696c 6f63 5b78 5d20 290a  _col].iloc[x] ).
-0006f920: 2020 2020 2020 2020 6966 2073 6964 3020          if sid0 
-0006f930: 213d 2073 6964 3a0a 2020 2020 2020 2020  != sid:.        
-0006f940: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
-0006f950: 6e28 224f 5554 4552 3a20 7468 6520 6964  n("OUTER: the id
-0006f960: 2064 6572 6976 6564 2066 726f 6d20 7468   derived from th
-0006f970: 6520 6669 6c65 6e61 6d65 2022 202b 2073  e filename " + s
-0006f980: 6964 3020 2b20 2220 646f 6573 206e 6f74  id0 + " does not
-0006f990: 206d 6174 6368 2074 6865 2069 6420 7374   match the id st
-0006f9a0: 6f72 6564 2069 6e20 7468 6520 6461 7461  ored in the data
-0006f9b0: 2066 7261 6d65 2022 202b 2073 6964 2029   frame " + sid )
-0006f9c0: 0a20 2020 2020 2020 2020 2020 2077 6172  .            war
-0006f9d0: 6e69 6e67 732e 7761 726e 2820 2266 696c  nings.warn( "fil
-0006f9e0: 656e 616d 6520 6973 203a 2022 202b 2020  ename is : " +  
-0006f9f0: 6d79 666e 2029 0a20 2020 2020 2020 2020  myfn ).         
-0006fa00: 2020 2077 6172 6e69 6e67 732e 7761 726e     warnings.warn
-0006fa10: 2820 2273 6964 2069 7320 3a20 2220 2b20  ( "sid is : " + 
-0006fa20: 7369 6420 290a 2020 2020 2020 2020 2020  sid ).          
-0006fa30: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
-0006fa40: 2022 7820 6973 203a 2022 202b 2073 7472   "x is : " + str
-0006fa50: 2878 2920 290a 2020 2020 2020 2020 6d79  (x) ).        my
-0006fa60: 7072 6f6a 203d 2073 7472 2864 665b 7072  proj = str(df[pr
-0006fa70: 6f6a 6563 745f 636f 6c5d 2e69 6c6f 635b  oject_col].iloc[
-0006fa80: 785d 290a 2020 2020 2020 2020 6d79 6461  x]).        myda
-0006fa90: 7465 203d 2073 7472 2864 665b 6461 7465  te = str(df[date
-0006faa0: 5f63 6f6c 5d2e 696c 6f63 5b78 5d29 0a20  _col].iloc[x]). 
-0006fab0: 2020 2020 2020 206d 7969 6420 3d20 7374         myid = st
-0006fac0: 7228 6466 5b69 6d61 6765 5f63 6f6c 5d2e  r(df[image_col].
-0006fad0: 696c 6f63 5b78 5d29 0a20 2020 2020 2020  iloc[x]).       
-0006fae0: 2069 6620 7365 636f 6e64 5f73 706c 6974   if second_split
-0006faf0: 3a0a 2020 2020 2020 2020 2020 2020 6d79  :.            my
-0006fb00: 6964 203d 206d 7969 642e 7370 6c69 7428  id = myid.split(
-0006fb10: 222e 2229 5b30 5d0a 2020 2020 2020 2020  ".")[0].        
-0006fb20: 7061 7468 5f74 656d 706c 6174 6520 3d20  path_template = 
-0006fb30: 6261 7365 5f70 6174 6820 2b20 222f 2220  base_path + "/" 
-0006fb40: 2b20 6d79 7072 6f6a 202b 2020 222f 2220  + myproj +  "/" 
-0006fb50: 2b20 7369 6420 2b20 222f 2220 2b20 6d79  + sid + "/" + my
-0006fb60: 6461 7465 202b 2027 2f27 202b 2068 6965  date + '/' + hie
-0006fb70: 7276 6172 6961 626c 6520 2b20 272f 2720  rvariable + '/' 
-0006fb80: 2b20 7374 7228 6d79 6964 2920 2b20 222f  + str(myid) + "/
-0006fb90: 220a 2020 2020 2020 2020 6869 6572 666e  ".        hierfn
-0006fba0: 203d 2073 6f72 7465 6428 676c 6f62 2820   = sorted(glob( 
-0006fbb0: 7061 7468 5f74 656d 706c 6174 6520 2b20  path_template + 
-0006fbc0: 222a 2220 2b20 6869 6572 7661 7269 6162  "*" + hiervariab
-0006fbd0: 6c65 202b 2022 2a77 6964 652e 6373 7622  le + "*wide.csv"
-0006fbe0: 2029 2029 0a20 2020 2020 2020 2069 6620   ) ).        if 
-0006fbf0: 6c65 6e28 2068 6965 7266 6e20 2920 3d3d  len( hierfn ) ==
-0006fc00: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-0006fc10: 7072 696e 7428 2068 6965 7266 6e20 290a  print( hierfn ).
-0006fc20: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0006fc30: 7428 2070 6174 685f 7465 6d70 6c61 7465  t( path_template
-0006fc40: 2029 0a20 2020 2020 2020 2020 2020 2070   ).            p
-0006fc50: 7269 6e74 2820 6d79 7072 6f6a 2029 0a20  rint( myproj ). 
-0006fc60: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0006fc70: 2820 7369 6420 290a 2020 2020 2020 2020  ( sid ).        
-0006fc80: 2020 2020 7072 696e 7428 206d 7964 6174      print( mydat
-0006fc90: 6520 2920 0a20 2020 2020 2020 2020 2020  e ) .           
-0006fca0: 2070 7269 6e74 2820 6d79 6964 2029 0a20   print( myid ). 
-0006fcb0: 2020 2020 2020 2069 6620 6c65 6e28 2068         if len( h
-0006fcc0: 6965 7266 6e20 2920 3e20 303a 0a20 2020  ierfn ) > 0:.   
-0006fcd0: 2020 2020 2020 2020 206b 6565 705b 785d           keep[x]
-0006fce0: 3d54 7275 650a 0a20 2020 2023 2064 663d  =True..    # df=
-0006fcf0: 6466 5b6b 6565 705d 0a20 2020 2069 6620  df[keep].    if 
-0006fd00: 6466 2e73 6861 7065 5b30 5d20 3d3d 2030  df.shape[0] == 0
-0006fd10: 3a0a 2020 2020 2020 2020 7761 726e 696e  :.        warnin
-0006fd20: 6773 2e77 6172 6e28 2269 6e70 7574 2064  gs.warn("input d
-0006fd30: 6174 6120 6672 616d 6520 7368 6170 6520  ata frame shape 
-0006fd40: 6973 2066 696c 7465 7265 6420 646f 776e  is filtered down
-0006fd50: 2074 6f20 7a65 726f 2229 0a20 2020 2020   to zero").     
-0006fd60: 2020 2072 6574 7572 6e20 6466 0a0a 2020     return df..  
-0006fd70: 2020 6966 206e 6f74 2064 662e 696e 6465    if not df.inde
-0006fd80: 782e 6973 5f75 6e69 7175 653a 0a20 2020  x.is_unique:.   
-0006fd90: 2020 2020 2077 6172 6e69 6e67 732e 7761       warnings.wa
-0006fda0: 726e 2822 6461 7461 2066 7261 6d65 2064  rn("data frame d
-0006fdb0: 6f65 7320 6e6f 7420 6861 7665 2075 6e69  oes not have uni
-0006fdc0: 7175 6520 696e 6469 6365 732e 2020 7765  que indices.  we
-0006fdd0: 2074 6865 7265 666f 7265 2072 6573 6574   therefore reset
-0006fde0: 2074 6865 2069 6e64 6578 2074 6f20 616c   the index to al
-0006fdf0: 6c6f 7720 7468 6520 6675 6e63 7469 6f6e  low the function
-0006fe00: 2074 6f20 636f 6e74 696e 7565 206f 6e2e   to continue on.
-0006fe10: 2220 290a 2020 2020 2020 2020 6466 203d  " ).        df =
-0006fe20: 2064 662e 7265 7365 745f 696e 6465 7828   df.reset_index(
-0006fe30: 290a 0a20 2020 200a 2020 2020 6966 2076  )..    .    if v
-0006fe40: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-0006fe50: 7072 696e 7428 2022 6f72 6967 696e 616c  print( "original
-0006fe60: 2069 6e70 7574 2068 6164 2073 6861 7065   input had shape
-0006fe70: 2022 202b 2073 7472 2820 6466 2e73 6861   " + str( df.sha
-0006fe80: 7065 5b30 5d20 2920 2b20 2220 2854 3120  pe[0] ) + " (T1 
-0006fe90: 6f6e 6c79 2920 616e 6420 7765 2066 696e  only) and we fin
-0006fea0: 6420 2220 2b20 7374 7228 2028 6b65 6570  d " + str( (keep
-0006feb0: 292e 7375 6d28 2920 2920 2b20 2220 7769  ).sum() ) + " wi
-0006fec0: 7468 2068 6965 7261 7263 6869 6361 6c20  th hierarchical 
-0006fed0: 6f75 7470 7574 2064 6566 696e 6564 2062  output defined b
-0006fee0: 7920 7661 7269 6162 6c65 3a20 2220 2b20  y variable: " + 
-0006fef0: 6869 6572 7661 7269 6162 6c65 2029 0a20  hiervariable ). 
-0006ff00: 2020 2020 2020 2070 7269 6e74 2820 6466         print( df
-0006ff10: 2e73 6861 7065 2029 0a0a 2020 2020 6466  .shape )..    df
-0006ff20: 6f75 7420 3d20 7064 2e44 6174 6146 7261  out = pd.DataFra
-0006ff30: 6d65 2829 0a20 2020 206d 7963 7420 3d20  me().    myct = 
-0006ff40: 300a 2020 2020 666f 7220 7820 696e 2072  0.    for x in r
-0006ff50: 616e 6765 2820 6466 2e73 6861 7065 5b30  ange( df.shape[0
-0006ff60: 5d29 3a0a 2020 2020 2020 2020 6966 2076  ]):.        if v
-0006ff70: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-0006ff80: 2020 2020 7072 696e 7428 225c 6e5c 6e2d      print("\n\n-
-0006ff90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0006ffa0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0006ffb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0006ffc0: 2229 0a20 2020 2020 2020 2020 2020 2070  ").            p
-0006ffd0: 7269 6e74 2866 227b 787d 2e2e 2e22 290a  rint(f"{x}...").
-0006ffe0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0006fff0: 2020 2020 2020 2020 2020 7072 6f67 7265            progre
-00070000: 7373 5f72 6570 6f72 7465 7228 782c 2064  ss_reporter(x, d
-00070010: 662e 7368 6170 655b 305d 2c20 7769 6474  f.shape[0], widt
-00070020: 683d 3530 3029 0a20 2020 2020 2020 206c  h=500).        l
-00070030: 6f63 696e 6420 3d20 6466 2e69 6e64 6578  ocind = df.index
-00070040: 5b78 5d0a 2020 2020 2020 2020 6d79 666e  [x].        myfn
-00070050: 203d 206f 732e 7061 7468 2e62 6173 656e   = os.path.basen
-00070060: 616d 6528 2064 665b 2766 696c 656e 616d  ame( df['filenam
-00070070: 6527 5d2e 696c 6f63 5b78 5d20 290a 2020  e'].iloc[x] ).  
-00070080: 2020 2020 2020 7369 6420 3d20 7374 7228        sid = str(
-00070090: 2064 665b 7375 626a 6563 745f 636f 6c5d   df[subject_col]
-000700a0: 2e69 6c6f 635b 785d 2029 0a20 2020 2020  .iloc[x] ).     
-000700b0: 2020 2074 656d 7042 203d 206d 7966 6e2e     tempB = myfn.
-000700c0: 7370 6c69 7428 2073 706c 6974 7365 7020  split( splitsep 
-000700d0: 290a 2020 2020 2020 2020 7369 6430 203d  ).        sid0 =
-000700e0: 2073 7472 2874 656d 7042 5b31 5d29 0a20   str(tempB[1]). 
-000700f0: 2020 2020 2020 2069 6620 7369 6430 2021         if sid0 !
-00070100: 3d20 7369 6420 616e 6420 7665 7262 6f73  = sid and verbos
-00070110: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
-00070120: 6172 6e69 6e67 732e 7761 726e 2822 494e  arnings.warn("IN
-00070130: 4e45 523a 2074 6865 2069 6420 6465 7269  NER: the id deri
-00070140: 7665 6420 6672 6f6d 2074 6865 2066 696c  ved from the fil
-00070150: 656e 616d 6520 2220 2b20 7374 7228 7369  ename " + str(si
-00070160: 6429 202b 2022 2064 6f65 7320 6e6f 7420  d) + " does not 
-00070170: 6d61 7463 6820 7468 6520 6964 2073 746f  match the id sto
-00070180: 7265 6420 696e 2074 6865 2064 6174 6120  red in the data 
-00070190: 6672 616d 6520 2220 2b20 7374 7228 7369  frame " + str(si
-000701a0: 6430 2920 290a 2020 2020 2020 2020 2020  d0) ).          
-000701b0: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
-000701c0: 2022 6669 6c65 6e61 6d65 2069 7320 3a20   "filename is : 
-000701d0: 2220 2b20 2073 7472 286d 7966 6e29 2029  " +  str(myfn) )
-000701e0: 0a20 2020 2020 2020 2020 2020 2077 6172  .            war
-000701f0: 6e69 6e67 732e 7761 726e 2820 2273 6964  nings.warn( "sid
-00070200: 2069 7320 3a20 2220 2b20 7374 7228 7369   is : " + str(si
-00070210: 6429 2029 0a20 2020 2020 2020 2020 2020  d) ).           
-00070220: 2077 6172 6e69 6e67 732e 7761 726e 2820   warnings.warn( 
-00070230: 2278 2069 7320 3a20 2220 2b20 7374 7228  "x is : " + str(
-00070240: 7829 2029 0a20 2020 2020 2020 2020 2020  x) ).           
-00070250: 2077 6172 6e69 6e67 732e 7761 726e 2820   warnings.warn( 
-00070260: 2269 6e64 6578 2069 7320 3a20 2220 2b20  "index is : " + 
-00070270: 7374 7228 6c6f 6369 6e64 2920 290a 2020  str(locind) ).  
-00070280: 2020 2020 2020 6d79 7072 6f6a 203d 2073        myproj = s
-00070290: 7472 2864 665b 7072 6f6a 6563 745f 636f  tr(df[project_co
-000702a0: 6c5d 2e69 6c6f 635b 785d 290a 2020 2020  l].iloc[x]).    
-000702b0: 2020 2020 6d79 6461 7465 203d 2073 7472      mydate = str
-000702c0: 2864 665b 6461 7465 5f63 6f6c 5d2e 696c  (df[date_col].il
-000702d0: 6f63 5b78 5d29 0a20 2020 2020 2020 206d  oc[x]).        m
-000702e0: 7969 6420 3d20 7374 7228 6466 5b69 6d61  yid = str(df[ima
-000702f0: 6765 5f63 6f6c 5d2e 696c 6f63 5b78 5d29  ge_col].iloc[x])
-00070300: 0a20 2020 2020 2020 2069 6620 7365 636f  .        if seco
-00070310: 6e64 5f73 706c 6974 3a0a 2020 2020 2020  nd_split:.      
-00070320: 2020 2020 2020 6d79 6964 203d 206d 7969        myid = myi
-00070330: 642e 7370 6c69 7428 222e 2229 5b30 5d0a  d.split(".")[0].
-00070340: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-00070350: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00070360: 7072 696e 7428 206d 7966 6e20 290a 2020  print( myfn ).  
-00070370: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00070380: 2074 656d 7020 290a 2020 2020 2020 2020   temp ).        
-00070390: 2020 2020 7072 696e 7428 2022 6964 2022      print( "id "
-000703a0: 202b 2073 6964 2020 290a 2020 2020 2020   + sid  ).      
-000703b0: 2020 7061 7468 5f74 656d 706c 6174 6520    path_template 
-000703c0: 3d20 6261 7365 5f70 6174 6820 2b20 222f  = base_path + "/
-000703d0: 2220 2b20 6d79 7072 6f6a 202b 2020 222f  " + myproj +  "/
-000703e0: 2220 2b20 7369 6420 2b20 222f 2220 2b20  " + sid + "/" + 
-000703f0: 6d79 6461 7465 202b 2027 2f27 202b 2068  mydate + '/' + h
-00070400: 6965 7276 6172 6961 626c 6520 2b20 272f  iervariable + '/
-00070410: 2720 2b20 7374 7228 6d79 6964 2920 2b20  ' + str(myid) + 
-00070420: 222f 220a 2020 2020 2020 2020 7365 6172  "/".        sear
-00070430: 6368 6869 6572 203d 2070 6174 685f 7465  chhier = path_te
-00070440: 6d70 6c61 7465 202b 2022 2a22 202b 2068  mplate + "*" + h
-00070450: 6965 7276 6172 6961 626c 6520 2b20 222a  iervariable + "*
-00070460: 7769 6465 2e63 7376 220a 2020 2020 2020  wide.csv".      
-00070470: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-00070480: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00070490: 2073 6561 7263 6868 6965 7220 290a 2020   searchhier ).  
-000704a0: 2020 2020 2020 6869 6572 666e 203d 2073        hierfn = s
-000704b0: 6f72 7465 6428 2067 6c6f 6228 2073 6561  orted( glob( sea
-000704c0: 7263 6868 6965 7220 2920 290a 2020 2020  rchhier ) ).    
-000704d0: 2020 2020 6966 206c 656e 2820 6869 6572      if len( hier
-000704e0: 666e 2029 203e 2031 3a0a 2020 2020 2020  fn ) > 1:.      
-000704f0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00070500: 6545 7272 6f72 2822 7468 6572 6520 6172  eError("there ar
-00070510: 6520 2220 2b20 7374 7228 206c 656e 2820  e " + str( len( 
-00070520: 6869 6572 666e 2029 2029 202b 2022 206e  hierfn ) ) + " n
-00070530: 756d 6265 7220 6f66 2068 6965 7220 666e  umber of hier fn
-00070540: 7320 7769 7468 2073 6561 7263 6820 7061  s with search pa
-00070550: 7468 2022 202b 2073 6561 7263 6868 6965  th " + searchhie
-00070560: 7220 290a 2020 2020 2020 2020 6966 206c  r ).        if l
-00070570: 656e 2820 6869 6572 666e 2029 203d 3d20  en( hierfn ) == 
-00070580: 313a 0a20 2020 2020 2020 2020 2020 2068  1:.            h
-00070590: 6466 3d74 3164 663d 6474 6466 3d72 7364  df=t1df=dtdf=rsd
-000705a0: 663d 7065 7266 6466 3d6e 6d64 663d 666c  f=perfdf=nmdf=fl
-000705b0: 6169 7264 663d 4e6f 6e65 0a20 2020 2020  airdf=None.     
-000705c0: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-000705d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000705e0: 2020 2070 7269 6e74 2868 6965 7266 6e29     print(hierfn)
-000705f0: 0a20 2020 2020 2020 2020 2020 2068 6466  .            hdf
-00070600: 203d 2070 642e 7265 6164 5f63 7376 2868   = pd.read_csv(h
-00070610: 6965 7266 6e5b 305d 290a 2020 2020 2020  ierfn[0]).      
-00070620: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
-00070630: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00070640: 2020 7072 696e 7428 2068 6466 5b27 766f    print( hdf['vo
-00070650: 6c5f 6865 6d69 7370 6865 7265 5f6c 6566  l_hemisphere_lef
-00070660: 7468 656d 6973 7068 6572 6573 275d 2029  themispheres'] )
-00070670: 0a20 2020 2020 2020 2020 2020 2062 6164  .            bad
-00070680: 6e61 6d65 7320 3d20 6765 745f 6e61 6d65  names = get_name
-00070690: 735f 6672 6f6d 5f64 6174 615f 6672 616d  s_from_data_fram
-000706a0: 6528 205b 2755 6e6e 616d 6564 275d 2c20  e( ['Unnamed'], 
-000706b0: 6864 6620 290a 2020 2020 2020 2020 2020  hdf ).          
-000706c0: 2020 6864 663d 6864 662e 6472 6f70 2862    hdf=hdf.drop(b
-000706d0: 6164 6e61 6d65 732c 2061 7869 733d 3129  adnames, axis=1)
-000706e0: 0a20 2020 2020 2020 2020 2020 206e 756d  .            num
-000706f0: 7320 3d20 5b69 7369 6e73 7461 6e63 6528  s = [isinstance(
-00070700: 6864 665b 636f 6c5d 2e69 6c6f 635b 305d  hdf[col].iloc[0]
-00070710: 2c20 2869 6e74 2c20 666c 6f61 7429 2920  , (int, float)) 
-00070720: 666f 7220 636f 6c20 696e 2068 6466 2e63  for col in hdf.c
-00070730: 6f6c 756d 6e73 5d0a 2020 2020 2020 2020  olumns].        
-00070740: 2020 2020 636f 7265 6e61 6d65 7320 3d20      corenames = 
-00070750: 6c69 7374 286e 702e 6172 7261 7928 6864  list(np.array(hd
-00070760: 662e 636f 6c75 6d6e 7329 5b6e 756d 735d  f.columns)[nums]
-00070770: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-00070780: 6864 662e 6c6f 635b 3a2c 206e 756d 735d  hdf.loc[:, nums]
-00070790: 203d 2068 6466 2e6c 6f63 5b3a 2c20 6e75   = hdf.loc[:, nu
-000707a0: 6d73 5d2e 6164 645f 7072 6566 6978 2822  ms].add_prefix("
-000707b0: 5431 4869 6572 5f22 290a 2020 2020 2020  T1Hier_").      
-000707c0: 2020 2020 2020 6864 6620 3d20 6864 662e        hdf = hdf.
-000707d0: 6164 645f 7072 6566 6978 2822 5431 4869  add_prefix("T1Hi
-000707e0: 6572 5f22 290a 2020 2020 2020 2020 2020  er_").          
-000707f0: 2020 6d79 6374 203d 206d 7963 7420 2b20    myct = myct + 
-00070800: 310a 2020 2020 2020 2020 2020 2020 6466  1.            df
-00070810: 6c69 7374 203d 205b 6864 665d 0a0a 2020  list = [hdf]..  
-00070820: 2020 2020 2020 2020 2020 666f 7220 6d79            for my
-00070830: 6d6f 6420 696e 2076 6d6f 6464 6963 742e  mod in vmoddict.
-00070840: 6b65 7973 2829 3a0a 2020 2020 2020 2020  keys():.        
-00070850: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
-00070860: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00070870: 2020 2020 2020 2020 7072 696e 7428 225c          print("\
-00070880: 6e5c 6e2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  n\n*************
-00070890: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2022 202b  ************ " +
-000708a0: 206d 796d 6f64 202b 2022 202a 2a2a 2a2a   mymod + " *****
-000708b0: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
-000708c0: 2a2a 2a2a 2229 0a20 2020 2020 2020 2020  ****").         
-000708d0: 2020 2020 2020 206d 6f64 616c 6974 7963         modalityc
-000708e0: 6c61 7373 203d 2076 6d6f 6464 6963 745b  lass = vmoddict[
-000708f0: 206d 796d 6f64 205d 0a20 2020 2020 2020   mymod ].       
-00070900: 2020 2020 2020 2020 2069 6620 7769 6c64           if wild
-00070910: 5f63 6172 645f 6d6f 6461 6c69 7479 5f69  _card_modality_i
-00070920: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-00070930: 2020 2020 2020 206d 796d 6f64 6964 203d         mymodid =
-00070940: 2027 2a27 0a20 2020 2020 2020 2020 2020   '*'.           
-00070950: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00070960: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00070970: 796d 6f64 6964 203d 2073 7472 2820 6466  ymodid = str( df
-00070980: 5b6d 796d 6f64 5d2e 696c 6f63 5b78 5d20  [mymod].iloc[x] 
-00070990: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000709a0: 2020 2020 2020 6966 206d 796d 6f64 6964        if mymodid
-000709b0: 2e6c 6f77 6572 2829 2021 3d20 226e 616e  .lower() != "nan
-000709c0: 2220 616e 6420 6d79 6d6f 6469 642e 6c6f  " and mymodid.lo
-000709d0: 7765 7228 2920 213d 2022 6e61 223a 0a20  wer() != "na":. 
-000709e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000709f0: 2020 2020 2020 206d 796d 6f64 6964 203d         mymodid =
-00070a00: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
-00070a10: 6528 206d 796d 6f64 6964 2029 0a20 2020  e( mymodid ).   
-00070a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070a30: 2020 2020 206d 796d 6f64 6964 203d 206f       mymodid = o
-00070a40: 732e 7061 7468 2e73 706c 6974 6578 7428  s.path.splitext(
-00070a50: 206d 796d 6f64 6964 2029 5b30 5d0a 2020   mymodid )[0].  
-00070a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070a70: 2020 2020 2020 6d79 6d6f 6469 6420 3d20        mymodid = 
-00070a80: 6f73 2e70 6174 682e 7370 6c69 7465 7874  os.path.splitext
-00070a90: 2820 6d79 6d6f 6469 6420 295b 305d 0a20  ( mymodid )[0]. 
-00070aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070ab0: 2020 2020 2020 2074 656d 7020 3d20 6d79         temp = my
-00070ac0: 6d6f 6469 642e 7370 6c69 7428 2069 6473  modid.split( ids
-00070ad0: 6570 2029 0a20 2020 2020 2020 2020 2020  ep ).           
-00070ae0: 2020 2020 2020 2020 2020 2020 206d 796d               mym
-00070af0: 6f64 6964 203d 2074 656d 705b 206c 656e  odid = temp[ len
-00070b00: 2820 7465 6d70 2029 2d31 205d 0a20 2020  ( temp )-1 ].   
-00070b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070b20: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00070b30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00070b40: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-00070b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070b60: 2020 2020 2020 2070 7269 6e74 2822 6d69         print("mi
-00070b70: 7373 696e 6722 290a 2020 2020 2020 2020  ssing").        
-00070b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070b90: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-00070ba0: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
-00070bb0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-00070bc0: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
-00070bd0: 226d 6f64 616c 6974 7920 6964 2069 7320  "modality id is 
-00070be0: 2220 2b20 6d79 6d6f 6469 6420 2b20 2220  " + mymodid + " 
-00070bf0: 666f 7220 6d6f 6461 6c69 7479 2022 202b  for modality " +
-00070c00: 206d 6f64 616c 6974 7963 6c61 7373 202b   modalityclass +
-00070c10: 2027 206d 6f64 616c 6974 7920 7370 6563   ' modality spec
-00070c20: 6966 6963 2073 7562 6a20 2720 2b20 7369  ific subj ' + si
-00070c30: 6420 2b20 2720 6d6f 6461 6c69 7479 2073  d + ' modality s
-00070c40: 7065 6369 6669 6320 6964 2069 7320 2720  pecific id is ' 
-00070c50: 2b20 6d79 6964 202b 2022 2069 7473 2064  + myid + " its d
-00070c60: 6174 6520 2220 2b20 206d 7964 6174 6520  ate " +  mydate 
-00070c70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00070c80: 2020 6d6f 6461 6c69 7479 636c 6173 7373    modalityclasss
-00070c90: 6561 7263 6820 3d20 6d6f 6461 6c69 7479  earch = modality
-00070ca0: 636c 6173 730a 2020 2020 2020 2020 2020  class.          
-00070cb0: 2020 2020 2020 6966 206d 6f64 616c 6974        if modalit
-00070cc0: 7963 6c61 7373 2069 6e20 5b27 7273 664d  yclass in ['rsfM
-00070cd0: 5249 272c 2744 5449 275d 3a0a 2020 2020  RI','DTI']:.    
-00070ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070cf0: 6d6f 6461 6c69 7479 636c 6173 7373 6561  modalityclasssea
-00070d00: 7263 683d 6d6f 6461 6c69 7479 636c 6173  rch=modalityclas
-00070d10: 732b 222a 220a 2020 2020 2020 2020 2020  s+"*".          
-00070d20: 2020 2020 2020 7061 7468 5f74 656d 706c        path_templ
-00070d30: 6174 655f 6d20 3d20 6261 7365 5f70 6174  ate_m = base_pat
-00070d40: 6820 2b20 222f 2220 2b20 6d79 7072 6f6a  h + "/" + myproj
-00070d50: 202b 2020 222f 2220 2b20 7369 6420 2b20   +  "/" + sid + 
-00070d60: 222f 2220 2b20 6d79 6461 7465 202b 2027  "/" + mydate + '
-00070d70: 2f27 202b 206d 6f64 616c 6974 7963 6c61  /' + modalitycla
-00070d80: 7373 7365 6172 6368 202b 2027 2f27 202b  sssearch + '/' +
-00070d90: 206d 796d 6f64 6964 202b 2022 2f22 0a20   mymodid + "/". 
-00070da0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00070db0: 6f64 7365 6172 6368 203d 2070 6174 685f  odsearch = path_
-00070dc0: 7465 6d70 6c61 7465 5f6d 202b 2022 2a22  template_m + "*"
-00070dd0: 202b 206d 6f64 616c 6974 7963 6c61 7373   + modalityclass
-00070de0: 7365 6172 6368 202b 2022 2a77 6964 652e  search + "*wide.
-00070df0: 6373 7622 0a20 2020 2020 2020 2020 2020  csv".           
-00070e00: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-00070e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00070e20: 2020 2020 2070 7269 6e74 2820 6d6f 6473       print( mods
-00070e30: 6561 7263 6820 290a 2020 2020 2020 2020  earch ).        
-00070e40: 2020 2020 2020 2020 7431 7766 6e20 3d20          t1wfn = 
-00070e50: 736f 7274 6564 2820 676c 6f62 2820 6d6f  sorted( glob( mo
-00070e60: 6473 6561 7263 6820 2920 290a 2020 2020  dsearch ) ).    
-00070e70: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-00070e80: 656e 2820 7431 7766 6e20 2920 3e20 313a  en( t1wfn ) > 1:
-00070e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00070ea0: 2020 2020 206e 6c61 7267 6520 3d20 6c65       nlarge = le
-00070eb0: 6e28 7431 7766 6e29 0a20 2020 2020 2020  n(t1wfn).       
-00070ec0: 2020 2020 2020 2020 2020 2020 2074 3177               t1w
-00070ed0: 666e 203d 2066 696e 645f 6d6f 7374 5f72  fn = find_most_r
-00070ee0: 6563 656e 745f 6669 6c65 2820 7431 7766  ecent_file( t1wf
-00070ef0: 6e20 290a 2020 2020 2020 2020 2020 2020  n ).            
-00070f00: 2020 2020 2020 2020 7761 726e 696e 6773          warnings
-00070f10: 2e77 6172 6e28 2274 6865 7265 2061 7265  .warn("there are
-00070f20: 2022 202b 2073 7472 2820 6e6c 6172 6765   " + str( nlarge
-00070f30: 2029 202b 2022 206e 756d 6265 7220 6f66   ) + " number of
-00070f40: 2077 6964 6520 666e 7320 7769 7468 2073   wide fns with s
-00070f50: 6561 7263 6820 7061 7468 2022 202b 206d  earch path " + m
-00070f60: 6f64 7365 6172 6368 202b 2022 2077 6520  odsearch + " we 
-00070f70: 7461 6b65 2074 6865 206d 6f73 7420 7265  take the most re
-00070f80: 6365 6e74 206f 6620 7468 6573 6520 2220  cent of these " 
-00070f90: 2b20 7431 7766 6e5b 305d 2029 0a20 2020  + t1wfn[0] ).   
-00070fa0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00070fb0: 6c65 6e28 2074 3177 666e 2029 203d 3d20  len( t1wfn ) == 
-00070fc0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-00070fd0: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
-00070fe0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00070ff0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00071000: 2874 3177 666e 290a 2020 2020 2020 2020  (t1wfn).        
-00071010: 2020 2020 2020 2020 2020 2020 7431 6466              t1df
-00071020: 203d 206d 7972 6561 645f 6373 7628 7431   = myread_csv(t1
-00071030: 7766 6e5b 305d 2c20 636f 7265 6e61 6d65  wfn[0], corename
-00071040: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-00071050: 2020 2020 2020 2074 3164 6620 3d20 6669         t1df = fi
-00071060: 6c74 6572 5f64 6628 2074 3164 662c 206d  lter_df( t1df, m
-00071070: 6f64 616c 6974 7963 6c61 7373 2b27 5f27  odalityclass+'_'
-00071080: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00071090: 2020 2020 2020 6466 6c69 7374 203d 2064        dflist = d
-000710a0: 666c 6973 7420 2b20 5b74 3164 665d 0a20  flist + [t1df]. 
-000710b0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000710c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000710d0: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
-000710e0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-000710f0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00071100: 6e74 2820 2220 6361 6e6e 6f74 2066 696e  nt( " cannot fin
-00071110: 6420 2220 2b20 6d6f 6473 6561 7263 6820  d " + modsearch 
-00071120: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00071130: 2020 0a20 2020 2020 2020 2020 2020 2068    .            h
-00071140: 6466 203d 2070 642e 636f 6e63 6174 2820  df = pd.concat( 
-00071150: 6466 6c69 7374 2c20 6178 6973 3d31 2c20  dflist, axis=1, 
-00071160: 6967 6e6f 7265 5f69 6e64 6578 3d46 616c  ignore_index=Fal
-00071170: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
-00071180: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
-00071190: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-000711a0: 7428 2022 636f 756e 743a 2022 202b 2073  t( "count: " + s
-000711b0: 7472 2820 6d79 6374 2029 2029 0a20 2020  tr( myct ) ).   
-000711c0: 2020 2020 2020 2020 2073 7562 6466 203d           subdf =
-000711d0: 2064 662e 696c 6f63 5b5b 785d 5d0a 2020   df.iloc[[x]].  
-000711e0: 2020 2020 2020 2020 2020 6864 662e 696e            hdf.in
-000711f0: 6465 7820 3d20 7375 6264 662e 696e 6465  dex = subdf.inde
-00071200: 782e 636f 7079 2829 0a20 2020 2020 2020  x.copy().       
-00071210: 2020 2020 2073 7562 6466 203d 2070 642e       subdf = pd.
-00071220: 636f 6e63 6174 2820 5b73 7562 6466 2c68  concat( [subdf,h
-00071230: 6466 5d2c 2061 7869 733d 312c 2069 676e  df], axis=1, ign
-00071240: 6f72 655f 696e 6465 783d 4661 6c73 6529  ore_index=False)
-00071250: 0a20 2020 2020 2020 2020 2020 2064 666f  .            dfo
-00071260: 7574 203d 2070 642e 636f 6e63 6174 2820  ut = pd.concat( 
-00071270: 5b64 666f 7574 2c73 7562 6466 5d2c 2061  [dfout,subdf], a
-00071280: 7869 733d 302c 2069 676e 6f72 655f 696e  xis=0, ignore_in
-00071290: 6465 783d 4661 6c73 6520 290a 0a20 2020  dex=False )..   
-000712a0: 2069 6620 6466 6f75 742e 7368 6170 655b   if dfout.shape[
-000712b0: 305d 203e 2030 3a0a 2020 2020 2020 2020  0] > 0:.        
-000712c0: 6261 646e 616d 6573 203d 2067 6574 5f6e  badnames = get_n
-000712d0: 616d 6573 5f66 726f 6d5f 6461 7461 5f66  ames_from_data_f
-000712e0: 7261 6d65 2820 5b27 556e 6e61 6d65 6427  rame( ['Unnamed'
-000712f0: 5d2c 2064 666f 7574 2029 0a20 2020 2020  ], dfout ).     
-00071300: 2020 2064 666f 7574 3d64 666f 7574 2e64     dfout=dfout.d
-00071310: 726f 7028 6261 646e 616d 6573 2c20 6178  rop(badnames, ax
-00071320: 6973 3d31 290a 2020 2020 7265 7475 726e  is=1).    return
-00071330: 2064 666f 7574 0a0a 6465 6620 656e 616e   dfout..def enan
-00071340: 7469 6f6d 6f72 7068 6963 5f66 696c 6c69  tiomorphic_filli
-00071350: 6e67 5f77 6974 686f 7574 5f6d 6173 6b28  ng_without_mask(
-00071360: 2069 6d61 6765 2c20 6178 6973 3d30 2c20   image, axis=0, 
-00071370: 696e 7465 6e73 6974 793d 276c 6f77 2720  intensity='low' 
-00071380: 293a 0a20 2020 2022 2222 0a20 2020 2050  ):.    """.    P
-00071390: 6572 666f 726d 2061 6e20 656e 616e 7469  erform an enanti
-000713a0: 6f6d 6f72 7068 6963 206c 6573 696f 6e20  omorphic lesion 
-000713b0: 6669 6c6c 696e 6720 6f6e 2061 6e20 696d  filling on an im
-000713c0: 6167 6520 7769 7468 6f75 7420 6120 6c65  age without a le
-000713d0: 7369 6f6e 206d 6173 6b2e 0a0a 2020 2020  sion mask...    
-000713e0: 4172 6773 3a0a 2020 2020 696d 6167 6520  Args:.    image 
-000713f0: 2861 6e74 7349 6d61 6765 293a 2054 6865  (antsImage): The
-00071400: 2061 6e74 7320 696d 6167 6520 746f 2066   ants image to f
-00071410: 6c69 7020 616e 6420 6669 6c6c 0a20 2020  lip and fill.   
-00071420: 2061 7869 7320 2820 696e 7420 293a 2074   axis ( int ): t
-00071430: 6865 2061 7869 7320 616c 6f6e 6720 7768  he axis along wh
-00071440: 6963 6820 746f 2072 6566 6c65 6374 2074  ich to reflect t
-00071450: 6865 2069 6d61 6765 0a20 2020 2069 6e74  he image.    int
-00071460: 656e 7369 7479 2028 2073 7472 2029 203a  ensity ( str ) :
-00071470: 206c 6f77 206f 7220 6869 6768 0a0a 2020   low or high..  
-00071480: 2020 5265 7475 726e 733a 0a20 2020 2061    Returns:.    a
-00071490: 6e74 732e 414e 5473 496d 6167 653a 2054  nts.ANTsImage: T
-000714a0: 6865 2069 6d61 6765 2061 6674 6572 2065  he image after e
-000714b0: 6e61 6e74 696f 6d6f 7270 6869 6320 6669  nantiomorphic fi
-000714c0: 6c6c 696e 672e 0a20 2020 2022 2222 0a20  lling..    """. 
-000714d0: 2020 2069 6d61 6765 6e20 3d20 616e 7473     imagen = ants
-000714e0: 2e69 4d61 7468 2820 696d 6167 652c 2027  .iMath( image, '
-000714f0: 4e6f 726d 616c 697a 6527 2029 0a20 2020  Normalize' ).   
-00071500: 2069 6d61 6765 6e20 3d20 616e 7473 2e69   imagen = ants.i
-00071510: 4d61 7468 2820 696d 6167 656e 2c20 2254  Math( imagen, "T
-00071520: 7275 6e63 6174 6549 6e74 656e 7369 7479  runcateIntensity
-00071530: 222c 2031 652d 362c 2030 2e39 3820 290a  ", 1e-6, 0.98 ).
-00071540: 2020 2020 696d 6167 656e 203d 2061 6e74      imagen = ant
-00071550: 732e 694d 6174 6828 2069 6d61 6765 6e2c  s.iMath( imagen,
-00071560: 2027 4e6f 726d 616c 697a 6527 2029 0a20   'Normalize' ). 
-00071570: 2020 2023 2043 7265 6174 6520 6120 6d69     # Create a mi
-00071580: 7272 6f72 2069 6d61 6765 2028 666c 6970  rror image (flip
-00071590: 7069 6e67 206c 6566 7420 616e 6420 7269  ping left and ri
-000715a0: 6768 7429 0a20 2020 206d 6972 726f 725f  ght).    mirror_
-000715b0: 696d 6167 6520 3d20 616e 7473 2e72 6566  image = ants.ref
-000715c0: 6c65 6374 5f69 6d61 6765 2869 6d61 6765  lect_image(image
-000715d0: 6e2c 2061 7869 733d 302c 2074 783d 2753  n, axis=0, tx='S
-000715e0: 794e 2720 295b 2777 6172 7065 646d 6f76  yN' )['warpedmov
-000715f0: 6f75 7427 5d0a 0a20 2020 2023 2043 7265  out']..    # Cre
-00071600: 6174 6520 6120 7379 6d6d 6574 7269 6320  ate a symmetric 
-00071610: 7665 7273 696f 6e20 6f66 2074 6865 2069  version of the i
-00071620: 6d61 6765 2062 7920 6176 6572 6167 696e  mage by averagin
-00071630: 6720 7468 6520 6f72 6967 696e 616c 2061  g the original a
-00071640: 6e64 2074 6865 206d 6972 726f 7220 696d  nd the mirror im
-00071650: 6167 650a 2020 2020 7379 6d6d 6574 7269  age.    symmetri
-00071660: 635f 696d 6167 6520 3d20 696d 6167 656e  c_image = imagen
-00071670: 202a 2030 2e35 202b 206d 6972 726f 725f   * 0.5 + mirror_
-00071680: 696d 6167 6520 2a20 302e 350a 0a20 2020  image * 0.5..   
-00071690: 2023 2049 6465 6e74 6966 7920 706f 7465   # Identify pote
-000716a0: 6e74 6961 6c20 6c65 7369 6f6e 2061 7265  ntial lesion are
-000716b0: 6173 2062 7920 6669 6e64 696e 6720 6469  as by finding di
-000716c0: 6666 6572 656e 6365 7320 6265 7477 6565  fferences betwee
-000716d0: 6e20 7468 6520 6f72 6967 696e 616c 2061  n the original a
-000716e0: 6e64 2073 796d 6d65 7472 6963 2069 6d61  nd symmetric ima
-000716f0: 6765 0a20 2020 2064 6966 6665 7265 6e63  ge.    differenc
-00071700: 655f 696d 6167 6520 3d20 696d 6167 6520  e_image = image 
-00071710: 2d20 7379 6d6d 6574 7269 635f 696d 6167  - symmetric_imag
-00071720: 650a 2020 2020 6469 6666 7365 6720 3d20  e.    diffseg = 
-00071730: 616e 7473 2e74 6872 6573 686f 6c64 5f69  ants.threshold_i
-00071740: 6d61 6765 2864 6966 6665 7265 6e63 655f  mage(difference_
-00071750: 696d 6167 652c 2022 4f74 7375 222c 2033  image, "Otsu", 3
-00071760: 2029 0a20 2020 2069 6620 696e 7465 6e73   ).    if intens
-00071770: 6974 7920 3d3d 2027 6c6f 7727 3a0a 2020  ity == 'low':.  
-00071780: 2020 2020 2020 6c69 6b65 6c79 5f6c 6573        likely_les
-00071790: 696f 6e20 3d20 616e 7473 2e74 6872 6573  ion = ants.thres
-000717a0: 686f 6c64 5f69 6d61 6765 2820 6469 6666  hold_image( diff
-000717b0: 7365 672c 2031 2c20 2031 290a 2020 2020  seg, 1,  1).    
-000717c0: 656c 7365 3a0a 2020 2020 2020 2020 6c69  else:.        li
-000717d0: 6b65 6c79 5f6c 6573 696f 6e20 3d20 616e  kely_lesion = an
-000717e0: 7473 2e74 6872 6573 686f 6c64 5f69 6d61  ts.threshold_ima
-000717f0: 6765 2820 6469 6666 7365 672c 2033 2c20  ge( diffseg, 3, 
-00071800: 2033 290a 2020 2020 6c69 6b65 6c79 5f6c   3).    likely_l
-00071810: 6573 696f 6e20 3d20 616e 7473 2e73 6d6f  esion = ants.smo
-00071820: 6f74 685f 696d 6167 6528 206c 696b 656c  oth_image( likel
-00071830: 795f 6c65 7369 6f6e 2c20 332e 3020 292e  y_lesion, 3.0 ).
-00071840: 694d 6174 6828 224e 6f72 6d61 6c69 7a65  iMath("Normalize
-00071850: 2229 0a20 2020 206c 6573 696f 6e6e 6567  ").    lesionneg
-00071860: 203d 2028 2069 6d61 6765 6e2a 302b 312e   = ( imagen*0+1.
-00071870: 3020 2920 2d20 6c69 6b65 6c79 5f6c 6573  0 ) - likely_les
-00071880: 696f 6e0a 2020 2020 6669 6c6c 6564 5f69  ion.    filled_i
-00071890: 6d61 6765 203d 2061 6e74 732e 696d 6167  mage = ants.imag
-000718a0: 655f 636c 6f6e 6528 696d 6167 656e 2920  e_clone(imagen) 
-000718b0: 2020 200a 2020 2020 6669 6c6c 6564 5f69     .    filled_i
-000718c0: 6d61 6765 203d 2069 6d61 6765 6e20 2a20  mage = imagen * 
-000718d0: 6c65 7369 6f6e 6e65 6720 2b20 6d69 7272  lesionneg + mirr
-000718e0: 6f72 5f69 6d61 6765 202a 206c 696b 656c  or_image * likel
-000718f0: 795f 6c65 7369 6f6e 0a0a 2020 2020 7265  y_lesion..    re
-00071900: 7475 726e 2066 696c 6c65 645f 696d 6167  turn filled_imag
-00071910: 652c 2064 6966 6673 6567 0a0a 0a0a 6465  e, diffseg....de
-00071920: 6620 6669 6c74 6572 5f69 6d61 6765 5f66  f filter_image_f
-00071930: 696c 6573 2869 6d61 6765 5f70 6174 6873  iles(image_paths
-00071940: 2c20 6372 6974 6572 6961 3d27 6c61 7267  , criteria='larg
-00071950: 6573 7427 293a 0a20 2020 2022 2222 0a20  est'):.    """. 
-00071960: 2020 2046 696c 7465 7273 2061 206c 6973     Filters a lis
-00071970: 7420 6f66 2069 6d61 6765 2066 696c 6520  t of image file 
-00071980: 7061 7468 7320 6261 7365 6420 6f6e 2073  paths based on s
-00071990: 7065 6369 6669 6564 2063 7269 7465 7269  pecified criteri
-000719a0: 6120 616e 6420 7265 7475 726e 7320 0a20  a and returns . 
-000719b0: 2020 2074 6865 2070 6174 6820 6f66 2074     the path of t
-000719c0: 6865 2069 6d61 6765 2074 6861 7420 6265  he image that be
-000719d0: 7374 206d 6174 6368 6573 2074 6861 7420  st matches that 
-000719e0: 6372 6974 6572 6961 2028 736d 616c 6c65  criteria (smalle
-000719f0: 7374 2c20 6c61 7267 6573 742c 206f 7220  st, largest, or 
-00071a00: 6272 6967 6874 6573 7429 2e0a 0a20 2020  brightest)...   
-00071a10: 2041 7267 733a 0a20 2020 2069 6d61 6765   Args:.    image
-00071a20: 5f70 6174 6873 2028 6c69 7374 293a 2041  _paths (list): A
-00071a30: 206c 6973 7420 6f66 2066 696c 6520 7061   list of file pa
-00071a40: 7468 7320 746f 2074 6865 2069 6d61 6765  ths to the image
-00071a50: 732e 0a20 2020 2063 7269 7465 7269 6120  s..    criteria 
-00071a60: 2873 7472 293a 2043 7269 7465 7269 6120  (str): Criteria 
-00071a70: 666f 7220 7365 6c65 6374 696e 6720 7468  for selecting th
-00071a80: 6520 696d 6167 6520 2827 736d 616c 6c65  e image ('smalle
-00071a90: 7374 272c 2027 6c61 7267 6573 7427 2c20  st', 'largest', 
-00071aa0: 2762 7269 6768 7465 7374 2729 2e0a 0a20  'brightest')... 
-00071ab0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00071ac0: 7374 723a 2054 6865 2066 696c 6520 7061  str: The file pa
-00071ad0: 7468 206f 6620 7468 6520 7365 6c65 6374  th of the select
-00071ae0: 6564 2069 6d61 6765 2c20 6f72 204e 6f6e  ed image, or Non
-00071af0: 6520 6966 206e 6f20 7661 6c69 6420 696d  e if no valid im
-00071b00: 6167 6573 2061 7265 2066 6f75 6e64 2e0a  ages are found..
-00071b10: 2020 2020 2222 220a 2020 2020 696d 706f      """.    impo
-00071b20: 7274 206e 756d 7079 2061 7320 6e70 0a20  rt numpy as np. 
-00071b30: 2020 2069 6620 6e6f 7420 696d 6167 655f     if not image_
-00071b40: 7061 7468 733a 0a20 2020 2020 2020 2072  paths:.        r
-00071b50: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
-00071b60: 7365 6c65 6374 6564 5f69 6d61 6765 5f70  selected_image_p
-00071b70: 6174 6820 3d20 4e6f 6e65 0a20 2020 2069  ath = None.    i
-00071b80: 6620 6372 6974 6572 6961 203d 3d20 2773  f criteria == 's
-00071b90: 6d61 6c6c 6573 7427 206f 7220 6372 6974  mallest' or crit
-00071ba0: 6572 6961 203d 3d20 276c 6172 6765 7374  eria == 'largest
-00071bb0: 273a 0a20 2020 2020 2020 2065 7874 7265  ':.        extre
-00071bc0: 6d65 5f76 6f6c 756d 6520 3d20 4e6f 6e65  me_volume = None
-00071bd0: 0a0a 2020 2020 2020 2020 666f 7220 7061  ..        for pa
-00071be0: 7468 2069 6e20 696d 6167 655f 7061 7468  th in image_path
-00071bf0: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
-00071c00: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00071c10: 2020 2020 696d 6167 6520 3d20 616e 7473      image = ants
-00071c20: 2e69 6d61 6765 5f72 6561 6428 7061 7468  .image_read(path
-00071c30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00071c40: 2020 766f 6c75 6d65 203d 206e 702e 7072    volume = np.pr
-00071c50: 6f64 2869 6d61 6765 2e73 6861 7065 290a  od(image.shape).
-00071c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00071c70: 2069 6620 6372 6974 6572 6961 203d 3d20   if criteria == 
-00071c80: 276c 6172 6765 7374 273a 0a20 2020 2020  'largest':.     
-00071c90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00071ca0: 6620 6578 7472 656d 655f 766f 6c75 6d65  f extreme_volume
-00071cb0: 2069 7320 4e6f 6e65 206f 7220 766f 6c75   is None or volu
-00071cc0: 6d65 203e 2065 7874 7265 6d65 5f76 6f6c  me > extreme_vol
-00071cd0: 756d 653a 0a20 2020 2020 2020 2020 2020  ume:.           
-00071ce0: 2020 2020 2020 2020 2020 2020 2065 7874               ext
-00071cf0: 7265 6d65 5f76 6f6c 756d 6520 3d20 766f  reme_volume = vo
-00071d00: 6c75 6d65 0a20 2020 2020 2020 2020 2020  lume.           
-00071d10: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00071d20: 6563 7465 645f 696d 6167 655f 7061 7468  ected_image_path
-00071d30: 203d 2070 6174 680a 2020 2020 2020 2020   = path.        
-00071d40: 2020 2020 2020 2020 656c 6966 2063 7269          elif cri
-00071d50: 7465 7269 6120 3d3d 2027 736d 616c 6c65  teria == 'smalle
-00071d60: 7374 273a 0a20 2020 2020 2020 2020 2020  st':.           
-00071d70: 2020 2020 2020 2020 2069 6620 6578 7472           if extr
-00071d80: 656d 655f 766f 6c75 6d65 2069 7320 4e6f  eme_volume is No
-00071d90: 6e65 206f 7220 766f 6c75 6d65 203c 2065  ne or volume < e
-00071da0: 7874 7265 6d65 5f76 6f6c 756d 653a 0a20  xtreme_volume:. 
-00071db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00071dc0: 2020 2020 2020 2065 7874 7265 6d65 5f76         extreme_v
-00071dd0: 6f6c 756d 6520 3d20 766f 6c75 6d65 0a20  olume = volume. 
-00071de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00071df0: 2020 2020 2020 2073 656c 6563 7465 645f         selected_
-00071e00: 696d 6167 655f 7061 7468 203d 2070 6174  image_path = pat
-00071e10: 680a 0a20 2020 2020 2020 2020 2020 2065  h..            e
-00071e20: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-00071e30: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-00071e40: 2020 2020 2020 7072 696e 7428 6622 4572        print(f"Er
-00071e50: 726f 7220 7072 6f63 6573 7369 6e67 2069  ror processing i
-00071e60: 6d61 6765 207b 7061 7468 7d3a 207b 657d  mage {path}: {e}
-00071e70: 2229 0a0a 2020 2020 656c 6966 2063 7269  ")..    elif cri
-00071e80: 7465 7269 6120 3d3d 2027 6272 6967 6874  teria == 'bright
-00071e90: 6573 7427 3a0a 2020 2020 2020 2020 6d61  est':.        ma
-00071ea0: 785f 6272 6967 6874 6e65 7373 203d 204e  x_brightness = N
-00071eb0: 6f6e 650a 0a20 2020 2020 2020 2066 6f72  one..        for
-00071ec0: 2070 6174 6820 696e 2069 6d61 6765 5f70   path in image_p
-00071ed0: 6174 6873 3a0a 2020 2020 2020 2020 2020  aths:.          
-00071ee0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00071ef0: 2020 2020 2020 2069 6d61 6765 203d 2061         image = a
-00071f00: 6e74 732e 696d 6167 655f 7265 6164 2870  nts.image_read(p
-00071f10: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-00071f20: 2020 2020 2062 7269 6768 746e 6573 7320       brightness 
-00071f30: 3d20 6e70 2e6d 6561 6e28 696d 6167 652e  = np.mean(image.
-00071f40: 6e75 6d70 7928 2929 0a0a 2020 2020 2020  numpy())..      
-00071f50: 2020 2020 2020 2020 2020 6966 206d 6178            if max
-00071f60: 5f62 7269 6768 746e 6573 7320 6973 204e  _brightness is N
-00071f70: 6f6e 6520 6f72 2062 7269 6768 746e 6573  one or brightnes
-00071f80: 7320 3e20 6d61 785f 6272 6967 6874 6e65  s > max_brightne
-00071f90: 7373 3a0a 2020 2020 2020 2020 2020 2020  ss:.            
-00071fa0: 2020 2020 2020 2020 6d61 785f 6272 6967          max_brig
-00071fb0: 6874 6e65 7373 203d 2062 7269 6768 746e  htness = brightn
-00071fc0: 6573 730a 2020 2020 2020 2020 2020 2020  ess.            
-00071fd0: 2020 2020 2020 2020 7365 6c65 6374 6564          selected
-00071fe0: 5f69 6d61 6765 5f70 6174 6820 3d20 7061  _image_path = pa
-00071ff0: 7468 0a0a 2020 2020 2020 2020 2020 2020  th..            
-00072000: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00072010: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-00072020: 2020 2020 2020 2070 7269 6e74 2866 2245         print(f"E
-00072030: 7272 6f72 2070 726f 6365 7373 696e 6720  rror processing 
-00072040: 696d 6167 6520 7b70 6174 687d 3a20 7b65  image {path}: {e
-00072050: 7d22 290a 0a20 2020 2065 6c73 653a 0a20  }")..    else:. 
-00072060: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00072070: 7565 4572 726f 7228 2243 7269 7465 7269  ueError("Criteri
-00072080: 6120 6d75 7374 2062 6520 2773 6d61 6c6c  a must be 'small
-00072090: 6573 7427 2c20 276c 6172 6765 7374 272c  est', 'largest',
-000720a0: 206f 7220 2762 7269 6768 7465 7374 272e   or 'brightest'.
-000720b0: 2229 0a0a 2020 2020 7265 7475 726e 2073  ")..    return s
-000720c0: 656c 6563 7465 645f 696d 6167 655f 7061  elected_image_pa
-000720d0: 7468 0a0a 0a0a 6465 6620 6d6d 5f6d 6174  th....def mm_mat
-000720e0: 6368 5f62 795f 7163 5f73 636f 7269 6e67  ch_by_qc_scoring
-000720f0: 2864 665f 612c 2064 665f 622c 206d 6174  (df_a, df_b, mat
-00072100: 6368 5f63 6f6c 756d 6e2c 2063 7269 7465  ch_column, crite
-00072110: 7269 612c 2070 7265 6669 783d 276d 6174  ria, prefix='mat
-00072120: 6368 6564 5f27 2c20 6578 636c 7564 655f  ched_', exclude_
-00072130: 636f 6c75 6d6e 733d 4e6f 6e65 293a 0a20  columns=None):. 
-00072140: 2020 2022 2222 0a20 2020 204d 6174 6368     """.    Match
-00072150: 2065 6163 6820 726f 7720 696e 2064 665f   each row in df_
-00072160: 6120 746f 2061 2072 6f77 2069 6e20 6466  a to a row in df
-00072170: 5f62 2062 6173 6564 206f 6e20 6120 6d61  _b based on a ma
-00072180: 7463 6869 6e67 2063 6f6c 756d 6e20 616e  tching column an
-00072190: 6420 6372 6974 6572 6961 2066 6f72 2073  d criteria for s
-000721a0: 656c 6563 7469 6e67 2074 6865 2062 6573  electing the bes
-000721b0: 7420 6d61 7463 682c 0a20 2020 2077 6974  t match,.    wit
-000721c0: 6820 6f70 7469 6f6e 7320 746f 2070 7265  h options to pre
-000721d0: 6669 7820 636f 6c75 6d6e 206e 616d 6573  fix column names
-000721e0: 2066 726f 6d20 6466 5f62 2061 6e64 2065   from df_b and e
-000721f0: 7863 6c75 6465 2063 6572 7461 696e 2063  xclude certain c
-00072200: 6f6c 756d 6e73 2066 726f 6d20 7468 6520  olumns from the 
-00072210: 6669 6e61 6c20 6f75 7470 7574 2e20 4164  final output. Ad
-00072220: 6469 7469 6f6e 616c 6c79 2c0a 2020 2020  ditionally,.    
-00072230: 7265 7475 726e 7320 6120 4461 7461 4672  returns a DataFr
-00072240: 616d 6520 636f 6e74 6169 6e69 6e67 2072  ame containing r
-00072250: 6f77 7320 6672 6f6d 2064 665f 6220 7468  ows from df_b th
-00072260: 6174 2077 6572 6520 6e6f 7420 6d61 7463  at were not matc
-00072270: 6865 6420 746f 2061 6e79 2072 6f77 2069  hed to any row i
-00072280: 6e20 6466 5f61 2e0a 0a20 2020 2050 6172  n df_a...    Par
-00072290: 616d 6574 6572 733a 0a20 2020 202d 2064  ameters:.    - d
-000722a0: 665f 613a 2044 6174 6146 7261 6d65 2041  f_a: DataFrame A
-000722b0: 2e0a 2020 2020 2d20 6466 5f62 3a20 4461  ..    - df_b: Da
-000722c0: 7461 4672 616d 6520 422e 0a20 2020 202d  taFrame B..    -
-000722d0: 206d 6174 6368 5f63 6f6c 756d 6e3a 2054   match_column: T
-000722e0: 6865 2063 6f6c 756d 6e20 6e61 6d65 206f  he column name o
-000722f0: 6e20 7768 6963 6820 726f 7773 2073 686f  n which rows sho
-00072300: 756c 6420 6d61 7463 6820 6265 7477 6565  uld match betwee
-00072310: 6e20 4461 7461 4672 616d 6520 4120 616e  n DataFrame A an
-00072320: 6420 422e 0a20 2020 202d 2063 7269 7465  d B..    - crite
-00072330: 7269 613a 2041 2064 6963 7469 6f6e 6172  ria: A dictionar
-00072340: 7920 7768 6572 6520 6b65 7973 2061 7265  y where keys are
-00072350: 2063 6f6c 756d 6e20 6e61 6d65 7320 616e   column names an
-00072360: 6420 7661 6c75 6573 2061 7265 2027 6d69  d values are 'mi
-00072370: 6e27 206f 7220 276d 6178 272c 2069 6e64  n' or 'max', ind
-00072380: 6963 6174 696e 6720 7768 6574 6865 720a  icating whether.
-00072390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000723a0: 7468 6520 636f 6c75 6d6e 2073 686f 756c  the column shoul
-000723b0: 6420 6265 206d 696e 696d 697a 6564 206f  d be minimized o
-000723c0: 7220 6d61 7869 6d69 7a65 6420 666f 7220  r maximized for 
-000723d0: 7468 6520 6265 7374 206d 6174 6368 2e0a  the best match..
-000723e0: 2020 2020 2d20 7072 6566 6978 3a20 4120      - prefix: A 
-000723f0: 7374 7269 6e67 2070 7265 6669 7820 746f  string prefix to
-00072400: 2061 6464 2074 6f20 636f 6c75 6d6e 206e   add to column n
-00072410: 616d 6573 2066 726f 6d20 6466 5f62 2069  ames from df_b i
-00072420: 6e20 7468 6520 6669 6e61 6c20 6f75 7470  n the final outp
-00072430: 7574 2074 6f20 6176 6f69 6420 6475 706c  ut to avoid dupl
-00072440: 6963 6174 696f 6e2e 0a20 2020 202d 2065  ication..    - e
-00072450: 7863 6c75 6465 5f63 6f6c 756d 6e73 3a20  xclude_columns: 
-00072460: 4120 6c69 7374 206f 6620 636f 6c75 6d6e  A list of column
-00072470: 206e 616d 6573 2066 726f 6d20 6466 5f62   names from df_b
-00072480: 2074 6f20 6578 636c 7564 6520 6672 6f6d   to exclude from
-00072490: 2074 6865 2066 696e 616c 206f 7574 7075   the final outpu
-000724a0: 742e 0a20 2020 200a 2020 2020 5265 7475  t..    .    Retu
-000724b0: 726e 733a 0a20 2020 202d 2041 2074 7570  rns:.    - A tup
-000724c0: 6c65 206f 6620 7477 6f20 4461 7461 4672  le of two DataFr
-000724d0: 616d 6573 3a20 0a20 2020 2020 2020 2031  ames: .        1
-000724e0: 2e20 4120 6e65 7720 4461 7461 4672 616d  . A new DataFram
-000724f0: 6520 636f 6d62 696e 696e 6720 6466 5f61  e combining df_a
-00072500: 2077 6974 6820 6d61 7463 6865 6420 726f   with matched ro
-00072510: 7773 2066 726f 6d20 6466 5f62 2e0a 2020  ws from df_b..  
-00072520: 2020 2020 2020 322e 2041 2044 6174 6146        2. A DataF
-00072530: 7261 6d65 2063 6f6e 7461 696e 696e 6720  rame containing 
-00072540: 726f 7773 2066 726f 6d20 6466 5f62 2074  rows from df_b t
-00072550: 6861 7420 7765 7265 206e 6f74 206d 6174  hat were not mat
-00072560: 6368 6564 2074 6f20 6466 5f61 2e0a 2020  ched to df_a..  
-00072570: 2020 2222 220a 2020 2020 6672 6f6d 2073    """.    from s
-00072580: 6369 7079 2e73 7461 7473 2069 6d70 6f72  cipy.stats impor
-00072590: 7420 7a73 636f 7265 0a20 2020 2064 665f  t zscore.    df_
-000725a0: 6120 3d20 6466 5f61 2e6c 6f63 5b3a 2c20  a = df_a.loc[:, 
-000725b0: 7e64 665f 612e 636f 6c75 6d6e 732e 7374  ~df_a.columns.st
-000725c0: 722e 7374 6172 7473 7769 7468 2827 556e  r.startswith('Un
-000725d0: 6e61 6d65 643a 2729 5d2e 636f 7079 2829  named:')].copy()
-000725e0: 0a20 2020 2069 6620 6466 5f62 2069 7320  .    if df_b is 
-000725f0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00072600: 2020 6466 5f62 203d 2064 665f 622e 6c6f    df_b = df_b.lo
-00072610: 635b 3a2c 207e 6466 5f62 2e63 6f6c 756d  c[:, ~df_b.colum
-00072620: 6e73 2e73 7472 2e73 7461 7274 7377 6974  ns.str.startswit
-00072630: 6828 2755 6e6e 616d 6564 3a27 295d 2e63  h('Unnamed:')].c
-00072640: 6f70 7928 290a 2020 2020 656c 7365 3a0a  opy().    else:.
-00072650: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-00072660: 665f 612c 2070 642e 4461 7461 4672 616d  f_a, pd.DataFram
-00072670: 6528 290a 2020 2020 0a20 2020 2023 204e  e().    .    # N
-00072680: 6f72 6d61 6c69 7a65 2064 665f 6220 6261  ormalize df_b ba
-00072690: 7365 6420 6f6e 2063 7269 7465 7269 610a  sed on criteria.
-000726a0: 2020 2020 666f 7220 636f 6c2c 2063 7269      for col, cri
-000726b0: 7420 696e 2063 7269 7465 7269 612e 6974  t in criteria.it
-000726c0: 656d 7328 293a 0a20 2020 2020 2020 2069  ems():.        i
-000726d0: 6620 6372 6974 203d 3d20 276d 6178 273a  f crit == 'max':
-000726e0: 0a20 2020 2020 2020 2020 2020 2064 665f  .            df_
-000726f0: 622e 6c6f 635b 6466 5f62 2e69 6e64 6578  b.loc[df_b.index
-00072700: 2c20 6627 7363 6f72 655f 7b63 6f6c 7d27  , f'score_{col}'
-00072710: 5d20 3d20 7a73 636f 7265 282d 6466 5f62  ] = zscore(-df_b
-00072720: 5b63 6f6c 5d29 0a20 2020 2020 2020 2065  [col]).        e
-00072730: 6c69 6620 6372 6974 203d 3d20 276d 696e  lif crit == 'min
-00072740: 273a 0a20 2020 2020 2020 2020 2020 2064  ':.            d
-00072750: 665f 622e 6c6f 635b 6466 5f62 2e69 6e64  f_b.loc[df_b.ind
-00072760: 6578 2c20 6627 7363 6f72 655f 7b63 6f6c  ex, f'score_{col
-00072770: 7d27 5d20 3d20 7a73 636f 7265 2864 665f  }'] = zscore(df_
-00072780: 625b 636f 6c5d 290a 0a20 2020 2023 2043  b[col])..    # C
-00072790: 616c 6375 6c61 7465 2027 6265 7374 5f73  alculate 'best_s
-000727a0: 636f 7265 2720 6279 2073 756d 6d69 6e67  core' by summing
-000727b0: 2061 6c6c 2073 636f 7265 2063 6f6c 756d   all score colum
-000727c0: 6e73 0a20 2020 2073 636f 7265 5f63 6f6c  ns.    score_col
-000727d0: 756d 6e73 203d 205b 6627 7363 6f72 655f  umns = [f'score_
-000727e0: 7b63 6f6c 7d27 2066 6f72 2063 6f6c 2069  {col}' for col i
-000727f0: 6e20 6372 6974 6572 6961 2e6b 6579 7328  n criteria.keys(
-00072800: 295d 0a20 2020 2064 665f 625b 2762 6573  )].    df_b['bes
-00072810: 745f 7363 6f72 6527 5d20 3d20 6466 5f62  t_score'] = df_b
-00072820: 5b73 636f 7265 5f63 6f6c 756d 6e73 5d2e  [score_columns].
-00072830: 7375 6d28 6178 6973 3d31 290a 0a20 2020  sum(axis=1)..   
-00072840: 206d 6174 6368 6564 5f69 6e64 6963 6573   matched_indices
-00072850: 203d 205b 5d20 2023 2054 7261 636b 2069   = []  # Track i
-00072860: 6e64 6963 6573 206f 6620 6d61 7463 6865  ndices of matche
-00072870: 6420 726f 7773 2069 6e20 6466 5f62 0a0a  d rows in df_b..
-00072880: 2020 2020 2320 4d61 7463 6820 726f 7773      # Match rows
-00072890: 0a20 2020 206d 6174 6368 6564 5f72 6f77  .    matched_row
-000728a0: 7320 3d20 5b5d 0a20 2020 2066 6f72 205f  s = [].    for _
-000728b0: 2c20 726f 775f 6120 696e 2064 665f 612e  , row_a in df_a.
-000728c0: 6974 6572 726f 7773 2829 3a0a 2020 2020  iterrows():.    
-000728d0: 2020 2020 6d61 7463 6865 7320 3d20 6466      matches = df
-000728e0: 5f62 5b64 665f 625b 6d61 7463 685f 636f  _b[df_b[match_co
-000728f0: 6c75 6d6e 5d20 3d3d 2072 6f77 5f61 5b6d  lumn] == row_a[m
-00072900: 6174 6368 5f63 6f6c 756d 6e5d 5d0a 2020  atch_column]].  
-00072910: 2020 2020 2020 6966 206e 6f74 206d 6174        if not mat
-00072920: 6368 6573 2e65 6d70 7479 3a0a 2020 2020  ches.empty:.    
-00072930: 2020 2020 2020 2020 6265 7374 5f69 6478          best_idx
-00072940: 203d 206d 6174 6368 6573 5b27 6265 7374   = matches['best
-00072950: 5f73 636f 7265 275d 2e69 6478 6d69 6e28  _score'].idxmin(
-00072960: 290a 2020 2020 2020 2020 2020 2020 6265  ).            be
-00072970: 7374 5f6d 6174 6368 203d 206d 6174 6368  st_match = match
-00072980: 6573 2e6c 6f63 5b62 6573 745f 6964 785d  es.loc[best_idx]
-00072990: 0a20 2020 2020 2020 2020 2020 206d 6174  .            mat
-000729a0: 6368 6564 5f69 6e64 6963 6573 2e61 7070  ched_indices.app
-000729b0: 656e 6428 6265 7374 5f69 6478 2920 2023  end(best_idx)  #
-000729c0: 2054 7261 636b 2074 6869 7320 696e 6465   Track this inde
-000729d0: 7820 6173 206d 6174 6368 6564 0a20 2020  x as matched.   
-000729e0: 2020 2020 2020 2020 206d 6174 6368 6564           matched
-000729f0: 5f72 6f77 732e 6170 7065 6e64 2862 6573  _rows.append(bes
-00072a00: 745f 6d61 7463 6829 0a20 2020 2020 2020  t_match).       
-00072a10: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00072a20: 2020 206d 6174 6368 6564 5f72 6f77 732e     matched_rows.
-00072a30: 6170 7065 6e64 2870 642e 5365 7269 6573  append(pd.Series
-00072a40: 2864 7479 7065 3d27 666c 6f61 7436 3427  (dtype='float64'
-00072a50: 2929 0a0a 2020 2020 2320 4372 6561 7465  ))..    # Create
-00072a60: 2061 2044 6174 6146 7261 6d65 2066 726f   a DataFrame fro
-00072a70: 6d20 6d61 7463 6865 6420 726f 7773 0a20  m matched rows. 
-00072a80: 2020 2064 665f 6d61 7463 6865 6420 3d20     df_matched = 
-00072a90: 7064 2e44 6174 6146 7261 6d65 286d 6174  pd.DataFrame(mat
-00072aa0: 6368 6564 5f72 6f77 7329 2e72 6573 6574  ched_rows).reset
-00072ab0: 5f69 6e64 6578 2864 726f 703d 5472 7565  _index(drop=True
-00072ac0: 290a 2020 2020 0a20 2020 2023 2045 7863  ).    .    # Exc
-00072ad0: 6c75 6465 2073 7065 6369 6669 6564 2063  lude specified c
-00072ae0: 6f6c 756d 6e73 2061 6e64 2061 6464 2070  olumns and add p
-00072af0: 7265 6669 780a 2020 2020 6966 2065 7863  refix.    if exc
-00072b00: 6c75 6465 5f63 6f6c 756d 6e73 2069 7320  lude_columns is 
-00072b10: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00072b20: 2020 6466 5f6d 6174 6368 6564 203d 2064    df_matched = d
-00072b30: 665f 6d61 7463 6865 642e 6472 6f70 2863  f_matched.drop(c
-00072b40: 6f6c 756d 6e73 3d65 7863 6c75 6465 5f63  olumns=exclude_c
-00072b50: 6f6c 756d 6e73 2c20 6572 726f 7273 3d27  olumns, errors='
-00072b60: 6967 6e6f 7265 2729 0a20 2020 2064 665f  ignore').    df_
-00072b70: 6d61 7463 6865 6420 3d20 6466 5f6d 6174  matched = df_mat
-00072b80: 6368 6564 2e72 656e 616d 6528 636f 6c75  ched.rename(colu
-00072b90: 6d6e 733d 6c61 6d62 6461 2078 3a20 6622  mns=lambda x: f"
-00072ba0: 7b70 7265 6669 787d 7b78 7d22 2069 6620  {prefix}{x}" if 
-00072bb0: 7820 213d 206d 6174 6368 5f63 6f6c 756d  x != match_colum
-00072bc0: 6e20 616e 6420 7820 696e 2064 665f 6d61  n and x in df_ma
-00072bd0: 7463 6865 642e 636f 6c75 6d6e 7320 656c  tched.columns el
-00072be0: 7365 2078 290a 0a20 2020 2023 2043 6f6d  se x)..    # Com
-00072bf0: 6269 6e65 2064 665f 6120 7769 7468 206d  bine df_a with m
-00072c00: 6174 6368 6564 2072 6f77 7320 6672 6f6d  atched rows from
-00072c10: 2064 665f 620a 2020 2020 7265 7375 6c74   df_b.    result
-00072c20: 5f64 6620 3d20 7064 2e63 6f6e 6361 7428  _df = pd.concat(
-00072c30: 5b64 665f 612e 7265 7365 745f 696e 6465  [df_a.reset_inde
-00072c40: 7828 6472 6f70 3d54 7275 6529 2c20 6466  x(drop=True), df
-00072c50: 5f6d 6174 6368 6564 5d2c 2061 7869 733d  _matched], axis=
-00072c60: 3129 0a20 2020 200a 2020 2020 2320 4578  1).    .    # Ex
-00072c70: 7472 6163 7420 756e 6d61 7463 6865 6420  tract unmatched 
-00072c80: 726f 7773 2066 726f 6d20 6466 5f62 0a20  rows from df_b. 
-00072c90: 2020 2075 6e6d 6174 6368 6564 5f64 665f     unmatched_df_
-00072ca0: 6220 3d20 6466 5f62 2e64 726f 7028 696e  b = df_b.drop(in
-00072cb0: 6465 783d 6d61 7463 6865 645f 696e 6469  dex=matched_indi
-00072cc0: 6365 7329 2e72 6573 6574 5f69 6e64 6578  ces).reset_index
-00072cd0: 2864 726f 703d 5472 7565 290a 0a20 2020  (drop=True)..   
-00072ce0: 2072 6574 7572 6e20 7265 7375 6c74 5f64   return result_d
-00072cf0: 662c 2075 6e6d 6174 6368 6564 5f64 665f  f, unmatched_df_
-00072d00: 620a 0a0a 6465 6620 6669 785f 4c52 5f52  b...def fix_LR_R
-00072d10: 4c5f 7374 7566 6628 6466 2c20 636f 6c31  L_stuff(df, col1
-00072d20: 2c20 636f 6c32 2c20 7369 7a65 5f63 6f6c  , col2, size_col
-00072d30: 312c 2073 697a 655f 636f 6c32 2c20 6964  1, size_col2, id
-00072d40: 312c 2069 6432 2029 3a0a 2020 2020 6466  1, id2 ):.    df
-00072d50: 5f63 6f70 7920 3d20 6466 2e63 6f70 7928  _copy = df.copy(
-00072d60: 290a 2020 2020 2320 456e 7375 7265 2063  ).    # Ensure c
-00072d70: 6f6c 756d 6e73 2063 6f6e 7461 696e 2073  olumns contain s
-00072d80: 7472 696e 6773 2066 6f72 2073 7562 7374  trings for subst
-00072d90: 7269 6e67 2063 6865 636b 730a 2020 2020  ring checks.    
-00072da0: 6466 5f63 6f70 795b 636f 6c31 5d20 3d20  df_copy[col1] = 
-00072db0: 6466 5f63 6f70 795b 636f 6c31 5d2e 6173  df_copy[col1].as
-00072dc0: 7479 7065 2873 7472 290a 2020 2020 6466  type(str).    df
-00072dd0: 5f63 6f70 795b 636f 6c32 5d20 3d20 6466  _copy[col2] = df
-00072de0: 5f63 6f70 795b 636f 6c32 5d2e 6173 7479  _copy[col2].asty
-00072df0: 7065 2873 7472 290a 2020 2020 6466 5f63  pe(str).    df_c
-00072e00: 6f70 795b 6964 315d 203d 2064 665f 636f  opy[id1] = df_co
-00072e10: 7079 5b69 6431 5d2e 6173 7479 7065 2873  py[id1].astype(s
-00072e20: 7472 290a 2020 2020 6466 5f63 6f70 795b  tr).    df_copy[
-00072e30: 6964 325d 203d 2064 665f 636f 7079 5b69  id2] = df_copy[i
-00072e40: 6432 5d2e 6173 7479 7065 2873 7472 290a  d2].astype(str).
-00072e50: 2020 2020 0a20 2020 2066 6f72 2069 6e64      .    for ind
-00072e60: 6578 2c20 726f 7720 696e 2064 665f 636f  ex, row in df_co
-00072e70: 7079 2e69 7465 7272 6f77 7328 293a 0a20  py.iterrows():. 
-00072e80: 2020 2020 2020 2063 6f6c 315f 7661 6c20         col1_val 
-00072e90: 3d20 726f 775b 636f 6c31 5d0a 2020 2020  = row[col1].    
-00072ea0: 2020 2020 636f 6c32 5f76 616c 203d 2072      col2_val = r
-00072eb0: 6f77 5b63 6f6c 325d 0a20 2020 2020 2020  ow[col2].       
-00072ec0: 2073 697a 6531 203d 2072 6f77 5b73 697a   size1 = row[siz
-00072ed0: 655f 636f 6c31 5d0a 2020 2020 2020 2020  e_col1].        
-00072ee0: 7369 7a65 3220 3d20 726f 775b 7369 7a65  size2 = row[size
-00072ef0: 5f63 6f6c 325d 0a20 2020 2020 2020 200a  _col2].        .
-00072f00: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
-00072f10: 666f 7220 2752 4c27 206f 7220 274c 5227  for 'RL' or 'LR'
-00072f20: 2069 6e20 6561 6368 2063 6f6c 756d 6e20   in each column 
-00072f30: 616e 6420 636f 6d70 6172 6520 7369 7a65  and compare size
-00072f40: 730a 2020 2020 2020 2020 6966 2028 2752  s.        if ('R
-00072f50: 4c27 2069 6e20 636f 6c31 5f76 616c 206f  L' in col1_val o
-00072f60: 7220 274c 5227 2069 6e20 636f 6c31 5f76  r 'LR' in col1_v
-00072f70: 616c 2920 616e 6420 2827 524c 2720 696e  al) and ('RL' in
-00072f80: 2063 6f6c 325f 7661 6c20 6f72 2027 4c52   col2_val or 'LR
-00072f90: 2720 696e 2063 6f6c 325f 7661 6c29 3a0a  ' in col2_val):.
-00072fa0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00072fb0: 696e 7565 0a20 2020 2020 2020 2065 6c69  inue.        eli
-00072fc0: 6620 2752 4c27 206e 6f74 2069 6e20 636f  f 'RL' not in co
-00072fd0: 6c31 5f76 616c 2061 6e64 2027 4c52 2720  l1_val and 'LR' 
-00072fe0: 6e6f 7420 696e 2063 6f6c 315f 7661 6c20  not in col1_val 
-00072ff0: 616e 6420 2752 4c27 206e 6f74 2069 6e20  and 'RL' not in 
-00073000: 636f 6c32 5f76 616c 2061 6e64 2027 4c52  col2_val and 'LR
-00073010: 2720 6e6f 7420 696e 2063 6f6c 325f 7661  ' not in col2_va
-00073020: 6c3a 0a20 2020 2020 2020 2020 2020 2069  l:.            i
-00073030: 6620 7369 7a65 3120 3c20 7369 7a65 323a  f size1 < size2:
-00073040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00073050: 2064 665f 636f 7079 2e61 745b 696e 6465   df_copy.at[inde
-00073060: 782c 2063 6f6c 315d 203d 2064 665f 636f  x, col1] = df_co
-00073070: 7079 2e61 745b 696e 6465 782c 2063 6f6c  py.at[index, col
-00073080: 325d 0a20 2020 2020 2020 2020 2020 2020  2].             
-00073090: 2020 2064 665f 636f 7079 2e61 745b 696e     df_copy.at[in
-000730a0: 6465 782c 2073 697a 655f 636f 6c31 5d20  dex, size_col1] 
-000730b0: 3d20 6466 5f63 6f70 792e 6174 5b69 6e64  = df_copy.at[ind
-000730c0: 6578 2c20 7369 7a65 5f63 6f6c 325d 0a20  ex, size_col2]. 
-000730d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000730e0: 665f 636f 7079 2e61 745b 696e 6465 782c  f_copy.at[index,
-000730f0: 2069 6431 5d20 3d20 6466 5f63 6f70 792e   id1] = df_copy.
-00073100: 6174 5b69 6e64 6578 2c20 6964 325d 0a20  at[index, id2]. 
-00073110: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00073120: 665f 636f 7079 2e61 745b 696e 6465 782c  f_copy.at[index,
-00073130: 2073 697a 655f 636f 6c32 5d20 3d20 300a   size_col2] = 0.
-00073140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073150: 6466 5f63 6f70 792e 6174 5b69 6e64 6578  df_copy.at[index
-00073160: 2c20 636f 6c32 5d20 3d20 4e6f 6e65 0a20  , col2] = None. 
+0005c940: 2020 2020 206a 6d6d 2e6c 6f63 5b6b 2c20       jmm.loc[k, 
+0005c950: 6474 305b 313a 5d5d 203d 206e 616e 4c69  dt0[1:]] = nanLi
+0005c960: 7374 202a 206c 656e 2876 3129 0a20 2020  st * len(v1).   
+0005c970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005c980: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+0005c990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005c9a0: 2020 2020 2070 7269 6e74 2820 6a6f 696e       print( join
+0005c9b0: 4469 6167 6e6f 7374 6963 734c 6f63 2029  DiagnosticsLoc )
+0005c9c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005c9d0: 2020 2020 206a 6f69 6e44 6961 676e 6f73       joinDiagnos
+0005c9e0: 7469 6373 203d 2070 642e 636f 6e63 6174  tics = pd.concat
+0005c9f0: 2820 5b6a 6f69 6e44 6961 676e 6f73 7469  ( [joinDiagnosti
+0005ca00: 6373 2c20 6a6f 696e 4469 6167 6e6f 7374  cs, joinDiagnost
+0005ca10: 6963 734c 6f63 5d2c 2061 7869 733d 302c  icsLoc], axis=0,
+0005ca20: 2069 676e 6f72 655f 696e 6465 783d 4661   ignore_index=Fa
+0005ca30: 6c73 6520 290a 0a20 2020 2069 6620 7665  lse )..    if ve
+0005ca40: 7262 6f73 653a 0a20 2020 2020 2020 2070  rbose:.        p
+0005ca50: 7269 6e74 2822 646f 2044 5449 2229 0a20  rint("do DTI"). 
+0005ca60: 2020 2023 2068 6572 6520 2d20 7765 2066     # here - we f
+0005ca70: 6972 7374 2068 6176 6520 746f 2061 7665  irst have to ave
+0005ca80: 7261 6765 2077 6974 6869 6e20 6561 6368  rage within each
+0005ca90: 2072 6f77 0a20 2020 2064 7430 203d 2067   row.    dt0 = g
+0005caa0: 6574 5f6e 616d 6573 5f66 726f 6d5f 6461  et_names_from_da
+0005cab0: 7461 5f66 7261 6d65 285b 2244 5449 225d  ta_frame(["DTI"]
+0005cac0: 2c20 6a6d 6d2c 2065 7863 6c75 7369 6f6e  , jmm, exclusion
+0005cad0: 733d 5b22 556e 6e61 6d65 6422 2c20 2244  s=["Unnamed", "D
+0005cae0: 5449 5f4c 5222 2c20 2244 5449 5f52 4c22  TI_LR", "DTI_RL"
+0005caf0: 5d29 0a20 2020 2064 7431 203d 2067 6574  ]).    dt1 = get
+0005cb00: 5f6e 616d 6573 5f66 726f 6d5f 6461 7461  _names_from_data
+0005cb10: 5f66 7261 6d65 285b 2244 5449 5f4c 5222  _frame(["DTI_LR"
+0005cb20: 5d2c 206a 6d6d 2c20 6578 636c 7573 696f  ], jmm, exclusio
+0005cb30: 6e73 3d5b 2255 6e6e 616d 6564 225d 290a  ns=["Unnamed"]).
+0005cb40: 2020 2020 6474 3220 3d20 6765 745f 6e61      dt2 = get_na
+0005cb50: 6d65 735f 6672 6f6d 5f64 6174 615f 6672  mes_from_data_fr
+0005cb60: 616d 6528 205b 2244 5449 5f52 4c22 5d2c  ame( ["DTI_RL"],
+0005cb70: 206a 6d6d 2c20 6578 636c 7573 696f 6e73   jmm, exclusions
+0005cb80: 3d5b 2255 6e6e 616d 6564 225d 290a 2020  =["Unnamed"]).  
+0005cb90: 2020 666c 6964 203d 2064 7430 5b30 5d0a    flid = dt0[0].
+0005cba0: 2020 2020 7772 6f77 7320 3d20 5b5d 0a20      wrows = []. 
+0005cbb0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+0005cbc0: 6528 6a6d 6d2e 7368 6170 655b 305d 293a  e(jmm.shape[0]):
+0005cbd0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0005cbe0: 7064 2e69 736e 6128 6a6d 6d5b 6474 305b  pd.isna(jmm[dt0[
+0005cbf0: 315d 5d5b 695d 2920 6f72 206e 6f74 2070  1]][i]) or not p
+0005cc00: 642e 6973 6e61 286a 6d6d 5b64 7431 5b31  d.isna(jmm[dt1[1
+0005cc10: 5d5d 5b69 5d29 206f 7220 6e6f 7420 7064  ]][i]) or not pd
+0005cc20: 2e69 736e 6128 6a6d 6d5b 6474 325b 315d  .isna(jmm[dt2[1]
+0005cc30: 5d5b 695d 293a 0a20 2020 2020 2020 2020  ][i]):.         
+0005cc40: 2020 2077 726f 7773 2e61 7070 656e 6428     wrows.append(
+0005cc50: 6929 0a20 2020 2066 6f72 206b 2069 6e20  i).    for k in 
+0005cc60: 7772 6f77 733a 0a20 2020 2020 2020 2076  wrows:.        v
+0005cc70: 3120 3d20 6a6d 6d2e 6c6f 635b 6b2c 2064  1 = jmm.loc[k, d
+0005cc80: 7430 5b31 3a5d 5d2e 6173 7479 7065 2866  t0[1:]].astype(f
+0005cc90: 6c6f 6174 290a 2020 2020 2020 2020 7632  loat).        v2
+0005cca0: 203d 206a 6d6d 2e6c 6f63 5b6b 2c20 6474   = jmm.loc[k, dt
+0005ccb0: 315b 313a 5d5d 2e61 7374 7970 6528 666c  1[1:]].astype(fl
+0005ccc0: 6f61 7429 0a20 2020 2020 2020 2076 3320  oat).        v3 
+0005ccd0: 3d20 6a6d 6d2e 6c6f 635b 6b2c 2064 7432  = jmm.loc[k, dt2
+0005cce0: 5b31 3a5d 5d2e 6173 7479 7065 2866 6c6f  [1:]].astype(flo
+0005ccf0: 6174 290a 2020 2020 2020 2020 6368 6563  at).        chec
+0005cd00: 6b63 6f6c 203d 2064 7430 5b35 5d0a 2020  kcol = dt0[5].  
+0005cd10: 2020 2020 2020 6966 206e 6f74 206e 702e        if not np.
+0005cd20: 6973 6e61 6e28 7631 5b63 6865 636b 636f  isnan(v1[checkco
+0005cd30: 6c5d 293a 0a20 2020 2020 2020 2020 2020  l]):.           
+0005cd40: 2069 6620 7631 5b63 6865 636b 636f 6c5d   if v1[checkcol]
+0005cd50: 203c 2030 2e32 353a 0a20 2020 2020 2020   < 0.25:.       
+0005cd60: 2020 2020 2020 2020 2076 312e 7265 706c           v1.repl
+0005cd70: 6163 6528 6e70 2e6e 616e 2c20 696e 706c  ace(np.nan, inpl
+0005cd80: 6163 653d 5472 7565 290a 2020 2020 2020  ace=True).      
+0005cd90: 2020 6368 6563 6b63 6f6c 203d 2064 7431    checkcol = dt1
+0005cda0: 5b35 5d0a 2020 2020 2020 2020 6966 206e  [5].        if n
+0005cdb0: 6f74 206e 702e 6973 6e61 6e28 7632 5b63  ot np.isnan(v2[c
+0005cdc0: 6865 636b 636f 6c5d 293a 0a20 2020 2020  heckcol]):.     
+0005cdd0: 2020 2020 2020 2069 6620 7632 5b63 6865         if v2[che
+0005cde0: 636b 636f 6c5d 203c 2030 2e32 353a 0a20  ckcol] < 0.25:. 
+0005cdf0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0005ce00: 322e 7265 706c 6163 6528 6e70 2e6e 616e  2.replace(np.nan
+0005ce10: 2c20 696e 706c 6163 653d 5472 7565 290a  , inplace=True).
+0005ce20: 2020 2020 2020 2020 6368 6563 6b63 6f6c          checkcol
+0005ce30: 203d 2064 7432 5b35 5d0a 2020 2020 2020   = dt2[5].      
+0005ce40: 2020 6966 206e 6f74 206e 702e 6973 6e61    if not np.isna
+0005ce50: 6e28 7633 5b63 6865 636b 636f 6c5d 293a  n(v3[checkcol]):
+0005ce60: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0005ce70: 7633 5b63 6865 636b 636f 6c5d 203c 2030  v3[checkcol] < 0
+0005ce80: 2e32 353a 0a20 2020 2020 2020 2020 2020  .25:.           
+0005ce90: 2020 2020 2076 332e 7265 706c 6163 6528       v3.replace(
+0005cea0: 6e70 2e6e 616e 2c20 696e 706c 6163 653d  np.nan, inplace=
+0005ceb0: 5472 7565 290a 2020 2020 2020 2020 7676  True).        vv
+0005cec0: 6563 203d 205b 7631 5b30 5d2c 2076 325b  ec = [v1[0], v2[
+0005ced0: 305d 2c20 7633 5b30 5d5d 0a20 2020 2020  0], v3[0]].     
+0005cee0: 2020 2069 6620 616e 7928 7e6e 702e 6973     if any(~np.is
+0005cef0: 6e61 6e28 7676 6563 2929 3a0a 2020 2020  nan(vvec)):.    
+0005cf00: 2020 2020 2020 2020 6d79 6e6e 6120 3d20          mynna = 
+0005cf10: 5b69 2066 6f72 2069 2c20 7820 696e 2065  [i for i, x in e
+0005cf20: 6e75 6d65 7261 7465 2876 7665 6329 2069  numerate(vvec) i
+0005cf30: 6620 7e6e 702e 6973 6e61 6e28 7829 5d0a  f ~np.isnan(x)].
+0005cf40: 2020 2020 2020 2020 2020 2020 6a6d 6d2e              jmm.
+0005cf50: 6c6f 635b 6b2c 2064 7430 5b30 5d5d 203d  loc[k, dt0[0]] =
+0005cf60: 2027 4454 4927 0a20 2020 2020 2020 2020   'DTI'.         
+0005cf70: 2020 2069 6620 6c65 6e28 6d79 6e6e 6129     if len(mynna)
+0005cf80: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
+0005cf90: 2020 2020 2020 2069 6620 6d79 6e6e 615b         if mynna[
+0005cfa0: 305d 203d 3d20 303a 0a20 2020 2020 2020  0] == 0:.       
+0005cfb0: 2020 2020 2020 2020 2020 2020 206a 6d6d               jmm
+0005cfc0: 2e6c 6f63 5b6b 2c20 6474 305b 313a 5d5d  .loc[k, dt0[1:]]
+0005cfd0: 203d 2076 310a 2020 2020 2020 2020 2020   = v1.          
+0005cfe0: 2020 2020 2020 6966 206d 796e 6e61 5b30        if mynna[0
+0005cff0: 5d20 3d3d 2031 3a0a 2020 2020 2020 2020  ] == 1:.        
+0005d000: 2020 2020 2020 2020 2020 2020 6a6d 6d2e              jmm.
+0005d010: 6c6f 635b 6b2c 2064 7430 5b31 3a5d 5d20  loc[k, dt0[1:]] 
+0005d020: 3d20 7632 0a20 2020 2020 2020 2020 2020  = v2.           
+0005d030: 2020 2020 2069 6620 6d79 6e6e 615b 305d       if mynna[0]
+0005d040: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
+0005d050: 2020 2020 2020 2020 2020 206a 6d6d 2e6c             jmm.l
+0005d060: 6f63 5b6b 2c20 6474 305b 313a 5d5d 203d  oc[k, dt0[1:]] =
+0005d070: 2076 330a 2020 2020 2020 2020 2020 2020   v3.            
+0005d080: 656c 6966 206c 656e 286d 796e 6e61 2920  elif len(mynna) 
+0005d090: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
+0005d0a0: 2020 2020 2069 6620 6d79 6e6e 615b 305d       if mynna[0]
+0005d0b0: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+0005d0c0: 2020 2020 2020 2020 2020 206a 6d6d 2e6c             jmm.l
+0005d0d0: 6f63 5b6b 2c20 6474 305b 313a 5d5d 203d  oc[k, dt0[1:]] =
+0005d0e0: 2076 310a 2020 2020 2020 2020 2020 2020   v1.            
+0005d0f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0005d100: 2020 2020 2020 2020 2020 2020 2020 6a6f                jo
+0005d110: 696e 4469 6167 6e6f 7374 6963 734c 6f63  inDiagnosticsLoc
+0005d120: 203d 2070 642e 4461 7461 4672 616d 6528   = pd.DataFrame(
+0005d130: 2063 6f6c 756d 6e73 203d 2064 7863 6f6c   columns = dxcol
+0005d140: 732c 2069 6e64 6578 3d72 616e 6765 2831  s, index=range(1
+0005d150: 2920 290a 2020 2020 2020 2020 2020 2020  ) ).            
+0005d160: 2020 2020 2020 2020 6d79 636f 7272 203d          mycorr =
+0005d170: 206e 702e 636f 7272 636f 6566 2820 7632   np.corrcoef( v2
+0005d180: 5b30 3a64 6961 676e 6f73 7469 635f 6e5d  [0:diagnostic_n]
+0005d190: 2e76 616c 7565 732c 2076 335b 303a 6469  .values, v3[0:di
+0005d1a0: 6167 6e6f 7374 6963 5f6e 5d2e 7661 6c75  agnostic_n].valu
+0005d1b0: 6573 2029 5b30 2c31 5d0a 2020 2020 2020  es )[0,1].      
+0005d1c0: 2020 2020 2020 2020 2020 2020 2020 6d79                my
+0005d1d0: 6572 723d 6e70 2e73 7172 7428 6e70 2e6d  err=np.sqrt(np.m
+0005d1e0: 6561 6e28 2876 325b 303a 6469 6167 6e6f  ean((v2[0:diagno
+0005d1f0: 7374 6963 5f6e 5d2e 7661 6c75 6573 202d  stic_n].values -
+0005d200: 2076 335b 303a 6469 6167 6e6f 7374 6963   v3[0:diagnostic
+0005d210: 5f6e 5d2e 7661 6c75 6573 292a 2a32 2929  _n].values)**2))
+0005d220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005d230: 2020 2020 206a 6f69 6e44 6961 676e 6f73       joinDiagnos
+0005d240: 7469 6373 4c6f 632e 696c 6f63 5b30 5d20  ticsLoc.iloc[0] 
+0005d250: 3d20 5b6a 6d6d 2e6c 6f63 5b6b 2c27 755f  = [jmm.loc[k,'u_
+0005d260: 6869 6572 5f69 6427 5d2c 6d61 7468 2e6e  hier_id'],math.n
+0005d270: 616e 2c27 4454 4927 2c27 636f 6c61 7667  an,'DTI','colavg
+0005d280: 272c 6d79 636f 7272 2c6d 7965 7272 5d0a  ',mycorr,myerr].
+0005d290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005d2a0: 2020 2020 6966 206d 7963 6f72 7220 3e20      if mycorr > 
+0005d2b0: 636f 7272 5f74 6872 6573 683a 0a20 2020  corr_thresh:.   
+0005d2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005d2d0: 2020 2020 206a 6d6d 2e6c 6f63 5b6b 2c20       jmm.loc[k, 
+0005d2e0: 6474 305b 313a 5d5d 203d 2076 322e 7661  dt0[1:]] = v2.va
+0005d2f0: 6c75 6573 2a30 2e35 202b 2076 332e 7661  lues*0.5 + v3.va
+0005d300: 6c75 6573 2a30 2e35 0a20 2020 2020 2020  lues*0.5.       
+0005d310: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0005d320: 653a 2023 0a20 2020 2020 2020 2020 2020  e: #.           
+0005d330: 2020 2020 2020 2020 2020 2020 206a 6d6d               jmm
+0005d340: 2e6c 6f63 5b6b 2c20 6474 305b 313a 5d5d  .loc[k, dt0[1:]]
+0005d350: 203d 206e 616e 4c69 7374 202a 206c 656e   = nanList * len
+0005d360: 2820 6474 305b 313a 5d20 290a 2020 2020  ( dt0[1:] ).    
+0005d370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005d380: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+0005d390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005d3a0: 2020 2020 7072 696e 7428 206a 6f69 6e44      print( joinD
+0005d3b0: 6961 676e 6f73 7469 6373 4c6f 6320 290a  iagnosticsLoc ).
+0005d3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005d3d0: 2020 2020 6a6f 696e 4469 6167 6e6f 7374      joinDiagnost
+0005d3e0: 6963 7320 3d20 7064 2e63 6f6e 6361 7428  ics = pd.concat(
+0005d3f0: 205b 6a6f 696e 4469 6167 6e6f 7374 6963   [joinDiagnostic
+0005d400: 732c 206a 6f69 6e44 6961 676e 6f73 7469  s, joinDiagnosti
+0005d410: 6373 4c6f 635d 2c20 6178 6973 3d30 2c20  csLoc], axis=0, 
+0005d420: 6967 6e6f 7265 5f69 6e64 6578 3d46 616c  ignore_index=Fal
+0005d430: 7365 2029 0a0a 0a20 2020 2023 2066 6972  se )...    # fir
+0005d440: 7374 2074 6173 6b20 2d20 736f 7274 2062  st task - sort b
+0005d450: 7920 755f 6869 6572 5f69 640a 2020 2020  y u_hier_id.    
+0005d460: 6a6d 6d20 3d20 6a6d 6d2e 736f 7274 5f76  jmm = jmm.sort_v
+0005d470: 616c 7565 7328 2022 755f 6869 6572 5f69  alues( "u_hier_i
+0005d480: 6422 2029 0a20 2020 2023 2067 6574 2072  d" ).    # get r
+0005d490: 6964 206f 6620 6a75 6e6b 2063 6f6c 756d  id of junk colum
+0005d4a0: 6e73 0a20 2020 2062 6164 6e61 6d65 7320  ns.    badnames 
+0005d4b0: 3d20 6765 745f 6e61 6d65 735f 6672 6f6d  = get_names_from
+0005d4c0: 5f64 6174 615f 6672 616d 6528 205b 2755  _data_frame( ['U
+0005d4d0: 6e6e 616d 6564 275d 2c20 6a6d 6d20 290a  nnamed'], jmm ).
+0005d4e0: 2020 2020 6a6d 6d3d 6a6d 6d2e 6472 6f70      jmm=jmm.drop
+0005d4f0: 2862 6164 6e61 6d65 732c 2061 7869 733d  (badnames, axis=
+0005d500: 3129 0a20 2020 206a 6d6d 3d6a 6d6d 2e73  1).    jmm=jmm.s
+0005d510: 6574 5f69 6e64 6578 2822 755f 6869 6572  et_index("u_hier
+0005d520: 5f69 6422 2c64 726f 703d 4661 6c73 6529  _id",drop=False)
+0005d530: 0a20 2020 2023 2032 6e64 202d 2067 6574  .    # 2nd - get
+0005d540: 2072 6964 206f 6620 6475 706c 6963 6174   rid of duplicat
+0005d550: 6564 2075 5f68 6965 725f 6964 0a20 2020  ed u_hier_id.   
+0005d560: 206a 6d6d 556e 6971 203d 206a 6d6d 2e64   jmmUniq = jmm.d
+0005d570: 726f 705f 6475 706c 6963 6174 6573 2820  rop_duplicates( 
+0005d580: 7375 6273 6574 3d22 755f 6869 6572 5f69  subset="u_hier_i
+0005d590: 6422 2029 2023 2066 6173 7420 616e 6420  d" ) # fast and 
+0005d5a0: 6561 7379 0a20 2020 2023 2066 6f72 2065  easy.    # for e
+0005d5b0: 6163 6820 6d6f 6461 6c69 7479 2c20 636f  ach modality, co
+0005d5c0: 756e 7420 7768 6963 6820 6964 7320 6861  unt which ids ha
+0005d5d0: 7665 206d 6f72 6520 7468 616e 206f 6e65  ve more than one
+0005d5e0: 0a20 2020 206d 6f64 5f6e 616d 6573 203d  .    mod_names =
+0005d5f0: 2067 6574 5f76 616c 6964 5f6d 6f64 616c   get_valid_modal
+0005d600: 6974 6965 7328 290a 2020 2020 666f 7220  ities().    for 
+0005d610: 6d6f 645f 6e61 6d65 2069 6e20 6d6f 645f  mod_name in mod_
+0005d620: 6e61 6d65 733a 0a20 2020 2020 2020 2066  names:.        f
+0005d630: 6c5f 6e61 6d65 7320 3d20 6765 745f 6e61  l_names = get_na
+0005d640: 6d65 735f 6672 6f6d 5f64 6174 615f 6672  mes_from_data_fr
+0005d650: 616d 6528 5b6d 6f64 5f6e 616d 655d 2c20  ame([mod_name], 
+0005d660: 6a6d 6d2c 0a20 2020 2020 2020 2020 2020  jmm,.           
+0005d670: 2065 7863 6c75 7369 6f6e 733d 5b27 556e   exclusions=['Un
+0005d680: 6e61 6d65 6427 2c22 4454 495f 4c52 222c  named',"DTI_LR",
+0005d690: 2244 5449 5f52 4c22 2c22 7273 664d 5249  "DTI_RL","rsfMRI
+0005d6a0: 5f52 4c22 2c22 7273 664d 5249 5f4c 5222  _RL","rsfMRI_LR"
+0005d6b0: 5d29 0a20 2020 2020 2020 2069 6620 6c65  ]).        if le
+0005d6c0: 6e28 2066 6c5f 6e61 6d65 7320 2920 3e20  n( fl_names ) > 
+0005d6d0: 313a 0a20 2020 2020 2020 2020 2020 2069  1:.            i
+0005d6e0: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+0005d6f0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0005d700: 286d 6f64 5f6e 616d 6529 0a20 2020 2020  (mod_name).     
+0005d710: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0005d720: 2866 6c5f 6e61 6d65 7329 0a20 2020 2020  (fl_names).     
+0005d730: 2020 2020 2020 2066 6c5f 6964 203d 2066         fl_id = f
+0005d740: 6c5f 6e61 6d65 735b 305d 0a20 2020 2020  l_names[0].     
+0005d750: 2020 2020 2020 206e 5f6e 616d 6573 203d         n_names =
+0005d760: 206c 656e 2866 6c5f 6e61 6d65 7329 0a20   len(fl_names). 
+0005d770: 2020 2020 2020 2020 2020 206c 6f63 7665             locve
+0005d780: 6320 3d20 6a6d 6d5b 666c 5f6e 616d 6573  c = jmm[fl_names
+0005d790: 5b6e 5f6e 616d 6573 2d31 5d5d 2e61 7374  [n_names-1]].ast
+0005d7a0: 7970 6528 666c 6f61 7429 0a20 2020 2020  ype(float).     
+0005d7b0: 2020 2020 2020 2062 6f6f 6c76 6563 3d7e         boolvec=~
+0005d7c0: 7064 2e69 736e 6128 6c6f 6376 6563 290a  pd.isna(locvec).
+0005d7d0: 2020 2020 2020 2020 2020 2020 6a6d 6d73              jmms
+0005d7e0: 7562 203d 206a 6d6d 5b62 6f6f 6c76 6563  ub = jmm[boolvec
+0005d7f0: 5d5b 205b 2775 5f68 6965 725f 6964 275d  ][ ['u_hier_id']
+0005d800: 2b66 6c5f 6e61 6d65 735d 0a20 2020 2020  +fl_names].     
+0005d810: 2020 2020 2020 206d 795f 7462 6c20 3d20         my_tbl = 
+0005d820: 436f 756e 7465 7228 6a6d 6d73 7562 5b27  Counter(jmmsub['
+0005d830: 755f 6869 6572 5f69 6427 5d29 0a20 2020  u_hier_id']).   
+0005d840: 2020 2020 2020 2020 2067 746f 6176 6720           gtoavg 
+0005d850: 3d20 5b6e 616d 6520 666f 7220 6e61 6d65  = [name for name
+0005d860: 2069 6e20 6d79 5f74 626c 2e6b 6579 7328   in my_tbl.keys(
+0005d870: 2920 6966 206d 795f 7462 6c5b 6e61 6d65  ) if my_tbl[name
+0005d880: 5d20 3d3d 2031 5d0a 2020 2020 2020 2020  ] == 1].        
+0005d890: 2020 2020 6774 6f61 7667 4731 203d 205b      gtoavgG1 = [
+0005d8a0: 6e61 6d65 2066 6f72 206e 616d 6520 696e  name for name in
+0005d8b0: 206d 795f 7462 6c2e 6b65 7973 2829 2069   my_tbl.keys() i
+0005d8c0: 6620 6d79 5f74 626c 5b6e 616d 655d 203e  f my_tbl[name] >
+0005d8d0: 2031 5d0a 2020 2020 2020 2020 2020 2020   1].            
+0005d8e0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+0005d8f0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0005d900: 7428 224a 6f69 6e20 3122 290a 2020 2020  t("Join 1").    
+0005d910: 2020 2020 2020 2020 6a6d 6d73 7562 3120          jmmsub1 
+0005d920: 3d20 6a6d 6d73 7562 2e6c 6f63 5b6a 6d6d  = jmmsub.loc[jmm
+0005d930: 7375 625b 2775 5f68 6965 725f 6964 275d  sub['u_hier_id']
+0005d940: 2e69 7369 6e28 6774 6f61 7667 295d 5b5b  .isin(gtoavg)][[
+0005d950: 2775 5f68 6965 725f 6964 275d 2b66 6c5f  'u_hier_id']+fl_
+0005d960: 6e61 6d65 735d 0a20 2020 2020 2020 2020  names].         
+0005d970: 2020 2066 6f72 2075 2069 6e20 6774 6f61     for u in gtoa
+0005d980: 7667 3a0a 2020 2020 2020 2020 2020 2020  vg:.            
+0005d990: 2020 2020 6a6d 6d55 6e69 712e 6c6f 635b      jmmUniq.loc[
+0005d9a0: 755d 5b66 6c5f 6e61 6d65 735b 313a 5d5d  u][fl_names[1:]]
+0005d9b0: 203d 206a 6d6d 7375 6231 2e6c 6f63 5b75   = jmmsub1.loc[u
+0005d9c0: 5d5b 666c 5f6e 616d 6573 5b31 3a5d 5d0a  ][fl_names[1:]].
+0005d9d0: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+0005d9e0: 6572 626f 7365 2061 6e64 206c 656e 2867  erbose and len(g
+0005d9f0: 746f 6176 6747 3129 203e 2031 3a0a 2020  toavgG1) > 1:.  
+0005da00: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0005da10: 696e 7428 224a 6f69 6e20 3e31 2229 0a20  int("Join >1"). 
+0005da20: 2020 2020 2020 2020 2020 206a 6d6d 7375             jmmsu
+0005da30: 6247 3120 3d20 6a6d 6d73 7562 2e6c 6f63  bG1 = jmmsub.loc
+0005da40: 5b6a 6d6d 7375 625b 2775 5f68 6965 725f  [jmmsub['u_hier_
+0005da50: 6964 275d 2e69 7369 6e28 6774 6f61 7667  id'].isin(gtoavg
+0005da60: 4731 295d 5b5b 2775 5f68 6965 725f 6964  G1)][['u_hier_id
+0005da70: 275d 2b66 6c5f 6e61 6d65 735d 0a20 2020  ']+fl_names].   
+0005da80: 2020 2020 2020 2020 2066 6f72 2075 2069           for u i
+0005da90: 6e20 6774 6f61 7667 4731 3a0a 2020 2020  n gtoavgG1:.    
+0005daa0: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+0005dab0: 203d 206a 6d6d 7375 6247 312e 6c6f 635b   = jmmsubG1.loc[
+0005dac0: 755d 5b20 5b27 755f 6869 6572 5f69 6427  u][ ['u_hier_id'
+0005dad0: 5d2b 666c 5f6e 616d 6573 205d 0a20 2020  ]+fl_names ].   
+0005dae0: 2020 2020 2020 2020 2020 2020 2064 726f               dro
+0005daf0: 706e 616d 6573 203d 2067 6574 5f6e 616d  pnames = get_nam
+0005db00: 6573 5f66 726f 6d5f 6461 7461 5f66 7261  es_from_data_fra
+0005db10: 6d65 2820 5b27 4d4d 2e49 4427 5d2c 2074  me( ['MM.ID'], t
+0005db20: 656d 7020 290a 2020 2020 2020 2020 2020  emp ).          
+0005db30: 2020 2020 2020 7465 6d70 5665 6320 3d20        tempVec = 
+0005db40: 7465 6d70 2e64 726f 7028 636f 6c75 6d6e  temp.drop(column
+0005db50: 733d 6472 6f70 6e61 6d65 7329 0a20 2020  s=dropnames).   
+0005db60: 2020 2020 2020 2020 2020 2020 206a 6f69               joi
+0005db70: 6e44 6961 676e 6f73 7469 6373 4c6f 6320  nDiagnosticsLoc 
+0005db80: 3d20 7064 2e44 6174 6146 7261 6d65 2820  = pd.DataFrame( 
+0005db90: 636f 6c75 6d6e 7320 3d20 6478 636f 6c73  columns = dxcols
+0005dba0: 2c20 696e 6465 783d 7261 6e67 6528 3129  , index=range(1)
+0005dbb0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0005dbc0: 2020 2069 6431 3d74 656d 705b 666c 5f69     id1=temp[fl_i
+0005dbd0: 645d 2e69 6c6f 635b 305d 0a20 2020 2020  d].iloc[0].     
+0005dbe0: 2020 2020 2020 2020 2020 2069 6432 3d74             id2=t
+0005dbf0: 656d 705b 666c 5f69 645d 2e69 6c6f 635b  emp[fl_id].iloc[
+0005dc00: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
+0005dc10: 2020 2076 313d 7465 6d70 5665 632e 696c     v1=tempVec.il
+0005dc20: 6f63 5b30 5d5b 313a 5d2e 6173 7479 7065  oc[0][1:].astype
+0005dc30: 2866 6c6f 6174 292e 746f 5f6e 756d 7079  (float).to_numpy
+0005dc40: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0005dc50: 2020 2076 323d 7465 6d70 5665 632e 696c     v2=tempVec.il
+0005dc60: 6f63 5b31 5d5b 313a 5d2e 6173 7479 7065  oc[1][1:].astype
+0005dc70: 2866 6c6f 6174 292e 746f 5f6e 756d 7079  (float).to_numpy
+0005dc80: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0005dc90: 2020 2069 6620 6c65 6e28 7632 2920 3e20     if len(v2) > 
+0005dca0: 6469 6167 6e6f 7374 6963 5f6e 3a0a 2020  diagnostic_n:.  
+0005dcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005dcc0: 2020 7631 3d76 315b 303a 6469 6167 6e6f    v1=v1[0:diagno
+0005dcd0: 7374 6963 5f6e 5d0a 2020 2020 2020 2020  stic_n].        
+0005dce0: 2020 2020 2020 2020 2020 2020 7632 3d76              v2=v
+0005dcf0: 325b 303a 6469 6167 6e6f 7374 6963 5f6e  2[0:diagnostic_n
+0005dd00: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0005dd10: 2020 6d79 636f 7272 203d 206e 702e 636f    mycorr = np.co
+0005dd20: 7272 636f 6566 2820 7631 2c20 7632 2029  rrcoef( v1, v2 )
+0005dd30: 5b30 2c31 5d0a 2020 2020 2020 2020 2020  [0,1].          
+0005dd40: 2020 2020 2020 2320 6d79 636f 7272 3d74        # mycorr=t
+0005dd50: 656d 7061 7272 5b6e 702e 7472 6975 5f69  emparr[np.triu_i
+0005dd60: 6e64 6963 6573 5f66 726f 6d28 7465 6d70  ndices_from(temp
+0005dd70: 6172 722c 206b 3d31 295d 2e6d 6561 6e28  arr, k=1)].mean(
+0005dd80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0005dd90: 2020 6d79 6572 723d 6e70 2e73 7172 7428    myerr=np.sqrt(
+0005dda0: 6e70 2e6d 6561 6e28 2876 3120 2d20 7632  np.mean((v1 - v2
+0005ddb0: 292a 2a32 2929 0a20 2020 2020 2020 2020  )**2)).         
+0005ddc0: 2020 2020 2020 206a 6f69 6e44 6961 676e         joinDiagn
+0005ddd0: 6f73 7469 6373 4c6f 632e 696c 6f63 5b30  osticsLoc.iloc[0
+0005dde0: 5d20 3d20 5b69 6431 2c69 6432 2c6d 6f64  ] = [id1,id2,mod
+0005ddf0: 5f6e 616d 652c 2772 6f77 6176 6727 2c6d  _name,'rowavg',m
+0005de00: 7963 6f72 722c 6d79 6572 725d 0a20 2020  ycorr,myerr].   
+0005de10: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0005de20: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+0005de30: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0005de40: 6e74 2820 6a6f 696e 4469 6167 6e6f 7374  nt( joinDiagnost
+0005de50: 6963 734c 6f63 2029 0a20 2020 2020 2020  icsLoc ).       
+0005de60: 2020 2020 2020 2020 2074 656d 7020 3d20           temp = 
+0005de70: 6a6d 6d73 7562 4731 2e6c 6f63 5b75 5d5b  jmmsubG1.loc[u][
+0005de80: 666c 5f6e 616d 6573 5b31 3a5d 5d2e 6173  fl_names[1:]].as
+0005de90: 7479 7065 2866 6c6f 6174 290a 2020 2020  type(float).    
+0005dea0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+0005deb0: 7963 6f72 7220 3e20 636f 7272 5f74 6872  ycorr > corr_thr
+0005dec0: 6573 6820 6f72 206c 656e 2820 7631 2029  esh or len( v1 )
+0005ded0: 203c 2031 303a 0a20 2020 2020 2020 2020   < 10:.         
+0005dee0: 2020 2020 2020 2020 2020 206a 6d6d 556e             jmmUn
+0005def0: 6971 2e6c 6f63 5b75 5d5b 666c 5f6e 616d  iq.loc[u][fl_nam
+0005df00: 6573 5b31 3a5d 5d20 3d20 7465 6d70 2e6d  es[1:]] = temp.m
+0005df10: 6561 6e28 6178 6973 3d30 290a 2020 2020  ean(axis=0).    
+0005df20: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0005df30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0005df40: 2020 2020 2020 6a6d 6d55 6e69 712e 6c6f        jmmUniq.lo
+0005df50: 635b 755d 5b66 6c5f 6e61 6d65 735b 313a  c[u][fl_names[1:
+0005df60: 5d5d 203d 206e 616e 4c69 7374 202a 2074  ]] = nanList * t
+0005df70: 656d 702e 7368 6170 655b 315d 0a20 2020  emp.shape[1].   
+0005df80: 2020 2020 2020 2020 2020 2020 206a 6f69               joi
+0005df90: 6e44 6961 676e 6f73 7469 6373 203d 2070  nDiagnostics = p
+0005dfa0: 642e 636f 6e63 6174 2820 5b6a 6f69 6e44  d.concat( [joinD
+0005dfb0: 6961 676e 6f73 7469 6373 2c20 6a6f 696e  iagnostics, join
+0005dfc0: 4469 6167 6e6f 7374 6963 734c 6f63 5d2c  DiagnosticsLoc],
+0005dfd0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+0005dfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005dff0: 2020 2020 2020 2020 2020 2020 2020 6178                ax
+0005e000: 6973 3d30 2c20 6967 6e6f 7265 5f69 6e64  is=0, ignore_ind
+0005e010: 6578 3d46 616c 7365 2029 0a0a 2020 2020  ex=False )..    
+0005e020: 7265 7475 726e 206a 6d6d 556e 6971 2c20  return jmmUniq, 
+0005e030: 6a6d 6d2c 206a 6f69 6e44 6961 676e 6f73  jmm, joinDiagnos
+0005e040: 7469 6373 0a0a 0a0a 6465 6620 7175 6963  tics....def quic
+0005e050: 6b5f 7669 7a5f 6d6d 5f6e 7267 280a 2020  k_viz_mm_nrg(.  
+0005e060: 2020 736f 7572 6365 6469 722c 2023 2072    sourcedir, # r
+0005e070: 6f6f 7420 666f 6c64 6572 0a20 2020 2070  oot folder.    p
+0005e080: 726f 6a65 6374 6964 2c20 2320 7072 6f6a  rojectid, # proj
+0005e090: 6563 7420 6e61 6d65 0a20 2020 2073 6964  ect name.    sid
+0005e0a0: 202c 2023 2073 7562 6a65 6374 2075 6e69   , # subject uni
+0005e0b0: 7175 6520 6964 0a20 2020 2064 7469 642c  que id.    dtid,
+0005e0c0: 2023 2064 6174 650a 2020 2020 6578 7472   # date.    extr
+0005e0d0: 6163 745f 6272 6169 6e3d 5472 7565 2c0a  act_brain=True,.
+0005e0e0: 2020 2020 736c 6963 655f 6661 6374 6f72      slice_factor
+0005e0f0: 203d 2030 2e35 352c 0a20 2020 2073 686f   = 0.55,.    sho
+0005e100: 775f 6974 203d 204e 6f6e 652c 2023 206f  w_it = None, # o
+0005e110: 7574 7075 7420 7061 7468 0a20 2020 2076  utput path.    v
+0005e120: 6572 626f 7365 203d 2054 7275 650a 293a  erbose = True.):
+0005e130: 0a20 2020 2022 2222 0a20 2020 2054 6869  .    """.    Thi
+0005e140: 7320 6675 6e63 7469 6f6e 2063 7265 6174  s function creat
+0005e150: 6573 2076 6973 7561 6c69 7a61 7469 6f6e  es visualization
+0005e160: 7320 6f66 2062 7261 696e 2069 6d61 6765  s of brain image
+0005e170: 7320 666f 7220 6120 7370 6563 6966 6963  s for a specific
+0005e180: 2073 7562 6a65 6374 2069 6e20 6120 7072   subject in a pr
+0005e190: 6f6a 6563 7420 7573 696e 6720 414e 5473  oject using ANTs
+0005e1a0: 5079 2e0a 0a20 2020 2041 7267 733a 0a0a  Py...    Args:..
+0005e1b0: 2020 2020 736f 7572 6365 6469 7220 2873      sourcedir (s
+0005e1c0: 7472 293a 2052 6f6f 7420 666f 6c64 6572  tr): Root folder
+0005e1d0: 2e0a 2020 2020 0a20 2020 2070 726f 6a65  ..    .    proje
+0005e1e0: 6374 6964 2028 7374 7229 3a20 5072 6f6a  ctid (str): Proj
+0005e1f0: 6563 7420 6e61 6d65 2e0a 2020 2020 0a20  ect name..    . 
+0005e200: 2020 2073 6964 2028 7374 7229 3a20 5375     sid (str): Su
+0005e210: 626a 6563 7420 756e 6971 7565 2069 642e  bject unique id.
+0005e220: 0a20 2020 200a 2020 2020 6474 6964 2028  .    .    dtid (
+0005e230: 7374 7229 3a20 4461 7465 2e0a 2020 2020  str): Date..    
+0005e240: 0a20 2020 2065 7874 7261 6374 5f62 7261  .    extract_bra
+0005e250: 696e 2028 626f 6f6c 293a 2049 6620 5472  in (bool): If Tr
+0005e260: 7565 2c20 7468 6520 6675 6e63 7469 6f6e  ue, the function
+0005e270: 2065 7874 7261 6374 7320 7468 6520 6272   extracts the br
+0005e280: 6169 6e20 6672 6f6d 2074 6865 2054 3177  ain from the T1w
+0005e290: 2069 6d61 6765 2e20 4465 6661 756c 7420   image. Default 
+0005e2a0: 6973 2054 7275 652e 0a20 2020 200a 2020  is True..    .  
+0005e2b0: 2020 736c 6963 655f 6661 6374 6f72 2028    slice_factor (
+0005e2c0: 666c 6f61 7429 3a20 5468 6520 736c 6963  float): The slic
+0005e2d0: 6520 746f 2062 6520 7669 7375 616c 697a  e to be visualiz
+0005e2e0: 6564 2069 7320 6465 7465 726d 696e 6564  ed is determined
+0005e2f0: 2062 7920 6d75 6c74 6970 6c79 696e 6720   by multiplying 
+0005e300: 7468 6520 696d 6167 6520 7369 7a65 2062  the image size b
+0005e310: 7920 7468 6973 2066 6163 746f 722e 2044  y this factor. D
+0005e320: 6566 6175 6c74 2069 7320 302e 3535 2e0a  efault is 0.55..
+0005e330: 2020 2020 0a20 2020 2073 686f 775f 6974      .    show_it
+0005e340: 2028 7374 7229 3a20 4f75 7470 7574 2070   (str): Output p
+0005e350: 6174 682e 2049 6620 6e6f 7420 4e6f 6e65  ath. If not None
+0005e360: 2c20 7468 6520 7669 7375 616c 697a 6174  , the visualizat
+0005e370: 696f 6e73 2077 696c 6c20 6265 2073 6176  ions will be sav
+0005e380: 6564 2061 7420 7468 6973 206c 6f63 6174  ed at this locat
+0005e390: 696f 6e2e 2044 6566 6175 6c74 2069 7320  ion. Default is 
+0005e3a0: 4e6f 6e65 2e0a 2020 2020 0a20 2020 2076  None..    .    v
+0005e3b0: 6572 626f 7365 2028 626f 6f6c 293a 2049  erbose (bool): I
+0005e3c0: 6620 5472 7565 2c20 696e 666f 726d 6174  f True, informat
+0005e3d0: 696f 6e20 7769 6c6c 2062 6520 7072 696e  ion will be prin
+0005e3e0: 7465 6420 7768 696c 6520 7275 6e6e 696e  ted while runnin
+0005e3f0: 6720 7468 6520 6675 6e63 7469 6f6e 2e20  g the function. 
+0005e400: 4465 6661 756c 7420 6973 2054 7275 652e  Default is True.
+0005e410: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+0005e420: 2020 2076 697a 6c69 7374 2028 6c69 7374     vizlist (list
+0005e430: 293a 204c 6973 7420 6f66 2069 6d61 6765  ): List of image
+0005e440: 2076 6973 7561 6c69 7a61 7469 6f6e 732e   visualizations.
+0005e450: 0a0a 2020 2020 2222 220a 2020 2020 6969  ..    """.    ii
+0005e460: 643d 272a 270a 2020 2020 696d 706f 7274  d='*'.    import
+0005e470: 2067 6c6f 6220 6173 2067 6c6f 620a 2020   glob as glob.  
+0005e480: 2020 6672 6f6d 206f 732e 7061 7468 2069    from os.path i
+0005e490: 6d70 6f72 7420 6578 6973 7473 0a20 2020  mport exists.   
+0005e4a0: 2069 6d70 6f72 7420 616e 7473 0a20 2020   import ants.   
+0005e4b0: 2065 785f 7061 7468 203d 206f 732e 7061   ex_path = os.pa
+0005e4c0: 7468 2e65 7870 616e 6475 7365 7228 2022  th.expanduser( "
+0005e4d0: 7e2f 2e61 6e74 7370 7974 3177 2f22 2029  ~/.antspyt1w/" )
+0005e4e0: 0a20 2020 2065 785f 7061 7468 6d6d 203d  .    ex_pathmm =
+0005e4f0: 206f 732e 7061 7468 2e65 7870 616e 6475   os.path.expandu
+0005e500: 7365 7228 2022 7e2f 2e61 6e74 7370 796d  ser( "~/.antspym
+0005e510: 6d2f 2220 290a 2020 2020 7465 6d70 6c61  m/" ).    templa
+0005e520: 7465 666e 203d 2065 785f 7061 7468 202b  tefn = ex_path +
+0005e530: 2027 4349 5431 3638 5f54 3177 5f37 3030   'CIT168_T1w_700
+0005e540: 756d 5f70 6164 5f61 646e 692e 6e69 692e  um_pad_adni.nii.
+0005e550: 677a 270a 2020 2020 6966 206e 6f74 2065  gz'.    if not e
+0005e560: 7869 7374 7328 2074 656d 706c 6174 6566  xists( templatef
+0005e570: 6e20 293a 0a20 2020 2020 2020 2070 7269  n ):.        pri
+0005e580: 6e74 2820 222a 2a6d 6973 7369 6e67 2066  nt( "**missing f
+0005e590: 696c 6573 2a2a 203d 3e20 6361 6c6c 2067  iles** => call g
+0005e5a0: 6574 5f64 6174 6120 6672 6f6d 206c 6174  et_data from lat
+0005e5b0: 6573 7420 616e 7473 7079 7431 7720 616e  est antspyt1w an
+0005e5c0: 6420 616e 7473 7079 6d6d 2e22 2029 0a20  d antspymm." ). 
+0005e5d0: 2020 2020 2020 2061 6e74 7370 7974 3177         antspyt1w
+0005e5e0: 2e67 6574 5f64 6174 6128 2066 6f72 6365  .get_data( force
+0005e5f0: 5f64 6f77 6e6c 6f61 643d 5472 7565 2029  _download=True )
+0005e600: 0a20 2020 2020 2020 2067 6574 5f64 6174  .        get_dat
+0005e610: 6128 2066 6f72 6365 5f64 6f77 6e6c 6f61  a( force_downloa
+0005e620: 643d 5472 7565 2029 0a20 2020 2074 656d  d=True ).    tem
+0005e630: 7020 3d20 736f 7572 6365 6469 722e 7370  p = sourcedir.sp
+0005e640: 6c69 7428 2022 2f22 2029 0a20 2020 2073  lit( "/" ).    s
+0005e650: 706c 6974 436f 756e 7420 3d20 6c65 6e28  plitCount = len(
+0005e660: 2074 656d 7020 290a 2020 2020 7465 6d70   temp ).    temp
+0005e670: 6c61 7465 203d 206d 6d5f 7265 6164 2820  late = mm_read( 
+0005e680: 7465 6d70 6c61 7465 666e 2029 2023 2052  templatefn ) # R
+0005e690: 6561 6420 696e 2074 656d 706c 6174 650a  ead in template.
+0005e6a0: 2020 2020 7375 626a 6563 7472 6f6f 7470      subjectrootp
+0005e6b0: 6174 6820 3d20 6f73 2e70 6174 682e 6a6f  ath = os.path.jo
+0005e6c0: 696e 2873 6f75 7263 6564 6972 2c20 7072  in(sourcedir, pr
+0005e6d0: 6f6a 6563 7469 642c 2073 6964 2c20 6474  ojectid, sid, dt
+0005e6e0: 6964 290a 2020 2020 6d79 696d 6773 496e  id).    myimgsIn
+0005e6f0: 7075 7420 3d20 676c 6f62 2e67 6c6f 6228  put = glob.glob(
+0005e700: 2073 7562 6a65 6374 726f 6f74 7061 7468   subjectrootpath
+0005e710: 2b22 2f2a 2220 290a 2020 2020 6d79 696d  +"/*" ).    myim
+0005e720: 6773 496e 7075 742e 736f 7274 2820 290a  gsInput.sort( ).
+0005e730: 2020 2020 6966 2076 6572 626f 7365 3a0a      if verbose:.
+0005e740: 2020 2020 2020 2020 7072 696e 7428 206d          print( m
+0005e750: 7969 6d67 7349 6e70 7574 2029 0a20 2020  yimgsInput ).   
+0005e760: 2074 315f 7365 6172 6368 5f70 6174 6820   t1_search_path 
+0005e770: 3d20 6f73 2e70 6174 682e 6a6f 696e 2873  = os.path.join(s
+0005e780: 7562 6a65 6374 726f 6f74 7061 7468 2c20  ubjectrootpath, 
+0005e790: 2254 3177 222c 2022 2a22 2c20 222a 6e69  "T1w", "*", "*ni
+0005e7a0: 692e 677a 2229 0a20 2020 2069 6620 7665  i.gz").    if ve
+0005e7b0: 7262 6f73 653a 0a20 2020 2020 2020 2070  rbose:.        p
+0005e7c0: 7269 6e74 2866 2274 3120 7365 6172 6368  rint(f"t1 search
+0005e7d0: 2070 6174 683a 207b 7431 5f73 6561 7263   path: {t1_searc
+0005e7e0: 685f 7061 7468 7d22 290a 2020 2020 7431  h_path}").    t1
+0005e7f0: 666e 203d 2067 6c6f 622e 676c 6f62 2874  fn = glob.glob(t
+0005e800: 315f 7365 6172 6368 5f70 6174 6829 0a20  1_search_path). 
+0005e810: 2020 2074 3166 6e2e 736f 7274 2829 0a20     t1fn.sort(). 
+0005e820: 2020 2069 6620 6c65 6e28 2074 3166 6e20     if len( t1fn 
+0005e830: 2920 3c20 313a 0a20 2020 2020 2020 2072  ) < 1:.        r
+0005e840: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+0005e850: 2771 7569 636b 5f76 697a 5f6d 6d5f 6e72  'quick_viz_mm_nr
+0005e860: 6720 6361 6e6e 6f74 2066 696e 6420 7468  g cannot find th
+0005e870: 6520 5431 7720 4020 2720 2b20 7375 626a  e T1w @ ' + subj
+0005e880: 6563 7472 6f6f 7470 6174 6820 290a 2020  ectrootpath ).  
+0005e890: 2020 7431 666e 203d 2074 3166 6e5b 305d    t1fn = t1fn[0]
+0005e8a0: 0a20 2020 2074 3120 3d20 6d6d 5f72 6561  .    t1 = mm_rea
+0005e8b0: 6428 2074 3166 6e20 290a 2020 2020 6e69  d( t1fn ).    ni
+0005e8c0: 6d61 6765 7320 3d20 6c65 6e28 6d79 696d  mages = len(myim
+0005e8d0: 6773 496e 7075 7429 0a20 2020 2076 697a  gsInput).    viz
+0005e8e0: 6c69 7374 3d5b 5d0a 2020 2020 6966 2076  list=[].    if v
+0005e8f0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+0005e900: 7072 696e 7428 2020 2220 7765 2068 6176  print(  " we hav
+0005e910: 6520 3a20 2220 2b20 7374 7228 6e69 6d61  e : " + str(nima
+0005e920: 6765 7329 202b 2022 206d 6f64 616c 6974  ges) + " modalit
+0005e930: 6965 732e 2020 7769 6c6c 2076 6973 7561  ies.  will visua
+0005e940: 6c69 7a65 2054 3120 4e4d 2072 7366 4d52  lize T1 NM rsfMR
+0005e950: 4920 4454 4942 3020 4454 4944 5749 2046  I DTIB0 DTIDWI F
+0005e960: 4c41 4952 2229 0a20 2020 2023 206e 7267  LAIR").    # nrg
+0005e970: 5f6d 6f64 616c 6974 795f 6c69 7374 203d  _modality_list =
+0005e980: 205b 2254 3177 222c 2022 4e4d 3244 4d54   ["T1w", "NM2DMT
+0005e990: 222c 2022 7273 664d 5249 222c 2272 7366  ", "rsfMRI","rsf
+0005e9a0: 4d52 495f 4c52 222c 2272 7366 4d52 495f  MRI_LR","rsfMRI_
+0005e9b0: 524c 222c 2244 5449 222c 2244 5449 5f4c  RL","DTI","DTI_L
+0005e9c0: 5222 2c20 2254 3246 6c61 6972 2220 5d2c  R", "T2Flair" ],
+0005e9d0: 0a20 2020 206e 7267 5f6d 6f64 616c 6974  .    nrg_modalit
+0005e9e0: 795f 6c69 7374 203d 205b 2027 5431 7727  y_list = [ 'T1w'
+0005e9f0: 2c20 274e 4d32 444d 5427 2c20 2772 7366  , 'NM2DMT', 'rsf
+0005ea00: 4d52 4927 2c20 2744 5749 3127 2c20 2744  MRI', 'DWI1', 'D
+0005ea10: 5749 3227 2c20 2754 3246 6c61 6972 2720  WI2', 'T2Flair' 
+0005ea20: 5d0a 2020 2020 666f 7220 6e72 674e 756d  ].    for nrgNum
+0005ea30: 2069 6e20 5b30 2c31 2c32 2c33 2c34 2c35   in [0,1,2,3,4,5
+0005ea40: 5d3a 0a20 2020 2020 2020 206f 7665 726d  ]:.        overm
+0005ea50: 6f64 5820 3d20 6e72 675f 6d6f 6461 6c69  odX = nrg_modali
+0005ea60: 7479 5f6c 6973 745b 6e72 674e 756d 5d0a  ty_list[nrgNum].
+0005ea70: 2020 2020 2020 2020 6966 206f 7665 726d          if overm
+0005ea80: 6f64 5820 3d3d 2027 5431 7727 3a0a 2020  odX == 'T1w':.  
+0005ea90: 2020 2020 2020 2020 2020 6d6f 645f 7365            mod_se
+0005eaa0: 6172 6368 5f70 6174 6820 3d20 6f73 2e70  arch_path = os.p
+0005eab0: 6174 682e 6a6f 696e 2873 7562 6a65 6374  ath.join(subject
+0005eac0: 726f 6f74 7061 7468 2c20 6f76 6572 6d6f  rootpath, overmo
+0005ead0: 6458 2c20 6969 642c 2022 2a6e 6969 2e67  dX, iid, "*nii.g
+0005eae0: 7a22 290a 2020 2020 2020 2020 2020 2020  z").            
+0005eaf0: 6d79 696d 6773 7220 3d20 676c 6f62 2e67  myimgsr = glob.g
+0005eb00: 6c6f 6228 6d6f 645f 7365 6172 6368 5f70  lob(mod_search_p
+0005eb10: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+0005eb20: 2069 6620 6c65 6e28 206d 7969 6d67 7372   if len( myimgsr
+0005eb30: 2029 203d 3d20 303a 0a20 2020 2020 2020   ) == 0:.       
+0005eb40: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
+0005eb50: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+0005eb60: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+0005eb70: 4e6f 2074 3120 696d 6167 6573 3a20 2220  No t1 images: " 
+0005eb80: 2b20 7369 6420 2b20 6474 6964 2029 0a20  + sid + dtid ). 
+0005eb90: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0005eba0: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
+0005ebb0: 2020 2020 2020 206d 7969 6d67 7372 2e73         myimgsr.s
+0005ebc0: 6f72 7428 290a 2020 2020 2020 2020 2020  ort().          
+0005ebd0: 2020 6d79 696d 6773 723d 6d79 696d 6773    myimgsr=myimgs
+0005ebe0: 725b 305d 0a20 2020 2020 2020 2020 2020  r[0].           
+0005ebf0: 2076 696d 673d 616e 7473 2e69 6d61 6765   vimg=ants.image
+0005ec00: 5f72 6561 6428 206d 7969 6d67 7372 2029  _read( myimgsr )
+0005ec10: 0a20 2020 2020 2020 2065 6c69 6620 6f76  .        elif ov
+0005ec20: 6572 6d6f 6458 203d 3d20 2744 5749 3127  ermodX == 'DWI1'
+0005ec30: 3a0a 2020 2020 2020 2020 2020 2020 6d6f  :.            mo
+0005ec40: 645f 7365 6172 6368 5f70 6174 6820 3d20  d_search_path = 
+0005ec50: 6f73 2e70 6174 682e 6a6f 696e 2873 7562  os.path.join(sub
+0005ec60: 6a65 6374 726f 6f74 7061 7468 2c20 2744  jectrootpath, 'D
+0005ec70: 5449 2a27 2c20 222a 222c 2022 2a6e 6969  TI*', "*", "*nii
+0005ec80: 2e67 7a22 290a 2020 2020 2020 2020 2020  .gz").          
+0005ec90: 2020 6d79 696d 6773 7220 3d20 676c 6f62    myimgsr = glob
+0005eca0: 2e67 6c6f 6228 6d6f 645f 7365 6172 6368  .glob(mod_search
+0005ecb0: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+0005ecc0: 2020 2069 6620 6c65 6e28 206d 7969 6d67     if len( myimg
+0005ecd0: 7372 2029 203e 2030 3a0a 2020 2020 2020  sr ) > 0:.      
+0005ece0: 2020 2020 2020 2020 2020 6d79 696d 6773            myimgs
+0005ecf0: 722e 736f 7274 2829 0a20 2020 2020 2020  r.sort().       
+0005ed00: 2020 2020 2020 2020 206d 7969 6d67 7372           myimgsr
+0005ed10: 3d6d 7969 6d67 7372 5b30 5d0a 2020 2020  =myimgsr[0].    
+0005ed20: 2020 2020 2020 2020 2020 2020 7669 6d67              vimg
+0005ed30: 3d61 6e74 732e 696d 6167 655f 7265 6164  =ants.image_read
+0005ed40: 2820 6d79 696d 6773 7220 290a 2020 2020  ( myimgsr ).    
+0005ed50: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0005ed60: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0005ed70: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+0005ed80: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0005ed90: 696e 7428 224e 6f20 2220 2b20 6f76 6572  int("No " + over
+0005eda0: 6d6f 6458 290a 2020 2020 2020 2020 2020  modX).          
+0005edb0: 2020 2020 2020 7669 6d67 203d 206e 6f69        vimg = noi
+0005edc0: 7a69 6d67 0a20 2020 2020 2020 2065 6c69  zimg.        eli
+0005edd0: 6620 6f76 6572 6d6f 6458 203d 3d20 2744  f overmodX == 'D
+0005ede0: 5749 3227 3a0a 2020 2020 2020 2020 2020  WI2':.          
+0005edf0: 2020 6d6f 645f 7365 6172 6368 5f70 6174    mod_search_pat
+0005ee00: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
+0005ee10: 2873 7562 6a65 6374 726f 6f74 7061 7468  (subjectrootpath
+0005ee20: 2c20 2744 5449 2a27 2c20 222a 222c 2022  , 'DTI*', "*", "
+0005ee30: 2a6e 6969 2e67 7a22 290a 2020 2020 2020  *nii.gz").      
+0005ee40: 2020 2020 2020 6d79 696d 6773 7220 3d20        myimgsr = 
+0005ee50: 676c 6f62 2e67 6c6f 6228 6d6f 645f 7365  glob.glob(mod_se
+0005ee60: 6172 6368 5f70 6174 6829 0a20 2020 2020  arch_path).     
+0005ee70: 2020 2020 2020 2069 6620 6c65 6e28 206d         if len( m
+0005ee80: 7969 6d67 7372 2029 203e 2030 3a0a 2020  yimgsr ) > 0:.  
+0005ee90: 2020 2020 2020 2020 2020 2020 2020 6d79                my
+0005eea0: 696d 6773 722e 736f 7274 2829 0a20 2020  imgsr.sort().   
+0005eeb0: 2020 2020 2020 2020 2020 2020 206d 7969               myi
+0005eec0: 6d67 7372 3d6d 7969 6d67 7372 5b6c 656e  mgsr=myimgsr[len
+0005eed0: 286d 7969 6d67 7372 292d 315d 0a20 2020  (myimgsr)-1].   
+0005eee0: 2020 2020 2020 2020 2020 2020 2076 696d               vim
+0005eef0: 673d 616e 7473 2e69 6d61 6765 5f72 6561  g=ants.image_rea
+0005ef00: 6428 206d 7969 6d67 7372 2029 0a20 2020  d( myimgsr ).   
+0005ef10: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0005ef20: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0005ef30: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+0005ef40: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0005ef50: 7269 6e74 2822 4e6f 2022 202b 206f 7665  rint("No " + ove
+0005ef60: 726d 6f64 5829 0a20 2020 2020 2020 2020  rmodX).         
+0005ef70: 2020 2020 2020 2076 696d 6720 3d20 6e6f         vimg = no
+0005ef80: 697a 696d 670a 2020 2020 2020 2020 656c  izimg.        el
+0005ef90: 6966 206f 7665 726d 6f64 5820 3d3d 2027  if overmodX == '
+0005efa0: 4e4d 3244 4d54 273a 0a20 2020 2020 2020  NM2DMT':.       
+0005efb0: 2020 2020 206d 6f64 5f73 6561 7263 685f       mod_search_
+0005efc0: 7061 7468 203d 206f 732e 7061 7468 2e6a  path = os.path.j
+0005efd0: 6f69 6e28 7375 626a 6563 7472 6f6f 7470  oin(subjectrootp
+0005efe0: 6174 682c 206f 7665 726d 6f64 582c 2022  ath, overmodX, "
+0005eff0: 2a22 2c20 222a 6e69 692e 677a 2229 0a20  *", "*nii.gz"). 
+0005f000: 2020 2020 2020 2020 2020 206d 7969 6d67             myimg
+0005f010: 7372 203d 2067 6c6f 622e 676c 6f62 286d  sr = glob.glob(m
+0005f020: 6f64 5f73 6561 7263 685f 7061 7468 290a  od_search_path).
+0005f030: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+0005f040: 656e 2820 6d79 696d 6773 7220 2920 3e20  en( myimgsr ) > 
+0005f050: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0005f060: 2020 206d 7969 6d67 7372 2e73 6f72 7428     myimgsr.sort(
+0005f070: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0005f080: 2020 6d79 696d 6773 7230 3d6d 7969 6d67    myimgsr0=myimg
+0005f090: 7372 5b30 5d0a 2020 2020 2020 2020 2020  sr[0].          
+0005f0a0: 2020 2020 2020 7669 6d67 3d61 6e74 732e        vimg=ants.
+0005f0b0: 696d 6167 655f 7265 6164 2820 6d79 696d  image_read( myim
+0005f0c0: 6773 7230 2029 0a20 2020 2020 2020 2020  gsr0 ).         
+0005f0d0: 2020 2020 2020 2066 6f72 206b 2069 6e20         for k in 
+0005f0e0: 7261 6e67 6528 312c 6c65 6e28 6d79 696d  range(1,len(myim
+0005f0f0: 6773 7229 293a 0a20 2020 2020 2020 2020  gsr)):.         
+0005f100: 2020 2020 2020 2020 2020 2074 656d 7020             temp 
+0005f110: 3d20 616e 7473 2e69 6d61 6765 5f72 6561  = ants.image_rea
+0005f120: 6428 206d 7969 6d67 7372 5b6b 5d29 0a20  d( myimgsr[k]). 
+0005f130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f140: 2020 2076 696d 673d 7669 6d67 2b61 6e74     vimg=vimg+ant
+0005f150: 732e 7265 7361 6d70 6c65 5f69 6d61 6765  s.resample_image
+0005f160: 5f74 6f5f 7461 7267 6574 2874 656d 702c  _to_target(temp,
+0005f170: 7669 6d67 290a 2020 2020 2020 2020 2020  vimg).          
+0005f180: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0005f190: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+0005f1a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0005f1b0: 2020 2020 2020 2020 7072 696e 7428 224e          print("N
+0005f1c0: 6f20 2220 2b20 6f76 6572 6d6f 6458 290a  o " + overmodX).
+0005f1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f1e0: 7669 6d67 203d 206e 6f69 7a69 6d67 0a20  vimg = noizimg. 
+0005f1f0: 2020 2020 2020 2065 6c69 6620 6f76 6572         elif over
+0005f200: 6d6f 6458 203d 3d20 2772 7366 4d52 4927  modX == 'rsfMRI'
+0005f210: 3a0a 2020 2020 2020 2020 2020 2020 6d6f  :.            mo
+0005f220: 645f 7365 6172 6368 5f70 6174 6820 3d20  d_search_path = 
+0005f230: 6f73 2e70 6174 682e 6a6f 696e 2873 7562  os.path.join(sub
+0005f240: 6a65 6374 726f 6f74 7061 7468 2c20 2772  jectrootpath, 'r
+0005f250: 7366 4d52 492a 272c 2022 2a22 2c20 222a  sfMRI*', "*", "*
+0005f260: 6e69 692e 677a 2229 0a20 2020 2020 2020  nii.gz").       
+0005f270: 2020 2020 206d 7969 6d67 7372 203d 2067       myimgsr = g
+0005f280: 6c6f 622e 676c 6f62 286d 6f64 5f73 6561  lob.glob(mod_sea
+0005f290: 7263 685f 7061 7468 290a 2020 2020 2020  rch_path).      
+0005f2a0: 2020 2020 2020 6966 206c 656e 2820 6d79        if len( my
+0005f2b0: 696d 6773 7220 2920 3e20 303a 0a20 2020  imgsr ) > 0:.   
+0005f2c0: 2020 2020 2020 2020 2020 2020 206d 7969               myi
+0005f2d0: 6d67 7372 2e73 6f72 7428 290a 2020 2020  mgsr.sort().    
+0005f2e0: 2020 2020 2020 2020 2020 2020 6d79 696d              myim
+0005f2f0: 6773 723d 6d79 696d 6773 725b 305d 0a20  gsr=myimgsr[0]. 
+0005f300: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0005f310: 696d 673d 6d6d 5f72 6561 645f 746f 5f33  img=mm_read_to_3
+0005f320: 6428 206d 7969 6d67 7372 2029 0a20 2020  d( myimgsr ).   
+0005f330: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0005f340: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0005f350: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+0005f360: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0005f370: 7269 6e74 2822 4e6f 2022 202b 206f 7665  rint("No " + ove
+0005f380: 726d 6f64 5829 0a20 2020 2020 2020 2020  rmodX).         
+0005f390: 2020 2020 2020 2076 696d 6720 3d20 6e6f         vimg = no
+0005f3a0: 697a 696d 670a 2020 2020 2020 2020 656c  izimg.        el
+0005f3b0: 7365 203a 0a20 2020 2020 2020 2020 2020  se :.           
+0005f3c0: 206d 6f64 5f73 6561 7263 685f 7061 7468   mod_search_path
+0005f3d0: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
+0005f3e0: 7375 626a 6563 7472 6f6f 7470 6174 682c  subjectrootpath,
+0005f3f0: 206f 7665 726d 6f64 582c 2022 2a22 2c20   overmodX, "*", 
+0005f400: 222a 6e69 692e 677a 2229 0a20 2020 2020  "*nii.gz").     
+0005f410: 2020 2020 2020 206d 7969 6d67 7372 203d         myimgsr =
+0005f420: 2067 6c6f 622e 676c 6f62 286d 6f64 5f73   glob.glob(mod_s
+0005f430: 6561 7263 685f 7061 7468 290a 2020 2020  earch_path).    
+0005f440: 2020 2020 2020 2020 6966 206c 656e 2820          if len( 
+0005f450: 6d79 696d 6773 7220 2920 3e20 303a 0a20  myimgsr ) > 0:. 
+0005f460: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0005f470: 7969 6d67 7372 2e73 6f72 7428 290a 2020  yimgsr.sort().  
+0005f480: 2020 2020 2020 2020 2020 2020 2020 6d79                my
+0005f490: 696d 6773 723d 6d79 696d 6773 725b 305d  imgsr=myimgsr[0]
+0005f4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005f4b0: 2076 696d 673d 616e 7473 2e69 6d61 6765   vimg=ants.image
+0005f4c0: 5f72 6561 6428 206d 7969 6d67 7372 2029  _read( myimgsr )
+0005f4d0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0005f4e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0005f4f0: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+0005f500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f510: 2020 2070 7269 6e74 2822 4e6f 2022 202b     print("No " +
+0005f520: 206f 7665 726d 6f64 5829 0a20 2020 2020   overmodX).     
+0005f530: 2020 2020 2020 2020 2020 2076 696d 6720             vimg 
+0005f540: 3d20 6e6f 697a 696d 670a 2020 2020 2020  = noizimg.      
+0005f550: 2020 6966 2054 7275 653a 0a20 2020 2020    if True:.     
+0005f560: 2020 2020 2020 2069 6620 6578 7472 6163         if extrac
+0005f570: 745f 6272 6169 6e20 616e 6420 6f76 6572  t_brain and over
+0005f580: 6d6f 6458 203d 3d20 2754 3177 273a 0a20  modX == 'T1w':. 
+0005f590: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0005f5a0: 696d 6720 3d20 7669 6d67 202a 2061 6e74  img = vimg * ant
+0005f5b0: 7370 7974 3177 2e62 7261 696e 5f65 7874  spyt1w.brain_ext
+0005f5c0: 7261 6374 696f 6e28 7669 6d67 290a 2020  raction(vimg).  
+0005f5d0: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+0005f5e0: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+0005f5f0: 2020 2020 2020 7072 696e 7428 6622 6d6f        print(f"mo
+0005f600: 6461 6c69 7479 2073 6561 7263 6820 7061  dality search pa
+0005f610: 7468 3a20 7b6d 7969 6d67 7372 7d22 202b  th: {myimgsr}" +
+0005f620: 2022 206e 756d 3a20 2220 2b20 7374 7228   " num: " + str(
+0005f630: 6e72 674e 756d 2929 0a20 2020 2020 2020  nrgNum)).       
+0005f640: 2020 2020 2069 6620 6c65 6e28 2076 696d       if len( vim
+0005f650: 672e 7368 6170 6520 2920 3d3d 2034 2061  g.shape ) == 4 a
+0005f660: 6e64 2028 206f 7665 726d 6f64 5820 3d3d  nd ( overmodX ==
+0005f670: 2022 4457 4932 2220 2029 3a0a 2020 2020   "DWI2"  ):.    
+0005f680: 2020 2020 2020 2020 2020 2020 7474 6230              ttb0
+0005f690: 2c20 7474 6477 3d67 6574 5f61 7665 7261  , ttdw=get_avera
+0005f6a0: 6765 5f64 7769 5f62 3028 7669 6d67 290a  ge_dwi_b0(vimg).
+0005f6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f6c0: 7669 6d67 203d 2074 7464 770a 2020 2020  vimg = ttdw.    
+0005f6d0: 2020 2020 2020 2020 656c 6966 206c 656e          elif len
+0005f6e0: 2820 7669 6d67 2e73 6861 7065 2029 203d  ( vimg.shape ) =
+0005f6f0: 3d20 3420 616e 6420 6f76 6572 6d6f 6458  = 4 and overmodX
+0005f700: 203d 3d20 2244 5749 3122 3a0a 2020 2020   == "DWI1":.    
+0005f710: 2020 2020 2020 2020 2020 2020 7474 6230              ttb0
+0005f720: 2c20 7474 6477 3d67 6574 5f61 7665 7261  , ttdw=get_avera
+0005f730: 6765 5f64 7769 5f62 3028 7669 6d67 290a  ge_dwi_b0(vimg).
+0005f740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f750: 7669 6d67 203d 2074 7462 300a 2020 2020  vimg = ttb0.    
+0005f760: 2020 2020 2020 2020 656c 6966 206c 656e          elif len
+0005f770: 2820 7669 6d67 2e73 6861 7065 2029 203d  ( vimg.shape ) =
+0005f780: 3d20 3420 3a0a 2020 2020 2020 2020 2020  = 4 :.          
+0005f790: 2020 2020 2020 7669 6d67 3d61 6e74 732e        vimg=ants.
+0005f7a0: 6765 745f 6176 6572 6167 655f 6f66 5f74  get_average_of_t
+0005f7b0: 696d 6573 6572 6965 7328 7669 6d67 290a  imeseries(vimg).
+0005f7c0: 2020 2020 2020 2020 2020 2020 6d73 6b3d              msk=
+0005f7d0: 616e 7473 2e67 6574 5f6d 6173 6b28 7669  ants.get_mask(vi
+0005f7e0: 6d67 290a 2020 2020 2020 2020 2020 2020  mg).            
+0005f7f0: 7669 6d67 3d61 6e74 732e 6372 6f70 5f69  vimg=ants.crop_i
+0005f800: 6d61 6765 2876 696d 672c 6d73 6b29 0a20  mage(vimg,msk). 
+0005f810: 2020 2020 2020 2020 2020 2069 6620 6f76             if ov
+0005f820: 6572 6d6f 6458 203d 3d20 2754 3177 273a  ermodX == 'T1w':
+0005f830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005f840: 2072 6566 696d 673d 616e 7473 2e69 6d61   refimg=ants.ima
+0005f850: 6765 5f63 6c6f 6e65 2820 7669 6d67 2029  ge_clone( vimg )
+0005f860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005f870: 206e 6f69 7a69 6d67 203d 2061 6e74 732e   noizimg = ants.
+0005f880: 6164 645f 6e6f 6973 655f 746f 5f69 6d61  add_noise_to_ima
+0005f890: 6765 2820 7265 6669 6d67 2a30 2c20 2761  ge( refimg*0, 'a
+0005f8a0: 6464 6974 6976 6567 6175 7373 6961 6e27  dditivegaussian'
+0005f8b0: 2c20 5b31 3030 2c31 5d20 290a 2020 2020  , [100,1] ).    
+0005f8c0: 2020 2020 2020 2020 2020 2020 7669 7a6c              vizl
+0005f8d0: 6973 742e 6170 7065 6e64 2820 7669 6d67  ist.append( vimg
+0005f8e0: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
+0005f8f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0005f900: 2020 2020 2076 696d 6720 3d20 616e 7473       vimg = ants
+0005f910: 2e72 6573 616d 706c 655f 696d 6167 655f  .resample_image_
+0005f920: 746f 5f74 6172 6765 7428 2076 696d 672c  to_target( vimg,
+0005f930: 2072 6566 696d 6720 290a 2020 2020 2020   refimg ).      
+0005f940: 2020 2020 2020 2020 2020 7669 6d67 203d            vimg =
+0005f950: 2061 6e74 732e 694d 6174 6828 2076 696d   ants.iMath( vim
+0005f960: 672c 2027 5472 756e 6361 7465 496e 7465  g, 'TruncateInte
+0005f970: 6e73 6974 7927 2c30 2e30 312c 302e 3938  nsity',0.01,0.98
+0005f980: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0005f990: 2020 7669 7a6c 6973 742e 6170 7065 6e64    vizlist.append
+0005f9a0: 2820 616e 7473 2e69 4d61 7468 2820 7669  ( ants.iMath( vi
+0005f9b0: 6d67 2c20 274e 6f72 6d61 6c69 7a65 2720  mg, 'Normalize' 
+0005f9c0: 2920 2a20 3235 3520 290a 0a20 2020 206c  ) * 255 )..    l
+0005f9d0: 6973 746c 656e 203d 206c 656e 2820 7669  istlen = len( vi
+0005f9e0: 7a6c 6973 7420 290a 2020 2020 7669 7a6c  zlist ).    vizl
+0005f9f0: 6973 7420 3d20 6e70 2e61 7361 7272 6179  ist = np.asarray
+0005fa00: 2820 7669 7a6c 6973 7420 290a 2020 2020  ( vizlist ).    
+0005fa10: 6966 2073 686f 775f 6974 2069 7320 6e6f  if show_it is no
+0005fa20: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0005fa30: 6669 6c65 6e61 6d65 6f75 743d 4e6f 6e65  filenameout=None
+0005fa40: 0a20 2020 2020 2020 2069 6620 7665 7262  .        if verb
+0005fa50: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+0005fa60: 2070 7269 6e74 2820 7368 6f77 5f69 7420   print( show_it 
+0005fa70: 290a 2020 2020 2020 2020 666f 7220 6120  ).        for a 
+0005fa80: 696e 205b 302c 312c 325d 3a0a 2020 2020  in [0,1,2]:.    
+0005fa90: 2020 2020 2020 2020 6e3d 696e 7428 6e70          n=int(np
+0005faa0: 2e72 6f75 6e64 2820 7265 6669 6d67 2e73  .round( refimg.s
+0005fab0: 6861 7065 5b61 5d20 2a20 736c 6963 655f  hape[a] * slice_
+0005fac0: 6661 6374 6f72 2029 290a 2020 2020 2020  factor )).      
+0005fad0: 2020 2020 2020 736c 6963 6573 3d6e 702e        slices=np.
+0005fae0: 7265 7065 6174 2820 696e 7428 6e29 2c20  repeat( int(n), 
+0005faf0: 6c69 7374 6c65 6e20 2029 0a20 2020 2020  listlen  ).     
+0005fb00: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0005fb10: 616e 6365 2873 686f 775f 6974 2c73 7472  ance(show_it,str
+0005fb20: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0005fb30: 2020 2066 696c 656e 616d 656f 7574 3d73     filenameout=s
+0005fb40: 686f 775f 6974 2b27 5f61 7827 2b73 7472  how_it+'_ax'+str
+0005fb50: 2869 6e74 2861 2929 2b27 5f73 6c27 2b73  (int(a))+'_sl'+s
+0005fb60: 7472 286e 292b 272e 706e 6727 0a20 2020  tr(n)+'.png'.   
+0005fb70: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0005fb80: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+0005fb90: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0005fba0: 6e74 2820 6669 6c65 6e61 6d65 6f75 7420  nt( filenameout 
+0005fbb0: 290a 2020 2020 2020 2020 2020 2020 616e  ).            an
+0005fbc0: 7473 2e70 6c6f 745f 6772 6964 2876 697a  ts.plot_grid(viz
+0005fbd0: 6c69 7374 2e72 6573 6861 7065 2832 2c33  list.reshape(2,3
+0005fbe0: 292c 2073 6c69 6365 732e 7265 7368 6170  ), slices.reshap
+0005fbf0: 6528 322c 3329 2c20 7469 746c 653d 274d  e(2,3), title='M
+0005fc00: 4d20 5375 626a 6563 7420 2720 2b20 7369  M Subject ' + si
+0005fc10: 6420 2b20 2720 2720 2b20 6474 6964 2c20  d + ' ' + dtid, 
+0005fc20: 7266 6163 6563 6f6c 6f72 3d27 7768 6974  rfacecolor='whit
+0005fc30: 6527 2c20 6178 6573 3d61 2c20 6669 6c65  e', axes=a, file
+0005fc40: 6e61 6d65 3d66 696c 656e 616d 656f 7574  name=filenameout
+0005fc50: 2029 0a20 2020 2069 6620 7665 7262 6f73   ).    if verbos
+0005fc60: 653a 0a20 2020 2020 2020 2070 7269 6e74  e:.        print
+0005fc70: 2822 7669 7a20 636f 6d70 6c65 7465 2e22  ("viz complete."
+0005fc80: 290a 2020 2020 7265 7475 726e 2076 697a  ).    return viz
+0005fc90: 6c69 7374 0a0a 0a64 6566 2062 6c69 6e64  list...def blind
+0005fca0: 5f69 6d61 6765 5f61 7373 6573 736d 656e  _image_assessmen
+0005fcb0: 7428 0a20 2020 2069 6d61 6765 2c0a 2020  t(.    image,.  
+0005fcc0: 2020 7669 7a5f 6669 6c65 6e61 6d65 3d4e    viz_filename=N
+0005fcd0: 6f6e 652c 0a20 2020 2074 6974 6c65 3d46  one,.    title=F
+0005fce0: 616c 7365 2c0a 2020 2020 7075 6c6c 5f72  alse,.    pull_r
+0005fcf0: 616e 6b3d 4661 6c73 652c 0a20 2020 2072  ank=False,.    r
+0005fd00: 6573 616d 706c 653d 4e6f 6e65 2c0a 2020  esample=None,.  
+0005fd10: 2020 6e5f 746f 5f73 6b69 7020 3d20 3130    n_to_skip = 10
+0005fd20: 2c0a 2020 2020 7665 7262 6f73 653d 4661  ,.    verbose=Fa
+0005fd30: 6c73 650a 293a 0a20 2020 2022 2222 0a20  lse.):.    """. 
+0005fd40: 2020 2071 7569 636b 2062 6c69 6e64 2069     quick blind i
+0005fd50: 6d61 6765 2061 7373 6573 736d 656e 7420  mage assessment 
+0005fd60: 616e 6420 7472 6970 6c61 6e61 7220 7669  and triplanar vi
+0005fd70: 7375 616c 697a 6174 696f 6e20 6f66 2061  sualization of a
+0005fd80: 6e20 696d 6167 6520 2e2e 2e20 3444 2069  n image ... 4D i
+0005fd90: 6e70 7574 2077 696c 6c20 6265 2076 6973  nput will be vis
+0005fda0: 7561 6c69 7a65 6420 616e 6420 6173 7365  ualized and asse
+0005fdb0: 7373 6564 2069 6e20 3344 2e20 2070 726f  ssed in 3D.  pro
+0005fdc0: 6475 6365 7320 6120 706e 6720 616e 6420  duces a png and 
+0005fdd0: 6373 7620 7768 6572 6520 6373 7620 636f  csv where csv co
+0005fde0: 6e74 6169 6e73 3a0a 0a20 2020 202a 2072  ntains:..    * r
+0005fdf0: 6566 6c65 6374 696f 6e20 6572 726f 7220  eflection error 
+0005fe00: 2820 6573 7469 6d61 7465 7320 6173 796d  ( estimates asym
+0005fe10: 6d65 7472 7920 290a 0a20 2020 202a 2062  metry )..    * b
+0005fe20: 7269 7371 2028 2062 6c69 6e64 2071 7561  risq ( blind qua
+0005fe30: 6c69 7479 2061 7373 6573 736d 656e 7420  lity assessment 
+0005fe40: 290a 0a20 2020 202a 2070 6174 6368 2065  )..    * patch e
+0005fe50: 6967 656e 7661 6c75 6520 7261 7469 6f20  igenvalue ratio 
+0005fe60: 2820 626c 696e 6420 7175 616c 6974 7920  ( blind quality 
+0005fe70: 6173 7365 7373 6d65 6e74 2029 0a0a 2020  assessment )..  
+0005fe80: 2020 2a20 5053 4e52 2061 6e64 2053 5349    * PSNR and SSI
+0005fe90: 4d20 7673 2061 2073 6d6f 6f74 6865 6420  M vs a smoothed 
+0005fea0: 7265 6665 7265 6e63 6520 2834 4420 6f72  reference (4D or
+0005feb0: 2033 4420 6170 7072 6f70 7269 6174 6529   3D appropriate)
+0005fec0: 0a0a 2020 2020 2a20 6d61 736b 2076 6f6c  ..    * mask vol
+0005fed0: 756d 6520 2820 6573 7469 6d61 7465 7320  ume ( estimates 
+0005fee0: 666f 7265 6772 6f75 6e64 206f 626a 6563  foreground objec
+0005fef0: 7420 7369 7a65 2029 0a0a 2020 2020 2a20  t size )..    * 
+0005ff00: 7370 6163 696e 670a 0a20 2020 202a 2064  spacing..    * d
+0005ff10: 696d 656e 7369 6f6e 2061 6674 6572 2063  imension after c
+0005ff20: 726f 7070 696e 6720 6279 206d 6173 6b0a  ropping by mask.
+0005ff30: 0a20 2020 2069 6d61 6765 203a 2063 6861  .    image : cha
+0005ff40: 7261 6374 6572 206f 7220 696d 6167 6520  racter or image 
+0005ff50: 6f62 6a65 6374 2075 7375 616c 6c79 2061  object usually a
+0005ff60: 206e 6966 7469 2069 6d61 6765 0a0a 2020   nifti image..  
+0005ff70: 2020 7669 7a5f 6669 6c65 6e61 6d65 203a    viz_filename :
+0005ff80: 2063 6861 7261 6374 6572 2066 6f72 2061   character for a
+0005ff90: 2070 6e67 206f 7574 7075 7420 696d 6167   png output imag
+0005ffa0: 650a 0a20 2020 2074 6974 6c65 203a 2064  e..    title : d
+0005ffb0: 6973 706c 6179 2061 2073 756d 6d61 7279  isplay a summary
+0005ffc0: 2074 6974 6c65 206f 6e20 7468 6520 706e   title on the pn
+0005ffd0: 670a 0a20 2020 2070 756c 6c5f 7261 6e6b  g..    pull_rank
+0005ffe0: 203a 2062 6f6f 6c65 616e 0a0a 2020 2020   : boolean..    
+0005fff0: 7265 7361 6d70 6c65 203a 204e 6f6e 652c  resample : None,
+00060000: 206e 756d 6572 6963 206d 6178 206f 7220   numeric max or 
+00060010: 6d69 6e2c 2072 6573 616d 706c 6573 2069  min, resamples i
+00060020: 6d61 6765 2074 6f20 6973 6f74 726f 7079  mage to isotropy
+00060030: 0a0a 2020 2020 6e5f 746f 5f73 6b69 7020  ..    n_to_skip 
+00060040: 3a20 3130 2062 7920 6465 6661 756c 743b  : 10 by default;
+00060050: 2073 616d 706c 6573 2074 696d 6520 7365   samples time se
+00060060: 7269 6573 2065 7665 7279 206e 5f74 6f5f  ries every n_to_
+00060070: 736b 6970 2076 6f6c 756d 650a 0a20 2020  skip volume..   
+00060080: 2076 6572 626f 7365 203a 2062 6f6f 6c65   verbose : boole
+00060090: 616e 0a0a 2020 2020 2222 220a 2020 2020  an..    """.    
+000600a0: 696d 706f 7274 2067 6c6f 6220 6173 2067  import glob as g
+000600b0: 6c6f 620a 2020 2020 6672 6f6d 206f 732e  lob.    from os.
+000600c0: 7061 7468 2069 6d70 6f72 7420 6578 6973  path import exis
+000600d0: 7473 0a20 2020 2069 6d70 6f72 7420 616e  ts.    import an
+000600e0: 7473 0a20 2020 2069 6d70 6f72 7420 6d61  ts.    import ma
+000600f0: 7470 6c6f 746c 6962 2e70 7970 6c6f 7420  tplotlib.pyplot 
+00060100: 6173 2070 6c74 0a20 2020 2066 726f 6d20  as plt.    from 
+00060110: 5049 4c20 696d 706f 7274 2049 6d61 6765  PIL import Image
+00060120: 0a20 2020 2066 726f 6d20 7061 7468 6c69  .    from pathli
+00060130: 6220 696d 706f 7274 2050 6174 680a 2020  b import Path.  
+00060140: 2020 696d 706f 7274 206a 736f 6e0a 2020    import json.  
+00060150: 2020 696d 706f 7274 2072 650a 2020 2020    import re.    
+00060160: 6672 6f6d 2064 6970 792e 696f 2e67 7261  from dipy.io.gra
+00060170: 6469 656e 7473 2069 6d70 6f72 7420 7265  dients import re
+00060180: 6164 5f62 7661 6c73 5f62 7665 6373 0a20  ad_bvals_bvecs. 
+00060190: 2020 206d 7973 7465 6d3d 2727 0a20 2020     mystem=''.   
+000601a0: 2069 6620 6973 696e 7374 616e 6365 2869   if isinstance(i
+000601b0: 6d61 6765 2c6c 6973 7429 3a0a 2020 2020  mage,list):.    
+000601c0: 2020 2020 6973 6669 6c65 6e61 6d65 3d69      isfilename=i
+000601d0: 7369 6e73 7461 6e63 6528 2069 6d61 6765  sinstance( image
+000601e0: 5b30 5d2c 2073 7472 290a 2020 2020 2020  [0], str).      
+000601f0: 2020 696d 6167 6520 3d20 696d 6167 655b    image = image[
+00060200: 305d 0a20 2020 2065 6c73 653a 0a20 2020  0].    else:.   
+00060210: 2020 2020 2069 7366 696c 656e 616d 653d       isfilename=
+00060220: 6973 696e 7374 616e 6365 2820 696d 6167  isinstance( imag
+00060230: 652c 2073 7472 290a 2020 2020 6f75 7464  e, str).    outd
+00060240: 6620 3d20 7064 2e44 6174 6146 7261 6d65  f = pd.DataFrame
+00060250: 2829 0a20 2020 206d 796d 6574 6120 3d20  ().    mymeta = 
+00060260: 4e6f 6e65 0a20 2020 204d 6167 6e65 7469  None.    Magneti
+00060270: 6346 6965 6c64 5374 7265 6e67 7468 203d  cFieldStrength =
+00060280: 204e 6f6e 650a 2020 2020 696d 6167 655f   None.    image_
+00060290: 6669 6c65 6e61 6d65 3d27 270a 2020 2020  filename=''.    
+000602a0: 6966 2069 7366 696c 656e 616d 653a 0a20  if isfilename:. 
+000602b0: 2020 2020 2020 2069 6d61 6765 5f66 696c         image_fil
+000602c0: 656e 616d 6520 3d20 696d 6167 650a 2020  ename = image.  
+000602d0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+000602e0: 6e63 6528 696d 6167 652c 6c69 7374 293a  nce(image,list):
+000602f0: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
+00060300: 6765 5f66 696c 656e 616d 653d 696d 6167  ge_filename=imag
+00060310: 655b 305d 0a20 2020 2020 2020 206a 736f  e[0].        jso
+00060320: 6e5f 6e61 6d65 203d 2072 652e 7375 6228  n_name = re.sub(
+00060330: 222e 6e69 692e 677a 222c 222e 6a73 6f6e  ".nii.gz",".json
+00060340: 222c 696d 6167 655f 6669 6c65 6e61 6d65  ",image_filename
+00060350: 290a 2020 2020 2020 2020 6966 2065 7869  ).        if exi
+00060360: 7374 7328 206a 736f 6e5f 6e61 6d65 2029  sts( json_name )
+00060370: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+00060380: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00060390: 2020 2077 6974 6820 6f70 656e 286a 736f     with open(jso
+000603a0: 6e5f 6e61 6d65 2c20 2772 2729 2061 7320  n_name, 'r') as 
+000603b0: 6663 635f 6669 6c65 3a0a 2020 2020 2020  fcc_file:.      
+000603c0: 2020 2020 2020 2020 2020 2020 2020 6d79                my
+000603d0: 6d65 7461 203d 206a 736f 6e2e 6c6f 6164  meta = json.load
+000603e0: 2866 6363 5f66 696c 6529 0a20 2020 2020  (fcc_file).     
+000603f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00060400: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+00060410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060420: 2020 2070 7269 6e74 286a 736f 6e2e 6475     print(json.du
+00060430: 6d70 7328 6d79 6d65 7461 2c20 696e 6465  mps(mymeta, inde
+00060440: 6e74 3d34 2929 0a20 2020 2020 2020 2020  nt=4)).         
+00060450: 2020 2020 2020 2020 2020 2066 6363 5f66             fcc_f
+00060460: 696c 652e 636c 6f73 6528 290a 2020 2020  ile.close().    
+00060470: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
+00060480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060490: 7061 7373 0a20 2020 2020 2020 206d 7973  pass.        mys
+000604a0: 7465 6d3d 5061 7468 2820 696d 6167 6520  tem=Path( image 
+000604b0: 292e 7374 656d 0a20 2020 2020 2020 206d  ).stem.        m
+000604c0: 7973 7465 6d3d 5061 7468 2820 6d79 7374  ystem=Path( myst
+000604d0: 656d 2029 2e73 7465 6d0a 2020 2020 2020  em ).stem.      
+000604e0: 2020 696d 6167 655f 7265 6665 7265 6e63    image_referenc
+000604f0: 6520 3d20 616e 7473 2e69 6d61 6765 5f72  e = ants.image_r
+00060500: 6561 6428 2069 6d61 6765 2029 0a20 2020  ead( image ).   
+00060510: 2020 2020 2069 6d61 6765 203d 2061 6e74       image = ant
+00060520: 732e 696d 6167 655f 7265 6164 2820 696d  s.image_read( im
+00060530: 6167 6520 290a 2020 2020 656c 7365 3a0a  age ).    else:.
+00060540: 2020 2020 2020 2020 696d 6167 655f 7265          image_re
+00060550: 6665 7265 6e63 6520 3d20 616e 7473 2e69  ference = ants.i
+00060560: 6d61 6765 5f63 6c6f 6e65 2820 696d 6167  mage_clone( imag
+00060570: 6520 290a 2020 2020 6e74 696d 6570 6f69  e ).    ntimepoi
+00060580: 6e74 7320 3d20 310a 2020 2020 6276 616c  nts = 1.    bval
+00060590: 7565 4d61 783d 4e6f 6e65 0a20 2020 2062  ueMax=None.    b
+000605a0: 7665 636e 6f72 6d3d 4e6f 6e65 0a20 2020  vecnorm=None.   
+000605b0: 2069 6620 696d 6167 655f 7265 6665 7265   if image_refere
+000605c0: 6e63 652e 6469 6d65 6e73 696f 6e20 3d3d  nce.dimension ==
+000605d0: 2034 3a0a 2020 2020 2020 2020 6e74 696d   4:.        ntim
+000605e0: 6570 6f69 6e74 7320 3d20 696d 6167 655f  epoints = image_
+000605f0: 7265 6665 7265 6e63 652e 7368 6170 655b  reference.shape[
+00060600: 335d 0a20 2020 2020 2020 2069 6620 2244  3].        if "D
+00060610: 5449 2220 696e 2069 6d61 6765 5f66 696c  TI" in image_fil
+00060620: 656e 616d 653a 0a20 2020 2020 2020 2020  ename:.         
+00060630: 2020 206d 7954 5373 6567 203d 2073 6567     myTSseg = seg
+00060640: 6d65 6e74 5f74 696d 6573 6572 6965 735f  ment_timeseries_
+00060650: 6279 5f6d 6561 6e76 616c 7565 2820 696d  by_meanvalue( im
+00060660: 6167 655f 7265 6665 7265 6e63 6520 290a  age_reference ).
+00060670: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+00060680: 655f 6230 2c20 696d 6167 655f 6477 6920  e_b0, image_dwi 
+00060690: 3d20 6765 745f 6176 6572 6167 655f 6477  = get_average_dw
+000606a0: 695f 6230 2820 696d 6167 655f 7265 6665  i_b0( image_refe
+000606b0: 7265 6e63 652c 2066 6173 743d 5472 7565  rence, fast=True
+000606c0: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
+000606d0: 6d61 6765 5f62 3020 3d20 616e 7473 2e69  mage_b0 = ants.i
+000606e0: 4d61 7468 2820 696d 6167 655f 6230 2c20  Math( image_b0, 
+000606f0: 274e 6f72 6d61 6c69 7a65 2720 290a 2020  'Normalize' ).  
+00060700: 2020 2020 2020 2020 2020 696d 6167 655f            image_
+00060710: 6477 6920 3d20 616e 7473 2e69 4d61 7468  dwi = ants.iMath
+00060720: 2820 696d 6167 655f 6477 692c 2027 4e6f  ( image_dwi, 'No
+00060730: 726d 616c 697a 6527 2029 0a20 2020 2020  rmalize' ).     
+00060740: 2020 2020 2020 2062 7661 6c5f 6e61 6d65         bval_name
+00060750: 203d 2072 652e 7375 6228 222e 6e69 692e   = re.sub(".nii.
+00060760: 677a 222c 222e 6276 616c 222c 696d 6167  gz",".bval",imag
+00060770: 655f 6669 6c65 6e61 6d65 290a 2020 2020  e_filename).    
+00060780: 2020 2020 2020 2020 6276 6563 5f6e 616d          bvec_nam
+00060790: 6520 3d20 7265 2e73 7562 2822 2e6e 6969  e = re.sub(".nii
+000607a0: 2e67 7a22 2c22 2e62 7665 6322 2c69 6d61  .gz",".bvec",ima
+000607b0: 6765 5f66 696c 656e 616d 6529 0a20 2020  ge_filename).   
+000607c0: 2020 2020 2020 2020 2069 6620 6578 6973           if exis
+000607d0: 7473 2820 6276 616c 5f6e 616d 6520 2920  ts( bval_name ) 
+000607e0: 616e 6420 6578 6973 7473 2820 6276 6563  and exists( bvec
+000607f0: 5f6e 616d 6520 293a 0a20 2020 2020 2020  _name ):.       
+00060800: 2020 2020 2020 2020 2062 7661 6c73 2c20           bvals, 
+00060810: 6276 6563 7320 3d20 7265 6164 5f62 7661  bvecs = read_bva
+00060820: 6c73 5f62 7665 6373 2820 6276 616c 5f6e  ls_bvecs( bval_n
+00060830: 616d 6520 2c20 6276 6563 5f6e 616d 6520  ame , bvec_name 
+00060840: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00060850: 2020 2062 7661 6c75 654d 6178 203d 2062     bvalueMax = b
+00060860: 7661 6c73 2e6d 6178 2829 0a20 2020 2020  vals.max().     
+00060870: 2020 2020 2020 2020 2020 2062 7665 636e             bvecn
+00060880: 6f72 6d20 3d20 6e70 2e6c 696e 616c 672e  orm = np.linalg.
+00060890: 6e6f 726d 2862 7665 6373 2c61 7869 733d  norm(bvecs,axis=
+000608a0: 3129 2e72 6573 6861 7065 2820 6276 6563  1).reshape( bvec
+000608b0: 732e 7368 6170 655b 305d 2c31 2029 0a20  s.shape[0],1 ). 
+000608c0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+000608d0: 7665 636e 6f72 6d20 3d20 6276 6563 6e6f  vecnorm = bvecno
+000608e0: 726d 2e6d 6178 2829 0a20 2020 2020 2020  rm.max().       
+000608f0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00060900: 2020 2069 6d61 6765 5f62 3020 3d20 616e     image_b0 = an
+00060910: 7473 2e67 6574 5f61 7665 7261 6765 5f6f  ts.get_average_o
+00060920: 665f 7469 6d65 7365 7269 6573 2820 696d  f_timeseries( im
+00060930: 6167 655f 7265 6665 7265 6e63 6520 292e  age_reference ).
+00060940: 694d 6174 6828 224e 6f72 6d61 6c69 7a65  iMath("Normalize
+00060950: 2229 0a20 2020 2065 6c73 653a 0a20 2020  ").    else:.   
+00060960: 2020 2020 2069 6d61 6765 5f63 6f6d 7061       image_compa
+00060970: 7265 203d 2061 6e74 732e 736d 6f6f 7468  re = ants.smooth
+00060980: 5f69 6d61 6765 2820 696d 6167 655f 7265  _image( image_re
+00060990: 6665 7265 6e63 652c 2033 2c20 7369 676d  ference, 3, sigm
+000609a0: 615f 696e 5f70 6879 7369 6361 6c5f 636f  a_in_physical_co
+000609b0: 6f72 6469 6e61 7465 733d 4661 6c73 6520  ordinates=False 
+000609c0: 290a 2020 2020 666f 7220 6a6a 6a20 696e  ).    for jjj in
+000609d0: 2072 616e 6765 2830 2c6e 7469 6d65 706f   range(0,ntimepo
+000609e0: 696e 7473 2c6e 5f74 6f5f 736b 6970 293a  ints,n_to_skip):
+000609f0: 0a20 2020 2020 2020 206d 6f64 616c 6974  .        modalit
+00060a00: 793d 2775 6e6b 6e6f 776e 270a 2020 2020  y='unknown'.    
+00060a10: 2020 2020 6966 2022 7273 664d 5249 2220      if "rsfMRI" 
+00060a20: 696e 2069 6d61 6765 5f66 696c 656e 616d  in image_filenam
+00060a30: 653a 0a20 2020 2020 2020 2020 2020 206d  e:.            m
+00060a40: 6f64 616c 6974 793d 2772 7366 4d52 4927  odality='rsfMRI'
+00060a50: 0a20 2020 2020 2020 2065 6c69 6620 2254  .        elif "T
+00060a60: 3177 2220 696e 2069 6d61 6765 5f66 696c  1w" in image_fil
+00060a70: 656e 616d 653a 0a20 2020 2020 2020 2020  ename:.         
+00060a80: 2020 206d 6f64 616c 6974 793d 2754 3177     modality='T1w
+00060a90: 270a 2020 2020 2020 2020 656c 6966 2022  '.        elif "
+00060aa0: 5432 466c 6169 7222 2069 6e20 696d 6167  T2Flair" in imag
+00060ab0: 655f 6669 6c65 6e61 6d65 3a0a 2020 2020  e_filename:.    
+00060ac0: 2020 2020 2020 2020 6d6f 6461 6c69 7479          modality
+00060ad0: 3d27 5432 466c 6169 7227 0a20 2020 2020  ='T2Flair'.     
+00060ae0: 2020 2065 6c69 6620 224e 4d32 444d 5422     elif "NM2DMT"
+00060af0: 2069 6e20 696d 6167 655f 6669 6c65 6e61   in image_filena
+00060b00: 6d65 3a0a 2020 2020 2020 2020 2020 2020  me:.            
+00060b10: 6d6f 6461 6c69 7479 3d27 4e4d 3244 4d54  modality='NM2DMT
+00060b20: 270a 2020 2020 2020 2020 6966 2069 6d61  '.        if ima
+00060b30: 6765 5f72 6566 6572 656e 6365 2e64 696d  ge_reference.dim
+00060b40: 656e 7369 6f6e 203d 3d20 343a 0a20 2020  ension == 4:.   
+00060b50: 2020 2020 2020 2020 2069 6d61 6765 203d           image =
+00060b60: 2061 6e74 732e 736c 6963 655f 696d 6167   ants.slice_imag
+00060b70: 6528 2069 6d61 6765 5f72 6566 6572 656e  e( image_referen
+00060b80: 6365 2c20 6964 783d 696e 7428 6a6a 6a29  ce, idx=int(jjj)
+00060b90: 2c20 6178 6973 3d33 2029 0a20 2020 2020  , axis=3 ).     
+00060ba0: 2020 2020 2020 2069 6620 2244 5449 2220         if "DTI" 
+00060bb0: 696e 2069 6d61 6765 5f66 696c 656e 616d  in image_filenam
+00060bc0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00060bd0: 2020 2069 6620 6a6a 6a20 696e 206d 7954     if jjj in myT
+00060be0: 5373 6567 5b27 6869 6768 6572 6d65 616e  Sseg['highermean
+00060bf0: 7327 5d3a 0a20 2020 2020 2020 2020 2020  s']:.           
+00060c00: 2020 2020 2020 2020 2069 6d61 6765 5f63           image_c
+00060c10: 6f6d 7061 7265 203d 2061 6e74 732e 696d  ompare = ants.im
+00060c20: 6167 655f 636c 6f6e 6528 2069 6d61 6765  age_clone( image
+00060c30: 5f62 3020 290a 2020 2020 2020 2020 2020  _b0 ).          
+00060c40: 2020 2020 2020 2020 2020 6d6f 6461 6c69            modali
+00060c50: 7479 3d27 4454 4962 3027 0a20 2020 2020  ty='DTIb0'.     
+00060c60: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00060c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00060c80: 2020 2020 2069 6d61 6765 5f63 6f6d 7061       image_compa
+00060c90: 7265 203d 2061 6e74 732e 696d 6167 655f  re = ants.image_
+00060ca0: 636c 6f6e 6528 2069 6d61 6765 5f64 7769  clone( image_dwi
+00060cb0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00060cc0: 2020 2020 2020 206d 6f64 616c 6974 793d         modality=
+00060cd0: 2744 5449 6477 6927 0a20 2020 2020 2020  'DTIdwi'.       
+00060ce0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00060cf0: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+00060d00: 5f63 6f6d 7061 7265 203d 2061 6e74 732e  _compare = ants.
+00060d10: 696d 6167 655f 636c 6f6e 6528 2069 6d61  image_clone( ima
+00060d20: 6765 5f62 3020 290a 2020 2020 2020 2020  ge_b0 ).        
+00060d30: 2320 696d 6167 6520 3d20 616e 7473 2e69  # image = ants.i
+00060d40: 4d61 7468 2820 696d 6167 652c 2027 5472  Math( image, 'Tr
+00060d50: 756e 6361 7465 496e 7465 6e73 6974 7927  uncateIntensity'
+00060d60: 2c30 2e30 312c 302e 3939 3529 0a20 2020  ,0.01,0.995).   
+00060d70: 2020 2020 206d 696e 7370 6320 3d20 6e70       minspc = np
+00060d80: 2e6d 696e 2861 6e74 732e 6765 745f 7370  .min(ants.get_sp
+00060d90: 6163 696e 6728 696d 6167 6529 290a 2020  acing(image)).  
+00060da0: 2020 2020 2020 6d61 7873 7063 203d 206e        maxspc = n
+00060db0: 702e 6d61 7828 616e 7473 2e67 6574 5f73  p.max(ants.get_s
+00060dc0: 7061 6369 6e67 2869 6d61 6765 2929 0a20  pacing(image)). 
+00060dd0: 2020 2020 2020 2069 6620 7265 7361 6d70         if resamp
+00060de0: 6c65 2069 7320 6e6f 7420 4e6f 6e65 3a0a  le is not None:.
+00060df0: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+00060e00: 6573 616d 706c 6520 3d3d 2027 6d69 6e27  esample == 'min'
+00060e10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00060e20: 2020 6966 206d 696e 7370 6320 3c20 3165    if minspc < 1e
+00060e30: 2d31 323a 0a20 2020 2020 2020 2020 2020  -12:.           
+00060e40: 2020 2020 2020 2020 206d 696e 7370 6320           minspc 
+00060e50: 3d20 6e70 2e6d 6178 2861 6e74 732e 6765  = np.max(ants.ge
+00060e60: 745f 7370 6163 696e 6728 696d 6167 6529  t_spacing(image)
+00060e70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00060e80: 2020 6e65 7773 7063 203d 206e 702e 7265    newspc = np.re
+00060e90: 7065 6174 2820 6d69 6e73 7063 2c20 3320  peat( minspc, 3 
+00060ea0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00060eb0: 6966 2072 6573 616d 706c 6520 3d3d 2027  if resample == '
+00060ec0: 6d61 7827 3a0a 2020 2020 2020 2020 2020  max':.          
+00060ed0: 2020 2020 2020 6e65 7773 7063 203d 206e        newspc = n
+00060ee0: 702e 7265 7065 6174 2820 6d61 7873 7063  p.repeat( maxspc
+00060ef0: 2c20 3320 290a 2020 2020 2020 2020 2020  , 3 ).          
+00060f00: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00060f10: 2020 2020 2020 2020 6e65 7773 7063 203d          newspc =
+00060f20: 206e 702e 7265 7065 6174 2820 7265 7361   np.repeat( resa
+00060f30: 6d70 6c65 2c20 3320 290a 2020 2020 2020  mple, 3 ).      
+00060f40: 2020 2020 2020 696d 6167 6520 3d20 616e        image = an
+00060f50: 7473 2e72 6573 616d 706c 655f 696d 6167  ts.resample_imag
+00060f60: 6528 2069 6d61 6765 2c20 6e65 7773 7063  e( image, newspc
+00060f70: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
+00060f80: 6d61 6765 5f63 6f6d 7061 7265 203d 2061  mage_compare = a
+00060f90: 6e74 732e 7265 7361 6d70 6c65 5f69 6d61  nts.resample_ima
+00060fa0: 6765 2820 696d 6167 655f 636f 6d70 6172  ge( image_compar
+00060fb0: 652c 206e 6577 7370 6320 290a 2020 2020  e, newspc ).    
+00060fc0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00060fd0: 2020 2020 2020 2320 6368 6563 6b20 666f        # check fo
+00060fe0: 7220 7370 6320 636c 6f73 6520 746f 207a  r spc close to z
+00060ff0: 6572 6f0a 2020 2020 2020 2020 2020 2020  ero.            
+00061000: 7370 6320 3d20 6c69 7374 2861 6e74 732e  spc = list(ants.
+00061010: 6765 745f 7370 6163 696e 6728 696d 6167  get_spacing(imag
+00061020: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
+00061030: 666f 7220 7370 636b 2069 6e20 7261 6e67  for spck in rang
+00061040: 6528 6c65 6e28 7370 6329 293a 0a20 2020  e(len(spc)):.   
+00061050: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00061060: 7370 635b 7370 636b 5d20 3c20 3165 2d31  spc[spck] < 1e-1
+00061070: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
+00061080: 2020 2020 2020 2073 7063 5b73 7063 6b5d         spc[spck]
+00061090: 3d31 0a20 2020 2020 2020 2020 2020 2061  =1.            a
+000610a0: 6e74 732e 7365 745f 7370 6163 696e 6728  nts.set_spacing(
+000610b0: 2069 6d61 6765 2c20 7370 6320 290a 2020   image, spc ).  
+000610c0: 2020 2020 2020 2020 2020 616e 7473 2e73            ants.s
+000610d0: 6574 5f73 7061 6369 6e67 2820 696d 6167  et_spacing( imag
+000610e0: 655f 636f 6d70 6172 652c 2073 7063 2029  e_compare, spc )
+000610f0: 0a20 2020 2020 2020 2023 2069 6620 224e  .        # if "N
+00061100: 4d32 444d 5422 2069 6e20 696d 6167 655f  M2DMT" in image_
+00061110: 6669 6c65 6e61 6d65 206f 7220 2246 4958  filename or "FIX
+00061120: 4d45 2220 696e 2069 6d61 6765 5f66 696c  ME" in image_fil
+00061130: 656e 616d 6520 6f72 2022 5350 4543 5422  ename or "SPECT"
+00061140: 2069 6e20 696d 6167 655f 6669 6c65 6e61   in image_filena
+00061150: 6d65 206f 7220 2255 4e4b 4e4f 574e 2220  me or "UNKNOWN" 
+00061160: 696e 2069 6d61 6765 5f66 696c 656e 616d  in image_filenam
+00061170: 653a 0a20 2020 2020 2020 206d 696e 7370  e:.        minsp
+00061180: 6320 3d20 6e70 2e6d 696e 2861 6e74 732e  c = np.min(ants.
+00061190: 6765 745f 7370 6163 696e 6728 696d 6167  get_spacing(imag
+000611a0: 6529 290a 2020 2020 2020 2020 6d61 7873  e)).        maxs
+000611b0: 7063 203d 206e 702e 6d61 7828 616e 7473  pc = np.max(ants
+000611c0: 2e67 6574 5f73 7061 6369 6e67 2869 6d61  .get_spacing(ima
+000611d0: 6765 2929 0a20 2020 2020 2020 206d 736b  ge)).        msk
+000611e0: 203d 2061 6e74 732e 7468 7265 7368 6f6c   = ants.threshol
+000611f0: 645f 696d 6167 6528 2061 6e74 732e 694d  d_image( ants.iM
+00061200: 6174 6828 696d 6167 652c 274e 6f72 6d61  ath(image,'Norma
+00061210: 6c69 7a65 2729 2c20 302e 3135 2c20 312e  lize'), 0.15, 1.
+00061220: 3020 290a 2020 2020 2020 2020 2320 656c  0 ).        # el
+00061230: 7365 3a0a 2020 2020 2020 2020 2320 2020  se:.        #   
+00061240: 206d 736b 203d 2061 6e74 732e 6765 745f   msk = ants.get_
+00061250: 6d61 736b 2820 696d 6167 6520 290a 2020  mask( image ).  
+00061260: 2020 2020 2020 6d73 6b20 3d20 616e 7473        msk = ants
+00061270: 2e6d 6f72 7068 6f6c 6f67 7928 6d73 6b2c  .morphology(msk,
+00061280: 2022 636c 6f73 6522 2c20 3320 290a 2020   "close", 3 ).  
+00061290: 2020 2020 2020 6267 6d73 6b20 3d20 6d73        bgmsk = ms
+000612a0: 6b2a 302b 312d 6d73 6b0a 2020 2020 2020  k*0+1-msk.      
+000612b0: 2020 6d73 6b64 696c 203d 2061 6e74 732e    mskdil = ants.
+000612c0: 694d 6174 6828 6d73 6b2c 2022 4d44 222c  iMath(msk, "MD",
+000612d0: 2034 2029 0a20 2020 2020 2020 2023 2061   4 ).        # a
+000612e0: 6e74 732e 706c 6f74 5f6f 7274 686f 2820  nts.plot_ortho( 
+000612f0: 696d 6167 652c 206d 736b 2c20 6372 6f70  image, msk, crop
+00061300: 3d46 616c 7365 2029 0a20 2020 2020 2020  =False ).       
+00061310: 206e 766f 7820 3d20 696e 7428 206d 736b   nvox = int( msk
+00061320: 2e73 756d 2829 2029 0a20 2020 2020 2020  .sum() ).       
+00061330: 2073 7063 203d 2061 6e74 732e 6765 745f   spc = ants.get_
+00061340: 7370 6163 696e 6728 2069 6d61 6765 2029  spacing( image )
+00061350: 0a20 2020 2020 2020 206f 7267 203d 2061  .        org = a
+00061360: 6e74 732e 6765 745f 6f72 6967 696e 2820  nts.get_origin( 
+00061370: 696d 6167 6520 290a 2020 2020 2020 2020  image ).        
+00061380: 6966 2028 206e 766f 7820 3e20 3020 293a  if ( nvox > 0 ):
+00061390: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
+000613a0: 6765 203d 2061 6e74 732e 6372 6f70 5f69  ge = ants.crop_i
+000613b0: 6d61 6765 2820 696d 6167 652c 206d 736b  mage( image, msk
+000613c0: 6469 6c20 292e 694d 6174 6828 224e 6f72  dil ).iMath("Nor
+000613d0: 6d61 6c69 7a65 2229 0a20 2020 2020 2020  malize").       
+000613e0: 2020 2020 206d 736b 203d 2061 6e74 732e       msk = ants.
+000613f0: 6372 6f70 5f69 6d61 6765 2820 6d73 6b2c  crop_image( msk,
+00061400: 206d 736b 6469 6c20 292e 694d 6174 6828   mskdil ).iMath(
+00061410: 224e 6f72 6d61 6c69 7a65 2229 0a20 2020  "Normalize").   
+00061420: 2020 2020 2020 2020 2062 676d 736b 203d           bgmsk =
+00061430: 2061 6e74 732e 6372 6f70 5f69 6d61 6765   ants.crop_image
+00061440: 2820 6267 6d73 6b2c 206d 736b 6469 6c20  ( bgmsk, mskdil 
+00061450: 292e 694d 6174 6828 224e 6f72 6d61 6c69  ).iMath("Normali
+00061460: 7a65 2229 0a20 2020 2020 2020 2020 2020  ze").           
+00061470: 2069 6d61 6765 5f63 6f6d 7061 7265 203d   image_compare =
+00061480: 2061 6e74 732e 6372 6f70 5f69 6d61 6765   ants.crop_image
+00061490: 2820 696d 6167 655f 636f 6d70 6172 652c  ( image_compare,
+000614a0: 206d 736b 6469 6c20 292e 694d 6174 6828   mskdil ).iMath(
+000614b0: 224e 6f72 6d61 6c69 7a65 2229 2020 2020  "Normalize")    
+000614c0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+000614d0: 2020 2020 6e70 6174 6368 203d 2069 6e74      npatch = int
+000614e0: 2820 6e70 2e72 6f75 6e64 2820 2030 2e31  ( np.round(  0.1
+000614f0: 202a 206e 766f 7820 2920 290a 2020 2020   * nvox ) ).    
+00061500: 2020 2020 2020 2020 6e70 6174 6368 203d          npatch =
+00061510: 206e 702e 6d69 6e28 2020 5b35 3132 2c6e   np.min(  [512,n
+00061520: 7061 7463 6820 5d20 290a 2020 2020 2020  patch ] ).      
+00061530: 2020 2020 2020 7061 7463 685f 7368 6170        patch_shap
+00061540: 6520 3d20 5b5d 0a20 2020 2020 2020 2020  e = [].         
+00061550: 2020 2066 6f72 206b 2069 6e20 7261 6e67     for k in rang
+00061560: 6528 2033 2029 3a0a 2020 2020 2020 2020  e( 3 ):.        
+00061570: 2020 2020 2020 2020 7020 3d20 696e 7428          p = int(
+00061580: 2033 322e 3020 2f20 616e 7473 2e67 6574   32.0 / ants.get
+00061590: 5f73 7061 6369 6e67 2820 696d 6167 6520  _spacing( image 
+000615a0: 2029 5b6b 5d20 290a 2020 2020 2020 2020   )[k] ).        
+000615b0: 2020 2020 2020 2020 6966 2070 203e 2069          if p > i
+000615c0: 6e74 2820 6e70 2e72 6f75 6e64 2820 696d  nt( np.round( im
+000615d0: 6167 652e 7368 6170 655b 6b5d 202a 2030  age.shape[k] * 0
+000615e0: 2e35 2029 2029 3a0a 2020 2020 2020 2020  .5 ) ):.        
+000615f0: 2020 2020 2020 2020 2020 2020 7020 3d20              p = 
+00061600: 696e 7428 206e 702e 726f 756e 6428 2069  int( np.round( i
+00061610: 6d61 6765 2e73 6861 7065 5b6b 5d20 2a20  mage.shape[k] * 
+00061620: 302e 3520 2920 290a 2020 2020 2020 2020  0.5 ) ).        
+00061630: 2020 2020 2020 2020 7061 7463 685f 7368          patch_sh
+00061640: 6170 652e 6170 7065 6e64 2820 7020 290a  ape.append( p ).
+00061650: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+00061660: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+00061670: 2020 2020 2020 2020 7072 696e 7428 696d          print(im
+00061680: 6167 6529 0a20 2020 2020 2020 2020 2020  age).           
+00061690: 2020 2020 2070 7269 6e74 2820 7061 7463       print( patc
+000616a0: 685f 7368 6170 6520 290a 2020 2020 2020  h_shape ).      
+000616b0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+000616c0: 206e 7061 7463 6820 290a 2020 2020 2020   npatch ).      
+000616d0: 2020 2020 2020 6d79 6576 7220 3d20 6d61        myevr = ma
+000616e0: 7468 2e6e 616e 2023 2064 6f6e 7420 7761  th.nan # dont wa
+000616f0: 6e74 2074 6f20 6661 696c 2069 6620 736f  nt to fail if so
+00061700: 6d65 7468 696e 6720 6f64 6420 6861 7070  mething odd happ
+00061710: 656e 7320 696e 2070 6174 6368 2065 7874  ens in patch ext
+00061720: 7261 6374 696f 6e0a 2020 2020 2020 2020  raction.        
+00061730: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00061740: 2020 2020 2020 2020 206d 7965 7672 203d           myevr =
+00061750: 2061 6e74 7370 7974 3177 2e70 6174 6368   antspyt1w.patch
+00061760: 5f65 6967 656e 7661 6c75 655f 7261 7469  _eigenvalue_rati
+00061770: 6f28 2069 6d61 6765 2c20 6e70 6174 6368  o( image, npatch
+00061780: 2c20 7061 7463 685f 7368 6170 652c 0a20  , patch_shape,. 
+00061790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000617a0: 2020 2065 7664 6570 7468 203d 2030 2e39     evdepth = 0.9
+000617b0: 2c20 6d61 736b 3d6d 736b 2029 0a20 2020  , mask=msk ).   
+000617c0: 2020 2020 2020 2020 2065 7863 6570 743a           except:
+000617d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000617e0: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
+000617f0: 2020 6966 2070 756c 6c5f 7261 6e6b 3a0a    if pull_rank:.
+00061800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061810: 696d 6167 6520 3d20 616e 7473 2e72 616e  image = ants.ran
+00061820: 6b5f 696e 7465 6e73 6974 7928 696d 6167  k_intensity(imag
+00061830: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
+00061840: 6d61 6765 7265 666c 6563 7420 3d20 616e  magereflect = an
+00061850: 7473 2e72 6566 6c65 6374 5f69 6d61 6765  ts.reflect_image
+00061860: 2869 6d61 6765 2c20 6178 6973 3d30 290a  (image, axis=0).
+00061870: 2020 2020 2020 2020 2020 2020 6173 796d              asym
+00061880: 5f65 7272 203d 2028 2069 6d61 6765 202d  _err = ( image -
+00061890: 2069 6d61 6765 7265 666c 6563 7420 292e   imagereflect ).
+000618a0: 6162 7328 292e 6d65 616e 2829 0a20 2020  abs().mean().   
+000618b0: 2020 2020 2020 2020 2023 2065 7374 696d           # estim
+000618c0: 6174 6520 6e6f 6973 6520 6279 2063 656e  ate noise by cen
+000618d0: 7465 7220 6372 6f70 7069 6e67 2c20 6465  ter cropping, de
+000618e0: 6e6f 697a 696e 6720 616e 6420 7461 6b69  noizing and taki
+000618f0: 6e67 206d 6167 6e69 7475 6465 206f 6620  ng magnitude of 
+00061900: 6469 6666 6572 656e 6365 0a20 2020 2020  difference.     
+00061910: 2020 2020 2020 206e 6f63 726f 703d 4661         nocrop=Fa
+00061920: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+00061930: 6966 2069 6d61 6765 2e64 696d 656e 7369  if image.dimensi
+00061940: 6f6e 203d 3d20 333a 0a20 2020 2020 2020  on == 3:.       
+00061950: 2020 2020 2020 2020 2069 6620 696d 6167           if imag
+00061960: 652e 7368 6170 655b 325d 203d 3d20 313a  e.shape[2] == 1:
+00061970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00061980: 2020 2020 206e 6f63 726f 703d 5472 7565       nocrop=True
+00061990: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+000619a0: 2020 2020 2069 6620 6d61 7873 7063 2f6d       if maxspc/m
+000619b0: 696e 7370 6320 3e20 3130 3a0a 2020 2020  inspc > 10:.    
+000619c0: 2020 2020 2020 2020 2020 2020 6e6f 6372              nocr
+000619d0: 6f70 3d54 7275 650a 2020 2020 2020 2020  op=True.        
+000619e0: 2020 2020 6966 206e 6f63 726f 703a 0a20      if nocrop:. 
+000619f0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00061a00: 7963 6320 3d20 616e 7473 2e69 6d61 6765  ycc = ants.image
+00061a10: 5f63 6c6f 6e65 2820 696d 6167 6520 290a  _clone( image ).
+00061a20: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00061a30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00061a40: 2020 6d79 6363 203d 2061 6e74 7370 7974    mycc = antspyt
+00061a50: 3177 2e73 7065 6369 616c 5f63 726f 7028  1w.special_crop(
+00061a60: 2069 6d61 6765 2c0a 2020 2020 2020 2020   image,.        
+00061a70: 2020 2020 2020 2020 2020 2020 616e 7473              ants
+00061a80: 2e67 6574 5f63 656e 7465 725f 6f66 5f6d  .get_center_of_m
+00061a90: 6173 7328 206d 736b 202a 3020 2b20 3120  ass( msk *0 + 1 
+00061aa0: 292c 2070 6174 6368 5f73 6861 7065 2029  ), patch_shape )
+00061ab0: 0a20 2020 2020 2020 2020 2020 206d 7963  .            myc
+00061ac0: 6364 203d 2061 6e74 732e 6465 6e6f 6973  cd = ants.denois
+00061ad0: 655f 696d 6167 6528 206d 7963 632c 2070  e_image( mycc, p
+00061ae0: 3d32 2c72 3d32 2c6e 6f69 7365 5f6d 6f64  =2,r=2,noise_mod
+00061af0: 656c 3d27 4761 7573 7369 616e 2720 290a  el='Gaussian' ).
+00061b00: 2020 2020 2020 2020 2020 2020 6e6f 697a              noiz
+00061b10: 6c65 7665 6c20 3d20 2820 6d79 6363 202d  level = ( mycc -
+00061b20: 206d 7963 6364 2029 2e61 6273 2829 2e6d   myccd ).abs().m
+00061b30: 6561 6e28 290a 2020 2020 2320 2020 2020  ean().    #     
+00061b40: 2020 2061 6e74 732e 706c 6f74 5f6f 7274     ants.plot_ort
+00061b50: 686f 2820 696d 6167 652c 2063 726f 703d  ho( image, crop=
+00061b60: 4661 6c73 652c 2066 696c 656e 616d 653d  False, filename=
+00061b70: 7669 7a5f 6669 6c65 6e61 6d65 2c20 666c  viz_filename, fl
+00061b80: 6174 3d54 7275 652c 2078 797a 5f6c 696e  at=True, xyz_lin
+00061b90: 6573 3d46 616c 7365 2c20 6f72 6965 6e74  es=False, orient
+00061ba0: 5f6c 6162 656c 733d 4661 6c73 652c 2078  _labels=False, x
+00061bb0: 797a 5f70 6164 3d30 2029 0a20 2020 2023  yz_pad=0 ).    #
+00061bc0: 2020 2020 2020 2020 6672 6f6d 2062 7269          from bri
+00061bd0: 7371 7565 2069 6d70 6f72 7420 4252 4953  sque import BRIS
+00061be0: 5155 450a 2020 2020 2320 2020 2020 2020  QUE.    #       
+00061bf0: 206f 626a 203d 2042 5249 5351 5545 2875   obj = BRISQUE(u
+00061c00: 726c 3d46 616c 7365 290a 2020 2020 2320  rl=False).    # 
+00061c10: 2020 2020 2020 206d 7962 7269 7371 203d         mybrisq =
+00061c20: 206f 626a 2e73 636f 7265 2820 6e70 2e61   obj.score( np.a
+00061c30: 7272 6179 2820 496d 6167 652e 6f70 656e  rray( Image.open
+00061c40: 2820 7669 7a5f 6669 6c65 6e61 6d65 2029  ( viz_filename )
+00061c50: 2920 290a 2020 2020 2020 2020 2020 2020  ) ).            
+00061c60: 6d73 6b5f 766f 6c20 3d20 6d73 6b2e 7375  msk_vol = msk.su
+00061c70: 6d28 2920 2a20 6e70 2e70 726f 6428 2073  m() * np.prod( s
+00061c80: 7063 2029 0a20 2020 2020 2020 2020 2020  pc ).           
+00061c90: 2062 6773 7464 203d 2069 6d61 6765 5b20   bgstd = image[ 
+00061ca0: 6267 6d73 6b20 3d3d 2031 205d 2e73 7464  bgmsk == 1 ].std
+00061cb0: 2829 0a20 2020 2020 2020 2020 2020 2066  ().            f
+00061cc0: 676d 6561 6e20 3d20 696d 6167 655b 206d  gmean = image[ m
+00061cd0: 736b 203d 3d20 3120 5d2e 6d65 616e 2829  sk == 1 ].mean()
+00061ce0: 0a20 2020 2020 2020 2020 2020 2062 676d  .            bgm
+00061cf0: 6561 6e20 3d20 696d 6167 655b 2062 676d  ean = image[ bgm
+00061d00: 736b 203d 3d20 3120 5d2e 6d65 616e 2829  sk == 1 ].mean()
+00061d10: 0a20 2020 2020 2020 2020 2020 2073 6e72  .            snr
+00061d20: 7265 6620 3d20 6667 6d65 616e 202f 2062  ref = fgmean / b
+00061d30: 6773 7464 0a20 2020 2020 2020 2020 2020  gstd.           
+00061d40: 2063 6e72 7265 6620 3d20 2820 6667 6d65   cnrref = ( fgme
+00061d50: 616e 202d 2062 676d 6561 6e20 2920 2f20  an - bgmean ) / 
+00061d60: 6267 7374 640a 2020 2020 2020 2020 2020  bgstd.          
+00061d70: 2020 7073 6e72 7265 6620 3d20 616e 7473    psnrref = ants
+00061d80: 7079 6e65 742e 7073 6e72 2820 2069 6d61  pynet.psnr(  ima
+00061d90: 6765 5f63 6f6d 7061 7265 2c20 696d 6167  ge_compare, imag
+00061da0: 6520 2029 0a20 2020 2020 2020 2020 2020  e  ).           
+00061db0: 2073 7369 6d72 6566 203d 2061 6e74 7370   ssimref = antsp
+00061dc0: 796e 6574 2e73 7369 6d28 2020 696d 6167  ynet.ssim(  imag
+00061dd0: 655f 636f 6d70 6172 652c 2069 6d61 6765  e_compare, image
+00061de0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00061df0: 6966 206e 6f63 726f 703a 0a20 2020 2020  if nocrop:.     
+00061e00: 2020 2020 2020 2020 2020 206d 796d 6920             mymi 
+00061e10: 3d20 6d61 7468 2e69 6e66 0a20 2020 2020  = math.inf.     
+00061e20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00061e30: 2020 2020 2020 2020 2020 2020 206d 796d               mym
+00061e40: 6920 3d20 616e 7473 2e69 6d61 6765 5f6d  i = ants.image_m
+00061e50: 7574 7561 6c5f 696e 666f 726d 6174 696f  utual_informatio
+00061e60: 6e28 2069 6d61 6765 5f63 6f6d 7061 7265  n( image_compare
+00061e70: 2c20 696d 6167 6520 290a 2020 2020 2020  , image ).      
+00061e80: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00061e90: 2020 2020 6d73 6b5f 766f 6c20 3d20 300a      msk_vol = 0.
+00061ea0: 2020 2020 2020 2020 2020 2020 6d79 6576              myev
+00061eb0: 7220 3d20 6d79 6d69 203d 2073 7369 6d72  r = mymi = ssimr
+00061ec0: 6566 203d 2070 736e 7272 6566 203d 2063  ef = psnrref = c
+00061ed0: 6e72 7265 6620 3d20 6173 796d 5f65 7272  nrref = asym_err
+00061ee0: 203d 206e 6f69 7a6c 6576 656c 203d 206d   = noizlevel = m
+00061ef0: 6174 682e 6e61 6e0a 2020 2020 2020 2020  ath.nan.        
+00061f00: 2020 2020 0a20 2020 2020 2020 206d 7269      .        mri
+00061f10: 7365 7269 6573 3d4e 6f6e 650a 2020 2020  series=None.    
+00061f20: 2020 2020 6d72 696d 6667 3d4e 6f6e 650a      mrimfg=None.
+00061f30: 2020 2020 2020 2020 6d72 696d 6f64 656c          mrimodel
+00061f40: 3d4e 6f6e 650a 2020 2020 2020 2020 6d72  =None.        mr
+00061f50: 6953 4152 3d4e 6f6e 650a 2020 2020 2020  iSAR=None.      
+00061f60: 2020 4261 6e64 7769 6474 6850 6572 5069    BandwidthPerPi
+00061f70: 7865 6c50 6861 7365 456e 636f 6465 3d4e  xelPhaseEncode=N
+00061f80: 6f6e 650a 2020 2020 2020 2020 5069 7865  one.        Pixe
+00061f90: 6c42 616e 6477 6964 7468 3d4e 6f6e 650a  lBandwidth=None.
+00061fa0: 2020 2020 2020 2020 6966 206d 796d 6574          if mymet
+00061fb0: 6120 6973 206e 6f74 204e 6f6e 653a 0a20  a is not None:. 
+00061fc0: 2020 2020 2020 2020 2020 2023 206d 7269             # mri
+00061fd0: 7365 7269 6573 3d6d 796d 6574 615b 2727  series=mymeta[''
+00061fe0: 5d0a 2020 2020 2020 2020 2020 2020 7472  ].            tr
+00061ff0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00062000: 2020 206d 7269 6d66 673d 6d79 6d65 7461     mrimfg=mymeta
+00062010: 5b27 4d61 6e75 6661 6374 7572 6572 275d  ['Manufacturer']
+00062020: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00062030: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
+00062040: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
+00062050: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00062060: 2020 2020 2020 2020 2020 206d 7269 6d6f             mrimo
+00062070: 6465 6c3d 6d79 6d65 7461 5b27 4d61 6e75  del=mymeta['Manu
+00062080: 6661 6374 7572 6572 734d 6f64 656c 4e61  facturersModelNa
+00062090: 6d65 275d 0a20 2020 2020 2020 2020 2020  me'].           
+000620a0: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
+000620b0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+000620c0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+000620d0: 2020 2020 2020 2020 2020 2020 2020 204d                 M
+000620e0: 6167 6e65 7469 6346 6965 6c64 5374 7265  agneticFieldStre
+000620f0: 6e67 7468 3d6d 796d 6574 615b 274d 6167  ngth=mymeta['Mag
+00062100: 6e65 7469 6346 6965 6c64 5374 7265 6e67  neticFieldStreng
+00062110: 7468 275d 0a20 2020 2020 2020 2020 2020  th'].           
+00062120: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
+00062130: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+00062140: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00062150: 2020 2020 2020 2020 2020 2020 2020 2050                 P
+00062160: 6978 656c 4261 6e64 7769 6474 683d 6d79  ixelBandwidth=my
+00062170: 6d65 7461 5b27 5069 7865 6c42 616e 6477  meta['PixelBandw
+00062180: 6964 7468 275d 0a20 2020 2020 2020 2020  idth'].         
+00062190: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+000621a0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+000621b0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+000621c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000621d0: 2042 616e 6477 6964 7468 5065 7250 6978   BandwidthPerPix
+000621e0: 656c 5068 6173 6545 6e63 6f64 653d 6d79  elPhaseEncode=my
+000621f0: 6d65 7461 5b27 4261 6e64 7769 6474 6850  meta['BandwidthP
+00062200: 6572 5069 7865 6c50 6861 7365 456e 636f  erPixelPhaseEnco
+00062210: 6465 275d 0a20 2020 2020 2020 2020 2020  de'].           
+00062220: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
+00062230: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+00062240: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00062250: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00062260: 7269 5341 523d 6d79 6d65 7461 5b27 5341  riSAR=mymeta['SA
+00062270: 5227 5d0a 2020 2020 2020 2020 2020 2020  R'].            
+00062280: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
+00062290: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
+000622a0: 2020 2020 2074 746c 3d6d 7973 7465 6d20       ttl=mystem 
+000622b0: 2b20 2720 270a 2020 2020 2020 2020 7474  + ' '.        tt
+000622c0: 6c3d 2727 0a20 2020 2020 2020 2074 746c  l=''.        ttl
+000622d0: 3d74 746c 202b 2022 4e5a 3a20 2220 2b20  =ttl + "NZ: " + 
+000622e0: 227b 3a30 2e34 667d 222e 666f 726d 6174  "{:0.4f}".format
+000622f0: 286e 6f69 7a6c 6576 656c 2920 2b20 2220  (noizlevel) + " 
+00062300: 534e 523a 2022 202b 2022 7b3a 302e 3466  SNR: " + "{:0.4f
+00062310: 7d22 2e66 6f72 6d61 7428 736e 7272 6566  }".format(snrref
+00062320: 2920 2b20 2220 434e 523a 2022 202b 2022  ) + " CNR: " + "
+00062330: 7b3a 302e 3466 7d22 2e66 6f72 6d61 7428  {:0.4f}".format(
+00062340: 636e 7272 6566 2920 2b20 2220 5053 3a20  cnrref) + " PS: 
+00062350: 2220 2b20 227b 3a30 2e34 667d 222e 666f  " + "{:0.4f}".fo
+00062360: 726d 6174 2870 736e 7272 6566 292b 2022  rmat(psnrref)+ "
+00062370: 2053 533a 2022 202b 2022 7b3a 302e 3466   SS: " + "{:0.4f
+00062380: 7d22 2e66 6f72 6d61 7428 7373 696d 7265  }".format(ssimre
+00062390: 6629 202b 2022 2045 5652 3a20 2220 2b20  f) + " EVR: " + 
+000623a0: 227b 3a30 2e34 667d 222e 666f 726d 6174  "{:0.4f}".format
+000623b0: 286d 7965 7672 292b 2022 204d 493a 2022  (myevr)+ " MI: "
+000623c0: 202b 2022 7b3a 302e 3466 7d22 2e66 6f72   + "{:0.4f}".for
+000623d0: 6d61 7428 6d79 6d69 290a 2020 2020 2020  mat(mymi).      
+000623e0: 2020 6966 2076 697a 5f66 696c 656e 616d    if viz_filenam
+000623f0: 6520 6973 206e 6f74 204e 6f6e 6520 616e  e is not None an
+00062400: 6420 2820 6a6a 6a20 3d3d 2030 206f 7220  d ( jjj == 0 or 
+00062410: 286a 6a6a 2025 2033 3020 3d3d 2030 2920  (jjj % 30 == 0) 
+00062420: 2920 616e 6420 696d 6167 652e 7368 6170  ) and image.shap
+00062430: 655b 325d 203c 2036 3835 3a0a 2020 2020  e[2] < 685:.    
+00062440: 2020 2020 2020 2020 7669 7a5f 6669 6c65          viz_file
+00062450: 6e61 6d65 5f75 7365 203d 2072 652e 7375  name_use = re.su
+00062460: 6228 2022 2e70 6e67 222c 2022 5f73 6c69  b( ".png", "_sli
+00062470: 6365 222b 7374 7228 6a6a 6a29 2e7a 6669  ce"+str(jjj).zfi
+00062480: 6c6c 2834 292b 222e 706e 6722 2c20 7669  ll(4)+".png", vi
+00062490: 7a5f 6669 6c65 6e61 6d65 2029 0a20 2020  z_filename ).   
+000624a0: 2020 2020 2020 2020 2061 6e74 732e 706c           ants.pl
+000624b0: 6f74 5f6f 7274 686f 2820 696d 6167 652c  ot_ortho( image,
+000624c0: 2063 726f 703d 4661 6c73 652c 2066 696c   crop=False, fil
+000624d0: 656e 616d 653d 7669 7a5f 6669 6c65 6e61  ename=viz_filena
+000624e0: 6d65 5f75 7365 2c20 666c 6174 3d54 7275  me_use, flat=Tru
+000624f0: 652c 2078 797a 5f6c 696e 6573 3d46 616c  e, xyz_lines=Fal
+00062500: 7365 2c20 6f72 6965 6e74 5f6c 6162 656c  se, orient_label
+00062510: 733d 4661 6c73 652c 2078 797a 5f70 6164  s=False, xyz_pad
+00062520: 3d30 2c20 2074 6974 6c65 3d74 746c 2c20  =0,  title=ttl, 
+00062530: 7469 746c 6566 6f6e 7473 697a 653d 3132  titlefontsize=12
+00062540: 2c20 7469 746c 655f 6479 3d2d 302e 3032  , title_dy=-0.02
+00062550: 2c74 6578 7466 6f6e 7463 6f6c 6f72 3d27  ,textfontcolor='
+00062560: 7265 6427 2029 0a20 2020 2020 2020 2064  red' ).        d
+00062570: 6620 3d20 7064 2e44 6174 6146 7261 6d65  f = pd.DataFrame
+00062580: 285b 5b20 0a20 2020 2020 2020 2020 2020  ([[ .           
+00062590: 206d 7973 7465 6d2c 200a 2020 2020 2020   mystem, .      
+000625a0: 2020 2020 2020 696d 6167 655f 7265 6665        image_refe
+000625b0: 7265 6e63 652e 6469 6d65 6e73 696f 6e2c  rence.dimension,
+000625c0: 200a 2020 2020 2020 2020 2020 2020 6e6f   .            no
+000625d0: 697a 6c65 7665 6c2c 2073 6e72 7265 662c  izlevel, snrref,
+000625e0: 2063 6e72 7265 662c 2070 736e 7272 6566   cnrref, psnrref
+000625f0: 2c20 7373 696d 7265 662c 206d 796d 692c  , ssimref, mymi,
+00062600: 2061 7379 6d5f 6572 722c 206d 7965 7672   asym_err, myevr
+00062610: 2c20 6d73 6b5f 766f 6c2c 200a 2020 2020  , msk_vol, .    
+00062620: 2020 2020 2020 2020 7370 635b 305d 2c20          spc[0], 
+00062630: 7370 635b 315d 2c20 7370 635b 325d 2c6f  spc[1], spc[2],o
+00062640: 7267 5b30 5d2c 206f 7267 5b31 5d2c 206f  rg[0], org[1], o
+00062650: 7267 5b32 5d2c 200a 2020 2020 2020 2020  rg[2], .        
+00062660: 2020 2020 696d 6167 652e 7368 6170 655b      image.shape[
+00062670: 305d 2c20 696d 6167 652e 7368 6170 655b  0], image.shape[
+00062680: 315d 2c20 696d 6167 652e 7368 6170 655b  1], image.shape[
+00062690: 325d 2c20 6e74 696d 6570 6f69 6e74 732c  2], ntimepoints,
+000626a0: 200a 2020 2020 2020 2020 2020 2020 6a6a   .            jj
+000626b0: 6a2c 206d 6f64 616c 6974 792c 206d 7269  j, modality, mri
+000626c0: 7365 7269 6573 2c20 6d72 696d 6667 2c20  series, mrimfg, 
+000626d0: 6d72 696d 6f64 656c 2c20 4d61 676e 6574  mrimodel, Magnet
+000626e0: 6963 4669 656c 6453 7472 656e 6774 682c  icFieldStrength,
+000626f0: 206d 7269 5341 522c 2050 6978 656c 4261   mriSAR, PixelBa
+00062700: 6e64 7769 6474 682c 2042 616e 6477 6964  ndwidth, Bandwid
+00062710: 7468 5065 7250 6978 656c 5068 6173 6545  thPerPixelPhaseE
+00062720: 6e63 6f64 652c 2062 7661 6c75 654d 6178  ncode, bvalueMax
+00062730: 2c20 6276 6563 6e6f 726d 205d 5d2c 200a  , bvecnorm ]], .
+00062740: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
+00062750: 6d6e 733d 5b0a 2020 2020 2020 2020 2020  mns=[.          
+00062760: 2020 2020 2020 2766 696c 656e 616d 6527        'filename'
+00062770: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+00062780: 2020 2027 6469 6d65 6e73 696f 6e61 6c69     'dimensionali
+00062790: 7479 272c 0a20 2020 2020 2020 2020 2020  ty',.           
+000627a0: 2020 2020 2027 6e6f 6973 6527 2c20 2773       'noise', 's
+000627b0: 6e72 272c 2027 636e 7227 2c20 2770 736e  nr', 'cnr', 'psn
+000627c0: 7227 2c20 2773 7369 6d27 2c20 276d 6927  r', 'ssim', 'mi'
+000627d0: 2c20 2772 6566 6c65 6374 696f 6e5f 6572  , 'reflection_er
+000627e0: 7227 2c20 2745 5652 272c 2027 6d73 6b5f  r', 'EVR', 'msk_
+000627f0: 766f 6c27 2c20 2773 7063 3027 2c27 7370  vol', 'spc0','sp
+00062800: 6331 272c 2773 7063 3227 2c27 6f72 6730  c1','spc2','org0
+00062810: 272c 276f 7267 3127 2c27 6f72 6732 272c  ','org1','org2',
+00062820: 2764 696d 7827 2c27 6469 6d79 272c 2764  'dimx','dimy','d
+00062830: 696d 7a27 2c27 6469 6d74 272c 2773 6c69  imz','dimt','sli
+00062840: 6365 272c 276d 6f64 616c 6974 7927 2c20  ce','modality', 
+00062850: 276d 7269 7365 7269 6573 272c 2027 6d72  'mriseries', 'mr
+00062860: 696d 6667 272c 2027 6d72 696d 6f64 656c  imfg', 'mrimodel
+00062870: 272c 2027 6d72 694d 6167 6e65 7469 6346  ', 'mriMagneticF
+00062880: 6965 6c64 5374 7265 6e67 7468 272c 2027  ieldStrength', '
+00062890: 6d72 6953 4152 272c 2027 6d72 6950 6978  mriSAR', 'mriPix
+000628a0: 656c 4261 6e64 7769 6474 6827 2c20 276d  elBandwidth', 'm
+000628b0: 7269 5069 7865 6c42 616e 6477 6964 7468  riPixelBandwidth
+000628c0: 5045 272c 2027 6474 695f 6276 616c 7565  PE', 'dti_bvalue
+000628d0: 4d61 7827 2c20 2764 7469 5f62 7665 636e  Max', 'dti_bvecn
+000628e0: 6f72 6d27 205d 290a 2020 2020 2020 2020  orm' ]).        
+000628f0: 6f75 7464 6620 3d20 7064 2e63 6f6e 6361  outdf = pd.conca
+00062900: 7428 205b 6f75 7464 662c 2064 6620 5d2c  t( [outdf, df ],
+00062910: 2061 7869 733d 302c 2069 676e 6f72 655f   axis=0, ignore_
+00062920: 696e 6465 783d 4661 6c73 6520 290a 2020  index=False ).  
+00062930: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
+00062940: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+00062950: 696e 7428 206f 7574 6466 2029 0a20 2020  int( outdf ).   
+00062960: 2069 6620 7669 7a5f 6669 6c65 6e61 6d65   if viz_filename
+00062970: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00062980: 2020 2020 2020 6373 7666 6e20 3d20 7265        csvfn = re
+00062990: 2e73 7562 2820 2270 6e67 222c 2022 6373  .sub( "png", "cs
+000629a0: 7622 2c20 7669 7a5f 6669 6c65 6e61 6d65  v", viz_filename
+000629b0: 2029 0a20 2020 2020 2020 206f 7574 6466   ).        outdf
+000629c0: 2e74 6f5f 6373 7628 2063 7376 666e 2029  .to_csv( csvfn )
+000629d0: 0a20 2020 2072 6574 7572 6e20 6f75 7464  .    return outd
+000629e0: 660a 0a64 6566 2072 656d 6f76 655f 756e  f..def remove_un
+000629f0: 7761 6e74 6564 5f63 6f6c 756d 6e73 2864  wanted_columns(d
+00062a00: 6629 3a0a 2020 2020 2320 4964 656e 7469  f):.    # Identi
+00062a10: 6679 2063 6f6c 756d 6e73 2074 6f20 6472  fy columns to dr
+00062a20: 6f70 3a20 7468 6f73 6520 6e61 6d65 6420  op: those named 
+00062a30: 2758 2720 6f72 2073 7461 7274 696e 6720  'X' or starting 
+00062a40: 7769 7468 2027 556e 6e61 6d65 6427 0a20  with 'Unnamed'. 
+00062a50: 2020 2063 6f6c 735f 746f 5f64 726f 7020     cols_to_drop 
+00062a60: 3d20 5b63 6f6c 2066 6f72 2063 6f6c 2069  = [col for col i
+00062a70: 6e20 6466 2e63 6f6c 756d 6e73 2069 6620  n df.columns if 
+00062a80: 636f 6c20 3d3d 2027 5827 206f 7220 636f  col == 'X' or co
+00062a90: 6c2e 7374 6172 7473 7769 7468 2827 556e  l.startswith('Un
+00062aa0: 6e61 6d65 6427 295d 0a20 2020 200a 2020  named')].    .  
+00062ab0: 2020 2320 4472 6f70 2074 6865 2069 6465    # Drop the ide
+00062ac0: 6e74 6966 6965 6420 636f 6c75 6d6e 7320  ntified columns 
+00062ad0: 6672 6f6d 2074 6865 2044 6174 6146 7261  from the DataFra
+00062ae0: 6d65 2c20 6966 2061 6e79 0a20 2020 2064  me, if any.    d
+00062af0: 665f 636c 6561 6e65 6420 3d20 6466 2e64  f_cleaned = df.d
+00062b00: 726f 7028 636f 6c75 6d6e 733d 636f 6c73  rop(columns=cols
+00062b10: 5f74 6f5f 6472 6f70 2c20 6572 726f 7273  _to_drop, errors
+00062b20: 3d27 6967 6e6f 7265 2729 0a20 2020 200a  ='ignore').    .
+00062b30: 2020 2020 7265 7475 726e 2064 665f 636c      return df_cl
+00062b40: 6561 6e65 640a 0a64 6566 2070 726f 6365  eaned..def proce
+00062b50: 7373 5f64 6174 6166 7261 6d65 5f67 656e  ss_dataframe_gen
+00062b60: 6572 616c 697a 6564 2864 662c 2067 726f  eralized(df, gro
+00062b70: 7570 5f62 795f 636f 6c75 6d6e 293a 0a20  up_by_column):. 
+00062b80: 2020 2023 204d 616b 6520 7375 7265 2074     # Make sure t
+00062b90: 6865 2067 726f 7570 5f62 795f 636f 6c75  he group_by_colu
+00062ba0: 6d6e 2069 7320 6578 636c 7564 6564 2066  mn is excluded f
+00062bb0: 726f 6d20 626f 7468 206e 756d 6572 6963  rom both numeric
+00062bc0: 2061 6e64 206f 7468 6572 2063 6f6c 756d   and other colum
+00062bd0: 6e73 2063 616c 6375 6c61 7469 6f6e 730a  ns calculations.
+00062be0: 2020 2020 6e75 6d65 7269 635f 636f 6c73      numeric_cols
+00062bf0: 203d 2064 662e 7365 6c65 6374 5f64 7479   = df.select_dty
+00062c00: 7065 7328 696e 636c 7564 653d 276e 756d  pes(include='num
+00062c10: 6265 7227 292e 636f 6c75 6d6e 732e 6469  ber').columns.di
+00062c20: 6666 6572 656e 6365 285b 6772 6f75 705f  fference([group_
+00062c30: 6279 5f63 6f6c 756d 6e5d 290a 2020 2020  by_column]).    
+00062c40: 6f74 6865 725f 636f 6c73 203d 2064 662e  other_cols = df.
+00062c50: 636f 6c75 6d6e 732e 6469 6666 6572 656e  columns.differen
+00062c60: 6365 286e 756d 6572 6963 5f63 6f6c 7329  ce(numeric_cols)
+00062c70: 2e64 6966 6665 7265 6e63 6528 5b67 726f  .difference([gro
+00062c80: 7570 5f62 795f 636f 6c75 6d6e 5d29 0a20  up_by_column]). 
+00062c90: 2020 200a 2020 2020 2320 4465 6669 6e65     .    # Define
+00062ca0: 2061 6767 7265 6761 7469 6f6e 2066 756e   aggregation fun
+00062cb0: 6374 696f 6e73 3a20 6d65 616e 2066 6f72  ctions: mean for
+00062cc0: 206e 756d 6572 6963 2063 6f6c 732c 206d   numeric cols, m
+00062cd0: 6f64 6520 666f 7220 6f74 6865 7220 636f  ode for other co
+00062ce0: 6c73 0a20 2020 2023 2055 7064 6174 6520  ls.    # Update 
+00062cf0: 746f 2068 616e 646c 6520 656d 7074 7920  to handle empty 
+00062d00: 6d6f 6465 2072 6573 756c 7473 2073 6166  mode results saf
+00062d10: 656c 790a 2020 2020 6167 675f 6469 6374  ely.    agg_dict
+00062d20: 203d 207b 636f 6c3a 2027 6d65 616e 2720   = {col: 'mean' 
+00062d30: 666f 7220 636f 6c20 696e 206e 756d 6572  for col in numer
+00062d40: 6963 5f63 6f6c 737d 0a20 2020 2061 6767  ic_cols}.    agg
+00062d50: 5f64 6963 742e 7570 6461 7465 287b 0a20  _dict.update({. 
+00062d60: 2020 2020 2020 2063 6f6c 3a20 6c61 6d62         col: lamb
+00062d70: 6461 2078 3a20 7064 2e53 6572 6965 732e  da x: pd.Series.
+00062d80: 6d6f 6465 2878 292e 696c 6f63 5b30 5d20  mode(x).iloc[0] 
+00062d90: 6966 206e 6f74 2070 642e 5365 7269 6573  if not pd.Series
+00062da0: 2e6d 6f64 6528 7829 2e65 6d70 7479 2065  .mode(x).empty e
+00062db0: 6c73 6520 4e6f 6e65 2066 6f72 2063 6f6c  lse None for col
+00062dc0: 2069 6e20 6f74 6865 725f 636f 6c73 0a20   in other_cols. 
+00062dd0: 2020 207d 2920 2020 200a 2020 2020 2320     })    .    # 
+00062de0: 4772 6f75 7020 6279 2074 6865 2073 7065  Group by the spe
+00062df0: 6369 6669 6564 2063 6f6c 756d 6e2c 2061  cified column, a
+00062e00: 7070 6c79 696e 6720 6469 6666 6572 656e  pplying differen
+00062e10: 7420 6167 6772 6567 6174 696f 6e20 6675  t aggregation fu
+00062e20: 6e63 7469 6f6e 7320 746f 2064 6966 6665  nctions to diffe
+00062e30: 7265 6e74 2063 6f6c 756d 6e73 0a20 2020  rent columns.   
+00062e40: 2070 726f 6365 7373 6564 5f64 6620 3d20   processed_df = 
+00062e50: 6466 2e67 726f 7570 6279 2867 726f 7570  df.groupby(group
+00062e60: 5f62 795f 636f 6c75 6d6e 2c20 6173 5f69  _by_column, as_i
+00062e70: 6e64 6578 3d46 616c 7365 292e 6167 6728  ndex=False).agg(
+00062e80: 6167 675f 6469 6374 290a 2020 2020 7265  agg_dict).    re
+00062e90: 7475 726e 2070 726f 6365 7373 6564 5f64  turn processed_d
+00062ea0: 660a 0a64 6566 2061 7665 7261 6765 5f62  f..def average_b
+00062eb0: 6c69 6e64 5f71 635f 6279 5f6d 6f64 616c  lind_qc_by_modal
+00062ec0: 6974 7928 7163 5f66 756c 6c2c 7665 7262  ity(qc_full,verb
+00062ed0: 6f73 653d 4661 6c73 6529 3a0a 2020 2020  ose=False):.    
+00062ee0: 2222 220a 2020 2020 4176 6572 6167 6573  """.    Averages
+00062ef0: 2074 696d 6520 7365 7269 6573 2071 6320   time series qc 
+00062f00: 7265 7375 6c74 7320 746f 2079 6965 6c64  results to yield
+00062f10: 206f 6e65 2065 6e74 7279 2070 6572 2069   one entry per i
+00062f20: 6d61 6765 2e20 7468 6973 2061 6c73 6f20  mage. this also 
+00062f30: 6669 6c74 6572 7320 746f 2022 6b6e 6f77  filters to "know
+00062f40: 6e22 2063 6f6c 756d 6e73 2e0a 0a20 2020  n" columns...   
+00062f50: 2041 7267 733a 0a20 2020 2071 635f 6675   Args:.    qc_fu
+00062f60: 6c6c 3a20 7061 6e64 6173 2064 6174 6166  ll: pandas dataf
+00062f70: 7261 6d65 2063 6f6e 7461 696e 696e 6720  rame containing 
+00062f80: 7468 6520 6675 6c6c 2071 6320 6461 7461  the full qc data
+00062f90: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+00062fa0: 2020 2020 7061 6e64 6173 2064 6174 6166      pandas dataf
+00062fb0: 7261 6d65 2063 6f6e 7461 696e 696e 6720  rame containing 
+00062fc0: 7468 6520 7072 6f63 6573 7365 6420 7163  the processed qc
+00062fd0: 2064 6174 612e 0a20 2020 2022 2222 0a20   data..    """. 
+00062fe0: 2020 2071 635f 6675 6c6c 203d 2072 656d     qc_full = rem
+00062ff0: 6f76 655f 756e 7761 6e74 6564 5f63 6f6c  ove_unwanted_col
+00063000: 756d 6e73 2820 7163 5f66 756c 6c20 290a  umns( qc_full ).
+00063010: 2020 2020 2320 4765 7420 756e 6971 7565      # Get unique
+00063020: 206d 6f64 616c 6974 6965 730a 2020 2020   modalities.    
+00063030: 6d6f 6461 6c69 7469 6573 203d 2071 635f  modalities = qc_
+00063040: 6675 6c6c 5b27 6d6f 6461 6c69 7479 275d  full['modality']
+00063050: 2e75 6e69 7175 6528 290a 2020 2020 6d6f  .unique().    mo
+00063060: 6461 6c69 7469 6573 203d 206d 6f64 616c  dalities = modal
+00063070: 6974 6965 735b 6d6f 6461 6c69 7469 6573  ities[modalities
+00063080: 2021 3d20 2775 6e6b 6e6f 776e 275d 0a20   != 'unknown']. 
+00063090: 2020 2023 2047 6574 2075 6e69 7175 6520     # Get unique 
+000630a0: 6964 730a 2020 2020 7569 6420 3d20 7163  ids.    uid = qc
+000630b0: 5f66 756c 6c5b 2766 696c 656e 616d 6527  _full['filename'
+000630c0: 5d0a 2020 2020 746f 5f61 7665 7261 6765  ].    to_average
+000630d0: 203d 2075 6964 2e75 6e69 7175 6528 290a   = uid.unique().
+000630e0: 2020 2020 6d65 7461 203d 2070 642e 4461      meta = pd.Da
+000630f0: 7461 4672 616d 6528 636f 6c75 6d6e 733d  taFrame(columns=
+00063100: 7163 5f66 756c 6c2e 636f 6c75 6d6e 7320  qc_full.columns 
+00063110: 290a 2020 2020 2320 5072 6f63 6573 7320  ).    # Process 
+00063120: 6561 6368 2075 6e69 7175 6520 6964 0a20  each unique id. 
+00063130: 2020 206e 203d 206c 656e 2874 6f5f 6176     n = len(to_av
+00063140: 6572 6167 6529 0a20 2020 2066 6f72 206b  erage).    for k
+00063150: 2069 6e20 7261 6e67 6528 6e29 3a0a 2020   in range(n):.  
+00063160: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
+00063170: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00063180: 206b 2025 2031 3030 203d 3d20 303a 0a20   k % 100 == 0:. 
+00063190: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000631a0: 726f 6767 6572 203d 2073 7472 2820 6e70  rogger = str( np
+000631b0: 2e72 6f75 6e64 2820 6b20 2f20 6e20 2a20  .round( k / n * 
+000631c0: 3130 3020 2920 290a 2020 2020 2020 2020  100 ) ).        
+000631d0: 2020 2020 2020 2020 7072 696e 7428 2070          print( p
+000631e0: 726f 6767 6572 2c20 656e 6420 3d22 2e2e  rogger, end ="..
+000631f0: 2e22 2c20 666c 7573 683d 5472 7565 290a  .", flush=True).
+00063200: 2020 2020 2020 2020 6d31 7365 6c20 3d20          m1sel = 
+00063210: 7569 6420 3d3d 2074 6f5f 6176 6572 6167  uid == to_averag
+00063220: 655b 6b5d 0a20 2020 2020 2020 2069 6620  e[k].        if 
+00063230: 7375 6d28 6d31 7365 6c29 203e 2031 3a0a  sum(m1sel) > 1:.
+00063240: 2020 2020 2020 2020 2020 2020 2320 4966              # If
+00063250: 206d 6f72 6520 7468 616e 206f 6e65 2065   more than one e
+00063260: 6e74 7279 2066 6f72 2069 642c 2074 616b  ntry for id, tak
+00063270: 6520 7468 6520 6176 6572 6167 6520 6f66  e the average of
+00063280: 2063 6f6e 7469 6e75 6f75 7320 636f 6c75   continuous colu
+00063290: 6d6e 732c 0a20 2020 2020 2020 2020 2020  mns,.           
+000632a0: 2023 206d 6178 696d 756d 206f 6620 7468   # maximum of th
+000632b0: 6520 736c 6963 6520 636f 6c75 6d6e 2c20  e slice column, 
+000632c0: 616e 6420 7468 6520 6669 7273 7420 656e  and the first en
+000632d0: 7472 7920 6f66 2074 6865 206f 7468 6572  try of the other
+000632e0: 2063 6f6c 756d 6e73 0a20 2020 2020 2020   columns.       
+000632f0: 2020 2020 206d 6673 7562 203d 2070 726f       mfsub = pro
+00063300: 6365 7373 5f64 6174 6166 7261 6d65 5f67  cess_dataframe_g
+00063310: 656e 6572 616c 697a 6564 2871 635f 6675  eneralized(qc_fu
+00063320: 6c6c 5b6d 3173 656c 5d2c 2766 696c 656e  ll[m1sel],'filen
+00063330: 616d 6527 290a 2020 2020 2020 2020 656c  ame').        el
+00063340: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00063350: 6d66 7375 6220 3d20 7163 5f66 756c 6c5b  mfsub = qc_full[
+00063360: 6d31 7365 6c5d 0a20 2020 2020 2020 206d  m1sel].        m
+00063370: 6574 612e 6c6f 635b 6b5d 203d 206d 6673  eta.loc[k] = mfs
+00063380: 7562 2e69 6c6f 635b 305d 0a20 2020 206d  ub.iloc[0].    m
+00063390: 6574 615b 276d 6f64 616c 6974 7927 5d20  eta['modality'] 
+000633a0: 3d20 6d65 7461 5b27 6d6f 6461 6c69 7479  = meta['modality
+000633b0: 275d 2e72 6570 6c61 6365 285b 2744 5449  '].replace(['DTI
+000633c0: 6477 6927 2c20 2744 5449 6230 275d 2c20  dwi', 'DTIb0'], 
+000633d0: 2744 5449 272c 2072 6567 6578 3d54 7275  'DTI', regex=Tru
+000633e0: 6529 0a20 2020 2072 6574 7572 6e20 6d65  e).    return me
+000633f0: 7461 0a0a 6465 6620 776d 6828 2066 6c61  ta..def wmh( fla
+00063400: 6972 2c20 7431 2c20 7431 7365 672c 0a20  ir, t1, t1seg,. 
+00063410: 2020 206d 6d66 726f 6d63 6f6e 7665 7868     mmfromconvexh
+00063420: 756c 6c20 3d20 332e 302c 0a20 2020 2073  ull = 3.0,.    s
+00063430: 7472 6963 743d 5472 7565 2c0a 2020 2020  trict=True,.    
+00063440: 7072 6f62 6162 696c 6974 795f 6d61 736b  probability_mask
+00063450: 3d4e 6f6e 652c 0a20 2020 2070 7269 6f72  =None,.    prior
+00063460: 5f70 726f 6261 6269 6c69 7479 3d4e 6f6e  _probability=Non
+00063470: 652c 0a20 2020 206d 6f64 656c 3d27 7379  e,.    model='sy
+00063480: 7375 272c 0a20 2020 2076 6572 626f 7365  su',.    verbose
+00063490: 3d46 616c 7365 2029 203a 0a20 2020 2022  =False ) :.    "
+000634a0: 2222 0a20 2020 204f 7574 7075 7473 2074  "".    Outputs t
+000634b0: 6865 2057 4d48 2070 726f 6261 6269 6c69  he WMH probabili
+000634c0: 7479 206d 6173 6b20 616e 6420 6120 7375  ty mask and a su
+000634d0: 6d6d 6172 7920 7369 6e67 6c65 206d 6561  mmary single mea
+000634e0: 7375 7265 6d65 6e74 0a0a 2020 2020 4172  surement..    Ar
+000634f0: 6775 6d65 6e74 730a 2020 2020 2d2d 2d2d  guments.    ----
+00063500: 2d2d 2d2d 2d0a 2020 2020 666c 6169 7220  -----.    flair 
+00063510: 3a20 414e 5473 496d 6167 650a 2020 2020  : ANTsImage.    
+00063520: 2020 2020 696e 7075 7420 332d 4420 464c      input 3-D FL
+00063530: 4149 5220 6272 6169 6e20 696d 6167 6520  AIR brain image 
+00063540: 286e 6f74 2073 6b75 6c6c 2d73 7472 6970  (not skull-strip
+00063550: 7065 6429 2e0a 0a20 2020 2074 3120 3a20  ped)...    t1 : 
+00063560: 414e 5473 496d 6167 650a 2020 2020 2020  ANTsImage.      
+00063570: 2020 696e 7075 7420 332d 4420 5431 2062    input 3-D T1 b
+00063580: 7261 696e 2069 6d61 6765 2028 6e6f 7420  rain image (not 
+00063590: 736b 756c 6c2d 7374 7269 7070 6564 292e  skull-stripped).
+000635a0: 0a0a 2020 2020 7431 7365 6720 3a20 414e  ..    t1seg : AN
+000635b0: 5473 496d 6167 650a 2020 2020 2020 2020  TsImage.        
+000635c0: 5431 2073 6567 6d65 6e74 6174 696f 6e20  T1 segmentation 
+000635d0: 696d 6167 650a 0a20 2020 206d 6d66 726f  image..    mmfro
+000635e0: 6d63 6f6e 7665 7868 756c 6c20 3a20 666c  mconvexhull : fl
+000635f0: 6f61 740a 2020 2020 2020 2020 7265 7374  oat.        rest
+00063600: 7269 6374 2057 4d48 2074 6f20 7265 6769  rict WMH to regi
+00063610: 6f6e 7320 7468 6174 2061 7265 2057 4d20  ons that are WM 
+00063620: 6f72 206d 6d66 726f 6d63 6f6e 7665 7868  or mmfromconvexh
+00063630: 756c 6c20 6d6d 2061 7761 7920 6672 6f6d  ull mm away from
+00063640: 2074 6865 0a20 2020 2020 2020 2063 6f6e   the.        con
+00063650: 7665 7820 6875 6c6c 206f 6620 7468 6520  vex hull of the 
+00063660: 6365 7265 6272 756d 2e20 2020 7765 2063  cerebrum.   we c
+00063670: 686f 6f73 6520 6120 6465 6661 756c 7420  hoose a default 
+00063680: 7661 6c75 6520 6261 7365 6420 6f6e 0a20  value based on. 
+00063690: 2020 2020 2020 2046 6967 7572 6520 3420         Figure 4 
+000636a0: 6672 6f6d 3a0a 2020 2020 2020 2020 6874  from:.        ht
+000636b0: 7470 733a 2f2f 7777 772e 6e63 6269 2e6e  tps://www.ncbi.n
+000636c0: 6c6d 2e6e 6968 2e67 6f76 2f70 6d63 2f61  lm.nih.gov/pmc/a
+000636d0: 7274 6963 6c65 732f 504d 4336 3234 3035  rticles/PMC62405
+000636e0: 3739 2f70 6466 2f66 6e61 6769 2d31 302d  79/pdf/fnagi-10-
+000636f0: 3030 3333 392e 7064 660a 0a20 2020 2073  00339.pdf..    s
+00063700: 7472 6963 743a 2062 6f6f 6c65 616e 202d  trict: boolean -
+00063710: 2069 6620 5472 7565 2c20 6f6e 6c79 2075   if True, only u
+00063720: 7365 2063 6f6e 7665 7820 6875 6c6c 2064  se convex hull d
+00063730: 6973 7461 6e63 650a 0a20 2020 2070 726f  istance..    pro
+00063740: 6261 6269 6c69 7479 5f6d 6173 6b20 3a20  bability_mask : 
+00063750: 4e6f 6e65 202d 2075 7365 2074 6f20 636f  None - use to co
+00063760: 6d70 7574 6520 776d 6820 6a75 7374 206f  mpute wmh just o
+00063770: 6e63 6520 2d20 7468 656e 2074 6869 7320  nce - then this 
+00063780: 6675 6e63 7469 6f6e 0a20 2020 2020 2020  function.       
+00063790: 206a 7573 7420 646f 6573 2072 6566 696e   just does refin
+000637a0: 656d 656e 7420 616e 6420 7375 6d6d 6172  ement and summar
+000637b0: 790a 0a20 2020 2070 7269 6f72 5f70 726f  y..    prior_pro
+000637c0: 6261 6269 6c69 7479 203a 206f 7074 696f  bability : optio
+000637d0: 6e61 6c20 7072 696f 7220 7072 6f62 6162  nal prior probab
+000637e0: 696c 6974 7920 696d 6167 6520 696e 2073  ility image in s
+000637f0: 7061 6365 206f 6620 7468 6520 696e 7075  pace of the inpu
+00063800: 7420 7431 0a0a 2020 2020 6d6f 6465 6c20  t t1..    model 
+00063810: 3a20 6569 7468 6572 2073 7973 7520 6f72  : either sysu or
+00063820: 2068 7970 6572 0a0a 2020 2020 7665 7262   hyper..    verb
+00063830: 6f73 6520 3a20 626f 6f6c 6561 6e0a 0a20  ose : boolean.. 
+00063840: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
+00063850: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2057 4d48  --------.    WMH
+00063860: 2070 726f 6261 6269 6c69 7479 206d 6170   probability map
+00063870: 2061 6e64 2061 2073 756d 6d61 7279 2073   and a summary s
+00063880: 696e 676c 6520 6d65 6173 7572 656d 656e  ingle measuremen
+00063890: 7420 7768 6963 6820 6973 2074 6865 2073  t which is the s
+000638a0: 756d 206f 6620 7468 6520 574d 4820 6d61  um of the WMH ma
+000638b0: 700a 0a20 2020 2022 2222 0a20 2020 2069  p..    """.    i
+000638c0: 6d70 6f72 7420 6e75 6d70 7920 6173 206e  mport numpy as n
+000638d0: 700a 2020 2020 696d 706f 7274 206d 6174  p.    import mat
+000638e0: 680a 2020 2020 7431 5f32 5f66 6c61 6972  h.    t1_2_flair
+000638f0: 5f72 6567 203d 2061 6e74 732e 7265 6769  _reg = ants.regi
+00063900: 7374 7261 7469 6f6e 2866 6c61 6972 2c20  stration(flair, 
+00063910: 7431 2c20 7479 7065 5f6f 665f 7472 616e  t1, type_of_tran
+00063920: 7366 6f72 6d20 3d20 2752 6967 6964 2729  sform = 'Rigid')
+00063930: 2023 2052 6567 6973 7465 7220 5431 2074   # Register T1 t
+00063940: 6f20 466c 6169 720a 2020 2020 6966 2070  o Flair.    if p
+00063950: 726f 6261 6269 6c69 7479 5f6d 6173 6b20  robability_mask 
+00063960: 6973 204e 6f6e 6520 616e 6420 6d6f 6465  is None and mode
+00063970: 6c20 3d3d 2027 7379 7375 273a 0a20 2020  l == 'sysu':.   
+00063980: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
+00063990: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+000639a0: 6e74 2827 7379 7375 2729 0a20 2020 2020  nt('sysu').     
+000639b0: 2020 2070 726f 6261 6269 6c69 7479 5f6d     probability_m
+000639c0: 6173 6b20 3d20 616e 7473 7079 6e65 742e  ask = antspynet.
+000639d0: 7379 7375 5f6d 6564 6961 5f77 6d68 5f73  sysu_media_wmh_s
+000639e0: 6567 6d65 6e74 6174 696f 6e28 2066 6c61  egmentation( fla
+000639f0: 6972 2029 0a20 2020 2065 6c69 6620 7072  ir ).    elif pr
+00063a00: 6f62 6162 696c 6974 795f 6d61 736b 2069  obability_mask i
+00063a10: 7320 4e6f 6e65 2061 6e64 206d 6f64 656c  s None and model
+00063a20: 203d 3d20 2768 7970 6572 273a 0a20 2020   == 'hyper':.   
+00063a30: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
+00063a40: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+00063a50: 6e74 2827 6879 7065 7227 290a 2020 2020  nt('hyper').    
+00063a60: 2020 2020 7072 6f62 6162 696c 6974 795f      probability_
+00063a70: 6d61 736b 203d 2061 6e74 7370 796e 6574  mask = antspynet
+00063a80: 2e68 7970 6572 6d61 7070 3372 5f73 6567  .hypermapp3r_seg
+00063a90: 6d65 6e74 6174 696f 6e28 2074 315f 325f  mentation( t1_2_
+00063aa0: 666c 6169 725f 7265 675b 2777 6172 7065  flair_reg['warpe
+00063ab0: 646d 6f76 6f75 7427 5d2c 2066 6c61 6972  dmovout'], flair
+00063ac0: 2029 0a20 2020 2023 2074 315f 325f 666c   ).    # t1_2_fl
+00063ad0: 6169 725f 7265 6720 3d20 7472 615f 696e  air_reg = tra_in
+00063ae0: 6974 6961 6c69 7a65 7228 2066 6c61 6972  itializer( flair
+00063af0: 2c20 7431 2c20 6e5f 7369 6d75 6c61 7469  , t1, n_simulati
+00063b00: 6f6e 733d 342c 206d 6178 5f72 6f74 6174  ons=4, max_rotat
+00063b10: 696f 6e3d 352c 2074 7261 6e73 666f 726d  ion=5, transform
+00063b20: 3d5b 2772 6967 6964 275d 2c20 7665 7262  =['rigid'], verb
+00063b30: 6f73 653d 4661 6c73 6520 290a 2020 2020  ose=False ).    
+00063b40: 7072 696f 725f 7072 6f62 6162 696c 6974  prior_probabilit
+00063b50: 795f 666c 6169 7220 3d20 4e6f 6e65 0a20  y_flair = None. 
+00063b60: 2020 2069 6620 7072 696f 725f 7072 6f62     if prior_prob
+00063b70: 6162 696c 6974 7920 6973 206e 6f74 204e  ability is not N
+00063b80: 6f6e 653a 0a20 2020 2020 2020 2070 7269  one:.        pri
+00063b90: 6f72 5f70 726f 6261 6269 6c69 7479 5f66  or_probability_f
+00063ba0: 6c61 6972 203d 2061 6e74 732e 6170 706c  lair = ants.appl
+00063bb0: 795f 7472 616e 7366 6f72 6d73 2820 666c  y_transforms( fl
+00063bc0: 6169 722c 2070 7269 6f72 5f70 726f 6261  air, prior_proba
+00063bd0: 6269 6c69 7479 2c0a 2020 2020 2020 2020  bility,.        
+00063be0: 2020 2020 7431 5f32 5f66 6c61 6972 5f72      t1_2_flair_r
+00063bf0: 6567 5b27 6677 6474 7261 6e73 666f 726d  eg['fwdtransform
+00063c00: 7327 5d20 290a 2020 2020 776d 7365 675f  s'] ).    wmseg_
+00063c10: 6d61 736b 203d 2061 6e74 732e 7468 7265  mask = ants.thre
+00063c20: 7368 6f6c 645f 696d 6167 6528 2074 3173  shold_image( t1s
+00063c30: 6567 2c0a 2020 2020 2020 2020 6c6f 775f  eg,.        low_
+00063c40: 7468 7265 7368 203d 2033 2c20 6869 6768  thresh = 3, high
+00063c50: 5f74 6872 6573 6820 3d20 3329 2e69 4d61  _thresh = 3).iMa
+00063c60: 7468 2822 4669 6c6c 486f 6c65 7322 290a  th("FillHoles").
+00063c70: 2020 2020 776d 7365 675f 6d61 736b 5f75      wmseg_mask_u
+00063c80: 7365 203d 2061 6e74 732e 696d 6167 655f  se = ants.image_
+00063c90: 636c 6f6e 6528 2077 6d73 6567 5f6d 6173  clone( wmseg_mas
+00063ca0: 6b20 290a 2020 2020 6469 7374 6d61 736b  k ).    distmask
+00063cb0: 203d 204e 6f6e 650a 2020 2020 6966 206d   = None.    if m
+00063cc0: 6d66 726f 6d63 6f6e 7665 7868 756c 6c20  mfromconvexhull 
+00063cd0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+00063ce0: 2063 6f6e 7665 7868 756c 6c20 3d20 616e   convexhull = an
+00063cf0: 7473 2e74 6872 6573 686f 6c64 5f69 6d61  ts.threshold_ima
+00063d00: 6765 2820 7431 7365 672c 2031 2c20 3420  ge( t1seg, 1, 4 
+00063d10: 290a 2020 2020 2020 2020 2020 2020 7370  ).            sp
+00063d20: 6332 766f 7820 3d20 6e70 2e70 726f 6428  c2vox = np.prod(
+00063d30: 2061 6e74 732e 6765 745f 7370 6163 696e   ants.get_spacin
+00063d40: 6728 2074 3173 6567 2029 2029 0a20 2020  g( t1seg ) ).   
+00063d50: 2020 2020 2020 2020 2076 6f78 6469 7374           voxdist
+00063d60: 203d 2030 2e30 0a20 2020 2020 2020 2020   = 0.0.         
+00063d70: 2020 206d 7973 7063 203d 2061 6e74 732e     myspc = ants.
+00063d80: 6765 745f 7370 6163 696e 6728 2074 3173  get_spacing( t1s
+00063d90: 6567 2029 0a20 2020 2020 2020 2020 2020  eg ).           
+00063da0: 2066 6f72 206b 2069 6e20 7261 6e67 6528   for k in range(
+00063db0: 2074 3173 6567 2e64 696d 656e 7369 6f6e   t1seg.dimension
+00063dc0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00063dd0: 2020 2020 766f 7864 6973 7420 3d20 766f      voxdist = vo
+00063de0: 7864 6973 7420 2b20 6d79 7370 635b 6b5d  xdist + myspc[k]
+00063df0: 202a 206d 7973 7063 5b6b 5d0a 2020 2020   * myspc[k].    
+00063e00: 2020 2020 2020 2020 766f 7864 6973 7420          voxdist 
+00063e10: 3d20 6d61 7468 2e73 7172 7428 2076 6f78  = math.sqrt( vox
+00063e20: 6469 7374 2029 0a20 2020 2020 2020 2020  dist ).         
+00063e30: 2020 206e 6d6f 7270 6820 3d20 726f 756e     nmorph = roun
+00063e40: 6428 2032 2e30 202f 2076 6f78 6469 7374  d( 2.0 / voxdist
+00063e50: 2029 0a20 2020 2020 2020 2020 2020 2063   ).            c
+00063e60: 6f6e 7665 7868 756c 6c20 3d20 616e 7473  onvexhull = ants
+00063e70: 2e6d 6f72 7068 6f6c 6f67 7928 2063 6f6e  .morphology( con
+00063e80: 7665 7868 756c 6c2c 2022 636c 6f73 6522  vexhull, "close"
+00063e90: 2c20 6e6d 6f72 7068 2029 2e69 4d61 7468  , nmorph ).iMath
+00063ea0: 2822 4669 6c6c 486f 6c65 7322 290a 2020  ("FillHoles").  
+00063eb0: 2020 2020 2020 2020 2020 6469 7374 203d            dist =
+00063ec0: 2061 6e74 732e 694d 6174 6828 2063 6f6e   ants.iMath( con
+00063ed0: 7665 7868 756c 6c2c 2022 4d61 7572 6572  vexhull, "Maurer
+00063ee0: 4469 7374 616e 6365 2220 2920 2a20 2d31  Distance" ) * -1
+00063ef0: 2e30 0a20 2020 2020 2020 2020 2020 2064  .0.            d
+00063f00: 6973 746d 6173 6b20 3d20 616e 7473 2e74  istmask = ants.t
+00063f10: 6872 6573 686f 6c64 5f69 6d61 6765 2820  hreshold_image( 
+00063f20: 6469 7374 2c20 6d6d 6672 6f6d 636f 6e76  dist, mmfromconv
+00063f30: 6578 6875 6c6c 2c20 312e 6538 3020 290a  exhull, 1.e80 ).
+00063f40: 2020 2020 2020 2020 2020 2020 776d 7365              wmse
+00063f50: 675f 6d61 736b 203d 2077 6d73 6567 5f6d  g_mask = wmseg_m
+00063f60: 6173 6b20 2b20 6469 7374 6d61 736b 0a20  ask + distmask. 
+00063f70: 2020 2020 2020 2020 2020 2069 6620 7374             if st
+00063f80: 7269 6374 3a0a 2020 2020 2020 2020 2020  rict:.          
+00063f90: 2020 2020 2020 776d 7365 675f 6d61 736b        wmseg_mask
+00063fa0: 5f75 7365 203d 2061 6e74 732e 7468 7265  _use = ants.thre
+00063fb0: 7368 6f6c 645f 696d 6167 6528 2077 6d73  shold_image( wms
+00063fc0: 6567 5f6d 6173 6b2c 2032 2c20 3220 290a  eg_mask, 2, 2 ).
+00063fd0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00063fe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00063ff0: 2020 776d 7365 675f 6d61 736b 5f75 7365    wmseg_mask_use
+00064000: 203d 2061 6e74 732e 7468 7265 7368 6f6c   = ants.threshol
+00064010: 645f 696d 6167 6528 2077 6d73 6567 5f6d  d_image( wmseg_m
+00064020: 6173 6b2c 2031 2c20 3220 290a 2020 2020  ask, 1, 2 ).    
+00064030: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00064040: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00064050: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00064060: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00064070: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
+00064080: 2020 2077 6d73 6567 5f32 5f66 6c61 6972     wmseg_2_flair
+00064090: 203d 2061 6e74 732e 6170 706c 795f 7472   = ants.apply_tr
+000640a0: 616e 7366 6f72 6d73 2866 6c61 6972 2c20  ansforms(flair, 
+000640b0: 776d 7365 675f 6d61 736b 5f75 7365 2c0a  wmseg_mask_use,.
+000640c0: 2020 2020 2020 2020 7472 616e 7366 6f72          transfor
+000640d0: 6d6c 6973 7420 3d20 7431 5f32 5f66 6c61  mlist = t1_2_fla
+000640e0: 6972 5f72 6567 5b27 6677 6474 7261 6e73  ir_reg['fwdtrans
+000640f0: 666f 726d 7327 5d2c 0a20 2020 2020 2020  forms'],.       
+00064100: 2069 6e74 6572 706f 6c61 746f 7220 3d20   interpolator = 
+00064110: 276e 6561 7265 7374 4e65 6967 6862 6f72  'nearestNeighbor
+00064120: 2720 290a 2020 2020 7365 675f 325f 666c  ' ).    seg_2_fl
+00064130: 6169 7220 3d20 616e 7473 2e61 7070 6c79  air = ants.apply
+00064140: 5f74 7261 6e73 666f 726d 7328 666c 6169  _transforms(flai
+00064150: 722c 2074 3173 6567 2c0a 2020 2020 2020  r, t1seg,.      
+00064160: 2020 7472 616e 7366 6f72 6d6c 6973 7420    transformlist 
+00064170: 3d20 7431 5f32 5f66 6c61 6972 5f72 6567  = t1_2_flair_reg
+00064180: 5b27 6677 6474 7261 6e73 666f 726d 7327  ['fwdtransforms'
+00064190: 5d2c 0a20 2020 2020 2020 2069 6e74 6572  ],.        inter
+000641a0: 706f 6c61 746f 7220 3d20 276e 6561 7265  polator = 'neare
+000641b0: 7374 4e65 6967 6862 6f72 2720 290a 2020  stNeighbor' ).  
+000641c0: 2020 6373 666d 6173 6b20 3d20 616e 7473    csfmask = ants
+000641d0: 2e74 6872 6573 686f 6c64 5f69 6d61 6765  .threshold_image
+000641e0: 2873 6567 5f32 5f66 6c61 6972 2c31 2c31  (seg_2_flair,1,1
+000641f0: 290a 2020 2020 666c 6169 7273 6e72 203d  ).    flairsnr =
+00064200: 206d 6173 6b5f 736e 7228 2066 6c61 6972   mask_snr( flair
+00064210: 2c20 6373 666d 6173 6b2c 2077 6d73 6567  , csfmask, wmseg
+00064220: 5f32 5f66 6c61 6972 2c20 6269 6173 5f63  _2_flair, bias_c
+00064230: 6f72 7265 6374 203d 2046 616c 7365 2029  orrect = False )
+00064240: 0a20 2020 2070 726f 6261 6269 6c69 7479  .    probability
+00064250: 5f6d 6173 6b5f 574d 203d 2077 6d73 6567  _mask_WM = wmseg
+00064260: 5f32 5f66 6c61 6972 202a 2070 726f 6261  _2_flair * proba
+00064270: 6269 6c69 7479 5f6d 6173 6b20 2320 5265  bility_mask # Re
+00064280: 6d6f 7665 2057 4d48 2073 6967 6e61 6c20  move WMH signal 
+00064290: 6f75 7473 6964 6520 6f66 2057 4d0a 2020  outside of WM.  
+000642a0: 2020 776d 685f 7375 6d20 3d20 6e70 2e70    wmh_sum = np.p
+000642b0: 726f 6428 2061 6e74 732e 6765 745f 7370  rod( ants.get_sp
+000642c0: 6163 696e 6728 2066 6c61 6972 2029 2029  acing( flair ) )
+000642d0: 202a 2070 726f 6261 6269 6c69 7479 5f6d   * probability_m
+000642e0: 6173 6b5f 574d 2e73 756d 2829 0a20 2020  ask_WM.sum().   
+000642f0: 2077 6d68 5f73 756d 5f70 7269 6f72 203d   wmh_sum_prior =
+00064300: 206d 6174 682e 6e61 6e0a 2020 2020 7072   math.nan.    pr
+00064310: 6f62 6162 696c 6974 795f 6d61 736b 5f70  obability_mask_p
+00064320: 6f73 7465 7269 6f72 203d 204e 6f6e 650a  osterior = None.
+00064330: 2020 2020 6966 2070 7269 6f72 5f70 726f      if prior_pro
+00064340: 6261 6269 6c69 7479 5f66 6c61 6972 2069  bability_flair i
+00064350: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00064360: 2020 2020 7072 6f62 6162 696c 6974 795f      probability_
+00064370: 6d61 736b 5f70 6f73 7465 7269 6f72 203d  mask_posterior =
+00064380: 2070 7269 6f72 5f70 726f 6261 6269 6c69   prior_probabili
+00064390: 7479 5f66 6c61 6972 202a 2070 726f 6261  ty_flair * proba
+000643a0: 6269 6c69 7479 5f6d 6173 6b20 2320 7573  bility_mask # us
+000643b0: 6520 7072 696f 720a 2020 2020 2020 2020  e prior.        
+000643c0: 776d 685f 7375 6d5f 7072 696f 7220 3d20  wmh_sum_prior = 
+000643d0: 6e70 2e70 726f 6428 2061 6e74 732e 6765  np.prod( ants.ge
+000643e0: 745f 7370 6163 696e 6728 666c 6169 7229  t_spacing(flair)
+000643f0: 2029 202a 2070 726f 6261 6269 6c69 7479   ) * probability
+00064400: 5f6d 6173 6b5f 706f 7374 6572 696f 722e  _mask_posterior.
+00064410: 7375 6d28 290a 2020 2020 6966 206d 6174  sum().    if mat
+00064420: 682e 6973 6e61 6e28 2077 6d68 5f73 756d  h.isnan( wmh_sum
+00064430: 2029 3a0a 2020 2020 2020 2020 776d 685f   ):.        wmh_
+00064440: 7375 6d3d 300a 2020 2020 6966 206d 6174  sum=0.    if mat
+00064450: 682e 6973 6e61 6e28 2077 6d68 5f73 756d  h.isnan( wmh_sum
+00064460: 5f70 7269 6f72 2029 3a0a 2020 2020 2020  _prior ):.      
+00064470: 2020 776d 685f 7375 6d5f 7072 696f 723d    wmh_sum_prior=
+00064480: 300a 2020 2020 666c 6169 725f 6576 7220  0.    flair_evr 
+00064490: 3d20 616e 7473 7079 7431 772e 7061 7463  = antspyt1w.patc
+000644a0: 685f 6569 6765 6e76 616c 7565 5f72 6174  h_eigenvalue_rat
+000644b0: 696f 2820 666c 6169 722c 2035 3132 2c20  io( flair, 512, 
+000644c0: 5b31 362c 3136 2c31 365d 2c20 6576 6465  [16,16,16], evde
+000644d0: 7074 6820 3d20 302e 392c 206d 6173 6b3d  pth = 0.9, mask=
+000644e0: 776d 7365 675f 325f 666c 6169 7220 290a  wmseg_2_flair ).
+000644f0: 2020 2020 7265 7475 726e 7b0a 2020 2020      return{.    
+00064500: 2020 2020 2757 4d48 5f70 726f 6261 6269      'WMH_probabi
+00064510: 6c69 7479 5f6d 6170 5f72 6177 273a 2070  lity_map_raw': p
+00064520: 726f 6261 6269 6c69 7479 5f6d 6173 6b2c  robability_mask,
+00064530: 0a20 2020 2020 2020 2027 574d 485f 7072  .        'WMH_pr
+00064540: 6f62 6162 696c 6974 795f 6d61 7027 203a  obability_map' :
+00064550: 2070 726f 6261 6269 6c69 7479 5f6d 6173   probability_mas
+00064560: 6b5f 574d 2c0a 2020 2020 2020 2020 2757  k_WM,.        'W
+00064570: 4d48 5f70 6f73 7465 7269 6f72 5f70 726f  MH_posterior_pro
+00064580: 6261 6269 6c69 7479 5f6d 6170 2720 3a20  bability_map' : 
+00064590: 7072 6f62 6162 696c 6974 795f 6d61 736b  probability_mask
+000645a0: 5f70 6f73 7465 7269 6f72 2c0a 2020 2020  _posterior,.    
+000645b0: 2020 2020 2777 6d68 5f6d 6173 7327 3a20      'wmh_mass': 
+000645c0: 776d 685f 7375 6d2c 0a20 2020 2020 2020  wmh_sum,.       
+000645d0: 2027 776d 685f 6d61 7373 5f70 7269 6f72   'wmh_mass_prior
+000645e0: 273a 2077 6d68 5f73 756d 5f70 7269 6f72  ': wmh_sum_prior
+000645f0: 2c0a 2020 2020 2020 2020 2777 6d68 5f65  ,.        'wmh_e
+00064600: 7672 2720 3a20 666c 6169 725f 6576 722c  vr' : flair_evr,
+00064610: 0a20 2020 2020 2020 2027 776d 685f 534e  .        'wmh_SN
+00064620: 5227 203a 2066 6c61 6972 736e 722c 0a20  R' : flairsnr,. 
+00064630: 2020 2020 2020 2027 636f 6e76 6578 6875         'convexhu
+00064640: 6c6c 5f6d 6173 6b27 3a20 6469 7374 6d61  ll_mask': distma
+00064650: 736b 207d 0a0a 0a64 6566 2072 6570 6c61  sk }...def repla
+00064660: 6365 5f65 6c65 6d65 6e74 735f 696e 5f6e  ce_elements_in_n
+00064670: 756d 7079 5f61 7272 6179 286f 7269 6769  umpy_array(origi
+00064680: 6e61 6c5f 6172 7261 792c 2069 6e64 6963  nal_array, indic
+00064690: 6573 5f74 6f5f 7265 706c 6163 652c 206e  es_to_replace, n
+000646a0: 6577 5f76 616c 7565 293a 0a20 2020 2022  ew_value):.    "
+000646b0: 2222 0a20 2020 2052 6570 6c61 6365 2073  "".    Replace s
+000646c0: 7065 6369 6669 6564 2065 6c65 6d65 6e74  pecified element
+000646d0: 7320 6f72 2072 6f77 7320 696e 2061 206e  s or rows in a n
+000646e0: 756d 7079 2061 7272 6179 2077 6974 6820  umpy array with 
+000646f0: 6120 6e65 7720 7661 6c75 652e 0a0a 2020  a new value...  
+00064700: 2020 5061 7261 6d65 7465 7273 3a0a 2020    Parameters:.  
+00064710: 2020 6f72 6967 696e 616c 5f61 7272 6179    original_array
+00064720: 2028 6e75 6d70 792e 6e64 6172 7261 7929   (numpy.ndarray)
+00064730: 3a20 4120 6e75 6d70 7920 6172 7261 7920  : A numpy array 
+00064740: 696e 2077 6869 6368 2065 6c65 6d65 6e74  in which element
+00064750: 7320 6f72 2072 6f77 7320 6172 6520 746f  s or rows are to
+00064760: 2062 6520 7265 706c 6163 6564 2e0a 2020   be replaced..  
+00064770: 2020 696e 6469 6365 735f 746f 5f72 6570    indices_to_rep
+00064780: 6c61 6365 2028 6c69 7374 206f 7220 6e75  lace (list or nu
+00064790: 6d70 792e 6e64 6172 7261 7929 3a20 496e  mpy.ndarray): In
+000647a0: 6469 6365 7320 6f66 2065 6c65 6d65 6e74  dices of element
+000647b0: 7320 6f72 2072 6f77 7320 746f 2062 6520  s or rows to be 
+000647c0: 7265 706c 6163 6564 2e0a 2020 2020 6e65  replaced..    ne
+000647d0: 775f 7661 6c75 653a 2054 6865 206e 6577  w_value: The new
+000647e0: 2076 616c 7565 2074 6f20 7265 706c 6163   value to replac
+000647f0: 6520 7468 6520 7370 6563 6966 6965 6420  e the specified 
+00064800: 656c 656d 656e 7473 206f 7220 726f 7773  elements or rows
+00064810: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+00064820: 2020 2020 6e75 6d70 792e 6e64 6172 7261      numpy.ndarra
+00064830: 793a 2041 206e 6577 206e 756d 7079 2061  y: A new numpy a
+00064840: 7272 6179 2077 6974 6820 7468 6520 7370  rray with the sp
+00064850: 6563 6966 6965 6420 656c 656d 656e 7473  ecified elements
+00064860: 206f 7220 726f 7773 2072 6570 6c61 6365   or rows replace
+00064870: 642e 2049 6620 7468 6520 696e 7075 7420  d. If the input 
+00064880: 6172 7261 7920 6973 204e 6f6e 652c 0a20  array is None,. 
+00064890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000648a0: 2020 7468 6520 6675 6e63 7469 6f6e 2072    the function r
+000648b0: 6574 7572 6e73 204e 6f6e 652e 0a20 2020  eturns None..   
+000648c0: 2022 2222 0a0a 2020 2020 6966 206f 7269   """..    if ori
+000648d0: 6769 6e61 6c5f 6172 7261 7920 6973 204e  ginal_array is N
+000648e0: 6f6e 653a 0a20 2020 2020 2020 2072 6574  one:.        ret
+000648f0: 7572 6e20 4e6f 6e65 0a0a 2020 2020 6d61  urn None..    ma
+00064900: 785f 696e 6465 7820 3d20 6f72 6967 696e  x_index = origin
+00064910: 616c 5f61 7272 6179 2e73 697a 6520 6966  al_array.size if
+00064920: 206f 7269 6769 6e61 6c5f 6172 7261 792e   original_array.
+00064930: 6e64 696d 203d 3d20 3120 656c 7365 206f  ndim == 1 else o
+00064940: 7269 6769 6e61 6c5f 6172 7261 792e 7368  riginal_array.sh
+00064950: 6170 655b 305d 0a0a 2020 2020 2320 4669  ape[0]..    # Fi
+00064960: 6c74 6572 206f 7574 2069 6e76 616c 6964  lter out invalid
+00064970: 2069 6e64 6963 6573 2061 6e64 2063 6865   indices and che
+00064980: 636b 2066 6f72 2061 6e79 206f 7574 2d6f  ck for any out-o
+00064990: 662d 626f 756e 6473 2069 6e64 6963 6573  f-bounds indices
+000649a0: 0a20 2020 2076 616c 6964 5f69 6e64 6963  .    valid_indic
+000649b0: 6573 203d 205b 5d0a 2020 2020 666f 7220  es = [].    for 
+000649c0: 6964 7820 696e 2069 6e64 6963 6573 5f74  idx in indices_t
+000649d0: 6f5f 7265 706c 6163 653a 0a20 2020 2020  o_replace:.     
+000649e0: 2020 2069 6620 6964 7820 3c20 6d61 785f     if idx < max_
+000649f0: 696e 6465 783a 0a20 2020 2020 2020 2020  index:.         
+00064a00: 2020 2076 616c 6964 5f69 6e64 6963 6573     valid_indices
+00064a10: 2e61 7070 656e 6428 6964 7829 0a20 2020  .append(idx).   
+00064a20: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00064a30: 2020 2020 2020 2077 6172 6e69 6e67 732e         warnings.
+00064a40: 7761 726e 2866 2257 6172 6e69 6e67 3a20  warn(f"Warning: 
+00064a50: 496e 6465 7820 7b69 6478 7d20 6973 206f  Index {idx} is o
+00064a60: 7574 206f 6620 626f 756e 6473 2061 6e64  ut of bounds and
+00064a70: 2077 696c 6c20 6265 2069 676e 6f72 6564   will be ignored
+00064a80: 2e22 290a 0a20 2020 2069 6620 6f72 6967  .")..    if orig
+00064a90: 696e 616c 5f61 7272 6179 2e6e 6469 6d20  inal_array.ndim 
+00064aa0: 3d3d 2031 3a0a 2020 2020 2020 2020 2320  == 1:.        # 
+00064ab0: 5265 706c 6163 6520 656c 656d 656e 7473  Replace elements
+00064ac0: 2069 6e20 6120 3144 2061 7272 6179 0a20   in a 1D array. 
+00064ad0: 2020 2020 2020 206f 7269 6769 6e61 6c5f         original_
+00064ae0: 6172 7261 795b 7661 6c69 645f 696e 6469  array[valid_indi
+00064af0: 6365 735d 203d 206e 6577 5f76 616c 7565  ces] = new_value
+00064b00: 0a20 2020 2065 6c69 6620 6f72 6967 696e  .    elif origin
+00064b10: 616c 5f61 7272 6179 2e6e 6469 6d20 3d3d  al_array.ndim ==
+00064b20: 2032 3a0a 2020 2020 2020 2020 2320 5265   2:.        # Re
+00064b30: 706c 6163 6520 726f 7773 2069 6e20 6120  place rows in a 
+00064b40: 3244 2061 7272 6179 0a20 2020 2020 2020  2D array.       
+00064b50: 206f 7269 6769 6e61 6c5f 6172 7261 795b   original_array[
+00064b60: 7661 6c69 645f 696e 6469 6365 732c 203a  valid_indices, :
+00064b70: 5d20 3d20 6e65 775f 7661 6c75 650a 2020  ] = new_value.  
+00064b80: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00064b90: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00064ba0: 2822 6f72 6967 696e 616c 5f61 7272 6179  ("original_array
+00064bb0: 206d 7573 7420 6265 2065 6974 6865 7220   must be either 
+00064bc0: 3144 206f 7220 3244 2e22 290a 0a20 2020  1D or 2D.")..   
+00064bd0: 2072 6574 7572 6e20 6f72 6967 696e 616c   return original
+00064be0: 5f61 7272 6179 0a0a 0a0a 6465 6620 7265  _array....def re
+00064bf0: 6d6f 7665 5f65 6c65 6d65 6e74 735f 6672  move_elements_fr
+00064c00: 6f6d 5f6e 756d 7079 5f61 7272 6179 286f  om_numpy_array(o
+00064c10: 7269 6769 6e61 6c5f 6172 7261 792c 2069  riginal_array, i
+00064c20: 6e64 6963 6573 5f74 6f5f 7265 6d6f 7665  ndices_to_remove
+00064c30: 293a 0a20 2020 2022 2222 0a20 2020 2052  ):.    """.    R
+00064c40: 656d 6f76 6520 7370 6563 6966 6965 6420  emove specified 
+00064c50: 656c 656d 656e 7473 206f 7220 726f 7773  elements or rows
+00064c60: 2066 726f 6d20 6120 6e75 6d70 7920 6172   from a numpy ar
+00064c70: 7261 792e 0a0a 2020 2020 5061 7261 6d65  ray...    Parame
+00064c80: 7465 7273 3a0a 2020 2020 6f72 6967 696e  ters:.    origin
+00064c90: 616c 5f61 7272 6179 2028 6e75 6d70 792e  al_array (numpy.
+00064ca0: 6e64 6172 7261 7929 3a20 4120 6e75 6d70  ndarray): A nump
+00064cb0: 7920 6172 7261 7920 6672 6f6d 2077 6869  y array from whi
+00064cc0: 6368 2065 6c65 6d65 6e74 7320 6f72 2072  ch elements or r
+00064cd0: 6f77 7320 6172 6520 746f 2062 6520 7265  ows are to be re
+00064ce0: 6d6f 7665 642e 0a20 2020 2069 6e64 6963  moved..    indic
+00064cf0: 6573 5f74 6f5f 7265 6d6f 7665 2028 6c69  es_to_remove (li
+00064d00: 7374 206f 7220 6e75 6d70 792e 6e64 6172  st or numpy.ndar
+00064d10: 7261 7929 3a20 496e 6469 6365 7320 6f66  ray): Indices of
+00064d20: 2065 6c65 6d65 6e74 7320 6f72 2072 6f77   elements or row
+00064d30: 7320 746f 2062 6520 7265 6d6f 7665 642e  s to be removed.
+00064d40: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+00064d50: 2020 206e 756d 7079 2e6e 6461 7272 6179     numpy.ndarray
+00064d60: 3a20 4120 6e65 7720 6e75 6d70 7920 6172  : A new numpy ar
+00064d70: 7261 7920 7769 7468 2074 6865 2073 7065  ray with the spe
+00064d80: 6369 6669 6564 2065 6c65 6d65 6e74 7320  cified elements 
+00064d90: 6f72 2072 6f77 7320 7265 6d6f 7665 642e  or rows removed.
+00064da0: 2049 6620 7468 6520 696e 7075 7420 6172   If the input ar
+00064db0: 7261 7920 6973 204e 6f6e 652c 0a20 2020  ray is None,.   
+00064dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00064dd0: 7468 6520 6675 6e63 7469 6f6e 2072 6574  the function ret
+00064de0: 7572 6e73 204e 6f6e 652e 0a20 2020 2022  urns None..    "
+00064df0: 2222 0a0a 2020 2020 6966 206f 7269 6769  ""..    if origi
+00064e00: 6e61 6c5f 6172 7261 7920 6973 204e 6f6e  nal_array is Non
+00064e10: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
+00064e20: 6e20 4e6f 6e65 0a0a 2020 2020 6966 206f  n None..    if o
+00064e30: 7269 6769 6e61 6c5f 6172 7261 792e 6e64  riginal_array.nd
+00064e40: 696d 203d 3d20 313a 0a20 2020 2020 2020  im == 1:.       
+00064e50: 2023 2052 656d 6f76 6520 656c 656d 656e   # Remove elemen
+00064e60: 7473 2066 726f 6d20 6120 3144 2061 7272  ts from a 1D arr
+00064e70: 6179 0a20 2020 2020 2020 2072 6574 7572  ay.        retur
+00064e80: 6e20 6e70 2e64 656c 6574 6528 6f72 6967  n np.delete(orig
+00064e90: 696e 616c 5f61 7272 6179 2c20 696e 6469  inal_array, indi
+00064ea0: 6365 735f 746f 5f72 656d 6f76 6529 0a20  ces_to_remove). 
+00064eb0: 2020 2065 6c69 6620 6f72 6967 696e 616c     elif original
+00064ec0: 5f61 7272 6179 2e6e 6469 6d20 3d3d 2032  _array.ndim == 2
+00064ed0: 3a0a 2020 2020 2020 2020 2320 5265 6d6f  :.        # Remo
+00064ee0: 7665 2072 6f77 7320 6672 6f6d 2061 2032  ve rows from a 2
+00064ef0: 4420 6172 7261 790a 2020 2020 2020 2020  D array.        
+00064f00: 7265 7475 726e 206e 702e 6465 6c65 7465  return np.delete
+00064f10: 286f 7269 6769 6e61 6c5f 6172 7261 792c  (original_array,
+00064f20: 2069 6e64 6963 6573 5f74 6f5f 7265 6d6f   indices_to_remo
+00064f30: 7665 2c20 6178 6973 3d30 290a 2020 2020  ve, axis=0).    
+00064f40: 656c 7365 3a0a 2020 2020 2020 2020 7261  else:.        ra
+00064f50: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
+00064f60: 6f72 6967 696e 616c 5f61 7272 6179 206d  original_array m
+00064f70: 7573 7420 6265 2065 6974 6865 7220 3144  ust be either 1D
+00064f80: 206f 7220 3244 2e22 290a 0a64 6566 2072   or 2D.")..def r
+00064f90: 656d 6f76 655f 766f 6c75 6d65 735f 6672  emove_volumes_fr
+00064fa0: 6f6d 5f74 696d 6573 6572 6965 7328 7469  om_timeseries(ti
+00064fb0: 6d65 5f73 6572 6965 732c 2076 6f6c 756d  me_series, volum
+00064fc0: 6573 5f74 6f5f 7265 6d6f 7665 293a 0a20  es_to_remove):. 
+00064fd0: 2020 2022 2222 0a20 2020 2052 656d 6f76     """.    Remov
+00064fe0: 6520 7370 6563 6966 6965 6420 766f 6c75  e specified volu
+00064ff0: 6d65 7320 6672 6f6d 2061 2074 696d 6520  mes from a time 
+00065000: 7365 7269 6573 2e0a 0a20 2020 203a 7061  series...    :pa
+00065010: 7261 6d20 7469 6d65 5f73 6572 6965 733a  ram time_series:
+00065020: 2041 4e54 7349 6d61 6765 2072 6570 7265   ANTsImage repre
+00065030: 7365 6e74 696e 6720 7468 6520 7469 6d65  senting the time
+00065040: 2073 6572 6965 7320 2834 4420 696d 6167   series (4D imag
+00065050: 6529 2e0a 2020 2020 3a70 6172 616d 2076  e)..    :param v
+00065060: 6f6c 756d 6573 5f74 6f5f 7265 6d6f 7665  olumes_to_remove
+00065070: 3a20 4c69 7374 206f 6620 766f 6c75 6d65  : List of volume
+00065080: 2069 6e64 6963 6573 2074 6f20 7265 6d6f   indices to remo
+00065090: 7665 2e0a 2020 2020 3a72 6574 7572 6e3a  ve..    :return:
+000650a0: 2041 4e54 7349 6d61 6765 2077 6974 6820   ANTsImage with 
+000650b0: 7370 6563 6966 6965 6420 766f 6c75 6d65  specified volume
+000650c0: 7320 7265 6d6f 7665 642e 0a20 2020 2022  s removed..    "
+000650d0: 2222 0a20 2020 2069 6620 6e6f 7420 6973  "".    if not is
+000650e0: 696e 7374 616e 6365 2874 696d 655f 7365  instance(time_se
+000650f0: 7269 6573 2c20 616e 7473 2e41 4e54 7349  ries, ants.ANTsI
+00065100: 6d61 6765 293a 0a20 2020 2020 2020 2072  mage):.        r
+00065110: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00065120: 2274 696d 655f 7365 7269 6573 206d 7573  "time_series mus
+00065130: 7420 6265 2061 6e20 414e 5473 496d 6167  t be an ANTsImag
+00065140: 652e 2229 0a0a 2020 2020 6966 2074 696d  e.")..    if tim
+00065150: 655f 7365 7269 6573 2e64 696d 656e 7369  e_series.dimensi
+00065160: 6f6e 2021 3d20 343a 0a20 2020 2020 2020  on != 4:.       
+00065170: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00065180: 7228 2274 696d 655f 7365 7269 6573 206d  r("time_series m
+00065190: 7573 7420 6265 2061 2034 4420 696d 6167  ust be a 4D imag
+000651a0: 652e 2229 0a0a 2020 2020 2320 4372 6561  e.")..    # Crea
+000651b0: 7465 2061 2062 6f6f 6c65 616e 2069 6e64  te a boolean ind
+000651c0: 6578 2066 6f72 2076 6f6c 756d 6573 2074  ex for volumes t
+000651d0: 6f20 6b65 6570 0a20 2020 2076 6f6c 756d  o keep.    volum
+000651e0: 6573 5f74 6f5f 6b65 6570 203d 205b 6920  es_to_keep = [i 
+000651f0: 666f 7220 6920 696e 2072 616e 6765 2874  for i in range(t
+00065200: 696d 655f 7365 7269 6573 2e73 6861 7065  ime_series.shape
+00065210: 5b33 5d29 2069 6620 6920 6e6f 7420 696e  [3]) if i not in
+00065220: 2076 6f6c 756d 6573 5f74 6f5f 7265 6d6f   volumes_to_remo
+00065230: 7665 5d0a 0a20 2020 2023 2053 656c 6563  ve]..    # Selec
+00065240: 7420 7468 6520 766f 6c75 6d65 7320 746f  t the volumes to
+00065250: 206b 6565 700a 2020 2020 6669 6c74 6572   keep.    filter
+00065260: 6564 5f74 696d 655f 7365 7269 6573 203d  ed_time_series =
+00065270: 2061 6e74 732e 6672 6f6d 5f6e 756d 7079   ants.from_numpy
+00065280: 2820 7469 6d65 5f73 6572 6965 735b 2e2e  ( time_series[..
+00065290: 2e2c 2076 6f6c 756d 6573 5f74 6f5f 6b65  ., volumes_to_ke
+000652a0: 6570 5d20 290a 0a20 2020 2072 6574 7572  ep] )..    retur
+000652b0: 6e20 616e 7473 2e63 6f70 795f 696d 6167  n ants.copy_imag
+000652c0: 655f 696e 666f 2820 7469 6d65 5f73 6572  e_info( time_ser
+000652d0: 6965 732c 2066 696c 7465 7265 645f 7469  ies, filtered_ti
+000652e0: 6d65 5f73 6572 6965 7320 290a 0a64 6566  me_series )..def
+000652f0: 2072 656d 6f76 655f 656c 656d 656e 7473   remove_elements
+00065300: 5f66 726f 6d5f 6c69 7374 286f 7269 6769  _from_list(origi
+00065310: 6e61 6c5f 6c69 7374 2c20 656c 656d 656e  nal_list, elemen
+00065320: 7473 5f74 6f5f 7265 6d6f 7665 293a 0a20  ts_to_remove):. 
+00065330: 2020 2022 2222 0a20 2020 2052 656d 6f76     """.    Remov
+00065340: 6520 7370 6563 6966 6965 6420 656c 656d  e specified elem
+00065350: 656e 7473 2066 726f 6d20 6120 6c69 7374  ents from a list
+00065360: 2e0a 0a20 2020 2050 6172 616d 6574 6572  ...    Parameter
+00065370: 733a 0a20 2020 206f 7269 6769 6e61 6c5f  s:.    original_
+00065380: 6c69 7374 2028 6c69 7374 293a 2054 6865  list (list): The
+00065390: 206f 7269 6769 6e61 6c20 6c69 7374 2066   original list f
+000653a0: 726f 6d20 7768 6963 6820 656c 656d 656e  rom which elemen
+000653b0: 7473 2077 696c 6c20 6265 2072 656d 6f76  ts will be remov
+000653c0: 6564 2e0a 2020 2020 656c 656d 656e 7473  ed..    elements
+000653d0: 5f74 6f5f 7265 6d6f 7665 2028 6c69 7374  _to_remove (list
+000653e0: 293a 2041 206c 6973 7420 6f66 2065 6c65  ): A list of ele
+000653f0: 6d65 6e74 7320 7468 6174 206e 6565 6420  ments that need 
+00065400: 746f 2062 6520 7265 6d6f 7665 6420 6672  to be removed fr
+00065410: 6f6d 2074 6865 206f 7269 6769 6e61 6c20  om the original 
+00065420: 6c69 7374 2e0a 0a20 2020 2052 6574 7572  list...    Retur
+00065430: 6e73 3a0a 2020 2020 6c69 7374 3a20 4120  ns:.    list: A 
+00065440: 6e65 7720 6c69 7374 2077 6974 6820 7468  new list with th
+00065450: 6520 7370 6563 6966 6965 6420 656c 656d  e specified elem
+00065460: 656e 7473 2072 656d 6f76 6564 2e0a 2020  ents removed..  
+00065470: 2020 2222 220a 2020 2020 7265 7475 726e    """.    return
+00065480: 205b 656c 656d 656e 7420 666f 7220 656c   [element for el
+00065490: 656d 656e 7420 696e 206f 7269 6769 6e61  ement in origina
+000654a0: 6c5f 6c69 7374 2069 6620 656c 656d 656e  l_list if elemen
+000654b0: 7420 6e6f 7420 696e 2065 6c65 6d65 6e74  t not in element
+000654c0: 735f 746f 5f72 656d 6f76 655d 0a0a 0a64  s_to_remove]...d
+000654d0: 6566 2069 6d70 7574 655f 7469 6d65 7365  ef impute_timese
+000654e0: 7269 6573 2874 696d 655f 7365 7269 6573  ries(time_series
+000654f0: 2c20 766f 6c75 6d65 735f 746f 5f69 6d70  , volumes_to_imp
+00065500: 7574 652c 206d 6574 686f 643d 276c 696e  ute, method='lin
+00065510: 6561 7227 2c20 7665 7262 6f73 653d 4661  ear', verbose=Fa
+00065520: 6c73 6529 3a0a 2020 2020 2222 220a 2020  lse):.    """.  
+00065530: 2020 496d 7075 7465 2073 7065 6369 6669    Impute specifi
+00065540: 6564 2076 6f6c 756d 6573 2066 726f 6d20  ed volumes from 
+00065550: 6120 7469 6d65 2073 6572 6965 7320 7769  a time series wi
+00065560: 7468 2069 6e74 6572 706f 6c61 7465 6420  th interpolated 
+00065570: 7661 6c75 6573 2e0a 0a20 2020 203a 7061  values...    :pa
+00065580: 7261 6d20 7469 6d65 5f73 6572 6965 733a  ram time_series:
+00065590: 2041 4e54 7349 6d61 6765 2072 6570 7265   ANTsImage repre
+000655a0: 7365 6e74 696e 6720 7468 6520 7469 6d65  senting the time
+000655b0: 2073 6572 6965 7320 2834 4420 696d 6167   series (4D imag
+000655c0: 6529 2e0a 2020 2020 3a70 6172 616d 2076  e)..    :param v
+000655d0: 6f6c 756d 6573 5f74 6f5f 696d 7075 7465  olumes_to_impute
+000655e0: 3a20 4c69 7374 206f 6620 766f 6c75 6d65  : List of volume
+000655f0: 2069 6e64 6963 6573 2074 6f20 696d 7075   indices to impu
+00065600: 7465 2e0a 2020 2020 3a70 6172 616d 206d  te..    :param m
+00065610: 6574 686f 643a 2049 6e74 6572 706f 6c61  ethod: Interpola
+00065620: 7469 6f6e 206d 6574 686f 6420 2827 6c69  tion method ('li
+00065630: 6e65 6172 2720 6f72 206f 7468 6572 206d  near' or other m
+00065640: 6574 686f 6473 2069 6620 696d 706c 656d  ethods if implem
+00065650: 656e 7465 6429 2e0a 2020 2020 3a70 6172  ented)..    :par
+00065660: 616d 2076 6572 626f 7365 3a20 626f 6f6c  am verbose: bool
+00065670: 6561 6e0a 2020 2020 3a72 6574 7572 6e3a  ean.    :return:
+00065680: 2041 4e54 7349 6d61 6765 2077 6974 6820   ANTsImage with 
+00065690: 7370 6563 6966 6965 6420 766f 6c75 6d65  specified volume
+000656a0: 7320 696d 7075 7465 642e 0a20 2020 2022  s imputed..    "
+000656b0: 2222 0a20 2020 2069 6620 6e6f 7420 6973  "".    if not is
+000656c0: 696e 7374 616e 6365 2874 696d 655f 7365  instance(time_se
+000656d0: 7269 6573 2c20 616e 7473 2e41 4e54 7349  ries, ants.ANTsI
+000656e0: 6d61 6765 293a 0a20 2020 2020 2020 2072  mage):.        r
+000656f0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00065700: 2274 696d 655f 7365 7269 6573 206d 7573  "time_series mus
+00065710: 7420 6265 2061 6e20 414e 5473 496d 6167  t be an ANTsImag
+00065720: 652e 2229 0a0a 2020 2020 6966 2074 696d  e.")..    if tim
+00065730: 655f 7365 7269 6573 2e64 696d 656e 7369  e_series.dimensi
+00065740: 6f6e 2021 3d20 343a 0a20 2020 2020 2020  on != 4:.       
+00065750: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00065760: 7228 2274 696d 655f 7365 7269 6573 206d  r("time_series m
+00065770: 7573 7420 6265 2061 2034 4420 696d 6167  ust be a 4D imag
+00065780: 652e 2229 0a0a 2020 2020 2320 436f 6e76  e.")..    # Conv
+00065790: 6572 7420 7469 6d65 5f73 6572 6965 7320  ert time_series 
+000657a0: 746f 206e 756d 7079 2066 6f72 206d 616e  to numpy for man
+000657b0: 6970 756c 6174 696f 6e0a 2020 2020 7469  ipulation.    ti
+000657c0: 6d65 5f73 6572 6965 735f 6e70 203d 2074  me_series_np = t
+000657d0: 696d 655f 7365 7269 6573 2e6e 756d 7079  ime_series.numpy
+000657e0: 2829 0a20 2020 2074 6f74 616c 5f76 6f6c  ().    total_vol
+000657f0: 756d 6573 203d 2074 696d 655f 7365 7269  umes = time_seri
+00065800: 6573 5f6e 702e 7368 6170 655b 335d 0a0a  es_np.shape[3]..
+00065810: 2020 2020 2320 4372 6561 7465 2061 2063      # Create a c
+00065820: 6f6d 706c 656d 656e 7420 6c69 7374 206f  omplement list o
+00065830: 6620 766f 6c75 6d65 7320 6e6f 7420 746f  f volumes not to
+00065840: 2069 6d70 7574 650a 2020 2020 766f 6c75   impute.    volu
+00065850: 6d65 735f 6e6f 745f 746f 5f69 6d70 7574  mes_not_to_imput
+00065860: 6520 3d20 5b69 2066 6f72 2069 2069 6e20  e = [i for i in 
+00065870: 7261 6e67 6528 746f 7461 6c5f 766f 6c75  range(total_volu
+00065880: 6d65 7329 2069 6620 6920 6e6f 7420 696e  mes) if i not in
+00065890: 2076 6f6c 756d 6573 5f74 6f5f 696d 7075   volumes_to_impu
+000658a0: 7465 5d0a 0a20 2020 2023 2044 6566 696e  te]..    # Defin
+000658b0: 6520 7468 6520 6c6f 7765 7220 616e 6420  e the lower and 
+000658c0: 7570 7065 7220 626f 756e 6473 0a20 2020  upper bounds.   
+000658d0: 206d 696e 5f76 616c 6964 5f69 6e64 6578   min_valid_index
+000658e0: 203d 206d 696e 2876 6f6c 756d 6573 5f6e   = min(volumes_n
+000658f0: 6f74 5f74 6f5f 696d 7075 7465 290a 2020  ot_to_impute).  
+00065900: 2020 6d61 785f 7661 6c69 645f 696e 6465    max_valid_inde
+00065910: 7820 3d20 6d61 7828 766f 6c75 6d65 735f  x = max(volumes_
+00065920: 6e6f 745f 746f 5f69 6d70 7574 6529 0a0a  not_to_impute)..
+00065930: 2020 2020 666f 7220 766f 6c5f 6964 7820      for vol_idx 
+00065940: 696e 2076 6f6c 756d 6573 5f74 6f5f 696d  in volumes_to_im
+00065950: 7075 7465 3a0a 2020 2020 2020 2020 2320  pute:.        # 
+00065960: 456e 7375 7265 2074 6865 2076 6f6c 756d  Ensure the volum
+00065970: 6520 696e 6465 7820 6973 2077 6974 6869  e index is withi
+00065980: 6e20 7468 6520 7661 6c69 6420 7261 6e67  n the valid rang
+00065990: 650a 2020 2020 2020 2020 6966 2076 6f6c  e.        if vol
+000659a0: 5f69 6478 203c 2030 206f 7220 766f 6c5f  _idx < 0 or vol_
+000659b0: 6964 7820 3e3d 2074 6f74 616c 5f76 6f6c  idx >= total_vol
+000659c0: 756d 6573 3a0a 2020 2020 2020 2020 2020  umes:.          
+000659d0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+000659e0: 6f72 2866 2256 6f6c 756d 6520 696e 6465  or(f"Volume inde
+000659f0: 7820 7b76 6f6c 5f69 6478 7d20 6973 206f  x {vol_idx} is o
+00065a00: 7574 206f 6620 626f 756e 6473 2e22 290a  ut of bounds.").
+00065a10: 0a20 2020 2020 2020 2023 2046 696e 6420  .        # Find 
+00065a20: 7468 6520 6e65 6172 6573 7420 7661 6c69  the nearest vali
+00065a30: 6420 6c6f 7765 7220 696e 6465 7820 7769  d lower index wi
+00065a40: 7468 696e 2074 6865 2062 6f75 6e64 730a  thin the bounds.
+00065a50: 2020 2020 2020 2020 6c6f 7765 725f 6361          lower_ca
+00065a60: 6e64 6964 6174 6573 203d 205b 7620 666f  ndidates = [v fo
+00065a70: 7220 7620 696e 2076 6f6c 756d 6573 5f6e  r v in volumes_n
+00065a80: 6f74 5f74 6f5f 696d 7075 7465 2069 6620  ot_to_impute if 
+00065a90: 7620 3c3d 2076 6f6c 5f69 6478 5d0a 2020  v <= vol_idx].  
+00065aa0: 2020 2020 2020 6c6f 7765 725f 6964 7820        lower_idx 
+00065ab0: 3d20 6d61 7828 6c6f 7765 725f 6361 6e64  = max(lower_cand
+00065ac0: 6964 6174 6573 2920 6966 206c 6f77 6572  idates) if lower
+00065ad0: 5f63 616e 6469 6461 7465 7320 656c 7365  _candidates else
+00065ae0: 206d 696e 5f76 616c 6964 5f69 6e64 6578   min_valid_index
+00065af0: 0a0a 2020 2020 2020 2020 2320 4669 6e64  ..        # Find
+00065b00: 2074 6865 206e 6561 7265 7374 2076 616c   the nearest val
+00065b10: 6964 2075 7070 6572 2069 6e64 6578 2077  id upper index w
+00065b20: 6974 6869 6e20 7468 6520 626f 756e 6473  ithin the bounds
+00065b30: 0a20 2020 2020 2020 2075 7070 6572 5f63  .        upper_c
+00065b40: 616e 6469 6461 7465 7320 3d20 5b76 2066  andidates = [v f
+00065b50: 6f72 2076 2069 6e20 766f 6c75 6d65 735f  or v in volumes_
+00065b60: 6e6f 745f 746f 5f69 6d70 7574 6520 6966  not_to_impute if
+00065b70: 2076 203e 3d20 766f 6c5f 6964 785d 0a20   v >= vol_idx]. 
+00065b80: 2020 2020 2020 2075 7070 6572 5f69 6478         upper_idx
+00065b90: 203d 206d 696e 2875 7070 6572 5f63 616e   = min(upper_can
+00065ba0: 6469 6461 7465 7329 2069 6620 7570 7065  didates) if uppe
+00065bb0: 725f 6361 6e64 6964 6174 6573 2065 6c73  r_candidates els
+00065bc0: 6520 6d61 785f 7661 6c69 645f 696e 6465  e max_valid_inde
+00065bd0: 780a 0a20 2020 2020 2020 2069 6620 7665  x..        if ve
+00065be0: 7262 6f73 653a 0a20 2020 2020 2020 2020  rbose:.         
+00065bf0: 2020 2070 7269 6e74 2866 2249 6d70 7574     print(f"Imput
+00065c00: 696e 6720 766f 6c75 6d65 207b 766f 6c5f  ing volume {vol_
+00065c10: 6964 787d 2075 7369 6e67 2069 6e64 6963  idx} using indic
+00065c20: 6573 207b 6c6f 7765 725f 6964 787d 2061  es {lower_idx} a
+00065c30: 6e64 207b 7570 7065 725f 6964 787d 2229  nd {upper_idx}")
+00065c40: 0a0a 2020 2020 2020 2020 6966 206d 6574  ..        if met
+00065c50: 686f 6420 3d3d 2027 6c69 6e65 6172 273a  hod == 'linear':
+00065c60: 0a20 2020 2020 2020 2020 2020 2023 204c  .            # L
+00065c70: 696e 6561 7220 696e 7465 7270 6f6c 6174  inear interpolat
+00065c80: 696f 6e20 6265 7477 6565 6e20 7468 6520  ion between the 
+00065c90: 7477 6f20 6e65 6172 6573 7420 766f 6c75  two nearest volu
+00065ca0: 6d65 730a 2020 2020 2020 2020 2020 2020  mes.            
+00065cb0: 6c6f 7765 725f 766f 6c75 6d65 203d 2074  lower_volume = t
+00065cc0: 696d 655f 7365 7269 6573 5f6e 705b 2e2e  ime_series_np[..
+00065cd0: 2e2c 206c 6f77 6572 5f69 6478 5d0a 2020  ., lower_idx].  
+00065ce0: 2020 2020 2020 2020 2020 7570 7065 725f            upper_
+00065cf0: 766f 6c75 6d65 203d 2074 696d 655f 7365  volume = time_se
+00065d00: 7269 6573 5f6e 705b 2e2e 2e2c 2075 7070  ries_np[..., upp
+00065d10: 6572 5f69 6478 5d0a 2020 2020 2020 2020  er_idx].        
+00065d20: 2020 2020 696e 7465 7270 6f6c 6174 6564      interpolated
+00065d30: 5f76 6f6c 756d 6520 3d20 286c 6f77 6572  _volume = (lower
+00065d40: 5f76 6f6c 756d 6520 2b20 7570 7065 725f  _volume + upper_
+00065d50: 766f 6c75 6d65 2920 2f20 320a 2020 2020  volume) / 2.    
+00065d60: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00065d70: 2020 2020 2020 2320 506c 6163 6568 6f6c        # Placehol
+00065d80: 6465 7220 666f 7220 6f74 6865 7220 696e  der for other in
+00065d90: 7465 7270 6f6c 6174 696f 6e20 6d65 7468  terpolation meth
+00065da0: 6f64 730a 2020 2020 2020 2020 2020 2020  ods.            
+00065db0: 7261 6973 6520 4e6f 7449 6d70 6c65 6d65  raise NotImpleme
+00065dc0: 6e74 6564 4572 726f 7228 2243 7572 7265  ntedError("Curre
+00065dd0: 6e74 6c79 2c20 6f6e 6c79 206c 696e 6561  ntly, only linea
+00065de0: 7220 696e 7465 7270 6f6c 6174 696f 6e20  r interpolation 
+00065df0: 6973 2069 6d70 6c65 6d65 6e74 6564 2e22  is implemented."
+00065e00: 290a 0a20 2020 2020 2020 2023 2052 6570  )..        # Rep
+00065e10: 6c61 6365 2074 6865 2073 7065 6369 6669  lace the specifi
+00065e20: 6564 2076 6f6c 756d 6520 7769 7468 2074  ed volume with t
+00065e30: 6865 2069 6e74 6572 706f 6c61 7465 6420  he interpolated 
+00065e40: 766f 6c75 6d65 0a20 2020 2020 2020 2074  volume.        t
+00065e50: 696d 655f 7365 7269 6573 5f6e 705b 2e2e  ime_series_np[..
+00065e60: 2e2c 2076 6f6c 5f69 6478 5d20 3d20 696e  ., vol_idx] = in
+00065e70: 7465 7270 6f6c 6174 6564 5f76 6f6c 756d  terpolated_volum
+00065e80: 650a 0a20 2020 2023 2043 6f6e 7665 7274  e..    # Convert
+00065e90: 2074 6865 206e 756d 7079 2061 7272 6179   the numpy array
+00065ea0: 2062 6163 6b20 746f 2041 4e54 7349 6d61   back to ANTsIma
+00065eb0: 6765 0a20 2020 2069 6d70 7574 6564 5f74  ge.    imputed_t
+00065ec0: 696d 655f 7365 7269 6573 203d 2061 6e74  ime_series = ant
+00065ed0: 732e 6672 6f6d 5f6e 756d 7079 2874 696d  s.from_numpy(tim
+00065ee0: 655f 7365 7269 6573 5f6e 7029 0a20 2020  e_series_np).   
+00065ef0: 2069 6d70 7574 6564 5f74 696d 655f 7365   imputed_time_se
+00065f00: 7269 6573 203d 2061 6e74 732e 636f 7079  ries = ants.copy
+00065f10: 5f69 6d61 6765 5f69 6e66 6f28 7469 6d65  _image_info(time
+00065f20: 5f73 6572 6965 732c 2069 6d70 7574 6564  _series, imputed
+00065f30: 5f74 696d 655f 7365 7269 6573 290a 0a20  _time_series).. 
+00065f40: 2020 2072 6574 7572 6e20 696d 7075 7465     return impute
+00065f50: 645f 7469 6d65 5f73 6572 6965 730a 0a64  d_time_series..d
+00065f60: 6566 2069 6d70 7574 655f 6477 6928 2064  ef impute_dwi( d
+00065f70: 7769 2c20 7468 7265 7368 6f6c 6420 3d20  wi, threshold = 
+00065f80: 302e 3230 2c20 696d 7075 7465 6230 3d46  0.20, imputeb0=F
+00065f90: 616c 7365 2c20 6d61 736b 3d4e 6f6e 652c  alse, mask=None,
+00065fa0: 2076 6572 626f 7365 3d46 616c 7365 2029   verbose=False )
+00065fb0: 3a0a 2020 2020 2222 220a 2020 2020 4964  :.    """.    Id
+00065fc0: 656e 7469 6679 2062 6164 2076 6f6c 756d  entify bad volum
+00065fd0: 6573 2069 6e20 6120 6477 6920 616e 6420  es in a dwi and 
+00065fe0: 696d 7075 7465 2074 6865 6d20 6675 6c6c  impute them full
+00065ff0: 7920 6175 746f 6d61 7469 6361 6c6c 792e  y automatically.
+00066000: 0a0a 2020 2020 3a70 6172 616d 2064 7769  ..    :param dwi
+00066010: 3a20 414e 5473 496d 6167 6520 7265 7072  : ANTsImage repr
+00066020: 6573 656e 7469 6e67 2074 6865 2074 696d  esenting the tim
+00066030: 6520 7365 7269 6573 2028 3444 2069 6d61  e series (4D ima
+00066040: 6765 292e 0a20 2020 203a 7061 7261 6d20  ge)..    :param 
+00066050: 7468 7265 7368 6f6c 643a 2074 6872 6573  threshold: thres
+00066060: 686f 6c64 2028 302c 3129 2066 6f72 206f  hold (0,1) for o
+00066070: 7574 6c69 6572 6e65 7373 2028 6c6f 7765  utlierness (lowe
+00066080: 7220 6d65 616e 7320 696d 7075 7465 206d  r means impute m
+00066090: 6f72 6520 6461 7461 290a 2020 2020 3a70  ore data).    :p
+000660a0: 6172 616d 2069 6d70 7574 6562 303a 2062  aram imputeb0: b
+000660b0: 6f6f 6c65 616e 2077 696c 6c20 696d 7075  oolean will impu
+000660c0: 7465 2074 6865 2062 3020 7769 7468 2064  te the b0 with d
+000660d0: 7769 2069 6620 5472 7565 0a20 2020 203a  wi if True.    :
+000660e0: 7061 7261 6d20 6d61 736b 3a20 7265 7374  param mask: rest
+000660f0: 7269 6374 7320 746f 2061 2072 6567 696f  ricts to a regio
+00066100: 6e20 6f66 2069 6e74 6572 6573 740a 2020  n of interest.  
+00066110: 2020 3a70 6172 616d 2076 6572 626f 7365    :param verbose
+00066120: 3a20 626f 6f6c 6561 6e0a 2020 2020 3a72  : boolean.    :r
+00066130: 6574 7572 6e3a 2041 4e54 7349 6d61 6765  eturn: ANTsImage
+00066140: 2061 7574 6f6d 6174 6963 616c 6c79 2069   automatically i
+00066150: 6d70 7574 6564 2e0a 2020 2020 2222 220a  mputed..    """.
+00066160: 2020 2020 6c69 7374 3120 3d20 7365 676d      list1 = segm
+00066170: 656e 745f 7469 6d65 7365 7269 6573 5f62  ent_timeseries_b
+00066180: 795f 6d65 616e 7661 6c75 6528 2064 7769  y_meanvalue( dwi
+00066190: 2029 5b27 6869 6768 6572 6d65 616e 7327   )['highermeans'
+000661a0: 5d0a 2020 2020 6966 2069 6d70 7574 6562  ].    if imputeb
+000661b0: 303a 0a20 2020 2020 2020 2064 7769 6220  0:.        dwib 
+000661c0: 3d20 696d 7075 7465 5f74 696d 6573 6572  = impute_timeser
+000661d0: 6965 7328 2064 7769 2c20 6c69 7374 3120  ies( dwi, list1 
+000661e0: 2920 2320 666f 6375 7320 6f6e 2074 6865  ) # focus on the
+000661f0: 2064 7769 202d 206e 6f74 2074 6865 2062   dwi - not the b
+00066200: 300a 2020 2020 2020 2020 6c6f 6f70 6564  0.        looped
+00066210: 2c20 6c69 7374 3220 3d20 6c6f 6f70 5f74  , list2 = loop_t
+00066220: 696d 6573 6572 6965 735f 6365 6e73 6f72  imeseries_censor
+00066230: 696e 6728 2064 7769 622c 2074 6872 6573  ing( dwib, thres
+00066240: 686f 6c64 2c20 6d61 736b 2029 0a20 2020  hold, mask ).   
+00066250: 2065 6c73 653a 0a20 2020 2020 2020 206c   else:.        l
+00066260: 6f6f 7065 642c 206c 6973 7432 203d 206c  ooped, list2 = l
+00066270: 6f6f 705f 7469 6d65 7365 7269 6573 5f63  oop_timeseries_c
+00066280: 656e 736f 7269 6e67 2820 6477 692c 2074  ensoring( dwi, t
+00066290: 6872 6573 686f 6c64 2c20 6d61 736b 2029  hreshold, mask )
+000662a0: 0a20 2020 2069 6620 7665 7262 6f73 653a  .    if verbose:
+000662b0: 0a20 2020 2020 2020 2070 7269 6e74 2820  .        print( 
+000662c0: 6c69 7374 3120 290a 2020 2020 2020 2020  list1 ).        
+000662d0: 7072 696e 7428 206c 6973 7432 2029 0a20  print( list2 ). 
+000662e0: 2020 2063 6f6d 706c 656d 656e 7420 3d20     complement = 
+000662f0: 7265 6d6f 7665 5f65 6c65 6d65 6e74 735f  remove_elements_
+00066300: 6672 6f6d 5f6c 6973 7428 206c 6973 7432  from_list( list2
+00066310: 2c20 6c69 7374 3120 290a 2020 2020 6966  , list1 ).    if
+00066320: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+00066330: 2020 7072 696e 7428 2022 496d 7075 7469    print( "Imputi
+00066340: 6e67 3a22 290a 2020 2020 2020 2020 7072  ng:").        pr
+00066350: 696e 7428 2063 6f6d 706c 656d 656e 7420  int( complement 
+00066360: 290a 2020 2020 6966 206c 656e 2820 636f  ).    if len( co
+00066370: 6d70 6c65 6d65 6e74 2029 203d 3d20 303a  mplement ) == 0:
+00066380: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00066390: 6477 690a 2020 2020 7265 7475 726e 2069  dwi.    return i
+000663a0: 6d70 7574 655f 7469 6d65 7365 7269 6573  mpute_timeseries
+000663b0: 2820 6477 692c 2063 6f6d 706c 656d 656e  ( dwi, complemen
+000663c0: 7420 290a 0a64 6566 2063 656e 736f 725f  t )..def censor_
+000663d0: 6477 6928 2064 7769 2c20 6276 616c 2c20  dwi( dwi, bval, 
+000663e0: 6276 6563 2c20 7468 7265 7368 6f6c 6420  bvec, threshold 
+000663f0: 3d20 302e 3230 2c20 696d 7075 7465 6230  = 0.20, imputeb0
+00066400: 3d46 616c 7365 2c20 6d61 736b 3d4e 6f6e  =False, mask=Non
+00066410: 652c 2076 6572 626f 7365 3d46 616c 7365  e, verbose=False
+00066420: 2029 3a0a 2020 2020 2222 220a 2020 2020   ):.    """.    
+00066430: 4964 656e 7469 6679 2062 6164 2076 6f6c  Identify bad vol
+00066440: 756d 6573 2069 6e20 6120 6477 6920 616e  umes in a dwi an
+00066450: 6420 696d 7075 7465 2074 6865 6d20 6675  d impute them fu
+00066460: 6c6c 7920 6175 746f 6d61 7469 6361 6c6c  lly automaticall
+00066470: 792e 0a0a 2020 2020 3a70 6172 616d 2064  y...    :param d
+00066480: 7769 3a20 414e 5473 496d 6167 6520 7265  wi: ANTsImage re
+00066490: 7072 6573 656e 7469 6e67 2074 6865 2074  presenting the t
+000664a0: 696d 6520 7365 7269 6573 2028 3444 2069  ime series (4D i
+000664b0: 6d61 6765 292e 0a20 2020 203a 7061 7261  mage)..    :para
+000664c0: 6d20 6276 616c 3a20 6276 616c 2061 7272  m bval: bval arr
+000664d0: 6179 0a20 2020 203a 7061 7261 6d20 6276  ay.    :param bv
+000664e0: 6563 3a20 6276 6563 2061 7272 6179 0a20  ec: bvec array. 
+000664f0: 2020 203a 7061 7261 6d20 7468 7265 7368     :param thresh
+00066500: 6f6c 643a 2074 6872 6573 686f 6c64 2028  old: threshold (
+00066510: 302c 3129 2066 6f72 206f 7574 6c69 6572  0,1) for outlier
+00066520: 6e65 7373 2028 6c6f 7765 7220 6d65 616e  ness (lower mean
+00066530: 7320 696d 7075 7465 206d 6f72 6520 6461  s impute more da
+00066540: 7461 290a 2020 2020 3a70 6172 616d 2069  ta).    :param i
+00066550: 6d70 7574 6562 303a 2062 6f6f 6c65 616e  mputeb0: boolean
+00066560: 2077 696c 6c20 696d 7075 7465 2074 6865   will impute the
+00066570: 2062 3020 7769 7468 2064 7769 2069 6620   b0 with dwi if 
+00066580: 5472 7565 0a20 2020 203a 7061 7261 6d20  True.    :param 
+00066590: 6d61 736b 3a20 7265 7374 7269 6374 7320  mask: restricts 
+000665a0: 746f 2061 2072 6567 696f 6e20 6f66 2069  to a region of i
+000665b0: 6e74 6572 6573 740a 2020 2020 3a70 6172  nterest.    :par
+000665c0: 616d 2076 6572 626f 7365 3a20 626f 6f6c  am verbose: bool
+000665d0: 6561 6e0a 2020 2020 3a72 6574 7572 6e3a  ean.    :return:
+000665e0: 2041 4e54 7349 6d61 6765 2061 7574 6f6d   ANTsImage autom
+000665f0: 6174 6963 616c 6c79 2069 6d70 7574 6564  atically imputed
+00066600: 2e0a 2020 2020 2222 220a 2020 2020 6c69  ..    """.    li
+00066610: 7374 3120 3d20 7365 676d 656e 745f 7469  st1 = segment_ti
+00066620: 6d65 7365 7269 6573 5f62 795f 6d65 616e  meseries_by_mean
+00066630: 7661 6c75 6528 2064 7769 2029 5b27 6869  value( dwi )['hi
+00066640: 6768 6572 6d65 616e 7327 5d0a 2020 2020  ghermeans'].    
+00066650: 6966 2069 6d70 7574 6562 303a 0a20 2020  if imputeb0:.   
+00066660: 2020 2020 2064 7769 6220 3d20 696d 7075       dwib = impu
+00066670: 7465 5f74 696d 6573 6572 6965 7328 2064  te_timeseries( d
+00066680: 7769 2c20 6c69 7374 3120 2920 2320 666f  wi, list1 ) # fo
+00066690: 6375 7320 6f6e 2074 6865 2064 7769 202d  cus on the dwi -
+000666a0: 206e 6f74 2074 6865 2062 300a 2020 2020   not the b0.    
+000666b0: 2020 2020 6c6f 6f70 6564 2c20 6c69 7374      looped, list
+000666c0: 3220 3d20 6c6f 6f70 5f74 696d 6573 6572  2 = loop_timeser
+000666d0: 6965 735f 6365 6e73 6f72 696e 6728 2064  ies_censoring( d
+000666e0: 7769 622c 2074 6872 6573 686f 6c64 2c20  wib, threshold, 
+000666f0: 6d61 736b 2029 0a20 2020 2065 6c73 653a  mask ).    else:
+00066700: 0a20 2020 2020 2020 206c 6f6f 7065 642c  .        looped,
+00066710: 206c 6973 7432 203d 206c 6f6f 705f 7469   list2 = loop_ti
+00066720: 6d65 7365 7269 6573 5f63 656e 736f 7269  meseries_censori
+00066730: 6e67 2820 6477 692c 2074 6872 6573 686f  ng( dwi, thresho
+00066740: 6c64 2c20 6d61 736b 2029 0a20 2020 2069  ld, mask ).    i
+00066750: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+00066760: 2020 2070 7269 6e74 2820 6c69 7374 3120     print( list1 
+00066770: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
+00066780: 206c 6973 7432 2029 0a20 2020 2063 6f6d   list2 ).    com
+00066790: 706c 656d 656e 7420 3d20 7265 6d6f 7665  plement = remove
+000667a0: 5f65 6c65 6d65 6e74 735f 6672 6f6d 5f6c  _elements_from_l
+000667b0: 6973 7428 206c 6973 7432 2c20 6c69 7374  ist( list2, list
+000667c0: 3120 290a 2020 2020 6966 2076 6572 626f  1 ).    if verbo
+000667d0: 7365 3a0a 2020 2020 2020 2020 7072 696e  se:.        prin
+000667e0: 7428 2022 6365 6e73 6f72 696e 673a 2229  t( "censoring:")
+000667f0: 0a20 2020 2020 2020 2070 7269 6e74 2820  .        print( 
+00066800: 636f 6d70 6c65 6d65 6e74 2029 0a20 2020  complement ).   
+00066810: 2069 6620 6c65 6e28 2063 6f6d 706c 656d   if len( complem
+00066820: 656e 7420 2920 3d3d 2030 3a0a 2020 2020  ent ) == 0:.    
+00066830: 2020 2020 7265 7475 726e 2064 7769 2c20      return dwi, 
+00066840: 6276 616c 2c20 6276 6563 0a20 2020 2072  bval, bvec.    r
+00066850: 6574 7572 6e20 7265 6d6f 7665 5f76 6f6c  eturn remove_vol
+00066860: 756d 6573 5f66 726f 6d5f 7469 6d65 7365  umes_from_timese
+00066870: 7269 6573 2820 6477 692c 2063 6f6d 706c  ries( dwi, compl
+00066880: 656d 656e 7420 292c 2072 656d 6f76 655f  ement ), remove_
+00066890: 656c 656d 656e 7473 5f66 726f 6d5f 6e75  elements_from_nu
+000668a0: 6d70 795f 6172 7261 7928 2062 7661 6c2c  mpy_array( bval,
+000668b0: 2063 6f6d 706c 656d 656e 7420 292c 2072   complement ), r
+000668c0: 656d 6f76 655f 656c 656d 656e 7473 5f66  emove_elements_f
+000668d0: 726f 6d5f 6e75 6d70 795f 6172 7261 7928  rom_numpy_array(
+000668e0: 2062 7665 632c 2063 6f6d 706c 656d 656e   bvec, complemen
+000668f0: 7420 290a 0a0a 6465 6620 666c 6174 7465  t )...def flatte
+00066900: 6e5f 7469 6d65 5f73 6572 6965 7328 7469  n_time_series(ti
+00066910: 6d65 5f73 6572 6965 7329 3a0a 2020 2020  me_series):.    
+00066920: 2222 220a 2020 2020 466c 6174 7465 6e20  """.    Flatten 
+00066930: 6120 3444 2074 696d 6520 7365 7269 6573  a 4D time series
+00066940: 2069 6e74 6f20 6120 3244 2061 7272 6179   into a 2D array
+00066950: 2e0a 2020 2020 0a20 2020 203a 7061 7261  ..    .    :para
+00066960: 6d20 7469 6d65 5f73 6572 6965 733a 2041  m time_series: A
+00066970: 2034 4420 6e75 6d70 7920 6172 7261 7920   4D numpy array 
+00066980: 7768 6572 6520 7468 6520 6c61 7374 2064  where the last d
+00066990: 696d 656e 7369 6f6e 2069 7320 7469 6d65  imension is time
+000669a0: 2e0a 2020 2020 3a72 6574 7572 6e3a 2041  ..    :return: A
+000669b0: 2032 4420 6e75 6d70 7920 6172 7261 7920   2D numpy array 
+000669c0: 7768 6572 6520 6561 6368 2072 6f77 2069  where each row i
+000669d0: 7320 6120 666c 6174 7465 6e65 6420 766f  s a flattened vo
+000669e0: 6c75 6d65 2e0a 2020 2020 2222 220a 2020  lume..    """.  
+000669f0: 2020 6e5f 766f 6c75 6d65 7320 3d20 7469    n_volumes = ti
+00066a00: 6d65 5f73 6572 6965 732e 7368 6170 655b  me_series.shape[
+00066a10: 335d 0a20 2020 2072 6574 7572 6e20 7469  3].    return ti
+00066a20: 6d65 5f73 6572 6965 732e 7265 7368 6170  me_series.reshap
+00066a30: 6528 2d31 2c20 6e5f 766f 6c75 6d65 7329  e(-1, n_volumes)
+00066a40: 2e54 0a0a 6465 6620 6361 6c63 756c 6174  .T..def calculat
+00066a50: 655f 6c6f 6f70 5f73 636f 7265 7328 666c  e_loop_scores(fl
+00066a60: 6174 7465 6e65 645f 7365 7269 6573 2c20  attened_series, 
+00066a70: 6e5f 6e65 6967 6862 6f72 733d 3230 293a  n_neighbors=20):
+00066a80: 0a20 2020 2022 2222 0a20 2020 2043 616c  .    """.    Cal
+00066a90: 6375 6c61 7465 204c 6f63 616c 204f 7574  culate Local Out
+00066aa0: 6c69 6572 2050 726f 6261 6269 6c69 7469  lier Probabiliti
+00066ab0: 6573 2066 6f72 2065 6163 6820 766f 6c75  es for each volu
+00066ac0: 6d65 2e0a 2020 2020 0a20 2020 203a 7061  me..    .    :pa
+00066ad0: 7261 6d20 666c 6174 7465 6e65 645f 7365  ram flattened_se
+00066ae0: 7269 6573 3a20 4120 3244 206e 756d 7079  ries: A 2D numpy
+00066af0: 2061 7272 6179 2066 726f 6d20 666c 6174   array from flat
+00066b00: 7465 6e5f 7469 6d65 5f73 6572 6965 732e  ten_time_series.
+00066b10: 0a20 2020 203a 7061 7261 6d20 6e5f 6e65  .    :param n_ne
+00066b20: 6967 6862 6f72 733a 204e 756d 6265 7220  ighbors: Number 
+00066b30: 6f66 206e 6569 6768 626f 7273 2074 6f20  of neighbors to 
+00066b40: 7573 6520 666f 7220 6361 6c63 756c 6174  use for calculat
+00066b50: 696e 6720 4c4f 4620 7363 6f72 6573 2e0a  ing LOF scores..
+00066b60: 2020 2020 3a72 6574 7572 6e3a 2041 6e20      :return: An 
+00066b70: 6172 7261 7920 6f66 204c 6f4f 5020 7363  array of LoOP sc
+00066b80: 6f72 6573 2e0a 2020 2020 2222 220a 2020  ores..    """.  
+00066b90: 2020 6672 6f6d 2050 794e 6f6d 616c 7920    from PyNomaly 
+00066ba0: 696d 706f 7274 206c 6f6f 700a 2020 2020  import loop.    
+00066bb0: 6672 6f6d 2073 6b6c 6561 726e 2e6e 6569  from sklearn.nei
+00066bc0: 6768 626f 7273 2069 6d70 6f72 7420 4e65  ghbors import Ne
+00066bd0: 6172 6573 744e 6569 6768 626f 7273 0a20  arestNeighbors. 
+00066be0: 2020 2066 726f 6d20 736b 6c65 6172 6e2e     from sklearn.
+00066bf0: 7072 6570 726f 6365 7373 696e 6720 696d  preprocessing im
+00066c00: 706f 7274 2053 7461 6e64 6172 6453 6361  port StandardSca
+00066c10: 6c65 720a 2020 2020 2320 7265 706c 6163  ler.    # replac
+00066c20: 6520 6e61 6e73 2077 6974 6820 7a65 726f  e nans with zero
+00066c30: 0a20 2020 2066 6c61 7474 656e 6564 5f73  .    flattened_s
+00066c40: 6572 6965 733d 6e70 2e6e 616e 5f74 6f5f  eries=np.nan_to_
+00066c50: 6e75 6d28 666c 6174 7465 6e65 645f 7365  num(flattened_se
+00066c60: 7269 6573 2c20 6e61 6e3d 3029 0a20 2020  ries, nan=0).   
+00066c70: 2073 6361 6c65 7220 3d20 5374 616e 6461   scaler = Standa
+00066c80: 7264 5363 616c 6572 2829 0a20 2020 2073  rdScaler().    s
+00066c90: 6361 6c65 722e 6669 7428 666c 6174 7465  caler.fit(flatte
+00066ca0: 6e65 645f 7365 7269 6573 290a 2020 2020  ned_series).    
+00066cb0: 6461 7461 203d 2073 6361 6c65 722e 7472  data = scaler.tr
+00066cc0: 616e 7366 6f72 6d28 666c 6174 7465 6e65  ansform(flattene
+00066cd0: 645f 7365 7269 6573 290a 2020 2020 6461  d_series).    da
+00066ce0: 7461 3d6e 702e 6e61 6e5f 746f 5f6e 756d  ta=np.nan_to_num
+00066cf0: 2864 6174 612c 206e 616e 3d30 290a 2020  (data, nan=0).  
+00066d00: 2020 6966 206e 5f6e 6569 6768 626f 7273    if n_neighbors
+00066d10: 203e 2069 6e74 2866 6c61 7474 656e 6564   > int(flattened
+00066d20: 5f73 6572 6965 732e 7368 6170 655b 305d  _series.shape[0]
+00066d30: 2f32 2e30 293a 0a20 2020 2020 2020 206e  /2.0):.        n
+00066d40: 5f6e 6569 6768 626f 7273 203d 2069 6e74  _neighbors = int
+00066d50: 2866 6c61 7474 656e 6564 5f73 6572 6965  (flattened_serie
+00066d60: 732e 7368 6170 655b 305d 2f32 2e30 290a  s.shape[0]/2.0).
+00066d70: 2020 2020 6e65 6967 6820 3d20 4e65 6172      neigh = Near
+00066d80: 6573 744e 6569 6768 626f 7273 286e 5f6e  estNeighbors(n_n
+00066d90: 6569 6768 626f 7273 3d6e 5f6e 6569 6768  eighbors=n_neigh
+00066da0: 626f 7273 2c20 6d65 7472 6963 3d27 6d69  bors, metric='mi
+00066db0: 6e6b 6f77 736b 6927 290a 2020 2020 6e65  nkowski').    ne
+00066dc0: 6967 682e 6669 7428 6461 7461 290a 2020  igh.fit(data).  
+00066dd0: 2020 642c 2069 6478 203d 206e 6569 6768    d, idx = neigh
+00066de0: 2e6b 6e65 6967 6862 6f72 7328 6461 7461  .kneighbors(data
+00066df0: 2c20 7265 7475 726e 5f64 6973 7461 6e63  , return_distanc
+00066e00: 653d 5472 7565 290a 2020 2020 6d20 3d20  e=True).    m = 
+00066e10: 6c6f 6f70 2e4c 6f63 616c 4f75 746c 6965  loop.LocalOutlie
+00066e20: 7250 726f 6261 6269 6c69 7479 2864 6973  rProbability(dis
+00066e30: 7461 6e63 655f 6d61 7472 6978 3d64 2c20  tance_matrix=d, 
+00066e40: 6e65 6967 6862 6f72 5f6d 6174 7269 783d  neighbor_matrix=
+00066e50: 6964 782c 206e 5f6e 6569 6768 626f 7273  idx, n_neighbors
+00066e60: 3d6e 5f6e 6569 6768 626f 7273 292e 6669  =n_neighbors).fi
+00066e70: 7428 290a 2020 2020 7265 7475 726e 206d  t().    return m
+00066e80: 2e6c 6f63 616c 5f6f 7574 6c69 6572 5f70  .local_outlier_p
+00066e90: 726f 6261 6269 6c69 7469 6573 5b3a 5d0a  robabilities[:].
+00066ea0: 0a64 6566 2073 636f 7265 5f66 6d72 695f  .def score_fmri_
+00066eb0: 6365 6e73 6f72 696e 6728 6362 6674 732c  censoring(cbfts,
+00066ec0: 2063 7366 5f73 6567 2c20 676d 5f73 6567   csf_seg, gm_seg
+00066ed0: 2c20 776d 5f73 6567 2029 3a0a 2020 2020  , wm_seg ):.    
+00066ee0: 2222 220a 2020 2020 5072 6f63 6573 7320  """.    Process 
+00066ef0: 4342 4620 7469 6d65 2073 6572 6965 7320  CBF time series 
+00066f00: 746f 2072 656d 6f76 6520 6869 6768 2d6c  to remove high-l
+00066f10: 6576 6572 6167 6520 706f 696e 7473 2e0a  everage points..
+00066f20: 2020 2020 4465 7269 7665 6420 6672 6f6d      Derived from
+00066f30: 2074 6865 2053 434f 5245 2061 6c67 6f72   the SCORE algor
+00066f40: 6974 686d 2062 7920 5375 6469 7074 6f20  ithm by Sudipto 
+00066f50: 446f 6c75 6920 6574 2e20 616c 2e0a 0a20  Dolui et. al... 
+00066f60: 2020 2050 6172 616d 6574 6572 733a 0a20     Parameters:. 
+00066f70: 2020 2063 6266 7473 2028 414e 5473 496d     cbfts (ANTsIm
+00066f80: 6167 6529 3a20 3444 2041 4e54 7349 6d61  age): 4D ANTsIma
+00066f90: 6765 206f 6620 4342 4620 7469 6d65 2073  ge of CBF time s
+00066fa0: 6572 6965 732e 0a20 2020 2063 7366 5f73  eries..    csf_s
+00066fb0: 6567 2028 414e 5473 496d 6167 6529 3a20  eg (ANTsImage): 
+00066fc0: 4353 4620 6269 6e61 7279 206d 6170 2e0a  CSF binary map..
+00066fd0: 2020 2020 676d 5f73 6567 2028 414e 5473      gm_seg (ANTs
+00066fe0: 496d 6167 6529 3a20 4772 6179 206d 6174  Image): Gray mat
+00066ff0: 7465 7220 6269 6e61 7279 206d 6170 2e0a  ter binary map..
+00067000: 2020 2020 776d 5f73 6567 2028 414e 5473      wm_seg (ANTs
+00067010: 496d 6167 6529 3a20 574d 2062 696e 6172  Image): WM binar
+00067020: 7920 6d61 702e 0a0a 2020 2020 5265 7475  y map...    Retu
+00067030: 726e 733a 0a20 2020 2041 4e54 7349 6d61  rns:.    ANTsIma
+00067040: 6765 3a20 5072 6f63 6573 7365 6420 4342  ge: Processed CB
+00067050: 4620 7469 6d65 2073 6572 6965 732e 0a20  F time series.. 
+00067060: 2020 206e 6461 7272 6179 3a20 496e 6465     ndarray: Inde
+00067070: 7820 6f66 2072 656d 6f76 6564 2076 6f6c  x of removed vol
+00067080: 756d 6573 2e0a 2020 2020 2222 220a 2020  umes..    """.  
+00067090: 2020 0a20 2020 206e 5f67 6d5f 766f 7865    .    n_gm_voxe
+000670a0: 6c73 203d 206e 702e 7375 6d28 676d 5f73  ls = np.sum(gm_s
+000670b0: 6567 2e6e 756d 7079 2829 2920 2d20 310a  eg.numpy()) - 1.
+000670c0: 2020 2020 6e5f 776d 5f76 6f78 656c 7320      n_wm_voxels 
+000670d0: 3d20 6e70 2e73 756d 2877 6d5f 7365 672e  = np.sum(wm_seg.
+000670e0: 6e75 6d70 7928 2929 202d 2031 0a20 2020  numpy()) - 1.   
+000670f0: 206e 5f63 7366 5f76 6f78 656c 7320 3d20   n_csf_voxels = 
+00067100: 6e70 2e73 756d 2863 7366 5f73 6567 2e6e  np.sum(csf_seg.n
+00067110: 756d 7079 2829 2920 2d20 310a 2020 2020  umpy()) - 1.    
+00067120: 6d61 736b 3169 6d67 203d 2067 6d5f 7365  mask1img = gm_se
+00067130: 6720 2b20 776d 5f73 6567 202b 2063 7366  g + wm_seg + csf
+00067140: 5f73 6567 0a20 2020 206d 6173 6b31 203d  _seg.    mask1 =
+00067150: 2028 6d61 736b 3169 6d67 3d3d 3129 2e6e   (mask1img==1).n
+00067160: 756d 7079 2829 0a20 2020 200a 2020 2020  umpy().    .    
+00067170: 6362 6674 735f 6e70 203d 2063 6266 7473  cbfts_np = cbfts
+00067180: 2e6e 756d 7079 2829 0a20 2020 2067 6d62  .numpy().    gmb
+00067190: 6f6f 6c20 3d20 2867 6d5f 7365 673d 3d31  ool = (gm_seg==1
+000671a0: 292e 6e75 6d70 7928 290a 2020 2020 6373  ).numpy().    cs
+000671b0: 6662 6f6f 6c20 3d20 2863 7366 5f73 6567  fbool = (csf_seg
+000671c0: 3d3d 3129 2e6e 756d 7079 2829 0a20 2020  ==1).numpy().   
+000671d0: 2077 6d62 6f6f 6c20 3d20 2877 6d5f 7365   wmbool = (wm_se
+000671e0: 673d 3d31 292e 6e75 6d70 7928 290a 2020  g==1).numpy().  
+000671f0: 2020 676d 5f63 6266 5f74 7320 3d20 616e    gm_cbf_ts = an
+00067200: 7473 2e74 696d 6573 6572 6965 735f 746f  ts.timeseries_to
+00067210: 5f6d 6174 7269 7828 2063 6266 7473 2c20  _matrix( cbfts, 
+00067220: 676d 5f73 6567 2029 0a20 2020 2067 6d5f  gm_seg ).    gm_
+00067230: 6362 665f 7473 203d 206e 702e 7371 7565  cbf_ts = np.sque
+00067240: 657a 6528 6e70 2e6d 6561 6e28 676d 5f63  eze(np.mean(gm_c
+00067250: 6266 5f74 732c 2061 7869 733d 3129 290a  bf_ts, axis=1)).
+00067260: 2020 2020 0a20 2020 206d 6564 6961 6e5f      .    median_
+00067270: 676d 5f63 6266 203d 206e 702e 6d65 6469  gm_cbf = np.medi
+00067280: 616e 2867 6d5f 6362 665f 7473 290a 2020  an(gm_cbf_ts).  
+00067290: 2020 6d61 645f 676d 5f63 6266 203d 206e    mad_gm_cbf = n
+000672a0: 702e 6d65 6469 616e 286e 702e 6162 7328  p.median(np.abs(
+000672b0: 676d 5f63 6266 5f74 7320 2d20 6d65 6469  gm_cbf_ts - medi
+000672c0: 616e 5f67 6d5f 6362 6629 2920 2f20 302e  an_gm_cbf)) / 0.
+000672d0: 3637 350a 2020 2020 696e 6478 203d 206e  675.    indx = n
+000672e0: 702e 6162 7328 676d 5f63 6266 5f74 7320  p.abs(gm_cbf_ts 
+000672f0: 2d20 6d65 6469 616e 5f67 6d5f 6362 6629  - median_gm_cbf)
+00067300: 203e 2028 322e 3520 2a20 6d61 645f 676d   > (2.5 * mad_gm
+00067310: 5f63 6266 290a 2020 2020 0a20 2020 2023  _cbf).    .    #
+00067320: 2074 6865 2073 7061 7469 616c 206d 6561   the spatial mea
+00067330: 6e0a 2020 2020 7370 6174 6d65 616e 6e70  n.    spatmeannp
+00067340: 203d 206e 702e 6d65 616e 2863 6266 7473   = np.mean(cbfts
+00067350: 5f6e 705b 3a2c 203a 2c20 3a2c 207e 696e  _np[:, :, :, ~in
+00067360: 6478 5d2c 2061 7869 733d 3329 0a20 2020  dx], axis=3).   
+00067370: 2073 7061 746d 6561 6e20 3d20 616e 7473   spatmean = ants
+00067380: 2e66 726f 6d5f 6e75 6d70 7928 2073 7061  .from_numpy( spa
+00067390: 746d 6561 6e6e 7020 290a 2020 2020 5620  tmeannp ).    V 
+000673a0: 3d20 280a 2020 2020 2020 2020 6e5f 676d  = (.        n_gm
+000673b0: 5f76 6f78 656c 7320 2a20 6e70 2e76 6172  _voxels * np.var
+000673c0: 2873 7061 746d 6561 6e6e 705b 676d 626f  (spatmeannp[gmbo
+000673d0: 6f6c 5d29 0a20 2020 2020 2020 202b 206e  ol]).        + n
+000673e0: 5f77 6d5f 766f 7865 6c73 202a 206e 702e  _wm_voxels * np.
+000673f0: 7661 7228 7370 6174 6d65 616e 6e70 5b77  var(spatmeannp[w
+00067400: 6d62 6f6f 6c5d 290a 2020 2020 2020 2020  mbool]).        
+00067410: 2b20 6e5f 6373 665f 766f 7865 6c73 202a  + n_csf_voxels *
+00067420: 206e 702e 7661 7228 7370 6174 6d65 616e   np.var(spatmean
+00067430: 6e70 5b63 7366 626f 6f6c 5d29 0a20 2020  np[csfbool]).   
+00067440: 2029 0a20 2020 2056 3120 3d20 6d61 7468   ).    V1 = math
+00067450: 2e69 6e66 0a20 2020 2063 743d 300a 2020  .inf.    ct=0.  
+00067460: 2020 7768 696c 6520 5620 3c20 5631 3a0a    while V < V1:.
+00067470: 2020 2020 2020 2020 6374 3d63 742b 310a          ct=ct+1.
+00067480: 2020 2020 2020 2020 5631 203d 2056 0a20          V1 = V. 
+00067490: 2020 2020 2020 2043 4320 3d20 6e70 2e7a         CC = np.z
+000674a0: 6572 6f73 2863 6266 7473 5f6e 702e 7368  eros(cbfts_np.sh
+000674b0: 6170 655b 335d 290a 2020 2020 2020 2020  ape[3]).        
+000674c0: 666f 7220 7320 696e 2072 616e 6765 2863  for s in range(c
+000674d0: 6266 7473 5f6e 702e 7368 6170 655b 335d  bfts_np.shape[3]
+000674e0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+000674f0: 6620 696e 6478 5b73 5d3a 0a20 2020 2020  f indx[s]:.     
+00067500: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00067510: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
+00067520: 746d 7031 203d 2061 6e74 732e 6672 6f6d  tmp1 = ants.from
+00067530: 5f6e 756d 7079 2820 6362 6674 735f 6e70  _numpy( cbfts_np
+00067540: 5b3a 2c20 3a2c 203a 2c20 735d 2029 0a20  [:, :, :, s] ). 
+00067550: 2020 2020 2020 2020 2020 2043 435b 735d             CC[s]
+00067560: 203d 2061 6e74 732e 696d 6167 655f 7369   = ants.image_si
+00067570: 6d69 6c61 7269 7479 2820 7370 6174 6d65  milarity( spatme
+00067580: 616e 2c20 746d 7031 2c20 6d65 7472 6963  an, tmp1, metric
+00067590: 5f74 7970 653d 2743 6f72 7265 6c61 7469  _type='Correlati
+000675a0: 6f6e 272c 2066 6978 6564 5f6d 6173 6b3d  on', fixed_mask=
+000675b0: 6d61 736b 3169 6d67 2029 0a20 2020 2020  mask1img ).     
+000675c0: 2020 2069 6e78 203d 206e 702e 6172 676d     inx = np.argm
+000675d0: 696e 2843 4329 0a20 2020 2020 2020 2069  in(CC).        i
+000675e0: 6e64 785b 696e 785d 203d 2054 7275 650a  ndx[inx] = True.
+000675f0: 2020 2020 2020 2020 7370 6174 6d65 616e          spatmean
+00067600: 6e70 203d 206e 702e 6d65 616e 2863 6266  np = np.mean(cbf
+00067610: 7473 5f6e 705b 3a2c 203a 2c20 3a2c 207e  ts_np[:, :, :, ~
+00067620: 696e 6478 5d2c 2061 7869 733d 3329 0a20  indx], axis=3). 
+00067630: 2020 2020 2020 2073 7061 746d 6561 6e20         spatmean 
+00067640: 3d20 616e 7473 2e66 726f 6d5f 6e75 6d70  = ants.from_nump
+00067650: 7928 2073 7061 746d 6561 6e6e 7020 290a  y( spatmeannp ).
+00067660: 2020 2020 2020 2020 5620 3d20 280a 2020          V = (.  
+00067670: 2020 2020 2020 2020 6e5f 676d 5f76 6f78          n_gm_vox
+00067680: 656c 7320 2a20 6e70 2e76 6172 2873 7061  els * np.var(spa
+00067690: 746d 6561 6e6e 705b 676d 626f 6f6c 5d29  tmeannp[gmbool])
+000676a0: 202b 200a 2020 2020 2020 2020 2020 6e5f   + .          n_
+000676b0: 776d 5f76 6f78 656c 7320 2a20 6e70 2e76  wm_voxels * np.v
+000676c0: 6172 2873 7061 746d 6561 6e6e 705b 776d  ar(spatmeannp[wm
+000676d0: 626f 6f6c 5d29 202b 200a 2020 2020 2020  bool]) + .      
+000676e0: 2020 2020 6e5f 6373 665f 766f 7865 6c73      n_csf_voxels
+000676f0: 202a 206e 702e 7661 7228 7370 6174 6d65   * np.var(spatme
+00067700: 616e 6e70 5b63 7366 626f 6f6c 5d29 0a20  annp[csfbool]). 
+00067710: 2020 2020 2020 2029 0a20 2020 2063 6266         ).    cbf
+00067720: 7473 5f72 6563 6f6e 203d 2063 6266 7473  ts_recon = cbfts
+00067730: 5f6e 705b 3a2c 203a 2c20 3a2c 207e 696e  _np[:, :, :, ~in
+00067740: 6478 5d0a 2020 2020 6362 6674 735f 7265  dx].    cbfts_re
+00067750: 636f 6e20 3d20 6e70 2e6e 616e 5f74 6f5f  con = np.nan_to_
+00067760: 6e75 6d28 6362 6674 735f 7265 636f 6e29  num(cbfts_recon)
+00067770: 0a20 2020 2063 6266 7473 5f72 6563 6f6e  .    cbfts_recon
+00067780: 5f61 6e74 7320 3d20 616e 7473 2e66 726f  _ants = ants.fro
+00067790: 6d5f 6e75 6d70 7928 6362 6674 735f 7265  m_numpy(cbfts_re
+000677a0: 636f 6e29 0a20 2020 2063 6266 7473 5f72  con).    cbfts_r
+000677b0: 6563 6f6e 5f61 6e74 7320 3d20 616e 7473  econ_ants = ants
+000677c0: 2e63 6f70 795f 696d 6167 655f 696e 666f  .copy_image_info
+000677d0: 2863 6266 7473 2c20 6362 6674 735f 7265  (cbfts, cbfts_re
+000677e0: 636f 6e5f 616e 7473 290a 2020 2020 7265  con_ants).    re
+000677f0: 7475 726e 2063 6266 7473 5f72 6563 6f6e  turn cbfts_recon
+00067800: 5f61 6e74 732c 2069 6e64 780a 0a64 6566  _ants, indx..def
+00067810: 206c 6f6f 705f 7469 6d65 7365 7269 6573   loop_timeseries
+00067820: 5f63 656e 736f 7269 6e67 2878 2c20 7468  _censoring(x, th
+00067830: 7265 7368 6f6c 643d 302e 352c 206d 6173  reshold=0.5, mas
+00067840: 6b3d 4e6f 6e65 2c20 7665 7262 6f73 653d  k=None, verbose=
+00067850: 4661 6c73 6529 3a0a 2020 2020 2222 220a  False):.    """.
+00067860: 2020 2020 4365 6e73 6f72 2068 6967 6820      Censor high 
+00067870: 6c65 7665 7261 6765 2076 6f6c 756d 6573  leverage volumes
+00067880: 2066 726f 6d20 6120 7469 6d65 2073 6572   from a time ser
+00067890: 6965 7320 7573 696e 6720 4c6f 6361 6c20  ies using Local 
+000678a0: 4f75 746c 6965 7220 5072 6f62 6162 696c  Outlier Probabil
+000678b0: 6974 6965 7320 284c 6f4f 5029 2e0a 0a20  ities (LoOP)... 
+000678c0: 2020 2050 6172 616d 6574 6572 733a 0a20     Parameters:. 
+000678d0: 2020 2078 2028 414e 5473 496d 6167 6529     x (ANTsImage)
+000678e0: 3a20 4120 3444 2074 696d 6520 7365 7269  : A 4D time seri
+000678f0: 6573 2069 6d61 6765 2e0a 2020 2020 7468  es image..    th
+00067900: 7265 7368 6f6c 6420 2866 6c6f 6174 293a  reshold (float):
+00067910: 2054 6872 6573 686f 6c64 2066 6f72 2064   Threshold for d
+00067920: 6574 6572 6d69 6e69 6e67 2068 6967 6820  etermining high 
+00067930: 6c65 7665 7261 6765 2076 6f6c 756d 6573  leverage volumes
+00067940: 2062 6173 6564 206f 6e20 4c6f 4f50 2073   based on LoOP s
+00067950: 636f 7265 732e 0a20 2020 206d 6173 6b20  cores..    mask 
+00067960: 2861 6e74 7349 6d61 6765 293a 2072 6573  (antsImage): res
+00067970: 7472 6963 7473 2074 6f20 6120 524f 490a  tricts to a ROI.
+00067980: 2020 2020 7665 7262 6f73 6520 2862 6f6f      verbose (boo
+00067990: 6c29 0a0a 2020 2020 5265 7475 726e 733a  l)..    Returns:
+000679a0: 0a20 2020 2074 7570 6c65 3a20 4120 7475  .    tuple: A tu
+000679b0: 706c 6520 636f 6e74 6169 6e69 6e67 2074  ple containing t
+000679c0: 6865 2063 656e 736f 7265 6420 7469 6d65  he censored time
+000679d0: 2073 6572 6965 7320 2841 4e54 7349 6d61   series (ANTsIma
+000679e0: 6765 2920 616e 6420 7468 6520 696e 6469  ge) and the indi
+000679f0: 6365 7320 6f66 2074 6865 2068 6967 6820  ces of the high 
+00067a00: 6c65 7665 7261 6765 2076 6f6c 756d 6573  leverage volumes
+00067a10: 2e0a 2020 2020 2222 220a 2020 2020 696d  ..    """.    im
+00067a20: 706f 7274 2077 6172 6e69 6e67 730a 2020  port warnings.  
+00067a30: 2020 6966 2078 2e73 6861 7065 5b33 5d20    if x.shape[3] 
+00067a40: 3c20 3230 3a20 2320 6a75 7374 2061 2067  < 20: # just a g
+00067a50: 7565 7373 2061 7420 7768 6174 2077 6520  uess at what we 
+00067a60: 6e65 6564 2068 6572 6520 2e2e 2e0a 2020  need here ....  
+00067a70: 2020 2020 2020 7761 726e 696e 6773 2e77        warnings.w
+00067a80: 6172 6e28 2257 6172 6e69 6e67 3a20 7468  arn("Warning: th
+00067a90: 6520 7469 6d65 2064 696d 656e 7369 6f6e  e time dimension
+00067aa0: 2069 7320 3c20 3230 202d 2074 6f6f 2066   is < 20 - too f
+00067ab0: 6577 2073 616d 706c 6573 2066 6f72 206c  ew samples for l
+00067ac0: 6f6f 702e 206a 7573 7420 7265 7475 726e  oop. just return
+00067ad0: 2074 6865 206f 7269 6769 6e61 6c20 6461   the original da
+00067ae0: 7461 2e22 290a 2020 2020 2020 2020 7265  ta.").        re
+00067af0: 7475 726e 2078 2c20 5b5d 0a20 2020 2069  turn x, [].    i
+00067b00: 6620 6d61 736b 2069 7320 4e6f 6e65 3a0a  f mask is None:.
+00067b10: 2020 2020 2020 2020 666c 6174 7465 6e65          flattene
+00067b20: 645f 7365 7269 6573 203d 2066 6c61 7474  d_series = flatt
+00067b30: 656e 5f74 696d 655f 7365 7269 6573 2878  en_time_series(x
+00067b40: 2e6e 756d 7079 2829 290a 2020 2020 656c  .numpy()).    el
+00067b50: 7365 3a0a 2020 2020 2020 2020 666c 6174  se:.        flat
+00067b60: 7465 6e65 645f 7365 7269 6573 203d 2061  tened_series = a
+00067b70: 6e74 732e 7469 6d65 7365 7269 6573 5f74  nts.timeseries_t
+00067b80: 6f5f 6d61 7472 6978 2820 782c 206d 6173  o_matrix( x, mas
+00067b90: 6b20 290a 2020 2020 6c6f 6f70 5f73 636f  k ).    loop_sco
+00067ba0: 7265 7320 3d20 6361 6c63 756c 6174 655f  res = calculate_
+00067bb0: 6c6f 6f70 5f73 636f 7265 7328 666c 6174  loop_scores(flat
+00067bc0: 7465 6e65 645f 7365 7269 6573 290a 2020  tened_series).  
+00067bd0: 2020 6869 6768 5f6c 6576 6572 6167 655f    high_leverage_
+00067be0: 766f 6c75 6d65 7320 3d20 6e70 2e77 6865  volumes = np.whe
+00067bf0: 7265 286c 6f6f 705f 7363 6f72 6573 203e  re(loop_scores >
+00067c00: 2074 6872 6573 686f 6c64 295b 305d 0a20   threshold)[0]. 
+00067c10: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+00067c20: 2020 2020 2020 2070 7269 6e74 2822 4c4f         print("LO
+00067c30: 4f50 2048 6967 6820 4c65 7665 7261 6765  OP High Leverage
+00067c40: 2056 6f6c 756d 6573 3a22 2c20 6869 6768   Volumes:", high
+00067c50: 5f6c 6576 6572 6167 655f 766f 6c75 6d65  _leverage_volume
+00067c60: 7329 0a20 2020 206e 6577 5f61 736c 203d  s).    new_asl =
+00067c70: 2072 656d 6f76 655f 766f 6c75 6d65 735f   remove_volumes_
+00067c80: 6672 6f6d 5f74 696d 6573 6572 6965 7328  from_timeseries(
+00067c90: 782c 2068 6967 685f 6c65 7665 7261 6765  x, high_leverage
+00067ca0: 5f76 6f6c 756d 6573 290a 2020 2020 7265  _volumes).    re
+00067cb0: 7475 726e 206e 6577 5f61 736c 2c20 6869  turn new_asl, hi
+00067cc0: 6768 5f6c 6576 6572 6167 655f 766f 6c75  gh_leverage_volu
+00067cd0: 6d65 730a 0a0a 6465 6620 6e6f 7665 6c74  mes...def novelt
+00067ce0: 795f 6465 7465 6374 696f 6e5f 6565 2864  y_detection_ee(d
+00067cf0: 665f 7472 6169 6e2c 2064 665f 7465 7374  f_train, df_test
+00067d00: 2c20 636f 6e74 616d 696e 6174 696f 6e3d  , contamination=
+00067d10: 302e 3035 293a 0a20 2020 2022 2222 0a20  0.05):.    """. 
+00067d20: 2020 2054 6869 7320 6675 6e63 7469 6f6e     This function
+00067d30: 2070 6572 666f 726d 7320 6e6f 7665 6c74   performs novelt
+00067d40: 7920 6465 7465 6374 696f 6e20 7573 696e  y detection usin
+00067d50: 6720 456c 6c69 7074 6963 2045 6e76 656c  g Elliptic Envel
+00067d60: 6f70 652e 0a0a 2020 2020 5061 7261 6d65  ope...    Parame
+00067d70: 7465 7273 3a0a 0a20 2020 202d 2064 665f  ters:..    - df_
+00067d80: 7472 6169 6e20 2870 616e 6461 7320 6461  train (pandas da
+00067d90: 7461 6672 616d 6529 3a20 7472 6169 6e69  taframe): traini
+00067da0: 6e67 2064 6174 6120 7573 6564 2074 6f20  ng data used to 
+00067db0: 6669 7420 7468 6520 6d6f 6465 6c0a 0a20  fit the model.. 
+00067dc0: 2020 202d 2064 665f 7465 7374 2028 7061     - df_test (pa
+00067dd0: 6e64 6173 2064 6174 6166 7261 6d65 293a  ndas dataframe):
+00067de0: 2074 6573 7420 6461 7461 2075 7365 6420   test data used 
+00067df0: 746f 2070 7265 6469 6374 206e 6f76 656c  to predict novel
+00067e00: 7469 6573 0a0a 2020 2020 2d20 636f 6e74  ties..    - cont
+00067e10: 616d 696e 6174 696f 6e20 2866 6c6f 6174  amination (float
+00067e20: 293a 2070 6172 616d 6574 6572 2063 6f6e  ): parameter con
+00067e30: 7472 6f6c 6c69 6e67 2074 6865 2070 726f  trolling the pro
+00067e40: 706f 7274 696f 6e20 6f66 206f 7574 6c69  portion of outli
+00067e50: 6572 7320 696e 2074 6865 2064 6174 6120  ers in the data 
+00067e60: 2864 6566 6175 6c74 3a20 302e 3035 290a  (default: 0.05).
+00067e70: 0a20 2020 2052 6574 7572 6e73 3a0a 0a20  .    Returns:.. 
+00067e80: 2020 2070 7265 6469 6374 696f 6e73 2028     predictions (
+00067e90: 7061 6e64 6173 2073 6572 6965 7329 3a20  pandas series): 
+00067ea0: 7072 6564 6963 7465 6420 6c61 6265 6c73  predicted labels
+00067eb0: 2066 6f72 2074 6865 2074 6573 7420 6461   for the test da
+00067ec0: 7461 2028 3120 666f 7220 6e6f 7665 6c74  ta (1 for novelt
+00067ed0: 6965 732c 2030 2066 6f72 2069 6e6c 6965  ies, 0 for inlie
+00067ee0: 7273 290a 2020 2020 2222 220a 2020 2020  rs).    """.    
+00067ef0: 696d 706f 7274 2070 616e 6461 7320 6173  import pandas as
+00067f00: 2070 640a 2020 2020 6672 6f6d 2073 6b6c   pd.    from skl
+00067f10: 6561 726e 2e63 6f76 6172 6961 6e63 6520  earn.covariance 
+00067f20: 696d 706f 7274 2045 6c6c 6970 7469 6345  import EllipticE
+00067f30: 6e76 656c 6f70 650a 2020 2020 2320 4669  nvelope.    # Fi
+00067f40: 7420 7468 6520 6d6f 6465 6c20 6f6e 2074  t the model on t
+00067f50: 6865 2074 7261 696e 696e 6720 6461 7461  he training data
+00067f60: 0a20 2020 2063 6c66 203d 2045 6c6c 6970  .    clf = Ellip
+00067f70: 7469 6345 6e76 656c 6f70 6528 636f 6e74  ticEnvelope(cont
+00067f80: 616d 696e 6174 696f 6e3d 636f 6e74 616d  amination=contam
+00067f90: 696e 6174 696f 6e2c 7375 7070 6f72 745f  ination,support_
+00067fa0: 6672 6163 7469 6f6e 3d31 290a 2020 2020  fraction=1).    
+00067fb0: 6466 5f74 7261 696e 5b20 6466 5f74 7261  df_train[ df_tra
+00067fc0: 696e 203d 3d20 6d61 7468 2e69 6e66 205d  in == math.inf ]
+00067fd0: 203d 2030 0a20 2020 2064 665f 7465 7374   = 0.    df_test
+00067fe0: 5b20 6466 5f74 6573 7420 3d3d 206d 6174  [ df_test == mat
+00067ff0: 682e 696e 6620 5d20 3d20 300a 2020 2020  h.inf ] = 0.    
+00068000: 6672 6f6d 2073 6b6c 6561 726e 2e70 7265  from sklearn.pre
+00068010: 7072 6f63 6573 7369 6e67 2069 6d70 6f72  processing impor
+00068020: 7420 5374 616e 6461 7264 5363 616c 6572  t StandardScaler
+00068030: 0a20 2020 2073 6361 6c65 7220 3d20 5374  .    scaler = St
+00068040: 616e 6461 7264 5363 616c 6572 2829 0a20  andardScaler(). 
+00068050: 2020 2073 6361 6c65 722e 6669 7428 6466     scaler.fit(df
+00068060: 5f74 7261 696e 290a 2020 2020 636c 662e  _train).    clf.
+00068070: 6669 7428 7363 616c 6572 2e74 7261 6e73  fit(scaler.trans
+00068080: 666f 726d 2864 665f 7472 6169 6e29 290a  form(df_train)).
+00068090: 2020 2020 7072 6564 6963 7469 6f6e 7320      predictions 
+000680a0: 3d20 636c 662e 7072 6564 6963 7428 7363  = clf.predict(sc
+000680b0: 616c 6572 2e74 7261 6e73 666f 726d 2864  aler.transform(d
+000680c0: 665f 7465 7374 2929 0a20 2020 2070 7265  f_test)).    pre
+000680d0: 6469 6374 696f 6e73 5b70 7265 6469 6374  dictions[predict
+000680e0: 696f 6e73 3d3d 315d 3d30 0a20 2020 2070  ions==1]=0.    p
+000680f0: 7265 6469 6374 696f 6e73 5b70 7265 6469  redictions[predi
+00068100: 6374 696f 6e73 3d3d 2d31 5d3d 310a 2020  ctions==-1]=1.  
+00068110: 2020 6966 2073 7472 2874 7970 6528 6466    if str(type(df
+00068120: 5f74 7261 696e 2929 3d3d 223c 636c 6173  _train))=="<clas
+00068130: 7320 2770 616e 6461 732e 636f 7265 2e66  s 'pandas.core.f
+00068140: 7261 6d65 2e44 6174 6146 7261 6d65 273e  rame.DataFrame'>
+00068150: 223a 0a20 2020 2020 2020 2072 6574 7572  ":.        retur
+00068160: 6e20 7064 2e53 6572 6965 7328 7072 6564  n pd.Series(pred
+00068170: 6963 7469 6f6e 732c 2069 6e64 6578 3d64  ictions, index=d
+00068180: 665f 7465 7374 2e69 6e64 6578 290a 2020  f_test.index).  
+00068190: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000681a0: 7265 7475 726e 2070 642e 5365 7269 6573  return pd.Series
+000681b0: 2870 7265 6469 6374 696f 6e73 290a 0a0a  (predictions)...
+000681c0: 0a64 6566 206e 6f76 656c 7479 5f64 6574  .def novelty_det
+000681d0: 6563 7469 6f6e 5f73 766d 2864 665f 7472  ection_svm(df_tr
+000681e0: 6169 6e2c 2064 665f 7465 7374 2c20 6e75  ain, df_test, nu
+000681f0: 3d30 2e30 352c 206b 6572 6e65 6c3d 2772  =0.05, kernel='r
+00068200: 6266 2729 3a0a 2020 2020 2222 220a 2020  bf'):.    """.  
+00068210: 2020 5468 6973 2066 756e 6374 696f 6e20    This function 
+00068220: 7065 7266 6f72 6d73 206e 6f76 656c 7479  performs novelty
+00068230: 2064 6574 6563 7469 6f6e 2075 7369 6e67   detection using
+00068240: 204f 6e65 2d43 6c61 7373 2053 564d 2e0a   One-Class SVM..
+00068250: 0a20 2020 2050 6172 616d 6574 6572 733a  .    Parameters:
+00068260: 0a0a 2020 2020 2d20 6466 5f74 7261 696e  ..    - df_train
+00068270: 2028 7061 6e64 6173 2064 6174 6166 7261   (pandas datafra
+00068280: 6d65 293a 2074 7261 696e 696e 6720 6461  me): training da
+00068290: 7461 2075 7365 6420 746f 2066 6974 2074  ta used to fit t
+000682a0: 6865 206d 6f64 656c 0a0a 2020 2020 2d20  he model..    - 
+000682b0: 6466 5f74 6573 7420 2870 616e 6461 7320  df_test (pandas 
+000682c0: 6461 7461 6672 616d 6529 3a20 7465 7374  dataframe): test
+000682d0: 2064 6174 6120 7573 6564 2074 6f20 7072   data used to pr
+000682e0: 6564 6963 7420 6e6f 7665 6c74 6965 730a  edict novelties.
+000682f0: 0a20 2020 202d 206e 7520 2866 6c6f 6174  .    - nu (float
+00068300: 293a 2070 6172 616d 6574 6572 2063 6f6e  ): parameter con
+00068310: 7472 6f6c 6c69 6e67 2074 6865 2066 7261  trolling the fra
+00068320: 6374 696f 6e20 6f66 2074 7261 696e 696e  ction of trainin
+00068330: 6720 6572 726f 7273 2061 6e64 2074 6865  g errors and the
+00068340: 2066 7261 6374 696f 6e20 6f66 2073 7570   fraction of sup
+00068350: 706f 7274 2076 6563 746f 7273 2028 6465  port vectors (de
+00068360: 6661 756c 743a 2030 2e30 3529 0a0a 2020  fault: 0.05)..  
+00068370: 2020 2d20 6b65 726e 656c 2028 7374 7229    - kernel (str)
+00068380: 3a20 6b65 726e 656c 2074 7970 6520 7573  : kernel type us
+00068390: 6564 2069 6e20 7468 6520 5356 4d20 616c  ed in the SVM al
+000683a0: 676f 7269 7468 6d20 2864 6566 6175 6c74  gorithm (default
+000683b0: 3a20 2772 6266 2729 0a0a 2020 2020 5265  : 'rbf')..    Re
+000683c0: 7475 726e 733a 0a0a 2020 2020 7072 6564  turns:..    pred
+000683d0: 6963 7469 6f6e 7320 2870 616e 6461 7320  ictions (pandas 
+000683e0: 7365 7269 6573 293a 2070 7265 6469 6374  series): predict
+000683f0: 6564 206c 6162 656c 7320 666f 7220 7468  ed labels for th
+00068400: 6520 7465 7374 2064 6174 6120 2831 2066  e test data (1 f
+00068410: 6f72 206e 6f76 656c 7469 6573 2c20 3020  or novelties, 0 
+00068420: 666f 7220 696e 6c69 6572 7329 0a20 2020  for inliers).   
+00068430: 2022 2222 0a20 2020 2066 726f 6d20 736b   """.    from sk
+00068440: 6c65 6172 6e2e 7376 6d20 696d 706f 7274  learn.svm import
+00068450: 204f 6e65 436c 6173 7353 564d 0a20 2020   OneClassSVM.   
+00068460: 2023 2046 6974 2074 6865 206d 6f64 656c   # Fit the model
+00068470: 206f 6e20 7468 6520 7472 6169 6e69 6e67   on the training
+00068480: 2064 6174 610a 2020 2020 6466 5f74 7261   data.    df_tra
+00068490: 696e 5b20 6466 5f74 7261 696e 203d 3d20  in[ df_train == 
+000684a0: 6d61 7468 2e69 6e66 205d 203d 2030 0a20  math.inf ] = 0. 
+000684b0: 2020 2064 665f 7465 7374 5b20 6466 5f74     df_test[ df_t
+000684c0: 6573 7420 3d3d 206d 6174 682e 696e 6620  est == math.inf 
+000684d0: 5d20 3d20 300a 2020 2020 636c 6620 3d20  ] = 0.    clf = 
+000684e0: 4f6e 6543 6c61 7373 5356 4d28 6e75 3d6e  OneClassSVM(nu=n
+000684f0: 752c 206b 6572 6e65 6c3d 6b65 726e 656c  u, kernel=kernel
+00068500: 290a 2020 2020 6672 6f6d 2073 6b6c 6561  ).    from sklea
+00068510: 726e 2e70 7265 7072 6f63 6573 7369 6e67  rn.preprocessing
+00068520: 2069 6d70 6f72 7420 5374 616e 6461 7264   import Standard
+00068530: 5363 616c 6572 0a20 2020 2073 6361 6c65  Scaler.    scale
+00068540: 7220 3d20 5374 616e 6461 7264 5363 616c  r = StandardScal
+00068550: 6572 2829 0a20 2020 2073 6361 6c65 722e  er().    scaler.
+00068560: 6669 7428 6466 5f74 7261 696e 290a 2020  fit(df_train).  
+00068570: 2020 636c 662e 6669 7428 7363 616c 6572    clf.fit(scaler
+00068580: 2e74 7261 6e73 666f 726d 2864 665f 7472  .transform(df_tr
+00068590: 6169 6e29 290a 2020 2020 7072 6564 6963  ain)).    predic
+000685a0: 7469 6f6e 7320 3d20 636c 662e 7072 6564  tions = clf.pred
+000685b0: 6963 7428 7363 616c 6572 2e74 7261 6e73  ict(scaler.trans
+000685c0: 666f 726d 2864 665f 7465 7374 2929 0a20  form(df_test)). 
+000685d0: 2020 2070 7265 6469 6374 696f 6e73 5b70     predictions[p
+000685e0: 7265 6469 6374 696f 6e73 3d3d 315d 3d30  redictions==1]=0
+000685f0: 0a20 2020 2070 7265 6469 6374 696f 6e73  .    predictions
+00068600: 5b70 7265 6469 6374 696f 6e73 3d3d 2d31  [predictions==-1
+00068610: 5d3d 310a 2020 2020 6966 2073 7472 2874  ]=1.    if str(t
+00068620: 7970 6528 6466 5f74 7261 696e 2929 3d3d  ype(df_train))==
+00068630: 223c 636c 6173 7320 2770 616e 6461 732e  "<class 'pandas.
+00068640: 636f 7265 2e66 7261 6d65 2e44 6174 6146  core.frame.DataF
+00068650: 7261 6d65 273e 223a 0a20 2020 2020 2020  rame'>":.       
+00068660: 2072 6574 7572 6e20 7064 2e53 6572 6965   return pd.Serie
+00068670: 7328 7072 6564 6963 7469 6f6e 732c 2069  s(predictions, i
+00068680: 6e64 6578 3d64 665f 7465 7374 2e69 6e64  ndex=df_test.ind
+00068690: 6578 290a 2020 2020 656c 7365 3a0a 2020  ex).    else:.  
+000686a0: 2020 2020 2020 7265 7475 726e 2070 642e        return pd.
+000686b0: 5365 7269 6573 2870 7265 6469 6374 696f  Series(predictio
+000686c0: 6e73 290a 0a0a 0a64 6566 206e 6f76 656c  ns)....def novel
+000686d0: 7479 5f64 6574 6563 7469 6f6e 5f6c 6f66  ty_detection_lof
+000686e0: 2864 665f 7472 6169 6e2c 2064 665f 7465  (df_train, df_te
+000686f0: 7374 2c20 6e5f 6e65 6967 6862 6f72 733d  st, n_neighbors=
+00068700: 3230 293a 0a20 2020 2022 2222 0a20 2020  20):.    """.   
+00068710: 2054 6869 7320 6675 6e63 7469 6f6e 2070   This function p
+00068720: 6572 666f 726d 7320 6e6f 7665 6c74 7920  erforms novelty 
+00068730: 6465 7465 6374 696f 6e20 7573 696e 6720  detection using 
+00068740: 4c6f 6361 6c20 4f75 746c 6965 7220 4661  Local Outlier Fa
+00068750: 6374 6f72 2028 4c4f 4629 2e0a 0a20 2020  ctor (LOF)...   
+00068760: 2050 6172 616d 6574 6572 733a 0a0a 2020   Parameters:..  
+00068770: 2020 2d20 6466 5f74 7261 696e 2028 7061    - df_train (pa
+00068780: 6e64 6173 2064 6174 6166 7261 6d65 293a  ndas dataframe):
+00068790: 2074 7261 696e 696e 6720 6461 7461 2075   training data u
+000687a0: 7365 6420 746f 2066 6974 2074 6865 206d  sed to fit the m
+000687b0: 6f64 656c 0a0a 2020 2020 2d20 6466 5f74  odel..    - df_t
+000687c0: 6573 7420 2870 616e 6461 7320 6461 7461  est (pandas data
+000687d0: 6672 616d 6529 3a20 7465 7374 2064 6174  frame): test dat
+000687e0: 6120 7573 6564 2074 6f20 7072 6564 6963  a used to predic
+000687f0: 7420 6e6f 7665 6c74 6965 730a 0a20 2020  t novelties..   
+00068800: 202d 206e 5f6e 6569 6768 626f 7273 2028   - n_neighbors (
+00068810: 696e 7429 3a20 6e75 6d62 6572 206f 6620  int): number of 
+00068820: 6e65 6967 6862 6f72 7320 7573 6564 2074  neighbors used t
+00068830: 6f20 636f 6d70 7574 6520 7468 6520 4c4f  o compute the LO
+00068840: 4620 2864 6566 6175 6c74 3a20 3230 290a  F (default: 20).
+00068850: 0a20 2020 2052 6574 7572 6e73 3a0a 0a20  .    Returns:.. 
+00068860: 2020 202d 2070 7265 6469 6374 696f 6e73     - predictions
+00068870: 2028 7061 6e64 6173 2073 6572 6965 7329   (pandas series)
+00068880: 3a20 7072 6564 6963 7465 6420 6c61 6265  : predicted labe
+00068890: 6c73 2066 6f72 2074 6865 2074 6573 7420  ls for the test 
+000688a0: 6461 7461 2028 3120 666f 7220 6e6f 7665  data (1 for nove
+000688b0: 6c74 6965 732c 2030 2066 6f72 2069 6e6c  lties, 0 for inl
+000688c0: 6965 7273 290a 0a20 2020 2022 2222 0a20  iers)..    """. 
+000688d0: 2020 2066 726f 6d20 736b 6c65 6172 6e2e     from sklearn.
+000688e0: 6e65 6967 6862 6f72 7320 696d 706f 7274  neighbors import
+000688f0: 204c 6f63 616c 4f75 746c 6965 7246 6163   LocalOutlierFac
+00068900: 746f 720a 2020 2020 2320 4669 7420 7468  tor.    # Fit th
+00068910: 6520 6d6f 6465 6c20 6f6e 2074 6865 2074  e model on the t
+00068920: 7261 696e 696e 6720 6461 7461 0a20 2020  raining data.   
+00068930: 2064 665f 7472 6169 6e5b 2064 665f 7472   df_train[ df_tr
+00068940: 6169 6e20 3d3d 206d 6174 682e 696e 6620  ain == math.inf 
+00068950: 5d20 3d20 300a 2020 2020 6466 5f74 6573  ] = 0.    df_tes
+00068960: 745b 2064 665f 7465 7374 203d 3d20 6d61  t[ df_test == ma
+00068970: 7468 2e69 6e66 205d 203d 2030 0a20 2020  th.inf ] = 0.   
+00068980: 2063 6c66 203d 204c 6f63 616c 4f75 746c   clf = LocalOutl
+00068990: 6965 7246 6163 746f 7228 6e5f 6e65 6967  ierFactor(n_neig
+000689a0: 6862 6f72 733d 6e5f 6e65 6967 6862 6f72  hbors=n_neighbor
+000689b0: 732c 2061 6c67 6f72 6974 686d 3d27 6175  s, algorithm='au
+000689c0: 746f 272c 636f 6e74 616d 696e 6174 696f  to',contaminatio
+000689d0: 6e3d 2761 7574 6f27 2c20 6e6f 7665 6c74  n='auto', novelt
+000689e0: 793d 5472 7565 290a 2020 2020 6672 6f6d  y=True).    from
+000689f0: 2073 6b6c 6561 726e 2e70 7265 7072 6f63   sklearn.preproc
+00068a00: 6573 7369 6e67 2069 6d70 6f72 7420 5374  essing import St
+00068a10: 616e 6461 7264 5363 616c 6572 0a20 2020  andardScaler.   
+00068a20: 2073 6361 6c65 7220 3d20 5374 616e 6461   scaler = Standa
+00068a30: 7264 5363 616c 6572 2829 0a20 2020 2073  rdScaler().    s
+00068a40: 6361 6c65 722e 6669 7428 6466 5f74 7261  caler.fit(df_tra
+00068a50: 696e 290a 2020 2020 636c 662e 6669 7428  in).    clf.fit(
+00068a60: 7363 616c 6572 2e74 7261 6e73 666f 726d  scaler.transform
+00068a70: 2864 665f 7472 6169 6e29 290a 2020 2020  (df_train)).    
+00068a80: 7072 6564 6963 7469 6f6e 7320 3d20 636c  predictions = cl
+00068a90: 662e 7072 6564 6963 7428 7363 616c 6572  f.predict(scaler
+00068aa0: 2e74 7261 6e73 666f 726d 2864 665f 7465  .transform(df_te
+00068ab0: 7374 2929 0a20 2020 2070 7265 6469 6374  st)).    predict
+00068ac0: 696f 6e73 5b70 7265 6469 6374 696f 6e73  ions[predictions
+00068ad0: 3d3d 315d 3d30 0a20 2020 2070 7265 6469  ==1]=0.    predi
+00068ae0: 6374 696f 6e73 5b70 7265 6469 6374 696f  ctions[predictio
+00068af0: 6e73 3d3d 2d31 5d3d 310a 2020 2020 6966  ns==-1]=1.    if
+00068b00: 2073 7472 2874 7970 6528 6466 5f74 7261   str(type(df_tra
+00068b10: 696e 2929 3d3d 223c 636c 6173 7320 2770  in))=="<class 'p
+00068b20: 616e 6461 732e 636f 7265 2e66 7261 6d65  andas.core.frame
+00068b30: 2e44 6174 6146 7261 6d65 273e 223a 0a20  .DataFrame'>":. 
+00068b40: 2020 2020 2020 2072 6574 7572 6e20 7064         return pd
+00068b50: 2e53 6572 6965 7328 7072 6564 6963 7469  .Series(predicti
+00068b60: 6f6e 732c 2069 6e64 6578 3d64 665f 7465  ons, index=df_te
+00068b70: 7374 2e69 6e64 6578 290a 2020 2020 656c  st.index).    el
+00068b80: 7365 3a0a 2020 2020 2020 2020 7265 7475  se:.        retu
+00068b90: 726e 2070 642e 5365 7269 6573 2870 7265  rn pd.Series(pre
+00068ba0: 6469 6374 696f 6e73 290a 0a0a 6465 6620  dictions)...def 
+00068bb0: 6e6f 7665 6c74 795f 6465 7465 6374 696f  novelty_detectio
+00068bc0: 6e5f 6c6f 6f70 2864 665f 7472 6169 6e2c  n_loop(df_train,
+00068bd0: 2064 665f 7465 7374 2c20 6e5f 6e65 6967   df_test, n_neig
+00068be0: 6862 6f72 733d 3230 2c20 6469 7374 616e  hbors=20, distan
+00068bf0: 6365 5f6d 6574 7269 633d 276d 696e 6b6f  ce_metric='minko
+00068c00: 7773 6b69 2729 3a0a 2020 2020 2222 220a  wski'):.    """.
+00068c10: 2020 2020 5468 6973 2066 756e 6374 696f      This functio
+00068c20: 6e20 7065 7266 6f72 6d73 206e 6f76 656c  n performs novel
+00068c30: 7479 2064 6574 6563 7469 6f6e 2075 7369  ty detection usi
+00068c40: 6e67 204c 6f63 616c 204f 7574 6c69 6572  ng Local Outlier
+00068c50: 2046 6163 746f 7220 284c 4f46 292e 0a0a   Factor (LOF)...
+00068c60: 2020 2020 5061 7261 6d65 7465 7273 3a0a      Parameters:.
+00068c70: 0a20 2020 202d 2064 665f 7472 6169 6e20  .    - df_train 
+00068c80: 2870 616e 6461 7320 6461 7461 6672 616d  (pandas datafram
+00068c90: 6529 3a20 7472 6169 6e69 6e67 2064 6174  e): training dat
+00068ca0: 6120 7573 6564 2074 6f20 6669 7420 7468  a used to fit th
+00068cb0: 6520 6d6f 6465 6c0a 0a20 2020 202d 2064  e model..    - d
+00068cc0: 665f 7465 7374 2028 7061 6e64 6173 2064  f_test (pandas d
+00068cd0: 6174 6166 7261 6d65 293a 2074 6573 7420  ataframe): test 
+00068ce0: 6461 7461 2075 7365 6420 746f 2070 7265  data used to pre
+00068cf0: 6469 6374 206e 6f76 656c 7469 6573 0a0a  dict novelties..
+00068d00: 2020 2020 2d20 6e5f 6e65 6967 6862 6f72      - n_neighbor
+00068d10: 7320 2869 6e74 293a 206e 756d 6265 7220  s (int): number 
+00068d20: 6f66 206e 6569 6768 626f 7273 2075 7365  of neighbors use
+00068d30: 6420 746f 2063 6f6d 7075 7465 2074 6865  d to compute the
+00068d40: 204c 4f4f 5020 2864 6566 6175 6c74 3a20   LOOP (default: 
+00068d50: 3230 290a 0a20 2020 202d 2064 6973 7461  20)..    - dista
+00068d60: 6e63 655f 6d65 7472 6963 203a 2064 6566  nce_metric : def
+00068d70: 6175 6c74 206d 696e 6b6f 7773 6b69 0a0a  ault minkowski..
+00068d80: 2020 2020 5265 7475 726e 733a 0a0a 2020      Returns:..  
+00068d90: 2020 2d20 7072 6564 6963 7469 6f6e 7320    - predictions 
+00068da0: 2870 616e 6461 7320 7365 7269 6573 293a  (pandas series):
+00068db0: 2070 7265 6469 6374 6564 206c 6162 656c   predicted label
+00068dc0: 7320 666f 7220 7468 6520 7465 7374 2064  s for the test d
+00068dd0: 6174 6120 2831 2066 6f72 206e 6f76 656c  ata (1 for novel
+00068de0: 7469 6573 2c20 3020 666f 7220 696e 6c69  ties, 0 for inli
+00068df0: 6572 7329 0a0a 2020 2020 2222 220a 2020  ers)..    """.  
+00068e00: 2020 6672 6f6d 2050 794e 6f6d 616c 7920    from PyNomaly 
+00068e10: 696d 706f 7274 206c 6f6f 700a 2020 2020  import loop.    
+00068e20: 6672 6f6d 2073 6b6c 6561 726e 2e6e 6569  from sklearn.nei
+00068e30: 6768 626f 7273 2069 6d70 6f72 7420 4e65  ghbors import Ne
+00068e40: 6172 6573 744e 6569 6768 626f 7273 0a20  arestNeighbors. 
+00068e50: 2020 2066 726f 6d20 736b 6c65 6172 6e2e     from sklearn.
+00068e60: 7072 6570 726f 6365 7373 696e 6720 696d  preprocessing im
+00068e70: 706f 7274 2053 7461 6e64 6172 6453 6361  port StandardSca
+00068e80: 6c65 720a 2020 2020 7363 616c 6572 203d  ler.    scaler =
+00068e90: 2053 7461 6e64 6172 6453 6361 6c65 7228   StandardScaler(
+00068ea0: 290a 2020 2020 7363 616c 6572 2e66 6974  ).    scaler.fit
+00068eb0: 2864 665f 7472 6169 6e29 0a20 2020 2064  (df_train).    d
+00068ec0: 6174 6120 3d20 6e70 2e76 7374 6163 6b28  ata = np.vstack(
+00068ed0: 205b 7363 616c 6572 2e74 7261 6e73 666f   [scaler.transfo
+00068ee0: 726d 2864 665f 7465 7374 292c 7363 616c  rm(df_test),scal
+00068ef0: 6572 2e74 7261 6e73 666f 726d 2864 665f  er.transform(df_
+00068f00: 7472 6169 6e29 5d29 0a20 2020 206e 6569  train)]).    nei
+00068f10: 6768 203d 204e 6561 7265 7374 4e65 6967  gh = NearestNeig
+00068f20: 6862 6f72 7328 6e5f 6e65 6967 6862 6f72  hbors(n_neighbor
+00068f30: 733d 6e5f 6e65 6967 6862 6f72 732c 206d  s=n_neighbors, m
+00068f40: 6574 7269 633d 6469 7374 616e 6365 5f6d  etric=distance_m
+00068f50: 6574 7269 6329 0a20 2020 206e 6569 6768  etric).    neigh
+00068f60: 2e66 6974 2864 6174 6129 0a20 2020 2064  .fit(data).    d
+00068f70: 2c20 6964 7820 3d20 6e65 6967 682e 6b6e  , idx = neigh.kn
+00068f80: 6569 6768 626f 7273 2864 6174 612c 2072  eighbors(data, r
+00068f90: 6574 7572 6e5f 6469 7374 616e 6365 3d54  eturn_distance=T
+00068fa0: 7275 6529 0a20 2020 206d 203d 206c 6f6f  rue).    m = loo
+00068fb0: 702e 4c6f 6361 6c4f 7574 6c69 6572 5072  p.LocalOutlierPr
+00068fc0: 6f62 6162 696c 6974 7928 6469 7374 616e  obability(distan
+00068fd0: 6365 5f6d 6174 7269 783d 642c 206e 6569  ce_matrix=d, nei
+00068fe0: 6768 626f 725f 6d61 7472 6978 3d69 6478  ghbor_matrix=idx
+00068ff0: 2c20 6e5f 6e65 6967 6862 6f72 733d 6e5f  , n_neighbors=n_
+00069000: 6e65 6967 6862 6f72 7329 2e66 6974 2829  neighbors).fit()
+00069010: 0a20 2020 2072 6574 7572 6e20 6d2e 6c6f  .    return m.lo
+00069020: 6361 6c5f 6f75 746c 6965 725f 7072 6f62  cal_outlier_prob
+00069030: 6162 696c 6974 6965 735b 7261 6e67 6528  abilities[range(
+00069040: 6466 5f74 6573 742e 7368 6170 655b 305d  df_test.shape[0]
+00069050: 295d 0a0a 0a0a 6465 6620 6e6f 7665 6c74  )]....def novelt
+00069060: 795f 6465 7465 6374 696f 6e5f 7175 616e  y_detection_quan
+00069070: 7469 6c65 2864 665f 7472 6169 6e2c 2064  tile(df_train, d
+00069080: 665f 7465 7374 293a 0a20 2020 2022 2222  f_test):.    """
+00069090: 0a20 2020 2054 6869 7320 6675 6e63 7469  .    This functi
+000690a0: 6f6e 2070 6572 666f 726d 7320 6e6f 7665  on performs nove
+000690b0: 6c74 7920 6465 7465 6374 696f 6e20 7573  lty detection us
+000690c0: 696e 6720 7175 616e 7469 6c65 7320 666f  ing quantiles fo
+000690d0: 7220 6561 6368 2063 6f6c 756d 6e2e 0a0a  r each column...
+000690e0: 2020 2020 5061 7261 6d65 7465 7273 3a0a      Parameters:.
+000690f0: 0a20 2020 202d 2064 665f 7472 6169 6e20  .    - df_train 
+00069100: 2870 616e 6461 7320 6461 7461 6672 616d  (pandas datafram
+00069110: 6529 3a20 7472 6169 6e69 6e67 2064 6174  e): training dat
+00069120: 6120 7573 6564 2074 6f20 6669 7420 7468  a used to fit th
+00069130: 6520 6d6f 6465 6c0a 0a20 2020 202d 2064  e model..    - d
+00069140: 665f 7465 7374 2028 7061 6e64 6173 2064  f_test (pandas d
+00069150: 6174 6166 7261 6d65 293a 2074 6573 7420  ataframe): test 
+00069160: 6461 7461 2075 7365 6420 746f 2070 7265  data used to pre
+00069170: 6469 6374 206e 6f76 656c 7469 6573 0a0a  dict novelties..
+00069180: 2020 2020 5265 7475 726e 733a 0a0a 2020      Returns:..  
+00069190: 2020 2d20 7175 616e 7469 6c65 7320 666f    - quantiles fo
+000691a0: 7220 7468 6520 7465 7374 2073 616d 706c  r the test sampl
+000691b0: 6520 6174 2065 6163 6820 636f 6c75 6d6e  e at each column
+000691c0: 2077 6865 7265 2076 616c 7565 7320 7261   where values ra
+000691d0: 6e67 6520 696e 205b 302c 315d 0a20 2020  nge in [0,1].   
+000691e0: 2020 2020 2061 6e64 2068 6967 6865 7220       and higher 
+000691f0: 7661 6c75 6573 206d 6561 6e20 7468 6520  values mean the 
+00069200: 636f 6c75 6d6e 2069 7320 636c 6f73 6572  column is closer
+00069210: 2074 6f20 7468 6520 6564 6765 206f 6620   to the edge of 
+00069220: 7468 6520 6469 7374 7269 6275 7469 6f6e  the distribution
+00069230: 0a0a 2020 2020 2222 220a 2020 2020 6d79  ..    """.    my
+00069240: 7173 203d 2064 665f 7465 7374 2e63 6f70  qs = df_test.cop
+00069250: 7928 290a 2020 2020 6e20 3d20 6466 5f74  y().    n = df_t
+00069260: 7261 696e 2e73 6861 7065 5b30 5d0a 2020  rain.shape[0].  
+00069270: 2020 6466 5f74 7261 696e 6b65 7973 203d    df_trainkeys =
+00069280: 2064 665f 7472 6169 6e2e 6b65 7973 2829   df_train.keys()
+00069290: 0a20 2020 2066 6f72 206b 2069 6e20 7261  .    for k in ra
+000692a0: 6e67 6528 2064 665f 7472 6169 6e2e 7368  nge( df_train.sh
+000692b0: 6170 655b 315d 2029 3a0a 2020 2020 2020  ape[1] ):.      
+000692c0: 2020 6d79 6b65 7920 3d20 6466 5f74 7261    mykey = df_tra
+000692d0: 696e 6b65 7973 5b6b 5d0a 2020 2020 2020  inkeys[k].      
+000692e0: 2020 7465 6d70 203d 2028 6d79 7173 5b6d    temp = (myqs[m
+000692f0: 796b 6579 5d5b 305d 203e 2020 6466 5f74  ykey][0] >  df_t
+00069300: 7261 696e 5b6d 796b 6579 5d29 2e73 756d  rain[mykey]).sum
+00069310: 2829 202f 206e 0a20 2020 2020 2020 206d  () / n.        m
+00069320: 7971 735b 6d79 6b65 795d 203d 2061 6273  yqs[mykey] = abs
+00069330: 2820 7465 6d70 202d 2030 2e35 2029 202f  ( temp - 0.5 ) /
+00069340: 2030 2e35 0a20 2020 2072 6574 7572 6e20   0.5.    return 
+00069350: 6d79 7173 0a0a 6465 6620 6272 6169 6e6d  myqs..def brainm
+00069360: 6170 5f66 6967 7572 6528 7374 6174 6973  ap_figure(statis
+00069370: 7469 6361 6c5f 6466 2c20 6461 7461 5f64  tical_df, data_d
+00069380: 6963 7469 6f6e 6172 795f 7061 7468 2c20  ictionary_path, 
+00069390: 6f75 7470 7574 5f70 7265 6669 782c 2062  output_prefix, b
+000693a0: 7261 696e 5f69 6d61 6765 2c20 6f76 6572  rain_image, over
+000693b0: 6c61 795f 636d 6170 3d27 6277 7227 2c20  lay_cmap='bwr', 
+000693c0: 6e73 6c69 6365 733d 3231 2c20 6e63 6f6c  nslices=21, ncol
+000693d0: 3d37 2c20 6564 6765 5f69 6d61 6765 5f64  =7, edge_image_d
+000693e0: 696c 6174 696f 6e20 3d20 302c 2062 6c61  ilation = 0, bla
+000693f0: 636b 5f62 673d 5472 7565 2c20 6178 6573  ck_bg=True, axes
+00069400: 203d 205b 302c 312c 325d 2c20 6669 7865   = [0,1,2], fixe
+00069410: 645f 6f76 6572 6c61 795f 7261 6e67 653d  d_overlay_range=
+00069420: 4e6f 6e65 2c20 6372 6f70 3d35 2c20 7665  None, crop=5, ve
+00069430: 7262 6f73 653d 4661 6c73 6520 293a 0a20  rbose=False ):. 
+00069440: 2020 2022 2222 0a20 2020 2043 7265 6174     """.    Creat
+00069450: 6520 6669 6775 7265 7320 6261 7365 6420  e figures based 
+00069460: 6f6e 2073 7461 7469 7374 6963 616c 2064  on statistical d
+00069470: 6174 6120 616e 6420 616e 2075 6e64 6572  ata and an under
+00069480: 6c79 696e 6720 6272 6169 6e20 696d 6167  lying brain imag
+00069490: 652e 0a0a 2020 2020 4173 7375 6d65 7320  e...    Assumes 
+000694a0: 626f 7468 207e 2f2e 616e 7473 7079 7431  both ~/.antspyt1
+000694b0: 7720 616e 6420 7e2f 2e61 6e74 7370 796d  w and ~/.antspym
+000694c0: 6d20 6461 7461 2069 7320 6176 6169 6c61  m data is availa
+000694d0: 626c 650a 0a20 2020 2050 6172 616d 6574  ble..    Paramet
+000694e0: 6572 733a 0a20 2020 202d 2073 7461 7469  ers:.    - stati
+000694f0: 7374 6963 616c 5f64 6620 2870 616e 6461  stical_df (panda
+00069500: 7320 6461 7461 6672 616d 6529 3a20 7769  s dataframe): wi
+00069510: 7468 2032 2063 6f6c 756d 6e73 206e 616d  th 2 columns nam
+00069520: 6564 2061 6e61 7420 616e 6420 7661 6c75  ed anat and valu
+00069530: 6573 0a20 2020 2020 2020 2074 6865 2061  es.        the a
+00069540: 6e61 7420 636f 6c75 6d6e 2073 686f 756c  nat column shoul
+00069550: 6420 6861 7665 206e 616d 6573 2074 6861  d have names tha
+00069560: 7420 6d65 6574 202a 7061 7274 6961 6c20  t meet *partial 
+00069570: 6d61 7463 6869 6e67 2a20 6372 6974 6572  matching* criter
+00069580: 696f 6e20 0a20 2020 2020 2020 2077 6974  ion .        wit
+00069590: 6820 7265 7370 6563 7420 746f 2072 6567  h respect to reg
+000695a0: 696f 6e73 2074 6861 7420 6172 6520 6d65  ions that are me
+000695b0: 6173 7572 6564 2069 6e20 616e 7473 7079  asured in antspy
+000695c0: 6d6d 2e20 2020 7661 6c75 6520 7769 6c6c  mm.   value will
+000695d0: 2062 6520 0a20 2020 2020 2020 2074 6865   be .        the
+000695e0: 2076 616c 7565 2074 6f20 6265 2064 6973   value to be dis
+000695f0: 706c 6179 6564 2e20 2020 6966 2074 776f  played.   if two
+00069600: 2065 7861 6d70 6c65 7320 6f66 2061 2067   examples of a g
+00069610: 6976 656e 2072 6567 696f 6e20 6578 6973  iven region exis
+00069620: 7420 696e 200a 2020 2020 2020 2020 7374  t in .        st
+00069630: 6174 6973 7469 6361 6c5f 6466 2c20 7468  atistical_df, th
+00069640: 656e 2074 6865 206c 6172 6765 7374 2061  en the largest a
+00069650: 6273 6f6c 7574 6520 7661 6c75 6520 7769  bsolute value wi
+00069660: 6c6c 2062 6520 7461 6b65 6e20 666f 7220  ll be taken for 
+00069670: 6469 7370 6c61 792e 0a20 2020 202d 2064  display..    - d
+00069680: 6174 615f 6469 6374 696f 6e61 7279 5f70  ata_dictionary_p
+00069690: 6174 6820 2873 7472 293a 2050 6174 6820  ath (str): Path 
+000696a0: 746f 2074 6865 2064 6174 6120 6469 6374  to the data dict
+000696b0: 696f 6e61 7279 2043 5356 2066 696c 652e  ionary CSV file.
+000696c0: 0a20 2020 202d 206f 7574 7075 745f 7072  .    - output_pr
+000696d0: 6566 6978 2028 7374 7229 3a20 5072 6566  efix (str): Pref
+000696e0: 6978 2066 6f72 2074 6865 206f 7574 7075  ix for the outpu
+000696f0: 7420 6669 6775 7265 2066 696c 656e 616d  t figure filenam
+00069700: 6573 2e0a 2020 2020 2d20 6272 6169 6e5f  es..    - brain_
+00069710: 696d 6167 6520 2861 6e74 7349 6d61 6765  image (antsImage
+00069720: 293a 2074 6865 2062 7261 696e 2069 6d61  ): the brain ima
+00069730: 6765 206f 6e20 7768 6963 6820 7265 7375  ge on which resu
+00069740: 6c74 7320 7769 6c6c 206f 7665 726c 6179  lts will overlay
+00069750: 2e0a 2020 2020 2d20 6f76 6572 6c61 795f  ..    - overlay_
+00069760: 636d 6170 2028 7374 7229 3a20 7365 6520  cmap (str): see 
+00069770: 6d61 7470 6c6f 746c 6962 0a20 2020 202d  matplotlib.    -
+00069780: 206e 736c 6963 6573 2028 696e 7429 3a20   nslices (int): 
+00069790: 6e75 6d62 6572 206f 6620 736c 6963 6573  number of slices
+000697a0: 2074 6f20 7368 6f77 0a20 2020 202d 206e   to show.    - n
+000697b0: 636f 6c20 2869 6e74 293a 206e 756d 6265  col (int): numbe
+000697c0: 7220 6f66 2063 6f6c 756d 6e73 2074 6f20  r of columns to 
+000697d0: 7368 6f77 0a20 2020 202d 2065 6467 655f  show.    - edge_
+000697e0: 696d 6167 655f 6469 6c61 7469 6f6e 2028  image_dilation (
+000697f0: 696e 7429 3a20 696e 7465 6765 7220 6772  int): integer gr
+00069800: 6561 7465 7220 7468 616e 206f 7220 6571  eater than or eq
+00069810: 7561 6c20 746f 207a 6572 6f0a 2020 2020  ual to zero.    
+00069820: 2d20 626c 6163 6b5f 6267 2028 626f 6f6c  - black_bg (bool
+00069830: 293a 2062 6f6f 6c65 616e 0a20 2020 202d  ): boolean.    -
+00069840: 2061 7865 7320 286c 6973 7429 3a20 696e   axes (list): in
+00069850: 7465 6765 7220 6c69 7374 2074 7970 6963  teger list typic
+00069860: 616c 6c79 205b 302c 312c 325d 2073 6167  ally [0,1,2] sag
+00069870: 6974 7461 6c20 636f 726f 6e61 6c20 6178  ittal coronal ax
+00069880: 6961 6c0a 2020 2020 2d20 6669 7865 645f  ial.    - fixed_
+00069890: 6f76 6572 6c61 795f 7261 6e67 6520 286c  overlay_range (l
+000698a0: 6973 7429 3a20 7363 616c 6172 2070 6169  ist): scalar pai
+000698b0: 7220 7769 6c6c 2074 7279 2074 6f20 6b65  r will try to ke
+000698c0: 6570 2061 2063 6f6e 7374 616e 7420 6362  ep a constant cb
+000698d0: 6172 2061 6e64 2077 696c 6c20 7472 756e  ar and will trun
+000698e0: 6361 7465 2074 6865 206f 7665 726c 6179  cate the overlay
+000698f0: 2061 7420 7468 6573 6520 6d69 6e2f 6d61   at these min/ma
+00069900: 7820 7661 6c75 6573 0a20 2020 202d 2063  x values.    - c
+00069910: 726f 7020 2869 6e74 293a 2063 726f 7073  rop (int): crops
+00069920: 2074 6865 2069 6d61 6765 2074 6f20 6469   the image to di
+00069930: 7370 6c61 7920 6279 2074 6865 2065 7874  splay by the ext
+00069940: 656e 7420 6f66 2074 6865 206f 7665 726c  ent of the overl
+00069950: 6179 3b20 6c61 7267 6572 2076 616c 7565  ay; larger value
+00069960: 7320 6469 6c61 7465 2074 6865 206d 6173  s dilate the mas
+00069970: 6b73 206d 6f72 652e 0a20 2020 202d 2076  ks more..    - v
+00069980: 6572 626f 7365 2028 626f 6f6c 293a 2062  erbose (bool): b
+00069990: 6f6f 6c65 616e 0a0a 2020 2020 5265 7475  oolean..    Retu
+000699a0: 726e 733a 0a20 2020 2061 6e20 696d 6167  rns:.    an imag
+000699b0: 6520 7769 7468 2076 616c 7565 7320 6d61  e with values ma
+000699c0: 7070 6564 2074 6f20 7468 6520 6173 736f  pped to the asso
+000699d0: 6369 6174 6564 2072 6567 696f 6e73 0a20  ciated regions. 
+000699e0: 2020 2022 2222 0a20 2020 2069 6d70 6f72     """.    impor
+000699f0: 7420 7265 0a0a 2020 2020 2320 5265 6164  t re..    # Read
+00069a00: 2074 6865 2073 7461 7469 7374 6963 616c   the statistical
+00069a10: 2066 696c 650a 2020 2020 7a7a 203d 2073   file.    zz = s
+00069a20: 7461 7469 7374 6963 616c 5f64 6620 0a20  tatistical_df . 
+00069a30: 2020 200a 2020 2020 2320 5265 6164 2074     .    # Read t
+00069a40: 6865 2064 6174 6120 6469 6374 696f 6e61  he data dictiona
+00069a50: 7279 2066 726f 6d20 6120 4353 5620 6669  ry from a CSV fi
+00069a60: 6c65 0a20 2020 206d 7964 6963 7420 3d20  le.    mydict = 
+00069a70: 7064 2e72 6561 645f 6373 7628 6461 7461  pd.read_csv(data
+00069a80: 5f64 6963 7469 6f6e 6172 795f 7061 7468  _dictionary_path
+00069a90: 290a 2020 2020 6d79 6469 6374 203d 206d  ).    mydict = m
+00069aa0: 7964 6963 745b 7e6d 7964 6963 745b 274d  ydict[~mydict['M
+00069ab0: 6561 7375 7265 6d65 6e74 275d 2e73 7472  easurement'].str
+00069ac0: 2e63 6f6e 7461 696e 7328 2274 7261 6374  .contains("tract
+00069ad0: 6f67 7261 7068 792d 6261 7365 6420 636f  ography-based co
+00069ae0: 6e6e 6563 7469 7669 7479 222c 206e 613d  nnectivity", na=
+00069af0: 4661 6c73 6529 5d0a 0a20 2020 2073 7461  False)]..    sta
+00069b00: 7469 7374 6963 616c 5f64 665b 2761 6e61  tistical_df['ana
+00069b10: 7427 5d20 3d20 7374 6174 6973 7469 6361  t'] = statistica
+00069b20: 6c5f 6466 5b27 616e 6174 275d 2e73 7472  l_df['anat'].str
+00069b30: 2e72 6570 6c61 6365 2822 5f22 2c20 222e  .replace("_", ".
+00069b40: 222c 2072 6567 6578 3d54 7275 6529 0a0a  ", regex=True)..
+00069b50: 2020 2020 2320 4c6f 6164 2069 6d61 6765      # Load image
+00069b60: 2061 6e64 2070 726f 6365 7373 2069 740a   and process it.
+00069b70: 2020 2020 6564 6765 696d 6720 3d20 616e      edgeimg = an
+00069b80: 7473 2e69 4d61 7468 2862 7261 696e 5f69  ts.iMath(brain_i
+00069b90: 6d61 6765 2c22 4e6f 726d 616c 697a 6522  mage,"Normalize"
+00069ba0: 290a 2020 2020 6966 2065 6467 655f 696d  ).    if edge_im
+00069bb0: 6167 655f 6469 6c61 7469 6f6e 203e 2030  age_dilation > 0
+00069bc0: 3a0a 2020 2020 2020 2020 6564 6765 696d  :.        edgeim
+00069bd0: 6720 3d20 616e 7473 2e69 4d61 7468 2820  g = ants.iMath( 
+00069be0: 6564 6765 696d 672c 2022 4d44 222c 2065  edgeimg, "MD", e
+00069bf0: 6467 655f 696d 6167 655f 6469 6c61 7469  dge_image_dilati
+00069c00: 6f6e 290a 0a20 2020 2023 2044 6566 696e  on)..    # Defin
+00069c10: 6520 6c69 7374 7320 616e 6420 6461 7461  e lists and data
+00069c20: 2066 7261 6d65 730a 2020 2020 706f 7374   frames.    post
+00069c30: 6669 7820 3d20 5b27 6266 272c 2027 6369  fix = ['bf', 'ci
+00069c40: 7431 3638 6c61 6227 2c20 276d 746c 272c  t168lab', 'mtl',
+00069c50: 2027 6365 7265 6265 6c6c 756d 272c 2027   'cerebellum', '
+00069c60: 646b 745f 636f 7274 6578 272c 2762 7261  dkt_cortex','bra
+00069c70: 696e 7374 656d 272c 274a 4855 5f77 6d27  instem','JHU_wm'
+00069c80: 2c27 7965 6f27 5d0a 2020 2020 6174 6c61  ,'yeo'].    atla
+00069c90: 7320 3d20 5b27 4246 272c 2027 4349 5431  s = ['BF', 'CIT1
+00069ca0: 3638 272c 2027 4d54 4c27 2c20 2754 7573  68', 'MTL', 'Tus
+00069cb0: 7469 736f 6e43 6f62 7261 272c 2027 6465  tisonCobra', 'de
+00069cc0: 7369 6b61 6e2d 6b69 6c6c 6961 6e79 2d74  sikan-killiany-t
+00069cd0: 6f75 7276 696c 6c65 272c 2762 7261 696e  ourville','brain
+00069ce0: 7374 656d 272c 274a 4855 5f77 6d27 2c27  stem','JHU_wm','
+00069cf0: 7965 6f27 5d0a 2020 2020 706f 7374 6465  yeo'].    postde
+00069d00: 7363 203d 205b 276e 626d 3343 4831 3327  sc = ['nbm3CH13'
+00069d10: 2c20 2743 4954 3136 385f 5265 696e 665f  , 'CIT168_Reinf_
+00069d20: 4c65 6172 6e5f 7631 5f6c 6162 656c 5f64  Learn_v1_label_d
+00069d30: 6573 6372 6970 7469 6f6e 735f 7061 6427  escriptions_pad'
+00069d40: 2c20 276d 746c 5f64 6573 6372 6970 7469  , 'mtl_descripti
+00069d50: 6f6e 272c 2027 6365 7265 6265 6c6c 756d  on', 'cerebellum
+00069d60: 272c 2027 646b 7427 2c27 4349 5431 3638  ', 'dkt','CIT168
+00069d70: 5f54 3177 5f37 3030 756d 5f70 6164 5f61  _T1w_700um_pad_a
+00069d80: 646e 695f 6272 6169 6e73 7465 6d27 2c27  dni_brainstem','
+00069d90: 4641 5f4a 4855 5f6c 6162 656c 735f 6564  FA_JHU_labels_ed
+00069da0: 6974 6564 272c 2770 706d 695f 7465 6d70  ited','ppmi_temp
+00069db0: 6c61 7465 5f35 3030 5061 7263 656c 735f  late_500Parcels_
+00069dc0: 5965 6f32 3031 315f 3137 4e65 7477 6f72  Yeo2011_17Networ
+00069dd0: 6b73 5f32 3032 335f 686f 6d6f 746f 7069  ks_2023_homotopi
+00069de0: 6327 5d0a 2020 2020 7374 6174 6466 203d  c'].    statdf =
+00069df0: 2070 642e 4461 7461 4672 616d 6528 7b27   pd.DataFrame({'
+00069e00: 696d 6727 3a20 706f 7374 6669 782c 2027  img': postfix, '
+00069e10: 6174 6c61 7327 3a20 6174 6c61 732c 2027  atlas': atlas, '
+00069e20: 6373 7664 6573 6372 6970 7427 3a20 706f  csvdescript': po
+00069e30: 7374 6465 7363 7d29 0a20 2020 2074 656d  stdesc}).    tem
+00069e40: 706c 6174 6570 7265 6669 7820 3d20 277e  plateprefix = '~
+00069e50: 2f2e 616e 7473 7079 6d6d 2f50 504d 495f  /.antspymm/PPMI_
+00069e60: 7465 6d70 6c61 7465 305f 270a 2020 2020  template0_'.    
+00069e70: 2320 4974 6572 6174 6520 7468 726f 7567  # Iterate throug
+00069e80: 6820 636f 6c75 6d6e 7320 616e 6420 6372  h columns and cr
+00069e90: 6561 7465 2066 6967 7572 6573 0a20 2020  eate figures.   
+00069ea0: 2063 6f6c 3276 697a 203d 2027 7661 6c75   col2viz = 'valu
+00069eb0: 6573 270a 2020 2020 6966 2054 7275 653a  es'.    if True:
+00069ec0: 0a20 2020 2020 2020 2061 6e61 7474 6f73  .        anattos
+00069ed0: 686f 7720 3d20 7a7a 5b27 616e 6174 275d  how = zz['anat']
+00069ee0: 2e75 6e69 7175 6528 290a 2020 2020 2020  .unique().      
+00069ef0: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+00069f00: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00069f10: 636f 6c32 7669 7a29 0a20 2020 2020 2020  col2viz).       
+00069f20: 2020 2020 2070 7269 6e74 2861 6e61 7474       print(anatt
+00069f30: 6f73 686f 7729 0a20 2020 2020 2020 2023  oshow).        #
+00069f40: 2052 6573 7420 6f66 2079 6f75 7220 636f   Rest of your co
+00069f50: 6465 2066 6f72 2066 6967 7572 6520 6372  de for figure cr
+00069f60: 6561 7469 6f6e 2067 6f65 7320 6865 7265  eation goes here
+00069f70: 2e2e 2e0a 2020 2020 2020 2020 6164 6465  ....        adde
+00069f80: 6d20 3d20 6564 6765 696d 6720 2a20 300a  m = edgeimg * 0.
+00069f90: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
+00069fa0: 2072 616e 6765 286c 656e 2861 6e61 7474   range(len(anatt
+00069fb0: 6f73 686f 7729 293a 0a20 2020 2020 2020  oshow)):.       
+00069fc0: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
+00069fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00069fe0: 2070 7269 6e74 2873 7472 286b 2920 2b20   print(str(k) + 
+00069ff0: 2022 2022 202b 2061 6e61 7474 6f73 686f   " " + anattosho
+0006a000: 775b 6b5d 2020 290a 2020 2020 2020 2020  w[k]  ).        
+0006a010: 2020 2020 6d79 7375 6220 3d20 7a7a 5b7a      mysub = zz[z
+0006a020: 7a5b 2761 6e61 7427 5d2e 7374 722e 636f  z['anat'].str.co
+0006a030: 6e74 6169 6e73 2861 6e61 7474 6f73 686f  ntains(anattosho
+0006a040: 775b 6b5d 295d 0a20 2020 2020 2020 2020  w[k])].         
+0006a050: 2020 2061 6e61 7473 6561 723d 7265 2e73     anatsear=re.s
+0006a060: 7562 2822 6474 692e 6661 222c 2222 2c61  ub("dti.fa","",a
+0006a070: 6e61 7474 6f73 686f 775b 6b5d 290a 2020  nattoshow[k]).  
+0006a080: 2020 2020 2020 2020 2020 616e 6174 7365            anatse
+0006a090: 6172 3d72 652e 7375 6228 2263 6266 2e22  ar=re.sub("cbf."
+0006a0a0: 2c22 222c 616e 6174 7365 6172 290a 2020  ,"",anatsear).  
+0006a0b0: 2020 2020 2020 2020 2020 616e 6174 7365            anatse
+0006a0c0: 6172 3d72 652e 7375 6228 2274 312e 766f  ar=re.sub("t1.vo
+0006a0d0: 6c61 7379 6d22 2c22 222c 616e 6174 7365  lasym","",anatse
+0006a0e0: 6172 290a 2020 2020 2020 2020 2020 2020  ar).            
+0006a0f0: 616e 6174 7365 6172 3d72 652e 7375 6228  anatsear=re.sub(
+0006a100: 2274 312e 7468 6b61 7379 6d22 2c22 222c  "t1.thkasym","",
+0006a110: 616e 6174 7365 6172 290a 2020 2020 2020  anatsear).      
+0006a120: 2020 2020 2020 616e 6174 7365 6172 3d72        anatsear=r
+0006a130: 652e 7375 6228 2274 312e 6172 6561 6173  e.sub("t1.areaas
+0006a140: 796d 222c 2222 2c61 6e61 7473 6561 7229  ym","",anatsear)
+0006a150: 0a20 2020 2020 2020 2020 2020 2061 6e61  .            ana
+0006a160: 7473 6561 723d 7265 2e73 7562 2822 7431  tsear=re.sub("t1
+0006a170: 2e76 6f6c 2e22 2c22 222c 616e 6174 7365  .vol.","",anatse
+0006a180: 6172 290a 2020 2020 2020 2020 2020 2020  ar).            
+0006a190: 616e 6174 7365 6172 3d72 652e 7375 6228  anatsear=re.sub(
+0006a1a0: 2274 312e 7468 6b2e 222c 2222 2c61 6e61  "t1.thk.","",ana
+0006a1b0: 7473 6561 7229 0a20 2020 2020 2020 2020  tsear).         
+0006a1c0: 2020 2061 6e61 7473 6561 723d 7265 2e73     anatsear=re.s
+0006a1d0: 7562 2822 7431 2e61 7265 612e 222c 2222  ub("t1.area.",""
+0006a1e0: 2c61 6e61 7473 6561 7229 0a20 2020 2020  ,anatsear).     
+0006a1f0: 2020 2020 2020 2061 6e61 7473 6561 723d         anatsear=
+0006a200: 7265 2e73 7562 2822 6173 796d 6470 2e22  re.sub("asymdp."
+0006a210: 2c22 222c 616e 6174 7365 6172 290a 2020  ,"",anatsear).  
+0006a220: 2020 2020 2020 2020 2020 616e 6174 7365            anatse
+0006a230: 6172 3d72 652e 7375 6228 2261 7379 6d2e  ar=re.sub("asym.
+0006a240: 222c 2222 2c61 6e61 7473 6561 7229 0a20  ","",anatsear). 
+0006a250: 2020 2020 2020 2020 2020 2061 6e61 7473             anats
+0006a260: 6561 723d 7265 2e73 7562 2822 6474 692e  ear=re.sub("dti.
+0006a270: 6d64 2e22 2c22 222c 616e 6174 7365 6172  md.","",anatsear
+0006a280: 290a 2020 2020 2020 2020 2020 2020 616e  ).            an
+0006a290: 6174 7365 6172 3d72 652e 7375 6228 2264  atsear=re.sub("d
+0006a2a0: 7469 2e66 612e 222c 2222 2c61 6e61 7473  ti.fa.","",anats
+0006a2b0: 6561 7229 0a20 2020 2020 2020 2020 2020  ear).           
+0006a2c0: 2061 6e61 7473 6561 723d 7265 2e73 7562   anatsear=re.sub
+0006a2d0: 2822 6474 692e 6d64 222c 2222 2c61 6e61  ("dti.md","",ana
+0006a2e0: 7473 6561 7229 0a20 2020 2020 2020 2020  tsear).         
+0006a2f0: 2020 2061 6e61 7473 6561 723d 7265 2e73     anatsear=re.s
+0006a300: 7562 2822 6474 692e 6d65 616e 2e6d 642e  ub("dti.mean.md.
+0006a310: 222c 2222 2c61 6e61 7473 6561 7229 0a20  ","",anatsear). 
+0006a320: 2020 2020 2020 2020 2020 2061 6e61 7473             anats
+0006a330: 6561 723d 7265 2e73 7562 2822 6474 692e  ear=re.sub("dti.
+0006a340: 6d65 616e 2e66 612e 222c 2222 2c61 6e61  mean.fa.","",ana
+0006a350: 7473 6561 7229 0a20 2020 2020 2020 2020  tsear).         
+0006a360: 2020 2061 6e61 7473 6561 723d 7265 2e73     anatsear=re.s
+0006a370: 7562 2822 6c72 6176 6722 2c22 222c 616e  ub("lravg","",an
+0006a380: 6174 7365 6172 290a 2020 2020 2020 2020  atsear).        
+0006a390: 2020 2020 6174 6c61 7373 6561 7263 6820      atlassearch 
+0006a3a0: 3d20 6d79 6469 6374 5b27 7469 6479 6e61  = mydict['tidyna
+0006a3b0: 6d65 7327 5d2e 7374 722e 636f 6e74 6169  mes'].str.contai
+0006a3c0: 6e73 2861 6e61 7473 6561 7229 0a20 2020  ns(anatsear).   
+0006a3d0: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
+0006a3e0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+0006a3f0: 2020 2020 2070 7269 6e74 2820 2220 616e       print( " an
+0006a400: 6174 7365 6172 2022 202b 2061 6e61 7473  atsear " + anats
+0006a410: 6561 7220 2b20 2220 6174 6c61 7373 6561  ear + " atlassea
+0006a420: 7263 6820 2220 290a 2020 2020 2020 2020  rch " ).        
+0006a430: 2020 2020 6966 2061 746c 6173 7365 6172      if atlassear
+0006a440: 6368 2e73 756d 2829 203e 2030 3a0a 2020  ch.sum() > 0:.  
+0006a450: 2020 2020 2020 2020 2020 2020 2020 7768                wh
+0006a460: 6963 6861 746c 6173 203d 206d 7964 6963  ichatlas = mydic
+0006a470: 745b 6174 6c61 7373 6561 7263 685d 5b27  t[atlassearch]['
+0006a480: 4174 6c61 7327 5d2e 696c 6f63 5b30 5d0a  Atlas'].iloc[0].
+0006a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a4a0: 6f67 6c61 6265 6c6e 616d 6520 3d20 6d79  oglabelname = my
+0006a4b0: 6469 6374 5b61 746c 6173 7365 6172 6368  dict[atlassearch
+0006a4c0: 5d5b 274c 6162 656c 275d 2e69 6c6f 635b  ]['Label'].iloc[
+0006a4d0: 305d 0a20 2020 2020 2020 2020 2020 2065  0].            e
+0006a4e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0006a4f0: 2020 2020 2070 7269 6e74 2861 6e61 7473       print(anats
+0006a500: 6561 7229 0a20 2020 2020 2020 2020 2020  ear).           
+0006a510: 2020 2020 206f 676c 6162 656c 6e61 6d65       oglabelname
+0006a520: 3d27 756e 6b6e 6f77 6e27 0a20 2020 2020  ='unknown'.     
+0006a530: 2020 2020 2020 2020 2020 2077 6869 6368             which
+0006a540: 6174 6c61 733d 4e6f 6e65 0a20 2020 2020  atlas=None.     
+0006a550: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+0006a560: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0006a570: 2020 2070 7269 6e74 2822 6f67 6c61 6265     print("oglabe
+0006a580: 6c6e 616d 6520 2220 2b20 6f67 6c61 6265  lname " + oglabe
+0006a590: 6c6e 616d 6520 2b20 2220 7768 6963 6861  lname + " whicha
+0006a5a0: 746c 6173 2022 202b 2073 7472 2877 6869  tlas " + str(whi
+0006a5b0: 6368 6174 6c61 7329 2029 0a20 2020 2020  chatlas) ).     
+0006a5c0: 2020 2020 2020 2076 616c 7332 7669 7a20         vals2viz 
+0006a5d0: 3d20 6d79 7375 625b 636f 6c32 7669 7a5d  = mysub[col2viz]
+0006a5e0: 2e61 6767 285b 276d 696e 272c 2027 6d61  .agg(['min', 'ma
+0006a5f0: 7827 5d29 0a20 2020 2020 2020 2020 2020  x']).           
+0006a600: 2076 616c 7332 7669 7a20 3d20 7661 6c73   vals2viz = vals
+0006a610: 3276 697a 5b61 6273 2876 616c 7332 7669  2viz[abs(vals2vi
+0006a620: 7a29 2e69 6478 6d61 7828 295d 0a20 2020  z).idxmax()].   
+0006a630: 2020 2020 2020 2020 206d 7965 7874 203d           myext =
+0006a640: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+0006a650: 2020 6966 2027 646b 7463 6f72 7465 7827    if 'dktcortex'
+0006a660: 2069 6e20 616e 6174 746f 7368 6f77 5b6b   in anattoshow[k
+0006a670: 5d20 6f72 2077 6869 6368 6174 6c61 7320  ] or whichatlas 
+0006a680: 3d3d 2027 6465 7369 6b61 6e2d 6b69 6c6c  == 'desikan-kill
+0006a690: 6961 6e79 2d74 6f75 7276 696c 6c65 2720  iany-tourville' 
+0006a6a0: 6f72 2027 6474 6b72 6567 696f 6e73 2720  or 'dtkregions' 
+0006a6b0: 696e 2061 6e61 7474 6f73 686f 775b 6b5d  in anattoshow[k]
+0006a6c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0006a6d0: 2020 6d79 6578 7420 3d20 2764 6b74 5f63    myext = 'dkt_c
+0006a6e0: 6f72 7465 7827 0a20 2020 2020 2020 2020  ortex'.         
+0006a6f0: 2020 2065 6c69 6620 2763 6974 3136 3827     elif 'cit168'
+0006a700: 2069 6e20 616e 6174 746f 7368 6f77 5b6b   in anattoshow[k
+0006a710: 5d20 6f72 2077 6869 6368 6174 6c61 7320  ] or whichatlas 
+0006a720: 3d3d 2027 4349 5431 3638 273a 0a20 2020  == 'CIT168':.   
+0006a730: 2020 2020 2020 2020 2020 2020 206d 7965               mye
+0006a740: 7874 203d 2027 6369 7431 3638 6c61 6227  xt = 'cit168lab'
+0006a750: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+0006a760: 6620 276d 746c 2720 696e 2061 6e61 7474  f 'mtl' in anatt
+0006a770: 6f73 686f 775b 6b5d 3a0a 2020 2020 2020  oshow[k]:.      
+0006a780: 2020 2020 2020 2020 2020 6d79 6578 7420            myext 
+0006a790: 3d20 276d 746c 270a 2020 2020 2020 2020  = 'mtl'.        
+0006a7a0: 2020 2020 2020 2020 6f67 6c61 6265 6c6e          oglabeln
+0006a7b0: 616d 653d 7265 2e73 7562 2827 6d74 6c27  ame=re.sub('mtl'
+0006a7c0: 2c20 2727 2c61 6e61 7473 6561 7229 0a20  , '',anatsear). 
+0006a7d0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0006a7e0: 2763 6572 6562 656c 6c75 6d27 2069 6e20  'cerebellum' in 
+0006a7f0: 616e 6174 746f 7368 6f77 5b6b 5d3a 0a20  anattoshow[k]:. 
+0006a800: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0006a810: 7965 7874 203d 2027 6365 7265 6265 6c6c  yext = 'cerebell
+0006a820: 756d 270a 2020 2020 2020 2020 2020 2020  um'.            
+0006a830: 2020 2020 6f67 6c61 6265 6c6e 616d 653d      oglabelname=
+0006a840: 7265 2e73 7562 2827 6365 7265 6265 6c6c  re.sub('cerebell
+0006a850: 756d 272c 2027 272c 616e 6174 7365 6172  um', '',anatsear
+0006a860: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0006a870: 2020 2320 6f67 6c61 6265 6c6e 616d 653d    # oglabelname=
+0006a880: 6f67 6c61 6265 6c6e 616d 655b 323a 5d0a  oglabelname[2:].
+0006a890: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0006a8a0: 2027 6272 6169 6e73 7465 6d27 2069 6e20   'brainstem' in 
+0006a8b0: 616e 6174 746f 7368 6f77 5b6b 5d3a 0a20  anattoshow[k]:. 
+0006a8c0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0006a8d0: 7965 7874 203d 2027 6272 6169 6e73 7465  yext = 'brainste
+0006a8e0: 6d27 0a20 2020 2020 2020 2020 2020 2065  m'.            e
+0006a8f0: 6c69 6620 616e 7928 6974 656d 2069 6e20  lif any(item in 
+0006a900: 616e 6174 746f 7368 6f77 5b6b 5d20 666f  anattoshow[k] fo
+0006a910: 7220 6974 656d 2069 6e20 5b27 6e62 6d27  r item in ['nbm'
+0006a920: 2c20 2762 6627 5d29 3a0a 2020 2020 2020  , 'bf']):.      
+0006a930: 2020 2020 2020 2020 2020 6d79 6578 7420            myext 
+0006a940: 3d20 2762 6627 0a20 2020 2020 2020 2020  = 'bf'.         
+0006a950: 2020 2020 2020 206f 676c 6162 656c 6e61         oglabelna
+0006a960: 6d65 3d72 652e 7375 6228 7227 5c2e 272c  me=re.sub(r'\.',
+0006a970: 2027 5f27 2c61 6e61 7473 6561 7229 0a20   '_',anatsear). 
+0006a980: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0006a990: 7768 6963 6861 746c 6173 203d 3d20 276a  whichatlas == 'j
+0006a9a0: 6f68 6e73 2068 6f70 6b69 6e73 2077 6869  ohns hopkins whi
+0006a9b0: 7465 206d 6174 7465 7227 3a0a 2020 2020  te matter':.    
+0006a9c0: 2020 2020 2020 2020 2020 2020 6d79 6578              myex
+0006a9d0: 7420 3d20 274a 4855 5f77 6d27 0a20 2020  t = 'JHU_wm'.   
+0006a9e0: 2020 2020 2020 2020 2065 6c69 6620 7768           elif wh
+0006a9f0: 6963 6861 746c 6173 203d 3d20 2764 6573  ichatlas == 'des
+0006aa00: 696b 616e 2d6b 696c 6c69 616e 792d 746f  ikan-killiany-to
+0006aa10: 7572 7669 6c6c 6527 3a0a 2020 2020 2020  urville':.      
+0006aa20: 2020 2020 2020 2020 2020 6d79 6578 7420            myext 
+0006aa30: 3d20 2764 6b74 5f63 6f72 7465 7827 0a20  = 'dkt_cortex'. 
+0006aa40: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0006aa50: 7768 6963 6861 746c 6173 203d 3d20 2743  whichatlas == 'C
+0006aa60: 4954 3136 3827 3a0a 2020 2020 2020 2020  IT168':.        
+0006aa70: 2020 2020 2020 2020 6d79 6578 7420 3d20          myext = 
+0006aa80: 2763 6974 3136 386c 6162 270a 2020 2020  'cit168lab'.    
+0006aa90: 2020 2020 2020 2020 656c 6966 2077 6869          elif whi
+0006aaa0: 6368 6174 6c61 7320 3d3d 2027 4246 273a  chatlas == 'BF':
+0006aab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006aac0: 206d 7965 7874 203d 2027 6266 270a 2020   myext = 'bf'.  
+0006aad0: 2020 2020 2020 2020 2020 2020 2020 6f67                og
+0006aae0: 6c61 6265 6c6e 616d 653d 7265 2e73 7562  labelname=re.sub
+0006aaf0: 2827 6266 272c 2027 272c 6f67 6c61 6265  ('bf', '',oglabe
+0006ab00: 6c6e 616d 6529 0a20 2020 2020 2020 2020  lname).         
+0006ab10: 2020 2065 6c69 6620 7768 6963 6861 746c     elif whichatl
+0006ab20: 6173 203d 3d20 2779 656f 5f68 6f6d 6f74  as == 'yeo_homot
+0006ab30: 6f70 6963 273a 0a20 2020 2020 2020 2020  opic':.         
+0006ab40: 2020 2020 2020 206d 7965 7874 203d 2027         myext = '
+0006ab50: 7965 6f27 0a20 2020 2020 2020 2020 2020  yeo'.           
+0006ab60: 2069 6620 6d79 6578 7420 6973 204e 6f6e   if myext is Non
+0006ab70: 6520 616e 6420 7665 7262 6f73 653a 0a20  e and verbose:. 
+0006ab80: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0006ab90: 6620 7768 6963 6861 746c 6173 2069 7320  f whichatlas is 
+0006aba0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0006abb0: 2020 2020 2020 2020 2020 7768 6963 6861            whicha
+0006abc0: 746c 6173 3d27 4e6f 6e65 270a 2020 2020  tlas='None'.    
+0006abd0: 2020 2020 2020 2020 2020 2020 6966 2061              if a
+0006abe0: 6e61 7474 6f73 686f 775b 6b5d 2069 7320  nattoshow[k] is 
+0006abf0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0006ac00: 2020 2020 2020 2020 2020 616e 6174 746f            anatto
+0006ac10: 7368 6f77 5b6b 5d3d 274e 6f6e 6527 0a20  show[k]='None'. 
+0006ac20: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0006ac30: 7269 6e74 2820 224d 5945 5854 2022 202b  rint( "MYEXT " +
+0006ac40: 2061 6e61 7474 6f73 686f 775b 6b5d 202b   anattoshow[k] +
+0006ac50: 2027 2075 6e66 6f75 6e64 2027 202b 2077   ' unfound ' + w
+0006ac60: 6869 6368 6174 6c61 7320 290a 2020 2020  hichatlas ).    
+0006ac70: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0006ac80: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0006ac90: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+0006aca0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0006acb0: 696e 7428 2022 4d59 4558 5420 2220 2b20  int( "MYEXT " + 
+0006acc0: 6d79 6578 7420 290a 0a20 2020 2020 2020  myext )..       
+0006acd0: 2020 2020 2069 6620 6d79 6578 7420 3d3d       if myext ==
+0006ace0: 2027 6369 7431 3638 6c61 6227 3a0a 2020   'cit168lab':.  
+0006acf0: 2020 2020 2020 2020 2020 2020 2020 6f67                og
+0006ad00: 6c61 6265 6c6e 616d 653d 7265 2e73 7562  labelname=re.sub
+0006ad10: 2822 6369 7431 3638 222c 2222 2c6f 676c  ("cit168","",ogl
+0006ad20: 6162 656c 6e61 6d65 290a 2020 2020 2020  abelname).      
+0006ad30: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+0006ad40: 2020 2066 6f72 206a 2069 6e20 706f 7374     for j in post
+0006ad50: 6669 783a 0a20 2020 2020 2020 2020 2020  fix:.           
+0006ad60: 2020 2020 2069 6620 6a20 3d3d 2022 646b       if j == "dk
+0006ad70: 745f 636f 7274 6578 223a 0a20 2020 2020  t_cortex":.     
+0006ad80: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+0006ad90: 203d 2027 646b 7463 6f72 7465 7827 0a20   = 'dktcortex'. 
+0006ada0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0006adb0: 6620 6a20 3d3d 2022 6465 6570 5f63 6974  f j == "deep_cit
+0006adc0: 3136 386c 6162 223a 0a20 2020 2020 2020  168lab":.       
+0006add0: 2020 2020 2020 2020 2020 2020 206a 203d               j =
+0006ade0: 2027 6465 6570 5f63 6974 3136 3827 0a20   'deep_cit168'. 
+0006adf0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0006ae00: 6e61 7474 6f73 686f 775b 6b5d 203d 2061  nattoshow[k] = a
+0006ae10: 6e61 7474 6f73 686f 775b 6b5d 2e72 6570  nattoshow[k].rep
+0006ae20: 6c61 6365 286a 2c20 2222 290a 2020 2020  lace(j, "").    
+0006ae30: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+0006ae40: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0006ae50: 2020 2020 7072 696e 7428 2061 6e61 7474      print( anatt
+0006ae60: 6f73 686f 775b 6b5d 202b 2022 2022 202b  oshow[k] + " " +
+0006ae70: 2073 7472 2820 7661 6c73 3276 697a 2029   str( vals2viz )
+0006ae80: 2029 0a20 2020 2020 2020 2020 2020 206d   ).            m
+0006ae90: 7961 746c 6173 203d 2061 746c 6173 5b70  yatlas = atlas[p
+0006aea0: 6f73 7466 6978 2e69 6e64 6578 286d 7965  ostfix.index(mye
+0006aeb0: 7874 295d 0a20 2020 2020 2020 2020 2020  xt)].           
+0006aec0: 2063 6f72 7265 6374 6465 7363 7269 7074   correctdescript
+0006aed0: 203d 2070 6f73 7464 6573 635b 706f 7374   = postdesc[post
+0006aee0: 6669 782e 696e 6465 7828 6d79 6578 7429  fix.index(myext)
+0006aef0: 5d0a 2020 2020 2020 2020 2020 2020 6c6f  ].            lo
+0006af00: 6366 696c 656e 616d 6520 3d20 2074 656d  cfilename =  tem
+0006af10: 706c 6174 6570 7265 6669 7820 2b20 6d79  plateprefix + my
+0006af20: 6578 7420 2b20 272e 6e69 692e 677a 270a  ext + '.nii.gz'.
+0006af30: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+0006af40: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+0006af50: 2020 2020 2020 2020 7072 696e 7428 206c          print( l
+0006af60: 6f63 6669 6c65 6e61 6d65 2029 0a20 2020  ocfilename ).   
+0006af70: 2020 2020 2020 2020 2069 6620 6d79 6578           if myex
+0006af80: 7420 3d3d 2027 7965 6f27 3a0a 2020 2020  t == 'yeo':.    
+0006af90: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
+0006afa0: 6265 6c6e 616d 653d 6f67 6c61 6265 6c6e  belname=oglabeln
+0006afb0: 616d 652e 6c6f 7765 7228 290a 2020 2020  ame.lower().    
+0006afc0: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
+0006afd0: 6265 6c6e 616d 653d 7265 2e73 7562 2822  belname=re.sub("
+0006afe0: 7273 666d 7269 5f66 636e 7870 726f 3132  rsfmri_fcnxpro12
+0006aff0: 325f 222c 2222 2c6f 676c 6162 656c 6e61  2_","",oglabelna
+0006b000: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+0006b010: 2020 2020 6f67 6c61 6265 6c6e 616d 653d      oglabelname=
+0006b020: 7265 2e73 7562 2822 7273 666d 7269 5f66  re.sub("rsfmri_f
+0006b030: 636e 7870 726f 3132 395f 222c 2222 2c6f  cnxpro129_","",o
+0006b040: 676c 6162 656c 6e61 6d65 290a 2020 2020  glabelname).    
+0006b050: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
+0006b060: 6265 6c6e 616d 653d 7265 2e73 7562 2822  belname=re.sub("
+0006b070: 7273 666d 7269 5f66 636e 7870 726f 3133  rsfmri_fcnxpro13
+0006b080: 345f 222c 2222 2c6f 676c 6162 656c 6e61  4_","",oglabelna
+0006b090: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+0006b0a0: 2020 2020 6c6f 6366 696c 656e 616d 6520      locfilename 
+0006b0b0: 3d20 227e 2f2e 616e 7473 7079 6d6d 2f70  = "~/.antspymm/p
+0006b0c0: 706d 695f 7465 6d70 6c61 7465 5f35 3030  pmi_template_500
+0006b0d0: 5061 7263 656c 735f 5965 6f32 3031 315f  Parcels_Yeo2011_
+0006b0e0: 3137 4e65 7477 6f72 6b73 5f32 3032 335f  17Networks_2023_
+0006b0f0: 686f 6d6f 746f 7069 632e 6e69 692e 677a  homotopic.nii.gz
+0006b100: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0006b110: 2020 6174 6c61 7344 6573 6372 6970 7420    atlasDescript 
+0006b120: 3d20 7064 2e72 6561 645f 6373 7628 6622  = pd.read_csv(f"
+0006b130: 7e2f 2e61 6e74 7370 796d 6d2f 7b63 6f72  ~/.antspymm/{cor
+0006b140: 7265 6374 6465 7363 7269 7074 7d2e 6373  rectdescript}.cs
+0006b150: 7622 290a 2020 2020 2020 2020 2020 2020  v").            
+0006b160: 2020 2020 6174 6c61 7344 6573 6372 6970      atlasDescrip
+0006b170: 742e 7265 6e61 6d65 2863 6f6c 756d 6e73  t.rename(columns
+0006b180: 3d7b 2753 7973 7465 6d4e 616d 6527 3a20  ={'SystemName': 
+0006b190: 2744 6573 6372 6970 7469 6f6e 277d 2c20  'Description'}, 
+0006b1a0: 696e 706c 6163 653d 5472 7565 290a 2020  inplace=True).  
+0006b1b0: 2020 2020 2020 2020 2020 2020 2020 6174                at
+0006b1c0: 6c61 7344 6573 6372 6970 742e 7265 6e61  lasDescript.rena
+0006b1d0: 6d65 2863 6f6c 756d 6e73 3d7b 2752 4f49  me(columns={'ROI
+0006b1e0: 273a 2027 4c61 6265 6c27 7d2c 2069 6e70  ': 'Label'}, inp
+0006b1f0: 6c61 6365 3d54 7275 6529 0a20 2020 2020  lace=True).     
+0006b200: 2020 2020 2020 2020 2020 2061 746c 6173             atlas
+0006b210: 4465 7363 7269 7074 5b27 4465 7363 7269  Descript['Descri
+0006b220: 7074 696f 6e27 5d20 3d20 6174 6c61 7344  ption'] = atlasD
+0006b230: 6573 6372 6970 745b 2744 6573 6372 6970  escript['Descrip
+0006b240: 7469 6f6e 275d 2e73 7472 2e6c 6f77 6572  tion'].str.lower
+0006b250: 2829 0a20 2020 2020 2020 2020 2020 2065  ().            e
+0006b260: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0006b270: 2020 2020 2061 746c 6173 4465 7363 7269       atlasDescri
+0006b280: 7074 203d 2070 642e 7265 6164 5f63 7376  pt = pd.read_csv
+0006b290: 2866 227e 2f2e 616e 7473 7079 7431 772f  (f"~/.antspyt1w/
+0006b2a0: 7b63 6f72 7265 6374 6465 7363 7269 7074  {correctdescript
+0006b2b0: 7d2e 6373 7622 290a 2020 2020 2020 2020  }.csv").        
+0006b2c0: 2020 2020 2020 2020 6174 6c61 7344 6573          atlasDes
+0006b2d0: 6372 6970 745b 2744 6573 6372 6970 7469  cript['Descripti
+0006b2e0: 6f6e 275d 203d 2061 746c 6173 4465 7363  on'] = atlasDesc
+0006b2f0: 7269 7074 5b27 4465 7363 7269 7074 696f  ript['Descriptio
+0006b300: 6e27 5d2e 7374 722e 6c6f 7765 7228 290a  n'].str.lower().
+0006b310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b320: 6174 6c61 7344 6573 6372 6970 745b 2744  atlasDescript['D
+0006b330: 6573 6372 6970 7469 6f6e 275d 203d 2061  escription'] = a
+0006b340: 746c 6173 4465 7363 7269 7074 5b27 4465  tlasDescript['De
+0006b350: 7363 7269 7074 696f 6e27 5d2e 7374 722e  scription'].str.
+0006b360: 7265 706c 6163 6528 2220 222c 2022 5f22  replace(" ", "_"
+0006b370: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0006b380: 2020 6174 6c61 7344 6573 6372 6970 745b    atlasDescript[
+0006b390: 2744 6573 6372 6970 7469 6f6e 275d 203d  'Description'] =
+0006b3a0: 2061 746c 6173 4465 7363 7269 7074 5b27   atlasDescript['
+0006b3b0: 4465 7363 7269 7074 696f 6e27 5d2e 7374  Description'].st
+0006b3c0: 722e 7265 706c 6163 6528 225f 6c65 6674  r.replace("_left
+0006b3d0: 5f22 2c20 225f 2229 0a20 2020 2020 2020  _", "_").       
+0006b3e0: 2020 2020 2020 2020 2061 746c 6173 4465           atlasDe
+0006b3f0: 7363 7269 7074 5b27 4465 7363 7269 7074  script['Descript
+0006b400: 696f 6e27 5d20 3d20 6174 6c61 7344 6573  ion'] = atlasDes
+0006b410: 6372 6970 745b 2744 6573 6372 6970 7469  cript['Descripti
+0006b420: 6f6e 275d 2e73 7472 2e72 6570 6c61 6365  on'].str.replace
+0006b430: 2822 5f72 6967 6874 5f22 2c20 225f 2229  ("_right_", "_")
+0006b440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006b450: 2061 746c 6173 4465 7363 7269 7074 5b27   atlasDescript['
+0006b460: 4465 7363 7269 7074 696f 6e27 5d20 3d20  Description'] = 
+0006b470: 6174 6c61 7344 6573 6372 6970 745b 2744  atlasDescript['D
+0006b480: 6573 6372 6970 7469 6f6e 275d 2e73 7472  escription'].str
+0006b490: 2e72 6570 6c61 6365 2822 5f6c 6566 7422  .replace("_left"
+0006b4a0: 2c20 2222 290a 2020 2020 2020 2020 2020  , "").          
+0006b4b0: 2020 2020 2020 6174 6c61 7344 6573 6372        atlasDescr
+0006b4c0: 6970 745b 2744 6573 6372 6970 7469 6f6e  ipt['Description
+0006b4d0: 275d 203d 2061 746c 6173 4465 7363 7269  '] = atlasDescri
+0006b4e0: 7074 5b27 4465 7363 7269 7074 696f 6e27  pt['Description'
+0006b4f0: 5d2e 7374 722e 7265 706c 6163 6528 225f  ].str.replace("_
+0006b500: 7269 6768 7422 2c20 2222 290a 2020 2020  right", "").    
+0006b510: 2020 2020 2020 2020 2020 2020 6174 6c61              atla
+0006b520: 7344 6573 6372 6970 745b 2744 6573 6372  sDescript['Descr
+0006b530: 6970 7469 6f6e 275d 203d 2061 746c 6173  iption'] = atlas
+0006b540: 4465 7363 7269 7074 5b27 4465 7363 7269  Descript['Descri
+0006b550: 7074 696f 6e27 5d2e 7374 722e 7265 706c  ption'].str.repl
+0006b560: 6163 6528 226c 6566 745f 222c 2022 2229  ace("left_", "")
+0006b570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006b580: 2061 746c 6173 4465 7363 7269 7074 5b27   atlasDescript['
+0006b590: 4465 7363 7269 7074 696f 6e27 5d20 3d20  Description'] = 
+0006b5a0: 6174 6c61 7344 6573 6372 6970 745b 2744  atlasDescript['D
+0006b5b0: 6573 6372 6970 7469 6f6e 275d 2e73 7472  escription'].str
+0006b5c0: 2e72 6570 6c61 6365 2822 7269 6768 745f  .replace("right_
+0006b5d0: 222c 2022 2229 0a20 2020 2020 2020 2020  ", "").         
+0006b5e0: 2020 2020 2020 2061 746c 6173 4465 7363         atlasDesc
+0006b5f0: 7269 7074 5b27 4465 7363 7269 7074 696f  ript['Descriptio
+0006b600: 6e27 5d20 3d20 6174 6c61 7344 6573 6372  n'] = atlasDescr
+0006b610: 6970 745b 2744 6573 6372 6970 7469 6f6e  ipt['Description
+0006b620: 275d 2e73 7472 2e72 6570 6c61 6365 2822  '].str.replace("
+0006b630: 2f22 2c22 2e22 290a 2020 2020 2020 2020  /",".").        
+0006b640: 2020 2020 2020 2020 6966 206d 7965 7874          if myext
+0006b650: 203d 3d20 274a 4855 5f77 6d27 3a0a 2020   == 'JHU_wm':.  
+0006b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b670: 2020 6174 6c61 7344 6573 6372 6970 745b    atlasDescript[
+0006b680: 2744 6573 6372 6970 7469 6f6e 275d 203d  'Description'] =
+0006b690: 2061 746c 6173 4465 7363 7269 7074 5b27   atlasDescript['
+0006b6a0: 4465 7363 7269 7074 696f 6e27 5d2e 7374  Description'].st
+0006b6b0: 722e 7265 706c 6163 6528 2266 612d 222c  r.replace("fa-",
+0006b6c0: 2022 2229 0a20 2020 2020 2020 2020 2020   "").           
+0006b6d0: 2020 2020 2020 2020 2061 746c 6173 4465           atlasDe
+0006b6e0: 7363 7269 7074 5b27 4465 7363 7269 7074  script['Descript
+0006b6f0: 696f 6e27 5d20 3d20 6174 6c61 7344 6573  ion'] = atlasDes
+0006b700: 6372 6970 745b 2744 6573 6372 6970 7469  cript['Descripti
+0006b710: 6f6e 275d 2e73 7472 2e72 6570 6c61 6365  on'].str.replace
+0006b720: 2822 2d6c 6566 742d 222c 2022 2229 0a20  ("-left-", ""). 
+0006b730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b740: 2020 2061 746c 6173 4465 7363 7269 7074     atlasDescript
+0006b750: 5b27 4465 7363 7269 7074 696f 6e27 5d20  ['Description'] 
+0006b760: 3d20 6174 6c61 7344 6573 6372 6970 745b  = atlasDescript[
+0006b770: 2744 6573 6372 6970 7469 6f6e 275d 2e73  'Description'].s
+0006b780: 7472 2e72 6570 6c61 6365 2822 2d72 6967  tr.replace("-rig
+0006b790: 6874 2d22 2c20 2222 290a 2020 2020 2020  ht-", "").      
+0006b7a0: 2020 2020 2020 2020 2020 6966 206d 7965            if mye
+0006b7b0: 7874 203d 3d20 2763 6572 6562 656c 6c75  xt == 'cerebellu
+0006b7c0: 6d27 3a0a 2020 2020 2020 2020 2020 2020  m':.            
+0006b7d0: 2020 2020 2020 2020 6174 6c61 7344 6573          atlasDes
+0006b7e0: 6372 6970 745b 2744 6573 6372 6970 7469  cript['Descripti
+0006b7f0: 6f6e 275d 203d 2061 746c 6173 4465 7363  on'] = atlasDesc
+0006b800: 7269 7074 5b27 4465 7363 7269 7074 696f  ript['Descriptio
+0006b810: 6e27 5d2e 7374 722e 7265 706c 6163 6528  n'].str.replace(
+0006b820: 226c 5f22 2c20 2222 290a 2020 2020 2020  "l_", "").      
+0006b830: 2020 2020 2020 2020 2020 2020 2020 6174                at
+0006b840: 6c61 7344 6573 6372 6970 745b 2744 6573  lasDescript['Des
+0006b850: 6372 6970 7469 6f6e 275d 203d 2061 746c  cription'] = atl
+0006b860: 6173 4465 7363 7269 7074 5b27 4465 7363  asDescript['Desc
+0006b870: 7269 7074 696f 6e27 5d2e 7374 722e 7265  ription'].str.re
+0006b880: 706c 6163 6528 2272 5f22 2c20 2222 290a  place("r_", "").
+0006b890: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0006b8a0: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+0006b8b0: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
+0006b8c0: 6174 6c61 7344 6573 6372 6970 7420 290a  atlasDescript ).
+0006b8d0: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
+0006b8e0: 6265 6c6e 616d 6520 3d20 6f67 6c61 6265  belname = oglabe
+0006b8f0: 6c6e 616d 652e 6c6f 7765 7228 290a 2020  lname.lower().  
+0006b900: 2020 2020 2020 2020 2020 6f67 6c61 6265            oglabe
+0006b910: 6c6e 616d 6520 3d20 7265 2e73 7562 2822  lname = re.sub("
+0006b920: 2022 2c20 225f 222c 6f67 6c61 6265 6c6e   ", "_",oglabeln
+0006b930: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+0006b940: 206f 676c 6162 656c 6e61 6d65 203d 2072   oglabelname = r
+0006b950: 652e 7375 6228 225f 6c65 6674 5f22 2c20  e.sub("_left_", 
+0006b960: 225f 222c 6f67 6c61 6265 6c6e 616d 6529  "_",oglabelname)
+0006b970: 0a20 2020 2020 2020 2020 2020 206f 676c  .            ogl
+0006b980: 6162 656c 6e61 6d65 203d 2072 652e 7375  abelname = re.su
+0006b990: 6228 225f 7269 6768 745f 222c 2022 5f22  b("_right_", "_"
+0006b9a0: 2c6f 676c 6162 656c 6e61 6d65 290a 2020  ,oglabelname).  
+0006b9b0: 2020 2020 2020 2020 2020 6f67 6c61 6265            oglabe
+0006b9c0: 6c6e 616d 6520 3d20 7265 2e73 7562 2822  lname = re.sub("
+0006b9d0: 5f6c 6566 7422 2c20 2222 2c6f 676c 6162  _left", "",oglab
+0006b9e0: 656c 6e61 6d65 290a 2020 2020 2020 2020  elname).        
+0006b9f0: 2020 2020 6f67 6c61 6265 6c6e 616d 6520      oglabelname 
+0006ba00: 3d20 7265 2e73 7562 2822 5f72 6967 6874  = re.sub("_right
+0006ba10: 222c 2022 222c 6f67 6c61 6265 6c6e 616d  ", "",oglabelnam
+0006ba20: 6529 0a20 2020 2020 2020 2020 2020 206f  e).            o
+0006ba30: 676c 6162 656c 6e61 6d65 203d 2072 652e  glabelname = re.
+0006ba40: 7375 6228 2274 3168 6965 725f 766f 6c5f  sub("t1hier_vol_
+0006ba50: 222c 2022 222c 6f67 6c61 6265 6c6e 616d  ", "",oglabelnam
+0006ba60: 6529 0a20 2020 2020 2020 2020 2020 206f  e).            o
+0006ba70: 676c 6162 656c 6e61 6d65 203d 2072 652e  glabelname = re.
+0006ba80: 7375 6228 2274 3168 6965 725f 6172 6561  sub("t1hier_area
+0006ba90: 5f22 2c20 2222 2c6f 676c 6162 656c 6e61  _", "",oglabelna
+0006baa0: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+0006bab0: 6f67 6c61 6265 6c6e 616d 6520 3d20 7265  oglabelname = re
+0006bac0: 2e73 7562 2822 7431 6869 6572 5f74 686b  .sub("t1hier_thk
+0006bad0: 5f22 2c20 2222 2c6f 676c 6162 656c 6e61  _", "",oglabelna
+0006bae0: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+0006baf0: 6f67 6c61 6265 6c6e 616d 6520 3d20 7265  oglabelname = re
+0006bb00: 2e73 7562 2822 646b 7472 6567 696f 6e73  .sub("dktregions
+0006bb10: 222c 2022 222c 6f67 6c61 6265 6c6e 616d  ", "",oglabelnam
+0006bb20: 6529 0a20 2020 2020 2020 2020 2020 206f  e).            o
+0006bb30: 676c 6162 656c 6e61 6d65 203d 2072 652e  glabelname = re.
+0006bb40: 7375 6228 2264 6b74 636f 7274 6578 222c  sub("dktcortex",
+0006bb50: 2022 222c 6f67 6c61 6265 6c6e 616d 6529   "",oglabelname)
+0006bb60: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0006bb70: 6d79 6578 7420 3d3d 2027 4a48 555f 776d  myext == 'JHU_wm
+0006bb80: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+0006bb90: 2020 206f 676c 6162 656c 6e61 6d65 203d     oglabelname =
+0006bba0: 2072 652e 7375 6228 2264 7469 5f6d 6561   re.sub("dti_mea
+0006bbb0: 6e5f 6661 2e22 2c20 2222 2c6f 676c 6162  n_fa.", "",oglab
+0006bbc0: 656c 6e61 6d65 290a 2020 2020 2020 2020  elname).        
+0006bbd0: 2020 2020 2020 2020 6f67 6c61 6265 6c6e          oglabeln
+0006bbe0: 616d 6520 3d20 7265 2e73 7562 2822 6474  ame = re.sub("dt
+0006bbf0: 695f 6d65 616e 5f6d 642e 222c 2022 222c  i_mean_md.", "",
+0006bc00: 6f67 6c61 6265 6c6e 616d 6529 0a20 2020  oglabelname).   
+0006bc10: 2020 2020 2020 2020 2020 2020 206f 676c               ogl
+0006bc20: 6162 656c 6e61 6d65 203d 2072 652e 7375  abelname = re.su
+0006bc30: 6228 222e 6c65 6674 2e22 2c20 2222 2c6f  b(".left.", "",o
+0006bc40: 676c 6162 656c 6e61 6d65 290a 2020 2020  glabelname).    
+0006bc50: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
+0006bc60: 6265 6c6e 616d 6520 3d20 7265 2e73 7562  belname = re.sub
+0006bc70: 2822 2e72 6967 6874 2e22 2c20 2222 2c6f  (".right.", "",o
+0006bc80: 676c 6162 656c 6e61 6d65 290a 2020 2020  glabelname).    
+0006bc90: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
+0006bca0: 6265 6c6e 616d 6520 3d20 7265 2e73 7562  belname = re.sub
+0006bcb0: 2822 2e6c 7261 7667 2e22 2c20 2222 2c6f  (".lravg.", "",o
+0006bcc0: 676c 6162 656c 6e61 6d65 290a 2020 2020  glabelname).    
+0006bcd0: 2020 2020 2020 2020 2020 2020 6f67 6c61              ogla
+0006bce0: 6265 6c6e 616d 6520 3d20 7265 2e73 7562  belname = re.sub
+0006bcf0: 2822 2e61 7379 6d2e 222c 2022 222c 6f67  (".asym.", "",og
+0006bd00: 6c61 6265 6c6e 616d 6529 0a0a 2020 2020  labelname)..    
+0006bd10: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+0006bd20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0006bd30: 2020 2020 7072 696e 7428 226f 676c 6162      print("oglab
+0006bd40: 656c 6e61 6d65 2022 202b 206f 676c 6162  elname " + oglab
+0006bd50: 656c 6e61 6d65 2029 0a0a 2020 2020 2020  elname )..      
+0006bd60: 2020 2020 2020 6966 206d 7965 7874 203d        if myext =
+0006bd70: 3d20 2763 6572 6562 656c 6c75 6d27 3a0a  = 'cerebellum':.
+0006bd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006bd90: 6966 206e 6f74 2061 746c 6173 4465 7363  if not atlasDesc
+0006bda0: 7269 7074 2e65 6d70 7479 2061 6e64 2027  ript.empty and '
+0006bdb0: 4465 7363 7269 7074 696f 6e27 2069 6e20  Description' in 
+0006bdc0: 6174 6c61 7344 6573 6372 6970 742e 636f  atlasDescript.co
+0006bdd0: 6c75 6d6e 733a 0a20 2020 2020 2020 2020  lumns:.         
+0006bde0: 2020 2020 2020 2020 2020 2061 746c 6173             atlas
+0006bdf0: 4465 7363 7269 7074 5b27 4465 7363 7269  Descript['Descri
+0006be00: 7074 696f 6e27 5d20 3d20 6174 6c61 7344  ption'] = atlasD
+0006be10: 6573 6372 6970 745b 2744 6573 6372 6970  escript['Descrip
+0006be20: 7469 6f6e 275d 2e73 7472 2e72 6570 6c61  tion'].str.repla
+0006be30: 6365 2822 6c5f 222c 2022 2229 0a20 2020  ce("l_", "").   
+0006be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006be50: 2061 746c 6173 4465 7363 7269 7074 5b27   atlasDescript['
+0006be60: 4465 7363 7269 7074 696f 6e27 5d20 3d20  Description'] = 
+0006be70: 6174 6c61 7344 6573 6372 6970 745b 2744  atlasDescript['D
+0006be80: 6573 6372 6970 7469 6f6e 275d 2e73 7472  escription'].str
+0006be90: 2e72 6570 6c61 6365 2822 725f 222c 2022  .replace("r_", "
+0006bea0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+0006beb0: 2020 2020 2020 206f 676c 6162 656c 6e61         oglabelna
+0006bec0: 6d65 3d72 652e 7375 6228 2272 6176 6722  me=re.sub("ravg"
+0006bed0: 2c22 222c 6f67 6c61 6265 6c6e 616d 6529  ,"",oglabelname)
+0006bee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006bef0: 2020 2020 206f 676c 6162 656c 6e61 6d65       oglabelname
+0006bf00: 3d72 652e 7375 6228 226c 6176 6722 2c22  =re.sub("lavg","
+0006bf10: 222c 6f67 6c61 6265 6c6e 616d 6529 0a20  ",oglabelname). 
+0006bf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006bf30: 2020 2077 6869 6368 696e 6465 7820 3d20     whichindex = 
+0006bf40: 6174 6c61 7344 6573 6372 6970 742e 696e  atlasDescript.in
+0006bf50: 6465 785b 6174 6c61 7344 6573 6372 6970  dex[atlasDescrip
+0006bf60: 745b 2744 6573 6372 6970 7469 6f6e 275d  t['Description']
+0006bf70: 203d 3d20 6f67 6c61 6265 6c6e 616d 655d   == oglabelname]
+0006bf80: 2e76 616c 7565 735b 305d 0a20 2020 2020  .values[0].     
+0006bf90: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0006bfa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006bfb0: 2020 2020 2069 6620 6174 6c61 7344 6573       if atlasDes
+0006bfc0: 6372 6970 742e 656d 7074 793a 0a20 2020  cript.empty:.   
+0006bfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006bfe0: 2020 2020 2070 7269 6e74 2822 5468 6520       print("The 
+0006bff0: 4461 7461 4672 616d 6520 2761 746c 6173  DataFrame 'atlas
+0006c000: 4465 7363 7269 7074 2720 6973 2065 6d70  Descript' is emp
+0006c010: 7479 2e22 290a 2020 2020 2020 2020 2020  ty.").          
+0006c020: 2020 2020 2020 2020 2020 6966 2027 4465            if 'De
+0006c030: 7363 7269 7074 696f 6e27 206e 6f74 2069  scription' not i
+0006c040: 6e20 6174 6c61 7344 6573 6372 6970 742e  n atlasDescript.
+0006c050: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
+0006c060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c070: 2070 7269 6e74 2822 5468 6520 636f 6c75   print("The colu
+0006c080: 6d6e 2027 4465 7363 7269 7074 696f 6e27  mn 'Description'
+0006c090: 2064 6f65 7320 6e6f 7420 6578 6973 7420   does not exist 
+0006c0a0: 696e 2027 6174 6c61 7344 6573 6372 6970  in 'atlasDescrip
+0006c0b0: 7427 2e22 290a 2020 2020 2020 2020 2020  t'.").          
+0006c0c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0006c0d0: 2020 2020 2020 2020 7768 6963 6869 6e64          whichind
+0006c0e0: 6578 203d 2061 746c 6173 4465 7363 7269  ex = atlasDescri
+0006c0f0: 7074 2e69 6e64 6578 5b61 746c 6173 4465  pt.index[atlasDe
+0006c100: 7363 7269 7074 5b27 4465 7363 7269 7074  script['Descript
+0006c110: 696f 6e27 5d2e 7374 722e 636f 6e74 6169  ion'].str.contai
+0006c120: 6e73 286f 676c 6162 656c 6e61 6d65 295d  ns(oglabelname)]
+0006c130: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0006c140: 2074 7970 6528 7768 6963 6869 6e64 6578   type(whichindex
+0006c150: 2920 6973 206e 702e 696e 7436 343a 0a20  ) is np.int64:. 
+0006c160: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0006c170: 6162 656c 6e75 6d73 203d 2061 746c 6173  abelnums = atlas
+0006c180: 4465 7363 7269 7074 2e6c 6f63 5b77 6869  Descript.loc[whi
+0006c190: 6368 696e 6465 782c 2027 4c61 6265 6c27  chindex, 'Label'
+0006c1a0: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
+0006c1b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0006c1c0: 2020 2020 6c61 6265 6c6e 756d 7320 3d20      labelnums = 
+0006c1d0: 6c69 7374 2861 746c 6173 4465 7363 7269  list(atlasDescri
+0006c1e0: 7074 2e6c 6f63 5b77 6869 6368 696e 6465  pt.loc[whichinde
+0006c1f0: 782c 2027 4c61 6265 6c27 5d29 0a0a 2020  x, 'Label'])..  
+0006c200: 2020 2020 2020 2020 2020 6966 206d 7965            if mye
+0006c210: 7874 203d 3d20 2779 656f 273a 0a20 2020  xt == 'yeo':.   
+0006c220: 2020 2020 2020 2020 2020 2020 2070 6172               par
+0006c230: 7473 203d 2072 652e 6669 6e64 616c 6c28  ts = re.findall(
+0006c240: 7227 5c44 2b27 2c20 6f67 6c61 6265 6c6e  r'\D+', oglabeln
+0006c250: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+0006c260: 2020 2020 206f 676c 6162 656c 6e61 6d65       oglabelname
+0006c270: 203d 205b 7061 7274 2e72 6570 6c61 6365   = [part.replace
+0006c280: 2827 5f27 2c20 2727 2920 666f 7220 7061  ('_', '') for pa
+0006c290: 7274 2069 6e20 7061 7274 7320 6966 2070  rt in parts if p
+0006c2a0: 6172 742e 7265 706c 6163 6528 275f 272c  art.replace('_',
+0006c2b0: 2027 2729 5d0a 2020 2020 2020 2020 2020   '')].          
+0006c2c0: 2020 2020 2020 6669 6c74 6572 6564 5f64        filtered_d
+0006c2d0: 6620 3d20 6174 6c61 7344 6573 6372 6970  f = atlasDescrip
+0006c2e0: 745b 6174 6c61 7344 6573 6372 6970 745b  t[atlasDescript[
+0006c2f0: 2744 6573 6372 6970 7469 6f6e 275d 2e69  'Description'].i
+0006c300: 7369 6e28 6f67 6c61 6265 6c6e 616d 6529  sin(oglabelname)
+0006c310: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0006c320: 2020 6c61 6265 6c6e 756d 7320 3d20 6669    labelnums = fi
+0006c330: 6c74 6572 6564 5f64 665b 274c 6162 656c  ltered_df['Label
+0006c340: 275d 2e74 6f6c 6973 7428 290a 0a20 2020  '].tolist()..   
+0006c350: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0006c360: 6973 696e 7374 616e 6365 286c 6162 656c  isinstance(label
+0006c370: 6e75 6d73 2c20 6c69 7374 293a 0a20 2020  nums, list):.   
+0006c380: 2020 2020 2020 2020 2020 2020 206c 6162               lab
+0006c390: 656c 6e75 6d73 3d5b 6c61 6265 6c6e 756d  elnums=[labelnum
+0006c3a0: 735d 0a20 2020 2020 2020 2020 2020 2061  s].            a
+0006c3b0: 6464 656d 6973 7a65 726f 203d 2061 6e74  ddemiszero = ant
+0006c3c0: 732e 7468 7265 7368 6f6c 645f 696d 6167  s.threshold_imag
+0006c3d0: 6528 6164 6465 6d2c 2030 2c20 3029 0a20  e(addem, 0, 0). 
+0006c3e0: 2020 2020 2020 2020 2020 2074 656d 7020             temp 
+0006c3f0: 3d20 616e 7473 2e69 6d61 6765 5f72 6561  = ants.image_rea
+0006c400: 6428 6c6f 6366 696c 656e 616d 6529 0a20  d(locfilename). 
+0006c410: 2020 2020 2020 2020 2020 2074 656d 7020             temp 
+0006c420: 3d20 616e 7473 2e6d 6173 6b5f 696d 6167  = ants.mask_imag
+0006c430: 6528 7465 6d70 2c20 7465 6d70 2c20 6c65  e(temp, temp, le
+0006c440: 7665 6c3d 6c61 6265 6c6e 756d 732c 2062  vel=labelnums, b
+0006c450: 696e 6172 697a 653d 5472 7565 290a 2020  inarize=True).  
+0006c460: 2020 2020 2020 2020 2020 6966 2076 6572            if ver
+0006c470: 626f 7365 3a0a 2020 2020 2020 2020 2020  bose:.          
+0006c480: 2020 2020 2020 7072 696e 7428 2244 4542        print("DEB
+0006c490: 5547 2229 0a20 2020 2020 2020 2020 2020  UG").           
+0006c4a0: 2020 2020 2070 7269 6e74 2820 2074 656d       print(  tem
+0006c4b0: 702e 7375 6d28 2920 2920 0a20 2020 2020  p.sum() ) .     
+0006c4c0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0006c4d0: 2820 6c61 6265 6c6e 756d 7320 290a 2020  ( labelnums ).  
+0006c4e0: 2020 2020 2020 2020 2020 7465 6d70 5b74            temp[t
+0006c4f0: 656d 7020 3d3d 2031 5d20 3d20 2876 616c  emp == 1] = (val
+0006c500: 7332 7669 7a29 0a20 2020 2020 2020 2020  s2viz).         
+0006c510: 2020 2074 656d 705b 6164 6465 6d69 737a     temp[addemisz
+0006c520: 6572 6f20 3d3d 2030 5d20 3d20 300a 2020  ero == 0] = 0.  
+0006c530: 2020 2020 2020 2020 2020 6164 6465 6d20            addem 
+0006c540: 3d20 6164 6465 6d20 2b20 7465 6d70 0a0a  = addem + temp..
+0006c550: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+0006c560: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0006c570: 7072 696e 7428 2744 6f6e 6520 4164 6469  print('Done Addi
+0006c580: 6e67 2729 0a20 2020 2020 2020 2066 6f72  ng').        for
+0006c590: 2061 7878 2069 6e20 6178 6573 3a0a 2020   axx in axes:.  
+0006c5a0: 2020 2020 2020 2020 2020 6669 6766 6e3d            figfn=
+0006c5b0: 6f75 7470 7574 5f70 7265 6669 782b 6622  output_prefix+f"
+0006c5c0: 6669 677b 636f 6c32 7669 7a7d 6178 7b61  fig{col2viz}ax{a
+0006c5d0: 7878 7d5f 7079 2e6a 7067 220a 2020 2020  xx}_py.jpg".    
+0006c5e0: 2020 2020 2020 2020 6966 2063 726f 7020          if crop 
+0006c5f0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+0006c600: 2020 2020 2063 6d61 736b 203d 2061 6e74       cmask = ant
+0006c610: 732e 7468 7265 7368 6f6c 645f 696d 6167  s.threshold_imag
+0006c620: 6528 2061 6464 656d 2c31 652d 352c 2031  e( addem,1e-5, 1
+0006c630: 6539 2029 2e69 4d61 7468 2822 4d44 222c  e9 ).iMath("MD",
+0006c640: 6372 6f70 2920 2b20 616e 7473 2e74 6872  crop) + ants.thr
+0006c650: 6573 686f 6c64 5f69 6d61 6765 2820 6164  eshold_image( ad
+0006c660: 6465 6d2c 2d31 6539 2c20 2d31 652d 3520  dem,-1e9, -1e-5 
+0006c670: 292e 694d 6174 6828 224d 4422 2c63 726f  ).iMath("MD",cro
+0006c680: 7029 0a20 2020 2020 2020 2020 2020 2020  p).             
+0006c690: 2020 2061 6464 656d 4320 3d20 616e 7473     addemC = ants
+0006c6a0: 2e63 726f 705f 696d 6167 6528 2061 6464  .crop_image( add
+0006c6b0: 656d 2c20 636d 6173 6b20 290a 2020 2020  em, cmask ).    
+0006c6c0: 2020 2020 2020 2020 2020 2020 6564 6765              edge
+0006c6d0: 696d 6743 203d 2061 6e74 732e 6372 6f70  imgC = ants.crop
+0006c6e0: 5f69 6d61 6765 2820 6564 6765 696d 672c  _image( edgeimg,
+0006c6f0: 2063 6d61 736b 2029 0a20 2020 2020 2020   cmask ).       
+0006c700: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0006c710: 2020 2020 2020 2020 2020 2061 6464 656d             addem
+0006c720: 4320 3d20 6164 6465 6d0a 2020 2020 2020  C = addem.      
+0006c730: 2020 2020 2020 2020 2020 6564 6765 696d            edgeim
+0006c740: 6743 203d 2065 6467 6569 6d67 0a20 2020  gC = edgeimg.   
+0006c750: 2020 2020 2020 2020 2069 6620 6669 7865           if fixe
+0006c760: 645f 6f76 6572 6c61 795f 7261 6e67 6520  d_overlay_range 
+0006c770: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0006c780: 2020 2020 2020 2020 2020 2020 2061 6464               add
+0006c790: 656d 435b 303a 332c 303a 332c 303a 335d  emC[0:3,0:3,0:3]
+0006c7a0: 3d66 6978 6564 5f6f 7665 726c 6179 5f72  =fixed_overlay_r
+0006c7b0: 616e 6765 5b30 5d0a 2020 2020 2020 2020  ange[0].        
+0006c7c0: 2020 2020 2020 2020 6164 6465 6d43 5b34          addemC[4
+0006c7d0: 3a37 2c34 3a37 2c34 3a37 5d3d 6669 7865  :7,4:7,4:7]=fixe
+0006c7e0: 645f 6f76 6572 6c61 795f 7261 6e67 655b  d_overlay_range[
+0006c7f0: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
+0006c800: 2020 2061 6464 656d 435b 2061 6464 656d     addemC[ addem
+0006c810: 4320 3c3d 2066 6978 6564 5f6f 7665 726c  C <= fixed_overl
+0006c820: 6179 5f72 616e 6765 5b30 5d20 5d20 3d20  ay_range[0] ] = 
+0006c830: 3020 2320 6669 7865 645f 6f76 6572 6c61  0 # fixed_overla
+0006c840: 795f 7261 6e67 655b 305d 0a20 2020 2020  y_range[0].     
+0006c850: 2020 2020 2020 2020 2020 2061 6464 656d             addem
+0006c860: 435b 2061 6464 656d 4320 3e3d 2066 6978  C[ addemC >= fix
+0006c870: 6564 5f6f 7665 726c 6179 5f72 616e 6765  ed_overlay_range
+0006c880: 5b31 5d20 5d20 3d20 6669 7865 645f 6f76  [1] ] = fixed_ov
+0006c890: 6572 6c61 795f 7261 6e67 655b 315d 0a20  erlay_range[1]. 
+0006c8a0: 2020 2020 2020 2020 2020 2061 6e74 732e             ants.
+0006c8b0: 706c 6f74 2865 6467 6569 6d67 432c 2061  plot(edgeimgC, a
+0006c8c0: 6464 656d 432c 2061 7869 733d 6178 782c  ddemC, axis=axx,
+0006c8d0: 206e 736c 6963 6573 3d6e 736c 6963 6573   nslices=nslices
+0006c8e0: 2c20 6e63 6f6c 3d6e 636f 6c2c 2020 2020  , ncol=ncol,    
+0006c8f0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+0006c900: 2020 2020 6f76 6572 6c61 795f 636d 6170      overlay_cmap
+0006c910: 3d6f 7665 726c 6179 5f63 6d61 702c 2072  =overlay_cmap, r
+0006c920: 6573 616d 706c 653d 4661 6c73 652c 206f  esample=False, o
+0006c930: 7665 726c 6179 5f61 6c70 6861 3d31 2e30  verlay_alpha=1.0
+0006c940: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006c950: 2020 6669 6c65 6e61 6d65 3d66 6967 666e    filename=figfn
+0006c960: 2c20 6362 6172 3d61 7878 3d3d 6178 6573  , cbar=axx==axes
+0006c970: 5b30 5d2c 2063 726f 703d 5472 7565 2c20  [0], crop=True, 
+0006c980: 626c 6163 6b5f 6267 3d62 6c61 636b 5f62  black_bg=black_b
+0006c990: 6720 290a 2020 2020 2020 2020 6966 2076  g ).        if v
+0006c9a0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+0006c9b0: 2020 2020 7072 696e 7428 6622 7b63 6f6c      print(f"{col
+0006c9c0: 3276 697a 7d20 646f 6e65 2229 0a20 2020  2viz} done").   
+0006c9d0: 2069 6620 7665 7262 6f73 653a 0a20 2020   if verbose:.   
+0006c9e0: 2020 2020 2070 7269 6e74 2822 444f 4e45       print("DONE
+0006c9f0: 2062 7261 696e 206d 6170 2066 6967 7572   brain map figur
+0006ca00: 6573 2229 0a20 2020 2072 6574 7572 6e20  es").    return 
+0006ca10: 6164 6465 6d0a 0a64 6566 2066 696c 7465  addem..def filte
+0006ca20: 725f 6466 2869 6e64 662c 206d 7970 7265  r_df(indf, mypre
+0006ca30: 6669 7829 3a0a 2020 2020 2222 220a 2020  fix):.    """.  
+0006ca40: 2020 5072 6f63 6573 7320 616e 6420 6669    Process and fi
+0006ca50: 6c74 6572 2061 2070 616e 6461 7320 4461  lter a pandas Da
+0006ca60: 7461 4672 616d 652c 2072 656d 6f76 696e  taFrame, removin
+0006ca70: 6720 6365 7274 6169 6e20 636f 6c75 6d6e  g certain column
+0006ca80: 732c 200a 2020 2020 6669 6c74 6572 696e  s, .    filterin
+0006ca90: 6720 6261 7365 6420 6f6e 2064 6174 6120  g based on data 
+0006caa0: 7479 7065 732c 2063 6f6d 7075 7469 6e67  types, computing
+0006cab0: 2074 6865 206d 6561 6e20 6f66 206e 756d   the mean of num
+0006cac0: 6572 6963 2063 6f6c 756d 6e73 2c20 0a20  eric columns, . 
+0006cad0: 2020 2061 6e64 2061 6464 696e 6720 6120     and adding a 
+0006cae0: 7072 6566 6978 2074 6f20 636f 6c75 6d6e  prefix to column
+0006caf0: 206e 616d 6573 2e0a 0a20 2020 2050 6172   names...    Par
+0006cb00: 616d 6574 6572 733a 0a20 2020 2069 6e64  ameters:.    ind
+0006cb10: 6620 2870 616e 6461 732e 4461 7461 4672  f (pandas.DataFr
+0006cb20: 616d 6529 3a20 5468 6520 696e 7075 7420  ame): The input 
+0006cb30: 4461 7461 4672 616d 6520 746f 2062 6520  DataFrame to be 
+0006cb40: 7072 6f63 6573 7365 642e 0a20 2020 206d  processed..    m
+0006cb50: 7970 7265 6669 7820 2873 7472 293a 2041  yprefix (str): A
+0006cb60: 2073 7472 696e 6720 7072 6566 6978 2074   string prefix t
+0006cb70: 6f20 6265 2061 6464 6564 2074 6f20 7468  o be added to th
+0006cb80: 6520 636f 6c75 6d6e 206e 616d 6573 200a  e column names .
+0006cb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006cba0: 2020 2020 6f66 2074 6865 2070 726f 6365      of the proce
+0006cbb0: 7373 6564 2044 6174 6146 7261 6d65 2e0a  ssed DataFrame..
+0006cbc0: 0a20 2020 2053 7465 7073 3a0a 2020 2020  .    Steps:.    
+0006cbd0: 312e 2052 656d 6f76 6573 2063 6f6c 756d  1. Removes colum
+0006cbe0: 6e73 2077 6974 6820 6e61 6d65 7320 636f  ns with names co
+0006cbf0: 6e74 6169 6e69 6e67 2027 556e 6e61 6d65  ntaining 'Unname
+0006cc00: 6427 2e0a 2020 2020 322e 2049 6620 7468  d'..    2. If th
+0006cc10: 6520 4461 7461 4672 616d 6520 6861 7320  e DataFrame has 
+0006cc20: 6e6f 2072 6f77 732c 2069 7420 7265 7475  no rows, it retu
+0006cc30: 726e 7320 7468 6520 656d 7074 7920 4461  rns the empty Da
+0006cc40: 7461 4672 616d 652e 0a20 2020 2033 2e20  taFrame..    3. 
+0006cc50: 4669 6c74 6572 7320 6f75 7420 636f 6c75  Filters out colu
+0006cc60: 6d6e 7320 6261 7365 6420 6f6e 2074 6865  mns based on the
+0006cc70: 2074 7970 6520 6f66 2074 6865 2066 6972   type of the fir
+0006cc80: 7374 2065 6c65 6d65 6e74 2c20 0a20 2020  st element, .   
+0006cc90: 2020 2020 6b65 6570 696e 6720 7468 6f73      keeping thos
+0006cca0: 6520 7468 6174 2061 7265 206f 6620 7479  e that are of ty
+0006ccb0: 7065 2060 6f62 6a65 6374 602c 2060 696e  pe `object`, `in
+0006ccc0: 7460 2c20 6f72 2060 666c 6f61 7460 2e0a  t`, or `float`..
+0006ccd0: 2020 2020 342e 2052 656d 6f76 6573 2063      4. Removes c
+0006cce0: 6f6c 756d 6e73 2074 6861 7420 6172 6520  olumns that are 
+0006ccf0: 6f66 2060 6f62 6a65 6374 6020 6474 7970  of `object` dtyp
+0006cd00: 652e 0a20 2020 2035 2e20 4361 6c63 756c  e..    5. Calcul
+0006cd10: 6174 6573 2074 6865 206d 6561 6e20 6f66  ates the mean of
+0006cd20: 2074 6865 2072 656d 6169 6e69 6e67 2063   the remaining c
+0006cd30: 6f6c 756d 6e73 2c20 736b 6970 7069 6e67  olumns, skipping
+0006cd40: 204e 614e 2076 616c 7565 732e 0a20 2020   NaN values..   
+0006cd50: 2036 2e20 4164 6473 2074 6865 2073 7065   6. Adds the spe
+0006cd60: 6369 6669 6564 2060 6d79 7072 6566 6978  cified `myprefix
+0006cd70: 6020 746f 2074 6865 2063 6f6c 756d 6e20  ` to the column 
+0006cd80: 6e61 6d65 732e 0a0a 2020 2020 5265 7475  names...    Retu
+0006cd90: 726e 733a 0a20 2020 2070 616e 6461 732e  rns:.    pandas.
+0006cda0: 4461 7461 4672 616d 653a 2041 2074 7261  DataFrame: A tra
+0006cdb0: 6e73 666f 726d 6564 2044 6174 6146 7261  nsformed DataFra
+0006cdc0: 6d65 2077 6974 6820 6120 7369 6e67 6c65  me with a single
+0006cdd0: 2072 6f77 2063 6f6e 7461 696e 696e 6720   row containing 
+0006cde0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006cdf0: 2020 2020 2020 2074 6865 206d 6561 6e20         the mean 
+0006ce00: 7661 6c75 6573 206f 6620 7468 6520 6669  values of the fi
+0006ce10: 6c74 6572 6564 2063 6f6c 756d 6e73 2c20  ltered columns, 
+0006ce20: 616e 6420 7769 7468 200a 2020 2020 2020  and with .      
+0006ce30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ce40: 636f 6c75 6d6e 206e 616d 6573 2070 7265  column names pre
+0006ce50: 6669 7865 6420 6173 2073 7065 6369 6669  fixed as specifi
+0006ce60: 6564 2e0a 2020 2020 2222 220a 2020 2020  ed..    """.    
+0006ce70: 696e 6466 203d 2069 6e64 662e 6c6f 635b  indf = indf.loc[
+0006ce80: 3a2c 207e 696e 6466 2e63 6f6c 756d 6e73  :, ~indf.columns
+0006ce90: 2e73 7472 2e63 6f6e 7461 696e 7328 2755  .str.contains('U
+0006cea0: 6e6e 616d 6564 2a27 2c20 6e61 3d46 616c  nnamed*', na=Fal
+0006ceb0: 7365 2c20 7265 6765 783d 5472 7565 295d  se, regex=True)]
+0006cec0: 0a20 2020 2069 6620 696e 6466 2e73 6861  .    if indf.sha
+0006ced0: 7065 5b30 5d20 3d3d 2030 3a0a 2020 2020  pe[0] == 0:.    
+0006cee0: 2020 2020 7265 7475 726e 2069 6e64 660a      return indf.
+0006cef0: 2020 2020 6e75 6d73 203d 205b 6973 696e      nums = [isin
+0006cf00: 7374 616e 6365 2869 6e64 665b 636f 6c5d  stance(indf[col]
+0006cf10: 2e69 6c6f 635b 305d 2c20 286f 626a 6563  .iloc[0], (objec
+0006cf20: 742c 2069 6e74 2c20 666c 6f61 7429 2920  t, int, float)) 
+0006cf30: 666f 7220 636f 6c20 696e 2069 6e64 662e  for col in indf.
+0006cf40: 636f 6c75 6d6e 735d 0a20 2020 2069 6e64  columns].    ind
+0006cf50: 6620 3d20 696e 6466 2e6c 6f63 5b3a 2c20  f = indf.loc[:, 
+0006cf60: 6e75 6d73 5d0a 2020 2020 696e 6466 203d  nums].    indf =
+0006cf70: 2069 6e64 662e 6c6f 635b 3a2c 2069 6e64   indf.loc[:, ind
+0006cf80: 662e 6474 7970 6573 2021 3d20 276f 626a  f.dtypes != 'obj
+0006cf90: 6563 7427 5d0a 2020 2020 696e 6466 203d  ect'].    indf =
+0006cfa0: 2070 642e 4461 7461 4672 616d 6528 696e   pd.DataFrame(in
+0006cfb0: 6466 2e6d 6561 6e28 6178 6973 3d30 2c20  df.mean(axis=0, 
+0006cfc0: 736b 6970 6e61 3d54 7275 6529 292e 540a  skipna=True)).T.
+0006cfd0: 2020 2020 696e 6466 203d 2069 6e64 662e      indf = indf.
+0006cfe0: 6164 645f 7072 6566 6978 286d 7970 7265  add_prefix(mypre
+0006cff0: 6669 7829 0a20 2020 2072 6574 7572 6e20  fix).    return 
+0006d000: 696e 6466 0a0a 0a64 6566 2061 6767 7265  indf...def aggre
+0006d010: 6761 7465 5f61 6e74 7370 796d 6d5f 7265  gate_antspymm_re
+0006d020: 7375 6c74 7328 696e 7075 745f 6373 762c  sults(input_csv,
+0006d030: 2073 7562 6a65 6374 5f63 6f6c 3d27 7375   subject_col='su
+0006d040: 626a 6563 7449 4427 2c20 6461 7465 5f63  bjectID', date_c
+0006d050: 6f6c 3d27 6461 7465 272c 2069 6d61 6765  ol='date', image
+0006d060: 5f63 6f6c 3d27 696d 6167 6549 4427 2c20  _col='imageID', 
+0006d070: 6461 7465 5f63 6f6c 756d 6e3d 2773 6573  date_column='ses
+0006d080: 2d31 272c 2062 6173 655f 7061 7468 3d22  -1', base_path="
+0006d090: 2e2f 5072 6f63 6573 7365 642f 414e 5473  ./Processed/ANTs
+0006d0a0: 4578 7041 7274 2f22 2c20 6869 6572 7661  ExpArt/", hierva
+0006d0b0: 7269 6162 6c65 3d27 5431 7748 6965 7261  riable='T1wHiera
+0006d0c0: 7263 6869 6361 6c27 2c20 7661 6c69 645f  rchical', valid_
+0006d0d0: 6d6f 6461 6c69 7469 6573 3d4e 6f6e 652c  modalities=None,
+0006d0e0: 2076 6572 626f 7365 3d46 616c 7365 2029   verbose=False )
+0006d0f0: 3a0a 2020 2020 2222 220a 2020 2020 4167  :.    """.    Ag
+0006d100: 6772 6567 6174 6520 414e 5473 5079 4d4d  gregate ANTsPyMM
+0006d110: 2072 6573 756c 7473 2066 726f 6d20 7468   results from th
+0006d120: 6520 7370 6563 6966 6965 6420 4353 5620  e specified CSV 
+0006d130: 6669 6c65 2061 6e64 2073 6176 6520 7468  file and save th
+0006d140: 6520 6167 6772 6567 6174 6564 2072 6573  e aggregated res
+0006d150: 756c 7473 2074 6f20 6120 6e65 7720 4353  ults to a new CS
+0006d160: 5620 6669 6c65 2e0a 0a20 2020 2050 6172  V file...    Par
+0006d170: 616d 6574 6572 733a 0a20 2020 202d 2069  ameters:.    - i
+0006d180: 6e70 7574 5f63 7376 2028 7374 7229 3a20  nput_csv (str): 
+0006d190: 4669 6c65 2070 6174 6820 6f66 2074 6865  File path of the
+0006d1a0: 2069 6e70 7574 2043 5356 2066 696c 6520   input CSV file 
+0006d1b0: 636f 6e74 6169 6e69 6e67 2041 4e54 7350  containing ANTsP
+0006d1c0: 794d 4d20 5143 2072 6573 756c 7473 2061  yMM QC results a
+0006d1d0: 7665 7261 6765 6420 616e 6420 7769 7468  veraged and with
+0006d1e0: 206f 7574 6c69 6572 206d 6561 7375 7265   outlier measure
+0006d1f0: 6d65 6e74 732e 0a20 2020 202d 2073 7562  ments..    - sub
+0006d200: 6a65 6374 5f63 6f6c 2028 7374 7229 3a20  ject_col (str): 
+0006d210: 4e61 6d65 206f 6620 7468 6520 636f 6c75  Name of the colu
+0006d220: 6d6e 2074 6f20 7374 6f72 6520 7375 626a  mn to store subj
+0006d230: 6563 7420 4944 732e 0a20 2020 202d 2064  ect IDs..    - d
+0006d240: 6174 655f 636f 6c20 2873 7472 293a 204e  ate_col (str): N
+0006d250: 616d 6520 6f66 2074 6865 2063 6f6c 756d  ame of the colum
+0006d260: 6e20 746f 2073 746f 7265 2064 6174 6520  n to store date 
+0006d270: 696e 666f 726d 6174 696f 6e2e 0a20 2020  information..   
+0006d280: 202d 2069 6d61 6765 5f63 6f6c 2028 7374   - image_col (st
+0006d290: 7229 3a20 4e61 6d65 206f 6620 7468 6520  r): Name of the 
+0006d2a0: 636f 6c75 6d6e 2074 6f20 7374 6f72 6520  column to store 
+0006d2b0: 696d 6167 6520 4944 732e 0a20 2020 202d  image IDs..    -
+0006d2c0: 2064 6174 655f 636f 6c75 6d6e 2028 7374   date_column (st
+0006d2d0: 7229 3a20 4e61 6d65 206f 6620 7468 6520  r): Name of the 
+0006d2e0: 636f 6c75 6d6e 2072 6570 7265 7365 6e74  column represent
+0006d2f0: 696e 6720 7468 6520 6461 7465 2069 6e66  ing the date inf
+0006d300: 6f72 6d61 7469 6f6e 2e0a 2020 2020 2d20  ormation..    - 
+0006d310: 6261 7365 5f70 6174 6820 2873 7472 293a  base_path (str):
+0006d320: 2042 6173 6520 7061 7468 2066 6f72 2073   Base path for s
+0006d330: 6561 7263 6820 7061 7468 732e 2044 6566  earch paths. Def
+0006d340: 6175 6c74 7320 746f 2022 2e2f 5072 6f63  aults to "./Proc
+0006d350: 6573 7365 642f 414e 5473 4578 7041 7274  essed/ANTsExpArt
+0006d360: 2f22 2e0a 2020 2020 2d20 6869 6572 7661  /"..    - hierva
+0006d370: 7269 6162 6c65 2028 7374 7229 203a 2074  riable (str) : t
+0006d380: 6865 2073 7472 696e 6720 7661 7269 6162  he string variab
+0006d390: 6c65 2064 656e 6f74 696e 6720 7468 6520  le denoting the 
+0006d3a0: 4869 6572 6172 6368 6963 616c 206f 7574  Hierarchical out
+0006d3b0: 7075 740a 2020 2020 2d20 7661 6c69 645f  put.    - valid_
+0006d3c0: 6d6f 6461 6c69 7469 6573 2028 7374 7220  modalities (str 
+0006d3d0: 6172 7261 7929 203a 2069 6465 6e74 6966  array) : identif
+0006d3e0: 6965 7320 666f 7220 6561 6368 206d 6f64  ies for each mod
+0006d3f0: 616c 6974 793b 2069 6620 4e6f 6e65 2077  ality; if None w
+0006d400: 696c 6c20 6265 2072 6570 6c61 6365 6420  ill be replaced 
+0006d410: 6279 2067 6574 5f76 616c 6964 5f6d 6f64  by get_valid_mod
+0006d420: 616c 6974 6965 7328 6c6f 6e67 3d54 7275  alities(long=Tru
+0006d430: 6529 0a20 2020 202d 2076 6572 626f 7365  e).    - verbose
+0006d440: 203a 2062 6f6f 6c65 616e 0a0a 2020 2020   : boolean..    
+0006d450: 4e6f 7465 3a0a 2020 2020 5468 6973 2066  Note:.    This f
+0006d460: 756e 6374 696f 6e20 6973 2074 6573 7465  unction is teste
+0006d470: 6420 756e 6465 7220 6c69 6d69 7465 6420  d under limited 
+0006d480: 6369 7263 756d 7374 616e 6365 732e 2055  circumstances. U
+0006d490: 7365 2077 6974 6820 6361 7574 696f 6e2e  se with caution.
+0006d4a0: 0a0a 2020 2020 4578 616d 706c 6520 7573  ..    Example us
+0006d4b0: 6167 653a 0a20 2020 2061 6767 5f64 6620  age:.    agg_df 
+0006d4c0: 3d20 6167 6772 6567 6174 655f 616e 7473  = aggregate_ants
+0006d4d0: 7079 6d6d 5f72 6573 756c 7473 2822 7163  pymm_results("qc
+0006d4e0: 6466 616f 6c2e 6373 7622 2c20 7375 626a  dfaol.csv", subj
+0006d4f0: 6563 745f 636f 6c3d 2773 7562 6a65 6374  ect_col='subject
+0006d500: 4944 272c 2064 6174 655f 636f 6c3d 2764  ID', date_col='d
+0006d510: 6174 6527 2c20 696d 6167 655f 636f 6c3d  ate', image_col=
+0006d520: 2769 6d61 6765 4944 272c 2064 6174 655f  'imageID', date_
+0006d530: 636f 6c75 6d6e 3d27 7365 732d 3127 2c20  column='ses-1', 
+0006d540: 6261 7365 5f70 6174 683d 222e 2f59 6f75  base_path="./You
+0006d550: 722f 4375 7374 6f6d 2f50 6174 682f 2229  r/Custom/Path/")
+0006d560: 0a0a 2020 2020 4175 7468 6f72 3a0a 2020  ..    Author:.  
+0006d570: 2020 4176 616e 7473 2061 6e64 2043 6861    Avants and Cha
+0006d580: 7447 5054 0a20 2020 2022 2222 0a20 2020  tGPT.    """.   
+0006d590: 2069 6d70 6f72 7420 7061 6e64 6173 2061   import pandas a
+0006d5a0: 7320 7064 0a20 2020 2069 6d70 6f72 7420  s pd.    import 
+0006d5b0: 6e75 6d70 7920 6173 206e 700a 2020 2020  numpy as np.    
+0006d5c0: 6672 6f6d 2067 6c6f 6220 696d 706f 7274  from glob import
+0006d5d0: 2067 6c6f 620a 0a20 2020 2064 6566 206d   glob..    def m
+0006d5e0: 7972 6561 645f 6373 7628 782c 2063 6e6d  yread_csv(x, cnm
+0006d5f0: 7329 3a0a 2020 2020 2020 2020 2222 220a  s):.        """.
+0006d600: 2020 2020 2020 2020 5265 6164 7320 6120          Reads a 
+0006d610: 4353 5620 6669 6c65 2061 6e64 2072 6574  CSV file and ret
+0006d620: 7572 6e73 2061 2044 6174 6146 7261 6d65  urns a DataFrame
+0006d630: 2065 7863 6c75 6469 6e67 2073 7065 6369   excluding speci
+0006d640: 6669 6564 2063 6f6c 756d 6e73 2e0a 0a20  fied columns... 
+0006d650: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
+0006d660: 733a 0a20 2020 2020 2020 202d 2078 2028  s:.        - x (
+0006d670: 7374 7229 3a20 4669 6c65 2070 6174 6820  str): File path 
+0006d680: 6f66 2074 6865 2069 6e70 7574 2043 5356  of the input CSV
+0006d690: 2066 696c 6520 6465 7363 7269 6269 6e67   file describing
+0006d6a0: 2074 6865 2062 6c69 6e64 2051 4320 6f75   the blind QC ou
+0006d6b0: 7470 7574 0a20 2020 2020 2020 202d 2063  tput.        - c
+0006d6c0: 6e6d 7320 286c 6973 7429 3a20 4c69 7374  nms (list): List
+0006d6d0: 206f 6620 636f 6c75 6d6e 206e 616d 6573   of column names
+0006d6e0: 2074 6f20 6578 636c 7564 6520 6672 6f6d   to exclude from
+0006d6f0: 2074 6865 2044 6174 6146 7261 6d65 2e0a   the DataFrame..
+0006d700: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0006d710: 3a0a 2020 2020 2020 2020 7064 2e44 6174  :.        pd.Dat
+0006d720: 6146 7261 6d65 3a20 4461 7461 4672 616d  aFrame: DataFram
+0006d730: 6520 7769 7468 2073 7065 6369 6669 6564  e with specified
+0006d740: 2063 6f6c 756d 6e73 2065 7863 6c75 6465   columns exclude
+0006d750: 642e 0a20 2020 2020 2020 2022 2222 0a20  d..        """. 
+0006d760: 2020 2020 2020 2064 6620 3d20 7064 2e72         df = pd.r
+0006d770: 6561 645f 6373 7628 7829 0a20 2020 2020  ead_csv(x).     
+0006d780: 2020 2072 6574 7572 6e20 6466 2e6c 6f63     return df.loc
+0006d790: 5b3a 2c20 7e64 662e 636f 6c75 6d6e 732e  [:, ~df.columns.
+0006d7a0: 6973 696e 2863 6e6d 7329 5d0a 0a20 2020  isin(cnms)]..   
+0006d7b0: 2069 6d70 6f72 7420 7761 726e 696e 6773   import warnings
+0006d7c0: 0a20 2020 2023 2057 6172 6e69 6e67 206d  .    # Warning m
+0006d7d0: 6573 7361 6765 2066 6f72 2075 6e74 6573  essage for untes
+0006d7e0: 7465 6420 6675 6e63 7469 6f6e 0a20 2020  ted function.   
+0006d7f0: 2077 6172 6e69 6e67 732e 7761 726e 2822   warnings.warn("
+0006d800: 5761 726e 696e 673a 2054 6869 7320 6675  Warning: This fu
+0006d810: 6e63 7469 6f6e 2069 7320 6e6f 7420 7765  nction is not we
+0006d820: 6c6c 2074 6573 7465 642e 2055 7365 2077  ll tested. Use w
+0006d830: 6974 6820 6361 7574 696f 6e2e 2229 0a0a  ith caution.")..
+0006d840: 2020 2020 6966 2076 616c 6964 5f6d 6f64      if valid_mod
+0006d850: 616c 6974 6965 7320 6973 204e 6f6e 653a  alities is None:
+0006d860: 0a20 2020 2020 2020 2076 616c 6964 5f6d  .        valid_m
+0006d870: 6f64 616c 6974 6965 7320 3d20 6765 745f  odalities = get_
+0006d880: 7661 6c69 645f 6d6f 6461 6c69 7469 6573  valid_modalities
+0006d890: 2827 6c6f 6e67 2729 0a0a 2020 2020 2320  ('long')..    # 
+0006d8a0: 5265 6164 2074 6865 2069 6e70 7574 2043  Read the input C
+0006d8b0: 5356 2066 696c 650a 2020 2020 6466 203d  SV file.    df =
+0006d8c0: 2070 642e 7265 6164 5f63 7376 2869 6e70   pd.read_csv(inp
+0006d8d0: 7574 5f63 7376 290a 0a20 2020 2023 2046  ut_csv)..    # F
+0006d8e0: 696c 7465 7220 726f 7773 2077 6865 7265  ilter rows where
+0006d8f0: 206d 6f64 616c 6974 7920 6973 2027 5431   modality is 'T1
+0006d900: 7727 0a20 2020 2064 6620 3d20 6466 5b64  w'.    df = df[d
+0006d910: 665b 276d 6f64 616c 6974 7927 5d20 3d3d  f['modality'] ==
+0006d920: 2027 5431 7727 5d0a 2020 2020 6261 646e   'T1w'].    badn
+0006d930: 616d 6573 203d 2067 6574 5f6e 616d 6573  ames = get_names
+0006d940: 5f66 726f 6d5f 6461 7461 5f66 7261 6d65  _from_data_frame
+0006d950: 2820 5b27 556e 6e61 6d65 6427 5d2c 2064  ( ['Unnamed'], d
+0006d960: 6620 290a 2020 2020 6466 3d64 662e 6472  f ).    df=df.dr
+0006d970: 6f70 2862 6164 6e61 6d65 732c 2061 7869  op(badnames, axi
+0006d980: 733d 3129 0a0a 2020 2020 2320 4164 6420  s=1)..    # Add 
+0006d990: 6e65 7720 636f 6c75 6d6e 7320 666f 7220  new columns for 
+0006d9a0: 7375 626a 6563 7420 4944 2c20 6461 7465  subject ID, date
+0006d9b0: 2c20 616e 6420 696d 6167 6520 4944 0a20  , and image ID. 
+0006d9c0: 2020 2064 665b 7375 626a 6563 745f 636f     df[subject_co
+0006d9d0: 6c5d 203d 206e 702e 6e61 6e0a 2020 2020  l] = np.nan.    
+0006d9e0: 6466 5b64 6174 655f 636f 6c5d 203d 2064  df[date_col] = d
+0006d9f0: 6174 655f 636f 6c75 6d6e 0a20 2020 2064  ate_column.    d
+0006da00: 665b 696d 6167 655f 636f 6c5d 203d 206e  f[image_col] = n
+0006da10: 702e 6e61 6e0a 2020 2020 6466 203d 2064  p.nan.    df = d
+0006da20: 662e 6173 7479 7065 287b 7375 626a 6563  f.astype({subjec
+0006da30: 745f 636f 6c3a 2073 7472 2c20 6461 7465  t_col: str, date
+0006da40: 5f63 6f6c 3a20 7374 722c 2069 6d61 6765  _col: str, image
+0006da50: 5f63 6f6c 3a20 7374 7220 7d29 0a0a 2320  _col: str })..# 
+0006da60: 2020 2069 6620 7665 7262 6f73 653a 0a23     if verbose:.#
+0006da70: 2020 2020 2020 2020 7072 696e 7428 2064          print( d
+0006da80: 662e 7368 6170 6520 290a 2320 2020 2020  f.shape ).#     
+0006da90: 2020 2070 7269 6e74 2820 6466 2e64 7479     print( df.dty
+0006daa0: 7065 7320 290a 0a20 2020 2023 2070 7265  pes )..    # pre
+0006dab0: 6669 6c74 6572 2064 6620 666f 7220 6461  filter df for da
+0006dac0: 7461 2074 6861 7420 6578 6973 7473 0a20  ta that exists. 
+0006dad0: 2020 206b 6565 7020 3d20 6e70 2e74 696c     keep = np.til
+0006dae0: 6528 2046 616c 7365 2c20 6466 2e73 6861  e( False, df.sha
+0006daf0: 7065 5b30 5d20 290a 2020 2020 666f 7220  pe[0] ).    for 
+0006db00: 7820 696e 2072 616e 6765 2864 662e 7368  x in range(df.sh
+0006db10: 6170 655b 305d 293a 0a20 2020 2020 2020  ape[0]):.       
+0006db20: 2074 656d 7020 3d20 6466 5b27 6669 6c65   temp = df['file
+0006db30: 6e61 6d65 275d 2e69 6c6f 635b 785d 2e73  name'].iloc[x].s
+0006db40: 706c 6974 2822 5f22 290a 2020 2020 2020  plit("_").      
+0006db50: 2020 2320 4765 6e65 7261 6c69 7a65 6420    # Generalized 
+0006db60: 7365 6172 6368 2070 6174 6873 0a20 2020  search paths.   
+0006db70: 2020 2020 2070 6174 685f 7465 6d70 6c61       path_templa
+0006db80: 7465 203d 2066 227b 6261 7365 5f70 6174  te = f"{base_pat
+0006db90: 687d 7b74 656d 705b 305d 7d2f 7b64 6174  h}{temp[0]}/{dat
+0006dba0: 655f 636f 6c75 6d6e 7d2f 2a2f 2a2f 2a22  e_column}/*/*/*"
+0006dbb0: 0a20 2020 2020 2020 2068 6965 7266 6e20  .        hierfn 
+0006dbc0: 3d20 736f 7274 6564 2867 6c6f 6228 2070  = sorted(glob( p
+0006dbd0: 6174 685f 7465 6d70 6c61 7465 202b 2022  ath_template + "
+0006dbe0: 2d22 202b 2068 6965 7276 6172 6961 626c  -" + hiervariabl
+0006dbf0: 6520 2b20 222d 2a77 6964 652e 6373 7622  e + "-*wide.csv"
+0006dc00: 2029 2029 0a20 2020 2020 2020 2069 6620   ) ).        if 
+0006dc10: 6c65 6e28 2068 6965 7266 6e20 2920 3e20  len( hierfn ) > 
+0006dc20: 303a 0a20 2020 2020 2020 2020 2020 206b  0:.            k
+0006dc30: 6565 705b 785d 3d54 7275 650a 0a20 2020  eep[x]=True..   
+0006dc40: 200a 2020 2020 6466 3d64 665b 6b65 6570   .    df=df[keep
+0006dc50: 5d0a 2020 2020 0a20 2020 2069 6620 7665  ].    .    if ve
+0006dc60: 7262 6f73 653a 0a20 2020 2020 2020 2070  rbose:.        p
+0006dc70: 7269 6e74 2820 226f 7269 6769 6e61 6c20  rint( "original 
+0006dc80: 696e 7075 7420 6861 6420 7368 6170 6520  input had shape 
+0006dc90: 2220 2b20 7374 7228 2064 662e 7368 6170  " + str( df.shap
+0006dca0: 655b 305d 2029 202b 2022 2028 5431 206f  e[0] ) + " (T1 o
+0006dcb0: 6e6c 7929 2061 6e64 2077 6520 6669 6e64  nly) and we find
+0006dcc0: 2022 202b 2073 7472 2820 286b 6565 7029   " + str( (keep)
+0006dcd0: 2e73 756d 2829 2029 202b 2022 2077 6974  .sum() ) + " wit
+0006dce0: 6820 6869 6572 6172 6368 6963 616c 206f  h hierarchical o
+0006dcf0: 7574 7075 7420 6465 6669 6e65 6420 6279  utput defined by
+0006dd00: 2076 6172 6961 626c 653a 2022 202b 2068   variable: " + h
+0006dd10: 6965 7276 6172 6961 626c 6520 290a 2020  iervariable ).  
+0006dd20: 2020 2020 2020 7072 696e 7428 2064 662e        print( df.
+0006dd30: 7368 6170 6520 290a 0a20 2020 206d 7963  shape )..    myc
+0006dd40: 7420 3d20 300a 2020 2020 666f 7220 7820  t = 0.    for x 
+0006dd50: 696e 2072 616e 6765 2820 6466 2e73 6861  in range( df.sha
+0006dd60: 7065 5b30 5d29 3a0a 2020 2020 2020 2020  pe[0]):.        
+0006dd70: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+0006dd80: 2020 2020 2020 2020 7072 696e 7428 6622          print(f"
+0006dd90: 7b78 7d2e 2e2e 2229 0a20 2020 2020 2020  {x}...").       
+0006dda0: 206c 6f63 696e 6420 3d20 6466 2e69 6e64   locind = df.ind
+0006ddb0: 6578 5b78 5d0a 2020 2020 2020 2020 7465  ex[x].        te
+0006ddc0: 6d70 203d 2064 665b 2766 696c 656e 616d  mp = df['filenam
+0006ddd0: 6527 5d2e 696c 6f63 5b78 5d2e 7370 6c69  e'].iloc[x].spli
+0006dde0: 7428 225f 2229 0a20 2020 2020 2020 2069  t("_").        i
+0006ddf0: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+0006de00: 2020 2020 2020 2070 7269 6e74 2820 7465         print( te
+0006de10: 6d70 2029 0a20 2020 2020 2020 2064 665b  mp ).        df[
+0006de20: 7375 626a 6563 745f 636f 6c5d 2e69 6c6f  subject_col].ilo
+0006de30: 635b 785d 3d74 656d 705b 305d 0a20 2020  c[x]=temp[0].   
+0006de40: 2020 2020 2064 665b 6461 7465 5f63 6f6c       df[date_col
+0006de50: 5d2e 696c 6f63 5b78 5d3d 6461 7465 5f63  ].iloc[x]=date_c
+0006de60: 6f6c 756d 6e0a 2020 2020 2020 2020 6466  olumn.        df
+0006de70: 5b69 6d61 6765 5f63 6f6c 5d2e 696c 6f63  [image_col].iloc
+0006de80: 5b78 5d3d 7465 6d70 5b31 5d0a 0a20 2020  [x]=temp[1]..   
+0006de90: 2020 2020 2023 2047 656e 6572 616c 697a       # Generaliz
+0006dea0: 6564 2073 6561 7263 6820 7061 7468 730a  ed search paths.
+0006deb0: 2020 2020 2020 2020 7061 7468 5f74 656d          path_tem
+0006dec0: 706c 6174 6520 3d20 6622 7b62 6173 655f  plate = f"{base_
+0006ded0: 7061 7468 7d7b 7465 6d70 5b30 5d7d 2f7b  path}{temp[0]}/{
+0006dee0: 6461 7465 5f63 6f6c 756d 6e7d 2f2a 2f2a  date_column}/*/*
+0006def0: 2f2a 220a 2020 2020 2020 2020 6966 2076  /*".        if v
+0006df00: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+0006df10: 2020 2020 7072 696e 7428 7061 7468 5f74      print(path_t
+0006df20: 656d 706c 6174 6529 0a20 2020 2020 2020  emplate).       
+0006df30: 2068 6965 7266 6e20 3d20 736f 7274 6564   hierfn = sorted
+0006df40: 2867 6c6f 6228 2070 6174 685f 7465 6d70  (glob( path_temp
+0006df50: 6c61 7465 202b 2022 2d22 202b 2068 6965  late + "-" + hie
+0006df60: 7276 6172 6961 626c 6520 2b20 222d 2a77  rvariable + "-*w
+0006df70: 6964 652e 6373 7622 2029 2029 0a20 2020  ide.csv" ) ).   
+0006df80: 2020 2020 2069 6620 6c65 6e28 2068 6965       if len( hie
+0006df90: 7266 6e20 2920 3e20 303a 0a20 2020 2020  rfn ) > 0:.     
+0006dfa0: 2020 2020 2020 2068 6466 3d74 3164 663d         hdf=t1df=
+0006dfb0: 6474 6466 3d72 7364 663d 7065 7266 6466  dtdf=rsdf=perfdf
+0006dfc0: 3d6e 6d64 663d 666c 6169 7264 663d 4e6f  =nmdf=flairdf=No
+0006dfd0: 6e65 0a20 2020 2020 2020 2020 2020 2069  ne.            i
+0006dfe0: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+0006dff0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0006e000: 2868 6965 7266 6e29 0a20 2020 2020 2020  (hierfn).       
+0006e010: 2020 2020 2068 6466 203d 2070 642e 7265       hdf = pd.re
+0006e020: 6164 5f63 7376 2868 6965 7266 6e5b 305d  ad_csv(hierfn[0]
+0006e030: 290a 2020 2020 2020 2020 2020 2020 6261  ).            ba
+0006e040: 646e 616d 6573 203d 2067 6574 5f6e 616d  dnames = get_nam
+0006e050: 6573 5f66 726f 6d5f 6461 7461 5f66 7261  es_from_data_fra
+0006e060: 6d65 2820 5b27 556e 6e61 6d65 6427 5d2c  me( ['Unnamed'],
+0006e070: 2068 6466 2029 0a20 2020 2020 2020 2020   hdf ).         
+0006e080: 2020 2068 6466 3d68 6466 2e64 726f 7028     hdf=hdf.drop(
+0006e090: 6261 646e 616d 6573 2c20 6178 6973 3d31  badnames, axis=1
+0006e0a0: 290a 2020 2020 2020 2020 2020 2020 6e75  ).            nu
+0006e0b0: 6d73 203d 205b 6973 696e 7374 616e 6365  ms = [isinstance
+0006e0c0: 2868 6466 5b63 6f6c 5d2e 696c 6f63 5b30  (hdf[col].iloc[0
+0006e0d0: 5d2c 2028 696e 742c 2066 6c6f 6174 2929  ], (int, float))
+0006e0e0: 2066 6f72 2063 6f6c 2069 6e20 6864 662e   for col in hdf.
+0006e0f0: 636f 6c75 6d6e 735d 0a20 2020 2020 2020  columns].       
+0006e100: 2020 2020 2063 6f72 656e 616d 6573 203d       corenames =
+0006e110: 206c 6973 7428 6e70 2e61 7272 6179 2868   list(np.array(h
+0006e120: 6466 2e63 6f6c 756d 6e73 295b 6e75 6d73  df.columns)[nums
+0006e130: 5d29 0a20 2020 2020 2020 2020 2020 2068  ]).            h
+0006e140: 6466 2e6c 6f63 5b3a 2c20 6e75 6d73 5d20  df.loc[:, nums] 
+0006e150: 3d20 6864 662e 6c6f 635b 3a2c 206e 756d  = hdf.loc[:, num
+0006e160: 735d 2e61 6464 5f70 7265 6669 7828 2254  s].add_prefix("T
+0006e170: 3148 6965 725f 2229 0a20 2020 2020 2020  1Hier_").       
+0006e180: 2020 2020 206d 7963 7420 3d20 6d79 6374       myct = myct
+0006e190: 202b 2031 0a20 2020 2020 2020 2020 2020   + 1.           
+0006e1a0: 2064 666c 6973 7420 3d20 5b68 6466 5d0a   dflist = [hdf].
+0006e1b0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0006e1c0: 206d 796d 6f64 2069 6e20 7661 6c69 645f   mymod in valid_
+0006e1d0: 6d6f 6461 6c69 7469 6573 3a0a 2020 2020  modalities:.    
+0006e1e0: 2020 2020 2020 2020 2020 2020 7431 7766              t1wf
+0006e1f0: 6e20 3d20 736f 7274 6564 2867 6c6f 6228  n = sorted(glob(
+0006e200: 2070 6174 685f 7465 6d70 6c61 7465 2b20   path_template+ 
+0006e210: 222d 2220 2b20 6d79 6d6f 6420 2b20 222d  "-" + mymod + "-
+0006e220: 2a77 6964 652e 6373 7622 2029 2029 0a20  *wide.csv" ) ). 
+0006e230: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0006e240: 6620 6c65 6e28 2074 3177 666e 2029 203e  f len( t1wfn ) >
+0006e250: 2030 203a 0a20 2020 2020 2020 2020 2020   0 :.           
+0006e260: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
+0006e270: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+0006e280: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0006e290: 6e74 2874 3177 666e 290a 2020 2020 2020  nt(t1wfn).      
+0006e2a0: 2020 2020 2020 2020 2020 2020 2020 7431                t1
+0006e2b0: 6466 203d 206d 7972 6561 645f 6373 7628  df = myread_csv(
+0006e2c0: 7431 7766 6e5b 305d 2c20 636f 7265 6e61  t1wfn[0], corena
+0006e2d0: 6d65 7329 0a20 2020 2020 2020 2020 2020  mes).           
+0006e2e0: 2020 2020 2020 2020 2074 3164 6620 3d20           t1df = 
+0006e2f0: 6669 6c74 6572 5f64 6628 2074 3164 662c  filter_df( t1df,
+0006e300: 206d 796d 6f64 2b27 5f27 290a 2020 2020   mymod+'_').    
+0006e310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e320: 6466 6c69 7374 203d 2064 666c 6973 7420  dflist = dflist 
+0006e330: 2b20 5b74 3164 665d 0a20 2020 2020 2020  + [t1df].       
+0006e340: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+0006e350: 2020 2020 2020 6864 6620 3d20 7064 2e63        hdf = pd.c
+0006e360: 6f6e 6361 7428 2064 666c 6973 742c 2061  oncat( dflist, a
+0006e370: 7869 733d 312c 2069 676e 6f72 655f 696e  xis=1, ignore_in
+0006e380: 6465 783d 4661 6c73 6520 290a 2020 2020  dex=False ).    
+0006e390: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+0006e3a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0006e3b0: 2020 2020 7072 696e 7428 2064 662e 6c6f      print( df.lo
+0006e3c0: 635b 6c6f 6369 6e64 2c27 6669 6c65 6e61  c[locind,'filena
+0006e3d0: 6d65 275d 2029 0a20 2020 2020 2020 2020  me'] ).         
+0006e3e0: 2020 2069 6620 6d79 6374 203d 3d20 313a     if myct == 1:
+0006e3f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006e400: 2073 7562 6466 203d 2064 662e 696c 6f63   subdf = df.iloc
+0006e410: 5b5b 785d 5d0a 2020 2020 2020 2020 2020  [[x]].          
+0006e420: 2020 2020 2020 6864 662e 696e 6465 7820        hdf.index 
+0006e430: 3d20 7375 6264 662e 696e 6465 782e 636f  = subdf.index.co
+0006e440: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
+0006e450: 2020 2020 2064 6620 3d20 7064 2e63 6f6e       df = pd.con
+0006e460: 6361 7428 205b 6466 2c68 6466 5d2c 2061  cat( [df,hdf], a
+0006e470: 7869 733d 312c 2069 676e 6f72 655f 696e  xis=1, ignore_in
+0006e480: 6465 783d 4661 6c73 6520 290a 2020 2020  dex=False ).    
+0006e490: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0006e4a0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0006e4b0: 6d6d 636f 6c73 203d 206c 6973 7428 7365  mmcols = list(se
+0006e4c0: 7428 6864 662e 636f 6c75 6d6e 7329 2e69  t(hdf.columns).i
+0006e4d0: 6e74 6572 7365 6374 696f 6e28 6466 2e63  ntersection(df.c
+0006e4e0: 6f6c 756d 6e73 2929 0a20 2020 2020 2020  olumns)).       
+0006e4f0: 2020 2020 2020 2020 2064 662e 6c6f 635b           df.loc[
+0006e500: 6c6f 6369 6e64 2c20 636f 6d6d 636f 6c73  locind, commcols
+0006e510: 5d20 3d20 6864 662e 6c6f 635b 302c 2063  ] = hdf.loc[0, c
+0006e520: 6f6d 6d63 6f6c 735d 0a20 2020 2062 6164  ommcols].    bad
+0006e530: 6e61 6d65 7320 3d20 6765 745f 6e61 6d65  names = get_name
+0006e540: 735f 6672 6f6d 5f64 6174 615f 6672 616d  s_from_data_fram
+0006e550: 6528 205b 2755 6e6e 616d 6564 275d 2c20  e( ['Unnamed'], 
+0006e560: 6466 2029 0a20 2020 2064 663d 6466 2e64  df ).    df=df.d
+0006e570: 726f 7028 6261 646e 616d 6573 2c20 6178  rop(badnames, ax
+0006e580: 6973 3d31 290a 2020 2020 7265 7475 726e  is=1).    return
+0006e590: 2820 6466 2029 0a0a 6465 6620 6669 6e64  ( df )..def find
+0006e5a0: 5f6d 6f73 745f 7265 6365 6e74 5f66 696c  _most_recent_fil
+0006e5b0: 6528 6669 6c65 5f6c 6973 7429 3a0a 2020  e(file_list):.  
+0006e5c0: 2020 2222 220a 2020 2020 4669 6e64 7320    """.    Finds 
+0006e5d0: 616e 6420 7265 7475 726e 7320 7468 6520  and returns the 
+0006e5e0: 6d6f 7374 2072 6563 656e 746c 7920 6d6f  most recently mo
+0006e5f0: 6469 6669 6564 2066 696c 6520 6672 6f6d  dified file from
+0006e600: 2061 206c 6973 7420 6f66 2066 696c 6520   a list of file 
+0006e610: 7061 7468 732e 0a20 2020 200a 2020 2020  paths..    .    
+0006e620: 5061 7261 6d65 7465 7273 3a0a 2020 2020  Parameters:.    
+0006e630: 2d20 6669 6c65 5f6c 6973 743a 2041 206c  - file_list: A l
+0006e640: 6973 7420 6f66 2073 7472 696e 6773 2c20  ist of strings, 
+0006e650: 7768 6572 6520 6561 6368 2073 7472 696e  where each strin
+0006e660: 6720 6973 2061 2070 6174 6820 746f 2061  g is a path to a
+0006e670: 2066 696c 652e 0a20 2020 200a 2020 2020   file..    .    
+0006e680: 5265 7475 726e 733a 0a20 2020 202d 2054  Returns:.    - T
+0006e690: 6865 2070 6174 6820 746f 2074 6865 206d  he path to the m
+0006e6a0: 6f73 7420 7265 6365 6e74 6c79 206d 6f64  ost recently mod
+0006e6b0: 6966 6965 6420 6669 6c65 2069 6e20 7468  ified file in th
+0006e6c0: 6520 6c69 7374 2c20 6f72 204e 6f6e 6520  e list, or None 
+0006e6d0: 6966 2074 6865 206c 6973 7420 6973 2065  if the list is e
+0006e6e0: 6d70 7479 206f 7220 636f 6e74 6169 6e73  mpty or contains
+0006e6f0: 206e 6f20 7661 6c69 6420 6669 6c65 732e   no valid files.
+0006e700: 0a20 2020 2022 2222 0a20 2020 2023 2046  .    """.    # F
+0006e710: 696c 7465 7220 6f75 7420 6974 656d 7320  ilter out items 
+0006e720: 7468 6174 2061 7265 206e 6f74 2066 696c  that are not fil
+0006e730: 6573 206f 7220 646f 206e 6f74 2065 7869  es or do not exi
+0006e740: 7374 0a20 2020 2076 616c 6964 5f66 696c  st.    valid_fil
+0006e750: 6573 203d 205b 6620 666f 7220 6620 696e  es = [f for f in
+0006e760: 2066 696c 655f 6c69 7374 2069 6620 6f73   file_list if os
+0006e770: 2e70 6174 682e 6973 6669 6c65 2866 295d  .path.isfile(f)]
+0006e780: 0a20 2020 200a 2020 2020 2320 4368 6563  .    .    # Chec
+0006e790: 6b20 6966 2074 6865 2066 696c 7465 7265  k if the filtere
+0006e7a0: 6420 6c69 7374 2069 7320 6e6f 7420 656d  d list is not em
+0006e7b0: 7074 790a 2020 2020 6966 2076 616c 6964  pty.    if valid
+0006e7c0: 5f66 696c 6573 3a0a 2020 2020 2020 2020  _files:.        
+0006e7d0: 2320 4669 6e64 2074 6865 2066 696c 6520  # Find the file 
+0006e7e0: 7769 7468 2074 6865 206c 6174 6573 7420  with the latest 
+0006e7f0: 6d6f 6469 6669 6361 7469 6f6e 2074 696d  modification tim
+0006e800: 650a 2020 2020 2020 2020 6d6f 7374 5f72  e.        most_r
+0006e810: 6563 656e 745f 6669 6c65 203d 206d 6178  ecent_file = max
+0006e820: 2876 616c 6964 5f66 696c 6573 2c20 6b65  (valid_files, ke
+0006e830: 793d 6f73 2e70 6174 682e 6765 746d 7469  y=os.path.getmti
+0006e840: 6d65 290a 2020 2020 2020 2020 7265 7475  me).        retu
+0006e850: 726e 205b 6d6f 7374 5f72 6563 656e 745f  rn [most_recent_
+0006e860: 6669 6c65 5d0a 2020 2020 656c 7365 3a0a  file].    else:.
+0006e870: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+0006e880: 6f6e 650a 2020 2020 0a64 6566 2061 6767  one.    .def agg
+0006e890: 7265 6761 7465 5f61 6e74 7370 796d 6d5f  regate_antspymm_
+0006e8a0: 7265 7375 6c74 735f 7364 6628 0a20 2020  results_sdf(.   
+0006e8b0: 2073 7475 6479 5f64 662c 200a 2020 2020   study_df, .    
+0006e8c0: 7072 6f6a 6563 745f 636f 6c3d 2770 726f  project_col='pro
+0006e8d0: 6a65 6374 4944 272c 0a20 2020 2073 7562  jectID',.    sub
+0006e8e0: 6a65 6374 5f63 6f6c 3d27 7375 626a 6563  ject_col='subjec
+0006e8f0: 7449 4427 2c20 0a20 2020 2064 6174 655f  tID', .    date_
+0006e900: 636f 6c3d 2764 6174 6527 2c20 0a20 2020  col='date', .   
+0006e910: 2069 6d61 6765 5f63 6f6c 3d27 696d 6167   image_col='imag
+0006e920: 6549 4427 2c20 0a20 2020 2062 6173 655f  eID', .    base_
+0006e930: 7061 7468 3d22 2e2f 222c 200a 2020 2020  path="./", .    
+0006e940: 6869 6572 7661 7269 6162 6c65 3d27 5431  hiervariable='T1
+0006e950: 7748 6965 7261 7263 6869 6361 6c27 2c20  wHierarchical', 
+0006e960: 0a20 2020 2073 706c 6974 7365 703d 272d  .    splitsep='-
+0006e970: 272c 0a20 2020 2069 6473 6570 3d27 2d27  ',.    idsep='-'
+0006e980: 2c0a 2020 2020 7769 6c64 5f63 6172 645f  ,.    wild_card_
+0006e990: 6d6f 6461 6c69 7479 5f69 643d 4661 6c73  modality_id=Fals
+0006e9a0: 652c 0a20 2020 2073 6563 6f6e 645f 7370  e,.    second_sp
+0006e9b0: 6c69 743d 4661 6c73 652c 0a20 2020 2076  lit=False,.    v
+0006e9c0: 6572 626f 7365 3d46 616c 7365 2029 3a0a  erbose=False ):.
+0006e9d0: 2020 2020 2222 220a 2020 2020 4167 6772      """.    Aggr
+0006e9e0: 6567 6174 6520 414e 5473 5079 4d4d 2072  egate ANTsPyMM r
+0006e9f0: 6573 756c 7473 2066 726f 6d20 7468 6520  esults from the 
+0006ea00: 7370 6563 6966 6965 6420 7374 7564 7920  specified study 
+0006ea10: 6461 7461 2066 7261 6d65 2061 6e64 2073  data frame and s
+0006ea20: 746f 7265 2074 6865 2061 6767 7265 6761  tore the aggrega
+0006ea30: 7465 6420 7265 7375 6c74 7320 696e 2061  ted results in a
+0006ea40: 206e 6577 2064 6174 6120 6672 616d 652e   new data frame.
+0006ea50: 2020 5468 6973 2061 7373 756d 6573 2064    This assumes d
+0006ea60: 6174 6120 6973 206f 7267 616e 697a 6564  ata is organized
+0006ea70: 206f 6e20 6469 736b 200a 2020 2020 6173   on disk .    as
+0006ea80: 2066 6f6c 6c6f 7773 3a20 2072 6f6f 7464   follows:  rootd
+0006ea90: 6972 2f70 726f 6a65 6374 4944 2f73 7562  ir/projectID/sub
+0006eaa0: 6a65 6374 4944 2f64 6174 652f 6f75 7470  jectID/date/outp
+0006eab0: 7574 6964 2f69 6d61 6765 6964 2f20 7768  utid/imageid/ wh
+0006eac0: 6572 6520 0a20 2020 206f 7574 7075 7469  ere .    outputi
+0006ead0: 6420 6973 206d 6f64 616c 6974 792d 7370  d is modality-sp
+0006eae0: 6563 6966 6963 2061 6e64 2063 7265 6174  ecific and creat
+0006eaf0: 6564 2062 7920 414e 5473 5079 4d4d 2070  ed by ANTsPyMM p
+0006eb00: 726f 6365 7373 696e 672e 0a0a 2020 2020  rocessing...    
+0006eb10: 5061 7261 6d65 7465 7273 3a0a 2020 2020  Parameters:.    
+0006eb20: 2d20 7374 7564 795f 6466 2028 7061 6e64  - study_df (pand
+0006eb30: 6173 2064 6629 3a20 7061 6e64 6173 2064  as df): pandas d
+0006eb40: 6174 6120 6672 616d 652c 206f 7574 7075  ata frame, outpu
+0006eb50: 7420 6f66 2067 656e 6572 6174 655f 6d6d  t of generate_mm
+0006eb60: 5f64 6174 6166 7261 6d65 2e0a 2020 2020  _dataframe..    
+0006eb70: 2d20 7072 6f6a 6563 745f 636f 6c20 2873  - project_col (s
+0006eb80: 7472 293a 204e 616d 6520 6f66 2074 6865  tr): Name of the
+0006eb90: 2063 6f6c 756d 6e20 7468 6174 2073 746f   column that sto
+0006eba0: 7265 7320 7468 6520 7072 6f6a 6563 7420  res the project 
+0006ebb0: 4944 0a20 2020 202d 2073 7562 6a65 6374  ID.    - subject
+0006ebc0: 5f63 6f6c 2028 7374 7229 3a20 4e61 6d65  _col (str): Name
+0006ebd0: 206f 6620 7468 6520 636f 6c75 6d6e 2074   of the column t
+0006ebe0: 6f20 7374 6f72 6520 7375 626a 6563 7420  o store subject 
+0006ebf0: 4944 732e 0a20 2020 202d 2064 6174 655f  IDs..    - date_
+0006ec00: 636f 6c20 2873 7472 293a 204e 616d 6520  col (str): Name 
+0006ec10: 6f66 2074 6865 2063 6f6c 756d 6e20 746f  of the column to
+0006ec20: 2073 746f 7265 2064 6174 6520 696e 666f   store date info
+0006ec30: 726d 6174 696f 6e2e 0a20 2020 202d 2069  rmation..    - i
+0006ec40: 6d61 6765 5f63 6f6c 2028 7374 7229 3a20  mage_col (str): 
+0006ec50: 4e61 6d65 206f 6620 7468 6520 636f 6c75  Name of the colu
+0006ec60: 6d6e 2074 6f20 7374 6f72 6520 696d 6167  mn to store imag
+0006ec70: 6520 4944 732e 0a20 2020 202d 2062 6173  e IDs..    - bas
+0006ec80: 655f 7061 7468 2028 7374 7229 3a20 4261  e_path (str): Ba
+0006ec90: 7365 2070 6174 6820 666f 7220 7365 6172  se path for sear
+0006eca0: 6368 696e 6720 666f 7220 7072 6f63 6573  ching for proces
+0006ecb0: 7369 6e67 206f 7574 7075 7473 206f 6620  sing outputs of 
+0006ecc0: 414e 5473 5079 4d4d 2e0a 2020 2020 2d20  ANTsPyMM..    - 
+0006ecd0: 6869 6572 7661 7269 6162 6c65 2028 7374  hiervariable (st
+0006ece0: 7229 203a 2074 6865 2073 7472 696e 6720  r) : the string 
+0006ecf0: 7661 7269 6162 6c65 2064 656e 6f74 696e  variable denotin
+0006ed00: 6720 7468 6520 4869 6572 6172 6368 6963  g the Hierarchic
+0006ed10: 616c 206f 7574 7075 740a 2020 2020 2d20  al output.    - 
+0006ed20: 7370 6c69 7473 6570 2028 7374 7229 3a20  splitsep (str): 
+0006ed30: 2074 6865 2073 6570 6172 6174 6f72 2075   the separator u
+0006ed40: 7365 6420 746f 2073 706c 6974 2074 6865  sed to split the
+0006ed50: 2066 696c 656e 616d 650a 2020 2020 2d20   filename.    - 
+0006ed60: 6964 7365 7020 2873 7472 293a 2074 6865  idsep (str): the
+0006ed70: 2073 6570 6172 6174 6f72 2075 7365 6420   separator used 
+0006ed80: 746f 2070 6172 7469 7469 6f6e 2073 7562  to partition sub
+0006ed90: 6a65 6374 6964 2064 6174 6520 616e 6420  jectid date and 
+0006eda0: 696d 6167 6569 6420 0a20 2020 2020 2020  imageid .       
+0006edb0: 2066 6f72 2065 7861 6d70 6c65 2c20 6966   for example, if
+0006edc0: 2069 6473 6570 2069 7320 2d20 7468 656e   idsep is - then
+0006edd0: 2077 6520 6861 7665 2073 7562 6a65 6374   we have subject
+0006ede0: 6964 2d64 6174 652d 696d 6167 6569 640a  id-date-imageid.
+0006edf0: 2020 2020 2d20 7769 6c64 5f63 6172 645f      - wild_card_
+0006ee00: 6d6f 6461 6c69 7479 5f69 6420 2862 6f6f  modality_id (boo
+0006ee10: 6c29 3a20 6b65 6570 2069 6620 4661 6c73  l): keep if Fals
+0006ee20: 6520 666f 7220 7361 6665 7220 6578 6563  e for safer exec
+0006ee30: 7574 696f 6e0a 2020 2020 2d20 7365 636f  ution.    - seco
+0006ee40: 6e64 5f73 706c 6974 2028 626f 6f6c 293a  nd_split (bool):
+0006ee50: 2074 6869 7320 6973 2061 2068 6163 6b20   this is a hack 
+0006ee60: 7468 6174 2077 696c 6c20 7370 6c69 7420  that will split 
+0006ee70: 7468 6520 696d 6167 6549 4420 6279 202e  the imageID by .
+0006ee80: 2061 6e64 206b 6565 7020 7468 6520 6669   and keep the fi
+0006ee90: 7273 7420 7061 7274 206f 6620 7468 6520  rst part of the 
+0006eea0: 7370 6c69 743b 206d 6179 2062 6520 6e65  split; may be ne
+0006eeb0: 6564 6564 2077 6865 6e20 7468 6520 696e  eded when the in
+0006eec0: 7075 7420 6669 6c65 6e61 6d65 7320 636f  put filenames co
+0006eed0: 6e74 6169 6e20 2e0a 2020 2020 2d20 7665  ntain ..    - ve
+0006eee0: 7262 6f73 6520 3a20 626f 6f6c 6561 6e0a  rbose : boolean.
+0006eef0: 0a20 2020 204e 6f74 653a 0a20 2020 2054  .    Note:.    T
+0006ef00: 6869 7320 6675 6e63 7469 6f6e 2069 7320  his function is 
+0006ef10: 7465 7374 6564 2075 6e64 6572 206c 696d  tested under lim
+0006ef20: 6974 6564 2063 6972 6375 6d73 7461 6e63  ited circumstanc
+0006ef30: 6573 2e20 5573 6520 7769 7468 2063 6175  es. Use with cau
+0006ef40: 7469 6f6e 2e0a 2020 2020 4f6e 6520 7061  tion..    One pa
+0006ef50: 7274 6963 756c 6172 2067 6f74 6368 6120  rticular gotcha 
+0006ef60: 6973 2069 6620 7468 6520 696d 6167 6549  is if the imageI
+0006ef70: 4420 6973 2073 746f 7265 6420 6173 2061  D is stored as a
+0006ef80: 206e 756d 6572 6963 2076 616c 7565 2069   numeric value i
+0006ef90: 6e20 7468 6520 6461 7461 6672 616d 6520  n the dataframe 
+0006efa0: 0a20 2020 2062 7574 2069 7320 6d65 616e  .    but is mean
+0006efb0: 7420 746f 2062 6520 6120 7374 7269 6e67  t to be a string
+0006efc0: 2e20 2045 2e67 2e20 2730 3030 2720 2873  .  E.g. '000' (s
+0006efd0: 7472 696e 6729 2077 6f75 6c64 2062 6520  tring) would be 
+0006efe0: 696e 7465 7270 7265 7465 6420 6173 2030  interpreted as 0
+0006eff0: 2069 6e20 7468 6520 0a20 2020 2066 696c   in the .    fil
+0006f000: 6520 6e61 6d65 2067 6c6f 622e 2020 5468  e name glob.  Th
+0006f010: 6973 2077 6f75 6c64 206d 6973 7320 7468  is would miss th
+0006f020: 6520 6578 7461 6e74 2028 6f6e 2064 6973  e extant (on dis
+0006f030: 6b29 2063 7376 2e0a 0a20 2020 2045 7861  k) csv...    Exa
+0006f040: 6d70 6c65 2075 7361 6765 3a0a 2020 2020  mple usage:.    
+0006f050: 6167 675f 6466 203d 2061 6767 7265 6761  agg_df = aggrega
+0006f060: 7465 5f61 6e74 7370 796d 6d5f 7265 7375  te_antspymm_resu
+0006f070: 6c74 735f 7364 6628 2073 7475 6479 6466  lts_sdf( studydf
+0006f080: 2c20 7375 626a 6563 745f 636f 6c3d 2773  , subject_col='s
+0006f090: 7562 6a65 6374 4944 272c 2064 6174 655f  ubjectID', date_
+0006f0a0: 636f 6c3d 2764 6174 6527 2c20 696d 6167  col='date', imag
+0006f0b0: 655f 636f 6c3d 2769 6d61 6765 4944 272c  e_col='imageID',
+0006f0c0: 2062 6173 655f 7061 7468 3d22 2e2f 596f   base_path="./Yo
+0006f0d0: 7572 2f43 7573 746f 6d2f 5061 7468 2f22  ur/Custom/Path/"
+0006f0e0: 290a 0a20 2020 2041 7574 686f 723a 0a20  )..    Author:. 
+0006f0f0: 2020 2041 7661 6e74 7320 616e 6420 4368     Avants and Ch
+0006f100: 6174 4750 540a 2020 2020 2222 220a 2020  atGPT.    """.  
+0006f110: 2020 696d 706f 7274 2070 616e 6461 7320    import pandas 
+0006f120: 6173 2070 640a 2020 2020 696d 706f 7274  as pd.    import
+0006f130: 206e 756d 7079 2061 7320 6e70 0a20 2020   numpy as np.   
+0006f140: 2066 726f 6d20 676c 6f62 2069 6d70 6f72   from glob impor
+0006f150: 7420 676c 6f62 0a0a 2020 2020 6465 6620  t glob..    def 
+0006f160: 7072 6f67 7265 7373 5f72 6570 6f72 7465  progress_reporte
+0006f170: 7228 6375 7272 656e 745f 7374 6570 2c20  r(current_step, 
+0006f180: 746f 7461 6c5f 7374 6570 732c 2077 6964  total_steps, wid
+0006f190: 7468 3d35 3029 3a0a 2020 2020 2020 2020  th=50):.        
+0006f1a0: 2320 4361 6c63 756c 6174 6520 7468 6520  # Calculate the 
+0006f1b0: 7072 6f70 6f72 7469 6f6e 206f 6620 7072  proportion of pr
+0006f1c0: 6f67 7265 7373 0a20 2020 2020 2020 2070  ogress.        p
+0006f1d0: 726f 6772 6573 7320 3d20 6375 7272 656e  rogress = curren
+0006f1e0: 745f 7374 6570 202f 2074 6f74 616c 5f73  t_step / total_s
+0006f1f0: 7465 7073 0a20 2020 2020 2020 2023 2043  teps.        # C
+0006f200: 616c 6375 6c61 7465 2074 6865 206e 756d  alculate the num
+0006f210: 6265 7220 6f66 2027 6669 6c6c 6564 2720  ber of 'filled' 
+0006f220: 6368 6172 6163 7465 7273 2069 6e20 7468  characters in th
+0006f230: 6520 7072 6f67 7265 7373 2062 6172 0a20  e progress bar. 
+0006f240: 2020 2020 2020 2066 696c 6c65 645f 6c65         filled_le
+0006f250: 6e67 7468 203d 2069 6e74 2877 6964 7468  ngth = int(width
+0006f260: 202a 2070 726f 6772 6573 7329 0a20 2020   * progress).   
+0006f270: 2020 2020 2023 2043 7265 6174 6520 7468       # Create th
+0006f280: 6520 7072 6f67 7265 7373 2062 6172 2073  e progress bar s
+0006f290: 7472 696e 670a 2020 2020 2020 2020 6261  tring.        ba
+0006f2a0: 7220 3d20 27e2 9688 2720 2a20 6669 6c6c  r = '...' * fill
+0006f2b0: 6564 5f6c 656e 6774 6820 2b20 272d 2720  ed_length + '-' 
+0006f2c0: 2a20 2877 6964 7468 202d 2066 696c 6c65  * (width - fille
+0006f2d0: 645f 6c65 6e67 7468 290a 2020 2020 2020  d_length).      
+0006f2e0: 2020 2320 5072 696e 7420 7468 6520 7072    # Print the pr
+0006f2f0: 6f67 7265 7373 2062 6172 2077 6974 6820  ogress bar with 
+0006f300: 7065 7263 656e 7461 6765 0a20 2020 2020  percentage.     
+0006f310: 2020 2070 7269 6e74 2866 275c 7250 726f     print(f'\rPro
+0006f320: 6772 6573 733a 207c 7b62 6172 7d7c 207b  gress: |{bar}| {
+0006f330: 696e 7428 3130 3020 2a20 7072 6f67 7265  int(100 * progre
+0006f340: 7373 297d 2527 2c20 656e 643d 275c 7227  ss)}%', end='\r'
+0006f350: 290a 2020 2020 2020 2020 2320 5072 696e  ).        # Prin
+0006f360: 7420 6120 6e65 7720 6c69 6e65 2077 6865  t a new line whe
+0006f370: 6e20 7468 6520 7072 6f67 7265 7373 2069  n the progress i
+0006f380: 7320 636f 6d70 6c65 7465 0a20 2020 2020  s complete.     
+0006f390: 2020 2069 6620 6375 7272 656e 745f 7374     if current_st
+0006f3a0: 6570 203d 3d20 746f 7461 6c5f 7374 6570  ep == total_step
+0006f3b0: 733a 0a20 2020 2020 2020 2020 2020 2070  s:.            p
+0006f3c0: 7269 6e74 2829 0a0a 2020 2020 6465 6620  rint()..    def 
+0006f3d0: 6d79 7265 6164 5f63 7376 2878 2c20 636e  myread_csv(x, cn
+0006f3e0: 6d73 293a 0a20 2020 2020 2020 2022 2222  ms):.        """
+0006f3f0: 0a20 2020 2020 2020 2052 6561 6473 2061  .        Reads a
+0006f400: 2043 5356 2066 696c 6520 616e 6420 7265   CSV file and re
+0006f410: 7475 726e 7320 6120 4461 7461 4672 616d  turns a DataFram
+0006f420: 6520 6578 636c 7564 696e 6720 7370 6563  e excluding spec
+0006f430: 6966 6965 6420 636f 6c75 6d6e 732e 0a0a  ified columns...
+0006f440: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
+0006f450: 7273 3a0a 2020 2020 2020 2020 2d20 7820  rs:.        - x 
+0006f460: 2873 7472 293a 2046 696c 6520 7061 7468  (str): File path
+0006f470: 206f 6620 7468 6520 696e 7075 7420 4353   of the input CS
+0006f480: 5620 6669 6c65 2064 6573 6372 6962 696e  V file describin
+0006f490: 6720 7468 6520 626c 696e 6420 5143 206f  g the blind QC o
+0006f4a0: 7574 7075 740a 2020 2020 2020 2020 2d20  utput.        - 
+0006f4b0: 636e 6d73 2028 6c69 7374 293a 204c 6973  cnms (list): Lis
+0006f4c0: 7420 6f66 2063 6f6c 756d 6e20 6e61 6d65  t of column name
+0006f4d0: 7320 746f 2065 7863 6c75 6465 2066 726f  s to exclude fro
+0006f4e0: 6d20 7468 6520 4461 7461 4672 616d 652e  m the DataFrame.
+0006f4f0: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+0006f500: 733a 0a20 2020 2020 2020 2070 642e 4461  s:.        pd.Da
+0006f510: 7461 4672 616d 653a 2044 6174 6146 7261  taFrame: DataFra
+0006f520: 6d65 2077 6974 6820 7370 6563 6966 6965  me with specifie
+0006f530: 6420 636f 6c75 6d6e 7320 6578 636c 7564  d columns exclud
+0006f540: 6564 2e0a 2020 2020 2020 2020 2222 220a  ed..        """.
+0006f550: 2020 2020 2020 2020 6466 203d 2070 642e          df = pd.
+0006f560: 7265 6164 5f63 7376 2878 290a 2020 2020  read_csv(x).    
+0006f570: 2020 2020 7265 7475 726e 2064 662e 6c6f      return df.lo
+0006f580: 635b 3a2c 207e 6466 2e63 6f6c 756d 6e73  c[:, ~df.columns
+0006f590: 2e69 7369 6e28 636e 6d73 295d 0a0a 2020  .isin(cnms)]..  
+0006f5a0: 2020 696d 706f 7274 2077 6172 6e69 6e67    import warning
+0006f5b0: 730a 2020 2020 2320 5761 726e 696e 6720  s.    # Warning 
+0006f5c0: 6d65 7373 6167 6520 666f 7220 756e 7465  message for unte
+0006f5d0: 7374 6564 2066 756e 6374 696f 6e0a 2020  sted function.  
+0006f5e0: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
+0006f5f0: 2257 6172 6e69 6e67 3a20 5468 6973 2066  "Warning: This f
+0006f600: 756e 6374 696f 6e20 6973 206e 6f74 2077  unction is not w
+0006f610: 656c 6c20 7465 7374 6564 2e20 5573 6520  ell tested. Use 
+0006f620: 7769 7468 2063 6175 7469 6f6e 2e22 290a  with caution.").
+0006f630: 0a20 2020 2076 6d6f 6464 6963 7420 3d20  .    vmoddict = 
+0006f640: 7b7d 0a20 2020 2023 2041 6464 206b 6579  {}.    # Add key
+0006f650: 2d76 616c 7565 2070 6169 7273 0a20 2020  -value pairs.   
+0006f660: 2076 6d6f 6464 6963 745b 2769 6d61 6765   vmoddict['image
+0006f670: 4944 275d 203d 2027 5431 7727 0a20 2020  ID'] = 'T1w'.   
+0006f680: 2076 6d6f 6464 6963 745b 2766 6c61 6972   vmoddict['flair
+0006f690: 6964 275d 203d 2027 5432 466c 6169 7227  id'] = 'T2Flair'
+0006f6a0: 0a20 2020 2076 6d6f 6464 6963 745b 2770  .    vmoddict['p
+0006f6b0: 6572 6669 6427 5d20 3d20 2770 6572 6627  erfid'] = 'perf'
+0006f6c0: 0a20 2020 2076 6d6f 6464 6963 745b 2772  .    vmoddict['r
+0006f6d0: 7366 6964 3127 5d20 3d20 2772 7366 4d52  sfid1'] = 'rsfMR
+0006f6e0: 4927 0a23 2020 2020 766d 6f64 6469 6374  I'.#    vmoddict
+0006f6f0: 5b27 7273 6669 6432 275d 203d 2027 7273  ['rsfid2'] = 'rs
+0006f700: 664d 5249 270a 2020 2020 766d 6f64 6469  fMRI'.    vmoddi
+0006f710: 6374 5b27 6474 6964 3127 5d20 3d20 2744  ct['dtid1'] = 'D
+0006f720: 5449 270a 2320 2020 2076 6d6f 6464 6963  TI'.#    vmoddic
+0006f730: 745b 2764 7469 6432 275d 203d 2027 4454  t['dtid2'] = 'DT
+0006f740: 4927 0a20 2020 2076 6d6f 6464 6963 745b  I'.    vmoddict[
+0006f750: 276e 6d69 6431 275d 203d 2027 4e4d 3244  'nmid1'] = 'NM2D
+0006f760: 4d54 270a 2320 2020 2076 6d6f 6464 6963  MT'.#    vmoddic
+0006f770: 745b 276e 6d69 6432 275d 203d 2027 4e4d  t['nmid2'] = 'NM
+0006f780: 3244 4d54 270a 0a20 2020 2023 2046 696c  2DMT'..    # Fil
+0006f790: 7465 7220 726f 7773 2077 6865 7265 206d  ter rows where m
+0006f7a0: 6f64 616c 6974 7920 6973 2027 5431 7727  odality is 'T1w'
+0006f7b0: 0a20 2020 2064 6620 3d20 7374 7564 795f  .    df = study_
+0006f7c0: 6466 5b20 7374 7564 795f 6466 5b27 6d6f  df[ study_df['mo
+0006f7d0: 6461 6c69 7479 275d 203d 3d20 2754 3177  dality'] == 'T1w
+0006f7e0: 275d 0a20 2020 2062 6164 6e61 6d65 7320  '].    badnames 
+0006f7f0: 3d20 6765 745f 6e61 6d65 735f 6672 6f6d  = get_names_from
+0006f800: 5f64 6174 615f 6672 616d 6528 205b 2755  _data_frame( ['U
+0006f810: 6e6e 616d 6564 275d 2c20 6466 2029 0a20  nnamed'], df ). 
+0006f820: 2020 2064 663d 6466 2e64 726f 7028 6261     df=df.drop(ba
+0006f830: 646e 616d 6573 2c20 6178 6973 3d31 290a  dnames, axis=1).
+0006f840: 2020 2020 2320 7072 6566 696c 7465 7220      # prefilter 
+0006f850: 6466 2066 6f72 2064 6174 6120 7468 6174  df for data that
+0006f860: 2065 7869 7374 730a 2020 2020 6b65 6570   exists.    keep
+0006f870: 203d 206e 702e 7469 6c65 2820 4661 6c73   = np.tile( Fals
+0006f880: 652c 2064 662e 7368 6170 655b 305d 2029  e, df.shape[0] )
+0006f890: 0a20 2020 2066 6f72 2078 2069 6e20 7261  .    for x in ra
+0006f8a0: 6e67 6528 6466 2e73 6861 7065 5b30 5d29  nge(df.shape[0])
+0006f8b0: 3a0a 2020 2020 2020 2020 6d79 666e 203d  :.        myfn =
+0006f8c0: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
+0006f8d0: 6528 2064 665b 2766 696c 656e 616d 6527  e( df['filename'
+0006f8e0: 5d2e 696c 6f63 5b78 5d20 290a 2020 2020  ].iloc[x] ).    
+0006f8f0: 2020 2020 7465 6d70 203d 206d 7966 6e2e      temp = myfn.
+0006f900: 7370 6c69 7428 2073 706c 6974 7365 7020  split( splitsep 
+0006f910: 290a 2020 2020 2020 2020 2320 4765 6e65  ).        # Gene
+0006f920: 7261 6c69 7a65 6420 7365 6172 6368 2070  ralized search p
+0006f930: 6174 6873 0a20 2020 2020 2020 2073 6964  aths.        sid
+0006f940: 3020 3d20 7374 7228 2074 656d 705b 315d  0 = str( temp[1]
+0006f950: 2029 0a20 2020 2020 2020 2073 6964 203d   ).        sid =
+0006f960: 2073 7472 2820 6466 5b73 7562 6a65 6374   str( df[subject
+0006f970: 5f63 6f6c 5d2e 696c 6f63 5b78 5d20 290a  _col].iloc[x] ).
+0006f980: 2020 2020 2020 2020 6966 2073 6964 3020          if sid0 
+0006f990: 213d 2073 6964 3a0a 2020 2020 2020 2020  != sid:.        
+0006f9a0: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
+0006f9b0: 6e28 224f 5554 4552 3a20 7468 6520 6964  n("OUTER: the id
+0006f9c0: 2064 6572 6976 6564 2066 726f 6d20 7468   derived from th
+0006f9d0: 6520 6669 6c65 6e61 6d65 2022 202b 2073  e filename " + s
+0006f9e0: 6964 3020 2b20 2220 646f 6573 206e 6f74  id0 + " does not
+0006f9f0: 206d 6174 6368 2074 6865 2069 6420 7374   match the id st
+0006fa00: 6f72 6564 2069 6e20 7468 6520 6461 7461  ored in the data
+0006fa10: 2066 7261 6d65 2022 202b 2073 6964 2029   frame " + sid )
+0006fa20: 0a20 2020 2020 2020 2020 2020 2077 6172  .            war
+0006fa30: 6e69 6e67 732e 7761 726e 2820 2266 696c  nings.warn( "fil
+0006fa40: 656e 616d 6520 6973 203a 2022 202b 2020  ename is : " +  
+0006fa50: 6d79 666e 2029 0a20 2020 2020 2020 2020  myfn ).         
+0006fa60: 2020 2077 6172 6e69 6e67 732e 7761 726e     warnings.warn
+0006fa70: 2820 2273 6964 2069 7320 3a20 2220 2b20  ( "sid is : " + 
+0006fa80: 7369 6420 290a 2020 2020 2020 2020 2020  sid ).          
+0006fa90: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
+0006faa0: 2022 7820 6973 203a 2022 202b 2073 7472   "x is : " + str
+0006fab0: 2878 2920 290a 2020 2020 2020 2020 6d79  (x) ).        my
+0006fac0: 7072 6f6a 203d 2073 7472 2864 665b 7072  proj = str(df[pr
+0006fad0: 6f6a 6563 745f 636f 6c5d 2e69 6c6f 635b  oject_col].iloc[
+0006fae0: 785d 290a 2020 2020 2020 2020 6d79 6461  x]).        myda
+0006faf0: 7465 203d 2073 7472 2864 665b 6461 7465  te = str(df[date
+0006fb00: 5f63 6f6c 5d2e 696c 6f63 5b78 5d29 0a20  _col].iloc[x]). 
+0006fb10: 2020 2020 2020 206d 7969 6420 3d20 7374         myid = st
+0006fb20: 7228 6466 5b69 6d61 6765 5f63 6f6c 5d2e  r(df[image_col].
+0006fb30: 696c 6f63 5b78 5d29 0a20 2020 2020 2020  iloc[x]).       
+0006fb40: 2069 6620 7365 636f 6e64 5f73 706c 6974   if second_split
+0006fb50: 3a0a 2020 2020 2020 2020 2020 2020 6d79  :.            my
+0006fb60: 6964 203d 206d 7969 642e 7370 6c69 7428  id = myid.split(
+0006fb70: 222e 2229 5b30 5d0a 2020 2020 2020 2020  ".")[0].        
+0006fb80: 7061 7468 5f74 656d 706c 6174 6520 3d20  path_template = 
+0006fb90: 6261 7365 5f70 6174 6820 2b20 222f 2220  base_path + "/" 
+0006fba0: 2b20 6d79 7072 6f6a 202b 2020 222f 2220  + myproj +  "/" 
+0006fbb0: 2b20 7369 6420 2b20 222f 2220 2b20 6d79  + sid + "/" + my
+0006fbc0: 6461 7465 202b 2027 2f27 202b 2068 6965  date + '/' + hie
+0006fbd0: 7276 6172 6961 626c 6520 2b20 272f 2720  rvariable + '/' 
+0006fbe0: 2b20 7374 7228 6d79 6964 2920 2b20 222f  + str(myid) + "/
+0006fbf0: 220a 2020 2020 2020 2020 6869 6572 666e  ".        hierfn
+0006fc00: 203d 2073 6f72 7465 6428 676c 6f62 2820   = sorted(glob( 
+0006fc10: 7061 7468 5f74 656d 706c 6174 6520 2b20  path_template + 
+0006fc20: 222a 2220 2b20 6869 6572 7661 7269 6162  "*" + hiervariab
+0006fc30: 6c65 202b 2022 2a77 6964 652e 6373 7622  le + "*wide.csv"
+0006fc40: 2029 2029 0a20 2020 2020 2020 2069 6620   ) ).        if 
+0006fc50: 6c65 6e28 2068 6965 7266 6e20 2920 3d3d  len( hierfn ) ==
+0006fc60: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+0006fc70: 7072 696e 7428 2068 6965 7266 6e20 290a  print( hierfn ).
+0006fc80: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0006fc90: 7428 2070 6174 685f 7465 6d70 6c61 7465  t( path_template
+0006fca0: 2029 0a20 2020 2020 2020 2020 2020 2070   ).            p
+0006fcb0: 7269 6e74 2820 6d79 7072 6f6a 2029 0a20  rint( myproj ). 
+0006fcc0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0006fcd0: 2820 7369 6420 290a 2020 2020 2020 2020  ( sid ).        
+0006fce0: 2020 2020 7072 696e 7428 206d 7964 6174      print( mydat
+0006fcf0: 6520 2920 0a20 2020 2020 2020 2020 2020  e ) .           
+0006fd00: 2070 7269 6e74 2820 6d79 6964 2029 0a20   print( myid ). 
+0006fd10: 2020 2020 2020 2069 6620 6c65 6e28 2068         if len( h
+0006fd20: 6965 7266 6e20 2920 3e20 303a 0a20 2020  ierfn ) > 0:.   
+0006fd30: 2020 2020 2020 2020 206b 6565 705b 785d           keep[x]
+0006fd40: 3d54 7275 650a 0a20 2020 2023 2064 663d  =True..    # df=
+0006fd50: 6466 5b6b 6565 705d 0a20 2020 2069 6620  df[keep].    if 
+0006fd60: 6466 2e73 6861 7065 5b30 5d20 3d3d 2030  df.shape[0] == 0
+0006fd70: 3a0a 2020 2020 2020 2020 7761 726e 696e  :.        warnin
+0006fd80: 6773 2e77 6172 6e28 2269 6e70 7574 2064  gs.warn("input d
+0006fd90: 6174 6120 6672 616d 6520 7368 6170 6520  ata frame shape 
+0006fda0: 6973 2066 696c 7465 7265 6420 646f 776e  is filtered down
+0006fdb0: 2074 6f20 7a65 726f 2229 0a20 2020 2020   to zero").     
+0006fdc0: 2020 2072 6574 7572 6e20 6466 0a0a 2020     return df..  
+0006fdd0: 2020 6966 206e 6f74 2064 662e 696e 6465    if not df.inde
+0006fde0: 782e 6973 5f75 6e69 7175 653a 0a20 2020  x.is_unique:.   
+0006fdf0: 2020 2020 2077 6172 6e69 6e67 732e 7761       warnings.wa
+0006fe00: 726e 2822 6461 7461 2066 7261 6d65 2064  rn("data frame d
+0006fe10: 6f65 7320 6e6f 7420 6861 7665 2075 6e69  oes not have uni
+0006fe20: 7175 6520 696e 6469 6365 732e 2020 7765  que indices.  we
+0006fe30: 2074 6865 7265 666f 7265 2072 6573 6574   therefore reset
+0006fe40: 2074 6865 2069 6e64 6578 2074 6f20 616c   the index to al
+0006fe50: 6c6f 7720 7468 6520 6675 6e63 7469 6f6e  low the function
+0006fe60: 2074 6f20 636f 6e74 696e 7565 206f 6e2e   to continue on.
+0006fe70: 2220 290a 2020 2020 2020 2020 6466 203d  " ).        df =
+0006fe80: 2064 662e 7265 7365 745f 696e 6465 7828   df.reset_index(
+0006fe90: 290a 0a20 2020 200a 2020 2020 6966 2076  )..    .    if v
+0006fea0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+0006feb0: 7072 696e 7428 2022 6f72 6967 696e 616c  print( "original
+0006fec0: 2069 6e70 7574 2068 6164 2073 6861 7065   input had shape
+0006fed0: 2022 202b 2073 7472 2820 6466 2e73 6861   " + str( df.sha
+0006fee0: 7065 5b30 5d20 2920 2b20 2220 2854 3120  pe[0] ) + " (T1 
+0006fef0: 6f6e 6c79 2920 616e 6420 7765 2066 696e  only) and we fin
+0006ff00: 6420 2220 2b20 7374 7228 2028 6b65 6570  d " + str( (keep
+0006ff10: 292e 7375 6d28 2920 2920 2b20 2220 7769  ).sum() ) + " wi
+0006ff20: 7468 2068 6965 7261 7263 6869 6361 6c20  th hierarchical 
+0006ff30: 6f75 7470 7574 2064 6566 696e 6564 2062  output defined b
+0006ff40: 7920 7661 7269 6162 6c65 3a20 2220 2b20  y variable: " + 
+0006ff50: 6869 6572 7661 7269 6162 6c65 2029 0a20  hiervariable ). 
+0006ff60: 2020 2020 2020 2070 7269 6e74 2820 6466         print( df
+0006ff70: 2e73 6861 7065 2029 0a0a 2020 2020 6466  .shape )..    df
+0006ff80: 6f75 7420 3d20 7064 2e44 6174 6146 7261  out = pd.DataFra
+0006ff90: 6d65 2829 0a20 2020 206d 7963 7420 3d20  me().    myct = 
+0006ffa0: 300a 2020 2020 666f 7220 7820 696e 2072  0.    for x in r
+0006ffb0: 616e 6765 2820 6466 2e73 6861 7065 5b30  ange( df.shape[0
+0006ffc0: 5d29 3a0a 2020 2020 2020 2020 6966 2076  ]):.        if v
+0006ffd0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+0006ffe0: 2020 2020 7072 696e 7428 225c 6e5c 6e2d      print("\n\n-
+0006fff0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00070000: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00070010: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00070020: 2229 0a20 2020 2020 2020 2020 2020 2070  ").            p
+00070030: 7269 6e74 2866 227b 787d 2e2e 2e22 290a  rint(f"{x}...").
+00070040: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00070050: 2020 2020 2020 2020 2020 7072 6f67 7265            progre
+00070060: 7373 5f72 6570 6f72 7465 7228 782c 2064  ss_reporter(x, d
+00070070: 662e 7368 6170 655b 305d 2c20 7769 6474  f.shape[0], widt
+00070080: 683d 3530 3029 0a20 2020 2020 2020 206c  h=500).        l
+00070090: 6f63 696e 6420 3d20 6466 2e69 6e64 6578  ocind = df.index
+000700a0: 5b78 5d0a 2020 2020 2020 2020 6d79 666e  [x].        myfn
+000700b0: 203d 206f 732e 7061 7468 2e62 6173 656e   = os.path.basen
+000700c0: 616d 6528 2064 665b 2766 696c 656e 616d  ame( df['filenam
+000700d0: 6527 5d2e 696c 6f63 5b78 5d20 290a 2020  e'].iloc[x] ).  
+000700e0: 2020 2020 2020 7369 6420 3d20 7374 7228        sid = str(
+000700f0: 2064 665b 7375 626a 6563 745f 636f 6c5d   df[subject_col]
+00070100: 2e69 6c6f 635b 785d 2029 0a20 2020 2020  .iloc[x] ).     
+00070110: 2020 2074 656d 7042 203d 206d 7966 6e2e     tempB = myfn.
+00070120: 7370 6c69 7428 2073 706c 6974 7365 7020  split( splitsep 
+00070130: 290a 2020 2020 2020 2020 7369 6430 203d  ).        sid0 =
+00070140: 2073 7472 2874 656d 7042 5b31 5d29 0a20   str(tempB[1]). 
+00070150: 2020 2020 2020 2069 6620 7369 6430 2021         if sid0 !
+00070160: 3d20 7369 6420 616e 6420 7665 7262 6f73  = sid and verbos
+00070170: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
+00070180: 6172 6e69 6e67 732e 7761 726e 2822 494e  arnings.warn("IN
+00070190: 4e45 523a 2074 6865 2069 6420 6465 7269  NER: the id deri
+000701a0: 7665 6420 6672 6f6d 2074 6865 2066 696c  ved from the fil
+000701b0: 656e 616d 6520 2220 2b20 7374 7228 7369  ename " + str(si
+000701c0: 6429 202b 2022 2064 6f65 7320 6e6f 7420  d) + " does not 
+000701d0: 6d61 7463 6820 7468 6520 6964 2073 746f  match the id sto
+000701e0: 7265 6420 696e 2074 6865 2064 6174 6120  red in the data 
+000701f0: 6672 616d 6520 2220 2b20 7374 7228 7369  frame " + str(si
+00070200: 6430 2920 290a 2020 2020 2020 2020 2020  d0) ).          
+00070210: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
+00070220: 2022 6669 6c65 6e61 6d65 2069 7320 3a20   "filename is : 
+00070230: 2220 2b20 2073 7472 286d 7966 6e29 2029  " +  str(myfn) )
+00070240: 0a20 2020 2020 2020 2020 2020 2077 6172  .            war
+00070250: 6e69 6e67 732e 7761 726e 2820 2273 6964  nings.warn( "sid
+00070260: 2069 7320 3a20 2220 2b20 7374 7228 7369   is : " + str(si
+00070270: 6429 2029 0a20 2020 2020 2020 2020 2020  d) ).           
+00070280: 2077 6172 6e69 6e67 732e 7761 726e 2820   warnings.warn( 
+00070290: 2278 2069 7320 3a20 2220 2b20 7374 7228  "x is : " + str(
+000702a0: 7829 2029 0a20 2020 2020 2020 2020 2020  x) ).           
+000702b0: 2077 6172 6e69 6e67 732e 7761 726e 2820   warnings.warn( 
+000702c0: 2269 6e64 6578 2069 7320 3a20 2220 2b20  "index is : " + 
+000702d0: 7374 7228 6c6f 6369 6e64 2920 290a 2020  str(locind) ).  
+000702e0: 2020 2020 2020 6d79 7072 6f6a 203d 2073        myproj = s
+000702f0: 7472 2864 665b 7072 6f6a 6563 745f 636f  tr(df[project_co
+00070300: 6c5d 2e69 6c6f 635b 785d 290a 2020 2020  l].iloc[x]).    
+00070310: 2020 2020 6d79 6461 7465 203d 2073 7472      mydate = str
+00070320: 2864 665b 6461 7465 5f63 6f6c 5d2e 696c  (df[date_col].il
+00070330: 6f63 5b78 5d29 0a20 2020 2020 2020 206d  oc[x]).        m
+00070340: 7969 6420 3d20 7374 7228 6466 5b69 6d61  yid = str(df[ima
+00070350: 6765 5f63 6f6c 5d2e 696c 6f63 5b78 5d29  ge_col].iloc[x])
+00070360: 0a20 2020 2020 2020 2069 6620 7365 636f  .        if seco
+00070370: 6e64 5f73 706c 6974 3a0a 2020 2020 2020  nd_split:.      
+00070380: 2020 2020 2020 6d79 6964 203d 206d 7969        myid = myi
+00070390: 642e 7370 6c69 7428 222e 2229 5b30 5d0a  d.split(".")[0].
+000703a0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+000703b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000703c0: 7072 696e 7428 206d 7966 6e20 290a 2020  print( myfn ).  
+000703d0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+000703e0: 2074 656d 7020 290a 2020 2020 2020 2020   temp ).        
+000703f0: 2020 2020 7072 696e 7428 2022 6964 2022      print( "id "
+00070400: 202b 2073 6964 2020 290a 2020 2020 2020   + sid  ).      
+00070410: 2020 7061 7468 5f74 656d 706c 6174 6520    path_template 
+00070420: 3d20 6261 7365 5f70 6174 6820 2b20 222f  = base_path + "/
+00070430: 2220 2b20 6d79 7072 6f6a 202b 2020 222f  " + myproj +  "/
+00070440: 2220 2b20 7369 6420 2b20 222f 2220 2b20  " + sid + "/" + 
+00070450: 6d79 6461 7465 202b 2027 2f27 202b 2068  mydate + '/' + h
+00070460: 6965 7276 6172 6961 626c 6520 2b20 272f  iervariable + '/
+00070470: 2720 2b20 7374 7228 6d79 6964 2920 2b20  ' + str(myid) + 
+00070480: 222f 220a 2020 2020 2020 2020 7365 6172  "/".        sear
+00070490: 6368 6869 6572 203d 2070 6174 685f 7465  chhier = path_te
+000704a0: 6d70 6c61 7465 202b 2022 2a22 202b 2068  mplate + "*" + h
+000704b0: 6965 7276 6172 6961 626c 6520 2b20 222a  iervariable + "*
+000704c0: 7769 6465 2e63 7376 220a 2020 2020 2020  wide.csv".      
+000704d0: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
+000704e0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+000704f0: 2073 6561 7263 6868 6965 7220 290a 2020   searchhier ).  
+00070500: 2020 2020 2020 6869 6572 666e 203d 2073        hierfn = s
+00070510: 6f72 7465 6428 2067 6c6f 6228 2073 6561  orted( glob( sea
+00070520: 7263 6868 6965 7220 2920 290a 2020 2020  rchhier ) ).    
+00070530: 2020 2020 6966 206c 656e 2820 6869 6572      if len( hier
+00070540: 666e 2029 203e 2031 3a0a 2020 2020 2020  fn ) > 1:.      
+00070550: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00070560: 6545 7272 6f72 2822 7468 6572 6520 6172  eError("there ar
+00070570: 6520 2220 2b20 7374 7228 206c 656e 2820  e " + str( len( 
+00070580: 6869 6572 666e 2029 2029 202b 2022 206e  hierfn ) ) + " n
+00070590: 756d 6265 7220 6f66 2068 6965 7220 666e  umber of hier fn
+000705a0: 7320 7769 7468 2073 6561 7263 6820 7061  s with search pa
+000705b0: 7468 2022 202b 2073 6561 7263 6868 6965  th " + searchhie
+000705c0: 7220 290a 2020 2020 2020 2020 6966 206c  r ).        if l
+000705d0: 656e 2820 6869 6572 666e 2029 203d 3d20  en( hierfn ) == 
+000705e0: 313a 0a20 2020 2020 2020 2020 2020 2068  1:.            h
+000705f0: 6466 3d74 3164 663d 6474 6466 3d72 7364  df=t1df=dtdf=rsd
+00070600: 663d 7065 7266 6466 3d6e 6d64 663d 666c  f=perfdf=nmdf=fl
+00070610: 6169 7264 663d 4e6f 6e65 0a20 2020 2020  airdf=None.     
+00070620: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+00070630: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00070640: 2020 2070 7269 6e74 2868 6965 7266 6e29     print(hierfn)
+00070650: 0a20 2020 2020 2020 2020 2020 2068 6466  .            hdf
+00070660: 203d 2070 642e 7265 6164 5f63 7376 2868   = pd.read_csv(h
+00070670: 6965 7266 6e5b 305d 290a 2020 2020 2020  ierfn[0]).      
+00070680: 2020 2020 2020 6966 2076 6572 626f 7365        if verbose
+00070690: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000706a0: 2020 7072 696e 7428 2068 6466 5b27 766f    print( hdf['vo
+000706b0: 6c5f 6865 6d69 7370 6865 7265 5f6c 6566  l_hemisphere_lef
+000706c0: 7468 656d 6973 7068 6572 6573 275d 2029  themispheres'] )
+000706d0: 0a20 2020 2020 2020 2020 2020 2062 6164  .            bad
+000706e0: 6e61 6d65 7320 3d20 6765 745f 6e61 6d65  names = get_name
+000706f0: 735f 6672 6f6d 5f64 6174 615f 6672 616d  s_from_data_fram
+00070700: 6528 205b 2755 6e6e 616d 6564 275d 2c20  e( ['Unnamed'], 
+00070710: 6864 6620 290a 2020 2020 2020 2020 2020  hdf ).          
+00070720: 2020 6864 663d 6864 662e 6472 6f70 2862    hdf=hdf.drop(b
+00070730: 6164 6e61 6d65 732c 2061 7869 733d 3129  adnames, axis=1)
+00070740: 0a20 2020 2020 2020 2020 2020 206e 756d  .            num
+00070750: 7320 3d20 5b69 7369 6e73 7461 6e63 6528  s = [isinstance(
+00070760: 6864 665b 636f 6c5d 2e69 6c6f 635b 305d  hdf[col].iloc[0]
+00070770: 2c20 2869 6e74 2c20 666c 6f61 7429 2920  , (int, float)) 
+00070780: 666f 7220 636f 6c20 696e 2068 6466 2e63  for col in hdf.c
+00070790: 6f6c 756d 6e73 5d0a 2020 2020 2020 2020  olumns].        
+000707a0: 2020 2020 636f 7265 6e61 6d65 7320 3d20      corenames = 
+000707b0: 6c69 7374 286e 702e 6172 7261 7928 6864  list(np.array(hd
+000707c0: 662e 636f 6c75 6d6e 7329 5b6e 756d 735d  f.columns)[nums]
+000707d0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+000707e0: 6864 662e 6c6f 635b 3a2c 206e 756d 735d  hdf.loc[:, nums]
+000707f0: 203d 2068 6466 2e6c 6f63 5b3a 2c20 6e75   = hdf.loc[:, nu
+00070800: 6d73 5d2e 6164 645f 7072 6566 6978 2822  ms].add_prefix("
+00070810: 5431 4869 6572 5f22 290a 2020 2020 2020  T1Hier_").      
+00070820: 2020 2020 2020 6864 6620 3d20 6864 662e        hdf = hdf.
+00070830: 6164 645f 7072 6566 6978 2822 5431 4869  add_prefix("T1Hi
+00070840: 6572 5f22 290a 2020 2020 2020 2020 2020  er_").          
+00070850: 2020 6d79 6374 203d 206d 7963 7420 2b20    myct = myct + 
+00070860: 310a 2020 2020 2020 2020 2020 2020 6466  1.            df
+00070870: 6c69 7374 203d 205b 6864 665d 0a0a 2020  list = [hdf]..  
+00070880: 2020 2020 2020 2020 2020 666f 7220 6d79            for my
+00070890: 6d6f 6420 696e 2076 6d6f 6464 6963 742e  mod in vmoddict.
+000708a0: 6b65 7973 2829 3a0a 2020 2020 2020 2020  keys():.        
+000708b0: 2020 2020 2020 2020 6966 2076 6572 626f          if verbo
+000708c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000708d0: 2020 2020 2020 2020 7072 696e 7428 225c          print("\
+000708e0: 6e5c 6e2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  n\n*************
+000708f0: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2022 202b  ************ " +
+00070900: 206d 796d 6f64 202b 2022 202a 2a2a 2a2a   mymod + " *****
+00070910: 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a 2a2a  ****************
+00070920: 2a2a 2a2a 2229 0a20 2020 2020 2020 2020  ****").         
+00070930: 2020 2020 2020 206d 6f64 616c 6974 7963         modalityc
+00070940: 6c61 7373 203d 2076 6d6f 6464 6963 745b  lass = vmoddict[
+00070950: 206d 796d 6f64 205d 0a20 2020 2020 2020   mymod ].       
+00070960: 2020 2020 2020 2020 2069 6620 7769 6c64           if wild
+00070970: 5f63 6172 645f 6d6f 6461 6c69 7479 5f69  _card_modality_i
+00070980: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+00070990: 2020 2020 2020 206d 796d 6f64 6964 203d         mymodid =
+000709a0: 2027 2a27 0a20 2020 2020 2020 2020 2020   '*'.           
+000709b0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000709c0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000709d0: 796d 6f64 6964 203d 2073 7472 2820 6466  ymodid = str( df
+000709e0: 5b6d 796d 6f64 5d2e 696c 6f63 5b78 5d20  [mymod].iloc[x] 
+000709f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00070a00: 2020 2020 2020 6966 206d 796d 6f64 6964        if mymodid
+00070a10: 2e6c 6f77 6572 2829 2021 3d20 226e 616e  .lower() != "nan
+00070a20: 2220 616e 6420 6d79 6d6f 6469 642e 6c6f  " and mymodid.lo
+00070a30: 7765 7228 2920 213d 2022 6e61 223a 0a20  wer() != "na":. 
+00070a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070a50: 2020 2020 2020 206d 796d 6f64 6964 203d         mymodid =
+00070a60: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
+00070a70: 6528 206d 796d 6f64 6964 2029 0a20 2020  e( mymodid ).   
+00070a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070a90: 2020 2020 206d 796d 6f64 6964 203d 206f       mymodid = o
+00070aa0: 732e 7061 7468 2e73 706c 6974 6578 7428  s.path.splitext(
+00070ab0: 206d 796d 6f64 6964 2029 5b30 5d0a 2020   mymodid )[0].  
+00070ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070ad0: 2020 2020 2020 6d79 6d6f 6469 6420 3d20        mymodid = 
+00070ae0: 6f73 2e70 6174 682e 7370 6c69 7465 7874  os.path.splitext
+00070af0: 2820 6d79 6d6f 6469 6420 295b 305d 0a20  ( mymodid )[0]. 
+00070b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070b10: 2020 2020 2020 2074 656d 7020 3d20 6d79         temp = my
+00070b20: 6d6f 6469 642e 7370 6c69 7428 2069 6473  modid.split( ids
+00070b30: 6570 2029 0a20 2020 2020 2020 2020 2020  ep ).           
+00070b40: 2020 2020 2020 2020 2020 2020 206d 796d               mym
+00070b50: 6f64 6964 203d 2074 656d 705b 206c 656e  odid = temp[ len
+00070b60: 2820 7465 6d70 2029 2d31 205d 0a20 2020  ( temp )-1 ].   
+00070b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070b80: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00070b90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00070ba0: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+00070bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070bc0: 2020 2020 2020 2070 7269 6e74 2822 6d69         print("mi
+00070bd0: 7373 696e 6722 290a 2020 2020 2020 2020  ssing").        
+00070be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070bf0: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+00070c00: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
+00070c10: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+00070c20: 2020 2020 2020 2020 2070 7269 6e74 2820           print( 
+00070c30: 226d 6f64 616c 6974 7920 6964 2069 7320  "modality id is 
+00070c40: 2220 2b20 6d79 6d6f 6469 6420 2b20 2220  " + mymodid + " 
+00070c50: 666f 7220 6d6f 6461 6c69 7479 2022 202b  for modality " +
+00070c60: 206d 6f64 616c 6974 7963 6c61 7373 202b   modalityclass +
+00070c70: 2027 206d 6f64 616c 6974 7920 7370 6563   ' modality spec
+00070c80: 6966 6963 2073 7562 6a20 2720 2b20 7369  ific subj ' + si
+00070c90: 6420 2b20 2720 6d6f 6461 6c69 7479 2073  d + ' modality s
+00070ca0: 7065 6369 6669 6320 6964 2069 7320 2720  pecific id is ' 
+00070cb0: 2b20 6d79 6964 202b 2022 2069 7473 2064  + myid + " its d
+00070cc0: 6174 6520 2220 2b20 206d 7964 6174 6520  ate " +  mydate 
+00070cd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00070ce0: 2020 6d6f 6461 6c69 7479 636c 6173 7373    modalityclasss
+00070cf0: 6561 7263 6820 3d20 6d6f 6461 6c69 7479  earch = modality
+00070d00: 636c 6173 730a 2020 2020 2020 2020 2020  class.          
+00070d10: 2020 2020 2020 6966 206d 6f64 616c 6974        if modalit
+00070d20: 7963 6c61 7373 2069 6e20 5b27 7273 664d  yclass in ['rsfM
+00070d30: 5249 272c 2744 5449 275d 3a0a 2020 2020  RI','DTI']:.    
+00070d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070d50: 6d6f 6461 6c69 7479 636c 6173 7373 6561  modalityclasssea
+00070d60: 7263 683d 6d6f 6461 6c69 7479 636c 6173  rch=modalityclas
+00070d70: 732b 222a 220a 2020 2020 2020 2020 2020  s+"*".          
+00070d80: 2020 2020 2020 7061 7468 5f74 656d 706c        path_templ
+00070d90: 6174 655f 6d20 3d20 6261 7365 5f70 6174  ate_m = base_pat
+00070da0: 6820 2b20 222f 2220 2b20 6d79 7072 6f6a  h + "/" + myproj
+00070db0: 202b 2020 222f 2220 2b20 7369 6420 2b20   +  "/" + sid + 
+00070dc0: 222f 2220 2b20 6d79 6461 7465 202b 2027  "/" + mydate + '
+00070dd0: 2f27 202b 206d 6f64 616c 6974 7963 6c61  /' + modalitycla
+00070de0: 7373 7365 6172 6368 202b 2027 2f27 202b  sssearch + '/' +
+00070df0: 206d 796d 6f64 6964 202b 2022 2f22 0a20   mymodid + "/". 
+00070e00: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00070e10: 6f64 7365 6172 6368 203d 2070 6174 685f  odsearch = path_
+00070e20: 7465 6d70 6c61 7465 5f6d 202b 2022 2a22  template_m + "*"
+00070e30: 202b 206d 6f64 616c 6974 7963 6c61 7373   + modalityclass
+00070e40: 7365 6172 6368 202b 2022 2a77 6964 652e  search + "*wide.
+00070e50: 6373 7622 0a20 2020 2020 2020 2020 2020  csv".           
+00070e60: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
+00070e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00070e80: 2020 2020 2070 7269 6e74 2820 6d6f 6473       print( mods
+00070e90: 6561 7263 6820 290a 2020 2020 2020 2020  earch ).        
+00070ea0: 2020 2020 2020 2020 7431 7766 6e20 3d20          t1wfn = 
+00070eb0: 736f 7274 6564 2820 676c 6f62 2820 6d6f  sorted( glob( mo
+00070ec0: 6473 6561 7263 6820 2920 290a 2020 2020  dsearch ) ).    
+00070ed0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+00070ee0: 656e 2820 7431 7766 6e20 2920 3e20 313a  en( t1wfn ) > 1:
+00070ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00070f00: 2020 2020 206e 6c61 7267 6520 3d20 6c65       nlarge = le
+00070f10: 6e28 7431 7766 6e29 0a20 2020 2020 2020  n(t1wfn).       
+00070f20: 2020 2020 2020 2020 2020 2020 2074 3177               t1w
+00070f30: 666e 203d 2066 696e 645f 6d6f 7374 5f72  fn = find_most_r
+00070f40: 6563 656e 745f 6669 6c65 2820 7431 7766  ecent_file( t1wf
+00070f50: 6e20 290a 2020 2020 2020 2020 2020 2020  n ).            
+00070f60: 2020 2020 2020 2020 7761 726e 696e 6773          warnings
+00070f70: 2e77 6172 6e28 2274 6865 7265 2061 7265  .warn("there are
+00070f80: 2022 202b 2073 7472 2820 6e6c 6172 6765   " + str( nlarge
+00070f90: 2029 202b 2022 206e 756d 6265 7220 6f66   ) + " number of
+00070fa0: 2077 6964 6520 666e 7320 7769 7468 2073   wide fns with s
+00070fb0: 6561 7263 6820 7061 7468 2022 202b 206d  earch path " + m
+00070fc0: 6f64 7365 6172 6368 202b 2022 2077 6520  odsearch + " we 
+00070fd0: 7461 6b65 2074 6865 206d 6f73 7420 7265  take the most re
+00070fe0: 6365 6e74 206f 6620 7468 6573 6520 2220  cent of these " 
+00070ff0: 2b20 7431 7766 6e5b 305d 2029 0a20 2020  + t1wfn[0] ).   
+00071000: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00071010: 6c65 6e28 2074 3177 666e 2029 203d 3d20  len( t1wfn ) == 
+00071020: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00071030: 2020 2020 2020 2069 6620 7665 7262 6f73         if verbos
+00071040: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00071050: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00071060: 2874 3177 666e 290a 2020 2020 2020 2020  (t1wfn).        
+00071070: 2020 2020 2020 2020 2020 2020 7431 6466              t1df
+00071080: 203d 206d 7972 6561 645f 6373 7628 7431   = myread_csv(t1
+00071090: 7766 6e5b 305d 2c20 636f 7265 6e61 6d65  wfn[0], corename
+000710a0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+000710b0: 2020 2020 2020 2074 3164 6620 3d20 6669         t1df = fi
+000710c0: 6c74 6572 5f64 6628 2074 3164 662c 206d  lter_df( t1df, m
+000710d0: 6f64 616c 6974 7963 6c61 7373 2b27 5f27  odalityclass+'_'
+000710e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000710f0: 2020 2020 2020 6466 6c69 7374 203d 2064        dflist = d
+00071100: 666c 6973 7420 2b20 5b74 3164 665d 0a20  flist + [t1df]. 
+00071110: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00071120: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00071130: 2020 2020 2020 2020 2069 6620 7665 7262           if verb
+00071140: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+00071150: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00071160: 6e74 2820 2220 6361 6e6e 6f74 2066 696e  nt( " cannot fin
+00071170: 6420 2220 2b20 6d6f 6473 6561 7263 6820  d " + modsearch 
+00071180: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00071190: 2020 0a20 2020 2020 2020 2020 2020 2068    .            h
+000711a0: 6466 203d 2070 642e 636f 6e63 6174 2820  df = pd.concat( 
+000711b0: 6466 6c69 7374 2c20 6178 6973 3d31 2c20  dflist, axis=1, 
+000711c0: 6967 6e6f 7265 5f69 6e64 6578 3d46 616c  ignore_index=Fal
+000711d0: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+000711e0: 6966 2076 6572 626f 7365 3a0a 2020 2020  if verbose:.    
+000711f0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00071200: 7428 2022 636f 756e 743a 2022 202b 2073  t( "count: " + s
+00071210: 7472 2820 6d79 6374 2029 2029 0a20 2020  tr( myct ) ).   
+00071220: 2020 2020 2020 2020 2073 7562 6466 203d           subdf =
+00071230: 2064 662e 696c 6f63 5b5b 785d 5d0a 2020   df.iloc[[x]].  
+00071240: 2020 2020 2020 2020 2020 6864 662e 696e            hdf.in
+00071250: 6465 7820 3d20 7375 6264 662e 696e 6465  dex = subdf.inde
+00071260: 782e 636f 7079 2829 0a20 2020 2020 2020  x.copy().       
+00071270: 2020 2020 2073 7562 6466 203d 2070 642e       subdf = pd.
+00071280: 636f 6e63 6174 2820 5b73 7562 6466 2c68  concat( [subdf,h
+00071290: 6466 5d2c 2061 7869 733d 312c 2069 676e  df], axis=1, ign
+000712a0: 6f72 655f 696e 6465 783d 4661 6c73 6529  ore_index=False)
+000712b0: 0a20 2020 2020 2020 2020 2020 2064 666f  .            dfo
+000712c0: 7574 203d 2070 642e 636f 6e63 6174 2820  ut = pd.concat( 
+000712d0: 5b64 666f 7574 2c73 7562 6466 5d2c 2061  [dfout,subdf], a
+000712e0: 7869 733d 302c 2069 676e 6f72 655f 696e  xis=0, ignore_in
+000712f0: 6465 783d 4661 6c73 6520 290a 0a20 2020  dex=False )..   
+00071300: 2069 6620 6466 6f75 742e 7368 6170 655b   if dfout.shape[
+00071310: 305d 203e 2030 3a0a 2020 2020 2020 2020  0] > 0:.        
+00071320: 6261 646e 616d 6573 203d 2067 6574 5f6e  badnames = get_n
+00071330: 616d 6573 5f66 726f 6d5f 6461 7461 5f66  ames_from_data_f
+00071340: 7261 6d65 2820 5b27 556e 6e61 6d65 6427  rame( ['Unnamed'
+00071350: 5d2c 2064 666f 7574 2029 0a20 2020 2020  ], dfout ).     
+00071360: 2020 2064 666f 7574 3d64 666f 7574 2e64     dfout=dfout.d
+00071370: 726f 7028 6261 646e 616d 6573 2c20 6178  rop(badnames, ax
+00071380: 6973 3d31 290a 2020 2020 7265 7475 726e  is=1).    return
+00071390: 2064 666f 7574 0a0a 6465 6620 656e 616e   dfout..def enan
+000713a0: 7469 6f6d 6f72 7068 6963 5f66 696c 6c69  tiomorphic_filli
+000713b0: 6e67 5f77 6974 686f 7574 5f6d 6173 6b28  ng_without_mask(
+000713c0: 2069 6d61 6765 2c20 6178 6973 3d30 2c20   image, axis=0, 
+000713d0: 696e 7465 6e73 6974 793d 276c 6f77 2720  intensity='low' 
+000713e0: 293a 0a20 2020 2022 2222 0a20 2020 2050  ):.    """.    P
+000713f0: 6572 666f 726d 2061 6e20 656e 616e 7469  erform an enanti
+00071400: 6f6d 6f72 7068 6963 206c 6573 696f 6e20  omorphic lesion 
+00071410: 6669 6c6c 696e 6720 6f6e 2061 6e20 696d  filling on an im
+00071420: 6167 6520 7769 7468 6f75 7420 6120 6c65  age without a le
+00071430: 7369 6f6e 206d 6173 6b2e 0a0a 2020 2020  sion mask...    
+00071440: 4172 6773 3a0a 2020 2020 696d 6167 6520  Args:.    image 
+00071450: 2861 6e74 7349 6d61 6765 293a 2054 6865  (antsImage): The
+00071460: 2061 6e74 7320 696d 6167 6520 746f 2066   ants image to f
+00071470: 6c69 7020 616e 6420 6669 6c6c 0a20 2020  lip and fill.   
+00071480: 2061 7869 7320 2820 696e 7420 293a 2074   axis ( int ): t
+00071490: 6865 2061 7869 7320 616c 6f6e 6720 7768  he axis along wh
+000714a0: 6963 6820 746f 2072 6566 6c65 6374 2074  ich to reflect t
+000714b0: 6865 2069 6d61 6765 0a20 2020 2069 6e74  he image.    int
+000714c0: 656e 7369 7479 2028 2073 7472 2029 203a  ensity ( str ) :
+000714d0: 206c 6f77 206f 7220 6869 6768 0a0a 2020   low or high..  
+000714e0: 2020 5265 7475 726e 733a 0a20 2020 2061    Returns:.    a
+000714f0: 6e74 732e 414e 5473 496d 6167 653a 2054  nts.ANTsImage: T
+00071500: 6865 2069 6d61 6765 2061 6674 6572 2065  he image after e
+00071510: 6e61 6e74 696f 6d6f 7270 6869 6320 6669  nantiomorphic fi
+00071520: 6c6c 696e 672e 0a20 2020 2022 2222 0a20  lling..    """. 
+00071530: 2020 2069 6d61 6765 6e20 3d20 616e 7473     imagen = ants
+00071540: 2e69 4d61 7468 2820 696d 6167 652c 2027  .iMath( image, '
+00071550: 4e6f 726d 616c 697a 6527 2029 0a20 2020  Normalize' ).   
+00071560: 2069 6d61 6765 6e20 3d20 616e 7473 2e69   imagen = ants.i
+00071570: 4d61 7468 2820 696d 6167 656e 2c20 2254  Math( imagen, "T
+00071580: 7275 6e63 6174 6549 6e74 656e 7369 7479  runcateIntensity
+00071590: 222c 2031 652d 362c 2030 2e39 3820 290a  ", 1e-6, 0.98 ).
+000715a0: 2020 2020 696d 6167 656e 203d 2061 6e74      imagen = ant
+000715b0: 732e 694d 6174 6828 2069 6d61 6765 6e2c  s.iMath( imagen,
+000715c0: 2027 4e6f 726d 616c 697a 6527 2029 0a20   'Normalize' ). 
+000715d0: 2020 2023 2043 7265 6174 6520 6120 6d69     # Create a mi
+000715e0: 7272 6f72 2069 6d61 6765 2028 666c 6970  rror image (flip
+000715f0: 7069 6e67 206c 6566 7420 616e 6420 7269  ping left and ri
+00071600: 6768 7429 0a20 2020 206d 6972 726f 725f  ght).    mirror_
+00071610: 696d 6167 6520 3d20 616e 7473 2e72 6566  image = ants.ref
+00071620: 6c65 6374 5f69 6d61 6765 2869 6d61 6765  lect_image(image
+00071630: 6e2c 2061 7869 733d 302c 2074 783d 2753  n, axis=0, tx='S
+00071640: 794e 2720 295b 2777 6172 7065 646d 6f76  yN' )['warpedmov
+00071650: 6f75 7427 5d0a 0a20 2020 2023 2043 7265  out']..    # Cre
+00071660: 6174 6520 6120 7379 6d6d 6574 7269 6320  ate a symmetric 
+00071670: 7665 7273 696f 6e20 6f66 2074 6865 2069  version of the i
+00071680: 6d61 6765 2062 7920 6176 6572 6167 696e  mage by averagin
+00071690: 6720 7468 6520 6f72 6967 696e 616c 2061  g the original a
+000716a0: 6e64 2074 6865 206d 6972 726f 7220 696d  nd the mirror im
+000716b0: 6167 650a 2020 2020 7379 6d6d 6574 7269  age.    symmetri
+000716c0: 635f 696d 6167 6520 3d20 696d 6167 656e  c_image = imagen
+000716d0: 202a 2030 2e35 202b 206d 6972 726f 725f   * 0.5 + mirror_
+000716e0: 696d 6167 6520 2a20 302e 350a 0a20 2020  image * 0.5..   
+000716f0: 2023 2049 6465 6e74 6966 7920 706f 7465   # Identify pote
+00071700: 6e74 6961 6c20 6c65 7369 6f6e 2061 7265  ntial lesion are
+00071710: 6173 2062 7920 6669 6e64 696e 6720 6469  as by finding di
+00071720: 6666 6572 656e 6365 7320 6265 7477 6565  fferences betwee
+00071730: 6e20 7468 6520 6f72 6967 696e 616c 2061  n the original a
+00071740: 6e64 2073 796d 6d65 7472 6963 2069 6d61  nd symmetric ima
+00071750: 6765 0a20 2020 2064 6966 6665 7265 6e63  ge.    differenc
+00071760: 655f 696d 6167 6520 3d20 696d 6167 6520  e_image = image 
+00071770: 2d20 7379 6d6d 6574 7269 635f 696d 6167  - symmetric_imag
+00071780: 650a 2020 2020 6469 6666 7365 6720 3d20  e.    diffseg = 
+00071790: 616e 7473 2e74 6872 6573 686f 6c64 5f69  ants.threshold_i
+000717a0: 6d61 6765 2864 6966 6665 7265 6e63 655f  mage(difference_
+000717b0: 696d 6167 652c 2022 4f74 7375 222c 2033  image, "Otsu", 3
+000717c0: 2029 0a20 2020 2069 6620 696e 7465 6e73   ).    if intens
+000717d0: 6974 7920 3d3d 2027 6c6f 7727 3a0a 2020  ity == 'low':.  
+000717e0: 2020 2020 2020 6c69 6b65 6c79 5f6c 6573        likely_les
+000717f0: 696f 6e20 3d20 616e 7473 2e74 6872 6573  ion = ants.thres
+00071800: 686f 6c64 5f69 6d61 6765 2820 6469 6666  hold_image( diff
+00071810: 7365 672c 2031 2c20 2031 290a 2020 2020  seg, 1,  1).    
+00071820: 656c 7365 3a0a 2020 2020 2020 2020 6c69  else:.        li
+00071830: 6b65 6c79 5f6c 6573 696f 6e20 3d20 616e  kely_lesion = an
+00071840: 7473 2e74 6872 6573 686f 6c64 5f69 6d61  ts.threshold_ima
+00071850: 6765 2820 6469 6666 7365 672c 2033 2c20  ge( diffseg, 3, 
+00071860: 2033 290a 2020 2020 6c69 6b65 6c79 5f6c   3).    likely_l
+00071870: 6573 696f 6e20 3d20 616e 7473 2e73 6d6f  esion = ants.smo
+00071880: 6f74 685f 696d 6167 6528 206c 696b 656c  oth_image( likel
+00071890: 795f 6c65 7369 6f6e 2c20 332e 3020 292e  y_lesion, 3.0 ).
+000718a0: 694d 6174 6828 224e 6f72 6d61 6c69 7a65  iMath("Normalize
+000718b0: 2229 0a20 2020 206c 6573 696f 6e6e 6567  ").    lesionneg
+000718c0: 203d 2028 2069 6d61 6765 6e2a 302b 312e   = ( imagen*0+1.
+000718d0: 3020 2920 2d20 6c69 6b65 6c79 5f6c 6573  0 ) - likely_les
+000718e0: 696f 6e0a 2020 2020 6669 6c6c 6564 5f69  ion.    filled_i
+000718f0: 6d61 6765 203d 2061 6e74 732e 696d 6167  mage = ants.imag
+00071900: 655f 636c 6f6e 6528 696d 6167 656e 2920  e_clone(imagen) 
+00071910: 2020 200a 2020 2020 6669 6c6c 6564 5f69     .    filled_i
+00071920: 6d61 6765 203d 2069 6d61 6765 6e20 2a20  mage = imagen * 
+00071930: 6c65 7369 6f6e 6e65 6720 2b20 6d69 7272  lesionneg + mirr
+00071940: 6f72 5f69 6d61 6765 202a 206c 696b 656c  or_image * likel
+00071950: 795f 6c65 7369 6f6e 0a0a 2020 2020 7265  y_lesion..    re
+00071960: 7475 726e 2066 696c 6c65 645f 696d 6167  turn filled_imag
+00071970: 652c 2064 6966 6673 6567 0a0a 0a0a 6465  e, diffseg....de
+00071980: 6620 6669 6c74 6572 5f69 6d61 6765 5f66  f filter_image_f
+00071990: 696c 6573 2869 6d61 6765 5f70 6174 6873  iles(image_paths
+000719a0: 2c20 6372 6974 6572 6961 3d27 6c61 7267  , criteria='larg
+000719b0: 6573 7427 293a 0a20 2020 2022 2222 0a20  est'):.    """. 
+000719c0: 2020 2046 696c 7465 7273 2061 206c 6973     Filters a lis
+000719d0: 7420 6f66 2069 6d61 6765 2066 696c 6520  t of image file 
+000719e0: 7061 7468 7320 6261 7365 6420 6f6e 2073  paths based on s
+000719f0: 7065 6369 6669 6564 2063 7269 7465 7269  pecified criteri
+00071a00: 6120 616e 6420 7265 7475 726e 7320 0a20  a and returns . 
+00071a10: 2020 2074 6865 2070 6174 6820 6f66 2074     the path of t
+00071a20: 6865 2069 6d61 6765 2074 6861 7420 6265  he image that be
+00071a30: 7374 206d 6174 6368 6573 2074 6861 7420  st matches that 
+00071a40: 6372 6974 6572 6961 2028 736d 616c 6c65  criteria (smalle
+00071a50: 7374 2c20 6c61 7267 6573 742c 206f 7220  st, largest, or 
+00071a60: 6272 6967 6874 6573 7429 2e0a 0a20 2020  brightest)...   
+00071a70: 2041 7267 733a 0a20 2020 2069 6d61 6765   Args:.    image
+00071a80: 5f70 6174 6873 2028 6c69 7374 293a 2041  _paths (list): A
+00071a90: 206c 6973 7420 6f66 2066 696c 6520 7061   list of file pa
+00071aa0: 7468 7320 746f 2074 6865 2069 6d61 6765  ths to the image
+00071ab0: 732e 0a20 2020 2063 7269 7465 7269 6120  s..    criteria 
+00071ac0: 2873 7472 293a 2043 7269 7465 7269 6120  (str): Criteria 
+00071ad0: 666f 7220 7365 6c65 6374 696e 6720 7468  for selecting th
+00071ae0: 6520 696d 6167 6520 2827 736d 616c 6c65  e image ('smalle
+00071af0: 7374 272c 2027 6c61 7267 6573 7427 2c20  st', 'largest', 
+00071b00: 2762 7269 6768 7465 7374 2729 2e0a 0a20  'brightest')... 
+00071b10: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+00071b20: 7374 723a 2054 6865 2066 696c 6520 7061  str: The file pa
+00071b30: 7468 206f 6620 7468 6520 7365 6c65 6374  th of the select
+00071b40: 6564 2069 6d61 6765 2c20 6f72 204e 6f6e  ed image, or Non
+00071b50: 6520 6966 206e 6f20 7661 6c69 6420 696d  e if no valid im
+00071b60: 6167 6573 2061 7265 2066 6f75 6e64 2e0a  ages are found..
+00071b70: 2020 2020 2222 220a 2020 2020 696d 706f      """.    impo
+00071b80: 7274 206e 756d 7079 2061 7320 6e70 0a20  rt numpy as np. 
+00071b90: 2020 2069 6620 6e6f 7420 696d 6167 655f     if not image_
+00071ba0: 7061 7468 733a 0a20 2020 2020 2020 2072  paths:.        r
+00071bb0: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
+00071bc0: 7365 6c65 6374 6564 5f69 6d61 6765 5f70  selected_image_p
+00071bd0: 6174 6820 3d20 4e6f 6e65 0a20 2020 2069  ath = None.    i
+00071be0: 6620 6372 6974 6572 6961 203d 3d20 2773  f criteria == 's
+00071bf0: 6d61 6c6c 6573 7427 206f 7220 6372 6974  mallest' or crit
+00071c00: 6572 6961 203d 3d20 276c 6172 6765 7374  eria == 'largest
+00071c10: 273a 0a20 2020 2020 2020 2065 7874 7265  ':.        extre
+00071c20: 6d65 5f76 6f6c 756d 6520 3d20 4e6f 6e65  me_volume = None
+00071c30: 0a0a 2020 2020 2020 2020 666f 7220 7061  ..        for pa
+00071c40: 7468 2069 6e20 696d 6167 655f 7061 7468  th in image_path
+00071c50: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
+00071c60: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00071c70: 2020 2020 696d 6167 6520 3d20 616e 7473      image = ants
+00071c80: 2e69 6d61 6765 5f72 6561 6428 7061 7468  .image_read(path
+00071c90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00071ca0: 2020 766f 6c75 6d65 203d 206e 702e 7072    volume = np.pr
+00071cb0: 6f64 2869 6d61 6765 2e73 6861 7065 290a  od(image.shape).
+00071cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00071cd0: 2069 6620 6372 6974 6572 6961 203d 3d20   if criteria == 
+00071ce0: 276c 6172 6765 7374 273a 0a20 2020 2020  'largest':.     
+00071cf0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00071d00: 6620 6578 7472 656d 655f 766f 6c75 6d65  f extreme_volume
+00071d10: 2069 7320 4e6f 6e65 206f 7220 766f 6c75   is None or volu
+00071d20: 6d65 203e 2065 7874 7265 6d65 5f76 6f6c  me > extreme_vol
+00071d30: 756d 653a 0a20 2020 2020 2020 2020 2020  ume:.           
+00071d40: 2020 2020 2020 2020 2020 2020 2065 7874               ext
+00071d50: 7265 6d65 5f76 6f6c 756d 6520 3d20 766f  reme_volume = vo
+00071d60: 6c75 6d65 0a20 2020 2020 2020 2020 2020  lume.           
+00071d70: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00071d80: 6563 7465 645f 696d 6167 655f 7061 7468  ected_image_path
+00071d90: 203d 2070 6174 680a 2020 2020 2020 2020   = path.        
+00071da0: 2020 2020 2020 2020 656c 6966 2063 7269          elif cri
+00071db0: 7465 7269 6120 3d3d 2027 736d 616c 6c65  teria == 'smalle
+00071dc0: 7374 273a 0a20 2020 2020 2020 2020 2020  st':.           
+00071dd0: 2020 2020 2020 2020 2069 6620 6578 7472           if extr
+00071de0: 656d 655f 766f 6c75 6d65 2069 7320 4e6f  eme_volume is No
+00071df0: 6e65 206f 7220 766f 6c75 6d65 203c 2065  ne or volume < e
+00071e00: 7874 7265 6d65 5f76 6f6c 756d 653a 0a20  xtreme_volume:. 
+00071e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00071e20: 2020 2020 2020 2065 7874 7265 6d65 5f76         extreme_v
+00071e30: 6f6c 756d 6520 3d20 766f 6c75 6d65 0a20  olume = volume. 
+00071e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00071e50: 2020 2020 2020 2073 656c 6563 7465 645f         selected_
+00071e60: 696d 6167 655f 7061 7468 203d 2070 6174  image_path = pat
+00071e70: 680a 0a20 2020 2020 2020 2020 2020 2065  h..            e
+00071e80: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00071e90: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00071ea0: 2020 2020 2020 7072 696e 7428 6622 4572        print(f"Er
+00071eb0: 726f 7220 7072 6f63 6573 7369 6e67 2069  ror processing i
+00071ec0: 6d61 6765 207b 7061 7468 7d3a 207b 657d  mage {path}: {e}
+00071ed0: 2229 0a0a 2020 2020 656c 6966 2063 7269  ")..    elif cri
+00071ee0: 7465 7269 6120 3d3d 2027 6272 6967 6874  teria == 'bright
+00071ef0: 6573 7427 3a0a 2020 2020 2020 2020 6d61  est':.        ma
+00071f00: 785f 6272 6967 6874 6e65 7373 203d 204e  x_brightness = N
+00071f10: 6f6e 650a 0a20 2020 2020 2020 2066 6f72  one..        for
+00071f20: 2070 6174 6820 696e 2069 6d61 6765 5f70   path in image_p
+00071f30: 6174 6873 3a0a 2020 2020 2020 2020 2020  aths:.          
+00071f40: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00071f50: 2020 2020 2020 2069 6d61 6765 203d 2061         image = a
+00071f60: 6e74 732e 696d 6167 655f 7265 6164 2870  nts.image_read(p
+00071f70: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+00071f80: 2020 2020 2062 7269 6768 746e 6573 7320       brightness 
+00071f90: 3d20 6e70 2e6d 6561 6e28 696d 6167 652e  = np.mean(image.
+00071fa0: 6e75 6d70 7928 2929 0a0a 2020 2020 2020  numpy())..      
+00071fb0: 2020 2020 2020 2020 2020 6966 206d 6178            if max
+00071fc0: 5f62 7269 6768 746e 6573 7320 6973 204e  _brightness is N
+00071fd0: 6f6e 6520 6f72 2062 7269 6768 746e 6573  one or brightnes
+00071fe0: 7320 3e20 6d61 785f 6272 6967 6874 6e65  s > max_brightne
+00071ff0: 7373 3a0a 2020 2020 2020 2020 2020 2020  ss:.            
+00072000: 2020 2020 2020 2020 6d61 785f 6272 6967          max_brig
+00072010: 6874 6e65 7373 203d 2062 7269 6768 746e  htness = brightn
+00072020: 6573 730a 2020 2020 2020 2020 2020 2020  ess.            
+00072030: 2020 2020 2020 2020 7365 6c65 6374 6564          selected
+00072040: 5f69 6d61 6765 5f70 6174 6820 3d20 7061  _image_path = pa
+00072050: 7468 0a0a 2020 2020 2020 2020 2020 2020  th..            
+00072060: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00072070: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+00072080: 2020 2020 2020 2070 7269 6e74 2866 2245         print(f"E
+00072090: 7272 6f72 2070 726f 6365 7373 696e 6720  rror processing 
+000720a0: 696d 6167 6520 7b70 6174 687d 3a20 7b65  image {path}: {e
+000720b0: 7d22 290a 0a20 2020 2065 6c73 653a 0a20  }")..    else:. 
+000720c0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+000720d0: 7565 4572 726f 7228 2243 7269 7465 7269  ueError("Criteri
+000720e0: 6120 6d75 7374 2062 6520 2773 6d61 6c6c  a must be 'small
+000720f0: 6573 7427 2c20 276c 6172 6765 7374 272c  est', 'largest',
+00072100: 206f 7220 2762 7269 6768 7465 7374 272e   or 'brightest'.
+00072110: 2229 0a0a 2020 2020 7265 7475 726e 2073  ")..    return s
+00072120: 656c 6563 7465 645f 696d 6167 655f 7061  elected_image_pa
+00072130: 7468 0a0a 0a0a 6465 6620 6d6d 5f6d 6174  th....def mm_mat
+00072140: 6368 5f62 795f 7163 5f73 636f 7269 6e67  ch_by_qc_scoring
+00072150: 2864 665f 612c 2064 665f 622c 206d 6174  (df_a, df_b, mat
+00072160: 6368 5f63 6f6c 756d 6e2c 2063 7269 7465  ch_column, crite
+00072170: 7269 612c 2070 7265 6669 783d 276d 6174  ria, prefix='mat
+00072180: 6368 6564 5f27 2c20 6578 636c 7564 655f  ched_', exclude_
+00072190: 636f 6c75 6d6e 733d 4e6f 6e65 293a 0a20  columns=None):. 
+000721a0: 2020 2022 2222 0a20 2020 204d 6174 6368     """.    Match
+000721b0: 2065 6163 6820 726f 7720 696e 2064 665f   each row in df_
+000721c0: 6120 746f 2061 2072 6f77 2069 6e20 6466  a to a row in df
+000721d0: 5f62 2062 6173 6564 206f 6e20 6120 6d61  _b based on a ma
+000721e0: 7463 6869 6e67 2063 6f6c 756d 6e20 616e  tching column an
+000721f0: 6420 6372 6974 6572 6961 2066 6f72 2073  d criteria for s
+00072200: 656c 6563 7469 6e67 2074 6865 2062 6573  electing the bes
+00072210: 7420 6d61 7463 682c 0a20 2020 2077 6974  t match,.    wit
+00072220: 6820 6f70 7469 6f6e 7320 746f 2070 7265  h options to pre
+00072230: 6669 7820 636f 6c75 6d6e 206e 616d 6573  fix column names
+00072240: 2066 726f 6d20 6466 5f62 2061 6e64 2065   from df_b and e
+00072250: 7863 6c75 6465 2063 6572 7461 696e 2063  xclude certain c
+00072260: 6f6c 756d 6e73 2066 726f 6d20 7468 6520  olumns from the 
+00072270: 6669 6e61 6c20 6f75 7470 7574 2e20 4164  final output. Ad
+00072280: 6469 7469 6f6e 616c 6c79 2c0a 2020 2020  ditionally,.    
+00072290: 7265 7475 726e 7320 6120 4461 7461 4672  returns a DataFr
+000722a0: 616d 6520 636f 6e74 6169 6e69 6e67 2072  ame containing r
+000722b0: 6f77 7320 6672 6f6d 2064 665f 6220 7468  ows from df_b th
+000722c0: 6174 2077 6572 6520 6e6f 7420 6d61 7463  at were not matc
+000722d0: 6865 6420 746f 2061 6e79 2072 6f77 2069  hed to any row i
+000722e0: 6e20 6466 5f61 2e0a 0a20 2020 2050 6172  n df_a...    Par
+000722f0: 616d 6574 6572 733a 0a20 2020 202d 2064  ameters:.    - d
+00072300: 665f 613a 2044 6174 6146 7261 6d65 2041  f_a: DataFrame A
+00072310: 2e0a 2020 2020 2d20 6466 5f62 3a20 4461  ..    - df_b: Da
+00072320: 7461 4672 616d 6520 422e 0a20 2020 202d  taFrame B..    -
+00072330: 206d 6174 6368 5f63 6f6c 756d 6e3a 2054   match_column: T
+00072340: 6865 2063 6f6c 756d 6e20 6e61 6d65 206f  he column name o
+00072350: 6e20 7768 6963 6820 726f 7773 2073 686f  n which rows sho
+00072360: 756c 6420 6d61 7463 6820 6265 7477 6565  uld match betwee
+00072370: 6e20 4461 7461 4672 616d 6520 4120 616e  n DataFrame A an
+00072380: 6420 422e 0a20 2020 202d 2063 7269 7465  d B..    - crite
+00072390: 7269 613a 2041 2064 6963 7469 6f6e 6172  ria: A dictionar
+000723a0: 7920 7768 6572 6520 6b65 7973 2061 7265  y where keys are
+000723b0: 2063 6f6c 756d 6e20 6e61 6d65 7320 616e   column names an
+000723c0: 6420 7661 6c75 6573 2061 7265 2027 6d69  d values are 'mi
+000723d0: 6e27 206f 7220 276d 6178 272c 2069 6e64  n' or 'max', ind
+000723e0: 6963 6174 696e 6720 7768 6574 6865 720a  icating whether.
+000723f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00072400: 7468 6520 636f 6c75 6d6e 2073 686f 756c  the column shoul
+00072410: 6420 6265 206d 696e 696d 697a 6564 206f  d be minimized o
+00072420: 7220 6d61 7869 6d69 7a65 6420 666f 7220  r maximized for 
+00072430: 7468 6520 6265 7374 206d 6174 6368 2e0a  the best match..
+00072440: 2020 2020 2d20 7072 6566 6978 3a20 4120      - prefix: A 
+00072450: 7374 7269 6e67 2070 7265 6669 7820 746f  string prefix to
+00072460: 2061 6464 2074 6f20 636f 6c75 6d6e 206e   add to column n
+00072470: 616d 6573 2066 726f 6d20 6466 5f62 2069  ames from df_b i
+00072480: 6e20 7468 6520 6669 6e61 6c20 6f75 7470  n the final outp
+00072490: 7574 2074 6f20 6176 6f69 6420 6475 706c  ut to avoid dupl
+000724a0: 6963 6174 696f 6e2e 0a20 2020 202d 2065  ication..    - e
+000724b0: 7863 6c75 6465 5f63 6f6c 756d 6e73 3a20  xclude_columns: 
+000724c0: 4120 6c69 7374 206f 6620 636f 6c75 6d6e  A list of column
+000724d0: 206e 616d 6573 2066 726f 6d20 6466 5f62   names from df_b
+000724e0: 2074 6f20 6578 636c 7564 6520 6672 6f6d   to exclude from
+000724f0: 2074 6865 2066 696e 616c 206f 7574 7075   the final outpu
+00072500: 742e 0a20 2020 200a 2020 2020 5265 7475  t..    .    Retu
+00072510: 726e 733a 0a20 2020 202d 2041 2074 7570  rns:.    - A tup
+00072520: 6c65 206f 6620 7477 6f20 4461 7461 4672  le of two DataFr
+00072530: 616d 6573 3a20 0a20 2020 2020 2020 2031  ames: .        1
+00072540: 2e20 4120 6e65 7720 4461 7461 4672 616d  . A new DataFram
+00072550: 6520 636f 6d62 696e 696e 6720 6466 5f61  e combining df_a
+00072560: 2077 6974 6820 6d61 7463 6865 6420 726f   with matched ro
+00072570: 7773 2066 726f 6d20 6466 5f62 2e0a 2020  ws from df_b..  
+00072580: 2020 2020 2020 322e 2041 2044 6174 6146        2. A DataF
+00072590: 7261 6d65 2063 6f6e 7461 696e 696e 6720  rame containing 
+000725a0: 726f 7773 2066 726f 6d20 6466 5f62 2074  rows from df_b t
+000725b0: 6861 7420 7765 7265 206e 6f74 206d 6174  hat were not mat
+000725c0: 6368 6564 2074 6f20 6466 5f61 2e0a 2020  ched to df_a..  
+000725d0: 2020 2222 220a 2020 2020 6672 6f6d 2073    """.    from s
+000725e0: 6369 7079 2e73 7461 7473 2069 6d70 6f72  cipy.stats impor
+000725f0: 7420 7a73 636f 7265 0a20 2020 2064 665f  t zscore.    df_
+00072600: 6120 3d20 6466 5f61 2e6c 6f63 5b3a 2c20  a = df_a.loc[:, 
+00072610: 7e64 665f 612e 636f 6c75 6d6e 732e 7374  ~df_a.columns.st
+00072620: 722e 7374 6172 7473 7769 7468 2827 556e  r.startswith('Un
+00072630: 6e61 6d65 643a 2729 5d2e 636f 7079 2829  named:')].copy()
+00072640: 0a20 2020 2069 6620 6466 5f62 2069 7320  .    if df_b is 
+00072650: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00072660: 2020 6466 5f62 203d 2064 665f 622e 6c6f    df_b = df_b.lo
+00072670: 635b 3a2c 207e 6466 5f62 2e63 6f6c 756d  c[:, ~df_b.colum
+00072680: 6e73 2e73 7472 2e73 7461 7274 7377 6974  ns.str.startswit
+00072690: 6828 2755 6e6e 616d 6564 3a27 295d 2e63  h('Unnamed:')].c
+000726a0: 6f70 7928 290a 2020 2020 656c 7365 3a0a  opy().    else:.
+000726b0: 2020 2020 2020 2020 7265 7475 726e 2064          return d
+000726c0: 665f 612c 2070 642e 4461 7461 4672 616d  f_a, pd.DataFram
+000726d0: 6528 290a 2020 2020 0a20 2020 2023 204e  e().    .    # N
+000726e0: 6f72 6d61 6c69 7a65 2064 665f 6220 6261  ormalize df_b ba
+000726f0: 7365 6420 6f6e 2063 7269 7465 7269 610a  sed on criteria.
+00072700: 2020 2020 666f 7220 636f 6c2c 2063 7269      for col, cri
+00072710: 7420 696e 2063 7269 7465 7269 612e 6974  t in criteria.it
+00072720: 656d 7328 293a 0a20 2020 2020 2020 2069  ems():.        i
+00072730: 6620 6372 6974 203d 3d20 276d 6178 273a  f crit == 'max':
+00072740: 0a20 2020 2020 2020 2020 2020 2064 665f  .            df_
+00072750: 622e 6c6f 635b 6466 5f62 2e69 6e64 6578  b.loc[df_b.index
+00072760: 2c20 6627 7363 6f72 655f 7b63 6f6c 7d27  , f'score_{col}'
+00072770: 5d20 3d20 7a73 636f 7265 282d 6466 5f62  ] = zscore(-df_b
+00072780: 5b63 6f6c 5d29 0a20 2020 2020 2020 2065  [col]).        e
+00072790: 6c69 6620 6372 6974 203d 3d20 276d 696e  lif crit == 'min
+000727a0: 273a 0a20 2020 2020 2020 2020 2020 2064  ':.            d
+000727b0: 665f 622e 6c6f 635b 6466 5f62 2e69 6e64  f_b.loc[df_b.ind
+000727c0: 6578 2c20 6627 7363 6f72 655f 7b63 6f6c  ex, f'score_{col
+000727d0: 7d27 5d20 3d20 7a73 636f 7265 2864 665f  }'] = zscore(df_
+000727e0: 625b 636f 6c5d 290a 0a20 2020 2023 2043  b[col])..    # C
+000727f0: 616c 6375 6c61 7465 2027 6265 7374 5f73  alculate 'best_s
+00072800: 636f 7265 2720 6279 2073 756d 6d69 6e67  core' by summing
+00072810: 2061 6c6c 2073 636f 7265 2063 6f6c 756d   all score colum
+00072820: 6e73 0a20 2020 2073 636f 7265 5f63 6f6c  ns.    score_col
+00072830: 756d 6e73 203d 205b 6627 7363 6f72 655f  umns = [f'score_
+00072840: 7b63 6f6c 7d27 2066 6f72 2063 6f6c 2069  {col}' for col i
+00072850: 6e20 6372 6974 6572 6961 2e6b 6579 7328  n criteria.keys(
+00072860: 295d 0a20 2020 2064 665f 625b 2762 6573  )].    df_b['bes
+00072870: 745f 7363 6f72 6527 5d20 3d20 6466 5f62  t_score'] = df_b
+00072880: 5b73 636f 7265 5f63 6f6c 756d 6e73 5d2e  [score_columns].
+00072890: 7375 6d28 6178 6973 3d31 290a 0a20 2020  sum(axis=1)..   
+000728a0: 206d 6174 6368 6564 5f69 6e64 6963 6573   matched_indices
+000728b0: 203d 205b 5d20 2023 2054 7261 636b 2069   = []  # Track i
+000728c0: 6e64 6963 6573 206f 6620 6d61 7463 6865  ndices of matche
+000728d0: 6420 726f 7773 2069 6e20 6466 5f62 0a0a  d rows in df_b..
+000728e0: 2020 2020 2320 4d61 7463 6820 726f 7773      # Match rows
+000728f0: 0a20 2020 206d 6174 6368 6564 5f72 6f77  .    matched_row
+00072900: 7320 3d20 5b5d 0a20 2020 2066 6f72 205f  s = [].    for _
+00072910: 2c20 726f 775f 6120 696e 2064 665f 612e  , row_a in df_a.
+00072920: 6974 6572 726f 7773 2829 3a0a 2020 2020  iterrows():.    
+00072930: 2020 2020 6d61 7463 6865 7320 3d20 6466      matches = df
+00072940: 5f62 5b64 665f 625b 6d61 7463 685f 636f  _b[df_b[match_co
+00072950: 6c75 6d6e 5d20 3d3d 2072 6f77 5f61 5b6d  lumn] == row_a[m
+00072960: 6174 6368 5f63 6f6c 756d 6e5d 5d0a 2020  atch_column]].  
+00072970: 2020 2020 2020 6966 206e 6f74 206d 6174        if not mat
+00072980: 6368 6573 2e65 6d70 7479 3a0a 2020 2020  ches.empty:.    
+00072990: 2020 2020 2020 2020 6265 7374 5f69 6478          best_idx
+000729a0: 203d 206d 6174 6368 6573 5b27 6265 7374   = matches['best
+000729b0: 5f73 636f 7265 275d 2e69 6478 6d69 6e28  _score'].idxmin(
+000729c0: 290a 2020 2020 2020 2020 2020 2020 6265  ).            be
+000729d0: 7374 5f6d 6174 6368 203d 206d 6174 6368  st_match = match
+000729e0: 6573 2e6c 6f63 5b62 6573 745f 6964 785d  es.loc[best_idx]
+000729f0: 0a20 2020 2020 2020 2020 2020 206d 6174  .            mat
+00072a00: 6368 6564 5f69 6e64 6963 6573 2e61 7070  ched_indices.app
+00072a10: 656e 6428 6265 7374 5f69 6478 2920 2023  end(best_idx)  #
+00072a20: 2054 7261 636b 2074 6869 7320 696e 6465   Track this inde
+00072a30: 7820 6173 206d 6174 6368 6564 0a20 2020  x as matched.   
+00072a40: 2020 2020 2020 2020 206d 6174 6368 6564           matched
+00072a50: 5f72 6f77 732e 6170 7065 6e64 2862 6573  _rows.append(bes
+00072a60: 745f 6d61 7463 6829 0a20 2020 2020 2020  t_match).       
+00072a70: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00072a80: 2020 206d 6174 6368 6564 5f72 6f77 732e     matched_rows.
+00072a90: 6170 7065 6e64 2870 642e 5365 7269 6573  append(pd.Series
+00072aa0: 2864 7479 7065 3d27 666c 6f61 7436 3427  (dtype='float64'
+00072ab0: 2929 0a0a 2020 2020 2320 4372 6561 7465  ))..    # Create
+00072ac0: 2061 2044 6174 6146 7261 6d65 2066 726f   a DataFrame fro
+00072ad0: 6d20 6d61 7463 6865 6420 726f 7773 0a20  m matched rows. 
+00072ae0: 2020 2064 665f 6d61 7463 6865 6420 3d20     df_matched = 
+00072af0: 7064 2e44 6174 6146 7261 6d65 286d 6174  pd.DataFrame(mat
+00072b00: 6368 6564 5f72 6f77 7329 2e72 6573 6574  ched_rows).reset
+00072b10: 5f69 6e64 6578 2864 726f 703d 5472 7565  _index(drop=True
+00072b20: 290a 2020 2020 0a20 2020 2023 2045 7863  ).    .    # Exc
+00072b30: 6c75 6465 2073 7065 6369 6669 6564 2063  lude specified c
+00072b40: 6f6c 756d 6e73 2061 6e64 2061 6464 2070  olumns and add p
+00072b50: 7265 6669 780a 2020 2020 6966 2065 7863  refix.    if exc
+00072b60: 6c75 6465 5f63 6f6c 756d 6e73 2069 7320  lude_columns is 
+00072b70: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00072b80: 2020 6466 5f6d 6174 6368 6564 203d 2064    df_matched = d
+00072b90: 665f 6d61 7463 6865 642e 6472 6f70 2863  f_matched.drop(c
+00072ba0: 6f6c 756d 6e73 3d65 7863 6c75 6465 5f63  olumns=exclude_c
+00072bb0: 6f6c 756d 6e73 2c20 6572 726f 7273 3d27  olumns, errors='
+00072bc0: 6967 6e6f 7265 2729 0a20 2020 2064 665f  ignore').    df_
+00072bd0: 6d61 7463 6865 6420 3d20 6466 5f6d 6174  matched = df_mat
+00072be0: 6368 6564 2e72 656e 616d 6528 636f 6c75  ched.rename(colu
+00072bf0: 6d6e 733d 6c61 6d62 6461 2078 3a20 6622  mns=lambda x: f"
+00072c00: 7b70 7265 6669 787d 7b78 7d22 2069 6620  {prefix}{x}" if 
+00072c10: 7820 213d 206d 6174 6368 5f63 6f6c 756d  x != match_colum
+00072c20: 6e20 616e 6420 7820 696e 2064 665f 6d61  n and x in df_ma
+00072c30: 7463 6865 642e 636f 6c75 6d6e 7320 656c  tched.columns el
+00072c40: 7365 2078 290a 0a20 2020 2023 2043 6f6d  se x)..    # Com
+00072c50: 6269 6e65 2064 665f 6120 7769 7468 206d  bine df_a with m
+00072c60: 6174 6368 6564 2072 6f77 7320 6672 6f6d  atched rows from
+00072c70: 2064 665f 620a 2020 2020 7265 7375 6c74   df_b.    result
+00072c80: 5f64 6620 3d20 7064 2e63 6f6e 6361 7428  _df = pd.concat(
+00072c90: 5b64 665f 612e 7265 7365 745f 696e 6465  [df_a.reset_inde
+00072ca0: 7828 6472 6f70 3d54 7275 6529 2c20 6466  x(drop=True), df
+00072cb0: 5f6d 6174 6368 6564 5d2c 2061 7869 733d  _matched], axis=
+00072cc0: 3129 0a20 2020 200a 2020 2020 2320 4578  1).    .    # Ex
+00072cd0: 7472 6163 7420 756e 6d61 7463 6865 6420  tract unmatched 
+00072ce0: 726f 7773 2066 726f 6d20 6466 5f62 0a20  rows from df_b. 
+00072cf0: 2020 2075 6e6d 6174 6368 6564 5f64 665f     unmatched_df_
+00072d00: 6220 3d20 6466 5f62 2e64 726f 7028 696e  b = df_b.drop(in
+00072d10: 6465 783d 6d61 7463 6865 645f 696e 6469  dex=matched_indi
+00072d20: 6365 7329 2e72 6573 6574 5f69 6e64 6578  ces).reset_index
+00072d30: 2864 726f 703d 5472 7565 290a 0a20 2020  (drop=True)..   
+00072d40: 2072 6574 7572 6e20 7265 7375 6c74 5f64   return result_d
+00072d50: 662c 2075 6e6d 6174 6368 6564 5f64 665f  f, unmatched_df_
+00072d60: 620a 0a0a 6465 6620 6669 785f 4c52 5f52  b...def fix_LR_R
+00072d70: 4c5f 7374 7566 6628 6466 2c20 636f 6c31  L_stuff(df, col1
+00072d80: 2c20 636f 6c32 2c20 7369 7a65 5f63 6f6c  , col2, size_col
+00072d90: 312c 2073 697a 655f 636f 6c32 2c20 6964  1, size_col2, id
+00072da0: 312c 2069 6432 2029 3a0a 2020 2020 6466  1, id2 ):.    df
+00072db0: 5f63 6f70 7920 3d20 6466 2e63 6f70 7928  _copy = df.copy(
+00072dc0: 290a 2020 2020 2320 456e 7375 7265 2063  ).    # Ensure c
+00072dd0: 6f6c 756d 6e73 2063 6f6e 7461 696e 2073  olumns contain s
+00072de0: 7472 696e 6773 2066 6f72 2073 7562 7374  trings for subst
+00072df0: 7269 6e67 2063 6865 636b 730a 2020 2020  ring checks.    
+00072e00: 6466 5f63 6f70 795b 636f 6c31 5d20 3d20  df_copy[col1] = 
+00072e10: 6466 5f63 6f70 795b 636f 6c31 5d2e 6173  df_copy[col1].as
+00072e20: 7479 7065 2873 7472 290a 2020 2020 6466  type(str).    df
+00072e30: 5f63 6f70 795b 636f 6c32 5d20 3d20 6466  _copy[col2] = df
+00072e40: 5f63 6f70 795b 636f 6c32 5d2e 6173 7479  _copy[col2].asty
+00072e50: 7065 2873 7472 290a 2020 2020 6466 5f63  pe(str).    df_c
+00072e60: 6f70 795b 6964 315d 203d 2064 665f 636f  opy[id1] = df_co
+00072e70: 7079 5b69 6431 5d2e 6173 7479 7065 2873  py[id1].astype(s
+00072e80: 7472 290a 2020 2020 6466 5f63 6f70 795b  tr).    df_copy[
+00072e90: 6964 325d 203d 2064 665f 636f 7079 5b69  id2] = df_copy[i
+00072ea0: 6432 5d2e 6173 7479 7065 2873 7472 290a  d2].astype(str).
+00072eb0: 2020 2020 0a20 2020 2066 6f72 2069 6e64      .    for ind
+00072ec0: 6578 2c20 726f 7720 696e 2064 665f 636f  ex, row in df_co
+00072ed0: 7079 2e69 7465 7272 6f77 7328 293a 0a20  py.iterrows():. 
+00072ee0: 2020 2020 2020 2063 6f6c 315f 7661 6c20         col1_val 
+00072ef0: 3d20 726f 775b 636f 6c31 5d0a 2020 2020  = row[col1].    
+00072f00: 2020 2020 636f 6c32 5f76 616c 203d 2072      col2_val = r
+00072f10: 6f77 5b63 6f6c 325d 0a20 2020 2020 2020  ow[col2].       
+00072f20: 2073 697a 6531 203d 2072 6f77 5b73 697a   size1 = row[siz
+00072f30: 655f 636f 6c31 5d0a 2020 2020 2020 2020  e_col1].        
+00072f40: 7369 7a65 3220 3d20 726f 775b 7369 7a65  size2 = row[size
+00072f50: 5f63 6f6c 325d 0a20 2020 2020 2020 200a  _col2].        .
+00072f60: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
+00072f70: 666f 7220 2752 4c27 206f 7220 274c 5227  for 'RL' or 'LR'
+00072f80: 2069 6e20 6561 6368 2063 6f6c 756d 6e20   in each column 
+00072f90: 616e 6420 636f 6d70 6172 6520 7369 7a65  and compare size
+00072fa0: 730a 2020 2020 2020 2020 6966 2028 2752  s.        if ('R
+00072fb0: 4c27 2069 6e20 636f 6c31 5f76 616c 206f  L' in col1_val o
+00072fc0: 7220 274c 5227 2069 6e20 636f 6c31 5f76  r 'LR' in col1_v
+00072fd0: 616c 2920 616e 6420 2827 524c 2720 696e  al) and ('RL' in
+00072fe0: 2063 6f6c 325f 7661 6c20 6f72 2027 4c52   col2_val or 'LR
+00072ff0: 2720 696e 2063 6f6c 325f 7661 6c29 3a0a  ' in col2_val):.
+00073000: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00073010: 696e 7565 0a20 2020 2020 2020 2065 6c69  inue.        eli
+00073020: 6620 2752 4c27 206e 6f74 2069 6e20 636f  f 'RL' not in co
+00073030: 6c31 5f76 616c 2061 6e64 2027 4c52 2720  l1_val and 'LR' 
+00073040: 6e6f 7420 696e 2063 6f6c 315f 7661 6c20  not in col1_val 
+00073050: 616e 6420 2752 4c27 206e 6f74 2069 6e20  and 'RL' not in 
+00073060: 636f 6c32 5f76 616c 2061 6e64 2027 4c52  col2_val and 'LR
+00073070: 2720 6e6f 7420 696e 2063 6f6c 325f 7661  ' not in col2_va
+00073080: 6c3a 0a20 2020 2020 2020 2020 2020 2069  l:.            i
+00073090: 6620 7369 7a65 3120 3c20 7369 7a65 323a  f size1 < size2:
+000730a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000730b0: 2064 665f 636f 7079 2e61 745b 696e 6465   df_copy.at[inde
+000730c0: 782c 2063 6f6c 315d 203d 2064 665f 636f  x, col1] = df_co
+000730d0: 7079 2e61 745b 696e 6465 782c 2063 6f6c  py.at[index, col
+000730e0: 325d 0a20 2020 2020 2020 2020 2020 2020  2].             
+000730f0: 2020 2064 665f 636f 7079 2e61 745b 696e     df_copy.at[in
+00073100: 6465 782c 2073 697a 655f 636f 6c31 5d20  dex, size_col1] 
+00073110: 3d20 6466 5f63 6f70 792e 6174 5b69 6e64  = df_copy.at[ind
+00073120: 6578 2c20 7369 7a65 5f63 6f6c 325d 0a20  ex, size_col2]. 
+00073130: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00073140: 665f 636f 7079 2e61 745b 696e 6465 782c  f_copy.at[index,
+00073150: 2069 6431 5d20 3d20 6466 5f63 6f70 792e   id1] = df_copy.
+00073160: 6174 5b69 6e64 6578 2c20 6964 325d 0a20  at[index, id2]. 
 00073170: 2020 2020 2020 2020 2020 2020 2020 2064                 d
 00073180: 665f 636f 7079 2e61 745b 696e 6465 782c  f_copy.at[index,
-00073190: 2069 6432 5d20 3d20 4e6f 6e65 0a20 2020   id2] = None.   
-000731a0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000731b0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000731c0: 665f 636f 7079 2e61 745b 696e 6465 782c  f_copy.at[index,
-000731d0: 2063 6f6c 325d 203d 204e 6f6e 650a 2020   col2] = None.  
-000731e0: 2020 2020 2020 2020 2020 2020 2020 6466                df
-000731f0: 5f63 6f70 792e 6174 5b69 6e64 6578 2c20  _copy.at[index, 
-00073200: 7369 7a65 5f63 6f6c 325d 203d 2030 0a20  size_col2] = 0. 
+00073190: 2073 697a 655f 636f 6c32 5d20 3d20 300a   size_col2] = 0.
+000731a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000731b0: 6466 5f63 6f70 792e 6174 5b69 6e64 6578  df_copy.at[index
+000731c0: 2c20 636f 6c32 5d20 3d20 4e6f 6e65 0a20  , col2] = None. 
+000731d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000731e0: 665f 636f 7079 2e61 745b 696e 6465 782c  f_copy.at[index,
+000731f0: 2069 6432 5d20 3d20 4e6f 6e65 0a20 2020   id2] = None.   
+00073200: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
 00073210: 2020 2020 2020 2020 2020 2020 2020 2064                 d
 00073220: 665f 636f 7079 2e61 745b 696e 6465 782c  f_copy.at[index,
-00073230: 2069 6432 5d20 3d20 4e6f 6e65 0a20 2020   id2] = None.   
-00073240: 2020 2020 2065 6c69 6620 2752 4c27 2069       elif 'RL' i
-00073250: 6e20 636f 6c31 5f76 616c 206f 7220 274c  n col1_val or 'L
-00073260: 5227 2069 6e20 636f 6c31 5f76 616c 3a0a  R' in col1_val:.
-00073270: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00073280: 697a 6531 203c 2073 697a 6532 3a0a 2020  ize1 < size2:.  
-00073290: 2020 2020 2020 2020 2020 2020 2020 6466                df
-000732a0: 5f63 6f70 792e 6174 5b69 6e64 6578 2c20  _copy.at[index, 
-000732b0: 636f 6c31 5d20 3d20 6466 5f63 6f70 792e  col1] = df_copy.
-000732c0: 6174 5b69 6e64 6578 2c20 636f 6c32 5d0a  at[index, col2].
-000732d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000732e0: 6466 5f63 6f70 792e 6174 5b69 6e64 6578  df_copy.at[index
-000732f0: 2c20 6964 315d 203d 2064 665f 636f 7079  , id1] = df_copy
-00073300: 2e61 745b 696e 6465 782c 2069 6432 5d0a  .at[index, id2].
-00073310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073320: 6466 5f63 6f70 792e 6174 5b69 6e64 6578  df_copy.at[index
-00073330: 2c20 7369 7a65 5f63 6f6c 315d 203d 2064  , size_col1] = d
-00073340: 665f 636f 7079 2e61 745b 696e 6465 782c  f_copy.at[index,
-00073350: 2073 697a 655f 636f 6c32 5d0a 2020 2020   size_col2].    
-00073360: 2020 2020 2020 2020 2020 2020 6466 5f63              df_c
-00073370: 6f70 792e 6174 5b69 6e64 6578 2c20 7369  opy.at[index, si
-00073380: 7a65 5f63 6f6c 325d 203d 2030 0a20 2020  ze_col2] = 0.   
-00073390: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-000733a0: 636f 7079 2e61 745b 696e 6465 782c 2063  copy.at[index, c
-000733b0: 6f6c 325d 203d 204e 6f6e 650a 2020 2020  ol2] = None.    
+00073230: 2063 6f6c 325d 203d 204e 6f6e 650a 2020   col2] = None.  
+00073240: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00073250: 5f63 6f70 792e 6174 5b69 6e64 6578 2c20  _copy.at[index, 
+00073260: 7369 7a65 5f63 6f6c 325d 203d 2030 0a20  size_col2] = 0. 
+00073270: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00073280: 665f 636f 7079 2e61 745b 696e 6465 782c  f_copy.at[index,
+00073290: 2069 6432 5d20 3d20 4e6f 6e65 0a20 2020   id2] = None.   
+000732a0: 2020 2020 2065 6c69 6620 2752 4c27 2069       elif 'RL' i
+000732b0: 6e20 636f 6c31 5f76 616c 206f 7220 274c  n col1_val or 'L
+000732c0: 5227 2069 6e20 636f 6c31 5f76 616c 3a0a  R' in col1_val:.
+000732d0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+000732e0: 697a 6531 203c 2073 697a 6532 3a0a 2020  ize1 < size2:.  
+000732f0: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00073300: 5f63 6f70 792e 6174 5b69 6e64 6578 2c20  _copy.at[index, 
+00073310: 636f 6c31 5d20 3d20 6466 5f63 6f70 792e  col1] = df_copy.
+00073320: 6174 5b69 6e64 6578 2c20 636f 6c32 5d0a  at[index, col2].
+00073330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073340: 6466 5f63 6f70 792e 6174 5b69 6e64 6578  df_copy.at[index
+00073350: 2c20 6964 315d 203d 2064 665f 636f 7079  , id1] = df_copy
+00073360: 2e61 745b 696e 6465 782c 2069 6432 5d0a  .at[index, id2].
+00073370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073380: 6466 5f63 6f70 792e 6174 5b69 6e64 6578  df_copy.at[index
+00073390: 2c20 7369 7a65 5f63 6f6c 315d 203d 2064  , size_col1] = d
+000733a0: 665f 636f 7079 2e61 745b 696e 6465 782c  f_copy.at[index,
+000733b0: 2073 697a 655f 636f 6c32 5d0a 2020 2020   size_col2].    
 000733c0: 2020 2020 2020 2020 2020 2020 6466 5f63              df_c
-000733d0: 6f70 792e 6174 5b69 6e64 6578 2c20 6964  opy.at[index, id
-000733e0: 325d 203d 204e 6f6e 650a 2020 2020 2020  2] = None.      
-000733f0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00073400: 2020 2020 2020 2020 2020 2020 6466 5f63              df_c
-00073410: 6f70 792e 6174 5b69 6e64 6578 2c20 636f  opy.at[index, co
-00073420: 6c32 5d20 3d20 4e6f 6e65 0a20 2020 2020  l2] = None.     
-00073430: 2020 2020 2020 2020 2020 2064 665f 636f             df_co
-00073440: 7079 2e61 745b 696e 6465 782c 2069 6432  py.at[index, id2
-00073450: 5d20 3d20 4e6f 6e65 0a20 2020 2020 2020  ] = None.       
-00073460: 2020 2020 2020 2020 2064 665f 636f 7079           df_copy
-00073470: 2e61 745b 696e 6465 782c 2073 697a 655f  .at[index, size_
-00073480: 636f 6c32 5d20 3d20 300a 2020 2020 2020  col2] = 0.      
-00073490: 2020 656c 6966 2027 524c 2720 696e 2063    elif 'RL' in c
-000734a0: 6f6c 325f 7661 6c20 6f72 2027 4c52 2720  ol2_val or 'LR' 
-000734b0: 696e 2063 6f6c 325f 7661 6c3a 0a20 2020  in col2_val:.   
-000734c0: 2020 2020 2020 2020 2069 6620 7369 7a65           if size
-000734d0: 3220 3c20 7369 7a65 313a 0a20 2020 2020  2 < size1:.     
-000734e0: 2020 2020 2020 2020 2020 2064 665f 636f             df_co
-000734f0: 7079 2e61 745b 696e 6465 782c 2069 6432  py.at[index, id2
-00073500: 5d20 3d20 4e6f 6e65 0a20 2020 2020 2020  ] = None.       
-00073510: 2020 2020 2020 2020 2064 665f 636f 7079           df_copy
-00073520: 2e61 745b 696e 6465 782c 2063 6f6c 325d  .at[index, col2]
-00073530: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00073540: 2020 2020 2020 2020 6466 5f63 6f70 792e          df_copy.
-00073550: 6174 5b69 6e64 6578 2c20 7369 7a65 5f63  at[index, size_c
-00073560: 6f6c 325d 203d 2030 0a20 2020 2020 2020  ol2] = 0.       
-00073570: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00073580: 2020 2020 2020 2020 2020 2064 665f 636f             df_co
-00073590: 7079 2e61 745b 696e 6465 782c 2063 6f6c  py.at[index, col
-000735a0: 315d 203d 2064 665f 636f 7079 2e61 745b  1] = df_copy.at[
-000735b0: 696e 6465 782c 2063 6f6c 325d 0a20 2020  index, col2].   
-000735c0: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-000735d0: 636f 7079 2e61 745b 696e 6465 782c 2069  copy.at[index, i
-000735e0: 6431 5d20 3d20 6466 5f63 6f70 792e 6174  d1] = df_copy.at
-000735f0: 5b69 6e64 6578 2c20 6964 325d 0a20 2020  [index, id2].   
-00073600: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00073610: 636f 7079 2e61 745b 696e 6465 782c 2073  copy.at[index, s
-00073620: 697a 655f 636f 6c31 5d20 3d20 6466 5f63  ize_col1] = df_c
-00073630: 6f70 792e 6174 5b69 6e64 6578 2c20 7369  opy.at[index, si
-00073640: 7a65 5f63 6f6c 325d 0a20 2020 2020 2020  ze_col2].       
-00073650: 2020 2020 2020 2020 2064 665f 636f 7079           df_copy
-00073660: 2e61 745b 696e 6465 782c 2073 697a 655f  .at[index, size_
-00073670: 636f 6c32 5d20 3d20 300a 2020 2020 2020  col2] = 0.      
-00073680: 2020 2020 2020 2020 2020 6466 5f63 6f70            df_cop
-00073690: 792e 6174 5b69 6e64 6578 2c20 636f 6c32  y.at[index, col2
-000736a0: 5d20 3d20 4e6f 6e65 2020 2020 0a20 2020  ] = None    .   
-000736b0: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-000736c0: 636f 7079 2e61 745b 696e 6465 782c 2069  copy.at[index, i
-000736d0: 6432 5d20 3d20 4e6f 6e65 2020 2020 0a20  d2] = None    . 
-000736e0: 2020 2072 6574 7572 6e20 6466 5f63 6f70     return df_cop
-000736f0: 790a 0a0a 6465 6620 7265 6e61 6d65 6974  y...def renameit
-00073700: 2864 662c 206f 6c64 5f63 6f6c 5f6e 616d  (df, old_col_nam
-00073710: 652c 206e 6577 5f63 6f6c 5f6e 616d 6529  e, new_col_name)
-00073720: 3a0a 2020 2020 2222 220a 2020 2020 5265  :.    """.    Re
-00073730: 6e61 6d65 7320 6120 636f 6c75 6d6e 2069  names a column i
-00073740: 6e20 6120 7061 6e64 6173 2044 6174 6146  n a pandas DataF
-00073750: 7261 6d65 2069 6e20 706c 6163 652e 2052  rame in place. R
-00073760: 6169 7365 7320 616e 2065 7272 6f72 2069  aises an error i
-00073770: 6620 7468 6520 7370 6563 6966 6965 6420  f the specified 
-00073780: 6f6c 6420 636f 6c75 6d6e 206e 616d 6520  old column name 
-00073790: 646f 6573 206e 6f74 2065 7869 7374 2e0a  does not exist..
-000737a0: 0a20 2020 2050 6172 616d 6574 6572 733a  .    Parameters:
-000737b0: 0a20 2020 202d 2064 663a 2070 616e 6461  .    - df: panda
-000737c0: 732e 4461 7461 4672 616d 650a 2020 2020  s.DataFrame.    
-000737d0: 2020 2020 5468 6520 4461 7461 4672 616d      The DataFram
-000737e0: 6520 696e 2077 6869 6368 2074 6865 2063  e in which the c
-000737f0: 6f6c 756d 6e20 6973 2074 6f20 6265 2072  olumn is to be r
-00073800: 656e 616d 6564 2e0a 2020 2020 2d20 6f6c  enamed..    - ol
-00073810: 645f 636f 6c5f 6e61 6d65 3a20 7374 720a  d_col_name: str.
-00073820: 2020 2020 2020 2020 5468 6520 6375 7272          The curr
-00073830: 656e 7420 6e61 6d65 206f 6620 7468 6520  ent name of the 
-00073840: 636f 6c75 6d6e 2074 6f20 6265 2072 656e  column to be ren
-00073850: 616d 6564 2e0a 2020 2020 2d20 6e65 775f  amed..    - new_
-00073860: 636f 6c5f 6e61 6d65 3a20 7374 720a 2020  col_name: str.  
-00073870: 2020 2020 2020 5468 6520 6e65 7720 6e61        The new na
-00073880: 6d65 2066 6f72 2074 6865 2063 6f6c 756d  me for the colum
-00073890: 6e2e 0a20 2020 200a 2020 2020 5261 6973  n..    .    Rais
-000738a0: 6573 3a0a 2020 2020 2d20 5661 6c75 6545  es:.    - ValueE
-000738b0: 7272 6f72 3a20 4966 2074 6865 206f 6c64  rror: If the old
-000738c0: 2063 6f6c 756d 6e20 6e61 6d65 2064 6f65   column name doe
-000738d0: 7320 6e6f 7420 6578 6973 7420 696e 2074  s not exist in t
-000738e0: 6865 2044 6174 6146 7261 6d65 2e0a 2020  he DataFrame..  
-000738f0: 2020 0a20 2020 2052 6574 7572 6e73 3a0a    .    Returns:.
-00073900: 2020 2020 4e6f 6e65 0a20 2020 2022 2222      None.    """
-00073910: 0a20 2020 2069 6d70 6f72 7420 7761 726e  .    import warn
-00073920: 696e 6773 0a20 2020 2023 2043 6865 636b  ings.    # Check
-00073930: 2069 6620 7468 6520 6f6c 6420 636f 6c75   if the old colu
-00073940: 6d6e 206e 616d 6520 6578 6973 7473 2069  mn name exists i
-00073950: 6e20 7468 6520 4461 7461 4672 616d 650a  n the DataFrame.
-00073960: 2020 2020 6966 206f 6c64 5f63 6f6c 5f6e      if old_col_n
-00073970: 616d 6520 6e6f 7420 696e 2064 662e 636f  ame not in df.co
-00073980: 6c75 6d6e 733a 0a20 2020 2020 2020 2077  lumns:.        w
-00073990: 6172 6e69 6e67 732e 7761 726e 2866 2254  arnings.warn(f"T
-000739a0: 6865 2063 6f6c 756d 6e20 277b 6f6c 645f  he column '{old_
-000739b0: 636f 6c5f 6e61 6d65 7d27 2064 6f65 7320  col_name}' does 
-000739c0: 6e6f 7420 6578 6973 7420 696e 2074 6865  not exist in the
-000739d0: 2044 6174 6146 7261 6d65 2e22 290a 2020   DataFrame.").  
-000739e0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-000739f0: 200a 2020 2020 2320 5072 6f63 6565 6420   .    # Proceed 
-00073a00: 7769 7468 2072 656e 616d 696e 6720 7468  with renaming th
-00073a10: 6520 636f 6c75 6d6e 2069 6620 6974 2065  e column if it e
-00073a20: 7869 7374 730a 2020 2020 6466 2e72 656e  xists.    df.ren
-00073a30: 616d 6528 636f 6c75 6d6e 733d 7b6f 6c64  ame(columns={old
-00073a40: 5f63 6f6c 5f6e 616d 653a 206e 6577 5f63  _col_name: new_c
-00073a50: 6f6c 5f6e 616d 657d 2c20 696e 706c 6163  ol_name}, inplac
-00073a60: 653d 5472 7565 290a 0a0a 6465 6620 6d6d  e=True)...def mm
-00073a70: 5f6d 6174 6368 5f62 795f 7163 5f73 636f  _match_by_qc_sco
-00073a80: 7269 6e67 5f61 6c6c 2820 7163 5f64 6174  ring_all( qc_dat
-00073a90: 6166 7261 6d65 2c20 6669 785f 4c52 524c  aframe, fix_LRRL
-00073aa0: 3d54 7275 652c 2076 6572 626f 7365 3d54  =True, verbose=T
-00073ab0: 7275 6520 293a 0a20 2020 2022 2222 0a20  rue ):.    """. 
-00073ac0: 2020 2050 726f 6365 7373 6573 2061 2071     Processes a q
-00073ad0: 7561 6c69 7479 2063 6f6e 7472 6f6c 2028  uality control (
-00073ae0: 5143 2920 4461 7461 4672 616d 6520 746f  QC) DataFrame to
-00073af0: 2070 6572 666f 726d 206d 6f64 616c 6974   perform modalit
-00073b00: 792d 7370 6563 6966 6963 206d 6174 6368  y-specific match
-00073b10: 696e 6720 616e 6420 6669 6c74 6572 696e  ing and filterin
-00073b20: 6720 6261 7365 640a 2020 2020 6f6e 2070  g based.    on p
-00073b30: 7265 6465 6669 6e65 6420 6372 6974 6572  redefined criter
-00073b40: 6961 2c20 6f70 7469 6d69 7a69 6e67 2066  ia, optimizing f
-00073b50: 6f72 206d 696e 696d 616c 206f 7574 6c69  or minimal outli
-00073b60: 6572 7320 616e 6420 6e6f 6973 652c 2061  ers and noise, a
-00073b70: 6e64 206d 6178 696d 616c 2073 6967 6e61  nd maximal signa
-00073b80: 6c2d 746f 2d6e 6f69 7365 2072 6174 696f  l-to-noise ratio
-00073b90: 2028 534e 5229 2c0a 2020 2020 6578 7065   (SNR),.    expe
-00073ba0: 6374 6564 2076 616c 7565 206f 6620 7261  cted value of ra
-00073bb0: 6e64 6f6d 6e65 7373 2028 4556 5229 2c20  ndomness (EVR), 
-00073bc0: 616e 6420 6469 6d65 6e73 696f 6e61 6c69  and dimensionali
-00073bd0: 7479 2074 696d 6520 2864 696d 7429 2e0a  ty time (dimt)..
-00073be0: 0a20 2020 2054 6869 7320 6675 6e63 7469  .    This functi
-00073bf0: 6f6e 2069 7465 7261 7469 7665 6c79 206d  on iteratively m
-00073c00: 6174 6368 6573 2064 6174 6166 7261 6d65  atches dataframe
-00073c10: 7320 6465 7269 7665 6420 6672 6f6d 2074  s derived from t
-00073c20: 6865 2051 4320 6461 7461 6672 616d 6520  he QC dataframe 
-00073c30: 666f 7220 6469 6666 6572 656e 7420 696d  for different im
-00073c40: 6167 696e 6720 6d6f 6461 6c69 7469 6573  aging modalities
-00073c50: 2c0a 2020 2020 6170 706c 7969 6e67 2061  ,.    applying a
-00073c60: 2073 6572 6965 7320 6f66 2066 696c 7465   series of filte
-00073c70: 7273 2074 6f20 7365 6c65 6374 2074 6865  rs to select the
-00073c80: 2062 6573 7420 6d61 7463 6865 7320 6261   best matches ba
-00073c90: 7365 6420 6f6e 2074 6865 2051 4320 6d65  sed on the QC me
-00073ca0: 7472 6963 732e 204d 6174 6368 6573 2061  trics. Matches a
-00073cb0: 7265 206d 6164 6520 7769 7468 0a20 2020  re made with.   
-00073cc0: 2063 6f6e 7369 6465 7261 7469 6f6e 2074   consideration t
-00073cd0: 6f20 6d69 6e69 6d69 7a65 206f 7574 6c69  o minimize outli
-00073ce0: 6572 206c 6f6f 7020 616e 6420 6e6f 6973  er loop and nois
-00073cf0: 652c 2077 6869 6c65 206d 6178 696d 697a  e, while maximiz
-00073d00: 696e 6720 534e 522c 2045 5652 2c20 616e  ing SNR, EVR, an
-00073d10: 6420 6469 6d74 2066 6f72 2065 6163 6820  d dimt for each 
-00073d20: 6d6f 6461 6c69 7479 2e0a 0a20 2020 2050  modality...    P
-00073d30: 6172 616d 6574 6572 733a 0a20 2020 202d  arameters:.    -
-00073d40: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7163  ---------.    qc
-00073d50: 5f64 6174 6166 7261 6d65 203a 2070 616e  _dataframe : pan
-00073d60: 6461 732e 4461 7461 4672 616d 650a 2020  das.DataFrame.  
-00073d70: 2020 2020 2020 5468 6520 4461 7461 4672        The DataFr
-00073d80: 616d 6520 636f 6e74 6169 6e69 6e67 2051  ame containing Q
-00073d90: 4320 6d65 7472 6963 7320 666f 7220 6469  C metrics for di
-00073da0: 6666 6572 656e 7420 6d6f 6461 6c69 7469  fferent modaliti
-00073db0: 6573 2061 6e64 2069 6d61 6769 6e67 2064  es and imaging d
-00073dc0: 6174 612e 0a20 2020 2066 6978 5f4c 5252  ata..    fix_LRR
-00073dd0: 4c20 3a20 626f 6f6c 2c20 6f70 7469 6f6e  L : bool, option
-00073de0: 616c 0a0a 2020 2020 7665 7262 6f73 6520  al..    verbose 
-00073df0: 3a20 626f 6f6c 2c20 6f70 7469 6f6e 616c  : bool, optional
-00073e00: 0a20 2020 2020 2020 2049 6620 5472 7565  .        If True
-00073e10: 2c20 7072 696e 7473 2074 6865 2070 726f  , prints the pro
-00073e20: 6772 6573 7320 616e 6420 7468 6520 7368  gress and the sh
-00073e30: 6170 6520 6f66 2074 6865 2044 6174 6146  ape of the DataF
-00073e40: 7261 6d65 2062 6569 6e67 2070 726f 6365  rame being proce
-00073e50: 7373 6564 2069 6e20 6561 6368 2073 7465  ssed in each ste
-00073e60: 702e 0a0a 2020 2020 5072 6f63 6573 733a  p...    Process:
-00073e70: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-00073e80: 2031 2e20 5374 616e 6461 7264 697a 6573   1. Standardizes
-00073e90: 206d 6f64 616c 6974 6965 7320 6279 206d   modalities by m
-00073ea0: 6572 6769 6e67 2044 5449 2d72 656c 6174  erging DTI-relat
-00073eb0: 6564 2065 6e74 7269 6573 2e0a 2020 2020  ed entries..    
-00073ec0: 322e 2043 6f6e 7665 7274 7320 7370 6563  2. Converts spec
-00073ed0: 6966 6963 2063 6f6c 756d 6e73 2074 6f20  ific columns to 
-00073ee0: 6170 7072 6f70 7269 6174 6520 6461 7461  appropriate data
-00073ef0: 2074 7970 6573 2066 6f72 2070 726f 6365   types for proce
-00073f00: 7373 696e 672e 0a20 2020 2033 2e20 5065  ssing..    3. Pe
-00073f10: 7266 6f72 6d73 206d 6f64 616c 6974 792d  rforms modality-
-00073f20: 7370 6563 6966 6963 206d 6174 6368 696e  specific matchin
-00073f30: 6720 616e 6420 6669 6c74 6572 696e 6720  g and filtering 
-00073f40: 6261 7365 6420 6f6e 2074 6865 206f 7574  based on the out
-00073f50: 6c69 6572 2063 6f6c 756d 6e20 616e 6420  lier column and 
-00073f60: 6372 6974 6572 6961 2066 6f72 2065 6163  criteria for eac
-00073f70: 6820 6d6f 6461 6c69 7479 2e0a 2020 2020  h modality..    
-00073f80: 342e 2049 7465 7261 7469 7665 6c79 2070  4. Iteratively p
-00073f90: 726f 6365 7373 6573 2075 6e6d 6174 6368  rocesses unmatch
-00073fa0: 6564 2064 6174 6120 666f 7220 7072 6564  ed data for pred
-00073fb0: 6566 696e 6564 206d 6f64 616c 6974 6965  efined modalitie
-00073fc0: 7320 7769 7468 2073 7065 6369 6669 6320  s with specific 
-00073fd0: 7072 6566 6978 6573 2074 6f20 6669 6e64  prefixes to find
-00073fe0: 2066 7572 7468 6572 206d 6174 6368 6573   further matches
-00073ff0: 2e0a 2020 2020 0a20 2020 2052 6574 7572  ..    .    Retur
-00074000: 6e73 3a0a 2020 2020 2d2d 2d2d 2d2d 2d0a  ns:.    -------.
-00074010: 2020 2020 7061 6e64 6173 2e44 6174 6146      pandas.DataF
-00074020: 7261 6d65 0a20 2020 2020 2020 2054 6865  rame.        The
-00074030: 206d 6174 6368 6564 2061 6e64 2066 696c   matched and fil
-00074040: 7465 7265 6420 4461 7461 4672 616d 6520  tered DataFrame 
-00074050: 6166 7465 7220 6170 706c 7969 6e67 2061  after applying a
-00074060: 6c6c 2051 4320 7363 6f72 696e 6720 616e  ll QC scoring an
-00074070: 6420 6d61 7463 6869 6e67 206f 7065 7261  d matching opera
-00074080: 7469 6f6e 7320 6163 726f 7373 2073 7065  tions across spe
-00074090: 6369 6669 6564 206d 6f64 616c 6974 6965  cified modalitie
-000740a0: 732e 0a0a 2020 2020 2222 220a 2020 2020  s...    """.    
-000740b0: 7163 5f64 6174 6166 7261 6d65 5b27 6d6f  qc_dataframe['mo
-000740c0: 6461 6c69 7479 275d 203d 2071 635f 6461  dality'] = qc_da
-000740d0: 7461 6672 616d 655b 276d 6f64 616c 6974  taframe['modalit
-000740e0: 7927 5d2e 7265 706c 6163 6528 5b27 4454  y'].replace(['DT
-000740f0: 4964 7769 272c 2027 4454 4962 3027 5d2c  Idwi', 'DTIb0'],
-00074100: 2027 4454 4927 2c20 7265 6765 783d 5472   'DTI', regex=Tr
-00074110: 7565 290a 2020 2020 7163 5f64 6174 6166  ue).    qc_dataf
-00074120: 7261 6d65 5b27 6669 6c65 6e61 6d65 275d  rame['filename']
-00074130: 3d71 635f 6461 7461 6672 616d 655b 2766  =qc_dataframe['f
-00074140: 696c 656e 616d 6527 5d2e 6173 7479 7065  ilename'].astype
-00074150: 2873 7472 290a 2020 2020 7163 5f64 6174  (str).    qc_dat
-00074160: 6166 7261 6d65 5b27 6f6c 5f6c 6f6f 7027  aframe['ol_loop'
-00074170: 5d3d 7163 5f64 6174 6166 7261 6d65 5b27  ]=qc_dataframe['
-00074180: 6f6c 5f6c 6f6f 7027 5d2e 6173 7479 7065  ol_loop'].astype
-00074190: 2866 6c6f 6174 290a 2020 2020 7163 5f64  (float).    qc_d
-000741a0: 6174 6166 7261 6d65 5b27 6f6c 5f6c 6f66  ataframe['ol_lof
-000741b0: 275d 3d71 635f 6461 7461 6672 616d 655b  ']=qc_dataframe[
-000741c0: 276f 6c5f 6c6f 6627 5d2e 6173 7479 7065  'ol_lof'].astype
-000741d0: 2866 6c6f 6174 290a 2020 2020 7163 5f64  (float).    qc_d
-000741e0: 6174 6166 7261 6d65 5b27 6f6c 5f6c 6f66  ataframe['ol_lof
-000741f0: 5f64 6563 6973 696f 6e27 5d3d 7163 5f64  _decision']=qc_d
+000733d0: 6f70 792e 6174 5b69 6e64 6578 2c20 7369  opy.at[index, si
+000733e0: 7a65 5f63 6f6c 325d 203d 2030 0a20 2020  ze_col2] = 0.   
+000733f0: 2020 2020 2020 2020 2020 2020 2064 665f               df_
+00073400: 636f 7079 2e61 745b 696e 6465 782c 2063  copy.at[index, c
+00073410: 6f6c 325d 203d 204e 6f6e 650a 2020 2020  ol2] = None.    
+00073420: 2020 2020 2020 2020 2020 2020 6466 5f63              df_c
+00073430: 6f70 792e 6174 5b69 6e64 6578 2c20 6964  opy.at[index, id
+00073440: 325d 203d 204e 6f6e 650a 2020 2020 2020  2] = None.      
+00073450: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00073460: 2020 2020 2020 2020 2020 2020 6466 5f63              df_c
+00073470: 6f70 792e 6174 5b69 6e64 6578 2c20 636f  opy.at[index, co
+00073480: 6c32 5d20 3d20 4e6f 6e65 0a20 2020 2020  l2] = None.     
+00073490: 2020 2020 2020 2020 2020 2064 665f 636f             df_co
+000734a0: 7079 2e61 745b 696e 6465 782c 2069 6432  py.at[index, id2
+000734b0: 5d20 3d20 4e6f 6e65 0a20 2020 2020 2020  ] = None.       
+000734c0: 2020 2020 2020 2020 2064 665f 636f 7079           df_copy
+000734d0: 2e61 745b 696e 6465 782c 2073 697a 655f  .at[index, size_
+000734e0: 636f 6c32 5d20 3d20 300a 2020 2020 2020  col2] = 0.      
+000734f0: 2020 656c 6966 2027 524c 2720 696e 2063    elif 'RL' in c
+00073500: 6f6c 325f 7661 6c20 6f72 2027 4c52 2720  ol2_val or 'LR' 
+00073510: 696e 2063 6f6c 325f 7661 6c3a 0a20 2020  in col2_val:.   
+00073520: 2020 2020 2020 2020 2069 6620 7369 7a65           if size
+00073530: 3220 3c20 7369 7a65 313a 0a20 2020 2020  2 < size1:.     
+00073540: 2020 2020 2020 2020 2020 2064 665f 636f             df_co
+00073550: 7079 2e61 745b 696e 6465 782c 2069 6432  py.at[index, id2
+00073560: 5d20 3d20 4e6f 6e65 0a20 2020 2020 2020  ] = None.       
+00073570: 2020 2020 2020 2020 2064 665f 636f 7079           df_copy
+00073580: 2e61 745b 696e 6465 782c 2063 6f6c 325d  .at[index, col2]
+00073590: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+000735a0: 2020 2020 2020 2020 6466 5f63 6f70 792e          df_copy.
+000735b0: 6174 5b69 6e64 6578 2c20 7369 7a65 5f63  at[index, size_c
+000735c0: 6f6c 325d 203d 2030 0a20 2020 2020 2020  ol2] = 0.       
+000735d0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000735e0: 2020 2020 2020 2020 2020 2064 665f 636f             df_co
+000735f0: 7079 2e61 745b 696e 6465 782c 2063 6f6c  py.at[index, col
+00073600: 315d 203d 2064 665f 636f 7079 2e61 745b  1] = df_copy.at[
+00073610: 696e 6465 782c 2063 6f6c 325d 0a20 2020  index, col2].   
+00073620: 2020 2020 2020 2020 2020 2020 2064 665f               df_
+00073630: 636f 7079 2e61 745b 696e 6465 782c 2069  copy.at[index, i
+00073640: 6431 5d20 3d20 6466 5f63 6f70 792e 6174  d1] = df_copy.at
+00073650: 5b69 6e64 6578 2c20 6964 325d 0a20 2020  [index, id2].   
+00073660: 2020 2020 2020 2020 2020 2020 2064 665f               df_
+00073670: 636f 7079 2e61 745b 696e 6465 782c 2073  copy.at[index, s
+00073680: 697a 655f 636f 6c31 5d20 3d20 6466 5f63  ize_col1] = df_c
+00073690: 6f70 792e 6174 5b69 6e64 6578 2c20 7369  opy.at[index, si
+000736a0: 7a65 5f63 6f6c 325d 0a20 2020 2020 2020  ze_col2].       
+000736b0: 2020 2020 2020 2020 2064 665f 636f 7079           df_copy
+000736c0: 2e61 745b 696e 6465 782c 2073 697a 655f  .at[index, size_
+000736d0: 636f 6c32 5d20 3d20 300a 2020 2020 2020  col2] = 0.      
+000736e0: 2020 2020 2020 2020 2020 6466 5f63 6f70            df_cop
+000736f0: 792e 6174 5b69 6e64 6578 2c20 636f 6c32  y.at[index, col2
+00073700: 5d20 3d20 4e6f 6e65 2020 2020 0a20 2020  ] = None    .   
+00073710: 2020 2020 2020 2020 2020 2020 2064 665f               df_
+00073720: 636f 7079 2e61 745b 696e 6465 782c 2069  copy.at[index, i
+00073730: 6432 5d20 3d20 4e6f 6e65 2020 2020 0a20  d2] = None    . 
+00073740: 2020 2072 6574 7572 6e20 6466 5f63 6f70     return df_cop
+00073750: 790a 0a0a 6465 6620 7265 6e61 6d65 6974  y...def renameit
+00073760: 2864 662c 206f 6c64 5f63 6f6c 5f6e 616d  (df, old_col_nam
+00073770: 652c 206e 6577 5f63 6f6c 5f6e 616d 6529  e, new_col_name)
+00073780: 3a0a 2020 2020 2222 220a 2020 2020 5265  :.    """.    Re
+00073790: 6e61 6d65 7320 6120 636f 6c75 6d6e 2069  names a column i
+000737a0: 6e20 6120 7061 6e64 6173 2044 6174 6146  n a pandas DataF
+000737b0: 7261 6d65 2069 6e20 706c 6163 652e 2052  rame in place. R
+000737c0: 6169 7365 7320 616e 2065 7272 6f72 2069  aises an error i
+000737d0: 6620 7468 6520 7370 6563 6966 6965 6420  f the specified 
+000737e0: 6f6c 6420 636f 6c75 6d6e 206e 616d 6520  old column name 
+000737f0: 646f 6573 206e 6f74 2065 7869 7374 2e0a  does not exist..
+00073800: 0a20 2020 2050 6172 616d 6574 6572 733a  .    Parameters:
+00073810: 0a20 2020 202d 2064 663a 2070 616e 6461  .    - df: panda
+00073820: 732e 4461 7461 4672 616d 650a 2020 2020  s.DataFrame.    
+00073830: 2020 2020 5468 6520 4461 7461 4672 616d      The DataFram
+00073840: 6520 696e 2077 6869 6368 2074 6865 2063  e in which the c
+00073850: 6f6c 756d 6e20 6973 2074 6f20 6265 2072  olumn is to be r
+00073860: 656e 616d 6564 2e0a 2020 2020 2d20 6f6c  enamed..    - ol
+00073870: 645f 636f 6c5f 6e61 6d65 3a20 7374 720a  d_col_name: str.
+00073880: 2020 2020 2020 2020 5468 6520 6375 7272          The curr
+00073890: 656e 7420 6e61 6d65 206f 6620 7468 6520  ent name of the 
+000738a0: 636f 6c75 6d6e 2074 6f20 6265 2072 656e  column to be ren
+000738b0: 616d 6564 2e0a 2020 2020 2d20 6e65 775f  amed..    - new_
+000738c0: 636f 6c5f 6e61 6d65 3a20 7374 720a 2020  col_name: str.  
+000738d0: 2020 2020 2020 5468 6520 6e65 7720 6e61        The new na
+000738e0: 6d65 2066 6f72 2074 6865 2063 6f6c 756d  me for the colum
+000738f0: 6e2e 0a20 2020 200a 2020 2020 5261 6973  n..    .    Rais
+00073900: 6573 3a0a 2020 2020 2d20 5661 6c75 6545  es:.    - ValueE
+00073910: 7272 6f72 3a20 4966 2074 6865 206f 6c64  rror: If the old
+00073920: 2063 6f6c 756d 6e20 6e61 6d65 2064 6f65   column name doe
+00073930: 7320 6e6f 7420 6578 6973 7420 696e 2074  s not exist in t
+00073940: 6865 2044 6174 6146 7261 6d65 2e0a 2020  he DataFrame..  
+00073950: 2020 0a20 2020 2052 6574 7572 6e73 3a0a    .    Returns:.
+00073960: 2020 2020 4e6f 6e65 0a20 2020 2022 2222      None.    """
+00073970: 0a20 2020 2069 6d70 6f72 7420 7761 726e  .    import warn
+00073980: 696e 6773 0a20 2020 2023 2043 6865 636b  ings.    # Check
+00073990: 2069 6620 7468 6520 6f6c 6420 636f 6c75   if the old colu
+000739a0: 6d6e 206e 616d 6520 6578 6973 7473 2069  mn name exists i
+000739b0: 6e20 7468 6520 4461 7461 4672 616d 650a  n the DataFrame.
+000739c0: 2020 2020 6966 206f 6c64 5f63 6f6c 5f6e      if old_col_n
+000739d0: 616d 6520 6e6f 7420 696e 2064 662e 636f  ame not in df.co
+000739e0: 6c75 6d6e 733a 0a20 2020 2020 2020 2077  lumns:.        w
+000739f0: 6172 6e69 6e67 732e 7761 726e 2866 2254  arnings.warn(f"T
+00073a00: 6865 2063 6f6c 756d 6e20 277b 6f6c 645f  he column '{old_
+00073a10: 636f 6c5f 6e61 6d65 7d27 2064 6f65 7320  col_name}' does 
+00073a20: 6e6f 7420 6578 6973 7420 696e 2074 6865  not exist in the
+00073a30: 2044 6174 6146 7261 6d65 2e22 290a 2020   DataFrame.").  
+00073a40: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+00073a50: 200a 2020 2020 2320 5072 6f63 6565 6420   .    # Proceed 
+00073a60: 7769 7468 2072 656e 616d 696e 6720 7468  with renaming th
+00073a70: 6520 636f 6c75 6d6e 2069 6620 6974 2065  e column if it e
+00073a80: 7869 7374 730a 2020 2020 6466 2e72 656e  xists.    df.ren
+00073a90: 616d 6528 636f 6c75 6d6e 733d 7b6f 6c64  ame(columns={old
+00073aa0: 5f63 6f6c 5f6e 616d 653a 206e 6577 5f63  _col_name: new_c
+00073ab0: 6f6c 5f6e 616d 657d 2c20 696e 706c 6163  ol_name}, inplac
+00073ac0: 653d 5472 7565 290a 0a0a 6465 6620 6d6d  e=True)...def mm
+00073ad0: 5f6d 6174 6368 5f62 795f 7163 5f73 636f  _match_by_qc_sco
+00073ae0: 7269 6e67 5f61 6c6c 2820 7163 5f64 6174  ring_all( qc_dat
+00073af0: 6166 7261 6d65 2c20 6669 785f 4c52 524c  aframe, fix_LRRL
+00073b00: 3d54 7275 652c 2076 6572 626f 7365 3d54  =True, verbose=T
+00073b10: 7275 6520 293a 0a20 2020 2022 2222 0a20  rue ):.    """. 
+00073b20: 2020 2050 726f 6365 7373 6573 2061 2071     Processes a q
+00073b30: 7561 6c69 7479 2063 6f6e 7472 6f6c 2028  uality control (
+00073b40: 5143 2920 4461 7461 4672 616d 6520 746f  QC) DataFrame to
+00073b50: 2070 6572 666f 726d 206d 6f64 616c 6974   perform modalit
+00073b60: 792d 7370 6563 6966 6963 206d 6174 6368  y-specific match
+00073b70: 696e 6720 616e 6420 6669 6c74 6572 696e  ing and filterin
+00073b80: 6720 6261 7365 640a 2020 2020 6f6e 2070  g based.    on p
+00073b90: 7265 6465 6669 6e65 6420 6372 6974 6572  redefined criter
+00073ba0: 6961 2c20 6f70 7469 6d69 7a69 6e67 2066  ia, optimizing f
+00073bb0: 6f72 206d 696e 696d 616c 206f 7574 6c69  or minimal outli
+00073bc0: 6572 7320 616e 6420 6e6f 6973 652c 2061  ers and noise, a
+00073bd0: 6e64 206d 6178 696d 616c 2073 6967 6e61  nd maximal signa
+00073be0: 6c2d 746f 2d6e 6f69 7365 2072 6174 696f  l-to-noise ratio
+00073bf0: 2028 534e 5229 2c0a 2020 2020 6578 7065   (SNR),.    expe
+00073c00: 6374 6564 2076 616c 7565 206f 6620 7261  cted value of ra
+00073c10: 6e64 6f6d 6e65 7373 2028 4556 5229 2c20  ndomness (EVR), 
+00073c20: 616e 6420 6469 6d65 6e73 696f 6e61 6c69  and dimensionali
+00073c30: 7479 2074 696d 6520 2864 696d 7429 2e0a  ty time (dimt)..
+00073c40: 0a20 2020 2054 6869 7320 6675 6e63 7469  .    This functi
+00073c50: 6f6e 2069 7465 7261 7469 7665 6c79 206d  on iteratively m
+00073c60: 6174 6368 6573 2064 6174 6166 7261 6d65  atches dataframe
+00073c70: 7320 6465 7269 7665 6420 6672 6f6d 2074  s derived from t
+00073c80: 6865 2051 4320 6461 7461 6672 616d 6520  he QC dataframe 
+00073c90: 666f 7220 6469 6666 6572 656e 7420 696d  for different im
+00073ca0: 6167 696e 6720 6d6f 6461 6c69 7469 6573  aging modalities
+00073cb0: 2c0a 2020 2020 6170 706c 7969 6e67 2061  ,.    applying a
+00073cc0: 2073 6572 6965 7320 6f66 2066 696c 7465   series of filte
+00073cd0: 7273 2074 6f20 7365 6c65 6374 2074 6865  rs to select the
+00073ce0: 2062 6573 7420 6d61 7463 6865 7320 6261   best matches ba
+00073cf0: 7365 6420 6f6e 2074 6865 2051 4320 6d65  sed on the QC me
+00073d00: 7472 6963 732e 204d 6174 6368 6573 2061  trics. Matches a
+00073d10: 7265 206d 6164 6520 7769 7468 0a20 2020  re made with.   
+00073d20: 2063 6f6e 7369 6465 7261 7469 6f6e 2074   consideration t
+00073d30: 6f20 6d69 6e69 6d69 7a65 206f 7574 6c69  o minimize outli
+00073d40: 6572 206c 6f6f 7020 616e 6420 6e6f 6973  er loop and nois
+00073d50: 652c 2077 6869 6c65 206d 6178 696d 697a  e, while maximiz
+00073d60: 696e 6720 534e 522c 2045 5652 2c20 616e  ing SNR, EVR, an
+00073d70: 6420 6469 6d74 2066 6f72 2065 6163 6820  d dimt for each 
+00073d80: 6d6f 6461 6c69 7479 2e0a 0a20 2020 2050  modality...    P
+00073d90: 6172 616d 6574 6572 733a 0a20 2020 202d  arameters:.    -
+00073da0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7163  ---------.    qc
+00073db0: 5f64 6174 6166 7261 6d65 203a 2070 616e  _dataframe : pan
+00073dc0: 6461 732e 4461 7461 4672 616d 650a 2020  das.DataFrame.  
+00073dd0: 2020 2020 2020 5468 6520 4461 7461 4672        The DataFr
+00073de0: 616d 6520 636f 6e74 6169 6e69 6e67 2051  ame containing Q
+00073df0: 4320 6d65 7472 6963 7320 666f 7220 6469  C metrics for di
+00073e00: 6666 6572 656e 7420 6d6f 6461 6c69 7469  fferent modaliti
+00073e10: 6573 2061 6e64 2069 6d61 6769 6e67 2064  es and imaging d
+00073e20: 6174 612e 0a20 2020 2066 6978 5f4c 5252  ata..    fix_LRR
+00073e30: 4c20 3a20 626f 6f6c 2c20 6f70 7469 6f6e  L : bool, option
+00073e40: 616c 0a0a 2020 2020 7665 7262 6f73 6520  al..    verbose 
+00073e50: 3a20 626f 6f6c 2c20 6f70 7469 6f6e 616c  : bool, optional
+00073e60: 0a20 2020 2020 2020 2049 6620 5472 7565  .        If True
+00073e70: 2c20 7072 696e 7473 2074 6865 2070 726f  , prints the pro
+00073e80: 6772 6573 7320 616e 6420 7468 6520 7368  gress and the sh
+00073e90: 6170 6520 6f66 2074 6865 2044 6174 6146  ape of the DataF
+00073ea0: 7261 6d65 2062 6569 6e67 2070 726f 6365  rame being proce
+00073eb0: 7373 6564 2069 6e20 6561 6368 2073 7465  ssed in each ste
+00073ec0: 702e 0a0a 2020 2020 5072 6f63 6573 733a  p...    Process:
+00073ed0: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+00073ee0: 2031 2e20 5374 616e 6461 7264 697a 6573   1. Standardizes
+00073ef0: 206d 6f64 616c 6974 6965 7320 6279 206d   modalities by m
+00073f00: 6572 6769 6e67 2044 5449 2d72 656c 6174  erging DTI-relat
+00073f10: 6564 2065 6e74 7269 6573 2e0a 2020 2020  ed entries..    
+00073f20: 322e 2043 6f6e 7665 7274 7320 7370 6563  2. Converts spec
+00073f30: 6966 6963 2063 6f6c 756d 6e73 2074 6f20  ific columns to 
+00073f40: 6170 7072 6f70 7269 6174 6520 6461 7461  appropriate data
+00073f50: 2074 7970 6573 2066 6f72 2070 726f 6365   types for proce
+00073f60: 7373 696e 672e 0a20 2020 2033 2e20 5065  ssing..    3. Pe
+00073f70: 7266 6f72 6d73 206d 6f64 616c 6974 792d  rforms modality-
+00073f80: 7370 6563 6966 6963 206d 6174 6368 696e  specific matchin
+00073f90: 6720 616e 6420 6669 6c74 6572 696e 6720  g and filtering 
+00073fa0: 6261 7365 6420 6f6e 2074 6865 206f 7574  based on the out
+00073fb0: 6c69 6572 2063 6f6c 756d 6e20 616e 6420  lier column and 
+00073fc0: 6372 6974 6572 6961 2066 6f72 2065 6163  criteria for eac
+00073fd0: 6820 6d6f 6461 6c69 7479 2e0a 2020 2020  h modality..    
+00073fe0: 342e 2049 7465 7261 7469 7665 6c79 2070  4. Iteratively p
+00073ff0: 726f 6365 7373 6573 2075 6e6d 6174 6368  rocesses unmatch
+00074000: 6564 2064 6174 6120 666f 7220 7072 6564  ed data for pred
+00074010: 6566 696e 6564 206d 6f64 616c 6974 6965  efined modalitie
+00074020: 7320 7769 7468 2073 7065 6369 6669 6320  s with specific 
+00074030: 7072 6566 6978 6573 2074 6f20 6669 6e64  prefixes to find
+00074040: 2066 7572 7468 6572 206d 6174 6368 6573   further matches
+00074050: 2e0a 2020 2020 0a20 2020 2052 6574 7572  ..    .    Retur
+00074060: 6e73 3a0a 2020 2020 2d2d 2d2d 2d2d 2d0a  ns:.    -------.
+00074070: 2020 2020 7061 6e64 6173 2e44 6174 6146      pandas.DataF
+00074080: 7261 6d65 0a20 2020 2020 2020 2054 6865  rame.        The
+00074090: 206d 6174 6368 6564 2061 6e64 2066 696c   matched and fil
+000740a0: 7465 7265 6420 4461 7461 4672 616d 6520  tered DataFrame 
+000740b0: 6166 7465 7220 6170 706c 7969 6e67 2061  after applying a
+000740c0: 6c6c 2051 4320 7363 6f72 696e 6720 616e  ll QC scoring an
+000740d0: 6420 6d61 7463 6869 6e67 206f 7065 7261  d matching opera
+000740e0: 7469 6f6e 7320 6163 726f 7373 2073 7065  tions across spe
+000740f0: 6369 6669 6564 206d 6f64 616c 6974 6965  cified modalitie
+00074100: 732e 0a0a 2020 2020 2222 220a 2020 2020  s...    """.    
+00074110: 7163 5f64 6174 6166 7261 6d65 5b27 6d6f  qc_dataframe['mo
+00074120: 6461 6c69 7479 275d 203d 2071 635f 6461  dality'] = qc_da
+00074130: 7461 6672 616d 655b 276d 6f64 616c 6974  taframe['modalit
+00074140: 7927 5d2e 7265 706c 6163 6528 5b27 4454  y'].replace(['DT
+00074150: 4964 7769 272c 2027 4454 4962 3027 5d2c  Idwi', 'DTIb0'],
+00074160: 2027 4454 4927 2c20 7265 6765 783d 5472   'DTI', regex=Tr
+00074170: 7565 290a 2020 2020 7163 5f64 6174 6166  ue).    qc_dataf
+00074180: 7261 6d65 5b27 6669 6c65 6e61 6d65 275d  rame['filename']
+00074190: 3d71 635f 6461 7461 6672 616d 655b 2766  =qc_dataframe['f
+000741a0: 696c 656e 616d 6527 5d2e 6173 7479 7065  ilename'].astype
+000741b0: 2873 7472 290a 2020 2020 7163 5f64 6174  (str).    qc_dat
+000741c0: 6166 7261 6d65 5b27 6f6c 5f6c 6f6f 7027  aframe['ol_loop'
+000741d0: 5d3d 7163 5f64 6174 6166 7261 6d65 5b27  ]=qc_dataframe['
+000741e0: 6f6c 5f6c 6f6f 7027 5d2e 6173 7479 7065  ol_loop'].astype
+000741f0: 2866 6c6f 6174 290a 2020 2020 7163 5f64  (float).    qc_d
 00074200: 6174 6166 7261 6d65 5b27 6f6c 5f6c 6f66  ataframe['ol_lof
-00074210: 5f64 6563 6973 696f 6e27 5d2e 6173 7479  _decision'].asty
-00074220: 7065 2866 6c6f 6174 290a 2020 2020 6f75  pe(float).    ou
-00074230: 746c 6965 725f 636f 6c75 6d6e 3d27 6f6c  tlier_column='ol
-00074240: 5f6c 6f6f 7027 0a20 2020 206d 6d64 6630  _loop'.    mmdf0
-00074250: 203d 2062 6573 745f 6d6d 6d28 2071 635f   = best_mmm( qc_
-00074260: 6461 7461 6672 616d 652c 2027 5431 7727  dataframe, 'T1w'
-00074270: 2c20 6f75 746c 6965 725f 636f 6c75 6d6e  , outlier_column
-00074280: 3d6f 7574 6c69 6572 5f63 6f6c 756d 6e20  =outlier_column 
-00074290: 295b 2766 696c 7427 5d0a 2020 2020 666c  )['filt'].    fl
-000742a0: 6466 203d 2062 6573 745f 6d6d 6d28 2071  df = best_mmm( q
-000742b0: 635f 6461 7461 6672 616d 652c 2027 5432  c_dataframe, 'T2
-000742c0: 466c 6169 7227 2c20 6f75 746c 6965 725f  Flair', outlier_
-000742d0: 636f 6c75 6d6e 3d6f 7574 6c69 6572 5f63  column=outlier_c
-000742e0: 6f6c 756d 6e20 295b 2766 696c 7427 5d0a  olumn )['filt'].
-000742f0: 2020 2020 6e6d 6466 203d 2062 6573 745f      nmdf = best_
-00074300: 6d6d 6d28 2071 635f 6461 7461 6672 616d  mmm( qc_datafram
-00074310: 652c 2027 4e4d 3244 4d54 272c 206f 7574  e, 'NM2DMT', out
-00074320: 6c69 6572 5f63 6f6c 756d 6e3d 6f75 746c  lier_column=outl
-00074330: 6965 725f 636f 6c75 6d6e 2029 5b27 6669  ier_column )['fi
-00074340: 6c74 275d 0a20 2020 2072 7364 6620 3d20  lt'].    rsdf = 
-00074350: 6265 7374 5f6d 6d6d 2820 7163 5f64 6174  best_mmm( qc_dat
-00074360: 6166 7261 6d65 2c20 2772 7366 4d52 4927  aframe, 'rsfMRI'
-00074370: 2c20 6f75 746c 6965 725f 636f 6c75 6d6e  , outlier_column
-00074380: 3d6f 7574 6c69 6572 5f63 6f6c 756d 6e20  =outlier_column 
-00074390: 295b 2766 696c 7427 5d0a 2020 2020 6474  )['filt'].    dt
-000743a0: 6466 203d 2062 6573 745f 6d6d 6d28 2071  df = best_mmm( q
-000743b0: 635f 6461 7461 6672 616d 652c 2027 4454  c_dataframe, 'DT
-000743c0: 4927 2c20 6f75 746c 6965 725f 636f 6c75  I', outlier_colu
-000743d0: 6d6e 3d6f 7574 6c69 6572 5f63 6f6c 756d  mn=outlier_colum
-000743e0: 6e20 295b 2766 696c 7427 5d0a 0a20 2020  n )['filt']..   
-000743f0: 2063 7269 7465 7269 6120 3d20 7b27 6f6c   criteria = {'ol
-00074400: 5f6c 6f6f 7027 3a20 276d 696e 272c 2027  _loop': 'min', '
-00074410: 6e6f 6973 6527 3a20 276d 696e 272c 2027  noise': 'min', '
-00074420: 736e 7227 3a20 276d 6178 272c 2027 4556  snr': 'max', 'EV
-00074430: 5227 3a20 276d 6178 272c 2027 7265 666c  R': 'max', 'refl
-00074440: 6563 7469 6f6e 5f65 7272 273a 276d 696e  ection_err':'min
-00074450: 277d 0a20 2020 2078 636c 203d 205b 2027  '}.    xcl = [ '
-00074460: 6d72 696d 6667 272c 2027 6d72 696d 6f64  mrimfg', 'mrimod
-00074470: 656c 272c 276d 7269 4d61 676e 6574 6963  el','mriMagnetic
-00074480: 4669 656c 6453 7472 656e 6774 6827 2c20  FieldStrength', 
-00074490: 2764 7469 5f66 6169 6c65 6427 2c20 2772  'dti_failed', 'r
-000744a0: 7366 5f66 6169 6c65 6427 2c20 2773 7562  sf_failed', 'sub
-000744b0: 6a65 6374 4944 272c 2027 6461 7465 272c  jectID', 'date',
-000744c0: 2027 7375 626a 6563 7449 4464 6174 6527   'subjectIDdate'
-000744d0: 2c27 7265 7065 6174 275d 0a20 2020 2023  ,'repeat'].    #
-000744e0: 2041 7373 756d 696e 6720 6466 5f61 2061   Assuming df_a a
-000744f0: 6e64 2064 665f 6220 6172 6520 616c 7265  nd df_b are alre
-00074500: 6164 7920 6c6f 6164 6564 0a20 2020 206d  ady loaded.    m
-00074510: 6d64 662c 2075 6e64 6666 6c20 3d20 6d6d  mdf, undffl = mm
-00074520: 5f6d 6174 6368 5f62 795f 7163 5f73 636f  _match_by_qc_sco
-00074530: 7269 6e67 286d 6d64 6630 2c20 666c 6466  ring(mmdf0, fldf
-00074540: 2c20 2773 7562 6a65 6374 4944 6461 7465  , 'subjectIDdate
-00074550: 272c 2063 7269 7465 7269 612c 200a 2020  ', criteria, .  
-00074560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074570: 2020 2020 2020 7072 6566 6978 3d27 5432        prefix='T2
-00074580: 466c 6169 725f 272c 2065 7863 6c75 6465  Flair_', exclude
-00074590: 5f63 6f6c 756d 6e73 3d78 636c 2029 0a0a  _columns=xcl )..
-000745a0: 2020 2020 7072 6566 6978 6573 203d 205b      prefixes = [
-000745b0: 274e 4d31 5f27 2c20 274e 4d32 5f27 2c20  'NM1_', 'NM2_', 
-000745c0: 274e 4d33 5f27 2c20 274e 4d34 5f27 2c20  'NM3_', 'NM4_', 
-000745d0: 274e 4d35 5f27 2c20 274e 4d36 5f27 5d20  'NM5_', 'NM6_'] 
-000745e0: 200a 2020 2020 756e 6466 6d6f 6420 3d20   .    undfmod = 
-000745f0: 6e6d 6466 2020 2320 496e 6974 6961 6c69  nmdf  # Initiali
-00074600: 7a65 2027 756e 6466 6d6f 6427 2077 6974  ze 'undfmod' wit
-00074610: 6820 276e 6d64 6627 2066 6f72 2074 6865  h 'nmdf' for the
-00074620: 2066 6972 7374 2069 7465 7261 7469 6f6e   first iteration
-00074630: 0a20 2020 2069 6620 756e 6466 6d6f 6420  .    if undfmod 
-00074640: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00074650: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
-00074660: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00074670: 6e74 2827 7374 6172 7420 4e4d 2729 0a20  nt('start NM'). 
-00074680: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00074690: 2820 756e 6466 6d6f 642e 7368 6170 6520  ( undfmod.shape 
-000746a0: 290a 2020 2020 2020 2020 666f 7220 7072  ).        for pr
-000746b0: 6566 6978 2069 6e20 7072 6566 6978 6573  efix in prefixes
-000746c0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000746d0: 2075 6e64 666d 6f64 2e73 6861 7065 5b30   undfmod.shape[0
-000746e0: 5d20 3e20 3530 3a0a 2020 2020 2020 2020  ] > 50:.        
-000746f0: 2020 2020 2020 2020 6d6d 6466 2c20 756e          mmdf, un
-00074700: 6466 6d6f 6420 3d20 6d6d 5f6d 6174 6368  dfmod = mm_match
-00074710: 5f62 795f 7163 5f73 636f 7269 6e67 286d  _by_qc_scoring(m
-00074720: 6d64 662c 2075 6e64 666d 6f64 2c20 2773  mdf, undfmod, 's
-00074730: 7562 6a65 6374 4944 6461 7465 272c 2063  ubjectIDdate', c
-00074740: 7269 7465 7269 612c 2070 7265 6669 783d  riteria, prefix=
-00074750: 7072 6566 6978 2c20 6578 636c 7564 655f  prefix, exclude_
-00074760: 636f 6c75 6d6e 733d 7863 6c29 0a20 2020  columns=xcl).   
-00074770: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00074780: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
-00074790: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-000747a0: 6e74 2820 7072 6566 6978 2029 0a20 2020  nt( prefix ).   
-000747b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000747c0: 2070 7269 6e74 2820 756e 6466 6d6f 642e   print( undfmod.
-000747d0: 7368 6170 6520 290a 0a20 2020 2063 7269  shape )..    cri
-000747e0: 7465 7269 6120 3d20 7b27 6f6c 5f6c 6f6f  teria = {'ol_loo
-000747f0: 7027 3a20 276d 696e 272c 2027 6e6f 6973  p': 'min', 'nois
-00074800: 6527 3a20 276d 696e 272c 2027 736e 7227  e': 'min', 'snr'
-00074810: 3a20 276d 6178 272c 2027 4556 5227 3a20  : 'max', 'EVR': 
-00074820: 276d 6178 272c 2027 6469 6d74 273a 276d  'max', 'dimt':'m
-00074830: 6178 277d 0a20 2020 2023 2068 6967 6865  ax'}.    # highe
-00074840: 7220 6276 616c 7565 7320 6c65 6164 2074  r bvalues lead t
-00074850: 6f20 6d6f 7265 206e 6f69 7365 202e 2e2e  o more noise ...
-00074860: 0a20 2020 2063 7269 7465 7269 6120 3d20  .    criteria = 
-00074870: 7b27 6f6c 5f6c 6f6f 7027 3a20 276d 696e  {'ol_loop': 'min
-00074880: 272c 2027 6e6f 6973 6527 3a20 276d 696e  ', 'noise': 'min
-00074890: 272c 2020 2764 7469 5f62 7661 6c75 654d  ',  'dti_bvalueM
-000748a0: 6178 273a 276d 696e 272c 2020 2764 696d  ax':'min',  'dim
-000748b0: 7427 3a27 6d61 7827 7d0a 2020 2020 7072  t':'max'}.    pr
-000748c0: 6566 6978 6573 203d 205b 2744 5449 315f  efixes = ['DTI1_
-000748d0: 272c 2027 4454 4932 5f27 2c20 2744 5449  ', 'DTI2_', 'DTI
-000748e0: 335f 275d 2020 2320 4c69 7374 206f 6620  3_']  # List of 
-000748f0: 7072 6566 6978 6573 2066 6f72 2065 6163  prefixes for eac
-00074900: 6820 6d61 7463 6869 6e67 2069 7465 7261  h matching itera
-00074910: 7469 6f6e 0a20 2020 2075 6e64 666d 6f64  tion.    undfmod
-00074920: 203d 2064 7464 660a 2020 2020 6966 2076   = dtdf.    if v
-00074930: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-00074940: 7072 696e 7428 2773 7461 7274 2044 5427  print('start DT'
-00074950: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
-00074960: 2075 6e64 666d 6f64 2e73 6861 7065 2029   undfmod.shape )
-00074970: 0a20 2020 2066 6f72 2070 7265 6669 7820  .    for prefix 
-00074980: 696e 2070 7265 6669 7865 733a 0a20 2020  in prefixes:.   
-00074990: 2020 2020 2069 6620 756e 6466 6d6f 642e       if undfmod.
-000749a0: 7368 6170 655b 305d 203e 2035 303a 0a20  shape[0] > 50:. 
-000749b0: 2020 2020 2020 2020 2020 206d 6d64 662c             mmdf,
-000749c0: 2075 6e64 666d 6f64 203d 206d 6d5f 6d61   undfmod = mm_ma
-000749d0: 7463 685f 6279 5f71 635f 7363 6f72 696e  tch_by_qc_scorin
-000749e0: 6728 6d6d 6466 2c20 756e 6466 6d6f 642c  g(mmdf, undfmod,
-000749f0: 2027 7375 626a 6563 7449 4464 6174 6527   'subjectIDdate'
-00074a00: 2c20 6372 6974 6572 6961 2c20 7072 6566  , criteria, pref
-00074a10: 6978 3d70 7265 6669 782c 2065 7863 6c75  ix=prefix, exclu
-00074a20: 6465 5f63 6f6c 756d 6e73 3d78 636c 290a  de_columns=xcl).
-00074a30: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-00074a40: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
-00074a50: 2020 2020 2020 2020 7072 696e 7428 2070          print( p
-00074a60: 7265 6669 7820 290a 2020 2020 2020 2020  refix ).        
-00074a70: 2020 2020 2020 2020 7072 696e 7428 2075          print( u
-00074a80: 6e64 666d 6f64 2e73 6861 7065 2029 0a0a  ndfmod.shape )..
-00074a90: 2020 2020 7072 6566 6978 6573 203d 205b      prefixes = [
-00074aa0: 2772 7366 315f 272c 2027 7273 6632 5f27  'rsf1_', 'rsf2_'
-00074ab0: 2c20 2772 7366 335f 275d 2020 2320 4c69  , 'rsf3_']  # Li
-00074ac0: 7374 206f 6620 7072 6566 6978 6573 2066  st of prefixes f
-00074ad0: 6f72 2065 6163 6820 6d61 7463 6869 6e67  or each matching
-00074ae0: 2069 7465 7261 7469 6f6e 0a20 2020 2075   iteration.    u
-00074af0: 6e64 666d 6f64 203d 2072 7364 6620 2023  ndfmod = rsdf  #
-00074b00: 2049 6e69 7469 616c 697a 6520 2775 6e64   Initialize 'und
-00074b10: 666d 6f64 2720 7769 7468 2027 6e6d 6466  fmod' with 'nmdf
-00074b20: 2720 666f 7220 7468 6520 6669 7273 7420  ' for the first 
-00074b30: 6974 6572 6174 696f 6e0a 2020 2020 6966  iteration.    if
-00074b40: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
-00074b50: 2020 7072 696e 7428 2773 7461 7274 2072    print('start r
-00074b60: 7366 2729 0a20 2020 2020 2020 2070 7269  sf').        pri
-00074b70: 6e74 2820 756e 6466 6d6f 642e 7368 6170  nt( undfmod.shap
-00074b80: 6520 290a 2020 2020 666f 7220 7072 6566  e ).    for pref
-00074b90: 6978 2069 6e20 7072 6566 6978 6573 3a0a  ix in prefixes:.
-00074ba0: 2020 2020 2020 2020 6966 2075 6e64 666d          if undfm
-00074bb0: 6f64 2e73 6861 7065 5b30 5d20 3e20 3530  od.shape[0] > 50
-00074bc0: 3a0a 2020 2020 2020 2020 2020 2020 6d6d  :.            mm
-00074bd0: 6466 2c20 756e 6466 6d6f 6420 3d20 6d6d  df, undfmod = mm
-00074be0: 5f6d 6174 6368 5f62 795f 7163 5f73 636f  _match_by_qc_sco
-00074bf0: 7269 6e67 286d 6d64 662c 2075 6e64 666d  ring(mmdf, undfm
-00074c00: 6f64 2c20 2773 7562 6a65 6374 4944 6461  od, 'subjectIDda
-00074c10: 7465 272c 2063 7269 7465 7269 612c 2070  te', criteria, p
-00074c20: 7265 6669 783d 7072 6566 6978 2c20 6578  refix=prefix, ex
-00074c30: 636c 7564 655f 636f 6c75 6d6e 733d 7863  clude_columns=xc
-00074c40: 6c29 0a20 2020 2020 2020 2020 2020 2069  l).            i
-00074c50: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-00074c60: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00074c70: 2820 7072 6566 6978 2029 0a20 2020 2020  ( prefix ).     
-00074c80: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00074c90: 2820 756e 6466 6d6f 642e 7368 6170 6520  ( undfmod.shape 
-00074ca0: 290a 2020 2020 0a20 2020 2069 6620 6669  ).    .    if fi
-00074cb0: 785f 4c52 524c 3a0a 2020 2020 2020 2020  x_LRRL:.        
-00074cc0: 2320 2020 2020 2020 206d 6d64 663d 6669  #        mmdf=fi
-00074cd0: 785f 4c52 5f52 4c5f 7374 7566 6628 206d  x_LR_RL_stuff( m
-00074ce0: 6d64 662c 2027 4454 4931 5f66 696c 656e  mdf, 'DTI1_filen
-00074cf0: 616d 6527 2c20 2744 5449 325f 6669 6c65  ame', 'DTI2_file
-00074d00: 6e61 6d65 272c 2027 4454 4931 5f64 696d  name', 'DTI1_dim
-00074d10: 7427 2c20 2744 5449 325f 6469 6d74 2729  t', 'DTI2_dimt')
-00074d20: 0a20 2020 2020 2020 206d 6d64 663d 6669  .        mmdf=fi
+00074210: 275d 3d71 635f 6461 7461 6672 616d 655b  ']=qc_dataframe[
+00074220: 276f 6c5f 6c6f 6627 5d2e 6173 7479 7065  'ol_lof'].astype
+00074230: 2866 6c6f 6174 290a 2020 2020 7163 5f64  (float).    qc_d
+00074240: 6174 6166 7261 6d65 5b27 6f6c 5f6c 6f66  ataframe['ol_lof
+00074250: 5f64 6563 6973 696f 6e27 5d3d 7163 5f64  _decision']=qc_d
+00074260: 6174 6166 7261 6d65 5b27 6f6c 5f6c 6f66  ataframe['ol_lof
+00074270: 5f64 6563 6973 696f 6e27 5d2e 6173 7479  _decision'].asty
+00074280: 7065 2866 6c6f 6174 290a 2020 2020 6f75  pe(float).    ou
+00074290: 746c 6965 725f 636f 6c75 6d6e 3d27 6f6c  tlier_column='ol
+000742a0: 5f6c 6f6f 7027 0a20 2020 206d 6d64 6630  _loop'.    mmdf0
+000742b0: 203d 2062 6573 745f 6d6d 6d28 2071 635f   = best_mmm( qc_
+000742c0: 6461 7461 6672 616d 652c 2027 5431 7727  dataframe, 'T1w'
+000742d0: 2c20 6f75 746c 6965 725f 636f 6c75 6d6e  , outlier_column
+000742e0: 3d6f 7574 6c69 6572 5f63 6f6c 756d 6e20  =outlier_column 
+000742f0: 295b 2766 696c 7427 5d0a 2020 2020 666c  )['filt'].    fl
+00074300: 6466 203d 2062 6573 745f 6d6d 6d28 2071  df = best_mmm( q
+00074310: 635f 6461 7461 6672 616d 652c 2027 5432  c_dataframe, 'T2
+00074320: 466c 6169 7227 2c20 6f75 746c 6965 725f  Flair', outlier_
+00074330: 636f 6c75 6d6e 3d6f 7574 6c69 6572 5f63  column=outlier_c
+00074340: 6f6c 756d 6e20 295b 2766 696c 7427 5d0a  olumn )['filt'].
+00074350: 2020 2020 6e6d 6466 203d 2062 6573 745f      nmdf = best_
+00074360: 6d6d 6d28 2071 635f 6461 7461 6672 616d  mmm( qc_datafram
+00074370: 652c 2027 4e4d 3244 4d54 272c 206f 7574  e, 'NM2DMT', out
+00074380: 6c69 6572 5f63 6f6c 756d 6e3d 6f75 746c  lier_column=outl
+00074390: 6965 725f 636f 6c75 6d6e 2029 5b27 6669  ier_column )['fi
+000743a0: 6c74 275d 0a20 2020 2072 7364 6620 3d20  lt'].    rsdf = 
+000743b0: 6265 7374 5f6d 6d6d 2820 7163 5f64 6174  best_mmm( qc_dat
+000743c0: 6166 7261 6d65 2c20 2772 7366 4d52 4927  aframe, 'rsfMRI'
+000743d0: 2c20 6f75 746c 6965 725f 636f 6c75 6d6e  , outlier_column
+000743e0: 3d6f 7574 6c69 6572 5f63 6f6c 756d 6e20  =outlier_column 
+000743f0: 295b 2766 696c 7427 5d0a 2020 2020 6474  )['filt'].    dt
+00074400: 6466 203d 2062 6573 745f 6d6d 6d28 2071  df = best_mmm( q
+00074410: 635f 6461 7461 6672 616d 652c 2027 4454  c_dataframe, 'DT
+00074420: 4927 2c20 6f75 746c 6965 725f 636f 6c75  I', outlier_colu
+00074430: 6d6e 3d6f 7574 6c69 6572 5f63 6f6c 756d  mn=outlier_colum
+00074440: 6e20 295b 2766 696c 7427 5d0a 0a20 2020  n )['filt']..   
+00074450: 2063 7269 7465 7269 6120 3d20 7b27 6f6c   criteria = {'ol
+00074460: 5f6c 6f6f 7027 3a20 276d 696e 272c 2027  _loop': 'min', '
+00074470: 6e6f 6973 6527 3a20 276d 696e 272c 2027  noise': 'min', '
+00074480: 736e 7227 3a20 276d 6178 272c 2027 4556  snr': 'max', 'EV
+00074490: 5227 3a20 276d 6178 272c 2027 7265 666c  R': 'max', 'refl
+000744a0: 6563 7469 6f6e 5f65 7272 273a 276d 696e  ection_err':'min
+000744b0: 277d 0a20 2020 2078 636c 203d 205b 2027  '}.    xcl = [ '
+000744c0: 6d72 696d 6667 272c 2027 6d72 696d 6f64  mrimfg', 'mrimod
+000744d0: 656c 272c 276d 7269 4d61 676e 6574 6963  el','mriMagnetic
+000744e0: 4669 656c 6453 7472 656e 6774 6827 2c20  FieldStrength', 
+000744f0: 2764 7469 5f66 6169 6c65 6427 2c20 2772  'dti_failed', 'r
+00074500: 7366 5f66 6169 6c65 6427 2c20 2773 7562  sf_failed', 'sub
+00074510: 6a65 6374 4944 272c 2027 6461 7465 272c  jectID', 'date',
+00074520: 2027 7375 626a 6563 7449 4464 6174 6527   'subjectIDdate'
+00074530: 2c27 7265 7065 6174 275d 0a20 2020 2023  ,'repeat'].    #
+00074540: 2041 7373 756d 696e 6720 6466 5f61 2061   Assuming df_a a
+00074550: 6e64 2064 665f 6220 6172 6520 616c 7265  nd df_b are alre
+00074560: 6164 7920 6c6f 6164 6564 0a20 2020 206d  ady loaded.    m
+00074570: 6d64 662c 2075 6e64 6666 6c20 3d20 6d6d  mdf, undffl = mm
+00074580: 5f6d 6174 6368 5f62 795f 7163 5f73 636f  _match_by_qc_sco
+00074590: 7269 6e67 286d 6d64 6630 2c20 666c 6466  ring(mmdf0, fldf
+000745a0: 2c20 2773 7562 6a65 6374 4944 6461 7465  , 'subjectIDdate
+000745b0: 272c 2063 7269 7465 7269 612c 200a 2020  ', criteria, .  
+000745c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000745d0: 2020 2020 2020 7072 6566 6978 3d27 5432        prefix='T2
+000745e0: 466c 6169 725f 272c 2065 7863 6c75 6465  Flair_', exclude
+000745f0: 5f63 6f6c 756d 6e73 3d78 636c 2029 0a0a  _columns=xcl )..
+00074600: 2020 2020 7072 6566 6978 6573 203d 205b      prefixes = [
+00074610: 274e 4d31 5f27 2c20 274e 4d32 5f27 2c20  'NM1_', 'NM2_', 
+00074620: 274e 4d33 5f27 2c20 274e 4d34 5f27 2c20  'NM3_', 'NM4_', 
+00074630: 274e 4d35 5f27 2c20 274e 4d36 5f27 5d20  'NM5_', 'NM6_'] 
+00074640: 200a 2020 2020 756e 6466 6d6f 6420 3d20   .    undfmod = 
+00074650: 6e6d 6466 2020 2320 496e 6974 6961 6c69  nmdf  # Initiali
+00074660: 7a65 2027 756e 6466 6d6f 6427 2077 6974  ze 'undfmod' wit
+00074670: 6820 276e 6d64 6627 2066 6f72 2074 6865  h 'nmdf' for the
+00074680: 2066 6972 7374 2069 7465 7261 7469 6f6e   first iteration
+00074690: 0a20 2020 2069 6620 756e 6466 6d6f 6420  .    if undfmod 
+000746a0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+000746b0: 2020 2020 2069 6620 7665 7262 6f73 653a       if verbose:
+000746c0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+000746d0: 6e74 2827 7374 6172 7420 4e4d 2729 0a20  nt('start NM'). 
+000746e0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+000746f0: 2820 756e 6466 6d6f 642e 7368 6170 6520  ( undfmod.shape 
+00074700: 290a 2020 2020 2020 2020 666f 7220 7072  ).        for pr
+00074710: 6566 6978 2069 6e20 7072 6566 6978 6573  efix in prefixes
+00074720: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00074730: 2075 6e64 666d 6f64 2e73 6861 7065 5b30   undfmod.shape[0
+00074740: 5d20 3e20 3530 3a0a 2020 2020 2020 2020  ] > 50:.        
+00074750: 2020 2020 2020 2020 6d6d 6466 2c20 756e          mmdf, un
+00074760: 6466 6d6f 6420 3d20 6d6d 5f6d 6174 6368  dfmod = mm_match
+00074770: 5f62 795f 7163 5f73 636f 7269 6e67 286d  _by_qc_scoring(m
+00074780: 6d64 662c 2075 6e64 666d 6f64 2c20 2773  mdf, undfmod, 's
+00074790: 7562 6a65 6374 4944 6461 7465 272c 2063  ubjectIDdate', c
+000747a0: 7269 7465 7269 612c 2070 7265 6669 783d  riteria, prefix=
+000747b0: 7072 6566 6978 2c20 6578 636c 7564 655f  prefix, exclude_
+000747c0: 636f 6c75 6d6e 733d 7863 6c29 0a20 2020  columns=xcl).   
+000747d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000747e0: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+000747f0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00074800: 6e74 2820 7072 6566 6978 2029 0a20 2020  nt( prefix ).   
+00074810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074820: 2070 7269 6e74 2820 756e 6466 6d6f 642e   print( undfmod.
+00074830: 7368 6170 6520 290a 0a20 2020 2063 7269  shape )..    cri
+00074840: 7465 7269 6120 3d20 7b27 6f6c 5f6c 6f6f  teria = {'ol_loo
+00074850: 7027 3a20 276d 696e 272c 2027 6e6f 6973  p': 'min', 'nois
+00074860: 6527 3a20 276d 696e 272c 2027 736e 7227  e': 'min', 'snr'
+00074870: 3a20 276d 6178 272c 2027 4556 5227 3a20  : 'max', 'EVR': 
+00074880: 276d 6178 272c 2027 6469 6d74 273a 276d  'max', 'dimt':'m
+00074890: 6178 277d 0a20 2020 2023 2068 6967 6865  ax'}.    # highe
+000748a0: 7220 6276 616c 7565 7320 6c65 6164 2074  r bvalues lead t
+000748b0: 6f20 6d6f 7265 206e 6f69 7365 202e 2e2e  o more noise ...
+000748c0: 0a20 2020 2063 7269 7465 7269 6120 3d20  .    criteria = 
+000748d0: 7b27 6f6c 5f6c 6f6f 7027 3a20 276d 696e  {'ol_loop': 'min
+000748e0: 272c 2027 6e6f 6973 6527 3a20 276d 696e  ', 'noise': 'min
+000748f0: 272c 2020 2764 7469 5f62 7661 6c75 654d  ',  'dti_bvalueM
+00074900: 6178 273a 276d 696e 272c 2020 2764 696d  ax':'min',  'dim
+00074910: 7427 3a27 6d61 7827 7d0a 2020 2020 7072  t':'max'}.    pr
+00074920: 6566 6978 6573 203d 205b 2744 5449 315f  efixes = ['DTI1_
+00074930: 272c 2027 4454 4932 5f27 2c20 2744 5449  ', 'DTI2_', 'DTI
+00074940: 335f 275d 2020 2320 4c69 7374 206f 6620  3_']  # List of 
+00074950: 7072 6566 6978 6573 2066 6f72 2065 6163  prefixes for eac
+00074960: 6820 6d61 7463 6869 6e67 2069 7465 7261  h matching itera
+00074970: 7469 6f6e 0a20 2020 2075 6e64 666d 6f64  tion.    undfmod
+00074980: 203d 2064 7464 660a 2020 2020 6966 2076   = dtdf.    if v
+00074990: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+000749a0: 7072 696e 7428 2773 7461 7274 2044 5427  print('start DT'
+000749b0: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
+000749c0: 2075 6e64 666d 6f64 2e73 6861 7065 2029   undfmod.shape )
+000749d0: 0a20 2020 2066 6f72 2070 7265 6669 7820  .    for prefix 
+000749e0: 696e 2070 7265 6669 7865 733a 0a20 2020  in prefixes:.   
+000749f0: 2020 2020 2069 6620 756e 6466 6d6f 642e       if undfmod.
+00074a00: 7368 6170 655b 305d 203e 2035 303a 0a20  shape[0] > 50:. 
+00074a10: 2020 2020 2020 2020 2020 206d 6d64 662c             mmdf,
+00074a20: 2075 6e64 666d 6f64 203d 206d 6d5f 6d61   undfmod = mm_ma
+00074a30: 7463 685f 6279 5f71 635f 7363 6f72 696e  tch_by_qc_scorin
+00074a40: 6728 6d6d 6466 2c20 756e 6466 6d6f 642c  g(mmdf, undfmod,
+00074a50: 2027 7375 626a 6563 7449 4464 6174 6527   'subjectIDdate'
+00074a60: 2c20 6372 6974 6572 6961 2c20 7072 6566  , criteria, pref
+00074a70: 6978 3d70 7265 6669 782c 2065 7863 6c75  ix=prefix, exclu
+00074a80: 6465 5f63 6f6c 756d 6e73 3d78 636c 290a  de_columns=xcl).
+00074a90: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+00074aa0: 6572 626f 7365 3a0a 2020 2020 2020 2020  erbose:.        
+00074ab0: 2020 2020 2020 2020 7072 696e 7428 2070          print( p
+00074ac0: 7265 6669 7820 290a 2020 2020 2020 2020  refix ).        
+00074ad0: 2020 2020 2020 2020 7072 696e 7428 2075          print( u
+00074ae0: 6e64 666d 6f64 2e73 6861 7065 2029 0a0a  ndfmod.shape )..
+00074af0: 2020 2020 7072 6566 6978 6573 203d 205b      prefixes = [
+00074b00: 2772 7366 315f 272c 2027 7273 6632 5f27  'rsf1_', 'rsf2_'
+00074b10: 2c20 2772 7366 335f 275d 2020 2320 4c69  , 'rsf3_']  # Li
+00074b20: 7374 206f 6620 7072 6566 6978 6573 2066  st of prefixes f
+00074b30: 6f72 2065 6163 6820 6d61 7463 6869 6e67  or each matching
+00074b40: 2069 7465 7261 7469 6f6e 0a20 2020 2075   iteration.    u
+00074b50: 6e64 666d 6f64 203d 2072 7364 6620 2023  ndfmod = rsdf  #
+00074b60: 2049 6e69 7469 616c 697a 6520 2775 6e64   Initialize 'und
+00074b70: 666d 6f64 2720 7769 7468 2027 6e6d 6466  fmod' with 'nmdf
+00074b80: 2720 666f 7220 7468 6520 6669 7273 7420  ' for the first 
+00074b90: 6974 6572 6174 696f 6e0a 2020 2020 6966  iteration.    if
+00074ba0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+00074bb0: 2020 7072 696e 7428 2773 7461 7274 2072    print('start r
+00074bc0: 7366 2729 0a20 2020 2020 2020 2070 7269  sf').        pri
+00074bd0: 6e74 2820 756e 6466 6d6f 642e 7368 6170  nt( undfmod.shap
+00074be0: 6520 290a 2020 2020 666f 7220 7072 6566  e ).    for pref
+00074bf0: 6978 2069 6e20 7072 6566 6978 6573 3a0a  ix in prefixes:.
+00074c00: 2020 2020 2020 2020 6966 2075 6e64 666d          if undfm
+00074c10: 6f64 2e73 6861 7065 5b30 5d20 3e20 3530  od.shape[0] > 50
+00074c20: 3a0a 2020 2020 2020 2020 2020 2020 6d6d  :.            mm
+00074c30: 6466 2c20 756e 6466 6d6f 6420 3d20 6d6d  df, undfmod = mm
+00074c40: 5f6d 6174 6368 5f62 795f 7163 5f73 636f  _match_by_qc_sco
+00074c50: 7269 6e67 286d 6d64 662c 2075 6e64 666d  ring(mmdf, undfm
+00074c60: 6f64 2c20 2773 7562 6a65 6374 4944 6461  od, 'subjectIDda
+00074c70: 7465 272c 2063 7269 7465 7269 612c 2070  te', criteria, p
+00074c80: 7265 6669 783d 7072 6566 6978 2c20 6578  refix=prefix, ex
+00074c90: 636c 7564 655f 636f 6c75 6d6e 733d 7863  clude_columns=xc
+00074ca0: 6c29 0a20 2020 2020 2020 2020 2020 2069  l).            i
+00074cb0: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
+00074cc0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00074cd0: 2820 7072 6566 6978 2029 0a20 2020 2020  ( prefix ).     
+00074ce0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00074cf0: 2820 756e 6466 6d6f 642e 7368 6170 6520  ( undfmod.shape 
+00074d00: 290a 2020 2020 0a20 2020 2069 6620 6669  ).    .    if fi
+00074d10: 785f 4c52 524c 3a0a 2020 2020 2020 2020  x_LRRL:.        
+00074d20: 2320 2020 2020 2020 206d 6d64 663d 6669  #        mmdf=fi
 00074d30: 785f 4c52 5f52 4c5f 7374 7566 6628 206d  x_LR_RL_stuff( m
-00074d40: 6d64 662c 2027 7273 6631 5f66 696c 656e  mdf, 'rsf1_filen
-00074d50: 616d 6527 2c20 2772 7366 325f 6669 6c65  ame', 'rsf2_file
-00074d60: 6e61 6d65 272c 2027 7273 6631 5f64 696d  name', 'rsf1_dim
-00074d70: 7427 2c20 2772 7366 325f 6469 6d74 272c  t', 'rsf2_dimt',
-00074d80: 2027 7273 6631 5f69 6d61 6765 4944 272c   'rsf1_imageID',
-00074d90: 2027 7273 6632 5f69 6d61 6765 4944 2720   'rsf2_imageID' 
-00074da0: 2029 0a20 2020 2065 6c73 653a 0a20 2020   ).    else:.   
-00074db0: 2020 2020 2069 6d70 6f72 7420 7761 726e       import warn
-00074dc0: 696e 6773 0a20 2020 2020 2020 2077 6172  ings.        war
-00074dd0: 6e69 6e67 732e 7761 726e 2822 4649 584d  nings.warn("FIXM
-00074de0: 453a 2073 686f 756c 6420 6669 7820 4c52  E: should fix LR
-00074df0: 2061 6e64 2052 4c20 7369 7475 6174 696f   and RL situatio
-00074e00: 6e20 666f 7220 7468 6520 4454 4920 616e  n for the DTI an
-00074e10: 6420 7273 664d 5249 2229 0a0a 2020 2020  d rsfMRI")..    
-00074e20: 2320 6e6f 7720 646f 2074 6865 206e 6563  # now do the nec
-00074e30: 6573 7361 7279 2072 6570 6c61 6365 6d65  essary replaceme
-00074e40: 6e74 730a 2020 2020 0a20 2020 2072 656e  nts.    .    ren
-00074e50: 616d 6569 7428 206d 6d64 662c 2027 7065  ameit( mmdf, 'pe
-00074e60: 7266 5f69 6d61 6765 4944 272c 2027 7065  rf_imageID', 'pe
-00074e70: 7266 6964 2720 290a 2020 2020 7265 6e61  rfid' ).    rena
-00074e80: 6d65 6974 2820 6d6d 6466 2c20 2770 6572  meit( mmdf, 'per
-00074e90: 665f 6669 6c65 6e61 6d65 272c 2027 7065  f_filename', 'pe
-00074ea0: 7266 666e 2720 290a 2020 2020 7265 6e61  rffn' ).    rena
-00074eb0: 6d65 6974 2820 6d6d 6466 2c20 2754 3246  meit( mmdf, 'T2F
-00074ec0: 6c61 6972 5f69 6d61 6765 4944 272c 2027  lair_imageID', '
-00074ed0: 666c 6169 7269 6427 2029 0a20 2020 2072  flairid' ).    r
-00074ee0: 656e 616d 6569 7428 206d 6d64 662c 2027  enameit( mmdf, '
-00074ef0: 5432 466c 6169 725f 6669 6c65 6e61 6d65  T2Flair_filename
-00074f00: 272c 2027 666c 6169 7266 6e27 2029 0a20  ', 'flairfn' ). 
-00074f10: 2020 2072 656e 616d 6569 7428 206d 6d64     renameit( mmd
-00074f20: 662c 2027 7273 6631 5f69 6d61 6765 4944  f, 'rsf1_imageID
-00074f30: 272c 2027 7273 6669 6431 2720 290a 2020  ', 'rsfid1' ).  
-00074f40: 2020 7265 6e61 6d65 6974 2820 6d6d 6466    renameit( mmdf
-00074f50: 2c20 2772 7366 325f 696d 6167 6549 4427  , 'rsf2_imageID'
-00074f60: 2c20 2772 7366 6964 3227 2029 0a20 2020  , 'rsfid2' ).   
-00074f70: 2072 656e 616d 6569 7428 206d 6d64 662c   renameit( mmdf,
-00074f80: 2027 7273 6631 5f66 696c 656e 616d 6527   'rsf1_filename'
-00074f90: 2c20 2772 7366 666e 3127 2029 0a20 2020  , 'rsffn1' ).   
-00074fa0: 2072 656e 616d 6569 7428 206d 6d64 662c   renameit( mmdf,
-00074fb0: 2027 7273 6632 5f66 696c 656e 616d 6527   'rsf2_filename'
-00074fc0: 2c20 2772 7366 666e 3227 2029 0a20 2020  , 'rsffn2' ).   
+00074d40: 6d64 662c 2027 4454 4931 5f66 696c 656e  mdf, 'DTI1_filen
+00074d50: 616d 6527 2c20 2744 5449 325f 6669 6c65  ame', 'DTI2_file
+00074d60: 6e61 6d65 272c 2027 4454 4931 5f64 696d  name', 'DTI1_dim
+00074d70: 7427 2c20 2744 5449 325f 6469 6d74 2729  t', 'DTI2_dimt')
+00074d80: 0a20 2020 2020 2020 206d 6d64 663d 6669  .        mmdf=fi
+00074d90: 785f 4c52 5f52 4c5f 7374 7566 6628 206d  x_LR_RL_stuff( m
+00074da0: 6d64 662c 2027 7273 6631 5f66 696c 656e  mdf, 'rsf1_filen
+00074db0: 616d 6527 2c20 2772 7366 325f 6669 6c65  ame', 'rsf2_file
+00074dc0: 6e61 6d65 272c 2027 7273 6631 5f64 696d  name', 'rsf1_dim
+00074dd0: 7427 2c20 2772 7366 325f 6469 6d74 272c  t', 'rsf2_dimt',
+00074de0: 2027 7273 6631 5f69 6d61 6765 4944 272c   'rsf1_imageID',
+00074df0: 2027 7273 6632 5f69 6d61 6765 4944 2720   'rsf2_imageID' 
+00074e00: 2029 0a20 2020 2065 6c73 653a 0a20 2020   ).    else:.   
+00074e10: 2020 2020 2069 6d70 6f72 7420 7761 726e       import warn
+00074e20: 696e 6773 0a20 2020 2020 2020 2077 6172  ings.        war
+00074e30: 6e69 6e67 732e 7761 726e 2822 4649 584d  nings.warn("FIXM
+00074e40: 453a 2073 686f 756c 6420 6669 7820 4c52  E: should fix LR
+00074e50: 2061 6e64 2052 4c20 7369 7475 6174 696f   and RL situatio
+00074e60: 6e20 666f 7220 7468 6520 4454 4920 616e  n for the DTI an
+00074e70: 6420 7273 664d 5249 2229 0a0a 2020 2020  d rsfMRI")..    
+00074e80: 2320 6e6f 7720 646f 2074 6865 206e 6563  # now do the nec
+00074e90: 6573 7361 7279 2072 6570 6c61 6365 6d65  essary replaceme
+00074ea0: 6e74 730a 2020 2020 0a20 2020 2072 656e  nts.    .    ren
+00074eb0: 616d 6569 7428 206d 6d64 662c 2027 7065  ameit( mmdf, 'pe
+00074ec0: 7266 5f69 6d61 6765 4944 272c 2027 7065  rf_imageID', 'pe
+00074ed0: 7266 6964 2720 290a 2020 2020 7265 6e61  rfid' ).    rena
+00074ee0: 6d65 6974 2820 6d6d 6466 2c20 2770 6572  meit( mmdf, 'per
+00074ef0: 665f 6669 6c65 6e61 6d65 272c 2027 7065  f_filename', 'pe
+00074f00: 7266 666e 2720 290a 2020 2020 7265 6e61  rffn' ).    rena
+00074f10: 6d65 6974 2820 6d6d 6466 2c20 2754 3246  meit( mmdf, 'T2F
+00074f20: 6c61 6972 5f69 6d61 6765 4944 272c 2027  lair_imageID', '
+00074f30: 666c 6169 7269 6427 2029 0a20 2020 2072  flairid' ).    r
+00074f40: 656e 616d 6569 7428 206d 6d64 662c 2027  enameit( mmdf, '
+00074f50: 5432 466c 6169 725f 6669 6c65 6e61 6d65  T2Flair_filename
+00074f60: 272c 2027 666c 6169 7266 6e27 2029 0a20  ', 'flairfn' ). 
+00074f70: 2020 2072 656e 616d 6569 7428 206d 6d64     renameit( mmd
+00074f80: 662c 2027 7273 6631 5f69 6d61 6765 4944  f, 'rsf1_imageID
+00074f90: 272c 2027 7273 6669 6431 2720 290a 2020  ', 'rsfid1' ).  
+00074fa0: 2020 7265 6e61 6d65 6974 2820 6d6d 6466    renameit( mmdf
+00074fb0: 2c20 2772 7366 325f 696d 6167 6549 4427  , 'rsf2_imageID'
+00074fc0: 2c20 2772 7366 6964 3227 2029 0a20 2020  , 'rsfid2' ).   
 00074fd0: 2072 656e 616d 6569 7428 206d 6d64 662c   renameit( mmdf,
-00074fe0: 2027 4454 4931 5f69 6d61 6765 4944 272c   'DTI1_imageID',
-00074ff0: 2027 6474 6964 3127 2029 0a20 2020 2072   'dtid1' ).    r
-00075000: 656e 616d 6569 7428 206d 6d64 662c 2027  enameit( mmdf, '
-00075010: 4454 4932 5f69 6d61 6765 4944 272c 2027  DTI2_imageID', '
-00075020: 6474 6964 3227 2029 0a20 2020 2072 656e  dtid2' ).    ren
-00075030: 616d 6569 7428 206d 6d64 662c 2027 4454  ameit( mmdf, 'DT
-00075040: 4933 5f69 6d61 6765 4944 272c 2027 6474  I3_imageID', 'dt
-00075050: 6964 3327 2029 0a20 2020 2072 656e 616d  id3' ).    renam
-00075060: 6569 7428 206d 6d64 662c 2027 4454 4931  eit( mmdf, 'DTI1
-00075070: 5f66 696c 656e 616d 6527 2c20 2764 7466  _filename', 'dtf
-00075080: 6e31 2720 290a 2020 2020 7265 6e61 6d65  n1' ).    rename
-00075090: 6974 2820 6d6d 6466 2c20 2744 5449 325f  it( mmdf, 'DTI2_
-000750a0: 6669 6c65 6e61 6d65 272c 2027 6474 666e  filename', 'dtfn
-000750b0: 3227 2029 0a20 2020 2072 656e 616d 6569  2' ).    renamei
-000750c0: 7428 206d 6d64 662c 2027 4454 4933 5f66  t( mmdf, 'DTI3_f
-000750d0: 696c 656e 616d 6527 2c20 2764 7466 6e33  ilename', 'dtfn3
-000750e0: 2720 290a 2020 2020 666f 7220 7820 696e  ' ).    for x in
-000750f0: 2072 616e 6765 2831 2c36 293a 0a20 2020   range(1,6):.   
-00075100: 2020 2020 2074 656d 7030 3d22 4e4d 222b       temp0="NM"+
-00075110: 7374 7228 7829 2b22 5f69 6d61 6765 4944  str(x)+"_imageID
-00075120: 220a 2020 2020 2020 2020 7465 6d70 313d  ".        temp1=
-00075130: 226e 6d69 6422 2b73 7472 2878 290a 2020  "nmid"+str(x).  
-00075140: 2020 2020 2020 7265 6e61 6d65 6974 2820        renameit( 
-00075150: 6d6d 6466 2c20 7465 6d70 302c 2074 656d  mmdf, temp0, tem
-00075160: 7031 2029 0a20 2020 2020 2020 2074 656d  p1 ).        tem
-00075170: 7030 3d22 4e4d 222b 7374 7228 7829 2b22  p0="NM"+str(x)+"
-00075180: 5f66 696c 656e 616d 6522 0a20 2020 2020  _filename".     
-00075190: 2020 2074 656d 7031 3d22 6e6d 666e 222b     temp1="nmfn"+
-000751a0: 7374 7228 7829 0a20 2020 2020 2020 2072  str(x).        r
-000751b0: 656e 616d 6569 7428 206d 6d64 662c 2074  enameit( mmdf, t
-000751c0: 656d 7030 2c20 7465 6d70 3120 290a 2020  emp0, temp1 ).  
-000751d0: 2020 7265 7475 726e 206d 6d64 660a         return mmdf.
+00074fe0: 2027 7273 6631 5f66 696c 656e 616d 6527   'rsf1_filename'
+00074ff0: 2c20 2772 7366 666e 3127 2029 0a20 2020  , 'rsffn1' ).   
+00075000: 2072 656e 616d 6569 7428 206d 6d64 662c   renameit( mmdf,
+00075010: 2027 7273 6632 5f66 696c 656e 616d 6527   'rsf2_filename'
+00075020: 2c20 2772 7366 666e 3227 2029 0a20 2020  , 'rsffn2' ).   
+00075030: 2072 656e 616d 6569 7428 206d 6d64 662c   renameit( mmdf,
+00075040: 2027 4454 4931 5f69 6d61 6765 4944 272c   'DTI1_imageID',
+00075050: 2027 6474 6964 3127 2029 0a20 2020 2072   'dtid1' ).    r
+00075060: 656e 616d 6569 7428 206d 6d64 662c 2027  enameit( mmdf, '
+00075070: 4454 4932 5f69 6d61 6765 4944 272c 2027  DTI2_imageID', '
+00075080: 6474 6964 3227 2029 0a20 2020 2072 656e  dtid2' ).    ren
+00075090: 616d 6569 7428 206d 6d64 662c 2027 4454  ameit( mmdf, 'DT
+000750a0: 4933 5f69 6d61 6765 4944 272c 2027 6474  I3_imageID', 'dt
+000750b0: 6964 3327 2029 0a20 2020 2072 656e 616d  id3' ).    renam
+000750c0: 6569 7428 206d 6d64 662c 2027 4454 4931  eit( mmdf, 'DTI1
+000750d0: 5f66 696c 656e 616d 6527 2c20 2764 7466  _filename', 'dtf
+000750e0: 6e31 2720 290a 2020 2020 7265 6e61 6d65  n1' ).    rename
+000750f0: 6974 2820 6d6d 6466 2c20 2744 5449 325f  it( mmdf, 'DTI2_
+00075100: 6669 6c65 6e61 6d65 272c 2027 6474 666e  filename', 'dtfn
+00075110: 3227 2029 0a20 2020 2072 656e 616d 6569  2' ).    renamei
+00075120: 7428 206d 6d64 662c 2027 4454 4933 5f66  t( mmdf, 'DTI3_f
+00075130: 696c 656e 616d 6527 2c20 2764 7466 6e33  ilename', 'dtfn3
+00075140: 2720 290a 2020 2020 666f 7220 7820 696e  ' ).    for x in
+00075150: 2072 616e 6765 2831 2c36 293a 0a20 2020   range(1,6):.   
+00075160: 2020 2020 2074 656d 7030 3d22 4e4d 222b       temp0="NM"+
+00075170: 7374 7228 7829 2b22 5f69 6d61 6765 4944  str(x)+"_imageID
+00075180: 220a 2020 2020 2020 2020 7465 6d70 313d  ".        temp1=
+00075190: 226e 6d69 6422 2b73 7472 2878 290a 2020  "nmid"+str(x).  
+000751a0: 2020 2020 2020 7265 6e61 6d65 6974 2820        renameit( 
+000751b0: 6d6d 6466 2c20 7465 6d70 302c 2074 656d  mmdf, temp0, tem
+000751c0: 7031 2029 0a20 2020 2020 2020 2074 656d  p1 ).        tem
+000751d0: 7030 3d22 4e4d 222b 7374 7228 7829 2b22  p0="NM"+str(x)+"
+000751e0: 5f66 696c 656e 616d 6522 0a20 2020 2020  _filename".     
+000751f0: 2020 2074 656d 7031 3d22 6e6d 666e 222b     temp1="nmfn"+
+00075200: 7374 7228 7829 0a20 2020 2020 2020 2072  str(x).        r
+00075210: 656e 616d 6569 7428 206d 6d64 662c 2074  enameit( mmdf, t
+00075220: 656d 7030 2c20 7465 6d70 3120 290a 2020  emp0, temp1 ).  
+00075230: 2020 7265 7475 726e 206d 6d64 660a         return mmdf.
```

### Comparing `antspymm-1.3.5/antspymm.egg-info/PKG-INFO` & `antspymm-1.3.6/antspymm.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,22 +1,22 @@
 Metadata-Version: 2.1
 Name: antspymm
-Version: 1.3.5
+Version: 1.3.6
 Summary: multi-channel/time-series medical image processing with antspyx
-Home-page: https://github.com/stnava/ANTsPyMM
-Author: Avants, Gosselin, Tustison, Reardon
-Author-email: stnava@gmail.com
+Author-email: "Avants, Gosselin, Tustison, Reardon" <stnava@gmail.com>
 License: Apache 2.0
-Description-Content-Type: text/markdown; charset=UTF-8; variant=GFM
+Requires-Python: >=3.8
+Description-Content-Type: text/markdown
 License-File: LICENSE
 Requires-Dist: h5py>=2.10.0
 Requires-Dist: numpy>=1.19.4
 Requires-Dist: pandas>=1.0.1
 Requires-Dist: antspyx
-Requires-Dist: antspyt1w>=0.2.3
+Requires-Dist: antspynet>=0.2.5
+Requires-Dist: antspyt1w>=0.9.3
 Requires-Dist: pathlib
 Requires-Dist: dipy
 Requires-Dist: nibabel
 Requires-Dist: scipy
 Requires-Dist: siq
 Requires-Dist: scikit-learn
 
@@ -31,15 +31,15 @@
 
 this package also keeps track of the latest preferred algorithm variations for
 production environments.
 
 install the `dev` version by calling (within the source directory):
 
 ```
-python setup.py install
+python3 -m  build .
 ```
 
 or install the latest release via 
 
 ```
 pip install antspymm
 ```
@@ -446,13 +446,16 @@
 ```python
 import ssl
 ssl._create_default_https_context = ssl._create_unverified_context
 ```
 
 ## to publish a release
 
+before doing this - make sure you have a recent run of `pip-compile pyproject.toml`
+
 ```
 rm -r -f build/ antspymm.egg-info/ dist/
-python3 setup.py sdist bdist_wheel
-twine upload --repository antspymm dist/*
+python3 -m  build .
+python3 -m pip install --upgrade twine
+python3 -m twine upload --repository antspymm dist/*
 ```
```

### Comparing `antspymm-1.3.5/antspymm.egg-info/SOURCES.txt` & `antspymm-1.3.6/antspymm.egg-info/SOURCES.txt`

 * *Files 10% similar despite different names*

```diff
@@ -1,17 +1,16 @@
 LICENSE
 MANIFEST.in
 README.md
-setup.py
+pyproject.toml
 antspymm/__init__.py
 antspymm/mm.py
 antspymm.egg-info/PKG-INFO
 antspymm.egg-info/SOURCES.txt
 antspymm.egg-info/dependency_links.txt
-antspymm.egg-info/not-zip-safe
 antspymm.egg-info/requires.txt
 antspymm.egg-info/top_level.txt
 docs/adni_rsfmri_2_nrg_conversion.py
 docs/antspymm_data_dictionary.csv
 docs/bids_cohort_example.py
 docs/blind_qc.Rmd
 docs/blind_qc.html
@@ -19,38 +18,42 @@
 docs/deepnbm.jpg
 docs/example_antspymm_output.csv
 docs/example_run_from_directory.py
 docs/make_dict_table.Rmd
 docs/make_dict_table.html
 docs/nrg_cohort_example.py
 docs/ptbp_nrg.py
+docs/release_notes.py
 docs/roi_visualization.py
+docs/roi_visualization_limbic.py
 docs/roi_visualization_ppmi.py
 docs/step1_blind_qc.py
 docs/step2_outlierness.py
 docs/step3_mm_nrg_csv.py
 docs/step4_aggregate.py
 docs/ukbb_to_nrg_processing.py
 docs/ukbb_to_nrg_processing2.py
 tests/blind_qc.py
 tests/mm.py
 tests/mm_nrg.py
 tests/outlierness.py
 tests/parallel_study_aggregation_example.py
+tests/test_00_setup.py
 tests/test_bids_2_nrg.py
 tests/test_deformation_gradient_reo.py
 tests/test_dti_recon.py
 tests/test_dti_reg.py
 tests/test_dwi_rebasing.py
 tests/test_dwi_run.py
 tests/test_dwi_run_ptbp_scrub.py
 tests/test_flair_run.py
 tests/test_joint_dti_recon.py
 tests/test_mm_csv.py
 tests/test_nrg_validation.py
 tests/test_perfusion_ptbp.py
+tests/test_perfusion_ptbp2.py
 tests/test_perfusion_run.py
 tests/test_rsfmri_run.py
 tests/test_rsfmri_run_minimal.py
 tests/test_ukbb_rsfmri.py
 tests/testsr.py
 tests/visualize_tractogram.py
```

### Comparing `antspymm-1.3.5/docs/adni_rsfmri_2_nrg_conversion.py` & `antspymm-1.3.6/docs/adni_rsfmri_2_nrg_conversion.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/antspymm_data_dictionary.csv` & `antspymm-1.3.6/docs/antspymm_data_dictionary.csv`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/bids_cohort_example.py` & `antspymm-1.3.6/docs/bids_cohort_example.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/blind_qc.Rmd` & `antspymm-1.3.6/docs/blind_qc.Rmd`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/blind_qc.html` & `antspymm-1.3.6/docs/blind_qc.html`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/convert_adni_dti_to_nrg.R` & `antspymm-1.3.6/docs/convert_adni_dti_to_nrg.R`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/deepnbm.jpg` & `antspymm-1.3.6/docs/deepnbm.jpg`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/example_antspymm_output.csv` & `antspymm-1.3.6/docs/example_antspymm_output.csv`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/example_run_from_directory.py` & `antspymm-1.3.6/docs/example_run_from_directory.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/make_dict_table.Rmd` & `antspymm-1.3.6/docs/make_dict_table.Rmd`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/make_dict_table.html` & `antspymm-1.3.6/docs/make_dict_table.html`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/nrg_cohort_example.py` & `antspymm-1.3.6/docs/nrg_cohort_example.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/ptbp_nrg.py` & `antspymm-1.3.6/docs/ptbp_nrg.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/roi_visualization.py` & `antspymm-1.3.6/docs/roi_visualization.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/roi_visualization_ppmi.py` & `antspymm-1.3.6/docs/roi_visualization_ppmi.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/step1_blind_qc.py` & `antspymm-1.3.6/docs/step1_blind_qc.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/step2_outlierness.py` & `antspymm-1.3.6/docs/step2_outlierness.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/step3_mm_nrg_csv.py` & `antspymm-1.3.6/docs/step3_mm_nrg_csv.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/step4_aggregate.py` & `antspymm-1.3.6/docs/step4_aggregate.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/ukbb_to_nrg_processing.py` & `antspymm-1.3.6/docs/ukbb_to_nrg_processing.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/docs/ukbb_to_nrg_processing2.py` & `antspymm-1.3.6/docs/ukbb_to_nrg_processing2.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/blind_qc.py` & `antspymm-1.3.6/tests/blind_qc.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/mm.py` & `antspymm-1.3.6/tests/mm.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/mm_nrg.py` & `antspymm-1.3.6/tests/mm_nrg.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/outlierness.py` & `antspymm-1.3.6/tests/outlierness.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/parallel_study_aggregation_example.py` & `antspymm-1.3.6/tests/parallel_study_aggregation_example.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/test_deformation_gradient_reo.py` & `antspymm-1.3.6/tests/test_deformation_gradient_reo.py`

 * *Files 9% similar despite different names*

```diff
@@ -10,14 +10,16 @@
 import antspynet
 import ants
 import pandas as pd
 import tensorflow as tf
 from tempfile import mktemp
 import numpy as np
 import antspymm
+import sys
+sys.exit(0) # this is not an actual test that we want to run regularly
 print(" Load in JHU atlas and labels ")
 ex_path = os.path.expanduser( "~/.antspyt1w/" )
 ex_path_mm = os.path.expanduser( "~/.antspymm/" )
 JHU_atlas = ants.image_read( ex_path + 'JHU-ICBM-FA-1mm.nii.gz' ) # Read in JHU atlas
 JHU_labels = ants.image_read( ex_path + 'JHU-ICBM-labels-1mm.nii.gz' ) # Read in JHU labels
 #### Load in data ####
 template = ants.image_read( "OASIS/T_template0_BrainCerebellum_3mm.nii.gz")
```

### Comparing `antspymm-1.3.5/tests/test_dti_reg.py` & `antspymm-1.3.6/tests/test_dti_reg.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/test_dwi_rebasing.py` & `antspymm-1.3.6/tests/test_dwi_rebasing.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/test_dwi_run.py` & `antspymm-1.3.6/tests/test_dwi_run.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/test_dwi_run_ptbp_scrub.py` & `antspymm-1.3.6/tests/test_dwi_run_ptbp_scrub.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/test_joint_dti_recon.py` & `antspymm-1.3.6/tests/test_joint_dti_recon.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/test_mm_csv.py` & `antspymm-1.3.6/tests/test_mm_csv.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/test_nrg_validation.py` & `antspymm-1.3.6/tests/test_nrg_validation.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/test_perfusion_ptbp.py` & `antspymm-1.3.6/tests/test_perfusion_ptbp.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/test_perfusion_run.py` & `antspymm-1.3.6/tests/test_perfusion_run.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/test_rsfmri_run.py` & `antspymm-1.3.6/tests/test_rsfmri_run.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/test_rsfmri_run_minimal.py` & `antspymm-1.3.6/tests/test_rsfmri_run_minimal.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/test_ukbb_rsfmri.py` & `antspymm-1.3.6/tests/test_ukbb_rsfmri.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/testsr.py` & `antspymm-1.3.6/tests/testsr.py`

 * *Files identical despite different names*

### Comparing `antspymm-1.3.5/tests/visualize_tractogram.py` & `antspymm-1.3.6/tests/visualize_tractogram.py`

 * *Files identical despite different names*

