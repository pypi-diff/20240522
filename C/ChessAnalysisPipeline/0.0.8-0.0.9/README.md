# Comparing `tmp/ChessAnalysisPipeline-0.0.8.tar.gz` & `tmp/ChessAnalysisPipeline-0.0.9.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "ChessAnalysisPipeline-0.0.8.tar", last modified: Tue May 23 18:02:46 2023, max compression
+gzip compressed data, was "ChessAnalysisPipeline-0.0.9.tar", last modified: Mon Jun 26 12:53:49 2023, max compression
```

## Comparing `ChessAnalysisPipeline-0.0.8.tar` & `ChessAnalysisPipeline-0.0.9.tar`

### file list

```diff
@@ -1,69 +1,69 @@
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-23 18:02:46.241003 ChessAnalysisPipeline-0.0.8/
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-23 18:02:46.225002 ChessAnalysisPipeline-0.0.8/CHAP/
--rwxr-xr-x   0 runner    (1001) docker     (123)     6803 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/TaskManager.py
--rwxr-xr-x   0 runner    (1001) docker     (123)      897 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-23 18:02:46.225002 ChessAnalysisPipeline-0.0.8/CHAP/common/
--rwxr-xr-x   0 runner    (1001) docker     (123)     1003 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/common/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-23 18:02:46.229002 ChessAnalysisPipeline-0.0.8/CHAP/common/models/
--rwxr-xr-x   0 runner    (1001) docker     (123)      200 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/common/models/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    27175 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/common/models/integration.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    27191 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/common/models/map.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    24154 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/common/processor.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     2694 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/common/reader.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-23 18:02:46.229002 ChessAnalysisPipeline-0.0.8/CHAP/common/utils/
--rwxr-xr-x   0 runner    (1001) docker     (123)      183 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/common/utils/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (123)   121894 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/common/utils/fit.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    59457 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/common/utils/general.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    11359 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/common/utils/material.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    42703 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/common/utils/scanparsers.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     5087 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/common/writer.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-23 18:02:46.233003 ChessAnalysisPipeline-0.0.8/CHAP/edd/
--rwxr-xr-x   0 runner    (1001) docker     (123)      417 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/edd/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    11959 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/edd/models.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    23295 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/edd/processor.py
--rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/edd/reader.py
--rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/edd/writer.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-23 18:02:46.233003 ChessAnalysisPipeline-0.0.8/CHAP/inference/
--rwxr-xr-x   0 runner    (1001) docker     (123)      263 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/inference/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     2065 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/inference/processor.py
--rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/inference/reader.py
--rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/inference/writer.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     5377 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/pipeline.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     2639 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/processor.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     2534 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/reader.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     3896 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/runner.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-23 18:02:46.233003 ChessAnalysisPipeline-0.0.8/CHAP/saxswaxs/
--rwxr-xr-x   0 runner    (1001) docker     (123)      291 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/saxswaxs/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (123)       97 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/saxswaxs/processor.py
--rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/saxswaxs/reader.py
--rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/saxswaxs/writer.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     3648 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/server.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-23 18:02:46.233003 ChessAnalysisPipeline-0.0.8/CHAP/sin2psi/
--rwxr-xr-x   0 runner    (1001) docker     (123)      344 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/sin2psi/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (123)       97 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/sin2psi/processor.py
--rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/sin2psi/reader.py
--rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/sin2psi/writer.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-23 18:02:46.237002 ChessAnalysisPipeline-0.0.8/CHAP/tomo/
--rwxr-xr-x   0 runner    (1001) docker     (123)      301 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/tomo/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     8384 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/tomo/models.py
--rwxr-xr-x   0 runner    (1001) docker     (123)   135965 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/tomo/processor.py
--rwxr-xr-x   0 runner    (1001) docker     (123)      123 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/tomo/reader.py
--rwxr-xr-x   0 runner    (1001) docker     (123)      123 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/tomo/writer.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     2585 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/CHAP/writer.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-23 18:02:46.237002 ChessAnalysisPipeline-0.0.8/ChessAnalysisPipeline.egg-info/
--rw-r--r--   0 runner    (1001) docker     (123)     1197 2023-05-23 18:02:46.000000 ChessAnalysisPipeline-0.0.8/ChessAnalysisPipeline.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     1344 2023-05-23 18:02:46.000000 ChessAnalysisPipeline-0.0.8/ChessAnalysisPipeline.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (123)        1 2023-05-23 18:02:46.000000 ChessAnalysisPipeline-0.0.8/ChessAnalysisPipeline.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (123)       42 2023-05-23 18:02:46.000000 ChessAnalysisPipeline-0.0.8/ChessAnalysisPipeline.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (123)        7 2023-05-23 18:02:46.000000 ChessAnalysisPipeline-0.0.8/ChessAnalysisPipeline.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (123)       11 2023-05-23 18:02:46.000000 ChessAnalysisPipeline-0.0.8/ChessAnalysisPipeline.egg-info/top_level.txt
--rw-r--r--   0 runner    (1001) docker     (123)     1075 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/LICENSE
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-23 18:02:46.241003 ChessAnalysisPipeline-0.0.8/MLaaS/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/MLaaS/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     7467 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/MLaaS/ktrain.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     2738 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/MLaaS/mnist_img.py
--rwxr-xr-x   0 runner    (1001) docker     (123)    14889 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/MLaaS/tfaas_client.py
--rw-r--r--   0 runner    (1001) docker     (123)     1197 2023-05-23 18:02:46.241003 ChessAnalysisPipeline-0.0.8/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)      719 2023-05-23 18:02:35.000000 ChessAnalysisPipeline-0.0.8/README.md
--rw-r--r--   0 runner    (1001) docker     (123)       38 2023-05-23 18:02:46.241003 ChessAnalysisPipeline-0.0.8/setup.cfg
--rwxr-xr-x   0 runner    (1001) docker     (123)     2450 2023-05-23 18:02:39.000000 ChessAnalysisPipeline-0.0.8/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-06-26 12:53:49.696104 ChessAnalysisPipeline-0.0.9/
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-06-26 12:53:49.684104 ChessAnalysisPipeline-0.0.9/CHAP/
+-rwxr-xr-x   0 runner    (1001) docker     (123)     6803 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/TaskManager.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     1052 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-06-26 12:53:49.688104 ChessAnalysisPipeline-0.0.9/CHAP/common/
+-rwxr-xr-x   0 runner    (1001) docker     (123)      865 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/common/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-06-26 12:53:49.688104 ChessAnalysisPipeline-0.0.9/CHAP/common/models/
+-rwxr-xr-x   0 runner    (1001) docker     (123)      200 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/common/models/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    27175 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/common/models/integration.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    27149 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/common/models/map.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    26341 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/common/processor.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     2694 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/common/reader.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     5091 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/common/writer.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-06-26 12:53:49.688104 ChessAnalysisPipeline-0.0.9/CHAP/edd/
+-rwxr-xr-x   0 runner    (1001) docker     (123)      417 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/edd/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    11931 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/edd/models.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    19366 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/edd/processor.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/edd/reader.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/edd/writer.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-06-26 12:53:49.688104 ChessAnalysisPipeline-0.0.9/CHAP/inference/
+-rwxr-xr-x   0 runner    (1001) docker     (123)      263 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/inference/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     2065 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/inference/processor.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/inference/reader.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/inference/writer.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     6951 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/pipeline.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     2639 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/processor.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     2534 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/reader.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     4696 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/runner.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-06-26 12:53:49.692104 ChessAnalysisPipeline-0.0.9/CHAP/saxswaxs/
+-rwxr-xr-x   0 runner    (1001) docker     (123)      291 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/saxswaxs/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)       97 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/saxswaxs/processor.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/saxswaxs/reader.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/saxswaxs/writer.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     3648 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/server.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-06-26 12:53:49.692104 ChessAnalysisPipeline-0.0.9/CHAP/sin2psi/
+-rwxr-xr-x   0 runner    (1001) docker     (123)      344 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/sin2psi/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)       97 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/sin2psi/processor.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/sin2psi/reader.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)       94 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/sin2psi/writer.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-06-26 12:53:49.692104 ChessAnalysisPipeline-0.0.9/CHAP/tomo/
+-rwxr-xr-x   0 runner    (1001) docker     (123)      301 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/tomo/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     9040 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/tomo/models.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)   141542 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/tomo/processor.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)      123 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/tomo/reader.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)      123 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/tomo/writer.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-06-26 12:53:49.692104 ChessAnalysisPipeline-0.0.9/CHAP/utils/
+-rwxr-xr-x   0 runner    (1001) docker     (123)      183 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/utils/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)   121887 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/utils/fit.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    59457 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/utils/general.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    11359 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/utils/material.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    43781 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/utils/scanparsers.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     2585 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/CHAP/writer.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-06-26 12:53:49.696104 ChessAnalysisPipeline-0.0.9/ChessAnalysisPipeline.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (123)     1519 2023-06-26 12:53:49.000000 ChessAnalysisPipeline-0.0.9/ChessAnalysisPipeline.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     1309 2023-06-26 12:53:49.000000 ChessAnalysisPipeline-0.0.9/ChessAnalysisPipeline.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        1 2023-06-26 12:53:49.000000 ChessAnalysisPipeline-0.0.9/ChessAnalysisPipeline.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (123)       42 2023-06-26 12:53:49.000000 ChessAnalysisPipeline-0.0.9/ChessAnalysisPipeline.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        7 2023-06-26 12:53:49.000000 ChessAnalysisPipeline-0.0.9/ChessAnalysisPipeline.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (123)       11 2023-06-26 12:53:49.000000 ChessAnalysisPipeline-0.0.9/ChessAnalysisPipeline.egg-info/top_level.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     1075 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/LICENSE
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-06-26 12:53:49.696104 ChessAnalysisPipeline-0.0.9/MLaaS/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/MLaaS/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     7467 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/MLaaS/ktrain.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     2738 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/MLaaS/mnist_img.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)    14889 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/MLaaS/tfaas_client.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1519 2023-06-26 12:53:49.696104 ChessAnalysisPipeline-0.0.9/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     1041 2023-06-26 12:53:39.000000 ChessAnalysisPipeline-0.0.9/README.md
+-rw-r--r--   0 runner    (1001) docker     (123)       38 2023-06-26 12:53:49.696104 ChessAnalysisPipeline-0.0.9/setup.cfg
+-rwxr-xr-x   0 runner    (1001) docker     (123)     2429 2023-06-26 12:53:43.000000 ChessAnalysisPipeline-0.0.9/setup.py
```

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/TaskManager.py` & `ChessAnalysisPipeline-0.0.9/CHAP/TaskManager.py`

 * *Files identical despite different names*

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/__init__.py` & `ChessAnalysisPipeline-0.0.9/CHAP/__init__.py`

 * *Files 12% similar despite different names*

```diff
@@ -8,12 +8,16 @@
 
 Many `PipelineItem`s can be shared by data processing workflows for
 multiple different X-ray techniques, while others may be unique to
 just a single technique. The `PipelineItem`s that are shared by many
 techniques are organized in the `CHAP.common` subpackage.
 `PipelineItem`s unique to a tomography workflow, for instance, are
 organized in the `CHAP.tomo` subpackage.
+
+[`CHAP.utils`](CHAP.utils.md) contains a
+broad selection of utilities to assist in some common tasks that
+appear in specific `Processor` implementations.
 """
 
 from CHAP.reader import Reader
 from CHAP.processor import Processor
 from CHAP.writer import Writer
```

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/common/__init__.py` & `ChessAnalysisPipeline-0.0.9/CHAP/common/__init__.py`

 * *Files 17% similar despite different names*

```diff
@@ -1,17 +1,14 @@
 """This subpackage of `CHAP` contains `PipelineItem`s that are or can
 be used in workflows for processing data from multiple different X-ray
 techniques.
 
-In addition, `CHAP.common` contains two subpackages of its own:
+In addition, `CHAP.common` contains a subpackage of its own:
 [`CHAP.common.models`](CHAP.common.models.md) contains tools for
 validating input data in some `Processor`s.
-[`CHAP.common.utils`](CHAP.common.utils.md) contains a
-broad selection of utilities to assist in some common tasks that
-appear in specific `Processor` implementations.
 """
 
 from CHAP.common.reader import (
     BinaryFileReader,
     NexusReader,
     URLReader,
     YAMLReader,
@@ -20,14 +17,15 @@
     AsyncProcessor,
     IntegrationProcessor,
     IntegrateMapProcessor,
     MapProcessor,
     NexusToNumpyProcessor,
     NexusToXarrayProcessor,
     PrintProcessor,
+    RawDetectorDataMapProcessor,
     StrainAnalysisProcessor,
     XarrayToNexusProcessor,
     XarrayToNumpyProcessor,
 )
 from CHAP.common.writer import (
     ExtractArchiveWriter,
     NexusWriter,
```

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/common/models/integration.py` & `ChessAnalysisPipeline-0.0.9/CHAP/common/models/integration.py`

 * *Files identical despite different names*

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/common/models/map.py` & `ChessAnalysisPipeline-0.0.9/CHAP/common/models/map.py`

 * *Files 1% similar despite different names*

```diff
@@ -656,34 +656,34 @@
 
     station = station.lower()
     experiment = experiment.lower()
 
     # Local modules
     if station in ('id1a3', 'id3a'):
         if experiment in ('saxswaxs', 'powder'):
-            from CHAP.common.utils.scanparsers \
+            from CHAP.utils.scanparsers \
                 import SMBLinearScanParser as ScanParser
         elif experiment == 'edd':
-            from CHAP.common.utils.scanparsers \
+            from CHAP.utils.scanparsers \
                 import SMBMCAScanParser as ScanParser
         elif experiment == 'tomo':
-            from CHAP.common.utils.scanparsers \
+            from CHAP.utils.scanparsers \
                 import SMBRotationScanParser as ScanParser
         else:
             raise ValueError(
                 f'Invalid experiment type for station {station}: {experiment}')
     elif station == 'id3b':
         if experiment == 'saxswaxs':
-            from CHAP.common.utils.scanparsers \
+            from CHAP.utils.scanparsers \
                 import FMBSAXSWAXSScanParser as ScanParser
         elif experiment == 'tomo':
-            from CHAP.common.utils.scanparsers \
+            from CHAP.utils.scanparsers \
                 import FMBRotationScanParser as ScanParser
         elif experiment == 'xrf':
-            from CHAP.common.utils.scanparsers \
+            from CHAP.utils.scanparsers \
                 import FMBXRFScanParser as ScanParser
         else:
             raise ValueError(
                 f'Invalid experiment type for station {station}: {experiment}')
     else:
         raise ValueError(f'Invalid station: {station}')
```

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/common/processor.py` & `ChessAnalysisPipeline-0.0.9/CHAP/common/processor.py`

 * *Files 11% similar despite different names*

```diff
@@ -104,65 +104,22 @@
             least one item has the value `'IntegrationConfig'` for the
             `'schema'` key.
         :type data: list[dict[str,object]]
         :return: integrated data and process metadata
         :rtype: nexusformat.nexus.NXprocess
         """
 
-        map_config, integration_config = self.get_configs(data)
+        map_config = self.get_config(
+            data, 'common.models.map.MapConfig')
+        integration_config = self.get_config(
+            data, 'common.models.integration.IntegrationConfig')
         nxprocess = self.get_nxprocess(map_config, integration_config)
 
         return nxprocess
 
-    def get_configs(self, data):
-        """Return valid instances of `MapConfig` and
-        `IntegrationConfig` from the input supplied by
-        `MultipleReader`.
-
-        :param data: Result of `Reader.read` where at least one item
-            has the value `'MapConfig'` for the `'schema'` key, and at
-            least one item has the value `'IntegrationConfig'` for the
-            `'schema'` key.
-        :type data: list[dict[str,object]]
-        :raises ValueError: if `data` cannot be parsed into map and
-            integration configurations.
-        :return: valid map and integration configuration objects.
-        :rtype: tuple[MapConfig, IntegrationConfig]
-        """
-
-        self.logger.debug('Getting configuration objects')
-        t0 = time()
-
-        from CHAP.common.models.map import MapConfig
-        from CHAP.common.models.integration import IntegrationConfig
-
-        map_config = False
-        integration_config = False
-        if isinstance(data, list):
-            for item in data:
-                if isinstance(item, dict):
-                    schema = item.get('schema')
-                    if schema == 'MapConfig':
-                        map_config = item.get('data')
-                    elif schema == 'IntegrationConfig':
-                        integration_config = item.get('data')
-
-        if not map_config:
-            raise ValueError('No map configuration found')
-        if not integration_config:
-            raise ValueError('No integration configuration found')
-
-        map_config = MapConfig(**map_config)
-        integration_config = IntegrationConfig(**integration_config)
-
-        self.logger.debug(
-            f'Got configuration objects in {time()-t0:.3f} seconds')
-
-        return map_config, integration_config
-
     def get_nxprocess(self, map_config, integration_config):
         """Use a `MapConfig` and `IntegrationConfig` to construct a
         `nexusformat.nexus.NXprocess`
 
         :param map_config: a valid map configuration
         :type map_config: MapConfig
         :param integration_config: a valid integration configuration
@@ -316,48 +273,19 @@
         :param data: Result of `Reader.read` where at least one item
             has the value `'MapConfig'` for the `'schema'` key.
         :type data: list[dict[str,object]]
         :return: Map data & metadata
         :rtype: nexusformat.nexus.NXentry
         """
 
-        map_config = self.get_map_config(data)
+        map_config = self.get_config(data, 'common.models.map.MapConfig')
         nxentry = self.__class__.get_nxentry(map_config)
 
         return nxentry
 
-    def get_map_config(self, data):
-        """Get an instance of `MapConfig` from a returned value of
-        `Reader.read`
-
-        :param data: Result of `Reader.read` where at least one item
-            has the value `'MapConfig'` for the `'schema'` key.
-        :type data: list[dict[str,object]]
-        :raises Exception: If a valid `MapConfig` cannot be
-            constructed from `data`.
-        :return: a valid instance of `MapConfig` with field values
-            taken from `data`.
-        :rtype: MapConfig
-        """
-
-        from CHAP.common.models.map import MapConfig
-
-        map_config = False
-        if isinstance(data, list):
-            for item in data:
-                if isinstance(item, dict):
-                    if item.get('schema') == 'MapConfig':
-                        map_config = item.get('data')
-                        break
-
-        if not map_config:
-            raise ValueError('No map configuration found')
-
-        return MapConfig(**map_config)
-
     @staticmethod
     def get_nxentry(map_config):
         """Use a `MapConfig` to construct a
         `nexusformat.nexus.NXentry`
 
         :param map_config: a valid map configuration
         :type map_config: MapConfig
@@ -560,14 +488,140 @@
             print(data._str_tree(attrs=True, recursive=True))
         else:
             print(str(data))
 
         return data
 
 
+class RawDetectorDataMapProcessor(Processor):
+    """A Processor to return a map of raw derector data in an NXroot"""
+
+    def process(self, data, detector_name, detector_shape):
+        """Process configurations for a map and return the raw
+        detector data data collected over the map.
+
+        :param data: input map configuration
+        :type data: list[dict[str,object]]
+        :param detector_name: detector prefix
+        :type detector_name: str
+        :param detector_shape: shape of detector data for a single
+            scan step
+        :type detector_shape: list
+        :return: map of raw detector data
+        :rtype: nexusformat.nexus.NXroot
+        """
+
+        map_config = self.get_config(data)
+        nxroot = self.get_nxroot(map_config, detector_name, detector_shape)
+
+        return nxroot
+
+    def get_config(self, data):
+        """Get instances of the map configuration object needed by this
+        `Processor`
+
+        :param data: Result of `Reader.read` where at least one item
+            has the value `'MapConfig'` for the `'schema'` key
+        :type data: list[dict[str,object]]
+        :raises Exception: If a valid map config object cannot be
+            constructed from `data`.
+        :return: valid instances of the map configuration object with
+            field values taken from `data`.
+        :rtype: MapConfig
+        """
+        from CHAP.common.models.map import MapConfig
+
+        map_config = False
+        if isinstance(data, list):
+            for item in data:
+                if isinstance(item, dict):
+                    schema = item.get('schema')
+                    if schema == 'MapConfig':
+                        map_config = item.get('data')
+
+        if not map_config:
+            raise ValueError('No map configuration found in input data')
+
+        return MapConfig(**map_config)
+
+    def get_nxroot(self, map_config, detector_name, detector_shape):
+        """Get a map of the detector data collected by the scans in
+        `map_config`.The data will be returned along with some
+        relevant metadata in the form of a NeXus structure.
+
+        :param map_config: the map configuration
+        :type map_config: MapConfig
+        :param detector_name: detector prefix
+        :type detector_name: str
+        :param detector_shape: shape of detector data for a single
+            scan step
+        :type detector_shape: list
+        :return: a map of the raw detector data
+        :rtype: nexusformat.nexus.NXroot
+        """
+        # third party modules
+        from nexusformat.nexus import (NXdata,
+                                       NXdetector,
+                                       NXinstrument,
+                                       NXroot)
+        import numpy as np
+
+        # local modules
+        from CHAP.common import MapProcessor
+
+        nxroot = NXroot()
+
+        nxroot[map_config.title] = MapProcessor.get_nxentry(map_config)
+        nxentry = nxroot[map_config.title]
+
+        nxentry.instrument = NXinstrument()
+        nxentry.instrument.detector = NXdetector()
+
+        nxentry.instrument.detector.data = NXdata()
+        nxdata = nxentry.instrument.detector.data
+        nxdata.raw = np.empty((*map_config.shape, *detector_shape))
+        nxdata.raw.attrs['units'] = 'counts'
+        for i, det_axis_size in enumerate(detector_shape):
+            nxdata[f'detector_axis_{i}_index'] = np.arange(det_axis_size)
+
+        for scans in map_config.spec_scans:
+            for scan_number in scans.scan_numbers:
+                scanparser = scans.get_scanparser(scan_number)
+                for scan_step_index in range(scanparser.spec_scan_npts):
+                    map_index = scans.get_index(
+                        scan_number,
+                        scan_step_index,
+                        map_config)
+                    self.logger.debug(
+                        f'Adding data to nxroot for map point {map_index}')
+                    nxdata.raw[map_index] = scanparser.get_detector_data(
+                        detector_name,
+                        scan_step_index)
+
+        nxentry.data.makelink(
+            nxdata.raw,
+            name=detector_name)
+        for i, det_axis_size in enumerate(detector_shape):
+            nxentry.data.makelink(
+                nxdata[f'detector_axis_{i}_index'],
+                name=f'{detector_name}_axis_{i}_index'
+            )
+            if isinstance(nxentry.data.attrs['axes'], str):
+                nxentry.data.attrs['axes'] = [
+                    nxentry.data.attrs['axes'],
+                    f'{detector_name}_axis_{i}_index']
+            else:
+                nxentry.data.attrs['axes'] += [
+                    f'{detector_name}_axis_{i}_index']
+
+        nxentry.data.attrs['signal'] = detector_name
+
+        return nxroot
+
+
 class StrainAnalysisProcessor(Processor):
     """A Processor to compute a map of sample strains by fitting bragg
     peaks in 1D detector data and analyzing the difference between
     measured peak locations and expected peak locations for the sample
     measured.
     """
```

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/common/reader.py` & `ChessAnalysisPipeline-0.0.9/CHAP/common/reader.py`

 * *Files identical despite different names*

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/common/utils/fit.py` & `ChessAnalysisPipeline-0.0.9/CHAP/utils/fit.py`

 * *Files 0% similar despite different names*

```diff
@@ -57,15 +57,15 @@
 try:
     import xarray as xr
     HAVE_XARRAY = True
 except ImportError:
     HAVE_XARRAY = False
 
 # Local modules
-from CHAP.common.utils.general import (
+from CHAP.utils.general import (
     is_int,
     is_num,
     is_dict_series,
     is_index,
     index_nearest,
     input_num,
     quick_plot,
```

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/common/utils/general.py` & `ChessAnalysisPipeline-0.0.9/CHAP/utils/general.py`

 * *Files identical despite different names*

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/common/utils/material.py` & `ChessAnalysisPipeline-0.0.9/CHAP/utils/material.py`

 * *Files identical despite different names*

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/common/utils/scanparsers.py` & `ChessAnalysisPipeline-0.0.9/CHAP/utils/scanparsers.py`

 * *Files 1% similar despite different names*

```diff
@@ -616,15 +616,15 @@
     """
 
     def get_scan_title(self):
         return f'{self.scan_name}_scan{self.scan_number}'
 
     def get_detector_data_file(self, detector_prefix, scan_step_index:int):
         scan_step = self.get_scan_step(scan_step_index)
-        file_name = f'scan{self.scan_number}_{scan_step[1]:03d}.hdf5'
+        file_name = f'scan{self.scan_number}_{scan_step[0]:03d}.hdf5'
         file_name_full = os.path.join(self.detector_data_path, file_name)
         if os.path.isfile(file_name_full):
             return file_name_full
         raise RuntimeError(f'{self.scan_title}: could not find detector image '
                            f'file for detector {detector_prefix} scan step '
                            f'({scan_step_index})')
 
@@ -792,15 +792,15 @@
         return len(self.rotation_angles)
 
     def get_scan_type(self):
         """Return a string identifier for the type of tomography data
         being collected by this scan: df1 (dark field), bf1 (bright
         field), or tf1 (sample tomography data).
 
-        :rtype: typing.Literal['df1', 'bf1', 'tf1']
+        :rtype: typing.Literal['df1', 'bf1', 'ts1', 'tomo']
         """
         return None
 
     def get_rotation_angles(self):
         """Return the angular values visited by the rotating motor at
         each point in the scan.
 
@@ -946,18 +946,20 @@
     with the typical tomography setup at SMB.
     """
 
     def __init__(self, spec_file_name, scan_number):
         super().__init__(spec_file_name, scan_number)
 
         self._par_file_pattern = f'id*-*tomo*-{self.scan_name}'
+        self._katefix = 0  # RV remove when no longer needed
 
     def get_scan_type(self):
         scan_type = self.pars.get(
-            'tomo_type', self.pars.get('tomotype', None))
+            'tomo_type', self.pars.get(
+            'tomotype', self.pars.get('scan_type', None)))
         if scan_type is None:
             raise RuntimeError(
                 f'{self.scan_title}: cannot determine the scan_type')
         return scan_type
 
     def get_rotation_angles(self):
         return np.linspace(
@@ -978,15 +980,26 @@
         if vertical_shift is None:
             raise RuntimeError(
                 f'{self.scan_title}: cannot determine the vertical shift')
         return vertical_shift
 
     def get_starting_image_index(self):
         try:
-            return int(self.pars['junkstart'])
+            junkstart = int(self.pars['junkstart'])
+            #RV temp fix for error in par files at Kate's beamline
+            #Remove this and self._katefix when no longer needed
+            file_name = f'nf_{junkstart:06d}.tif'
+            file_name_full = os.path.join(self.detector_data_path, file_name)
+            if not os.path.isfile(file_name_full):
+                self._katefix = min([
+                    int(re.findall(r'\d+', f)[0])
+                        for f in os.listdir(self.detector_data_path)
+                        if re.match(r'nf_\d+\.tif', f)])
+            return junkstart
+            #return int(self.pars['junkstart'])
         except:
             raise RuntimeError(f'{self.scan_title}: cannot determine first '
                                'detector image index')
 
     def get_starting_image_offset(self):
         try:
             return (int(self.pars['goodstart'])
@@ -999,21 +1012,27 @@
         return os.path.join(self.scan_path, str(self.scan_number), 'nf')
 
     def get_detector_data_file(self, scan_step_index:int):
         file_name = f'nf_{self.starting_image_index+scan_step_index:06d}.tif'
         file_name_full = os.path.join(self.detector_data_path, file_name)
         if os.path.isfile(file_name_full):
             return file_name_full
+        #RV temp fix for error in par files at Kate's beamline
+        #Remove this and self._katefix when no longer needed
+        file_name = f'nf_{self.starting_image_index+scan_step_index+self._katefix:06d}.tif'
+        file_name_full = os.path.join(self.detector_data_path, file_name)
+        if os.path.isfile(file_name_full):
+            return file_name_full
         raise RuntimeError(f'{self.scan_title}: could not find detector image '
                            f'file for scan step ({scan_step_index})')
 
     def get_detector_data(self, detector_prefix, scan_step_index=None):
         if scan_step_index is None:
             detector_data = []
-            for index in range(len(self.get_spec_scan_npts())):
+            for index in range(len(self.spec_scan_npts)):
                 detector_data.append(
                     self.get_detector_data(detector_prefix, index))
             detector_data = np.asarray(detector_data)
         elif isinstance(scan_step_index, int):
             image_file = self.get_detector_data_file(scan_step_index)
             with TiffFile(image_file) as tiff_file:
                 detector_data = tiff_file.asarray()
```

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/common/writer.py` & `ChessAnalysisPipeline-0.0.9/CHAP/common/writer.py`

 * *Files 1% similar despite different names*

```diff
@@ -120,15 +120,15 @@
             `list[str]`
         :raises RuntimeError: if `filename` already exists and
             `force_overwrite` is `False`.
         :return: the original input data
         :rtype: str, tuple, list
         """
         # Local modules
-        from .utils.general import is_str_series
+        from CHAP.utils.general import is_str_series
 
         data = self.unwrap_pipelinedata(data)
 
         if not isinstance(data, str) and not is_str_series(data, log=False):
             raise TypeError(
                 f'{self.__name__}.write: input data must be a str or a tuple or '
                 'list of str.')
```

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/edd/models.py` & `ChessAnalysisPipeline-0.0.9/CHAP/edd/models.py`

 * *Files 1% similar despite different names*

```diff
@@ -9,15 +9,15 @@
                       FilePath,
                       root_validator,
                       validator)
 from scipy.interpolate import interp1d
 from typing import Literal, Optional
 
 # local modules
-from CHAP.common.utils.scanparsers import SMBMCAScanParser as ScanParser
+from CHAP.utils.scanparsers import SMBMCAScanParser as ScanParser
 
 
 class MCAScanDataConfig(BaseModel):
     """Class representing metadata required to locate raw MCA data for
     a single scan and construct a mask for it.
 
     :ivar spec_file: Path to the SPEC file containing the scan
@@ -275,21 +275,21 @@
         flux = np.loadtxt(self.flux_file)
         energies = flux[:,0]/1.e3
         relative_intensities = flux[:,1]/np.max(flux[:,1])
         interpolation_function = interp1d(energies, relative_intensities)
         return interpolation_function
 
     def material(self):
-        """Get CeO2 as a `CHAP.common.utils.material.Material` object.
+        """Get CeO2 as a `CHAP.utils.material.Material` object.
 
         :return: CeO2 material
-        :rtype: CHAP.common.utils.material.Material
+        :rtype: CHAP.utils.material.Material
         """
         # local modules
-        from CHAP.common.utils.material import Material
+        from CHAP.utils.material import Material
 
         material = Material(
             material_name=self.hexrd_h5_material_name,
             material_file=self.hexrd_h5_material_file,
             lattice_parameters_angstroms=self.lattice_parameter_angstrom)
         # The following kwargs will be needed if we allow the material to be
         # built using xrayutilities (for now, we only allow hexrd to make the
```

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/edd/processor.py` & `ChessAnalysisPipeline-0.0.9/CHAP/edd/processor.py`

 * *Files 8% similar despite different names*

```diff
@@ -38,51 +38,21 @@
         :param interactive: allow for user interactions, defaults to
             False
         :type interactive: bool, optional
         :return: complete DVL configuraiton dictionary
         :rtype: dict
         """
 
-        dvl_config = self.get_config(data)
+        dvl_config = self.get_config(
+            data, 'edd.models.DiffractionVolumeLengthConfig')
         dvl = self.measure_dvl(dvl_config, interactive=interactive)
         dvl_config.dvl_measured = dvl
 
         return dvl_config.dict()
 
-    def get_config(self, data):
-        """Get an instance of the configuration object needed by this
-        `Processor` from a returned value of `Reader.read`
-
-        :param data: Result of `Reader.read` where at least one item
-            has the value `'MCACeriaCalibrationConfig'` for the
-            `'schema'` key.
-        :type data: list[dict[str,object]]
-        :raises Exception: If a valid config object cannot be
-            constructed from `data`.
-        :return: a valid instance of a configuration object with field
-            values taken from `data`.
-        :rtype: MCACeriaCalibrationConfig
-        """
-        # local modules
-        from CHAP.edd.models import DiffractionVolumeLengthConfig
-
-        dvl_config = False
-        if isinstance(data, list):
-            for item in data:
-                if isinstance(item, dict):
-                    if item.get('schema') == 'DiffractionVolumeLengthConfig':
-                        dvl_config = item.get('data')
-                        break
-
-        if not dvl_config:
-            raise ValueError(
-                'No DVL calculation configuration found in input data')
-
-        return DiffractionVolumeLengthConfig(**dvl_config)
-
     def measure_dvl(self, dvl_config, interactive=False):
         """Return a measured value for the length of the diffraction
         volume. Use the iron foil raster scan data provided in
         `dvl_config` and fit a gaussian to the sum of all MCA channel
         counts vs scanned motor position in the raster scan. The
         computed diffraction volume length is approximately equal to
         the standard deviation of the fitted peak.
@@ -100,16 +70,16 @@
         :param interactive: allow for user interactions, defaults to
             False
         :type interactive: bool, optional
         :return: calculated diffraction volume length
         :rtype: float
         """
 
-        from CHAP.common.utils.fit import Fit
-        from CHAP.common.utils.general import draw_mask_1d
+        from CHAP.utils.fit import Fit
+        from CHAP.utils.general import draw_mask_1d
 
         # Get raw MCA data from raster scan
         mca_data = dvl_config.mca_data()
 
         # Interactively set mask, if needed & possible.
         if dvl_config.include_bin_ranges is None:
             if interactive:
@@ -152,15 +122,15 @@
         # "Normalize" the masked summed data and fit a gaussian to it
         y = (masked_sum - min(masked_sum)) / max(masked_sum)
         fit = Fit.fit_data(y, 'gaussian', x=x, normalize=False)
 
         # Calculate / manually select diffraction volume length
         dvl = fit.best_values['sigma'] * dvl_config.sigma_to_dvl_factor
         if interactive:
-            from CHAP.common.utils.general import input_yesno
+            from CHAP.utils.general import input_yesno
             manual_dvl = input_yesno(
                 'Indicate the diffraction volume length manually? (y/n)',
                 default='y')
             if manual_dvl:
                 dvl_config.measurement_mode = 'manual'
                 mask, dvl_bounds = draw_mask_1d(
                     y, xdata=x,
@@ -201,56 +171,26 @@
             False
         :type interactive: bool, optional
         :return: original configuration dictionary with tuned values
             added
         :rtype: dict[str,float]
         """
 
-        calibration_config = self.get_config(data)
+        calibration_config = self.get_config(
+            data, 'edd.models.MCACeriaCalibrationConfig')
 
         tth, slope, intercept = self.calibrate(calibration_config,
                                                interactive=interactive)
 
         calibration_config.tth_calibrated = tth
         calibration_config.slope_calibrated = slope
         calibration_config.intercept_calibrated = intercept
 
         return calibration_config.dict()
 
-    def get_config(self, data):
-        """Get an instance of the configuration object needed by this
-        `Processor` from a returned value of `Reader.read`
-
-        :param data: Result of `Reader.read` where at least one item
-            has the value `'MCACeriaCalibrationConfig'` for the
-            `'schema'` key.
-        :type data: list[dict[str,object]]
-        :raises Exception: If a valid config object cannot be
-            constructed from `data`.
-        :return: a valid instance of a configuration object with field
-            values taken from `data`.
-        :rtype: MCACeriaCalibrationConfig
-        """
-        # local modules
-        from CHAP.edd.models import MCACeriaCalibrationConfig
-
-        calibration_config = False
-        if isinstance(data, list):
-            for item in data:
-                if isinstance(item, dict):
-                    if item.get('schema') == 'MCACeriaCalibrationConfig':
-                        calibration_config = item.get('data')
-                        break
-
-        if not calibration_config:
-            raise ValueError(
-                'No MCA ceria calibration configuration found in input data')
-
-        return MCACeriaCalibrationConfig(**calibration_config)
-
     def calibrate(self, calibration_config, interactive=False):
         """Iteratively calibrate 2&theta by fitting selected peaks of
         an MCA spectrum until the computed strain is sufficiently
         small. Use the fitted peak locations to determine linear
         correction parameters for the MCA's channel energies.
 
         :param calibration_config: object configuring the CeO2
@@ -264,29 +204,29 @@
             intercept
         :rtype: float, float, float
         """
         # third party modules
         from scipy.constants import physical_constants
 
         # local modules
-        from CHAP.common.utils.fit import Fit, FitMultipeak
+        from CHAP.utils.fit import Fit, FitMultipeak
 
         # We'll work in keV and A, not eV and m.
         hc = 1e7 * physical_constants['Planck constant in eV/Hz'][0] \
             * physical_constants['speed of light in vacuum'][0]
 
         # Collect raw MCA data of interest
         mca_data = calibration_config.mca_data()
         mca_bin_energies = np.arange(0, calibration_config.num_bins) \
             * (calibration_config.max_energy_kev/calibration_config.num_bins)
 
         # Mask out the corrected MCA data for fitting
         if calibration_config.include_bin_ranges is None:
             if interactive:
-                from CHAP.common.utils.general import draw_mask_1d
+                from CHAP.utils.general import draw_mask_1d
                 mask, include_bin_ranges = draw_mask_1d(
                     mca_data,
                     xdata=mca_bin_energies,
                     title='Click and drag to select ranges of Ceria'
                            +' calibration data to include',
                     xlabel='MCA channel energy (keV)',
                     ylabel='MCA intensity (counts)')
@@ -307,15 +247,15 @@
         fit_mca_intensities = fit_mca_intensities/mca_intensity_weights
 
         # Get the HKLs and lattice spacings that will be used for
         # fitting
         tth = calibration_config.tth_initial_guess
         if calibration_config.fit_hkls is None:
             if interactive:
-                from CHAP.common.utils.general import select_peaks
+                from CHAP.utils.general import select_peaks
                 hkls, ds = calibration_config.unique_ds()
                 peak_locations = hc / (2. * ds * np.sin(0.5 * np.radians(tth)))
                 selected_peaks = select_peaks(
                     mca_data, mca_bin_energies, peak_locations,
                     mask=mca_mask)
                 fit_hkls = [np.where(peak_locations == peak)[0][0]
                             for peak in selected_peaks]
@@ -422,58 +362,22 @@
         :param data: input map configuration and results of ceria
             calibration
         :type data: list[dict[str,object]]
         :return: calibrated and flux-corrected MCA data
         :rtype: nexusformat.nexus.NXentry
         """
 
-        map_config, calibration_config = self.get_configs(data)
+        map_config = self.get_config(
+            data, 'common.models.map.MapConfig')
+        calibration_config = self.get_config(
+            data, 'edd.models.MCACeriaCalibrationConfig')
         nxroot = self.get_nxroot(map_config, calibration_config)
 
         return nxroot
 
-    def get_configs(self, data):
-        """Get instances of the configuration objects needed by this
-        `Processor` from a returned value of `Reader.read`
-
-        :param data: Result of `Reader.read` where at least one item
-            has the value `'MapConfig'` for the `'schema'` key, and at
-            least one item has the value `'MCACeriaCalibrationConfig'`
-            for the `'schema'` key.
-        :type data: list[dict[str,object]]
-        :raises Exception: If valid config objects cannot be
-            constructed from `data`.
-        :return: valid instances of the configuration objects with
-            field values taken from `data`.
-        :rtype: tuple[MapConfig, MCACeriaCalibrationConfig]
-        """
-        # local modules
-        from CHAP.common.models.map import MapConfig
-        from CHAP.edd.models import MCACeriaCalibrationConfig
-
-        map_config = False
-        calibration_config = False
-        if isinstance(data, list):
-            for item in data:
-                if isinstance(item, dict):
-                    schema = item.get('schema')
-                    if schema == 'MapConfig':
-                        map_config = item.get('data')
-                    elif schema == 'MCACeriaCalibrationConfig':
-                        calibration_config = item.get('data')
-
-        if not map_config:
-            raise ValueError('No map configuration found in input data')
-        if not calibration_config:
-            raise ValueError('No MCA ceria calibration configuration found in '
-                             'input data')
-
-        return (MapConfig(**map_config),
-                MCACeriaCalibrationConfig(**calibration_config))
-
     def get_nxroot(self, map_config, calibration_config):
         """Get a map of the MCA data collected by the scans in
         `map_config`. The MCA data will be calibrated and
         flux-corrected according to the parameters included in
         `calibration_config`. The data will be returned along with
         relevant metadata in the form of a NeXus structure.
```

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/inference/processor.py` & `ChessAnalysisPipeline-0.0.9/CHAP/inference/processor.py`

 * *Files identical despite different names*

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/pipeline.py` & `ChessAnalysisPipeline-0.0.9/CHAP/pipeline.py`

 * *Files 26% similar despite different names*

```diff
@@ -79,14 +79,56 @@
         values = [d['data'] for d in data]
 
         if len(values) == 1:
             return values[0]
 
         return values
 
+    def get_config(self, data, schema, remove=True):
+        """Look through `data` for an item whose value for the
+        `'schema'` key matches `schema`. Convert the value for that
+        item's `'data'` key into the configuration `BaseModel`
+        identified by `schema` and return it.
+
+        :param data: input data from a previous `PipelineItem`
+        :type data: list[PipelineData]
+        :param schema: name of the `BaseModel` class to match in
+            `data` & return
+        :type schema: str
+        :param remove: if there is a matching entry in `data`, remove
+           it from the list, defaults to `True`.
+        :type remove: bool, optional
+        :raises ValueError: if there's no match for `schema` in `data`
+        :return: matching configuration model
+        :rtype: BaseModel
+        """
+
+        self.logger.debug(f'Getting {schema} configuration')
+        t0 = time()
+
+        matching_config = False
+        for i, d in enumerate(data):
+            _schema = d.get('schema')
+            if _schema == schema:
+                matching_config = d.get('data')
+                if remove:
+                    data.pop(i)
+
+        if not matching_config:
+            raise ValueError(f'No configuration for {schema} found')
+
+        mod_name, cls_name = schema.rsplit('.', 1)
+        module = __import__(f'CHAP.{mod_name}', fromlist=cls_name)
+        model_config = getattr(module, cls_name)(**matching_config)
+
+        self.logger.debug(
+            f'Got {schema} configuration in {time()-t0:.3f} seconds')
+
+        return model_config
+
     def execute(self, schema=None, **kwargs):
         """Run the appropriate method of the object and return the
         result.
 
         :param schema: the name of a schema associated with the data
             that will be returned
         :type schema: str
```

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/processor.py` & `ChessAnalysisPipeline-0.0.9/CHAP/processor.py`

 * *Files identical despite different names*

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/reader.py` & `ChessAnalysisPipeline-0.0.9/CHAP/reader.py`

 * *Files identical despite different names*

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/runner.py` & `ChessAnalysisPipeline-0.0.9/CHAP/runner.py`

 * *Files 18% similar despite different names*

```diff
@@ -27,14 +27,18 @@
         self.parser.add_argument(
             '--log-level', choices=logging._nameToLevel.keys(),
             dest='log_level', default='INFO', help='logging level')
         self.parser.add_argument(
             '--profile', action='store_true', dest='profile',
             help='profile output')
 
+def parser():
+    """Return the parser from `OptionParser`."""
+    optmgr = OptionParser()
+    return optmgr.parser
 
 def main():
     """Main function"""
     optmgr = OptionParser()
     opts = optmgr.parser.parse_args()
     if opts.profile:
         from cProfile import runctx  # python profiler
@@ -94,17 +98,33 @@
         if isinstance(item, dict):
             name = list(item.keys())[0]
             # Combine the "interactive" command line argument with the object's keywords
             # giving precedence of "interactive" in the latter
             kwargs = {**kwargs, **item[name]}
         else:
             name = item
-        modName, clsName = name.split('.')
-        module = __import__(f'CHAP.{modName}', fromlist=[clsName])
-        obj = getattr(module, clsName)()
+        if "users" in name:
+            # load users module. This is required in CHAPaaS which can
+            # have common area for users module. Otherwise, we will be
+            # required to have invidual user's PYTHONPATHs to load user
+            # processors.
+            try:
+                import users
+            except ImportError:
+                if logger:
+                    logger.error(f'Unable to load {name}')
+                continue
+            clsName = name.split('.')[-1]
+            modName = '.'.join(name.split('.')[:-1])
+            module = __import__(modName, fromlist=[clsName])
+            obj = getattr(module, clsName)()
+        else:
+            modName, clsName = name.split('.')
+            module = __import__(f'CHAP.{modName}', fromlist=[clsName])
+            obj = getattr(module, clsName)()
         if log_level:
             obj.logger.setLevel(log_level)
         if log_handler:
             obj.logger.addHandler(log_handler)
         if logger:
             logger.info(f'Loaded {obj}')
         objects.append(obj)
```

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/server.py` & `ChessAnalysisPipeline-0.0.9/CHAP/server.py`

 * *Files identical despite different names*

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/tomo/models.py` & `ChessAnalysisPipeline-0.0.9/CHAP/tomo/models.py`

 * *Files 18% similar despite different names*

```diff
@@ -48,14 +48,20 @@
     reconstruction setup processor.
 
     :ivar detector: Detector used in the tomography experiment.
     :type detector: Detector
     :ivar include_raw_data: Flag to designate whether raw data will be
         included (True) or not (False), defaults to False.
     :type include_raw_data: bool, optional
+    :ivar dark_field: A list of dark field spec scans (only required for
+        id3b style experiments).
+    :type dark_field: list[SpecScans], optional
+    :ivar bright_field: A list of bright field spec scans (only required
+        for id3b style experiments).
+    :type bright_field: list[SpecScans], optional
     """
     detector: Detector.construct()
     include_raw_data: Optional[StrictBool] = False
     dark_field: Optional[conlist(item_type=SpecScans, min_items=1)]
     bright_field: Optional[conlist(item_type=SpecScans, min_items=1)]
 
 
@@ -67,14 +73,20 @@
     :ivar detector: Detector used in the tomography experiment.
     :type detector: Detector
     :ivar img_x_bounds: Detector image bounds in the x-direction.
     :type img_x_bounds: list[int], optional
     :ivar delta_theta: Rotation angle increment in image reduction
         in degrees.
     :type delta_theta: float, optional
+    :ivar dark_field: A list of dark field spec scans (only required for
+        id3b style experiments).
+    :type dark_field: list[SpecScans], optional
+    :ivar bright_field: A list of bright field spec scans (only required
+        for id3b style experiments).
+    :type bright_field: list[SpecScans], optional
     """
     detector: Detector = Detector.construct()
     img_x_bounds: Optional[
         conlist(item_type=conint(ge=-1), min_items=2, max_items=2)]
     delta_theta: Optional[confloat(gt=1, allow_inf_nan=False)]
     dark_field: Optional[conlist(item_type=SpecScans, min_items=1)]
     bright_field: Optional[conlist(item_type=SpecScans, min_items=1)]
@@ -167,20 +179,20 @@
 
 
 class TomoSimConfig(BaseModel):
     """
     Class representing the configuration for the tomography simulator.
 
     :ivar station: The station name (in 'idxx' format).
-    :type station: str
+    :type station: Literal['id1a3', 'id3a', 'id3b']
     :ivar detector: Detector used in the tomography experiment.
     :type detector: Detector
-    :ivar sample_type: Sample type for the tomography simulator, one of
-        "square_rod", "square_pipe", "hollow_cube", or "hollow_brick".
-    :type sample_type: str
+    :ivar sample_type: Sample type for the tomography simulator.
+    :type sample_type: Literal['square_rod', 'square_pipe',
+        'hollow_cube', 'hollow_brick']
     :ivar sample_size: Size of each sample dimension in mm (internally
         converted to an integer number of pixels).
     :type sample_size: list[float]
     :ivar wall_thickness: Wall thickness for pipe, cube, and brick in
         mm (internally converted to an integer number of pixels).
     :type wall_thickness: float
     :ivar mu: Linear attenuation coefficient in mm^-1, defaults to 0.05.
@@ -189,19 +201,19 @@
         simulation in degrees.
     :type theta_step: float
     :ivar beam_intensity: Initial beam intensity in counts,
         defaults to 1.e9.
     :type beam_intensity: float, optional
     :ivar background_intensity: Background intensity in counts,
         defaults to 20.
-    :type beam_intensity: float, optional
+    :type background_intensity:: float, optional
     :ivar slit_size: Vertical beam height in mm, defaults to 1.0.
-    :type beam_intensity: float, optional
+    :type slit_size:: float, optional
     """
-    station: Literal['id1a3','id3a','id3b']
+    station: Literal['id1a3', 'id3a', 'id3b']
     detector: Detector.construct()
     sample_type: Literal[
         'square_rod', 'square_pipe', 'hollow_cube', 'hollow_brick']
     sample_size: conlist(
         item_type=confloat(gt=0, allow_inf_nan=False),
         min_items=1, max_items=2)
     wall_thickness: Optional[confloat(ge=0, allow_inf_nan=False)]
```

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/tomo/processor.py` & `ChessAnalysisPipeline-0.0.9/CHAP/tomo/processor.py`

 * *Files 6% similar despite different names*

```diff
@@ -20,8479 +20,8828 @@
 00000130: 696d 706f 7274 2065 7869 7420 6173 2073  import exit as s
 00000140: 7973 5f65 7869 740a 6672 6f6d 2074 696d  ys_exit.from tim
 00000150: 6520 696d 706f 7274 2074 696d 650a 0a23  e import time..#
 00000160: 2054 6869 7264 2070 6172 7479 206d 6f64   Third party mod
 00000170: 756c 6573 0a69 6d70 6f72 7420 6e75 6d70  ules.import nump
 00000180: 7920 6173 206e 700a 0a23 204c 6f63 616c  y as np..# Local
 00000190: 206d 6f64 756c 6573 0a66 726f 6d20 4348   modules.from CH
-000001a0: 4150 2e63 6f6d 6d6f 6e2e 7574 696c 732e  AP.common.utils.
-000001b0: 6765 6e65 7261 6c20 696d 706f 7274 2028  general import (
-000001c0: 0a20 2020 2069 735f 6e75 6d2c 0a20 2020  .    is_num,.   
-000001d0: 2069 6e70 7574 5f69 6e74 2c0a 2020 2020   input_int,.    
-000001e0: 696e 7075 745f 6e75 6d2c 0a20 2020 2069  input_num,.    i
-000001f0: 6e70 7574 5f79 6573 6e6f 2c0a 2020 2020  nput_yesno,.    
-00000200: 7365 6c65 6374 5f69 6d61 6765 5f62 6f75  select_image_bou
-00000210: 6e64 732c 0a20 2020 2073 656c 6563 745f  nds,.    select_
-00000220: 6f6e 655f 696d 6167 655f 626f 756e 642c  one_image_bound,
-00000230: 0a20 2020 2064 7261 775f 6d61 736b 5f31  .    draw_mask_1
-00000240: 642c 0a20 2020 2063 6c65 6172 5f70 6c6f  d,.    clear_plo
-00000250: 742c 0a20 2020 2063 6c65 6172 5f69 6d73  t,.    clear_ims
-00000260: 686f 772c 0a20 2020 2071 7569 636b 5f70  how,.    quick_p
-00000270: 6c6f 742c 0a20 2020 2071 7569 636b 5f69  lot,.    quick_i
-00000280: 6d73 686f 772c 0a29 0a66 726f 6d20 4348  mshow,.).from CH
-00000290: 4150 2e63 6f6d 6d6f 6e2e 7574 696c 732e  AP.common.utils.
-000002a0: 6669 7420 696d 706f 7274 2046 6974 0a66  fit import Fit.f
-000002b0: 726f 6d20 4348 4150 2e70 726f 6365 7373  rom CHAP.process
-000002c0: 6f72 2069 6d70 6f72 7420 5072 6f63 6573  or import Proces
-000002d0: 736f 720a 6672 6f6d 2043 4841 502e 7265  sor.from CHAP.re
-000002e0: 6164 6572 2069 6d70 6f72 7420 6d61 696e  ader import main
-000002f0: 0a0a 4e55 4d5f 434f 5245 5f54 4f4d 4f50  ..NUM_CORE_TOMOP
-00000300: 595f 4c49 4d49 5420 3d20 3234 0a0a 0a63  Y_LIMIT = 24...c
-00000310: 6c61 7373 2054 6f6d 6f44 6174 6150 726f  lass TomoDataPro
-00000320: 6365 7373 6f72 2850 726f 6365 7373 6f72  cessor(Processor
-00000330: 293a 0a20 2020 2022 2222 0a20 2020 2041  ):.    """.    A
-00000340: 2070 726f 6365 7373 6f72 2074 6f20 7265   processor to re
-00000350: 636f 6e73 7472 7563 7420 6120 7365 7420  construct a set 
-00000360: 6f66 2074 6f6d 6f67 7261 7068 6963 2069  of tomographic i
-00000370: 6d61 6765 7320 7265 7475 726e 696e 670a  mages returning.
-00000380: 2020 2020 6569 7468 6572 2061 2064 6963      either a dic
-00000390: 7469 6f6e 6172 7920 6f72 2061 2060 6e65  tionary or a `ne
-000003a0: 7875 7366 6f72 6d61 742e 6e65 7875 732e  xusformat.nexus.
-000003b0: 4e58 726f 6f74 6020 6f62 6a65 6374 0a20  NXroot` object. 
-000003c0: 2020 2063 6f6e 7461 696e 696e 6720 7468     containing th
-000003d0: 6520 286d 6574 6129 2064 6174 6120 6166  e (meta) data af
-000003e0: 7465 7220 7072 6f63 6573 7369 6e67 2065  ter processing e
-000003f0: 6163 6820 696e 6469 7669 6475 616c 2073  ach individual s
-00000400: 7465 702e 0a20 2020 2022 2222 0a0a 2020  tep..    """..  
-00000410: 2020 6465 6620 7072 6f63 6573 7328 0a20    def process(. 
-00000420: 2020 2020 2020 2020 2020 2073 656c 662c             self,
-00000430: 2064 6174 612c 2069 6e74 6572 6163 7469   data, interacti
-00000440: 7665 3d46 616c 7365 2c20 7265 6475 6365  ve=False, reduce
-00000450: 5f64 6174 613d 4661 6c73 652c 0a20 2020  _data=False,.   
-00000460: 2020 2020 2020 2020 2066 696e 645f 6365           find_ce
-00000470: 6e74 6572 3d46 616c 7365 2c20 7265 636f  nter=False, reco
-00000480: 6e73 7472 7563 745f 6461 7461 3d46 616c  nstruct_data=Fal
-00000490: 7365 2c20 636f 6d62 696e 655f 6461 7461  se, combine_data
-000004a0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-000004b0: 2020 2020 6f75 7470 7574 5f66 6f6c 6465      output_folde
-000004c0: 723d 272e 272c 2073 6176 655f 6669 6773  r='.', save_figs
-000004d0: 3d4e 6f6e 652c 202a 2a6b 7761 7267 7329  =None, **kwargs)
-000004e0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-000004f0: 2020 2020 2020 5072 6f63 6573 7320 7468        Process th
-00000500: 6520 6f75 7470 7574 206f 6620 6120 6052  e output of a `R
-00000510: 6561 6465 7260 2074 6861 7420 636f 6e74  eader` that cont
-00000520: 6169 6e73 2061 206d 6170 206f 7220 610a  ains a map or a.
-00000530: 2020 2020 2020 2020 606e 6578 7573 666f          `nexusfo
-00000540: 726d 6174 2e6e 6578 7573 2e4e 5872 6f6f  rmat.nexus.NXroo
-00000550: 7460 206f 626a 6563 7420 616e 6420 6f6e  t` object and on
-00000560: 6520 7468 6174 2063 6f6e 7461 696e 7320  e that contains 
-00000570: 7468 6520 7374 6570 0a20 2020 2020 2020  the step.       
-00000580: 2073 7065 6369 6669 6320 696e 7374 7275   specific instru
-00000590: 6374 696f 6e73 2061 6e64 2072 6574 7572  ctions and retur
-000005a0: 6e20 6569 7468 6572 2061 2064 6963 7469  n either a dicti
-000005b0: 6f6e 6172 7920 6f72 2061 0a20 2020 2020  onary or a.     
-000005c0: 2020 2060 6e65 7875 7366 6f72 6d61 742e     `nexusformat.
-000005d0: 6e65 7875 732e 4e58 726f 6f74 6020 7769  nexus.NXroot` wi
-000005e0: 7468 2074 6865 2070 726f 6365 7373 6564  th the processed
-000005f0: 2072 6573 756c 742e 0a0a 2020 2020 2020   result...      
-00000600: 2020 3a70 6172 616d 2064 6174 613a 2049    :param data: I
-00000610: 6e70 7574 2063 6f6e 6669 6775 7261 7469  nput configurati
-00000620: 6f6e 2066 6f72 2074 6865 2069 6e64 6976  on for the indiv
-00000630: 6964 7561 6c20 7374 6570 7320 696e 2074  idual steps in t
-00000640: 6865 0a20 2020 2020 2020 2020 2020 2074  he.            t
-00000650: 6f6d 6f67 7261 7068 6963 2069 6d61 6765  omographic image
-00000660: 2072 6564 7563 7469 6f6e 2e0a 2020 2020   reduction..    
-00000670: 2020 2020 3a74 7970 6520 6461 7461 3a20      :type data: 
-00000680: 6c69 7374 5b50 6970 656c 696e 6544 6174  list[PipelineDat
-00000690: 615d 0a20 2020 2020 2020 203a 7061 7261  a].        :para
-000006a0: 6d20 696e 7465 7261 6374 6976 653a 2041  m interactive: A
-000006b0: 6c6c 6f77 7320 666f 7220 7573 6572 2069  llows for user i
-000006c0: 6e74 6572 6163 7469 6f6e 732c 0a20 2020  nteractions,.   
-000006d0: 2020 2020 2020 2020 2064 6566 6175 6c74           default
-000006e0: 7320 746f 2046 616c 7365 2e0a 2020 2020  s to False..    
-000006f0: 2020 2020 3a74 7970 6520 626f 6f6c 2c20      :type bool, 
-00000700: 6f70 7469 6f6e 616c 0a20 2020 2020 2020  optional.       
-00000710: 203a 7061 7261 6d20 7265 6475 6365 5f64   :param reduce_d
-00000720: 6174 613a 2047 656e 6572 6174 6520 7265  ata: Generate re
-00000730: 6475 6365 6420 746f 6d6f 6772 6170 6879  duced tomography
-00000740: 2069 6d61 6765 732c 0a20 2020 2020 2020   images,.       
-00000750: 2020 2020 2064 6566 6175 6c74 7320 746f       defaults to
-00000760: 2046 616c 7365 2e0a 2020 2020 2020 2020   False..        
-00000770: 3a74 7970 6520 626f 6f6c 2c20 6f70 7469  :type bool, opti
-00000780: 6f6e 616c 0a20 2020 2020 2020 203a 7061  onal.        :pa
-00000790: 7261 6d20 6669 6e64 5f63 656e 7465 723a  ram find_center:
-000007a0: 2046 696e 6420 7468 6520 6361 6c69 6272   Find the calibr
-000007b0: 6174 6564 2063 656e 7465 7220 6178 6973  ated center axis
-000007c0: 2069 6e66 6f2c 0a20 2020 2020 2020 2020   info,.         
-000007d0: 2020 2064 6566 6175 6c74 7320 746f 2046     defaults to F
-000007e0: 616c 7365 2e0a 2020 2020 2020 2020 3a74  alse..        :t
-000007f0: 7970 6520 626f 6f6c 2c20 6f70 7469 6f6e  ype bool, option
-00000800: 616c 0a20 2020 2020 2020 203a 7061 7261  al.        :para
-00000810: 6d20 7265 636f 6e73 7472 7563 745f 6461  m reconstruct_da
-00000820: 7461 3a20 5265 636f 6e73 7472 7563 7420  ta: Reconstruct 
-00000830: 7468 6520 746f 6d6f 6772 6170 6879 2064  the tomography d
-00000840: 6174 612c 0a20 2020 2020 2020 2020 2020  ata,.           
-00000850: 2064 6566 6175 6c74 7320 746f 2046 616c   defaults to Fal
-00000860: 7365 2e0a 2020 2020 2020 2020 3a74 7970  se..        :typ
-00000870: 6520 626f 6f6c 2c20 6f70 7469 6f6e 616c  e bool, optional
-00000880: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00000890: 636f 6d62 696e 655f 6461 7461 3a20 436f  combine_data: Co
-000008a0: 6d62 696e 6520 7468 6520 7265 636f 6e73  mbine the recons
-000008b0: 7472 7563 7465 6420 746f 6d6f 6772 6170  tructed tomograp
-000008c0: 6879 0a20 2020 2020 2020 2020 2020 2073  hy.            s
-000008d0: 7461 636b 732c 2064 6566 6175 6c74 7320  tacks, defaults 
-000008e0: 746f 2046 616c 7365 2e0a 2020 2020 2020  to False..      
-000008f0: 2020 3a74 7970 6520 626f 6f6c 2c20 6f70    :type bool, op
-00000900: 7469 6f6e 616c 0a20 2020 2020 2020 203a  tional.        :
-00000910: 7061 7261 6d20 6f75 7470 7574 5f66 6f6c  param output_fol
-00000920: 6465 723a 204f 7574 7075 7420 666f 6c64  der: Output fold
-00000930: 6572 206e 616d 652c 2064 6566 6175 6c74  er name, default
-00000940: 7320 746f 2027 2e27 2e0a 2020 2020 2020  s to '.'..      
-00000950: 2020 3a74 7970 6520 7374 722c 206f 7074    :type str, opt
-00000960: 696f 6e61 6c0a 2020 2020 2020 2020 3a70  ional.        :p
-00000970: 6172 616d 2073 6176 655f 6669 6773 3a20  aram save_figs: 
-00000980: 4469 7370 6c61 7920 616e 642f 6f72 2073  Display and/or s
-00000990: 6176 6520 6669 6775 7265 7320 746f 2066  ave figures to f
-000009a0: 696c 652e 0a20 2020 2020 2020 203a 7479  ile..        :ty
-000009b0: 7065 2073 7472 2c20 6f70 7469 6f6e 616c  pe str, optional
-000009c0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-000009d0: 3a20 5072 6f63 6573 7365 6420 286d 6574  : Processed (met
-000009e0: 6129 6461 7461 206f 6620 7468 6520 6c61  a)data of the la
-000009f0: 7374 2073 7465 702e 0a20 2020 2020 2020  st step..       
-00000a00: 203a 7274 7970 653a 2064 6963 7420 6f72   :rtype: dict or
-00000a10: 206e 6578 7573 666f 726d 6174 2e6e 6578   nexusformat.nex
-00000a20: 7573 2e4e 5872 6f6f 740a 2020 2020 2020  us.NXroot.      
-00000a30: 2020 2222 220a 0a20 2020 2020 2020 2069    """..        i
-00000a40: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-00000a50: 2872 6564 7563 655f 6461 7461 2c20 626f  (reduce_data, bo
-00000a60: 6f6c 293a 0a20 2020 2020 2020 2020 2020  ol):.           
-00000a70: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00000a80: 7228 6627 496e 7661 6c69 6420 7061 7261  r(f'Invalid para
-00000a90: 6d65 7465 7220 7265 6475 6365 5f64 6174  meter reduce_dat
-00000aa0: 6120 287b 7265 6475 6365 5f64 6174 617d  a ({reduce_data}
-00000ab0: 2927 290a 2020 2020 2020 2020 6966 206e  )').        if n
-00000ac0: 6f74 2069 7369 6e73 7461 6e63 6528 6669  ot isinstance(fi
-00000ad0: 6e64 5f63 656e 7465 722c 2062 6f6f 6c29  nd_center, bool)
-00000ae0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00000af0: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-00000b00: 2749 6e76 616c 6964 2070 6172 616d 6574  'Invalid paramet
-00000b10: 6572 2066 696e 645f 6365 6e74 6572 2028  er find_center (
-00000b20: 7b66 696e 645f 6365 6e74 6572 7d29 2729  {find_center})')
-00000b30: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00000b40: 6973 696e 7374 616e 6365 2872 6563 6f6e  isinstance(recon
-00000b50: 7374 7275 6374 5f64 6174 612c 2062 6f6f  struct_data, boo
-00000b60: 6c29 3a0a 2020 2020 2020 2020 2020 2020  l):.            
-00000b70: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00000b80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00000b90: 2020 6627 496e 7661 6c69 6420 7061 7261    f'Invalid para
-00000ba0: 6d65 7465 7220 7265 636f 6e73 7472 7563  meter reconstruc
-00000bb0: 745f 6461 7461 2028 7b72 6563 6f6e 7374  t_data ({reconst
-00000bc0: 7275 6374 5f64 6174 617d 2927 290a 2020  ruct_data})').  
-00000bd0: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
-00000be0: 6e73 7461 6e63 6528 636f 6d62 696e 655f  nstance(combine_
-00000bf0: 6461 7461 2c20 626f 6f6c 293a 0a20 2020  data, bool):.   
-00000c00: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00000c10: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
-00000c20: 2020 2020 2020 2020 2020 2066 2749 6e76             f'Inv
-00000c30: 616c 6964 2070 6172 616d 6574 6572 2063  alid parameter c
-00000c40: 6f6d 6269 6e65 5f64 6174 6120 287b 636f  ombine_data ({co
-00000c50: 6d62 696e 655f 6461 7461 7d29 2729 0a0a  mbine_data})')..
-00000c60: 2020 2020 2020 2020 746f 6d6f 203d 2054          tomo = T
-00000c70: 6f6d 6f28 0a20 2020 2020 2020 2020 2020  omo(.           
-00000c80: 2069 6e74 6572 6163 7469 7665 3d69 6e74   interactive=int
-00000c90: 6572 6163 7469 7665 2c20 6f75 7470 7574  eractive, output
-00000ca0: 5f66 6f6c 6465 723d 6f75 7470 7574 5f66  _folder=output_f
-00000cb0: 6f6c 6465 722c 0a20 2020 2020 2020 2020  older,.         
-00000cc0: 2020 2073 6176 655f 6669 6773 3d73 6176     save_figs=sav
-00000cd0: 655f 6669 6773 290a 2020 2020 2020 2020  e_figs).        
-00000ce0: 6e78 726f 6f74 203d 204e 6f6e 650a 2020  nxroot = None.  
-00000cf0: 2020 2020 2020 6365 6e74 6572 5f63 6f6e        center_con
-00000d00: 6669 6720 3d20 4e6f 6e65 0a0a 2020 2020  fig = None..    
-00000d10: 2020 2020 2320 4765 7420 616e 6420 7661      # Get and va
-00000d20: 6c69 6461 7465 2074 6865 2072 656c 6576  lidate the relev
-00000d30: 616e 7420 636f 6e66 6967 7572 6174 696f  ant configuratio
-00000d40: 6e20 6f62 6a65 6374 7320 696e 2064 6174  n objects in dat
-00000d50: 610a 2020 2020 2020 2020 636f 6e66 6967  a.        config
-00000d60: 7320 3d20 7365 6c66 2e67 6574 5f63 6f6e  s = self.get_con
-00000d70: 6669 6773 2864 6174 6129 0a0a 2020 2020  figs(data)..    
-00000d80: 2020 2020 2320 5365 7475 7020 7468 6520      # Setup the 
-00000d90: 7069 7065 6c69 6e65 2066 6f72 2061 2074  pipeline for a t
-00000da0: 6f6d 6f67 7261 7068 7920 7265 636f 6e73  omography recons
-00000db0: 7472 7563 7469 6f6e 0a20 2020 2020 2020  truction.       
-00000dc0: 2069 6620 2773 6574 7570 2720 696e 2063   if 'setup' in c
-00000dd0: 6f6e 6669 6773 3a0a 2020 2020 2020 2020  onfigs:.        
-00000de0: 2020 2020 636f 6e66 6967 732e 706f 7028      configs.pop(
-00000df0: 276e 7872 6f6f 7427 2c20 4e6f 6e65 290a  'nxroot', None).
-00000e00: 2020 2020 2020 2020 2020 2020 6e78 726f              nxro
-00000e10: 6f74 203d 2073 656c 662e 6765 745f 6e78  ot = self.get_nx
-00000e20: 726f 6f74 2863 6f6e 6669 6773 2e70 6f70  root(configs.pop
-00000e30: 2827 6d61 7027 292c 2063 6f6e 6669 6773  ('map'), configs
-00000e40: 2e70 6f70 2827 7365 7475 7027 2929 0a20  .pop('setup')). 
-00000e50: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00000e60: 2020 2020 2020 2020 206e 7872 6f6f 7420           nxroot 
-00000e70: 3d20 636f 6e66 6967 732e 706f 7028 276e  = configs.pop('n
-00000e80: 7872 6f6f 7427 2c20 4e6f 6e65 290a 0a20  xroot', None).. 
-00000e90: 2020 2020 2020 2023 2052 6564 7563 6520         # Reduce 
-00000ea0: 746f 6d6f 6772 6170 6879 2069 6d61 6765  tomography image
-00000eb0: 730a 2020 2020 2020 2020 6966 2072 6564  s.        if red
-00000ec0: 7563 655f 6461 7461 206f 7220 2772 6564  uce_data or 'red
-00000ed0: 7563 6527 2069 6e20 636f 6e66 6967 733a  uce' in configs:
-00000ee0: 0a20 2020 2020 2020 2020 2020 2061 7267  .            arg
-00000ef0: 7320 3d20 7b7d 0a20 2020 2020 2020 2020  s = {}.         
-00000f00: 2020 2069 6620 2772 6564 7563 6527 2069     if 'reduce' i
-00000f10: 6e20 636f 6e66 6967 733a 0a20 2020 2020  n configs:.     
-00000f20: 2020 2020 2020 2020 2020 2074 6f6f 6c5f             tool_
-00000f30: 636f 6e66 6967 203d 2063 6f6e 6669 6773  config = configs
-00000f40: 2e70 6f70 2827 7265 6475 6365 2729 0a20  .pop('reduce'). 
-00000f50: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00000f60: 7267 735b 2769 6d67 5f78 5f62 6f75 6e64  rgs['img_x_bound
-00000f70: 7327 5d20 3d20 746f 6f6c 5f63 6f6e 6669  s'] = tool_confi
-00000f80: 672e 696d 675f 785f 626f 756e 6473 0a20  g.img_x_bounds. 
-00000f90: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00000fa0: 7267 735b 2764 656c 7461 5f74 6865 7461  rgs['delta_theta
-00000fb0: 275d 203d 2074 6f6f 6c5f 636f 6e66 6967  '] = tool_config
-00000fc0: 2e64 656c 7461 5f74 6865 7461 0a20 2020  .delta_theta.   
-00000fd0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00000fe0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00000ff0: 6620 6e78 726f 6f74 2069 7320 4e6f 6e65  f nxroot is None
-00001000: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00001010: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
-00001020: 696d 6545 7272 6f72 280a 2020 2020 2020  imeError(.      
-00001030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001040: 2020 2755 6e61 626c 6520 746f 2072 6564    'Unable to red
-00001050: 7563 6520 7468 6520 6461 7461 2077 6974  uce the data wit
-00001060: 686f 7574 2070 726f 7669 6469 6e67 2061  hout providing a
-00001070: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00001080: 2020 2020 2020 2020 2020 202b 2027 7265             + 're
-00001090: 6475 6365 645f 6461 7461 2063 6f6e 6669  duced_data confi
-000010a0: 6720 6669 6c65 2729 0a20 2020 2020 2020  g file').       
-000010b0: 2020 2020 2069 6620 6e78 726f 6f74 2069       if nxroot i
-000010c0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-000010d0: 2020 2020 2020 2020 6d61 705f 636f 6e66          map_conf
-000010e0: 6967 203d 2063 6f6e 6669 6773 2e70 6f70  ig = configs.pop
-000010f0: 2827 6d61 7027 290a 2020 2020 2020 2020  ('map').        
-00001100: 2020 2020 2020 2020 6e78 726f 6f74 203d          nxroot =
-00001110: 2073 656c 662e 6765 745f 6e78 726f 6f74   self.get_nxroot
-00001120: 286d 6170 5f63 6f6e 6669 672c 2074 6f6f  (map_config, too
-00001130: 6c5f 636f 6e66 6967 290a 2020 2020 2020  l_config).      
-00001140: 2020 2020 2020 6e78 726f 6f74 203d 2074        nxroot = t
-00001150: 6f6d 6f2e 6765 6e5f 7265 6475 6365 645f  omo.gen_reduced_
-00001160: 6461 7461 286e 7872 6f6f 742c 202a 2a61  data(nxroot, **a
-00001170: 7267 7329 0a0a 2020 2020 2020 2020 2320  rgs)..        # 
-00001180: 4669 6e64 2072 6f74 6174 696f 6e20 6178  Find rotation ax
-00001190: 6973 2063 656e 7465 7273 2066 6f72 2074  is centers for t
-000011a0: 6865 2074 6f6d 6f67 7261 7068 7920 7374  he tomography st
-000011b0: 6163 6b73 0a20 2020 2020 2020 2023 2052  acks.        # R
-000011c0: 5620 7061 7373 2074 6f6f 6c5f 636f 6e66  V pass tool_conf
-000011d0: 6967 2064 6972 6563 746c 7920 746f 2074  ig directly to t
-000011e0: 6f6d 6f2e 6669 6e64 5f63 656e 7465 7273  omo.find_centers
-000011f0: 3f0a 2020 2020 2020 2020 6966 2066 696e  ?.        if fin
-00001200: 645f 6365 6e74 6572 206f 7220 2766 696e  d_center or 'fin
-00001210: 645f 6365 6e74 6572 2720 696e 2063 6f6e  d_center' in con
-00001220: 6669 6773 3a0a 2020 2020 2020 2020 2020  figs:.          
-00001230: 2020 6172 6773 203d 207b 7d0a 2020 2020    args = {}.    
-00001240: 2020 2020 2020 2020 7275 6e5f 6669 6e64          run_find
-00001250: 5f63 656e 7465 7273 203d 2046 616c 7365  _centers = False
-00001260: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00001270: 2766 696e 645f 6365 6e74 6572 2720 696e  'find_center' in
-00001280: 2063 6f6e 6669 6773 3a0a 2020 2020 2020   configs:.      
-00001290: 2020 2020 2020 2020 2020 746f 6f6c 5f63            tool_c
-000012a0: 6f6e 6669 6720 3d20 636f 6e66 6967 732e  onfig = configs.
-000012b0: 706f 7028 2766 696e 645f 6365 6e74 6572  pop('find_center
-000012c0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-000012d0: 2020 2061 7267 735b 2763 656e 7465 725f     args['center_
-000012e0: 726f 7773 275d 203d 2028 0a20 2020 2020  rows'] = (.     
-000012f0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00001300: 6f6f 6c5f 636f 6e66 6967 2e6c 6f77 6572  ool_config.lower
-00001310: 5f72 6f77 2c20 746f 6f6c 5f63 6f6e 6669  _row, tool_confi
-00001320: 672e 7570 7065 725f 726f 7729 0a20 2020  g.upper_row).   
-00001330: 2020 2020 2020 2020 2020 2020 2061 7267               arg
-00001340: 735b 2763 656e 7465 725f 7374 6163 6b5f  s['center_stack_
-00001350: 696e 6465 7827 5d20 3d20 746f 6f6c 5f63  index'] = tool_c
-00001360: 6f6e 6669 672e 6365 6e74 6572 5f73 7461  onfig.center_sta
-00001370: 636b 5f69 6e64 6578 0a20 2020 2020 2020  ck_index.       
-00001380: 2020 2020 2020 2020 206c 6f77 6572 5f63           lower_c
-00001390: 656e 7465 725f 6f66 6673 6574 203d 2074  enter_offset = t
-000013a0: 6f6f 6c5f 636f 6e66 6967 2e6c 6f77 6572  ool_config.lower
-000013b0: 5f63 656e 7465 725f 6f66 6673 6574 0a20  _center_offset. 
-000013c0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-000013d0: 7070 6572 5f63 656e 7465 725f 6f66 6673  pper_center_offs
-000013e0: 6574 203d 2074 6f6f 6c5f 636f 6e66 6967  et = tool_config
-000013f0: 2e75 7070 6572 5f63 656e 7465 725f 6f66  .upper_center_of
-00001400: 6673 6574 0a20 2020 2020 2020 2020 2020  fset.           
-00001410: 2020 2020 2069 6620 284e 6f6e 6520 696e       if (None in
-00001420: 2061 7267 735b 2763 656e 7465 725f 726f   args['center_ro
-00001430: 7773 275d 206f 7220 6c6f 7765 725f 6365  ws'] or lower_ce
-00001440: 6e74 6572 5f6f 6666 7365 7420 6973 204e  nter_offset is N
-00001450: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00001460: 2020 2020 2020 2020 2020 2020 6f72 2075              or u
-00001470: 7070 6572 5f63 656e 7465 725f 6f66 6673  pper_center_offs
-00001480: 6574 2069 7320 4e6f 6e65 293a 0a20 2020  et is None):.   
-00001490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000014a0: 2072 756e 5f66 696e 645f 6365 6e74 6572   run_find_center
-000014b0: 7320 3d20 5472 7565 0a20 2020 2020 2020  s = True.       
-000014c0: 2020 2020 2069 6620 7275 6e5f 6669 6e64       if run_find
-000014d0: 5f63 656e 7465 7273 206f 7220 2766 696e  _centers or 'fin
-000014e0: 645f 6365 6e74 6572 2720 6e6f 7420 696e  d_center' not in
-000014f0: 2063 6f6e 6669 6773 3a0a 2020 2020 2020   configs:.      
-00001500: 2020 2020 2020 2020 2020 6365 6e74 6572            center
-00001510: 5f63 6f6e 6669 6720 3d20 746f 6d6f 2e66  _config = tomo.f
-00001520: 696e 645f 6365 6e74 6572 7328 6e78 726f  ind_centers(nxro
-00001530: 6f74 2c20 2a2a 6172 6773 290a 2020 2020  ot, **args).    
-00001540: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00001550: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00001560: 5256 206d 616b 6520 6120 636f 6e76 6572  RV make a conver
-00001570: 7420 746f 2064 6963 7420 696e 2062 6173  t to dict in bas
-00001580: 656d 6f64 656c 3f0a 2020 2020 2020 2020  emodel?.        
-00001590: 2020 2020 2020 2020 6365 6e74 6572 5f63          center_c
-000015a0: 6f6e 6669 6720 3d20 7b0a 2020 2020 2020  onfig = {.      
-000015b0: 2020 2020 2020 2020 2020 2020 2020 276c                'l
-000015c0: 6f77 6572 5f72 6f77 273a 2074 6f6f 6c5f  ower_row': tool_
-000015d0: 636f 6e66 6967 2e6c 6f77 6572 5f72 6f77  config.lower_row
-000015e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000015f0: 2020 2020 2020 276c 6f77 6572 5f63 656e        'lower_cen
-00001600: 7465 725f 6f66 6673 6574 273a 2074 6f6f  ter_offset': too
-00001610: 6c5f 636f 6e66 6967 2e6c 6f77 6572 5f63  l_config.lower_c
-00001620: 656e 7465 725f 6f66 6673 6574 2c0a 2020  enter_offset,.  
-00001630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001640: 2020 2775 7070 6572 5f72 6f77 273a 2074    'upper_row': t
-00001650: 6f6f 6c5f 636f 6e66 6967 2e75 7070 6572  ool_config.upper
-00001660: 5f72 6f77 2c0a 2020 2020 2020 2020 2020  _row,.          
-00001670: 2020 2020 2020 2020 2020 2775 7070 6572            'upper
-00001680: 5f63 656e 7465 725f 6f66 6673 6574 273a  _center_offset':
-00001690: 2074 6f6f 6c5f 636f 6e66 6967 2e75 7070   tool_config.upp
-000016a0: 6572 5f63 656e 7465 725f 6f66 6673 6574  er_center_offset
-000016b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000016c0: 2020 2020 2020 2763 656e 7465 725f 7374        'center_st
-000016d0: 6163 6b5f 696e 6465 7827 3a20 746f 6f6c  ack_index': tool
-000016e0: 5f63 6f6e 6669 672e 6365 6e74 6572 5f73  _config.center_s
-000016f0: 7461 636b 5f69 6e64 6578 2c0a 2020 2020  tack_index,.    
-00001700: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-00001710: 2020 2020 2020 2023 2052 6563 6f6e 7374         # Reconst
-00001720: 7275 6374 2074 6f6d 6f67 7261 7068 7920  ruct tomography 
-00001730: 7374 6163 6b73 0a20 2020 2020 2020 2023  stacks.        #
-00001740: 2052 5620 7061 7373 2074 6f6f 6c5f 636f   RV pass tool_co
-00001750: 6e66 6967 2061 6e64 2063 656e 7465 725f  nfig and center_
-00001760: 636f 6e66 6967 2064 6972 6563 746c 7920  config directly 
-00001770: 746f 0a20 2020 2020 2020 2023 2020 2020  to.        #    
-00001780: 2074 6f6d 6f2e 7265 636f 6e73 7472 7563   tomo.reconstruc
-00001790: 745f 6461 7461 3f0a 2020 2020 2020 2020  t_data?.        
-000017a0: 6966 2072 6563 6f6e 7374 7275 6374 5f64  if reconstruct_d
-000017b0: 6174 6120 6f72 2027 7265 636f 6e73 7472  ata or 'reconstr
-000017c0: 7563 7427 2069 6e20 636f 6e66 6967 733a  uct' in configs:
-000017d0: 0a20 2020 2020 2020 2020 2020 2061 7267  .            arg
-000017e0: 7320 3d20 7b7d 0a20 2020 2020 2020 2020  s = {}.         
-000017f0: 2020 2069 6620 2772 6563 6f6e 7374 7275     if 'reconstru
-00001800: 6374 2720 696e 2063 6f6e 6669 6773 3a0a  ct' in configs:.
-00001810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001820: 746f 6f6c 5f63 6f6e 6669 6720 3d20 636f  tool_config = co
-00001830: 6e66 6967 732e 706f 7028 2772 6563 6f6e  nfigs.pop('recon
-00001840: 7374 7275 6374 2729 0a20 2020 2020 2020  struct').       
-00001850: 2020 2020 2020 2020 2061 7267 735b 2778           args['x
-00001860: 5f62 6f75 6e64 7327 5d20 3d20 746f 6f6c  _bounds'] = tool
-00001870: 5f63 6f6e 6669 672e 785f 626f 756e 6473  _config.x_bounds
-00001880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001890: 2061 7267 735b 2779 5f62 6f75 6e64 7327   args['y_bounds'
-000018a0: 5d20 3d20 746f 6f6c 5f63 6f6e 6669 672e  ] = tool_config.
-000018b0: 795f 626f 756e 6473 0a20 2020 2020 2020  y_bounds.       
-000018c0: 2020 2020 2020 2020 2061 7267 735b 277a           args['z
-000018d0: 5f62 6f75 6e64 7327 5d20 3d20 746f 6f6c  _bounds'] = tool
-000018e0: 5f63 6f6e 6669 672e 7a5f 626f 756e 6473  _config.z_bounds
-000018f0: 0a20 2020 2020 2020 2020 2020 206e 7872  .            nxr
-00001900: 6f6f 7420 3d20 746f 6d6f 2e72 6563 6f6e  oot = tomo.recon
-00001910: 7374 7275 6374 5f64 6174 6128 6e78 726f  struct_data(nxro
-00001920: 6f74 2c20 6365 6e74 6572 5f63 6f6e 6669  ot, center_confi
-00001930: 672c 202a 2a61 7267 7329 0a20 2020 2020  g, **args).     
-00001940: 2020 2020 2020 2063 656e 7465 725f 636f         center_co
-00001950: 6e66 6967 203d 204e 6f6e 650a 0a20 2020  nfig = None..   
-00001960: 2020 2020 2023 2043 6f6d 6269 6e65 2072       # Combine r
-00001970: 6563 6f6e 7374 7275 6374 6564 2074 6f6d  econstructed tom
-00001980: 6f67 7261 7068 7920 7374 6163 6b73 0a20  ography stacks. 
-00001990: 2020 2020 2020 2069 6620 636f 6d62 696e         if combin
-000019a0: 655f 6461 7461 206f 7220 2763 6f6d 6269  e_data or 'combi
-000019b0: 6e65 2720 696e 2063 6f6e 6669 6773 3a0a  ne' in configs:.
-000019c0: 2020 2020 2020 2020 2020 2020 6172 6773              args
-000019d0: 203d 207b 7d0a 2020 2020 2020 2020 2020   = {}.          
-000019e0: 2020 6966 2027 636f 6d62 696e 6527 2069    if 'combine' i
-000019f0: 6e20 636f 6e66 6967 733a 0a20 2020 2020  n configs:.     
-00001a00: 2020 2020 2020 2020 2020 2074 6f6f 6c5f             tool_
-00001a10: 636f 6e66 6967 203d 2063 6f6e 6669 6773  config = configs
-00001a20: 2e70 6f70 2827 636f 6d62 696e 6527 290a  .pop('combine').
-00001a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001a40: 6172 6773 5b27 785f 626f 756e 6473 275d  args['x_bounds']
-00001a50: 203d 2074 6f6f 6c5f 636f 6e66 6967 2e78   = tool_config.x
-00001a60: 5f62 6f75 6e64 730a 2020 2020 2020 2020  _bounds.        
-00001a70: 2020 2020 2020 2020 6172 6773 5b27 795f          args['y_
-00001a80: 626f 756e 6473 275d 203d 2074 6f6f 6c5f  bounds'] = tool_
-00001a90: 636f 6e66 6967 2e79 5f62 6f75 6e64 730a  config.y_bounds.
-00001aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ab0: 6172 6773 5b27 7a5f 626f 756e 6473 275d  args['z_bounds']
-00001ac0: 203d 2074 6f6f 6c5f 636f 6e66 6967 2e7a   = tool_config.z
-00001ad0: 5f62 6f75 6e64 730a 2020 2020 2020 2020  _bounds.        
-00001ae0: 2020 2020 6e78 726f 6f74 203d 2074 6f6d      nxroot = tom
-00001af0: 6f2e 636f 6d62 696e 655f 6461 7461 286e  o.combine_data(n
-00001b00: 7872 6f6f 742c 202a 2a61 7267 7329 0a0a  xroot, **args)..
-00001b10: 2020 2020 2020 2020 6966 2063 656e 7465          if cente
-00001b20: 725f 636f 6e66 6967 2069 7320 6e6f 7420  r_config is not 
-00001b30: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00001b40: 2020 7265 7475 726e 2063 656e 7465 725f    return center_
-00001b50: 636f 6e66 6967 0a20 2020 2020 2020 2072  config.        r
-00001b60: 6574 7572 6e20 6e78 726f 6f74 0a0a 2020  eturn nxroot..  
-00001b70: 2020 6465 6620 6765 745f 636f 6e66 6967    def get_config
-00001b80: 7328 7365 6c66 2c20 6461 7461 293a 0a20  s(self, data):. 
-00001b90: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00001ba0: 2020 2047 6574 2069 6e73 7461 6e63 6573     Get instances
-00001bb0: 206f 6620 7468 6520 636f 6e66 6967 7572   of the configur
-00001bc0: 6174 696f 6e20 6f62 6a65 6374 7320 6e65  ation objects ne
-00001bd0: 6564 6564 2062 7920 7468 6973 0a20 2020  eded by this.   
-00001be0: 2020 2020 2060 5072 6f63 6573 736f 7260       `Processor`
-00001bf0: 2066 726f 6d20 6120 7265 7475 726e 6564   from a returned
-00001c00: 2076 616c 7565 206f 6620 6052 6561 6465   value of `Reade
-00001c10: 722e 7265 6164 600a 0a20 2020 2020 2020  r.read`..       
-00001c20: 203a 7061 7261 6d20 6461 7461 3a20 5265   :param data: Re
-00001c30: 7375 6c74 206f 6620 6052 6561 6465 722e  sult of `Reader.
-00001c40: 7265 6164 6020 7768 6572 6520 6174 206c  read` where at l
-00001c50: 6561 7374 206f 6e65 2069 7465 6d0a 2020  east one item.  
-00001c60: 2020 2020 2020 2020 2020 6973 206f 6620            is of 
-00001c70: 7479 7065 2060 6e65 7875 7366 6f72 6d61  type `nexusforma
-00001c80: 742e 6e65 7875 732e 4e58 726f 6f74 6020  t.nexus.NXroot` 
-00001c90: 6f72 2068 6173 2074 6865 2076 616c 7565  or has the value
-00001ca0: 0a20 2020 2020 2020 2020 2020 2060 274d  .            `'M
-00001cb0: 6170 436f 6e66 6967 2760 2066 6f72 2074  apConfig'` for t
-00001cc0: 6865 2060 2773 6368 656d 6127 6020 6b65  he `'schema'` ke
-00001cd0: 792c 2061 6e64 2061 7420 6c65 6173 7420  y, and at least 
-00001ce0: 6f6e 6520 6974 656d 0a20 2020 2020 2020  one item.       
-00001cf0: 2020 2020 2068 6173 2074 6865 2076 616c       has the val
-00001d00: 7565 2060 2754 6f6d 6f53 6574 7570 436f  ue `'TomoSetupCo
-00001d10: 6e66 6967 2760 2c20 6f72 2060 2754 6f6d  nfig'`, or `'Tom
-00001d20: 6f52 6564 7563 6543 6f6e 6669 6727 602c  oReduceConfig'`,
-00001d30: 0a20 2020 2020 2020 2020 2020 206f 7220  .            or 
-00001d40: 6027 546f 6d6f 4669 6e64 4365 6e74 6572  `'TomoFindCenter
-00001d50: 436f 6e66 6967 2760 2c20 6f72 2060 2754  Config'`, or `'T
-00001d60: 6f6d 6f52 6563 6f6e 7374 7275 6374 436f  omoReconstructCo
-00001d70: 6e66 6967 2760 2c0a 2020 2020 2020 2020  nfig'`,.        
-00001d80: 2020 2020 6f72 2060 2754 6f6d 6f43 6f6d      or `'TomoCom
-00001d90: 6269 6e65 436f 6e66 6967 2760 2066 6f72  bineConfig'` for
-00001da0: 2074 6865 2060 2773 6368 656d 6127 6020   the `'schema'` 
-00001db0: 6b65 792e 0a20 2020 2020 2020 203a 7479  key..        :ty
-00001dc0: 7065 2064 6174 613a 206c 6973 745b 5069  pe data: list[Pi
-00001dd0: 7065 6c69 6e65 4461 7461 5d0a 2020 2020  pelineData].    
-00001de0: 2020 2020 3a72 6574 7572 6e3a 2076 616c      :return: val
-00001df0: 6964 2069 6e73 7461 6e63 6573 206f 6620  id instances of 
-00001e00: 7468 6520 636f 6e66 6967 7572 6174 696f  the configuratio
-00001e10: 6e20 6f62 6a65 6374 7320 7769 7468 2066  n objects with f
-00001e20: 6965 6c64 0a20 2020 2020 2020 2020 2020  ield.           
-00001e30: 2076 616c 7565 7320 7461 6b65 6e20 6672   values taken fr
-00001e40: 6f6d 2060 6461 7461 602e 0a20 2020 2020  om `data`..     
-00001e50: 2020 203a 7274 7970 653a 2064 6963 740a     :rtype: dict.
-00001e60: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00001e70: 2020 2020 2320 5468 6972 6420 7061 7274      # Third part
-00001e80: 7920 6d6f 6475 6c65 730a 2020 2020 2020  y modules.      
-00001e90: 2020 6672 6f6d 206e 6578 7573 666f 726d    from nexusform
-00001ea0: 6174 2e6e 6578 7573 2069 6d70 6f72 7420  at.nexus import 
-00001eb0: 4e58 726f 6f74 0a0a 2020 2020 2020 2020  NXroot..        
-00001ec0: 2320 4c6f 6361 6c20 6d6f 6475 6c65 730a  # Local modules.
-00001ed0: 2020 2020 2020 2020 6672 6f6d 2043 4841          from CHA
-00001ee0: 502e 636f 6d6d 6f6e 2e6d 6f64 656c 732e  P.common.models.
-00001ef0: 6d61 7020 696d 706f 7274 204d 6170 436f  map import MapCo
-00001f00: 6e66 6967 0a20 2020 2020 2020 2066 726f  nfig.        fro
-00001f10: 6d20 4348 4150 2e74 6f6d 6f2e 6d6f 6465  m CHAP.tomo.mode
-00001f20: 6c73 2069 6d70 6f72 7420 280a 2020 2020  ls import (.    
-00001f30: 2020 2020 2020 2020 546f 6d6f 5365 7475          TomoSetu
-00001f40: 7043 6f6e 6669 672c 0a20 2020 2020 2020  pConfig,.       
-00001f50: 2020 2020 2054 6f6d 6f52 6564 7563 6543       TomoReduceC
-00001f60: 6f6e 6669 672c 0a20 2020 2020 2020 2020  onfig,.         
-00001f70: 2020 2054 6f6d 6f46 696e 6443 656e 7465     TomoFindCente
-00001f80: 7243 6f6e 6669 672c 0a20 2020 2020 2020  rConfig,.       
-00001f90: 2020 2020 2054 6f6d 6f52 6563 6f6e 7374       TomoReconst
-00001fa0: 7275 6374 436f 6e66 6967 2c0a 2020 2020  ructConfig,.    
-00001fb0: 2020 2020 2020 2020 546f 6d6f 436f 6d62          TomoComb
-00001fc0: 696e 6543 6f6e 6669 672c 0a20 2020 2020  ineConfig,.     
-00001fd0: 2020 2029 0a0a 2020 2020 2020 2020 636f     )..        co
-00001fe0: 6e66 6967 7320 3d20 7b7d 0a20 2020 2020  nfigs = {}.     
-00001ff0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00002000: 2864 6174 612c 206c 6973 7429 3a0a 2020  (data, list):.  
-00002010: 2020 2020 2020 2020 2020 666f 7220 6974            for it
-00002020: 656d 2069 6e20 6461 7461 3a0a 2020 2020  em in data:.    
-00002030: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00002040: 7369 6e73 7461 6e63 6528 6974 656d 2c20  sinstance(item, 
-00002050: 6469 6374 2920 616e 6420 6974 656d 2e67  dict) and item.g
-00002060: 6574 2827 6461 7461 2729 2069 7320 6e6f  et('data') is no
-00002070: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00002080: 2020 2020 2020 2020 2020 2020 7363 6865              sche
-00002090: 6d61 203d 2069 7465 6d2e 6765 7428 2773  ma = item.get('s
-000020a0: 6368 656d 6127 290a 2020 2020 2020 2020  chema').        
-000020b0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-000020c0: 7369 6e73 7461 6e63 6528 6974 656d 2e67  sinstance(item.g
-000020d0: 6574 2827 6461 7461 2729 2c20 4e58 726f  et('data'), NXro
-000020e0: 6f74 293a 0a20 2020 2020 2020 2020 2020  ot):.           
-000020f0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00002100: 6669 6773 5b27 6e78 726f 6f74 275d 203d  figs['nxroot'] =
-00002110: 2069 7465 6d2e 6765 7428 2764 6174 6127   item.get('data'
-00002120: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00002130: 2020 2020 2020 6966 2073 6368 656d 6120        if schema 
-00002140: 3d3d 2027 4d61 7043 6f6e 6669 6727 3a0a  == 'MapConfig':.
-00002150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002160: 2020 2020 2020 2020 636f 6e66 6967 735b          configs[
-00002170: 276d 6170 275d 203d 204d 6170 436f 6e66  'map'] = MapConf
-00002180: 6967 282a 2a28 6974 656d 2e67 6574 2827  ig(**(item.get('
-00002190: 6461 7461 2729 2929 0a20 2020 2020 2020  data'))).       
-000021a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000021b0: 7363 6865 6d61 203d 3d20 2754 6f6d 6f53  schema == 'TomoS
-000021c0: 6574 7570 436f 6e66 6967 273a 0a20 2020  etupConfig':.   
-000021d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000021e0: 2020 2020 2063 6f6e 6669 6773 5b27 7365       configs['se
-000021f0: 7475 7027 5d20 3d20 546f 6d6f 5365 7475  tup'] = TomoSetu
-00002200: 7043 6f6e 6669 6728 0a20 2020 2020 2020  pConfig(.       
-00002210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002220: 2020 2020 202a 2a28 6974 656d 2e67 6574       **(item.get
-00002230: 2827 6461 7461 2729 2929 0a20 2020 2020  ('data'))).     
-00002240: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00002250: 6620 7363 6865 6d61 203d 3d20 2754 6f6d  f schema == 'Tom
-00002260: 6f52 6564 7563 6543 6f6e 6669 6727 3a0a  oReduceConfig':.
-00002270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002280: 2020 2020 2020 2020 636f 6e66 6967 735b          configs[
-00002290: 2772 6564 7563 6527 5d20 3d20 546f 6d6f  'reduce'] = Tomo
-000022a0: 5265 6475 6365 436f 6e66 6967 280a 2020  ReduceConfig(.  
-000022b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000022c0: 2020 2020 2020 2020 2020 2a2a 2869 7465            **(ite
-000022d0: 6d2e 6765 7428 2764 6174 6127 2929 290a  m.get('data'))).
-000022e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000022f0: 2020 2020 656c 6966 2073 6368 656d 6120      elif schema 
-00002300: 3d3d 2027 546f 6d6f 4669 6e64 4365 6e74  == 'TomoFindCent
-00002310: 6572 436f 6e66 6967 273a 0a20 2020 2020  erConfig':.     
-00002320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002330: 2020 2063 6f6e 6669 6773 5b27 6669 6e64     configs['find
-00002340: 5f63 656e 7465 7227 5d20 3d20 546f 6d6f  _center'] = Tomo
-00002350: 4669 6e64 4365 6e74 6572 436f 6e66 6967  FindCenterConfig
-00002360: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00002370: 2020 2020 2020 2020 2020 2020 2020 2a2a                **
-00002380: 2869 7465 6d2e 6765 7428 2764 6174 6127  (item.get('data'
-00002390: 2929 290a 2020 2020 2020 2020 2020 2020  ))).            
-000023a0: 2020 2020 2020 2020 656c 6966 2073 6368          elif sch
-000023b0: 656d 6120 3d3d 2027 546f 6d6f 5265 636f  ema == 'TomoReco
-000023c0: 6e73 7472 7563 7443 6f6e 6669 6727 3a0a  nstructConfig':.
-000023d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000023e0: 2020 2020 2020 2020 636f 6e66 6967 735b          configs[
-000023f0: 2772 6563 6f6e 7374 7275 6374 275d 203d  'reconstruct'] =
-00002400: 2054 6f6d 6f52 6563 6f6e 7374 7275 6374   TomoReconstruct
-00002410: 436f 6e66 6967 280a 2020 2020 2020 2020  Config(.        
-00002420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002430: 2020 2020 2a2a 2869 7465 6d2e 6765 7428      **(item.get(
-00002440: 2764 6174 6127 2929 290a 2020 2020 2020  'data'))).      
-00002450: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00002460: 6966 2073 6368 656d 6120 3d3d 2027 546f  if schema == 'To
-00002470: 6d6f 436f 6d62 696e 6543 6f6e 6669 6727  moCombineConfig'
-00002480: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00002490: 2020 2020 2020 2020 2020 636f 6e66 6967            config
-000024a0: 735b 2763 6f6d 6269 6e65 275d 203d 2054  s['combine'] = T
-000024b0: 6f6d 6f43 6f6d 6269 6e65 436f 6e66 6967  omoCombineConfig
-000024c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000024d0: 2020 2020 2020 2020 2020 2020 2020 2a2a                **
-000024e0: 2869 7465 6d2e 6765 7428 2764 6174 6127  (item.get('data'
-000024f0: 2929 290a 0a20 2020 2020 2020 2072 6574  )))..        ret
-00002500: 7572 6e20 636f 6e66 6967 730a 0a20 2020  urn configs..   
-00002510: 2064 6566 2067 6574 5f6e 7872 6f6f 7428   def get_nxroot(
-00002520: 7365 6c66 2c20 6d61 705f 636f 6e66 6967  self, map_config
-00002530: 2c20 746f 6f6c 5f63 6f6e 6669 6729 3a0a  , tool_config):.
-00002540: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00002550: 2020 2020 4765 7420 6120 6d61 7020 6f66      Get a map of
-00002560: 2074 6865 2063 6f6c 6c65 6374 6564 2074   the collected t
-00002570: 6f6d 6f67 7261 7068 7920 6461 7461 2066  omography data f
-00002580: 726f 6d20 7468 6520 7363 616e 7320 696e  rom the scans in
-00002590: 0a20 2020 2020 2020 2060 6d61 705f 636f  .        `map_co
-000025a0: 6e66 6967 6020 616e 6420 7468 6520 6465  nfig` and the de
-000025b0: 7465 6374 6f72 2069 6e66 6f20 696e 2060  tector info in `
-000025c0: 746f 6f6c 5f63 6f6e 6669 6727 2e0a 2020  tool_config'..  
-000025d0: 2020 2020 2020 5468 6520 6d61 7020 6973        The map is
-000025e0: 2072 6574 7572 6e65 6420 6173 2061 6e20   returned as an 
-000025f0: 606e 6578 7573 666f 726d 6174 2e6e 6578  `nexusformat.nex
-00002600: 7573 2e4e 5872 6f6f 7460 206f 626a 6563  us.NXroot` objec
-00002610: 742e 0a0a 2020 2020 2020 2020 3a70 6172  t...        :par
-00002620: 616d 206d 6170 5f63 6f6e 6669 673a 204d  am map_config: M
-00002630: 6170 2063 6f6e 6669 6775 7261 7469 6f6e  ap configuration
-00002640: 0a20 2020 2020 2020 203a 7479 7065 206d  .        :type m
-00002650: 6170 5f63 6f6e 6669 673a 204d 6170 436f  ap_config: MapCo
-00002660: 6e66 6967 0a20 2020 2020 2020 203a 7061  nfig.        :pa
-00002670: 7261 6d20 746f 6f6c 5f63 6f6e 6669 673a  ram tool_config:
-00002680: 2054 6865 2074 6f6d 6f67 7261 7068 7920   The tomography 
-00002690: 696d 6167 6520 7265 6475 6374 696f 6e20  image reduction 
-000026a0: 636f 6e66 6967 7572 6174 696f 6e0a 2020  configuration.  
-000026b0: 2020 2020 2020 2020 2020 636f 6e74 6169            contai
-000026c0: 6e69 6e67 2061 7420 6d69 6e69 6d75 6d20  ning at minimum 
-000026d0: 7468 6520 6465 7465 6374 6f72 2069 6e66  the detector inf
-000026e0: 6f72 6d61 7469 6f6e 2e0a 2020 2020 2020  ormation..      
-000026f0: 2020 3a74 7970 6520 746f 6f6c 5f63 6f6e    :type tool_con
-00002700: 6669 673a 2054 6f6d 6f52 6564 7563 6543  fig: TomoReduceC
-00002710: 6f6e 6669 670a 2020 2020 2020 2020 3a72  onfig.        :r
-00002720: 6574 7572 6e3a 2061 206d 6170 206f 6620  eturn: a map of 
-00002730: 7468 6520 636f 6c6c 6563 7465 6420 746f  the collected to
-00002740: 6d6f 6772 6170 6879 2064 6174 6120 616c  mography data al
-00002750: 6f6e 6720 7769 7468 2074 6865 0a20 2020  ong with the.   
-00002760: 2020 2020 2064 6174 6120 7265 6475 6374       data reduct
-00002770: 696f 6e20 636f 6e66 6967 7572 6174 696f  ion configuratio
-00002780: 6e0a 2020 2020 2020 2020 3a72 7479 7065  n.        :rtype
-00002790: 3a20 6e65 7875 7366 6f72 6d61 742e 6e65  : nexusformat.ne
-000027a0: 7875 732e 4e58 726f 6f74 0a20 2020 2020  xus.NXroot.     
-000027b0: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
-000027c0: 2053 7973 7465 6d20 6d6f 6475 6c65 730a   System modules.
-000027d0: 2020 2020 2020 2020 6672 6f6d 2063 6f70          from cop
-000027e0: 7920 696d 706f 7274 2064 6565 7063 6f70  y import deepcop
-000027f0: 790a 2020 2020 2020 2020 6672 6f6d 206c  y.        from l
-00002800: 6f67 6769 6e67 2069 6d70 6f72 7420 6765  ogging import ge
-00002810: 744c 6f67 6765 720a 0a20 2020 2020 2020  tLogger..       
-00002820: 2023 2054 6869 7264 2070 6172 7479 206d   # Third party m
-00002830: 6f64 756c 6573 0a20 2020 2020 2020 2066  odules.        f
-00002840: 726f 6d20 6e65 7875 7366 6f72 6d61 742e  rom nexusformat.
-00002850: 6e65 7875 7320 696d 706f 7274 2028 0a20  nexus import (. 
-00002860: 2020 2020 2020 2020 2020 204e 5863 6f6c             NXcol
-00002870: 6c65 6374 696f 6e2c 0a20 2020 2020 2020  lection,.       
-00002880: 2020 2020 204e 5864 6174 612c 0a20 2020       NXdata,.   
-00002890: 2020 2020 2020 2020 204e 5864 6574 6563           NXdetec
-000028a0: 746f 722c 0a20 2020 2020 2020 2020 2020  tor,.           
-000028b0: 204e 5869 6e73 7472 756d 656e 742c 0a20   NXinstrument,. 
-000028c0: 2020 2020 2020 2020 2020 204e 5872 6f6f             NXroo
-000028d0: 742c 0a20 2020 2020 2020 2020 2020 204e  t,.            N
-000028e0: 5873 616d 706c 652c 0a20 2020 2020 2020  Xsample,.       
-000028f0: 2020 2020 204e 5873 6f75 7263 652c 0a20       NXsource,. 
-00002900: 2020 2020 2020 2020 2020 204e 5873 7562             NXsub
-00002910: 656e 7472 792c 0a20 2020 2020 2020 2029  entry,.        )
-00002920: 0a0a 2020 2020 2020 2020 2320 4c6f 6361  ..        # Loca
-00002930: 6c20 6d6f 6475 6c65 730a 2020 2020 2020  l modules.      
-00002940: 2020 6672 6f6d 2043 4841 502e 636f 6d6d    from CHAP.comm
-00002950: 6f6e 2069 6d70 6f72 7420 4d61 7050 726f  on import MapPro
-00002960: 6365 7373 6f72 0a20 2020 2020 2020 2066  cessor.        f
-00002970: 726f 6d20 4348 4150 2e63 6f6d 6d6f 6e2e  rom CHAP.common.
-00002980: 6d6f 6465 6c73 2e6d 6170 2069 6d70 6f72  models.map impor
-00002990: 7420 696d 706f 7274 5f73 6361 6e70 6172  t import_scanpar
-000029a0: 7365 720a 2020 2020 2020 2020 6672 6f6d  ser.        from
-000029b0: 2043 4841 502e 636f 6d6d 6f6e 2e75 7469   CHAP.common.uti
-000029c0: 6c73 2e67 656e 6572 616c 2069 6d70 6f72  ls.general impor
-000029d0: 7420 696e 6465 785f 6e65 6172 6573 740a  t index_nearest.
-000029e0: 0a20 2020 2020 2020 206c 6f67 6765 7220  .        logger 
-000029f0: 3d20 6765 744c 6f67 6765 7228 7365 6c66  = getLogger(self
-00002a00: 2e5f 5f6e 616d 655f 5f29 0a20 2020 2020  .__name__).     
-00002a10: 2020 206c 6f67 6765 722e 7072 6f70 6167     logger.propag
-00002a20: 6174 6520 3d20 4661 6c73 650a 0a20 2020  ate = False..   
-00002a30: 2020 2020 2069 6e63 6c75 6465 5f72 6177       include_raw
-00002a40: 5f64 6174 6120 3d20 6765 7461 7474 7228  _data = getattr(
-00002a50: 746f 6f6c 5f63 6f6e 6669 672c 2027 696e  tool_config, 'in
-00002a60: 636c 7564 655f 7261 775f 6461 7461 272c  clude_raw_data',
-00002a70: 2046 616c 7365 290a 0a20 2020 2020 2020   False)..       
-00002a80: 2023 2043 6f6e 7374 7275 6374 204e 5872   # Construct NXr
-00002a90: 6f6f 740a 2020 2020 2020 2020 6e78 726f  oot.        nxro
-00002aa0: 6f74 203d 204e 5872 6f6f 7428 290a 0a20  ot = NXroot().. 
-00002ab0: 2020 2020 2020 2023 2043 6f6e 7374 7275         # Constru
-00002ac0: 6374 2062 6173 6520 4e58 656e 7472 7920  ct base NXentry 
-00002ad0: 616e 6420 6164 6420 746f 204e 5872 6f6f  and add to NXroo
-00002ae0: 740a 2020 2020 2020 2020 6e78 656e 7472  t.        nxentr
-00002af0: 7920 3d20 4d61 7050 726f 6365 7373 6f72  y = MapProcessor
-00002b00: 2e67 6574 5f6e 7865 6e74 7279 286d 6170  .get_nxentry(map
-00002b10: 5f63 6f6e 6669 6729 0a20 2020 2020 2020  _config).       
-00002b20: 206e 7872 6f6f 745b 6d61 705f 636f 6e66   nxroot[map_conf
-00002b30: 6967 2e74 6974 6c65 5d20 3d20 6e78 656e  ig.title] = nxen
-00002b40: 7472 790a 2020 2020 2020 2020 6e78 726f  try.        nxro
-00002b50: 6f74 2e61 7474 7273 5b27 6465 6661 756c  ot.attrs['defaul
-00002b60: 7427 5d20 3d20 6d61 705f 636f 6e66 6967  t'] = map_config
-00002b70: 2e74 6974 6c65 0a20 2020 2020 2020 206e  .title.        n
-00002b80: 7865 6e74 7279 2e64 6566 696e 6974 696f  xentry.definitio
-00002b90: 6e20 3d20 274e 5874 6f6d 6f27 0a20 2020  n = 'NXtomo'.   
-00002ba0: 2020 2020 2069 6620 2764 6174 6127 2069       if 'data' i
-00002bb0: 6e20 6e78 656e 7472 793a 0a20 2020 2020  n nxentry:.     
-00002bc0: 2020 2020 2020 2064 656c 206e 7865 6e74         del nxent
-00002bd0: 7279 5b27 6461 7461 275d 0a0a 2020 2020  ry['data']..    
-00002be0: 2020 2020 2320 4164 6420 616e 204e 5869      # Add an NXi
-00002bf0: 6e73 7472 756d 656e 7420 746f 2074 6865  nstrument to the
-00002c00: 204e 5865 6e74 7279 0a20 2020 2020 2020   NXentry.       
-00002c10: 206e 7869 6e73 7472 756d 656e 7420 3d20   nxinstrument = 
-00002c20: 4e58 696e 7374 7275 6d65 6e74 2829 0a20  NXinstrument(). 
-00002c30: 2020 2020 2020 206e 7865 6e74 7279 2e69         nxentry.i
-00002c40: 6e73 7472 756d 656e 7420 3d20 6e78 696e  nstrument = nxin
-00002c50: 7374 7275 6d65 6e74 0a0a 2020 2020 2020  strument..      
-00002c60: 2020 2320 4164 6420 616e 204e 5873 6f75    # Add an NXsou
-00002c70: 7263 6520 746f 2074 6865 204e 5869 6e73  rce to the NXins
-00002c80: 7472 756d 656e 740a 2020 2020 2020 2020  trument.        
-00002c90: 6e78 736f 7572 6365 203d 204e 5873 6f75  nxsource = NXsou
-00002ca0: 7263 6528 290a 2020 2020 2020 2020 6e78  rce().        nx
-00002cb0: 696e 7374 7275 6d65 6e74 2e73 6f75 7263  instrument.sourc
-00002cc0: 6520 3d20 6e78 736f 7572 6365 0a20 2020  e = nxsource.   
-00002cd0: 2020 2020 206e 7873 6f75 7263 652e 7479       nxsource.ty
-00002ce0: 7065 203d 2027 5379 6e63 6872 6f74 726f  pe = 'Synchrotro
-00002cf0: 6e20 582d 7261 7920 536f 7572 6365 270a  n X-ray Source'.
-00002d00: 2020 2020 2020 2020 6e78 736f 7572 6365          nxsource
-00002d10: 2e6e 616d 6520 3d20 2743 4845 5353 270a  .name = 'CHESS'.
-00002d20: 2020 2020 2020 2020 6e78 736f 7572 6365          nxsource
-00002d30: 2e70 726f 6265 203d 2027 782d 7261 7927  .probe = 'x-ray'
-00002d40: 0a0a 2020 2020 2020 2020 2320 5461 6720  ..        # Tag 
-00002d50: 7468 6520 4e58 736f 7572 6365 2077 6974  the NXsource wit
-00002d60: 6820 7468 6520 7275 6e69 6e66 6f20 2861  h the runinfo (a
-00002d70: 7320 616e 2061 7474 7269 6275 7465 290a  s an attribute).
-00002d80: 2320 2020 2020 2020 206e 7873 6f75 7263  #        nxsourc
-00002d90: 652e 6174 7472 735b 2763 7963 6c65 275d  e.attrs['cycle']
-00002da0: 203d 206d 6170 5f63 6f6e 6669 672e 6379   = map_config.cy
-00002db0: 636c 650a 2320 2020 2020 2020 206e 7873  cle.#        nxs
-00002dc0: 6f75 7263 652e 6174 7472 735b 2762 7472  ource.attrs['btr
-00002dd0: 275d 203d 206d 6170 5f63 6f6e 6669 672e  '] = map_config.
-00002de0: 6274 720a 2020 2020 2020 2020 6e78 736f  btr.        nxso
-00002df0: 7572 6365 2e61 7474 7273 5b27 7374 6174  urce.attrs['stat
-00002e00: 696f 6e27 5d20 3d20 6d61 705f 636f 6e66  ion'] = map_conf
-00002e10: 6967 2e73 7461 7469 6f6e 0a20 2020 2020  ig.station.     
-00002e20: 2020 206e 7873 6f75 7263 652e 6174 7472     nxsource.attr
-00002e30: 735b 2765 7870 6572 696d 656e 745f 7479  s['experiment_ty
-00002e40: 7065 275d 203d 206d 6170 5f63 6f6e 6669  pe'] = map_confi
-00002e50: 672e 6578 7065 7269 6d65 6e74 5f74 7970  g.experiment_typ
-00002e60: 650a 0a20 2020 2020 2020 2023 2041 6464  e..        # Add
-00002e70: 2061 6e20 4e58 6465 7465 6374 6f72 2074   an NXdetector t
-00002e80: 6f20 7468 6520 4e58 696e 7374 7275 6d65  o the NXinstrume
-00002e90: 6e74 0a20 2020 2020 2020 2023 2028 646f  nt.        # (do
-00002ea0: 206e 6f74 2066 696c 6c20 696e 2064 6174   not fill in dat
-00002eb0: 6120 6669 656c 6473 2079 6574 290a 2020  a fields yet).  
-00002ec0: 2020 2020 2020 6e78 6465 7465 6374 6f72        nxdetector
-00002ed0: 203d 204e 5864 6574 6563 746f 7228 290a   = NXdetector().
-00002ee0: 2020 2020 2020 2020 6e78 696e 7374 7275          nxinstru
-00002ef0: 6d65 6e74 2e64 6574 6563 746f 7220 3d20  ment.detector = 
-00002f00: 6e78 6465 7465 6374 6f72 0a20 2020 2020  nxdetector.     
-00002f10: 2020 206e 7864 6574 6563 746f 722e 6c6f     nxdetector.lo
-00002f20: 6361 6c5f 6e61 6d65 203d 2074 6f6f 6c5f  cal_name = tool_
-00002f30: 636f 6e66 6967 2e64 6574 6563 746f 722e  config.detector.
-00002f40: 7072 6566 6978 0a20 2020 2020 2020 2070  prefix.        p
-00002f50: 6978 656c 5f73 697a 6520 3d20 746f 6f6c  ixel_size = tool
-00002f60: 5f63 6f6e 6669 672e 6465 7465 6374 6f72  _config.detector
-00002f70: 2e70 6978 656c 5f73 697a 650a 2020 2020  .pixel_size.    
-00002f80: 2020 2020 6966 206c 656e 2870 6978 656c      if len(pixel
-00002f90: 5f73 697a 6529 203d 3d20 313a 0a20 2020  _size) == 1:.   
-00002fa0: 2020 2020 2020 2020 206e 7864 6574 6563           nxdetec
-00002fb0: 746f 722e 785f 7069 7865 6c5f 7369 7a65  tor.x_pixel_size
-00002fc0: 203d 205c 0a20 2020 2020 2020 2020 2020   = \.           
-00002fd0: 2020 2020 2070 6978 656c 5f73 697a 655b       pixel_size[
-00002fe0: 305d 2f74 6f6f 6c5f 636f 6e66 6967 2e64  0]/tool_config.d
-00002ff0: 6574 6563 746f 722e 6c65 6e73 5f6d 6167  etector.lens_mag
-00003000: 6e69 6669 6361 7469 6f6e 0a20 2020 2020  nification.     
-00003010: 2020 2020 2020 206e 7864 6574 6563 746f         nxdetecto
-00003020: 722e 795f 7069 7865 6c5f 7369 7a65 203d  r.y_pixel_size =
-00003030: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
-00003040: 2020 2070 6978 656c 5f73 697a 655b 305d     pixel_size[0]
-00003050: 2f74 6f6f 6c5f 636f 6e66 6967 2e64 6574  /tool_config.det
-00003060: 6563 746f 722e 6c65 6e73 5f6d 6167 6e69  ector.lens_magni
-00003070: 6669 6361 7469 6f6e 0a20 2020 2020 2020  fication.       
-00003080: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00003090: 2020 206e 7864 6574 6563 746f 722e 785f     nxdetector.x_
-000030a0: 7069 7865 6c5f 7369 7a65 203d 205c 0a20  pixel_size = \. 
-000030b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000030c0: 6978 656c 5f73 697a 655b 305d 2f74 6f6f  ixel_size[0]/too
-000030d0: 6c5f 636f 6e66 6967 2e64 6574 6563 746f  l_config.detecto
-000030e0: 722e 6c65 6e73 5f6d 6167 6e69 6669 6361  r.lens_magnifica
-000030f0: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-00003100: 206e 7864 6574 6563 746f 722e 795f 7069   nxdetector.y_pi
-00003110: 7865 6c5f 7369 7a65 203d 205c 0a20 2020  xel_size = \.   
-00003120: 2020 2020 2020 2020 2020 2020 2070 6978               pix
-00003130: 656c 5f73 697a 655b 315d 2f74 6f6f 6c5f  el_size[1]/tool_
-00003140: 636f 6e66 6967 2e64 6574 6563 746f 722e  config.detector.
-00003150: 6c65 6e73 5f6d 6167 6e69 6669 6361 7469  lens_magnificati
-00003160: 6f6e 0a20 2020 2020 2020 206e 7864 6574  on.        nxdet
-00003170: 6563 746f 722e 785f 7069 7865 6c5f 7369  ector.x_pixel_si
-00003180: 7a65 2e61 7474 7273 5b27 756e 6974 7327  ze.attrs['units'
-00003190: 5d20 3d20 276d 6d27 0a20 2020 2020 2020  ] = 'mm'.       
-000031a0: 206e 7864 6574 6563 746f 722e 795f 7069   nxdetector.y_pi
-000031b0: 7865 6c5f 7369 7a65 2e61 7474 7273 5b27  xel_size.attrs['
-000031c0: 756e 6974 7327 5d20 3d20 276d 6d27 0a0a  units'] = 'mm'..
-000031d0: 2020 2020 2020 2020 6966 2069 6e63 6c75          if inclu
-000031e0: 6465 5f72 6177 5f64 6174 613a 0a20 2020  de_raw_data:.   
-000031f0: 2020 2020 2020 2020 2023 2041 6464 2061           # Add a
-00003200: 6e20 4e58 7361 6d70 6c65 2074 6f20 4e58  n NXsample to NX
-00003210: 656e 7472 790a 2020 2020 2020 2020 2020  entry.          
-00003220: 2020 2320 2864 6f20 6e6f 7420 6669 6c6c    # (do not fill
-00003230: 2069 6e20 6461 7461 2066 6965 6c64 7320   in data fields 
-00003240: 7965 7429 0a20 2020 2020 2020 2020 2020  yet).           
-00003250: 206e 7873 616d 706c 6520 3d20 4e58 7361   nxsample = NXsa
-00003260: 6d70 6c65 2829 0a20 2020 2020 2020 2020  mple().         
-00003270: 2020 206e 7865 6e74 7279 2e73 616d 706c     nxentry.sampl
-00003280: 6520 3d20 6e78 7361 6d70 6c65 0a20 2020  e = nxsample.   
-00003290: 2020 2020 2020 2020 206e 7873 616d 706c           nxsampl
-000032a0: 652e 6e61 6d65 203d 206d 6170 5f63 6f6e  e.name = map_con
-000032b0: 6669 672e 7361 6d70 6c65 2e6e 616d 650a  fig.sample.name.
-000032c0: 2020 2020 2020 2020 2020 2020 6e78 7361              nxsa
-000032d0: 6d70 6c65 2e64 6573 6372 6970 7469 6f6e  mple.description
-000032e0: 203d 206d 6170 5f63 6f6e 6669 672e 7361   = map_config.sa
-000032f0: 6d70 6c65 2e64 6573 6372 6970 7469 6f6e  mple.description
-00003300: 0a0a 2020 2020 2020 2020 2320 4164 6420  ..        # Add 
-00003310: 4e58 636f 6c6c 6563 7469 6f6e 2773 2074  NXcollection's t
-00003320: 6f20 4e58 656e 7472 7920 746f 2068 6f6c  o NXentry to hol
-00003330: 6420 6d65 7461 6461 7461 2061 626f 7574  d metadata about
-00003340: 2074 6865 2053 5045 430a 2020 2020 2020   the SPEC.      
-00003350: 2020 2320 2020 2020 7363 616e 7320 696e    #     scans in
-00003360: 2074 6865 206d 6170 0a20 2020 2020 2020   the map.       
-00003370: 2023 2041 6c73 6f20 6f62 7461 696e 2074   # Also obtain t
-00003380: 6865 2064 6174 6120 6669 656c 6473 2069  he data fields i
-00003390: 6e20 4e58 7361 6d70 6c65 2061 6e64 204e  n NXsample and N
-000033a0: 5864 6574 6563 746f 7220 6966 0a20 2020  Xdetector if.   
-000033b0: 2020 2020 2023 2020 2020 2072 6571 7565       #     reque
-000033c0: 7374 6564 0a20 2020 2020 2020 2069 6d70  sted.        imp
-000033d0: 6f72 745f 7363 616e 7061 7273 6572 286d  ort_scanparser(m
-000033e0: 6170 5f63 6f6e 6669 672e 7374 6174 696f  ap_config.statio
-000033f0: 6e2c 206d 6170 5f63 6f6e 6669 672e 6578  n, map_config.ex
-00003400: 7065 7269 6d65 6e74 5f74 7970 6529 0a20  periment_type). 
-00003410: 2020 2020 2020 2069 6d61 6765 5f6b 6579         image_key
-00003420: 7320 3d20 5b5d 0a20 2020 2020 2020 2073  s = [].        s
-00003430: 6571 7565 6e63 655f 6e75 6d62 6572 7320  equence_numbers 
-00003440: 3d20 5b5d 0a20 2020 2020 2020 2069 6d61  = [].        ima
-00003450: 6765 5f73 7461 636b 7320 3d20 5b5d 0a20  ge_stacks = []. 
-00003460: 2020 2020 2020 2072 6f74 6174 696f 6e5f         rotation_
-00003470: 616e 676c 6573 203d 205b 5d0a 2020 2020  angles = [].    
-00003480: 2020 2020 785f 7472 616e 736c 6174 696f      x_translatio
-00003490: 6e73 203d 205b 5d0a 2020 2020 2020 2020  ns = [].        
-000034a0: 7a5f 7472 616e 736c 6174 696f 6e73 203d  z_translations =
-000034b0: 205b 5d0a 2020 2020 2020 2020 7370 6563   [].        spec
-000034c0: 5f73 6361 6e73 203d 206d 6170 5f63 6f6e  _scans = map_con
-000034d0: 6669 672e 7370 6563 5f73 6361 6e73 0a20  fig.spec_scans. 
-000034e0: 2020 2020 2020 2069 6620 6d61 705f 636f         if map_co
-000034f0: 6e66 6967 2e73 7461 7469 6f6e 203d 3d20  nfig.station == 
-00003500: 2769 6433 6227 3a0a 2020 2020 2020 2020  'id3b':.        
-00003510: 2020 2020 7363 616e 5f74 7970 6573 203d      scan_types =
-00003520: 206c 656e 2873 7065 635f 7363 616e 7329   len(spec_scans)
-00003530: 2a5b 2774 7331 275d 0a20 2020 2020 2020  *['ts1'].       
-00003540: 2020 2020 2069 6620 746f 6f6c 5f63 6f6e       if tool_con
-00003550: 6669 672e 6461 726b 5f66 6965 6c64 2069  fig.dark_field i
-00003560: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00003570: 2020 2020 2020 2020 2020 2020 7370 6563              spec
-00003580: 5f73 6361 6e73 202b 3d20 746f 6f6c 5f63  _scans += tool_c
+000001a0: 4150 2e75 7469 6c73 2e67 656e 6572 616c  AP.utils.general
+000001b0: 2069 6d70 6f72 7420 280a 2020 2020 6973   import (.    is
+000001c0: 5f6e 756d 2c0a 2020 2020 696e 7075 745f  _num,.    input_
+000001d0: 696e 742c 0a20 2020 2069 6e70 7574 5f6e  int,.    input_n
+000001e0: 756d 2c0a 2020 2020 696e 7075 745f 7965  um,.    input_ye
+000001f0: 736e 6f2c 0a20 2020 2073 656c 6563 745f  sno,.    select_
+00000200: 696d 6167 655f 626f 756e 6473 2c0a 2020  image_bounds,.  
+00000210: 2020 7365 6c65 6374 5f6f 6e65 5f69 6d61    select_one_ima
+00000220: 6765 5f62 6f75 6e64 2c0a 2020 2020 6472  ge_bound,.    dr
+00000230: 6177 5f6d 6173 6b5f 3164 2c0a 2020 2020  aw_mask_1d,.    
+00000240: 636c 6561 725f 706c 6f74 2c0a 2020 2020  clear_plot,.    
+00000250: 636c 6561 725f 696d 7368 6f77 2c0a 2020  clear_imshow,.  
+00000260: 2020 7175 6963 6b5f 706c 6f74 2c0a 2020    quick_plot,.  
+00000270: 2020 7175 6963 6b5f 696d 7368 6f77 2c0a    quick_imshow,.
+00000280: 290a 6672 6f6d 2043 4841 502e 7574 696c  ).from CHAP.util
+00000290: 732e 6669 7420 696d 706f 7274 2046 6974  s.fit import Fit
+000002a0: 0a66 726f 6d20 4348 4150 2e70 726f 6365  .from CHAP.proce
+000002b0: 7373 6f72 2069 6d70 6f72 7420 5072 6f63  ssor import Proc
+000002c0: 6573 736f 720a 6672 6f6d 2043 4841 502e  essor.from CHAP.
+000002d0: 7265 6164 6572 2069 6d70 6f72 7420 6d61  reader import ma
+000002e0: 696e 0a0a 4e55 4d5f 434f 5245 5f54 4f4d  in..NUM_CORE_TOM
+000002f0: 4f50 595f 4c49 4d49 5420 3d20 3234 0a0a  OPY_LIMIT = 24..
+00000300: 0a63 6c61 7373 2054 6f6d 6f44 6174 6150  .class TomoDataP
+00000310: 726f 6365 7373 6f72 2850 726f 6365 7373  rocessor(Process
+00000320: 6f72 293a 0a20 2020 2022 2222 0a20 2020  or):.    """.   
+00000330: 2041 2070 726f 6365 7373 6f72 2074 6f20   A processor to 
+00000340: 7265 636f 6e73 7472 7563 7420 6120 7365  reconstruct a se
+00000350: 7420 6f66 2074 6f6d 6f67 7261 7068 6963  t of tomographic
+00000360: 2069 6d61 6765 7320 7265 7475 726e 696e   images returnin
+00000370: 670a 2020 2020 6569 7468 6572 2061 2064  g.    either a d
+00000380: 6963 7469 6f6e 6172 7920 6f72 2061 2060  ictionary or a `
+00000390: 6e65 7875 7366 6f72 6d61 742e 6e65 7875  nexusformat.nexu
+000003a0: 732e 4e58 726f 6f74 6020 6f62 6a65 6374  s.NXroot` object
+000003b0: 0a20 2020 2063 6f6e 7461 696e 696e 6720  .    containing 
+000003c0: 7468 6520 286d 6574 6129 2064 6174 6120  the (meta) data 
+000003d0: 6166 7465 7220 7072 6f63 6573 7369 6e67  after processing
+000003e0: 2065 6163 6820 696e 6469 7669 6475 616c   each individual
+000003f0: 2073 7465 702e 0a20 2020 2022 2222 0a0a   step..    """..
+00000400: 2020 2020 6465 6620 7072 6f63 6573 7328      def process(
+00000410: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00000420: 662c 2064 6174 612c 2069 6e74 6572 6163  f, data, interac
+00000430: 7469 7665 3d46 616c 7365 2c20 7265 6475  tive=False, redu
+00000440: 6365 5f64 6174 613d 4661 6c73 652c 0a20  ce_data=False,. 
+00000450: 2020 2020 2020 2020 2020 2066 696e 645f             find_
+00000460: 6365 6e74 6572 3d46 616c 7365 2c20 7265  center=False, re
+00000470: 636f 6e73 7472 7563 745f 6461 7461 3d46  construct_data=F
+00000480: 616c 7365 2c20 636f 6d62 696e 655f 6461  alse, combine_da
+00000490: 7461 3d46 616c 7365 2c0a 2020 2020 2020  ta=False,.      
+000004a0: 2020 2020 2020 6f75 7470 7574 5f66 6f6c        output_fol
+000004b0: 6465 723d 272e 272c 2073 6176 655f 6669  der='.', save_fi
+000004c0: 6773 3d27 6e6f 272c 202a 2a6b 7761 7267  gs='no', **kwarg
+000004d0: 7329 3a0a 2020 2020 2020 2020 2222 220a  s):.        """.
+000004e0: 2020 2020 2020 2020 5072 6f63 6573 7320          Process 
+000004f0: 7468 6520 696e 7075 7420 6d61 7020 6f72  the input map or
+00000500: 2063 6f6e 6669 6775 7261 7469 6f6e 2077   configuration w
+00000510: 6974 6820 7468 6520 7374 6570 2073 7065  ith the step spe
+00000520: 6369 6669 630a 2020 2020 2020 2020 696e  cific.        in
+00000530: 7374 7275 6374 696f 6e73 2061 6e64 2072  structions and r
+00000540: 6574 7572 6e20 6569 7468 6572 2061 2064  eturn either a d
+00000550: 6963 7469 6f6e 6172 7920 6f72 2061 0a20  ictionary or a. 
+00000560: 2020 2020 2020 2060 6e65 7875 7366 6f72         `nexusfor
+00000570: 6d61 742e 6e65 7875 732e 4e58 726f 6f74  mat.nexus.NXroot
+00000580: 6020 6f62 6a65 6374 2077 6974 6820 7468  ` object with th
+00000590: 6520 7072 6f63 6573 7365 6420 7265 7375  e processed resu
+000005a0: 6c74 2e0a 0a20 2020 2020 2020 203a 7061  lt...        :pa
+000005b0: 7261 6d20 6461 7461 3a20 496e 7075 7420  ram data: Input 
+000005c0: 6d61 7020 6f72 2063 6f6e 6669 6775 7261  map or configura
+000005d0: 7469 6f6e 2873 2920 616e 6420 7370 6563  tion(s) and spec
+000005e0: 6966 6963 2073 7465 700a 2020 2020 2020  ific step.      
+000005f0: 2020 2020 2020 696e 7374 7275 6374 696f        instructio
+00000600: 6e73 2066 6f72 2074 6f6d 6f67 7261 7068  ns for tomograph
+00000610: 6963 2069 6d61 6765 2072 6564 7563 7469  ic image reducti
+00000620: 6f6e 2e0a 2020 2020 2020 2020 3a74 7970  on..        :typ
+00000630: 6520 6461 7461 3a20 6c69 7374 5b50 6970  e data: list[Pip
+00000640: 656c 696e 6544 6174 615d 0a20 2020 2020  elineData].     
+00000650: 2020 203a 7061 7261 6d20 696e 7465 7261     :param intera
+00000660: 6374 6976 653a 2041 6c6c 6f77 7320 666f  ctive: Allows fo
+00000670: 7220 7573 6572 2069 6e74 6572 6163 7469  r user interacti
+00000680: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+00000690: 2064 6566 6175 6c74 7320 746f 2046 616c   defaults to Fal
+000006a0: 7365 2e0a 2020 2020 2020 2020 3a74 7970  se..        :typ
+000006b0: 6520 696e 7465 7261 6374 6976 653a 2062  e interactive: b
+000006c0: 6f6f 6c2c 206f 7074 696f 6e61 6c0a 2020  ool, optional.  
+000006d0: 2020 2020 2020 3a70 6172 616d 2072 6564        :param red
+000006e0: 7563 655f 6461 7461 3a20 4765 6e65 7261  uce_data: Genera
+000006f0: 7465 2072 6564 7563 6564 2074 6f6d 6f67  te reduced tomog
+00000700: 7261 7068 7920 696d 6167 6573 2c0a 2020  raphy images,.  
+00000710: 2020 2020 2020 2020 2020 6465 6661 756c            defaul
+00000720: 7473 2074 6f20 4661 6c73 652e 0a20 2020  ts to False..   
+00000730: 2020 2020 203a 7479 7065 2072 6564 7563       :type reduc
+00000740: 655f 6461 7461 3a20 626f 6f6c 2c20 6f70  e_data: bool, op
+00000750: 7469 6f6e 616c 0a20 2020 2020 2020 203a  tional.        :
+00000760: 7061 7261 6d20 6669 6e64 5f63 656e 7465  param find_cente
+00000770: 723a 2046 696e 6420 7468 6520 6361 6c69  r: Find the cali
+00000780: 6272 6174 6564 2063 656e 7465 7220 6178  brated center ax
+00000790: 6973 2069 6e66 6f2c 0a20 2020 2020 2020  is info,.       
+000007a0: 2020 2020 2064 6566 6175 6c74 7320 746f       defaults to
+000007b0: 2046 616c 7365 2e0a 2020 2020 2020 2020   False..        
+000007c0: 3a74 7970 6520 6669 6e64 5f63 656e 7465  :type find_cente
+000007d0: 723a 2062 6f6f 6c2c 206f 7074 696f 6e61  r: bool, optiona
+000007e0: 6c0a 2020 2020 2020 2020 3a70 6172 616d  l.        :param
+000007f0: 2072 6563 6f6e 7374 7275 6374 5f64 6174   reconstruct_dat
+00000800: 613a 2052 6563 6f6e 7374 7275 6374 2074  a: Reconstruct t
+00000810: 6865 2074 6f6d 6f67 7261 7068 7920 6461  he tomography da
+00000820: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
+00000830: 6465 6661 756c 7473 2074 6f20 4661 6c73  defaults to Fals
+00000840: 652e 0a20 2020 2020 2020 203a 7479 7065  e..        :type
+00000850: 2072 6563 6f6e 7374 7275 6374 5f64 6174   reconstruct_dat
+00000860: 613a 2062 6f6f 6c2c 206f 7074 696f 6e61  a: bool, optiona
+00000870: 6c0a 2020 2020 2020 2020 3a70 6172 616d  l.        :param
+00000880: 2063 6f6d 6269 6e65 5f64 6174 613a 2043   combine_data: C
+00000890: 6f6d 6269 6e65 2074 6865 2072 6563 6f6e  ombine the recon
+000008a0: 7374 7275 6374 6564 2074 6f6d 6f67 7261  structed tomogra
+000008b0: 7068 790a 2020 2020 2020 2020 2020 2020  phy.            
+000008c0: 7374 6163 6b73 2c20 6465 6661 756c 7473  stacks, defaults
+000008d0: 2074 6f20 4661 6c73 652e 0a20 2020 2020   to False..     
+000008e0: 2020 203a 7479 7065 2063 6f6d 6269 6e65     :type combine
+000008f0: 5f64 6174 613a 2062 6f6f 6c2c 206f 7074  _data: bool, opt
+00000900: 696f 6e61 6c0a 2020 2020 2020 2020 3a70  ional.        :p
+00000910: 6172 616d 206f 7574 7075 745f 666f 6c64  aram output_fold
+00000920: 6572 3a20 4f75 7470 7574 2066 6f6c 6465  er: Output folde
+00000930: 7220 6e61 6d65 2c20 6465 6661 756c 7473  r name, defaults
+00000940: 2074 6f20 272e 272e 0a20 2020 2020 2020   to '.'..       
+00000950: 203a 7479 7065 206f 7574 7075 745f 666f   :type output_fo
+00000960: 6c64 6572 3a3a 2073 7472 2c20 6f70 7469  lder:: str, opti
+00000970: 6f6e 616c 0a20 2020 2020 2020 203a 7061  onal.        :pa
+00000980: 7261 6d20 7361 7665 5f66 6967 733a 2053  ram save_figs: S
+00000990: 6166 6520 6669 6775 7265 7320 746f 2066  afe figures to f
+000009a0: 696c 6520 2827 7965 7327 206f 7220 276f  ile ('yes' or 'o
+000009b0: 6e6c 7927 2920 616e 642f 6f72 0a20 2020  nly') and/or.   
+000009c0: 2020 2020 2020 2020 2064 6973 706c 6179           display
+000009d0: 2066 6967 7572 6573 2028 2779 6573 2720   figures ('yes' 
+000009e0: 6f72 2027 6e6f 2729 2c20 6465 6661 756c  or 'no'), defaul
+000009f0: 7473 2074 6f20 276e 6f27 2e0a 2020 2020  ts to 'no'..    
+00000a00: 2020 2020 3a74 7970 6520 7361 7665 5f66      :type save_f
+00000a10: 6967 733a 204c 6974 6572 616c 5b27 7965  igs: Literal['ye
+00000a20: 7327 2c20 276e 6f27 2c20 276f 6e6c 7927  s', 'no', 'only'
+00000a30: 5d2c 206f 7074 696f 6e61 6c0a 2020 2020  ], optional.    
+00000a40: 2020 2020 3a72 6574 7572 6e3a 2050 726f      :return: Pro
+00000a50: 6365 7373 6564 2028 6d65 7461 2964 6174  cessed (meta)dat
+00000a60: 6120 6f66 2074 6865 206c 6173 7420 7374  a of the last st
+00000a70: 6570 2e0a 2020 2020 2020 2020 3a72 7479  ep..        :rty
+00000a80: 7065 3a20 556e 696f 6e5b 6469 6374 2c20  pe: Union[dict, 
+00000a90: 6e65 7875 7366 6f72 6d61 742e 6e65 7875  nexusformat.nexu
+00000aa0: 732e 4e58 726f 6f74 5d0a 2020 2020 2020  s.NXroot].      
+00000ab0: 2020 2222 220a 0a20 2020 2020 2020 2069    """..        i
+00000ac0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+00000ad0: 2872 6564 7563 655f 6461 7461 2c20 626f  (reduce_data, bo
+00000ae0: 6f6c 293a 0a20 2020 2020 2020 2020 2020  ol):.           
+00000af0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00000b00: 7228 6627 496e 7661 6c69 6420 7061 7261  r(f'Invalid para
+00000b10: 6d65 7465 7220 7265 6475 6365 5f64 6174  meter reduce_dat
+00000b20: 6120 287b 7265 6475 6365 5f64 6174 617d  a ({reduce_data}
+00000b30: 2927 290a 2020 2020 2020 2020 6966 206e  )').        if n
+00000b40: 6f74 2069 7369 6e73 7461 6e63 6528 6669  ot isinstance(fi
+00000b50: 6e64 5f63 656e 7465 722c 2062 6f6f 6c29  nd_center, bool)
+00000b60: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00000b70: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
+00000b80: 2749 6e76 616c 6964 2070 6172 616d 6574  'Invalid paramet
+00000b90: 6572 2066 696e 645f 6365 6e74 6572 2028  er find_center (
+00000ba0: 7b66 696e 645f 6365 6e74 6572 7d29 2729  {find_center})')
+00000bb0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00000bc0: 6973 696e 7374 616e 6365 2872 6563 6f6e  isinstance(recon
+00000bd0: 7374 7275 6374 5f64 6174 612c 2062 6f6f  struct_data, boo
+00000be0: 6c29 3a0a 2020 2020 2020 2020 2020 2020  l):.            
+00000bf0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00000c00: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00000c10: 2020 6627 496e 7661 6c69 6420 7061 7261    f'Invalid para
+00000c20: 6d65 7465 7220 7265 636f 6e73 7472 7563  meter reconstruc
+00000c30: 745f 6461 7461 2028 7b72 6563 6f6e 7374  t_data ({reconst
+00000c40: 7275 6374 5f64 6174 617d 2927 290a 2020  ruct_data})').  
+00000c50: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
+00000c60: 6e73 7461 6e63 6528 636f 6d62 696e 655f  nstance(combine_
+00000c70: 6461 7461 2c20 626f 6f6c 293a 0a20 2020  data, bool):.   
+00000c80: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00000c90: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
+00000ca0: 2020 2020 2020 2020 2020 2066 2749 6e76             f'Inv
+00000cb0: 616c 6964 2070 6172 616d 6574 6572 2063  alid parameter c
+00000cc0: 6f6d 6269 6e65 5f64 6174 6120 287b 636f  ombine_data ({co
+00000cd0: 6d62 696e 655f 6461 7461 7d29 2729 0a0a  mbine_data})')..
+00000ce0: 2020 2020 2020 2020 746f 6d6f 203d 2054          tomo = T
+00000cf0: 6f6d 6f28 0a20 2020 2020 2020 2020 2020  omo(.           
+00000d00: 2069 6e74 6572 6163 7469 7665 3d69 6e74   interactive=int
+00000d10: 6572 6163 7469 7665 2c20 6f75 7470 7574  eractive, output
+00000d20: 5f66 6f6c 6465 723d 6f75 7470 7574 5f66  _folder=output_f
+00000d30: 6f6c 6465 722c 0a20 2020 2020 2020 2020  older,.         
+00000d40: 2020 2073 6176 655f 6669 6773 3d73 6176     save_figs=sav
+00000d50: 655f 6669 6773 290a 2020 2020 2020 2020  e_figs).        
+00000d60: 6e78 726f 6f74 203d 204e 6f6e 650a 2020  nxroot = None.  
+00000d70: 2020 2020 2020 6365 6e74 6572 5f63 6f6e        center_con
+00000d80: 6669 6720 3d20 4e6f 6e65 0a0a 2020 2020  fig = None..    
+00000d90: 2020 2020 2320 4765 7420 616e 6420 7661      # Get and va
+00000da0: 6c69 6461 7465 2074 6865 2072 656c 6576  lidate the relev
+00000db0: 616e 7420 636f 6e66 6967 7572 6174 696f  ant configuratio
+00000dc0: 6e20 6f62 6a65 6374 7320 696e 2064 6174  n objects in dat
+00000dd0: 610a 2020 2020 2020 2020 636f 6e66 6967  a.        config
+00000de0: 7320 3d20 7365 6c66 2e67 6574 5f63 6f6e  s = self.get_con
+00000df0: 6669 6773 2864 6174 6129 0a0a 2020 2020  figs(data)..    
+00000e00: 2020 2020 2320 5365 7475 7020 7468 6520      # Setup the 
+00000e10: 7069 7065 6c69 6e65 2066 6f72 2061 2074  pipeline for a t
+00000e20: 6f6d 6f67 7261 7068 7920 7265 636f 6e73  omography recons
+00000e30: 7472 7563 7469 6f6e 0a20 2020 2020 2020  truction.       
+00000e40: 2069 6620 2773 6574 7570 2720 696e 2063   if 'setup' in c
+00000e50: 6f6e 6669 6773 3a0a 2020 2020 2020 2020  onfigs:.        
+00000e60: 2020 2020 636f 6e66 6967 732e 706f 7028      configs.pop(
+00000e70: 276e 7872 6f6f 7427 2c20 4e6f 6e65 290a  'nxroot', None).
+00000e80: 2020 2020 2020 2020 2020 2020 6e78 726f              nxro
+00000e90: 6f74 203d 2073 656c 662e 6765 745f 6e78  ot = self.get_nx
+00000ea0: 726f 6f74 2863 6f6e 6669 6773 2e70 6f70  root(configs.pop
+00000eb0: 2827 6d61 7027 292c 2063 6f6e 6669 6773  ('map'), configs
+00000ec0: 2e70 6f70 2827 7365 7475 7027 2929 0a20  .pop('setup')). 
+00000ed0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00000ee0: 2020 2020 2020 2020 206e 7872 6f6f 7420           nxroot 
+00000ef0: 3d20 636f 6e66 6967 732e 706f 7028 276e  = configs.pop('n
+00000f00: 7872 6f6f 7427 2c20 4e6f 6e65 290a 0a20  xroot', None).. 
+00000f10: 2020 2020 2020 2023 2052 6564 7563 6520         # Reduce 
+00000f20: 746f 6d6f 6772 6170 6879 2069 6d61 6765  tomography image
+00000f30: 730a 2020 2020 2020 2020 6966 2072 6564  s.        if red
+00000f40: 7563 655f 6461 7461 206f 7220 2772 6564  uce_data or 'red
+00000f50: 7563 6527 2069 6e20 636f 6e66 6967 733a  uce' in configs:
+00000f60: 0a20 2020 2020 2020 2020 2020 2061 7267  .            arg
+00000f70: 7320 3d20 7b7d 0a20 2020 2020 2020 2020  s = {}.         
+00000f80: 2020 2069 6620 2772 6564 7563 6527 2069     if 'reduce' i
+00000f90: 6e20 636f 6e66 6967 733a 0a20 2020 2020  n configs:.     
+00000fa0: 2020 2020 2020 2020 2020 2074 6f6f 6c5f             tool_
+00000fb0: 636f 6e66 6967 203d 2063 6f6e 6669 6773  config = configs
+00000fc0: 2e70 6f70 2827 7265 6475 6365 2729 0a20  .pop('reduce'). 
+00000fd0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00000fe0: 7267 735b 2769 6d67 5f78 5f62 6f75 6e64  rgs['img_x_bound
+00000ff0: 7327 5d20 3d20 746f 6f6c 5f63 6f6e 6669  s'] = tool_confi
+00001000: 672e 696d 675f 785f 626f 756e 6473 0a20  g.img_x_bounds. 
+00001010: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00001020: 7267 735b 2764 656c 7461 5f74 6865 7461  rgs['delta_theta
+00001030: 275d 203d 2074 6f6f 6c5f 636f 6e66 6967  '] = tool_config
+00001040: 2e64 656c 7461 5f74 6865 7461 0a20 2020  .delta_theta.   
+00001050: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00001060: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00001070: 6620 6e78 726f 6f74 2069 7320 4e6f 6e65  f nxroot is None
+00001080: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00001090: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
+000010a0: 696d 6545 7272 6f72 280a 2020 2020 2020  imeError(.      
+000010b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000010c0: 2020 2755 6e61 626c 6520 746f 2072 6564    'Unable to red
+000010d0: 7563 6520 7468 6520 6461 7461 2077 6974  uce the data wit
+000010e0: 686f 7574 2070 726f 7669 6469 6e67 2061  hout providing a
+000010f0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00001100: 2020 2020 2020 2020 2020 202b 2027 7265             + 're
+00001110: 6475 6365 645f 6461 7461 2063 6f6e 6669  duced_data confi
+00001120: 6720 6669 6c65 2729 0a20 2020 2020 2020  g file').       
+00001130: 2020 2020 2069 6620 6e78 726f 6f74 2069       if nxroot i
+00001140: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00001150: 2020 2020 2020 2020 6d61 705f 636f 6e66          map_conf
+00001160: 6967 203d 2063 6f6e 6669 6773 2e70 6f70  ig = configs.pop
+00001170: 2827 6d61 7027 290a 2020 2020 2020 2020  ('map').        
+00001180: 2020 2020 2020 2020 6e78 726f 6f74 203d          nxroot =
+00001190: 2073 656c 662e 6765 745f 6e78 726f 6f74   self.get_nxroot
+000011a0: 286d 6170 5f63 6f6e 6669 672c 2074 6f6f  (map_config, too
+000011b0: 6c5f 636f 6e66 6967 290a 2020 2020 2020  l_config).      
+000011c0: 2020 2020 2020 6e78 726f 6f74 203d 2074        nxroot = t
+000011d0: 6f6d 6f2e 6765 6e5f 7265 6475 6365 645f  omo.gen_reduced_
+000011e0: 6461 7461 286e 7872 6f6f 742c 202a 2a61  data(nxroot, **a
+000011f0: 7267 7329 0a0a 2020 2020 2020 2020 2320  rgs)..        # 
+00001200: 4669 6e64 2072 6f74 6174 696f 6e20 6178  Find rotation ax
+00001210: 6973 2063 656e 7465 7273 2066 6f72 2074  is centers for t
+00001220: 6865 2074 6f6d 6f67 7261 7068 7920 7374  he tomography st
+00001230: 6163 6b73 0a20 2020 2020 2020 2023 2052  acks.        # R
+00001240: 5620 7061 7373 2074 6f6f 6c5f 636f 6e66  V pass tool_conf
+00001250: 6967 2064 6972 6563 746c 7920 746f 2074  ig directly to t
+00001260: 6f6d 6f2e 6669 6e64 5f63 656e 7465 7273  omo.find_centers
+00001270: 3f0a 2020 2020 2020 2020 6966 2066 696e  ?.        if fin
+00001280: 645f 6365 6e74 6572 206f 7220 2766 696e  d_center or 'fin
+00001290: 645f 6365 6e74 6572 2720 696e 2063 6f6e  d_center' in con
+000012a0: 6669 6773 3a0a 2020 2020 2020 2020 2020  figs:.          
+000012b0: 2020 6172 6773 203d 207b 7d0a 2020 2020    args = {}.    
+000012c0: 2020 2020 2020 2020 7275 6e5f 6669 6e64          run_find
+000012d0: 5f63 656e 7465 7273 203d 2046 616c 7365  _centers = False
+000012e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000012f0: 2766 696e 645f 6365 6e74 6572 2720 696e  'find_center' in
+00001300: 2063 6f6e 6669 6773 3a0a 2020 2020 2020   configs:.      
+00001310: 2020 2020 2020 2020 2020 746f 6f6c 5f63            tool_c
+00001320: 6f6e 6669 6720 3d20 636f 6e66 6967 732e  onfig = configs.
+00001330: 706f 7028 2766 696e 645f 6365 6e74 6572  pop('find_center
+00001340: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+00001350: 2020 2061 7267 735b 2763 656e 7465 725f     args['center_
+00001360: 726f 7773 275d 203d 2028 0a20 2020 2020  rows'] = (.     
+00001370: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00001380: 6f6f 6c5f 636f 6e66 6967 2e6c 6f77 6572  ool_config.lower
+00001390: 5f72 6f77 2c20 746f 6f6c 5f63 6f6e 6669  _row, tool_confi
+000013a0: 672e 7570 7065 725f 726f 7729 0a20 2020  g.upper_row).   
+000013b0: 2020 2020 2020 2020 2020 2020 2061 7267               arg
+000013c0: 735b 2763 656e 7465 725f 7374 6163 6b5f  s['center_stack_
+000013d0: 696e 6465 7827 5d20 3d20 746f 6f6c 5f63  index'] = tool_c
+000013e0: 6f6e 6669 672e 6365 6e74 6572 5f73 7461  onfig.center_sta
+000013f0: 636b 5f69 6e64 6578 0a20 2020 2020 2020  ck_index.       
+00001400: 2020 2020 2020 2020 206c 6f77 6572 5f63           lower_c
+00001410: 656e 7465 725f 6f66 6673 6574 203d 2074  enter_offset = t
+00001420: 6f6f 6c5f 636f 6e66 6967 2e6c 6f77 6572  ool_config.lower
+00001430: 5f63 656e 7465 725f 6f66 6673 6574 0a20  _center_offset. 
+00001440: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+00001450: 7070 6572 5f63 656e 7465 725f 6f66 6673  pper_center_offs
+00001460: 6574 203d 2074 6f6f 6c5f 636f 6e66 6967  et = tool_config
+00001470: 2e75 7070 6572 5f63 656e 7465 725f 6f66  .upper_center_of
+00001480: 6673 6574 0a20 2020 2020 2020 2020 2020  fset.           
+00001490: 2020 2020 2069 6620 284e 6f6e 6520 696e       if (None in
+000014a0: 2061 7267 735b 2763 656e 7465 725f 726f   args['center_ro
+000014b0: 7773 275d 206f 7220 6c6f 7765 725f 6365  ws'] or lower_ce
+000014c0: 6e74 6572 5f6f 6666 7365 7420 6973 204e  nter_offset is N
+000014d0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+000014e0: 2020 2020 2020 2020 2020 2020 6f72 2075              or u
+000014f0: 7070 6572 5f63 656e 7465 725f 6f66 6673  pper_center_offs
+00001500: 6574 2069 7320 4e6f 6e65 293a 0a20 2020  et is None):.   
+00001510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001520: 2072 756e 5f66 696e 645f 6365 6e74 6572   run_find_center
+00001530: 7320 3d20 5472 7565 0a20 2020 2020 2020  s = True.       
+00001540: 2020 2020 2069 6620 7275 6e5f 6669 6e64       if run_find
+00001550: 5f63 656e 7465 7273 206f 7220 2766 696e  _centers or 'fin
+00001560: 645f 6365 6e74 6572 2720 6e6f 7420 696e  d_center' not in
+00001570: 2063 6f6e 6669 6773 3a0a 2020 2020 2020   configs:.      
+00001580: 2020 2020 2020 2020 2020 6365 6e74 6572            center
+00001590: 5f63 6f6e 6669 6720 3d20 746f 6d6f 2e66  _config = tomo.f
+000015a0: 696e 645f 6365 6e74 6572 7328 6e78 726f  ind_centers(nxro
+000015b0: 6f74 2c20 2a2a 6172 6773 290a 2020 2020  ot, **args).    
+000015c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000015d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000015e0: 5256 206d 616b 6520 6120 636f 6e76 6572  RV make a conver
+000015f0: 7420 746f 2064 6963 7420 696e 2062 6173  t to dict in bas
+00001600: 656d 6f64 656c 3f0a 2020 2020 2020 2020  emodel?.        
+00001610: 2020 2020 2020 2020 6365 6e74 6572 5f63          center_c
+00001620: 6f6e 6669 6720 3d20 7b0a 2020 2020 2020  onfig = {.      
+00001630: 2020 2020 2020 2020 2020 2020 2020 276c                'l
+00001640: 6f77 6572 5f72 6f77 273a 2074 6f6f 6c5f  ower_row': tool_
+00001650: 636f 6e66 6967 2e6c 6f77 6572 5f72 6f77  config.lower_row
+00001660: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00001670: 2020 2020 2020 276c 6f77 6572 5f63 656e        'lower_cen
+00001680: 7465 725f 6f66 6673 6574 273a 2074 6f6f  ter_offset': too
+00001690: 6c5f 636f 6e66 6967 2e6c 6f77 6572 5f63  l_config.lower_c
+000016a0: 656e 7465 725f 6f66 6673 6574 2c0a 2020  enter_offset,.  
+000016b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000016c0: 2020 2775 7070 6572 5f72 6f77 273a 2074    'upper_row': t
+000016d0: 6f6f 6c5f 636f 6e66 6967 2e75 7070 6572  ool_config.upper
+000016e0: 5f72 6f77 2c0a 2020 2020 2020 2020 2020  _row,.          
+000016f0: 2020 2020 2020 2020 2020 2775 7070 6572            'upper
+00001700: 5f63 656e 7465 725f 6f66 6673 6574 273a  _center_offset':
+00001710: 2074 6f6f 6c5f 636f 6e66 6967 2e75 7070   tool_config.upp
+00001720: 6572 5f63 656e 7465 725f 6f66 6673 6574  er_center_offset
+00001730: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00001740: 2020 2020 2020 2763 656e 7465 725f 7374        'center_st
+00001750: 6163 6b5f 696e 6465 7827 3a20 746f 6f6c  ack_index': tool
+00001760: 5f63 6f6e 6669 672e 6365 6e74 6572 5f73  _config.center_s
+00001770: 7461 636b 5f69 6e64 6578 2c0a 2020 2020  tack_index,.    
+00001780: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+00001790: 2020 2020 2020 2023 2052 6563 6f6e 7374         # Reconst
+000017a0: 7275 6374 2074 6f6d 6f67 7261 7068 7920  ruct tomography 
+000017b0: 7374 6163 6b73 0a20 2020 2020 2020 2023  stacks.        #
+000017c0: 2052 5620 7061 7373 2074 6f6f 6c5f 636f   RV pass tool_co
+000017d0: 6e66 6967 2061 6e64 2063 656e 7465 725f  nfig and center_
+000017e0: 636f 6e66 6967 2064 6972 6563 746c 7920  config directly 
+000017f0: 746f 0a20 2020 2020 2020 2023 2020 2020  to.        #    
+00001800: 2074 6f6d 6f2e 7265 636f 6e73 7472 7563   tomo.reconstruc
+00001810: 745f 6461 7461 3f0a 2020 2020 2020 2020  t_data?.        
+00001820: 6966 2072 6563 6f6e 7374 7275 6374 5f64  if reconstruct_d
+00001830: 6174 6120 6f72 2027 7265 636f 6e73 7472  ata or 'reconstr
+00001840: 7563 7427 2069 6e20 636f 6e66 6967 733a  uct' in configs:
+00001850: 0a20 2020 2020 2020 2020 2020 2061 7267  .            arg
+00001860: 7320 3d20 7b7d 0a20 2020 2020 2020 2020  s = {}.         
+00001870: 2020 2069 6620 2772 6563 6f6e 7374 7275     if 'reconstru
+00001880: 6374 2720 696e 2063 6f6e 6669 6773 3a0a  ct' in configs:.
+00001890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000018a0: 746f 6f6c 5f63 6f6e 6669 6720 3d20 636f  tool_config = co
+000018b0: 6e66 6967 732e 706f 7028 2772 6563 6f6e  nfigs.pop('recon
+000018c0: 7374 7275 6374 2729 0a20 2020 2020 2020  struct').       
+000018d0: 2020 2020 2020 2020 2061 7267 735b 2778           args['x
+000018e0: 5f62 6f75 6e64 7327 5d20 3d20 746f 6f6c  _bounds'] = tool
+000018f0: 5f63 6f6e 6669 672e 785f 626f 756e 6473  _config.x_bounds
+00001900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001910: 2061 7267 735b 2779 5f62 6f75 6e64 7327   args['y_bounds'
+00001920: 5d20 3d20 746f 6f6c 5f63 6f6e 6669 672e  ] = tool_config.
+00001930: 795f 626f 756e 6473 0a20 2020 2020 2020  y_bounds.       
+00001940: 2020 2020 2020 2020 2061 7267 735b 277a           args['z
+00001950: 5f62 6f75 6e64 7327 5d20 3d20 746f 6f6c  _bounds'] = tool
+00001960: 5f63 6f6e 6669 672e 7a5f 626f 756e 6473  _config.z_bounds
+00001970: 0a20 2020 2020 2020 2020 2020 206e 7872  .            nxr
+00001980: 6f6f 7420 3d20 746f 6d6f 2e72 6563 6f6e  oot = tomo.recon
+00001990: 7374 7275 6374 5f64 6174 6128 6e78 726f  struct_data(nxro
+000019a0: 6f74 2c20 6365 6e74 6572 5f63 6f6e 6669  ot, center_confi
+000019b0: 672c 202a 2a61 7267 7329 0a20 2020 2020  g, **args).     
+000019c0: 2020 2020 2020 2063 656e 7465 725f 636f         center_co
+000019d0: 6e66 6967 203d 204e 6f6e 650a 0a20 2020  nfig = None..   
+000019e0: 2020 2020 2023 2043 6f6d 6269 6e65 2072       # Combine r
+000019f0: 6563 6f6e 7374 7275 6374 6564 2074 6f6d  econstructed tom
+00001a00: 6f67 7261 7068 7920 7374 6163 6b73 0a20  ography stacks. 
+00001a10: 2020 2020 2020 2069 6620 636f 6d62 696e         if combin
+00001a20: 655f 6461 7461 206f 7220 2763 6f6d 6269  e_data or 'combi
+00001a30: 6e65 2720 696e 2063 6f6e 6669 6773 3a0a  ne' in configs:.
+00001a40: 2020 2020 2020 2020 2020 2020 6172 6773              args
+00001a50: 203d 207b 7d0a 2020 2020 2020 2020 2020   = {}.          
+00001a60: 2020 6966 2027 636f 6d62 696e 6527 2069    if 'combine' i
+00001a70: 6e20 636f 6e66 6967 733a 0a20 2020 2020  n configs:.     
+00001a80: 2020 2020 2020 2020 2020 2074 6f6f 6c5f             tool_
+00001a90: 636f 6e66 6967 203d 2063 6f6e 6669 6773  config = configs
+00001aa0: 2e70 6f70 2827 636f 6d62 696e 6527 290a  .pop('combine').
+00001ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001ac0: 6172 6773 5b27 785f 626f 756e 6473 275d  args['x_bounds']
+00001ad0: 203d 2074 6f6f 6c5f 636f 6e66 6967 2e78   = tool_config.x
+00001ae0: 5f62 6f75 6e64 730a 2020 2020 2020 2020  _bounds.        
+00001af0: 2020 2020 2020 2020 6172 6773 5b27 795f          args['y_
+00001b00: 626f 756e 6473 275d 203d 2074 6f6f 6c5f  bounds'] = tool_
+00001b10: 636f 6e66 6967 2e79 5f62 6f75 6e64 730a  config.y_bounds.
+00001b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001b30: 6172 6773 5b27 7a5f 626f 756e 6473 275d  args['z_bounds']
+00001b40: 203d 2074 6f6f 6c5f 636f 6e66 6967 2e7a   = tool_config.z
+00001b50: 5f62 6f75 6e64 730a 2020 2020 2020 2020  _bounds.        
+00001b60: 2020 2020 6e78 726f 6f74 203d 2074 6f6d      nxroot = tom
+00001b70: 6f2e 636f 6d62 696e 655f 6461 7461 286e  o.combine_data(n
+00001b80: 7872 6f6f 742c 202a 2a61 7267 7329 0a0a  xroot, **args)..
+00001b90: 2020 2020 2020 2020 6966 2063 656e 7465          if cente
+00001ba0: 725f 636f 6e66 6967 2069 7320 6e6f 7420  r_config is not 
+00001bb0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00001bc0: 2020 7265 7475 726e 2063 656e 7465 725f    return center_
+00001bd0: 636f 6e66 6967 0a20 2020 2020 2020 2072  config.        r
+00001be0: 6574 7572 6e20 6e78 726f 6f74 0a0a 2020  eturn nxroot..  
+00001bf0: 2020 6465 6620 6765 745f 636f 6e66 6967    def get_config
+00001c00: 7328 7365 6c66 2c20 6461 7461 293a 0a20  s(self, data):. 
+00001c10: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00001c20: 2020 2047 6574 2069 6e73 7461 6e63 6573     Get instances
+00001c30: 206f 6620 7468 6520 636f 6e66 6967 7572   of the configur
+00001c40: 6174 696f 6e20 6f62 6a65 6374 7320 6e65  ation objects ne
+00001c50: 6564 6564 2062 7920 7468 6973 0a20 2020  eded by this.   
+00001c60: 2020 2020 2060 5072 6f63 6573 736f 7260       `Processor`
+00001c70: 2066 726f 6d20 6120 6c69 7374 206f 6620   from a list of 
+00001c80: 6050 6970 656c 696e 6544 6174 6160 206f  `PipelineData` o
+00001c90: 626a 6563 7473 2e0a 0a20 2020 2020 2020  bjects...       
+00001ca0: 203a 7061 7261 6d20 6461 7461 3a20 496e   :param data: In
+00001cb0: 7075 7420 6c69 7374 206f 6620 6050 6970  put list of `Pip
+00001cc0: 656c 696e 6544 6174 6160 206f 626a 6563  elineData` objec
+00001cd0: 7473 2c20 7768 6572 6520 6f6e 650a 2020  ts, where one.  
+00001ce0: 2020 2020 2020 2020 2020 6974 656d 2069            item i
+00001cf0: 7320 6f66 2074 7970 6520 606e 6578 7573  s of type `nexus
+00001d00: 666f 726d 6174 2e6e 6578 7573 2e4e 5872  format.nexus.NXr
+00001d10: 6f6f 7460 206f 7220 6861 7320 7468 6520  oot` or has the 
+00001d20: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
+00001d30: 2020 6027 4d61 7043 6f6e 6669 6727 6020    `'MapConfig'` 
+00001d40: 666f 7220 7468 6520 6027 7363 6865 6d61  for the `'schema
+00001d50: 2760 206b 6579 2c20 616e 6420 6174 206c  '` key, and at l
+00001d60: 6561 7374 206f 6e65 2069 7465 6d0a 2020  east one item.  
+00001d70: 2020 2020 2020 2020 2020 6861 7320 7468            has th
+00001d80: 6520 7661 6c75 6520 6027 546f 6d6f 5365  e value `'TomoSe
+00001d90: 7475 7043 6f6e 6669 6727 602c 206f 7220  tupConfig'`, or 
+00001da0: 6027 546f 6d6f 5265 6475 6365 436f 6e66  `'TomoReduceConf
+00001db0: 6967 2760 2c0a 2020 2020 2020 2020 2020  ig'`,.          
+00001dc0: 2020 6f72 2060 2754 6f6d 6f46 696e 6443    or `'TomoFindC
+00001dd0: 656e 7465 7243 6f6e 6669 6727 602c 206f  enterConfig'`, o
+00001de0: 7220 6027 546f 6d6f 5265 636f 6e73 7472  r `'TomoReconstr
+00001df0: 7563 7443 6f6e 6669 6727 602c 0a20 2020  uctConfig'`,.   
+00001e00: 2020 2020 2020 2020 206f 7220 6027 546f           or `'To
+00001e10: 6d6f 436f 6d62 696e 6543 6f6e 6669 6727  moCombineConfig'
+00001e20: 6020 666f 7220 7468 6520 6027 7363 6865  ` for the `'sche
+00001e30: 6d61 2760 206b 6579 2e0a 2020 2020 2020  ma'` key..      
+00001e40: 2020 3a74 7970 6520 6461 7461 3a20 6c69    :type data: li
+00001e50: 7374 5b50 6970 656c 696e 6544 6174 615d  st[PipelineData]
+00001e60: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+00001e70: 3a20 5661 6c69 6420 696e 7374 616e 6365  : Valid instance
+00001e80: 7320 6f66 2074 6865 2063 6f6e 6669 6775  s of the configu
+00001e90: 7261 7469 6f6e 206f 626a 6563 7473 2077  ration objects w
+00001ea0: 6974 6820 6669 656c 640a 2020 2020 2020  ith field.      
+00001eb0: 2020 2020 2020 7661 6c75 6573 2074 616b        values tak
+00001ec0: 656e 2066 726f 6d20 6064 6174 6160 2e0a  en from `data`..
+00001ed0: 2020 2020 2020 2020 3a72 7479 7065 3a20          :rtype: 
+00001ee0: 6469 6374 0a20 2020 2020 2020 2022 2222  dict.        """
+00001ef0: 0a20 2020 2020 2020 2023 2054 6869 7264  .        # Third
+00001f00: 2070 6172 7479 206d 6f64 756c 6573 0a20   party modules. 
+00001f10: 2020 2020 2020 2066 726f 6d20 6e65 7875         from nexu
+00001f20: 7366 6f72 6d61 742e 6e65 7875 7320 696d  sformat.nexus im
+00001f30: 706f 7274 204e 5872 6f6f 740a 0a20 2020  port NXroot..   
+00001f40: 2020 2020 2023 204c 6f63 616c 206d 6f64       # Local mod
+00001f50: 756c 6573 0a20 2020 2020 2020 2066 726f  ules.        fro
+00001f60: 6d20 4348 4150 2e63 6f6d 6d6f 6e2e 6d6f  m CHAP.common.mo
+00001f70: 6465 6c73 2e6d 6170 2069 6d70 6f72 7420  dels.map import 
+00001f80: 4d61 7043 6f6e 6669 670a 2020 2020 2020  MapConfig.      
+00001f90: 2020 6672 6f6d 2043 4841 502e 746f 6d6f    from CHAP.tomo
+00001fa0: 2e6d 6f64 656c 7320 696d 706f 7274 2028  .models import (
+00001fb0: 0a20 2020 2020 2020 2020 2020 2054 6f6d  .            Tom
+00001fc0: 6f53 6574 7570 436f 6e66 6967 2c0a 2020  oSetupConfig,.  
+00001fd0: 2020 2020 2020 2020 2020 546f 6d6f 5265            TomoRe
+00001fe0: 6475 6365 436f 6e66 6967 2c0a 2020 2020  duceConfig,.    
+00001ff0: 2020 2020 2020 2020 546f 6d6f 4669 6e64          TomoFind
+00002000: 4365 6e74 6572 436f 6e66 6967 2c0a 2020  CenterConfig,.  
+00002010: 2020 2020 2020 2020 2020 546f 6d6f 5265            TomoRe
+00002020: 636f 6e73 7472 7563 7443 6f6e 6669 672c  constructConfig,
+00002030: 0a20 2020 2020 2020 2020 2020 2054 6f6d  .            Tom
+00002040: 6f43 6f6d 6269 6e65 436f 6e66 6967 2c0a  oCombineConfig,.
+00002050: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00002060: 2020 2063 6f6e 6669 6773 203d 207b 7d0a     configs = {}.
+00002070: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00002080: 7461 6e63 6528 6461 7461 2c20 6c69 7374  tance(data, list
+00002090: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
+000020a0: 6f72 2069 7465 6d20 696e 2064 6174 613a  or item in data:
+000020b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000020c0: 2069 6620 6973 696e 7374 616e 6365 2869   if isinstance(i
+000020d0: 7465 6d2c 2064 6963 7429 2061 6e64 2069  tem, dict) and i
+000020e0: 7465 6d2e 6765 7428 2764 6174 6127 2920  tem.get('data') 
+000020f0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00002100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002110: 2073 6368 656d 6120 3d20 6974 656d 2e67   schema = item.g
+00002120: 6574 2827 7363 6865 6d61 2729 0a20 2020  et('schema').   
+00002130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002140: 2069 6620 6973 696e 7374 616e 6365 2869   if isinstance(i
+00002150: 7465 6d2e 6765 7428 2764 6174 6127 292c  tem.get('data'),
+00002160: 204e 5872 6f6f 7429 3a0a 2020 2020 2020   NXroot):.      
+00002170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002180: 2020 636f 6e66 6967 735b 276e 7872 6f6f    configs['nxroo
+00002190: 7427 5d20 3d20 6974 656d 2e67 6574 2827  t'] = item.get('
+000021a0: 6461 7461 2729 0a20 2020 2020 2020 2020  data').         
+000021b0: 2020 2020 2020 2020 2020 2069 6620 7363             if sc
+000021c0: 6865 6d61 203d 3d20 274d 6170 436f 6e66  hema == 'MapConf
+000021d0: 6967 273a 0a20 2020 2020 2020 2020 2020  ig':.           
+000021e0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+000021f0: 6669 6773 5b27 6d61 7027 5d20 3d20 4d61  figs['map'] = Ma
+00002200: 7043 6f6e 6669 6728 2a2a 2869 7465 6d2e  pConfig(**(item.
+00002210: 6765 7428 2764 6174 6127 2929 290a 2020  get('data'))).  
+00002220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002230: 2020 6966 2073 6368 656d 6120 3d3d 2027    if schema == '
+00002240: 546f 6d6f 5365 7475 7043 6f6e 6669 6727  TomoSetupConfig'
+00002250: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00002260: 2020 2020 2020 2020 2020 636f 6e66 6967            config
+00002270: 735b 2773 6574 7570 275d 203d 2054 6f6d  s['setup'] = Tom
+00002280: 6f53 6574 7570 436f 6e66 6967 280a 2020  oSetupConfig(.  
+00002290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000022a0: 2020 2020 2020 2020 2020 2a2a 2869 7465            **(ite
+000022b0: 6d2e 6765 7428 2764 6174 6127 2929 290a  m.get('data'))).
+000022c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000022d0: 2020 2020 6966 2073 6368 656d 6120 3d3d      if schema ==
+000022e0: 2027 546f 6d6f 5265 6475 6365 436f 6e66   'TomoReduceConf
+000022f0: 6967 273a 0a20 2020 2020 2020 2020 2020  ig':.           
+00002300: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00002310: 6669 6773 5b27 7265 6475 6365 275d 203d  figs['reduce'] =
+00002320: 2054 6f6d 6f52 6564 7563 6543 6f6e 6669   TomoReduceConfi
+00002330: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00002340: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+00002350: 2a28 6974 656d 2e67 6574 2827 6461 7461  *(item.get('data
+00002360: 2729 2929 0a20 2020 2020 2020 2020 2020  '))).           
+00002370: 2020 2020 2020 2020 2065 6c69 6620 7363           elif sc
+00002380: 6865 6d61 203d 3d20 2754 6f6d 6f46 696e  hema == 'TomoFin
+00002390: 6443 656e 7465 7243 6f6e 6669 6727 3a0a  dCenterConfig':.
+000023a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000023b0: 2020 2020 2020 2020 636f 6e66 6967 735b          configs[
+000023c0: 2766 696e 645f 6365 6e74 6572 275d 203d  'find_center'] =
+000023d0: 2054 6f6d 6f46 696e 6443 656e 7465 7243   TomoFindCenterC
+000023e0: 6f6e 6669 6728 0a20 2020 2020 2020 2020  onfig(.         
+000023f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002400: 2020 202a 2a28 6974 656d 2e67 6574 2827     **(item.get('
+00002410: 6461 7461 2729 2929 0a20 2020 2020 2020  data'))).       
+00002420: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00002430: 6620 7363 6865 6d61 203d 3d20 2754 6f6d  f schema == 'Tom
+00002440: 6f52 6563 6f6e 7374 7275 6374 436f 6e66  oReconstructConf
+00002450: 6967 273a 0a20 2020 2020 2020 2020 2020  ig':.           
+00002460: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00002470: 6669 6773 5b27 7265 636f 6e73 7472 7563  figs['reconstruc
+00002480: 7427 5d20 3d20 546f 6d6f 5265 636f 6e73  t'] = TomoRecons
+00002490: 7472 7563 7443 6f6e 6669 6728 0a20 2020  tructConfig(.   
+000024a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000024b0: 2020 2020 2020 2020 202a 2a28 6974 656d           **(item
+000024c0: 2e67 6574 2827 6461 7461 2729 2929 0a20  .get('data'))). 
+000024d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000024e0: 2020 2065 6c69 6620 7363 6865 6d61 203d     elif schema =
+000024f0: 3d20 2754 6f6d 6f43 6f6d 6269 6e65 436f  = 'TomoCombineCo
+00002500: 6e66 6967 273a 0a20 2020 2020 2020 2020  nfig':.         
+00002510: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00002520: 6f6e 6669 6773 5b27 636f 6d62 696e 6527  onfigs['combine'
+00002530: 5d20 3d20 546f 6d6f 436f 6d62 696e 6543  ] = TomoCombineC
+00002540: 6f6e 6669 6728 0a20 2020 2020 2020 2020  onfig(.         
+00002550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002560: 2020 202a 2a28 6974 656d 2e67 6574 2827     **(item.get('
+00002570: 6461 7461 2729 2929 0a0a 2020 2020 2020  data')))..      
+00002580: 2020 7265 7475 726e 2063 6f6e 6669 6773    return configs
+00002590: 0a0a 2020 2020 6465 6620 6765 745f 6e78  ..    def get_nx
+000025a0: 726f 6f74 2873 656c 662c 206d 6170 5f63  root(self, map_c
+000025b0: 6f6e 6669 672c 2074 6f6f 6c5f 636f 6e66  onfig, tool_conf
+000025c0: 6967 293a 0a20 2020 2020 2020 2022 2222  ig):.        """
+000025d0: 0a20 2020 2020 2020 2047 6574 2061 206d  .        Get a m
+000025e0: 6170 206f 6620 7468 6520 636f 6c6c 6563  ap of the collec
+000025f0: 7465 6420 746f 6d6f 6772 6170 6879 2064  ted tomography d
+00002600: 6174 6120 6672 6f6d 2074 6865 2073 6361  ata from the sca
+00002610: 6e73 2069 6e0a 2020 2020 2020 2020 606d  ns in.        `m
+00002620: 6170 5f63 6f6e 6669 6760 2061 6e64 2074  ap_config` and t
+00002630: 6865 2064 6574 6563 746f 7220 696e 666f  he detector info
+00002640: 2069 6e20 6074 6f6f 6c5f 636f 6e66 6967   in `tool_config
+00002650: 272e 0a0a 2020 2020 2020 2020 3a70 6172  '...        :par
+00002660: 616d 206d 6170 5f63 6f6e 6669 673a 204d  am map_config: M
+00002670: 6170 2063 6f6e 6669 6775 7261 7469 6f6e  ap configuration
+00002680: 0a20 2020 2020 2020 203a 7479 7065 206d  .        :type m
+00002690: 6170 5f63 6f6e 6669 673a 204d 6170 436f  ap_config: MapCo
+000026a0: 6e66 6967 0a20 2020 2020 2020 203a 7061  nfig.        :pa
+000026b0: 7261 6d20 746f 6f6c 5f63 6f6e 6669 673a  ram tool_config:
+000026c0: 2054 6865 2074 6f6d 6f67 7261 7068 7920   The tomography 
+000026d0: 696d 6167 6520 7265 6475 6374 696f 6e20  image reduction 
+000026e0: 636f 6e66 6967 7572 6174 696f 6e0a 2020  configuration.  
+000026f0: 2020 2020 2020 2020 2020 636f 6e74 6169            contai
+00002700: 6e69 6e67 2061 7420 6d69 6e69 6d75 6d20  ning at minimum 
+00002710: 7468 6520 6465 7465 6374 6f72 2069 6e66  the detector inf
+00002720: 6f72 6d61 7469 6f6e 2e0a 2020 2020 2020  ormation..      
+00002730: 2020 3a74 7970 6520 746f 6f6c 5f63 6f6e    :type tool_con
+00002740: 6669 673a 2054 6f6d 6f52 6564 7563 6543  fig: TomoReduceC
+00002750: 6f6e 6669 670a 2020 2020 2020 2020 3a72  onfig.        :r
+00002760: 6574 7572 6e3a 204d 6170 206f 6620 7468  eturn: Map of th
+00002770: 6520 636f 6c6c 6563 7465 6420 746f 6d6f  e collected tomo
+00002780: 6772 6170 6879 2028 6d65 7461 2920 6461  graphy (meta) da
+00002790: 7461 2061 6c6f 6e67 0a20 2020 2020 2020  ta along.       
+000027a0: 2020 2020 2077 6974 6820 7468 6520 6461       with the da
+000027b0: 7461 2072 6564 7563 7469 6f6e 2063 6f6e  ta reduction con
+000027c0: 6669 6775 7261 7469 6f6e 0a20 2020 2020  figuration.     
+000027d0: 2020 203a 7274 7970 653a 206e 6578 7573     :rtype: nexus
+000027e0: 666f 726d 6174 2e6e 6578 7573 2e4e 5872  format.nexus.NXr
+000027f0: 6f6f 740a 2020 2020 2020 2020 2222 220a  oot.        """.
+00002800: 2020 2020 2020 2020 2320 5379 7374 656d          # System
+00002810: 206d 6f64 756c 6573 0a20 2020 2020 2020   modules.       
+00002820: 2066 726f 6d20 636f 7079 2069 6d70 6f72   from copy impor
+00002830: 7420 6465 6570 636f 7079 0a20 2020 2020  t deepcopy.     
+00002840: 2020 2066 726f 6d20 6c6f 6767 696e 6720     from logging 
+00002850: 696d 706f 7274 2067 6574 4c6f 6767 6572  import getLogger
+00002860: 0a0a 2020 2020 2020 2020 2320 5468 6972  ..        # Thir
+00002870: 6420 7061 7274 7920 6d6f 6475 6c65 730a  d party modules.
+00002880: 2020 2020 2020 2020 6672 6f6d 206e 6578          from nex
+00002890: 7573 666f 726d 6174 2e6e 6578 7573 2069  usformat.nexus i
+000028a0: 6d70 6f72 7420 280a 2020 2020 2020 2020  mport (.        
+000028b0: 2020 2020 4e58 636f 6c6c 6563 7469 6f6e      NXcollection
+000028c0: 2c0a 2020 2020 2020 2020 2020 2020 4e58  ,.            NX
+000028d0: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
+000028e0: 2020 4e58 6465 7465 6374 6f72 2c0a 2020    NXdetector,.  
+000028f0: 2020 2020 2020 2020 2020 4e58 696e 7374            NXinst
+00002900: 7275 6d65 6e74 2c0a 2020 2020 2020 2020  rument,.        
+00002910: 2020 2020 4e58 726f 6f74 2c0a 2020 2020      NXroot,.    
+00002920: 2020 2020 2020 2020 4e58 7361 6d70 6c65          NXsample
+00002930: 2c0a 2020 2020 2020 2020 2020 2020 4e58  ,.            NX
+00002940: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+00002950: 2020 2020 4e58 7375 6265 6e74 7279 2c0a      NXsubentry,.
+00002960: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00002970: 2020 2023 204c 6f63 616c 206d 6f64 756c     # Local modul
+00002980: 6573 0a20 2020 2020 2020 2066 726f 6d20  es.        from 
+00002990: 4348 4150 2e63 6f6d 6d6f 6e20 696d 706f  CHAP.common impo
+000029a0: 7274 204d 6170 5072 6f63 6573 736f 720a  rt MapProcessor.
+000029b0: 2020 2020 2020 2020 6672 6f6d 2043 4841          from CHA
+000029c0: 502e 636f 6d6d 6f6e 2e6d 6f64 656c 732e  P.common.models.
+000029d0: 6d61 7020 696d 706f 7274 2069 6d70 6f72  map import impor
+000029e0: 745f 7363 616e 7061 7273 6572 0a20 2020  t_scanparser.   
+000029f0: 2020 2020 2066 726f 6d20 4348 4150 2e75       from CHAP.u
+00002a00: 7469 6c73 2e67 656e 6572 616c 2069 6d70  tils.general imp
+00002a10: 6f72 7420 696e 6465 785f 6e65 6172 6573  ort index_neares
+00002a20: 740a 0a20 2020 2020 2020 206c 6f67 6765  t..        logge
+00002a30: 7220 3d20 6765 744c 6f67 6765 7228 7365  r = getLogger(se
+00002a40: 6c66 2e5f 5f6e 616d 655f 5f29 0a20 2020  lf.__name__).   
+00002a50: 2020 2020 206c 6f67 6765 722e 7072 6f70       logger.prop
+00002a60: 6167 6174 6520 3d20 4661 6c73 650a 0a20  agate = False.. 
+00002a70: 2020 2020 2020 2069 6e63 6c75 6465 5f72         include_r
+00002a80: 6177 5f64 6174 6120 3d20 6765 7461 7474  aw_data = getatt
+00002a90: 7228 746f 6f6c 5f63 6f6e 6669 672c 2027  r(tool_config, '
+00002aa0: 696e 636c 7564 655f 7261 775f 6461 7461  include_raw_data
+00002ab0: 272c 2046 616c 7365 290a 0a20 2020 2020  ', False)..     
+00002ac0: 2020 2023 2043 6f6e 7374 7275 6374 204e     # Construct N
+00002ad0: 5872 6f6f 740a 2020 2020 2020 2020 6e78  Xroot.        nx
+00002ae0: 726f 6f74 203d 204e 5872 6f6f 7428 290a  root = NXroot().
+00002af0: 0a20 2020 2020 2020 2023 2043 6f6e 7374  .        # Const
+00002b00: 7275 6374 2062 6173 6520 4e58 656e 7472  ruct base NXentr
+00002b10: 7920 616e 6420 6164 6420 746f 204e 5872  y and add to NXr
+00002b20: 6f6f 740a 2020 2020 2020 2020 6e78 656e  oot.        nxen
+00002b30: 7472 7920 3d20 4d61 7050 726f 6365 7373  try = MapProcess
+00002b40: 6f72 2e67 6574 5f6e 7865 6e74 7279 286d  or.get_nxentry(m
+00002b50: 6170 5f63 6f6e 6669 6729 0a20 2020 2020  ap_config).     
+00002b60: 2020 206e 7872 6f6f 745b 6d61 705f 636f     nxroot[map_co
+00002b70: 6e66 6967 2e74 6974 6c65 5d20 3d20 6e78  nfig.title] = nx
+00002b80: 656e 7472 790a 2020 2020 2020 2020 6e78  entry.        nx
+00002b90: 726f 6f74 2e61 7474 7273 5b27 6465 6661  root.attrs['defa
+00002ba0: 756c 7427 5d20 3d20 6d61 705f 636f 6e66  ult'] = map_conf
+00002bb0: 6967 2e74 6974 6c65 0a20 2020 2020 2020  ig.title.       
+00002bc0: 206e 7865 6e74 7279 2e64 6566 696e 6974   nxentry.definit
+00002bd0: 696f 6e20 3d20 274e 5874 6f6d 6f27 0a20  ion = 'NXtomo'. 
+00002be0: 2020 2020 2020 2069 6620 2764 6174 6127         if 'data'
+00002bf0: 2069 6e20 6e78 656e 7472 793a 0a20 2020   in nxentry:.   
+00002c00: 2020 2020 2020 2020 2064 656c 206e 7865           del nxe
+00002c10: 6e74 7279 5b27 6461 7461 275d 0a0a 2020  ntry['data']..  
+00002c20: 2020 2020 2020 2320 4164 6420 616e 204e        # Add an N
+00002c30: 5869 6e73 7472 756d 656e 7420 746f 2074  Xinstrument to t
+00002c40: 6865 204e 5865 6e74 7279 0a20 2020 2020  he NXentry.     
+00002c50: 2020 206e 7869 6e73 7472 756d 656e 7420     nxinstrument 
+00002c60: 3d20 4e58 696e 7374 7275 6d65 6e74 2829  = NXinstrument()
+00002c70: 0a20 2020 2020 2020 206e 7865 6e74 7279  .        nxentry
+00002c80: 2e69 6e73 7472 756d 656e 7420 3d20 6e78  .instrument = nx
+00002c90: 696e 7374 7275 6d65 6e74 0a0a 2020 2020  instrument..    
+00002ca0: 2020 2020 2320 4164 6420 616e 204e 5873      # Add an NXs
+00002cb0: 6f75 7263 6520 746f 2074 6865 204e 5869  ource to the NXi
+00002cc0: 6e73 7472 756d 656e 740a 2020 2020 2020  nstrument.      
+00002cd0: 2020 6e78 736f 7572 6365 203d 204e 5873    nxsource = NXs
+00002ce0: 6f75 7263 6528 290a 2020 2020 2020 2020  ource().        
+00002cf0: 6e78 696e 7374 7275 6d65 6e74 2e73 6f75  nxinstrument.sou
+00002d00: 7263 6520 3d20 6e78 736f 7572 6365 0a20  rce = nxsource. 
+00002d10: 2020 2020 2020 206e 7873 6f75 7263 652e         nxsource.
+00002d20: 7479 7065 203d 2027 5379 6e63 6872 6f74  type = 'Synchrot
+00002d30: 726f 6e20 582d 7261 7920 536f 7572 6365  ron X-ray Source
+00002d40: 270a 2020 2020 2020 2020 6e78 736f 7572  '.        nxsour
+00002d50: 6365 2e6e 616d 6520 3d20 2743 4845 5353  ce.name = 'CHESS
+00002d60: 270a 2020 2020 2020 2020 6e78 736f 7572  '.        nxsour
+00002d70: 6365 2e70 726f 6265 203d 2027 782d 7261  ce.probe = 'x-ra
+00002d80: 7927 0a0a 2020 2020 2020 2020 2320 5461  y'..        # Ta
+00002d90: 6720 7468 6520 4e58 736f 7572 6365 2077  g the NXsource w
+00002da0: 6974 6820 7468 6520 7275 6e69 6e66 6f20  ith the runinfo 
+00002db0: 2861 7320 616e 2061 7474 7269 6275 7465  (as an attribute
+00002dc0: 290a 2320 2020 2020 2020 206e 7873 6f75  ).#        nxsou
+00002dd0: 7263 652e 6174 7472 735b 2763 7963 6c65  rce.attrs['cycle
+00002de0: 275d 203d 206d 6170 5f63 6f6e 6669 672e  '] = map_config.
+00002df0: 6379 636c 650a 2320 2020 2020 2020 206e  cycle.#        n
+00002e00: 7873 6f75 7263 652e 6174 7472 735b 2762  xsource.attrs['b
+00002e10: 7472 275d 203d 206d 6170 5f63 6f6e 6669  tr'] = map_confi
+00002e20: 672e 6274 720a 2020 2020 2020 2020 6e78  g.btr.        nx
+00002e30: 736f 7572 6365 2e61 7474 7273 5b27 7374  source.attrs['st
+00002e40: 6174 696f 6e27 5d20 3d20 6d61 705f 636f  ation'] = map_co
+00002e50: 6e66 6967 2e73 7461 7469 6f6e 0a20 2020  nfig.station.   
+00002e60: 2020 2020 206e 7873 6f75 7263 652e 6174       nxsource.at
+00002e70: 7472 735b 2765 7870 6572 696d 656e 745f  trs['experiment_
+00002e80: 7479 7065 275d 203d 206d 6170 5f63 6f6e  type'] = map_con
+00002e90: 6669 672e 6578 7065 7269 6d65 6e74 5f74  fig.experiment_t
+00002ea0: 7970 650a 0a20 2020 2020 2020 2023 2041  ype..        # A
+00002eb0: 6464 2061 6e20 4e58 6465 7465 6374 6f72  dd an NXdetector
+00002ec0: 2074 6f20 7468 6520 4e58 696e 7374 7275   to the NXinstru
+00002ed0: 6d65 6e74 0a20 2020 2020 2020 2023 2028  ment.        # (
+00002ee0: 646f 206e 6f74 2066 696c 6c20 696e 2064  do not fill in d
+00002ef0: 6174 6120 6669 656c 6473 2079 6574 290a  ata fields yet).
+00002f00: 2020 2020 2020 2020 6e78 6465 7465 6374          nxdetect
+00002f10: 6f72 203d 204e 5864 6574 6563 746f 7228  or = NXdetector(
+00002f20: 290a 2020 2020 2020 2020 6e78 696e 7374  ).        nxinst
+00002f30: 7275 6d65 6e74 2e64 6574 6563 746f 7220  rument.detector 
+00002f40: 3d20 6e78 6465 7465 6374 6f72 0a20 2020  = nxdetector.   
+00002f50: 2020 2020 206e 7864 6574 6563 746f 722e       nxdetector.
+00002f60: 6c6f 6361 6c5f 6e61 6d65 203d 2074 6f6f  local_name = too
+00002f70: 6c5f 636f 6e66 6967 2e64 6574 6563 746f  l_config.detecto
+00002f80: 722e 7072 6566 6978 0a20 2020 2020 2020  r.prefix.       
+00002f90: 2070 6978 656c 5f73 697a 6520 3d20 746f   pixel_size = to
+00002fa0: 6f6c 5f63 6f6e 6669 672e 6465 7465 6374  ol_config.detect
+00002fb0: 6f72 2e70 6978 656c 5f73 697a 650a 2020  or.pixel_size.  
+00002fc0: 2020 2020 2020 6966 206c 656e 2870 6978        if len(pix
+00002fd0: 656c 5f73 697a 6529 203d 3d20 313a 0a20  el_size) == 1:. 
+00002fe0: 2020 2020 2020 2020 2020 206e 7864 6574             nxdet
+00002ff0: 6563 746f 722e 785f 7069 7865 6c5f 7369  ector.x_pixel_si
+00003000: 7a65 203d 205c 0a20 2020 2020 2020 2020  ze = \.         
+00003010: 2020 2020 2020 2070 6978 656c 5f73 697a         pixel_siz
+00003020: 655b 305d 2f74 6f6f 6c5f 636f 6e66 6967  e[0]/tool_config
+00003030: 2e64 6574 6563 746f 722e 6c65 6e73 5f6d  .detector.lens_m
+00003040: 6167 6e69 6669 6361 7469 6f6e 0a20 2020  agnification.   
+00003050: 2020 2020 2020 2020 206e 7864 6574 6563           nxdetec
+00003060: 746f 722e 795f 7069 7865 6c5f 7369 7a65  tor.y_pixel_size
+00003070: 203d 205c 0a20 2020 2020 2020 2020 2020   = \.           
+00003080: 2020 2020 2070 6978 656c 5f73 697a 655b       pixel_size[
+00003090: 305d 2f74 6f6f 6c5f 636f 6e66 6967 2e64  0]/tool_config.d
+000030a0: 6574 6563 746f 722e 6c65 6e73 5f6d 6167  etector.lens_mag
+000030b0: 6e69 6669 6361 7469 6f6e 0a20 2020 2020  nification.     
+000030c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000030d0: 2020 2020 206e 7864 6574 6563 746f 722e       nxdetector.
+000030e0: 785f 7069 7865 6c5f 7369 7a65 203d 205c  x_pixel_size = \
+000030f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003100: 2070 6978 656c 5f73 697a 655b 305d 2f74   pixel_size[0]/t
+00003110: 6f6f 6c5f 636f 6e66 6967 2e64 6574 6563  ool_config.detec
+00003120: 746f 722e 6c65 6e73 5f6d 6167 6e69 6669  tor.lens_magnifi
+00003130: 6361 7469 6f6e 0a20 2020 2020 2020 2020  cation.         
+00003140: 2020 206e 7864 6574 6563 746f 722e 795f     nxdetector.y_
+00003150: 7069 7865 6c5f 7369 7a65 203d 205c 0a20  pixel_size = \. 
+00003160: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00003170: 6978 656c 5f73 697a 655b 315d 2f74 6f6f  ixel_size[1]/too
+00003180: 6c5f 636f 6e66 6967 2e64 6574 6563 746f  l_config.detecto
+00003190: 722e 6c65 6e73 5f6d 6167 6e69 6669 6361  r.lens_magnifica
+000031a0: 7469 6f6e 0a20 2020 2020 2020 206e 7864  tion.        nxd
+000031b0: 6574 6563 746f 722e 785f 7069 7865 6c5f  etector.x_pixel_
+000031c0: 7369 7a65 2e61 7474 7273 5b27 756e 6974  size.attrs['unit
+000031d0: 7327 5d20 3d20 276d 6d27 0a20 2020 2020  s'] = 'mm'.     
+000031e0: 2020 206e 7864 6574 6563 746f 722e 795f     nxdetector.y_
+000031f0: 7069 7865 6c5f 7369 7a65 2e61 7474 7273  pixel_size.attrs
+00003200: 5b27 756e 6974 7327 5d20 3d20 276d 6d27  ['units'] = 'mm'
+00003210: 0a0a 2020 2020 2020 2020 6966 2069 6e63  ..        if inc
+00003220: 6c75 6465 5f72 6177 5f64 6174 613a 0a20  lude_raw_data:. 
+00003230: 2020 2020 2020 2020 2020 2023 2041 6464             # Add
+00003240: 2061 6e20 4e58 7361 6d70 6c65 2074 6f20   an NXsample to 
+00003250: 4e58 656e 7472 790a 2020 2020 2020 2020  NXentry.        
+00003260: 2020 2020 2320 2864 6f20 6e6f 7420 6669      # (do not fi
+00003270: 6c6c 2069 6e20 6461 7461 2066 6965 6c64  ll in data field
+00003280: 7320 7965 7429 0a20 2020 2020 2020 2020  s yet).         
+00003290: 2020 206e 7873 616d 706c 6520 3d20 4e58     nxsample = NX
+000032a0: 7361 6d70 6c65 2829 0a20 2020 2020 2020  sample().       
+000032b0: 2020 2020 206e 7865 6e74 7279 2e73 616d       nxentry.sam
+000032c0: 706c 6520 3d20 6e78 7361 6d70 6c65 0a20  ple = nxsample. 
+000032d0: 2020 2020 2020 2020 2020 206e 7873 616d             nxsam
+000032e0: 706c 652e 6e61 6d65 203d 206d 6170 5f63  ple.name = map_c
+000032f0: 6f6e 6669 672e 7361 6d70 6c65 2e6e 616d  onfig.sample.nam
+00003300: 650a 2020 2020 2020 2020 2020 2020 6e78  e.            nx
+00003310: 7361 6d70 6c65 2e64 6573 6372 6970 7469  sample.descripti
+00003320: 6f6e 203d 206d 6170 5f63 6f6e 6669 672e  on = map_config.
+00003330: 7361 6d70 6c65 2e64 6573 6372 6970 7469  sample.descripti
+00003340: 6f6e 0a0a 2020 2020 2020 2020 2320 4164  on..        # Ad
+00003350: 6420 4e58 636f 6c6c 6563 7469 6f6e 2773  d NXcollection's
+00003360: 2074 6f20 4e58 656e 7472 7920 746f 2068   to NXentry to h
+00003370: 6f6c 6420 6d65 7461 6461 7461 2061 626f  old metadata abo
+00003380: 7574 2074 6865 2053 5045 430a 2020 2020  ut the SPEC.    
+00003390: 2020 2020 2320 2020 2020 7363 616e 7320      #     scans 
+000033a0: 696e 2074 6865 206d 6170 0a20 2020 2020  in the map.     
+000033b0: 2020 2023 2041 6c73 6f20 6f62 7461 696e     # Also obtain
+000033c0: 2074 6865 2064 6174 6120 6669 656c 6473   the data fields
+000033d0: 2069 6e20 4e58 7361 6d70 6c65 2061 6e64   in NXsample and
+000033e0: 204e 5864 6574 6563 746f 7220 6966 0a20   NXdetector if. 
+000033f0: 2020 2020 2020 2023 2020 2020 2072 6571         #     req
+00003400: 7565 7374 6564 0a20 2020 2020 2020 2069  uested.        i
+00003410: 6d70 6f72 745f 7363 616e 7061 7273 6572  mport_scanparser
+00003420: 286d 6170 5f63 6f6e 6669 672e 7374 6174  (map_config.stat
+00003430: 696f 6e2c 206d 6170 5f63 6f6e 6669 672e  ion, map_config.
+00003440: 6578 7065 7269 6d65 6e74 5f74 7970 6529  experiment_type)
+00003450: 0a20 2020 2020 2020 2069 6d61 6765 5f6b  .        image_k
+00003460: 6579 7320 3d20 5b5d 0a20 2020 2020 2020  eys = [].       
+00003470: 2073 6571 7565 6e63 655f 6e75 6d62 6572   sequence_number
+00003480: 7320 3d20 5b5d 0a20 2020 2020 2020 2069  s = [].        i
+00003490: 6d61 6765 5f73 7461 636b 7320 3d20 5b5d  mage_stacks = []
+000034a0: 0a20 2020 2020 2020 2072 6f74 6174 696f  .        rotatio
+000034b0: 6e5f 616e 676c 6573 203d 205b 5d0a 2020  n_angles = [].  
+000034c0: 2020 2020 2020 785f 7472 616e 736c 6174        x_translat
+000034d0: 696f 6e73 203d 205b 5d0a 2020 2020 2020  ions = [].      
+000034e0: 2020 7a5f 7472 616e 736c 6174 696f 6e73    z_translations
+000034f0: 203d 205b 5d0a 2020 2020 2020 2020 7370   = [].        sp
+00003500: 6563 5f73 6361 6e73 203d 206d 6170 5f63  ec_scans = map_c
+00003510: 6f6e 6669 672e 7370 6563 5f73 6361 6e73  onfig.spec_scans
+00003520: 0a20 2020 2020 2020 2069 6620 6d61 705f  .        if map_
+00003530: 636f 6e66 6967 2e73 7461 7469 6f6e 203d  config.station =
+00003540: 3d20 2769 6433 6227 3a0a 2020 2020 2020  = 'id3b':.      
+00003550: 2020 2020 2020 7363 616e 5f74 7970 6573        scan_types
+00003560: 203d 206c 656e 2873 7065 635f 7363 616e   = len(spec_scan
+00003570: 7329 2a5b 2774 7331 275d 0a20 2020 2020  s)*['ts1'].     
+00003580: 2020 2020 2020 2069 6620 746f 6f6c 5f63         if tool_c
 00003590: 6f6e 6669 672e 6461 726b 5f66 6965 6c64  onfig.dark_field
-000035a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000035b0: 2073 6361 6e5f 7479 7065 732e 6170 7065   scan_types.appe
-000035c0: 6e64 2827 6466 3127 290a 2020 2020 2020  nd('df1').      
-000035d0: 2020 2020 2020 6966 2074 6f6f 6c5f 636f        if tool_co
-000035e0: 6e66 6967 2e62 7269 6768 745f 6669 656c  nfig.bright_fiel
-000035f0: 6420 6973 206e 6f74 204e 6f6e 653a 0a20  d is not None:. 
-00003600: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00003610: 7065 635f 7363 616e 7320 2b3d 2074 6f6f  pec_scans += too
-00003620: 6c5f 636f 6e66 6967 2e62 7269 6768 745f  l_config.bright_
-00003630: 6669 656c 640a 2020 2020 2020 2020 2020  field.          
-00003640: 2020 2020 2020 7363 616e 5f74 7970 6573        scan_types
-00003650: 2e61 7070 656e 6428 2762 6631 2729 0a20  .append('bf1'). 
-00003660: 2020 2020 2020 2066 6f72 206e 2c20 7363         for n, sc
-00003670: 616e 7320 696e 2065 6e75 6d65 7261 7465  ans in enumerate
-00003680: 2873 7065 635f 7363 616e 7329 3a0a 2020  (spec_scans):.  
-00003690: 2020 2020 2020 2020 2020 666f 7220 7363            for sc
-000036a0: 616e 5f6e 756d 6265 7220 696e 2073 6361  an_number in sca
-000036b0: 6e73 2e73 6361 6e5f 6e75 6d62 6572 733a  ns.scan_numbers:
-000036c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000036d0: 2073 6361 6e70 6172 7365 7220 3d20 7363   scanparser = sc
-000036e0: 616e 732e 6765 745f 7363 616e 7061 7273  ans.get_scanpars
-000036f0: 6572 2873 6361 6e5f 6e75 6d62 6572 290a  er(scan_number).
-00003700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003710: 6966 206d 6170 5f63 6f6e 6669 672e 7374  if map_config.st
-00003720: 6174 696f 6e20 696e 2028 2769 6431 6133  ation in ('id1a3
-00003730: 272c 2027 6964 3361 2729 3a0a 2020 2020  ', 'id3a'):.    
-00003740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003750: 7363 616e 5f74 7970 6520 3d20 7363 616e  scan_type = scan
-00003760: 7061 7273 6572 2e73 6361 6e5f 7479 7065  parser.scan_type
-00003770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003780: 2020 2020 2069 6620 7363 616e 5f74 7970       if scan_typ
-00003790: 6520 3d3d 2027 6466 3127 3a0a 2020 2020  e == 'df1':.    
-000037a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000037b0: 2020 2020 696d 6167 655f 6b65 7920 3d20      image_key = 
-000037c0: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
-000037d0: 2020 2020 2020 2020 2020 6669 656c 645f            field_
-000037e0: 6e61 6d65 203d 2027 6461 726b 5f66 6965  name = 'dark_fie
-000037f0: 6c64 270a 2020 2020 2020 2020 2020 2020  ld'.            
-00003800: 2020 2020 2020 2020 656c 6966 2073 6361          elif sca
-00003810: 6e5f 7479 7065 203d 3d20 2762 6631 273a  n_type == 'bf1':
-00003820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003830: 2020 2020 2020 2020 2069 6d61 6765 5f6b           image_k
-00003840: 6579 203d 2031 0a20 2020 2020 2020 2020  ey = 1.         
-00003850: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00003860: 6965 6c64 5f6e 616d 6520 3d20 2762 7269  ield_name = 'bri
-00003870: 6768 745f 6669 656c 6427 0a20 2020 2020  ght_field'.     
-00003880: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00003890: 6c69 6620 7363 616e 5f74 7970 6520 3d3d  lif scan_type ==
-000038a0: 2027 7473 3127 3a0a 2020 2020 2020 2020   'ts1':.        
-000038b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000038c0: 696d 6167 655f 6b65 7920 3d20 300a 2020  image_key = 0.  
-000038d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000038e0: 2020 2020 2020 6669 656c 645f 6e61 6d65        field_name
-000038f0: 203d 2027 746f 6d6f 5f66 6965 6c64 7327   = 'tomo_fields'
-00003900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003910: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000035a0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000035b0: 2020 2020 2020 2020 2020 2020 2020 7370                sp
+000035c0: 6563 5f73 6361 6e73 202b 3d20 746f 6f6c  ec_scans += tool
+000035d0: 5f63 6f6e 6669 672e 6461 726b 5f66 6965  _config.dark_fie
+000035e0: 6c64 0a20 2020 2020 2020 2020 2020 2020  ld.             
+000035f0: 2020 2073 6361 6e5f 7479 7065 732e 6170     scan_types.ap
+00003600: 7065 6e64 2827 6466 3127 290a 2020 2020  pend('df1').    
+00003610: 2020 2020 2020 2020 6966 2074 6f6f 6c5f          if tool_
+00003620: 636f 6e66 6967 2e62 7269 6768 745f 6669  config.bright_fi
+00003630: 656c 6420 6973 206e 6f74 204e 6f6e 653a  eld is not None:
+00003640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003650: 2073 7065 635f 7363 616e 7320 2b3d 2074   spec_scans += t
+00003660: 6f6f 6c5f 636f 6e66 6967 2e62 7269 6768  ool_config.brigh
+00003670: 745f 6669 656c 640a 2020 2020 2020 2020  t_field.        
+00003680: 2020 2020 2020 2020 7363 616e 5f74 7970          scan_typ
+00003690: 6573 2e61 7070 656e 6428 2762 6631 2729  es.append('bf1')
+000036a0: 0a20 2020 2020 2020 2066 6f72 206e 2c20  .        for n, 
+000036b0: 7363 616e 7320 696e 2065 6e75 6d65 7261  scans in enumera
+000036c0: 7465 2873 7065 635f 7363 616e 7329 3a0a  te(spec_scans):.
+000036d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000036e0: 7363 616e 5f6e 756d 6265 7220 696e 2073  scan_number in s
+000036f0: 6361 6e73 2e73 6361 6e5f 6e75 6d62 6572  cans.scan_number
+00003700: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00003710: 2020 2073 6361 6e70 6172 7365 7220 3d20     scanparser = 
+00003720: 7363 616e 732e 6765 745f 7363 616e 7061  scans.get_scanpa
+00003730: 7273 6572 2873 6361 6e5f 6e75 6d62 6572  rser(scan_number
+00003740: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00003750: 2020 6966 206d 6170 5f63 6f6e 6669 672e    if map_config.
+00003760: 7374 6174 696f 6e20 696e 2028 2769 6431  station in ('id1
+00003770: 6133 272c 2027 6964 3361 2729 3a0a 2020  a3', 'id3a'):.  
+00003780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003790: 2020 7363 616e 5f74 7970 6520 3d20 7363    scan_type = sc
+000037a0: 616e 7061 7273 6572 2e73 6361 6e5f 7479  anparser.scan_ty
+000037b0: 7065 0a20 2020 2020 2020 2020 2020 2020  pe.             
+000037c0: 2020 2020 2020 2069 6620 7363 616e 5f74         if scan_t
+000037d0: 7970 6520 3d3d 2027 6466 3127 3a0a 2020  ype == 'df1':.  
+000037e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000037f0: 2020 2020 2020 696d 6167 655f 6b65 7920        image_key 
+00003800: 3d20 320a 2020 2020 2020 2020 2020 2020  = 2.            
+00003810: 2020 2020 2020 2020 2020 2020 6669 656c              fiel
+00003820: 645f 6e61 6d65 203d 2027 6461 726b 5f66  d_name = 'dark_f
+00003830: 6965 6c64 270a 2020 2020 2020 2020 2020  ield'.          
+00003840: 2020 2020 2020 2020 2020 656c 6966 2073            elif s
+00003850: 6361 6e5f 7479 7065 203d 3d20 2762 6631  can_type == 'bf1
+00003860: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+00003870: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+00003880: 5f6b 6579 203d 2031 0a20 2020 2020 2020  _key = 1.       
+00003890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000038a0: 2066 6965 6c64 5f6e 616d 6520 3d20 2762   field_name = 'b
+000038b0: 7269 6768 745f 6669 656c 6427 0a20 2020  right_field'.   
+000038c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000038d0: 2065 6c69 6620 7363 616e 5f74 7970 6520   elif scan_type 
+000038e0: 696e 2028 2774 7331 272c 2027 746f 6d6f  in ('ts1', 'tomo
+000038f0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00003900: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+00003910: 655f 6b65 7920 3d20 300a 2020 2020 2020  e_key = 0.      
 00003920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003930: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
-00003940: 4572 726f 7228 2749 6e76 616c 6964 2073  Error('Invalid s
-00003950: 6361 6e20 7479 7065 3a20 7b73 6361 6e5f  can type: {scan_
-00003960: 7479 7065 7d27 290a 2020 2020 2020 2020  type}').        
-00003970: 2020 2020 2020 2020 656c 6966 206d 6170          elif map
-00003980: 5f63 6f6e 6669 672e 7374 6174 696f 6e20  _config.station 
-00003990: 3d3d 2027 6964 3362 273a 0a20 2020 2020  == 'id3b':.     
-000039a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000039b0: 6620 2873 6361 6e73 2e73 7065 635f 6669  f (scans.spec_fi
-000039c0: 6c65 2e65 6e64 7377 6974 6828 275f 6461  le.endswith('_da
-000039d0: 726b 2729 0a20 2020 2020 2020 2020 2020  rk').           
-000039e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000039f0: 206f 7220 7363 616e 5f74 7970 6573 5b6e   or scan_types[n
-00003a00: 5d20 3d3d 2027 6466 3127 293a 0a20 2020  ] == 'df1'):.   
-00003a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a20: 2020 2020 2069 6d61 6765 5f6b 6579 203d       image_key =
-00003a30: 2032 0a20 2020 2020 2020 2020 2020 2020   2.             
-00003a40: 2020 2020 2020 2020 2020 2066 6965 6c64             field
-00003a50: 5f6e 616d 6520 3d20 2764 6172 6b5f 6669  _name = 'dark_fi
-00003a60: 656c 6427 0a20 2020 2020 2020 2020 2020  eld'.           
-00003a70: 2020 2020 2020 2020 2065 6c69 6620 2873           elif (s
-00003a80: 6361 6e73 2e73 7065 635f 6669 6c65 2e65  cans.spec_file.e
-00003a90: 6e64 7377 6974 6828 275f 666c 6174 2729  ndswith('_flat')
-00003aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003ab0: 2020 2020 2020 2020 2020 2020 206f 7220               or 
-00003ac0: 7363 616e 5f74 7970 6573 5b6e 5d20 3d3d  scan_types[n] ==
-00003ad0: 2027 6266 3127 293a 0a20 2020 2020 2020   'bf1'):.       
-00003ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003af0: 2069 6d61 6765 5f6b 6579 203d 2031 0a20   image_key = 1. 
-00003b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003b10: 2020 2020 2020 2066 6965 6c64 5f6e 616d         field_nam
-00003b20: 6520 3d20 2762 7269 6768 745f 6669 656c  e = 'bright_fiel
-00003b30: 6427 0a20 2020 2020 2020 2020 2020 2020  d'.             
-00003b40: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00003930: 2020 6669 656c 645f 6e61 6d65 203d 2027    field_name = '
+00003940: 746f 6d6f 5f66 6965 6c64 7327 0a20 2020  tomo_fields'.   
+00003950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003960: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00003970: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00003980: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
+00003990: 7228 2749 6e76 616c 6964 2073 6361 6e20  r('Invalid scan 
+000039a0: 7479 7065 3a20 7b73 6361 6e5f 7479 7065  type: {scan_type
+000039b0: 7d27 290a 2020 2020 2020 2020 2020 2020  }').            
+000039c0: 2020 2020 656c 6966 206d 6170 5f63 6f6e      elif map_con
+000039d0: 6669 672e 7374 6174 696f 6e20 3d3d 2027  fig.station == '
+000039e0: 6964 3362 273a 0a20 2020 2020 2020 2020  id3b':.         
+000039f0: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
+00003a00: 6361 6e73 2e73 7065 635f 6669 6c65 2e65  cans.spec_file.e
+00003a10: 6e64 7377 6974 6828 275f 6461 726b 2729  ndswith('_dark')
+00003a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003a30: 2020 2020 2020 2020 2020 2020 206f 7220               or 
+00003a40: 7363 616e 5f74 7970 6573 5b6e 5d20 3d3d  scan_types[n] ==
+00003a50: 2027 6466 3127 293a 0a20 2020 2020 2020   'df1'):.       
+00003a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003a70: 2069 6d61 6765 5f6b 6579 203d 2032 0a20   image_key = 2. 
+00003a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003a90: 2020 2020 2020 2066 6965 6c64 5f6e 616d         field_nam
+00003aa0: 6520 3d20 2764 6172 6b5f 6669 656c 6427  e = 'dark_field'
+00003ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003ac0: 2020 2020 2065 6c69 6620 2873 6361 6e73       elif (scans
+00003ad0: 2e73 7065 635f 6669 6c65 2e65 6e64 7377  .spec_file.endsw
+00003ae0: 6974 6828 275f 666c 6174 2729 0a20 2020  ith('_flat').   
+00003af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003b00: 2020 2020 2020 2020 206f 7220 7363 616e           or scan
+00003b10: 5f74 7970 6573 5b6e 5d20 3d3d 2027 6266  _types[n] == 'bf
+00003b20: 3127 293a 0a20 2020 2020 2020 2020 2020  1'):.           
+00003b30: 2020 2020 2020 2020 2020 2020 2069 6d61               ima
+00003b40: 6765 5f6b 6579 203d 2031 0a20 2020 2020  ge_key = 1.     
 00003b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003b60: 2020 2020 2069 6d61 6765 5f6b 6579 203d       image_key =
-00003b70: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
-00003b80: 2020 2020 2020 2020 2020 2066 6965 6c64             field
-00003b90: 5f6e 616d 6520 3d20 2774 6f6d 6f5f 6669  _name = 'tomo_fi
-00003ba0: 656c 6473 270a 2020 2020 2020 2020 2020  elds'.          
-00003bb0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00003b60: 2020 2066 6965 6c64 5f6e 616d 6520 3d20     field_name = 
+00003b70: 2762 7269 6768 745f 6669 656c 6427 0a20  'bright_field'. 
+00003b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003b90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00003ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003bb0: 2069 6d61 6765 5f6b 6579 203d 2030 0a20   image_key = 0. 
 00003bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003bd0: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
-00003be0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00003bf0: 2020 2020 2020 2020 2020 2020 6627 496e              f'In
-00003c00: 7661 6c69 6420 7374 6174 696f 6e20 696e  valid station in
-00003c10: 206d 6170 5f63 6f6e 6669 673a 207b 6d61   map_config: {ma
-00003c20: 705f 636f 6e66 6967 2e73 7461 7469 6f6e  p_config.station
-00003c30: 7d27 290a 0a20 2020 2020 2020 2020 2020  }')..           
-00003c40: 2020 2020 2023 2043 7265 6174 6520 616e       # Create an
-00003c50: 204e 5863 6f6c 6c65 6374 696f 6e20 666f   NXcollection fo
-00003c60: 7220 6561 6368 2066 6965 6c64 2074 7970  r each field typ
-00003c70: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00003c80: 2020 6966 2066 6965 6c64 5f6e 616d 6520    if field_name 
-00003c90: 696e 206e 7865 6e74 7279 2e73 7065 635f  in nxentry.spec_
-00003ca0: 7363 616e 733a 0a20 2020 2020 2020 2020  scans:.         
-00003cb0: 2020 2020 2020 2020 2020 206e 7863 6f6c             nxcol
-00003cc0: 6c65 6374 696f 6e20 3d20 6e78 656e 7472  lection = nxentr
-00003cd0: 792e 7370 6563 5f73 6361 6e73 5b66 6965  y.spec_scans[fie
-00003ce0: 6c64 5f6e 616d 655d 0a20 2020 2020 2020  ld_name].       
-00003cf0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00003d00: 6e78 636f 6c6c 6563 7469 6f6e 2e61 7474  nxcollection.att
-00003d10: 7273 5b27 7370 6563 5f66 696c 6527 5d20  rs['spec_file'] 
-00003d20: 213d 2073 7472 2873 6361 6e73 2e73 7065  != str(scans.spe
-00003d30: 635f 6669 6c65 293a 0a20 2020 2020 2020  c_file):.       
-00003d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003d50: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
-00003d60: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00003d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003d80: 2027 4d75 6c74 6970 6c65 2053 5045 4320   'Multiple SPEC 
-00003d90: 6669 6c65 7320 666f 7220 6120 7369 6e67  files for a sing
-00003da0: 6c65 2066 6965 6c64 2074 7970 6520 6e6f  le field type no
-00003db0: 7420 270a 2020 2020 2020 2020 2020 2020  t '.            
-00003dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003dd0: 2b20 6627 7965 7420 696d 706c 656d 656e  + f'yet implemen
-00003de0: 7465 643b 2066 6965 6c64 206e 616d 653a  ted; field name:
-00003df0: 207b 6669 656c 645f 6e61 6d65 7d2c 2027   {field_name}, '
-00003e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003e10: 2020 2020 2020 2020 2020 2020 202b 2066               + f
-00003e20: 2753 5045 4320 6669 6c65 3a20 7b73 7472  'SPEC file: {str
-00003e30: 2873 6361 6e73 2e73 7065 635f 6669 6c65  (scans.spec_file
-00003e40: 297d 2729 0a20 2020 2020 2020 2020 2020  )}').           
-00003e50: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00003e60: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00003e70: 7863 6f6c 6c65 6374 696f 6e20 3d20 4e58  xcollection = NX
-00003e80: 636f 6c6c 6563 7469 6f6e 2829 0a20 2020  collection().   
-00003e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ea0: 206e 7865 6e74 7279 2e73 7065 635f 7363   nxentry.spec_sc
-00003eb0: 616e 735b 6669 656c 645f 6e61 6d65 5d20  ans[field_name] 
-00003ec0: 3d20 6e78 636f 6c6c 6563 7469 6f6e 0a20  = nxcollection. 
-00003ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ee0: 2020 206e 7863 6f6c 6c65 6374 696f 6e2e     nxcollection.
-00003ef0: 6174 7472 735b 2773 7065 635f 6669 6c65  attrs['spec_file
-00003f00: 275d 203d 2073 7472 2873 6361 6e73 2e73  '] = str(scans.s
-00003f10: 7065 635f 6669 6c65 290a 2020 2020 2020  pec_file).      
-00003f20: 2020 2020 2020 2020 2020 2020 2020 6e78                nx
-00003f30: 636f 6c6c 6563 7469 6f6e 2e61 7474 7273  collection.attrs
-00003f40: 5b27 6461 7465 275d 203d 2073 6361 6e70  ['date'] = scanp
-00003f50: 6172 7365 722e 7370 6563 5f73 6361 6e2e  arser.spec_scan.
-00003f60: 6669 6c65 5f64 6174 650a 0a20 2020 2020  file_date..     
-00003f70: 2020 2020 2020 2020 2020 2023 2047 6574             # Get
-00003f80: 2074 6865 7461 730a 2020 2020 2020 2020   thetas.        
-00003f90: 2020 2020 2020 2020 696d 6167 655f 6f66          image_of
-00003fa0: 6673 6574 203d 2073 6361 6e70 6172 7365  fset = scanparse
-00003fb0: 722e 7374 6172 7469 6e67 5f69 6d61 6765  r.starting_image
-00003fc0: 5f6f 6666 7365 740a 2020 2020 2020 2020  _offset.        
-00003fd0: 2020 2020 2020 2020 6966 206d 6170 5f63          if map_c
-00003fe0: 6f6e 6669 672e 7374 6174 696f 6e20 696e  onfig.station in
-00003ff0: 2028 2769 6431 6133 272c 2027 6964 3361   ('id1a3', 'id3a
-00004000: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00004010: 2020 2020 2020 2020 7468 6574 6173 203d          thetas =
-00004020: 2073 6361 6e70 6172 7365 722e 726f 7461   scanparser.rota
-00004030: 7469 6f6e 5f61 6e67 6c65 730a 2020 2020  tion_angles.    
-00004040: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00004050: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00004060: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00004070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004080: 2020 2074 6865 7461 7320 3d20 5b5d 0a20     thetas = []. 
-00004090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000040a0: 2020 2020 2020 206e 756d 5f74 6865 7461         num_theta
-000040b0: 203d 2073 6361 6e70 6172 7365 722e 7370   = scanparser.sp
-000040c0: 6563 5f73 6361 6e5f 6e70 7473 0a20 2020  ec_scan_npts.   
-000040d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000040e0: 2020 2020 2066 6f72 2064 696d 2069 6e20       for dim in 
-000040f0: 6d61 705f 636f 6e66 6967 2e69 6e64 6570  map_config.indep
-00004100: 656e 6465 6e74 5f64 696d 656e 7369 6f6e  endent_dimension
-00004110: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00004120: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00004130: 6620 6469 6d2e 6c61 6265 6c20 213d 2027  f dim.label != '
-00004140: 7468 6574 6127 3a0a 2020 2020 2020 2020  theta':.        
-00004150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004160: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-00004170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004180: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00004190: 2069 6e64 6578 2069 6e20 7261 6e67 6528   index in range(
-000041a0: 6e75 6d5f 7468 6574 6129 3a0a 2020 2020  num_theta):.    
-000041b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000041c0: 2020 2020 2020 2020 2020 2020 7468 6574              thet
-000041d0: 6173 2e61 7070 656e 6428 6469 6d2e 6765  as.append(dim.ge
-000041e0: 745f 7661 6c75 6528 0a20 2020 2020 2020  t_value(.       
-000041f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004200: 2020 2020 2020 2020 2020 2020 2073 6361               sca
-00004210: 6e73 2c20 7363 616e 5f6e 756d 6265 722c  ns, scan_number,
-00004220: 2069 6e64 6578 2b69 6d61 6765 5f6f 6666   index+image_off
-00004230: 7365 7429 290a 2020 2020 2020 2020 2020  set)).          
-00004240: 2020 2020 2020 2020 2020 2020 2020 7468                th
-00004250: 6574 6173 203d 206e 702e 6173 6172 7261  etas = np.asarra
-00004260: 7928 7468 6574 6173 290a 2020 2020 2020  y(thetas).      
-00004270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004280: 2020 6173 7365 7274 2074 6865 7461 7320    assert thetas 
-00004290: 3d3d 2073 6361 6e70 6172 7365 722e 726f  == scanparser.ro
-000042a0: 7461 7469 6f6e 5f61 6e67 6c65 730a 2020  tation_angles.  
-000042b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000042c0: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
-000042d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000042e0: 2020 7468 6574 6173 203d 2073 6361 6e70    thetas = scanp
-000042f0: 6172 7365 722e 726f 7461 7469 6f6e 5f61  arser.rotation_a
-00004300: 6e67 6c65 730a 2020 2020 2020 2020 2020  ngles.          
-00004310: 2020 2020 2020 2020 2020 6966 2074 6865            if the
-00004320: 7461 735b 2d31 5d2d 7468 6574 6173 5b30  tas[-1]-thetas[0
-00004330: 5d20 3e20 3138 302e 3a0a 2020 2020 2020  ] > 180.:.      
-00004340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004350: 2020 696d 6167 655f 656e 6420 3d20 696e    image_end = in
-00004360: 6465 785f 6e65 6172 6573 7428 7468 6574  dex_nearest(thet
-00004370: 6173 2c20 7468 6574 6173 5b30 5d2b 3138  as, thetas[0]+18
-00004380: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
-00004390: 2020 2020 2020 2020 2020 2074 6865 7461             theta
-000043a0: 7320 3d20 7468 6574 6173 5b3a 696d 6167  s = thetas[:imag
-000043b0: 655f 656e 645d 0a0a 2020 2020 2020 2020  e_end]..        
-000043c0: 2020 2020 2020 2020 2320 7820 616e 6420          # x and 
-000043d0: 7a20 7472 616e 736c 6174 696f 6e73 0a20  z translations. 
-000043e0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
-000043f0: 5f74 7261 6e73 6c61 7469 6f6e 203d 2073  _translation = s
-00004400: 6361 6e70 6172 7365 722e 686f 7269 7a6f  canparser.horizo
-00004410: 6e74 616c 5f73 6869 6674 0a20 2020 2020  ntal_shift.     
-00004420: 2020 2020 2020 2020 2020 207a 5f74 7261             z_tra
-00004430: 6e73 6c61 7469 6f6e 203d 2073 6361 6e70  nslation = scanp
-00004440: 6172 7365 722e 7665 7274 6963 616c 5f73  arser.vertical_s
-00004450: 6869 6674 0a0a 2020 2020 2020 2020 2020  hift..          
-00004460: 2020 2020 2020 2320 4164 6420 616e 204e        # Add an N
-00004470: 5873 7562 656e 7472 7920 746f 2074 6865  Xsubentry to the
-00004480: 204e 5863 6f6c 6c65 6374 696f 6e20 666f   NXcollection fo
-00004490: 7220 6561 6368 2073 6361 6e0a 2020 2020  r each scan.    
-000044a0: 2020 2020 2020 2020 2020 2020 656e 7472              entr
-000044b0: 795f 6e61 6d65 203d 2066 2773 6361 6e5f  y_name = f'scan_
-000044c0: 7b73 6361 6e5f 6e75 6d62 6572 7d27 0a20  {scan_number}'. 
-000044d0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-000044e0: 7873 7562 656e 7472 7920 3d20 4e58 7375  xsubentry = NXsu
-000044f0: 6265 6e74 7279 2829 0a20 2020 2020 2020  bentry().       
-00004500: 2020 2020 2020 2020 206e 7863 6f6c 6c65           nxcolle
-00004510: 6374 696f 6e5b 656e 7472 795f 6e61 6d65  ction[entry_name
-00004520: 5d20 3d20 6e78 7375 6265 6e74 7279 0a20  ] = nxsubentry. 
-00004530: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00004540: 7873 7562 656e 7472 792e 7374 6172 745f  xsubentry.start_
-00004550: 7469 6d65 203d 2073 6361 6e70 6172 7365  time = scanparse
-00004560: 722e 7370 6563 5f73 6361 6e2e 6461 7465  r.spec_scan.date
-00004570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004580: 206e 7873 7562 656e 7472 792e 7370 6563   nxsubentry.spec
-00004590: 5f63 6f6d 6d61 6e64 203d 2073 6361 6e70  _command = scanp
-000045a0: 6172 7365 722e 7370 6563 5f63 6f6d 6d61  arser.spec_comma
-000045b0: 6e64 0a20 2020 2020 2020 2020 2020 2020  nd.             
-000045c0: 2020 2023 2041 6464 2061 6e20 4e58 696e     # Add an NXin
-000045d0: 7374 7275 6d65 6e74 2074 6f20 7468 6520  strument to the 
-000045e0: 7363 616e 2773 204e 5873 7562 656e 7472  scan's NXsubentr
-000045f0: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
-00004600: 2020 6e78 7375 6265 6e74 7279 2e69 6e73    nxsubentry.ins
-00004610: 7472 756d 656e 7420 3d20 4e58 696e 7374  trument = NXinst
-00004620: 7275 6d65 6e74 2829 0a20 2020 2020 2020  rument().       
-00004630: 2020 2020 2020 2020 2023 2041 6464 2061           # Add a
-00004640: 6e20 4e58 6465 7465 6374 6f72 2074 6f20  n NXdetector to 
-00004650: 7468 6520 4e58 696e 7374 7275 6d65 6e74  the NXinstrument
-00004660: 2074 6f20 7468 6520 7363 616e 2773 0a20   to the scan's. 
-00004670: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00004680: 2020 2020 204e 5873 7562 656e 7472 790a       NXsubentry.
-00004690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000046a0: 6e78 7375 6265 6e74 7279 2e69 6e73 7472  nxsubentry.instr
-000046b0: 756d 656e 742e 6465 7465 6374 6f72 203d  ument.detector =
-000046c0: 2064 6565 7063 6f70 7928 6e78 6465 7465   deepcopy(nxdete
-000046d0: 6374 6f72 290a 2020 2020 2020 2020 2020  ctor).          
-000046e0: 2020 2020 2020 6e78 7375 6265 6e74 7279        nxsubentry
-000046f0: 2e69 6e73 7472 756d 656e 742e 6465 7465  .instrument.dete
-00004700: 6374 6f72 2e66 7261 6d65 5f73 7461 7274  ctor.frame_start
-00004710: 5f6e 756d 6265 7220 3d20 5c0a 2020 2020  _number = \.    
-00004720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004730: 696d 6167 655f 6f66 6673 6574 0a20 2020  image_offset.   
-00004740: 2020 2020 2020 2020 2020 2020 206e 7873               nxs
-00004750: 7562 656e 7472 792e 696e 7374 7275 6d65  ubentry.instrume
-00004760: 6e74 2e64 6574 6563 746f 722e 696d 6167  nt.detector.imag
-00004770: 655f 6b65 7920 3d20 696d 6167 655f 6b65  e_key = image_ke
-00004780: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
-00004790: 2020 2320 4164 6420 616e 204e 5873 616d    # Add an NXsam
-000047a0: 706c 6520 746f 2074 6865 2073 6361 6e27  ple to the scan'
-000047b0: 7320 4e58 7375 6265 6e74 7279 0a20 2020  s NXsubentry.   
-000047c0: 2020 2020 2020 2020 2020 2020 206e 7873               nxs
-000047d0: 7562 656e 7472 792e 7361 6d70 6c65 203d  ubentry.sample =
-000047e0: 204e 5873 616d 706c 6528 290a 2020 2020   NXsample().    
-000047f0: 2020 2020 2020 2020 2020 2020 6e78 7375              nxsu
-00004800: 6265 6e74 7279 2e73 616d 706c 652e 726f  bentry.sample.ro
-00004810: 7461 7469 6f6e 5f61 6e67 6c65 203d 2074  tation_angle = t
-00004820: 6865 7461 730a 2020 2020 2020 2020 2020  hetas.          
-00004830: 2020 2020 2020 6e78 7375 6265 6e74 7279        nxsubentry
-00004840: 2e73 616d 706c 652e 726f 7461 7469 6f6e  .sample.rotation
-00004850: 5f61 6e67 6c65 2e75 6e69 7473 203d 2027  _angle.units = '
-00004860: 6465 6772 6565 7327 0a20 2020 2020 2020  degrees'.       
-00004870: 2020 2020 2020 2020 206e 7873 7562 656e           nxsuben
-00004880: 7472 792e 7361 6d70 6c65 2e78 5f74 7261  try.sample.x_tra
-00004890: 6e73 6c61 7469 6f6e 203d 2078 5f74 7261  nslation = x_tra
-000048a0: 6e73 6c61 7469 6f6e 0a20 2020 2020 2020  nslation.       
-000048b0: 2020 2020 2020 2020 206e 7873 7562 656e           nxsuben
-000048c0: 7472 792e 7361 6d70 6c65 2e78 5f74 7261  try.sample.x_tra
-000048d0: 6e73 6c61 7469 6f6e 2e75 6e69 7473 203d  nslation.units =
-000048e0: 2027 6d6d 270a 2020 2020 2020 2020 2020   'mm'.          
-000048f0: 2020 2020 2020 6e78 7375 6265 6e74 7279        nxsubentry
-00004900: 2e73 616d 706c 652e 7a5f 7472 616e 736c  .sample.z_transl
-00004910: 6174 696f 6e20 3d20 7a5f 7472 616e 736c  ation = z_transl
-00004920: 6174 696f 6e0a 2020 2020 2020 2020 2020  ation.          
-00004930: 2020 2020 2020 6e78 7375 6265 6e74 7279        nxsubentry
-00004940: 2e73 616d 706c 652e 7a5f 7472 616e 736c  .sample.z_transl
-00004950: 6174 696f 6e2e 756e 6974 7320 3d20 276d  ation.units = 'm
-00004960: 6d27 0a0a 2020 2020 2020 2020 2020 2020  m'..            
-00004970: 2020 2020 6966 2069 6e63 6c75 6465 5f72      if include_r
-00004980: 6177 5f64 6174 613a 0a20 2020 2020 2020  aw_data:.       
-00004990: 2020 2020 2020 2020 2020 2020 206e 756d               num
-000049a0: 5f69 6d61 6765 203d 206c 656e 2874 6865  _image = len(the
-000049b0: 7461 7329 0a20 2020 2020 2020 2020 2020  tas).           
-000049c0: 2020 2020 2020 2020 2069 6d61 6765 5f6b           image_k
-000049d0: 6579 7320 2b3d 206e 756d 5f69 6d61 6765  eys += num_image
-000049e0: 2a5b 696d 6167 655f 6b65 795d 0a20 2020  *[image_key].   
-000049f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004a00: 2073 6571 7565 6e63 655f 6e75 6d62 6572   sequence_number
-00004a10: 7320 2b3d 206c 6973 7428 7261 6e67 6528  s += list(range(
-00004a20: 6e75 6d5f 696d 6167 6529 290a 2020 2020  num_image)).    
-00004a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004a40: 696d 6167 655f 7374 6163 6b73 2e61 7070  image_stacks.app
-00004a50: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
-00004a60: 2020 2020 2020 2020 2020 2020 2073 6361               sca
-00004a70: 6e70 6172 7365 722e 6765 745f 6465 7465  nparser.get_dete
-00004a80: 6374 6f72 5f64 6174 6128 0a20 2020 2020  ctor_data(.     
-00004a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004aa0: 2020 2020 2020 2074 6f6f 6c5f 636f 6e66         tool_conf
-00004ab0: 6967 2e64 6574 6563 746f 722e 7072 6566  ig.detector.pref
-00004ac0: 6978 2c0a 2020 2020 2020 2020 2020 2020  ix,.            
-00004ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004ae0: 7363 616e 5f73 7465 705f 696e 6465 783d  scan_step_index=
-00004af0: 2869 6d61 6765 5f6f 6666 7365 742c 0a20  (image_offset,. 
-00004b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003bd0: 2020 2020 2020 2066 6965 6c64 5f6e 616d         field_nam
+00003be0: 6520 3d20 2774 6f6d 6f5f 6669 656c 6473  e = 'tomo_fields
+00003bf0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00003c00: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00003c10: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00003c20: 6520 5275 6e74 696d 6545 7272 6f72 280a  e RuntimeError(.
+00003c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003c40: 2020 2020 2020 2020 6627 496e 7661 6c69          f'Invali
+00003c50: 6420 7374 6174 696f 6e20 696e 206d 6170  d station in map
+00003c60: 5f63 6f6e 6669 673a 207b 6d61 705f 636f  _config: {map_co
+00003c70: 6e66 6967 2e73 7461 7469 6f6e 7d27 290a  nfig.station}').
+00003c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003c90: 2023 2043 7265 6174 6520 616e 204e 5863   # Create an NXc
+00003ca0: 6f6c 6c65 6374 696f 6e20 666f 7220 6561  ollection for ea
+00003cb0: 6368 2066 6965 6c64 2074 7970 650a 2020  ch field type.  
+00003cc0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00003cd0: 2066 6965 6c64 5f6e 616d 6520 696e 206e   field_name in n
+00003ce0: 7865 6e74 7279 2e73 7065 635f 7363 616e  xentry.spec_scan
+00003cf0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00003d00: 2020 2020 2020 206e 7863 6f6c 6c65 6374         nxcollect
+00003d10: 696f 6e20 3d20 6e78 656e 7472 792e 7370  ion = nxentry.sp
+00003d20: 6563 5f73 6361 6e73 5b66 6965 6c64 5f6e  ec_scans[field_n
+00003d30: 616d 655d 0a20 2020 2020 2020 2020 2020  ame].           
+00003d40: 2020 2020 2020 2020 2069 6620 6e78 636f           if nxco
+00003d50: 6c6c 6563 7469 6f6e 2e61 7474 7273 5b27  llection.attrs['
+00003d60: 7370 6563 5f66 696c 6527 5d20 213d 2073  spec_file'] != s
+00003d70: 7472 2873 6361 6e73 2e73 7065 635f 6669  tr(scans.spec_fi
+00003d80: 6c65 293a 0a20 2020 2020 2020 2020 2020  le):.           
+00003d90: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00003da0: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
+00003db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003dc0: 2020 2020 2020 2020 2020 2020 2027 4d75               'Mu
+00003dd0: 6c74 6970 6c65 2053 5045 4320 6669 6c65  ltiple SPEC file
+00003de0: 7320 666f 7220 6120 7369 6e67 6c65 2066  s for a single f
+00003df0: 6965 6c64 2074 7970 6520 6e6f 7420 270a  ield type not '.
+00003e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003e10: 2020 2020 2020 2020 2020 2020 2b20 6627              + f'
+00003e20: 7965 7420 696d 706c 656d 656e 7465 643b  yet implemented;
+00003e30: 2066 6965 6c64 206e 616d 653a 207b 6669   field name: {fi
+00003e40: 656c 645f 6e61 6d65 7d2c 2027 0a20 2020  eld_name}, '.   
+00003e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003e60: 2020 2020 2020 2020 202b 2066 2753 5045           + f'SPE
+00003e70: 4320 6669 6c65 3a20 7b73 7472 2873 6361  C file: {str(sca
+00003e80: 6e73 2e73 7065 635f 6669 6c65 297d 2729  ns.spec_file)}')
+00003e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003ea0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00003eb0: 2020 2020 2020 2020 2020 206e 7863 6f6c             nxcol
+00003ec0: 6c65 6374 696f 6e20 3d20 4e58 636f 6c6c  lection = NXcoll
+00003ed0: 6563 7469 6f6e 2829 0a20 2020 2020 2020  ection().       
+00003ee0: 2020 2020 2020 2020 2020 2020 206e 7865               nxe
+00003ef0: 6e74 7279 2e73 7065 635f 7363 616e 735b  ntry.spec_scans[
+00003f00: 6669 656c 645f 6e61 6d65 5d20 3d20 6e78  field_name] = nx
+00003f10: 636f 6c6c 6563 7469 6f6e 0a20 2020 2020  collection.     
+00003f20: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00003f30: 7863 6f6c 6c65 6374 696f 6e2e 6174 7472  xcollection.attr
+00003f40: 735b 2773 7065 635f 6669 6c65 275d 203d  s['spec_file'] =
+00003f50: 2073 7472 2873 6361 6e73 2e73 7065 635f   str(scans.spec_
+00003f60: 6669 6c65 290a 2020 2020 2020 2020 2020  file).          
+00003f70: 2020 2020 2020 2020 2020 6e78 636f 6c6c            nxcoll
+00003f80: 6563 7469 6f6e 2e61 7474 7273 5b27 6461  ection.attrs['da
+00003f90: 7465 275d 203d 2073 6361 6e70 6172 7365  te'] = scanparse
+00003fa0: 722e 7370 6563 5f73 6361 6e2e 6669 6c65  r.spec_scan.file
+00003fb0: 5f64 6174 650a 0a20 2020 2020 2020 2020  _date..         
+00003fc0: 2020 2020 2020 2023 2047 6574 2074 6865         # Get the
+00003fd0: 7461 730a 2020 2020 2020 2020 2020 2020  tas.            
+00003fe0: 2020 2020 696d 6167 655f 6f66 6673 6574      image_offset
+00003ff0: 203d 2073 6361 6e70 6172 7365 722e 7374   = scanparser.st
+00004000: 6172 7469 6e67 5f69 6d61 6765 5f6f 6666  arting_image_off
+00004010: 7365 740a 2020 2020 2020 2020 2020 2020  set.            
+00004020: 2020 2020 6966 206d 6170 5f63 6f6e 6669      if map_confi
+00004030: 672e 7374 6174 696f 6e20 696e 2028 2769  g.station in ('i
+00004040: 6431 6133 272c 2027 6964 3361 2729 3a0a  d1a3', 'id3a'):.
+00004050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004060: 2020 2020 7468 6574 6173 203d 2073 6361      thetas = sca
+00004070: 6e70 6172 7365 722e 726f 7461 7469 6f6e  nparser.rotation
+00004080: 5f61 6e67 6c65 730a 2020 2020 2020 2020  _angles.        
+00004090: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000040a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000040b0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+000040c0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000040d0: 6865 7461 7320 3d20 5b5d 0a20 2020 2020  hetas = [].     
+000040e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000040f0: 2020 206e 756d 5f74 6865 7461 203d 2073     num_theta = s
+00004100: 6361 6e70 6172 7365 722e 7370 6563 5f73  canparser.spec_s
+00004110: 6361 6e5f 6e70 7473 0a20 2020 2020 2020  can_npts.       
+00004120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004130: 2066 6f72 2064 696d 2069 6e20 6d61 705f   for dim in map_
+00004140: 636f 6e66 6967 2e69 6e64 6570 656e 6465  config.independe
+00004150: 6e74 5f64 696d 656e 7369 6f6e 733a 0a20  nt_dimensions:. 
+00004160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004170: 2020 2020 2020 2020 2020 2069 6620 6469             if di
+00004180: 6d2e 6c61 6265 6c20 213d 2027 7468 6574  m.label != 'thet
+00004190: 6127 3a0a 2020 2020 2020 2020 2020 2020  a':.            
+000041a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000041b0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+000041c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000041d0: 2020 2020 2020 2020 2066 6f72 2069 6e64           for ind
+000041e0: 6578 2069 6e20 7261 6e67 6528 6e75 6d5f  ex in range(num_
+000041f0: 7468 6574 6129 3a0a 2020 2020 2020 2020  theta):.        
+00004200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004210: 2020 2020 2020 2020 7468 6574 6173 2e61          thetas.a
+00004220: 7070 656e 6428 6469 6d2e 6765 745f 7661  ppend(dim.get_va
+00004230: 6c75 6528 0a20 2020 2020 2020 2020 2020  lue(.           
+00004240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004250: 2020 2020 2020 2020 2073 6361 6e73 2c20           scans, 
+00004260: 7363 616e 5f6e 756d 6265 722c 2069 6e64  scan_number, ind
+00004270: 6578 2b69 6d61 6765 5f6f 6666 7365 7429  ex+image_offset)
+00004280: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00004290: 2020 2020 2020 2020 2020 7468 6574 6173            thetas
+000042a0: 203d 206e 702e 6173 6172 7261 7928 7468   = np.asarray(th
+000042b0: 6574 6173 290a 2020 2020 2020 2020 2020  etas).          
+000042c0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+000042d0: 7365 7274 2074 6865 7461 7320 3d3d 2073  sert thetas == s
+000042e0: 6361 6e70 6172 7365 722e 726f 7461 7469  canparser.rotati
+000042f0: 6f6e 5f61 6e67 6c65 730a 2020 2020 2020  on_angles.      
+00004300: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+00004310: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
+00004320: 2020 2020 2020 2020 2020 2020 2020 7468                th
+00004330: 6574 6173 203d 2073 6361 6e70 6172 7365  etas = scanparse
+00004340: 722e 726f 7461 7469 6f6e 5f61 6e67 6c65  r.rotation_angle
+00004350: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00004360: 2020 2020 2020 6966 2074 6865 7461 735b        if thetas[
+00004370: 2d31 5d2d 7468 6574 6173 5b30 5d20 3e20  -1]-thetas[0] > 
+00004380: 3138 302e 3a0a 2020 2020 2020 2020 2020  180.:.          
+00004390: 2020 2020 2020 2020 2020 2020 2020 696d                im
+000043a0: 6167 655f 656e 6420 3d20 696e 6465 785f  age_end = index_
+000043b0: 6e65 6172 6573 7428 7468 6574 6173 2c20  nearest(thetas, 
+000043c0: 7468 6574 6173 5b30 5d2b 3138 3029 0a20  thetas[0]+180). 
+000043d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000043e0: 2020 2020 2020 2074 6865 7461 7320 3d20         thetas = 
+000043f0: 7468 6574 6173 5b3a 696d 6167 655f 656e  thetas[:image_en
+00004400: 645d 0a0a 2020 2020 2020 2020 2020 2020  d]..            
+00004410: 2020 2020 2320 7820 616e 6420 7a20 7472      # x and z tr
+00004420: 616e 736c 6174 696f 6e73 0a20 2020 2020  anslations.     
+00004430: 2020 2020 2020 2020 2020 2078 5f74 7261             x_tra
+00004440: 6e73 6c61 7469 6f6e 203d 2073 6361 6e70  nslation = scanp
+00004450: 6172 7365 722e 686f 7269 7a6f 6e74 616c  arser.horizontal
+00004460: 5f73 6869 6674 0a20 2020 2020 2020 2020  _shift.         
+00004470: 2020 2020 2020 207a 5f74 7261 6e73 6c61         z_transla
+00004480: 7469 6f6e 203d 2073 6361 6e70 6172 7365  tion = scanparse
+00004490: 722e 7665 7274 6963 616c 5f73 6869 6674  r.vertical_shift
+000044a0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000044b0: 2020 2320 4164 6420 616e 204e 5873 7562    # Add an NXsub
+000044c0: 656e 7472 7920 746f 2074 6865 204e 5863  entry to the NXc
+000044d0: 6f6c 6c65 6374 696f 6e20 666f 7220 6561  ollection for ea
+000044e0: 6368 2073 6361 6e0a 2020 2020 2020 2020  ch scan.        
+000044f0: 2020 2020 2020 2020 656e 7472 795f 6e61          entry_na
+00004500: 6d65 203d 2066 2773 6361 6e5f 7b73 6361  me = f'scan_{sca
+00004510: 6e5f 6e75 6d62 6572 7d27 0a20 2020 2020  n_number}'.     
+00004520: 2020 2020 2020 2020 2020 206e 7873 7562             nxsub
+00004530: 656e 7472 7920 3d20 4e58 7375 6265 6e74  entry = NXsubent
+00004540: 7279 2829 0a20 2020 2020 2020 2020 2020  ry().           
+00004550: 2020 2020 206e 7863 6f6c 6c65 6374 696f       nxcollectio
+00004560: 6e5b 656e 7472 795f 6e61 6d65 5d20 3d20  n[entry_name] = 
+00004570: 6e78 7375 6265 6e74 7279 0a20 2020 2020  nxsubentry.     
+00004580: 2020 2020 2020 2020 2020 206e 7873 7562             nxsub
+00004590: 656e 7472 792e 7374 6172 745f 7469 6d65  entry.start_time
+000045a0: 203d 2073 6361 6e70 6172 7365 722e 7370   = scanparser.sp
+000045b0: 6563 5f73 6361 6e2e 6461 7465 0a20 2020  ec_scan.date.   
+000045c0: 2020 2020 2020 2020 2020 2020 206e 7873               nxs
+000045d0: 7562 656e 7472 792e 7370 6563 5f63 6f6d  ubentry.spec_com
+000045e0: 6d61 6e64 203d 2073 6361 6e70 6172 7365  mand = scanparse
+000045f0: 722e 7370 6563 5f63 6f6d 6d61 6e64 0a20  r.spec_command. 
+00004600: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00004610: 2041 6464 2061 6e20 4e58 696e 7374 7275   Add an NXinstru
+00004620: 6d65 6e74 2074 6f20 7468 6520 7363 616e  ment to the scan
+00004630: 2773 204e 5873 7562 656e 7472 790a 2020  's NXsubentry.  
+00004640: 2020 2020 2020 2020 2020 2020 2020 6e78                nx
+00004650: 7375 6265 6e74 7279 2e69 6e73 7472 756d  subentry.instrum
+00004660: 656e 7420 3d20 4e58 696e 7374 7275 6d65  ent = NXinstrume
+00004670: 6e74 2829 0a20 2020 2020 2020 2020 2020  nt().           
+00004680: 2020 2020 2023 2041 6464 2061 6e20 4e58       # Add an NX
+00004690: 6465 7465 6374 6f72 2074 6f20 7468 6520  detector to the 
+000046a0: 4e58 696e 7374 7275 6d65 6e74 2074 6f20  NXinstrument to 
+000046b0: 7468 6520 7363 616e 2773 0a20 2020 2020  the scan's.     
+000046c0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+000046d0: 204e 5873 7562 656e 7472 790a 2020 2020   NXsubentry.    
+000046e0: 2020 2020 2020 2020 2020 2020 6e78 7375              nxsu
+000046f0: 6265 6e74 7279 2e69 6e73 7472 756d 656e  bentry.instrumen
+00004700: 742e 6465 7465 6374 6f72 203d 2064 6565  t.detector = dee
+00004710: 7063 6f70 7928 6e78 6465 7465 6374 6f72  pcopy(nxdetector
+00004720: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00004730: 2020 6e78 7375 6265 6e74 7279 2e69 6e73    nxsubentry.ins
+00004740: 7472 756d 656e 742e 6465 7465 6374 6f72  trument.detector
+00004750: 2e66 7261 6d65 5f73 7461 7274 5f6e 756d  .frame_start_num
+00004760: 6265 7220 3d20 5c0a 2020 2020 2020 2020  ber = \.        
+00004770: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+00004780: 655f 6f66 6673 6574 0a20 2020 2020 2020  e_offset.       
+00004790: 2020 2020 2020 2020 206e 7873 7562 656e           nxsuben
+000047a0: 7472 792e 696e 7374 7275 6d65 6e74 2e64  try.instrument.d
+000047b0: 6574 6563 746f 722e 696d 6167 655f 6b65  etector.image_ke
+000047c0: 7920 3d20 696d 6167 655f 6b65 790a 2020  y = image_key.  
+000047d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000047e0: 4164 6420 616e 204e 5873 616d 706c 6520  Add an NXsample 
+000047f0: 746f 2074 6865 2073 6361 6e27 7320 4e58  to the scan's NX
+00004800: 7375 6265 6e74 7279 0a20 2020 2020 2020  subentry.       
+00004810: 2020 2020 2020 2020 206e 7873 7562 656e           nxsuben
+00004820: 7472 792e 7361 6d70 6c65 203d 204e 5873  try.sample = NXs
+00004830: 616d 706c 6528 290a 2020 2020 2020 2020  ample().        
+00004840: 2020 2020 2020 2020 6e78 7375 6265 6e74          nxsubent
+00004850: 7279 2e73 616d 706c 652e 726f 7461 7469  ry.sample.rotati
+00004860: 6f6e 5f61 6e67 6c65 203d 2074 6865 7461  on_angle = theta
+00004870: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00004880: 2020 6e78 7375 6265 6e74 7279 2e73 616d    nxsubentry.sam
+00004890: 706c 652e 726f 7461 7469 6f6e 5f61 6e67  ple.rotation_ang
+000048a0: 6c65 2e75 6e69 7473 203d 2027 6465 6772  le.units = 'degr
+000048b0: 6565 7327 0a20 2020 2020 2020 2020 2020  ees'.           
+000048c0: 2020 2020 206e 7873 7562 656e 7472 792e       nxsubentry.
+000048d0: 7361 6d70 6c65 2e78 5f74 7261 6e73 6c61  sample.x_transla
+000048e0: 7469 6f6e 203d 2078 5f74 7261 6e73 6c61  tion = x_transla
+000048f0: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+00004900: 2020 2020 206e 7873 7562 656e 7472 792e       nxsubentry.
+00004910: 7361 6d70 6c65 2e78 5f74 7261 6e73 6c61  sample.x_transla
+00004920: 7469 6f6e 2e75 6e69 7473 203d 2027 6d6d  tion.units = 'mm
+00004930: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00004940: 2020 6e78 7375 6265 6e74 7279 2e73 616d    nxsubentry.sam
+00004950: 706c 652e 7a5f 7472 616e 736c 6174 696f  ple.z_translatio
+00004960: 6e20 3d20 7a5f 7472 616e 736c 6174 696f  n = z_translatio
+00004970: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+00004980: 2020 6e78 7375 6265 6e74 7279 2e73 616d    nxsubentry.sam
+00004990: 706c 652e 7a5f 7472 616e 736c 6174 696f  ple.z_translatio
+000049a0: 6e2e 756e 6974 7320 3d20 276d 6d27 0a0a  n.units = 'mm'..
+000049b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000049c0: 6966 2069 6e63 6c75 6465 5f72 6177 5f64  if include_raw_d
+000049d0: 6174 613a 0a20 2020 2020 2020 2020 2020  ata:.           
+000049e0: 2020 2020 2020 2020 206e 756d 5f69 6d61           num_ima
+000049f0: 6765 203d 206c 656e 2874 6865 7461 7329  ge = len(thetas)
+00004a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004a10: 2020 2020 2069 6d61 6765 5f6b 6579 7320       image_keys 
+00004a20: 2b3d 206e 756d 5f69 6d61 6765 2a5b 696d  += num_image*[im
+00004a30: 6167 655f 6b65 795d 0a20 2020 2020 2020  age_key].       
+00004a40: 2020 2020 2020 2020 2020 2020 2073 6571               seq
+00004a50: 7565 6e63 655f 6e75 6d62 6572 7320 2b3d  uence_numbers +=
+00004a60: 206c 6973 7428 7261 6e67 6528 6e75 6d5f   list(range(num_
+00004a70: 696d 6167 6529 290a 2020 2020 2020 2020  image)).        
+00004a80: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+00004a90: 655f 7374 6163 6b73 2e61 7070 656e 6428  e_stacks.append(
+00004aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004ab0: 2020 2020 2020 2020 2073 6361 6e70 6172           scanpar
+00004ac0: 7365 722e 6765 745f 6465 7465 6374 6f72  ser.get_detector
+00004ad0: 5f64 6174 6128 0a20 2020 2020 2020 2020  _data(.         
+00004ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004af0: 2020 2074 6f6f 6c5f 636f 6e66 6967 2e64     tool_config.d
+00004b00: 6574 6563 746f 722e 7072 6566 6978 2c0a  etector.prefix,.
 00004b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004b20: 2020 2020 2020 2020 2020 2020 696d 6167              imag
-00004b30: 655f 6f66 6673 6574 2b6e 756d 5f69 6d61  e_offset+num_ima
-00004b40: 6765 2929 290a 2020 2020 2020 2020 2020  ge))).          
-00004b50: 2020 2020 2020 2020 2020 726f 7461 7469            rotati
-00004b60: 6f6e 5f61 6e67 6c65 7320 2b3d 206c 6973  on_angles += lis
-00004b70: 7428 7468 6574 6173 290a 2020 2020 2020  t(thetas).      
-00004b80: 2020 2020 2020 2020 2020 2020 2020 785f                x_
-00004b90: 7472 616e 736c 6174 696f 6e73 202b 3d20  translations += 
-00004ba0: 6e75 6d5f 696d 6167 652a 5b78 5f74 7261  num_image*[x_tra
-00004bb0: 6e73 6c61 7469 6f6e 5d0a 2020 2020 2020  nslation].      
-00004bc0: 2020 2020 2020 2020 2020 2020 2020 7a5f                z_
-00004bd0: 7472 616e 736c 6174 696f 6e73 202b 3d20  translations += 
-00004be0: 6e75 6d5f 696d 6167 652a 5b7a 5f74 7261  num_image*[z_tra
-00004bf0: 6e73 6c61 7469 6f6e 5d0a 0a20 2020 2020  nslation]..     
-00004c00: 2020 2069 6620 696e 636c 7564 655f 7261     if include_ra
-00004c10: 775f 6461 7461 3a0a 2020 2020 2020 2020  w_data:.        
-00004c20: 2020 2020 2320 4164 6420 696d 6167 6520      # Add image 
-00004c30: 6461 7461 2074 6f20 4e58 6465 7465 6374  data to NXdetect
-00004c40: 6f72 0a20 2020 2020 2020 2020 2020 206e  or.            n
-00004c50: 7869 6e73 7472 756d 656e 742e 6465 7465  xinstrument.dete
-00004c60: 6374 6f72 2e69 6d61 6765 5f6b 6579 203d  ctor.image_key =
-00004c70: 2069 6d61 6765 5f6b 6579 730a 2020 2020   image_keys.    
-00004c80: 2020 2020 2020 2020 6e78 696e 7374 7275          nxinstru
-00004c90: 6d65 6e74 2e64 6574 6563 746f 722e 7365  ment.detector.se
-00004ca0: 7175 656e 6365 5f6e 756d 6265 7220 3d20  quence_number = 
-00004cb0: 7365 7175 656e 6365 5f6e 756d 6265 7273  sequence_numbers
-00004cc0: 0a20 2020 2020 2020 2020 2020 206e 7869  .            nxi
-00004cd0: 6e73 7472 756d 656e 742e 6465 7465 6374  nstrument.detect
-00004ce0: 6f72 2e64 6174 6120 3d20 6e70 2e63 6f6e  or.data = np.con
-00004cf0: 6361 7465 6e61 7465 2869 6d61 6765 5f73  catenate(image_s
-00004d00: 7461 636b 7329 0a0a 2020 2020 2020 2020  tacks)..        
-00004d10: 2020 2020 2320 4164 6420 696d 6167 6520      # Add image 
-00004d20: 6461 7461 2074 6f20 4e58 7361 6d70 6c65  data to NXsample
-00004d30: 0a20 2020 2020 2020 2020 2020 206e 7873  .            nxs
-00004d40: 616d 706c 652e 726f 7461 7469 6f6e 5f61  ample.rotation_a
-00004d50: 6e67 6c65 203d 2072 6f74 6174 696f 6e5f  ngle = rotation_
-00004d60: 616e 676c 6573 0a20 2020 2020 2020 2020  angles.         
-00004d70: 2020 206e 7873 616d 706c 652e 726f 7461     nxsample.rota
-00004d80: 7469 6f6e 5f61 6e67 6c65 2e61 7474 7273  tion_angle.attrs
-00004d90: 5b27 756e 6974 7327 5d20 3d20 2764 6567  ['units'] = 'deg
-00004da0: 7265 6573 270a 2020 2020 2020 2020 2020  rees'.          
-00004db0: 2020 6e78 7361 6d70 6c65 2e78 5f74 7261    nxsample.x_tra
-00004dc0: 6e73 6c61 7469 6f6e 203d 2078 5f74 7261  nslation = x_tra
-00004dd0: 6e73 6c61 7469 6f6e 730a 2020 2020 2020  nslations.      
-00004de0: 2020 2020 2020 6e78 7361 6d70 6c65 2e78        nxsample.x
-00004df0: 5f74 7261 6e73 6c61 7469 6f6e 2e61 7474  _translation.att
-00004e00: 7273 5b27 756e 6974 7327 5d20 3d20 276d  rs['units'] = 'm
-00004e10: 6d27 0a20 2020 2020 2020 2020 2020 206e  m'.            n
-00004e20: 7873 616d 706c 652e 7a5f 7472 616e 736c  xsample.z_transl
-00004e30: 6174 696f 6e20 3d20 7a5f 7472 616e 736c  ation = z_transl
-00004e40: 6174 696f 6e73 0a20 2020 2020 2020 2020  ations.         
-00004e50: 2020 206e 7873 616d 706c 652e 7a5f 7472     nxsample.z_tr
-00004e60: 616e 736c 6174 696f 6e2e 6174 7472 735b  anslation.attrs[
-00004e70: 2775 6e69 7473 275d 203d 2027 6d6d 270a  'units'] = 'mm'.
-00004e80: 0a20 2020 2020 2020 2020 2020 2023 2041  .            # A
-00004e90: 6464 2061 6e20 4e58 6461 7461 2074 6f20  dd an NXdata to 
-00004ea0: 4e58 656e 7472 790a 2020 2020 2020 2020  NXentry.        
-00004eb0: 2020 2020 6e78 6461 7461 203d 204e 5864      nxdata = NXd
-00004ec0: 6174 6128 290a 2020 2020 2020 2020 2020  ata().          
-00004ed0: 2020 6e78 656e 7472 792e 6461 7461 203d    nxentry.data =
-00004ee0: 206e 7864 6174 610a 2020 2020 2020 2020   nxdata.        
-00004ef0: 2020 2020 6e78 6461 7461 2e6d 616b 656c      nxdata.makel
-00004f00: 696e 6b28 6e78 656e 7472 792e 696e 7374  ink(nxentry.inst
-00004f10: 7275 6d65 6e74 2e64 6574 6563 746f 722e  rument.detector.
-00004f20: 6461 7461 2c20 6e61 6d65 3d27 6461 7461  data, name='data
-00004f30: 2729 0a20 2020 2020 2020 2020 2020 206e  ').            n
-00004f40: 7864 6174 612e 6d61 6b65 6c69 6e6b 286e  xdata.makelink(n
-00004f50: 7865 6e74 7279 2e69 6e73 7472 756d 656e  xentry.instrumen
-00004f60: 742e 6465 7465 6374 6f72 2e69 6d61 6765  t.detector.image
-00004f70: 5f6b 6579 290a 2020 2020 2020 2020 2020  _key).          
-00004f80: 2020 6e78 6461 7461 2e6d 616b 656c 696e    nxdata.makelin
-00004f90: 6b28 6e78 656e 7472 792e 7361 6d70 6c65  k(nxentry.sample
-00004fa0: 2e72 6f74 6174 696f 6e5f 616e 676c 6529  .rotation_angle)
-00004fb0: 0a20 2020 2020 2020 2020 2020 206e 7864  .            nxd
-00004fc0: 6174 612e 6d61 6b65 6c69 6e6b 286e 7865  ata.makelink(nxe
-00004fd0: 6e74 7279 2e73 616d 706c 652e 785f 7472  ntry.sample.x_tr
-00004fe0: 616e 736c 6174 696f 6e29 0a20 2020 2020  anslation).     
-00004ff0: 2020 2020 2020 206e 7864 6174 612e 6d61         nxdata.ma
-00005000: 6b65 6c69 6e6b 286e 7865 6e74 7279 2e73  kelink(nxentry.s
-00005010: 616d 706c 652e 7a5f 7472 616e 736c 6174  ample.z_translat
-00005020: 696f 6e29 0a23 2020 2020 2020 2020 2020  ion).#          
-00005030: 2020 6e78 6461 7461 2e61 7474 7273 5b27    nxdata.attrs['
-00005040: 6178 6573 275d 203d 205b 2766 6965 6c64  axes'] = ['field
-00005050: 272c 2027 726f 7727 2c20 2763 6f6c 756d  ', 'row', 'colum
-00005060: 6e27 5d0a 2320 2020 2020 2020 2020 2020  n'].#           
-00005070: 206e 7864 6174 612e 6174 7472 735b 2766   nxdata.attrs['f
-00005080: 6965 6c64 5f69 6e64 6963 6573 275d 203d  ield_indices'] =
-00005090: 2030 0a23 2020 2020 2020 2020 2020 2020   0.#            
-000050a0: 6e78 6461 7461 2e61 7474 7273 5b27 726f  nxdata.attrs['ro
-000050b0: 775f 696e 6469 6365 7327 5d20 3d20 310a  w_indices'] = 1.
-000050c0: 2320 2020 2020 2020 2020 2020 206e 7864  #            nxd
-000050d0: 6174 612e 6174 7472 735b 2763 6f6c 756d  ata.attrs['colum
-000050e0: 6e5f 696e 6469 6365 7327 5d20 3d20 320a  n_indices'] = 2.
-000050f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00005100: 6e78 726f 6f74 0a0a 0a64 6566 206e 7863  nxroot...def nxc
-00005110: 6f70 7928 6e78 6f62 6a65 6374 2c20 6578  opy(nxobject, ex
-00005120: 636c 7564 655f 6e78 7061 7468 733d 4e6f  clude_nxpaths=No
-00005130: 6e65 2c20 6e78 7061 7468 5f70 7265 6669  ne, nxpath_prefi
-00005140: 783d 2727 293a 0a20 2020 2022 2222 0a20  x=''):.    """. 
-00005150: 2020 2046 756e 6374 696f 6e20 7468 6174     Function that
-00005160: 2072 6574 7572 6e73 2061 2063 6f70 7920   returns a copy 
-00005170: 6f66 2061 206e 6578 7573 206f 626a 6563  of a nexus objec
-00005180: 742c 206f 7074 696f 6e61 6c6c 7920 6578  t, optionally ex
-00005190: 6c75 6469 6e67 0a20 2020 2063 6572 7461  luding.    certa
-000051a0: 696e 2063 6869 6c64 2069 7465 6d73 2e0a  in child items..
-000051b0: 0a20 2020 203a 7061 7261 6d20 6e78 6f62  .    :param nxob
-000051c0: 6a65 6374 3a20 7468 6520 6f72 6967 696e  ject: the origin
-000051d0: 616c 206e 6578 7573 206f 626a 6563 7420  al nexus object 
-000051e0: 746f 2072 6574 7572 6e20 6120 2263 6f70  to return a "cop
-000051f0: 7922 206f 660a 2020 2020 3a74 7970 6520  y" of.    :type 
-00005200: 6e78 6f62 6a65 6374 3a20 6e65 7875 7366  nxobject: nexusf
-00005210: 6f72 6d61 742e 6e65 7875 732e 4e58 6f62  ormat.nexus.NXob
-00005220: 6a65 6374 0a20 2020 203a 7061 7261 6d20  ject.    :param 
-00005230: 6578 6c75 6465 5f6e 7870 6174 6873 3a20  exlude_nxpaths: 
-00005240: 6120 6c69 7374 206f 6620 7061 7468 7320  a list of paths 
-00005250: 746f 2063 6869 6c64 206e 6578 7573 206f  to child nexus o
-00005260: 626a 6563 7473 2074 6861 740a 2020 2020  bjects that.    
-00005270: 2020 2020 7368 6f75 6c64 2062 6520 6578      should be ex
-00005280: 6c75 6465 6420 6672 6f6d 2074 6865 2072  luded from the r
-00005290: 6574 7572 6e65 6420 2263 6f70 7922 2c20  eturned "copy", 
-000052a0: 6465 6661 756c 7473 2074 6f20 605b 5d60  defaults to `[]`
-000052b0: 0a20 2020 203a 7479 7065 2065 7863 6c75  .    :type exclu
-000052c0: 6465 5f6e 7870 6174 6873 3a20 6c69 7374  de_nxpaths: list
-000052d0: 5b73 7472 5d2c 206f 7074 696f 6e61 6c0a  [str], optional.
-000052e0: 2020 2020 3a70 6172 616d 206e 7870 6174      :param nxpat
-000052f0: 685f 7072 6566 6978 3a20 466f 7220 7573  h_prefix: For us
-00005300: 6520 696e 2072 6563 7572 7369 7665 2063  e in recursive c
-00005310: 616c 6c73 2066 726f 6d20 696e 7369 6465  alls from inside
-00005320: 2074 6869 730a 2020 2020 2020 2020 6675   this.        fu
-00005330: 6e63 7469 6f6e 206f 6e6c 7921 0a20 2020  nction only!.   
-00005340: 203a 7479 7065 206e 7870 6174 685f 7072   :type nxpath_pr
-00005350: 6566 6978 3a20 7374 720a 2020 2020 3a72  efix: str.    :r
-00005360: 6574 7572 6e3a 2061 2063 6f70 7920 6f66  eturn: a copy of
-00005370: 2060 6e78 6f62 6a65 6374 6020 7769 7468   `nxobject` with
-00005380: 2073 6f6d 6520 6368 696c 6472 656e 206f   some children o
-00005390: 7074 696f 6e61 6c6c 7920 6578 6c75 6465  ptionally exlude
-000053a0: 642e 0a20 2020 203a 7274 7970 653a 204e  d..    :rtype: N
-000053b0: 586f 626a 6563 740a 2020 2020 2222 220a  Xobject.    """.
-000053c0: 2020 2020 2320 5468 6972 6420 7061 7274      # Third part
-000053d0: 7920 6d6f 6475 6c65 730a 2020 2020 6672  y modules.    fr
-000053e0: 6f6d 206e 6578 7573 666f 726d 6174 2e6e  om nexusformat.n
-000053f0: 6578 7573 2069 6d70 6f72 7420 4e58 6772  exus import NXgr
-00005400: 6f75 700a 0a20 2020 206e 786f 626a 6563  oup..    nxobjec
-00005410: 745f 636f 7079 203d 206e 786f 626a 6563  t_copy = nxobjec
-00005420: 742e 5f5f 636c 6173 735f 5f28 290a 2020  t.__class__().  
-00005430: 2020 6966 206e 6f74 206e 7870 6174 685f    if not nxpath_
-00005440: 7072 6566 6978 3a0a 2020 2020 2020 2020  prefix:.        
-00005450: 6966 2027 6465 6661 756c 7427 2069 6e20  if 'default' in 
-00005460: 6e78 6f62 6a65 6374 2e61 7474 7273 3a0a  nxobject.attrs:.
-00005470: 2020 2020 2020 2020 2020 2020 6e78 6f62              nxob
-00005480: 6a65 6374 5f63 6f70 792e 6174 7472 735b  ject_copy.attrs[
-00005490: 2764 6566 6175 6c74 275d 203d 206e 786f  'default'] = nxo
-000054a0: 626a 6563 742e 6174 7472 735b 2764 6566  bject.attrs['def
-000054b0: 6175 6c74 275d 0a20 2020 2065 6c73 653a  ault'].    else:
-000054c0: 0a20 2020 2020 2020 2066 6f72 206b 2c20  .        for k, 
-000054d0: 7620 696e 206e 786f 626a 6563 742e 6174  v in nxobject.at
-000054e0: 7472 732e 6974 656d 7328 293a 0a20 2020  trs.items():.   
-000054f0: 2020 2020 2020 2020 206e 786f 626a 6563           nxobjec
-00005500: 745f 636f 7079 2e61 7474 7273 5b6b 5d20  t_copy.attrs[k] 
-00005510: 3d20 760a 0a20 2020 2069 6620 6578 636c  = v..    if excl
-00005520: 7564 655f 6e78 7061 7468 7320 6973 204e  ude_nxpaths is N
-00005530: 6f6e 653a 0a20 2020 2020 2020 2065 7863  one:.        exc
-00005540: 6c75 6465 5f6e 7870 6174 6873 203d 205b  lude_nxpaths = [
-00005550: 5d0a 2020 2020 666f 7220 6b2c 2076 2069  ].    for k, v i
-00005560: 6e20 6e78 6f62 6a65 6374 2e69 7465 6d73  n nxobject.items
-00005570: 2829 3a0a 2020 2020 2020 2020 6e78 7061  ():.        nxpa
-00005580: 7468 203d 206f 735f 7061 7468 2e6a 6f69  th = os_path.joi
-00005590: 6e28 6e78 7061 7468 5f70 7265 6669 782c  n(nxpath_prefix,
-000055a0: 206b 290a 0a20 2020 2020 2020 2069 6620   k)..        if 
-000055b0: 6e78 7061 7468 2069 6e20 6578 636c 7564  nxpath in exclud
-000055c0: 655f 6e78 7061 7468 733a 0a20 2020 2020  e_nxpaths:.     
-000055d0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-000055e0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-000055f0: 7374 616e 6365 2876 2c20 4e58 6772 6f75  stance(v, NXgrou
-00005600: 7029 3a0a 2020 2020 2020 2020 2020 2020  p):.            
-00005610: 6e78 6f62 6a65 6374 5f63 6f70 795b 6b5d  nxobject_copy[k]
-00005620: 203d 206e 7863 6f70 7928 0a20 2020 2020   = nxcopy(.     
-00005630: 2020 2020 2020 2020 2020 2076 2c20 6578             v, ex
-00005640: 636c 7564 655f 6e78 7061 7468 733d 6578  clude_nxpaths=ex
-00005650: 636c 7564 655f 6e78 7061 7468 732c 0a20  clude_nxpaths,. 
-00005660: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00005670: 7870 6174 685f 7072 6566 6978 3d6f 735f  xpath_prefix=os_
-00005680: 7061 7468 2e6a 6f69 6e28 6e78 7061 7468  path.join(nxpath
-00005690: 5f70 7265 6669 782c 206b 2929 0a20 2020  _prefix, k)).   
-000056a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000056b0: 2020 2020 2020 206e 786f 626a 6563 745f         nxobject_
-000056c0: 636f 7079 5b6b 5d20 3d20 760a 0a20 2020  copy[k] = v..   
-000056d0: 2072 6574 7572 6e20 6e78 6f62 6a65 6374   return nxobject
-000056e0: 5f63 6f70 790a 0a0a 636c 6173 7320 5365  _copy...class Se
-000056f0: 744e 756d 6578 7072 5468 7265 6164 733a  tNumexprThreads:
-00005700: 0a20 2020 2022 2222 0a20 2020 2043 6c61  .    """.    Cla
-00005710: 7373 2074 6861 7420 7365 7473 2061 6e64  ss that sets and
-00005720: 206b 6565 7073 2074 7261 636b 206f 6620   keeps track of 
-00005730: 7468 6520 6e75 6d62 6572 206f 6620 7072  the number of pr
-00005740: 6f63 6573 736f 7273 2075 7365 6420 6279  ocessors used by
-00005750: 0a20 2020 2074 6865 2063 6f64 6520 696e  .    the code in
-00005760: 2067 656e 6572 616c 2061 6e64 2062 7920   general and by 
-00005770: 7468 6520 6e75 6d5f 6578 7072 2070 6163  the num_expr pac
-00005780: 6b61 6765 2073 7065 6369 6669 6361 6c6c  kage specificall
-00005790: 792e 0a0a 2020 2020 3a69 7661 7220 6e75  y...    :ivar nu
-000057a0: 6d5f 636f 7265 3a20 4e75 6d62 6572 206f  m_core: Number o
-000057b0: 6620 7072 6f63 6573 736f 7273 2075 7365  f processors use
-000057c0: 6420 6279 2074 6865 206e 756d 5f65 7870  d by the num_exp
-000057d0: 7220 7061 636b 6167 650a 2020 2020 3a74  r package.    :t
-000057e0: 7970 6520 6e75 6d5f 636f 7265 3a20 696e  ype num_core: in
-000057f0: 740a 2020 2020 2222 220a 0a20 2020 2064  t.    """..    d
-00005800: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-00005810: 2c20 6e75 6d5f 636f 7265 293a 0a20 2020  , num_core):.   
-00005820: 2020 2020 2022 2222 496e 6974 6961 6c69       """Initiali
-00005830: 7a65 2053 6574 4e75 6d65 7870 7254 6872  ze SetNumexprThr
-00005840: 6561 6473 2e22 2222 0a20 2020 2020 2020  eads.""".       
-00005850: 2023 2053 7973 7465 6d20 6d6f 6475 6c65   # System module
-00005860: 730a 2020 2020 2020 2020 6672 6f6d 206d  s.        from m
-00005870: 756c 7469 7072 6f63 6573 7369 6e67 2069  ultiprocessing i
-00005880: 6d70 6f72 7420 6370 755f 636f 756e 740a  mport cpu_count.
-00005890: 0a20 2020 2020 2020 2069 6620 6e75 6d5f  .        if num_
-000058a0: 636f 7265 2069 7320 4e6f 6e65 206f 7220  core is None or 
-000058b0: 6e75 6d5f 636f 7265 203c 2031 206f 7220  num_core < 1 or 
-000058c0: 6e75 6d5f 636f 7265 203e 2063 7075 5f63  num_core > cpu_c
-000058d0: 6f75 6e74 2829 3a0a 2020 2020 2020 2020  ount():.        
-000058e0: 2020 2020 7365 6c66 2e5f 6e75 6d5f 636f      self._num_co
-000058f0: 7265 203d 2063 7075 5f63 6f75 6e74 2829  re = cpu_count()
-00005900: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00005910: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00005920: 5f6e 756d 5f63 6f72 6520 3d20 6e75 6d5f  _num_core = num_
-00005930: 636f 7265 0a20 2020 2020 2020 2073 656c  core.        sel
-00005940: 662e 5f6e 756d 5f63 6f72 655f 6f72 6720  f._num_core_org 
-00005950: 3d20 7365 6c66 2e5f 6e75 6d5f 636f 7265  = self._num_core
-00005960: 0a0a 2020 2020 6465 6620 5f5f 656e 7465  ..    def __ente
-00005970: 725f 5f28 7365 6c66 293a 0a20 2020 2020  r__(self):.     
-00005980: 2020 2023 2054 6869 7264 2070 6172 7479     # Third party
-00005990: 206d 6f64 756c 6573 0a20 2020 2020 2020   modules.       
-000059a0: 2066 726f 6d20 6e75 6d65 7870 7220 696d   from numexpr im
-000059b0: 706f 7274 2028 0a20 2020 2020 2020 2020  port (.         
-000059c0: 2020 204d 4158 5f54 4852 4541 4453 2c0a     MAX_THREADS,.
-000059d0: 2020 2020 2020 2020 2020 2020 7365 745f              set_
-000059e0: 6e75 6d5f 7468 7265 6164 732c 0a20 2020  num_threads,.   
-000059f0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00005a00: 7365 6c66 2e5f 6e75 6d5f 636f 7265 5f6f  self._num_core_o
-00005a10: 7267 203d 2073 6574 5f6e 756d 5f74 6872  rg = set_num_thr
-00005a20: 6561 6473 280a 2020 2020 2020 2020 2020  eads(.          
-00005a30: 2020 6d69 6e28 7365 6c66 2e5f 6e75 6d5f    min(self._num_
-00005a40: 636f 7265 2c20 4d41 585f 5448 5245 4144  core, MAX_THREAD
-00005a50: 5329 290a 0a20 2020 2064 6566 205f 5f65  S))..    def __e
-00005a60: 7869 745f 5f28 7365 6c66 2c20 6578 635f  xit__(self, exc_
-00005a70: 7479 7065 2c20 6578 635f 7661 6c75 652c  type, exc_value,
-00005a80: 2074 7261 6365 6261 636b 293a 0a20 2020   traceback):.   
-00005a90: 2020 2020 2023 2054 6869 7264 2070 6172       # Third par
-00005aa0: 7479 206d 6f64 756c 6573 0a20 2020 2020  ty modules.     
-00005ab0: 2020 2066 726f 6d20 6e75 6d65 7870 7220     from numexpr 
-00005ac0: 696d 706f 7274 2073 6574 5f6e 756d 5f74  import set_num_t
-00005ad0: 6872 6561 6473 0a0a 2020 2020 2020 2020  hreads..        
-00005ae0: 7365 745f 6e75 6d5f 7468 7265 6164 7328  set_num_threads(
-00005af0: 7365 6c66 2e5f 6e75 6d5f 636f 7265 5f6f  self._num_core_o
-00005b00: 7267 290a 0a0a 636c 6173 7320 546f 6d6f  rg)...class Tomo
-00005b10: 3a0a 2020 2020 2222 2252 6563 6f6e 7374  :.    """Reconst
-00005b20: 7275 6374 2061 2073 6574 206f 6620 746f  ruct a set of to
-00005b30: 6d6f 6772 6170 6869 6320 696d 6167 6573  mographic images
-00005b40: 2e22 2222 0a0a 2020 2020 6465 6620 5f5f  ."""..    def __
-00005b50: 696e 6974 5f5f 280a 2020 2020 2020 2020  init__(.        
-00005b60: 2020 2020 7365 6c66 2c20 696e 7465 7261      self, intera
-00005b70: 6374 6976 653d 4661 6c73 652c 206e 756d  ctive=False, num
-00005b80: 5f63 6f72 653d 2d31 2c20 6f75 7470 7574  _core=-1, output
-00005b90: 5f66 6f6c 6465 723d 272e 272c 0a20 2020  _folder='.',.   
-00005ba0: 2020 2020 2020 2020 2073 6176 655f 6669           save_fi
-00005bb0: 6773 3d4e 6f6e 652c 2074 6573 745f 6d6f  gs=None, test_mo
-00005bc0: 6465 3d46 616c 7365 293a 0a20 2020 2020  de=False):.     
-00005bd0: 2020 2022 2222 496e 6974 6961 6c69 7a65     """Initialize
-00005be0: 2054 6f6d 6f2e 2222 220a 2020 2020 2020   Tomo.""".      
-00005bf0: 2020 2320 5379 7374 656d 206d 6f64 756c    # System modul
-00005c00: 6573 0a20 2020 2020 2020 2066 726f 6d20  es.        from 
-00005c10: 6c6f 6767 696e 6720 696d 706f 7274 2067  logging import g
-00005c20: 6574 4c6f 6767 6572 0a20 2020 2020 2020  etLogger.       
-00005c30: 2066 726f 6d20 6d75 6c74 6970 726f 6365   from multiproce
-00005c40: 7373 696e 6720 696d 706f 7274 2063 7075  ssing import cpu
-00005c50: 5f63 6f75 6e74 0a0a 2020 2020 2020 2020  _count..        
-00005c60: 7365 6c66 2e5f 5f6e 616d 655f 5f20 3d20  self.__name__ = 
-00005c70: 7365 6c66 2e5f 5f63 6c61 7373 5f5f 2e5f  self.__class__._
-00005c80: 5f6e 616d 655f 5f0a 2020 2020 2020 2020  _name__.        
-00005c90: 7365 6c66 2e5f 6c6f 6767 6572 203d 2067  self._logger = g
-00005ca0: 6574 4c6f 6767 6572 2873 656c 662e 5f5f  etLogger(self.__
-00005cb0: 6e61 6d65 5f5f 290a 2020 2020 2020 2020  name__).        
-00005cc0: 7365 6c66 2e5f 6c6f 6767 6572 2e70 726f  self._logger.pro
-00005cd0: 7061 6761 7465 203d 2046 616c 7365 0a0a  pagate = False..
-00005ce0: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-00005cf0: 7369 6e73 7461 6e63 6528 696e 7465 7261  sinstance(intera
-00005d00: 6374 6976 652c 2062 6f6f 6c29 3a0a 2020  ctive, bool):.  
-00005d10: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00005d20: 5661 6c75 6545 7272 6f72 2866 2749 6e76  ValueError(f'Inv
-00005d30: 616c 6964 2070 6172 616d 6574 6572 2069  alid parameter i
-00005d40: 6e74 6572 6163 7469 7665 2028 7b69 6e74  nteractive ({int
-00005d50: 6572 6163 7469 7665 7d29 2729 0a20 2020  eractive})').   
-00005d60: 2020 2020 2073 656c 662e 5f69 6e74 6572       self._inter
-00005d70: 6163 7469 7665 203d 2069 6e74 6572 6163  active = interac
-00005d80: 7469 7665 0a20 2020 2020 2020 2073 656c  tive.        sel
-00005d90: 662e 5f6e 756d 5f63 6f72 6520 3d20 6e75  f._num_core = nu
-00005da0: 6d5f 636f 7265 0a20 2020 2020 2020 2073  m_core.        s
-00005db0: 656c 662e 5f6f 7574 7075 745f 666f 6c64  elf._output_fold
-00005dc0: 6572 203d 206f 735f 7061 7468 2e61 6273  er = os_path.abs
-00005dd0: 7061 7468 286f 7574 7075 745f 666f 6c64  path(output_fold
-00005de0: 6572 290a 2020 2020 2020 2020 6966 206e  er).        if n
-00005df0: 6f74 206f 735f 7061 7468 2e69 7364 6972  ot os_path.isdir
-00005e00: 2873 656c 662e 5f6f 7574 7075 745f 666f  (self._output_fo
-00005e10: 6c64 6572 293a 0a20 2020 2020 2020 2020  lder):.         
-00005e20: 2020 206d 6b64 6972 2873 656c 662e 5f6f     mkdir(self._o
-00005e30: 7574 7075 745f 666f 6c64 6572 290a 2020  utput_folder).  
-00005e40: 2020 2020 2020 6966 2073 656c 662e 5f69        if self._i
-00005e50: 6e74 6572 6163 7469 7665 3a0a 2020 2020  nteractive:.    
-00005e60: 2020 2020 2020 2020 7365 6c66 2e5f 7465          self._te
-00005e70: 7374 5f6d 6f64 6520 3d20 4661 6c73 650a  st_mode = False.
-00005e80: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00005e90: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00005ea0: 2069 7369 6e73 7461 6e63 6528 7465 7374   isinstance(test
-00005eb0: 5f6d 6f64 652c 2062 6f6f 6c29 3a0a 2020  _mode, bool):.  
-00005ec0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00005ed0: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-00005ee0: 2749 6e76 616c 6964 2070 6172 616d 6574  'Invalid paramet
-00005ef0: 6572 2074 6573 745f 6d6f 6465 2028 7b74  er test_mode ({t
-00005f00: 6573 745f 6d6f 6465 7d29 2729 0a20 2020  est_mode})').   
-00005f10: 2020 2020 2020 2020 2073 656c 662e 5f74           self._t
-00005f20: 6573 745f 6d6f 6465 203d 2074 6573 745f  est_mode = test_
-00005f30: 6d6f 6465 0a20 2020 2020 2020 2020 2020  mode.           
-00005f40: 2069 6620 7361 7665 5f66 6967 7320 6973   if save_figs is
-00005f50: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00005f60: 2020 2020 2020 2073 6176 655f 6669 6773         save_figs
-00005f70: 203d 2027 6e6f 270a 2020 2020 2020 2020   = 'no'.        
-00005f80: 7365 6c66 2e5f 7465 7374 5f63 6f6e 6669  self._test_confi
-00005f90: 6720 3d20 7b7d 0a20 2020 2020 2020 2069  g = {}.        i
-00005fa0: 6620 7365 6c66 2e5f 7465 7374 5f6d 6f64  f self._test_mod
-00005fb0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-00005fc0: 6620 7361 7665 5f66 6967 7320 213d 2027  f save_figs != '
-00005fd0: 6f6e 6c79 273a 0a20 2020 2020 2020 2020  only':.         
-00005fe0: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-00005ff0: 6765 722e 7761 726e 696e 6728 2749 676e  ger.warning('Ign
-00006000: 6f72 696e 6720 7361 7665 5f66 6967 7320  oring save_figs 
-00006010: 696e 2074 6573 7420 6d6f 6465 2729 0a20  in test mode'). 
-00006020: 2020 2020 2020 2020 2020 2073 6176 655f             save_
-00006030: 6669 6773 203d 2027 6f6e 6c79 270a 2020  figs = 'only'.  
-00006040: 2020 2020 2020 6966 2073 6176 655f 6669        if save_fi
-00006050: 6773 203d 3d20 276f 6e6c 7927 3a0a 2020  gs == 'only':.  
-00006060: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00006070: 7361 7665 5f6f 6e6c 7920 3d20 5472 7565  save_only = True
-00006080: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00006090: 662e 5f73 6176 655f 6669 6773 203d 2054  f._save_figs = T
-000060a0: 7275 650a 2020 2020 2020 2020 656c 6966  rue.        elif
-000060b0: 2073 6176 655f 6669 6773 203d 3d20 2779   save_figs == 'y
-000060c0: 6573 273a 0a20 2020 2020 2020 2020 2020  es':.           
-000060d0: 2073 656c 662e 5f73 6176 655f 6f6e 6c79   self._save_only
-000060e0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-000060f0: 2020 2020 2073 656c 662e 5f73 6176 655f       self._save_
-00006100: 6669 6773 203d 2054 7275 650a 2020 2020  figs = True.    
-00006110: 2020 2020 656c 6966 2073 6176 655f 6669      elif save_fi
-00006120: 6773 203d 3d20 276e 6f27 3a0a 2020 2020  gs == 'no':.    
-00006130: 2020 2020 2020 2020 7365 6c66 2e5f 7361          self._sa
-00006140: 7665 5f6f 6e6c 7920 3d20 4661 6c73 650a  ve_only = False.
-00006150: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00006160: 2e5f 7361 7665 5f66 6967 7320 3d20 4661  ._save_figs = Fa
-00006170: 6c73 650a 2020 2020 2020 2020 656c 7365  lse.        else
-00006180: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00006190: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-000061a0: 2749 6e76 616c 6964 2070 6172 616d 6574  'Invalid paramet
-000061b0: 6572 2073 6176 655f 6669 6773 2028 7b73  er save_figs ({s
-000061c0: 6176 655f 6669 6773 7d29 2729 0a20 2020  ave_figs})').   
-000061d0: 2020 2020 2069 6620 7365 6c66 2e5f 7361       if self._sa
-000061e0: 7665 5f6f 6e6c 793a 0a20 2020 2020 2020  ve_only:.       
-000061f0: 2020 2020 2073 656c 662e 5f62 6c6f 636b       self._block
-00006200: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00006210: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00006220: 2020 2073 656c 662e 5f62 6c6f 636b 203d     self._block =
-00006230: 2054 7275 650a 2020 2020 2020 2020 6966   True.        if
-00006240: 2073 656c 662e 5f6e 756d 5f63 6f72 6520   self._num_core 
-00006250: 3d3d 202d 313a 0a20 2020 2020 2020 2020  == -1:.         
-00006260: 2020 2073 656c 662e 5f6e 756d 5f63 6f72     self._num_cor
-00006270: 6520 3d20 6370 755f 636f 756e 7428 290a  e = cpu_count().
-00006280: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-00006290: 7369 6e73 7461 6e63 6528 7365 6c66 2e5f  sinstance(self._
-000062a0: 6e75 6d5f 636f 7265 2c20 696e 7429 206f  num_core, int) o
-000062b0: 7220 7365 6c66 2e5f 6e75 6d5f 636f 7265  r self._num_core
-000062c0: 203c 2030 3a0a 2020 2020 2020 2020 2020   < 0:.          
-000062d0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-000062e0: 6f72 2866 2749 6e76 616c 6964 2070 6172  or(f'Invalid par
-000062f0: 616d 6574 6572 206e 756d 5f63 6f72 6520  ameter num_core 
-00006300: 287b 6e75 6d5f 636f 7265 7d29 2729 0a20  ({num_core})'). 
-00006310: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-00006320: 6e75 6d5f 636f 7265 203e 2063 7075 5f63  num_core > cpu_c
-00006330: 6f75 6e74 2829 3a0a 2020 2020 2020 2020  ount():.        
-00006340: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-00006350: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
-00006360: 2020 2020 2020 2020 2020 6627 6e75 6d5f            f'num_
-00006370: 636f 7265 203d 207b 7365 6c66 2e5f 6e75  core = {self._nu
-00006380: 6d5f 636f 7265 7d20 6973 206c 6172 6765  m_core} is large
-00006390: 7220 7468 616e 2074 6865 206e 756d 6265  r than the numbe
-000063a0: 7220 270a 2020 2020 2020 2020 2020 2020  r '.            
-000063b0: 2020 2020 2b20 6627 6f66 2061 7661 696c      + f'of avail
-000063c0: 6162 6c65 2070 726f 6365 7373 6f72 7320  able processors 
-000063d0: 616e 6420 7265 6475 6365 6420 746f 207b  and reduced to {
-000063e0: 6370 755f 636f 756e 7428 297d 2729 0a20  cpu_count()}'). 
-000063f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00006400: 5f6e 756d 5f63 6f72 6520 3d20 6370 755f  _num_core = cpu_
-00006410: 636f 756e 7428 290a 0a20 2020 2064 6566  count()..    def
-00006420: 2067 656e 5f72 6564 7563 6564 5f64 6174   gen_reduced_dat
-00006430: 6128 7365 6c66 2c20 6461 7461 2c20 696d  a(self, data, im
-00006440: 675f 785f 626f 756e 6473 3d4e 6f6e 652c  g_x_bounds=None,
-00006450: 2064 656c 7461 5f74 6865 7461 3d4e 6f6e   delta_theta=Non
-00006460: 6529 3a0a 2020 2020 2020 2020 2222 220a  e):.        """.
-00006470: 2020 2020 2020 2020 4765 6e65 7261 7465          Generate
-00006480: 2074 6865 2072 6564 7563 6564 2074 6f6d   the reduced tom
-00006490: 6f67 7261 7068 7920 696d 6167 6573 2e0a  ography images..
-000064a0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-000064b0: 6461 7461 3a20 4461 7461 206f 626a 6563  data: Data objec
-000064c0: 7420 636f 6e74 6169 6e69 6e67 2074 6865  t containing the
-000064d0: 2072 6177 2064 6174 6120 696e 666f 2061   raw data info a
-000064e0: 6e64 0a20 2020 2020 2020 2020 2020 206d  nd.            m
-000064f0: 6574 6164 6174 6120 7265 7175 6972 6564  etadata required
-00006500: 2066 6f72 2061 2074 6f6d 6f67 7261 7068   for a tomograph
-00006510: 7920 6461 7461 2072 6564 7563 7469 6f6e  y data reduction
-00006520: 0a20 2020 2020 2020 203a 7479 7065 2064  .        :type d
-00006530: 6174 613a 206e 6578 7573 666f 726d 6174  ata: nexusformat
-00006540: 2e6e 6578 7573 2e4e 5872 6f6f 740a 2020  .nexus.NXroot.  
-00006550: 2020 2020 2020 3a70 6172 616d 2069 6d67        :param img
-00006560: 5f78 5f62 6f75 6e64 733a 2044 6574 6563  _x_bounds: Detec
-00006570: 746f 7220 696d 6167 6520 626f 756e 6473  tor image bounds
-00006580: 2069 6e20 7468 6520 782d 6469 7265 6374   in the x-direct
-00006590: 696f 6e0a 2020 2020 2020 2020 3a74 7970  ion.        :typ
-000065a0: 6520 696d 675f 785f 626f 756e 6473 3a20  e img_x_bounds: 
-000065b0: 7475 706c 6528 696e 742c 2069 6e74 292c  tuple(int, int),
-000065c0: 206c 6973 745b 696e 745d 2c20 6f70 7469   list[int], opti
-000065d0: 6f6e 616c 0a20 2020 2020 2020 203a 7265  onal.        :re
-000065e0: 7475 726e 3a20 5265 6475 6365 6420 746f  turn: Reduced to
-000065f0: 6d6f 6772 6170 6879 2064 6174 610a 2020  mography data.  
-00006600: 2020 2020 2020 3a72 7479 7065 3a20 6e65        :rtype: ne
-00006610: 7875 7366 6f72 6d61 742e 6e65 7875 732e  xusformat.nexus.
-00006620: 4e58 726f 6f74 0a20 2020 2020 2020 2022  NXroot.        "
-00006630: 2222 0a20 2020 2020 2020 2023 2054 6869  "".        # Thi
-00006640: 7264 2070 6172 7479 206d 6f64 756c 6573  rd party modules
-00006650: 0a20 2020 2020 2020 2066 726f 6d20 6e65  .        from ne
-00006660: 7875 7366 6f72 6d61 742e 6e65 7875 7320  xusformat.nexus 
-00006670: 696d 706f 7274 2028 0a20 2020 2020 2020  import (.       
-00006680: 2020 2020 204e 5864 6174 612c 0a20 2020       NXdata,.   
-00006690: 2020 2020 2020 2020 204e 5870 726f 6365           NXproce
-000066a0: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
-000066b0: 4e58 726f 6f74 2c0a 2020 2020 2020 2020  NXroot,.        
-000066c0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-000066d0: 5f6c 6f67 6765 722e 696e 666f 2827 4765  _logger.info('Ge
-000066e0: 6e65 7261 7465 2074 6865 2072 6564 7563  nerate the reduc
-000066f0: 6564 2074 6f6d 6f67 7261 7068 7920 696d  ed tomography im
-00006700: 6167 6573 2729 0a20 2020 2020 2020 2069  ages').        i
-00006710: 6620 696d 675f 785f 626f 756e 6473 2069  f img_x_bounds i
-00006720: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00006730: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-00006740: 7369 6e73 7461 6e63 6528 696d 675f 785f  sinstance(img_x_
-00006750: 626f 756e 6473 2c20 2874 7570 6c65 2c20  bounds, (tuple, 
-00006760: 6c69 7374 2929 3a0a 2020 2020 2020 2020  list)):.        
-00006770: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00006780: 6c75 6545 7272 6f72 280a 2020 2020 2020  lueError(.      
-00006790: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-000067a0: 496e 7661 6c69 6420 7061 7261 6d65 7465  Invalid paramete
-000067b0: 7220 696d 675f 785f 626f 756e 6473 2028  r img_x_bounds (
-000067c0: 7b69 6d67 5f78 5f62 6f75 6e64 737d 2927  {img_x_bounds})'
-000067d0: 290a 2020 2020 2020 2020 2020 2020 696d  ).            im
-000067e0: 675f 785f 626f 756e 6473 203d 2074 7570  g_x_bounds = tup
-000067f0: 6c65 2869 6d67 5f78 5f62 6f75 6e64 7329  le(img_x_bounds)
-00006800: 0a0a 2020 2020 2020 2020 6966 2069 7369  ..        if isi
-00006810: 6e73 7461 6e63 6528 6461 7461 2c20 4e58  nstance(data, NX
-00006820: 726f 6f74 293a 0a20 2020 2020 2020 2020  root):.         
-00006830: 2020 206e 7865 6e74 7279 203d 2064 6174     nxentry = dat
-00006840: 615b 6461 7461 2e61 7474 7273 5b27 6465  a[data.attrs['de
-00006850: 6661 756c 7427 5d5d 0a20 2020 2020 2020  fault']].       
-00006860: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00006870: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00006880: 726f 7228 6627 496e 7661 6c69 6420 7061  ror(f'Invalid pa
-00006890: 7261 6d65 7465 7220 6461 7461 2028 7b64  rameter data ({d
-000068a0: 6174 617d 2927 290a 0a20 2020 2020 2020  ata})')..       
-000068b0: 2023 2043 7265 6174 6520 616e 204e 5870   # Create an NXp
-000068c0: 726f 6365 7373 2074 6f20 7374 6f72 6520  rocess to store 
-000068d0: 6461 7461 2072 6564 7563 7469 6f6e 2028  data reduction (
-000068e0: 6d65 7461 2964 6174 610a 2020 2020 2020  meta)data.      
-000068f0: 2020 7265 6475 6365 645f 6461 7461 203d    reduced_data =
-00006900: 204e 5870 726f 6365 7373 2829 0a0a 2020   NXprocess()..  
-00006910: 2020 2020 2020 2320 4765 6e65 7261 7465        # Generate
-00006920: 2064 6172 6b20 6669 656c 640a 2020 2020   dark field.    
-00006930: 2020 2020 6966 2027 6461 726b 5f66 6965      if 'dark_fie
-00006940: 6c64 2720 696e 206e 7865 6e74 7279 5b27  ld' in nxentry['
-00006950: 7370 6563 5f73 6361 6e73 275d 3a0a 2020  spec_scans']:.  
-00006960: 2020 2020 2020 2020 2020 7265 6475 6365            reduce
-00006970: 645f 6461 7461 203d 2073 656c 662e 5f67  d_data = self._g
-00006980: 656e 5f64 6172 6b28 6e78 656e 7472 792c  en_dark(nxentry,
-00006990: 2072 6564 7563 6564 5f64 6174 6129 0a0a   reduced_data)..
-000069a0: 2020 2020 2020 2020 2320 4765 6e65 7261          # Genera
-000069b0: 7465 2062 7269 6768 7420 6669 656c 640a  te bright field.
-000069c0: 2020 2020 2020 2020 7265 6475 6365 645f          reduced_
-000069d0: 6461 7461 203d 2073 656c 662e 5f67 656e  data = self._gen
-000069e0: 5f62 7269 6768 7428 6e78 656e 7472 792c  _bright(nxentry,
-000069f0: 2072 6564 7563 6564 5f64 6174 6129 0a0a   reduced_data)..
-00006a00: 2020 2020 2020 2020 2320 4765 7420 726f          # Get ro
-00006a10: 7461 7469 6f6e 2061 6e67 6c65 7320 666f  tation angles fo
-00006a20: 7220 696d 6167 6520 7374 6163 6b73 0a20  r image stacks. 
-00006a30: 2020 2020 2020 2074 6865 7461 7320 3d20         thetas = 
-00006a40: 7365 6c66 2e5f 6765 6e5f 7468 6574 6173  self._gen_thetas
-00006a50: 286e 7865 6e74 7279 290a 0a20 2020 2020  (nxentry)..     
-00006a60: 2020 2023 2047 6574 2074 6865 2069 6d61     # Get the ima
-00006a70: 6765 2073 7461 636b 206d 6173 6b20 746f  ge stack mask to
-00006a80: 2072 656d 6f76 6520 6261 6420 696d 6167   remove bad imag
-00006a90: 6573 2066 726f 6d20 7374 6163 6b0a 2020  es from stack.  
-00006aa0: 2020 2020 2020 696d 6167 655f 6d61 736b        image_mask
-00006ab0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00006ac0: 6472 6f70 5f66 7261 6374 696f 6e20 3d20  drop_fraction = 
-00006ad0: 3020 2320 6672 6163 7469 6f6e 206f 6620  0 # fraction of 
-00006ae0: 696d 6167 6573 2064 726f 7070 6564 2061  images dropped a
-00006af0: 7320 6120 7065 7263 656e 7461 6765 0a20  s a percentage. 
-00006b00: 2020 2020 2020 2069 6620 6472 6f70 5f66         if drop_f
-00006b10: 7261 6374 696f 6e3a 0a20 2020 2020 2020  raction:.       
-00006b20: 2020 2020 2069 6620 6465 6c74 615f 7468       if delta_th
-00006b30: 6574 6120 6973 206e 6f74 204e 6f6e 653a  eta is not None:
-00006b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006b50: 2064 656c 7461 5f74 6865 7461 203d 204e   delta_theta = N
-00006b60: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00006b70: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-00006b80: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
-00006b90: 2020 2020 2020 2020 2020 2020 2020 2749                'I
-00006ba0: 676e 6f72 6520 6465 6c74 615f 7468 6574  gnore delta_thet
-00006bb0: 6120 7768 656e 2061 6e20 696d 6167 6520  a when an image 
-00006bc0: 6d61 736b 2069 7320 7573 6564 2729 0a20  mask is used'). 
-00006bd0: 2020 2020 2020 2020 2020 206e 702e 7261             np.ra
-00006be0: 6e64 6f6d 2e73 6565 6428 3029 0a20 2020  ndom.seed(0).   
-00006bf0: 2020 2020 2020 2020 2069 6d61 6765 5f6d           image_m
-00006c00: 6173 6b20 3d20 6e70 2e77 6865 7265 286e  ask = np.where(n
-00006c10: 702e 7261 6e64 6f6d 2e72 616e 6428 0a20  p.random.rand(. 
-00006c20: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00006c30: 656e 2874 6865 7461 7329 2920 3c20 6472  en(thetas)) < dr
-00006c40: 6f70 5f66 7261 6374 696f 6e2f 3130 302c  op_fraction/100,
-00006c50: 2030 2c20 3129 2e61 7374 7970 6528 626f   0, 1).astype(bo
-00006c60: 6f6c 290a 0a20 2020 2020 2020 2023 2053  ol)..        # S
-00006c70: 6574 207a 6f6f 6d20 616e 642f 6f72 2072  et zoom and/or r
-00006c80: 6f74 6174 696f 6e20 616e 676c 6520 696e  otation angle in
-00006c90: 7465 7276 616c 2074 6f20 7265 6475 6365  terval to reduce
-00006ca0: 206d 656d 6f72 790a 2020 2020 2020 2020   memory.        
-00006cb0: 2320 2020 2020 7265 7175 6972 656d 656e  #     requiremen
-00006cc0: 740a 2020 2020 2020 2020 6966 2069 6d61  t.        if ima
-00006cd0: 6765 5f6d 6173 6b20 6973 204e 6f6e 653a  ge_mask is None:
-00006ce0: 0a20 2020 2020 2020 2020 2020 207a 6f6f  .            zoo
-00006cf0: 6d5f 7065 7263 2c20 6465 6c74 615f 7468  m_perc, delta_th
-00006d00: 6574 6120 3d20 7365 6c66 2e5f 7365 745f  eta = self._set_
-00006d10: 7a6f 6f6d 5f6f 725f 6465 6c74 615f 7468  zoom_or_delta_th
-00006d20: 6574 6128 0a20 2020 2020 2020 2020 2020  eta(.           
-00006d30: 2020 2020 2074 6865 7461 732c 2064 656c       thetas, del
-00006d40: 7461 5f74 6865 7461 290a 2020 2020 2020  ta_theta).      
-00006d50: 2020 2020 2020 6966 2064 656c 7461 5f74        if delta_t
-00006d60: 6865 7461 2069 7320 6e6f 7420 4e6f 6e65  heta is not None
-00006d70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006d80: 2020 696d 6167 655f 6d61 736b 203d 206e    image_mask = n
-00006d90: 702e 6173 6172 7261 7928 0a20 2020 2020  p.asarray(.     
-00006da0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00006db0: 3020 6966 2069 2564 656c 7461 5f74 6865  0 if i%delta_the
-00006dc0: 7461 2065 6c73 6520 310a 2020 2020 2020  ta else 1.      
-00006dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006de0: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-00006df0: 286c 656e 2874 6865 7461 7329 295d 2c20  (len(thetas))], 
-00006e00: 6474 7970 653d 626f 6f6c 290a 2020 2020  dtype=bool).    
-00006e10: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-00006e20: 6767 6572 2e64 6562 7567 2866 277a 6f6f  gger.debug(f'zoo
-00006e30: 6d5f 7065 7263 3a20 7b7a 6f6f 6d5f 7065  m_perc: {zoom_pe
-00006e40: 7263 7d27 290a 2020 2020 2020 2020 2020  rc}').          
-00006e50: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e64    self._logger.d
-00006e60: 6562 7567 2866 2764 656c 7461 5f74 6865  ebug(f'delta_the
-00006e70: 7461 3a20 7b64 656c 7461 5f74 6865 7461  ta: {delta_theta
-00006e80: 7d27 290a 2020 2020 2020 2020 2020 2020  }').            
-00006e90: 6966 207a 6f6f 6d5f 7065 7263 2069 7320  if zoom_perc is 
-00006ea0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00006eb0: 2020 2020 2020 2020 2020 7265 6475 6365            reduce
-00006ec0: 645f 6461 7461 2e61 7474 7273 5b27 7a6f  d_data.attrs['zo
-00006ed0: 6f6d 5f70 6572 6327 5d20 3d20 7a6f 6f6d  om_perc'] = zoom
-00006ee0: 5f70 6572 630a 2020 2020 2020 2020 6966  _perc.        if
-00006ef0: 2069 6d61 6765 5f6d 6173 6b20 6973 206e   image_mask is n
-00006f00: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00006f10: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
-00006f20: 722e 6465 6275 6728 6627 696d 6167 655f  r.debug(f'image_
-00006f30: 6d61 736b 203d 207b 696d 6167 655f 6d61  mask = {image_ma
-00006f40: 736b 7d27 290a 2020 2020 2020 2020 2020  sk}').          
-00006f50: 2020 7265 6475 6365 645f 6461 7461 5b27    reduced_data['
-00006f60: 696d 6167 655f 6d61 736b 275d 203d 2069  image_mask'] = i
-00006f70: 6d61 6765 5f6d 6173 6b0a 2020 2020 2020  mage_mask.      
-00006f80: 2020 2020 2020 7468 6574 6173 203d 2074        thetas = t
-00006f90: 6865 7461 735b 696d 6167 655f 6d61 736b  hetas[image_mask
-00006fa0: 5d0a 2020 2020 2020 2020 7365 6c66 2e5f  ].        self._
-00006fb0: 6c6f 6767 6572 2e64 6562 7567 2866 2774  logger.debug(f't
-00006fc0: 6865 7461 7320 3d20 7b74 6865 7461 737d  hetas = {thetas}
-00006fd0: 2729 0a20 2020 2020 2020 2072 6564 7563  ').        reduc
-00006fe0: 6564 5f64 6174 615b 2772 6f74 6174 696f  ed_data['rotatio
-00006ff0: 6e5f 616e 676c 6527 5d20 3d20 7468 6574  n_angle'] = thet
-00007000: 6173 0a0a 2020 2020 2020 2020 2320 5365  as..        # Se
-00007010: 7420 7665 7274 6963 616c 2064 6574 6563  t vertical detec
-00007020: 746f 7220 626f 756e 6473 2066 6f72 2069  tor bounds for i
-00007030: 6d61 6765 2073 7461 636b 0a20 2020 2020  mage stack.     
-00007040: 2020 2069 6d67 5f78 5f62 6f75 6e64 7320     img_x_bounds 
-00007050: 3d20 7365 6c66 2e5f 7365 745f 6465 7465  = self._set_dete
-00007060: 6374 6f72 5f62 6f75 6e64 7328 0a20 2020  ctor_bounds(.   
-00007070: 2020 2020 2020 2020 206e 7865 6e74 7279           nxentry
-00007080: 2c20 7265 6475 6365 645f 6461 7461 2c20  , reduced_data, 
-00007090: 7468 6574 6173 5b30 5d2c 2069 6d67 5f78  thetas[0], img_x
-000070a0: 5f62 6f75 6e64 733d 696d 675f 785f 626f  _bounds=img_x_bo
-000070b0: 756e 6473 290a 2020 2020 2020 2020 7365  unds).        se
-000070c0: 6c66 2e5f 6c6f 6767 6572 2e69 6e66 6f28  lf._logger.info(
-000070d0: 6627 696d 675f 785f 626f 756e 6473 203d  f'img_x_bounds =
-000070e0: 207b 696d 675f 785f 626f 756e 6473 7d27   {img_x_bounds}'
-000070f0: 290a 2020 2020 2020 2020 7265 6475 6365  ).        reduce
-00007100: 645f 6461 7461 5b27 696d 675f 785f 626f  d_data['img_x_bo
-00007110: 756e 6473 275d 203d 2069 6d67 5f78 5f62  unds'] = img_x_b
-00007120: 6f75 6e64 730a 0a20 2020 2020 2020 2023  ounds..        #
-00007130: 2047 656e 6572 6174 6520 7265 6475 6365   Generate reduce
-00007140: 6420 746f 6d6f 6772 6170 6879 2066 6965  d tomography fie
-00007150: 6c64 730a 2020 2020 2020 2020 7265 6475  lds.        redu
-00007160: 6365 645f 6461 7461 203d 2073 656c 662e  ced_data = self.
-00007170: 5f67 656e 5f74 6f6d 6f28 6e78 656e 7472  _gen_tomo(nxentr
-00007180: 792c 2072 6564 7563 6564 5f64 6174 6129  y, reduced_data)
-00007190: 0a0a 2020 2020 2020 2020 2320 4372 6561  ..        # Crea
-000071a0: 7465 2061 2063 6f70 7920 6f66 2074 6865  te a copy of the
-000071b0: 2069 6e70 7574 204e 6578 7573 206f 626a   input Nexus obj
-000071c0: 6563 7420 616e 6420 7265 6d6f 7665 2072  ect and remove r
-000071d0: 6177 2061 6e64 0a20 2020 2020 2020 2023  aw and.        #
-000071e0: 2020 2020 2061 6e79 2065 7869 7374 696e       any existin
-000071f0: 6720 7265 6475 6365 6420 6461 7461 0a20  g reduced data. 
-00007200: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-00007210: 616e 6365 2864 6174 612c 204e 5872 6f6f  ance(data, NXroo
-00007220: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00007230: 6578 636c 7564 655f 6974 656d 7320 3d20  exclude_items = 
-00007240: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00007250: 2020 6627 7b6e 7865 6e74 7279 2e6e 786e    f'{nxentry.nxn
-00007260: 616d 657d 2f72 6564 7563 6564 5f64 6174  ame}/reduced_dat
-00007270: 612f 6461 7461 272c 0a20 2020 2020 2020  a/data',.       
-00007280: 2020 2020 2020 2020 2066 277b 6e78 656e           f'{nxen
-00007290: 7472 792e 6e78 6e61 6d65 7d2f 696e 7374  try.nxname}/inst
-000072a0: 7275 6d65 6e74 2f64 6574 6563 746f 722f  rument/detector/
-000072b0: 6461 7461 272c 0a20 2020 2020 2020 2020  data',.         
-000072c0: 2020 2020 2020 2066 277b 6e78 656e 7472         f'{nxentr
-000072d0: 792e 6e78 6e61 6d65 7d2f 696e 7374 7275  y.nxname}/instru
-000072e0: 6d65 6e74 2f64 6574 6563 746f 722f 696d  ment/detector/im
-000072f0: 6167 655f 6b65 7927 2c0a 2020 2020 2020  age_key',.      
-00007300: 2020 2020 2020 2020 2020 6627 7b6e 7865            f'{nxe
-00007310: 6e74 7279 2e6e 786e 616d 657d 2f69 6e73  ntry.nxname}/ins
-00007320: 7472 756d 656e 742f 6465 7465 6374 6f72  trument/detector
-00007330: 2f73 6571 7565 6e63 655f 6e75 6d62 6572  /sequence_number
-00007340: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00007350: 2020 2066 277b 6e78 656e 7472 792e 6e78     f'{nxentry.nx
-00007360: 6e61 6d65 7d2f 7361 6d70 6c65 2f72 6f74  name}/sample/rot
-00007370: 6174 696f 6e5f 616e 676c 6527 2c0a 2020  ation_angle',.  
-00007380: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00007390: 7b6e 7865 6e74 7279 2e6e 786e 616d 657d  {nxentry.nxname}
-000073a0: 2f73 616d 706c 652f 785f 7472 616e 736c  /sample/x_transl
-000073b0: 6174 696f 6e27 2c0a 2020 2020 2020 2020  ation',.        
-000073c0: 2020 2020 2020 2020 6627 7b6e 7865 6e74          f'{nxent
-000073d0: 7279 2e6e 786e 616d 657d 2f73 616d 706c  ry.nxname}/sampl
-000073e0: 652f 7a5f 7472 616e 736c 6174 696f 6e27  e/z_translation'
-000073f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00007400: 2020 6627 7b6e 7865 6e74 7279 2e6e 786e    f'{nxentry.nxn
-00007410: 616d 657d 2f64 6174 612f 6461 7461 272c  ame}/data/data',
-00007420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007430: 2066 277b 6e78 656e 7472 792e 6e78 6e61   f'{nxentry.nxna
-00007440: 6d65 7d2f 6461 7461 2f69 6d61 6765 5f6b  me}/data/image_k
-00007450: 6579 272c 0a20 2020 2020 2020 2020 2020  ey',.           
-00007460: 2020 2020 2066 277b 6e78 656e 7472 792e       f'{nxentry.
-00007470: 6e78 6e61 6d65 7d2f 6461 7461 2f72 6f74  nxname}/data/rot
-00007480: 6174 696f 6e5f 616e 676c 6527 2c0a 2020  ation_angle',.  
-00007490: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-000074a0: 7b6e 7865 6e74 7279 2e6e 786e 616d 657d  {nxentry.nxname}
-000074b0: 2f64 6174 612f 785f 7472 616e 736c 6174  /data/x_translat
-000074c0: 696f 6e27 2c0a 2020 2020 2020 2020 2020  ion',.          
-000074d0: 2020 2020 2020 6627 7b6e 7865 6e74 7279        f'{nxentry
-000074e0: 2e6e 786e 616d 657d 2f64 6174 612f 7a5f  .nxname}/data/z_
-000074f0: 7472 616e 736c 6174 696f 6e27 2c0a 2020  translation',.  
-00007500: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
-00007510: 2020 2020 2020 2020 6e78 726f 6f74 203d          nxroot =
-00007520: 206e 7863 6f70 7928 6461 7461 2c20 6578   nxcopy(data, ex
-00007530: 636c 7564 655f 6e78 7061 7468 733d 6578  clude_nxpaths=ex
-00007540: 636c 7564 655f 6974 656d 7329 0a20 2020  clude_items).   
-00007550: 2020 2020 2020 2020 206e 7865 6e74 7279           nxentry
-00007560: 203d 206e 7872 6f6f 745b 6e78 726f 6f74   = nxroot[nxroot
-00007570: 2e61 7474 7273 5b27 6465 6661 756c 7427  .attrs['default'
-00007580: 5d5d 0a0a 2020 2020 2020 2020 2320 4164  ]]..        # Ad
-00007590: 6420 7468 6520 7265 6475 6365 6420 6461  d the reduced da
-000075a0: 7461 204e 5870 726f 6365 7373 0a20 2020  ta NXprocess.   
-000075b0: 2020 2020 206e 7865 6e74 7279 2e72 6564       nxentry.red
-000075c0: 7563 6564 5f64 6174 6120 3d20 7265 6475  uced_data = redu
-000075d0: 6365 645f 6461 7461 0a0a 2020 2020 2020  ced_data..      
-000075e0: 2020 6966 2027 6461 7461 2720 6e6f 7420    if 'data' not 
-000075f0: 696e 206e 7865 6e74 7279 3a0a 2020 2020  in nxentry:.    
-00007600: 2020 2020 2020 2020 6e78 656e 7472 792e          nxentry.
-00007610: 6461 7461 203d 204e 5864 6174 6128 290a  data = NXdata().
-00007620: 2020 2020 2020 2020 6e78 656e 7472 792e          nxentry.
-00007630: 6174 7472 735b 2764 6566 6175 6c74 275d  attrs['default']
-00007640: 203d 2027 6461 7461 270a 2020 2020 2020   = 'data'.      
-00007650: 2020 6e78 656e 7472 792e 6461 7461 2e6d    nxentry.data.m
-00007660: 616b 656c 696e 6b28 0a20 2020 2020 2020  akelink(.       
-00007670: 2020 2020 206e 7865 6e74 7279 2e72 6564       nxentry.red
-00007680: 7563 6564 5f64 6174 612e 6461 7461 2e74  uced_data.data.t
-00007690: 6f6d 6f5f 6669 656c 6473 2c20 6e61 6d65  omo_fields, name
-000076a0: 3d27 7265 6475 6365 645f 6461 7461 2729  ='reduced_data')
-000076b0: 0a20 2020 2020 2020 206e 7865 6e74 7279  .        nxentry
-000076c0: 2e64 6174 612e 6d61 6b65 6c69 6e6b 280a  .data.makelink(.
-000076d0: 2020 2020 2020 2020 2020 2020 6e78 656e              nxen
-000076e0: 7472 792e 7265 6475 6365 645f 6461 7461  try.reduced_data
-000076f0: 2e72 6f74 6174 696f 6e5f 616e 676c 652c  .rotation_angle,
-00007700: 206e 616d 653d 2772 6f74 6174 696f 6e5f   name='rotation_
-00007710: 616e 676c 6527 290a 2020 2020 2020 2020  angle').        
-00007720: 6e78 656e 7472 792e 6461 7461 2e61 7474  nxentry.data.att
-00007730: 7273 5b27 7369 676e 616c 275d 203d 2027  rs['signal'] = '
-00007740: 7265 6475 6365 645f 6461 7461 270a 0a20  reduced_data'.. 
-00007750: 2020 2020 2020 2072 6574 7572 6e20 6e78         return nx
-00007760: 726f 6f74 0a0a 2020 2020 6465 6620 6669  root..    def fi
-00007770: 6e64 5f63 656e 7465 7273 2873 656c 662c  nd_centers(self,
-00007780: 206e 7872 6f6f 742c 2063 656e 7465 725f   nxroot, center_
-00007790: 726f 7773 3d4e 6f6e 652c 2063 656e 7465  rows=None, cente
-000077a0: 725f 7374 6163 6b5f 696e 6465 783d 4e6f  r_stack_index=No
-000077b0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-000077c0: 6761 7573 7369 616e 5f73 6967 6d61 3d4e  gaussian_sigma=N
-000077d0: 6f6e 652c 2072 696e 675f 7769 6474 683d  one, ring_width=
-000077e0: 4e6f 6e65 293a 0a20 2020 2020 2020 2022  None):.        "
-000077f0: 2222 0a20 2020 2020 2020 2046 696e 6420  "".        Find 
-00007800: 7468 6520 6361 6c69 6272 6174 6564 2063  the calibrated c
-00007810: 656e 7465 7220 6178 6973 2069 6e66 6f0a  enter axis info.
-00007820: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00007830: 6e78 726f 6f74 3a20 4461 7461 206f 626a  nxroot: Data obj
-00007840: 6563 7420 636f 6e74 6169 6e69 6e67 2074  ect containing t
-00007850: 6865 2072 6564 7563 6564 2064 6174 6120  he reduced data 
-00007860: 616e 640a 2020 2020 2020 2020 2020 2020  and.            
-00007870: 6d65 7461 6461 7461 2072 6571 7569 7265  metadata require
-00007880: 6420 746f 2066 696e 6420 7468 6520 6361  d to find the ca
-00007890: 6c69 6272 6174 6564 2063 656e 7465 7220  librated center 
-000078a0: 6178 6973 2069 6e66 6f0a 2020 2020 2020  axis info.      
-000078b0: 2020 3a74 7970 6520 6461 7461 3a20 6e65    :type data: ne
-000078c0: 7875 7366 6f72 6d61 742e 6e65 7875 732e  xusformat.nexus.
-000078d0: 4e58 726f 6f74 0a20 2020 2020 2020 203a  NXroot.        :
-000078e0: 7061 7261 6d20 6365 6e74 6572 5f72 6f77  param center_row
-000078f0: 733a 204c 6f77 6572 2061 6e64 2075 7070  s: Lower and upp
-00007900: 6572 2072 6f77 2069 6e64 6963 6573 2066  er row indices f
-00007910: 6f72 2063 656e 7465 720a 2020 2020 2020  or center.      
-00007920: 2020 2020 2020 6669 6e64 696e 670a 2020        finding.  
-00007930: 2020 2020 2020 3a74 7970 6520 6365 6e74        :type cent
-00007940: 6572 5f72 6f77 733a 2074 7570 6c65 2869  er_rows: tuple(i
-00007950: 6e74 2c20 696e 7429 2c20 6c69 7374 5b69  nt, int), list[i
-00007960: 6e74 5d2c 206f 7074 696f 6e61 6c0a 2020  nt], optional.  
-00007970: 2020 2020 2020 3a72 6574 7572 6e3a 2043        :return: C
-00007980: 616c 6962 7261 7465 6420 6365 6e74 6572  alibrated center
-00007990: 2061 7869 7320 696e 666f 0a20 2020 2020   axis info.     
-000079a0: 2020 203a 7274 7970 653a 2064 6963 740a     :rtype: dict.
-000079b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000079c0: 2020 2020 2320 5468 6972 6420 7061 7274      # Third part
-000079d0: 7920 6d6f 6475 6c65 730a 2020 2020 2020  y modules.      
-000079e0: 2020 6672 6f6d 206e 6578 7573 666f 726d    from nexusform
-000079f0: 6174 2e6e 6578 7573 2069 6d70 6f72 7420  at.nexus import 
-00007a00: 280a 2020 2020 2020 2020 2020 2020 4e58  (.            NX
-00007a10: 656e 7472 792c 0a20 2020 2020 2020 2020  entry,.         
-00007a20: 2020 204e 5872 6f6f 742c 0a20 2020 2020     NXroot,.     
-00007a30: 2020 2029 0a20 2020 2020 2020 2066 726f     ).        fro
-00007a40: 6d20 7961 6d6c 2069 6d70 6f72 7420 7361  m yaml import sa
-00007a50: 6665 5f64 756d 700a 0a20 2020 2020 2020  fe_dump..       
-00007a60: 2073 656c 662e 5f6c 6f67 6765 722e 696e   self._logger.in
-00007a70: 666f 2827 4669 6e64 2074 6865 2063 616c  fo('Find the cal
-00007a80: 6962 7261 7465 6420 6365 6e74 6572 2061  ibrated center a
-00007a90: 7869 7320 696e 666f 2729 0a0a 2020 2020  xis info')..    
-00007aa0: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
-00007ab0: 7461 6e63 6528 6e78 726f 6f74 2c20 4e58  tance(nxroot, NX
-00007ac0: 726f 6f74 293a 0a20 2020 2020 2020 2020  root):.         
-00007ad0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00007ae0: 726f 7228 6627 496e 7661 6c69 6420 7061  ror(f'Invalid pa
-00007af0: 7261 6d65 7465 7220 6e78 726f 6f74 2028  rameter nxroot (
-00007b00: 7b6e 7872 6f6f 747d 2927 290a 2020 2020  {nxroot})').    
-00007b10: 2020 2020 6e78 656e 7472 7920 3d20 6e78      nxentry = nx
-00007b20: 726f 6f74 5b6e 7872 6f6f 742e 6174 7472  root[nxroot.attr
-00007b30: 735b 2764 6566 6175 6c74 275d 5d0a 2020  s['default']].  
-00007b40: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
-00007b50: 6e73 7461 6e63 6528 6e78 656e 7472 792c  nstance(nxentry,
-00007b60: 204e 5865 6e74 7279 293a 0a20 2020 2020   NXentry):.     
-00007b70: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00007b80: 7565 4572 726f 7228 6627 496e 7661 6c69  ueError(f'Invali
-00007b90: 6420 6e78 656e 7472 7920 287b 6e78 656e  d nxentry ({nxen
-00007ba0: 7472 797d 2927 290a 2020 2020 2020 2020  try})').        
-00007bb0: 6966 2028 6365 6e74 6572 5f72 6f77 7320  if (center_rows 
-00007bc0: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
-00007bd0: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-00007be0: 286e 6f74 2069 7369 6e73 7461 6e63 6528  (not isinstance(
-00007bf0: 6365 6e74 6572 5f72 6f77 732c 2028 7475  center_rows, (tu
-00007c00: 706c 652c 206c 6973 7429 290a 2020 2020  ple, list)).    
-00007c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007c20: 206f 7220 6c65 6e28 6365 6e74 6572 5f72   or len(center_r
-00007c30: 6f77 7329 2021 3d20 3229 293a 0a20 2020  ows) != 2)):.   
-00007c40: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00007c50: 616c 7565 4572 726f 7228 6627 496e 7661  alueError(f'Inva
-00007c60: 6c69 6420 7061 7261 6d65 7465 7220 6365  lid parameter ce
-00007c70: 6e74 6572 5f72 6f77 7320 287b 6365 6e74  nter_rows ({cent
-00007c80: 6572 5f72 6f77 737d 2927 290a 2020 2020  er_rows})').    
-00007c90: 2020 2020 6966 2028 6e6f 7420 7365 6c66      if (not self
-00007ca0: 2e5f 696e 7465 7261 6374 6976 650a 2020  ._interactive.  
-00007cb0: 2020 2020 2020 2020 2020 2020 2020 616e                an
-00007cc0: 6420 2863 656e 7465 725f 726f 7773 2069  d (center_rows i
-00007cd0: 7320 4e6f 6e65 0a20 2020 2020 2020 2020  s None.         
-00007ce0: 2020 2020 2020 2020 2020 2020 6f72 2028              or (
-00007cf0: 6365 6e74 6572 5f72 6f77 735b 305d 2069  center_rows[0] i
-00007d00: 7320 4e6f 6e65 2061 6e64 2063 656e 7465  s None and cente
-00007d10: 725f 726f 7773 5b31 5d20 6973 204e 6f6e  r_rows[1] is Non
-00007d20: 6529 2929 3a0a 2020 2020 2020 2020 2020  e))):.          
-00007d30: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e77    self._logger.w
-00007d40: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
-00007d50: 2020 2020 2020 2020 2763 656e 7465 725f          'center_
-00007d60: 726f 7773 2075 6e73 7065 6369 6669 6564  rows unspecified
-00007d70: 2c20 6669 6e64 2063 656e 7465 7273 2061  , find centers a
-00007d80: 7420 7265 6475 6365 6420 6461 7461 2062  t reduced data b
-00007d90: 6f75 6e64 7327 290a 2020 2020 2020 2020  ounds').        
-00007da0: 6966 2028 6365 6e74 6572 5f73 7461 636b  if (center_stack
-00007db0: 5f69 6e64 6578 2069 7320 6e6f 7420 4e6f  _index is not No
-00007dc0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
-00007dd0: 2020 2061 6e64 2028 6e6f 7420 6973 696e     and (not isin
-00007de0: 7374 616e 6365 2863 656e 7465 725f 7374  stance(center_st
-00007df0: 6163 6b5f 696e 6465 782c 2069 6e74 290a  ack_index, int).
-00007e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e10: 2020 2020 206f 7220 6365 6e74 6572 5f73       or center_s
-00007e20: 7461 636b 5f69 6e64 6578 203c 2030 2929  tack_index < 0))
-00007e30: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00007e40: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
-00007e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e60: 2749 6e76 616c 6964 2070 6172 616d 6574  'Invalid paramet
-00007e70: 6572 2063 656e 7465 725f 7374 6163 6b5f  er center_stack_
-00007e80: 696e 6465 7820 270a 2020 2020 2020 2020  index '.        
-00007e90: 2020 2020 2020 2020 2b20 6627 287b 6365          + f'({ce
-00007ea0: 6e74 6572 5f73 7461 636b 5f69 6e64 6578  nter_stack_index
-00007eb0: 7d29 2729 0a0a 2020 2020 2020 2020 2320  })')..        # 
-00007ec0: 4368 6563 6b20 6966 2072 6564 7563 6564  Check if reduced
-00007ed0: 2064 6174 6120 6973 2061 7661 696c 6162   data is availab
-00007ee0: 6c65 0a20 2020 2020 2020 2069 6620 2827  le.        if ('
-00007ef0: 7265 6475 6365 645f 6461 7461 2720 6e6f  reduced_data' no
-00007f00: 7420 696e 206e 7865 6e74 7279 0a20 2020  t in nxentry.   
-00007f10: 2020 2020 2020 2020 2020 2020 206f 7220               or 
-00007f20: 2772 6564 7563 6564 5f64 6174 6127 206e  'reduced_data' n
-00007f30: 6f74 2069 6e20 6e78 656e 7472 792e 6461  ot in nxentry.da
-00007f40: 7461 293a 0a20 2020 2020 2020 2020 2020  ta):.           
-00007f50: 2072 6169 7365 204b 6579 4572 726f 7228   raise KeyError(
-00007f60: 6627 556e 6162 6c65 2074 6f20 6669 6e64  f'Unable to find
-00007f70: 2076 616c 6964 2072 6564 7563 6564 2064   valid reduced d
-00007f80: 6174 6120 696e 207b 6e78 656e 7472 797d  ata in {nxentry}
-00007f90: 2e27 290a 0a20 2020 2020 2020 2023 2053  .')..        # S
-00007fa0: 656c 6563 7420 7468 6520 696d 6167 6520  elect the image 
-00007fb0: 7374 6163 6b20 746f 2063 616c 6962 7261  stack to calibra
-00007fc0: 7465 2074 6865 2063 656e 7465 7220 6178  te the center ax
-00007fd0: 6973 0a20 2020 2020 2020 2023 2020 2020  is.        #    
-00007fe0: 2072 6564 7563 6564 2064 6174 6120 6178   reduced data ax
-00007ff0: 6573 206f 7264 6572 3a20 7374 6163 6b2c  es order: stack,
-00008000: 7468 6574 612c 726f 772c 636f 6c75 6d6e  theta,row,column
-00008010: 0a20 2020 2020 2020 2023 204e 6f74 653a  .        # Note:
-00008020: 204e 6578 7573 2063 616e 2774 2066 6f6c   Nexus can't fol
-00008030: 6c6f 7720 6120 6c69 6e6b 2069 6620 7468  low a link if th
-00008040: 6520 6461 7461 2069 7420 706f 696e 7473  e data it points
-00008050: 2074 6f20 6973 0a20 2020 2020 2020 2023   to is.        #
-00008060: 2020 2020 2074 6f6f 2062 6967 2067 6574       too big get
-00008070: 2074 6865 2064 6174 6120 6672 6f6d 2074   the data from t
-00008080: 6865 2061 6374 7561 6c20 706c 6163 652c  he actual place,
-00008090: 206e 6f74 2066 726f 6d0a 2020 2020 2020   not from.      
-000080a0: 2020 2320 2020 2020 6e78 656e 7472 792e    #     nxentry.
-000080b0: 6461 7461 0a20 2020 2020 2020 2074 6f6d  data.        tom
-000080c0: 6f5f 6669 656c 6473 5f73 6861 7065 203d  o_fields_shape =
-000080d0: 206e 7865 6e74 7279 2e72 6564 7563 6564   nxentry.reduced
-000080e0: 5f64 6174 612e 6461 7461 2e74 6f6d 6f5f  _data.data.tomo_
-000080f0: 6669 656c 6473 2e73 6861 7065 0a20 2020  fields.shape.   
-00008100: 2020 2020 2069 6620 286c 656e 2874 6f6d       if (len(tom
-00008110: 6f5f 6669 656c 6473 5f73 6861 7065 2920  o_fields_shape) 
-00008120: 213d 2034 0a20 2020 2020 2020 2020 2020  != 4.           
-00008130: 2020 2020 206f 7220 616e 7928 5472 7565       or any(True
-00008140: 2066 6f72 2064 696d 2069 6e20 746f 6d6f   for dim in tomo
-00008150: 5f66 6965 6c64 735f 7368 6170 6520 6966  _fields_shape if
-00008160: 206e 6f74 2064 696d 2929 3a0a 2020 2020   not dim)):.    
-00008170: 2020 2020 2020 2020 7261 6973 6520 4b65          raise Ke
-00008180: 7945 7272 6f72 280a 2020 2020 2020 2020  yError(.        
-00008190: 2020 2020 2020 2020 2755 6e61 626c 6520          'Unable 
-000081a0: 746f 206c 6f61 6420 7468 6520 7265 7175  to load the requ
-000081b0: 6972 6564 2072 6564 7563 6564 2074 6f6d  ired reduced tom
-000081c0: 6f67 7261 7068 7920 7374 6163 6b27 290a  ography stack').
-000081d0: 2020 2020 2020 2020 6e75 6d5f 746f 6d6f          num_tomo
-000081e0: 5f73 7461 636b 7320 3d20 746f 6d6f 5f66  _stacks = tomo_f
-000081f0: 6965 6c64 735f 7368 6170 655b 305d 0a20  ields_shape[0]. 
-00008200: 2020 2020 2020 2069 6620 6e75 6d5f 746f         if num_to
-00008210: 6d6f 5f73 7461 636b 7320 3d3d 2031 3a0a  mo_stacks == 1:.
-00008220: 2020 2020 2020 2020 2020 2020 6365 6e74              cent
-00008230: 6572 5f73 7461 636b 5f69 6e64 6578 203d  er_stack_index =
-00008240: 2030 0a20 2020 2020 2020 2020 2020 2064   0.            d
-00008250: 6566 6175 6c74 203d 2027 6e27 0a20 2020  efault = 'n'.   
-00008260: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00008270: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-00008280: 7465 7374 5f6d 6f64 653a 0a20 2020 2020  test_mode:.     
-00008290: 2020 2020 2020 2020 2020 2023 2043 6f6e             # Con
-000082a0: 7665 7274 2069 6e70 7574 2076 616c 7565  vert input value
-000082b0: 2074 6f20 6f66 6673 6574 2030 0a20 2020   to offset 0.   
-000082c0: 2020 2020 2020 2020 2020 2020 2063 656e               cen
-000082d0: 7465 725f 7374 6163 6b5f 696e 6465 7820  ter_stack_index 
-000082e0: 3d20 7365 6c66 2e5f 7465 7374 5f63 6f6e  = self._test_con
-000082f0: 6669 675b 2763 656e 7465 725f 7374 6163  fig['center_stac
-00008300: 6b5f 696e 6465 7827 5d0a 2020 2020 2020  k_index'].      
-00008310: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
-00008320: 5f69 6e74 6572 6163 7469 7665 3a0a 2020  _interactive:.  
-00008330: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00008340: 2063 656e 7465 725f 7374 6163 6b5f 696e   center_stack_in
-00008350: 6465 7820 6973 204e 6f6e 653a 0a20 2020  dex is None:.   
-00008360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008370: 2063 656e 7465 725f 7374 6163 6b5f 696e   center_stack_in
-00008380: 6465 7820 3d20 696e 7075 745f 696e 7428  dex = input_int(
-00008390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000083a0: 2020 2020 2020 2020 2027 5c6e 456e 7465           '\nEnte
-000083b0: 7220 746f 6d6f 6772 6170 6879 2073 7461  r tomography sta
-000083c0: 636b 2069 6e64 6578 2074 6f20 6361 6c69  ck index to cali
-000083d0: 6272 6174 6520 7468 6520 270a 2020 2020  brate the '.    
-000083e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000083f0: 2020 2020 2b20 2763 656e 7465 7220 6178      + 'center ax
-00008400: 6973 272c 2067 653d 302c 206c 743d 6e75  is', ge=0, lt=nu
-00008410: 6d5f 746f 6d6f 5f73 7461 636b 732c 0a20  m_tomo_stacks,. 
-00008420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008430: 2020 2020 2020 2064 6566 6175 6c74 3d69         default=i
-00008440: 6e74 286e 756d 5f74 6f6d 6f5f 7374 6163  nt(num_tomo_stac
-00008450: 6b73 2f32 2929 0a20 2020 2020 2020 2020  ks/2)).         
-00008460: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00008470: 2020 2020 2020 2020 2069 6620 6365 6e74           if cent
-00008480: 6572 5f73 7461 636b 5f69 6e64 6578 2069  er_stack_index i
-00008490: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-000084a0: 2020 2020 2020 2020 2020 2020 6365 6e74              cent
-000084b0: 6572 5f73 7461 636b 5f69 6e64 6578 203d  er_stack_index =
-000084c0: 2069 6e74 286e 756d 5f74 6f6d 6f5f 7374   int(num_tomo_st
-000084d0: 6163 6b73 2f32 290a 2020 2020 2020 2020  acks/2).        
-000084e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000084f0: 2e5f 6c6f 6767 6572 2e77 6172 6e69 6e67  ._logger.warning
-00008500: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00008510: 2020 2020 2020 2020 2020 2763 656e 7465            'cente
-00008520: 725f 7374 6163 6b5f 696e 6465 7820 756e  r_stack_index un
-00008530: 7370 6563 6966 6965 642c 2075 7365 2073  specified, use s
-00008540: 7461 636b 2027 0a20 2020 2020 2020 2020  tack '.         
-00008550: 2020 2020 2020 2020 2020 2020 2020 202b                 +
-00008560: 2066 277b 6365 6e74 6572 5f73 7461 636b   f'{center_stack
-00008570: 5f69 6e64 6578 7d20 746f 2066 696e 6420  _index} to find 
-00008580: 6365 6e74 6572 7327 290a 2020 2020 2020  centers').      
-00008590: 2020 2020 2020 6465 6661 756c 7420 3d20        default = 
-000085a0: 2779 270a 0a20 2020 2020 2020 2023 2047  'y'..        # G
-000085b0: 6574 2074 6865 7461 7320 2869 6e20 6465  et thetas (in de
-000085c0: 6772 6565 7329 0a20 2020 2020 2020 2074  grees).        t
-000085d0: 6865 7461 7320 3d20 6e70 2e61 7361 7272  hetas = np.asarr
-000085e0: 6179 286e 7865 6e74 7279 2e72 6564 7563  ay(nxentry.reduc
-000085f0: 6564 5f64 6174 612e 726f 7461 7469 6f6e  ed_data.rotation
-00008600: 5f61 6e67 6c65 290a 2020 2020 2020 2020  _angle).        
-00008610: 6173 7365 7274 206c 656e 2874 6865 7461  assert len(theta
-00008620: 7329 203d 3d20 746f 6d6f 5f66 6965 6c64  s) == tomo_field
-00008630: 735f 7368 6170 655b 315d 0a0a 2020 2020  s_shape[1]..    
-00008640: 2020 2020 2320 4765 7420 6566 6665 6374      # Get effect
-00008650: 6976 6520 7069 7865 6c5f 7369 7a65 0a20  ive pixel_size. 
-00008660: 2020 2020 2020 2069 6620 277a 6f6f 6d5f         if 'zoom_
-00008670: 7065 7263 2720 696e 206e 7865 6e74 7279  perc' in nxentry
-00008680: 2e72 6564 7563 6564 5f64 6174 613a 0a20  .reduced_data:. 
-00008690: 2020 2020 2020 2020 2020 2065 6666 5f70             eff_p
-000086a0: 6978 656c 5f73 697a 6520 3d20 5c0a 2020  ixel_size = \.  
-000086b0: 2020 2020 2020 2020 2020 2020 2020 3130                10
-000086c0: 302e 202a 2028 6e78 656e 7472 792e 696e  0. * (nxentry.in
-000086d0: 7374 7275 6d65 6e74 2e64 6574 6563 746f  strument.detecto
-000086e0: 722e 785f 7069 7865 6c5f 7369 7a65 0a20  r.x_pixel_size. 
-000086f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008700: 2020 2020 2020 2020 2f20 6e78 656e 7472          / nxentr
-00008710: 792e 7265 6475 6365 645f 6461 7461 2e61  y.reduced_data.a
-00008720: 7474 7273 5b27 7a6f 6f6d 5f70 6572 6327  ttrs['zoom_perc'
-00008730: 5d29 0a20 2020 2020 2020 2065 6c73 653a  ]).        else:
-00008740: 0a20 2020 2020 2020 2020 2020 2065 6666  .            eff
-00008750: 5f70 6978 656c 5f73 697a 6520 3d20 6e78  _pixel_size = nx
-00008760: 656e 7472 792e 696e 7374 7275 6d65 6e74  entry.instrument
-00008770: 2e64 6574 6563 746f 722e 785f 7069 7865  .detector.x_pixe
-00008780: 6c5f 7369 7a65 0a0a 2020 2020 2020 2020  l_size..        
-00008790: 2320 4765 7420 6372 6f73 7320 7365 6374  # Get cross sect
-000087a0: 696f 6e61 6c20 6469 616d 6574 6572 0a20  ional diameter. 
-000087b0: 2020 2020 2020 2063 726f 7373 5f73 6563         cross_sec
-000087c0: 7469 6f6e 616c 5f64 696d 203d 2074 6f6d  tional_dim = tom
-000087d0: 6f5f 6669 656c 6473 5f73 6861 7065 5b33  o_fields_shape[3
-000087e0: 5d2a 6566 665f 7069 7865 6c5f 7369 7a65  ]*eff_pixel_size
-000087f0: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
-00008800: 6f67 6765 722e 6465 6275 6728 6627 6372  ogger.debug(f'cr
-00008810: 6f73 735f 7365 6374 696f 6e61 6c5f 6469  oss_sectional_di
-00008820: 6d20 3d20 7b63 726f 7373 5f73 6563 7469  m = {cross_secti
-00008830: 6f6e 616c 5f64 696d 7d27 290a 0a20 2020  onal_dim}')..   
-00008840: 2020 2020 2023 2044 6574 6572 6d69 6e65       # Determine
-00008850: 2063 656e 7465 7220 6f66 6673 6574 2061   center offset a
-00008860: 7420 7361 6d70 6c65 2072 6f77 2062 6f75  t sample row bou
-00008870: 6e64 6172 6965 730a 2020 2020 2020 2020  ndaries.        
-00008880: 7365 6c66 2e5f 6c6f 6767 6572 2e69 6e66  self._logger.inf
-00008890: 6f28 2744 6574 6572 6d69 6e65 2063 656e  o('Determine cen
-000088a0: 7465 7220 6f66 6673 6574 2061 7420 7361  ter offset at sa
-000088b0: 6d70 6c65 2072 6f77 2062 6f75 6e64 6172  mple row boundar
-000088c0: 6965 7327 290a 0a20 2020 2020 2020 2023  ies')..        #
-000088d0: 204c 6f77 6572 2072 6f77 2063 656e 7465   Lower row cente
-000088e0: 720a 2020 2020 2020 2020 6966 2073 656c  r.        if sel
-000088f0: 662e 5f74 6573 745f 6d6f 6465 3a0a 2020  f._test_mode:.  
-00008900: 2020 2020 2020 2020 2020 6c6f 7765 725f            lower_
-00008910: 726f 7720 3d20 7365 6c66 2e5f 7465 7374  row = self._test
-00008920: 5f63 6f6e 6669 675b 276c 6f77 6572 5f72  _config['lower_r
-00008930: 6f77 275d 0a20 2020 2020 2020 2065 6c69  ow'].        eli
-00008940: 6620 7365 6c66 2e5f 696e 7465 7261 6374  f self._interact
-00008950: 6976 653a 0a20 2020 2020 2020 2020 2020  ive:.           
-00008960: 2069 6620 6365 6e74 6572 5f72 6f77 7320   if center_rows 
-00008970: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
-00008980: 6365 6e74 6572 5f72 6f77 735b 305d 2069  center_rows[0] i
-00008990: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-000089a0: 2020 2020 2020 2020 2020 2020 6c6f 7765              lowe
-000089b0: 725f 726f 7720 3d20 6365 6e74 6572 5f72  r_row = center_r
-000089c0: 6f77 735b 305d 0a20 2020 2020 2020 2020  ows[0].         
-000089d0: 2020 2020 2020 2069 6620 6c6f 7765 725f         if lower_
-000089e0: 726f 7720 3d3d 202d 313a 0a20 2020 2020  row == -1:.     
-000089f0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00008a00: 6f77 6572 5f72 6f77 203d 2030 0a20 2020  ower_row = 0.   
-00008a10: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00008a20: 6e6f 7420 3020 3c3d 206c 6f77 6572 5f72  not 0 <= lower_r
-00008a30: 6f77 203c 2074 6f6d 6f5f 6669 656c 6473  ow < tomo_fields
-00008a40: 5f73 6861 7065 5b32 5d2d 313a 0a20 2020  _shape[2]-1:.   
-00008a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a60: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00008a70: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00008a80: 2020 2020 2020 2020 2020 2066 2749 6e76             f'Inv
-00008a90: 616c 6964 2070 6172 616d 6574 6572 2063  alid parameter c
-00008aa0: 656e 7465 725f 726f 7773 2028 7b63 656e  enter_rows ({cen
-00008ab0: 7465 725f 726f 7773 7d29 2729 0a20 2020  ter_rows})').   
-00008ac0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00008ad0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00008ae0: 6f77 6572 5f72 6f77 203d 2073 656c 6563  ower_row = selec
-00008af0: 745f 6f6e 655f 696d 6167 655f 626f 756e  t_one_image_boun
-00008b00: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-00008b10: 2020 2020 2020 206e 7865 6e74 7279 2e72         nxentry.r
-00008b20: 6564 7563 6564 5f64 6174 612e 6461 7461  educed_data.data
-00008b30: 2e74 6f6d 6f5f 6669 656c 6473 5b0a 2020  .tomo_fields[.  
-00008b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008b50: 2020 2020 2020 6365 6e74 6572 5f73 7461        center_sta
-00008b60: 636b 5f69 6e64 6578 2c30 2c3a 2c3a 5d2c  ck_index,0,:,:],
-00008b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008b80: 2020 2020 2030 2c20 626f 756e 643d 302c       0, bound=0,
-00008b90: 2074 6974 6c65 3d66 2774 6865 7461 3d7b   title=f'theta={
-00008ba0: 726f 756e 6428 7468 6574 6173 5b30 5d2c  round(thetas[0],
-00008bb0: 2032 292b 307d 272c 0a20 2020 2020 2020   2)+0}',.       
-00008bc0: 2020 2020 2020 2020 2020 2020 2062 6f75               bou
-00008bd0: 6e64 5f6e 616d 653d 2772 6f77 2069 6e64  nd_name='row ind
-00008be0: 6578 2074 6f20 6669 6e64 206c 6f77 6572  ex to find lower
-00008bf0: 2063 656e 7465 7227 2c0a 2020 2020 2020   center',.      
-00008c00: 2020 2020 2020 2020 2020 2020 2020 6465                de
-00008c10: 6661 756c 743d 6465 6661 756c 742c 2072  fault=default, r
-00008c20: 6169 7365 5f65 7272 6f72 3d54 7275 6529  aise_error=True)
-00008c30: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00008c40: 2020 2020 2020 2020 2020 2069 6620 6365             if ce
-00008c50: 6e74 6572 5f72 6f77 7320 6973 204e 6f6e  nter_rows is Non
-00008c60: 6520 6f72 2063 656e 7465 725f 726f 7773  e or center_rows
-00008c70: 5b30 5d20 6973 204e 6f6e 653a 0a20 2020  [0] is None:.   
-00008c80: 2020 2020 2020 2020 2020 2020 206c 6f77               low
-00008c90: 6572 5f72 6f77 203d 2030 0a20 2020 2020  er_row = 0.     
-00008ca0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00008cb0: 2020 2020 2020 2020 2020 2020 206c 6f77               low
-00008cc0: 6572 5f72 6f77 203d 2063 656e 7465 725f  er_row = center_
-00008cd0: 726f 7773 5b30 5d0a 2020 2020 2020 2020  rows[0].        
-00008ce0: 2020 2020 2020 2020 6966 206c 6f77 6572          if lower
-00008cf0: 5f72 6f77 203d 3d20 2d31 3a0a 2020 2020  _row == -1:.    
-00008d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d10: 6c6f 7765 725f 726f 7720 3d20 300a 2020  lower_row = 0.  
-00008d20: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00008d30: 206e 6f74 2030 203c 3d20 6c6f 7765 725f   not 0 <= lower_
-00008d40: 726f 7720 3c20 746f 6d6f 5f66 6965 6c64  row < tomo_field
-00008d50: 735f 7368 6170 655b 325d 2d31 3a0a 2020  s_shape[2]-1:.  
-00008d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d70: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00008d80: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00008d90: 2020 2020 2020 2020 2020 2020 6627 496e              f'In
-00008da0: 7661 6c69 6420 7061 7261 6d65 7465 7220  valid parameter 
-00008db0: 6365 6e74 6572 5f72 6f77 7320 287b 6365  center_rows ({ce
-00008dc0: 6e74 6572 5f72 6f77 737d 2927 290a 2020  nter_rows})').  
-00008dd0: 2020 2020 2020 7430 203d 2074 696d 6528        t0 = time(
-00008de0: 290a 2020 2020 2020 2020 6c6f 7765 725f  ).        lower_
-00008df0: 6365 6e74 6572 5f6f 6666 7365 7420 3d20  center_offset = 
-00008e00: 7365 6c66 2e5f 6669 6e64 5f63 656e 7465  self._find_cente
-00008e10: 725f 6f6e 655f 706c 616e 6528 0a20 2020  r_one_plane(.   
-00008e20: 2020 2020 2020 2020 206e 7865 6e74 7279           nxentry
-00008e30: 2e72 6564 7563 6564 5f64 6174 612e 6461  .reduced_data.da
-00008e40: 7461 2e74 6f6d 6f5f 6669 656c 6473 5b0a  ta.tomo_fields[.
-00008e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008e60: 6365 6e74 6572 5f73 7461 636b 5f69 6e64  center_stack_ind
-00008e70: 6578 2c3a 2c6c 6f77 6572 5f72 6f77 2c3a  ex,:,lower_row,:
-00008e80: 5d2c 0a20 2020 2020 2020 2020 2020 206c  ],.            l
-00008e90: 6f77 6572 5f72 6f77 2c20 7468 6574 6173  ower_row, thetas
-00008ea0: 2c20 6566 665f 7069 7865 6c5f 7369 7a65  , eff_pixel_size
-00008eb0: 2c20 6372 6f73 735f 7365 6374 696f 6e61  , cross_sectiona
-00008ec0: 6c5f 6469 6d2c 0a20 2020 2020 2020 2020  l_dim,.         
-00008ed0: 2020 2070 6174 683d 7365 6c66 2e5f 6f75     path=self._ou
-00008ee0: 7470 7574 5f66 6f6c 6465 722c 206e 756d  tput_folder, num
-00008ef0: 5f63 6f72 653d 7365 6c66 2e5f 6e75 6d5f  _core=self._num_
-00008f00: 636f 7265 2c0a 2020 2020 2020 2020 2020  core,.          
-00008f10: 2020 6761 7573 7369 616e 5f73 6967 6d61    gaussian_sigma
-00008f20: 3d67 6175 7373 6961 6e5f 7369 676d 612c  =gaussian_sigma,
-00008f30: 2072 696e 675f 7769 6474 683d 7269 6e67   ring_width=ring
-00008f40: 5f77 6964 7468 290a 2020 2020 2020 2020  _width).        
-00008f50: 7365 6c66 2e5f 6c6f 6767 6572 2e69 6e66  self._logger.inf
-00008f60: 6f28 6627 4669 6e64 696e 6720 6365 6e74  o(f'Finding cent
-00008f70: 6572 2074 6f6f 6b20 7b74 696d 6528 292d  er took {time()-
-00008f80: 7430 3a2e 3266 7d20 7365 636f 6e64 7327  t0:.2f} seconds'
-00008f90: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
-00008fa0: 6c6f 6767 6572 2e64 6562 7567 2866 276c  logger.debug(f'l
-00008fb0: 6f77 6572 5f72 6f77 203d 207b 6c6f 7765  ower_row = {lowe
-00008fc0: 725f 726f 773a 2e32 667d 2729 0a20 2020  r_row:.2f}').   
-00008fd0: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
-00008fe0: 722e 6465 6275 6728 6627 6c6f 7765 725f  r.debug(f'lower_
-00008ff0: 6365 6e74 6572 5f6f 6666 7365 7420 3d20  center_offset = 
-00009000: 7b6c 6f77 6572 5f63 656e 7465 725f 6f66  {lower_center_of
-00009010: 6673 6574 3a2e 3266 7d27 290a 0a20 2020  fset:.2f}')..   
-00009020: 2020 2020 2023 2055 7070 6572 2072 6f77       # Upper row
-00009030: 2063 656e 7465 720a 2020 2020 2020 2020   center.        
-00009040: 6966 2073 656c 662e 5f74 6573 745f 6d6f  if self._test_mo
-00009050: 6465 3a0a 2020 2020 2020 2020 2020 2020  de:.            
-00009060: 7570 7065 725f 726f 7720 3d20 7365 6c66  upper_row = self
-00009070: 2e5f 7465 7374 5f63 6f6e 6669 675b 2775  ._test_config['u
-00009080: 7070 6572 5f72 6f77 275d 0a20 2020 2020  pper_row'].     
-00009090: 2020 2065 6c69 6620 7365 6c66 2e5f 696e     elif self._in
-000090a0: 7465 7261 6374 6976 653a 0a20 2020 2020  teractive:.     
-000090b0: 2020 2020 2020 2069 6620 6365 6e74 6572         if center
-000090c0: 5f72 6f77 7320 6973 206e 6f74 204e 6f6e  _rows is not Non
-000090d0: 6520 616e 6420 6365 6e74 6572 5f72 6f77  e and center_row
-000090e0: 735b 315d 2069 7320 6e6f 7420 4e6f 6e65  s[1] is not None
-000090f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009100: 2020 7570 7065 725f 726f 7720 3d20 6365    upper_row = ce
-00009110: 6e74 6572 5f72 6f77 735b 315d 0a20 2020  nter_rows[1].   
-00009120: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00009130: 7570 7065 725f 726f 7720 3d3d 202d 313a  upper_row == -1:
-00009140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009150: 2020 2020 2075 7070 6572 5f72 6f77 203d       upper_row =
-00009160: 2074 6f6d 6f5f 6669 656c 6473 5f73 6861   tomo_fields_sha
-00009170: 7065 5b32 5d2d 310a 2020 2020 2020 2020  pe[2]-1.        
-00009180: 2020 2020 2020 2020 6966 206e 6f74 206c          if not l
-00009190: 6f77 6572 5f72 6f77 203c 2075 7070 6572  ower_row < upper
-000091a0: 5f72 6f77 203c 2074 6f6d 6f5f 6669 656c  _row < tomo_fiel
-000091b0: 6473 5f73 6861 7065 5b32 5d3a 0a20 2020  ds_shape[2]:.   
+00004b20: 2020 2020 2020 2020 2020 2020 7363 616e              scan
+00004b30: 5f73 7465 705f 696e 6465 783d 2869 6d61  _step_index=(ima
+00004b40: 6765 5f6f 6666 7365 742c 0a20 2020 2020  ge_offset,.     
+00004b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b70: 2020 2020 2020 2020 696d 6167 655f 6f66          image_of
+00004b80: 6673 6574 2b6e 756d 5f69 6d61 6765 2929  fset+num_image))
+00004b90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00004ba0: 2020 2020 2020 726f 7461 7469 6f6e 5f61        rotation_a
+00004bb0: 6e67 6c65 7320 2b3d 206c 6973 7428 7468  ngles += list(th
+00004bc0: 6574 6173 290a 2020 2020 2020 2020 2020  etas).          
+00004bd0: 2020 2020 2020 2020 2020 785f 7472 616e            x_tran
+00004be0: 736c 6174 696f 6e73 202b 3d20 6e75 6d5f  slations += num_
+00004bf0: 696d 6167 652a 5b78 5f74 7261 6e73 6c61  image*[x_transla
+00004c00: 7469 6f6e 5d0a 2020 2020 2020 2020 2020  tion].          
+00004c10: 2020 2020 2020 2020 2020 7a5f 7472 616e            z_tran
+00004c20: 736c 6174 696f 6e73 202b 3d20 6e75 6d5f  slations += num_
+00004c30: 696d 6167 652a 5b7a 5f74 7261 6e73 6c61  image*[z_transla
+00004c40: 7469 6f6e 5d0a 0a20 2020 2020 2020 2069  tion]..        i
+00004c50: 6620 696e 636c 7564 655f 7261 775f 6461  f include_raw_da
+00004c60: 7461 3a0a 2020 2020 2020 2020 2020 2020  ta:.            
+00004c70: 2320 4164 6420 696d 6167 6520 6461 7461  # Add image data
+00004c80: 2074 6f20 4e58 6465 7465 6374 6f72 0a20   to NXdetector. 
+00004c90: 2020 2020 2020 2020 2020 206e 7869 6e73             nxins
+00004ca0: 7472 756d 656e 742e 6465 7465 6374 6f72  trument.detector
+00004cb0: 2e69 6d61 6765 5f6b 6579 203d 2069 6d61  .image_key = ima
+00004cc0: 6765 5f6b 6579 730a 2020 2020 2020 2020  ge_keys.        
+00004cd0: 2020 2020 6e78 696e 7374 7275 6d65 6e74      nxinstrument
+00004ce0: 2e64 6574 6563 746f 722e 7365 7175 656e  .detector.sequen
+00004cf0: 6365 5f6e 756d 6265 7220 3d20 7365 7175  ce_number = sequ
+00004d00: 656e 6365 5f6e 756d 6265 7273 0a20 2020  ence_numbers.   
+00004d10: 2020 2020 2020 2020 206e 7869 6e73 7472           nxinstr
+00004d20: 756d 656e 742e 6465 7465 6374 6f72 2e64  ument.detector.d
+00004d30: 6174 6120 3d20 6e70 2e63 6f6e 6361 7465  ata = np.concate
+00004d40: 6e61 7465 2869 6d61 6765 5f73 7461 636b  nate(image_stack
+00004d50: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+00004d60: 2320 4164 6420 696d 6167 6520 6461 7461  # Add image data
+00004d70: 2074 6f20 4e58 7361 6d70 6c65 0a20 2020   to NXsample.   
+00004d80: 2020 2020 2020 2020 206e 7873 616d 706c           nxsampl
+00004d90: 652e 726f 7461 7469 6f6e 5f61 6e67 6c65  e.rotation_angle
+00004da0: 203d 2072 6f74 6174 696f 6e5f 616e 676c   = rotation_angl
+00004db0: 6573 0a20 2020 2020 2020 2020 2020 206e  es.            n
+00004dc0: 7873 616d 706c 652e 726f 7461 7469 6f6e  xsample.rotation
+00004dd0: 5f61 6e67 6c65 2e61 7474 7273 5b27 756e  _angle.attrs['un
+00004de0: 6974 7327 5d20 3d20 2764 6567 7265 6573  its'] = 'degrees
+00004df0: 270a 2020 2020 2020 2020 2020 2020 6e78  '.            nx
+00004e00: 7361 6d70 6c65 2e78 5f74 7261 6e73 6c61  sample.x_transla
+00004e10: 7469 6f6e 203d 2078 5f74 7261 6e73 6c61  tion = x_transla
+00004e20: 7469 6f6e 730a 2020 2020 2020 2020 2020  tions.          
+00004e30: 2020 6e78 7361 6d70 6c65 2e78 5f74 7261    nxsample.x_tra
+00004e40: 6e73 6c61 7469 6f6e 2e61 7474 7273 5b27  nslation.attrs['
+00004e50: 756e 6974 7327 5d20 3d20 276d 6d27 0a20  units'] = 'mm'. 
+00004e60: 2020 2020 2020 2020 2020 206e 7873 616d             nxsam
+00004e70: 706c 652e 7a5f 7472 616e 736c 6174 696f  ple.z_translatio
+00004e80: 6e20 3d20 7a5f 7472 616e 736c 6174 696f  n = z_translatio
+00004e90: 6e73 0a20 2020 2020 2020 2020 2020 206e  ns.            n
+00004ea0: 7873 616d 706c 652e 7a5f 7472 616e 736c  xsample.z_transl
+00004eb0: 6174 696f 6e2e 6174 7472 735b 2775 6e69  ation.attrs['uni
+00004ec0: 7473 275d 203d 2027 6d6d 270a 0a20 2020  ts'] = 'mm'..   
+00004ed0: 2020 2020 2020 2020 2023 2041 6464 2061           # Add a
+00004ee0: 6e20 4e58 6461 7461 2074 6f20 4e58 656e  n NXdata to NXen
+00004ef0: 7472 790a 2020 2020 2020 2020 2020 2020  try.            
+00004f00: 6e78 6461 7461 203d 204e 5864 6174 6128  nxdata = NXdata(
+00004f10: 290a 2020 2020 2020 2020 2020 2020 6e78  ).            nx
+00004f20: 656e 7472 792e 6461 7461 203d 206e 7864  entry.data = nxd
+00004f30: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
+00004f40: 6e78 6461 7461 2e6d 616b 656c 696e 6b28  nxdata.makelink(
+00004f50: 6e78 656e 7472 792e 696e 7374 7275 6d65  nxentry.instrume
+00004f60: 6e74 2e64 6574 6563 746f 722e 6461 7461  nt.detector.data
+00004f70: 2c20 6e61 6d65 3d27 6461 7461 2729 0a20  , name='data'). 
+00004f80: 2020 2020 2020 2020 2020 206e 7864 6174             nxdat
+00004f90: 612e 6d61 6b65 6c69 6e6b 286e 7865 6e74  a.makelink(nxent
+00004fa0: 7279 2e69 6e73 7472 756d 656e 742e 6465  ry.instrument.de
+00004fb0: 7465 6374 6f72 2e69 6d61 6765 5f6b 6579  tector.image_key
+00004fc0: 290a 2020 2020 2020 2020 2020 2020 6e78  ).            nx
+00004fd0: 6461 7461 2e6d 616b 656c 696e 6b28 6e78  data.makelink(nx
+00004fe0: 656e 7472 792e 7361 6d70 6c65 2e72 6f74  entry.sample.rot
+00004ff0: 6174 696f 6e5f 616e 676c 6529 0a20 2020  ation_angle).   
+00005000: 2020 2020 2020 2020 206e 7864 6174 612e           nxdata.
+00005010: 6d61 6b65 6c69 6e6b 286e 7865 6e74 7279  makelink(nxentry
+00005020: 2e73 616d 706c 652e 785f 7472 616e 736c  .sample.x_transl
+00005030: 6174 696f 6e29 0a20 2020 2020 2020 2020  ation).         
+00005040: 2020 206e 7864 6174 612e 6d61 6b65 6c69     nxdata.makeli
+00005050: 6e6b 286e 7865 6e74 7279 2e73 616d 706c  nk(nxentry.sampl
+00005060: 652e 7a5f 7472 616e 736c 6174 696f 6e29  e.z_translation)
+00005070: 0a23 2020 2020 2020 2020 2020 2020 6e78  .#            nx
+00005080: 6461 7461 2e61 7474 7273 5b27 6178 6573  data.attrs['axes
+00005090: 275d 203d 205b 2766 6965 6c64 272c 2027  '] = ['field', '
+000050a0: 726f 7727 2c20 2763 6f6c 756d 6e27 5d0a  row', 'column'].
+000050b0: 2320 2020 2020 2020 2020 2020 206e 7864  #            nxd
+000050c0: 6174 612e 6174 7472 735b 2766 6965 6c64  ata.attrs['field
+000050d0: 5f69 6e64 6963 6573 275d 203d 2030 0a23  _indices'] = 0.#
+000050e0: 2020 2020 2020 2020 2020 2020 6e78 6461              nxda
+000050f0: 7461 2e61 7474 7273 5b27 726f 775f 696e  ta.attrs['row_in
+00005100: 6469 6365 7327 5d20 3d20 310a 2320 2020  dices'] = 1.#   
+00005110: 2020 2020 2020 2020 206e 7864 6174 612e           nxdata.
+00005120: 6174 7472 735b 2763 6f6c 756d 6e5f 696e  attrs['column_in
+00005130: 6469 6365 7327 5d20 3d20 320a 0a20 2020  dices'] = 2..   
+00005140: 2020 2020 2072 6574 7572 6e20 6e78 726f       return nxro
+00005150: 6f74 0a0a 0a64 6566 206e 7863 6f70 7928  ot...def nxcopy(
+00005160: 6e78 6f62 6a65 6374 2c20 6578 636c 7564  nxobject, exclud
+00005170: 655f 6e78 7061 7468 733d 4e6f 6e65 2c20  e_nxpaths=None, 
+00005180: 6e78 7061 7468 5f70 7265 6669 783d 2727  nxpath_prefix=''
+00005190: 293a 0a20 2020 2022 2222 0a20 2020 2046  ):.    """.    F
+000051a0: 756e 6374 696f 6e20 7468 6174 2072 6574  unction that ret
+000051b0: 7572 6e73 2061 2063 6f70 7920 6f66 2061  urns a copy of a
+000051c0: 206e 6578 7573 206f 626a 6563 742c 206f   nexus object, o
+000051d0: 7074 696f 6e61 6c6c 7920 6578 6c75 6469  ptionally exludi
+000051e0: 6e67 0a20 2020 2063 6572 7461 696e 2063  ng.    certain c
+000051f0: 6869 6c64 2069 7465 6d73 2e0a 0a20 2020  hild items...   
+00005200: 203a 7061 7261 6d20 6e78 6f62 6a65 6374   :param nxobject
+00005210: 3a20 7468 6520 6f72 6967 696e 616c 206e  : the original n
+00005220: 6578 7573 206f 626a 6563 7420 746f 2072  exus object to r
+00005230: 6574 7572 6e20 6120 2263 6f70 7922 206f  eturn a "copy" o
+00005240: 660a 2020 2020 3a74 7970 6520 6e78 6f62  f.    :type nxob
+00005250: 6a65 6374 3a20 6e65 7875 7366 6f72 6d61  ject: nexusforma
+00005260: 742e 6e65 7875 732e 4e58 6f62 6a65 6374  t.nexus.NXobject
+00005270: 0a20 2020 203a 7061 7261 6d20 6578 6c75  .    :param exlu
+00005280: 6465 5f6e 7870 6174 6873 3a20 6120 6c69  de_nxpaths: a li
+00005290: 7374 206f 6620 7061 7468 7320 746f 2063  st of paths to c
+000052a0: 6869 6c64 206e 6578 7573 206f 626a 6563  hild nexus objec
+000052b0: 7473 2074 6861 740a 2020 2020 2020 2020  ts that.        
+000052c0: 7368 6f75 6c64 2062 6520 6578 636c 7564  should be exclud
+000052d0: 6564 2066 726f 6d20 7468 6520 7265 7475  ed from the retu
+000052e0: 726e 6564 2022 636f 7079 222c 2064 6566  rned "copy", def
+000052f0: 6175 6c74 7320 746f 2060 5b5d 600a 2020  aults to `[]`.  
+00005300: 2020 3a74 7970 6520 6578 636c 7564 655f    :type exclude_
+00005310: 6e78 7061 7468 733a 206c 6973 745b 7374  nxpaths: list[st
+00005320: 725d 2c20 6f70 7469 6f6e 616c 0a20 2020  r], optional.   
+00005330: 203a 7061 7261 6d20 6e78 7061 7468 5f70   :param nxpath_p
+00005340: 7265 6669 783a 2046 6f72 2075 7365 2069  refix: For use i
+00005350: 6e20 7265 6375 7273 6976 6520 6361 6c6c  n recursive call
+00005360: 7320 6672 6f6d 2069 6e73 6964 6520 7468  s from inside th
+00005370: 6973 0a20 2020 2020 2020 2066 756e 6374  is.        funct
+00005380: 696f 6e20 6f6e 6c79 210a 2020 2020 3a74  ion only!.    :t
+00005390: 7970 6520 6e78 7061 7468 5f70 7265 6669  ype nxpath_prefi
+000053a0: 783a 2073 7472 0a20 2020 203a 7265 7475  x: str.    :retu
+000053b0: 726e 3a20 436f 7079 206f 6620 7468 6520  rn: Copy of the 
+000053c0: 696e 7075 7420 606e 786f 626a 6563 7460  input `nxobject`
+000053d0: 2077 6974 6820 736f 6d65 2063 6869 6c64   with some child
+000053e0: 7265 6e20 6f70 7469 6f6e 616c 6c79 0a20  ren optionally. 
+000053f0: 2020 2020 2020 2065 786c 7564 6564 2e0a         exluded..
+00005400: 2020 2020 3a72 7479 7065 3a20 4e58 6f62      :rtype: NXob
+00005410: 6a65 6374 0a20 2020 2022 2222 0a20 2020  ject.    """.   
+00005420: 2023 2054 6869 7264 2070 6172 7479 206d   # Third party m
+00005430: 6f64 756c 6573 0a20 2020 2066 726f 6d20  odules.    from 
+00005440: 6e65 7875 7366 6f72 6d61 742e 6e65 7875  nexusformat.nexu
+00005450: 7320 696d 706f 7274 204e 5867 726f 7570  s import NXgroup
+00005460: 0a0a 2020 2020 6e78 6f62 6a65 6374 5f63  ..    nxobject_c
+00005470: 6f70 7920 3d20 6e78 6f62 6a65 6374 2e5f  opy = nxobject._
+00005480: 5f63 6c61 7373 5f5f 2829 0a20 2020 2069  _class__().    i
+00005490: 6620 6e6f 7420 6e78 7061 7468 5f70 7265  f not nxpath_pre
+000054a0: 6669 783a 0a20 2020 2020 2020 2069 6620  fix:.        if 
+000054b0: 2764 6566 6175 6c74 2720 696e 206e 786f  'default' in nxo
+000054c0: 626a 6563 742e 6174 7472 733a 0a20 2020  bject.attrs:.   
+000054d0: 2020 2020 2020 2020 206e 786f 626a 6563           nxobjec
+000054e0: 745f 636f 7079 2e61 7474 7273 5b27 6465  t_copy.attrs['de
+000054f0: 6661 756c 7427 5d20 3d20 6e78 6f62 6a65  fault'] = nxobje
+00005500: 6374 2e61 7474 7273 5b27 6465 6661 756c  ct.attrs['defaul
+00005510: 7427 5d0a 2020 2020 656c 7365 3a0a 2020  t'].    else:.  
+00005520: 2020 2020 2020 666f 7220 6b2c 2076 2069        for k, v i
+00005530: 6e20 6e78 6f62 6a65 6374 2e61 7474 7273  n nxobject.attrs
+00005540: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00005550: 2020 2020 2020 6e78 6f62 6a65 6374 5f63        nxobject_c
+00005560: 6f70 792e 6174 7472 735b 6b5d 203d 2076  opy.attrs[k] = v
+00005570: 0a0a 2020 2020 6966 2065 7863 6c75 6465  ..    if exclude
+00005580: 5f6e 7870 6174 6873 2069 7320 4e6f 6e65  _nxpaths is None
+00005590: 3a0a 2020 2020 2020 2020 6578 636c 7564  :.        exclud
+000055a0: 655f 6e78 7061 7468 7320 3d20 5b5d 0a20  e_nxpaths = []. 
+000055b0: 2020 2066 6f72 206b 2c20 7620 696e 206e     for k, v in n
+000055c0: 786f 626a 6563 742e 6974 656d 7328 293a  xobject.items():
+000055d0: 0a20 2020 2020 2020 206e 7870 6174 6820  .        nxpath 
+000055e0: 3d20 6f73 5f70 6174 682e 6a6f 696e 286e  = os_path.join(n
+000055f0: 7870 6174 685f 7072 6566 6978 2c20 6b29  xpath_prefix, k)
+00005600: 0a0a 2020 2020 2020 2020 6966 206e 7870  ..        if nxp
+00005610: 6174 6820 696e 2065 7863 6c75 6465 5f6e  ath in exclude_n
+00005620: 7870 6174 6873 3a0a 2020 2020 2020 2020  xpaths:.        
+00005630: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+00005640: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00005650: 6e63 6528 762c 204e 5867 726f 7570 293a  nce(v, NXgroup):
+00005660: 0a20 2020 2020 2020 2020 2020 206e 786f  .            nxo
+00005670: 626a 6563 745f 636f 7079 5b6b 5d20 3d20  bject_copy[k] = 
+00005680: 6e78 636f 7079 280a 2020 2020 2020 2020  nxcopy(.        
+00005690: 2020 2020 2020 2020 762c 2065 7863 6c75          v, exclu
+000056a0: 6465 5f6e 7870 6174 6873 3d65 7863 6c75  de_nxpaths=exclu
+000056b0: 6465 5f6e 7870 6174 6873 2c0a 2020 2020  de_nxpaths,.    
+000056c0: 2020 2020 2020 2020 2020 2020 6e78 7061              nxpa
+000056d0: 7468 5f70 7265 6669 783d 6f73 5f70 6174  th_prefix=os_pat
+000056e0: 682e 6a6f 696e 286e 7870 6174 685f 7072  h.join(nxpath_pr
+000056f0: 6566 6978 2c20 6b29 290a 2020 2020 2020  efix, k)).      
+00005700: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00005710: 2020 2020 6e78 6f62 6a65 6374 5f63 6f70      nxobject_cop
+00005720: 795b 6b5d 203d 2076 0a0a 2020 2020 7265  y[k] = v..    re
+00005730: 7475 726e 206e 786f 626a 6563 745f 636f  turn nxobject_co
+00005740: 7079 0a0a 0a63 6c61 7373 2053 6574 4e75  py...class SetNu
+00005750: 6d65 7870 7254 6872 6561 6473 3a0a 2020  mexprThreads:.  
+00005760: 2020 2222 220a 2020 2020 436c 6173 7320    """.    Class 
+00005770: 7468 6174 2073 6574 7320 616e 6420 6b65  that sets and ke
+00005780: 6570 7320 7472 6163 6b20 6f66 2074 6865  eps track of the
+00005790: 206e 756d 6265 7220 6f66 2070 726f 6365   number of proce
+000057a0: 7373 6f72 7320 7573 6564 2062 790a 2020  ssors used by.  
+000057b0: 2020 7468 6520 636f 6465 2069 6e20 6765    the code in ge
+000057c0: 6e65 7261 6c20 616e 6420 6279 2074 6865  neral and by the
+000057d0: 206e 756d 5f65 7870 7220 7061 636b 6167   num_expr packag
+000057e0: 6520 7370 6563 6966 6963 616c 6c79 2e0a  e specifically..
+000057f0: 2020 2020 2222 220a 0a20 2020 2064 6566      """..    def
+00005800: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00005810: 6e75 6d5f 636f 7265 293a 0a20 2020 2020  num_core):.     
+00005820: 2020 2022 2222 0a20 2020 2020 2020 2049     """.        I
+00005830: 6e69 7469 616c 697a 6520 5365 744e 756d  nitialize SetNum
+00005840: 6578 7072 5468 7265 6164 732e 0a0a 2020  exprThreads...  
+00005850: 2020 2020 2020 3a70 6172 616d 206e 756d        :param num
+00005860: 5f63 6f72 653a 204e 756d 6265 7220 6f66  _core: Number of
+00005870: 2070 726f 6365 7373 6f72 7320 7573 6564   processors used
+00005880: 2062 7920 7468 6520 6e75 6d5f 6578 7072   by the num_expr
+00005890: 0a20 2020 2020 2020 2020 2020 2070 6163  .            pac
+000058a0: 6b61 6765 0a20 2020 2020 2020 203a 7479  kage.        :ty
+000058b0: 7065 206e 756d 5f63 6f72 653a 2069 6e74  pe num_core: int
+000058c0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+000058d0: 2020 2020 2023 2053 7973 7465 6d20 6d6f       # System mo
+000058e0: 6475 6c65 730a 2020 2020 2020 2020 6672  dules.        fr
+000058f0: 6f6d 206d 756c 7469 7072 6f63 6573 7369  om multiprocessi
+00005900: 6e67 2069 6d70 6f72 7420 6370 755f 636f  ng import cpu_co
+00005910: 756e 740a 0a20 2020 2020 2020 2069 6620  unt..        if 
+00005920: 6e75 6d5f 636f 7265 2069 7320 4e6f 6e65  num_core is None
+00005930: 206f 7220 6e75 6d5f 636f 7265 203c 2031   or num_core < 1
+00005940: 206f 7220 6e75 6d5f 636f 7265 203e 2063   or num_core > c
+00005950: 7075 5f63 6f75 6e74 2829 3a0a 2020 2020  pu_count():.    
+00005960: 2020 2020 2020 2020 7365 6c66 2e5f 6e75          self._nu
+00005970: 6d5f 636f 7265 203d 2063 7075 5f63 6f75  m_core = cpu_cou
+00005980: 6e74 2829 0a20 2020 2020 2020 2065 6c73  nt().        els
+00005990: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+000059a0: 656c 662e 5f6e 756d 5f63 6f72 6520 3d20  elf._num_core = 
+000059b0: 6e75 6d5f 636f 7265 0a20 2020 2020 2020  num_core.       
+000059c0: 2073 656c 662e 5f6e 756d 5f63 6f72 655f   self._num_core_
+000059d0: 6f72 6720 3d20 7365 6c66 2e5f 6e75 6d5f  org = self._num_
+000059e0: 636f 7265 0a0a 2020 2020 6465 6620 5f5f  core..    def __
+000059f0: 656e 7465 725f 5f28 7365 6c66 293a 0a20  enter__(self):. 
+00005a00: 2020 2020 2020 2023 2054 6869 7264 2070         # Third p
+00005a10: 6172 7479 206d 6f64 756c 6573 0a20 2020  arty modules.   
+00005a20: 2020 2020 2066 726f 6d20 6e75 6d65 7870       from numexp
+00005a30: 7220 696d 706f 7274 2028 0a20 2020 2020  r import (.     
+00005a40: 2020 2020 2020 204d 4158 5f54 4852 4541         MAX_THREA
+00005a50: 4453 2c0a 2020 2020 2020 2020 2020 2020  DS,.            
+00005a60: 7365 745f 6e75 6d5f 7468 7265 6164 732c  set_num_threads,
+00005a70: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00005a80: 2020 2020 7365 6c66 2e5f 6e75 6d5f 636f      self._num_co
+00005a90: 7265 5f6f 7267 203d 2073 6574 5f6e 756d  re_org = set_num
+00005aa0: 5f74 6872 6561 6473 280a 2020 2020 2020  _threads(.      
+00005ab0: 2020 2020 2020 6d69 6e28 7365 6c66 2e5f        min(self._
+00005ac0: 6e75 6d5f 636f 7265 2c20 4d41 585f 5448  num_core, MAX_TH
+00005ad0: 5245 4144 5329 290a 0a20 2020 2064 6566  READS))..    def
+00005ae0: 205f 5f65 7869 745f 5f28 7365 6c66 2c20   __exit__(self, 
+00005af0: 6578 635f 7479 7065 2c20 6578 635f 7661  exc_type, exc_va
+00005b00: 6c75 652c 2074 7261 6365 6261 636b 293a  lue, traceback):
+00005b10: 0a20 2020 2020 2020 2023 2054 6869 7264  .        # Third
+00005b20: 2070 6172 7479 206d 6f64 756c 6573 0a20   party modules. 
+00005b30: 2020 2020 2020 2066 726f 6d20 6e75 6d65         from nume
+00005b40: 7870 7220 696d 706f 7274 2073 6574 5f6e  xpr import set_n
+00005b50: 756d 5f74 6872 6561 6473 0a0a 2020 2020  um_threads..    
+00005b60: 2020 2020 7365 745f 6e75 6d5f 7468 7265      set_num_thre
+00005b70: 6164 7328 7365 6c66 2e5f 6e75 6d5f 636f  ads(self._num_co
+00005b80: 7265 5f6f 7267 290a 0a0a 636c 6173 7320  re_org)...class 
+00005b90: 546f 6d6f 3a0a 2020 2020 2222 2252 6563  Tomo:.    """Rec
+00005ba0: 6f6e 7374 7275 6374 2061 2073 6574 206f  onstruct a set o
+00005bb0: 6620 746f 6d6f 6772 6170 6869 6320 696d  f tomographic im
+00005bc0: 6167 6573 2e22 2222 0a0a 2020 2020 6465  ages."""..    de
+00005bd0: 6620 5f5f 696e 6974 5f5f 280a 2020 2020  f __init__(.    
+00005be0: 2020 2020 2020 2020 7365 6c66 2c20 696e          self, in
+00005bf0: 7465 7261 6374 6976 653d 4661 6c73 652c  teractive=False,
+00005c00: 206e 756d 5f63 6f72 653d 2d31 2c20 6f75   num_core=-1, ou
+00005c10: 7470 7574 5f66 6f6c 6465 723d 272e 272c  tput_folder='.',
+00005c20: 0a20 2020 2020 2020 2020 2020 2073 6176  .            sav
+00005c30: 655f 6669 6773 3d27 6e6f 272c 2074 6573  e_figs='no', tes
+00005c40: 745f 6d6f 6465 3d46 616c 7365 293a 0a20  t_mode=False):. 
+00005c50: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00005c60: 2020 2049 6e69 7469 616c 697a 6520 546f     Initialize To
+00005c70: 6d6f 2e0a 0a20 2020 2020 2020 203a 7061  mo...        :pa
+00005c80: 7261 6d20 696e 7465 7261 6374 6976 653a  ram interactive:
+00005c90: 2041 6c6c 6f77 7320 666f 7220 7573 6572   Allows for user
+00005ca0: 2069 6e74 6572 6163 7469 6f6e 732c 0a20   interactions,. 
+00005cb0: 2020 2020 2020 2020 2020 2064 6566 6175             defau
+00005cc0: 6c74 7320 746f 2046 616c 7365 2e0a 2020  lts to False..  
+00005cd0: 2020 2020 2020 3a74 7970 6520 696e 7465        :type inte
+00005ce0: 7261 6374 6976 653a 2062 6f6f 6c2c 206f  ractive: bool, o
+00005cf0: 7074 696f 6e61 6c0a 2020 2020 2020 2020  ptional.        
+00005d00: 3a70 6172 616d 206e 756d 5f63 6f72 653a  :param num_core:
+00005d10: 204e 756d 6265 7220 6f66 2070 726f 6365   Number of proce
+00005d20: 7373 6f72 730a 2020 2020 2020 2020 3a74  ssors.        :t
+00005d30: 7970 6520 6e75 6d5f 636f 7265 3a20 696e  ype num_core: in
+00005d40: 740a 2020 2020 2020 2020 3a70 6172 616d  t.        :param
+00005d50: 206f 7574 7075 745f 666f 6c64 6572 3a20   output_folder: 
+00005d60: 4f75 7470 7574 2066 6f6c 6465 7220 6e61  Output folder na
+00005d70: 6d65 2c20 6465 6661 756c 7473 2074 6f20  me, defaults to 
+00005d80: 272e 272e 0a20 2020 2020 2020 203a 7479  '.'..        :ty
+00005d90: 7065 206f 7574 7075 745f 666f 6c64 6572  pe output_folder
+00005da0: 3a3a 2073 7472 2c20 6f70 7469 6f6e 616c  :: str, optional
+00005db0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+00005dc0: 7361 7665 5f66 6967 733a 2053 6166 6520  save_figs: Safe 
+00005dd0: 6669 6775 7265 7320 746f 2066 696c 6520  figures to file 
+00005de0: 2827 7965 7327 206f 7220 276f 6e6c 7927  ('yes' or 'only'
+00005df0: 2920 616e 642f 6f72 0a20 2020 2020 2020  ) and/or.       
+00005e00: 2020 2020 2064 6973 706c 6179 2066 6967       display fig
+00005e10: 7572 6573 2028 2779 6573 2720 6f72 2027  ures ('yes' or '
+00005e20: 6e6f 2729 2c20 6465 6661 756c 7473 2074  no'), defaults t
+00005e30: 6f20 276e 6f27 2e0a 2020 2020 2020 2020  o 'no'..        
+00005e40: 3a74 7970 6520 7361 7665 5f66 6967 733a  :type save_figs:
+00005e50: 204c 6974 6572 616c 5b27 7965 7327 2c20   Literal['yes', 
+00005e60: 276e 6f27 2c20 276f 6e6c 7927 5d2c 206f  'no', 'only'], o
+00005e70: 7074 696f 6e61 6c0a 2020 2020 2020 2020  ptional.        
+00005e80: 3a70 6172 616d 2074 6573 745f 6d6f 6465  :param test_mode
+00005e90: 3a20 5275 6e20 696e 2074 6573 7420 6d6f  : Run in test mo
+00005ea0: 6465 2028 6e6f 6e2d 696e 7465 7261 6374  de (non-interact
+00005eb0: 6976 656c 7929 2c20 6465 6661 756c 7473  ively), defaults
+00005ec0: 0a20 2020 2020 2020 2020 2020 2074 6f20  .            to 
+00005ed0: 4661 6c73 650a 2020 2020 2020 2020 3a74  False.        :t
+00005ee0: 7970 6520 7465 7374 5f6d 6f64 653a 2062  ype test_mode: b
+00005ef0: 6f6f 6c2c 206f 7074 696f 6e61 6c0a 2020  ool, optional.  
+00005f00: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00005f10: 2020 2320 5379 7374 656d 206d 6f64 756c    # System modul
+00005f20: 6573 0a20 2020 2020 2020 2066 726f 6d20  es.        from 
+00005f30: 6c6f 6767 696e 6720 696d 706f 7274 2067  logging import g
+00005f40: 6574 4c6f 6767 6572 0a20 2020 2020 2020  etLogger.       
+00005f50: 2066 726f 6d20 6d75 6c74 6970 726f 6365   from multiproce
+00005f60: 7373 696e 6720 696d 706f 7274 2063 7075  ssing import cpu
+00005f70: 5f63 6f75 6e74 0a0a 2020 2020 2020 2020  _count..        
+00005f80: 7365 6c66 2e5f 5f6e 616d 655f 5f20 3d20  self.__name__ = 
+00005f90: 7365 6c66 2e5f 5f63 6c61 7373 5f5f 2e5f  self.__class__._
+00005fa0: 5f6e 616d 655f 5f0a 2020 2020 2020 2020  _name__.        
+00005fb0: 7365 6c66 2e5f 6c6f 6767 6572 203d 2067  self._logger = g
+00005fc0: 6574 4c6f 6767 6572 2873 656c 662e 5f5f  etLogger(self.__
+00005fd0: 6e61 6d65 5f5f 290a 2020 2020 2020 2020  name__).        
+00005fe0: 7365 6c66 2e5f 6c6f 6767 6572 2e70 726f  self._logger.pro
+00005ff0: 7061 6761 7465 203d 2046 616c 7365 0a0a  pagate = False..
+00006000: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
+00006010: 7369 6e73 7461 6e63 6528 696e 7465 7261  sinstance(intera
+00006020: 6374 6976 652c 2062 6f6f 6c29 3a0a 2020  ctive, bool):.  
+00006030: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00006040: 5661 6c75 6545 7272 6f72 2866 2749 6e76  ValueError(f'Inv
+00006050: 616c 6964 2070 6172 616d 6574 6572 2069  alid parameter i
+00006060: 6e74 6572 6163 7469 7665 2028 7b69 6e74  nteractive ({int
+00006070: 6572 6163 7469 7665 7d29 2729 0a20 2020  eractive})').   
+00006080: 2020 2020 2073 656c 662e 5f69 6e74 6572       self._inter
+00006090: 6163 7469 7665 203d 2069 6e74 6572 6163  active = interac
+000060a0: 7469 7665 0a20 2020 2020 2020 2073 656c  tive.        sel
+000060b0: 662e 5f6e 756d 5f63 6f72 6520 3d20 6e75  f._num_core = nu
+000060c0: 6d5f 636f 7265 0a20 2020 2020 2020 2073  m_core.        s
+000060d0: 656c 662e 5f6f 7574 7075 745f 666f 6c64  elf._output_fold
+000060e0: 6572 203d 206f 735f 7061 7468 2e61 6273  er = os_path.abs
+000060f0: 7061 7468 286f 7574 7075 745f 666f 6c64  path(output_fold
+00006100: 6572 290a 2020 2020 2020 2020 6966 206e  er).        if n
+00006110: 6f74 206f 735f 7061 7468 2e69 7364 6972  ot os_path.isdir
+00006120: 2873 656c 662e 5f6f 7574 7075 745f 666f  (self._output_fo
+00006130: 6c64 6572 293a 0a20 2020 2020 2020 2020  lder):.         
+00006140: 2020 206d 6b64 6972 2873 656c 662e 5f6f     mkdir(self._o
+00006150: 7574 7075 745f 666f 6c64 6572 290a 2020  utput_folder).  
+00006160: 2020 2020 2020 6966 2073 656c 662e 5f69        if self._i
+00006170: 6e74 6572 6163 7469 7665 3a0a 2020 2020  nteractive:.    
+00006180: 2020 2020 2020 2020 7365 6c66 2e5f 7465          self._te
+00006190: 7374 5f6d 6f64 6520 3d20 4661 6c73 650a  st_mode = False.
+000061a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000061b0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+000061c0: 2069 7369 6e73 7461 6e63 6528 7465 7374   isinstance(test
+000061d0: 5f6d 6f64 652c 2062 6f6f 6c29 3a0a 2020  _mode, bool):.  
+000061e0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+000061f0: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
+00006200: 2749 6e76 616c 6964 2070 6172 616d 6574  'Invalid paramet
+00006210: 6572 2074 6573 745f 6d6f 6465 2028 7b74  er test_mode ({t
+00006220: 6573 745f 6d6f 6465 7d29 2729 0a20 2020  est_mode})').   
+00006230: 2020 2020 2020 2020 2073 656c 662e 5f74           self._t
+00006240: 6573 745f 6d6f 6465 203d 2074 6573 745f  est_mode = test_
+00006250: 6d6f 6465 0a20 2020 2020 2020 2073 656c  mode.        sel
+00006260: 662e 5f74 6573 745f 636f 6e66 6967 203d  f._test_config =
+00006270: 207b 7d0a 2020 2020 2020 2020 6966 2073   {}.        if s
+00006280: 656c 662e 5f74 6573 745f 6d6f 6465 3a0a  elf._test_mode:.
+00006290: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+000062a0: 6176 655f 6669 6773 2021 3d20 276f 6e6c  ave_figs != 'onl
+000062b0: 7927 3a0a 2020 2020 2020 2020 2020 2020  y':.            
+000062c0: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+000062d0: 2e77 6172 6e69 6e67 2827 4967 6e6f 7269  .warning('Ignori
+000062e0: 6e67 2073 6176 655f 6669 6773 2069 6e20  ng save_figs in 
+000062f0: 7465 7374 206d 6f64 6527 290a 2020 2020  test mode').    
+00006300: 2020 2020 2020 2020 7361 7665 5f66 6967          save_fig
+00006310: 7320 3d20 276f 6e6c 7927 0a20 2020 2020  s = 'only'.     
+00006320: 2020 2069 6620 7361 7665 5f66 6967 7320     if save_figs 
+00006330: 3d3d 2027 6f6e 6c79 273a 0a20 2020 2020  == 'only':.     
+00006340: 2020 2020 2020 2073 656c 662e 5f73 6176         self._sav
+00006350: 655f 6f6e 6c79 203d 2054 7275 650a 2020  e_only = True.  
+00006360: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00006370: 7361 7665 5f66 6967 7320 3d20 5472 7565  save_figs = True
+00006380: 0a20 2020 2020 2020 2065 6c69 6620 7361  .        elif sa
+00006390: 7665 5f66 6967 7320 3d3d 2027 7965 7327  ve_figs == 'yes'
+000063a0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000063b0: 6c66 2e5f 7361 7665 5f6f 6e6c 7920 3d20  lf._save_only = 
+000063c0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+000063d0: 2020 7365 6c66 2e5f 7361 7665 5f66 6967    self._save_fig
+000063e0: 7320 3d20 5472 7565 0a20 2020 2020 2020  s = True.       
+000063f0: 2065 6c69 6620 7361 7665 5f66 6967 7320   elif save_figs 
+00006400: 3d3d 2027 6e6f 273a 0a20 2020 2020 2020  == 'no':.       
+00006410: 2020 2020 2073 656c 662e 5f73 6176 655f       self._save_
+00006420: 6f6e 6c79 203d 2046 616c 7365 0a20 2020  only = False.   
+00006430: 2020 2020 2020 2020 2073 656c 662e 5f73           self._s
+00006440: 6176 655f 6669 6773 203d 2046 616c 7365  ave_figs = False
+00006450: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00006460: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00006470: 2056 616c 7565 4572 726f 7228 6627 496e   ValueError(f'In
+00006480: 7661 6c69 6420 7061 7261 6d65 7465 7220  valid parameter 
+00006490: 7361 7665 5f66 6967 7320 287b 7361 7665  save_figs ({save
+000064a0: 5f66 6967 737d 2927 290a 2020 2020 2020  _figs})').      
+000064b0: 2020 6966 2073 656c 662e 5f73 6176 655f    if self._save_
+000064c0: 6f6e 6c79 3a0a 2020 2020 2020 2020 2020  only:.          
+000064d0: 2020 7365 6c66 2e5f 626c 6f63 6b20 3d20    self._block = 
+000064e0: 4661 6c73 650a 2020 2020 2020 2020 656c  False.        el
+000064f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00006500: 7365 6c66 2e5f 626c 6f63 6b20 3d20 5472  self._block = Tr
+00006510: 7565 0a20 2020 2020 2020 2069 6620 7365  ue.        if se
+00006520: 6c66 2e5f 6e75 6d5f 636f 7265 203d 3d20  lf._num_core == 
+00006530: 2d31 3a0a 2020 2020 2020 2020 2020 2020  -1:.            
+00006540: 7365 6c66 2e5f 6e75 6d5f 636f 7265 203d  self._num_core =
+00006550: 2063 7075 5f63 6f75 6e74 2829 0a20 2020   cpu_count().   
+00006560: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+00006570: 7374 616e 6365 2873 656c 662e 5f6e 756d  stance(self._num
+00006580: 5f63 6f72 652c 2069 6e74 2920 6f72 2073  _core, int) or s
+00006590: 656c 662e 5f6e 756d 5f63 6f72 6520 3c20  elf._num_core < 
+000065a0: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
+000065b0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+000065c0: 6627 496e 7661 6c69 6420 7061 7261 6d65  f'Invalid parame
+000065d0: 7465 7220 6e75 6d5f 636f 7265 2028 7b6e  ter num_core ({n
+000065e0: 756d 5f63 6f72 657d 2927 290a 2020 2020  um_core})').    
+000065f0: 2020 2020 6966 2073 656c 662e 5f6e 756d      if self._num
+00006600: 5f63 6f72 6520 3e20 6370 755f 636f 756e  _core > cpu_coun
+00006610: 7428 293a 0a20 2020 2020 2020 2020 2020  t():.           
+00006620: 2073 656c 662e 5f6c 6f67 6765 722e 7761   self._logger.wa
+00006630: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
+00006640: 2020 2020 2020 2066 276e 756d 5f63 6f72         f'num_cor
+00006650: 6520 3d20 7b73 656c 662e 5f6e 756d 5f63  e = {self._num_c
+00006660: 6f72 657d 2069 7320 6c61 7267 6572 2074  ore} is larger t
+00006670: 6861 6e20 7468 6520 6e75 6d62 6572 2027  han the number '
+00006680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006690: 202b 2066 276f 6620 6176 6169 6c61 626c   + f'of availabl
+000066a0: 6520 7072 6f63 6573 736f 7273 2061 6e64  e processors and
+000066b0: 2072 6564 7563 6564 2074 6f20 7b63 7075   reduced to {cpu
+000066c0: 5f63 6f75 6e74 2829 7d27 290a 2020 2020  _count()}').    
+000066d0: 2020 2020 2020 2020 7365 6c66 2e5f 6e75          self._nu
+000066e0: 6d5f 636f 7265 203d 2063 7075 5f63 6f75  m_core = cpu_cou
+000066f0: 6e74 2829 0a0a 2020 2020 6465 6620 6765  nt()..    def ge
+00006700: 6e5f 7265 6475 6365 645f 6461 7461 2873  n_reduced_data(s
+00006710: 656c 662c 2064 6174 612c 2069 6d67 5f78  elf, data, img_x
+00006720: 5f62 6f75 6e64 733d 4e6f 6e65 2c20 6465  _bounds=None, de
+00006730: 6c74 615f 7468 6574 613d 4e6f 6e65 293a  lta_theta=None):
+00006740: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00006750: 2020 2020 2047 656e 6572 6174 6520 7468       Generate th
+00006760: 6520 7265 6475 6365 6420 746f 6d6f 6772  e reduced tomogr
+00006770: 6170 6879 2069 6d61 6765 732e 0a0a 2020  aphy images...  
+00006780: 2020 2020 2020 3a70 6172 616d 2064 6174        :param dat
+00006790: 613a 2044 6174 6120 6f62 6a65 6374 2063  a: Data object c
+000067a0: 6f6e 7461 696e 696e 6720 7468 6520 7261  ontaining the ra
+000067b0: 7720 6461 7461 2069 6e66 6f20 616e 640a  w data info and.
+000067c0: 2020 2020 2020 2020 2020 2020 6d65 7461              meta
+000067d0: 6461 7461 2072 6571 7569 7265 6420 666f  data required fo
+000067e0: 7220 6120 746f 6d6f 6772 6170 6879 2064  r a tomography d
+000067f0: 6174 6120 7265 6475 6374 696f 6e0a 2020  ata reduction.  
+00006800: 2020 2020 2020 3a74 7970 6520 6461 7461        :type data
+00006810: 3a20 6e65 7875 7366 6f72 6d61 742e 6e65  : nexusformat.ne
+00006820: 7875 732e 4e58 726f 6f74 0a20 2020 2020  xus.NXroot.     
+00006830: 2020 203a 7061 7261 6d20 696d 675f 785f     :param img_x_
+00006840: 626f 756e 6473 3a20 4465 7465 6374 6f72  bounds: Detector
+00006850: 2069 6d61 6765 2062 6f75 6e64 7320 696e   image bounds in
+00006860: 2074 6865 2078 2d64 6972 6563 7469 6f6e   the x-direction
+00006870: 0a20 2020 2020 2020 203a 7479 7065 2069  .        :type i
+00006880: 6d67 5f78 5f62 6f75 6e64 733a 2074 7570  mg_x_bounds: tup
+00006890: 6c65 2869 6e74 2c20 696e 7429 2c20 6c69  le(int, int), li
+000068a0: 7374 5b69 6e74 5d2c 206f 7074 696f 6e61  st[int], optiona
+000068b0: 6c0a 2020 2020 2020 2020 3a70 6172 616d  l.        :param
+000068c0: 2064 656c 7461 5f74 6865 7461 3a20 526f   delta_theta: Ro
+000068d0: 7461 7469 6f6e 2061 6e67 6c65 2073 7465  tation angle ste
+000068e0: 7020 7369 7a65 0a20 2020 2020 2020 203a  p size.        :
+000068f0: 7479 7065 2064 656c 7461 5f74 6865 7461  type delta_theta
+00006900: 3a20 666c 6f61 742c 206f 7074 696f 6e61  : float, optiona
+00006910: 6c0a 2020 2020 2020 2020 3a72 6574 7572  l.        :retur
+00006920: 6e3a 2052 6564 7563 6564 2074 6f6d 6f67  n: Reduced tomog
+00006930: 7261 7068 7920 6461 7461 0a20 2020 2020  raphy data.     
+00006940: 2020 203a 7274 7970 653a 206e 6578 7573     :rtype: nexus
+00006950: 666f 726d 6174 2e6e 6578 7573 2e4e 5872  format.nexus.NXr
+00006960: 6f6f 740a 2020 2020 2020 2020 2222 220a  oot.        """.
+00006970: 2020 2020 2020 2020 2320 5468 6972 6420          # Third 
+00006980: 7061 7274 7920 6d6f 6475 6c65 730a 2020  party modules.  
+00006990: 2020 2020 2020 6672 6f6d 206e 6578 7573        from nexus
+000069a0: 666f 726d 6174 2e6e 6578 7573 2069 6d70  format.nexus imp
+000069b0: 6f72 7420 280a 2020 2020 2020 2020 2020  ort (.          
+000069c0: 2020 4e58 6461 7461 2c0a 2020 2020 2020    NXdata,.      
+000069d0: 2020 2020 2020 4e58 7072 6f63 6573 732c        NXprocess,
+000069e0: 0a20 2020 2020 2020 2020 2020 204e 5872  .            NXr
+000069f0: 6f6f 742c 0a20 2020 2020 2020 2029 0a0a  oot,.        )..
+00006a00: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+00006a10: 6767 6572 2e69 6e66 6f28 2747 656e 6572  gger.info('Gener
+00006a20: 6174 6520 7468 6520 7265 6475 6365 6420  ate the reduced 
+00006a30: 746f 6d6f 6772 6170 6879 2069 6d61 6765  tomography image
+00006a40: 7327 290a 2020 2020 2020 2020 6966 2069  s').        if i
+00006a50: 6d67 5f78 5f62 6f75 6e64 7320 6973 206e  mg_x_bounds is n
+00006a60: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00006a70: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+00006a80: 7374 616e 6365 2869 6d67 5f78 5f62 6f75  stance(img_x_bou
+00006a90: 6e64 732c 2028 7475 706c 652c 206c 6973  nds, (tuple, lis
+00006aa0: 7429 293a 0a20 2020 2020 2020 2020 2020  t)):.           
+00006ab0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00006ac0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00006ad0: 2020 2020 2020 2020 2020 2066 2749 6e76             f'Inv
+00006ae0: 616c 6964 2070 6172 616d 6574 6572 2069  alid parameter i
+00006af0: 6d67 5f78 5f62 6f75 6e64 7320 287b 696d  mg_x_bounds ({im
+00006b00: 675f 785f 626f 756e 6473 7d29 2729 0a20  g_x_bounds})'). 
+00006b10: 2020 2020 2020 2020 2020 2069 6d67 5f78             img_x
+00006b20: 5f62 6f75 6e64 7320 3d20 7475 706c 6528  _bounds = tuple(
+00006b30: 696d 675f 785f 626f 756e 6473 290a 0a20  img_x_bounds).. 
+00006b40: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00006b50: 616e 6365 2864 6174 612c 204e 5872 6f6f  ance(data, NXroo
+00006b60: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+00006b70: 6e78 656e 7472 7920 3d20 6461 7461 5b64  nxentry = data[d
+00006b80: 6174 612e 6174 7472 735b 2764 6566 6175  ata.attrs['defau
+00006b90: 6c74 275d 5d0a 2020 2020 2020 2020 656c  lt']].        el
+00006ba0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00006bb0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00006bc0: 2866 2749 6e76 616c 6964 2070 6172 616d  (f'Invalid param
+00006bd0: 6574 6572 2064 6174 6120 287b 6461 7461  eter data ({data
+00006be0: 7d29 2729 0a0a 2020 2020 2020 2020 2320  })')..        # 
+00006bf0: 4372 6561 7465 2061 6e20 4e58 7072 6f63  Create an NXproc
+00006c00: 6573 7320 746f 2073 746f 7265 2064 6174  ess to store dat
+00006c10: 6120 7265 6475 6374 696f 6e20 286d 6574  a reduction (met
+00006c20: 6129 6461 7461 0a20 2020 2020 2020 2072  a)data.        r
+00006c30: 6564 7563 6564 5f64 6174 6120 3d20 4e58  educed_data = NX
+00006c40: 7072 6f63 6573 7328 290a 0a20 2020 2020  process()..     
+00006c50: 2020 2023 2047 656e 6572 6174 6520 6461     # Generate da
+00006c60: 726b 2066 6965 6c64 0a20 2020 2020 2020  rk field.       
+00006c70: 2069 6620 2764 6172 6b5f 6669 656c 6427   if 'dark_field'
+00006c80: 2069 6e20 6e78 656e 7472 795b 2773 7065   in nxentry['spe
+00006c90: 635f 7363 616e 7327 5d3a 0a20 2020 2020  c_scans']:.     
+00006ca0: 2020 2020 2020 2072 6564 7563 6564 5f64         reduced_d
+00006cb0: 6174 6120 3d20 7365 6c66 2e5f 6765 6e5f  ata = self._gen_
+00006cc0: 6461 726b 286e 7865 6e74 7279 2c20 7265  dark(nxentry, re
+00006cd0: 6475 6365 645f 6461 7461 290a 0a20 2020  duced_data)..   
+00006ce0: 2020 2020 2023 2047 656e 6572 6174 6520       # Generate 
+00006cf0: 6272 6967 6874 2066 6965 6c64 0a20 2020  bright field.   
+00006d00: 2020 2020 2072 6564 7563 6564 5f64 6174       reduced_dat
+00006d10: 6120 3d20 7365 6c66 2e5f 6765 6e5f 6272  a = self._gen_br
+00006d20: 6967 6874 286e 7865 6e74 7279 2c20 7265  ight(nxentry, re
+00006d30: 6475 6365 645f 6461 7461 290a 0a20 2020  duced_data)..   
+00006d40: 2020 2020 2023 2047 6574 2072 6f74 6174       # Get rotat
+00006d50: 696f 6e20 616e 676c 6573 2066 6f72 2069  ion angles for i
+00006d60: 6d61 6765 2073 7461 636b 730a 2020 2020  mage stacks.    
+00006d70: 2020 2020 7468 6574 6173 203d 2073 656c      thetas = sel
+00006d80: 662e 5f67 656e 5f74 6865 7461 7328 6e78  f._gen_thetas(nx
+00006d90: 656e 7472 7929 0a0a 2020 2020 2020 2020  entry)..        
+00006da0: 2320 4765 7420 7468 6520 696d 6167 6520  # Get the image 
+00006db0: 7374 6163 6b20 6d61 736b 2074 6f20 7265  stack mask to re
+00006dc0: 6d6f 7665 2062 6164 2069 6d61 6765 7320  move bad images 
+00006dd0: 6672 6f6d 2073 7461 636b 0a20 2020 2020  from stack.     
+00006de0: 2020 2069 6d61 6765 5f6d 6173 6b20 3d20     image_mask = 
+00006df0: 4e6f 6e65 0a20 2020 2020 2020 2064 726f  None.        dro
+00006e00: 705f 6672 6163 7469 6f6e 203d 2030 2023  p_fraction = 0 #
+00006e10: 2066 7261 6374 696f 6e20 6f66 2069 6d61   fraction of ima
+00006e20: 6765 7320 6472 6f70 7065 6420 6173 2061  ges dropped as a
+00006e30: 2070 6572 6365 6e74 6167 650a 2020 2020   percentage.    
+00006e40: 2020 2020 6966 2064 726f 705f 6672 6163      if drop_frac
+00006e50: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+00006e60: 2020 6966 2064 656c 7461 5f74 6865 7461    if delta_theta
+00006e70: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00006e80: 2020 2020 2020 2020 2020 2020 2020 6465                de
+00006e90: 6c74 615f 7468 6574 6120 3d20 4e6f 6e65  lta_theta = None
+00006ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006eb0: 2073 656c 662e 5f6c 6f67 6765 722e 7761   self._logger.wa
+00006ec0: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
+00006ed0: 2020 2020 2020 2020 2020 2027 4967 6e6f             'Igno
+00006ee0: 7265 2064 656c 7461 5f74 6865 7461 2077  re delta_theta w
+00006ef0: 6865 6e20 616e 2069 6d61 6765 206d 6173  hen an image mas
+00006f00: 6b20 6973 2075 7365 6427 290a 2020 2020  k is used').    
+00006f10: 2020 2020 2020 2020 6e70 2e72 616e 646f          np.rando
+00006f20: 6d2e 7365 6564 2830 290a 2020 2020 2020  m.seed(0).      
+00006f30: 2020 2020 2020 696d 6167 655f 6d61 736b        image_mask
+00006f40: 203d 206e 702e 7768 6572 6528 6e70 2e72   = np.where(np.r
+00006f50: 616e 646f 6d2e 7261 6e64 280a 2020 2020  andom.rand(.    
+00006f60: 2020 2020 2020 2020 2020 2020 6c65 6e28              len(
+00006f70: 7468 6574 6173 2929 203c 2064 726f 705f  thetas)) < drop_
+00006f80: 6672 6163 7469 6f6e 2f31 3030 2c20 302c  fraction/100, 0,
+00006f90: 2031 292e 6173 7479 7065 2862 6f6f 6c29   1).astype(bool)
+00006fa0: 0a0a 2020 2020 2020 2020 2320 5365 7420  ..        # Set 
+00006fb0: 7a6f 6f6d 2061 6e64 2f6f 7220 726f 7461  zoom and/or rota
+00006fc0: 7469 6f6e 2061 6e67 6c65 2069 6e74 6572  tion angle inter
+00006fd0: 7661 6c20 746f 2072 6564 7563 6520 6d65  val to reduce me
+00006fe0: 6d6f 7279 0a20 2020 2020 2020 2023 2020  mory.        #  
+00006ff0: 2020 2072 6571 7569 7265 6d65 6e74 0a20     requirement. 
+00007000: 2020 2020 2020 2069 6620 696d 6167 655f         if image_
+00007010: 6d61 736b 2069 7320 4e6f 6e65 3a0a 2020  mask is None:.  
+00007020: 2020 2020 2020 2020 2020 7a6f 6f6d 5f70            zoom_p
+00007030: 6572 632c 2064 656c 7461 5f74 6865 7461  erc, delta_theta
+00007040: 203d 2073 656c 662e 5f73 6574 5f7a 6f6f   = self._set_zoo
+00007050: 6d5f 6f72 5f64 656c 7461 5f74 6865 7461  m_or_delta_theta
+00007060: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00007070: 2020 7468 6574 6173 2c20 6465 6c74 615f    thetas, delta_
+00007080: 7468 6574 6129 0a20 2020 2020 2020 2020  theta).         
+00007090: 2020 2069 6620 6465 6c74 615f 7468 6574     if delta_thet
+000070a0: 6120 6973 206e 6f74 204e 6f6e 653a 0a20  a is not None:. 
+000070b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000070c0: 6d61 6765 5f6d 6173 6b20 3d20 6e70 2e61  mage_mask = np.a
+000070d0: 7361 7272 6179 280a 2020 2020 2020 2020  sarray(.        
+000070e0: 2020 2020 2020 2020 2020 2020 5b30 2069              [0 i
+000070f0: 6620 6925 6465 6c74 615f 7468 6574 6120  f i%delta_theta 
+00007100: 656c 7365 2031 0a20 2020 2020 2020 2020  else 1.         
+00007110: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00007120: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
+00007130: 6e28 7468 6574 6173 2929 5d2c 2064 7479  n(thetas))], dty
+00007140: 7065 3d62 6f6f 6c29 0a20 2020 2020 2020  pe=bool).       
+00007150: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
+00007160: 722e 6465 6275 6728 6627 7a6f 6f6d 5f70  r.debug(f'zoom_p
+00007170: 6572 633a 207b 7a6f 6f6d 5f70 6572 637d  erc: {zoom_perc}
+00007180: 2729 0a20 2020 2020 2020 2020 2020 2073  ').            s
+00007190: 656c 662e 5f6c 6f67 6765 722e 6465 6275  elf._logger.debu
+000071a0: 6728 6627 6465 6c74 615f 7468 6574 613a  g(f'delta_theta:
+000071b0: 207b 6465 6c74 615f 7468 6574 617d 2729   {delta_theta}')
+000071c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000071d0: 7a6f 6f6d 5f70 6572 6320 6973 206e 6f74  zoom_perc is not
+000071e0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000071f0: 2020 2020 2020 2072 6564 7563 6564 5f64         reduced_d
+00007200: 6174 612e 6174 7472 735b 277a 6f6f 6d5f  ata.attrs['zoom_
+00007210: 7065 7263 275d 203d 207a 6f6f 6d5f 7065  perc'] = zoom_pe
+00007220: 7263 0a20 2020 2020 2020 2069 6620 696d  rc.        if im
+00007230: 6167 655f 6d61 736b 2069 7320 6e6f 7420  age_mask is not 
+00007240: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00007250: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e64    self._logger.d
+00007260: 6562 7567 2866 2769 6d61 6765 5f6d 6173  ebug(f'image_mas
+00007270: 6b20 3d20 7b69 6d61 6765 5f6d 6173 6b7d  k = {image_mask}
+00007280: 2729 0a20 2020 2020 2020 2020 2020 2072  ').            r
+00007290: 6564 7563 6564 5f64 6174 615b 2769 6d61  educed_data['ima
+000072a0: 6765 5f6d 6173 6b27 5d20 3d20 696d 6167  ge_mask'] = imag
+000072b0: 655f 6d61 736b 0a20 2020 2020 2020 2020  e_mask.         
+000072c0: 2020 2074 6865 7461 7320 3d20 7468 6574     thetas = thet
+000072d0: 6173 5b69 6d61 6765 5f6d 6173 6b5d 0a20  as[image_mask]. 
+000072e0: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
+000072f0: 6765 722e 6465 6275 6728 6627 7468 6574  ger.debug(f'thet
+00007300: 6173 203d 207b 7468 6574 6173 7d27 290a  as = {thetas}').
+00007310: 2020 2020 2020 2020 7265 6475 6365 645f          reduced_
+00007320: 6461 7461 5b27 726f 7461 7469 6f6e 5f61  data['rotation_a
+00007330: 6e67 6c65 275d 203d 2074 6865 7461 730a  ngle'] = thetas.
+00007340: 0a20 2020 2020 2020 2023 2053 6574 2076  .        # Set v
+00007350: 6572 7469 6361 6c20 6465 7465 6374 6f72  ertical detector
+00007360: 2062 6f75 6e64 7320 666f 7220 696d 6167   bounds for imag
+00007370: 6520 7374 6163 6b0a 2020 2020 2020 2020  e stack.        
+00007380: 696d 675f 785f 626f 756e 6473 203d 2073  img_x_bounds = s
+00007390: 656c 662e 5f73 6574 5f64 6574 6563 746f  elf._set_detecto
+000073a0: 725f 626f 756e 6473 280a 2020 2020 2020  r_bounds(.      
+000073b0: 2020 2020 2020 6e78 656e 7472 792c 2072        nxentry, r
+000073c0: 6564 7563 6564 5f64 6174 612c 2074 6865  educed_data, the
+000073d0: 7461 735b 305d 2c20 696d 675f 785f 626f  tas[0], img_x_bo
+000073e0: 756e 6473 3d69 6d67 5f78 5f62 6f75 6e64  unds=img_x_bound
+000073f0: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
+00007400: 5f6c 6f67 6765 722e 696e 666f 2866 2769  _logger.info(f'i
+00007410: 6d67 5f78 5f62 6f75 6e64 7320 3d20 7b69  mg_x_bounds = {i
+00007420: 6d67 5f78 5f62 6f75 6e64 737d 2729 0a20  mg_x_bounds}'). 
+00007430: 2020 2020 2020 2072 6564 7563 6564 5f64         reduced_d
+00007440: 6174 615b 2769 6d67 5f78 5f62 6f75 6e64  ata['img_x_bound
+00007450: 7327 5d20 3d20 696d 675f 785f 626f 756e  s'] = img_x_boun
+00007460: 6473 0a0a 2020 2020 2020 2020 2320 4765  ds..        # Ge
+00007470: 6e65 7261 7465 2072 6564 7563 6564 2074  nerate reduced t
+00007480: 6f6d 6f67 7261 7068 7920 6669 656c 6473  omography fields
+00007490: 0a20 2020 2020 2020 2072 6564 7563 6564  .        reduced
+000074a0: 5f64 6174 6120 3d20 7365 6c66 2e5f 6765  _data = self._ge
+000074b0: 6e5f 746f 6d6f 286e 7865 6e74 7279 2c20  n_tomo(nxentry, 
+000074c0: 7265 6475 6365 645f 6461 7461 290a 0a20  reduced_data).. 
+000074d0: 2020 2020 2020 2023 2043 7265 6174 6520         # Create 
+000074e0: 6120 636f 7079 206f 6620 7468 6520 696e  a copy of the in
+000074f0: 7075 7420 4e65 7875 7320 6f62 6a65 6374  put Nexus object
+00007500: 2061 6e64 2072 656d 6f76 6520 7261 7720   and remove raw 
+00007510: 616e 640a 2020 2020 2020 2020 2320 2020  and.        #   
+00007520: 2020 616e 7920 6578 6973 7469 6e67 2072    any existing r
+00007530: 6564 7563 6564 2064 6174 610a 2020 2020  educed data.    
+00007540: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00007550: 6528 6461 7461 2c20 4e58 726f 6f74 293a  e(data, NXroot):
+00007560: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00007570: 6c75 6465 5f69 7465 6d73 203d 205b 0a20  lude_items = [. 
+00007580: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00007590: 277b 6e78 656e 7472 792e 6e78 6e61 6d65  '{nxentry.nxname
+000075a0: 7d2f 7265 6475 6365 645f 6461 7461 2f64  }/reduced_data/d
+000075b0: 6174 6127 2c0a 2020 2020 2020 2020 2020  ata',.          
+000075c0: 2020 2020 2020 6627 7b6e 7865 6e74 7279        f'{nxentry
+000075d0: 2e6e 786e 616d 657d 2f69 6e73 7472 756d  .nxname}/instrum
+000075e0: 656e 742f 6465 7465 6374 6f72 2f64 6174  ent/detector/dat
+000075f0: 6127 2c0a 2020 2020 2020 2020 2020 2020  a',.            
+00007600: 2020 2020 6627 7b6e 7865 6e74 7279 2e6e      f'{nxentry.n
+00007610: 786e 616d 657d 2f69 6e73 7472 756d 656e  xname}/instrumen
+00007620: 742f 6465 7465 6374 6f72 2f69 6d61 6765  t/detector/image
+00007630: 5f6b 6579 272c 0a20 2020 2020 2020 2020  _key',.         
+00007640: 2020 2020 2020 2066 277b 6e78 656e 7472         f'{nxentr
+00007650: 792e 6e78 6e61 6d65 7d2f 696e 7374 7275  y.nxname}/instru
+00007660: 6d65 6e74 2f64 6574 6563 746f 722f 7365  ment/detector/se
+00007670: 7175 656e 6365 5f6e 756d 6265 7227 2c0a  quence_number',.
+00007680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007690: 6627 7b6e 7865 6e74 7279 2e6e 786e 616d  f'{nxentry.nxnam
+000076a0: 657d 2f73 616d 706c 652f 726f 7461 7469  e}/sample/rotati
+000076b0: 6f6e 5f61 6e67 6c65 272c 0a20 2020 2020  on_angle',.     
+000076c0: 2020 2020 2020 2020 2020 2066 277b 6e78             f'{nx
+000076d0: 656e 7472 792e 6e78 6e61 6d65 7d2f 7361  entry.nxname}/sa
+000076e0: 6d70 6c65 2f78 5f74 7261 6e73 6c61 7469  mple/x_translati
+000076f0: 6f6e 272c 0a20 2020 2020 2020 2020 2020  on',.           
+00007700: 2020 2020 2066 277b 6e78 656e 7472 792e       f'{nxentry.
+00007710: 6e78 6e61 6d65 7d2f 7361 6d70 6c65 2f7a  nxname}/sample/z
+00007720: 5f74 7261 6e73 6c61 7469 6f6e 272c 0a20  _translation',. 
+00007730: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00007740: 277b 6e78 656e 7472 792e 6e78 6e61 6d65  '{nxentry.nxname
+00007750: 7d2f 6461 7461 2f64 6174 6127 2c0a 2020  }/data/data',.  
+00007760: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00007770: 7b6e 7865 6e74 7279 2e6e 786e 616d 657d  {nxentry.nxname}
+00007780: 2f64 6174 612f 696d 6167 655f 6b65 7927  /data/image_key'
+00007790: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000077a0: 2020 6627 7b6e 7865 6e74 7279 2e6e 786e    f'{nxentry.nxn
+000077b0: 616d 657d 2f64 6174 612f 726f 7461 7469  ame}/data/rotati
+000077c0: 6f6e 5f61 6e67 6c65 272c 0a20 2020 2020  on_angle',.     
+000077d0: 2020 2020 2020 2020 2020 2066 277b 6e78             f'{nx
+000077e0: 656e 7472 792e 6e78 6e61 6d65 7d2f 6461  entry.nxname}/da
+000077f0: 7461 2f78 5f74 7261 6e73 6c61 7469 6f6e  ta/x_translation
+00007800: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00007810: 2020 2066 277b 6e78 656e 7472 792e 6e78     f'{nxentry.nx
+00007820: 6e61 6d65 7d2f 6461 7461 2f7a 5f74 7261  name}/data/z_tra
+00007830: 6e73 6c61 7469 6f6e 272c 0a20 2020 2020  nslation',.     
+00007840: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+00007850: 2020 2020 206e 7872 6f6f 7420 3d20 6e78       nxroot = nx
+00007860: 636f 7079 2864 6174 612c 2065 7863 6c75  copy(data, exclu
+00007870: 6465 5f6e 7870 6174 6873 3d65 7863 6c75  de_nxpaths=exclu
+00007880: 6465 5f69 7465 6d73 290a 2020 2020 2020  de_items).      
+00007890: 2020 2020 2020 6e78 656e 7472 7920 3d20        nxentry = 
+000078a0: 6e78 726f 6f74 5b6e 7872 6f6f 742e 6174  nxroot[nxroot.at
+000078b0: 7472 735b 2764 6566 6175 6c74 275d 5d0a  trs['default']].
+000078c0: 0a20 2020 2020 2020 2023 2041 6464 2074  .        # Add t
+000078d0: 6865 2072 6564 7563 6564 2064 6174 6120  he reduced data 
+000078e0: 4e58 7072 6f63 6573 730a 2020 2020 2020  NXprocess.      
+000078f0: 2020 6e78 656e 7472 792e 7265 6475 6365    nxentry.reduce
+00007900: 645f 6461 7461 203d 2072 6564 7563 6564  d_data = reduced
+00007910: 5f64 6174 610a 0a20 2020 2020 2020 2069  _data..        i
+00007920: 6620 2764 6174 6127 206e 6f74 2069 6e20  f 'data' not in 
+00007930: 6e78 656e 7472 793a 0a20 2020 2020 2020  nxentry:.       
+00007940: 2020 2020 206e 7865 6e74 7279 2e64 6174       nxentry.dat
+00007950: 6120 3d20 4e58 6461 7461 2829 0a20 2020  a = NXdata().   
+00007960: 2020 2020 206e 7865 6e74 7279 2e61 7474       nxentry.att
+00007970: 7273 5b27 6465 6661 756c 7427 5d20 3d20  rs['default'] = 
+00007980: 2764 6174 6127 0a20 2020 2020 2020 206e  'data'.        n
+00007990: 7865 6e74 7279 2e64 6174 612e 6d61 6b65  xentry.data.make
+000079a0: 6c69 6e6b 280a 2020 2020 2020 2020 2020  link(.          
+000079b0: 2020 6e78 656e 7472 792e 7265 6475 6365    nxentry.reduce
+000079c0: 645f 6461 7461 2e64 6174 612e 746f 6d6f  d_data.data.tomo
+000079d0: 5f66 6965 6c64 732c 206e 616d 653d 2772  _fields, name='r
+000079e0: 6564 7563 6564 5f64 6174 6127 290a 2020  educed_data').  
+000079f0: 2020 2020 2020 6e78 656e 7472 792e 6461        nxentry.da
+00007a00: 7461 2e6d 616b 656c 696e 6b28 0a20 2020  ta.makelink(.   
+00007a10: 2020 2020 2020 2020 206e 7865 6e74 7279           nxentry
+00007a20: 2e72 6564 7563 6564 5f64 6174 612e 726f  .reduced_data.ro
+00007a30: 7461 7469 6f6e 5f61 6e67 6c65 2c20 6e61  tation_angle, na
+00007a40: 6d65 3d27 726f 7461 7469 6f6e 5f61 6e67  me='rotation_ang
+00007a50: 6c65 2729 0a20 2020 2020 2020 206e 7865  le').        nxe
+00007a60: 6e74 7279 2e64 6174 612e 6174 7472 735b  ntry.data.attrs[
+00007a70: 2773 6967 6e61 6c27 5d20 3d20 2772 6564  'signal'] = 'red
+00007a80: 7563 6564 5f64 6174 6127 0a0a 2020 2020  uced_data'..    
+00007a90: 2020 2020 7265 7475 726e 206e 7872 6f6f      return nxroo
+00007aa0: 740a 0a20 2020 2064 6566 2066 696e 645f  t..    def find_
+00007ab0: 6365 6e74 6572 7328 7365 6c66 2c20 6e78  centers(self, nx
+00007ac0: 726f 6f74 2c20 6365 6e74 6572 5f72 6f77  root, center_row
+00007ad0: 733d 4e6f 6e65 2c20 6365 6e74 6572 5f73  s=None, center_s
+00007ae0: 7461 636b 5f69 6e64 6578 3d4e 6f6e 652c  tack_index=None,
+00007af0: 0a20 2020 2020 2020 2020 2020 2067 6175  .            gau
+00007b00: 7373 6961 6e5f 7369 676d 613d 4e6f 6e65  ssian_sigma=None
+00007b10: 2c20 7269 6e67 5f77 6964 7468 3d4e 6f6e  , ring_width=Non
+00007b20: 6529 3a0a 2020 2020 2020 2020 2222 220a  e):.        """.
+00007b30: 2020 2020 2020 2020 4669 6e64 2074 6865          Find the
+00007b40: 2063 616c 6962 7261 7465 6420 6365 6e74   calibrated cent
+00007b50: 6572 2061 7869 7320 696e 666f 0a0a 2020  er axis info..  
+00007b60: 2020 2020 2020 3a70 6172 616d 206e 7872        :param nxr
+00007b70: 6f6f 743a 2044 6174 6120 6f62 6a65 6374  oot: Data object
+00007b80: 2063 6f6e 7461 696e 696e 6720 7468 6520   containing the 
+00007b90: 7265 6475 6365 6420 6461 7461 2061 6e64  reduced data and
+00007ba0: 0a20 2020 2020 2020 2020 2020 206d 6574  .            met
+00007bb0: 6164 6174 6120 7265 7175 6972 6564 2074  adata required t
+00007bc0: 6f20 6669 6e64 2074 6865 2063 616c 6962  o find the calib
+00007bd0: 7261 7465 6420 6365 6e74 6572 2061 7869  rated center axi
+00007be0: 7320 696e 666f 0a20 2020 2020 2020 203a  s info.        :
+00007bf0: 7479 7065 2064 6174 613a 206e 6578 7573  type data: nexus
+00007c00: 666f 726d 6174 2e6e 6578 7573 2e4e 5872  format.nexus.NXr
+00007c10: 6f6f 740a 2020 2020 2020 2020 3a70 6172  oot.        :par
+00007c20: 616d 2063 656e 7465 725f 726f 7773 3a20  am center_rows: 
+00007c30: 4c6f 7765 7220 616e 6420 7570 7065 7220  Lower and upper 
+00007c40: 726f 7720 696e 6469 6365 7320 666f 7220  row indices for 
+00007c50: 6365 6e74 6572 0a20 2020 2020 2020 2020  center.         
+00007c60: 2020 2066 696e 6469 6e67 0a20 2020 2020     finding.     
+00007c70: 2020 203a 7479 7065 2063 656e 7465 725f     :type center_
+00007c80: 726f 7773 3a20 7475 706c 6528 696e 742c  rows: tuple(int,
+00007c90: 2069 6e74 292c 206c 6973 745b 696e 745d   int), list[int]
+00007ca0: 2c20 6f70 7469 6f6e 616c 0a20 2020 2020  , optional.     
+00007cb0: 2020 203a 7061 7261 6d20 6365 6e74 6572     :param center
+00007cc0: 5f73 7461 636b 5f69 6e64 6578 3a20 5374  _stack_index: St
+00007cd0: 6163 6b20 696e 6465 7820 6f66 2074 6865  ack index of the
+00007ce0: 2074 6f6d 6f67 7261 7068 7920 7365 7420   tomography set 
+00007cf0: 746f 0a20 2020 2020 2020 2020 2020 2066  to.            f
+00007d00: 696e 6420 7468 6520 6365 6e74 6572 2061  ind the center a
+00007d10: 7869 732e 0a20 2020 2020 2020 203a 7479  xis..        :ty
+00007d20: 7065 2063 656e 7465 725f 7374 6163 6b5f  pe center_stack_
+00007d30: 696e 6465 783a 2069 6e74 2c20 6f70 7469  index: int, opti
+00007d40: 6f6e 616c 0a20 2020 2020 2020 203a 7061  onal.        :pa
+00007d50: 7261 6d20 6761 7573 7369 616e 5f73 6967  ram gaussian_sig
+00007d60: 6d61 3a20 5374 616e 6461 7264 2064 6576  ma: Standard dev
+00007d70: 6961 7469 6f6e 2066 6f72 2074 6865 2047  iation for the G
+00007d80: 6175 7373 6961 6e0a 2020 2020 2020 2020  aussian.        
+00007d90: 2020 2020 6669 6c74 6572 2061 7070 6c69      filter appli
+00007da0: 6564 2074 6f20 696d 6167 6520 7265 636f  ed to image reco
+00007db0: 6e73 7472 7563 7469 6f6e 2076 6973 7561  nstruction visua
+00007dc0: 6c69 7a61 7469 6f6e 732c 0a20 2020 2020  lizations,.     
+00007dd0: 2020 2020 2020 2064 6566 6175 6c74 7320         defaults 
+00007de0: 746f 206e 6f20 6669 6c74 6572 696e 6720  to no filtering 
+00007df0: 7065 7266 6f72 6d65 642e 0a20 2020 2020  performed..     
+00007e00: 2020 203a 7479 7065 2067 6175 7373 6961     :type gaussia
+00007e10: 6e5f 7369 676d 613a 2066 6c6f 6174 2c20  n_sigma: float, 
+00007e20: 6f70 7469 6f6e 616c 0a20 2020 2020 2020  optional.       
+00007e30: 203a 7061 7261 6d20 7269 6e67 5f77 6964   :param ring_wid
+00007e40: 7468 3a20 4d61 7869 6d75 6d20 7769 6474  th: Maximum widt
+00007e50: 6820 6f66 2072 696e 6773 2074 6f20 6265  h of rings to be
+00007e60: 2066 696c 7465 7265 6420 696e 2074 6865   filtered in the
+00007e70: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
+00007e80: 6765 2072 6563 6f6e 7374 7275 6374 696f  ge reconstructio
+00007e90: 6e20 696e 2070 6978 656c 732c 2064 6566  n in pixels, def
+00007ea0: 6175 6c74 7320 746f 206e 6f20 6669 6c74  aults to no filt
+00007eb0: 6572 696e 670a 2020 2020 2020 2020 2020  ering.          
+00007ec0: 2020 7065 7266 6f72 6d65 642e 0a20 2020    performed..   
+00007ed0: 2020 2020 203a 7479 7065 2072 696e 675f       :type ring_
+00007ee0: 7769 6474 683a 2066 6c6f 6174 2c20 6f70  width: float, op
+00007ef0: 7469 6f6e 616c 0a20 2020 2020 2020 203a  tional.        :
+00007f00: 7265 7475 726e 3a20 4361 6c69 6272 6174  return: Calibrat
+00007f10: 6564 2063 656e 7465 7220 6178 6973 2069  ed center axis i
+00007f20: 6e66 6f0a 2020 2020 2020 2020 3a72 7479  nfo.        :rty
+00007f30: 7065 3a20 6469 6374 0a20 2020 2020 2020  pe: dict.       
+00007f40: 2022 2222 0a20 2020 2020 2020 2023 2054   """.        # T
+00007f50: 6869 7264 2070 6172 7479 206d 6f64 756c  hird party modul
+00007f60: 6573 0a20 2020 2020 2020 2066 726f 6d20  es.        from 
+00007f70: 6e65 7875 7366 6f72 6d61 742e 6e65 7875  nexusformat.nexu
+00007f80: 7320 696d 706f 7274 2028 0a20 2020 2020  s import (.     
+00007f90: 2020 2020 2020 204e 5865 6e74 7279 2c0a         NXentry,.
+00007fa0: 2020 2020 2020 2020 2020 2020 4e58 726f              NXro
+00007fb0: 6f74 2c0a 2020 2020 2020 2020 290a 2020  ot,.        ).  
+00007fc0: 2020 2020 2020 6672 6f6d 2079 616d 6c20        from yaml 
+00007fd0: 696d 706f 7274 2073 6166 655f 6475 6d70  import safe_dump
+00007fe0: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
+00007ff0: 6c6f 6767 6572 2e69 6e66 6f28 2746 696e  logger.info('Fin
+00008000: 6420 7468 6520 6361 6c69 6272 6174 6564  d the calibrated
+00008010: 2063 656e 7465 7220 6178 6973 2069 6e66   center axis inf
+00008020: 6f27 290a 0a20 2020 2020 2020 2069 6620  o')..        if 
+00008030: 6e6f 7420 6973 696e 7374 616e 6365 286e  not isinstance(n
+00008040: 7872 6f6f 742c 204e 5872 6f6f 7429 3a0a  xroot, NXroot):.
+00008050: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00008060: 6520 5661 6c75 6545 7272 6f72 2866 2749  e ValueError(f'I
+00008070: 6e76 616c 6964 2070 6172 616d 6574 6572  nvalid parameter
+00008080: 206e 7872 6f6f 7420 287b 6e78 726f 6f74   nxroot ({nxroot
+00008090: 7d29 2729 0a20 2020 2020 2020 206e 7865  })').        nxe
+000080a0: 6e74 7279 203d 206e 7872 6f6f 745b 6e78  ntry = nxroot[nx
+000080b0: 726f 6f74 2e61 7474 7273 5b27 6465 6661  root.attrs['defa
+000080c0: 756c 7427 5d5d 0a20 2020 2020 2020 2069  ult']].        i
+000080d0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+000080e0: 286e 7865 6e74 7279 2c20 4e58 656e 7472  (nxentry, NXentr
+000080f0: 7929 3a0a 2020 2020 2020 2020 2020 2020  y):.            
+00008100: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00008110: 2866 2749 6e76 616c 6964 206e 7865 6e74  (f'Invalid nxent
+00008120: 7279 2028 7b6e 7865 6e74 7279 7d29 2729  ry ({nxentry})')
+00008130: 0a20 2020 2020 2020 2069 6620 2863 656e  .        if (cen
+00008140: 7465 725f 726f 7773 2069 7320 6e6f 7420  ter_rows is not 
+00008150: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00008160: 2020 2020 2061 6e64 2028 6e6f 7420 6973       and (not is
+00008170: 696e 7374 616e 6365 2863 656e 7465 725f  instance(center_
+00008180: 726f 7773 2c20 2874 7570 6c65 2c20 6c69  rows, (tuple, li
+00008190: 7374 2929 0a20 2020 2020 2020 2020 2020  st)).           
+000081a0: 2020 2020 2020 2020 2020 6f72 206c 656e            or len
+000081b0: 2863 656e 7465 725f 726f 7773 2920 213d  (center_rows) !=
+000081c0: 2032 2929 3a0a 2020 2020 2020 2020 2020   2)):.          
+000081d0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+000081e0: 6f72 2866 2749 6e76 616c 6964 2070 6172  or(f'Invalid par
+000081f0: 616d 6574 6572 2063 656e 7465 725f 726f  ameter center_ro
+00008200: 7773 2028 7b63 656e 7465 725f 726f 7773  ws ({center_rows
+00008210: 7d29 2729 0a20 2020 2020 2020 2069 6620  })').        if 
+00008220: 286e 6f74 2073 656c 662e 5f69 6e74 6572  (not self._inter
+00008230: 6163 7469 7665 0a20 2020 2020 2020 2020  active.         
+00008240: 2020 2020 2020 2061 6e64 2028 6365 6e74         and (cent
+00008250: 6572 5f72 6f77 7320 6973 204e 6f6e 650a  er_rows is None.
+00008260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008270: 2020 2020 206f 7220 2863 656e 7465 725f       or (center_
+00008280: 726f 7773 5b30 5d20 6973 204e 6f6e 6520  rows[0] is None 
+00008290: 616e 6420 6365 6e74 6572 5f72 6f77 735b  and center_rows[
+000082a0: 315d 2069 7320 4e6f 6e65 2929 293a 0a20  1] is None))):. 
+000082b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000082c0: 5f6c 6f67 6765 722e 7761 726e 696e 6728  _logger.warning(
+000082d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000082e0: 2027 6365 6e74 6572 5f72 6f77 7320 756e   'center_rows un
+000082f0: 7370 6563 6966 6965 642c 2066 696e 6420  specified, find 
+00008300: 6365 6e74 6572 7320 6174 2072 6564 7563  centers at reduc
+00008310: 6564 2064 6174 6120 626f 756e 6473 2729  ed data bounds')
+00008320: 0a20 2020 2020 2020 2069 6620 2863 656e  .        if (cen
+00008330: 7465 725f 7374 6163 6b5f 696e 6465 7820  ter_stack_index 
+00008340: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+00008350: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+00008360: 286e 6f74 2069 7369 6e73 7461 6e63 6528  (not isinstance(
+00008370: 6365 6e74 6572 5f73 7461 636b 5f69 6e64  center_stack_ind
+00008380: 6578 2c20 696e 7429 0a20 2020 2020 2020  ex, int).       
+00008390: 2020 2020 2020 2020 2020 2020 2020 6f72                or
+000083a0: 2063 656e 7465 725f 7374 6163 6b5f 696e   center_stack_in
+000083b0: 6465 7820 3c20 3029 293a 0a20 2020 2020  dex < 0)):.     
+000083c0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+000083d0: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
+000083e0: 2020 2020 2020 2020 2027 496e 7661 6c69           'Invali
+000083f0: 6420 7061 7261 6d65 7465 7220 6365 6e74  d parameter cent
+00008400: 6572 5f73 7461 636b 5f69 6e64 6578 2027  er_stack_index '
+00008410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008420: 202b 2066 2728 7b63 656e 7465 725f 7374   + f'({center_st
+00008430: 6163 6b5f 696e 6465 787d 2927 290a 0a20  ack_index})').. 
+00008440: 2020 2020 2020 2023 2043 6865 636b 2069         # Check i
+00008450: 6620 7265 6475 6365 6420 6461 7461 2069  f reduced data i
+00008460: 7320 6176 6169 6c61 626c 650a 2020 2020  s available.    
+00008470: 2020 2020 6966 2028 2772 6564 7563 6564      if ('reduced
+00008480: 5f64 6174 6127 206e 6f74 2069 6e20 6e78  _data' not in nx
+00008490: 656e 7472 790a 2020 2020 2020 2020 2020  entry.          
+000084a0: 2020 2020 2020 6f72 2027 7265 6475 6365        or 'reduce
+000084b0: 645f 6461 7461 2720 6e6f 7420 696e 206e  d_data' not in n
+000084c0: 7865 6e74 7279 2e64 6174 6129 3a0a 2020  xentry.data):.  
+000084d0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000084e0: 4b65 7945 7272 6f72 2866 2755 6e61 626c  KeyError(f'Unabl
+000084f0: 6520 746f 2066 696e 6420 7661 6c69 6420  e to find valid 
+00008500: 7265 6475 6365 6420 6461 7461 2069 6e20  reduced data in 
+00008510: 7b6e 7865 6e74 7279 7d2e 2729 0a0a 2020  {nxentry}.')..  
+00008520: 2020 2020 2020 2320 5365 6c65 6374 2074        # Select t
+00008530: 6865 2069 6d61 6765 2073 7461 636b 2074  he image stack t
+00008540: 6f20 6361 6c69 6272 6174 6520 7468 6520  o calibrate the 
+00008550: 6365 6e74 6572 2061 7869 730a 2020 2020  center axis.    
+00008560: 2020 2020 2320 2020 2020 7265 6475 6365      #     reduce
+00008570: 6420 6461 7461 2061 7865 7320 6f72 6465  d data axes orde
+00008580: 723a 2073 7461 636b 2c74 6865 7461 2c72  r: stack,theta,r
+00008590: 6f77 2c63 6f6c 756d 6e0a 2020 2020 2020  ow,column.      
+000085a0: 2020 2320 4e6f 7465 3a20 4e65 7875 7320    # Note: Nexus 
+000085b0: 6361 6e27 7420 666f 6c6c 6f77 2061 206c  can't follow a l
+000085c0: 696e 6b20 6966 2074 6865 2064 6174 6120  ink if the data 
+000085d0: 6974 2070 6f69 6e74 7320 746f 2069 730a  it points to is.
+000085e0: 2020 2020 2020 2020 2320 2020 2020 746f          #     to
+000085f0: 6f20 6269 6720 6765 7420 7468 6520 6461  o big get the da
+00008600: 7461 2066 726f 6d20 7468 6520 6163 7475  ta from the actu
+00008610: 616c 2070 6c61 6365 2c20 6e6f 7420 6672  al place, not fr
+00008620: 6f6d 0a20 2020 2020 2020 2023 2020 2020  om.        #    
+00008630: 206e 7865 6e74 7279 2e64 6174 610a 2020   nxentry.data.  
+00008640: 2020 2020 2020 746f 6d6f 5f66 6965 6c64        tomo_field
+00008650: 735f 7368 6170 6520 3d20 6e78 656e 7472  s_shape = nxentr
+00008660: 792e 7265 6475 6365 645f 6461 7461 2e64  y.reduced_data.d
+00008670: 6174 612e 746f 6d6f 5f66 6965 6c64 732e  ata.tomo_fields.
+00008680: 7368 6170 650a 2020 2020 2020 2020 6966  shape.        if
+00008690: 2028 6c65 6e28 746f 6d6f 5f66 6965 6c64   (len(tomo_field
+000086a0: 735f 7368 6170 6529 2021 3d20 340a 2020  s_shape) != 4.  
+000086b0: 2020 2020 2020 2020 2020 2020 2020 6f72                or
+000086c0: 2061 6e79 2854 7275 6520 666f 7220 6469   any(True for di
+000086d0: 6d20 696e 2074 6f6d 6f5f 6669 656c 6473  m in tomo_fields
+000086e0: 5f73 6861 7065 2069 6620 6e6f 7420 6469  _shape if not di
+000086f0: 6d29 293a 0a20 2020 2020 2020 2020 2020  m)):.           
+00008700: 2072 6169 7365 204b 6579 4572 726f 7228   raise KeyError(
+00008710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008720: 2027 556e 6162 6c65 2074 6f20 6c6f 6164   'Unable to load
+00008730: 2074 6865 2072 6571 7569 7265 6420 7265   the required re
+00008740: 6475 6365 6420 746f 6d6f 6772 6170 6879  duced tomography
+00008750: 2073 7461 636b 2729 0a20 2020 2020 2020   stack').       
+00008760: 206e 756d 5f74 6f6d 6f5f 7374 6163 6b73   num_tomo_stacks
+00008770: 203d 2074 6f6d 6f5f 6669 656c 6473 5f73   = tomo_fields_s
+00008780: 6861 7065 5b30 5d0a 2020 2020 2020 2020  hape[0].        
+00008790: 6966 206e 756d 5f74 6f6d 6f5f 7374 6163  if num_tomo_stac
+000087a0: 6b73 203d 3d20 313a 0a20 2020 2020 2020  ks == 1:.       
+000087b0: 2020 2020 2063 656e 7465 725f 7374 6163       center_stac
+000087c0: 6b5f 696e 6465 7820 3d20 300a 2020 2020  k_index = 0.    
+000087d0: 2020 2020 2020 2020 6465 6661 756c 7420          default 
+000087e0: 3d20 276e 270a 2020 2020 2020 2020 656c  = 'n'.        el
+000087f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00008800: 6966 2073 656c 662e 5f74 6573 745f 6d6f  if self._test_mo
+00008810: 6465 3a0a 2020 2020 2020 2020 2020 2020  de:.            
+00008820: 2020 2020 2320 436f 6e76 6572 7420 696e      # Convert in
+00008830: 7075 7420 7661 6c75 6520 746f 206f 6666  put value to off
+00008840: 7365 7420 300a 2020 2020 2020 2020 2020  set 0.          
+00008850: 2020 2020 2020 6365 6e74 6572 5f73 7461        center_sta
+00008860: 636b 5f69 6e64 6578 203d 2073 656c 662e  ck_index = self.
+00008870: 5f74 6573 745f 636f 6e66 6967 5b27 6365  _test_config['ce
+00008880: 6e74 6572 5f73 7461 636b 5f69 6e64 6578  nter_stack_index
+00008890: 275d 0a20 2020 2020 2020 2020 2020 2065  '].            e
+000088a0: 6c69 6620 7365 6c66 2e5f 696e 7465 7261  lif self._intera
+000088b0: 6374 6976 653a 0a20 2020 2020 2020 2020  ctive:.         
+000088c0: 2020 2020 2020 2069 6620 6365 6e74 6572         if center
+000088d0: 5f73 7461 636b 5f69 6e64 6578 2069 7320  _stack_index is 
+000088e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000088f0: 2020 2020 2020 2020 2020 6365 6e74 6572            center
+00008900: 5f73 7461 636b 5f69 6e64 6578 203d 2069  _stack_index = i
+00008910: 6e70 7574 5f69 6e74 280a 2020 2020 2020  nput_int(.      
+00008920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008930: 2020 275c 6e45 6e74 6572 2074 6f6d 6f67    '\nEnter tomog
+00008940: 7261 7068 7920 7374 6163 6b20 696e 6465  raphy stack inde
+00008950: 7820 746f 2063 616c 6962 7261 7465 2074  x to calibrate t
+00008960: 6865 2027 0a20 2020 2020 2020 2020 2020  he '.           
+00008970: 2020 2020 2020 2020 2020 2020 202b 2027               + '
+00008980: 6365 6e74 6572 2061 7869 7327 2c20 6765  center axis', ge
+00008990: 3d30 2c20 6c74 3d6e 756d 5f74 6f6d 6f5f  =0, lt=num_tomo_
+000089a0: 7374 6163 6b73 2c0a 2020 2020 2020 2020  stacks,.        
+000089b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000089c0: 6465 6661 756c 743d 696e 7428 6e75 6d5f  default=int(num_
+000089d0: 746f 6d6f 5f73 7461 636b 732f 3229 290a  tomo_stacks/2)).
+000089e0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000089f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00008a00: 2020 6966 2063 656e 7465 725f 7374 6163    if center_stac
+00008a10: 6b5f 696e 6465 7820 6973 204e 6f6e 653a  k_index is None:
+00008a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008a30: 2020 2020 2063 656e 7465 725f 7374 6163       center_stac
+00008a40: 6b5f 696e 6465 7820 3d20 696e 7428 6e75  k_index = int(nu
+00008a50: 6d5f 746f 6d6f 5f73 7461 636b 732f 3229  m_tomo_stacks/2)
+00008a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008a70: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
+00008a80: 722e 7761 726e 696e 6728 0a20 2020 2020  r.warning(.     
+00008a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008aa0: 2020 2027 6365 6e74 6572 5f73 7461 636b     'center_stack
+00008ab0: 5f69 6e64 6578 2075 6e73 7065 6369 6669  _index unspecifi
+00008ac0: 6564 2c20 7573 6520 7374 6163 6b20 270a  ed, use stack '.
+00008ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ae0: 2020 2020 2020 2020 2b20 6627 7b63 656e          + f'{cen
+00008af0: 7465 725f 7374 6163 6b5f 696e 6465 787d  ter_stack_index}
+00008b00: 2074 6f20 6669 6e64 2063 656e 7465 7273   to find centers
+00008b10: 2729 0a20 2020 2020 2020 2020 2020 2064  ').            d
+00008b20: 6566 6175 6c74 203d 2027 7927 0a0a 2020  efault = 'y'..  
+00008b30: 2020 2020 2020 2320 4765 7420 7468 6574        # Get thet
+00008b40: 6173 2028 696e 2064 6567 7265 6573 290a  as (in degrees).
+00008b50: 2020 2020 2020 2020 7468 6574 6173 203d          thetas =
+00008b60: 206e 702e 6173 6172 7261 7928 6e78 656e   np.asarray(nxen
+00008b70: 7472 792e 7265 6475 6365 645f 6461 7461  try.reduced_data
+00008b80: 2e72 6f74 6174 696f 6e5f 616e 676c 6529  .rotation_angle)
+00008b90: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00008ba0: 6c65 6e28 7468 6574 6173 2920 3d3d 2074  len(thetas) == t
+00008bb0: 6f6d 6f5f 6669 656c 6473 5f73 6861 7065  omo_fields_shape
+00008bc0: 5b31 5d0a 0a20 2020 2020 2020 2023 2047  [1]..        # G
+00008bd0: 6574 2065 6666 6563 7469 7665 2070 6978  et effective pix
+00008be0: 656c 5f73 697a 650a 2020 2020 2020 2020  el_size.        
+00008bf0: 6966 2027 7a6f 6f6d 5f70 6572 6327 2069  if 'zoom_perc' i
+00008c00: 6e20 6e78 656e 7472 792e 7265 6475 6365  n nxentry.reduce
+00008c10: 645f 6461 7461 3a0a 2020 2020 2020 2020  d_data:.        
+00008c20: 2020 2020 6566 665f 7069 7865 6c5f 7369      eff_pixel_si
+00008c30: 7a65 203d 205c 0a20 2020 2020 2020 2020  ze = \.         
+00008c40: 2020 2020 2020 2031 3030 2e20 2a20 286e         100. * (n
+00008c50: 7865 6e74 7279 2e69 6e73 7472 756d 656e  xentry.instrumen
+00008c60: 742e 6465 7465 6374 6f72 2e78 5f70 6978  t.detector.x_pix
+00008c70: 656c 5f73 697a 650a 2020 2020 2020 2020  el_size.        
+00008c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c90: 202f 206e 7865 6e74 7279 2e72 6564 7563   / nxentry.reduc
+00008ca0: 6564 5f64 6174 612e 6174 7472 735b 277a  ed_data.attrs['z
+00008cb0: 6f6f 6d5f 7065 7263 275d 290a 2020 2020  oom_perc']).    
+00008cc0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00008cd0: 2020 2020 2020 6566 665f 7069 7865 6c5f        eff_pixel_
+00008ce0: 7369 7a65 203d 206e 7865 6e74 7279 2e69  size = nxentry.i
+00008cf0: 6e73 7472 756d 656e 742e 6465 7465 6374  nstrument.detect
+00008d00: 6f72 2e78 5f70 6978 656c 5f73 697a 650a  or.x_pixel_size.
+00008d10: 0a20 2020 2020 2020 2023 2047 6574 2063  .        # Get c
+00008d20: 726f 7373 2073 6563 7469 6f6e 616c 2064  ross sectional d
+00008d30: 6961 6d65 7465 720a 2020 2020 2020 2020  iameter.        
+00008d40: 6372 6f73 735f 7365 6374 696f 6e61 6c5f  cross_sectional_
+00008d50: 6469 6d20 3d20 746f 6d6f 5f66 6965 6c64  dim = tomo_field
+00008d60: 735f 7368 6170 655b 335d 2a65 6666 5f70  s_shape[3]*eff_p
+00008d70: 6978 656c 5f73 697a 650a 2020 2020 2020  ixel_size.      
+00008d80: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e64    self._logger.d
+00008d90: 6562 7567 2866 2763 726f 7373 5f73 6563  ebug(f'cross_sec
+00008da0: 7469 6f6e 616c 5f64 696d 203d 207b 6372  tional_dim = {cr
+00008db0: 6f73 735f 7365 6374 696f 6e61 6c5f 6469  oss_sectional_di
+00008dc0: 6d7d 2729 0a0a 2020 2020 2020 2020 2320  m}')..        # 
+00008dd0: 4465 7465 726d 696e 6520 6365 6e74 6572  Determine center
+00008de0: 206f 6666 7365 7420 6174 2073 616d 706c   offset at sampl
+00008df0: 6520 726f 7720 626f 756e 6461 7269 6573  e row boundaries
+00008e00: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
+00008e10: 6f67 6765 722e 696e 666f 2827 4465 7465  ogger.info('Dete
+00008e20: 726d 696e 6520 6365 6e74 6572 206f 6666  rmine center off
+00008e30: 7365 7420 6174 2073 616d 706c 6520 726f  set at sample ro
+00008e40: 7720 626f 756e 6461 7269 6573 2729 0a0a  w boundaries')..
+00008e50: 2020 2020 2020 2020 2320 4c6f 7765 7220          # Lower 
+00008e60: 726f 7720 6365 6e74 6572 0a20 2020 2020  row center.     
+00008e70: 2020 2069 6620 7365 6c66 2e5f 7465 7374     if self._test
+00008e80: 5f6d 6f64 653a 0a20 2020 2020 2020 2020  _mode:.         
+00008e90: 2020 206c 6f77 6572 5f72 6f77 203d 2073     lower_row = s
+00008ea0: 656c 662e 5f74 6573 745f 636f 6e66 6967  elf._test_config
+00008eb0: 5b27 6c6f 7765 725f 726f 7727 5d0a 2020  ['lower_row'].  
+00008ec0: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
+00008ed0: 5f69 6e74 6572 6163 7469 7665 3a0a 2020  _interactive:.  
+00008ee0: 2020 2020 2020 2020 2020 6966 2063 656e            if cen
+00008ef0: 7465 725f 726f 7773 2069 7320 6e6f 7420  ter_rows is not 
+00008f00: 4e6f 6e65 2061 6e64 2063 656e 7465 725f  None and center_
+00008f10: 726f 7773 5b30 5d20 6973 206e 6f74 204e  rows[0] is not N
+00008f20: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00008f30: 2020 2020 206c 6f77 6572 5f72 6f77 203d       lower_row =
+00008f40: 2063 656e 7465 725f 726f 7773 5b30 5d0a   center_rows[0].
+00008f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008f60: 6966 206e 6f74 2030 203c 3d20 6c6f 7765  if not 0 <= lowe
+00008f70: 725f 726f 7720 3c20 746f 6d6f 5f66 6965  r_row < tomo_fie
+00008f80: 6c64 735f 7368 6170 655b 325d 2d31 3a0a  lds_shape[2]-1:.
+00008f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008fa0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00008fb0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00008fc0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00008fd0: 496e 7661 6c69 6420 7061 7261 6d65 7465  Invalid paramete
+00008fe0: 7220 6365 6e74 6572 5f72 6f77 7320 287b  r center_rows ({
+00008ff0: 6365 6e74 6572 5f72 6f77 737d 2927 290a  center_rows})').
+00009000: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00009010: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009020: 2020 6c6f 7765 725f 726f 7720 3d20 7365    lower_row = se
+00009030: 6c65 6374 5f6f 6e65 5f69 6d61 6765 5f62  lect_one_image_b
+00009040: 6f75 6e64 280a 2020 2020 2020 2020 2020  ound(.          
+00009050: 2020 2020 2020 2020 2020 6e78 656e 7472            nxentr
+00009060: 792e 7265 6475 6365 645f 6461 7461 2e64  y.reduced_data.d
+00009070: 6174 612e 746f 6d6f 5f66 6965 6c64 735b  ata.tomo_fields[
+00009080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009090: 2020 2020 2020 2020 2063 656e 7465 725f           center_
+000090a0: 7374 6163 6b5f 696e 6465 782c 302c 3a2c  stack_index,0,:,
+000090b0: 3a5d 2c0a 2020 2020 2020 2020 2020 2020  :],.            
+000090c0: 2020 2020 2020 2020 302c 2062 6f75 6e64          0, bound
+000090d0: 3d30 2c20 7469 746c 653d 6627 7468 6574  =0, title=f'thet
+000090e0: 613d 7b72 6f75 6e64 2874 6865 7461 735b  a={round(thetas[
+000090f0: 305d 2c20 3229 2b30 7d27 2c0a 2020 2020  0], 2)+0}',.    
+00009100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009110: 626f 756e 645f 6e61 6d65 3d27 726f 7720  bound_name='row 
+00009120: 696e 6465 7820 746f 2066 696e 6420 6c6f  index to find lo
+00009130: 7765 7220 6365 6e74 6572 272c 0a20 2020  wer center',.   
+00009140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009150: 2064 6566 6175 6c74 3d64 6566 6175 6c74   default=default
+00009160: 2c20 7261 6973 655f 6572 726f 723d 5472  , raise_error=Tr
+00009170: 7565 290a 2020 2020 2020 2020 656c 7365  ue).        else
+00009180: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00009190: 2063 656e 7465 725f 726f 7773 2069 7320   center_rows is 
+000091a0: 4e6f 6e65 206f 7220 6365 6e74 6572 5f72  None or center_r
+000091b0: 6f77 735b 305d 2069 7320 4e6f 6e65 3a0a  ows[0] is None:.
 000091c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000091d0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-000091e0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-000091f0: 2020 2020 2020 2020 2020 2066 2749 6e76             f'Inv
-00009200: 616c 6964 2070 6172 616d 6574 6572 2063  alid parameter c
-00009210: 656e 7465 725f 726f 7773 2028 7b63 656e  enter_rows ({cen
-00009220: 7465 725f 726f 7773 7d29 2729 0a20 2020  ter_rows})').   
-00009230: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00009240: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00009250: 7070 6572 5f72 6f77 203d 2073 656c 6563  pper_row = selec
-00009260: 745f 6f6e 655f 696d 6167 655f 626f 756e  t_one_image_boun
-00009270: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-00009280: 2020 2020 2020 206e 7865 6e74 7279 2e72         nxentry.r
-00009290: 6564 7563 6564 5f64 6174 612e 6461 7461  educed_data.data
-000092a0: 2e74 6f6d 6f5f 6669 656c 6473 5b0a 2020  .tomo_fields[.  
-000092b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000092c0: 2020 2020 2020 6365 6e74 6572 5f73 7461        center_sta
-000092d0: 636b 5f69 6e64 6578 2c30 2c3a 2c3a 5d2c  ck_index,0,:,:],
-000092e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000092f0: 2020 2020 2030 2c20 626f 756e 643d 746f       0, bound=to
-00009300: 6d6f 5f66 6965 6c64 735f 7368 6170 655b  mo_fields_shape[
-00009310: 325d 2d31 2c0a 2020 2020 2020 2020 2020  2]-1,.          
-00009320: 2020 2020 2020 2020 2020 7469 746c 653d            title=
-00009330: 6627 7468 6574 6120 3d20 7b72 6f75 6e64  f'theta = {round
-00009340: 2874 6865 7461 735b 305d 2c20 3229 2b30  (thetas[0], 2)+0
-00009350: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-00009360: 2020 2020 2020 2020 626f 756e 645f 6e61          bound_na
-00009370: 6d65 3d27 726f 7720 696e 6465 7820 746f  me='row index to
-00009380: 2066 696e 6420 7570 7065 7220 6365 6e74   find upper cent
-00009390: 6572 272c 0a20 2020 2020 2020 2020 2020  er',.           
-000093a0: 2020 2020 2020 2020 2064 6566 6175 6c74           default
-000093b0: 3d64 6566 6175 6c74 2c20 7261 6973 655f  =default, raise_
-000093c0: 6572 726f 723d 5472 7565 290a 2020 2020  error=True).    
-000093d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000093e0: 2020 2020 2020 6966 2063 656e 7465 725f        if center_
-000093f0: 726f 7773 2069 7320 4e6f 6e65 206f 7220  rows is None or 
-00009400: 6365 6e74 6572 5f72 6f77 735b 315d 2069  center_rows[1] i
-00009410: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00009420: 2020 2020 2020 2020 7570 7065 725f 726f          upper_ro
-00009430: 7720 3d20 746f 6d6f 5f66 6965 6c64 735f  w = tomo_fields_
-00009440: 7368 6170 655b 325d 2d31 0a20 2020 2020  shape[2]-1.     
-00009450: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00009460: 2020 2020 2020 2020 2020 2020 2075 7070               upp
-00009470: 6572 5f72 6f77 203d 2063 656e 7465 725f  er_row = center_
-00009480: 726f 7773 5b31 5d0a 2020 2020 2020 2020  rows[1].        
-00009490: 2020 2020 2020 2020 6966 2075 7070 6572          if upper
-000094a0: 5f72 6f77 203d 3d20 2d31 3a0a 2020 2020  _row == -1:.    
-000094b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000094c0: 7570 7065 725f 726f 7720 3d20 746f 6d6f  upper_row = tomo
-000094d0: 5f66 6965 6c64 735f 7368 6170 655b 325d  _fields_shape[2]
-000094e0: 2d31 0a20 2020 2020 2020 2020 2020 2020  -1.             
-000094f0: 2020 2069 6620 6e6f 7420 6c6f 7765 725f     if not lower_
-00009500: 726f 7720 3c20 7570 7065 725f 726f 7720  row < upper_row 
-00009510: 3c20 746f 6d6f 5f66 6965 6c64 735f 7368  < tomo_fields_sh
-00009520: 6170 655b 325d 3a0a 2020 2020 2020 2020  ape[2]:.        
-00009530: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00009540: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
-00009550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009560: 2020 2020 2020 6627 496e 7661 6c69 6420        f'Invalid 
-00009570: 7061 7261 6d65 7465 7220 6365 6e74 6572  parameter center
-00009580: 5f72 6f77 7320 287b 6365 6e74 6572 5f72  _rows ({center_r
-00009590: 6f77 737d 2927 290a 2020 2020 2020 2020  ows})').        
-000095a0: 7430 203d 2074 696d 6528 290a 2020 2020  t0 = time().    
-000095b0: 2020 2020 7570 7065 725f 6365 6e74 6572      upper_center
-000095c0: 5f6f 6666 7365 7420 3d20 7365 6c66 2e5f  _offset = self._
-000095d0: 6669 6e64 5f63 656e 7465 725f 6f6e 655f  find_center_one_
-000095e0: 706c 616e 6528 0a20 2020 2020 2020 2020  plane(.         
-000095f0: 2020 206e 7865 6e74 7279 2e72 6564 7563     nxentry.reduc
-00009600: 6564 5f64 6174 612e 6461 7461 2e74 6f6d  ed_data.data.tom
-00009610: 6f5f 6669 656c 6473 5b0a 2020 2020 2020  o_fields[.      
-00009620: 2020 2020 2020 2020 2020 6365 6e74 6572            center
-00009630: 5f73 7461 636b 5f69 6e64 6578 2c3a 2c75  _stack_index,:,u
-00009640: 7070 6572 5f72 6f77 2c3a 5d2c 0a20 2020  pper_row,:],.   
-00009650: 2020 2020 2020 2020 2075 7070 6572 5f72           upper_r
-00009660: 6f77 2c20 7468 6574 6173 2c20 6566 665f  ow, thetas, eff_
-00009670: 7069 7865 6c5f 7369 7a65 2c20 6372 6f73  pixel_size, cros
-00009680: 735f 7365 6374 696f 6e61 6c5f 6469 6d2c  s_sectional_dim,
-00009690: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
-000096a0: 683d 7365 6c66 2e5f 6f75 7470 7574 5f66  h=self._output_f
-000096b0: 6f6c 6465 722c 206e 756d 5f63 6f72 653d  older, num_core=
-000096c0: 7365 6c66 2e5f 6e75 6d5f 636f 7265 2c0a  self._num_core,.
-000096d0: 2020 2020 2020 2020 2020 2020 6761 7573              gaus
-000096e0: 7369 616e 5f73 6967 6d61 3d67 6175 7373  sian_sigma=gauss
-000096f0: 6961 6e5f 7369 676d 612c 2072 696e 675f  ian_sigma, ring_
-00009700: 7769 6474 683d 7269 6e67 5f77 6964 7468  width=ring_width
-00009710: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
-00009720: 6c6f 6767 6572 2e69 6e66 6f28 6627 4669  logger.info(f'Fi
-00009730: 6e64 696e 6720 6365 6e74 6572 2074 6f6f  nding center too
-00009740: 6b20 7b74 696d 6528 292d 7430 3a2e 3266  k {time()-t0:.2f
-00009750: 7d20 7365 636f 6e64 7327 290a 2020 2020  } seconds').    
-00009760: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-00009770: 2e64 6562 7567 2866 2775 7070 6572 5f72  .debug(f'upper_r
-00009780: 6f77 203d 207b 7570 7065 725f 726f 773a  ow = {upper_row:
-00009790: 2e32 667d 2729 0a20 2020 2020 2020 2073  .2f}').        s
-000097a0: 656c 662e 5f6c 6f67 6765 722e 6465 6275  elf._logger.debu
-000097b0: 6728 6627 7570 7065 725f 6365 6e74 6572  g(f'upper_center
-000097c0: 5f6f 6666 7365 7420 3d20 7b75 7070 6572  _offset = {upper
-000097d0: 5f63 656e 7465 725f 6f66 6673 6574 3a2e  _center_offset:.
-000097e0: 3266 7d27 290a 0a20 2020 2020 2020 2063  2f}')..        c
-000097f0: 656e 7465 725f 636f 6e66 6967 203d 207b  enter_config = {
-00009800: 0a20 2020 2020 2020 2020 2020 2027 6c6f  .            'lo
-00009810: 7765 725f 726f 7727 3a20 6c6f 7765 725f  wer_row': lower_
-00009820: 726f 772c 0a20 2020 2020 2020 2020 2020  row,.           
-00009830: 2027 6c6f 7765 725f 6365 6e74 6572 5f6f   'lower_center_o
-00009840: 6666 7365 7427 3a20 6c6f 7765 725f 6365  ffset': lower_ce
-00009850: 6e74 6572 5f6f 6666 7365 742c 0a20 2020  nter_offset,.   
-00009860: 2020 2020 2020 2020 2027 7570 7065 725f           'upper_
-00009870: 726f 7727 3a20 7570 7065 725f 726f 772c  row': upper_row,
-00009880: 0a20 2020 2020 2020 2020 2020 2027 7570  .            'up
-00009890: 7065 725f 6365 6e74 6572 5f6f 6666 7365  per_center_offse
-000098a0: 7427 3a20 7570 7065 725f 6365 6e74 6572  t': upper_center
-000098b0: 5f6f 6666 7365 742c 0a20 2020 2020 2020  _offset,.       
-000098c0: 207d 0a20 2020 2020 2020 2069 6620 6e75   }.        if nu
-000098d0: 6d5f 746f 6d6f 5f73 7461 636b 7320 3e20  m_tomo_stacks > 
-000098e0: 313a 0a20 2020 2020 2020 2020 2020 2063  1:.            c
-000098f0: 656e 7465 725f 636f 6e66 6967 5b27 6365  enter_config['ce
-00009900: 6e74 6572 5f73 7461 636b 5f69 6e64 6578  nter_stack_index
-00009910: 275d 203d 2063 656e 7465 725f 7374 6163  '] = center_stac
-00009920: 6b5f 696e 6465 780a 0a20 2020 2020 2020  k_index..       
-00009930: 2023 2053 6176 6520 7465 7374 2064 6174   # Save test dat
-00009940: 6120 746f 2066 696c 650a 2020 2020 2020  a to file.      
-00009950: 2020 6966 2073 656c 662e 5f74 6573 745f    if self._test_
-00009960: 6d6f 6465 3a0a 2020 2020 2020 2020 2020  mode:.          
-00009970: 2020 7769 7468 206f 7065 6e28 6627 7b73    with open(f'{s
-00009980: 656c 662e 5f6f 7574 7075 745f 666f 6c64  elf._output_fold
-00009990: 6572 7d2f 6365 6e74 6572 5f63 6f6e 6669  er}/center_confi
-000099a0: 672e 7961 6d6c 272c 2027 7727 2c0a 2020  g.yaml', 'w',.  
-000099b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000099c0: 2020 2020 656e 636f 6469 6e67 3d27 7574      encoding='ut
-000099d0: 6638 2729 2061 7320 663a 0a20 2020 2020  f8') as f:.     
-000099e0: 2020 2020 2020 2020 2020 2073 6166 655f             safe_
-000099f0: 6475 6d70 2863 656e 7465 725f 636f 6e66  dump(center_conf
-00009a00: 6967 2c20 6629 0a0a 2020 2020 2020 2020  ig, f)..        
-00009a10: 7265 7475 726e 2063 656e 7465 725f 636f  return center_co
-00009a20: 6e66 6967 0a0a 2020 2020 6465 6620 7265  nfig..    def re
-00009a30: 636f 6e73 7472 7563 745f 6461 7461 280a  construct_data(.
-00009a40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00009a50: 2c20 6e78 726f 6f74 2c20 6365 6e74 6572  , nxroot, center
-00009a60: 5f69 6e66 6f2c 2078 5f62 6f75 6e64 733d  _info, x_bounds=
-00009a70: 4e6f 6e65 2c20 795f 626f 756e 6473 3d4e  None, y_bounds=N
-00009a80: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00009a90: 207a 5f62 6f75 6e64 733d 4e6f 6e65 2c20   z_bounds=None, 
-00009aa0: 7365 636f 6e64 6172 795f 6974 6572 733d  secondary_iters=
-00009ab0: 302c 2072 656d 6f76 655f 7374 7269 7065  0, remove_stripe
-00009ac0: 5f73 6967 6d61 3d4e 6f6e 652c 0a20 2020  _sigma=None,.   
-00009ad0: 2020 2020 2020 2020 2072 696e 675f 7769           ring_wi
-00009ae0: 6474 683d 4e6f 6e65 293a 0a20 2020 2020  dth=None):.     
-00009af0: 2020 2022 2222 0a20 2020 2020 2020 2052     """.        R
-00009b00: 6563 6f6e 7374 7275 6374 2074 6865 2074  econstruct the t
-00009b10: 6f6d 6f67 7261 7068 7920 6461 7461 2e0a  omography data..
-00009b20: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00009b30: 6e78 726f 6f74 3a20 5265 6475 6365 6420  nxroot: Reduced 
-00009b40: 6461 7461 0a20 2020 2020 2020 203a 7479  data.        :ty
-00009b50: 7065 2064 6174 613a 206e 6578 7573 666f  pe data: nexusfo
-00009b60: 726d 6174 2e6e 6578 7573 2e4e 5872 6f6f  rmat.nexus.NXroo
-00009b70: 740a 2020 2020 2020 2020 3a70 6172 616d  t.        :param
-00009b80: 2063 656e 7465 725f 696e 666f 3a20 4361   center_info: Ca
-00009b90: 6c69 6272 6174 6564 2063 656e 7465 7220  librated center 
-00009ba0: 6178 6973 2069 6e66 6f0a 2020 2020 2020  axis info.      
-00009bb0: 2020 3a74 7970 6520 6365 6e74 6572 5f69    :type center_i
-00009bc0: 6e66 6f3a 2064 6963 740a 2020 2020 2020  nfo: dict.      
-00009bd0: 2020 3a70 6172 616d 2078 5f62 6f75 6e64    :param x_bound
-00009be0: 733a 2052 6563 6f6e 7374 7275 6374 6564  s: Reconstructed
-00009bf0: 2069 6d61 6765 2062 6f75 6e64 7320 696e   image bounds in
-00009c00: 2074 6865 2078 2d64 6972 6563 7469 6f6e   the x-direction
-00009c10: 0a20 2020 2020 2020 203a 7479 7065 2078  .        :type x
-00009c20: 5f62 6f75 6e64 733a 2074 7570 6c65 2869  _bounds: tuple(i
-00009c30: 6e74 2c20 696e 7429 2c20 6c69 7374 5b69  nt, int), list[i
-00009c40: 6e74 5d2c 206f 7074 696f 6e61 6c0a 2020  nt], optional.  
-00009c50: 2020 2020 2020 3a70 6172 616d 2079 5f62        :param y_b
-00009c60: 6f75 6e64 733a 2052 6563 6f6e 7374 7275  ounds: Reconstru
-00009c70: 6374 6564 2069 6d61 6765 2062 6f75 6e64  cted image bound
-00009c80: 7320 696e 2074 6865 2079 2d64 6972 6563  s in the y-direc
-00009c90: 7469 6f6e 0a20 2020 2020 2020 203a 7479  tion.        :ty
-00009ca0: 7065 2079 5f62 6f75 6e64 733a 2074 7570  pe y_bounds: tup
-00009cb0: 6c65 2869 6e74 2c20 696e 7429 2c20 6c69  le(int, int), li
-00009cc0: 7374 5b69 6e74 5d2c 206f 7074 696f 6e61  st[int], optiona
-00009cd0: 6c0a 2020 2020 2020 2020 3a70 6172 616d  l.        :param
-00009ce0: 207a 5f62 6f75 6e64 733a 2052 6563 6f6e   z_bounds: Recon
-00009cf0: 7374 7275 6374 6564 2069 6d61 6765 2062  structed image b
-00009d00: 6f75 6e64 7320 696e 2074 6865 207a 2d64  ounds in the z-d
-00009d10: 6972 6563 7469 6f6e 0a20 2020 2020 2020  irection.       
-00009d20: 203a 7479 7065 207a 5f62 6f75 6e64 733a   :type z_bounds:
-00009d30: 2074 7570 6c65 2869 6e74 2c20 696e 7429   tuple(int, int)
-00009d40: 2c20 6c69 7374 5b69 6e74 5d2c 206f 7074  , list[int], opt
-00009d50: 696f 6e61 6c0a 2020 2020 2020 2020 3a72  ional.        :r
-00009d60: 6574 7572 6e3a 2052 6563 6f6e 7374 7275  eturn: Reconstru
-00009d70: 6374 6564 2074 6f6d 6f67 7261 7068 7920  cted tomography 
-00009d80: 6461 7461 0a20 2020 2020 2020 203a 7274  data.        :rt
-00009d90: 7970 653a 2064 6963 740a 2020 2020 2020  ype: dict.      
-00009da0: 2020 2222 220a 2020 2020 2020 2020 2320    """.        # 
-00009db0: 5468 6972 6420 7061 7274 7920 6d6f 6475  Third party modu
-00009dc0: 6c65 730a 2020 2020 2020 2020 6672 6f6d  les.        from
-00009dd0: 206e 6578 7573 666f 726d 6174 2e6e 6578   nexusformat.nex
-00009de0: 7573 2069 6d70 6f72 7420 280a 2020 2020  us import (.    
-00009df0: 2020 2020 2020 2020 4e58 6461 7461 2c0a          NXdata,.
-00009e00: 2020 2020 2020 2020 2020 2020 4e58 656e              NXen
-00009e10: 7472 792c 0a20 2020 2020 2020 2020 2020  try,.           
-00009e20: 204e 5870 726f 6365 7373 2c0a 2020 2020   NXprocess,.    
-00009e30: 2020 2020 2020 2020 4e58 726f 6f74 2c0a          NXroot,.
-00009e40: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00009e50: 2020 2023 204c 6f63 616c 206d 6f64 756c     # Local modul
-00009e60: 6573 0a20 2020 2020 2020 2066 726f 6d20  es.        from 
-00009e70: 4348 4150 2e63 6f6d 6d6f 6e2e 7574 696c  CHAP.common.util
-00009e80: 732e 6765 6e65 7261 6c20 696d 706f 7274  s.general import
-00009e90: 2069 735f 696e 745f 7061 6972 0a0a 2020   is_int_pair..  
-00009ea0: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
-00009eb0: 6572 2e69 6e66 6f28 2752 6563 6f6e 7374  er.info('Reconst
-00009ec0: 7275 6374 2074 6865 2074 6f6d 6f67 7261  ruct the tomogra
-00009ed0: 7068 7920 6461 7461 2729 0a0a 2020 2020  phy data')..    
-00009ee0: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
-00009ef0: 7461 6e63 6528 6e78 726f 6f74 2c20 4e58  tance(nxroot, NX
-00009f00: 726f 6f74 293a 0a20 2020 2020 2020 2020  root):.         
-00009f10: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00009f20: 726f 7228 6627 496e 7661 6c69 6420 7061  ror(f'Invalid pa
-00009f30: 7261 6d65 7465 7220 6e78 726f 6f74 2028  rameter nxroot (
-00009f40: 7b6e 7872 6f6f 747d 2927 290a 2020 2020  {nxroot})').    
-00009f50: 2020 2020 6e78 656e 7472 7920 3d20 6e78      nxentry = nx
-00009f60: 726f 6f74 5b6e 7872 6f6f 742e 6174 7472  root[nxroot.attr
-00009f70: 735b 2764 6566 6175 6c74 275d 5d0a 2020  s['default']].  
-00009f80: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
-00009f90: 6e73 7461 6e63 6528 6e78 656e 7472 792c  nstance(nxentry,
-00009fa0: 204e 5865 6e74 7279 293a 0a20 2020 2020   NXentry):.     
-00009fb0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00009fc0: 7565 4572 726f 7228 6627 496e 7661 6c69  ueError(f'Invali
-00009fd0: 6420 6e78 656e 7472 7920 287b 6e78 656e  d nxentry ({nxen
-00009fe0: 7472 797d 2927 290a 2020 2020 2020 2020  try})').        
-00009ff0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-0000a000: 6528 6365 6e74 6572 5f69 6e66 6f2c 2064  e(center_info, d
-0000a010: 6963 7429 3a0a 2020 2020 2020 2020 2020  ict):.          
-0000a020: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-0000a030: 6f72 2866 2749 6e76 616c 6964 2070 6172  or(f'Invalid par
-0000a040: 616d 6574 6572 2063 656e 7465 725f 696e  ameter center_in
-0000a050: 666f 2028 7b63 656e 7465 725f 696e 666f  fo ({center_info
-0000a060: 7d29 2729 0a20 2020 2020 2020 2069 6620  })').        if 
-0000a070: 785f 626f 756e 6473 2069 7320 6e6f 7420  x_bounds is not 
-0000a080: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000a090: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
-0000a0a0: 6e63 6528 785f 626f 756e 6473 2c20 2874  nce(x_bounds, (t
-0000a0b0: 7570 6c65 2c20 6c69 7374 2929 3a0a 2020  uple, list)):.  
-0000a0c0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0000a0d0: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-0000a0e0: 2749 6e76 616c 6964 2070 6172 616d 6574  'Invalid paramet
-0000a0f0: 6572 2078 5f62 6f75 6e64 7320 287b 785f  er x_bounds ({x_
-0000a100: 626f 756e 6473 7d29 2729 0a20 2020 2020  bounds})').     
-0000a110: 2020 2020 2020 2078 5f62 6f75 6e64 7320         x_bounds 
-0000a120: 3d20 7475 706c 6528 785f 626f 756e 6473  = tuple(x_bounds
-0000a130: 290a 2020 2020 2020 2020 6966 2079 5f62  ).        if y_b
-0000a140: 6f75 6e64 7320 6973 206e 6f74 204e 6f6e  ounds is not Non
-0000a150: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-0000a160: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-0000a170: 2879 5f62 6f75 6e64 732c 2028 7475 706c  (y_bounds, (tupl
-0000a180: 652c 206c 6973 7429 293a 0a20 2020 2020  e, list)):.     
-0000a190: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000a1a0: 2056 616c 7565 4572 726f 7228 6627 496e   ValueError(f'In
-0000a1b0: 7661 6c69 6420 7061 7261 6d65 7465 7220  valid parameter 
-0000a1c0: 795f 626f 756e 6473 2028 7b79 5f62 6f75  y_bounds ({y_bou
-0000a1d0: 6e64 737d 2927 290a 2020 2020 2020 2020  nds})').        
-0000a1e0: 2020 2020 795f 626f 756e 6473 203d 2074      y_bounds = t
-0000a1f0: 7570 6c65 2879 5f62 6f75 6e64 7329 0a20  uple(y_bounds). 
-0000a200: 2020 2020 2020 2069 6620 7a5f 626f 756e         if z_boun
-0000a210: 6473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ds is not None:.
-0000a220: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0000a230: 6f74 2069 7369 6e73 7461 6e63 6528 7a5f  ot isinstance(z_
-0000a240: 626f 756e 6473 2c20 2874 7570 6c65 2c20  bounds, (tuple, 
-0000a250: 6c69 7374 2929 3a0a 2020 2020 2020 2020  list)):.        
-0000a260: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-0000a270: 6c75 6545 7272 6f72 2866 2749 6e76 616c  lueError(f'Inval
-0000a280: 6964 2070 6172 616d 6574 6572 207a 5f62  id parameter z_b
-0000a290: 6f75 6e64 7320 287b 7a5f 626f 756e 6473  ounds ({z_bounds
-0000a2a0: 7d29 2729 0a20 2020 2020 2020 2020 2020  })').           
-0000a2b0: 207a 5f62 6f75 6e64 7320 3d20 7475 706c   z_bounds = tupl
-0000a2c0: 6528 7a5f 626f 756e 6473 290a 0a20 2020  e(z_bounds)..   
-0000a2d0: 2020 2020 2023 2043 6865 636b 2069 6620       # Check if 
-0000a2e0: 7265 6475 6365 6420 6461 7461 2069 7320  reduced data is 
-0000a2f0: 6176 6169 6c61 626c 650a 2020 2020 2020  available.      
-0000a300: 2020 6966 2028 2772 6564 7563 6564 5f64    if ('reduced_d
-0000a310: 6174 6127 206e 6f74 2069 6e20 6e78 656e  ata' not in nxen
-0000a320: 7472 790a 2020 2020 2020 2020 2020 2020  try.            
-0000a330: 2020 2020 6f72 2027 7265 6475 6365 645f      or 'reduced_
-0000a340: 6461 7461 2720 6e6f 7420 696e 206e 7865  data' not in nxe
-0000a350: 6e74 7279 2e64 6174 6129 3a0a 2020 2020  ntry.data):.    
-0000a360: 2020 2020 2020 2020 7261 6973 6520 4b65          raise Ke
-0000a370: 7945 7272 6f72 2866 2755 6e61 626c 6520  yError(f'Unable 
-0000a380: 746f 2066 696e 6420 7661 6c69 6420 7265  to find valid re
-0000a390: 6475 6365 6420 6461 7461 2069 6e20 7b6e  duced data in {n
-0000a3a0: 7865 6e74 7279 7d2e 2729 0a0a 2020 2020  xentry}.')..    
-0000a3b0: 2020 2020 2320 4372 6561 7465 2061 6e20      # Create an 
-0000a3c0: 4e58 7072 6f63 6573 7320 746f 2073 746f  NXprocess to sto
-0000a3d0: 7265 2069 6d61 6765 2072 6563 6f6e 7374  re image reconst
-0000a3e0: 7275 6374 696f 6e20 286d 6574 6129 6461  ruction (meta)da
-0000a3f0: 7461 0a20 2020 2020 2020 206e 7870 726f  ta.        nxpro
-0000a400: 6365 7373 203d 204e 5870 726f 6365 7373  cess = NXprocess
-0000a410: 2829 0a0a 2020 2020 2020 2020 2320 4765  ()..        # Ge
-0000a420: 7420 726f 7461 7469 6f6e 2061 7869 7320  t rotation axis 
-0000a430: 726f 7773 2061 6e64 2063 656e 7465 7273  rows and centers
-0000a440: 0a20 2020 2020 2020 206c 6f77 6572 5f72  .        lower_r
-0000a450: 6f77 203d 2063 656e 7465 725f 696e 666f  ow = center_info
-0000a460: 2e67 6574 2827 6c6f 7765 725f 726f 7727  .get('lower_row'
-0000a470: 290a 2020 2020 2020 2020 6c6f 7765 725f  ).        lower_
-0000a480: 6365 6e74 6572 5f6f 6666 7365 7420 3d20  center_offset = 
-0000a490: 6365 6e74 6572 5f69 6e66 6f2e 6765 7428  center_info.get(
-0000a4a0: 276c 6f77 6572 5f63 656e 7465 725f 6f66  'lower_center_of
-0000a4b0: 6673 6574 2729 0a20 2020 2020 2020 2075  fset').        u
-0000a4c0: 7070 6572 5f72 6f77 203d 2063 656e 7465  pper_row = cente
-0000a4d0: 725f 696e 666f 2e67 6574 2827 7570 7065  r_info.get('uppe
-0000a4e0: 725f 726f 7727 290a 2020 2020 2020 2020  r_row').        
-0000a4f0: 7570 7065 725f 6365 6e74 6572 5f6f 6666  upper_center_off
-0000a500: 7365 7420 3d20 6365 6e74 6572 5f69 6e66  set = center_inf
-0000a510: 6f2e 6765 7428 2775 7070 6572 5f63 656e  o.get('upper_cen
-0000a520: 7465 725f 6f66 6673 6574 2729 0a20 2020  ter_offset').   
-0000a530: 2020 2020 2069 6620 286c 6f77 6572 5f72       if (lower_r
-0000a540: 6f77 2069 7320 4e6f 6e65 206f 7220 6c6f  ow is None or lo
-0000a550: 7765 725f 6365 6e74 6572 5f6f 6666 7365  wer_center_offse
-0000a560: 7420 6973 204e 6f6e 650a 2020 2020 2020  t is None.      
-0000a570: 2020 2020 2020 2020 2020 6f72 2075 7070            or upp
-0000a580: 6572 5f72 6f77 2069 7320 4e6f 6e65 206f  er_row is None o
-0000a590: 7220 7570 7065 725f 6365 6e74 6572 5f6f  r upper_center_o
-0000a5a0: 6666 7365 7420 6973 204e 6f6e 6529 3a0a  ffset is None):.
-0000a5b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000a5c0: 6520 4b65 7945 7272 6f72 280a 2020 2020  e KeyError(.    
-0000a5d0: 2020 2020 2020 2020 2020 2020 2755 6e61              'Una
-0000a5e0: 626c 6520 746f 2066 696e 6420 7661 6c69  ble to find vali
-0000a5f0: 6420 6361 6c69 6272 6174 6564 2063 656e  d calibrated cen
-0000a600: 7465 7220 6178 6973 2069 6e66 6f20 696e  ter axis info in
-0000a610: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0000a620: 2020 202b 2066 277b 6365 6e74 6572 5f69     + f'{center_i
-0000a630: 6e66 6f7d 2e27 290a 2020 2020 2020 2020  nfo}.').        
-0000a640: 6365 6e74 6572 5f73 6c6f 7065 203d 2028  center_slope = (
-0000a650: 7570 7065 725f 6365 6e74 6572 5f6f 6666  upper_center_off
-0000a660: 7365 742d 6c6f 7765 725f 6365 6e74 6572  set-lower_center
-0000a670: 5f6f 6666 7365 7429 205c 0a20 2020 2020  _offset) \.     
-0000a680: 2020 2020 2020 202f 2028 7570 7065 725f         / (upper_
-0000a690: 726f 772d 6c6f 7765 725f 726f 7729 0a0a  row-lower_row)..
-0000a6a0: 2020 2020 2020 2020 2320 4765 7420 7468          # Get th
-0000a6b0: 6574 6173 2028 696e 2064 6567 7265 6573  etas (in degrees
-0000a6c0: 290a 2020 2020 2020 2020 7468 6574 6173  ).        thetas
-0000a6d0: 203d 206e 702e 6173 6172 7261 7928 6e78   = np.asarray(nx
-0000a6e0: 656e 7472 792e 7265 6475 6365 645f 6461  entry.reduced_da
-0000a6f0: 7461 2e72 6f74 6174 696f 6e5f 616e 676c  ta.rotation_angl
-0000a700: 6529 0a0a 2020 2020 2020 2020 2320 5265  e)..        # Re
-0000a710: 636f 6e73 7472 7563 7420 746f 6d6f 6772  construct tomogr
-0000a720: 6170 6879 2064 6174 610a 2020 2020 2020  aphy data.      
-0000a730: 2020 2320 2020 2020 7265 6475 6365 6420    #     reduced 
-0000a740: 6461 7461 2061 7865 7320 6f72 6465 723a  data axes order:
-0000a750: 2073 7461 636b 2c74 6865 7461 2c72 6f77   stack,theta,row
-0000a760: 2c63 6f6c 756d 6e0a 2020 2020 2020 2020  ,column.        
-0000a770: 2320 2020 2020 7265 636f 6e73 7472 7563  #     reconstruc
-0000a780: 7465 6420 6461 7461 206f 7264 6572 2069  ted data order i
-0000a790: 6e20 6561 6368 2073 7461 636b 3a20 726f  n each stack: ro
-0000a7a0: 772f 7a2c 782c 790a 2020 2020 2020 2020  w/z,x,y.        
-0000a7b0: 2320 4e6f 7465 3a20 4e65 7875 7320 6361  # Note: Nexus ca
-0000a7c0: 6e27 7420 666f 6c6c 6f77 2061 206c 696e  n't follow a lin
-0000a7d0: 6b20 6966 2074 6865 2064 6174 6120 6974  k if the data it
-0000a7e0: 2070 6f69 6e74 7320 746f 2069 730a 2020   points to is.  
-0000a7f0: 2020 2020 2020 2320 2020 2020 746f 6f20        #     too 
-0000a800: 6269 6720 6765 7420 7468 6520 6461 7461  big get the data
-0000a810: 2066 726f 6d20 7468 6520 6163 7475 616c   from the actual
-0000a820: 2070 6c61 6365 2c20 6e6f 7420 6672 6f6d   place, not from
-0000a830: 0a20 2020 2020 2020 2023 2020 2020 206e  .        #     n
-0000a840: 7865 6e74 7279 2e64 6174 610a 2020 2020  xentry.data.    
-0000a850: 2020 2020 6966 2027 7a6f 6f6d 5f70 6572      if 'zoom_per
-0000a860: 6327 2069 6e20 6e78 656e 7472 792e 7265  c' in nxentry.re
-0000a870: 6475 6365 645f 6461 7461 3a0a 2020 2020  duced_data:.    
-0000a880: 2020 2020 2020 2020 7265 735f 7469 746c          res_titl
-0000a890: 6520 3d20 6627 7b6e 7865 6e74 7279 2e72  e = f'{nxentry.r
-0000a8a0: 6564 7563 6564 5f64 6174 612e 6174 7472  educed_data.attr
-0000a8b0: 735b 227a 6f6f 6d5f 7065 7263 225d 7d70  s["zoom_perc"]}p
-0000a8c0: 270a 2020 2020 2020 2020 656c 7365 3a0a  '.        else:.
-0000a8d0: 2020 2020 2020 2020 2020 2020 7265 735f              res_
-0000a8e0: 7469 746c 6520 3d20 2766 756c 6c72 6573  title = 'fullres
-0000a8f0: 270a 2020 2020 2020 2020 6e75 6d5f 746f  '.        num_to
-0000a900: 6d6f 5f73 7461 636b 7320 3d20 6e78 656e  mo_stacks = nxen
-0000a910: 7472 792e 7265 6475 6365 645f 6461 7461  try.reduced_data
-0000a920: 2e64 6174 612e 746f 6d6f 5f66 6965 6c64  .data.tomo_field
-0000a930: 732e 7368 6170 655b 305d 0a20 2020 2020  s.shape[0].     
-0000a940: 2020 2074 6f6d 6f5f 7265 636f 6e5f 7374     tomo_recon_st
-0000a950: 6163 6b73 203d 206e 756d 5f74 6f6d 6f5f  acks = num_tomo_
-0000a960: 7374 6163 6b73 2a5b 6e70 2e61 7272 6179  stacks*[np.array
-0000a970: 285b 5d29 5d0a 2020 2020 2020 2020 666f  ([])].        fo
-0000a980: 7220 6920 696e 2072 616e 6765 286e 756d  r i in range(num
-0000a990: 5f74 6f6d 6f5f 7374 6163 6b73 293a 0a20  _tomo_stacks):. 
-0000a9a0: 2020 2020 2020 2020 2020 2023 2043 6f6e             # Con
-0000a9b0: 7665 7274 2072 6564 7563 6564 2064 6174  vert reduced dat
-0000a9c0: 6120 7374 6163 6b20 6672 6f6d 2074 6865  a stack from the
-0000a9d0: 7461 2c72 6f77 2c63 6f6c 756d 6e20 746f  ta,row,column to
-0000a9e0: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-0000a9f0: 2020 2072 6f77 2c74 6865 7461 2c63 6f6c     row,theta,col
-0000aa00: 756d 6e0a 2020 2020 2020 2020 2020 2020  umn.            
-0000aa10: 7430 203d 2074 696d 6528 290a 2020 2020  t0 = time().    
-0000aa20: 2020 2020 2020 2020 746f 6d6f 5f73 7461          tomo_sta
-0000aa30: 636b 203d 206e 702e 6173 6172 7261 7928  ck = np.asarray(
-0000aa40: 6e78 656e 7472 792e 7265 6475 6365 645f  nxentry.reduced_
-0000aa50: 6461 7461 2e64 6174 612e 746f 6d6f 5f66  data.data.tomo_f
-0000aa60: 6965 6c64 735b 695d 290a 2020 2020 2020  ields[i]).      
-0000aa70: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
-0000aa80: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
-0000aa90: 2020 2020 2020 2020 2066 2752 6561 6469           f'Readi
-0000aaa0: 6e67 2072 6564 7563 6564 2064 6174 6120  ng reduced data 
-0000aab0: 7374 6163 6b20 7b69 7d20 746f 6f6b 207b  stack {i} took {
-0000aac0: 7469 6d65 2829 2d74 303a 2e32 667d 2027  time()-t0:.2f} '
-0000aad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000aae0: 202b 2027 7365 636f 6e64 7327 290a 2020   + 'seconds').  
-0000aaf0: 2020 2020 2020 2020 2020 6966 2028 6c65            if (le
-0000ab00: 6e28 746f 6d6f 5f73 7461 636b 2e73 6861  n(tomo_stack.sha
-0000ab10: 7065 2920 213d 2033 0a20 2020 2020 2020  pe) != 3.       
-0000ab20: 2020 2020 2020 2020 2020 2020 206f 7220               or 
-0000ab30: 616e 7928 5472 7565 2066 6f72 2064 696d  any(True for dim
-0000ab40: 2069 6e20 746f 6d6f 5f73 7461 636b 2e73   in tomo_stack.s
-0000ab50: 6861 7065 2069 6620 6e6f 7420 6469 6d29  hape if not dim)
-0000ab60: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000ab70: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
-0000ab80: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0000ab90: 2020 2020 2020 2020 2020 2066 2755 6e61             f'Una
-0000aba0: 626c 6520 746f 206c 6f61 6420 746f 6d6f  ble to load tomo
-0000abb0: 6772 6170 6879 2073 7461 636b 207b 697d  graphy stack {i}
-0000abc0: 2066 6f72 2027 0a20 2020 2020 2020 2020   for '.         
-0000abd0: 2020 2020 2020 2020 2020 202b 2027 7265             + 're
-0000abe0: 636f 6e73 7472 7563 7469 6f6e 2729 0a20  construction'). 
-0000abf0: 2020 2020 2020 2020 2020 2074 6f6d 6f5f             tomo_
-0000ac00: 7374 6163 6b20 3d20 6e70 2e73 7761 7061  stack = np.swapa
-0000ac10: 7865 7328 746f 6d6f 5f73 7461 636b 2c20  xes(tomo_stack, 
-0000ac20: 302c 2031 290a 2020 2020 2020 2020 2020  0, 1).          
-0000ac30: 2020 6173 7365 7274 206c 656e 2874 6865    assert len(the
-0000ac40: 7461 7329 203d 3d20 746f 6d6f 5f73 7461  tas) == tomo_sta
-0000ac50: 636b 2e73 6861 7065 5b31 5d0a 2020 2020  ck.shape[1].    
-0000ac60: 2020 2020 2020 2020 6173 7365 7274 2030          assert 0
-0000ac70: 203c 3d20 6c6f 7765 725f 726f 7720 3c20   <= lower_row < 
-0000ac80: 7570 7065 725f 726f 7720 3c20 746f 6d6f  upper_row < tomo
-0000ac90: 5f73 7461 636b 2e73 6861 7065 5b30 5d0a  _stack.shape[0].
-0000aca0: 2020 2020 2020 2020 2020 2020 6365 6e74              cent
-0000acb0: 6572 5f6f 6666 7365 7473 203d 205b 0a20  er_offsets = [. 
-0000acc0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0000acd0: 6f77 6572 5f63 656e 7465 725f 6f66 6673  ower_center_offs
-0000ace0: 6574 2d6c 6f77 6572 5f72 6f77 2a63 656e  et-lower_row*cen
-0000acf0: 7465 725f 736c 6f70 652c 0a20 2020 2020  ter_slope,.     
-0000ad00: 2020 2020 2020 2020 2020 2075 7070 6572             upper
-0000ad10: 5f63 656e 7465 725f 6f66 6673 6574 202b  _center_offset +
-0000ad20: 2063 656e 7465 725f 736c 6f70 6520 2a20   center_slope * 
-0000ad30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000ad40: 2020 2020 2020 746f 6d6f 5f73 7461 636b        tomo_stack
-0000ad50: 2e73 6861 7065 5b30 5d2d 312d 7570 7065  .shape[0]-1-uppe
-0000ad60: 725f 726f 7729 2c0a 2020 2020 2020 2020  r_row),.        
-0000ad70: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
-0000ad80: 2020 7430 203d 2074 696d 6528 290a 2020    t0 = time().  
-0000ad90: 2020 2020 2020 2020 2020 746f 6d6f 5f72            tomo_r
-0000ada0: 6563 6f6e 5f73 7461 636b 203d 2073 656c  econ_stack = sel
-0000adb0: 662e 5f72 6563 6f6e 7374 7275 6374 5f6f  f._reconstruct_o
-0000adc0: 6e65 5f74 6f6d 6f5f 7374 6163 6b28 0a20  ne_tomo_stack(. 
-0000add0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000ade0: 6f6d 6f5f 7374 6163 6b2c 2074 6865 7461  omo_stack, theta
-0000adf0: 732c 2063 656e 7465 725f 6f66 6673 6574  s, center_offset
-0000ae00: 733d 6365 6e74 6572 5f6f 6666 7365 7473  s=center_offsets
-0000ae10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000ae20: 2020 6e75 6d5f 636f 7265 3d73 656c 662e    num_core=self.
-0000ae30: 5f6e 756d 5f63 6f72 652c 2061 6c67 6f72  _num_core, algor
-0000ae40: 6974 686d 3d27 6772 6964 7265 6327 2c0a  ithm='gridrec',.
-0000ae50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ae60: 7365 636f 6e64 6172 795f 6974 6572 733d  secondary_iters=
-0000ae70: 7365 636f 6e64 6172 795f 6974 6572 732c  secondary_iters,
-0000ae80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ae90: 2072 656d 6f76 655f 7374 7269 7065 5f73   remove_stripe_s
-0000aea0: 6967 6d61 3d72 656d 6f76 655f 7374 7269  igma=remove_stri
-0000aeb0: 7065 5f73 6967 6d61 2c20 7269 6e67 5f77  pe_sigma, ring_w
-0000aec0: 6964 7468 3d72 696e 675f 7769 6474 6829  idth=ring_width)
-0000aed0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000aee0: 662e 5f6c 6f67 6765 722e 696e 666f 280a  f._logger.info(.
-0000aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af00: 6627 5265 636f 6e73 7472 7563 7469 6f6e  f'Reconstruction
-0000af10: 206f 6620 7374 6163 6b20 7b69 7d20 746f   of stack {i} to
-0000af20: 6f6b 207b 7469 6d65 2829 2d74 303a 2e32  ok {time()-t0:.2
-0000af30: 667d 2073 6563 6f6e 6473 2729 0a0a 2020  f} seconds')..  
-0000af40: 2020 2020 2020 2020 2020 2320 436f 6d62            # Comb
-0000af50: 696e 6520 7374 6163 6b73 0a20 2020 2020  ine stacks.     
-0000af60: 2020 2020 2020 2074 6f6d 6f5f 7265 636f         tomo_reco
-0000af70: 6e5f 7374 6163 6b73 5b69 5d20 3d20 746f  n_stacks[i] = to
-0000af80: 6d6f 5f72 6563 6f6e 5f73 7461 636b 0a0a  mo_recon_stack..
-0000af90: 2020 2020 2020 2020 2320 5265 7369 7a65          # Resize
-0000afa0: 2074 6865 2072 6563 6f6e 7374 7275 6374   the reconstruct
-0000afb0: 6564 2074 6f6d 6f67 7261 7068 7920 6461  ed tomography da
-0000afc0: 7461 0a20 2020 2020 2020 2023 2020 2020  ta.        #    
-0000afd0: 2072 6563 6f6e 7374 7275 6374 6564 2064   reconstructed d
-0000afe0: 6174 6120 6f72 6465 7220 696e 2065 6163  ata order in eac
-0000aff0: 6820 7374 6163 6b3a 2072 6f77 2f7a 2c78  h stack: row/z,x
-0000b000: 2c79 0a20 2020 2020 2020 2069 6620 7365  ,y.        if se
-0000b010: 6c66 2e5f 7465 7374 5f6d 6f64 653a 0a20  lf._test_mode:. 
-0000b020: 2020 2020 2020 2020 2020 2078 5f62 6f75             x_bou
-0000b030: 6e64 7320 3d20 7475 706c 6528 7365 6c66  nds = tuple(self
-0000b040: 2e5f 7465 7374 5f63 6f6e 6669 672e 6765  ._test_config.ge
-0000b050: 7428 2778 5f62 6f75 6e64 7327 2929 0a20  t('x_bounds')). 
-0000b060: 2020 2020 2020 2020 2020 2079 5f62 6f75             y_bou
-0000b070: 6e64 7320 3d20 7475 706c 6528 7365 6c66  nds = tuple(self
-0000b080: 2e5f 7465 7374 5f63 6f6e 6669 672e 6765  ._test_config.ge
-0000b090: 7428 2779 5f62 6f75 6e64 7327 2929 0a20  t('y_bounds')). 
-0000b0a0: 2020 2020 2020 2020 2020 207a 5f62 6f75             z_bou
-0000b0b0: 6e64 7320 3d20 4e6f 6e65 0a20 2020 2020  nds = None.     
-0000b0c0: 2020 2065 6c69 6620 7365 6c66 2e5f 696e     elif self._in
-0000b0d0: 7465 7261 6374 6976 653a 0a20 2020 2020  teractive:.     
-0000b0e0: 2020 2020 2020 2078 5f62 6f75 6e64 732c         x_bounds,
-0000b0f0: 2079 5f62 6f75 6e64 732c 207a 5f62 6f75   y_bounds, z_bou
-0000b100: 6e64 7320 3d20 7365 6c66 2e5f 7265 7369  nds = self._resi
-0000b110: 7a65 5f72 6563 6f6e 7374 7275 6374 6564  ze_reconstructed
-0000b120: 5f64 6174 6128 0a20 2020 2020 2020 2020  _data(.         
-0000b130: 2020 2020 2020 2074 6f6d 6f5f 7265 636f         tomo_reco
-0000b140: 6e5f 7374 6163 6b73 2c20 785f 626f 756e  n_stacks, x_boun
-0000b150: 6473 3d78 5f62 6f75 6e64 732c 2079 5f62  ds=x_bounds, y_b
-0000b160: 6f75 6e64 733d 795f 626f 756e 6473 2c0a  ounds=y_bounds,.
-0000b170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b180: 7a5f 626f 756e 6473 3d7a 5f62 6f75 6e64  z_bounds=z_bound
-0000b190: 7329 0a20 2020 2020 2020 2065 6c73 653a  s).        else:
-0000b1a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000b1b0: 785f 626f 756e 6473 203d 3d20 282d 312c  x_bounds == (-1,
-0000b1c0: 202d 3129 3a0a 2020 2020 2020 2020 2020   -1):.          
-0000b1d0: 2020 2020 2020 785f 626f 756e 6473 203d        x_bounds =
-0000b1e0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-0000b1f0: 2020 6966 2078 5f62 6f75 6e64 7320 6973    if x_bounds is
-0000b200: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0000b210: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-0000b220: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
-0000b230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b240: 2027 785f 626f 756e 6473 2075 6e73 7065   'x_bounds unspe
-0000b250: 6369 6669 6564 2c20 7265 636f 6e73 7472  cified, reconstr
-0000b260: 7563 7420 6461 7461 2066 6f72 2066 756c  uct data for ful
-0000b270: 6c20 782d 7261 6e67 6527 290a 2020 2020  l x-range').    
-0000b280: 2020 2020 2020 2020 656c 6966 206e 6f74          elif not
-0000b290: 2069 735f 696e 745f 7061 6972 2878 5f62   is_int_pair(x_b
-0000b2a0: 6f75 6e64 732c 2067 653d 302c 0a20 2020  ounds, ge=0,.   
-0000b2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b2c0: 2020 2020 2020 2020 2020 2020 2020 6c74                lt
-0000b2d0: 3d74 6f6d 6f5f 7265 636f 6e5f 7374 6163  =tomo_recon_stac
-0000b2e0: 6b73 5b30 5d2e 7368 6170 655b 315d 293a  ks[0].shape[1]):
-0000b2f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b300: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-0000b310: 7228 6627 496e 7661 6c69 6420 7061 7261  r(f'Invalid para
-0000b320: 6d65 7465 7220 785f 626f 756e 6473 2028  meter x_bounds (
-0000b330: 7b78 5f62 6f75 6e64 737d 2927 290a 2020  {x_bounds})').  
-0000b340: 2020 2020 2020 2020 2020 6966 2079 5f62            if y_b
-0000b350: 6f75 6e64 7320 3d3d 2028 2d31 2c20 2d31  ounds == (-1, -1
-0000b360: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000b370: 2020 2079 5f62 6f75 6e64 7320 3d20 4e6f     y_bounds = No
-0000b380: 6e65 0a20 2020 2020 2020 2020 2020 2069  ne.            i
-0000b390: 6620 795f 626f 756e 6473 2069 7320 4e6f  f y_bounds is No
-0000b3a0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0000b3b0: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-0000b3c0: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
-0000b3d0: 2020 2020 2020 2020 2020 2020 2020 2779                'y
-0000b3e0: 5f62 6f75 6e64 7320 756e 7370 6563 6966  _bounds unspecif
-0000b3f0: 6965 642c 2072 6563 6f6e 7374 7275 6374  ied, reconstruct
-0000b400: 2064 6174 6120 666f 7220 6675 6c6c 2079   data for full y
-0000b410: 2d72 616e 6765 2729 0a20 2020 2020 2020  -range').       
-0000b420: 2020 2020 2065 6c69 6620 6e6f 7420 6973       elif not is
-0000b430: 5f69 6e74 5f70 6169 7228 0a20 2020 2020  _int_pair(.     
-0000b440: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-0000b450: 5f62 6f75 6e64 732c 2067 653d 302c 206c  _bounds, ge=0, l
-0000b460: 743d 746f 6d6f 5f72 6563 6f6e 5f73 7461  t=tomo_recon_sta
-0000b470: 636b 735b 305d 2e73 6861 7065 5b32 5d29  cks[0].shape[2])
-0000b480: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000b490: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-0000b4a0: 6f72 2866 2749 6e76 616c 6964 2070 6172  or(f'Invalid par
-0000b4b0: 616d 6574 6572 2079 5f62 6f75 6e64 7320  ameter y_bounds 
-0000b4c0: 287b 795f 626f 756e 6473 7d29 2729 0a20  ({y_bounds})'). 
-0000b4d0: 2020 2020 2020 2020 2020 207a 5f62 6f75             z_bou
-0000b4e0: 6e64 7320 3d20 4e6f 6e65 0a20 2020 2020  nds = None.     
-0000b4f0: 2020 2069 6620 785f 626f 756e 6473 2069     if x_bounds i
-0000b500: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0000b510: 2020 2020 785f 7261 6e67 6520 3d20 2830      x_range = (0
-0000b520: 2c20 746f 6d6f 5f72 6563 6f6e 5f73 7461  , tomo_recon_sta
-0000b530: 636b 735b 305d 2e73 6861 7065 5b31 5d29  cks[0].shape[1])
-0000b540: 0a20 2020 2020 2020 2020 2020 2078 5f73  .            x_s
-0000b550: 6c69 6365 203d 2069 6e74 2878 5f72 616e  lice = int(x_ran
-0000b560: 6765 5b31 5d2f 3229 0a20 2020 2020 2020  ge[1]/2).       
-0000b570: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000b580: 2020 2078 5f72 616e 6765 203d 2028 6d69     x_range = (mi
-0000b590: 6e28 785f 626f 756e 6473 292c 206d 6178  n(x_bounds), max
-0000b5a0: 2878 5f62 6f75 6e64 7329 290a 2020 2020  (x_bounds)).    
-0000b5b0: 2020 2020 2020 2020 785f 736c 6963 6520          x_slice 
-0000b5c0: 3d20 696e 7428 2878 5f62 6f75 6e64 735b  = int((x_bounds[
-0000b5d0: 305d 2b78 5f62 6f75 6e64 735b 315d 2920  0]+x_bounds[1]) 
-0000b5e0: 2f20 3229 0a20 2020 2020 2020 2069 6620  / 2).        if 
-0000b5f0: 795f 626f 756e 6473 2069 7320 4e6f 6e65  y_bounds is None
-0000b600: 3a0a 2020 2020 2020 2020 2020 2020 795f  :.            y_
-0000b610: 7261 6e67 6520 3d20 2830 2c20 746f 6d6f  range = (0, tomo
-0000b620: 5f72 6563 6f6e 5f73 7461 636b 735b 305d  _recon_stacks[0]
-0000b630: 2e73 6861 7065 5b32 5d29 0a20 2020 2020  .shape[2]).     
-0000b640: 2020 2020 2020 2079 5f73 6c69 6365 203d         y_slice =
-0000b650: 2069 6e74 2879 5f72 616e 6765 5b31 5d20   int(y_range[1] 
-0000b660: 2f20 3229 0a20 2020 2020 2020 2065 6c73  / 2).        els
-0000b670: 653a 0a20 2020 2020 2020 2020 2020 2079  e:.            y
-0000b680: 5f72 616e 6765 203d 2028 6d69 6e28 795f  _range = (min(y_
-0000b690: 626f 756e 6473 292c 206d 6178 2879 5f62  bounds), max(y_b
-0000b6a0: 6f75 6e64 7329 290a 2020 2020 2020 2020  ounds)).        
-0000b6b0: 2020 2020 795f 736c 6963 6520 3d20 696e      y_slice = in
-0000b6c0: 7428 2879 5f62 6f75 6e64 735b 305d 2b79  t((y_bounds[0]+y
-0000b6d0: 5f62 6f75 6e64 735b 315d 2920 2f20 3229  _bounds[1]) / 2)
-0000b6e0: 0a20 2020 2020 2020 2069 6620 7a5f 626f  .        if z_bo
-0000b6f0: 756e 6473 2069 7320 4e6f 6e65 3a0a 2020  unds is None:.  
-0000b700: 2020 2020 2020 2020 2020 7a5f 7261 6e67            z_rang
-0000b710: 6520 3d20 2830 2c20 746f 6d6f 5f72 6563  e = (0, tomo_rec
-0000b720: 6f6e 5f73 7461 636b 735b 305d 2e73 6861  on_stacks[0].sha
-0000b730: 7065 5b30 5d29 0a20 2020 2020 2020 2020  pe[0]).         
-0000b740: 2020 207a 5f73 6c69 6365 203d 2069 6e74     z_slice = int
-0000b750: 287a 5f72 616e 6765 5b31 5d20 2f20 3229  (z_range[1] / 2)
-0000b760: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0000b770: 2020 2020 2020 2020 2020 207a 5f72 616e             z_ran
-0000b780: 6765 203d 2028 6d69 6e28 7a5f 626f 756e  ge = (min(z_boun
-0000b790: 6473 292c 206d 6178 287a 5f62 6f75 6e64  ds), max(z_bound
-0000b7a0: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-0000b7b0: 7a5f 736c 6963 6520 3d20 696e 7428 287a  z_slice = int((z
-0000b7c0: 5f62 6f75 6e64 735b 305d 2b7a 5f62 6f75  _bounds[0]+z_bou
-0000b7d0: 6e64 735b 315d 2920 2f20 3229 0a0a 2020  nds[1]) / 2)..  
-0000b7e0: 2020 2020 2020 2320 506c 6f74 2061 2066        # Plot a f
-0000b7f0: 6577 2072 6563 6f6e 7374 7275 6374 6564  ew reconstructed
-0000b800: 2069 6d61 6765 2073 6c69 6365 730a 2020   image slices.  
-0000b810: 2020 2020 2020 6966 2073 656c 662e 5f73        if self._s
-0000b820: 6176 655f 6669 6773 3a0a 2020 2020 2020  ave_figs:.      
-0000b830: 2020 2020 2020 666f 7220 692c 2073 7461        for i, sta
-0000b840: 636b 2069 6e20 656e 756d 6572 6174 6528  ck in enumerate(
-0000b850: 746f 6d6f 5f72 6563 6f6e 5f73 7461 636b  tomo_recon_stack
-0000b860: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0000b870: 2020 2020 6966 206e 756d 5f74 6f6d 6f5f      if num_tomo_
-0000b880: 7374 6163 6b73 203d 3d20 313a 0a20 2020  stacks == 1:.   
-0000b890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b8a0: 2062 6173 6574 6974 6c65 203d 2027 7265   basetitle = 're
-0000b8b0: 636f 6e27 0a20 2020 2020 2020 2020 2020  con'.           
-0000b8c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000b8d0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0000b8e0: 6173 6574 6974 6c65 203d 2066 2772 6563  asetitle = f'rec
-0000b8f0: 6f6e 2073 7461 636b 207b 697d 270a 2020  on stack {i}'.  
-0000b900: 2020 2020 2020 2020 2020 2020 2020 7469                ti
-0000b910: 746c 6520 3d20 6627 7b62 6173 6574 6974  tle = f'{basetit
-0000b920: 6c65 7d20 7b72 6573 5f74 6974 6c65 7d20  le} {res_title} 
-0000b930: 7873 6c69 6365 7b78 5f73 6c69 6365 7d27  xslice{x_slice}'
-0000b940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b950: 2071 7569 636b 5f69 6d73 686f 7728 0a20   quick_imshow(. 
-0000b960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b970: 2020 2073 7461 636b 5b7a 5f72 616e 6765     stack[z_range
-0000b980: 5b30 5d3a 7a5f 7261 6e67 655b 315d 2c78  [0]:z_range[1],x
-0000b990: 5f73 6c69 6365 2c79 5f72 616e 6765 5b30  _slice,y_range[0
-0000b9a0: 5d3a 795f 7261 6e67 655b 315d 5d2c 0a20  ]:y_range[1]],. 
-0000b9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b9c0: 2020 2074 6974 6c65 3d74 6974 6c65 2c20     title=title, 
-0000b9d0: 7061 7468 3d73 656c 662e 5f6f 7574 7075  path=self._outpu
-0000b9e0: 745f 666f 6c64 6572 2c20 7361 7665 5f66  t_folder, save_f
-0000b9f0: 6967 3d54 7275 652c 0a20 2020 2020 2020  ig=True,.       
-0000ba00: 2020 2020 2020 2020 2020 2020 2073 6176               sav
-0000ba10: 655f 6f6e 6c79 3d54 7275 6529 0a20 2020  e_only=True).   
-0000ba20: 2020 2020 2020 2020 2020 2020 2074 6974               tit
-0000ba30: 6c65 203d 2066 277b 6261 7365 7469 746c  le = f'{basetitl
-0000ba40: 657d 207b 7265 735f 7469 746c 657d 2079  e} {res_title} y
-0000ba50: 736c 6963 657b 795f 736c 6963 657d 270a  slice{y_slice}'.
-0000ba60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ba70: 7175 6963 6b5f 696d 7368 6f77 280a 2020  quick_imshow(.  
-0000ba80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ba90: 2020 7374 6163 6b5b 7a5f 7261 6e67 655b    stack[z_range[
-0000baa0: 305d 3a7a 5f72 616e 6765 5b31 5d2c 785f  0]:z_range[1],x_
-0000bab0: 7261 6e67 655b 305d 3a78 5f72 616e 6765  range[0]:x_range
-0000bac0: 5b31 5d2c 795f 736c 6963 655d 2c0a 2020  [1],y_slice],.  
-0000bad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bae0: 2020 7469 746c 653d 7469 746c 652c 2070    title=title, p
-0000baf0: 6174 683d 7365 6c66 2e5f 6f75 7470 7574  ath=self._output
-0000bb00: 5f66 6f6c 6465 722c 2073 6176 655f 6669  _folder, save_fi
-0000bb10: 673d 5472 7565 2c0a 2020 2020 2020 2020  g=True,.        
-0000bb20: 2020 2020 2020 2020 2020 2020 7361 7665              save
-0000bb30: 5f6f 6e6c 793d 5472 7565 290a 2020 2020  _only=True).    
-0000bb40: 2020 2020 2020 2020 2020 2020 7469 746c              titl
-0000bb50: 6520 3d20 6627 7b62 6173 6574 6974 6c65  e = f'{basetitle
-0000bb60: 7d20 7b72 6573 5f74 6974 6c65 7d20 7a73  } {res_title} zs
-0000bb70: 6c69 6365 7b7a 5f73 6c69 6365 7d27 0a20  lice{z_slice}'. 
-0000bb80: 2020 2020 2020 2020 2020 2020 2020 2071                 q
-0000bb90: 7569 636b 5f69 6d73 686f 7728 0a20 2020  uick_imshow(.   
-0000bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bbb0: 2073 7461 636b 5b7a 5f73 6c69 6365 2c78   stack[z_slice,x
-0000bbc0: 5f72 616e 6765 5b30 5d3a 785f 7261 6e67  _range[0]:x_rang
-0000bbd0: 655b 315d 2c79 5f72 616e 6765 5b30 5d3a  e[1],y_range[0]:
-0000bbe0: 795f 7261 6e67 655b 315d 5d2c 0a20 2020  y_range[1]],.   
-0000bbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc00: 2074 6974 6c65 3d74 6974 6c65 2c20 7061   title=title, pa
-0000bc10: 7468 3d73 656c 662e 5f6f 7574 7075 745f  th=self._output_
-0000bc20: 666f 6c64 6572 2c20 7361 7665 5f66 6967  folder, save_fig
-0000bc30: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-0000bc40: 2020 2020 2020 2020 2020 2073 6176 655f             save_
-0000bc50: 6f6e 6c79 3d54 7275 6529 0a0a 2020 2020  only=True)..    
-0000bc60: 2020 2020 2320 5361 7665 2074 6573 7420      # Save test 
-0000bc70: 6461 7461 2074 6f20 6669 6c65 0a20 2020  data to file.   
-0000bc80: 2020 2020 2023 2020 2020 2072 6563 6f6e       #     recon
-0000bc90: 7374 7275 6374 6564 2064 6174 6120 6f72  structed data or
-0000bca0: 6465 7220 696e 2065 6163 6820 7374 6163  der in each stac
-0000bcb0: 6b3a 2072 6f77 2f7a 2c78 2c79 0a20 2020  k: row/z,x,y.   
-0000bcc0: 2020 2020 2069 6620 7365 6c66 2e5f 7465       if self._te
-0000bcd0: 7374 5f6d 6f64 653a 0a20 2020 2020 2020  st_mode:.       
-0000bce0: 2020 2020 2066 6f72 2069 2c20 7374 6163       for i, stac
-0000bcf0: 6b20 696e 2065 6e75 6d65 7261 7465 2874  k in enumerate(t
-0000bd00: 6f6d 6f5f 7265 636f 6e5f 7374 6163 6b73  omo_recon_stacks
-0000bd10: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000bd20: 2020 206e 702e 7361 7665 7478 7428 0a20     np.savetxt(. 
-0000bd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd40: 2020 2066 277b 7365 6c66 2e5f 6f75 7470     f'{self._outp
-0000bd50: 7574 5f66 6f6c 6465 727d 2f72 6563 6f6e  ut_folder}/recon
-0000bd60: 5f73 7461 636b 5f7b 697d 2e74 7874 272c  _stack_{i}.txt',
-0000bd70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bd80: 2020 2020 2073 7461 636b 5b7a 5f73 6c69       stack[z_sli
-0000bd90: 6365 2c78 5f72 616e 6765 5b30 5d3a 785f  ce,x_range[0]:x_
-0000bda0: 7261 6e67 655b 315d 2c79 5f72 616e 6765  range[1],y_range
-0000bdb0: 5b30 5d3a 795f 7261 6e67 655b 315d 5d2c  [0]:y_range[1]],
-0000bdc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bdd0: 2020 2020 2066 6d74 3d27 252e 3665 2729       fmt='%.6e')
-0000bde0: 0a0a 2020 2020 2020 2020 2320 4164 6420  ..        # Add 
-0000bdf0: 696d 6167 6520 7265 636f 6e73 7472 7563  image reconstruc
-0000be00: 7469 6f6e 2074 6f20 7265 636f 6e73 7472  tion to reconstr
-0000be10: 7563 7465 6420 6461 7461 204e 5870 726f  ucted data NXpro
-0000be20: 6365 7373 0a20 2020 2020 2020 2023 2020  cess.        #  
-0000be30: 2020 2072 6563 6f6e 7374 7275 6374 6564     reconstructed
-0000be40: 2064 6174 6120 6f72 6465 7220 696e 2065   data order in e
-0000be50: 6163 6820 7374 6163 6b3a 2072 6f77 2f7a  ach stack: row/z
-0000be60: 2c78 2c79 0a20 2020 2020 2020 206e 7870  ,x,y.        nxp
-0000be70: 726f 6365 7373 2e64 6174 6120 3d20 4e58  rocess.data = NX
-0000be80: 6461 7461 2829 0a20 2020 2020 2020 206e  data().        n
-0000be90: 7870 726f 6365 7373 2e61 7474 7273 5b27  xprocess.attrs['
-0000bea0: 6465 6661 756c 7427 5d20 3d20 2764 6174  default'] = 'dat
-0000beb0: 6127 0a20 2020 2020 2020 2066 6f72 206b  a'.        for k
-0000bec0: 2c20 7620 696e 2063 656e 7465 725f 696e  , v in center_in
-0000bed0: 666f 2e69 7465 6d73 2829 3a0a 2020 2020  fo.items():.    
-0000bee0: 2020 2020 2020 2020 6e78 7072 6f63 6573          nxproces
-0000bef0: 735b 6b5d 203d 2076 0a20 2020 2020 2020  s[k] = v.       
-0000bf00: 2069 6620 785f 626f 756e 6473 2069 7320   if x_bounds is 
-0000bf10: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000bf20: 2020 2020 2020 6e78 7072 6f63 6573 732e        nxprocess.
-0000bf30: 785f 626f 756e 6473 203d 2078 5f62 6f75  x_bounds = x_bou
-0000bf40: 6e64 730a 2020 2020 2020 2020 6966 2079  nds.        if y
-0000bf50: 5f62 6f75 6e64 7320 6973 206e 6f74 204e  _bounds is not N
-0000bf60: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000bf70: 206e 7870 726f 6365 7373 2e79 5f62 6f75   nxprocess.y_bou
-0000bf80: 6e64 7320 3d20 795f 626f 756e 6473 0a20  nds = y_bounds. 
-0000bf90: 2020 2020 2020 2069 6620 7a5f 626f 756e         if z_boun
-0000bfa0: 6473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ds is not None:.
-0000bfb0: 2020 2020 2020 2020 2020 2020 6e78 7072              nxpr
-0000bfc0: 6f63 6573 732e 7a5f 626f 756e 6473 203d  ocess.z_bounds =
-0000bfd0: 207a 5f62 6f75 6e64 730a 2020 2020 2020   z_bounds.      
-0000bfe0: 2020 6e78 7072 6f63 6573 732e 6461 7461    nxprocess.data
-0000bff0: 5b27 7265 636f 6e73 7472 7563 7465 645f  ['reconstructed_
-0000c000: 6461 7461 275d 203d 206e 702e 6173 6172  data'] = np.asar
-0000c010: 7261 7928 0a20 2020 2020 2020 2020 2020  ray(.           
-0000c020: 205b 7374 6163 6b5b 7a5f 7261 6e67 655b   [stack[z_range[
-0000c030: 305d 3a7a 5f72 616e 6765 5b31 5d2c 785f  0]:z_range[1],x_
-0000c040: 7261 6e67 655b 305d 3a78 5f72 616e 6765  range[0]:x_range
-0000c050: 5b31 5d2c 0a20 2020 2020 2020 2020 2020  [1],.           
-0000c060: 2020 795f 7261 6e67 655b 305d 3a79 5f72    y_range[0]:y_r
-0000c070: 616e 6765 5b31 5d5d 2066 6f72 2073 7461  ange[1]] for sta
-0000c080: 636b 2069 6e20 746f 6d6f 5f72 6563 6f6e  ck in tomo_recon
-0000c090: 5f73 7461 636b 735d 290a 2020 2020 2020  _stacks]).      
-0000c0a0: 2020 6e78 7072 6f63 6573 732e 6461 7461    nxprocess.data
-0000c0b0: 2e61 7474 7273 5b27 7369 676e 616c 275d  .attrs['signal']
-0000c0c0: 203d 2027 7265 636f 6e73 7472 7563 7465   = 'reconstructe
-0000c0d0: 645f 6461 7461 270a 0a20 2020 2020 2020  d_data'..       
-0000c0e0: 2023 2043 7265 6174 6520 6120 636f 7079   # Create a copy
-0000c0f0: 206f 6620 7468 6520 696e 7075 7420 4e65   of the input Ne
-0000c100: 7875 7320 6f62 6a65 6374 2061 6e64 2072  xus object and r
-0000c110: 656d 6f76 6520 7265 6475 6365 640a 2020  emove reduced.  
-0000c120: 2020 2020 2020 2320 2020 2020 6461 7461        #     data
-0000c130: 0a20 2020 2020 2020 2065 7863 6c75 6465  .        exclude
-0000c140: 5f69 7465 6d73 203d 205b 0a20 2020 2020  _items = [.     
-0000c150: 2020 2020 2020 2066 277b 6e78 656e 7472         f'{nxentr
-0000c160: 792e 6e78 6e61 6d65 7d2f 7265 6475 6365  y.nxname}/reduce
-0000c170: 645f 6461 7461 2f64 6174 6127 2c0a 2020  d_data/data',.  
-0000c180: 2020 2020 2020 2020 2020 6627 7b6e 7865            f'{nxe
-0000c190: 6e74 7279 2e6e 786e 616d 657d 2f64 6174  ntry.nxname}/dat
-0000c1a0: 612f 7265 6475 6365 645f 6461 7461 272c  a/reduced_data',
-0000c1b0: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
-0000c1c0: 2020 206e 7872 6f6f 745f 636f 7079 203d     nxroot_copy =
-0000c1d0: 206e 7863 6f70 7928 6e78 726f 6f74 2c20   nxcopy(nxroot, 
-0000c1e0: 6578 636c 7564 655f 6e78 7061 7468 733d  exclude_nxpaths=
-0000c1f0: 6578 636c 7564 655f 6974 656d 7329 0a0a  exclude_items)..
-0000c200: 2020 2020 2020 2020 2320 4164 6420 7468          # Add th
-0000c210: 6520 7265 636f 6e73 7472 7563 7465 6420  e reconstructed 
-0000c220: 6461 7461 204e 5870 726f 6365 7373 2074  data NXprocess t
-0000c230: 6f20 7468 6520 6e65 7720 4e65 7875 7320  o the new Nexus 
-0000c240: 6f62 6a65 6374 0a20 2020 2020 2020 206e  object.        n
-0000c250: 7865 6e74 7279 5f63 6f70 7920 3d20 6e78  xentry_copy = nx
-0000c260: 726f 6f74 5f63 6f70 795b 6e78 726f 6f74  root_copy[nxroot
-0000c270: 5f63 6f70 792e 6174 7472 735b 2764 6566  _copy.attrs['def
-0000c280: 6175 6c74 275d 5d0a 2020 2020 2020 2020  ault']].        
-0000c290: 6e78 656e 7472 795f 636f 7079 2e72 6563  nxentry_copy.rec
-0000c2a0: 6f6e 7374 7275 6374 6564 5f64 6174 6120  onstructed_data 
-0000c2b0: 3d20 6e78 7072 6f63 6573 730a 2020 2020  = nxprocess.    
-0000c2c0: 2020 2020 6966 2027 6461 7461 2720 6e6f      if 'data' no
-0000c2d0: 7420 696e 206e 7865 6e74 7279 5f63 6f70  t in nxentry_cop
-0000c2e0: 793a 0a20 2020 2020 2020 2020 2020 206e  y:.            n
-0000c2f0: 7865 6e74 7279 5f63 6f70 792e 6461 7461  xentry_copy.data
-0000c300: 203d 204e 5864 6174 6128 290a 2020 2020   = NXdata().    
-0000c310: 2020 2020 6e78 656e 7472 795f 636f 7079      nxentry_copy
-0000c320: 2e61 7474 7273 5b27 6465 6661 756c 7427  .attrs['default'
-0000c330: 5d20 3d20 2764 6174 6127 0a20 2020 2020  ] = 'data'.     
-0000c340: 2020 206e 7865 6e74 7279 5f63 6f70 792e     nxentry_copy.
-0000c350: 6461 7461 2e6d 616b 656c 696e 6b28 0a20  data.makelink(. 
-0000c360: 2020 2020 2020 2020 2020 206e 7870 726f             nxpro
-0000c370: 6365 7373 2e64 6174 612e 7265 636f 6e73  cess.data.recons
-0000c380: 7472 7563 7465 645f 6461 7461 2c20 6e61  tructed_data, na
-0000c390: 6d65 3d27 7265 636f 6e73 7472 7563 7465  me='reconstructe
-0000c3a0: 645f 6461 7461 2729 0a20 2020 2020 2020  d_data').       
-0000c3b0: 206e 7865 6e74 7279 5f63 6f70 792e 6461   nxentry_copy.da
-0000c3c0: 7461 2e61 7474 7273 5b27 7369 676e 616c  ta.attrs['signal
-0000c3d0: 275d 203d 2027 7265 636f 6e73 7472 7563  '] = 'reconstruc
-0000c3e0: 7465 645f 6461 7461 270a 0a20 2020 2020  ted_data'..     
-0000c3f0: 2020 2072 6574 7572 6e20 6e78 726f 6f74     return nxroot
-0000c400: 5f63 6f70 790a 0a20 2020 2064 6566 2063  _copy..    def c
-0000c410: 6f6d 6269 6e65 5f64 6174 6128 0a20 2020  ombine_data(.   
-0000c420: 2020 2020 2020 2020 2073 656c 662c 206e           self, n
-0000c430: 7872 6f6f 742c 2078 5f62 6f75 6e64 733d  xroot, x_bounds=
-0000c440: 4e6f 6e65 2c20 795f 626f 756e 6473 3d4e  None, y_bounds=N
-0000c450: 6f6e 652c 207a 5f62 6f75 6e64 733d 4e6f  one, z_bounds=No
-0000c460: 6e65 293a 0a20 2020 2020 2020 2022 2222  ne):.        """
-0000c470: 436f 6d62 696e 6520 7468 6520 7265 636f  Combine the reco
-0000c480: 6e73 7472 7563 7465 6420 746f 6d6f 6772  nstructed tomogr
-0000c490: 6170 6879 2073 7461 636b 732e 0a0a 2020  aphy stacks...  
-0000c4a0: 2020 2020 2020 3a70 6172 616d 206e 7872        :param nxr
-0000c4b0: 6f6f 743a 2041 2073 7461 636b 206f 6620  oot: A stack of 
-0000c4c0: 7265 636f 6e73 7472 7563 7465 6420 746f  reconstructed to
-0000c4d0: 6d6f 6772 6170 6879 2064 6174 6173 6574  mography dataset
-0000c4e0: 730a 2020 2020 2020 2020 3a74 7970 6520  s.        :type 
-0000c4f0: 6461 7461 3a20 6e65 7875 7366 6f72 6d61  data: nexusforma
-0000c500: 742e 6e65 7875 732e 4e58 726f 6f74 0a20  t.nexus.NXroot. 
-0000c510: 2020 2020 2020 203a 7061 7261 6d20 785f         :param x_
-0000c520: 626f 756e 6473 3a20 436f 6d62 696e 6564  bounds: Combined
-0000c530: 2069 6d61 6765 2062 6f75 6e64 7320 696e   image bounds in
-0000c540: 2074 6865 2078 2d64 6972 6563 7469 6f6e   the x-direction
-0000c550: 0a20 2020 2020 2020 203a 7479 7065 2078  .        :type x
-0000c560: 5f62 6f75 6e64 733a 2074 7570 6c65 2869  _bounds: tuple(i
-0000c570: 6e74 2c20 696e 7429 2c20 6c69 7374 5b69  nt, int), list[i
-0000c580: 6e74 5d2c 206f 7074 696f 6e61 6c0a 2020  nt], optional.  
-0000c590: 2020 2020 2020 3a70 6172 616d 2079 5f62        :param y_b
-0000c5a0: 6f75 6e64 733a 2043 6f6d 6269 6e65 6420  ounds: Combined 
-0000c5b0: 696d 6167 6520 626f 756e 6473 2069 6e20  image bounds in 
-0000c5c0: 7468 6520 792d 6469 7265 6374 696f 6e0a  the y-direction.
-0000c5d0: 2020 2020 2020 2020 3a74 7970 6520 795f          :type y_
-0000c5e0: 626f 756e 6473 3a20 7475 706c 6528 696e  bounds: tuple(in
-0000c5f0: 742c 2069 6e74 292c 206c 6973 745b 696e  t, int), list[in
-0000c600: 745d 2c20 6f70 7469 6f6e 616c 0a20 2020  t], optional.   
-0000c610: 2020 2020 203a 7061 7261 6d20 7a5f 626f       :param z_bo
-0000c620: 756e 6473 3a20 436f 6d62 696e 6564 2069  unds: Combined i
-0000c630: 6d61 6765 2062 6f75 6e64 7320 696e 2074  mage bounds in t
-0000c640: 6865 207a 2d64 6972 6563 7469 6f6e 0a20  he z-direction. 
-0000c650: 2020 2020 2020 203a 7479 7065 207a 5f62         :type z_b
-0000c660: 6f75 6e64 733a 2074 7570 6c65 2869 6e74  ounds: tuple(int
-0000c670: 2c20 696e 7429 2c20 6c69 7374 5b69 6e74  , int), list[int
-0000c680: 5d2c 206f 7074 696f 6e61 6c0a 2020 2020  ], optional.    
-0000c690: 2020 2020 3a72 6574 7572 6e3a 2043 6f6d      :return: Com
-0000c6a0: 6269 6e65 6420 7265 636f 6e73 7472 7563  bined reconstruc
-0000c6b0: 7465 6420 746f 6d6f 6772 6170 6879 2064  ted tomography d
-0000c6c0: 6174 610a 2020 2020 2020 2020 3a72 7479  ata.        :rty
-0000c6d0: 7065 3a20 6469 6374 0a20 2020 2020 2020  pe: dict.       
-0000c6e0: 2022 2222 0a20 2020 2020 2020 2023 2054   """.        # T
-0000c6f0: 6869 7264 2070 6172 7479 206d 6f64 756c  hird party modul
-0000c700: 6573 0a20 2020 2020 2020 2066 726f 6d20  es.        from 
-0000c710: 6e65 7875 7366 6f72 6d61 742e 6e65 7875  nexusformat.nexu
-0000c720: 7320 696d 706f 7274 2028 0a20 2020 2020  s import (.     
-0000c730: 2020 2020 2020 204e 5864 6174 612c 0a20         NXdata,. 
-0000c740: 2020 2020 2020 2020 2020 204e 5865 6e74             NXent
-0000c750: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
-0000c760: 4e58 7072 6f63 6573 732c 0a20 2020 2020  NXprocess,.     
-0000c770: 2020 2020 2020 204e 5872 6f6f 742c 0a20         NXroot,. 
-0000c780: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0000c790: 2020 2320 4c6f 6361 6c20 6d6f 6475 6c65    # Local module
-0000c7a0: 730a 2020 2020 2020 2020 6672 6f6d 2043  s.        from C
-0000c7b0: 4841 502e 636f 6d6d 6f6e 2e75 7469 6c73  HAP.common.utils
-0000c7c0: 2e67 656e 6572 616c 2069 6d70 6f72 7420  .general import 
-0000c7d0: 6973 5f69 6e74 5f70 6169 720a 0a20 2020  is_int_pair..   
-0000c7e0: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
-0000c7f0: 722e 696e 666f 2827 436f 6d62 696e 6520  r.info('Combine 
-0000c800: 7468 6520 7265 636f 6e73 7472 7563 7465  the reconstructe
-0000c810: 6420 746f 6d6f 6772 6170 6879 2073 7461  d tomography sta
-0000c820: 636b 7327 290a 0a20 2020 2020 2020 2069  cks')..        i
-0000c830: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-0000c840: 286e 7872 6f6f 742c 204e 5872 6f6f 7429  (nxroot, NXroot)
-0000c850: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0000c860: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-0000c870: 2749 6e76 616c 6964 2070 6172 616d 6574  'Invalid paramet
-0000c880: 6572 206e 7872 6f6f 7420 287b 6e78 726f  er nxroot ({nxro
-0000c890: 6f74 7d29 2729 0a20 2020 2020 2020 206e  ot})').        n
-0000c8a0: 7865 6e74 7279 203d 206e 7872 6f6f 745b  xentry = nxroot[
-0000c8b0: 6e78 726f 6f74 2e61 7474 7273 5b27 6465  nxroot.attrs['de
-0000c8c0: 6661 756c 7427 5d5d 0a20 2020 2020 2020  fault']].       
-0000c8d0: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
-0000c8e0: 6365 286e 7865 6e74 7279 2c20 4e58 656e  ce(nxentry, NXen
-0000c8f0: 7472 7929 3a0a 2020 2020 2020 2020 2020  try):.          
-0000c900: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-0000c910: 6f72 2866 2749 6e76 616c 6964 206e 7865  or(f'Invalid nxe
-0000c920: 6e74 7279 2028 7b6e 7865 6e74 7279 7d29  ntry ({nxentry})
-0000c930: 2729 0a20 2020 2020 2020 2069 6620 785f  ').        if x_
-0000c940: 626f 756e 6473 2069 7320 6e6f 7420 4e6f  bounds is not No
-0000c950: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0000c960: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-0000c970: 6528 785f 626f 756e 6473 2c20 2874 7570  e(x_bounds, (tup
-0000c980: 6c65 2c20 6c69 7374 2929 3a0a 2020 2020  le, list)):.    
-0000c990: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000c9a0: 6520 5661 6c75 6545 7272 6f72 2866 2749  e ValueError(f'I
-0000c9b0: 6e76 616c 6964 2070 6172 616d 6574 6572  nvalid parameter
-0000c9c0: 2078 5f62 6f75 6e64 7320 287b 785f 626f   x_bounds ({x_bo
-0000c9d0: 756e 6473 7d29 2729 0a20 2020 2020 2020  unds})').       
-0000c9e0: 2020 2020 2078 5f62 6f75 6e64 7320 3d20       x_bounds = 
-0000c9f0: 7475 706c 6528 785f 626f 756e 6473 290a  tuple(x_bounds).
-0000ca00: 2020 2020 2020 2020 6966 2079 5f62 6f75          if y_bou
-0000ca10: 6e64 7320 6973 206e 6f74 204e 6f6e 653a  nds is not None:
-0000ca20: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000ca30: 6e6f 7420 6973 696e 7374 616e 6365 2879  not isinstance(y
-0000ca40: 5f62 6f75 6e64 732c 2028 7475 706c 652c  _bounds, (tuple,
-0000ca50: 206c 6973 7429 293a 0a20 2020 2020 2020   list)):.       
-0000ca60: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-0000ca70: 616c 7565 4572 726f 7228 6627 496e 7661  alueError(f'Inva
-0000ca80: 6c69 6420 7061 7261 6d65 7465 7220 795f  lid parameter y_
-0000ca90: 626f 756e 6473 2028 7b79 5f62 6f75 6e64  bounds ({y_bound
-0000caa0: 737d 2927 290a 2020 2020 2020 2020 2020  s})').          
-0000cab0: 2020 795f 626f 756e 6473 203d 2074 7570    y_bounds = tup
-0000cac0: 6c65 2879 5f62 6f75 6e64 7329 0a20 2020  le(y_bounds).   
-0000cad0: 2020 2020 2069 6620 7a5f 626f 756e 6473       if z_bounds
-0000cae0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0000caf0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0000cb00: 2069 7369 6e73 7461 6e63 6528 7a5f 626f   isinstance(z_bo
-0000cb10: 756e 6473 2c20 2874 7570 6c65 2c20 6c69  unds, (tuple, li
-0000cb20: 7374 2929 3a0a 2020 2020 2020 2020 2020  st)):.          
-0000cb30: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-0000cb40: 6545 7272 6f72 2866 2749 6e76 616c 6964  eError(f'Invalid
-0000cb50: 2070 6172 616d 6574 6572 207a 5f62 6f75   parameter z_bou
-0000cb60: 6e64 7320 287b 7a5f 626f 756e 6473 7d29  nds ({z_bounds})
-0000cb70: 2729 0a20 2020 2020 2020 2020 2020 207a  ').            z
-0000cb80: 5f62 6f75 6e64 7320 3d20 7475 706c 6528  _bounds = tuple(
-0000cb90: 7a5f 626f 756e 6473 290a 0a20 2020 2020  z_bounds)..     
-0000cba0: 2020 2023 2043 6865 636b 2069 6620 7265     # Check if re
-0000cbb0: 636f 6e73 7472 7563 7465 6420 696d 6167  constructed imag
-0000cbc0: 6520 6461 7461 2069 7320 6176 6169 6c61  e data is availa
-0000cbd0: 626c 650a 2020 2020 2020 2020 6966 2028  ble.        if (
-0000cbe0: 2772 6563 6f6e 7374 7275 6374 6564 5f64  'reconstructed_d
-0000cbf0: 6174 6127 206e 6f74 2069 6e20 6e78 656e  ata' not in nxen
-0000cc00: 7472 790a 2020 2020 2020 2020 2020 2020  try.            
-0000cc10: 2020 2020 6f72 2027 7265 636f 6e73 7472      or 'reconstr
-0000cc20: 7563 7465 645f 6461 7461 2720 6e6f 7420  ucted_data' not 
-0000cc30: 696e 206e 7865 6e74 7279 2e64 6174 6129  in nxentry.data)
-0000cc40: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0000cc50: 6973 6520 4b65 7945 7272 6f72 280a 2020  ise KeyError(.  
-0000cc60: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0000cc70: 556e 6162 6c65 2074 6f20 6669 6e64 2076  Unable to find v
-0000cc80: 616c 6964 2072 6563 6f6e 7374 7275 6374  alid reconstruct
-0000cc90: 6564 2069 6d61 6765 2064 6174 6120 696e  ed image data in
-0000cca0: 207b 6e78 656e 7472 797d 2729 0a0a 2020   {nxentry}')..  
-0000ccb0: 2020 2020 2020 2320 4372 6561 7465 2061        # Create a
-0000ccc0: 6e20 4e58 7072 6f63 6573 7320 746f 2073  n NXprocess to s
-0000ccd0: 746f 7265 2063 6f6d 6269 6e65 6420 696d  tore combined im
-0000cce0: 6167 6520 7265 636f 6e73 7472 7563 7469  age reconstructi
-0000ccf0: 6f6e 0a20 2020 2020 2020 2023 2020 2020  on.        #    
-0000cd00: 2028 6d65 7461 2964 6174 610a 2020 2020   (meta)data.    
-0000cd10: 2020 2020 6e78 7072 6f63 6573 7320 3d20      nxprocess = 
-0000cd20: 4e58 7072 6f63 6573 7328 290a 0a20 2020  NXprocess()..   
-0000cd30: 2020 2020 2023 2047 6574 2074 6865 2072       # Get the r
-0000cd40: 6563 6f6e 7374 7275 6374 6564 2064 6174  econstructed dat
-0000cd50: 610a 2020 2020 2020 2020 2320 2020 2020  a.        #     
-0000cd60: 7265 636f 6e73 7472 7563 7465 6420 6461  reconstructed da
-0000cd70: 7461 206f 7264 6572 3a20 7374 6163 6b2c  ta order: stack,
-0000cd80: 726f 7728 7a29 2c78 2c79 0a20 2020 2020  row(z),x,y.     
-0000cd90: 2020 2023 204e 6f74 653a 204e 6578 7573     # Note: Nexus
-0000cda0: 2063 616e 2774 2066 6f6c 6c6f 7720 6120   can't follow a 
-0000cdb0: 6c69 6e6b 2069 6620 7468 6520 6461 7461  link if the data
-0000cdc0: 2069 7420 706f 696e 7473 2074 6f20 6973   it points to is
-0000cdd0: 0a20 2020 2020 2020 2023 2020 2020 2074  .        #     t
-0000cde0: 6f6f 2062 6967 2067 6574 2074 6865 2064  oo big get the d
-0000cdf0: 6174 6120 6672 6f6d 2074 6865 2061 6374  ata from the act
-0000ce00: 7561 6c20 706c 6163 652c 206e 6f74 2066  ual place, not f
-0000ce10: 726f 6d0a 2020 2020 2020 2020 2320 2020  rom.        #   
-0000ce20: 2020 6e78 656e 7472 792e 6461 7461 0a20    nxentry.data. 
-0000ce30: 2020 2020 2020 206e 756d 5f74 6f6d 6f5f         num_tomo_
-0000ce40: 7374 6163 6b73 203d 205c 0a20 2020 2020  stacks = \.     
-0000ce50: 2020 2020 2020 206e 7865 6e74 7279 2e72         nxentry.r
-0000ce60: 6563 6f6e 7374 7275 6374 6564 5f64 6174  econstructed_dat
-0000ce70: 612e 6461 7461 2e72 6563 6f6e 7374 7275  a.data.reconstru
-0000ce80: 6374 6564 5f64 6174 612e 7368 6170 655b  cted_data.shape[
-0000ce90: 305d 0a20 2020 2020 2020 2069 6620 6e75  0].        if nu
-0000cea0: 6d5f 746f 6d6f 5f73 7461 636b 7320 3d3d  m_tomo_stacks ==
-0000ceb0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-0000cec0: 7365 6c66 2e5f 6c6f 6767 6572 2e69 6e66  self._logger.inf
-0000ced0: 6f28 274f 6e6c 7920 6f6e 6520 7374 6163  o('Only one stac
-0000cee0: 6b20 6176 6169 6c61 626c 653a 206c 6561  k available: lea
-0000cef0: 7669 6e67 2063 6f6d 6269 6e65 5f64 6174  ving combine_dat
-0000cf00: 6127 290a 2020 2020 2020 2020 2020 2020  a').            
-0000cf10: 7265 7475 726e 204e 6f6e 650a 0a20 2020  return None..   
-0000cf20: 2020 2020 2023 2043 6f6d 6269 6e65 2074       # Combine t
-0000cf30: 6865 2072 6563 6f6e 7374 7275 6374 6564  he reconstructed
-0000cf40: 2073 7461 636b 730a 2020 2020 2020 2020   stacks.        
-0000cf50: 2320 286c 6f61 6420 6f6e 6520 7374 6163  # (load one stac
-0000cf60: 6b20 6174 2061 2074 696d 6520 746f 2072  k at a time to r
-0000cf70: 6564 7563 6520 7269 736b 206f 6620 6869  educe risk of hi
-0000cf80: 7474 696e 6720 4e65 7875 730a 2020 2020  tting Nexus.    
-0000cf90: 2020 2020 2320 2020 2020 6461 7461 2061      #     data a
-0000cfa0: 6363 6573 7320 6c69 6d69 7429 0a20 2020  ccess limit).   
-0000cfb0: 2020 2020 2074 3020 3d20 7469 6d65 2829       t0 = time()
-0000cfc0: 0a20 2020 2020 2020 2074 6f6d 6f5f 7265  .        tomo_re
-0000cfd0: 636f 6e5f 636f 6d62 696e 6564 203d 206e  con_combined = n
-0000cfe0: 702e 6173 6172 7261 7928 0a20 2020 2020  p.asarray(.     
-0000cff0: 2020 2020 2020 206e 7865 6e74 7279 2e72         nxentry.r
-0000d000: 6563 6f6e 7374 7275 6374 6564 5f64 6174  econstructed_dat
-0000d010: 612e 6461 7461 2e72 6563 6f6e 7374 7275  a.data.reconstru
-0000d020: 6374 6564 5f64 6174 615b 305d 290a 2020  cted_data[0]).  
-0000d030: 2020 2020 2020 6966 206e 756d 5f74 6f6d        if num_tom
-0000d040: 6f5f 7374 6163 6b73 203e 2032 3a0a 2020  o_stacks > 2:.  
-0000d050: 2020 2020 2020 2020 2020 746f 6d6f 5f72            tomo_r
-0000d060: 6563 6f6e 5f63 6f6d 6269 6e65 6420 3d20  econ_combined = 
-0000d070: 6e70 2e63 6f6e 6361 7465 6e61 7465 280a  np.concatenate(.
-0000d080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d090: 5b74 6f6d 6f5f 7265 636f 6e5f 636f 6d62  [tomo_recon_comb
-0000d0a0: 696e 6564 5d0a 2020 2020 2020 2020 2020  ined].          
-0000d0b0: 2020 2020 2020 2b20 5b6e 7865 6e74 7279        + [nxentry
-0000d0c0: 2e72 6563 6f6e 7374 7275 6374 6564 5f64  .reconstructed_d
-0000d0d0: 6174 612e 6461 7461 2e72 6563 6f6e 7374  ata.data.reconst
-0000d0e0: 7275 6374 6564 5f64 6174 615b 695d 0a20  ructed_data[i]. 
-0000d0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d100: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-0000d110: 2831 2c20 6e75 6d5f 746f 6d6f 5f73 7461  (1, num_tomo_sta
-0000d120: 636b 732d 3129 5d29 0a20 2020 2020 2020  cks-1)]).       
-0000d130: 2069 6620 6e75 6d5f 746f 6d6f 5f73 7461   if num_tomo_sta
-0000d140: 636b 7320 3e20 313a 0a20 2020 2020 2020  cks > 1:.       
-0000d150: 2020 2020 2074 6f6d 6f5f 7265 636f 6e5f       tomo_recon_
-0000d160: 636f 6d62 696e 6564 203d 206e 702e 636f  combined = np.co
-0000d170: 6e63 6174 656e 6174 6528 0a20 2020 2020  ncatenate(.     
-0000d180: 2020 2020 2020 2020 2020 205b 746f 6d6f             [tomo
-0000d190: 5f72 6563 6f6e 5f63 6f6d 6269 6e65 645d  _recon_combined]
-0000d1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d1b0: 202b 205b 6e78 656e 7472 792e 7265 636f   + [nxentry.reco
-0000d1c0: 6e73 7472 7563 7465 645f 6461 7461 2e64  nstructed_data.d
-0000d1d0: 6174 612e 7265 636f 6e73 7472 7563 7465  ata.reconstructe
-0000d1e0: 645f 6461 7461 5b0a 2020 2020 2020 2020  d_data[.        
-0000d1f0: 2020 2020 2020 2020 2020 206e 756d 5f74             num_t
-0000d200: 6f6d 6f5f 7374 6163 6b73 2d31 5d5d 290a  omo_stacks-1]]).
-0000d210: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-0000d220: 6767 6572 2e69 6e66 6f28 0a20 2020 2020  gger.info(.     
-0000d230: 2020 2020 2020 2066 2743 6f6d 6269 6e69         f'Combini
-0000d240: 6e67 2074 6865 2072 6563 6f6e 7374 7275  ng the reconstru
-0000d250: 6374 6564 2073 7461 636b 7320 746f 6f6b  cted stacks took
-0000d260: 207b 7469 6d65 2829 2d74 303a 2e32 667d   {time()-t0:.2f}
-0000d270: 2073 6563 6f6e 6473 2729 0a0a 2020 2020   seconds')..    
-0000d280: 2020 2020 2320 5265 7369 7a65 2074 6865      # Resize the
-0000d290: 2063 6f6d 6269 6e65 6420 746f 6d6f 6772   combined tomogr
-0000d2a0: 6170 6879 2064 6174 6120 7374 6163 6b73  aphy data stacks
-0000d2b0: 0a20 2020 2020 2020 2023 2020 2020 2063  .        #     c
-0000d2c0: 6f6d 6269 6e65 6420 6461 7461 206f 7264  ombined data ord
-0000d2d0: 6572 3a20 726f 772f 7a2c 782c 790a 2020  er: row/z,x,y.  
-0000d2e0: 2020 2020 2020 6966 2073 656c 662e 5f74        if self._t
-0000d2f0: 6573 745f 6d6f 6465 3a0a 2020 2020 2020  est_mode:.      
-0000d300: 2020 2020 2020 785f 626f 756e 6473 203d        x_bounds =
-0000d310: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-0000d320: 2020 795f 626f 756e 6473 203d 204e 6f6e    y_bounds = Non
-0000d330: 650a 2020 2020 2020 2020 2020 2020 7a5f  e.            z_
-0000d340: 626f 756e 6473 203d 2074 7570 6c65 2873  bounds = tuple(s
-0000d350: 656c 662e 5f74 6573 745f 636f 6e66 6967  elf._test_config
-0000d360: 2e67 6574 2827 7a5f 626f 756e 6473 2729  .get('z_bounds')
-0000d370: 290a 2020 2020 2020 2020 656c 6966 2073  ).        elif s
-0000d380: 656c 662e 5f69 6e74 6572 6163 7469 7665  elf._interactive
-0000d390: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0000d3a0: 2078 5f62 6f75 6e64 7320 6973 204e 6f6e   x_bounds is Non
-0000d3b0: 6520 616e 6420 785f 626f 756e 6473 2069  e and x_bounds i
-0000d3c0: 6e20 6e78 656e 7472 792e 7265 636f 6e73  n nxentry.recons
-0000d3d0: 7472 7563 7465 645f 6461 7461 3a0a 2020  tructed_data:.  
-0000d3e0: 2020 2020 2020 2020 2020 2020 2020 785f                x_
-0000d3f0: 626f 756e 6473 203d 2028 2d31 2c20 2d31  bounds = (-1, -1
-0000d400: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0000d410: 2079 5f62 6f75 6e64 7320 6973 204e 6f6e   y_bounds is Non
-0000d420: 6520 616e 6420 795f 626f 756e 6473 2069  e and y_bounds i
-0000d430: 6e20 6e78 656e 7472 792e 7265 636f 6e73  n nxentry.recons
-0000d440: 7472 7563 7465 645f 6461 7461 3a0a 2020  tructed_data:.  
-0000d450: 2020 2020 2020 2020 2020 2020 2020 795f                y_
-0000d460: 626f 756e 6473 203d 2028 2d31 2c20 2d31  bounds = (-1, -1
-0000d470: 290a 2020 2020 2020 2020 2020 2020 785f  ).            x_
-0000d480: 626f 756e 6473 2c20 795f 626f 756e 6473  bounds, y_bounds
-0000d490: 2c20 7a5f 626f 756e 6473 203d 2073 656c  , z_bounds = sel
-0000d4a0: 662e 5f72 6573 697a 655f 7265 636f 6e73  f._resize_recons
-0000d4b0: 7472 7563 7465 645f 6461 7461 280a 2020  tructed_data(.  
-0000d4c0: 2020 2020 2020 2020 2020 2020 2020 746f                to
-0000d4d0: 6d6f 5f72 6563 6f6e 5f63 6f6d 6269 6e65  mo_recon_combine
-0000d4e0: 642c 207a 5f6f 6e6c 793d 5472 7565 290a  d, z_only=True).
-0000d4f0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000d500: 2020 2020 2020 2020 2020 6966 2078 5f62            if x_b
-0000d510: 6f75 6e64 7320 6973 204e 6f6e 653a 0a20  ounds is None:. 
-0000d520: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000d530: 656c 662e 5f6c 6f67 6765 722e 7761 726e  elf._logger.warn
-0000d540: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
-0000d550: 2020 2020 2020 2020 2027 785f 626f 756e           'x_boun
-0000d560: 6473 2075 6e73 7065 6369 6669 6564 2c20  ds unspecified, 
-0000d570: 7265 636f 6e73 7472 7563 7420 6461 7461  reconstruct data
-0000d580: 2066 6f72 2066 756c 6c20 782d 7261 6e67   for full x-rang
-0000d590: 6527 290a 2020 2020 2020 2020 2020 2020  e').            
-0000d5a0: 656c 6966 206e 6f74 2069 735f 696e 745f  elif not is_int_
-0000d5b0: 7061 6972 280a 2020 2020 2020 2020 2020  pair(.          
-0000d5c0: 2020 2020 2020 2020 2020 785f 626f 756e            x_boun
-0000d5d0: 6473 2c20 6765 3d30 2c20 6c74 3d74 6f6d  ds, ge=0, lt=tom
-0000d5e0: 6f5f 7265 636f 6e5f 636f 6d62 696e 6564  o_recon_combined
-0000d5f0: 2e73 6861 7065 5b31 5d29 3a0a 2020 2020  .shape[1]):.    
-0000d600: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000d610: 6520 5661 6c75 6545 7272 6f72 2866 2749  e ValueError(f'I
-0000d620: 6e76 616c 6964 2070 6172 616d 6574 6572  nvalid parameter
-0000d630: 2078 5f62 6f75 6e64 7320 287b 785f 626f   x_bounds ({x_bo
-0000d640: 756e 6473 7d29 2729 0a20 2020 2020 2020  unds})').       
-0000d650: 2020 2020 2069 6620 795f 626f 756e 6473       if y_bounds
-0000d660: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0000d670: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0000d680: 6c6f 6767 6572 2e77 6172 6e69 6e67 280a  logger.warning(.
-0000d690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d6a0: 2020 2020 2779 5f62 6f75 6e64 7320 756e      'y_bounds un
-0000d6b0: 7370 6563 6966 6965 642c 2072 6563 6f6e  specified, recon
-0000d6c0: 7374 7275 6374 2064 6174 6120 666f 7220  struct data for 
-0000d6d0: 6675 6c6c 2079 2d72 616e 6765 2729 0a20  full y-range'). 
-0000d6e0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0000d6f0: 6e6f 7420 6973 5f69 6e74 5f70 6169 7228  not is_int_pair(
-0000d700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d710: 2020 2020 2079 5f62 6f75 6e64 732c 2067       y_bounds, g
-0000d720: 653d 302c 206c 743d 746f 6d6f 5f72 6563  e=0, lt=tomo_rec
-0000d730: 6f6e 5f63 6f6d 6269 6e65 642e 7368 6170  on_combined.shap
-0000d740: 655b 325d 293a 0a20 2020 2020 2020 2020  e[2]):.         
-0000d750: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-0000d760: 7565 4572 726f 7228 6627 496e 7661 6c69  ueError(f'Invali
-0000d770: 6420 7061 7261 6d65 7465 7220 795f 626f  d parameter y_bo
-0000d780: 756e 6473 2028 7b79 5f62 6f75 6e64 737d  unds ({y_bounds}
-0000d790: 2927 290a 2020 2020 2020 2020 2020 2020  )').            
-0000d7a0: 7a5f 626f 756e 6473 203d 204e 6f6e 650a  z_bounds = None.
-0000d7b0: 2020 2020 2020 2020 6966 2078 5f62 6f75          if x_bou
-0000d7c0: 6e64 7320 6973 204e 6f6e 653a 0a20 2020  nds is None:.   
-0000d7d0: 2020 2020 2020 2020 2078 5f72 616e 6765           x_range
-0000d7e0: 203d 2028 302c 2074 6f6d 6f5f 7265 636f   = (0, tomo_reco
-0000d7f0: 6e5f 636f 6d62 696e 6564 2e73 6861 7065  n_combined.shape
-0000d800: 5b31 5d29 0a20 2020 2020 2020 2020 2020  [1]).           
-0000d810: 2078 5f73 6c69 6365 203d 2069 6e74 2878   x_slice = int(x
-0000d820: 5f72 616e 6765 5b31 5d2f 3229 0a20 2020  _range[1]/2).   
-0000d830: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000d840: 2020 2020 2020 2078 5f72 616e 6765 203d         x_range =
-0000d850: 2078 5f62 6f75 6e64 730a 2020 2020 2020   x_bounds.      
-0000d860: 2020 2020 2020 785f 736c 6963 6520 3d20        x_slice = 
-0000d870: 696e 7428 2878 5f62 6f75 6e64 735b 305d  int((x_bounds[0]
-0000d880: 2b78 5f62 6f75 6e64 735b 315d 2920 2f20  +x_bounds[1]) / 
-0000d890: 3229 0a20 2020 2020 2020 2069 6620 795f  2).        if y_
-0000d8a0: 626f 756e 6473 2069 7320 4e6f 6e65 3a0a  bounds is None:.
-0000d8b0: 2020 2020 2020 2020 2020 2020 795f 7261              y_ra
-0000d8c0: 6e67 6520 3d20 2830 2c20 746f 6d6f 5f72  nge = (0, tomo_r
-0000d8d0: 6563 6f6e 5f63 6f6d 6269 6e65 642e 7368  econ_combined.sh
-0000d8e0: 6170 655b 325d 290a 2020 2020 2020 2020  ape[2]).        
-0000d8f0: 2020 2020 795f 736c 6963 6520 3d20 696e      y_slice = in
-0000d900: 7428 795f 7261 6e67 655b 315d 2f32 290a  t(y_range[1]/2).
-0000d910: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000d920: 2020 2020 2020 2020 2020 795f 7261 6e67            y_rang
-0000d930: 6520 3d20 795f 626f 756e 6473 0a20 2020  e = y_bounds.   
-0000d940: 2020 2020 2020 2020 2079 5f73 6c69 6365           y_slice
-0000d950: 203d 2069 6e74 2828 795f 626f 756e 6473   = int((y_bounds
-0000d960: 5b30 5d2b 795f 626f 756e 6473 5b31 5d29  [0]+y_bounds[1])
-0000d970: 202f 2032 290a 2020 2020 2020 2020 6966   / 2).        if
-0000d980: 207a 5f62 6f75 6e64 7320 6973 204e 6f6e   z_bounds is Non
-0000d990: 653a 0a20 2020 2020 2020 2020 2020 207a  e:.            z
-0000d9a0: 5f72 616e 6765 203d 2028 302c 2074 6f6d  _range = (0, tom
-0000d9b0: 6f5f 7265 636f 6e5f 636f 6d62 696e 6564  o_recon_combined
-0000d9c0: 2e73 6861 7065 5b30 5d29 0a20 2020 2020  .shape[0]).     
-0000d9d0: 2020 2020 2020 207a 5f73 6c69 6365 203d         z_slice =
-0000d9e0: 2069 6e74 287a 5f72 616e 6765 5b31 5d2f   int(z_range[1]/
-0000d9f0: 3229 0a20 2020 2020 2020 2065 6c73 653a  2).        else:
-0000da00: 0a20 2020 2020 2020 2020 2020 207a 5f72  .            z_r
-0000da10: 616e 6765 203d 207a 5f62 6f75 6e64 730a  ange = z_bounds.
-0000da20: 2020 2020 2020 2020 2020 2020 7a5f 736c              z_sl
-0000da30: 6963 6520 3d20 696e 7428 287a 5f62 6f75  ice = int((z_bou
-0000da40: 6e64 735b 305d 2b7a 5f62 6f75 6e64 735b  nds[0]+z_bounds[
-0000da50: 315d 2920 2f20 3229 0a0a 2020 2020 2020  1]) / 2)..      
-0000da60: 2020 2320 506c 6f74 2061 2066 6577 2063    # Plot a few c
-0000da70: 6f6d 6269 6e65 6420 696d 6167 6520 736c  ombined image sl
-0000da80: 6963 6573 0a20 2020 2020 2020 2069 6620  ices.        if 
-0000da90: 7365 6c66 2e5f 7361 7665 5f66 6967 733a  self._save_figs:
-0000daa0: 0a20 2020 2020 2020 2020 2020 2071 7569  .            qui
-0000dab0: 636b 5f69 6d73 686f 7728 0a20 2020 2020  ck_imshow(.     
-0000dac0: 2020 2020 2020 2020 2020 2074 6f6d 6f5f             tomo_
-0000dad0: 7265 636f 6e5f 636f 6d62 696e 6564 5b0a  recon_combined[.
-0000dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000daf0: 2020 2020 7a5f 7261 6e67 655b 305d 3a7a      z_range[0]:z
-0000db00: 5f72 616e 6765 5b31 5d2c 785f 736c 6963  _range[1],x_slic
-0000db10: 652c 795f 7261 6e67 655b 305d 3a79 5f72  e,y_range[0]:y_r
-0000db20: 616e 6765 5b31 5d5d 2c0a 2020 2020 2020  ange[1]],.      
-0000db30: 2020 2020 2020 2020 2020 7469 746c 653d            title=
-0000db40: 6627 7265 636f 6e20 636f 6d62 696e 6564  f'recon combined
-0000db50: 2078 736c 6963 657b 785f 736c 6963 657d   xslice{x_slice}
-0000db60: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0000db70: 2020 2070 6174 683d 7365 6c66 2e5f 6f75     path=self._ou
-0000db80: 7470 7574 5f66 6f6c 6465 722c 2073 6176  tput_folder, sav
-0000db90: 655f 6669 673d 5472 7565 2c20 7361 7665  e_fig=True, save
-0000dba0: 5f6f 6e6c 793d 5472 7565 290a 2020 2020  _only=True).    
-0000dbb0: 2020 2020 2020 2020 7175 6963 6b5f 696d          quick_im
-0000dbc0: 7368 6f77 280a 2020 2020 2020 2020 2020  show(.          
-0000dbd0: 2020 2020 2020 746f 6d6f 5f72 6563 6f6e        tomo_recon
-0000dbe0: 5f63 6f6d 6269 6e65 645b 0a20 2020 2020  _combined[.     
-0000dbf0: 2020 2020 2020 2020 2020 2020 2020 207a                 z
-0000dc00: 5f72 616e 6765 5b30 5d3a 7a5f 7261 6e67  _range[0]:z_rang
-0000dc10: 655b 315d 2c78 5f72 616e 6765 5b30 5d3a  e[1],x_range[0]:
-0000dc20: 785f 7261 6e67 655b 315d 2c79 5f73 6c69  x_range[1],y_sli
-0000dc30: 6365 5d2c 0a20 2020 2020 2020 2020 2020  ce],.           
-0000dc40: 2020 2020 2074 6974 6c65 3d66 2772 6563       title=f'rec
-0000dc50: 6f6e 2063 6f6d 6269 6e65 6420 7973 6c69  on combined ysli
-0000dc60: 6365 7b79 5f73 6c69 6365 7d27 2c0a 2020  ce{y_slice}',.  
-0000dc70: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-0000dc80: 7468 3d73 656c 662e 5f6f 7574 7075 745f  th=self._output_
-0000dc90: 666f 6c64 6572 2c20 7361 7665 5f66 6967  folder, save_fig
-0000dca0: 3d54 7275 652c 2073 6176 655f 6f6e 6c79  =True, save_only
-0000dcb0: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
-0000dcc0: 2020 2071 7569 636b 5f69 6d73 686f 7728     quick_imshow(
-0000dcd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dce0: 2074 6f6d 6f5f 7265 636f 6e5f 636f 6d62   tomo_recon_comb
-0000dcf0: 696e 6564 5b0a 2020 2020 2020 2020 2020  ined[.          
-0000dd00: 2020 2020 2020 2020 2020 7a5f 736c 6963            z_slic
-0000dd10: 652c 785f 7261 6e67 655b 305d 3a78 5f72  e,x_range[0]:x_r
-0000dd20: 616e 6765 5b31 5d2c 795f 7261 6e67 655b  ange[1],y_range[
-0000dd30: 305d 3a79 5f72 616e 6765 5b31 5d5d 2c0a  0]:y_range[1]],.
-0000dd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dd50: 7469 746c 653d 6627 7265 636f 6e20 636f  title=f'recon co
-0000dd60: 6d62 696e 6564 207a 736c 6963 657b 7a5f  mbined zslice{z_
-0000dd70: 736c 6963 657d 272c 0a20 2020 2020 2020  slice}',.       
-0000dd80: 2020 2020 2020 2020 2070 6174 683d 7365           path=se
-0000dd90: 6c66 2e5f 6f75 7470 7574 5f66 6f6c 6465  lf._output_folde
-0000dda0: 722c 2073 6176 655f 6669 673d 5472 7565  r, save_fig=True
-0000ddb0: 2c20 7361 7665 5f6f 6e6c 793d 5472 7565  , save_only=True
-0000ddc0: 290a 0a20 2020 2020 2020 2023 2053 6176  )..        # Sav
-0000ddd0: 6520 7465 7374 2064 6174 6120 746f 2066  e test data to f
-0000dde0: 696c 650a 2020 2020 2020 2020 2320 2020  ile.        #   
-0000ddf0: 2020 636f 6d62 696e 6564 2064 6174 6120    combined data 
-0000de00: 6f72 6465 723a 2072 6f77 2f7a 2c78 2c79  order: row/z,x,y
-0000de10: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0000de20: 2e5f 7465 7374 5f6d 6f64 653a 0a20 2020  ._test_mode:.   
-0000de30: 2020 2020 2020 2020 206e 702e 7361 7665           np.save
-0000de40: 7478 7428 0a20 2020 2020 2020 2020 2020  txt(.           
-0000de50: 2020 2020 2066 277b 7365 6c66 2e5f 6f75       f'{self._ou
-0000de60: 7470 7574 5f66 6f6c 6465 727d 2f72 6563  tput_folder}/rec
-0000de70: 6f6e 5f63 6f6d 6269 6e65 642e 7478 7427  on_combined.txt'
-0000de80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000de90: 2020 746f 6d6f 5f72 6563 6f6e 5f63 6f6d    tomo_recon_com
-0000dea0: 6269 6e65 645b 0a20 2020 2020 2020 2020  bined[.         
-0000deb0: 2020 2020 2020 2020 2020 207a 5f73 6c69             z_sli
-0000dec0: 6365 2c78 5f72 616e 6765 5b30 5d3a 785f  ce,x_range[0]:x_
-0000ded0: 7261 6e67 655b 315d 2c79 5f72 616e 6765  range[1],y_range
-0000dee0: 5b30 5d3a 795f 7261 6e67 655b 315d 5d2c  [0]:y_range[1]],
-0000def0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000df00: 2066 6d74 3d27 252e 3665 2729 0a0a 2020   fmt='%.6e')..  
-0000df10: 2020 2020 2020 2320 4164 6420 696d 6167        # Add imag
-0000df20: 6520 7265 636f 6e73 7472 7563 7469 6f6e  e reconstruction
-0000df30: 2074 6f20 7265 636f 6e73 7472 7563 7465   to reconstructe
-0000df40: 6420 6461 7461 204e 5870 726f 6365 7373  d data NXprocess
-0000df50: 0a20 2020 2020 2020 2023 2020 2020 2063  .        #     c
-0000df60: 6f6d 6269 6e65 6420 6461 7461 206f 7264  ombined data ord
-0000df70: 6572 3a20 726f 772f 7a2c 782c 790a 2020  er: row/z,x,y.  
-0000df80: 2020 2020 2020 6e78 7072 6f63 6573 732e        nxprocess.
-0000df90: 6461 7461 203d 204e 5864 6174 6128 290a  data = NXdata().
-0000dfa0: 2020 2020 2020 2020 6e78 7072 6f63 6573          nxproces
-0000dfb0: 732e 6174 7472 735b 2764 6566 6175 6c74  s.attrs['default
-0000dfc0: 275d 203d 2027 6461 7461 270a 2020 2020  '] = 'data'.    
-0000dfd0: 2020 2020 6966 2078 5f62 6f75 6e64 7320      if x_bounds 
-0000dfe0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0000dff0: 2020 2020 2020 2020 206e 7870 726f 6365           nxproce
-0000e000: 7373 2e78 5f62 6f75 6e64 7320 3d20 785f  ss.x_bounds = x_
-0000e010: 626f 756e 6473 0a20 2020 2020 2020 2069  bounds.        i
-0000e020: 6620 795f 626f 756e 6473 2069 7320 6e6f  f y_bounds is no
-0000e030: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0000e040: 2020 2020 6e78 7072 6f63 6573 732e 795f      nxprocess.y_
-0000e050: 626f 756e 6473 203d 2079 5f62 6f75 6e64  bounds = y_bound
-0000e060: 730a 2020 2020 2020 2020 6966 207a 5f62  s.        if z_b
-0000e070: 6f75 6e64 7320 6973 206e 6f74 204e 6f6e  ounds is not Non
-0000e080: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
-0000e090: 7870 726f 6365 7373 2e7a 5f62 6f75 6e64  xprocess.z_bound
-0000e0a0: 7320 3d20 7a5f 626f 756e 6473 0a20 2020  s = z_bounds.   
-0000e0b0: 2020 2020 206e 7870 726f 6365 7373 2e64       nxprocess.d
-0000e0c0: 6174 615b 2763 6f6d 6269 6e65 645f 6461  ata['combined_da
-0000e0d0: 7461 275d 203d 2074 6f6d 6f5f 7265 636f  ta'] = tomo_reco
-0000e0e0: 6e5f 636f 6d62 696e 6564 5b0a 2020 2020  n_combined[.    
-0000e0f0: 2020 2020 2020 2020 7a5f 7261 6e67 655b          z_range[
-0000e100: 305d 3a7a 5f72 616e 6765 5b31 5d2c 785f  0]:z_range[1],x_
-0000e110: 7261 6e67 655b 305d 3a78 5f72 616e 6765  range[0]:x_range
-0000e120: 5b31 5d2c 795f 7261 6e67 655b 305d 3a79  [1],y_range[0]:y
-0000e130: 5f72 616e 6765 5b31 5d5d 0a20 2020 2020  _range[1]].     
-0000e140: 2020 206e 7870 726f 6365 7373 2e64 6174     nxprocess.dat
-0000e150: 612e 6174 7472 735b 2773 6967 6e61 6c27  a.attrs['signal'
-0000e160: 5d20 3d20 2763 6f6d 6269 6e65 645f 6461  ] = 'combined_da
-0000e170: 7461 270a 0a20 2020 2020 2020 2023 2043  ta'..        # C
-0000e180: 7265 6174 6520 6120 636f 7079 206f 6620  reate a copy of 
-0000e190: 7468 6520 696e 7075 7420 4e65 7875 7320  the input Nexus 
-0000e1a0: 6f62 6a65 6374 2061 6e64 2072 656d 6f76  object and remov
-0000e1b0: 650a 2020 2020 2020 2020 2320 2020 2020  e.        #     
-0000e1c0: 7265 636f 6e73 7472 7563 7465 6420 6461  reconstructed da
-0000e1d0: 7461 0a20 2020 2020 2020 2065 7863 6c75  ta.        exclu
-0000e1e0: 6465 5f69 7465 6d73 203d 205b 0a20 2020  de_items = [.   
-0000e1f0: 2020 2020 2020 2020 2066 277b 6e78 656e           f'{nxen
-0000e200: 7472 792e 6e78 6e61 6d65 7d2f 7265 636f  try.nxname}/reco
-0000e210: 6e73 7472 7563 7465 645f 6461 7461 2f64  nstructed_data/d
-0000e220: 6174 6127 2c0a 2020 2020 2020 2020 2020  ata',.          
-0000e230: 2020 6627 7b6e 7865 6e74 7279 2e6e 786e    f'{nxentry.nxn
-0000e240: 616d 657d 2f64 6174 612f 7265 636f 6e73  ame}/data/recons
-0000e250: 7472 7563 7465 645f 6461 7461 272c 0a20  tructed_data',. 
-0000e260: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-0000e270: 206e 7872 6f6f 745f 636f 7079 203d 206e   nxroot_copy = n
-0000e280: 7863 6f70 7928 6e78 726f 6f74 2c20 6578  xcopy(nxroot, ex
-0000e290: 636c 7564 655f 6e78 7061 7468 733d 6578  clude_nxpaths=ex
-0000e2a0: 636c 7564 655f 6974 656d 7329 0a0a 2020  clude_items)..  
-0000e2b0: 2020 2020 2020 2320 4164 6420 7468 6520        # Add the 
-0000e2c0: 636f 6d62 696e 6564 2064 6174 6120 4e58  combined data NX
-0000e2d0: 7072 6f63 6573 7320 746f 2074 6865 206e  process to the n
-0000e2e0: 6577 204e 6578 7573 206f 626a 6563 740a  ew Nexus object.
-0000e2f0: 2020 2020 2020 2020 6e78 656e 7472 795f          nxentry_
-0000e300: 636f 7079 203d 206e 7872 6f6f 745f 636f  copy = nxroot_co
-0000e310: 7079 5b6e 7872 6f6f 745f 636f 7079 2e61  py[nxroot_copy.a
-0000e320: 7474 7273 5b27 6465 6661 756c 7427 5d5d  ttrs['default']]
-0000e330: 0a20 2020 2020 2020 206e 7865 6e74 7279  .        nxentry
-0000e340: 5f63 6f70 792e 636f 6d62 696e 6564 5f64  _copy.combined_d
-0000e350: 6174 6120 3d20 6e78 7072 6f63 6573 730a  ata = nxprocess.
-0000e360: 2020 2020 2020 2020 6966 2027 6461 7461          if 'data
-0000e370: 2720 6e6f 7420 696e 206e 7865 6e74 7279  ' not in nxentry
-0000e380: 5f63 6f70 793a 0a20 2020 2020 2020 2020  _copy:.         
-0000e390: 2020 206e 7865 6e74 7279 5f63 6f70 792e     nxentry_copy.
-0000e3a0: 6461 7461 203d 204e 5864 6174 6128 290a  data = NXdata().
-0000e3b0: 2020 2020 2020 2020 6e78 656e 7472 795f          nxentry_
-0000e3c0: 636f 7079 2e61 7474 7273 5b27 6465 6661  copy.attrs['defa
-0000e3d0: 756c 7427 5d20 3d20 2764 6174 6127 0a20  ult'] = 'data'. 
-0000e3e0: 2020 2020 2020 206e 7865 6e74 7279 5f63         nxentry_c
-0000e3f0: 6f70 792e 6461 7461 2e6d 616b 656c 696e  opy.data.makelin
-0000e400: 6b28 0a20 2020 2020 2020 2020 2020 206e  k(.            n
-0000e410: 7870 726f 6365 7373 2e64 6174 612e 636f  xprocess.data.co
-0000e420: 6d62 696e 6564 5f64 6174 612c 206e 616d  mbined_data, nam
-0000e430: 653d 2763 6f6d 6269 6e65 645f 6461 7461  e='combined_data
-0000e440: 2729 0a20 2020 2020 2020 206e 7865 6e74  ').        nxent
-0000e450: 7279 5f63 6f70 792e 6461 7461 2e61 7474  ry_copy.data.att
-0000e460: 7273 5b27 7369 676e 616c 275d 203d 2027  rs['signal'] = '
-0000e470: 636f 6d62 696e 6564 5f64 6174 6127 0a0a  combined_data'..
-0000e480: 2020 2020 2020 2020 7265 7475 726e 206e          return n
-0000e490: 7872 6f6f 745f 636f 7079 0a0a 2020 2020  xroot_copy..    
-0000e4a0: 6465 6620 5f67 656e 5f64 6172 6b28 7365  def _gen_dark(se
-0000e4b0: 6c66 2c20 6e78 656e 7472 792c 2072 6564  lf, nxentry, red
-0000e4c0: 7563 6564 5f64 6174 6129 3a0a 2020 2020  uced_data):.    
-0000e4d0: 2020 2020 2222 2247 656e 6572 6174 6520      """Generate 
-0000e4e0: 6461 726b 2066 6965 6c64 2e22 2222 0a20  dark field.""". 
-0000e4f0: 2020 2020 2020 2023 2054 6869 7264 2070         # Third p
-0000e500: 6172 7479 206d 6f64 756c 6573 0a20 2020  arty modules.   
-0000e510: 2020 2020 2066 726f 6d20 6e65 7875 7366       from nexusf
-0000e520: 6f72 6d61 742e 6e65 7875 7320 696d 706f  ormat.nexus impo
-0000e530: 7274 204e 5864 6174 610a 0a20 2020 2020  rt NXdata..     
-0000e540: 2020 2023 204c 6f63 616c 206d 6f64 756c     # Local modul
-0000e550: 6573 0a20 2020 2020 2020 2066 726f 6d20  es.        from 
-0000e560: 4348 4150 2e63 6f6d 6d6f 6e2e 6d6f 6465  CHAP.common.mode
-0000e570: 6c73 2e6d 6170 2069 6d70 6f72 7420 280a  ls.map import (.
-0000e580: 2020 2020 2020 2020 2020 2020 6765 745f              get_
-0000e590: 7363 616e 7061 7273 6572 2c0a 2020 2020  scanparser,.    
-0000e5a0: 2020 2020 2020 2020 696d 706f 7274 5f73          import_s
-0000e5b0: 6361 6e70 6172 7365 722c 0a20 2020 2020  canparser,.     
-0000e5c0: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
-0000e5d0: 4765 7420 7468 6520 6461 726b 2066 6965  Get the dark fie
-0000e5e0: 6c64 2069 6d61 6765 730a 2020 2020 2020  ld images.      
-0000e5f0: 2020 696d 6167 655f 6b65 7920 3d20 6e78    image_key = nx
-0000e600: 656e 7472 792e 696e 7374 7275 6d65 6e74  entry.instrument
-0000e610: 2e64 6574 6563 746f 722e 6765 7428 2769  .detector.get('i
-0000e620: 6d61 6765 5f6b 6579 272c 204e 6f6e 6529  mage_key', None)
-0000e630: 0a20 2020 2020 2020 2069 6620 696d 6167  .        if imag
-0000e640: 655f 6b65 7920 6973 206e 6f74 204e 6f6e  e_key is not Non
-0000e650: 6520 616e 6420 2764 6174 6127 2069 6e20  e and 'data' in 
-0000e660: 6e78 656e 7472 792e 696e 7374 7275 6d65  nxentry.instrume
-0000e670: 6e74 2e64 6574 6563 746f 723a 0a20 2020  nt.detector:.   
-0000e680: 2020 2020 2020 2020 2066 6965 6c64 5f69           field_i
-0000e690: 6e64 6963 6573 203d 205b 0a20 2020 2020  ndices = [.     
-0000e6a0: 2020 2020 2020 2020 2020 2069 6e64 6578             index
-0000e6b0: 2066 6f72 2069 6e64 6578 2c20 6b65 7920   for index, key 
-0000e6c0: 696e 2065 6e75 6d65 7261 7465 2869 6d61  in enumerate(ima
-0000e6d0: 6765 5f6b 6579 2920 6966 206b 6579 203d  ge_key) if key =
-0000e6e0: 3d20 325d 0a20 2020 2020 2020 2020 2020  = 2].           
-0000e6f0: 2074 6466 5f73 7461 636b 203d 206e 7865   tdf_stack = nxe
-0000e700: 6e74 7279 2e69 6e73 7472 756d 656e 742e  ntry.instrument.
-0000e710: 6465 7465 6374 6f72 2e64 6174 615b 6669  detector.data[fi
-0000e720: 656c 645f 696e 6469 6365 732c 3a2c 3a5d  eld_indices,:,:]
-0000e730: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
-0000e740: 5620 7468 6520 6465 6661 756c 7420 4e58  V the default NX
-0000e750: 746f 6d6f 2066 6f72 6d20 646f 6573 206e  tomo form does n
-0000e760: 6f74 2061 6363 6f6d 6f64 6174 6520 6461  ot accomodate da
-0000e770: 726b 2066 6965 6c64 0a20 2020 2020 2020  rk field.       
-0000e780: 2020 2020 2023 2020 2020 2073 7461 636b       #     stack
-0000e790: 730a 2020 2020 2020 2020 656c 7365 3a0a  s.        else:.
-0000e7a0: 2020 2020 2020 2020 2020 2020 696d 706f              impo
-0000e7b0: 7274 5f73 6361 6e70 6172 7365 7228 0a20  rt_scanparser(. 
-0000e7c0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000e7d0: 7865 6e74 7279 2e69 6e73 7472 756d 656e  xentry.instrumen
-0000e7e0: 742e 736f 7572 6365 2e61 7474 7273 5b27  t.source.attrs['
-0000e7f0: 7374 6174 696f 6e27 5d2c 0a20 2020 2020  station'],.     
-0000e800: 2020 2020 2020 2020 2020 206e 7865 6e74             nxent
-0000e810: 7279 2e69 6e73 7472 756d 656e 742e 736f  ry.instrument.so
-0000e820: 7572 6365 2e61 7474 7273 5b27 6578 7065  urce.attrs['expe
-0000e830: 7269 6d65 6e74 5f74 7970 6527 5d29 0a20  riment_type']). 
-0000e840: 2020 2020 2020 2020 2020 2064 6172 6b5f             dark_
-0000e850: 6669 656c 645f 7363 616e 7320 3d20 6e78  field_scans = nx
-0000e860: 656e 7472 792e 7370 6563 5f73 6361 6e73  entry.spec_scans
-0000e870: 2e64 6172 6b5f 6669 656c 640a 2020 2020  .dark_field.    
-0000e880: 2020 2020 2020 2020 6465 7465 6374 6f72          detector
-0000e890: 5f70 7265 6669 7820 3d20 7374 7228 6e78  _prefix = str(nx
-0000e8a0: 656e 7472 792e 696e 7374 7275 6d65 6e74  entry.instrument
-0000e8b0: 2e64 6574 6563 746f 722e 6c6f 6361 6c5f  .detector.local_
-0000e8c0: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-0000e8d0: 2020 7464 665f 7374 6163 6b20 3d20 5b5d    tdf_stack = []
-0000e8e0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0000e8f0: 206e 7873 7562 656e 7472 795f 6e61 6d65   nxsubentry_name
-0000e900: 2c20 6e78 7375 6265 6e74 7279 2069 6e20  , nxsubentry in 
-0000e910: 6461 726b 5f66 6965 6c64 5f73 6361 6e73  dark_field_scans
-0000e920: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-0000e930: 2020 2020 2020 2020 2020 7363 616e 5f6e            scan_n
-0000e940: 756d 6265 7220 3d20 696e 7428 6e78 7375  umber = int(nxsu
-0000e950: 6265 6e74 7279 5f6e 616d 652e 7370 6c69  bentry_name.spli
-0000e960: 7428 275f 2729 5b2d 315d 290a 2020 2020  t('_')[-1]).    
-0000e970: 2020 2020 2020 2020 2020 2020 7363 616e              scan
-0000e980: 7061 7273 6572 203d 2067 6574 5f73 6361  parser = get_sca
-0000e990: 6e70 6172 7365 7228 0a20 2020 2020 2020  nparser(.       
-0000e9a0: 2020 2020 2020 2020 2020 2020 2064 6172               dar
-0000e9b0: 6b5f 6669 656c 645f 7363 616e 732e 6174  k_field_scans.at
-0000e9c0: 7472 735b 2773 7065 635f 6669 6c65 275d  trs['spec_file']
-0000e9d0: 2c20 7363 616e 5f6e 756d 6265 7229 0a20  , scan_number). 
-0000e9e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000e9f0: 6d61 6765 5f6f 6666 7365 7420 3d20 696e  mage_offset = in
-0000ea00: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0000ea10: 2020 2020 2020 206e 7873 7562 656e 7472         nxsubentr
-0000ea20: 792e 696e 7374 7275 6d65 6e74 2e64 6574  y.instrument.det
-0000ea30: 6563 746f 722e 6672 616d 655f 7374 6172  ector.frame_star
-0000ea40: 745f 6e75 6d62 6572 290a 2020 2020 2020  t_number).      
-0000ea50: 2020 2020 2020 2020 2020 6e75 6d5f 696d            num_im
-0000ea60: 6167 6520 3d20 6c65 6e28 6e78 7375 6265  age = len(nxsube
-0000ea70: 6e74 7279 2e73 616d 706c 652e 726f 7461  ntry.sample.rota
-0000ea80: 7469 6f6e 5f61 6e67 6c65 290a 2020 2020  tion_angle).    
-0000ea90: 2020 2020 2020 2020 2020 2020 7464 665f              tdf_
-0000eaa0: 7374 6163 6b2e 6170 7065 6e64 280a 2020  stack.append(.  
-0000eab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eac0: 2020 7363 616e 7061 7273 6572 2e67 6574    scanparser.get
-0000ead0: 5f64 6574 6563 746f 725f 6461 7461 280a  _detector_data(.
-0000eae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eaf0: 2020 2020 2020 2020 6465 7465 6374 6f72          detector
-0000eb00: 5f70 7265 6669 782c 0a20 2020 2020 2020  _prefix,.       
-0000eb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb20: 2028 696d 6167 655f 6f66 6673 6574 2c20   (image_offset, 
-0000eb30: 696d 6167 655f 6f66 6673 6574 2b6e 756d  image_offset+num
-0000eb40: 5f69 6d61 6765 2929 290a 2020 2020 2020  _image))).      
-0000eb50: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-0000eb60: 6e63 6528 7464 665f 7374 6163 6b2c 206c  nce(tdf_stack, l
-0000eb70: 6973 7429 3a0a 2020 2020 2020 2020 2020  ist):.          
-0000eb80: 2020 2020 2020 6173 7365 7274 206c 656e        assert len
-0000eb90: 2874 6466 5f73 7461 636b 2920 3d3d 2031  (tdf_stack) == 1
-0000eba0: 2020 2320 5256 0a20 2020 2020 2020 2020    # RV.         
-0000ebb0: 2020 2020 2020 2074 6466 5f73 7461 636b         tdf_stack
-0000ebc0: 203d 2074 6466 5f73 7461 636b 5b30 5d0a   = tdf_stack[0].
-0000ebd0: 0a20 2020 2020 2020 2023 2054 616b 6520  .        # Take 
-0000ebe0: 6d65 6469 616e 0a20 2020 2020 2020 2069  median.        i
-0000ebf0: 6620 7464 665f 7374 6163 6b2e 6e64 696d  f tdf_stack.ndim
-0000ec00: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
-0000ec10: 2020 2074 6466 203d 2074 6466 5f73 7461     tdf = tdf_sta
-0000ec20: 636b 0a20 2020 2020 2020 2065 6c69 6620  ck.        elif 
-0000ec30: 7464 665f 7374 6163 6b2e 6e64 696d 203d  tdf_stack.ndim =
-0000ec40: 3d20 333a 0a20 2020 2020 2020 2020 2020  = 3:.           
-0000ec50: 2074 6466 203d 206e 702e 6d65 6469 616e   tdf = np.median
-0000ec60: 2874 6466 5f73 7461 636b 2c20 6178 6973  (tdf_stack, axis
-0000ec70: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
-0000ec80: 6465 6c20 7464 665f 7374 6163 6b0a 2020  del tdf_stack.  
-0000ec90: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000eca0: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
-0000ecb0: 6e74 696d 6545 7272 6f72 2866 2749 6e76  ntimeError(f'Inv
-0000ecc0: 616c 6964 2074 6466 5f73 7461 636b 2073  alid tdf_stack s
-0000ecd0: 6861 7065 2028 7b74 6466 5f73 7461 636b  hape ({tdf_stack
-0000ece0: 2e73 6861 7065 7d29 2729 0a0a 2020 2020  .shape})')..    
-0000ecf0: 2020 2020 2320 5265 6d6f 7665 2064 6172      # Remove dar
-0000ed00: 6b20 6669 656c 6420 696e 7465 6e73 6974  k field intensit
-0000ed10: 6965 7320 6162 6f76 6520 7468 6520 6375  ies above the cu
-0000ed20: 746f 6666 0a23 2020 2020 2020 2020 7464  toff.#        td
-0000ed30: 665f 6375 746f 6666 203d 204e 6f6e 650a  f_cutoff = None.
-0000ed40: 2020 2020 2020 2020 7464 665f 6375 746f          tdf_cuto
-0000ed50: 6666 203d 2074 6466 2e6d 696e 2829 202b  ff = tdf.min() +
-0000ed60: 2032 202a 2028 6e70 2e6d 6564 6961 6e28   2 * (np.median(
-0000ed70: 7464 6629 2d74 6466 2e6d 696e 2829 290a  tdf)-tdf.min()).
-0000ed80: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-0000ed90: 6767 6572 2e64 6562 7567 2866 2774 6466  gger.debug(f'tdf
-0000eda0: 5f63 7574 6f66 6620 3d20 7b74 6466 5f63  _cutoff = {tdf_c
-0000edb0: 7574 6f66 667d 2729 0a20 2020 2020 2020  utoff}').       
-0000edc0: 2069 6620 7464 665f 6375 746f 6666 2069   if tdf_cutoff i
-0000edd0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0000ede0: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-0000edf0: 7369 6e73 7461 6e63 6528 7464 665f 6375  sinstance(tdf_cu
-0000ee00: 746f 6666 2c20 2869 6e74 2c20 666c 6f61  toff, (int, floa
-0000ee10: 7429 2920 6f72 2074 6466 5f63 7574 6f66  t)) or tdf_cutof
-0000ee20: 6620 3c20 303a 0a20 2020 2020 2020 2020  f < 0:.         
-0000ee30: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-0000ee40: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
-0000ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee60: 2066 2749 676e 6f72 696e 6720 696c 6c65   f'Ignoring ille
-0000ee70: 6761 6c20 7661 6c75 6520 6f66 2074 6466  gal value of tdf
-0000ee80: 5f63 7574 6f66 6620 7b74 6466 5f63 7574  _cutoff {tdf_cut
-0000ee90: 6f66 667d 2729 0a20 2020 2020 2020 2020  off}').         
-0000eea0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000eeb0: 2020 2020 2020 2020 2074 6466 5b74 6466           tdf[tdf
-0000eec0: 203e 2074 6466 5f63 7574 6f66 665d 203d   > tdf_cutoff] =
-0000eed0: 206e 702e 6e61 6e0a 2020 2020 2020 2020   np.nan.        
-0000eee0: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-0000eef0: 6767 6572 2e64 6562 7567 2866 2774 6466  gger.debug(f'tdf
-0000ef00: 5f63 7574 6f66 6620 3d20 7b74 6466 5f63  _cutoff = {tdf_c
-0000ef10: 7574 6f66 667d 2729 0a0a 2020 2020 2020  utoff}')..      
-0000ef20: 2020 2320 5265 6d6f 7665 206e 616e 730a    # Remove nans.
-0000ef30: 2020 2020 2020 2020 7464 665f 6d65 616e          tdf_mean
-0000ef40: 203d 206e 702e 6e61 6e6d 6561 6e28 7464   = np.nanmean(td
-0000ef50: 6629 0a20 2020 2020 2020 2073 656c 662e  f).        self.
-0000ef60: 5f6c 6f67 6765 722e 6465 6275 6728 6627  _logger.debug(f'
-0000ef70: 7464 665f 6d65 616e 203d 207b 7464 665f  tdf_mean = {tdf_
-0000ef80: 6d65 616e 7d27 290a 2020 2020 2020 2020  mean}').        
-0000ef90: 6e70 2e6e 616e 5f74 6f5f 6e75 6d28 0a20  np.nan_to_num(. 
-0000efa0: 2020 2020 2020 2020 2020 2074 6466 2c20             tdf, 
-0000efb0: 636f 7079 3d46 616c 7365 2c20 6e61 6e3d  copy=False, nan=
-0000efc0: 7464 665f 6d65 616e 2c20 706f 7369 6e66  tdf_mean, posinf
-0000efd0: 3d74 6466 5f6d 6561 6e2c 206e 6567 696e  =tdf_mean, negin
-0000efe0: 663d 302e 290a 0a20 2020 2020 2020 2023  f=0.)..        #
-0000eff0: 2050 6c6f 7420 6461 726b 2066 6965 6c64   Plot dark field
-0000f000: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0000f010: 2e5f 7361 7665 5f66 6967 733a 0a20 2020  ._save_figs:.   
-0000f020: 2020 2020 2020 2020 2071 7569 636b 5f69           quick_i
-0000f030: 6d73 686f 7728 0a20 2020 2020 2020 2020  mshow(.         
-0000f040: 2020 2020 2020 2074 6466 2c20 7469 746c         tdf, titl
-0000f050: 653d 2764 6172 6b20 6669 656c 6427 2c20  e='dark field', 
-0000f060: 7061 7468 3d73 656c 662e 5f6f 7574 7075  path=self._outpu
-0000f070: 745f 666f 6c64 6572 2c0a 2020 2020 2020  t_folder,.      
-0000f080: 2020 2020 2020 2020 2020 7361 7665 5f66            save_f
-0000f090: 6967 3d54 7275 652c 2073 6176 655f 6f6e  ig=True, save_on
-0000f0a0: 6c79 3d54 7275 6529 0a0a 2020 2020 2020  ly=True)..      
-0000f0b0: 2020 2320 4164 6420 6461 726b 2066 6965    # Add dark fie
-0000f0c0: 6c64 2074 6f20 7265 6475 6365 6420 6461  ld to reduced da
-0000f0d0: 7461 204e 5870 726f 6365 7373 0a20 2020  ta NXprocess.   
-0000f0e0: 2020 2020 2072 6564 7563 6564 5f64 6174       reduced_dat
-0000f0f0: 612e 6461 7461 203d 204e 5864 6174 6128  a.data = NXdata(
-0000f100: 290a 2020 2020 2020 2020 7265 6475 6365  ).        reduce
-0000f110: 645f 6461 7461 2e64 6174 615b 2764 6172  d_data.data['dar
-0000f120: 6b5f 6669 656c 6427 5d20 3d20 7464 660a  k_field'] = tdf.
-0000f130: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000f140: 7265 6475 6365 645f 6461 7461 0a0a 2020  reduced_data..  
-0000f150: 2020 6465 6620 5f67 656e 5f62 7269 6768    def _gen_brigh
-0000f160: 7428 7365 6c66 2c20 6e78 656e 7472 792c  t(self, nxentry,
-0000f170: 2072 6564 7563 6564 5f64 6174 6129 3a0a   reduced_data):.
-0000f180: 2020 2020 2020 2020 2222 2247 656e 6572          """Gener
-0000f190: 6174 6520 6272 6967 6874 2066 6965 6c64  ate bright field
-0000f1a0: 2e22 2222 0a20 2020 2020 2020 2023 2054  .""".        # T
-0000f1b0: 6869 7264 2070 6172 7479 206d 6f64 756c  hird party modul
-0000f1c0: 6573 0a20 2020 2020 2020 2066 726f 6d20  es.        from 
-0000f1d0: 6e65 7875 7366 6f72 6d61 742e 6e65 7875  nexusformat.nexu
-0000f1e0: 7320 696d 706f 7274 204e 5864 6174 610a  s import NXdata.
-0000f1f0: 0a20 2020 2020 2020 2023 204c 6f63 616c  .        # Local
-0000f200: 206d 6f64 756c 6573 0a20 2020 2020 2020   modules.       
-0000f210: 2066 726f 6d20 4348 4150 2e63 6f6d 6d6f   from CHAP.commo
-0000f220: 6e2e 6d6f 6465 6c73 2e6d 6170 2069 6d70  n.models.map imp
-0000f230: 6f72 7420 280a 2020 2020 2020 2020 2020  ort (.          
-0000f240: 2020 6765 745f 7363 616e 7061 7273 6572    get_scanparser
-0000f250: 2c0a 2020 2020 2020 2020 2020 2020 696d  ,.            im
-0000f260: 706f 7274 5f73 6361 6e70 6172 7365 722c  port_scanparser,
-0000f270: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0000f280: 2020 2020 2320 4765 7420 7468 6520 6272      # Get the br
-0000f290: 6967 6874 2066 6965 6c64 2069 6d61 6765  ight field image
-0000f2a0: 730a 2020 2020 2020 2020 696d 6167 655f  s.        image_
-0000f2b0: 6b65 7920 3d20 6e78 656e 7472 792e 696e  key = nxentry.in
-0000f2c0: 7374 7275 6d65 6e74 2e64 6574 6563 746f  strument.detecto
-0000f2d0: 722e 6765 7428 2769 6d61 6765 5f6b 6579  r.get('image_key
-0000f2e0: 272c 204e 6f6e 6529 0a20 2020 2020 2020  ', None).       
-0000f2f0: 2069 6620 696d 6167 655f 6b65 7920 6973   if image_key is
-0000f300: 206e 6f74 204e 6f6e 6520 616e 6420 2764   not None and 'd
-0000f310: 6174 6127 2069 6e20 6e78 656e 7472 792e  ata' in nxentry.
-0000f320: 696e 7374 7275 6d65 6e74 2e64 6574 6563  instrument.detec
-0000f330: 746f 723a 0a20 2020 2020 2020 2020 2020  tor:.           
-0000f340: 2066 6965 6c64 5f69 6e64 6963 6573 203d   field_indices =
-0000f350: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-0000f360: 2020 2069 6e64 6578 2066 6f72 2069 6e64     index for ind
-0000f370: 6578 2c20 6b65 7920 696e 2065 6e75 6d65  ex, key in enume
-0000f380: 7261 7465 2869 6d61 6765 5f6b 6579 2920  rate(image_key) 
-0000f390: 6966 206b 6579 203d 3d20 315d 0a20 2020  if key == 1].   
-0000f3a0: 2020 2020 2020 2020 2074 6266 5f73 7461           tbf_sta
-0000f3b0: 636b 203d 206e 7865 6e74 7279 2e69 6e73  ck = nxentry.ins
-0000f3c0: 7472 756d 656e 742e 6465 7465 6374 6f72  trument.detector
-0000f3d0: 2e64 6174 615b 6669 656c 645f 696e 6469  .data[field_indi
-0000f3e0: 6365 732c 3a2c 3a5d 0a20 2020 2020 2020  ces,:,:].       
-0000f3f0: 2020 2020 2023 2052 5620 7468 6520 6465       # RV the de
-0000f400: 6661 756c 7420 4e58 746f 6d6f 2066 6f72  fault NXtomo for
-0000f410: 6d20 646f 6573 206e 6f74 2061 6363 6f6d  m does not accom
-0000f420: 6f64 6174 6520 6272 6967 6874 0a20 2020  odate bright.   
-0000f430: 2020 2020 2020 2020 2023 2020 2020 2066           #     f
-0000f440: 6965 6c64 2073 7461 636b 730a 2020 2020  ield stacks.    
-0000f450: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000f460: 2020 2020 2020 696d 706f 7274 5f73 6361        import_sca
-0000f470: 6e70 6172 7365 7228 0a20 2020 2020 2020  nparser(.       
-0000f480: 2020 2020 2020 2020 206e 7865 6e74 7279           nxentry
-0000f490: 2e69 6e73 7472 756d 656e 742e 736f 7572  .instrument.sour
-0000f4a0: 6365 2e61 7474 7273 5b27 7374 6174 696f  ce.attrs['statio
-0000f4b0: 6e27 5d2c 0a20 2020 2020 2020 2020 2020  n'],.           
-0000f4c0: 2020 2020 206e 7865 6e74 7279 2e69 6e73       nxentry.ins
-0000f4d0: 7472 756d 656e 742e 736f 7572 6365 2e61  trument.source.a
-0000f4e0: 7474 7273 5b27 6578 7065 7269 6d65 6e74  ttrs['experiment
-0000f4f0: 5f74 7970 6527 5d29 0a20 2020 2020 2020  _type']).       
-0000f500: 2020 2020 2062 7269 6768 745f 6669 656c       bright_fiel
-0000f510: 645f 7363 616e 7320 3d20 6e78 656e 7472  d_scans = nxentr
-0000f520: 792e 7370 6563 5f73 6361 6e73 2e62 7269  y.spec_scans.bri
-0000f530: 6768 745f 6669 656c 640a 2020 2020 2020  ght_field.      
-0000f540: 2020 2020 2020 6465 7465 6374 6f72 5f70        detector_p
-0000f550: 7265 6669 7820 3d20 7374 7228 6e78 656e  refix = str(nxen
-0000f560: 7472 792e 696e 7374 7275 6d65 6e74 2e64  try.instrument.d
-0000f570: 6574 6563 746f 722e 6c6f 6361 6c5f 6e61  etector.local_na
-0000f580: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0000f590: 7462 665f 7374 6163 6b20 3d20 5b5d 0a20  tbf_stack = []. 
-0000f5a0: 2020 2020 2020 2020 2020 2066 6f72 206e             for n
-0000f5b0: 7873 7562 656e 7472 795f 6e61 6d65 2c20  xsubentry_name, 
-0000f5c0: 6e78 7375 6265 6e74 7279 2069 6e20 6272  nxsubentry in br
-0000f5d0: 6967 6874 5f66 6965 6c64 5f73 6361 6e73  ight_field_scans
-0000f5e0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-0000f5f0: 2020 2020 2020 2020 2020 7363 616e 5f6e            scan_n
-0000f600: 756d 6265 7220 3d20 696e 7428 6e78 7375  umber = int(nxsu
-0000f610: 6265 6e74 7279 5f6e 616d 652e 7370 6c69  bentry_name.spli
-0000f620: 7428 275f 2729 5b2d 315d 290a 2020 2020  t('_')[-1]).    
-0000f630: 2020 2020 2020 2020 2020 2020 7363 616e              scan
-0000f640: 7061 7273 6572 203d 2067 6574 5f73 6361  parser = get_sca
-0000f650: 6e70 6172 7365 7228 0a20 2020 2020 2020  nparser(.       
-0000f660: 2020 2020 2020 2020 2020 2020 2062 7269               bri
-0000f670: 6768 745f 6669 656c 645f 7363 616e 732e  ght_field_scans.
-0000f680: 6174 7472 735b 2773 7065 635f 6669 6c65  attrs['spec_file
-0000f690: 275d 2c20 7363 616e 5f6e 756d 6265 7229  '], scan_number)
-0000f6a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f6b0: 2069 6d61 6765 5f6f 6666 7365 7420 3d20   image_offset = 
-0000f6c0: 696e 7428 0a20 2020 2020 2020 2020 2020  int(.           
-0000f6d0: 2020 2020 2020 2020 206e 7873 7562 656e           nxsuben
-0000f6e0: 7472 792e 696e 7374 7275 6d65 6e74 2e64  try.instrument.d
-0000f6f0: 6574 6563 746f 722e 6672 616d 655f 7374  etector.frame_st
-0000f700: 6172 745f 6e75 6d62 6572 290a 2020 2020  art_number).    
-0000f710: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
-0000f720: 696d 6167 6520 3d20 6c65 6e28 6e78 7375  image = len(nxsu
-0000f730: 6265 6e74 7279 2e73 616d 706c 652e 726f  bentry.sample.ro
-0000f740: 7461 7469 6f6e 5f61 6e67 6c65 290a 2020  tation_angle).  
-0000f750: 2020 2020 2020 2020 2020 2020 2020 7462                tb
-0000f760: 665f 7374 6163 6b2e 6170 7065 6e64 280a  f_stack.append(.
-0000f770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f780: 2020 2020 7363 616e 7061 7273 6572 2e67      scanparser.g
-0000f790: 6574 5f64 6574 6563 746f 725f 6461 7461  et_detector_data
-0000f7a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000f7b0: 2020 2020 2020 2020 2020 6465 7465 6374            detect
-0000f7c0: 6f72 5f70 7265 6669 782c 0a20 2020 2020  or_prefix,.     
-0000f7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f7e0: 2020 2028 696d 6167 655f 6f66 6673 6574     (image_offset
-0000f7f0: 2c20 696d 6167 655f 6f66 6673 6574 2b6e  , image_offset+n
-0000f800: 756d 5f69 6d61 6765 2929 290a 2020 2020  um_image))).    
-0000f810: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0000f820: 7461 6e63 6528 7462 665f 7374 6163 6b2c  tance(tbf_stack,
-0000f830: 206c 6973 7429 3a0a 2020 2020 2020 2020   list):.        
-0000f840: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
-0000f850: 656e 2874 6266 5f73 7461 636b 2920 3d3d  en(tbf_stack) ==
-0000f860: 2031 2020 2320 5256 0a20 2020 2020 2020   1  # RV.       
-0000f870: 2020 2020 2020 2020 2074 6266 5f73 7461           tbf_sta
-0000f880: 636b 203d 2074 6266 5f73 7461 636b 5b30  ck = tbf_stack[0
-0000f890: 5d0a 0a20 2020 2020 2020 2023 2054 616b  ]..        # Tak
-0000f8a0: 6520 6d65 6469 616e 2069 6620 6d6f 7265  e median if more
-0000f8b0: 2074 6861 6e20 6f6e 6520 696d 6167 650a   than one image.
-0000f8c0: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
-0000f8d0: 2020 2320 4d65 6469 616e 206f 7220 6d65    # Median or me
-0000f8e0: 616e 3a20 4974 206d 6179 2062 6520 6265  an: It may be be
-0000f8f0: 7374 2074 6f20 7472 7920 7468 6520 6d65  st to try the me
-0000f900: 6469 616e 2062 6563 6175 7365 206f 660a  dian because of.
-0000f910: 2020 2020 2020 2020 2320 736f 6d65 2069          # some i
-0000f920: 6d61 6765 2061 7274 6966 6163 7473 2074  mage artifacts t
-0000f930: 6861 7420 6172 6973 6520 6475 6520 746f  hat arise due to
-0000f940: 2063 7269 6e6b 6c65 7320 696e 2074 6865   crinkles in the
-0000f950: 0a20 2020 2020 2020 2023 2075 7073 7472  .        # upstr
-0000f960: 6561 6d20 6b61 7074 6f6e 2074 6170 6520  eam kapton tape 
-0000f970: 7769 6e64 6f77 7320 6361 7573 696e 6720  windows causing 
-0000f980: 736f 6d65 2070 6861 7365 2063 6f6e 7472  some phase contr
-0000f990: 6173 740a 2020 2020 2020 2020 2320 696d  ast.        # im
-0000f9a0: 6167 6573 2074 6f20 6170 7065 6172 206f  ages to appear o
-0000f9b0: 6e20 7468 6520 6465 7465 6374 6f72 2e0a  n the detector..
-0000f9c0: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
-0000f9d0: 2020 2320 4f6e 6520 7468 696e 6720 7468    # One thing th
-0000f9e0: 6174 2061 6c73 6f20 6d61 7920 6265 2075  at also may be u
-0000f9f0: 7365 6675 6c20 696e 2061 2066 7574 7572  seful in a futur
-0000fa00: 6520 696d 706c 656d 656e 7461 7469 6f6e  e implementation
-0000fa10: 0a20 2020 2020 2020 2023 2069 7320 746f  .        # is to
-0000fa20: 2064 6f20 6120 6272 6967 6874 6669 656c   do a brightfiel
-0000fa30: 6420 6164 6a75 7374 6d65 6e74 206f 6e20  d adjustment on 
-0000fa40: 4541 4348 2066 7261 6d65 206f 6620 7468  EACH frame of th
-0000fa50: 6520 746f 6d6f 0a20 2020 2020 2020 2023  e tomo.        #
-0000fa60: 2062 6173 6564 206f 6e20 6120 524f 4920   based on a ROI 
-0000fa70: 696e 2074 6865 2063 6f72 6e65 7220 6f66  in the corner of
-0000fa80: 2074 6865 2066 7261 6d65 2077 6865 7265   the frame where
-0000fa90: 2074 6865 7265 2069 7320 6e6f 0a20 2020   there is no.   
-0000faa0: 2020 2020 2023 2073 616d 706c 6520 6275       # sample bu
-0000fab0: 7420 7468 6572 6520 6973 2074 6865 2064  t there is the d
-0000fac0: 6972 6563 7420 582d 7261 7920 6265 616d  irect X-ray beam
-0000fad0: 2062 6563 6175 7365 2074 6865 7265 2069   because there i
-0000fae0: 730a 2020 2020 2020 2020 2320 6672 616d  s.        # fram
-0000faf0: 6520 746f 2066 7261 6d65 2066 6c75 6374  e to frame fluct
-0000fb00: 7561 7469 6f6e 7320 6672 6f6d 2074 6865  uations from the
-0000fb10: 2069 6e63 6f6d 696e 6720 6265 616d 2e20   incoming beam. 
-0000fb20: 5765 2064 6f6e e280 9974 0a20 2020 2020  We don...t.     
-0000fb30: 2020 2023 2074 7970 6963 616c 6c79 2061     # typically a
-0000fb40: 6363 6f75 6e74 2066 6f72 2074 6865 6d20  ccount for them 
-0000fb50: 6275 7420 706f 7465 6e74 6961 6c6c 7920  but potentially 
-0000fb60: 636f 756c 642e 0a20 2020 2020 2020 2069  could..        i
-0000fb70: 6620 7462 665f 7374 6163 6b2e 6e64 696d  f tbf_stack.ndim
-0000fb80: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
-0000fb90: 2020 2074 6266 203d 2074 6266 5f73 7461     tbf = tbf_sta
-0000fba0: 636b 0a20 2020 2020 2020 2065 6c69 6620  ck.        elif 
-0000fbb0: 7462 665f 7374 6163 6b2e 6e64 696d 203d  tbf_stack.ndim =
-0000fbc0: 3d20 333a 0a20 2020 2020 2020 2020 2020  = 3:.           
-0000fbd0: 2074 6266 203d 206e 702e 6d65 6469 616e   tbf = np.median
-0000fbe0: 2874 6266 5f73 7461 636b 2c20 6178 6973  (tbf_stack, axis
-0000fbf0: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
-0000fc00: 6465 6c20 7462 665f 7374 6163 6b0a 2020  del tbf_stack.  
-0000fc10: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000fc20: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
-0000fc30: 6e74 696d 6545 7272 6f72 2866 2749 6e76  ntimeError(f'Inv
-0000fc40: 616c 6964 2074 6266 5f73 7461 636b 2073  alid tbf_stack s
-0000fc50: 6861 7065 2028 7b74 6266 5f73 7461 636b  hape ({tbf_stack
-0000fc60: 2e73 6861 7065 7d29 2729 0a0a 2020 2020  .shape})')..    
-0000fc70: 2020 2020 2320 5375 6274 7261 6374 2064      # Subtract d
-0000fc80: 6172 6b20 6669 656c 640a 2020 2020 2020  ark field.      
-0000fc90: 2020 6966 2027 6461 7461 2720 696e 2072    if 'data' in r
-0000fca0: 6564 7563 6564 5f64 6174 6120 616e 6420  educed_data and 
-0000fcb0: 2764 6172 6b5f 6669 656c 6427 2069 6e20  'dark_field' in 
-0000fcc0: 7265 6475 6365 645f 6461 7461 2e64 6174  reduced_data.dat
-0000fcd0: 613a 0a20 2020 2020 2020 2020 2020 2074  a:.            t
-0000fce0: 6266 202d 3d20 7265 6475 6365 645f 6461  bf -= reduced_da
-0000fcf0: 7461 2e64 6174 612e 6461 726b 5f66 6965  ta.data.dark_fie
-0000fd00: 6c64 0a20 2020 2020 2020 2065 6c73 653a  ld.        else:
-0000fd10: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000fd20: 662e 5f6c 6f67 6765 722e 7761 726e 696e  f._logger.warnin
-0000fd30: 6728 2744 6172 6b20 6669 656c 6420 756e  g('Dark field un
-0000fd40: 6176 6169 6c61 626c 6527 290a 0a20 2020  available')..   
-0000fd50: 2020 2020 2023 2053 6574 2061 6e79 206e       # Set any n
-0000fd60: 6f6e 2d70 6f73 6974 6976 6520 7661 6c75  on-positive valu
-0000fd70: 6573 2074 6f20 6f6e 650a 2020 2020 2020  es to one.      
-0000fd80: 2020 2320 2861 766f 6964 206e 6567 6174    # (avoid negat
-0000fd90: 6976 6520 6272 6967 6874 2066 6965 6c64  ive bright field
-0000fda0: 2076 616c 7565 7320 666f 7220 7370 696b   values for spik
-0000fdb0: 6573 2069 6e20 6461 726b 2066 6965 6c64  es in dark field
-0000fdc0: 290a 2020 2020 2020 2020 7462 665b 7462  ).        tbf[tb
-0000fdd0: 6620 3c20 315d 203d 2031 0a0a 2020 2020  f < 1] = 1..    
-0000fde0: 2020 2020 2320 506c 6f74 2062 7269 6768      # Plot brigh
-0000fdf0: 7420 6669 656c 640a 2020 2020 2020 2020  t field.        
-0000fe00: 6966 2073 656c 662e 5f73 6176 655f 6669  if self._save_fi
-0000fe10: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-0000fe20: 7175 6963 6b5f 696d 7368 6f77 280a 2020  quick_imshow(.  
-0000fe30: 2020 2020 2020 2020 2020 2020 2020 7462                tb
-0000fe40: 662c 2074 6974 6c65 3d27 6272 6967 6874  f, title='bright
-0000fe50: 2066 6965 6c64 272c 2070 6174 683d 7365   field', path=se
-0000fe60: 6c66 2e5f 6f75 7470 7574 5f66 6f6c 6465  lf._output_folde
-0000fe70: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-0000fe80: 2020 2073 6176 655f 6669 673d 5472 7565     save_fig=True
-0000fe90: 2c20 7361 7665 5f6f 6e6c 793d 5472 7565  , save_only=True
-0000fea0: 290a 0a20 2020 2020 2020 2023 2041 6464  )..        # Add
-0000feb0: 2062 7269 6768 7420 6669 656c 6420 746f   bright field to
-0000fec0: 2072 6564 7563 6564 2064 6174 6120 4e58   reduced data NX
-0000fed0: 7072 6f63 6573 730a 2020 2020 2020 2020  process.        
-0000fee0: 6966 2027 6461 7461 2720 6e6f 7420 696e  if 'data' not in
-0000fef0: 2072 6564 7563 6564 5f64 6174 613a 0a20   reduced_data:. 
-0000ff00: 2020 2020 2020 2020 2020 2072 6564 7563             reduc
-0000ff10: 6564 5f64 6174 612e 6461 7461 203d 204e  ed_data.data = N
-0000ff20: 5864 6174 6128 290a 2020 2020 2020 2020  Xdata().        
-0000ff30: 7265 6475 6365 645f 6461 7461 2e64 6174  reduced_data.dat
-0000ff40: 615b 2762 7269 6768 745f 6669 656c 6427  a['bright_field'
-0000ff50: 5d20 3d20 7462 660a 0a20 2020 2020 2020  ] = tbf..       
-0000ff60: 2072 6574 7572 6e20 7265 6475 6365 645f   return reduced_
-0000ff70: 6461 7461 0a0a 2020 2020 6465 6620 5f73  data..    def _s
-0000ff80: 6574 5f64 6574 6563 746f 725f 626f 756e  et_detector_boun
-0000ff90: 6473 2873 656c 662c 206e 7865 6e74 7279  ds(self, nxentry
-0000ffa0: 2c20 7265 6475 6365 645f 6461 7461 2c20  , reduced_data, 
-0000ffb0: 7468 6574 612c 0a20 2020 2020 2020 2020  theta,.         
-0000ffc0: 2020 2069 6d67 5f78 5f62 6f75 6e64 733d     img_x_bounds=
-0000ffd0: 4e6f 6e65 293a 0a20 2020 2020 2020 2022  None):.        "
-0000ffe0: 2222 0a20 2020 2020 2020 2053 6574 2076  "".        Set v
-0000fff0: 6572 7469 6361 6c20 6465 7465 6374 6f72  ertical detector
-00010000: 2062 6f75 6e64 7320 666f 7220 6561 6368   bounds for each
-00010010: 2069 6d61 6765 2073 7461 636b 2e52 6967   image stack.Rig
-00010020: 6874 206e 6f77 2074 6865 0a20 2020 2020  ht now the.     
-00010030: 2020 2072 616e 6765 2069 7320 7468 6520     range is the 
-00010040: 7361 6d65 2066 6f72 2065 6163 6820 7365  same for each se
-00010050: 7420 696e 2074 6865 2069 6d61 6765 2073  t in the image s
-00010060: 7461 636b 2e0a 2020 2020 2020 2020 2222  tack..        ""
-00010070: 220a 2020 2020 2020 2020 2320 4c6f 6361  ".        # Loca
-00010080: 6c20 6d6f 6475 6c65 730a 2020 2020 2020  l modules.      
-00010090: 2020 6672 6f6d 2043 4841 502e 636f 6d6d    from CHAP.comm
-000100a0: 6f6e 2e6d 6f64 656c 732e 6d61 7020 696d  on.models.map im
-000100b0: 706f 7274 2028 0a20 2020 2020 2020 2020  port (.         
-000100c0: 2020 2067 6574 5f73 6361 6e70 6172 7365     get_scanparse
-000100d0: 722c 0a20 2020 2020 2020 2020 2020 2069  r,.            i
-000100e0: 6d70 6f72 745f 7363 616e 7061 7273 6572  mport_scanparser
-000100f0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00010100: 2020 2020 6672 6f6d 2043 4841 502e 636f      from CHAP.co
-00010110: 6d6d 6f6e 2e75 7469 6c73 2e67 656e 6572  mmon.utils.gener
-00010120: 616c 2069 6d70 6f72 7420 6973 5f69 6e64  al import is_ind
-00010130: 6578 5f72 616e 6765 0a0a 2020 2020 2020  ex_range..      
-00010140: 2020 6966 2073 656c 662e 5f74 6573 745f    if self._test_
-00010150: 6d6f 6465 3a0a 2020 2020 2020 2020 2020  mode:.          
-00010160: 2020 7265 7475 726e 2074 7570 6c65 2873    return tuple(s
-00010170: 656c 662e 5f74 6573 745f 636f 6e66 6967  elf._test_config
-00010180: 5b27 696d 675f 785f 626f 756e 6473 275d  ['img_x_bounds']
-00010190: 290a 0a20 2020 2020 2020 2023 2047 6574  )..        # Get
-000101a0: 2074 6865 2066 6972 7374 2074 6f6d 6f67   the first tomog
-000101b0: 7261 7068 7920 696d 6167 6520 616e 6420  raphy image and 
-000101c0: 7468 6520 7265 6665 7265 6e63 6520 6865  the reference he
-000101d0: 6967 6874 730a 2020 2020 2020 2020 696d  ights.        im
-000101e0: 6167 655f 6d61 736b 203d 2072 6564 7563  age_mask = reduc
-000101f0: 6564 5f64 6174 612e 6765 7428 2769 6d61  ed_data.get('ima
-00010200: 6765 5f6d 6173 6b27 290a 2020 2020 2020  ge_mask').      
-00010210: 2020 6966 2069 6d61 6765 5f6d 6173 6b20    if image_mask 
-00010220: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00010230: 2020 2020 2066 6972 7374 5f69 6d61 6765       first_image
-00010240: 5f69 6e64 6578 203d 2030 0a20 2020 2020  _index = 0.     
-00010250: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00010260: 2020 2020 2069 6d61 6765 5f6d 6173 6b20       image_mask 
-00010270: 3d20 6e70 2e61 7361 7272 6179 2869 6d61  = np.asarray(ima
-00010280: 6765 5f6d 6173 6b29 0a20 2020 2020 2020  ge_mask).       
-00010290: 2020 2020 2066 6972 7374 5f69 6d61 6765       first_image
-000102a0: 5f69 6e64 6578 203d 2069 6e74 286e 702e  _index = int(np.
-000102b0: 6172 676d 6178 2869 6d61 6765 5f6d 6173  argmax(image_mas
-000102c0: 6b29 290a 2020 2020 2020 2020 696d 6167  k)).        imag
-000102d0: 655f 6b65 7920 3d20 6e78 656e 7472 792e  e_key = nxentry.
-000102e0: 696e 7374 7275 6d65 6e74 2e64 6574 6563  instrument.detec
-000102f0: 746f 722e 6765 7428 2769 6d61 6765 5f6b  tor.get('image_k
-00010300: 6579 272c 204e 6f6e 6529 0a20 2020 2020  ey', None).     
-00010310: 2020 2069 6620 696d 6167 655f 6b65 7920     if image_key 
-00010320: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
-00010330: 2764 6174 6127 2069 6e20 6e78 656e 7472  'data' in nxentr
-00010340: 792e 696e 7374 7275 6d65 6e74 2e64 6574  y.instrument.det
-00010350: 6563 746f 723a 0a20 2020 2020 2020 2020  ector:.         
-00010360: 2020 2066 6965 6c64 5f69 6e64 6963 6573     field_indices
-00010370: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-00010380: 2020 2020 2069 6e64 6578 2066 6f72 2069       index for i
-00010390: 6e64 6578 2c20 6b65 7920 696e 2065 6e75  ndex, key in enu
-000103a0: 6d65 7261 7465 2869 6d61 6765 5f6b 6579  merate(image_key
-000103b0: 2920 6966 206b 6579 203d 3d20 305d 0a20  ) if key == 0]. 
-000103c0: 2020 2020 2020 2020 2020 2066 6965 6c64             field
-000103d0: 5f69 6e64 6963 6573 5f6d 6173 6b65 6420  _indices_masked 
-000103e0: 3d20 6669 656c 645f 696e 6469 6365 735b  = field_indices[
-000103f0: 696d 6167 655f 6d61 736b 5d0a 2020 2020  image_mask].    
-00010400: 2020 2020 2020 2020 6669 7273 745f 696d          first_im
-00010410: 6167 6520 3d20 6e70 2e61 7361 7272 6179  age = np.asarray
-00010420: 286e 7865 6e74 7279 2e69 6e73 7472 756d  (nxentry.instrum
-00010430: 656e 742e 6465 7465 6374 6f72 2e64 6174  ent.detector.dat
-00010440: 615b 0a20 2020 2020 2020 2020 2020 2020  a[.             
-00010450: 2020 2066 6965 6c64 5f69 6e64 6963 6573     field_indices
-00010460: 5b66 6972 7374 5f69 6d61 6765 5f69 6e64  [first_image_ind
-00010470: 6578 2c3a 2c3a 5d5d 290a 2020 2020 2020  ex,:,:]]).      
-00010480: 2020 2020 2020 6173 7365 7274 2074 6865        assert the
-00010490: 7461 203d 3d20 666c 6f61 7428 6e78 656e  ta == float(nxen
-000104a0: 7472 792e 7361 6d70 6c65 2e72 6f74 6174  try.sample.rotat
-000104b0: 696f 6e5f 616e 676c 655b 0a20 2020 2020  ion_angle[.     
-000104c0: 2020 2020 2020 2020 2020 2066 6965 6c64             field
-000104d0: 5f69 6e64 6963 6573 5b66 6972 7374 5f69  _indices[first_i
-000104e0: 6d61 6765 5f69 6e64 6578 5d5d 290a 2020  mage_index]]).  
-000104f0: 2020 2020 2020 2020 2020 7a5f 7472 616e            z_tran
-00010500: 736c 6174 696f 6e5f 616c 6c20 3d20 5c0a  slation_all = \.
-00010510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010520: 6e78 656e 7472 792e 7361 6d70 6c65 2e7a  nxentry.sample.z
-00010530: 5f74 7261 6e73 6c61 7469 6f6e 5b66 6965  _translation[fie
-00010540: 6c64 5f69 6e64 6963 6573 5f6d 6173 6b65  ld_indices_maske
-00010550: 645d 0a20 2020 2020 2020 2020 2020 2076  d].            v
-00010560: 6572 7469 6361 6c5f 7368 6966 7473 203d  ertical_shifts =
-00010570: 2073 6f72 7465 6428 6c69 7374 2873 6574   sorted(list(set
-00010580: 287a 5f74 7261 6e73 6c61 7469 6f6e 5f61  (z_translation_a
-00010590: 6c6c 2929 290a 2020 2020 2020 2020 2020  ll))).          
-000105a0: 2020 6e75 6d5f 746f 6d6f 5f73 7461 636b    num_tomo_stack
-000105b0: 7320 3d20 6c65 6e28 7665 7274 6963 616c  s = len(vertical
-000105c0: 5f73 6869 6674 7329 0a20 2020 2020 2020  _shifts).       
-000105d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000105e0: 2020 2069 6d70 6f72 745f 7363 616e 7061     import_scanpa
-000105f0: 7273 6572 280a 2020 2020 2020 2020 2020  rser(.          
-00010600: 2020 2020 2020 6e78 656e 7472 792e 696e        nxentry.in
-00010610: 7374 7275 6d65 6e74 2e73 6f75 7263 652e  strument.source.
-00010620: 6174 7472 735b 2773 7461 7469 6f6e 275d  attrs['station']
-00010630: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00010640: 2020 6e78 656e 7472 792e 696e 7374 7275    nxentry.instru
-00010650: 6d65 6e74 2e73 6f75 7263 652e 6174 7472  ment.source.attr
-00010660: 735b 2765 7870 6572 696d 656e 745f 7479  s['experiment_ty
-00010670: 7065 275d 290a 2020 2020 2020 2020 2020  pe']).          
-00010680: 2020 746f 6d6f 5f66 6965 6c64 5f73 6361    tomo_field_sca
-00010690: 6e73 203d 206e 7865 6e74 7279 2e73 7065  ns = nxentry.spe
-000106a0: 635f 7363 616e 732e 746f 6d6f 5f66 6965  c_scans.tomo_fie
-000106b0: 6c64 730a 2020 2020 2020 2020 2020 2020  lds.            
-000106c0: 6e75 6d5f 746f 6d6f 5f73 7461 636b 7320  num_tomo_stacks 
-000106d0: 3d20 6c65 6e28 746f 6d6f 5f66 6965 6c64  = len(tomo_field
-000106e0: 5f73 6361 6e73 2e6b 6579 7328 2929 0a20  _scans.keys()). 
-000106f0: 2020 2020 2020 2020 2020 2063 656e 7465             cente
-00010700: 725f 7374 6163 6b5f 696e 6465 7820 3d20  r_stack_index = 
-00010710: 696e 7428 6e75 6d5f 746f 6d6f 5f73 7461  int(num_tomo_sta
-00010720: 636b 732f 3229 0a20 2020 2020 2020 2020  cks/2).         
-00010730: 2020 2064 6574 6563 746f 725f 7072 6566     detector_pref
-00010740: 6978 203d 2073 7472 286e 7865 6e74 7279  ix = str(nxentry
-00010750: 2e69 6e73 7472 756d 656e 742e 6465 7465  .instrument.dete
-00010760: 6374 6f72 2e6c 6f63 616c 5f6e 616d 6529  ctor.local_name)
-00010770: 0a20 2020 2020 2020 2020 2020 2076 6572  .            ver
-00010780: 7469 6361 6c5f 7368 6966 7473 203d 205b  tical_shifts = [
-00010790: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
-000107a0: 7220 692c 206e 7873 7562 656e 7472 7920  r i, nxsubentry 
-000107b0: 696e 2065 6e75 6d65 7261 7465 2874 6f6d  in enumerate(tom
-000107c0: 6f5f 6669 656c 645f 7363 616e 732e 6974  o_field_scans.it
-000107d0: 656d 7328 2929 3a0a 2020 2020 2020 2020  ems()):.        
-000107e0: 2020 2020 2020 2020 7363 616e 5f6e 756d          scan_num
-000107f0: 6265 7220 3d20 696e 7428 6e78 7375 6265  ber = int(nxsube
-00010800: 6e74 7279 5b30 5d2e 7370 6c69 7428 275f  ntry[0].split('_
-00010810: 2729 5b2d 315d 290a 2020 2020 2020 2020  ')[-1]).        
-00010820: 2020 2020 2020 2020 7363 616e 7061 7273          scanpars
-00010830: 6572 203d 2067 6574 5f73 6361 6e70 6172  er = get_scanpar
-00010840: 7365 7228 0a20 2020 2020 2020 2020 2020  ser(.           
-00010850: 2020 2020 2020 2020 2074 6f6d 6f5f 6669           tomo_fi
-00010860: 656c 645f 7363 616e 732e 6174 7472 735b  eld_scans.attrs[
-00010870: 2773 7065 635f 6669 6c65 275d 2c20 7363  'spec_file'], sc
-00010880: 616e 5f6e 756d 6265 7229 0a20 2020 2020  an_number).     
-00010890: 2020 2020 2020 2020 2020 2069 6d61 6765             image
-000108a0: 5f6f 6666 7365 7420 3d20 696e 7428 0a20  _offset = int(. 
-000108b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000108c0: 2020 206e 7873 7562 656e 7472 795b 315d     nxsubentry[1]
-000108d0: 2e69 6e73 7472 756d 656e 742e 6465 7465  .instrument.dete
-000108e0: 6374 6f72 2e66 7261 6d65 5f73 7461 7274  ctor.frame_start
-000108f0: 5f6e 756d 6265 7229 0a20 2020 2020 2020  _number).       
-00010900: 2020 2020 2020 2020 2076 6572 7469 6361           vertica
-00010910: 6c5f 7368 6966 7473 2e61 7070 656e 6428  l_shifts.append(
-00010920: 6e78 7375 6265 6e74 7279 5b31 5d2e 7361  nxsubentry[1].sa
-00010930: 6d70 6c65 2e7a 5f74 7261 6e73 6c61 7469  mple.z_translati
-00010940: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
-00010950: 2020 2020 6966 2069 203d 3d20 6365 6e74      if i == cent
-00010960: 6572 5f73 7461 636b 5f69 6e64 6578 3a0a  er_stack_index:.
-00010970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010980: 2020 2020 6669 7273 745f 696d 6167 6520      first_image 
-00010990: 3d20 7363 616e 7061 7273 6572 2e67 6574  = scanparser.get
-000109a0: 5f64 6574 6563 746f 725f 6461 7461 280a  _detector_data(.
-000109b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000109c0: 2020 2020 2020 2020 6465 7465 6374 6f72          detector
-000109d0: 5f70 7265 6669 782c 2069 6d61 6765 5f6f  _prefix, image_o
-000109e0: 6666 7365 742b 6669 7273 745f 696d 6167  ffset+first_imag
-000109f0: 655f 696e 6465 7829 0a20 2020 2020 2020  e_index).       
-00010a00: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-00010a10: 6572 7420 7468 6574 6120 3d3d 2066 6c6f  ert theta == flo
-00010a20: 6174 280a 2020 2020 2020 2020 2020 2020  at(.            
-00010a30: 2020 2020 2020 2020 2020 2020 6e78 7375              nxsu
-00010a40: 6265 6e74 7279 5b31 5d2e 7361 6d70 6c65  bentry[1].sample
-00010a50: 2e72 6f74 6174 696f 6e5f 616e 676c 655b  .rotation_angle[
-00010a60: 6669 7273 745f 696d 6167 655f 696e 6465  first_image_inde
-00010a70: 785d 290a 0a20 2020 2020 2020 2023 2053  x])..        # S
-00010a80: 656c 6563 7420 696d 6167 6520 626f 756e  elect image boun
-00010a90: 6473 0a20 2020 2020 2020 2074 6974 6c65  ds.        title
-00010aa0: 203d 2066 2774 6f6d 6f67 7261 7068 7920   = f'tomography 
-00010ab0: 696d 6167 6520 6174 2074 6865 7461 3d7b  image at theta={
-00010ac0: 726f 756e 6428 7468 6574 612c 2032 292b  round(theta, 2)+
-00010ad0: 307d 270a 2020 2020 2020 2020 6966 2069  0}'.        if i
-00010ae0: 6d67 5f78 5f62 6f75 6e64 7320 3d3d 2028  mg_x_bounds == (
-00010af0: 2d31 2c20 2d31 293a 0a20 2020 2020 2020  -1, -1):.       
-00010b00: 2020 2020 2069 6d67 5f78 5f62 6f75 6e64       img_x_bound
-00010b10: 7320 3d20 4e6f 6e65 0a20 2020 2020 2020  s = None.       
-00010b20: 2069 6620 696d 675f 785f 626f 756e 6473   if img_x_bounds
-00010b30: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00010b40: 2020 2020 2020 2020 2020 6966 2069 735f            if is_
-00010b50: 696e 6465 785f 7261 6e67 6528 696d 675f  index_range(img_
-00010b60: 785f 626f 756e 6473 2c20 6765 3d30 2c20  x_bounds, ge=0, 
-00010b70: 6c65 3d66 6972 7374 5f69 6d61 6765 2e73  le=first_image.s
-00010b80: 6861 7065 5b30 5d29 3a0a 2020 2020 2020  hape[0]):.      
-00010b90: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00010ba0: 2069 6d67 5f78 5f62 6f75 6e64 730a 2020   img_x_bounds.  
-00010bb0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00010bc0: 662e 5f69 6e74 6572 6163 7469 7665 3a0a  f._interactive:.
-00010bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010be0: 7365 6c66 2e5f 6c6f 6767 6572 2e77 6172  self._logger.war
-00010bf0: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
-00010c00: 2020 2020 2020 2020 2020 6627 496e 7661            f'Inva
-00010c10: 6c69 6420 7061 7261 6d65 7465 7220 696d  lid parameter im
-00010c20: 675f 785f 626f 756e 6473 2028 7b69 6d67  g_x_bounds ({img
-00010c30: 5f78 5f62 6f75 6e64 737d 292c 2027 0a20  _x_bounds}), '. 
-00010c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c50: 2020 202b 2027 6967 6e6f 7269 6e67 2069     + 'ignoring i
-00010c60: 6d67 5f78 5f62 6f75 6e64 7327 290a 2020  mg_x_bounds').  
-00010c70: 2020 2020 2020 2020 2020 2020 2020 696d                im
-00010c80: 675f 785f 626f 756e 6473 203d 204e 6f6e  g_x_bounds = Non
-00010c90: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
-00010ca0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00010cb0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00010cc0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00010cd0: 2020 2020 2020 2020 2020 6627 496e 7661            f'Inva
-00010ce0: 6c69 6420 7061 7261 6d65 7465 7220 696d  lid parameter im
-00010cf0: 675f 785f 626f 756e 6473 2028 7b69 6d67  g_x_bounds ({img
-00010d00: 5f78 5f62 6f75 6e64 737d 2927 290a 2020  _x_bounds})').  
-00010d10: 2020 2020 2020 6966 206e 7865 6e74 7279        if nxentry
-00010d20: 2e69 6e73 7472 756d 656e 742e 736f 7572  .instrument.sour
-00010d30: 6365 2e61 7474 7273 5b27 7374 6174 696f  ce.attrs['statio
-00010d40: 6e27 5d20 696e 2028 2769 6431 6133 272c  n'] in ('id1a3',
-00010d50: 2027 6964 3361 2729 3a0a 2020 2020 2020   'id3a'):.      
-00010d60: 2020 2020 2020 7069 7865 6c5f 7369 7a65        pixel_size
-00010d70: 203d 206e 7865 6e74 7279 2e69 6e73 7472   = nxentry.instr
-00010d80: 756d 656e 742e 6465 7465 6374 6f72 2e78  ument.detector.x
-00010d90: 5f70 6978 656c 5f73 697a 650a 2020 2020  _pixel_size.    
-00010da0: 2020 2020 2020 2020 2320 5472 7920 746f          # Try to
-00010db0: 2067 6574 2061 2066 6974 2066 726f 6d20   get a fit from 
-00010dc0: 7468 6520 6272 6967 6874 2066 6965 6c64  the bright field
-00010dd0: 0a20 2020 2020 2020 2020 2020 2074 6266  .            tbf
-00010de0: 203d 206e 702e 6173 6172 7261 7928 7265   = np.asarray(re
-00010df0: 6475 6365 645f 6461 7461 2e64 6174 612e  duced_data.data.
-00010e00: 6272 6967 6874 5f66 6965 6c64 290a 2020  bright_field).  
-00010e10: 2020 2020 2020 2020 2020 7462 665f 7368            tbf_sh
-00010e20: 6170 6520 3d20 7462 662e 7368 6170 650a  ape = tbf.shape.
-00010e30: 2020 2020 2020 2020 2020 2020 785f 7375              x_su
-00010e40: 6d20 3d20 6e70 2e73 756d 2874 6266 2c20  m = np.sum(tbf, 
-00010e50: 3129 0a20 2020 2020 2020 2020 2020 2078  1).            x
-00010e60: 5f73 756d 5f6d 696e 203d 2078 5f73 756d  _sum_min = x_sum
-00010e70: 2e6d 696e 2829 0a20 2020 2020 2020 2020  .min().         
-00010e80: 2020 2078 5f73 756d 5f6d 6178 203d 2078     x_sum_max = x
-00010e90: 5f73 756d 2e6d 6178 2829 0a20 2020 2020  _sum.max().     
-00010ea0: 2020 2020 2020 2066 6974 203d 2046 6974         fit = Fit
-00010eb0: 2e66 6974 5f64 6174 6128 0a20 2020 2020  .fit_data(.     
-00010ec0: 2020 2020 2020 2020 2020 2078 5f73 756d             x_sum
-00010ed0: 2c20 2772 6563 7461 6e67 6c65 272c 2078  , 'rectangle', x
-00010ee0: 3d6e 702e 6172 7261 7928 7261 6e67 6528  =np.array(range(
-00010ef0: 6c65 6e28 785f 7375 6d29 2929 2c0a 2020  len(x_sum))),.  
-00010f00: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00010f10: 726d 3d27 6174 616e 272c 2067 7565 7373  rm='atan', guess
-00010f20: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
-00010f30: 2020 2070 6172 616d 6574 6572 7320 3d20     parameters = 
-00010f40: 6669 742e 6265 7374 5f76 616c 7565 730a  fit.best_values.
-00010f50: 2020 2020 2020 2020 2020 2020 785f 6c6f              x_lo
-00010f60: 775f 6669 7420 3d20 7061 7261 6d65 7465  w_fit = paramete
-00010f70: 7273 2e67 6574 2827 6365 6e74 6572 3127  rs.get('center1'
-00010f80: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
-00010f90: 2020 2020 785f 7570 705f 6669 7420 3d20      x_upp_fit = 
-00010fa0: 7061 7261 6d65 7465 7273 2e67 6574 2827  parameters.get('
-00010fb0: 6365 6e74 6572 3227 2c20 4e6f 6e65 290a  center2', None).
-00010fc0: 2020 2020 2020 2020 2020 2020 7369 675f              sig_
-00010fd0: 6c6f 7720 3d20 7061 7261 6d65 7465 7273  low = parameters
-00010fe0: 2e67 6574 2827 7369 676d 6131 272c 204e  .get('sigma1', N
-00010ff0: 6f6e 6529 0a20 2020 2020 2020 2020 2020  one).           
-00011000: 2073 6967 5f75 7070 203d 2070 6172 616d   sig_upp = param
-00011010: 6574 6572 732e 6765 7428 2773 6967 6d61  eters.get('sigma
-00011020: 3227 2c20 4e6f 6e65 290a 2020 2020 2020  2', None).      
-00011030: 2020 2020 2020 6861 7665 5f66 6974 203d        have_fit =
-00011040: 2028 6669 742e 7375 6363 6573 7320 616e   (fit.success an
-00011050: 6420 785f 6c6f 775f 6669 7420 6973 206e  d x_low_fit is n
-00011060: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
-00011070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011080: 616e 6420 785f 7570 705f 6669 7420 6973  and x_upp_fit is
-00011090: 206e 6f74 204e 6f6e 6520 616e 6420 7369   not None and si
-000110a0: 675f 6c6f 7720 6973 206e 6f74 204e 6f6e  g_low is not Non
-000110b0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-000110c0: 2020 2020 2020 2020 2020 616e 6420 7369            and si
-000110d0: 675f 7570 7020 6973 206e 6f74 204e 6f6e  g_upp is not Non
-000110e0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-000110f0: 2020 2020 2020 2020 2020 616e 6420 3020            and 0 
-00011100: 3c3d 2078 5f6c 6f77 5f66 6974 203c 2078  <= x_low_fit < x
-00011110: 5f75 7070 5f66 6974 203c 3d20 785f 7375  _upp_fit <= x_su
-00011120: 6d2e 7369 7a65 0a20 2020 2020 2020 2020  m.size.         
-00011130: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00011140: 6e64 2028 7369 675f 6c6f 772b 7369 675f  nd (sig_low+sig_
-00011150: 7570 7029 202f 2028 785f 7570 705f 6669  upp) / (x_upp_fi
-00011160: 742d 785f 6c6f 775f 6669 7429 203c 2030  t-x_low_fit) < 0
-00011170: 2e31 290a 2020 2020 2020 2020 2020 2020  .1).            
-00011180: 6966 2068 6176 655f 6669 743a 0a20 2020  if have_fit:.   
-00011190: 2020 2020 2020 2020 2020 2020 2023 2053               # S
-000111a0: 6574 2061 2035 2520 6d61 7267 696e 206f  et a 5% margin o
-000111b0: 6e20 6561 6368 2073 6964 650a 2020 2020  n each side.    
-000111c0: 2020 2020 2020 2020 2020 2020 6d61 7267              marg
-000111d0: 696e 203d 2030 2e30 3520 2a20 2878 5f75  in = 0.05 * (x_u
-000111e0: 7070 5f66 6974 2d78 5f6c 6f77 5f66 6974  pp_fit-x_low_fit
-000111f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00011200: 2020 785f 6c6f 775f 6669 7420 3d20 6d61    x_low_fit = ma
-00011210: 7828 302c 2078 5f6c 6f77 5f66 6974 2d6d  x(0, x_low_fit-m
-00011220: 6172 6769 6e29 0a20 2020 2020 2020 2020  argin).         
-00011230: 2020 2020 2020 2078 5f75 7070 5f66 6974         x_upp_fit
-00011240: 203d 206d 696e 2874 6266 5f73 6861 7065   = min(tbf_shape
-00011250: 5b30 5d2c 2078 5f75 7070 5f66 6974 2b6d  [0], x_upp_fit+m
-00011260: 6172 6769 6e29 0a20 2020 2020 2020 2020  argin).         
-00011270: 2020 2069 6620 6e75 6d5f 746f 6d6f 5f73     if num_tomo_s
-00011280: 7461 636b 7320 3d3d 2031 3a0a 2020 2020  tacks == 1:.    
-00011290: 2020 2020 2020 2020 2020 2020 6966 2068              if h
-000112a0: 6176 655f 6669 743a 0a20 2020 2020 2020  ave_fit:.       
-000112b0: 2020 2020 2020 2020 2020 2020 2023 2053               # S
-000112c0: 6574 2074 6865 2064 6566 6175 6c74 2072  et the default r
-000112d0: 616e 6765 2074 6f20 656e 636c 6f73 6520  ange to enclose 
-000112e0: 7468 6520 6675 6c6c 2066 6974 7465 640a  the full fitted.
-000112f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011300: 2020 2020 2320 2020 2020 7769 6e64 6f77      #     window
-00011310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011320: 2020 2020 2078 5f6c 6f77 203d 2069 6e74       x_low = int
-00011330: 2878 5f6c 6f77 5f66 6974 290a 2020 2020  (x_low_fit).    
-00011340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011350: 785f 7570 7020 3d20 696e 7428 785f 7570  x_upp = int(x_up
-00011360: 705f 6669 7429 0a20 2020 2020 2020 2020  p_fit).         
-00011370: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00011380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011390: 2023 2043 656e 7465 7220 6120 6465 6661   # Center a defa
-000113a0: 756c 7420 7261 6e67 6520 6f66 2031 206d  ult range of 1 m
-000113b0: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
-000113c0: 2020 2020 2020 2320 5256 2063 616e 2077        # RV can w
-000113d0: 6520 6765 7420 7468 6973 2066 726f 6d20  e get this from 
-000113e0: 7468 6520 736c 6974 733f 0a20 2020 2020  the slits?.     
-000113f0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00011400: 756d 5f78 5f6d 696e 203d 2069 6e74 2828  um_x_min = int((
-00011410: 312e 202b 2030 2e35 2a70 6978 656c 5f73  1. + 0.5*pixel_s
-00011420: 697a 6529 202f 2070 6978 656c 5f73 697a  ize) / pixel_siz
-00011430: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00011440: 2020 2020 2020 2078 5f6c 6f77 203d 2069         x_low = i
-00011450: 6e74 2828 7462 665f 7368 6170 655b 305d  nt((tbf_shape[0]
-00011460: 2d6e 756d 5f78 5f6d 696e 2920 2f20 3229  -num_x_min) / 2)
-00011470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011480: 2020 2020 2078 5f75 7070 203d 2078 5f6c       x_upp = x_l
-00011490: 6f77 2b6e 756d 5f78 5f6d 696e 0a20 2020  ow+num_x_min.   
-000114a0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000114b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000114c0: 2047 6574 2074 6865 2064 6566 6175 6c74   Get the default
-000114d0: 2072 616e 6765 2066 726f 6d20 7468 6520   range from the 
-000114e0: 7265 6665 7265 6e63 6520 6865 6967 6874  reference height
-000114f0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00011500: 2020 6465 6c74 615f 7a20 3d20 7665 7274    delta_z = vert
-00011510: 6963 616c 5f73 6869 6674 735b 315d 2d76  ical_shifts[1]-v
-00011520: 6572 7469 6361 6c5f 7368 6966 7473 5b30  ertical_shifts[0
-00011530: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00011540: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-00011550: 2832 2c20 6e75 6d5f 746f 6d6f 5f73 7461  (2, num_tomo_sta
-00011560: 636b 7329 3a0a 2020 2020 2020 2020 2020  cks):.          
-00011570: 2020 2020 2020 2020 2020 6465 6c74 615f            delta_
-00011580: 7a20 3d20 6d69 6e28 0a20 2020 2020 2020  z = min(.       
-00011590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115a0: 2064 656c 7461 5f7a 2c20 7665 7274 6963   delta_z, vertic
-000115b0: 616c 5f73 6869 6674 735b 695d 2d76 6572  al_shifts[i]-ver
-000115c0: 7469 6361 6c5f 7368 6966 7473 5b69 2d31  tical_shifts[i-1
-000115d0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-000115e0: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
-000115f0: 6465 6275 6728 6627 6465 6c74 615f 7a20  debug(f'delta_z 
-00011600: 3d20 7b64 656c 7461 5f7a 7d27 290a 2020  = {delta_z}').  
-00011610: 2020 2020 2020 2020 2020 2020 2020 6e75                nu
-00011620: 6d5f 785f 6d69 6e20 3d20 696e 7428 2864  m_x_min = int((d
-00011630: 656c 7461 5f7a 202b 2030 2e35 2a70 6978  elta_z + 0.5*pix
-00011640: 656c 5f73 697a 6529 202f 2070 6978 656c  el_size) / pixel
-00011650: 5f73 697a 6529 0a20 2020 2020 2020 2020  _size).         
-00011660: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-00011670: 6765 722e 6465 6275 6728 6627 6e75 6d5f  ger.debug(f'num_
-00011680: 785f 6d69 6e20 3d20 7b6e 756d 5f78 5f6d  x_min = {num_x_m
-00011690: 696e 7d27 290a 2020 2020 2020 2020 2020  in}').          
-000116a0: 2020 2020 2020 6966 206e 756d 5f78 5f6d        if num_x_m
-000116b0: 696e 203e 2074 6266 5f73 6861 7065 5b30  in > tbf_shape[0
-000116c0: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-000116d0: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-000116e0: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
-000116f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011700: 2020 2020 2027 496d 6167 6520 626f 756e       'Image boun
-00011710: 6473 2061 6e64 2070 6978 656c 2073 697a  ds and pixel siz
-00011720: 6520 7072 6576 656e 7420 7365 616d 6c65  e prevent seamle
-00011730: 7373 2027 0a20 2020 2020 2020 2020 2020  ss '.           
-00011740: 2020 2020 2020 2020 2020 2020 202b 2027               + '
-00011750: 7374 6163 6b69 6e67 2729 0a20 2020 2020  stacking').     
-00011760: 2020 2020 2020 2020 2020 2069 6620 6861             if ha
-00011770: 7665 5f66 6974 3a0a 2020 2020 2020 2020  ve_fit:.        
-00011780: 2020 2020 2020 2020 2020 2020 2320 4365              # Ce
-00011790: 6e74 6572 2074 6865 2064 6566 6175 6c74  nter the default
-000117a0: 2072 616e 6765 2072 656c 6174 6976 6520   range relative 
-000117b0: 746f 2074 6865 2066 6974 7465 640a 2020  to the fitted.  
-000117c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117d0: 2020 2320 2020 2020 7769 6e64 6f77 0a20    #     window. 
-000117e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117f0: 2020 2078 5f6c 6f77 203d 2069 6e74 2828     x_low = int((
-00011800: 785f 6c6f 775f 6669 742b 785f 7570 705f  x_low_fit+x_upp_
-00011810: 6669 742d 6e75 6d5f 785f 6d69 6e29 202f  fit-num_x_min) /
-00011820: 2032 290a 2020 2020 2020 2020 2020 2020   2).            
-00011830: 2020 2020 2020 2020 785f 7570 7020 3d20          x_upp = 
-00011840: 785f 6c6f 772b 6e75 6d5f 785f 6d69 6e0a  x_low+num_x_min.
-00011850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011860: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00011870: 2020 2020 2020 2020 2020 2320 4365 6e74            # Cent
-00011880: 6572 2074 6865 2064 6566 6175 6c74 2072  er the default r
-00011890: 616e 6765 0a20 2020 2020 2020 2020 2020  ange.           
-000118a0: 2020 2020 2020 2020 2078 5f6c 6f77 203d           x_low =
-000118b0: 2069 6e74 2828 7462 665f 7368 6170 655b   int((tbf_shape[
-000118c0: 305d 2d6e 756d 5f78 5f6d 696e 2920 2f20  0]-num_x_min) / 
-000118d0: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
-000118e0: 2020 2020 2020 2078 5f75 7070 203d 2078         x_upp = x
-000118f0: 5f6c 6f77 2b6e 756d 5f78 5f6d 696e 0a20  _low+num_x_min. 
-00011900: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00011910: 7420 7365 6c66 2e5f 696e 7465 7261 6374  t self._interact
-00011920: 6976 653a 0a20 2020 2020 2020 2020 2020  ive:.           
-00011930: 2020 2020 2069 6d67 5f78 5f62 6f75 6e64       img_x_bound
-00011940: 7320 3d20 2878 5f6c 6f77 2c20 785f 7570  s = (x_low, x_up
-00011950: 7029 0a20 2020 2020 2020 2020 2020 2065  p).            e
-00011960: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00011970: 2020 2020 2074 6d70 203d 206e 702e 636f       tmp = np.co
-00011980: 7079 2874 6266 290a 2020 2020 2020 2020  py(tbf).        
-00011990: 2020 2020 2020 2020 746d 705f 6d61 7820          tmp_max 
-000119a0: 3d20 746d 702e 6d61 7828 290a 2020 2020  = tmp.max().    
-000119b0: 2020 2020 2020 2020 2020 2020 746d 705b              tmp[
-000119c0: 785f 6c6f 772c 3a5d 203d 2074 6d70 5f6d  x_low,:] = tmp_m
-000119d0: 6178 0a20 2020 2020 2020 2020 2020 2020  ax.             
-000119e0: 2020 2074 6d70 5b78 5f75 7070 2d31 2c3a     tmp[x_upp-1,:
-000119f0: 5d20 3d20 746d 705f 6d61 780a 2020 2020  ] = tmp_max.    
-00011a00: 2020 2020 2020 2020 2020 2020 7175 6963              quic
-00011a10: 6b5f 696d 7368 6f77 2874 6d70 2c20 7469  k_imshow(tmp, ti
-00011a20: 746c 653d 2762 7269 6768 7420 6669 656c  tle='bright fiel
-00011a30: 6427 290a 2020 2020 2020 2020 2020 2020  d').            
-00011a40: 2020 2020 746d 7020 3d20 6e70 2e63 6f70      tmp = np.cop
-00011a50: 7928 6669 7273 745f 696d 6167 6529 0a20  y(first_image). 
-00011a60: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00011a70: 6d70 5f6d 6178 203d 2074 6d70 2e6d 6178  mp_max = tmp.max
-00011a80: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00011a90: 2020 2074 6d70 5b78 5f6c 6f77 2c3a 5d20     tmp[x_low,:] 
-00011aa0: 3d20 746d 705f 6d61 780a 2020 2020 2020  = tmp_max.      
-00011ab0: 2020 2020 2020 2020 2020 746d 705b 785f            tmp[x_
-00011ac0: 7570 702d 312c 3a5d 203d 2074 6d70 5f6d  upp-1,:] = tmp_m
-00011ad0: 6178 0a20 2020 2020 2020 2020 2020 2020  ax.             
-00011ae0: 2020 2071 7569 636b 5f69 6d73 686f 7728     quick_imshow(
-00011af0: 746d 702c 2074 6974 6c65 3d74 6974 6c65  tmp, title=title
-00011b00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00011b10: 2020 6465 6c20 746d 700a 2020 2020 2020    del tmp.      
-00011b20: 2020 2020 2020 2020 2020 7175 6963 6b5f            quick_
-00011b30: 706c 6f74 280a 2020 2020 2020 2020 2020  plot(.          
-00011b40: 2020 2020 2020 2020 2020 2872 616e 6765            (range
-00011b50: 2878 5f73 756d 2e73 697a 6529 2c20 785f  (x_sum.size), x_
-00011b60: 7375 6d29 2c0a 2020 2020 2020 2020 2020  sum),.          
-00011b70: 2020 2020 2020 2020 2020 285b 785f 6c6f            ([x_lo
-00011b80: 772c 2078 5f6c 6f77 5d2c 205b 785f 7375  w, x_low], [x_su
-00011b90: 6d5f 6d69 6e2c 2078 5f73 756d 5f6d 6178  m_min, x_sum_max
-00011ba0: 5d2c 2027 722d 2729 2c0a 2020 2020 2020  ], 'r-'),.      
-00011bb0: 2020 2020 2020 2020 2020 2020 2020 285b                ([
-00011bc0: 785f 7570 702c 2078 5f75 7070 5d2c 205b  x_upp, x_upp], [
-00011bd0: 785f 7375 6d5f 6d69 6e2c 2078 5f73 756d  x_sum_min, x_sum
-00011be0: 5f6d 6178 5d2c 2027 722d 2729 2c0a 2020  _max], 'r-'),.  
-00011bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c00: 2020 7469 746c 653d 2773 756d 206f 7665    title='sum ove
-00011c10: 7220 7468 6574 6120 616e 6420 7927 290a  r theta and y').
-00011c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c30: 7072 696e 7428 6627 6c6f 7765 7220 626f  print(f'lower bo
-00011c40: 756e 6420 3d20 7b78 5f6c 6f77 7d20 2869  und = {x_low} (i
-00011c50: 6e63 6c75 7369 7665 2927 290a 2020 2020  nclusive)').    
-00011c60: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00011c70: 7428 6627 7570 7065 7220 626f 756e 6420  t(f'upper bound 
-00011c80: 3d20 7b78 5f75 7070 7d20 2865 7863 6c75  = {x_upp} (exclu
-00011c90: 7369 7665 295d 2729 0a20 2020 2020 2020  sive)]').       
-00011ca0: 2020 2020 2020 2020 2061 6363 6570 7420           accept 
-00011cb0: 3d20 696e 7075 745f 7965 736e 6f28 2741  = input_yesno('A
-00011cc0: 6363 6570 7420 7468 6573 6520 626f 756e  ccept these boun
-00011cd0: 6473 2028 792f 6e29 3f27 2c20 2779 2729  ds (y/n)?', 'y')
-00011ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011cf0: 2063 6c65 6172 5f69 6d73 686f 7728 2762   clear_imshow('b
-00011d00: 7269 6768 7420 6669 656c 6427 290a 2020  right field').  
-00011d10: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-00011d20: 6561 725f 696d 7368 6f77 2874 6974 6c65  ear_imshow(title
-00011d30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00011d40: 2020 636c 6561 725f 706c 6f74 2827 7375    clear_plot('su
-00011d50: 6d20 6f76 6572 2074 6865 7461 2061 6e64  m over theta and
-00011d60: 2079 2729 0a20 2020 2020 2020 2020 2020   y').           
-00011d70: 2020 2020 2069 6620 6163 6365 7074 3a0a       if accept:.
-00011d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d90: 2020 2020 696d 675f 785f 626f 756e 6473      img_x_bounds
-00011da0: 203d 2028 785f 6c6f 772c 2078 5f75 7070   = (x_low, x_upp
-00011db0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00011dc0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00011dd0: 2020 2020 2020 2020 2020 2020 7768 696c              whil
-00011de0: 6520 5472 7565 3a0a 2020 2020 2020 2020  e True:.        
-00011df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e00: 5f2c 2069 6d67 5f78 5f62 6f75 6e64 7320  _, img_x_bounds 
-00011e10: 3d20 6472 6177 5f6d 6173 6b5f 3164 280a  = draw_mask_1d(.
-00011e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e30: 2020 2020 2020 2020 2020 2020 785f 7375              x_su
-00011e40: 6d2c 2074 6974 6c65 3d27 7365 6c65 6374  m, title='select
-00011e50: 2078 2064 6174 6120 7261 6e67 6527 2c0a   x data range',.
-00011e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e70: 2020 2020 2020 2020 2020 2020 796c 6162              ylab
-00011e80: 656c 3d27 7375 6d20 6f76 6572 2074 6865  el='sum over the
-00011e90: 7461 2061 6e64 2079 2729 0a20 2020 2020  ta and y').     
-00011ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011eb0: 2020 2069 6620 6c65 6e28 696d 675f 785f     if len(img_x_
-00011ec0: 626f 756e 6473 2920 3d3d 2031 3a0a 2020  bounds) == 1:.  
-00011ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ee0: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-00011ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011f00: 2020 2020 2020 2020 7072 696e 7428 2743          print('C
-00011f10: 686f 6f73 6520 6120 7369 6e67 6c65 2063  hoose a single c
-00011f20: 6f6e 6e65 6374 6564 2064 6174 6120 7261  onnected data ra
-00011f30: 6e67 6527 290a 2020 2020 2020 2020 2020  nge').          
-00011f40: 2020 2020 2020 2020 2020 696d 675f 785f            img_x_
-00011f50: 626f 756e 6473 203d 2074 7570 6c65 2869  bounds = tuple(i
-00011f60: 6d67 5f78 5f62 6f75 6e64 735b 305d 290a  mg_x_bounds[0]).
-00011f70: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00011f80: 6e75 6d5f 746f 6d6f 5f73 7461 636b 7320  num_tomo_stacks 
-00011f90: 3e20 310a 2020 2020 2020 2020 2020 2020  > 1.            
-00011fa0: 2020 2020 2020 2020 616e 6420 2869 6d67          and (img
-00011fb0: 5f78 5f62 6f75 6e64 735b 315d 2d69 6d67  _x_bounds[1]-img
-00011fc0: 5f78 5f62 6f75 6e64 735b 305d 2b31 290a  _x_bounds[0]+1).
-00011fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011fe0: 2020 2020 2020 2020 203c 2069 6e74 2828           < int((
-00011ff0: 6465 6c74 615f 7a20 2d20 302e 352a 7069  delta_z - 0.5*pi
-00012000: 7865 6c5f 7369 7a65 2920 2f20 7069 7865  xel_size) / pixe
-00012010: 6c5f 7369 7a65 2929 3a0a 2020 2020 2020  l_size)):.      
-00012020: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00012030: 6c6f 6767 6572 2e77 6172 6e69 6e67 280a  logger.warning(.
-00012040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012050: 2020 2020 2749 6d61 6765 2062 6f75 6e64      'Image bound
-00012060: 7320 616e 6420 7069 7865 6c20 7369 7a65  s and pixel size
-00012070: 2070 7265 7665 6e74 2073 6561 6d6c 6573   prevent seamles
-00012080: 7320 7374 6163 6b69 6e67 2729 0a20 2020  s stacking').   
-00012090: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000120a0: 2020 2020 2020 2069 6620 6e75 6d5f 746f         if num_to
-000120b0: 6d6f 5f73 7461 636b 7320 3e20 313a 0a20  mo_stacks > 1:. 
-000120c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000120d0: 6169 7365 204e 6f74 496d 706c 656d 656e  aise NotImplemen
-000120e0: 7465 6445 7272 6f72 280a 2020 2020 2020  tedError(.      
-000120f0: 2020 2020 2020 2020 2020 2020 2020 2753                'S
-00012100: 656c 6563 7469 6e67 2069 6d61 6765 2062  electing image b
-00012110: 6f75 6e64 7320 666f 7220 6d75 6c74 6970  ounds for multip
-00012120: 6c65 2073 7461 636b 7320 6f6e 2046 4d42  le stacks on FMB
-00012130: 2729 0a20 2020 2020 2020 2020 2020 2023  ').            #
-00012140: 2046 6f72 2046 4d42 3a20 7573 6520 7468   For FMB: use th
-00012150: 6520 6669 7273 7420 746f 6d6f 6772 6170  e first tomograp
-00012160: 6879 2069 6d61 6765 2074 6f20 7365 6c65  hy image to sele
-00012170: 6374 2072 616e 6765 0a20 2020 2020 2020  ct range.       
-00012180: 2020 2020 2023 2052 5620 7265 7669 7369       # RV revisi
-00012190: 7420 6966 2074 6865 7920 646f 2074 6f6d  t if they do tom
-000121a0: 6f67 7261 7068 7920 7769 7468 206d 756c  ography with mul
-000121b0: 7469 706c 6520 7374 6163 6b73 0a20 2020  tiple stacks.   
-000121c0: 2020 2020 2020 2020 2078 5f73 756d 203d           x_sum =
-000121d0: 206e 702e 7375 6d28 6669 7273 745f 696d   np.sum(first_im
-000121e0: 6167 652c 2031 290a 2020 2020 2020 2020  age, 1).        
-000121f0: 2020 2020 785f 7375 6d5f 6d69 6e20 3d20      x_sum_min = 
-00012200: 785f 7375 6d2e 6d69 6e28 290a 2020 2020  x_sum.min().    
-00012210: 2020 2020 2020 2020 785f 7375 6d5f 6d61          x_sum_ma
-00012220: 7820 3d20 785f 7375 6d2e 6d61 7828 290a  x = x_sum.max().
-00012230: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00012240: 656c 662e 5f69 6e74 6572 6163 7469 7665  elf._interactive
-00012250: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012260: 2020 7072 696e 7428 0a20 2020 2020 2020    print(.       
-00012270: 2020 2020 2020 2020 2020 2020 2027 5365               'Se
-00012280: 6c65 6374 2076 6572 7469 6361 6c20 6461  lect vertical da
-00012290: 7461 2072 6564 7563 7469 6f6e 2072 616e  ta reduction ran
-000122a0: 6765 2066 726f 6d20 6669 7273 7420 270a  ge from first '.
-000122b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122c0: 2020 2020 2b20 2774 6f6d 6f67 7261 7068      + 'tomograph
-000122d0: 7920 696d 6167 6527 290a 2020 2020 2020  y image').      
-000122e0: 2020 2020 2020 2020 2020 696d 675f 785f            img_x_
-000122f0: 626f 756e 6473 203d 2073 656c 6563 745f  bounds = select_
-00012300: 696d 6167 655f 626f 756e 6473 2866 6972  image_bounds(fir
-00012310: 7374 5f69 6d61 6765 2c20 302c 2074 6974  st_image, 0, tit
-00012320: 6c65 3d74 6974 6c65 290a 2020 2020 2020  le=title).      
-00012330: 2020 2020 2020 2020 2020 6966 2069 6d67            if img
-00012340: 5f78 5f62 6f75 6e64 7320 6973 204e 6f6e  _x_bounds is Non
-00012350: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00012360: 2020 2020 2020 2072 6169 7365 2052 756e         raise Run
-00012370: 7469 6d65 4572 726f 7228 2755 6e61 626c  timeError('Unabl
-00012380: 6520 746f 2073 656c 6563 7420 696d 6167  e to select imag
-00012390: 6520 626f 756e 6473 2729 0a20 2020 2020  e bounds').     
-000123a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000123b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000123c0: 696d 675f 785f 626f 756e 6473 2069 7320  img_x_bounds is 
-000123d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000123e0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-000123f0: 6c6f 6767 6572 2e77 6172 6e69 6e67 280a  logger.warning(.
-00012400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012410: 2020 2020 2020 2020 2769 6d67 5f78 5f62          'img_x_b
-00012420: 6f75 6e64 7320 756e 7370 6563 6966 6965  ounds unspecifie
-00012430: 642c 2072 6564 7563 6520 6461 7461 2066  d, reduce data f
-00012440: 6f72 2065 6e74 6972 6520 270a 2020 2020  or entire '.    
-00012450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012460: 2020 2020 2b20 2764 6574 6563 746f 7220      + 'detector 
-00012470: 7261 6e67 6527 290a 2020 2020 2020 2020  range').        
-00012480: 2020 2020 2020 2020 2020 2020 696d 675f              img_
-00012490: 785f 626f 756e 6473 203d 2028 302c 2066  x_bounds = (0, f
-000124a0: 6972 7374 5f69 6d61 6765 2e73 6861 7065  irst_image.shape
-000124b0: 5b30 5d29 0a0a 2020 2020 2020 2020 2320  [0])..        # 
-000124c0: 506c 6f74 2072 6573 756c 7473 0a20 2020  Plot results.   
-000124d0: 2020 2020 2069 6620 7365 6c66 2e5f 7361       if self._sa
-000124e0: 7665 5f66 6967 733a 0a20 2020 2020 2020  ve_figs:.       
-000124f0: 2020 2020 2078 5f6c 6f77 203d 2069 6d67       x_low = img
-00012500: 5f78 5f62 6f75 6e64 735b 305d 0a20 2020  _x_bounds[0].   
-00012510: 2020 2020 2020 2020 2078 5f75 7070 203d           x_upp =
-00012520: 2069 6d67 5f78 5f62 6f75 6e64 735b 315d   img_x_bounds[1]
-00012530: 0a20 2020 2020 2020 2020 2020 2074 6d70  .            tmp
-00012540: 203d 206e 702e 636f 7079 2866 6972 7374   = np.copy(first
-00012550: 5f69 6d61 6765 290a 2020 2020 2020 2020  _image).        
-00012560: 2020 2020 746d 705f 6d61 7820 3d20 746d      tmp_max = tm
-00012570: 702e 6d61 7828 290a 2020 2020 2020 2020  p.max().        
-00012580: 2020 2020 746d 705b 785f 6c6f 772c 3a5d      tmp[x_low,:]
-00012590: 203d 2074 6d70 5f6d 6178 0a20 2020 2020   = tmp_max.     
-000125a0: 2020 2020 2020 2074 6d70 5b78 5f75 7070         tmp[x_upp
-000125b0: 2d31 2c3a 5d20 3d20 746d 705f 6d61 780a  -1,:] = tmp_max.
-000125c0: 2020 2020 2020 2020 2020 2020 7175 6963              quic
-000125d0: 6b5f 696d 7368 6f77 280a 2020 2020 2020  k_imshow(.      
-000125e0: 2020 2020 2020 2020 2020 746d 702c 2074            tmp, t
-000125f0: 6974 6c65 3d74 6974 6c65 2c20 7061 7468  itle=title, path
-00012600: 3d73 656c 662e 5f6f 7574 7075 745f 666f  =self._output_fo
-00012610: 6c64 6572 2c20 7361 7665 5f66 6967 3d54  lder, save_fig=T
-00012620: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-00012630: 2020 2020 2073 6176 655f 6f6e 6c79 3d54       save_only=T
-00012640: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
-00012650: 2071 7569 636b 5f70 6c6f 7428 0a20 2020   quick_plot(.   
-00012660: 2020 2020 2020 2020 2020 2020 2028 7261               (ra
-00012670: 6e67 6528 785f 7375 6d2e 7369 7a65 292c  nge(x_sum.size),
-00012680: 2078 5f73 756d 292c 0a20 2020 2020 2020   x_sum),.       
-00012690: 2020 2020 2020 2020 2028 5b78 5f6c 6f77           ([x_low
-000126a0: 2c20 785f 6c6f 775d 2c20 5b78 5f73 756d  , x_low], [x_sum
-000126b0: 5f6d 696e 2c20 785f 7375 6d5f 6d61 785d  _min, x_sum_max]
-000126c0: 2c20 2772 2d27 292c 0a20 2020 2020 2020  , 'r-'),.       
-000126d0: 2020 2020 2020 2020 2028 5b78 5f75 7070           ([x_upp
-000126e0: 2c20 785f 7570 705d 2c20 5b78 5f73 756d  , x_upp], [x_sum
-000126f0: 5f6d 696e 2c20 785f 7375 6d5f 6d61 785d  _min, x_sum_max]
-00012700: 2c20 2772 2d27 292c 0a20 2020 2020 2020  , 'r-'),.       
-00012710: 2020 2020 2020 2020 2074 6974 6c65 3d27           title='
-00012720: 7375 6d20 6f76 6572 2074 6865 7461 2061  sum over theta a
-00012730: 6e64 2079 272c 2070 6174 683d 7365 6c66  nd y', path=self
-00012740: 2e5f 6f75 7470 7574 5f66 6f6c 6465 722c  ._output_folder,
-00012750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012760: 2073 6176 655f 6669 673d 5472 7565 2c20   save_fig=True, 
-00012770: 7361 7665 5f6f 6e6c 793d 5472 7565 290a  save_only=True).
-00012780: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
-00012790: 746d 700a 0a20 2020 2020 2020 2072 6574  tmp..        ret
-000127a0: 7572 6e20 696d 675f 785f 626f 756e 6473  urn img_x_bounds
-000127b0: 0a0a 2020 2020 6465 6620 5f67 656e 5f74  ..    def _gen_t
-000127c0: 6865 7461 7328 7365 6c66 2c20 6e78 656e  hetas(self, nxen
-000127d0: 7472 7929 3a0a 2020 2020 2020 2020 2222  try):.        ""
-000127e0: 2247 6574 2074 6865 2072 6f74 6174 696f  "Get the rotatio
-000127f0: 6e20 616e 676c 6573 2066 6f72 2074 6865  n angles for the
-00012800: 2069 6d61 6765 2073 7461 636b 732e 2222   image stacks.""
-00012810: 220a 0a20 2020 2020 2020 2023 2047 6574  "..        # Get
-00012820: 2074 6865 2072 6f74 6174 696f 6e20 616e   the rotation an
-00012830: 676c 6573 0a20 2020 2020 2020 2069 6d61  gles.        ima
-00012840: 6765 5f6b 6579 203d 206e 7865 6e74 7279  ge_key = nxentry
-00012850: 2e69 6e73 7472 756d 656e 742e 6465 7465  .instrument.dete
-00012860: 6374 6f72 2e67 6574 2827 696d 6167 655f  ctor.get('image_
-00012870: 6b65 7927 2c20 4e6f 6e65 290a 2020 2020  key', None).    
-00012880: 2020 2020 6966 2069 6d61 6765 5f6b 6579      if image_key
-00012890: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
-000128a0: 2027 6461 7461 2720 696e 206e 7865 6e74   'data' in nxent
-000128b0: 7279 2e69 6e73 7472 756d 656e 742e 6465  ry.instrument.de
-000128c0: 7465 6374 6f72 3a0a 2020 2020 2020 2020  tector:.        
-000128d0: 2020 2020 6669 656c 645f 696e 6469 6365      field_indice
-000128e0: 735f 616c 6c20 3d20 5b0a 2020 2020 2020  s_all = [.      
-000128f0: 2020 2020 2020 2020 2020 696e 6465 7820            index 
-00012900: 666f 7220 696e 6465 782c 206b 6579 2069  for index, key i
-00012910: 6e20 656e 756d 6572 6174 6528 696d 6167  n enumerate(imag
-00012920: 655f 6b65 7929 2069 6620 6b65 7920 3d3d  e_key) if key ==
-00012930: 2030 5d0a 2020 2020 2020 2020 2020 2020   0].            
-00012940: 7a5f 7472 616e 736c 6174 696f 6e5f 616c  z_translation_al
-00012950: 6c20 3d20 6e78 656e 7472 792e 7361 6d70  l = nxentry.samp
-00012960: 6c65 2e7a 5f74 7261 6e73 6c61 7469 6f6e  le.z_translation
-00012970: 5b66 6965 6c64 5f69 6e64 6963 6573 5f61  [field_indices_a
-00012980: 6c6c 5d0a 2020 2020 2020 2020 2020 2020  ll].            
-00012990: 7a5f 7472 616e 736c 6174 696f 6e5f 6c65  z_translation_le
-000129a0: 7665 6c73 203d 2073 6f72 7465 6428 6c69  vels = sorted(li
-000129b0: 7374 2873 6574 287a 5f74 7261 6e73 6c61  st(set(z_transla
-000129c0: 7469 6f6e 5f61 6c6c 2929 290a 2020 2020  tion_all))).    
-000129d0: 2020 2020 2020 2020 7468 6574 6173 203d          thetas =
-000129e0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-000129f0: 2020 666f 7220 692c 207a 5f74 7261 6e73    for i, z_trans
-00012a00: 6c61 7469 6f6e 2069 6e20 656e 756d 6572  lation in enumer
-00012a10: 6174 6528 7a5f 7472 616e 736c 6174 696f  ate(z_translatio
-00012a20: 6e5f 6c65 7665 6c73 293a 0a20 2020 2020  n_levels):.     
-00012a30: 2020 2020 2020 2020 2020 2066 6965 6c64             field
-00012a40: 5f69 6e64 6963 6573 203d 205b 0a20 2020  _indices = [.   
-00012a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012a60: 2066 6965 6c64 5f69 6e64 6963 6573 5f61   field_indices_a
-00012a70: 6c6c 5b69 6e64 6578 5d0a 2020 2020 2020  ll[index].      
-00012a80: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00012a90: 7220 696e 6465 782c 207a 2069 6e20 656e  r index, z in en
-00012aa0: 756d 6572 6174 6528 7a5f 7472 616e 736c  umerate(z_transl
-00012ab0: 6174 696f 6e5f 616c 6c29 0a20 2020 2020  ation_all).     
-00012ac0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012ad0: 6620 7a20 3d3d 207a 5f74 7261 6e73 6c61  f z == z_transla
-00012ae0: 7469 6f6e 5d0a 2020 2020 2020 2020 2020  tion].          
-00012af0: 2020 2020 2020 7365 7175 656e 6365 5f6e        sequence_n
-00012b00: 756d 6265 7273 203d 205c 0a20 2020 2020  umbers = \.     
-00012b10: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00012b20: 7865 6e74 7279 2e69 6e73 7472 756d 656e  xentry.instrumen
-00012b30: 742e 6465 7465 6374 6f72 2e73 6571 7565  t.detector.seque
-00012b40: 6e63 655f 6e75 6d62 6572 5b66 6965 6c64  nce_number[field
-00012b50: 5f69 6e64 6963 6573 5d0a 2020 2020 2020  _indices].      
-00012b60: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00012b70: 2028 6c69 7374 2873 6571 7565 6e63 655f   (list(sequence_
-00012b80: 6e75 6d62 6572 7329 0a20 2020 2020 2020  numbers).       
-00012b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ba0: 203d 3d20 6c69 7374 2872 616e 6765 2828   == list(range((
-00012bb0: 6c65 6e28 7365 7175 656e 6365 5f6e 756d  len(sequence_num
-00012bc0: 6265 7273 2929 2929 290a 2020 2020 2020  bers))))).      
-00012bd0: 2020 2020 2020 2020 2020 6966 2074 6865            if the
-00012be0: 7461 7320 6973 204e 6f6e 653a 0a20 2020  tas is None:.   
-00012bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c00: 2074 6865 7461 7320 3d20 6e70 2e61 7361   thetas = np.asa
-00012c10: 7272 6179 280a 2020 2020 2020 2020 2020  rray(.          
-00012c20: 2020 2020 2020 2020 2020 2020 2020 6e78                nx
-00012c30: 656e 7472 792e 7361 6d70 6c65 2e72 6f74  entry.sample.rot
-00012c40: 6174 696f 6e5f 616e 676c 655b 0a20 2020  ation_angle[.   
-00012c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c60: 2020 2020 2020 2020 2066 6965 6c64 5f69           field_i
-00012c70: 6e64 6963 6573 5d29 5b73 6571 7565 6e63  ndices])[sequenc
-00012c80: 655f 6e75 6d62 6572 735d 0a20 2020 2020  e_numbers].     
-00012c90: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00012ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012cb0: 2020 2020 2061 7373 6572 7420 616c 6c28       assert all(
-00012cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012cd0: 2020 2020 2020 2020 2074 6865 7461 735b           thetas[
-00012ce0: 695d 203d 3d20 6e78 656e 7472 792e 7361  i] == nxentry.sa
-00012cf0: 6d70 6c65 2e72 6f74 6174 696f 6e5f 616e  mple.rotation_an
-00012d00: 676c 655b 0a20 2020 2020 2020 2020 2020  gle[.           
-00012d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d20: 2066 6965 6c64 5f69 6e64 6963 6573 5b69   field_indices[i
-00012d30: 6e64 6578 5d5d 0a20 2020 2020 2020 2020  ndex]].         
-00012d40: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00012d50: 6f72 2069 2c20 696e 6465 7820 696e 2065  or i, index in e
-00012d60: 6e75 6d65 7261 7465 2873 6571 7565 6e63  numerate(sequenc
-00012d70: 655f 6e75 6d62 6572 7329 290a 2020 2020  e_numbers)).    
-00012d80: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00012d90: 2020 2020 2020 746f 6d6f 5f66 6965 6c64        tomo_field
-00012da0: 5f73 6361 6e73 203d 206e 7865 6e74 7279  _scans = nxentry
-00012db0: 2e73 7065 635f 7363 616e 732e 746f 6d6f  .spec_scans.tomo
-00012dc0: 5f66 6965 6c64 730a 2020 2020 2020 2020  _fields.        
-00012dd0: 2020 2020 7468 6574 6173 203d 204e 6f6e      thetas = Non
-00012de0: 650a 2020 2020 2020 2020 2020 2020 666f  e.            fo
-00012df0: 7220 6e78 7375 6265 6e74 7279 5f6e 616d  r nxsubentry_nam
-00012e00: 652c 206e 7873 7562 656e 7472 7920 696e  e, nxsubentry in
-00012e10: 2074 6f6d 6f5f 6669 656c 645f 7363 616e   tomo_field_scan
-00012e20: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
-00012e30: 2020 2020 2020 2020 2020 2069 6620 7468             if th
-00012e40: 6574 6173 2069 7320 4e6f 6e65 3a0a 2020  etas is None:.  
+000091d0: 6c6f 7765 725f 726f 7720 3d20 300a 2020  lower_row = 0.  
+000091e0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000091f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009200: 6c6f 7765 725f 726f 7720 3d20 6365 6e74  lower_row = cent
+00009210: 6572 5f72 6f77 735b 305d 0a20 2020 2020  er_rows[0].     
+00009220: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00009230: 7420 3020 3c3d 206c 6f77 6572 5f72 6f77  t 0 <= lower_row
+00009240: 203c 2074 6f6d 6f5f 6669 656c 6473 5f73   < tomo_fields_s
+00009250: 6861 7065 5b32 5d2d 313a 0a20 2020 2020  hape[2]-1:.     
+00009260: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00009270: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00009280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009290: 2020 2020 2020 2020 2066 2749 6e76 616c           f'Inval
+000092a0: 6964 2070 6172 616d 6574 6572 2063 656e  id parameter cen
+000092b0: 7465 725f 726f 7773 2028 7b63 656e 7465  ter_rows ({cente
+000092c0: 725f 726f 7773 7d29 2729 0a20 2020 2020  r_rows})').     
+000092d0: 2020 2074 3020 3d20 7469 6d65 2829 0a20     t0 = time(). 
+000092e0: 2020 2020 2020 206c 6f77 6572 5f63 656e         lower_cen
+000092f0: 7465 725f 6f66 6673 6574 203d 2073 656c  ter_offset = sel
+00009300: 662e 5f66 696e 645f 6365 6e74 6572 5f6f  f._find_center_o
+00009310: 6e65 5f70 6c61 6e65 280a 2020 2020 2020  ne_plane(.      
+00009320: 2020 2020 2020 6e78 656e 7472 792e 7265        nxentry.re
+00009330: 6475 6365 645f 6461 7461 2e64 6174 612e  duced_data.data.
+00009340: 746f 6d6f 5f66 6965 6c64 735b 0a20 2020  tomo_fields[.   
+00009350: 2020 2020 2020 2020 2020 2020 2063 656e               cen
+00009360: 7465 725f 7374 6163 6b5f 696e 6465 782c  ter_stack_index,
+00009370: 3a2c 6c6f 7765 725f 726f 772c 3a5d 2c0a  :,lower_row,:],.
+00009380: 2020 2020 2020 2020 2020 2020 6c6f 7765              lowe
+00009390: 725f 726f 772c 2074 6865 7461 732c 2065  r_row, thetas, e
+000093a0: 6666 5f70 6978 656c 5f73 697a 652c 2063  ff_pixel_size, c
+000093b0: 726f 7373 5f73 6563 7469 6f6e 616c 5f64  ross_sectional_d
+000093c0: 696d 2c0a 2020 2020 2020 2020 2020 2020  im,.            
+000093d0: 7061 7468 3d73 656c 662e 5f6f 7574 7075  path=self._outpu
+000093e0: 745f 666f 6c64 6572 2c20 6e75 6d5f 636f  t_folder, num_co
+000093f0: 7265 3d73 656c 662e 5f6e 756d 5f63 6f72  re=self._num_cor
+00009400: 652c 0a20 2020 2020 2020 2020 2020 2067  e,.            g
+00009410: 6175 7373 6961 6e5f 7369 676d 613d 6761  aussian_sigma=ga
+00009420: 7573 7369 616e 5f73 6967 6d61 2c20 7269  ussian_sigma, ri
+00009430: 6e67 5f77 6964 7468 3d72 696e 675f 7769  ng_width=ring_wi
+00009440: 6474 6829 0a20 2020 2020 2020 2073 656c  dth).        sel
+00009450: 662e 5f6c 6f67 6765 722e 696e 666f 2866  f._logger.info(f
+00009460: 2746 696e 6469 6e67 2063 656e 7465 7220  'Finding center 
+00009470: 746f 6f6b 207b 7469 6d65 2829 2d74 303a  took {time()-t0:
+00009480: 2e32 667d 2073 6563 6f6e 6473 2729 0a20  .2f} seconds'). 
+00009490: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
+000094a0: 6765 722e 6465 6275 6728 6627 6c6f 7765  ger.debug(f'lowe
+000094b0: 725f 726f 7720 3d20 7b6c 6f77 6572 5f72  r_row = {lower_r
+000094c0: 6f77 3a2e 3266 7d27 290a 2020 2020 2020  ow:.2f}').      
+000094d0: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e64    self._logger.d
+000094e0: 6562 7567 2866 276c 6f77 6572 5f63 656e  ebug(f'lower_cen
+000094f0: 7465 725f 6f66 6673 6574 203d 207b 6c6f  ter_offset = {lo
+00009500: 7765 725f 6365 6e74 6572 5f6f 6666 7365  wer_center_offse
+00009510: 743a 2e32 667d 2729 0a0a 2020 2020 2020  t:.2f}')..      
+00009520: 2020 2320 5570 7065 7220 726f 7720 6365    # Upper row ce
+00009530: 6e74 6572 0a20 2020 2020 2020 2069 6620  nter.        if 
+00009540: 7365 6c66 2e5f 7465 7374 5f6d 6f64 653a  self._test_mode:
+00009550: 0a20 2020 2020 2020 2020 2020 2075 7070  .            upp
+00009560: 6572 5f72 6f77 203d 2073 656c 662e 5f74  er_row = self._t
+00009570: 6573 745f 636f 6e66 6967 5b27 7570 7065  est_config['uppe
+00009580: 725f 726f 7727 5d0a 2020 2020 2020 2020  r_row'].        
+00009590: 656c 6966 2073 656c 662e 5f69 6e74 6572  elif self._inter
+000095a0: 6163 7469 7665 3a0a 2020 2020 2020 2020  active:.        
+000095b0: 2020 2020 6966 2063 656e 7465 725f 726f      if center_ro
+000095c0: 7773 2069 7320 6e6f 7420 4e6f 6e65 2061  ws is not None a
+000095d0: 6e64 2063 656e 7465 725f 726f 7773 5b31  nd center_rows[1
+000095e0: 5d20 6973 206e 6f74 204e 6f6e 653a 0a20  ] is not None:. 
+000095f0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+00009600: 7070 6572 5f72 6f77 203d 2063 656e 7465  pper_row = cente
+00009610: 725f 726f 7773 5b31 5d0a 2020 2020 2020  r_rows[1].      
+00009620: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00009630: 206c 6f77 6572 5f72 6f77 203c 2075 7070   lower_row < upp
+00009640: 6572 5f72 6f77 203c 2074 6f6d 6f5f 6669  er_row < tomo_fi
+00009650: 656c 6473 5f73 6861 7065 5b32 5d3a 0a20  elds_shape[2]:. 
+00009660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009670: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00009680: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00009690: 2020 2020 2020 2020 2020 2020 2066 2749               f'I
+000096a0: 6e76 616c 6964 2070 6172 616d 6574 6572  nvalid parameter
+000096b0: 2063 656e 7465 725f 726f 7773 2028 7b63   center_rows ({c
+000096c0: 656e 7465 725f 726f 7773 7d29 2729 0a20  enter_rows})'). 
+000096d0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000096e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000096f0: 2075 7070 6572 5f72 6f77 203d 2073 656c   upper_row = sel
+00009700: 6563 745f 6f6e 655f 696d 6167 655f 626f  ect_one_image_bo
+00009710: 756e 6428 0a20 2020 2020 2020 2020 2020  und(.           
+00009720: 2020 2020 2020 2020 206e 7865 6e74 7279           nxentry
+00009730: 2e72 6564 7563 6564 5f64 6174 612e 6461  .reduced_data.da
+00009740: 7461 2e74 6f6d 6f5f 6669 656c 6473 5b0a  ta.tomo_fields[.
+00009750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009760: 2020 2020 2020 2020 6365 6e74 6572 5f73          center_s
+00009770: 7461 636b 5f69 6e64 6578 2c30 2c3a 2c3a  tack_index,0,:,:
+00009780: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00009790: 2020 2020 2020 2030 2c20 626f 756e 643d         0, bound=
+000097a0: 746f 6d6f 5f66 6965 6c64 735f 7368 6170  tomo_fields_shap
+000097b0: 655b 325d 2d31 2c0a 2020 2020 2020 2020  e[2]-1,.        
+000097c0: 2020 2020 2020 2020 2020 2020 7469 746c              titl
+000097d0: 653d 6627 7468 6574 6120 3d20 7b72 6f75  e=f'theta = {rou
+000097e0: 6e64 2874 6865 7461 735b 305d 2c20 3229  nd(thetas[0], 2)
+000097f0: 2b30 7d27 2c0a 2020 2020 2020 2020 2020  +0}',.          
+00009800: 2020 2020 2020 2020 2020 626f 756e 645f            bound_
+00009810: 6e61 6d65 3d27 726f 7720 696e 6465 7820  name='row index 
+00009820: 746f 2066 696e 6420 7570 7065 7220 6365  to find upper ce
+00009830: 6e74 6572 272c 0a20 2020 2020 2020 2020  nter',.         
+00009840: 2020 2020 2020 2020 2020 2064 6566 6175             defau
+00009850: 6c74 3d64 6566 6175 6c74 2c20 7261 6973  lt=default, rais
+00009860: 655f 6572 726f 723d 5472 7565 290a 2020  e_error=True).  
+00009870: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00009880: 2020 2020 2020 2020 6966 2063 656e 7465          if cente
+00009890: 725f 726f 7773 2069 7320 4e6f 6e65 206f  r_rows is None o
+000098a0: 7220 6365 6e74 6572 5f72 6f77 735b 315d  r center_rows[1]
+000098b0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+000098c0: 2020 2020 2020 2020 2020 7570 7065 725f            upper_
+000098d0: 726f 7720 3d20 746f 6d6f 5f66 6965 6c64  row = tomo_field
+000098e0: 735f 7368 6170 655b 325d 2d31 0a20 2020  s_shape[2]-1.   
+000098f0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00009900: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+00009910: 7070 6572 5f72 6f77 203d 2063 656e 7465  pper_row = cente
+00009920: 725f 726f 7773 5b31 5d0a 2020 2020 2020  r_rows[1].      
+00009930: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00009940: 206c 6f77 6572 5f72 6f77 203c 2075 7070   lower_row < upp
+00009950: 6572 5f72 6f77 203c 2074 6f6d 6f5f 6669  er_row < tomo_fi
+00009960: 656c 6473 5f73 6861 7065 5b32 5d3a 0a20  elds_shape[2]:. 
+00009970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009980: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00009990: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+000099a0: 2020 2020 2020 2020 2020 2020 2066 2749               f'I
+000099b0: 6e76 616c 6964 2070 6172 616d 6574 6572  nvalid parameter
+000099c0: 2063 656e 7465 725f 726f 7773 2028 7b63   center_rows ({c
+000099d0: 656e 7465 725f 726f 7773 7d29 2729 0a20  enter_rows})'). 
+000099e0: 2020 2020 2020 2074 3020 3d20 7469 6d65         t0 = time
+000099f0: 2829 0a20 2020 2020 2020 2075 7070 6572  ().        upper
+00009a00: 5f63 656e 7465 725f 6f66 6673 6574 203d  _center_offset =
+00009a10: 2073 656c 662e 5f66 696e 645f 6365 6e74   self._find_cent
+00009a20: 6572 5f6f 6e65 5f70 6c61 6e65 280a 2020  er_one_plane(.  
+00009a30: 2020 2020 2020 2020 2020 6e78 656e 7472            nxentr
+00009a40: 792e 7265 6475 6365 645f 6461 7461 2e64  y.reduced_data.d
+00009a50: 6174 612e 746f 6d6f 5f66 6965 6c64 735b  ata.tomo_fields[
+00009a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009a70: 2063 656e 7465 725f 7374 6163 6b5f 696e   center_stack_in
+00009a80: 6465 782c 3a2c 7570 7065 725f 726f 772c  dex,:,upper_row,
+00009a90: 3a5d 2c0a 2020 2020 2020 2020 2020 2020  :],.            
+00009aa0: 7570 7065 725f 726f 772c 2074 6865 7461  upper_row, theta
+00009ab0: 732c 2065 6666 5f70 6978 656c 5f73 697a  s, eff_pixel_siz
+00009ac0: 652c 2063 726f 7373 5f73 6563 7469 6f6e  e, cross_section
+00009ad0: 616c 5f64 696d 2c0a 2020 2020 2020 2020  al_dim,.        
+00009ae0: 2020 2020 7061 7468 3d73 656c 662e 5f6f      path=self._o
+00009af0: 7574 7075 745f 666f 6c64 6572 2c20 6e75  utput_folder, nu
+00009b00: 6d5f 636f 7265 3d73 656c 662e 5f6e 756d  m_core=self._num
+00009b10: 5f63 6f72 652c 0a20 2020 2020 2020 2020  _core,.         
+00009b20: 2020 2067 6175 7373 6961 6e5f 7369 676d     gaussian_sigm
+00009b30: 613d 6761 7573 7369 616e 5f73 6967 6d61  a=gaussian_sigma
+00009b40: 2c20 7269 6e67 5f77 6964 7468 3d72 696e  , ring_width=rin
+00009b50: 675f 7769 6474 6829 0a20 2020 2020 2020  g_width).       
+00009b60: 2073 656c 662e 5f6c 6f67 6765 722e 696e   self._logger.in
+00009b70: 666f 2866 2746 696e 6469 6e67 2063 656e  fo(f'Finding cen
+00009b80: 7465 7220 746f 6f6b 207b 7469 6d65 2829  ter took {time()
+00009b90: 2d74 303a 2e32 667d 2073 6563 6f6e 6473  -t0:.2f} seconds
+00009ba0: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00009bb0: 5f6c 6f67 6765 722e 6465 6275 6728 6627  _logger.debug(f'
+00009bc0: 7570 7065 725f 726f 7720 3d20 7b75 7070  upper_row = {upp
+00009bd0: 6572 5f72 6f77 3a2e 3266 7d27 290a 2020  er_row:.2f}').  
+00009be0: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+00009bf0: 6572 2e64 6562 7567 2866 2775 7070 6572  er.debug(f'upper
+00009c00: 5f63 656e 7465 725f 6f66 6673 6574 203d  _center_offset =
+00009c10: 207b 7570 7065 725f 6365 6e74 6572 5f6f   {upper_center_o
+00009c20: 6666 7365 743a 2e32 667d 2729 0a0a 2020  ffset:.2f}')..  
+00009c30: 2020 2020 2020 6365 6e74 6572 5f63 6f6e        center_con
+00009c40: 6669 6720 3d20 7b0a 2020 2020 2020 2020  fig = {.        
+00009c50: 2020 2020 276c 6f77 6572 5f72 6f77 273a      'lower_row':
+00009c60: 206c 6f77 6572 5f72 6f77 2c0a 2020 2020   lower_row,.    
+00009c70: 2020 2020 2020 2020 276c 6f77 6572 5f63          'lower_c
+00009c80: 656e 7465 725f 6f66 6673 6574 273a 206c  enter_offset': l
+00009c90: 6f77 6572 5f63 656e 7465 725f 6f66 6673  ower_center_offs
+00009ca0: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
+00009cb0: 2775 7070 6572 5f72 6f77 273a 2075 7070  'upper_row': upp
+00009cc0: 6572 5f72 6f77 2c0a 2020 2020 2020 2020  er_row,.        
+00009cd0: 2020 2020 2775 7070 6572 5f63 656e 7465      'upper_cente
+00009ce0: 725f 6f66 6673 6574 273a 2075 7070 6572  r_offset': upper
+00009cf0: 5f63 656e 7465 725f 6f66 6673 6574 2c0a  _center_offset,.
+00009d00: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00009d10: 2020 6966 206e 756d 5f74 6f6d 6f5f 7374    if num_tomo_st
+00009d20: 6163 6b73 203e 2031 3a0a 2020 2020 2020  acks > 1:.      
+00009d30: 2020 2020 2020 6365 6e74 6572 5f63 6f6e        center_con
+00009d40: 6669 675b 2763 656e 7465 725f 7374 6163  fig['center_stac
+00009d50: 6b5f 696e 6465 7827 5d20 3d20 6365 6e74  k_index'] = cent
+00009d60: 6572 5f73 7461 636b 5f69 6e64 6578 0a0a  er_stack_index..
+00009d70: 2020 2020 2020 2020 2320 5361 7665 2074          # Save t
+00009d80: 6573 7420 6461 7461 2074 6f20 6669 6c65  est data to file
+00009d90: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00009da0: 2e5f 7465 7374 5f6d 6f64 653a 0a20 2020  ._test_mode:.   
+00009db0: 2020 2020 2020 2020 2077 6974 6820 6f70           with op
+00009dc0: 656e 2866 277b 7365 6c66 2e5f 6f75 7470  en(f'{self._outp
+00009dd0: 7574 5f66 6f6c 6465 727d 2f63 656e 7465  ut_folder}/cente
+00009de0: 725f 636f 6e66 6967 2e79 616d 6c27 2c20  r_config.yaml', 
+00009df0: 2777 272c 0a20 2020 2020 2020 2020 2020  'w',.           
+00009e00: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
+00009e10: 696e 673d 2775 7466 3827 2920 6173 2066  ing='utf8') as f
+00009e20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009e30: 2020 7361 6665 5f64 756d 7028 6365 6e74    safe_dump(cent
+00009e40: 6572 5f63 6f6e 6669 672c 2066 290a 0a20  er_config, f).. 
+00009e50: 2020 2020 2020 2072 6574 7572 6e20 6365         return ce
+00009e60: 6e74 6572 5f63 6f6e 6669 670a 0a20 2020  nter_config..   
+00009e70: 2064 6566 2072 6563 6f6e 7374 7275 6374   def reconstruct
+00009e80: 5f64 6174 6128 0a20 2020 2020 2020 2020  _data(.         
+00009e90: 2020 2073 656c 662c 206e 7872 6f6f 742c     self, nxroot,
+00009ea0: 2063 656e 7465 725f 696e 666f 2c20 785f   center_info, x_
+00009eb0: 626f 756e 6473 3d4e 6f6e 652c 2079 5f62  bounds=None, y_b
+00009ec0: 6f75 6e64 733d 4e6f 6e65 2c0a 2020 2020  ounds=None,.    
+00009ed0: 2020 2020 2020 2020 7a5f 626f 756e 6473          z_bounds
+00009ee0: 3d4e 6f6e 652c 2073 6563 6f6e 6461 7279  =None, secondary
+00009ef0: 5f69 7465 7273 3d30 2c20 7265 6d6f 7665  _iters=0, remove
+00009f00: 5f73 7472 6970 655f 7369 676d 613d 4e6f  _stripe_sigma=No
+00009f10: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00009f20: 7269 6e67 5f77 6964 7468 3d4e 6f6e 6529  ring_width=None)
+00009f30: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00009f40: 2020 2020 2020 5265 636f 6e73 7472 7563        Reconstruc
+00009f50: 7420 7468 6520 746f 6d6f 6772 6170 6879  t the tomography
+00009f60: 2064 6174 612e 0a0a 2020 2020 2020 2020   data...        
+00009f70: 3a70 6172 616d 206e 7872 6f6f 743a 2052  :param nxroot: R
+00009f80: 6564 7563 6564 2064 6174 610a 2020 2020  educed data.    
+00009f90: 2020 2020 3a74 7970 6520 6461 7461 3a20      :type data: 
+00009fa0: 6e65 7875 7366 6f72 6d61 742e 6e65 7875  nexusformat.nexu
+00009fb0: 732e 4e58 726f 6f74 0a20 2020 2020 2020  s.NXroot.       
+00009fc0: 203a 7061 7261 6d20 6365 6e74 6572 5f69   :param center_i
+00009fd0: 6e66 6f3a 2043 616c 6962 7261 7465 6420  nfo: Calibrated 
+00009fe0: 6365 6e74 6572 2061 7869 7320 696e 666f  center axis info
+00009ff0: 0a20 2020 2020 2020 203a 7479 7065 2063  .        :type c
+0000a000: 656e 7465 725f 696e 666f 3a20 6469 6374  enter_info: dict
+0000a010: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000a020: 785f 626f 756e 6473 3a20 5265 636f 6e73  x_bounds: Recons
+0000a030: 7472 7563 7465 6420 696d 6167 6520 626f  tructed image bo
+0000a040: 756e 6473 2069 6e20 7468 6520 782d 6469  unds in the x-di
+0000a050: 7265 6374 696f 6e0a 2020 2020 2020 2020  rection.        
+0000a060: 3a74 7970 6520 785f 626f 756e 6473 3a20  :type x_bounds: 
+0000a070: 7475 706c 6528 696e 742c 2069 6e74 292c  tuple(int, int),
+0000a080: 206c 6973 745b 696e 745d 2c20 6f70 7469   list[int], opti
+0000a090: 6f6e 616c 0a20 2020 2020 2020 203a 7061  onal.        :pa
+0000a0a0: 7261 6d20 795f 626f 756e 6473 3a20 5265  ram y_bounds: Re
+0000a0b0: 636f 6e73 7472 7563 7465 6420 696d 6167  constructed imag
+0000a0c0: 6520 626f 756e 6473 2069 6e20 7468 6520  e bounds in the 
+0000a0d0: 792d 6469 7265 6374 696f 6e0a 2020 2020  y-direction.    
+0000a0e0: 2020 2020 3a74 7970 6520 795f 626f 756e      :type y_boun
+0000a0f0: 6473 3a20 7475 706c 6528 696e 742c 2069  ds: tuple(int, i
+0000a100: 6e74 292c 206c 6973 745b 696e 745d 2c20  nt), list[int], 
+0000a110: 6f70 7469 6f6e 616c 0a20 2020 2020 2020  optional.       
+0000a120: 203a 7061 7261 6d20 7a5f 626f 756e 6473   :param z_bounds
+0000a130: 3a20 5265 636f 6e73 7472 7563 7465 6420  : Reconstructed 
+0000a140: 696d 6167 6520 626f 756e 6473 2069 6e20  image bounds in 
+0000a150: 7468 6520 7a2d 6469 7265 6374 696f 6e0a  the z-direction.
+0000a160: 2020 2020 2020 2020 3a74 7970 6520 7a5f          :type z_
+0000a170: 626f 756e 6473 3a20 7475 706c 6528 696e  bounds: tuple(in
+0000a180: 742c 2069 6e74 292c 206c 6973 745b 696e  t, int), list[in
+0000a190: 745d 2c20 6f70 7469 6f6e 616c 0a20 2020  t], optional.   
+0000a1a0: 2020 2020 203a 7061 7261 6d20 7365 636f       :param seco
+0000a1b0: 6e64 6172 795f 6974 6572 733a 204e 756d  ndary_iters: Num
+0000a1c0: 6265 7220 6f66 2073 6563 6f6e 6461 7279  ber of secondary
+0000a1d0: 2069 7465 7261 7469 6f6e 7320 696e 2074   iterations in t
+0000a1e0: 6865 0a20 2020 2020 2020 2020 2020 2074  he.            t
+0000a1f0: 6f6d 6f70 7920 696d 6167 6520 7265 636f  omopy image reco
+0000a200: 6e73 7472 7563 7469 6f6e 2061 6c67 6f72  nstruction algor
+0000a210: 6974 686d 2c20 6465 6661 756c 7473 2074  ithm, defaults t
+0000a220: 6f20 302e 0a20 2020 2020 2020 203a 7479  o 0..        :ty
+0000a230: 7065 2073 6563 6f6e 6461 7279 5f69 7465  pe secondary_ite
+0000a240: 7273 3a20 696e 742c 206f 7074 696f 6e61  rs: int, optiona
+0000a250: 6c0a 2020 2020 2020 2020 3a70 6172 616d  l.        :param
+0000a260: 2072 656d 6f76 655f 7374 7269 7065 5f73   remove_stripe_s
+0000a270: 6967 6d61 3a20 4461 6d70 696e 6720 7061  igma: Damping pa
+0000a280: 7261 6d65 7465 7220 696e 2046 6f75 7269  rameter in Fouri
+0000a290: 6572 2073 7061 6365 0a20 2020 2020 2020  er space.       
+0000a2a0: 2020 2020 2069 6e20 746f 6d6f 7079 2773       in tomopy's
+0000a2b0: 2068 6f72 697a 6f6e 7461 6c20 7374 7269   horizontal stri
+0000a2c0: 7065 2072 656d 6f76 616c 2074 6f6f 6c2c  pe removal tool,
+0000a2d0: 2064 6566 6175 6c74 7320 746f 206e 6f0a   defaults to no.
+0000a2e0: 2020 2020 2020 2020 2020 2020 636f 7272              corr
+0000a2f0: 6563 7469 6f6e 2070 6572 666f 726d 6564  ection performed
+0000a300: 2e0a 2020 2020 2020 2020 3a74 7970 6520  ..        :type 
+0000a310: 7265 6d6f 7665 5f73 7472 6970 655f 7369  remove_stripe_si
+0000a320: 676d 613a 2066 6c6f 6174 2c20 6f70 7469  gma: float, opti
+0000a330: 6f6e 616c 0a20 2020 2020 2020 203a 7061  onal.        :pa
+0000a340: 7261 6d20 7269 6e67 5f77 6964 7468 3a20  ram ring_width: 
+0000a350: 4d61 7869 6d75 6d20 7769 6474 6820 6f66  Maximum width of
+0000a360: 2072 696e 6773 2074 6f20 6265 2066 696c   rings to be fil
+0000a370: 7465 7265 6420 696e 2074 6865 0a20 2020  tered in the.   
+0000a380: 2020 2020 2020 2020 2069 6d61 6765 2072           image r
+0000a390: 6563 6f6e 7374 7275 6374 696f 6e20 696e  econstruction in
+0000a3a0: 2070 6978 656c 732c 2064 6566 6175 6c74   pixels, default
+0000a3b0: 7320 746f 206e 6f20 6669 6c74 6572 696e  s to no filterin
+0000a3c0: 670a 2020 2020 2020 2020 2020 2020 7065  g.            pe
+0000a3d0: 7266 6f72 6d65 642e 0a20 2020 2020 2020  rformed..       
+0000a3e0: 203a 7479 7065 2072 696e 675f 7769 6474   :type ring_widt
+0000a3f0: 683a 2066 6c6f 6174 2c20 6f70 7469 6f6e  h: float, option
+0000a400: 616c 0a20 2020 2020 2020 203a 7265 7475  al.        :retu
+0000a410: 726e 3a20 5265 636f 6e73 7472 7563 7465  rn: Reconstructe
+0000a420: 6420 746f 6d6f 6772 6170 6879 2064 6174  d tomography dat
+0000a430: 610a 2020 2020 2020 2020 3a72 7479 7065  a.        :rtype
+0000a440: 3a20 6e65 7875 7366 6f72 6d61 742e 6e65  : nexusformat.ne
+0000a450: 7875 732e 4e58 726f 6f74 0a20 2020 2020  xus.NXroot.     
+0000a460: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
+0000a470: 2054 6869 7264 2070 6172 7479 206d 6f64   Third party mod
+0000a480: 756c 6573 0a20 2020 2020 2020 2066 726f  ules.        fro
+0000a490: 6d20 6e65 7875 7366 6f72 6d61 742e 6e65  m nexusformat.ne
+0000a4a0: 7875 7320 696d 706f 7274 2028 0a20 2020  xus import (.   
+0000a4b0: 2020 2020 2020 2020 204e 5864 6174 612c           NXdata,
+0000a4c0: 0a20 2020 2020 2020 2020 2020 204e 5865  .            NXe
+0000a4d0: 6e74 7279 2c0a 2020 2020 2020 2020 2020  ntry,.          
+0000a4e0: 2020 4e58 7072 6f63 6573 732c 0a20 2020    NXprocess,.   
+0000a4f0: 2020 2020 2020 2020 204e 5872 6f6f 742c           NXroot,
+0000a500: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000a510: 2020 2020 2320 4c6f 6361 6c20 6d6f 6475      # Local modu
+0000a520: 6c65 730a 2020 2020 2020 2020 6672 6f6d  les.        from
+0000a530: 2043 4841 502e 7574 696c 732e 6765 6e65   CHAP.utils.gene
+0000a540: 7261 6c20 696d 706f 7274 2069 735f 696e  ral import is_in
+0000a550: 745f 7061 6972 0a0a 2020 2020 2020 2020  t_pair..        
+0000a560: 7365 6c66 2e5f 6c6f 6767 6572 2e69 6e66  self._logger.inf
+0000a570: 6f28 2752 6563 6f6e 7374 7275 6374 2074  o('Reconstruct t
+0000a580: 6865 2074 6f6d 6f67 7261 7068 7920 6461  he tomography da
+0000a590: 7461 2729 0a0a 2020 2020 2020 2020 6966  ta')..        if
+0000a5a0: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+0000a5b0: 6e78 726f 6f74 2c20 4e58 726f 6f74 293a  nxroot, NXroot):
+0000a5c0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000a5d0: 7365 2056 616c 7565 4572 726f 7228 6627  se ValueError(f'
+0000a5e0: 496e 7661 6c69 6420 7061 7261 6d65 7465  Invalid paramete
+0000a5f0: 7220 6e78 726f 6f74 2028 7b6e 7872 6f6f  r nxroot ({nxroo
+0000a600: 747d 2927 290a 2020 2020 2020 2020 6e78  t})').        nx
+0000a610: 656e 7472 7920 3d20 6e78 726f 6f74 5b6e  entry = nxroot[n
+0000a620: 7872 6f6f 742e 6174 7472 735b 2764 6566  xroot.attrs['def
+0000a630: 6175 6c74 275d 5d0a 2020 2020 2020 2020  ault']].        
+0000a640: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
+0000a650: 6528 6e78 656e 7472 792c 204e 5865 6e74  e(nxentry, NXent
+0000a660: 7279 293a 0a20 2020 2020 2020 2020 2020  ry):.           
+0000a670: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+0000a680: 7228 6627 496e 7661 6c69 6420 6e78 656e  r(f'Invalid nxen
+0000a690: 7472 7920 287b 6e78 656e 7472 797d 2927  try ({nxentry})'
+0000a6a0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+0000a6b0: 2069 7369 6e73 7461 6e63 6528 6365 6e74   isinstance(cent
+0000a6c0: 6572 5f69 6e66 6f2c 2064 6963 7429 3a0a  er_info, dict):.
+0000a6d0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000a6e0: 6520 5661 6c75 6545 7272 6f72 2866 2749  e ValueError(f'I
+0000a6f0: 6e76 616c 6964 2070 6172 616d 6574 6572  nvalid parameter
+0000a700: 2063 656e 7465 725f 696e 666f 2028 7b63   center_info ({c
+0000a710: 656e 7465 725f 696e 666f 7d29 2729 0a20  enter_info})'). 
+0000a720: 2020 2020 2020 2069 6620 785f 626f 756e         if x_boun
+0000a730: 6473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ds is not None:.
+0000a740: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0000a750: 6f74 2069 7369 6e73 7461 6e63 6528 785f  ot isinstance(x_
+0000a760: 626f 756e 6473 2c20 2874 7570 6c65 2c20  bounds, (tuple, 
+0000a770: 6c69 7374 2929 3a0a 2020 2020 2020 2020  list)):.        
+0000a780: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+0000a790: 6c75 6545 7272 6f72 2866 2749 6e76 616c  lueError(f'Inval
+0000a7a0: 6964 2070 6172 616d 6574 6572 2078 5f62  id parameter x_b
+0000a7b0: 6f75 6e64 7320 287b 785f 626f 756e 6473  ounds ({x_bounds
+0000a7c0: 7d29 2729 0a20 2020 2020 2020 2020 2020  })').           
+0000a7d0: 2078 5f62 6f75 6e64 7320 3d20 7475 706c   x_bounds = tupl
+0000a7e0: 6528 785f 626f 756e 6473 290a 2020 2020  e(x_bounds).    
+0000a7f0: 2020 2020 6966 2079 5f62 6f75 6e64 7320      if y_bounds 
+0000a800: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0000a810: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0000a820: 6973 696e 7374 616e 6365 2879 5f62 6f75  isinstance(y_bou
+0000a830: 6e64 732c 2028 7475 706c 652c 206c 6973  nds, (tuple, lis
+0000a840: 7429 293a 0a20 2020 2020 2020 2020 2020  t)):.           
+0000a850: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+0000a860: 4572 726f 7228 6627 496e 7661 6c69 6420  Error(f'Invalid 
+0000a870: 7061 7261 6d65 7465 7220 795f 626f 756e  parameter y_boun
+0000a880: 6473 2028 7b79 5f62 6f75 6e64 737d 2927  ds ({y_bounds})'
+0000a890: 290a 2020 2020 2020 2020 2020 2020 795f  ).            y_
+0000a8a0: 626f 756e 6473 203d 2074 7570 6c65 2879  bounds = tuple(y
+0000a8b0: 5f62 6f75 6e64 7329 0a20 2020 2020 2020  _bounds).       
+0000a8c0: 2069 6620 7a5f 626f 756e 6473 2069 7320   if z_bounds is 
+0000a8d0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0000a8e0: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
+0000a8f0: 6e73 7461 6e63 6528 7a5f 626f 756e 6473  nstance(z_bounds
+0000a900: 2c20 2874 7570 6c65 2c20 6c69 7374 2929  , (tuple, list))
+0000a910: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a920: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+0000a930: 6f72 2866 2749 6e76 616c 6964 2070 6172  or(f'Invalid par
+0000a940: 616d 6574 6572 207a 5f62 6f75 6e64 7320  ameter z_bounds 
+0000a950: 287b 7a5f 626f 756e 6473 7d29 2729 0a20  ({z_bounds})'). 
+0000a960: 2020 2020 2020 2020 2020 207a 5f62 6f75             z_bou
+0000a970: 6e64 7320 3d20 7475 706c 6528 7a5f 626f  nds = tuple(z_bo
+0000a980: 756e 6473 290a 0a20 2020 2020 2020 2023  unds)..        #
+0000a990: 2043 6865 636b 2069 6620 7265 6475 6365   Check if reduce
+0000a9a0: 6420 6461 7461 2069 7320 6176 6169 6c61  d data is availa
+0000a9b0: 626c 650a 2020 2020 2020 2020 6966 2028  ble.        if (
+0000a9c0: 2772 6564 7563 6564 5f64 6174 6127 206e  'reduced_data' n
+0000a9d0: 6f74 2069 6e20 6e78 656e 7472 790a 2020  ot in nxentry.  
+0000a9e0: 2020 2020 2020 2020 2020 2020 2020 6f72                or
+0000a9f0: 2027 7265 6475 6365 645f 6461 7461 2720   'reduced_data' 
+0000aa00: 6e6f 7420 696e 206e 7865 6e74 7279 2e64  not in nxentry.d
+0000aa10: 6174 6129 3a0a 2020 2020 2020 2020 2020  ata):.          
+0000aa20: 2020 7261 6973 6520 4b65 7945 7272 6f72    raise KeyError
+0000aa30: 2866 2755 6e61 626c 6520 746f 2066 696e  (f'Unable to fin
+0000aa40: 6420 7661 6c69 6420 7265 6475 6365 6420  d valid reduced 
+0000aa50: 6461 7461 2069 6e20 7b6e 7865 6e74 7279  data in {nxentry
+0000aa60: 7d2e 2729 0a0a 2020 2020 2020 2020 2320  }.')..        # 
+0000aa70: 4372 6561 7465 2061 6e20 4e58 7072 6f63  Create an NXproc
+0000aa80: 6573 7320 746f 2073 746f 7265 2069 6d61  ess to store ima
+0000aa90: 6765 2072 6563 6f6e 7374 7275 6374 696f  ge reconstructio
+0000aaa0: 6e20 286d 6574 6129 6461 7461 0a20 2020  n (meta)data.   
+0000aab0: 2020 2020 206e 7870 726f 6365 7373 203d       nxprocess =
+0000aac0: 204e 5870 726f 6365 7373 2829 0a0a 2020   NXprocess()..  
+0000aad0: 2020 2020 2020 2320 4765 7420 726f 7461        # Get rota
+0000aae0: 7469 6f6e 2061 7869 7320 726f 7773 2061  tion axis rows a
+0000aaf0: 6e64 2063 656e 7465 7273 0a20 2020 2020  nd centers.     
+0000ab00: 2020 206c 6f77 6572 5f72 6f77 203d 2063     lower_row = c
+0000ab10: 656e 7465 725f 696e 666f 2e67 6574 2827  enter_info.get('
+0000ab20: 6c6f 7765 725f 726f 7727 290a 2020 2020  lower_row').    
+0000ab30: 2020 2020 6c6f 7765 725f 6365 6e74 6572      lower_center
+0000ab40: 5f6f 6666 7365 7420 3d20 6365 6e74 6572  _offset = center
+0000ab50: 5f69 6e66 6f2e 6765 7428 276c 6f77 6572  _info.get('lower
+0000ab60: 5f63 656e 7465 725f 6f66 6673 6574 2729  _center_offset')
+0000ab70: 0a20 2020 2020 2020 2075 7070 6572 5f72  .        upper_r
+0000ab80: 6f77 203d 2063 656e 7465 725f 696e 666f  ow = center_info
+0000ab90: 2e67 6574 2827 7570 7065 725f 726f 7727  .get('upper_row'
+0000aba0: 290a 2020 2020 2020 2020 7570 7065 725f  ).        upper_
+0000abb0: 6365 6e74 6572 5f6f 6666 7365 7420 3d20  center_offset = 
+0000abc0: 6365 6e74 6572 5f69 6e66 6f2e 6765 7428  center_info.get(
+0000abd0: 2775 7070 6572 5f63 656e 7465 725f 6f66  'upper_center_of
+0000abe0: 6673 6574 2729 0a20 2020 2020 2020 2069  fset').        i
+0000abf0: 6620 286c 6f77 6572 5f72 6f77 2069 7320  f (lower_row is 
+0000ac00: 4e6f 6e65 206f 7220 6c6f 7765 725f 6365  None or lower_ce
+0000ac10: 6e74 6572 5f6f 6666 7365 7420 6973 204e  nter_offset is N
+0000ac20: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0000ac30: 2020 2020 6f72 2075 7070 6572 5f72 6f77      or upper_row
+0000ac40: 2069 7320 4e6f 6e65 206f 7220 7570 7065   is None or uppe
+0000ac50: 725f 6365 6e74 6572 5f6f 6666 7365 7420  r_center_offset 
+0000ac60: 6973 204e 6f6e 6529 3a0a 2020 2020 2020  is None):.      
+0000ac70: 2020 2020 2020 7261 6973 6520 4b65 7945        raise KeyE
+0000ac80: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0000ac90: 2020 2020 2020 2755 6e61 626c 6520 746f        'Unable to
+0000aca0: 2066 696e 6420 7661 6c69 6420 6361 6c69   find valid cali
+0000acb0: 6272 6174 6564 2063 656e 7465 7220 6178  brated center ax
+0000acc0: 6973 2069 6e66 6f20 696e 2027 0a20 2020  is info in '.   
+0000acd0: 2020 2020 2020 2020 2020 2020 202b 2066               + f
+0000ace0: 277b 6365 6e74 6572 5f69 6e66 6f7d 2e27  '{center_info}.'
+0000acf0: 290a 2020 2020 2020 2020 6365 6e74 6572  ).        center
+0000ad00: 5f73 6c6f 7065 203d 2028 7570 7065 725f  _slope = (upper_
+0000ad10: 6365 6e74 6572 5f6f 6666 7365 742d 6c6f  center_offset-lo
+0000ad20: 7765 725f 6365 6e74 6572 5f6f 6666 7365  wer_center_offse
+0000ad30: 7429 205c 0a20 2020 2020 2020 2020 2020  t) \.           
+0000ad40: 202f 2028 7570 7065 725f 726f 772d 6c6f   / (upper_row-lo
+0000ad50: 7765 725f 726f 7729 0a0a 2020 2020 2020  wer_row)..      
+0000ad60: 2020 2320 4765 7420 7468 6574 6173 2028    # Get thetas (
+0000ad70: 696e 2064 6567 7265 6573 290a 2020 2020  in degrees).    
+0000ad80: 2020 2020 7468 6574 6173 203d 206e 702e      thetas = np.
+0000ad90: 6173 6172 7261 7928 6e78 656e 7472 792e  asarray(nxentry.
+0000ada0: 7265 6475 6365 645f 6461 7461 2e72 6f74  reduced_data.rot
+0000adb0: 6174 696f 6e5f 616e 676c 6529 0a0a 2020  ation_angle)..  
+0000adc0: 2020 2020 2020 2320 5265 636f 6e73 7472        # Reconstr
+0000add0: 7563 7420 746f 6d6f 6772 6170 6879 2064  uct tomography d
+0000ade0: 6174 610a 2020 2020 2020 2020 2320 2020  ata.        #   
+0000adf0: 2020 7265 6475 6365 6420 6461 7461 2061    reduced data a
+0000ae00: 7865 7320 6f72 6465 723a 2073 7461 636b  xes order: stack
+0000ae10: 2c74 6865 7461 2c72 6f77 2c63 6f6c 756d  ,theta,row,colum
+0000ae20: 6e0a 2020 2020 2020 2020 2320 2020 2020  n.        #     
+0000ae30: 7265 636f 6e73 7472 7563 7465 6420 6461  reconstructed da
+0000ae40: 7461 206f 7264 6572 2069 6e20 6561 6368  ta order in each
+0000ae50: 2073 7461 636b 3a20 726f 772f 7a2c 782c   stack: row/z,x,
+0000ae60: 790a 2020 2020 2020 2020 2320 4e6f 7465  y.        # Note
+0000ae70: 3a20 4e65 7875 7320 6361 6e27 7420 666f  : Nexus can't fo
+0000ae80: 6c6c 6f77 2061 206c 696e 6b20 6966 2074  llow a link if t
+0000ae90: 6865 2064 6174 6120 6974 2070 6f69 6e74  he data it point
+0000aea0: 7320 746f 2069 730a 2020 2020 2020 2020  s to is.        
+0000aeb0: 2320 2020 2020 746f 6f20 6269 6720 6765  #     too big ge
+0000aec0: 7420 7468 6520 6461 7461 2066 726f 6d20  t the data from 
+0000aed0: 7468 6520 6163 7475 616c 2070 6c61 6365  the actual place
+0000aee0: 2c20 6e6f 7420 6672 6f6d 0a20 2020 2020  , not from.     
+0000aef0: 2020 2023 2020 2020 206e 7865 6e74 7279     #     nxentry
+0000af00: 2e64 6174 610a 2020 2020 2020 2020 6966  .data.        if
+0000af10: 2027 7a6f 6f6d 5f70 6572 6327 2069 6e20   'zoom_perc' in 
+0000af20: 6e78 656e 7472 792e 7265 6475 6365 645f  nxentry.reduced_
+0000af30: 6461 7461 3a0a 2020 2020 2020 2020 2020  data:.          
+0000af40: 2020 7265 735f 7469 746c 6520 3d20 6627    res_title = f'
+0000af50: 7b6e 7865 6e74 7279 2e72 6564 7563 6564  {nxentry.reduced
+0000af60: 5f64 6174 612e 6174 7472 735b 227a 6f6f  _data.attrs["zoo
+0000af70: 6d5f 7065 7263 225d 7d70 270a 2020 2020  m_perc"]}p'.    
+0000af80: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000af90: 2020 2020 2020 7265 735f 7469 746c 6520        res_title 
+0000afa0: 3d20 2766 756c 6c72 6573 270a 2020 2020  = 'fullres'.    
+0000afb0: 2020 2020 6e75 6d5f 746f 6d6f 5f73 7461      num_tomo_sta
+0000afc0: 636b 7320 3d20 6e78 656e 7472 792e 7265  cks = nxentry.re
+0000afd0: 6475 6365 645f 6461 7461 2e64 6174 612e  duced_data.data.
+0000afe0: 746f 6d6f 5f66 6965 6c64 732e 7368 6170  tomo_fields.shap
+0000aff0: 655b 305d 0a20 2020 2020 2020 2074 6f6d  e[0].        tom
+0000b000: 6f5f 7265 636f 6e5f 7374 6163 6b73 203d  o_recon_stacks =
+0000b010: 206e 756d 5f74 6f6d 6f5f 7374 6163 6b73   num_tomo_stacks
+0000b020: 2a5b 6e70 2e61 7272 6179 285b 5d29 5d0a  *[np.array([])].
+0000b030: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
+0000b040: 2072 616e 6765 286e 756d 5f74 6f6d 6f5f   range(num_tomo_
+0000b050: 7374 6163 6b73 293a 0a20 2020 2020 2020  stacks):.       
+0000b060: 2020 2020 2023 2043 6f6e 7665 7274 2072       # Convert r
+0000b070: 6564 7563 6564 2064 6174 6120 7374 6163  educed data stac
+0000b080: 6b20 6672 6f6d 2074 6865 7461 2c72 6f77  k from theta,row
+0000b090: 2c63 6f6c 756d 6e20 746f 0a20 2020 2020  ,column to.     
+0000b0a0: 2020 2020 2020 2023 2020 2020 2072 6f77         #     row
+0000b0b0: 2c74 6865 7461 2c63 6f6c 756d 6e0a 2020  ,theta,column.  
+0000b0c0: 2020 2020 2020 2020 2020 7430 203d 2074            t0 = t
+0000b0d0: 696d 6528 290a 2020 2020 2020 2020 2020  ime().          
+0000b0e0: 2020 746f 6d6f 5f73 7461 636b 203d 206e    tomo_stack = n
+0000b0f0: 702e 6173 6172 7261 7928 6e78 656e 7472  p.asarray(nxentr
+0000b100: 792e 7265 6475 6365 645f 6461 7461 2e64  y.reduced_data.d
+0000b110: 6174 612e 746f 6d6f 5f66 6965 6c64 735b  ata.tomo_fields[
+0000b120: 695d 290a 2020 2020 2020 2020 2020 2020  i]).            
+0000b130: 7365 6c66 2e5f 6c6f 6767 6572 2e69 6e66  self._logger.inf
+0000b140: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
+0000b150: 2020 2066 2752 6561 6469 6e67 2072 6564     f'Reading red
+0000b160: 7563 6564 2064 6174 6120 7374 6163 6b20  uced data stack 
+0000b170: 7b69 7d20 746f 6f6b 207b 7469 6d65 2829  {i} took {time()
+0000b180: 2d74 303a 2e32 667d 2027 0a20 2020 2020  -t0:.2f} '.     
+0000b190: 2020 2020 2020 2020 2020 202b 2027 7365             + 'se
+0000b1a0: 636f 6e64 7327 290a 2020 2020 2020 2020  conds').        
+0000b1b0: 2020 2020 6966 2028 6c65 6e28 746f 6d6f      if (len(tomo
+0000b1c0: 5f73 7461 636b 2e73 6861 7065 2920 213d  _stack.shape) !=
+0000b1d0: 2033 0a20 2020 2020 2020 2020 2020 2020   3.             
+0000b1e0: 2020 2020 2020 206f 7220 616e 7928 5472         or any(Tr
+0000b1f0: 7565 2066 6f72 2064 696d 2069 6e20 746f  ue for dim in to
+0000b200: 6d6f 5f73 7461 636b 2e73 6861 7065 2069  mo_stack.shape i
+0000b210: 6620 6e6f 7420 6469 6d29 293a 0a20 2020  f not dim)):.   
+0000b220: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0000b230: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
+0000b240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b250: 2020 2020 2066 2755 6e61 626c 6520 746f       f'Unable to
+0000b260: 206c 6f61 6420 746f 6d6f 6772 6170 6879   load tomography
+0000b270: 2073 7461 636b 207b 697d 2066 6f72 2027   stack {i} for '
+0000b280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b290: 2020 2020 202b 2027 7265 636f 6e73 7472       + 'reconstr
+0000b2a0: 7563 7469 6f6e 2729 0a20 2020 2020 2020  uction').       
+0000b2b0: 2020 2020 2074 6f6d 6f5f 7374 6163 6b20       tomo_stack 
+0000b2c0: 3d20 6e70 2e73 7761 7061 7865 7328 746f  = np.swapaxes(to
+0000b2d0: 6d6f 5f73 7461 636b 2c20 302c 2031 290a  mo_stack, 0, 1).
+0000b2e0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0000b2f0: 7274 206c 656e 2874 6865 7461 7329 203d  rt len(thetas) =
+0000b300: 3d20 746f 6d6f 5f73 7461 636b 2e73 6861  = tomo_stack.sha
+0000b310: 7065 5b31 5d0a 2020 2020 2020 2020 2020  pe[1].          
+0000b320: 2020 6173 7365 7274 2030 203c 3d20 6c6f    assert 0 <= lo
+0000b330: 7765 725f 726f 7720 3c20 7570 7065 725f  wer_row < upper_
+0000b340: 726f 7720 3c20 746f 6d6f 5f73 7461 636b  row < tomo_stack
+0000b350: 2e73 6861 7065 5b30 5d0a 2020 2020 2020  .shape[0].      
+0000b360: 2020 2020 2020 6365 6e74 6572 5f6f 6666        center_off
+0000b370: 7365 7473 203d 205b 0a20 2020 2020 2020  sets = [.       
+0000b380: 2020 2020 2020 2020 206c 6f77 6572 5f63           lower_c
+0000b390: 656e 7465 725f 6f66 6673 6574 2d6c 6f77  enter_offset-low
+0000b3a0: 6572 5f72 6f77 2a63 656e 7465 725f 736c  er_row*center_sl
+0000b3b0: 6f70 652c 0a20 2020 2020 2020 2020 2020  ope,.           
+0000b3c0: 2020 2020 2075 7070 6572 5f63 656e 7465       upper_cente
+0000b3d0: 725f 6f66 6673 6574 202b 2063 656e 7465  r_offset + cente
+0000b3e0: 725f 736c 6f70 6520 2a20 280a 2020 2020  r_slope * (.    
+0000b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b400: 746f 6d6f 5f73 7461 636b 2e73 6861 7065  tomo_stack.shape
+0000b410: 5b30 5d2d 312d 7570 7065 725f 726f 7729  [0]-1-upper_row)
+0000b420: 2c0a 2020 2020 2020 2020 2020 2020 5d0a  ,.            ].
+0000b430: 2020 2020 2020 2020 2020 2020 7430 203d              t0 =
+0000b440: 2074 696d 6528 290a 2020 2020 2020 2020   time().        
+0000b450: 2020 2020 746f 6d6f 5f72 6563 6f6e 5f73      tomo_recon_s
+0000b460: 7461 636b 203d 2073 656c 662e 5f72 6563  tack = self._rec
+0000b470: 6f6e 7374 7275 6374 5f6f 6e65 5f74 6f6d  onstruct_one_tom
+0000b480: 6f5f 7374 6163 6b28 0a20 2020 2020 2020  o_stack(.       
+0000b490: 2020 2020 2020 2020 2074 6f6d 6f5f 7374           tomo_st
+0000b4a0: 6163 6b2c 2074 6865 7461 732c 2063 656e  ack, thetas, cen
+0000b4b0: 7465 725f 6f66 6673 6574 733d 6365 6e74  ter_offsets=cent
+0000b4c0: 6572 5f6f 6666 7365 7473 2c0a 2020 2020  er_offsets,.    
+0000b4d0: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
+0000b4e0: 636f 7265 3d73 656c 662e 5f6e 756d 5f63  core=self._num_c
+0000b4f0: 6f72 652c 2061 6c67 6f72 6974 686d 3d27  ore, algorithm='
+0000b500: 6772 6964 7265 6327 2c0a 2020 2020 2020  gridrec',.      
+0000b510: 2020 2020 2020 2020 2020 7365 636f 6e64            second
+0000b520: 6172 795f 6974 6572 733d 7365 636f 6e64  ary_iters=second
+0000b530: 6172 795f 6974 6572 732c 0a20 2020 2020  ary_iters,.     
+0000b540: 2020 2020 2020 2020 2020 2072 656d 6f76             remov
+0000b550: 655f 7374 7269 7065 5f73 6967 6d61 3d72  e_stripe_sigma=r
+0000b560: 656d 6f76 655f 7374 7269 7065 5f73 6967  emove_stripe_sig
+0000b570: 6d61 2c20 7269 6e67 5f77 6964 7468 3d72  ma, ring_width=r
+0000b580: 696e 675f 7769 6474 6829 0a20 2020 2020  ing_width).     
+0000b590: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
+0000b5a0: 6765 722e 696e 666f 280a 2020 2020 2020  ger.info(.      
+0000b5b0: 2020 2020 2020 2020 2020 6627 5265 636f            f'Reco
+0000b5c0: 6e73 7472 7563 7469 6f6e 206f 6620 7374  nstruction of st
+0000b5d0: 6163 6b20 7b69 7d20 746f 6f6b 207b 7469  ack {i} took {ti
+0000b5e0: 6d65 2829 2d74 303a 2e32 667d 2073 6563  me()-t0:.2f} sec
+0000b5f0: 6f6e 6473 2729 0a0a 2020 2020 2020 2020  onds')..        
+0000b600: 2020 2020 2320 436f 6d62 696e 6520 7374      # Combine st
+0000b610: 6163 6b73 0a20 2020 2020 2020 2020 2020  acks.           
+0000b620: 2074 6f6d 6f5f 7265 636f 6e5f 7374 6163   tomo_recon_stac
+0000b630: 6b73 5b69 5d20 3d20 746f 6d6f 5f72 6563  ks[i] = tomo_rec
+0000b640: 6f6e 5f73 7461 636b 0a0a 2020 2020 2020  on_stack..      
+0000b650: 2020 2320 5265 7369 7a65 2074 6865 2072    # Resize the r
+0000b660: 6563 6f6e 7374 7275 6374 6564 2074 6f6d  econstructed tom
+0000b670: 6f67 7261 7068 7920 6461 7461 0a20 2020  ography data.   
+0000b680: 2020 2020 2023 2020 2020 2072 6563 6f6e       #     recon
+0000b690: 7374 7275 6374 6564 2064 6174 6120 6f72  structed data or
+0000b6a0: 6465 7220 696e 2065 6163 6820 7374 6163  der in each stac
+0000b6b0: 6b3a 2072 6f77 2f7a 2c78 2c79 0a20 2020  k: row/z,x,y.   
+0000b6c0: 2020 2020 2069 6620 7365 6c66 2e5f 7465       if self._te
+0000b6d0: 7374 5f6d 6f64 653a 0a20 2020 2020 2020  st_mode:.       
+0000b6e0: 2020 2020 2078 5f62 6f75 6e64 7320 3d20       x_bounds = 
+0000b6f0: 7475 706c 6528 7365 6c66 2e5f 7465 7374  tuple(self._test
+0000b700: 5f63 6f6e 6669 672e 6765 7428 2778 5f62  _config.get('x_b
+0000b710: 6f75 6e64 7327 2929 0a20 2020 2020 2020  ounds')).       
+0000b720: 2020 2020 2079 5f62 6f75 6e64 7320 3d20       y_bounds = 
+0000b730: 7475 706c 6528 7365 6c66 2e5f 7465 7374  tuple(self._test
+0000b740: 5f63 6f6e 6669 672e 6765 7428 2779 5f62  _config.get('y_b
+0000b750: 6f75 6e64 7327 2929 0a20 2020 2020 2020  ounds')).       
+0000b760: 2020 2020 207a 5f62 6f75 6e64 7320 3d20       z_bounds = 
+0000b770: 4e6f 6e65 0a20 2020 2020 2020 2065 6c69  None.        eli
+0000b780: 6620 7365 6c66 2e5f 696e 7465 7261 6374  f self._interact
+0000b790: 6976 653a 0a20 2020 2020 2020 2020 2020  ive:.           
+0000b7a0: 2078 5f62 6f75 6e64 732c 2079 5f62 6f75   x_bounds, y_bou
+0000b7b0: 6e64 732c 207a 5f62 6f75 6e64 7320 3d20  nds, z_bounds = 
+0000b7c0: 7365 6c66 2e5f 7265 7369 7a65 5f72 6563  self._resize_rec
+0000b7d0: 6f6e 7374 7275 6374 6564 5f64 6174 6128  onstructed_data(
+0000b7e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b7f0: 2074 6f6d 6f5f 7265 636f 6e5f 7374 6163   tomo_recon_stac
+0000b800: 6b73 2c20 785f 626f 756e 6473 3d78 5f62  ks, x_bounds=x_b
+0000b810: 6f75 6e64 732c 2079 5f62 6f75 6e64 733d  ounds, y_bounds=
+0000b820: 795f 626f 756e 6473 2c0a 2020 2020 2020  y_bounds,.      
+0000b830: 2020 2020 2020 2020 2020 7a5f 626f 756e            z_boun
+0000b840: 6473 3d7a 5f62 6f75 6e64 7329 0a20 2020  ds=z_bounds).   
+0000b850: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000b860: 2020 2020 2020 2069 6620 785f 626f 756e         if x_boun
+0000b870: 6473 2069 7320 4e6f 6e65 3a0a 2020 2020  ds is None:.    
+0000b880: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000b890: 2e5f 6c6f 6767 6572 2e77 6172 6e69 6e67  ._logger.warning
+0000b8a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000b8b0: 2020 2020 2020 2778 5f62 6f75 6e64 7320        'x_bounds 
+0000b8c0: 756e 7370 6563 6966 6965 642c 2072 6563  unspecified, rec
+0000b8d0: 6f6e 7374 7275 6374 2064 6174 6120 666f  onstruct data fo
+0000b8e0: 7220 6675 6c6c 2078 2d72 616e 6765 2729  r full x-range')
+0000b8f0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+0000b900: 6620 6e6f 7420 6973 5f69 6e74 5f70 6169  f not is_int_pai
+0000b910: 7228 785f 626f 756e 6473 2c20 6765 3d30  r(x_bounds, ge=0
+0000b920: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000b930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b940: 2020 206c 743d 746f 6d6f 5f72 6563 6f6e     lt=tomo_recon
+0000b950: 5f73 7461 636b 735b 305d 2e73 6861 7065  _stacks[0].shape
+0000b960: 5b31 5d29 3a0a 2020 2020 2020 2020 2020  [1]):.          
+0000b970: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+0000b980: 6545 7272 6f72 2866 2749 6e76 616c 6964  eError(f'Invalid
+0000b990: 2070 6172 616d 6574 6572 2078 5f62 6f75   parameter x_bou
+0000b9a0: 6e64 7320 287b 785f 626f 756e 6473 7d29  nds ({x_bounds})
+0000b9b0: 2729 0a20 2020 2020 2020 2020 2020 2069  ').            i
+0000b9c0: 6620 795f 626f 756e 6473 2069 7320 4e6f  f y_bounds is No
+0000b9d0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000b9e0: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+0000b9f0: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
+0000ba00: 2020 2020 2020 2020 2020 2020 2020 2779                'y
+0000ba10: 5f62 6f75 6e64 7320 756e 7370 6563 6966  _bounds unspecif
+0000ba20: 6965 642c 2072 6563 6f6e 7374 7275 6374  ied, reconstruct
+0000ba30: 2064 6174 6120 666f 7220 6675 6c6c 2079   data for full y
+0000ba40: 2d72 616e 6765 2729 0a20 2020 2020 2020  -range').       
+0000ba50: 2020 2020 2065 6c69 6620 6e6f 7420 6973       elif not is
+0000ba60: 5f69 6e74 5f70 6169 7228 0a20 2020 2020  _int_pair(.     
+0000ba70: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+0000ba80: 5f62 6f75 6e64 732c 2067 653d 302c 206c  _bounds, ge=0, l
+0000ba90: 743d 746f 6d6f 5f72 6563 6f6e 5f73 7461  t=tomo_recon_sta
+0000baa0: 636b 735b 305d 2e73 6861 7065 5b32 5d29  cks[0].shape[2])
+0000bab0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000bac0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+0000bad0: 6f72 2866 2749 6e76 616c 6964 2070 6172  or(f'Invalid par
+0000bae0: 616d 6574 6572 2079 5f62 6f75 6e64 7320  ameter y_bounds 
+0000baf0: 287b 795f 626f 756e 6473 7d29 2729 0a20  ({y_bounds})'). 
+0000bb00: 2020 2020 2020 2020 2020 207a 5f62 6f75             z_bou
+0000bb10: 6e64 7320 3d20 4e6f 6e65 0a20 2020 2020  nds = None.     
+0000bb20: 2020 2069 6620 785f 626f 756e 6473 2069     if x_bounds i
+0000bb30: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000bb40: 2020 2020 785f 7261 6e67 6520 3d20 2830      x_range = (0
+0000bb50: 2c20 746f 6d6f 5f72 6563 6f6e 5f73 7461  , tomo_recon_sta
+0000bb60: 636b 735b 305d 2e73 6861 7065 5b31 5d29  cks[0].shape[1])
+0000bb70: 0a20 2020 2020 2020 2020 2020 2078 5f73  .            x_s
+0000bb80: 6c69 6365 203d 2069 6e74 2878 5f72 616e  lice = int(x_ran
+0000bb90: 6765 5b31 5d2f 3229 0a20 2020 2020 2020  ge[1]/2).       
+0000bba0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000bbb0: 2020 2078 5f72 616e 6765 203d 2028 6d69     x_range = (mi
+0000bbc0: 6e28 785f 626f 756e 6473 292c 206d 6178  n(x_bounds), max
+0000bbd0: 2878 5f62 6f75 6e64 7329 290a 2020 2020  (x_bounds)).    
+0000bbe0: 2020 2020 2020 2020 785f 736c 6963 6520          x_slice 
+0000bbf0: 3d20 696e 7428 2878 5f62 6f75 6e64 735b  = int((x_bounds[
+0000bc00: 305d 2b78 5f62 6f75 6e64 735b 315d 2920  0]+x_bounds[1]) 
+0000bc10: 2f20 3229 0a20 2020 2020 2020 2069 6620  / 2).        if 
+0000bc20: 795f 626f 756e 6473 2069 7320 4e6f 6e65  y_bounds is None
+0000bc30: 3a0a 2020 2020 2020 2020 2020 2020 795f  :.            y_
+0000bc40: 7261 6e67 6520 3d20 2830 2c20 746f 6d6f  range = (0, tomo
+0000bc50: 5f72 6563 6f6e 5f73 7461 636b 735b 305d  _recon_stacks[0]
+0000bc60: 2e73 6861 7065 5b32 5d29 0a20 2020 2020  .shape[2]).     
+0000bc70: 2020 2020 2020 2079 5f73 6c69 6365 203d         y_slice =
+0000bc80: 2069 6e74 2879 5f72 616e 6765 5b31 5d20   int(y_range[1] 
+0000bc90: 2f20 3229 0a20 2020 2020 2020 2065 6c73  / 2).        els
+0000bca0: 653a 0a20 2020 2020 2020 2020 2020 2079  e:.            y
+0000bcb0: 5f72 616e 6765 203d 2028 6d69 6e28 795f  _range = (min(y_
+0000bcc0: 626f 756e 6473 292c 206d 6178 2879 5f62  bounds), max(y_b
+0000bcd0: 6f75 6e64 7329 290a 2020 2020 2020 2020  ounds)).        
+0000bce0: 2020 2020 795f 736c 6963 6520 3d20 696e      y_slice = in
+0000bcf0: 7428 2879 5f62 6f75 6e64 735b 305d 2b79  t((y_bounds[0]+y
+0000bd00: 5f62 6f75 6e64 735b 315d 2920 2f20 3229  _bounds[1]) / 2)
+0000bd10: 0a20 2020 2020 2020 2069 6620 7a5f 626f  .        if z_bo
+0000bd20: 756e 6473 2069 7320 4e6f 6e65 3a0a 2020  unds is None:.  
+0000bd30: 2020 2020 2020 2020 2020 7a5f 7261 6e67            z_rang
+0000bd40: 6520 3d20 2830 2c20 746f 6d6f 5f72 6563  e = (0, tomo_rec
+0000bd50: 6f6e 5f73 7461 636b 735b 305d 2e73 6861  on_stacks[0].sha
+0000bd60: 7065 5b30 5d29 0a20 2020 2020 2020 2020  pe[0]).         
+0000bd70: 2020 207a 5f73 6c69 6365 203d 2069 6e74     z_slice = int
+0000bd80: 287a 5f72 616e 6765 5b31 5d20 2f20 3229  (z_range[1] / 2)
+0000bd90: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0000bda0: 2020 2020 2020 2020 2020 207a 5f72 616e             z_ran
+0000bdb0: 6765 203d 2028 6d69 6e28 7a5f 626f 756e  ge = (min(z_boun
+0000bdc0: 6473 292c 206d 6178 287a 5f62 6f75 6e64  ds), max(z_bound
+0000bdd0: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+0000bde0: 7a5f 736c 6963 6520 3d20 696e 7428 287a  z_slice = int((z
+0000bdf0: 5f62 6f75 6e64 735b 305d 2b7a 5f62 6f75  _bounds[0]+z_bou
+0000be00: 6e64 735b 315d 2920 2f20 3229 0a20 2020  nds[1]) / 2).   
+0000be10: 2020 2020 2066 6f72 2069 2c20 7374 6163       for i, stac
+0000be20: 6b20 696e 2065 6e75 6d65 7261 7465 2874  k in enumerate(t
+0000be30: 6f6d 6f5f 7265 636f 6e5f 7374 6163 6b73  omo_recon_stacks
+0000be40: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
+0000be50: 6f6d 6f5f 7265 636f 6e5f 7374 6163 6b73  omo_recon_stacks
+0000be60: 5b69 5d20 3d20 7374 6163 6b5b 0a20 2020  [i] = stack[.   
+0000be70: 2020 2020 2020 2020 2020 2020 207a 5f72               z_r
+0000be80: 616e 6765 5b30 5d3a 7a5f 7261 6e67 655b  ange[0]:z_range[
+0000be90: 315d 2c78 5f72 616e 6765 5b30 5d3a 785f  1],x_range[0]:x_
+0000bea0: 7261 6e67 655b 315d 2c79 5f72 616e 6765  range[1],y_range
+0000beb0: 5b30 5d3a 795f 7261 6e67 655b 315d 5d0a  [0]:y_range[1]].
+0000bec0: 2020 2020 2020 2020 746f 6d6f 5f72 6563          tomo_rec
+0000bed0: 6f6e 5f73 7461 636b 7320 3d20 6e70 2e61  on_stacks = np.a
+0000bee0: 7361 7272 6179 2874 6f6d 6f5f 7265 636f  sarray(tomo_reco
+0000bef0: 6e5f 7374 6163 6b73 290a 2320 2020 2020  n_stacks).#     
+0000bf00: 2020 2070 7269 6e74 2866 2774 6f6d 6f5f     print(f'tomo_
+0000bf10: 7265 636f 6e5f 7374 6163 6b73 207b 746f  recon_stacks {to
+0000bf20: 6d6f 5f72 6563 6f6e 5f73 7461 636b 732e  mo_recon_stacks.
+0000bf30: 7368 6170 657d 3a20 7b6e 702e 616d 696e  shape}: {np.amin
+0000bf40: 2874 6f6d 6f5f 7265 636f 6e5f 7374 6163  (tomo_recon_stac
+0000bf50: 6b73 297d 207b 6e70 2e61 6d61 7828 746f  ks)} {np.amax(to
+0000bf60: 6d6f 5f72 6563 6f6e 5f73 7461 636b 7329  mo_recon_stacks)
+0000bf70: 7d27 290a 2320 2020 2020 2020 205f 6d69  }').#        _mi
+0000bf80: 6e20 3d20 6e70 2e61 6d69 6e28 746f 6d6f  n = np.amin(tomo
+0000bf90: 5f72 6563 6f6e 5f73 7461 636b 7329 0a23  _recon_stacks).#
+0000bfa0: 2020 2020 2020 2020 5f6d 6178 203d 206e          _max = n
+0000bfb0: 702e 616d 6178 2874 6f6d 6f5f 7265 636f  p.amax(tomo_reco
+0000bfc0: 6e5f 7374 6163 6b73 290a 2320 2020 2020  n_stacks).#     
+0000bfd0: 2020 2074 6f6d 6f5f 7265 636f 6e5f 7374     tomo_recon_st
+0000bfe0: 6163 6b73 203d 2028 746f 6d6f 5f72 6563  acks = (tomo_rec
+0000bff0: 6f6e 5f73 7461 636b 732d 5f6d 696e 2920  on_stacks-_min) 
+0000c000: 2f20 285f 6d61 782d 5f6d 696e 290a 2320  / (_max-_min).# 
+0000c010: 2020 2020 2020 2070 7269 6e74 2866 2774         print(f't
+0000c020: 6f6d 6f5f 7265 636f 6e5f 7374 6163 6b73  omo_recon_stacks
+0000c030: 207b 746f 6d6f 5f72 6563 6f6e 5f73 7461   {tomo_recon_sta
+0000c040: 636b 732e 7368 6170 657d 3a20 7b6e 702e  cks.shape}: {np.
+0000c050: 616d 696e 2874 6f6d 6f5f 7265 636f 6e5f  amin(tomo_recon_
+0000c060: 7374 6163 6b73 297d 207b 6e70 2e61 6d61  stacks)} {np.ama
+0000c070: 7828 746f 6d6f 5f72 6563 6f6e 5f73 7461  x(tomo_recon_sta
+0000c080: 636b 7329 7d27 290a 0a20 2020 2020 2020  cks)}')..       
+0000c090: 2023 2050 6c6f 7420 6120 6665 7720 7265   # Plot a few re
+0000c0a0: 636f 6e73 7472 7563 7465 6420 696d 6167  constructed imag
+0000c0b0: 6520 736c 6963 6573 0a20 2020 2020 2020  e slices.       
+0000c0c0: 2069 6620 7365 6c66 2e5f 7361 7665 5f66   if self._save_f
+0000c0d0: 6967 733a 0a20 2020 2020 2020 2020 2020  igs:.           
+0000c0e0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+0000c0f0: 746f 6d6f 5f72 6563 6f6e 5f73 7461 636b  tomo_recon_stack
+0000c100: 732e 7368 6170 655b 305d 293a 0a20 2020  s.shape[0]):.   
+0000c110: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000c120: 6e75 6d5f 746f 6d6f 5f73 7461 636b 7320  num_tomo_stacks 
+0000c130: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
+0000c140: 2020 2020 2020 2020 2020 6261 7365 7469            baseti
+0000c150: 746c 6520 3d20 2772 6563 6f6e 270a 2020  tle = 'recon'.  
+0000c160: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0000c170: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000c180: 2020 2020 2020 2020 6261 7365 7469 746c          basetitl
+0000c190: 6520 3d20 6627 7265 636f 6e20 7374 6163  e = f'recon stac
+0000c1a0: 6b20 7b69 7d27 0a20 2020 2020 2020 2020  k {i}'.         
+0000c1b0: 2020 2020 2020 2074 6974 6c65 203d 2066         title = f
+0000c1c0: 277b 6261 7365 7469 746c 657d 207b 7265  '{basetitle} {re
+0000c1d0: 735f 7469 746c 657d 2078 736c 6963 657b  s_title} xslice{
+0000c1e0: 785f 736c 6963 657d 270a 2020 2020 2020  x_slice}'.      
+0000c1f0: 2020 2020 2020 2020 2020 785f 7069 7865            x_pixe
+0000c200: 6c5f 7369 7a65 203d 206e 7865 6e74 7279  l_size = nxentry
+0000c210: 2e69 6e73 7472 756d 656e 742e 6465 7465  .instrument.dete
+0000c220: 6374 6f72 2e78 5f70 6978 656c 5f73 697a  ctor.x_pixel_siz
+0000c230: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000c240: 2020 795f 7069 7865 6c5f 7369 7a65 203d    y_pixel_size =
+0000c250: 206e 7865 6e74 7279 2e69 6e73 7472 756d   nxentry.instrum
+0000c260: 656e 742e 6465 7465 6374 6f72 2e79 5f70  ent.detector.y_p
+0000c270: 6978 656c 5f73 697a 650a 2020 2020 2020  ixel_size.      
+0000c280: 2020 2020 2020 2020 2020 6578 7465 6e74            extent
+0000c290: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+0000c2a0: 2020 2020 2020 2020 2030 2c0a 2020 2020           0,.    
+0000c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c2c0: 666c 6f61 7428 795f 7069 7865 6c5f 7369  float(y_pixel_si
+0000c2d0: 7a65 2a74 6f6d 6f5f 7265 636f 6e5f 7374  ze*tomo_recon_st
+0000c2e0: 6163 6b73 2e73 6861 7065 5b33 5d29 2c0a  acks.shape[3]),.
+0000c2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c300: 2020 2020 666c 6f61 7428 785f 7069 7865      float(x_pixe
+0000c310: 6c5f 7369 7a65 2a74 6f6d 6f5f 7265 636f  l_size*tomo_reco
+0000c320: 6e5f 7374 6163 6b73 2e73 6861 7065 5b31  n_stacks.shape[1
+0000c330: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+0000c340: 2020 2020 2020 2020 3029 0a20 2020 2020          0).     
+0000c350: 2020 2020 2020 2020 2020 2071 7569 636b             quick
+0000c360: 5f69 6d73 686f 7728 0a20 2020 2020 2020  _imshow(.       
+0000c370: 2020 2020 2020 2020 2020 2020 2074 6f6d               tom
+0000c380: 6f5f 7265 636f 6e5f 7374 6163 6b73 5b69  o_recon_stacks[i
+0000c390: 2c3a 2c78 5f73 6c69 6365 2d78 5f72 616e  ,:,x_slice-x_ran
+0000c3a0: 6765 5b30 5d2c 3a5d 2c0a 2020 2020 2020  ge[0],:],.      
+0000c3b0: 2020 2020 2020 2020 2020 2020 2020 7469                ti
+0000c3c0: 746c 653d 7469 746c 652c 2070 6174 683d  tle=title, path=
+0000c3d0: 7365 6c66 2e5f 6f75 7470 7574 5f66 6f6c  self._output_fol
+0000c3e0: 6465 722c 2073 6176 655f 6669 673d 5472  der, save_fig=Tr
+0000c3f0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+0000c400: 2020 2020 2020 2020 7361 7665 5f6f 6e6c          save_onl
+0000c410: 793d 5472 7565 2c20 6578 7465 6e74 3d65  y=True, extent=e
+0000c420: 7874 656e 7429 0a20 2020 2020 2020 2020  xtent).         
+0000c430: 2020 2020 2020 2074 6974 6c65 203d 2066         title = f
+0000c440: 277b 6261 7365 7469 746c 657d 207b 7265  '{basetitle} {re
+0000c450: 735f 7469 746c 657d 2079 736c 6963 657b  s_title} yslice{
+0000c460: 795f 736c 6963 657d 270a 2020 2020 2020  y_slice}'.      
+0000c470: 2020 2020 2020 2020 2020 6578 7465 6e74            extent
+0000c480: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+0000c490: 2020 2020 2020 2020 2030 2c0a 2020 2020           0,.    
+0000c4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c4b0: 666c 6f61 7428 795f 7069 7865 6c5f 7369  float(y_pixel_si
+0000c4c0: 7a65 2a74 6f6d 6f5f 7265 636f 6e5f 7374  ze*tomo_recon_st
+0000c4d0: 6163 6b73 2e73 6861 7065 5b32 5d29 2c0a  acks.shape[2]),.
+0000c4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c4f0: 2020 2020 666c 6f61 7428 785f 7069 7865      float(x_pixe
+0000c500: 6c5f 7369 7a65 2a74 6f6d 6f5f 7265 636f  l_size*tomo_reco
+0000c510: 6e5f 7374 6163 6b73 2e73 6861 7065 5b31  n_stacks.shape[1
+0000c520: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+0000c530: 2020 2020 2020 2020 3029 0a20 2020 2020          0).     
+0000c540: 2020 2020 2020 2020 2020 2071 7569 636b             quick
+0000c550: 5f69 6d73 686f 7728 0a20 2020 2020 2020  _imshow(.       
+0000c560: 2020 2020 2020 2020 2020 2020 2074 6f6d               tom
+0000c570: 6f5f 7265 636f 6e5f 7374 6163 6b73 5b69  o_recon_stacks[i
+0000c580: 2c3a 2c3a 2c79 5f73 6c69 6365 2d79 5f72  ,:,:,y_slice-y_r
+0000c590: 616e 6765 5b30 5d5d 2c0a 2020 2020 2020  ange[0]],.      
+0000c5a0: 2020 2020 2020 2020 2020 2020 2020 7469                ti
+0000c5b0: 746c 653d 7469 746c 652c 2070 6174 683d  tle=title, path=
+0000c5c0: 7365 6c66 2e5f 6f75 7470 7574 5f66 6f6c  self._output_fol
+0000c5d0: 6465 722c 2073 6176 655f 6669 673d 5472  der, save_fig=Tr
+0000c5e0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+0000c5f0: 2020 2020 2020 2020 7361 7665 5f6f 6e6c          save_onl
+0000c600: 793d 5472 7565 2c20 6578 7465 6e74 3d65  y=True, extent=e
+0000c610: 7874 656e 7429 0a20 2020 2020 2020 2020  xtent).         
+0000c620: 2020 2020 2020 2074 6974 6c65 203d 2066         title = f
+0000c630: 277b 6261 7365 7469 746c 657d 207b 7265  '{basetitle} {re
+0000c640: 735f 7469 746c 657d 207a 736c 6963 657b  s_title} zslice{
+0000c650: 7a5f 736c 6963 657d 270a 2020 2020 2020  z_slice}'.      
+0000c660: 2020 2020 2020 2020 2020 6578 7465 6e74            extent
+0000c670: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+0000c680: 2020 2020 2020 2020 2030 2c0a 2020 2020           0,.    
+0000c690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6a0: 666c 6f61 7428 795f 7069 7865 6c5f 7369  float(y_pixel_si
+0000c6b0: 7a65 2a74 6f6d 6f5f 7265 636f 6e5f 7374  ze*tomo_recon_st
+0000c6c0: 6163 6b73 2e73 6861 7065 5b33 5d29 2c0a  acks.shape[3]),.
+0000c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6e0: 2020 2020 666c 6f61 7428 795f 7069 7865      float(y_pixe
+0000c6f0: 6c5f 7369 7a65 2a74 6f6d 6f5f 7265 636f  l_size*tomo_reco
+0000c700: 6e5f 7374 6163 6b73 2e73 6861 7065 5b32  n_stacks.shape[2
+0000c710: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+0000c720: 2020 2020 2020 2020 3029 0a20 2020 2020          0).     
+0000c730: 2020 2020 2020 2020 2020 2071 7569 636b             quick
+0000c740: 5f69 6d73 686f 7728 0a20 2020 2020 2020  _imshow(.       
+0000c750: 2020 2020 2020 2020 2020 2020 2074 6f6d               tom
+0000c760: 6f5f 7265 636f 6e5f 7374 6163 6b73 5b69  o_recon_stacks[i
+0000c770: 2c7a 5f73 6c69 6365 2d7a 5f72 616e 6765  ,z_slice-z_range
+0000c780: 5b30 5d2c 3a2c 3a5d 2c0a 2020 2020 2020  [0],:,:],.      
+0000c790: 2020 2020 2020 2020 2020 2020 2020 7469                ti
+0000c7a0: 746c 653d 7469 746c 652c 2070 6174 683d  tle=title, path=
+0000c7b0: 7365 6c66 2e5f 6f75 7470 7574 5f66 6f6c  self._output_fol
+0000c7c0: 6465 722c 2073 6176 655f 6669 673d 5472  der, save_fig=Tr
+0000c7d0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+0000c7e0: 2020 2020 2020 2020 7361 7665 5f6f 6e6c          save_onl
+0000c7f0: 793d 5472 7565 2c20 6578 7465 6e74 3d65  y=True, extent=e
+0000c800: 7874 656e 7429 0a0a 2020 2020 2020 2020  xtent)..        
+0000c810: 2320 5361 7665 2074 6573 7420 6461 7461  # Save test data
+0000c820: 2074 6f20 6669 6c65 0a20 2020 2020 2020   to file.       
+0000c830: 2023 2020 2020 2072 6563 6f6e 7374 7275   #     reconstru
+0000c840: 6374 6564 2064 6174 6120 6f72 6465 7220  cted data order 
+0000c850: 696e 2065 6163 6820 7374 6163 6b3a 2072  in each stack: r
+0000c860: 6f77 2f7a 2c78 2c79 0a20 2020 2020 2020  ow/z,x,y.       
+0000c870: 2069 6620 7365 6c66 2e5f 7465 7374 5f6d   if self._test_m
+0000c880: 6f64 653a 0a20 2020 2020 2020 2020 2020  ode:.           
+0000c890: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+0000c8a0: 746f 6d6f 5f72 6563 6f6e 5f73 7461 636b  tomo_recon_stack
+0000c8b0: 732e 7368 6170 655b 305d 293a 0a20 2020  s.shape[0]):.   
+0000c8c0: 2020 2020 2020 2020 2020 2020 206e 702e               np.
+0000c8d0: 7361 7665 7478 7428 0a20 2020 2020 2020  savetxt(.       
+0000c8e0: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
+0000c8f0: 7365 6c66 2e5f 6f75 7470 7574 5f66 6f6c  self._output_fol
+0000c900: 6465 727d 2f72 6563 6f6e 5f73 7461 636b  der}/recon_stack
+0000c910: 5f7b 697d 2e74 7874 272c 0a20 2020 2020  _{i}.txt',.     
+0000c920: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000c930: 6f6d 6f5f 7265 636f 6e5f 7374 6163 6b73  omo_recon_stacks
+0000c940: 5b69 2c7a 5f73 6c69 6365 2c3a 2c3a 5d2c  [i,z_slice,:,:],
+0000c950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c960: 2020 2020 2066 6d74 3d27 252e 3665 2729       fmt='%.6e')
+0000c970: 0a0a 2020 2020 2020 2020 2320 4164 6420  ..        # Add 
+0000c980: 696d 6167 6520 7265 636f 6e73 7472 7563  image reconstruc
+0000c990: 7469 6f6e 2074 6f20 7265 636f 6e73 7472  tion to reconstr
+0000c9a0: 7563 7465 6420 6461 7461 204e 5870 726f  ucted data NXpro
+0000c9b0: 6365 7373 0a20 2020 2020 2020 2023 2020  cess.        #  
+0000c9c0: 2020 2072 6563 6f6e 7374 7275 6374 6564     reconstructed
+0000c9d0: 2064 6174 6120 6f72 6465 7220 696e 2065   data order in e
+0000c9e0: 6163 6820 7374 6163 6b3a 2072 6f77 2f7a  ach stack: row/z
+0000c9f0: 2c78 2c79 0a20 2020 2020 2020 206e 7870  ,x,y.        nxp
+0000ca00: 726f 6365 7373 2e64 6174 6120 3d20 4e58  rocess.data = NX
+0000ca10: 6461 7461 2829 0a20 2020 2020 2020 206e  data().        n
+0000ca20: 7870 726f 6365 7373 2e61 7474 7273 5b27  xprocess.attrs['
+0000ca30: 6465 6661 756c 7427 5d20 3d20 2764 6174  default'] = 'dat
+0000ca40: 6127 0a20 2020 2020 2020 2066 6f72 206b  a'.        for k
+0000ca50: 2c20 7620 696e 2063 656e 7465 725f 696e  , v in center_in
+0000ca60: 666f 2e69 7465 6d73 2829 3a0a 2020 2020  fo.items():.    
+0000ca70: 2020 2020 2020 2020 6e78 7072 6f63 6573          nxproces
+0000ca80: 735b 6b5d 203d 2076 0a20 2020 2020 2020  s[k] = v.       
+0000ca90: 2069 6620 785f 626f 756e 6473 2069 7320   if x_bounds is 
+0000caa0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0000cab0: 2020 2020 2020 6e78 7072 6f63 6573 732e        nxprocess.
+0000cac0: 785f 626f 756e 6473 203d 2078 5f62 6f75  x_bounds = x_bou
+0000cad0: 6e64 730a 2020 2020 2020 2020 6966 2079  nds.        if y
+0000cae0: 5f62 6f75 6e64 7320 6973 206e 6f74 204e  _bounds is not N
+0000caf0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000cb00: 206e 7870 726f 6365 7373 2e79 5f62 6f75   nxprocess.y_bou
+0000cb10: 6e64 7320 3d20 795f 626f 756e 6473 0a20  nds = y_bounds. 
+0000cb20: 2020 2020 2020 2069 6620 7a5f 626f 756e         if z_boun
+0000cb30: 6473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ds is not None:.
+0000cb40: 2020 2020 2020 2020 2020 2020 6e78 7072              nxpr
+0000cb50: 6f63 6573 732e 7a5f 626f 756e 6473 203d  ocess.z_bounds =
+0000cb60: 207a 5f62 6f75 6e64 730a 2020 2020 2020   z_bounds.      
+0000cb70: 2020 6e78 7072 6f63 6573 732e 6461 7461    nxprocess.data
+0000cb80: 5b27 7265 636f 6e73 7472 7563 7465 645f  ['reconstructed_
+0000cb90: 6461 7461 275d 203d 2074 6f6d 6f5f 7265  data'] = tomo_re
+0000cba0: 636f 6e5f 7374 6163 6b73 0a20 2020 2020  con_stacks.     
+0000cbb0: 2020 206e 7870 726f 6365 7373 2e64 6174     nxprocess.dat
+0000cbc0: 612e 6174 7472 735b 2773 6967 6e61 6c27  a.attrs['signal'
+0000cbd0: 5d20 3d20 2772 6563 6f6e 7374 7275 6374  ] = 'reconstruct
+0000cbe0: 6564 5f64 6174 6127 0a0a 2020 2020 2020  ed_data'..      
+0000cbf0: 2020 2320 4372 6561 7465 2061 2063 6f70    # Create a cop
+0000cc00: 7920 6f66 2074 6865 2069 6e70 7574 204e  y of the input N
+0000cc10: 6578 7573 206f 626a 6563 7420 616e 6420  exus object and 
+0000cc20: 7265 6d6f 7665 2072 6564 7563 6564 0a20  remove reduced. 
+0000cc30: 2020 2020 2020 2023 2020 2020 2064 6174         #     dat
+0000cc40: 610a 2020 2020 2020 2020 6578 636c 7564  a.        exclud
+0000cc50: 655f 6974 656d 7320 3d20 5b0a 2020 2020  e_items = [.    
+0000cc60: 2020 2020 2020 2020 6627 7b6e 7865 6e74          f'{nxent
+0000cc70: 7279 2e6e 786e 616d 657d 2f72 6564 7563  ry.nxname}/reduc
+0000cc80: 6564 5f64 6174 612f 6461 7461 272c 0a20  ed_data/data',. 
+0000cc90: 2020 2020 2020 2020 2020 2066 277b 6e78             f'{nx
+0000cca0: 656e 7472 792e 6e78 6e61 6d65 7d2f 6461  entry.nxname}/da
+0000ccb0: 7461 2f72 6564 7563 6564 5f64 6174 6127  ta/reduced_data'
+0000ccc0: 2c0a 2020 2020 2020 2020 5d0a 2020 2020  ,.        ].    
+0000ccd0: 2020 2020 6e78 726f 6f74 5f63 6f70 7920      nxroot_copy 
+0000cce0: 3d20 6e78 636f 7079 286e 7872 6f6f 742c  = nxcopy(nxroot,
+0000ccf0: 2065 7863 6c75 6465 5f6e 7870 6174 6873   exclude_nxpaths
+0000cd00: 3d65 7863 6c75 6465 5f69 7465 6d73 290a  =exclude_items).
+0000cd10: 0a20 2020 2020 2020 2023 2041 6464 2074  .        # Add t
+0000cd20: 6865 2072 6563 6f6e 7374 7275 6374 6564  he reconstructed
+0000cd30: 2064 6174 6120 4e58 7072 6f63 6573 7320   data NXprocess 
+0000cd40: 746f 2074 6865 206e 6577 204e 6578 7573  to the new Nexus
+0000cd50: 206f 626a 6563 740a 2020 2020 2020 2020   object.        
+0000cd60: 6e78 656e 7472 795f 636f 7079 203d 206e  nxentry_copy = n
+0000cd70: 7872 6f6f 745f 636f 7079 5b6e 7872 6f6f  xroot_copy[nxroo
+0000cd80: 745f 636f 7079 2e61 7474 7273 5b27 6465  t_copy.attrs['de
+0000cd90: 6661 756c 7427 5d5d 0a20 2020 2020 2020  fault']].       
+0000cda0: 206e 7865 6e74 7279 5f63 6f70 792e 7265   nxentry_copy.re
+0000cdb0: 636f 6e73 7472 7563 7465 645f 6461 7461  constructed_data
+0000cdc0: 203d 206e 7870 726f 6365 7373 0a20 2020   = nxprocess.   
+0000cdd0: 2020 2020 2069 6620 2764 6174 6127 206e       if 'data' n
+0000cde0: 6f74 2069 6e20 6e78 656e 7472 795f 636f  ot in nxentry_co
+0000cdf0: 7079 3a0a 2020 2020 2020 2020 2020 2020  py:.            
+0000ce00: 6e78 656e 7472 795f 636f 7079 2e64 6174  nxentry_copy.dat
+0000ce10: 6120 3d20 4e58 6461 7461 2829 0a20 2020  a = NXdata().   
+0000ce20: 2020 2020 206e 7865 6e74 7279 5f63 6f70       nxentry_cop
+0000ce30: 792e 6174 7472 735b 2764 6566 6175 6c74  y.attrs['default
+0000ce40: 275d 203d 2027 6461 7461 270a 2020 2020  '] = 'data'.    
+0000ce50: 2020 2020 6e78 656e 7472 795f 636f 7079      nxentry_copy
+0000ce60: 2e64 6174 612e 6d61 6b65 6c69 6e6b 280a  .data.makelink(.
+0000ce70: 2020 2020 2020 2020 2020 2020 6e78 7072              nxpr
+0000ce80: 6f63 6573 732e 6461 7461 2e72 6563 6f6e  ocess.data.recon
+0000ce90: 7374 7275 6374 6564 5f64 6174 612c 206e  structed_data, n
+0000cea0: 616d 653d 2772 6563 6f6e 7374 7275 6374  ame='reconstruct
+0000ceb0: 6564 5f64 6174 6127 290a 2020 2020 2020  ed_data').      
+0000cec0: 2020 6e78 656e 7472 795f 636f 7079 2e64    nxentry_copy.d
+0000ced0: 6174 612e 6174 7472 735b 2773 6967 6e61  ata.attrs['signa
+0000cee0: 6c27 5d20 3d20 2772 6563 6f6e 7374 7275  l'] = 'reconstru
+0000cef0: 6374 6564 5f64 6174 6127 0a0a 2020 2020  cted_data'..    
+0000cf00: 2020 2020 7265 7475 726e 206e 7872 6f6f      return nxroo
+0000cf10: 745f 636f 7079 0a0a 2020 2020 6465 6620  t_copy..    def 
+0000cf20: 636f 6d62 696e 655f 6461 7461 280a 2020  combine_data(.  
+0000cf30: 2020 2020 2020 2020 2020 7365 6c66 2c20            self, 
+0000cf40: 6e78 726f 6f74 2c20 785f 626f 756e 6473  nxroot, x_bounds
+0000cf50: 3d4e 6f6e 652c 2079 5f62 6f75 6e64 733d  =None, y_bounds=
+0000cf60: 4e6f 6e65 2c20 7a5f 626f 756e 6473 3d4e  None, z_bounds=N
+0000cf70: 6f6e 6529 3a0a 2020 2020 2020 2020 2222  one):.        ""
+0000cf80: 2243 6f6d 6269 6e65 2074 6865 2072 6563  "Combine the rec
+0000cf90: 6f6e 7374 7275 6374 6564 2074 6f6d 6f67  onstructed tomog
+0000cfa0: 7261 7068 7920 7374 6163 6b73 2e0a 0a20  raphy stacks... 
+0000cfb0: 2020 2020 2020 203a 7061 7261 6d20 6e78         :param nx
+0000cfc0: 726f 6f74 3a20 4120 7374 6163 6b20 6f66  root: A stack of
+0000cfd0: 2072 6563 6f6e 7374 7275 6374 6564 2074   reconstructed t
+0000cfe0: 6f6d 6f67 7261 7068 7920 6461 7461 7365  omography datase
+0000cff0: 7473 0a20 2020 2020 2020 203a 7479 7065  ts.        :type
+0000d000: 2064 6174 613a 206e 6578 7573 666f 726d   data: nexusform
+0000d010: 6174 2e6e 6578 7573 2e4e 5872 6f6f 740a  at.nexus.NXroot.
+0000d020: 2020 2020 2020 2020 3a70 6172 616d 2078          :param x
+0000d030: 5f62 6f75 6e64 733a 2043 6f6d 6269 6e65  _bounds: Combine
+0000d040: 6420 696d 6167 6520 626f 756e 6473 2069  d image bounds i
+0000d050: 6e20 7468 6520 782d 6469 7265 6374 696f  n the x-directio
+0000d060: 6e0a 2020 2020 2020 2020 3a74 7970 6520  n.        :type 
+0000d070: 785f 626f 756e 6473 3a20 7475 706c 6528  x_bounds: tuple(
+0000d080: 696e 742c 2069 6e74 292c 206c 6973 745b  int, int), list[
+0000d090: 696e 745d 2c20 6f70 7469 6f6e 616c 0a20  int], optional. 
+0000d0a0: 2020 2020 2020 203a 7061 7261 6d20 795f         :param y_
+0000d0b0: 626f 756e 6473 3a20 436f 6d62 696e 6564  bounds: Combined
+0000d0c0: 2069 6d61 6765 2062 6f75 6e64 7320 696e   image bounds in
+0000d0d0: 2074 6865 2079 2d64 6972 6563 7469 6f6e   the y-direction
+0000d0e0: 0a20 2020 2020 2020 203a 7479 7065 2079  .        :type y
+0000d0f0: 5f62 6f75 6e64 733a 2074 7570 6c65 2869  _bounds: tuple(i
+0000d100: 6e74 2c20 696e 7429 2c20 6c69 7374 5b69  nt, int), list[i
+0000d110: 6e74 5d2c 206f 7074 696f 6e61 6c0a 2020  nt], optional.  
+0000d120: 2020 2020 2020 3a70 6172 616d 207a 5f62        :param z_b
+0000d130: 6f75 6e64 733a 2043 6f6d 6269 6e65 6420  ounds: Combined 
+0000d140: 696d 6167 6520 626f 756e 6473 2069 6e20  image bounds in 
+0000d150: 7468 6520 7a2d 6469 7265 6374 696f 6e0a  the z-direction.
+0000d160: 2020 2020 2020 2020 3a74 7970 6520 7a5f          :type z_
+0000d170: 626f 756e 6473 3a20 7475 706c 6528 696e  bounds: tuple(in
+0000d180: 742c 2069 6e74 292c 206c 6973 745b 696e  t, int), list[in
+0000d190: 745d 2c20 6f70 7469 6f6e 616c 0a20 2020  t], optional.   
+0000d1a0: 2020 2020 203a 7265 7475 726e 3a20 436f       :return: Co
+0000d1b0: 6d62 696e 6564 2072 6563 6f6e 7374 7275  mbined reconstru
+0000d1c0: 6374 6564 2074 6f6d 6f67 7261 7068 7920  cted tomography 
+0000d1d0: 6461 7461 0a20 2020 2020 2020 203a 7274  data.        :rt
+0000d1e0: 7970 653a 206e 6578 7573 666f 726d 6174  ype: nexusformat
+0000d1f0: 2e6e 6578 7573 2e4e 5872 6f6f 740a 2020  .nexus.NXroot.  
+0000d200: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000d210: 2020 2320 5468 6972 6420 7061 7274 7920    # Third party 
+0000d220: 6d6f 6475 6c65 730a 2020 2020 2020 2020  modules.        
+0000d230: 6672 6f6d 206e 6578 7573 666f 726d 6174  from nexusformat
+0000d240: 2e6e 6578 7573 2069 6d70 6f72 7420 280a  .nexus import (.
+0000d250: 2020 2020 2020 2020 2020 2020 4e58 6461              NXda
+0000d260: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
+0000d270: 4e58 656e 7472 792c 0a20 2020 2020 2020  NXentry,.       
+0000d280: 2020 2020 204e 5870 726f 6365 7373 2c0a       NXprocess,.
+0000d290: 2020 2020 2020 2020 2020 2020 4e58 726f              NXro
+0000d2a0: 6f74 2c0a 2020 2020 2020 2020 290a 0a20  ot,.        ).. 
+0000d2b0: 2020 2020 2020 2023 204c 6f63 616c 206d         # Local m
+0000d2c0: 6f64 756c 6573 0a20 2020 2020 2020 2066  odules.        f
+0000d2d0: 726f 6d20 4348 4150 2e75 7469 6c73 2e67  rom CHAP.utils.g
+0000d2e0: 656e 6572 616c 2069 6d70 6f72 7420 6973  eneral import is
+0000d2f0: 5f69 6e74 5f70 6169 720a 0a20 2020 2020  _int_pair..     
+0000d300: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
+0000d310: 696e 666f 2827 436f 6d62 696e 6520 7468  info('Combine th
+0000d320: 6520 7265 636f 6e73 7472 7563 7465 6420  e reconstructed 
+0000d330: 746f 6d6f 6772 6170 6879 2073 7461 636b  tomography stack
+0000d340: 7327 290a 0a20 2020 2020 2020 2069 6620  s')..        if 
+0000d350: 6e6f 7420 6973 696e 7374 616e 6365 286e  not isinstance(n
+0000d360: 7872 6f6f 742c 204e 5872 6f6f 7429 3a0a  xroot, NXroot):.
+0000d370: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000d380: 6520 5661 6c75 6545 7272 6f72 2866 2749  e ValueError(f'I
+0000d390: 6e76 616c 6964 2070 6172 616d 6574 6572  nvalid parameter
+0000d3a0: 206e 7872 6f6f 7420 287b 6e78 726f 6f74   nxroot ({nxroot
+0000d3b0: 7d29 2729 0a20 2020 2020 2020 206e 7865  })').        nxe
+0000d3c0: 6e74 7279 203d 206e 7872 6f6f 745b 6e78  ntry = nxroot[nx
+0000d3d0: 726f 6f74 2e61 7474 7273 5b27 6465 6661  root.attrs['defa
+0000d3e0: 756c 7427 5d5d 0a20 2020 2020 2020 2069  ult']].        i
+0000d3f0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+0000d400: 286e 7865 6e74 7279 2c20 4e58 656e 7472  (nxentry, NXentr
+0000d410: 7929 3a0a 2020 2020 2020 2020 2020 2020  y):.            
+0000d420: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+0000d430: 2866 2749 6e76 616c 6964 206e 7865 6e74  (f'Invalid nxent
+0000d440: 7279 2028 7b6e 7865 6e74 7279 7d29 2729  ry ({nxentry})')
+0000d450: 0a20 2020 2020 2020 2069 6620 785f 626f  .        if x_bo
+0000d460: 756e 6473 2069 7320 6e6f 7420 4e6f 6e65  unds is not None
+0000d470: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0000d480: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+0000d490: 785f 626f 756e 6473 2c20 2874 7570 6c65  x_bounds, (tuple
+0000d4a0: 2c20 6c69 7374 2929 3a0a 2020 2020 2020  , list)):.      
+0000d4b0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000d4c0: 5661 6c75 6545 7272 6f72 2866 2749 6e76  ValueError(f'Inv
+0000d4d0: 616c 6964 2070 6172 616d 6574 6572 2078  alid parameter x
+0000d4e0: 5f62 6f75 6e64 7320 287b 785f 626f 756e  _bounds ({x_boun
+0000d4f0: 6473 7d29 2729 0a20 2020 2020 2020 2020  ds})').         
+0000d500: 2020 2078 5f62 6f75 6e64 7320 3d20 7475     x_bounds = tu
+0000d510: 706c 6528 785f 626f 756e 6473 290a 2020  ple(x_bounds).  
+0000d520: 2020 2020 2020 6966 2079 5f62 6f75 6e64        if y_bound
+0000d530: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+0000d540: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0000d550: 7420 6973 696e 7374 616e 6365 2879 5f62  t isinstance(y_b
+0000d560: 6f75 6e64 732c 2028 7475 706c 652c 206c  ounds, (tuple, l
+0000d570: 6973 7429 293a 0a20 2020 2020 2020 2020  ist)):.         
+0000d580: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+0000d590: 7565 4572 726f 7228 6627 496e 7661 6c69  ueError(f'Invali
+0000d5a0: 6420 7061 7261 6d65 7465 7220 795f 626f  d parameter y_bo
+0000d5b0: 756e 6473 2028 7b79 5f62 6f75 6e64 737d  unds ({y_bounds}
+0000d5c0: 2927 290a 2020 2020 2020 2020 2020 2020  )').            
+0000d5d0: 795f 626f 756e 6473 203d 2074 7570 6c65  y_bounds = tuple
+0000d5e0: 2879 5f62 6f75 6e64 7329 0a20 2020 2020  (y_bounds).     
+0000d5f0: 2020 2069 6620 7a5f 626f 756e 6473 2069     if z_bounds i
+0000d600: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0000d610: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
+0000d620: 7369 6e73 7461 6e63 6528 7a5f 626f 756e  sinstance(z_boun
+0000d630: 6473 2c20 2874 7570 6c65 2c20 6c69 7374  ds, (tuple, list
+0000d640: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+0000d650: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+0000d660: 7272 6f72 2866 2749 6e76 616c 6964 2070  rror(f'Invalid p
+0000d670: 6172 616d 6574 6572 207a 5f62 6f75 6e64  arameter z_bound
+0000d680: 7320 287b 7a5f 626f 756e 6473 7d29 2729  s ({z_bounds})')
+0000d690: 0a20 2020 2020 2020 2020 2020 207a 5f62  .            z_b
+0000d6a0: 6f75 6e64 7320 3d20 7475 706c 6528 7a5f  ounds = tuple(z_
+0000d6b0: 626f 756e 6473 290a 0a20 2020 2020 2020  bounds)..       
+0000d6c0: 2023 2043 6865 636b 2069 6620 7265 636f   # Check if reco
+0000d6d0: 6e73 7472 7563 7465 6420 696d 6167 6520  nstructed image 
+0000d6e0: 6461 7461 2069 7320 6176 6169 6c61 626c  data is availabl
+0000d6f0: 650a 2020 2020 2020 2020 6966 2028 2772  e.        if ('r
+0000d700: 6563 6f6e 7374 7275 6374 6564 5f64 6174  econstructed_dat
+0000d710: 6127 206e 6f74 2069 6e20 6e78 656e 7472  a' not in nxentr
+0000d720: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
+0000d730: 2020 6f72 2027 7265 636f 6e73 7472 7563    or 'reconstruc
+0000d740: 7465 645f 6461 7461 2720 6e6f 7420 696e  ted_data' not in
+0000d750: 206e 7865 6e74 7279 2e64 6174 6129 3a0a   nxentry.data):.
+0000d760: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000d770: 6520 4b65 7945 7272 6f72 280a 2020 2020  e KeyError(.    
+0000d780: 2020 2020 2020 2020 2020 2020 6627 556e              f'Un
+0000d790: 6162 6c65 2074 6f20 6669 6e64 2076 616c  able to find val
+0000d7a0: 6964 2072 6563 6f6e 7374 7275 6374 6564  id reconstructed
+0000d7b0: 2069 6d61 6765 2064 6174 6120 696e 207b   image data in {
+0000d7c0: 6e78 656e 7472 797d 2729 0a0a 2020 2020  nxentry}')..    
+0000d7d0: 2020 2020 2320 4372 6561 7465 2061 6e20      # Create an 
+0000d7e0: 4e58 7072 6f63 6573 7320 746f 2073 746f  NXprocess to sto
+0000d7f0: 7265 2063 6f6d 6269 6e65 6420 696d 6167  re combined imag
+0000d800: 6520 7265 636f 6e73 7472 7563 7469 6f6e  e reconstruction
+0000d810: 0a20 2020 2020 2020 2023 2020 2020 2028  .        #     (
+0000d820: 6d65 7461 2964 6174 610a 2020 2020 2020  meta)data.      
+0000d830: 2020 6e78 7072 6f63 6573 7320 3d20 4e58    nxprocess = NX
+0000d840: 7072 6f63 6573 7328 290a 0a20 2020 2020  process()..     
+0000d850: 2020 2023 2047 6574 2074 6865 2072 6563     # Get the rec
+0000d860: 6f6e 7374 7275 6374 6564 2064 6174 610a  onstructed data.
+0000d870: 2020 2020 2020 2020 2320 2020 2020 7265          #     re
+0000d880: 636f 6e73 7472 7563 7465 6420 6461 7461  constructed data
+0000d890: 206f 7264 6572 3a20 7374 6163 6b2c 726f   order: stack,ro
+0000d8a0: 7728 7a29 2c78 2c79 0a20 2020 2020 2020  w(z),x,y.       
+0000d8b0: 2023 204e 6f74 653a 204e 6578 7573 2063   # Note: Nexus c
+0000d8c0: 616e 2774 2066 6f6c 6c6f 7720 6120 6c69  an't follow a li
+0000d8d0: 6e6b 2069 6620 7468 6520 6461 7461 2069  nk if the data i
+0000d8e0: 7420 706f 696e 7473 2074 6f20 6973 0a20  t points to is. 
+0000d8f0: 2020 2020 2020 2023 2020 2020 2074 6f6f         #     too
+0000d900: 2062 6967 2067 6574 2074 6865 2064 6174   big get the dat
+0000d910: 6120 6672 6f6d 2074 6865 2061 6374 7561  a from the actua
+0000d920: 6c20 706c 6163 652c 206e 6f74 2066 726f  l place, not fro
+0000d930: 6d0a 2020 2020 2020 2020 2320 2020 2020  m.        #     
+0000d940: 6e78 656e 7472 792e 6461 7461 0a20 2020  nxentry.data.   
+0000d950: 2020 2020 206e 756d 5f74 6f6d 6f5f 7374       num_tomo_st
+0000d960: 6163 6b73 203d 205c 0a20 2020 2020 2020  acks = \.       
+0000d970: 2020 2020 206e 7865 6e74 7279 2e72 6563       nxentry.rec
+0000d980: 6f6e 7374 7275 6374 6564 5f64 6174 612e  onstructed_data.
+0000d990: 6461 7461 2e72 6563 6f6e 7374 7275 6374  data.reconstruct
+0000d9a0: 6564 5f64 6174 612e 7368 6170 655b 305d  ed_data.shape[0]
+0000d9b0: 0a20 2020 2020 2020 2069 6620 6e75 6d5f  .        if num_
+0000d9c0: 746f 6d6f 5f73 7461 636b 7320 3d3d 2031  tomo_stacks == 1
+0000d9d0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0000d9e0: 6c66 2e5f 6c6f 6767 6572 2e69 6e66 6f28  lf._logger.info(
+0000d9f0: 274f 6e6c 7920 6f6e 6520 7374 6163 6b20  'Only one stack 
+0000da00: 6176 6169 6c61 626c 653a 206c 6561 7669  available: leavi
+0000da10: 6e67 2063 6f6d 6269 6e65 5f64 6174 6127  ng combine_data'
+0000da20: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0000da30: 7475 726e 204e 6f6e 650a 0a20 2020 2020  turn None..     
+0000da40: 2020 2023 2043 6f6d 6269 6e65 2074 6865     # Combine the
+0000da50: 2072 6563 6f6e 7374 7275 6374 6564 2073   reconstructed s
+0000da60: 7461 636b 730a 2020 2020 2020 2020 2320  tacks.        # 
+0000da70: 286c 6f61 6420 6f6e 6520 7374 6163 6b20  (load one stack 
+0000da80: 6174 2061 2074 696d 6520 746f 2072 6564  at a time to red
+0000da90: 7563 6520 7269 736b 206f 6620 6869 7474  uce risk of hitt
+0000daa0: 696e 6720 4e65 7875 730a 2020 2020 2020  ing Nexus.      
+0000dab0: 2020 2320 2020 2020 6461 7461 2061 6363    #     data acc
+0000dac0: 6573 7320 6c69 6d69 7429 0a20 2020 2020  ess limit).     
+0000dad0: 2020 2074 3020 3d20 7469 6d65 2829 0a20     t0 = time(). 
+0000dae0: 2020 2020 2020 2074 6f6d 6f5f 7265 636f         tomo_reco
+0000daf0: 6e5f 636f 6d62 696e 6564 203d 206e 702e  n_combined = np.
+0000db00: 6173 6172 7261 7928 0a20 2020 2020 2020  asarray(.       
+0000db10: 2020 2020 206e 7865 6e74 7279 2e72 6563       nxentry.rec
+0000db20: 6f6e 7374 7275 6374 6564 5f64 6174 612e  onstructed_data.
+0000db30: 6461 7461 2e72 6563 6f6e 7374 7275 6374  data.reconstruct
+0000db40: 6564 5f64 6174 615b 305d 290a 2020 2020  ed_data[0]).    
+0000db50: 2020 2020 6966 206e 756d 5f74 6f6d 6f5f      if num_tomo_
+0000db60: 7374 6163 6b73 203e 2032 3a0a 2020 2020  stacks > 2:.    
+0000db70: 2020 2020 2020 2020 746f 6d6f 5f72 6563          tomo_rec
+0000db80: 6f6e 5f63 6f6d 6269 6e65 6420 3d20 6e70  on_combined = np
+0000db90: 2e63 6f6e 6361 7465 6e61 7465 280a 2020  .concatenate(.  
+0000dba0: 2020 2020 2020 2020 2020 2020 2020 5b74                [t
+0000dbb0: 6f6d 6f5f 7265 636f 6e5f 636f 6d62 696e  omo_recon_combin
+0000dbc0: 6564 5d0a 2020 2020 2020 2020 2020 2020  ed].            
+0000dbd0: 2020 2020 2b20 5b6e 7865 6e74 7279 2e72      + [nxentry.r
+0000dbe0: 6563 6f6e 7374 7275 6374 6564 5f64 6174  econstructed_dat
+0000dbf0: 612e 6461 7461 2e72 6563 6f6e 7374 7275  a.data.reconstru
+0000dc00: 6374 6564 5f64 6174 615b 695d 0a20 2020  cted_data[i].   
+0000dc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc20: 666f 7220 6920 696e 2072 616e 6765 2831  for i in range(1
+0000dc30: 2c20 6e75 6d5f 746f 6d6f 5f73 7461 636b  , num_tomo_stack
+0000dc40: 732d 3129 5d29 0a20 2020 2020 2020 2069  s-1)]).        i
+0000dc50: 6620 6e75 6d5f 746f 6d6f 5f73 7461 636b  f num_tomo_stack
+0000dc60: 7320 3e20 313a 0a20 2020 2020 2020 2020  s > 1:.         
+0000dc70: 2020 2074 6f6d 6f5f 7265 636f 6e5f 636f     tomo_recon_co
+0000dc80: 6d62 696e 6564 203d 206e 702e 636f 6e63  mbined = np.conc
+0000dc90: 6174 656e 6174 6528 0a20 2020 2020 2020  atenate(.       
+0000dca0: 2020 2020 2020 2020 205b 746f 6d6f 5f72           [tomo_r
+0000dcb0: 6563 6f6e 5f63 6f6d 6269 6e65 645d 0a20  econ_combined]. 
+0000dcc0: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+0000dcd0: 205b 6e78 656e 7472 792e 7265 636f 6e73   [nxentry.recons
+0000dce0: 7472 7563 7465 645f 6461 7461 2e64 6174  tructed_data.dat
+0000dcf0: 612e 7265 636f 6e73 7472 7563 7465 645f  a.reconstructed_
+0000dd00: 6461 7461 5b0a 2020 2020 2020 2020 2020  data[.          
+0000dd10: 2020 2020 2020 2020 206e 756d 5f74 6f6d           num_tom
+0000dd20: 6f5f 7374 6163 6b73 2d31 5d5d 290a 2020  o_stacks-1]]).  
+0000dd30: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+0000dd40: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
+0000dd50: 2020 2020 2066 2743 6f6d 6269 6e69 6e67       f'Combining
+0000dd60: 2074 6865 2072 6563 6f6e 7374 7275 6374   the reconstruct
+0000dd70: 6564 2073 7461 636b 7320 746f 6f6b 207b  ed stacks took {
+0000dd80: 7469 6d65 2829 2d74 303a 2e32 667d 2073  time()-t0:.2f} s
+0000dd90: 6563 6f6e 6473 2729 0a0a 2020 2020 2020  econds')..      
+0000dda0: 2020 2320 5265 7369 7a65 2074 6865 2063    # Resize the c
+0000ddb0: 6f6d 6269 6e65 6420 746f 6d6f 6772 6170  ombined tomograp
+0000ddc0: 6879 2064 6174 6120 7374 6163 6b73 0a20  hy data stacks. 
+0000ddd0: 2020 2020 2020 2023 2020 2020 2063 6f6d         #     com
+0000dde0: 6269 6e65 6420 6461 7461 206f 7264 6572  bined data order
+0000ddf0: 3a20 726f 772f 7a2c 782c 790a 2020 2020  : row/z,x,y.    
+0000de00: 2020 2020 6966 2073 656c 662e 5f74 6573      if self._tes
+0000de10: 745f 6d6f 6465 3a0a 2020 2020 2020 2020  t_mode:.        
+0000de20: 2020 2020 785f 626f 756e 6473 203d 204e      x_bounds = N
+0000de30: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0000de40: 795f 626f 756e 6473 203d 204e 6f6e 650a  y_bounds = None.
+0000de50: 2020 2020 2020 2020 2020 2020 7a5f 626f              z_bo
+0000de60: 756e 6473 203d 2074 7570 6c65 2873 656c  unds = tuple(sel
+0000de70: 662e 5f74 6573 745f 636f 6e66 6967 2e67  f._test_config.g
+0000de80: 6574 2827 7a5f 626f 756e 6473 2729 290a  et('z_bounds')).
+0000de90: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
+0000dea0: 662e 5f69 6e74 6572 6163 7469 7665 3a0a  f._interactive:.
+0000deb0: 2020 2020 2020 2020 2020 2020 785f 626f              x_bo
+0000dec0: 756e 6473 2c20 795f 626f 756e 6473 2c20  unds, y_bounds, 
+0000ded0: 7a5f 626f 756e 6473 203d 2073 656c 662e  z_bounds = self.
+0000dee0: 5f72 6573 697a 655f 7265 636f 6e73 7472  _resize_reconstr
+0000def0: 7563 7465 645f 6461 7461 280a 2020 2020  ucted_data(.    
+0000df00: 2020 2020 2020 2020 2020 2020 746f 6d6f              tomo
+0000df10: 5f72 6563 6f6e 5f63 6f6d 6269 6e65 642c  _recon_combined,
+0000df20: 207a 5f6f 6e6c 793d 5472 7565 290a 2020   z_only=True).  
+0000df30: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000df40: 2020 2020 2020 2020 6966 2078 5f62 6f75          if x_bou
+0000df50: 6e64 7320 6973 204e 6f6e 653a 0a20 2020  nds is None:.   
+0000df60: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0000df70: 662e 5f6c 6f67 6765 722e 7761 726e 696e  f._logger.warnin
+0000df80: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+0000df90: 2020 2020 2020 2027 785f 626f 756e 6473         'x_bounds
+0000dfa0: 2075 6e73 7065 6369 6669 6564 2c20 7265   unspecified, re
+0000dfb0: 636f 6e73 7472 7563 7420 6461 7461 2066  construct data f
+0000dfc0: 6f72 2066 756c 6c20 782d 7261 6e67 6527  or full x-range'
+0000dfd0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+0000dfe0: 6966 206e 6f74 2069 735f 696e 745f 7061  if not is_int_pa
+0000dff0: 6972 280a 2020 2020 2020 2020 2020 2020  ir(.            
+0000e000: 2020 2020 2020 2020 785f 626f 756e 6473          x_bounds
+0000e010: 2c20 6765 3d30 2c20 6c74 3d74 6f6d 6f5f  , ge=0, lt=tomo_
+0000e020: 7265 636f 6e5f 636f 6d62 696e 6564 2e73  recon_combined.s
+0000e030: 6861 7065 5b31 5d29 3a0a 2020 2020 2020  hape[1]):.      
+0000e040: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000e050: 5661 6c75 6545 7272 6f72 2866 2749 6e76  ValueError(f'Inv
+0000e060: 616c 6964 2070 6172 616d 6574 6572 2078  alid parameter x
+0000e070: 5f62 6f75 6e64 7320 287b 785f 626f 756e  _bounds ({x_boun
+0000e080: 6473 7d29 2729 0a20 2020 2020 2020 2020  ds})').         
+0000e090: 2020 2069 6620 795f 626f 756e 6473 2069     if y_bounds i
+0000e0a0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000e0b0: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+0000e0c0: 6767 6572 2e77 6172 6e69 6e67 280a 2020  gger.warning(.  
+0000e0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e0e0: 2020 2779 5f62 6f75 6e64 7320 756e 7370    'y_bounds unsp
+0000e0f0: 6563 6966 6965 642c 2072 6563 6f6e 7374  ecified, reconst
+0000e100: 7275 6374 2064 6174 6120 666f 7220 6675  ruct data for fu
+0000e110: 6c6c 2079 2d72 616e 6765 2729 0a20 2020  ll y-range').   
+0000e120: 2020 2020 2020 2020 2065 6c69 6620 6e6f           elif no
+0000e130: 7420 6973 5f69 6e74 5f70 6169 7228 0a20  t is_int_pair(. 
+0000e140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e150: 2020 2079 5f62 6f75 6e64 732c 2067 653d     y_bounds, ge=
+0000e160: 302c 206c 743d 746f 6d6f 5f72 6563 6f6e  0, lt=tomo_recon
+0000e170: 5f63 6f6d 6269 6e65 642e 7368 6170 655b  _combined.shape[
+0000e180: 325d 293a 0a20 2020 2020 2020 2020 2020  2]):.           
+0000e190: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+0000e1a0: 4572 726f 7228 6627 496e 7661 6c69 6420  Error(f'Invalid 
+0000e1b0: 7061 7261 6d65 7465 7220 795f 626f 756e  parameter y_boun
+0000e1c0: 6473 2028 7b79 5f62 6f75 6e64 737d 2927  ds ({y_bounds})'
+0000e1d0: 290a 2020 2020 2020 2020 2020 2020 7a5f  ).            z_
+0000e1e0: 626f 756e 6473 203d 204e 6f6e 650a 2020  bounds = None.  
+0000e1f0: 2020 2020 2020 6966 2078 5f62 6f75 6e64        if x_bound
+0000e200: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0000e210: 2020 2020 2020 2078 5f72 616e 6765 203d         x_range =
+0000e220: 2028 302c 2074 6f6d 6f5f 7265 636f 6e5f   (0, tomo_recon_
+0000e230: 636f 6d62 696e 6564 2e73 6861 7065 5b31  combined.shape[1
+0000e240: 5d29 0a20 2020 2020 2020 2020 2020 2078  ]).            x
+0000e250: 5f73 6c69 6365 203d 2069 6e74 2878 5f72  _slice = int(x_r
+0000e260: 616e 6765 5b31 5d2f 3229 0a20 2020 2020  ange[1]/2).     
+0000e270: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000e280: 2020 2020 2078 5f72 616e 6765 203d 2078       x_range = x
+0000e290: 5f62 6f75 6e64 730a 2020 2020 2020 2020  _bounds.        
+0000e2a0: 2020 2020 785f 736c 6963 6520 3d20 696e      x_slice = in
+0000e2b0: 7428 2878 5f62 6f75 6e64 735b 305d 2b78  t((x_bounds[0]+x
+0000e2c0: 5f62 6f75 6e64 735b 315d 2920 2f20 3229  _bounds[1]) / 2)
+0000e2d0: 0a20 2020 2020 2020 2069 6620 795f 626f  .        if y_bo
+0000e2e0: 756e 6473 2069 7320 4e6f 6e65 3a0a 2020  unds is None:.  
+0000e2f0: 2020 2020 2020 2020 2020 795f 7261 6e67            y_rang
+0000e300: 6520 3d20 2830 2c20 746f 6d6f 5f72 6563  e = (0, tomo_rec
+0000e310: 6f6e 5f63 6f6d 6269 6e65 642e 7368 6170  on_combined.shap
+0000e320: 655b 325d 290a 2020 2020 2020 2020 2020  e[2]).          
+0000e330: 2020 795f 736c 6963 6520 3d20 696e 7428    y_slice = int(
+0000e340: 795f 7261 6e67 655b 315d 2f32 290a 2020  y_range[1]/2).  
+0000e350: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000e360: 2020 2020 2020 2020 795f 7261 6e67 6520          y_range 
+0000e370: 3d20 795f 626f 756e 6473 0a20 2020 2020  = y_bounds.     
+0000e380: 2020 2020 2020 2079 5f73 6c69 6365 203d         y_slice =
+0000e390: 2069 6e74 2828 795f 626f 756e 6473 5b30   int((y_bounds[0
+0000e3a0: 5d2b 795f 626f 756e 6473 5b31 5d29 202f  ]+y_bounds[1]) /
+0000e3b0: 2032 290a 2020 2020 2020 2020 6966 207a   2).        if z
+0000e3c0: 5f62 6f75 6e64 7320 6973 204e 6f6e 653a  _bounds is None:
+0000e3d0: 0a20 2020 2020 2020 2020 2020 207a 5f72  .            z_r
+0000e3e0: 616e 6765 203d 2028 302c 2074 6f6d 6f5f  ange = (0, tomo_
+0000e3f0: 7265 636f 6e5f 636f 6d62 696e 6564 2e73  recon_combined.s
+0000e400: 6861 7065 5b30 5d29 0a20 2020 2020 2020  hape[0]).       
+0000e410: 2020 2020 207a 5f73 6c69 6365 203d 2069       z_slice = i
+0000e420: 6e74 287a 5f72 616e 6765 5b31 5d2f 3229  nt(z_range[1]/2)
+0000e430: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0000e440: 2020 2020 2020 2020 2020 207a 5f72 616e             z_ran
+0000e450: 6765 203d 207a 5f62 6f75 6e64 730a 2020  ge = z_bounds.  
+0000e460: 2020 2020 2020 2020 2020 7a5f 736c 6963            z_slic
+0000e470: 6520 3d20 696e 7428 287a 5f62 6f75 6e64  e = int((z_bound
+0000e480: 735b 305d 2b7a 5f62 6f75 6e64 735b 315d  s[0]+z_bounds[1]
+0000e490: 2920 2f20 3229 0a0a 2020 2020 2020 2020  ) / 2)..        
+0000e4a0: 2320 506c 6f74 2061 2066 6577 2063 6f6d  # Plot a few com
+0000e4b0: 6269 6e65 6420 696d 6167 6520 736c 6963  bined image slic
+0000e4c0: 6573 0a20 2020 2020 2020 2069 6620 7365  es.        if se
+0000e4d0: 6c66 2e5f 7361 7665 5f66 6967 733a 0a20  lf._save_figs:. 
+0000e4e0: 2020 2020 2020 2020 2020 2078 5f70 6978             x_pix
+0000e4f0: 656c 5f73 697a 6520 3d20 6e78 656e 7472  el_size = nxentr
+0000e500: 792e 696e 7374 7275 6d65 6e74 2e64 6574  y.instrument.det
+0000e510: 6563 746f 722e 785f 7069 7865 6c5f 7369  ector.x_pixel_si
+0000e520: 7a65 0a20 2020 2020 2020 2020 2020 2079  ze.            y
+0000e530: 5f70 6978 656c 5f73 697a 6520 3d20 6e78  _pixel_size = nx
+0000e540: 656e 7472 792e 696e 7374 7275 6d65 6e74  entry.instrument
+0000e550: 2e64 6574 6563 746f 722e 795f 7069 7865  .detector.y_pixe
+0000e560: 6c5f 7369 7a65 0a20 2020 2020 2020 2020  l_size.         
+0000e570: 2020 2065 7874 656e 7420 3d20 280a 2020     extent = (.  
+0000e580: 2020 2020 2020 2020 2020 2020 2020 302c                0,
+0000e590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e5a0: 2066 6c6f 6174 2879 5f70 6978 656c 5f73   float(y_pixel_s
+0000e5b0: 697a 652a 746f 6d6f 5f72 6563 6f6e 5f63  ize*tomo_recon_c
+0000e5c0: 6f6d 6269 6e65 642e 7368 6170 655b 325d  ombined.shape[2]
+0000e5d0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0000e5e0: 2020 2066 6c6f 6174 2878 5f70 6978 656c     float(x_pixel
+0000e5f0: 5f73 697a 652a 746f 6d6f 5f72 6563 6f6e  _size*tomo_recon
+0000e600: 5f63 6f6d 6269 6e65 642e 7368 6170 655b  _combined.shape[
+0000e610: 305d 292c 0a20 2020 2020 2020 2020 2020  0]),.           
+0000e620: 2020 2020 2030 290a 2020 2020 2020 2020       0).        
+0000e630: 2020 2020 7175 6963 6b5f 696d 7368 6f77      quick_imshow
+0000e640: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000e650: 2020 746f 6d6f 5f72 6563 6f6e 5f63 6f6d    tomo_recon_com
+0000e660: 6269 6e65 645b 0a20 2020 2020 2020 2020  bined[.         
+0000e670: 2020 2020 2020 2020 2020 207a 5f72 616e             z_ran
+0000e680: 6765 5b30 5d3a 7a5f 7261 6e67 655b 315d  ge[0]:z_range[1]
+0000e690: 2c78 5f73 6c69 6365 2c79 5f72 616e 6765  ,x_slice,y_range
+0000e6a0: 5b30 5d3a 795f 7261 6e67 655b 315d 5d2c  [0]:y_range[1]],
+0000e6b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e6c0: 2074 6974 6c65 3d66 2772 6563 6f6e 2063   title=f'recon c
+0000e6d0: 6f6d 6269 6e65 6420 7873 6c69 6365 7b78  ombined xslice{x
+0000e6e0: 5f73 6c69 6365 7d27 2c20 6578 7465 6e74  _slice}', extent
+0000e6f0: 3d65 7874 656e 742c 0a20 2020 2020 2020  =extent,.       
+0000e700: 2020 2020 2020 2020 2070 6174 683d 7365           path=se
+0000e710: 6c66 2e5f 6f75 7470 7574 5f66 6f6c 6465  lf._output_folde
+0000e720: 722c 2073 6176 655f 6669 673d 5472 7565  r, save_fig=True
+0000e730: 2c20 7361 7665 5f6f 6e6c 793d 5472 7565  , save_only=True
+0000e740: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
+0000e750: 7465 6e74 203d 2028 0a20 2020 2020 2020  tent = (.       
+0000e760: 2020 2020 2020 2020 2030 2c0a 2020 2020           0,.    
+0000e770: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+0000e780: 7428 795f 7069 7865 6c5f 7369 7a65 2a74  t(y_pixel_size*t
+0000e790: 6f6d 6f5f 7265 636f 6e5f 636f 6d62 696e  omo_recon_combin
+0000e7a0: 6564 2e73 6861 7065 5b31 5d29 2c0a 2020  ed.shape[1]),.  
+0000e7b0: 2020 2020 2020 2020 2020 2020 2020 666c                fl
+0000e7c0: 6f61 7428 785f 7069 7865 6c5f 7369 7a65  oat(x_pixel_size
+0000e7d0: 2a74 6f6d 6f5f 7265 636f 6e5f 636f 6d62  *tomo_recon_comb
+0000e7e0: 696e 6564 2e73 6861 7065 5b30 5d29 2c0a  ined.shape[0]),.
+0000e7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e800: 3029 0a20 2020 2020 2020 2020 2020 2071  0).            q
+0000e810: 7569 636b 5f69 6d73 686f 7728 0a20 2020  uick_imshow(.   
+0000e820: 2020 2020 2020 2020 2020 2020 2074 6f6d               tom
+0000e830: 6f5f 7265 636f 6e5f 636f 6d62 696e 6564  o_recon_combined
+0000e840: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+0000e850: 2020 2020 2020 7a5f 7261 6e67 655b 305d        z_range[0]
+0000e860: 3a7a 5f72 616e 6765 5b31 5d2c 785f 7261  :z_range[1],x_ra
+0000e870: 6e67 655b 305d 3a78 5f72 616e 6765 5b31  nge[0]:x_range[1
+0000e880: 5d2c 795f 736c 6963 655d 2c0a 2020 2020  ],y_slice],.    
+0000e890: 2020 2020 2020 2020 2020 2020 7469 746c              titl
+0000e8a0: 653d 6627 7265 636f 6e20 636f 6d62 696e  e=f'recon combin
+0000e8b0: 6564 2079 736c 6963 657b 795f 736c 6963  ed yslice{y_slic
+0000e8c0: 657d 272c 2065 7874 656e 743d 6578 7465  e}', extent=exte
+0000e8d0: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+0000e8e0: 2020 2020 7061 7468 3d73 656c 662e 5f6f      path=self._o
+0000e8f0: 7574 7075 745f 666f 6c64 6572 2c20 7361  utput_folder, sa
+0000e900: 7665 5f66 6967 3d54 7275 652c 2073 6176  ve_fig=True, sav
+0000e910: 655f 6f6e 6c79 3d54 7275 6529 0a20 2020  e_only=True).   
+0000e920: 2020 2020 2020 2020 2065 7874 656e 7420           extent 
+0000e930: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0000e940: 2020 2020 302c 0a20 2020 2020 2020 2020      0,.         
+0000e950: 2020 2020 2020 2066 6c6f 6174 2879 5f70         float(y_p
+0000e960: 6978 656c 5f73 697a 652a 746f 6d6f 5f72  ixel_size*tomo_r
+0000e970: 6563 6f6e 5f63 6f6d 6269 6e65 642e 7368  econ_combined.sh
+0000e980: 6170 655b 325d 292c 0a20 2020 2020 2020  ape[2]),.       
+0000e990: 2020 2020 2020 2020 2066 6c6f 6174 2879           float(y
+0000e9a0: 5f70 6978 656c 5f73 697a 652a 746f 6d6f  _pixel_size*tomo
+0000e9b0: 5f72 6563 6f6e 5f63 6f6d 6269 6e65 642e  _recon_combined.
+0000e9c0: 7368 6170 655b 315d 292c 0a20 2020 2020  shape[1]),.     
+0000e9d0: 2020 2020 2020 2020 2020 2030 290a 2020             0).  
+0000e9e0: 2020 2020 2020 2020 2020 7175 6963 6b5f            quick_
+0000e9f0: 696d 7368 6f77 280a 2020 2020 2020 2020  imshow(.        
+0000ea00: 2020 2020 2020 2020 746f 6d6f 5f72 6563          tomo_rec
+0000ea10: 6f6e 5f63 6f6d 6269 6e65 645b 0a20 2020  on_combined[.   
+0000ea20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea30: 207a 5f73 6c69 6365 2c78 5f72 616e 6765   z_slice,x_range
+0000ea40: 5b30 5d3a 785f 7261 6e67 655b 315d 2c79  [0]:x_range[1],y
+0000ea50: 5f72 616e 6765 5b30 5d3a 795f 7261 6e67  _range[0]:y_rang
+0000ea60: 655b 315d 5d2c 0a20 2020 2020 2020 2020  e[1]],.         
+0000ea70: 2020 2020 2020 2074 6974 6c65 3d66 2772         title=f'r
+0000ea80: 6563 6f6e 2063 6f6d 6269 6e65 6420 7a73  econ combined zs
+0000ea90: 6c69 6365 7b7a 5f73 6c69 6365 7d27 2c20  lice{z_slice}', 
+0000eaa0: 6578 7465 6e74 3d65 7874 656e 742c 0a20  extent=extent,. 
+0000eab0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0000eac0: 6174 683d 7365 6c66 2e5f 6f75 7470 7574  ath=self._output
+0000ead0: 5f66 6f6c 6465 722c 2073 6176 655f 6669  _folder, save_fi
+0000eae0: 673d 5472 7565 2c20 7361 7665 5f6f 6e6c  g=True, save_onl
+0000eaf0: 793d 5472 7565 290a 0a20 2020 2020 2020  y=True)..       
+0000eb00: 2023 2053 6176 6520 7465 7374 2064 6174   # Save test dat
+0000eb10: 6120 746f 2066 696c 650a 2020 2020 2020  a to file.      
+0000eb20: 2020 2320 2020 2020 636f 6d62 696e 6564    #     combined
+0000eb30: 2064 6174 6120 6f72 6465 723a 2072 6f77   data order: row
+0000eb40: 2f7a 2c78 2c79 0a20 2020 2020 2020 2069  /z,x,y.        i
+0000eb50: 6620 7365 6c66 2e5f 7465 7374 5f6d 6f64  f self._test_mod
+0000eb60: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
+0000eb70: 702e 7361 7665 7478 7428 0a20 2020 2020  p.savetxt(.     
+0000eb80: 2020 2020 2020 2020 2020 2066 277b 7365             f'{se
+0000eb90: 6c66 2e5f 6f75 7470 7574 5f66 6f6c 6465  lf._output_folde
+0000eba0: 727d 2f72 6563 6f6e 5f63 6f6d 6269 6e65  r}/recon_combine
+0000ebb0: 642e 7478 7427 2c0a 2020 2020 2020 2020  d.txt',.        
+0000ebc0: 2020 2020 2020 2020 746f 6d6f 5f72 6563          tomo_rec
+0000ebd0: 6f6e 5f63 6f6d 6269 6e65 645b 0a20 2020  on_combined[.   
+0000ebe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ebf0: 207a 5f73 6c69 6365 2c78 5f72 616e 6765   z_slice,x_range
+0000ec00: 5b30 5d3a 785f 7261 6e67 655b 315d 2c79  [0]:x_range[1],y
+0000ec10: 5f72 616e 6765 5b30 5d3a 795f 7261 6e67  _range[0]:y_rang
+0000ec20: 655b 315d 5d2c 0a20 2020 2020 2020 2020  e[1]],.         
+0000ec30: 2020 2020 2020 2066 6d74 3d27 252e 3665         fmt='%.6e
+0000ec40: 2729 0a0a 2020 2020 2020 2020 2320 4164  ')..        # Ad
+0000ec50: 6420 696d 6167 6520 7265 636f 6e73 7472  d image reconstr
+0000ec60: 7563 7469 6f6e 2074 6f20 7265 636f 6e73  uction to recons
+0000ec70: 7472 7563 7465 6420 6461 7461 204e 5870  tructed data NXp
+0000ec80: 726f 6365 7373 0a20 2020 2020 2020 2023  rocess.        #
+0000ec90: 2020 2020 2063 6f6d 6269 6e65 6420 6461       combined da
+0000eca0: 7461 206f 7264 6572 3a20 726f 772f 7a2c  ta order: row/z,
+0000ecb0: 782c 790a 2020 2020 2020 2020 6e78 7072  x,y.        nxpr
+0000ecc0: 6f63 6573 732e 6461 7461 203d 204e 5864  ocess.data = NXd
+0000ecd0: 6174 6128 290a 2020 2020 2020 2020 6e78  ata().        nx
+0000ece0: 7072 6f63 6573 732e 6174 7472 735b 2764  process.attrs['d
+0000ecf0: 6566 6175 6c74 275d 203d 2027 6461 7461  efault'] = 'data
+0000ed00: 270a 2020 2020 2020 2020 6966 2078 5f62  '.        if x_b
+0000ed10: 6f75 6e64 7320 6973 206e 6f74 204e 6f6e  ounds is not Non
+0000ed20: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
+0000ed30: 7870 726f 6365 7373 2e78 5f62 6f75 6e64  xprocess.x_bound
+0000ed40: 7320 3d20 785f 626f 756e 6473 0a20 2020  s = x_bounds.   
+0000ed50: 2020 2020 2069 6620 795f 626f 756e 6473       if y_bounds
+0000ed60: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0000ed70: 2020 2020 2020 2020 2020 6e78 7072 6f63            nxproc
+0000ed80: 6573 732e 795f 626f 756e 6473 203d 2079  ess.y_bounds = y
+0000ed90: 5f62 6f75 6e64 730a 2020 2020 2020 2020  _bounds.        
+0000eda0: 6966 207a 5f62 6f75 6e64 7320 6973 206e  if z_bounds is n
+0000edb0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0000edc0: 2020 2020 206e 7870 726f 6365 7373 2e7a       nxprocess.z
+0000edd0: 5f62 6f75 6e64 7320 3d20 7a5f 626f 756e  _bounds = z_boun
+0000ede0: 6473 0a20 2020 2020 2020 206e 7870 726f  ds.        nxpro
+0000edf0: 6365 7373 2e64 6174 615b 2763 6f6d 6269  cess.data['combi
+0000ee00: 6e65 645f 6461 7461 275d 203d 2074 6f6d  ned_data'] = tom
+0000ee10: 6f5f 7265 636f 6e5f 636f 6d62 696e 6564  o_recon_combined
+0000ee20: 5b0a 2020 2020 2020 2020 2020 2020 7a5f  [.            z_
+0000ee30: 7261 6e67 655b 305d 3a7a 5f72 616e 6765  range[0]:z_range
+0000ee40: 5b31 5d2c 785f 7261 6e67 655b 305d 3a78  [1],x_range[0]:x
+0000ee50: 5f72 616e 6765 5b31 5d2c 795f 7261 6e67  _range[1],y_rang
+0000ee60: 655b 305d 3a79 5f72 616e 6765 5b31 5d5d  e[0]:y_range[1]]
+0000ee70: 0a20 2020 2020 2020 206e 7870 726f 6365  .        nxproce
+0000ee80: 7373 2e64 6174 612e 6174 7472 735b 2773  ss.data.attrs['s
+0000ee90: 6967 6e61 6c27 5d20 3d20 2763 6f6d 6269  ignal'] = 'combi
+0000eea0: 6e65 645f 6461 7461 270a 0a20 2020 2020  ned_data'..     
+0000eeb0: 2020 2023 2043 7265 6174 6520 6120 636f     # Create a co
+0000eec0: 7079 206f 6620 7468 6520 696e 7075 7420  py of the input 
+0000eed0: 4e65 7875 7320 6f62 6a65 6374 2061 6e64  Nexus object and
+0000eee0: 2072 656d 6f76 650a 2020 2020 2020 2020   remove.        
+0000eef0: 2320 2020 2020 7265 636f 6e73 7472 7563  #     reconstruc
+0000ef00: 7465 6420 6461 7461 0a20 2020 2020 2020  ted data.       
+0000ef10: 2065 7863 6c75 6465 5f69 7465 6d73 203d   exclude_items =
+0000ef20: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+0000ef30: 277b 6e78 656e 7472 792e 6e78 6e61 6d65  '{nxentry.nxname
+0000ef40: 7d2f 7265 636f 6e73 7472 7563 7465 645f  }/reconstructed_
+0000ef50: 6461 7461 2f64 6174 6127 2c0a 2020 2020  data/data',.    
+0000ef60: 2020 2020 2020 2020 6627 7b6e 7865 6e74          f'{nxent
+0000ef70: 7279 2e6e 786e 616d 657d 2f64 6174 612f  ry.nxname}/data/
+0000ef80: 7265 636f 6e73 7472 7563 7465 645f 6461  reconstructed_da
+0000ef90: 7461 272c 0a20 2020 2020 2020 205d 0a20  ta',.        ]. 
+0000efa0: 2020 2020 2020 206e 7872 6f6f 745f 636f         nxroot_co
+0000efb0: 7079 203d 206e 7863 6f70 7928 6e78 726f  py = nxcopy(nxro
+0000efc0: 6f74 2c20 6578 636c 7564 655f 6e78 7061  ot, exclude_nxpa
+0000efd0: 7468 733d 6578 636c 7564 655f 6974 656d  ths=exclude_item
+0000efe0: 7329 0a0a 2020 2020 2020 2020 2320 4164  s)..        # Ad
+0000eff0: 6420 7468 6520 636f 6d62 696e 6564 2064  d the combined d
+0000f000: 6174 6120 4e58 7072 6f63 6573 7320 746f  ata NXprocess to
+0000f010: 2074 6865 206e 6577 204e 6578 7573 206f   the new Nexus o
+0000f020: 626a 6563 740a 2020 2020 2020 2020 6e78  bject.        nx
+0000f030: 656e 7472 795f 636f 7079 203d 206e 7872  entry_copy = nxr
+0000f040: 6f6f 745f 636f 7079 5b6e 7872 6f6f 745f  oot_copy[nxroot_
+0000f050: 636f 7079 2e61 7474 7273 5b27 6465 6661  copy.attrs['defa
+0000f060: 756c 7427 5d5d 0a20 2020 2020 2020 206e  ult']].        n
+0000f070: 7865 6e74 7279 5f63 6f70 792e 636f 6d62  xentry_copy.comb
+0000f080: 696e 6564 5f64 6174 6120 3d20 6e78 7072  ined_data = nxpr
+0000f090: 6f63 6573 730a 2020 2020 2020 2020 6966  ocess.        if
+0000f0a0: 2027 6461 7461 2720 6e6f 7420 696e 206e   'data' not in n
+0000f0b0: 7865 6e74 7279 5f63 6f70 793a 0a20 2020  xentry_copy:.   
+0000f0c0: 2020 2020 2020 2020 206e 7865 6e74 7279           nxentry
+0000f0d0: 5f63 6f70 792e 6461 7461 203d 204e 5864  _copy.data = NXd
+0000f0e0: 6174 6128 290a 2020 2020 2020 2020 6e78  ata().        nx
+0000f0f0: 656e 7472 795f 636f 7079 2e61 7474 7273  entry_copy.attrs
+0000f100: 5b27 6465 6661 756c 7427 5d20 3d20 2764  ['default'] = 'd
+0000f110: 6174 6127 0a20 2020 2020 2020 206e 7865  ata'.        nxe
+0000f120: 6e74 7279 5f63 6f70 792e 6461 7461 2e6d  ntry_copy.data.m
+0000f130: 616b 656c 696e 6b28 0a20 2020 2020 2020  akelink(.       
+0000f140: 2020 2020 206e 7870 726f 6365 7373 2e64       nxprocess.d
+0000f150: 6174 612e 636f 6d62 696e 6564 5f64 6174  ata.combined_dat
+0000f160: 612c 206e 616d 653d 2763 6f6d 6269 6e65  a, name='combine
+0000f170: 645f 6461 7461 2729 0a20 2020 2020 2020  d_data').       
+0000f180: 206e 7865 6e74 7279 5f63 6f70 792e 6461   nxentry_copy.da
+0000f190: 7461 2e61 7474 7273 5b27 7369 676e 616c  ta.attrs['signal
+0000f1a0: 275d 203d 2027 636f 6d62 696e 6564 5f64  '] = 'combined_d
+0000f1b0: 6174 6127 0a0a 2020 2020 2020 2020 7265  ata'..        re
+0000f1c0: 7475 726e 206e 7872 6f6f 745f 636f 7079  turn nxroot_copy
+0000f1d0: 0a0a 2020 2020 6465 6620 5f67 656e 5f64  ..    def _gen_d
+0000f1e0: 6172 6b28 7365 6c66 2c20 6e78 656e 7472  ark(self, nxentr
+0000f1f0: 792c 2072 6564 7563 6564 5f64 6174 6129  y, reduced_data)
+0000f200: 3a0a 2020 2020 2020 2020 2222 2247 656e  :.        """Gen
+0000f210: 6572 6174 6520 6461 726b 2066 6965 6c64  erate dark field
+0000f220: 2e22 2222 0a20 2020 2020 2020 2023 2054  .""".        # T
+0000f230: 6869 7264 2070 6172 7479 206d 6f64 756c  hird party modul
+0000f240: 6573 0a20 2020 2020 2020 2066 726f 6d20  es.        from 
+0000f250: 6e65 7875 7366 6f72 6d61 742e 6e65 7875  nexusformat.nexu
+0000f260: 7320 696d 706f 7274 204e 5864 6174 610a  s import NXdata.
+0000f270: 0a20 2020 2020 2020 2023 204c 6f63 616c  .        # Local
+0000f280: 206d 6f64 756c 6573 0a20 2020 2020 2020   modules.       
+0000f290: 2066 726f 6d20 4348 4150 2e63 6f6d 6d6f   from CHAP.commo
+0000f2a0: 6e2e 6d6f 6465 6c73 2e6d 6170 2069 6d70  n.models.map imp
+0000f2b0: 6f72 7420 280a 2020 2020 2020 2020 2020  ort (.          
+0000f2c0: 2020 6765 745f 7363 616e 7061 7273 6572    get_scanparser
+0000f2d0: 2c0a 2020 2020 2020 2020 2020 2020 696d  ,.            im
+0000f2e0: 706f 7274 5f73 6361 6e70 6172 7365 722c  port_scanparser,
+0000f2f0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000f300: 2020 2020 2320 4765 7420 7468 6520 6461      # Get the da
+0000f310: 726b 2066 6965 6c64 2069 6d61 6765 730a  rk field images.
+0000f320: 2020 2020 2020 2020 696d 6167 655f 6b65          image_ke
+0000f330: 7920 3d20 6e78 656e 7472 792e 696e 7374  y = nxentry.inst
+0000f340: 7275 6d65 6e74 2e64 6574 6563 746f 722e  rument.detector.
+0000f350: 6765 7428 2769 6d61 6765 5f6b 6579 272c  get('image_key',
+0000f360: 204e 6f6e 6529 0a20 2020 2020 2020 2069   None).        i
+0000f370: 6620 696d 6167 655f 6b65 7920 6973 206e  f image_key is n
+0000f380: 6f74 204e 6f6e 6520 616e 6420 2764 6174  ot None and 'dat
+0000f390: 6127 2069 6e20 6e78 656e 7472 792e 696e  a' in nxentry.in
+0000f3a0: 7374 7275 6d65 6e74 2e64 6574 6563 746f  strument.detecto
+0000f3b0: 723a 0a20 2020 2020 2020 2020 2020 2066  r:.            f
+0000f3c0: 6965 6c64 5f69 6e64 6963 6573 203d 205b  ield_indices = [
+0000f3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f3e0: 2069 6e64 6578 2066 6f72 2069 6e64 6578   index for index
+0000f3f0: 2c20 6b65 7920 696e 2065 6e75 6d65 7261  , key in enumera
+0000f400: 7465 2869 6d61 6765 5f6b 6579 2920 6966  te(image_key) if
+0000f410: 206b 6579 203d 3d20 325d 0a20 2020 2020   key == 2].     
+0000f420: 2020 2020 2020 2074 6466 5f73 7461 636b         tdf_stack
+0000f430: 203d 206e 7865 6e74 7279 2e69 6e73 7472   = nxentry.instr
+0000f440: 756d 656e 742e 6465 7465 6374 6f72 2e64  ument.detector.d
+0000f450: 6174 615b 6669 656c 645f 696e 6469 6365  ata[field_indice
+0000f460: 732c 3a2c 3a5d 0a20 2020 2020 2020 2020  s,:,:].         
+0000f470: 2020 2023 2052 5620 7468 6520 6465 6661     # RV the defa
+0000f480: 756c 7420 4e58 746f 6d6f 2066 6f72 6d20  ult NXtomo form 
+0000f490: 646f 6573 206e 6f74 2061 6363 6f6d 6f64  does not accomod
+0000f4a0: 6174 6520 6461 726b 2066 6965 6c64 0a20  ate dark field. 
+0000f4b0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+0000f4c0: 2073 7461 636b 730a 2020 2020 2020 2020   stacks.        
+0000f4d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000f4e0: 2020 696d 706f 7274 5f73 6361 6e70 6172    import_scanpar
+0000f4f0: 7365 7228 0a20 2020 2020 2020 2020 2020  ser(.           
+0000f500: 2020 2020 206e 7865 6e74 7279 2e69 6e73       nxentry.ins
+0000f510: 7472 756d 656e 742e 736f 7572 6365 2e61  trument.source.a
+0000f520: 7474 7273 5b27 7374 6174 696f 6e27 5d2c  ttrs['station'],
+0000f530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f540: 206e 7865 6e74 7279 2e69 6e73 7472 756d   nxentry.instrum
+0000f550: 656e 742e 736f 7572 6365 2e61 7474 7273  ent.source.attrs
+0000f560: 5b27 6578 7065 7269 6d65 6e74 5f74 7970  ['experiment_typ
+0000f570: 6527 5d29 0a20 2020 2020 2020 2020 2020  e']).           
+0000f580: 2064 6172 6b5f 6669 656c 645f 7363 616e   dark_field_scan
+0000f590: 7320 3d20 6e78 656e 7472 792e 7370 6563  s = nxentry.spec
+0000f5a0: 5f73 6361 6e73 2e64 6172 6b5f 6669 656c  _scans.dark_fiel
+0000f5b0: 640a 2020 2020 2020 2020 2020 2020 6465  d.            de
+0000f5c0: 7465 6374 6f72 5f70 7265 6669 7820 3d20  tector_prefix = 
+0000f5d0: 7374 7228 6e78 656e 7472 792e 696e 7374  str(nxentry.inst
+0000f5e0: 7275 6d65 6e74 2e64 6574 6563 746f 722e  rument.detector.
+0000f5f0: 6c6f 6361 6c5f 6e61 6d65 290a 2020 2020  local_name).    
+0000f600: 2020 2020 2020 2020 7464 665f 7374 6163          tdf_stac
+0000f610: 6b20 3d20 5b5d 0a20 2020 2020 2020 2020  k = [].         
+0000f620: 2020 2066 6f72 206e 7873 7562 656e 7472     for nxsubentr
+0000f630: 795f 6e61 6d65 2c20 6e78 7375 6265 6e74  y_name, nxsubent
+0000f640: 7279 2069 6e20 6461 726b 5f66 6965 6c64  ry in dark_field
+0000f650: 5f73 6361 6e73 2e69 7465 6d73 2829 3a0a  _scans.items():.
+0000f660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f670: 7363 616e 5f6e 756d 6265 7220 3d20 696e  scan_number = in
+0000f680: 7428 6e78 7375 6265 6e74 7279 5f6e 616d  t(nxsubentry_nam
+0000f690: 652e 7370 6c69 7428 275f 2729 5b2d 315d  e.split('_')[-1]
+0000f6a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000f6b0: 2020 7363 616e 7061 7273 6572 203d 2067    scanparser = g
+0000f6c0: 6574 5f73 6361 6e70 6172 7365 7228 0a20  et_scanparser(. 
+0000f6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f6e0: 2020 2064 6172 6b5f 6669 656c 645f 7363     dark_field_sc
+0000f6f0: 616e 732e 6174 7472 735b 2773 7065 635f  ans.attrs['spec_
+0000f700: 6669 6c65 275d 2c20 7363 616e 5f6e 756d  file'], scan_num
+0000f710: 6265 7229 0a20 2020 2020 2020 2020 2020  ber).           
+0000f720: 2020 2020 2069 6d61 6765 5f6f 6666 7365       image_offse
+0000f730: 7420 3d20 696e 7428 0a20 2020 2020 2020  t = int(.       
+0000f740: 2020 2020 2020 2020 2020 2020 206e 7873               nxs
+0000f750: 7562 656e 7472 792e 696e 7374 7275 6d65  ubentry.instrume
+0000f760: 6e74 2e64 6574 6563 746f 722e 6672 616d  nt.detector.fram
+0000f770: 655f 7374 6172 745f 6e75 6d62 6572 290a  e_start_number).
+0000f780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f790: 6e75 6d5f 696d 6167 6520 3d20 6c65 6e28  num_image = len(
+0000f7a0: 6e78 7375 6265 6e74 7279 2e73 616d 706c  nxsubentry.sampl
+0000f7b0: 652e 726f 7461 7469 6f6e 5f61 6e67 6c65  e.rotation_angle
+0000f7c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000f7d0: 2020 7464 665f 7374 6163 6b2e 6170 7065    tdf_stack.appe
+0000f7e0: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
+0000f7f0: 2020 2020 2020 2020 7363 616e 7061 7273          scanpars
+0000f800: 6572 2e67 6574 5f64 6574 6563 746f 725f  er.get_detector_
+0000f810: 6461 7461 280a 2020 2020 2020 2020 2020  data(.          
+0000f820: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0000f830: 7465 6374 6f72 5f70 7265 6669 782c 0a20  tector_prefix,. 
+0000f840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f850: 2020 2020 2020 2028 696d 6167 655f 6f66         (image_of
+0000f860: 6673 6574 2c20 696d 6167 655f 6f66 6673  fset, image_offs
+0000f870: 6574 2b6e 756d 5f69 6d61 6765 2929 290a  et+num_image))).
+0000f880: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+0000f890: 7369 6e73 7461 6e63 6528 7464 665f 7374  sinstance(tdf_st
+0000f8a0: 6163 6b2c 206c 6973 7429 3a0a 2020 2020  ack, list):.    
+0000f8b0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0000f8c0: 7274 206c 656e 2874 6466 5f73 7461 636b  rt len(tdf_stack
+0000f8d0: 2920 3d3d 2031 2020 2320 5256 0a20 2020  ) == 1  # RV.   
+0000f8e0: 2020 2020 2020 2020 2020 2020 2074 6466               tdf
+0000f8f0: 5f73 7461 636b 203d 2074 6466 5f73 7461  _stack = tdf_sta
+0000f900: 636b 5b30 5d0a 0a20 2020 2020 2020 2023  ck[0]..        #
+0000f910: 2054 616b 6520 6d65 6469 616e 0a20 2020   Take median.   
+0000f920: 2020 2020 2069 6620 7464 665f 7374 6163       if tdf_stac
+0000f930: 6b2e 6e64 696d 203d 3d20 323a 0a20 2020  k.ndim == 2:.   
+0000f940: 2020 2020 2020 2020 2074 6466 203d 2074           tdf = t
+0000f950: 6466 5f73 7461 636b 0a20 2020 2020 2020  df_stack.       
+0000f960: 2065 6c69 6620 7464 665f 7374 6163 6b2e   elif tdf_stack.
+0000f970: 6e64 696d 203d 3d20 333a 0a20 2020 2020  ndim == 3:.     
+0000f980: 2020 2020 2020 2074 6466 203d 206e 702e         tdf = np.
+0000f990: 6d65 6469 616e 2874 6466 5f73 7461 636b  median(tdf_stack
+0000f9a0: 2c20 6178 6973 3d30 290a 2020 2020 2020  , axis=0).      
+0000f9b0: 2020 2020 2020 6465 6c20 7464 665f 7374        del tdf_st
+0000f9c0: 6163 6b0a 2020 2020 2020 2020 656c 7365  ack.        else
+0000f9d0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0000f9e0: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
+0000f9f0: 2866 2749 6e76 616c 6964 2074 6466 5f73  (f'Invalid tdf_s
+0000fa00: 7461 636b 2073 6861 7065 2028 7b74 6466  tack shape ({tdf
+0000fa10: 5f73 7461 636b 2e73 6861 7065 7d29 2729  _stack.shape})')
+0000fa20: 0a0a 2020 2020 2020 2020 2320 5265 6d6f  ..        # Remo
+0000fa30: 7665 2064 6172 6b20 6669 656c 6420 696e  ve dark field in
+0000fa40: 7465 6e73 6974 6965 7320 6162 6f76 6520  tensities above 
+0000fa50: 7468 6520 6375 746f 6666 0a23 2020 2020  the cutoff.#    
+0000fa60: 2020 2020 7464 665f 6375 746f 6666 203d      tdf_cutoff =
+0000fa70: 204e 6f6e 650a 2020 2020 2020 2020 7464   None.        td
+0000fa80: 665f 6375 746f 6666 203d 2074 6466 2e6d  f_cutoff = tdf.m
+0000fa90: 696e 2829 202b 2032 202a 2028 6e70 2e6d  in() + 2 * (np.m
+0000faa0: 6564 6961 6e28 7464 6629 2d74 6466 2e6d  edian(tdf)-tdf.m
+0000fab0: 696e 2829 290a 2020 2020 2020 2020 7365  in()).        se
+0000fac0: 6c66 2e5f 6c6f 6767 6572 2e64 6562 7567  lf._logger.debug
+0000fad0: 2866 2774 6466 5f63 7574 6f66 6620 3d20  (f'tdf_cutoff = 
+0000fae0: 7b74 6466 5f63 7574 6f66 667d 2729 0a20  {tdf_cutoff}'). 
+0000faf0: 2020 2020 2020 2069 6620 7464 665f 6375         if tdf_cu
+0000fb00: 746f 6666 2069 7320 6e6f 7420 4e6f 6e65  toff is not None
+0000fb10: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0000fb20: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+0000fb30: 7464 665f 6375 746f 6666 2c20 2869 6e74  tdf_cutoff, (int
+0000fb40: 2c20 666c 6f61 7429 2920 6f72 2074 6466  , float)) or tdf
+0000fb50: 5f63 7574 6f66 6620 3c20 303a 0a20 2020  _cutoff < 0:.   
+0000fb60: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0000fb70: 662e 5f6c 6f67 6765 722e 7761 726e 696e  f._logger.warnin
+0000fb80: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+0000fb90: 2020 2020 2020 2066 2749 676e 6f72 696e         f'Ignorin
+0000fba0: 6720 696c 6c65 6761 6c20 7661 6c75 6520  g illegal value 
+0000fbb0: 6f66 2074 6466 5f63 7574 6f66 6620 7b74  of tdf_cutoff {t
+0000fbc0: 6466 5f63 7574 6f66 667d 2729 0a20 2020  df_cutoff}').   
+0000fbd0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000fbe0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000fbf0: 6466 5b74 6466 203e 2074 6466 5f63 7574  df[tdf > tdf_cut
+0000fc00: 6f66 665d 203d 206e 702e 6e61 6e0a 2020  off] = np.nan.  
+0000fc10: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000fc20: 6c66 2e5f 6c6f 6767 6572 2e64 6562 7567  lf._logger.debug
+0000fc30: 2866 2774 6466 5f63 7574 6f66 6620 3d20  (f'tdf_cutoff = 
+0000fc40: 7b74 6466 5f63 7574 6f66 667d 2729 0a0a  {tdf_cutoff}')..
+0000fc50: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
+0000fc60: 206e 616e 730a 2020 2020 2020 2020 7464   nans.        td
+0000fc70: 665f 6d65 616e 203d 206e 702e 6e61 6e6d  f_mean = np.nanm
+0000fc80: 6561 6e28 7464 6629 0a20 2020 2020 2020  ean(tdf).       
+0000fc90: 2073 656c 662e 5f6c 6f67 6765 722e 6465   self._logger.de
+0000fca0: 6275 6728 6627 7464 665f 6d65 616e 203d  bug(f'tdf_mean =
+0000fcb0: 207b 7464 665f 6d65 616e 7d27 290a 2020   {tdf_mean}').  
+0000fcc0: 2020 2020 2020 6e70 2e6e 616e 5f74 6f5f        np.nan_to_
+0000fcd0: 6e75 6d28 0a20 2020 2020 2020 2020 2020  num(.           
+0000fce0: 2074 6466 2c20 636f 7079 3d46 616c 7365   tdf, copy=False
+0000fcf0: 2c20 6e61 6e3d 7464 665f 6d65 616e 2c20  , nan=tdf_mean, 
+0000fd00: 706f 7369 6e66 3d74 6466 5f6d 6561 6e2c  posinf=tdf_mean,
+0000fd10: 206e 6567 696e 663d 302e 290a 0a20 2020   neginf=0.)..   
+0000fd20: 2020 2020 2023 2050 6c6f 7420 6461 726b       # Plot dark
+0000fd30: 2066 6965 6c64 0a20 2020 2020 2020 2069   field.        i
+0000fd40: 6620 7365 6c66 2e5f 7361 7665 5f66 6967  f self._save_fig
+0000fd50: 733a 0a20 2020 2020 2020 2020 2020 2065  s:.            e
+0000fd60: 7874 656e 7420 3d20 280a 2020 2020 2020  xtent = (.      
+0000fd70: 2020 2020 2020 2020 2020 302c 0a20 2020            0,.   
+0000fd80: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
+0000fd90: 6174 286e 7865 6e74 7279 2e69 6e73 7472  at(nxentry.instr
+0000fda0: 756d 656e 742e 6465 7465 6374 6f72 2e79  ument.detector.y
+0000fdb0: 5f70 6978 656c 5f73 697a 652a 7464 662e  _pixel_size*tdf.
+0000fdc0: 7368 6170 655b 315d 292c 0a20 2020 2020  shape[1]),.     
+0000fdd0: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+0000fde0: 286e 7865 6e74 7279 2e69 6e73 7472 756d  (nxentry.instrum
+0000fdf0: 656e 742e 6465 7465 6374 6f72 2e78 5f70  ent.detector.x_p
+0000fe00: 6978 656c 5f73 697a 652a 7464 662e 7368  ixel_size*tdf.sh
+0000fe10: 6170 655b 305d 292c 0a20 2020 2020 2020  ape[0]),.       
+0000fe20: 2020 2020 2020 2020 2030 290a 2020 2020           0).    
+0000fe30: 2020 2020 2020 2020 7175 6963 6b5f 696d          quick_im
+0000fe40: 7368 6f77 280a 2020 2020 2020 2020 2020  show(.          
+0000fe50: 2020 2020 2020 7464 662c 2074 6974 6c65        tdf, title
+0000fe60: 3d27 6461 726b 2066 6965 6c64 272c 2070  ='dark field', p
+0000fe70: 6174 683d 7365 6c66 2e5f 6f75 7470 7574  ath=self._output
+0000fe80: 5f66 6f6c 6465 722c 0a20 2020 2020 2020  _folder,.       
+0000fe90: 2020 2020 2020 2020 2065 7874 656e 743d           extent=
+0000fea0: 6578 7465 6e74 2c20 7361 7665 5f66 6967  extent, save_fig
+0000feb0: 3d54 7275 652c 2073 6176 655f 6f6e 6c79  =True, save_only
+0000fec0: 3d54 7275 6529 0a0a 2020 2020 2020 2020  =True)..        
+0000fed0: 2320 4164 6420 6461 726b 2066 6965 6c64  # Add dark field
+0000fee0: 2074 6f20 7265 6475 6365 6420 6461 7461   to reduced data
+0000fef0: 204e 5870 726f 6365 7373 0a20 2020 2020   NXprocess.     
+0000ff00: 2020 2072 6564 7563 6564 5f64 6174 612e     reduced_data.
+0000ff10: 6461 7461 203d 204e 5864 6174 6128 290a  data = NXdata().
+0000ff20: 2020 2020 2020 2020 7265 6475 6365 645f          reduced_
+0000ff30: 6461 7461 2e64 6174 615b 2764 6172 6b5f  data.data['dark_
+0000ff40: 6669 656c 6427 5d20 3d20 7464 660a 0a20  field'] = tdf.. 
+0000ff50: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+0000ff60: 6475 6365 645f 6461 7461 0a0a 2020 2020  duced_data..    
+0000ff70: 6465 6620 5f67 656e 5f62 7269 6768 7428  def _gen_bright(
+0000ff80: 7365 6c66 2c20 6e78 656e 7472 792c 2072  self, nxentry, r
+0000ff90: 6564 7563 6564 5f64 6174 6129 3a0a 2020  educed_data):.  
+0000ffa0: 2020 2020 2020 2222 2247 656e 6572 6174        """Generat
+0000ffb0: 6520 6272 6967 6874 2066 6965 6c64 2e22  e bright field."
+0000ffc0: 2222 0a20 2020 2020 2020 2023 2054 6869  "".        # Thi
+0000ffd0: 7264 2070 6172 7479 206d 6f64 756c 6573  rd party modules
+0000ffe0: 0a20 2020 2020 2020 2066 726f 6d20 6e65  .        from ne
+0000fff0: 7875 7366 6f72 6d61 742e 6e65 7875 7320  xusformat.nexus 
+00010000: 696d 706f 7274 204e 5864 6174 610a 0a20  import NXdata.. 
+00010010: 2020 2020 2020 2023 204c 6f63 616c 206d         # Local m
+00010020: 6f64 756c 6573 0a20 2020 2020 2020 2066  odules.        f
+00010030: 726f 6d20 4348 4150 2e63 6f6d 6d6f 6e2e  rom CHAP.common.
+00010040: 6d6f 6465 6c73 2e6d 6170 2069 6d70 6f72  models.map impor
+00010050: 7420 280a 2020 2020 2020 2020 2020 2020  t (.            
+00010060: 6765 745f 7363 616e 7061 7273 6572 2c0a  get_scanparser,.
+00010070: 2020 2020 2020 2020 2020 2020 696d 706f              impo
+00010080: 7274 5f73 6361 6e70 6172 7365 722c 0a20  rt_scanparser,. 
+00010090: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000100a0: 2020 2320 4765 7420 7468 6520 6272 6967    # Get the brig
+000100b0: 6874 2066 6965 6c64 2069 6d61 6765 730a  ht field images.
+000100c0: 2020 2020 2020 2020 696d 6167 655f 6b65          image_ke
+000100d0: 7920 3d20 6e78 656e 7472 792e 696e 7374  y = nxentry.inst
+000100e0: 7275 6d65 6e74 2e64 6574 6563 746f 722e  rument.detector.
+000100f0: 6765 7428 2769 6d61 6765 5f6b 6579 272c  get('image_key',
+00010100: 204e 6f6e 6529 0a20 2020 2020 2020 2069   None).        i
+00010110: 6620 696d 6167 655f 6b65 7920 6973 206e  f image_key is n
+00010120: 6f74 204e 6f6e 6520 616e 6420 2764 6174  ot None and 'dat
+00010130: 6127 2069 6e20 6e78 656e 7472 792e 696e  a' in nxentry.in
+00010140: 7374 7275 6d65 6e74 2e64 6574 6563 746f  strument.detecto
+00010150: 723a 0a20 2020 2020 2020 2020 2020 2066  r:.            f
+00010160: 6965 6c64 5f69 6e64 6963 6573 203d 205b  ield_indices = [
+00010170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010180: 2069 6e64 6578 2066 6f72 2069 6e64 6578   index for index
+00010190: 2c20 6b65 7920 696e 2065 6e75 6d65 7261  , key in enumera
+000101a0: 7465 2869 6d61 6765 5f6b 6579 2920 6966  te(image_key) if
+000101b0: 206b 6579 203d 3d20 315d 0a20 2020 2020   key == 1].     
+000101c0: 2020 2020 2020 2074 6266 5f73 7461 636b         tbf_stack
+000101d0: 203d 206e 7865 6e74 7279 2e69 6e73 7472   = nxentry.instr
+000101e0: 756d 656e 742e 6465 7465 6374 6f72 2e64  ument.detector.d
+000101f0: 6174 615b 6669 656c 645f 696e 6469 6365  ata[field_indice
+00010200: 732c 3a2c 3a5d 0a20 2020 2020 2020 2020  s,:,:].         
+00010210: 2020 2023 2052 5620 7468 6520 6465 6661     # RV the defa
+00010220: 756c 7420 4e58 746f 6d6f 2066 6f72 6d20  ult NXtomo form 
+00010230: 646f 6573 206e 6f74 2061 6363 6f6d 6f64  does not accomod
+00010240: 6174 6520 6272 6967 6874 0a20 2020 2020  ate bright.     
+00010250: 2020 2020 2020 2023 2020 2020 2066 6965         #     fie
+00010260: 6c64 2073 7461 636b 730a 2020 2020 2020  ld stacks.      
+00010270: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00010280: 2020 2020 696d 706f 7274 5f73 6361 6e70      import_scanp
+00010290: 6172 7365 7228 0a20 2020 2020 2020 2020  arser(.         
+000102a0: 2020 2020 2020 206e 7865 6e74 7279 2e69         nxentry.i
+000102b0: 6e73 7472 756d 656e 742e 736f 7572 6365  nstrument.source
+000102c0: 2e61 7474 7273 5b27 7374 6174 696f 6e27  .attrs['station'
+000102d0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000102e0: 2020 206e 7865 6e74 7279 2e69 6e73 7472     nxentry.instr
+000102f0: 756d 656e 742e 736f 7572 6365 2e61 7474  ument.source.att
+00010300: 7273 5b27 6578 7065 7269 6d65 6e74 5f74  rs['experiment_t
+00010310: 7970 6527 5d29 0a20 2020 2020 2020 2020  ype']).         
+00010320: 2020 2062 7269 6768 745f 6669 656c 645f     bright_field_
+00010330: 7363 616e 7320 3d20 6e78 656e 7472 792e  scans = nxentry.
+00010340: 7370 6563 5f73 6361 6e73 2e62 7269 6768  spec_scans.brigh
+00010350: 745f 6669 656c 640a 2020 2020 2020 2020  t_field.        
+00010360: 2020 2020 6465 7465 6374 6f72 5f70 7265      detector_pre
+00010370: 6669 7820 3d20 7374 7228 6e78 656e 7472  fix = str(nxentr
+00010380: 792e 696e 7374 7275 6d65 6e74 2e64 6574  y.instrument.det
+00010390: 6563 746f 722e 6c6f 6361 6c5f 6e61 6d65  ector.local_name
+000103a0: 290a 2020 2020 2020 2020 2020 2020 7462  ).            tb
+000103b0: 665f 7374 6163 6b20 3d20 5b5d 0a20 2020  f_stack = [].   
+000103c0: 2020 2020 2020 2020 2066 6f72 206e 7873           for nxs
+000103d0: 7562 656e 7472 795f 6e61 6d65 2c20 6e78  ubentry_name, nx
+000103e0: 7375 6265 6e74 7279 2069 6e20 6272 6967  subentry in brig
+000103f0: 6874 5f66 6965 6c64 5f73 6361 6e73 2e69  ht_field_scans.i
+00010400: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+00010410: 2020 2020 2020 2020 7363 616e 5f6e 756d          scan_num
+00010420: 6265 7220 3d20 696e 7428 6e78 7375 6265  ber = int(nxsube
+00010430: 6e74 7279 5f6e 616d 652e 7370 6c69 7428  ntry_name.split(
+00010440: 275f 2729 5b2d 315d 290a 2020 2020 2020  '_')[-1]).      
+00010450: 2020 2020 2020 2020 2020 7363 616e 7061            scanpa
+00010460: 7273 6572 203d 2067 6574 5f73 6361 6e70  rser = get_scanp
+00010470: 6172 7365 7228 0a20 2020 2020 2020 2020  arser(.         
+00010480: 2020 2020 2020 2020 2020 2062 7269 6768             brigh
+00010490: 745f 6669 656c 645f 7363 616e 732e 6174  t_field_scans.at
+000104a0: 7472 735b 2773 7065 635f 6669 6c65 275d  trs['spec_file']
+000104b0: 2c20 7363 616e 5f6e 756d 6265 7229 0a20  , scan_number). 
+000104c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000104d0: 6d61 6765 5f6f 6666 7365 7420 3d20 696e  mage_offset = in
+000104e0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+000104f0: 2020 2020 2020 206e 7873 7562 656e 7472         nxsubentr
+00010500: 792e 696e 7374 7275 6d65 6e74 2e64 6574  y.instrument.det
+00010510: 6563 746f 722e 6672 616d 655f 7374 6172  ector.frame_star
+00010520: 745f 6e75 6d62 6572 290a 2020 2020 2020  t_number).      
+00010530: 2020 2020 2020 2020 2020 6e75 6d5f 696d            num_im
+00010540: 6167 6520 3d20 6c65 6e28 6e78 7375 6265  age = len(nxsube
+00010550: 6e74 7279 2e73 616d 706c 652e 726f 7461  ntry.sample.rota
+00010560: 7469 6f6e 5f61 6e67 6c65 290a 2020 2020  tion_angle).    
+00010570: 2020 2020 2020 2020 2020 2020 7462 665f              tbf_
+00010580: 7374 6163 6b2e 6170 7065 6e64 280a 2020  stack.append(.  
+00010590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000105a0: 2020 7363 616e 7061 7273 6572 2e67 6574    scanparser.get
+000105b0: 5f64 6574 6563 746f 725f 6461 7461 280a  _detector_data(.
+000105c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000105d0: 2020 2020 2020 2020 6465 7465 6374 6f72          detector
+000105e0: 5f70 7265 6669 782c 0a20 2020 2020 2020  _prefix,.       
+000105f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010600: 2028 696d 6167 655f 6f66 6673 6574 2c20   (image_offset, 
+00010610: 696d 6167 655f 6f66 6673 6574 2b6e 756d  image_offset+num
+00010620: 5f69 6d61 6765 2929 290a 2020 2020 2020  _image))).      
+00010630: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00010640: 6e63 6528 7462 665f 7374 6163 6b2c 206c  nce(tbf_stack, l
+00010650: 6973 7429 3a0a 2020 2020 2020 2020 2020  ist):.          
+00010660: 2020 2020 2020 6173 7365 7274 206c 656e        assert len
+00010670: 2874 6266 5f73 7461 636b 2920 3d3d 2031  (tbf_stack) == 1
+00010680: 2020 2320 5256 0a20 2020 2020 2020 2020    # RV.         
+00010690: 2020 2020 2020 2074 6266 5f73 7461 636b         tbf_stack
+000106a0: 203d 2074 6266 5f73 7461 636b 5b30 5d0a   = tbf_stack[0].
+000106b0: 0a20 2020 2020 2020 2023 2054 616b 6520  .        # Take 
+000106c0: 6d65 6469 616e 2069 6620 6d6f 7265 2074  median if more t
+000106d0: 6861 6e20 6f6e 6520 696d 6167 650a 2020  han one image.  
+000106e0: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
+000106f0: 2320 4d65 6469 616e 206f 7220 6d65 616e  # Median or mean
+00010700: 3a20 4974 206d 6179 2062 6520 6265 7374  : It may be best
+00010710: 2074 6f20 7472 7920 7468 6520 6d65 6469   to try the medi
+00010720: 616e 2062 6563 6175 7365 206f 660a 2020  an because of.  
+00010730: 2020 2020 2020 2320 736f 6d65 2069 6d61        # some ima
+00010740: 6765 2061 7274 6966 6163 7473 2074 6861  ge artifacts tha
+00010750: 7420 6172 6973 6520 6475 6520 746f 2063  t arise due to c
+00010760: 7269 6e6b 6c65 7320 696e 2074 6865 0a20  rinkles in the. 
+00010770: 2020 2020 2020 2023 2075 7073 7472 6561         # upstrea
+00010780: 6d20 6b61 7074 6f6e 2074 6170 6520 7769  m kapton tape wi
+00010790: 6e64 6f77 7320 6361 7573 696e 6720 736f  ndows causing so
+000107a0: 6d65 2070 6861 7365 2063 6f6e 7472 6173  me phase contras
+000107b0: 740a 2020 2020 2020 2020 2320 696d 6167  t.        # imag
+000107c0: 6573 2074 6f20 6170 7065 6172 206f 6e20  es to appear on 
+000107d0: 7468 6520 6465 7465 6374 6f72 2e0a 2020  the detector..  
+000107e0: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
+000107f0: 2320 4f6e 6520 7468 696e 6720 7468 6174  # One thing that
+00010800: 2061 6c73 6f20 6d61 7920 6265 2075 7365   also may be use
+00010810: 6675 6c20 696e 2061 2066 7574 7572 6520  ful in a future 
+00010820: 696d 706c 656d 656e 7461 7469 6f6e 0a20  implementation. 
+00010830: 2020 2020 2020 2023 2069 7320 746f 2064         # is to d
+00010840: 6f20 6120 6272 6967 6874 6669 656c 6420  o a brightfield 
+00010850: 6164 6a75 7374 6d65 6e74 206f 6e20 4541  adjustment on EA
+00010860: 4348 2066 7261 6d65 206f 6620 7468 6520  CH frame of the 
+00010870: 746f 6d6f 0a20 2020 2020 2020 2023 2062  tomo.        # b
+00010880: 6173 6564 206f 6e20 6120 524f 4920 696e  ased on a ROI in
+00010890: 2074 6865 2063 6f72 6e65 7220 6f66 2074   the corner of t
+000108a0: 6865 2066 7261 6d65 2077 6865 7265 2074  he frame where t
+000108b0: 6865 7265 2069 7320 6e6f 0a20 2020 2020  here is no.     
+000108c0: 2020 2023 2073 616d 706c 6520 6275 7420     # sample but 
+000108d0: 7468 6572 6520 6973 2074 6865 2064 6972  there is the dir
+000108e0: 6563 7420 582d 7261 7920 6265 616d 2062  ect X-ray beam b
+000108f0: 6563 6175 7365 2074 6865 7265 2069 730a  ecause there is.
+00010900: 2020 2020 2020 2020 2320 6672 616d 6520          # frame 
+00010910: 746f 2066 7261 6d65 2066 6c75 6374 7561  to frame fluctua
+00010920: 7469 6f6e 7320 6672 6f6d 2074 6865 2069  tions from the i
+00010930: 6e63 6f6d 696e 6720 6265 616d 2e20 5765  ncoming beam. We
+00010940: 2064 6f6e e280 9974 0a20 2020 2020 2020   don...t.       
+00010950: 2023 2074 7970 6963 616c 6c79 2061 6363   # typically acc
+00010960: 6f75 6e74 2066 6f72 2074 6865 6d20 6275  ount for them bu
+00010970: 7420 706f 7465 6e74 6961 6c6c 7920 636f  t potentially co
+00010980: 756c 642e 0a20 2020 2020 2020 2069 6620  uld..        if 
+00010990: 7462 665f 7374 6163 6b2e 6e64 696d 203d  tbf_stack.ndim =
+000109a0: 3d20 323a 0a20 2020 2020 2020 2020 2020  = 2:.           
+000109b0: 2074 6266 203d 2074 6266 5f73 7461 636b   tbf = tbf_stack
+000109c0: 0a20 2020 2020 2020 2065 6c69 6620 7462  .        elif tb
+000109d0: 665f 7374 6163 6b2e 6e64 696d 203d 3d20  f_stack.ndim == 
+000109e0: 333a 0a20 2020 2020 2020 2020 2020 2074  3:.            t
+000109f0: 6266 203d 206e 702e 6d65 6469 616e 2874  bf = np.median(t
+00010a00: 6266 5f73 7461 636b 2c20 6178 6973 3d30  bf_stack, axis=0
+00010a10: 290a 2020 2020 2020 2020 2020 2020 6465  ).            de
+00010a20: 6c20 7462 665f 7374 6163 6b0a 2020 2020  l tbf_stack.    
+00010a30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00010a40: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
+00010a50: 696d 6545 7272 6f72 2866 2749 6e76 616c  imeError(f'Inval
+00010a60: 6964 2074 6266 5f73 7461 636b 2073 6861  id tbf_stack sha
+00010a70: 7065 2028 7b74 6266 5f73 7461 636b 2e73  pe ({tbf_stack.s
+00010a80: 6861 7065 7d29 2729 0a0a 2020 2020 2020  hape})')..      
+00010a90: 2020 2320 5375 6274 7261 6374 2064 6172    # Subtract dar
+00010aa0: 6b20 6669 656c 640a 2020 2020 2020 2020  k field.        
+00010ab0: 6966 2027 6461 7461 2720 696e 2072 6564  if 'data' in red
+00010ac0: 7563 6564 5f64 6174 6120 616e 6420 2764  uced_data and 'd
+00010ad0: 6172 6b5f 6669 656c 6427 2069 6e20 7265  ark_field' in re
+00010ae0: 6475 6365 645f 6461 7461 2e64 6174 613a  duced_data.data:
+00010af0: 0a20 2020 2020 2020 2020 2020 2074 6266  .            tbf
+00010b00: 202d 3d20 7265 6475 6365 645f 6461 7461   -= reduced_data
+00010b10: 2e64 6174 612e 6461 726b 5f66 6965 6c64  .data.dark_field
+00010b20: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00010b30: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00010b40: 5f6c 6f67 6765 722e 7761 726e 696e 6728  _logger.warning(
+00010b50: 2744 6172 6b20 6669 656c 6420 756e 6176  'Dark field unav
+00010b60: 6169 6c61 626c 6527 290a 0a20 2020 2020  ailable')..     
+00010b70: 2020 2023 2053 6574 2061 6e79 206e 6f6e     # Set any non
+00010b80: 2d70 6f73 6974 6976 6520 7661 6c75 6573  -positive values
+00010b90: 2074 6f20 6f6e 650a 2020 2020 2020 2020   to one.        
+00010ba0: 2320 2861 766f 6964 206e 6567 6174 6976  # (avoid negativ
+00010bb0: 6520 6272 6967 6874 2066 6965 6c64 2076  e bright field v
+00010bc0: 616c 7565 7320 666f 7220 7370 696b 6573  alues for spikes
+00010bd0: 2069 6e20 6461 726b 2066 6965 6c64 290a   in dark field).
+00010be0: 2020 2020 2020 2020 7462 665b 7462 6620          tbf[tbf 
+00010bf0: 3c20 315d 203d 2031 0a0a 2020 2020 2020  < 1] = 1..      
+00010c00: 2020 2320 506c 6f74 2062 7269 6768 7420    # Plot bright 
+00010c10: 6669 656c 640a 2020 2020 2020 2020 6966  field.        if
+00010c20: 2073 656c 662e 5f73 6176 655f 6669 6773   self._save_figs
+00010c30: 3a0a 2020 2020 2020 2020 2020 2020 6578  :.            ex
+00010c40: 7465 6e74 203d 2028 0a20 2020 2020 2020  tent = (.       
+00010c50: 2020 2020 2020 2020 2030 2c0a 2020 2020           0,.    
+00010c60: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+00010c70: 7428 6e78 656e 7472 792e 696e 7374 7275  t(nxentry.instru
+00010c80: 6d65 6e74 2e64 6574 6563 746f 722e 795f  ment.detector.y_
+00010c90: 7069 7865 6c5f 7369 7a65 2a74 6266 2e73  pixel_size*tbf.s
+00010ca0: 6861 7065 5b31 5d29 2c0a 2020 2020 2020  hape[1]),.      
+00010cb0: 2020 2020 2020 2020 2020 666c 6f61 7428            float(
+00010cc0: 6e78 656e 7472 792e 696e 7374 7275 6d65  nxentry.instrume
+00010cd0: 6e74 2e64 6574 6563 746f 722e 785f 7069  nt.detector.x_pi
+00010ce0: 7865 6c5f 7369 7a65 2a74 6266 2e73 6861  xel_size*tbf.sha
+00010cf0: 7065 5b30 5d29 2c0a 2020 2020 2020 2020  pe[0]),.        
+00010d00: 2020 2020 2020 2020 3029 0a20 2020 2020          0).     
+00010d10: 2020 2020 2020 2071 7569 636b 5f69 6d73         quick_ims
+00010d20: 686f 7728 0a20 2020 2020 2020 2020 2020  how(.           
+00010d30: 2020 2020 2074 6266 2c20 7469 746c 653d       tbf, title=
+00010d40: 2762 7269 6768 7420 6669 656c 6427 2c20  'bright field', 
+00010d50: 7061 7468 3d73 656c 662e 5f6f 7574 7075  path=self._outpu
+00010d60: 745f 666f 6c64 6572 2c0a 2020 2020 2020  t_folder,.      
+00010d70: 2020 2020 2020 2020 2020 6578 7465 6e74            extent
+00010d80: 3d65 7874 656e 742c 2073 6176 655f 6669  =extent, save_fi
+00010d90: 673d 5472 7565 2c20 7361 7665 5f6f 6e6c  g=True, save_onl
+00010da0: 793d 5472 7565 290a 0a20 2020 2020 2020  y=True)..       
+00010db0: 2023 2041 6464 2062 7269 6768 7420 6669   # Add bright fi
+00010dc0: 656c 6420 746f 2072 6564 7563 6564 2064  eld to reduced d
+00010dd0: 6174 6120 4e58 7072 6f63 6573 730a 2020  ata NXprocess.  
+00010de0: 2020 2020 2020 6966 2027 6461 7461 2720        if 'data' 
+00010df0: 6e6f 7420 696e 2072 6564 7563 6564 5f64  not in reduced_d
+00010e00: 6174 613a 0a20 2020 2020 2020 2020 2020  ata:.           
+00010e10: 2072 6564 7563 6564 5f64 6174 612e 6461   reduced_data.da
+00010e20: 7461 203d 204e 5864 6174 6128 290a 2020  ta = NXdata().  
+00010e30: 2020 2020 2020 7265 6475 6365 645f 6461        reduced_da
+00010e40: 7461 2e64 6174 615b 2762 7269 6768 745f  ta.data['bright_
+00010e50: 6669 656c 6427 5d20 3d20 7462 660a 0a20  field'] = tbf.. 
+00010e60: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00010e70: 6475 6365 645f 6461 7461 0a0a 2020 2020  duced_data..    
+00010e80: 6465 6620 5f73 6574 5f64 6574 6563 746f  def _set_detecto
+00010e90: 725f 626f 756e 6473 2873 656c 662c 206e  r_bounds(self, n
+00010ea0: 7865 6e74 7279 2c20 7265 6475 6365 645f  xentry, reduced_
+00010eb0: 6461 7461 2c20 7468 6574 612c 0a20 2020  data, theta,.   
+00010ec0: 2020 2020 2020 2020 2069 6d67 5f78 5f62           img_x_b
+00010ed0: 6f75 6e64 733d 4e6f 6e65 293a 0a20 2020  ounds=None):.   
+00010ee0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00010ef0: 2053 6574 2076 6572 7469 6361 6c20 6465   Set vertical de
+00010f00: 7465 6374 6f72 2062 6f75 6e64 7320 666f  tector bounds fo
+00010f10: 7220 6561 6368 2069 6d61 6765 2073 7461  r each image sta
+00010f20: 636b 2e52 6967 6874 206e 6f77 2074 6865  ck.Right now the
+00010f30: 0a20 2020 2020 2020 2072 616e 6765 2069  .        range i
+00010f40: 7320 7468 6520 7361 6d65 2066 6f72 2065  s the same for e
+00010f50: 6163 6820 7365 7420 696e 2074 6865 2069  ach set in the i
+00010f60: 6d61 6765 2073 7461 636b 2e0a 2020 2020  mage stack..    
+00010f70: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00010f80: 2320 4c6f 6361 6c20 6d6f 6475 6c65 730a  # Local modules.
+00010f90: 2020 2020 2020 2020 6672 6f6d 2043 4841          from CHA
+00010fa0: 502e 636f 6d6d 6f6e 2e6d 6f64 656c 732e  P.common.models.
+00010fb0: 6d61 7020 696d 706f 7274 2028 0a20 2020  map import (.   
+00010fc0: 2020 2020 2020 2020 2067 6574 5f73 6361           get_sca
+00010fd0: 6e70 6172 7365 722c 0a20 2020 2020 2020  nparser,.       
+00010fe0: 2020 2020 2069 6d70 6f72 745f 7363 616e       import_scan
+00010ff0: 7061 7273 6572 2c0a 2020 2020 2020 2020  parser,.        
+00011000: 290a 2020 2020 2020 2020 6672 6f6d 2043  ).        from C
+00011010: 4841 502e 7574 696c 732e 6765 6e65 7261  HAP.utils.genera
+00011020: 6c20 696d 706f 7274 2069 735f 696e 6465  l import is_inde
+00011030: 785f 7261 6e67 650a 0a20 2020 2020 2020  x_range..       
+00011040: 2069 6620 7365 6c66 2e5f 7465 7374 5f6d   if self._test_m
+00011050: 6f64 653a 0a20 2020 2020 2020 2020 2020  ode:.           
+00011060: 2072 6574 7572 6e20 7475 706c 6528 7365   return tuple(se
+00011070: 6c66 2e5f 7465 7374 5f63 6f6e 6669 675b  lf._test_config[
+00011080: 2769 6d67 5f78 5f62 6f75 6e64 7327 5d29  'img_x_bounds'])
+00011090: 0a0a 2020 2020 2020 2020 2320 4765 7420  ..        # Get 
+000110a0: 7468 6520 6669 7273 7420 746f 6d6f 6772  the first tomogr
+000110b0: 6170 6879 2069 6d61 6765 2061 6e64 2074  aphy image and t
+000110c0: 6865 2072 6566 6572 656e 6365 2068 6569  he reference hei
+000110d0: 6768 7473 0a20 2020 2020 2020 2069 6d61  ghts.        ima
+000110e0: 6765 5f6d 6173 6b20 3d20 7265 6475 6365  ge_mask = reduce
+000110f0: 645f 6461 7461 2e67 6574 2827 696d 6167  d_data.get('imag
+00011100: 655f 6d61 736b 2729 0a20 2020 2020 2020  e_mask').       
+00011110: 2069 6620 696d 6167 655f 6d61 736b 2069   if image_mask i
+00011120: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00011130: 2020 2020 6669 7273 745f 696d 6167 655f      first_image_
+00011140: 696e 6465 7820 3d20 300a 2020 2020 2020  index = 0.      
+00011150: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00011160: 2020 2020 696d 6167 655f 6d61 736b 203d      image_mask =
+00011170: 206e 702e 6173 6172 7261 7928 696d 6167   np.asarray(imag
+00011180: 655f 6d61 736b 290a 2020 2020 2020 2020  e_mask).        
+00011190: 2020 2020 6669 7273 745f 696d 6167 655f      first_image_
+000111a0: 696e 6465 7820 3d20 696e 7428 6e70 2e61  index = int(np.a
+000111b0: 7267 6d61 7828 696d 6167 655f 6d61 736b  rgmax(image_mask
+000111c0: 2929 0a20 2020 2020 2020 2069 6d61 6765  )).        image
+000111d0: 5f6b 6579 203d 206e 7865 6e74 7279 2e69  _key = nxentry.i
+000111e0: 6e73 7472 756d 656e 742e 6465 7465 6374  nstrument.detect
+000111f0: 6f72 2e67 6574 2827 696d 6167 655f 6b65  or.get('image_ke
+00011200: 7927 2c20 4e6f 6e65 290a 2020 2020 2020  y', None).      
+00011210: 2020 6966 2069 6d61 6765 5f6b 6579 2069    if image_key i
+00011220: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2027  s not None and '
+00011230: 6461 7461 2720 696e 206e 7865 6e74 7279  data' in nxentry
+00011240: 2e69 6e73 7472 756d 656e 742e 6465 7465  .instrument.dete
+00011250: 6374 6f72 3a0a 2020 2020 2020 2020 2020  ctor:.          
+00011260: 2020 6669 656c 645f 696e 6469 6365 7320    field_indices 
+00011270: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00011280: 2020 2020 696e 6465 7820 666f 7220 696e      index for in
+00011290: 6465 782c 206b 6579 2069 6e20 656e 756d  dex, key in enum
+000112a0: 6572 6174 6528 696d 6167 655f 6b65 7929  erate(image_key)
+000112b0: 2069 6620 6b65 7920 3d3d 2030 5d0a 2020   if key == 0].  
+000112c0: 2020 2020 2020 2020 2020 6669 656c 645f            field_
+000112d0: 696e 6469 6365 735f 6d61 736b 6564 203d  indices_masked =
+000112e0: 2066 6965 6c64 5f69 6e64 6963 6573 5b69   field_indices[i
+000112f0: 6d61 6765 5f6d 6173 6b5d 0a20 2020 2020  mage_mask].     
+00011300: 2020 2020 2020 2066 6972 7374 5f69 6d61         first_ima
+00011310: 6765 203d 206e 702e 6173 6172 7261 7928  ge = np.asarray(
+00011320: 6e78 656e 7472 792e 696e 7374 7275 6d65  nxentry.instrume
+00011330: 6e74 2e64 6574 6563 746f 722e 6461 7461  nt.detector.data
+00011340: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00011350: 2020 6669 656c 645f 696e 6469 6365 735b    field_indices[
+00011360: 6669 7273 745f 696d 6167 655f 696e 6465  first_image_inde
+00011370: 782c 3a2c 3a5d 5d29 0a20 2020 2020 2020  x,:,:]]).       
+00011380: 2020 2020 2061 7373 6572 7420 7468 6574       assert thet
+00011390: 6120 3d3d 2066 6c6f 6174 286e 7865 6e74  a == float(nxent
+000113a0: 7279 2e73 616d 706c 652e 726f 7461 7469  ry.sample.rotati
+000113b0: 6f6e 5f61 6e67 6c65 5b0a 2020 2020 2020  on_angle[.      
+000113c0: 2020 2020 2020 2020 2020 6669 656c 645f            field_
+000113d0: 696e 6469 6365 735b 6669 7273 745f 696d  indices[first_im
+000113e0: 6167 655f 696e 6465 785d 5d29 0a20 2020  age_index]]).   
+000113f0: 2020 2020 2020 2020 207a 5f74 7261 6e73           z_trans
+00011400: 6c61 7469 6f6e 5f61 6c6c 203d 205c 0a20  lation_all = \. 
+00011410: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00011420: 7865 6e74 7279 2e73 616d 706c 652e 7a5f  xentry.sample.z_
+00011430: 7472 616e 736c 6174 696f 6e5b 6669 656c  translation[fiel
+00011440: 645f 696e 6469 6365 735f 6d61 736b 6564  d_indices_masked
+00011450: 5d0a 2020 2020 2020 2020 2020 2020 7665  ].            ve
+00011460: 7274 6963 616c 5f73 6869 6674 7320 3d20  rtical_shifts = 
+00011470: 736f 7274 6564 286c 6973 7428 7365 7428  sorted(list(set(
+00011480: 7a5f 7472 616e 736c 6174 696f 6e5f 616c  z_translation_al
+00011490: 6c29 2929 0a20 2020 2020 2020 2020 2020  l))).           
+000114a0: 206e 756d 5f74 6f6d 6f5f 7374 6163 6b73   num_tomo_stacks
+000114b0: 203d 206c 656e 2876 6572 7469 6361 6c5f   = len(vertical_
+000114c0: 7368 6966 7473 290a 2020 2020 2020 2020  shifts).        
+000114d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000114e0: 2020 696d 706f 7274 5f73 6361 6e70 6172    import_scanpar
+000114f0: 7365 7228 0a20 2020 2020 2020 2020 2020  ser(.           
+00011500: 2020 2020 206e 7865 6e74 7279 2e69 6e73       nxentry.ins
+00011510: 7472 756d 656e 742e 736f 7572 6365 2e61  trument.source.a
+00011520: 7474 7273 5b27 7374 6174 696f 6e27 5d2c  ttrs['station'],
+00011530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011540: 206e 7865 6e74 7279 2e69 6e73 7472 756d   nxentry.instrum
+00011550: 656e 742e 736f 7572 6365 2e61 7474 7273  ent.source.attrs
+00011560: 5b27 6578 7065 7269 6d65 6e74 5f74 7970  ['experiment_typ
+00011570: 6527 5d29 0a20 2020 2020 2020 2020 2020  e']).           
+00011580: 2074 6f6d 6f5f 6669 656c 645f 7363 616e   tomo_field_scan
+00011590: 7320 3d20 6e78 656e 7472 792e 7370 6563  s = nxentry.spec
+000115a0: 5f73 6361 6e73 2e74 6f6d 6f5f 6669 656c  _scans.tomo_fiel
+000115b0: 6473 0a20 2020 2020 2020 2020 2020 206e  ds.            n
+000115c0: 756d 5f74 6f6d 6f5f 7374 6163 6b73 203d  um_tomo_stacks =
+000115d0: 206c 656e 2874 6f6d 6f5f 6669 656c 645f   len(tomo_field_
+000115e0: 7363 616e 732e 6b65 7973 2829 290a 2020  scans.keys()).  
+000115f0: 2020 2020 2020 2020 2020 6365 6e74 6572            center
+00011600: 5f73 7461 636b 5f69 6e64 6578 203d 2069  _stack_index = i
+00011610: 6e74 286e 756d 5f74 6f6d 6f5f 7374 6163  nt(num_tomo_stac
+00011620: 6b73 2f32 290a 2020 2020 2020 2020 2020  ks/2).          
+00011630: 2020 6465 7465 6374 6f72 5f70 7265 6669    detector_prefi
+00011640: 7820 3d20 7374 7228 6e78 656e 7472 792e  x = str(nxentry.
+00011650: 696e 7374 7275 6d65 6e74 2e64 6574 6563  instrument.detec
+00011660: 746f 722e 6c6f 6361 6c5f 6e61 6d65 290a  tor.local_name).
+00011670: 2020 2020 2020 2020 2020 2020 7665 7274              vert
+00011680: 6963 616c 5f73 6869 6674 7320 3d20 5b5d  ical_shifts = []
+00011690: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000116a0: 2069 2c20 6e78 7375 6265 6e74 7279 2069   i, nxsubentry i
+000116b0: 6e20 656e 756d 6572 6174 6528 746f 6d6f  n enumerate(tomo
+000116c0: 5f66 6965 6c64 5f73 6361 6e73 2e69 7465  _field_scans.ite
+000116d0: 6d73 2829 293a 0a20 2020 2020 2020 2020  ms()):.         
+000116e0: 2020 2020 2020 2073 6361 6e5f 6e75 6d62         scan_numb
+000116f0: 6572 203d 2069 6e74 286e 7873 7562 656e  er = int(nxsuben
+00011700: 7472 795b 305d 2e73 706c 6974 2827 5f27  try[0].split('_'
+00011710: 295b 2d31 5d29 0a20 2020 2020 2020 2020  )[-1]).         
+00011720: 2020 2020 2020 2073 6361 6e70 6172 7365         scanparse
+00011730: 7220 3d20 6765 745f 7363 616e 7061 7273  r = get_scanpars
+00011740: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00011750: 2020 2020 2020 2020 746f 6d6f 5f66 6965          tomo_fie
+00011760: 6c64 5f73 6361 6e73 2e61 7474 7273 5b27  ld_scans.attrs['
+00011770: 7370 6563 5f66 696c 6527 5d2c 2073 6361  spec_file'], sca
+00011780: 6e5f 6e75 6d62 6572 290a 2020 2020 2020  n_number).      
+00011790: 2020 2020 2020 2020 2020 696d 6167 655f            image_
+000117a0: 6f66 6673 6574 203d 2069 6e74 280a 2020  offset = int(.  
+000117b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000117c0: 2020 6e78 7375 6265 6e74 7279 5b31 5d2e    nxsubentry[1].
+000117d0: 696e 7374 7275 6d65 6e74 2e64 6574 6563  instrument.detec
+000117e0: 746f 722e 6672 616d 655f 7374 6172 745f  tor.frame_start_
+000117f0: 6e75 6d62 6572 290a 2020 2020 2020 2020  number).        
+00011800: 2020 2020 2020 2020 7665 7274 6963 616c          vertical
+00011810: 5f73 6869 6674 732e 6170 7065 6e64 286e  _shifts.append(n
+00011820: 7873 7562 656e 7472 795b 315d 2e73 616d  xsubentry[1].sam
+00011830: 706c 652e 7a5f 7472 616e 736c 6174 696f  ple.z_translatio
+00011840: 6e29 0a20 2020 2020 2020 2020 2020 2020  n).             
+00011850: 2020 2069 6620 6920 3d3d 2063 656e 7465     if i == cente
+00011860: 725f 7374 6163 6b5f 696e 6465 783a 0a20  r_stack_index:. 
+00011870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011880: 2020 2066 6972 7374 5f69 6d61 6765 203d     first_image =
+00011890: 2073 6361 6e70 6172 7365 722e 6765 745f   scanparser.get_
+000118a0: 6465 7465 6374 6f72 5f64 6174 6128 0a20  detector_data(. 
+000118b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000118c0: 2020 2020 2020 2064 6574 6563 746f 725f         detector_
+000118d0: 7072 6566 6978 2c20 696d 6167 655f 6f66  prefix, image_of
+000118e0: 6673 6574 2b66 6972 7374 5f69 6d61 6765  fset+first_image
+000118f0: 5f69 6e64 6578 290a 2020 2020 2020 2020  _index).        
+00011900: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00011910: 7274 2074 6865 7461 203d 3d20 666c 6f61  rt theta == floa
+00011920: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00011930: 2020 2020 2020 2020 2020 206e 7873 7562             nxsub
+00011940: 656e 7472 795b 315d 2e73 616d 706c 652e  entry[1].sample.
+00011950: 726f 7461 7469 6f6e 5f61 6e67 6c65 5b66  rotation_angle[f
+00011960: 6972 7374 5f69 6d61 6765 5f69 6e64 6578  irst_image_index
+00011970: 5d29 0a0a 2020 2020 2020 2020 2320 5365  ])..        # Se
+00011980: 6c65 6374 2069 6d61 6765 2062 6f75 6e64  lect image bound
+00011990: 730a 2020 2020 2020 2020 7469 746c 6520  s.        title 
+000119a0: 3d20 6627 746f 6d6f 6772 6170 6879 2069  = f'tomography i
+000119b0: 6d61 6765 2061 7420 7468 6574 613d 7b72  mage at theta={r
+000119c0: 6f75 6e64 2874 6865 7461 2c20 3229 2b30  ound(theta, 2)+0
+000119d0: 7d27 0a20 2020 2020 2020 2069 6620 696d  }'.        if im
+000119e0: 675f 785f 626f 756e 6473 2069 7320 6e6f  g_x_bounds is no
+000119f0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00011a00: 2020 2020 6966 2069 735f 696e 6465 785f      if is_index_
+00011a10: 7261 6e67 6528 696d 675f 785f 626f 756e  range(img_x_boun
+00011a20: 6473 2c20 6765 3d30 2c20 6c65 3d66 6972  ds, ge=0, le=fir
+00011a30: 7374 5f69 6d61 6765 2e73 6861 7065 5b30  st_image.shape[0
+00011a40: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
+00011a50: 2020 2020 7265 7475 726e 2069 6d67 5f78      return img_x
+00011a60: 5f62 6f75 6e64 730a 2020 2020 2020 2020  _bounds.        
+00011a70: 2020 2020 6966 2073 656c 662e 5f69 6e74      if self._int
+00011a80: 6572 6163 7469 7665 3a0a 2020 2020 2020  eractive:.      
+00011a90: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00011aa0: 6c6f 6767 6572 2e77 6172 6e69 6e67 280a  logger.warning(.
+00011ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ac0: 2020 2020 6627 496e 7661 6c69 6420 7061      f'Invalid pa
+00011ad0: 7261 6d65 7465 7220 696d 675f 785f 626f  rameter img_x_bo
+00011ae0: 756e 6473 2028 7b69 6d67 5f78 5f62 6f75  unds ({img_x_bou
+00011af0: 6e64 737d 292c 2027 0a20 2020 2020 2020  nds}), '.       
+00011b00: 2020 2020 2020 2020 2020 2020 202b 2027               + '
+00011b10: 6967 6e6f 7269 6e67 2069 6d67 5f78 5f62  ignoring img_x_b
+00011b20: 6f75 6e64 7327 290a 2020 2020 2020 2020  ounds').        
+00011b30: 2020 2020 2020 2020 696d 675f 785f 626f          img_x_bo
+00011b40: 756e 6473 203d 204e 6f6e 650a 2020 2020  unds = None.    
+00011b50: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00011b60: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00011b70: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
+00011b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b90: 2020 2020 6627 496e 7661 6c69 6420 7061      f'Invalid pa
+00011ba0: 7261 6d65 7465 7220 696d 675f 785f 626f  rameter img_x_bo
+00011bb0: 756e 6473 2028 7b69 6d67 5f78 5f62 6f75  unds ({img_x_bou
+00011bc0: 6e64 737d 2927 290a 2020 2020 2020 2020  nds})').        
+00011bd0: 6966 206e 7865 6e74 7279 2e69 6e73 7472  if nxentry.instr
+00011be0: 756d 656e 742e 736f 7572 6365 2e61 7474  ument.source.att
+00011bf0: 7273 5b27 7374 6174 696f 6e27 5d20 696e  rs['station'] in
+00011c00: 2028 2769 6431 6133 272c 2027 6964 3361   ('id1a3', 'id3a
+00011c10: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00011c20: 7069 7865 6c5f 7369 7a65 203d 206e 7865  pixel_size = nxe
+00011c30: 6e74 7279 2e69 6e73 7472 756d 656e 742e  ntry.instrument.
+00011c40: 6465 7465 6374 6f72 2e78 5f70 6978 656c  detector.x_pixel
+00011c50: 5f73 697a 650a 2020 2020 2020 2020 2020  _size.          
+00011c60: 2020 2320 5472 7920 746f 2067 6574 2061    # Try to get a
+00011c70: 2066 6974 2066 726f 6d20 7468 6520 6272   fit from the br
+00011c80: 6967 6874 2066 6965 6c64 0a20 2020 2020  ight field.     
+00011c90: 2020 2020 2020 2074 6266 203d 206e 702e         tbf = np.
+00011ca0: 6173 6172 7261 7928 7265 6475 6365 645f  asarray(reduced_
+00011cb0: 6461 7461 2e64 6174 612e 6272 6967 6874  data.data.bright
+00011cc0: 5f66 6965 6c64 290a 2020 2020 2020 2020  _field).        
+00011cd0: 2020 2020 7462 665f 7368 6170 6520 3d20      tbf_shape = 
+00011ce0: 7462 662e 7368 6170 650a 2020 2020 2020  tbf.shape.      
+00011cf0: 2020 2020 2020 785f 7375 6d20 3d20 6e70        x_sum = np
+00011d00: 2e73 756d 2874 6266 2c20 3129 0a20 2020  .sum(tbf, 1).   
+00011d10: 2020 2020 2020 2020 2078 5f73 756d 5f6d           x_sum_m
+00011d20: 696e 203d 2078 5f73 756d 2e6d 696e 2829  in = x_sum.min()
+00011d30: 0a20 2020 2020 2020 2020 2020 2078 5f73  .            x_s
+00011d40: 756d 5f6d 6178 203d 2078 5f73 756d 2e6d  um_max = x_sum.m
+00011d50: 6178 2829 0a20 2020 2020 2020 2020 2020  ax().           
+00011d60: 2066 6974 203d 2046 6974 2e66 6974 5f64   fit = Fit.fit_d
+00011d70: 6174 6128 0a20 2020 2020 2020 2020 2020  ata(.           
+00011d80: 2020 2020 2078 5f73 756d 2c20 2772 6563       x_sum, 'rec
+00011d90: 7461 6e67 6c65 272c 2078 3d6e 702e 6172  tangle', x=np.ar
+00011da0: 7261 7928 7261 6e67 6528 6c65 6e28 785f  ray(range(len(x_
+00011db0: 7375 6d29 2929 2c0a 2020 2020 2020 2020  sum))),.        
+00011dc0: 2020 2020 2020 2020 666f 726d 3d27 6174          form='at
+00011dd0: 616e 272c 2067 7565 7373 3d54 7275 6529  an', guess=True)
+00011de0: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
+00011df0: 616d 6574 6572 7320 3d20 6669 742e 6265  ameters = fit.be
+00011e00: 7374 5f76 616c 7565 730a 2020 2020 2020  st_values.      
+00011e10: 2020 2020 2020 785f 6c6f 775f 6669 7420        x_low_fit 
+00011e20: 3d20 7061 7261 6d65 7465 7273 2e67 6574  = parameters.get
+00011e30: 2827 6365 6e74 6572 3127 2c20 4e6f 6e65  ('center1', None
+00011e40: 290a 2020 2020 2020 2020 2020 2020 785f  ).            x_
+00011e50: 7570 705f 6669 7420 3d20 7061 7261 6d65  upp_fit = parame
+00011e60: 7465 7273 2e67 6574 2827 6365 6e74 6572  ters.get('center
+00011e70: 3227 2c20 4e6f 6e65 290a 2020 2020 2020  2', None).      
+00011e80: 2020 2020 2020 7369 675f 6c6f 7720 3d20        sig_low = 
+00011e90: 7061 7261 6d65 7465 7273 2e67 6574 2827  parameters.get('
+00011ea0: 7369 676d 6131 272c 204e 6f6e 6529 0a20  sigma1', None). 
+00011eb0: 2020 2020 2020 2020 2020 2073 6967 5f75             sig_u
+00011ec0: 7070 203d 2070 6172 616d 6574 6572 732e  pp = parameters.
+00011ed0: 6765 7428 2773 6967 6d61 3227 2c20 4e6f  get('sigma2', No
+00011ee0: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
+00011ef0: 6861 7665 5f66 6974 203d 2028 6669 742e  have_fit = (fit.
+00011f00: 7375 6363 6573 7320 616e 6420 785f 6c6f  success and x_lo
+00011f10: 775f 6669 7420 6973 206e 6f74 204e 6f6e  w_fit is not Non
+00011f20: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00011f30: 2020 2020 2020 2020 2020 616e 6420 785f            and x_
+00011f40: 7570 705f 6669 7420 6973 206e 6f74 204e  upp_fit is not N
+00011f50: 6f6e 6520 616e 6420 7369 675f 6c6f 7720  one and sig_low 
+00011f60: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+00011f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f80: 2020 2020 616e 6420 7369 675f 7570 7020      and sig_upp 
+00011f90: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+00011fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011fb0: 2020 2020 616e 6420 3020 3c3d 2078 5f6c      and 0 <= x_l
+00011fc0: 6f77 5f66 6974 203c 2078 5f75 7070 5f66  ow_fit < x_upp_f
+00011fd0: 6974 203c 3d20 785f 7375 6d2e 7369 7a65  it <= x_sum.size
+00011fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011ff0: 2020 2020 2020 2020 2061 6e64 2028 7369           and (si
+00012000: 675f 6c6f 772b 7369 675f 7570 7029 202f  g_low+sig_upp) /
+00012010: 2028 785f 7570 705f 6669 742d 785f 6c6f   (x_upp_fit-x_lo
+00012020: 775f 6669 7429 203c 2030 2e31 290a 2020  w_fit) < 0.1).  
+00012030: 2020 2020 2020 2020 2020 6966 2068 6176            if hav
+00012040: 655f 6669 743a 0a20 2020 2020 2020 2020  e_fit:.         
+00012050: 2020 2020 2020 2023 2053 6574 2061 2035         # Set a 5
+00012060: 2520 6d61 7267 696e 206f 6e20 6561 6368  % margin on each
+00012070: 2073 6964 650a 2020 2020 2020 2020 2020   side.          
+00012080: 2020 2020 2020 6d61 7267 696e 203d 2030        margin = 0
+00012090: 2e30 3520 2a20 2878 5f75 7070 5f66 6974  .05 * (x_upp_fit
+000120a0: 2d78 5f6c 6f77 5f66 6974 290a 2020 2020  -x_low_fit).    
+000120b0: 2020 2020 2020 2020 2020 2020 785f 6c6f              x_lo
+000120c0: 775f 6669 7420 3d20 6d61 7828 302c 2078  w_fit = max(0, x
+000120d0: 5f6c 6f77 5f66 6974 2d6d 6172 6769 6e29  _low_fit-margin)
+000120e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000120f0: 2078 5f75 7070 5f66 6974 203d 206d 696e   x_upp_fit = min
+00012100: 2874 6266 5f73 6861 7065 5b30 5d2c 2078  (tbf_shape[0], x
+00012110: 5f75 7070 5f66 6974 2b6d 6172 6769 6e29  _upp_fit+margin)
+00012120: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00012130: 6e75 6d5f 746f 6d6f 5f73 7461 636b 7320  num_tomo_stacks 
+00012140: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
+00012150: 2020 2020 2020 6966 2068 6176 655f 6669        if have_fi
+00012160: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00012170: 2020 2020 2020 2023 2053 6574 2074 6865         # Set the
+00012180: 2064 6566 6175 6c74 2072 616e 6765 2074   default range t
+00012190: 6f20 656e 636c 6f73 6520 7468 6520 6675  o enclose the fu
+000121a0: 6c6c 2066 6974 7465 640a 2020 2020 2020  ll fitted.      
+000121b0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000121c0: 2020 2020 7769 6e64 6f77 0a20 2020 2020      window.     
+000121d0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
+000121e0: 5f6c 6f77 203d 2069 6e74 2878 5f6c 6f77  _low = int(x_low
+000121f0: 5f66 6974 290a 2020 2020 2020 2020 2020  _fit).          
+00012200: 2020 2020 2020 2020 2020 785f 7570 7020            x_upp 
+00012210: 3d20 696e 7428 785f 7570 705f 6669 7429  = int(x_upp_fit)
+00012220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012230: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00012240: 2020 2020 2020 2020 2020 2023 2043 656e             # Cen
+00012250: 7465 7220 6120 6465 6661 756c 7420 7261  ter a default ra
+00012260: 6e67 6520 6f66 2031 206d 6d0a 2020 2020  nge of 1 mm.    
+00012270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012280: 2320 5256 2063 616e 2077 6520 6765 7420  # RV can we get 
+00012290: 7468 6973 2066 726f 6d20 7468 6520 736c  this from the sl
+000122a0: 6974 733f 0a20 2020 2020 2020 2020 2020  its?.           
+000122b0: 2020 2020 2020 2020 206e 756d 5f78 5f6d           num_x_m
+000122c0: 696e 203d 2069 6e74 2828 312e 202b 2030  in = int((1. + 0
+000122d0: 2e35 2a70 6978 656c 5f73 697a 6529 202f  .5*pixel_size) /
+000122e0: 2070 6978 656c 5f73 697a 6529 0a20 2020   pixel_size).   
+000122f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012300: 2078 5f6c 6f77 203d 2069 6e74 2828 7462   x_low = int((tb
+00012310: 665f 7368 6170 655b 305d 2d6e 756d 5f78  f_shape[0]-num_x
+00012320: 5f6d 696e 2920 2f20 3229 0a20 2020 2020  _min) / 2).     
+00012330: 2020 2020 2020 2020 2020 2020 2020 2078                 x
+00012340: 5f75 7070 203d 2078 5f6c 6f77 2b6e 756d  _upp = x_low+num
+00012350: 5f78 5f6d 696e 0a20 2020 2020 2020 2020  _x_min.         
+00012360: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00012370: 2020 2020 2020 2020 2023 2047 6574 2074           # Get t
+00012380: 6865 2064 6566 6175 6c74 2072 616e 6765  he default range
+00012390: 2066 726f 6d20 7468 6520 7265 6665 7265   from the refere
+000123a0: 6e63 6520 6865 6967 6874 730a 2020 2020  nce heights.    
+000123b0: 2020 2020 2020 2020 2020 2020 6465 6c74              delt
+000123c0: 615f 7a20 3d20 7665 7274 6963 616c 5f73  a_z = vertical_s
+000123d0: 6869 6674 735b 315d 2d76 6572 7469 6361  hifts[1]-vertica
+000123e0: 6c5f 7368 6966 7473 5b30 5d0a 2020 2020  l_shifts[0].    
+000123f0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00012400: 6920 696e 2072 616e 6765 2832 2c20 6e75  i in range(2, nu
+00012410: 6d5f 746f 6d6f 5f73 7461 636b 7329 3a0a  m_tomo_stacks):.
+00012420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012430: 2020 2020 6465 6c74 615f 7a20 3d20 6d69      delta_z = mi
+00012440: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00012450: 2020 2020 2020 2020 2020 2064 656c 7461             delta
+00012460: 5f7a 2c20 7665 7274 6963 616c 5f73 6869  _z, vertical_shi
+00012470: 6674 735b 695d 2d76 6572 7469 6361 6c5f  fts[i]-vertical_
+00012480: 7368 6966 7473 5b69 2d31 5d29 0a20 2020  shifts[i-1]).   
+00012490: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+000124a0: 662e 5f6c 6f67 6765 722e 6465 6275 6728  f._logger.debug(
+000124b0: 6627 6465 6c74 615f 7a20 3d20 7b64 656c  f'delta_z = {del
+000124c0: 7461 5f7a 7d27 290a 2020 2020 2020 2020  ta_z}').        
+000124d0: 2020 2020 2020 2020 6e75 6d5f 785f 6d69          num_x_mi
+000124e0: 6e20 3d20 696e 7428 2864 656c 7461 5f7a  n = int((delta_z
+000124f0: 202b 2030 2e35 2a70 6978 656c 5f73 697a   + 0.5*pixel_siz
+00012500: 6529 202f 2070 6978 656c 5f73 697a 6529  e) / pixel_size)
+00012510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012520: 2073 656c 662e 5f6c 6f67 6765 722e 6465   self._logger.de
+00012530: 6275 6728 6627 6e75 6d5f 785f 6d69 6e20  bug(f'num_x_min 
+00012540: 3d20 7b6e 756d 5f78 5f6d 696e 7d27 290a  = {num_x_min}').
+00012550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012560: 6966 206e 756d 5f78 5f6d 696e 203e 2074  if num_x_min > t
+00012570: 6266 5f73 6861 7065 5b30 5d3a 0a20 2020  bf_shape[0]:.   
+00012580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012590: 2073 656c 662e 5f6c 6f67 6765 722e 7761   self._logger.wa
+000125a0: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
+000125b0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000125c0: 496d 6167 6520 626f 756e 6473 2061 6e64  Image bounds and
+000125d0: 2070 6978 656c 2073 697a 6520 7072 6576   pixel size prev
+000125e0: 656e 7420 7365 616d 6c65 7373 2027 0a20  ent seamless '. 
+000125f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012600: 2020 2020 2020 202b 2027 7374 6163 6b69         + 'stacki
+00012610: 6e67 2729 0a20 2020 2020 2020 2020 2020  ng').           
+00012620: 2020 2020 2069 6620 6861 7665 5f66 6974       if have_fit
+00012630: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012640: 2020 2020 2020 2320 4365 6e74 6572 2074        # Center t
+00012650: 6865 2064 6566 6175 6c74 2072 616e 6765  he default range
+00012660: 2072 656c 6174 6976 6520 746f 2074 6865   relative to the
+00012670: 2066 6974 7465 640a 2020 2020 2020 2020   fitted.        
+00012680: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+00012690: 2020 7769 6e64 6f77 0a20 2020 2020 2020    window.       
+000126a0: 2020 2020 2020 2020 2020 2020 2078 5f6c               x_l
+000126b0: 6f77 203d 2069 6e74 2828 785f 6c6f 775f  ow = int((x_low_
+000126c0: 6669 742b 785f 7570 705f 6669 742d 6e75  fit+x_upp_fit-nu
+000126d0: 6d5f 785f 6d69 6e29 202f 2032 290a 2020  m_x_min) / 2).  
+000126e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126f0: 2020 785f 7570 7020 3d20 785f 6c6f 772b    x_upp = x_low+
+00012700: 6e75 6d5f 785f 6d69 6e0a 2020 2020 2020  num_x_min.      
+00012710: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00012720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012730: 2020 2020 2320 4365 6e74 6572 2074 6865      # Center the
+00012740: 2064 6566 6175 6c74 2072 616e 6765 0a20   default range. 
+00012750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012760: 2020 2078 5f6c 6f77 203d 2069 6e74 2828     x_low = int((
+00012770: 7462 665f 7368 6170 655b 305d 2d6e 756d  tbf_shape[0]-num
+00012780: 5f78 5f6d 696e 2920 2f20 3229 0a20 2020  _x_min) / 2).   
+00012790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127a0: 2078 5f75 7070 203d 2078 5f6c 6f77 2b6e   x_upp = x_low+n
+000127b0: 756d 5f78 5f6d 696e 0a20 2020 2020 2020  um_x_min.       
+000127c0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+000127d0: 2e5f 696e 7465 7261 6374 6976 653a 0a20  ._interactive:. 
+000127e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000127f0: 6d67 5f78 5f62 6f75 6e64 7320 3d20 2878  mg_x_bounds = (x
+00012800: 5f6c 6f77 2c20 785f 7570 7029 0a20 2020  _low, x_upp).   
+00012810: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00012820: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00012830: 6d70 203d 206e 702e 636f 7079 2874 6266  mp = np.copy(tbf
+00012840: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00012850: 2020 746d 705f 6d61 7820 3d20 746d 702e    tmp_max = tmp.
+00012860: 6d61 7828 290a 2020 2020 2020 2020 2020  max().          
+00012870: 2020 2020 2020 746d 705b 785f 6c6f 772c        tmp[x_low,
+00012880: 3a5d 203d 2074 6d70 5f6d 6178 0a20 2020  :] = tmp_max.   
+00012890: 2020 2020 2020 2020 2020 2020 2074 6d70               tmp
+000128a0: 5b78 5f75 7070 2d31 2c3a 5d20 3d20 746d  [x_upp-1,:] = tm
+000128b0: 705f 6d61 780a 2020 2020 2020 2020 2020  p_max.          
+000128c0: 2020 2020 2020 7175 6963 6b5f 696d 7368        quick_imsh
+000128d0: 6f77 2874 6d70 2c20 7469 746c 653d 2762  ow(tmp, title='b
+000128e0: 7269 6768 7420 6669 656c 6427 290a 2020  right field').  
+000128f0: 2020 2020 2020 2020 2020 2020 2020 746d                tm
+00012900: 7020 3d20 6e70 2e63 6f70 7928 6669 7273  p = np.copy(firs
+00012910: 745f 696d 6167 6529 0a20 2020 2020 2020  t_image).       
+00012920: 2020 2020 2020 2020 2074 6d70 5f6d 6178           tmp_max
+00012930: 203d 2074 6d70 2e6d 6178 2829 0a20 2020   = tmp.max().   
+00012940: 2020 2020 2020 2020 2020 2020 2074 6d70               tmp
+00012950: 5b78 5f6c 6f77 2c3a 5d20 3d20 746d 705f  [x_low,:] = tmp_
+00012960: 6d61 780a 2020 2020 2020 2020 2020 2020  max.            
+00012970: 2020 2020 746d 705b 785f 7570 702d 312c      tmp[x_upp-1,
+00012980: 3a5d 203d 2074 6d70 5f6d 6178 0a20 2020  :] = tmp_max.   
+00012990: 2020 2020 2020 2020 2020 2020 2071 7569               qui
+000129a0: 636b 5f69 6d73 686f 7728 746d 702c 2074  ck_imshow(tmp, t
+000129b0: 6974 6c65 3d74 6974 6c65 290a 2020 2020  itle=title).    
+000129c0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+000129d0: 746d 700a 2020 2020 2020 2020 2020 2020  tmp.            
+000129e0: 2020 2020 7175 6963 6b5f 706c 6f74 280a      quick_plot(.
+000129f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a00: 2020 2020 2872 616e 6765 2878 5f73 756d      (range(x_sum
+00012a10: 2e73 697a 6529 2c20 785f 7375 6d29 2c0a  .size), x_sum),.
+00012a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a30: 2020 2020 285b 785f 6c6f 772c 2078 5f6c      ([x_low, x_l
+00012a40: 6f77 5d2c 205b 785f 7375 6d5f 6d69 6e2c  ow], [x_sum_min,
+00012a50: 2078 5f73 756d 5f6d 6178 5d2c 2027 722d   x_sum_max], 'r-
+00012a60: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00012a70: 2020 2020 2020 2020 285b 785f 7570 702c          ([x_upp,
+00012a80: 2078 5f75 7070 5d2c 205b 785f 7375 6d5f   x_upp], [x_sum_
+00012a90: 6d69 6e2c 2078 5f73 756d 5f6d 6178 5d2c  min, x_sum_max],
+00012aa0: 2027 722d 2729 2c0a 2020 2020 2020 2020   'r-'),.        
+00012ab0: 2020 2020 2020 2020 2020 2020 7469 746c              titl
+00012ac0: 653d 2773 756d 206f 7665 7220 7468 6574  e='sum over thet
+00012ad0: 6120 616e 6420 7927 290a 2020 2020 2020  a and y').      
+00012ae0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00012af0: 6627 6c6f 7765 7220 626f 756e 6420 3d20  f'lower bound = 
+00012b00: 7b78 5f6c 6f77 7d20 2869 6e63 6c75 7369  {x_low} (inclusi
+00012b10: 7665 2927 290a 2020 2020 2020 2020 2020  ve)').          
+00012b20: 2020 2020 2020 7072 696e 7428 6627 7570        print(f'up
+00012b30: 7065 7220 626f 756e 6420 3d20 7b78 5f75  per bound = {x_u
+00012b40: 7070 7d20 2865 7863 6c75 7369 7665 295d  pp} (exclusive)]
+00012b50: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+00012b60: 2020 2061 6363 6570 7420 3d20 696e 7075     accept = inpu
+00012b70: 745f 7965 736e 6f28 2741 6363 6570 7420  t_yesno('Accept 
+00012b80: 7468 6573 6520 626f 756e 6473 2028 792f  these bounds (y/
+00012b90: 6e29 3f27 2c20 2779 2729 0a20 2020 2020  n)?', 'y').     
+00012ba0: 2020 2020 2020 2020 2020 2063 6c65 6172             clear
+00012bb0: 5f69 6d73 686f 7728 2762 7269 6768 7420  _imshow('bright 
+00012bc0: 6669 656c 6427 290a 2020 2020 2020 2020  field').        
+00012bd0: 2020 2020 2020 2020 636c 6561 725f 696d          clear_im
+00012be0: 7368 6f77 2874 6974 6c65 290a 2020 2020  show(title).    
+00012bf0: 2020 2020 2020 2020 2020 2020 636c 6561              clea
+00012c00: 725f 706c 6f74 2827 7375 6d20 6f76 6572  r_plot('sum over
+00012c10: 2074 6865 7461 2061 6e64 2079 2729 0a20   theta and y'). 
+00012c20: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00012c30: 6620 6163 6365 7074 3a0a 2020 2020 2020  f accept:.      
+00012c40: 2020 2020 2020 2020 2020 2020 2020 696d                im
+00012c50: 675f 785f 626f 756e 6473 203d 2028 785f  g_x_bounds = (x_
+00012c60: 6c6f 772c 2078 5f75 7070 290a 2020 2020  low, x_upp).    
+00012c70: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00012c80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012c90: 2020 2020 2020 7768 696c 6520 5472 7565        while True
+00012ca0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012cb0: 2020 2020 2020 2020 2020 5f2c 2069 6d67            _, img
+00012cc0: 5f78 5f62 6f75 6e64 7320 3d20 6472 6177  _x_bounds = draw
+00012cd0: 5f6d 6173 6b5f 3164 280a 2020 2020 2020  _mask_1d(.      
+00012ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012cf0: 2020 2020 2020 785f 7375 6d2c 2074 6974        x_sum, tit
+00012d00: 6c65 3d27 7365 6c65 6374 2078 2064 6174  le='select x dat
+00012d10: 6120 7261 6e67 6527 2c0a 2020 2020 2020  a range',.      
+00012d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d30: 2020 2020 2020 796c 6162 656c 3d27 7375        ylabel='su
+00012d40: 6d20 6f76 6572 2074 6865 7461 2061 6e64  m over theta and
+00012d50: 2079 2729 0a20 2020 2020 2020 2020 2020   y').           
+00012d60: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00012d70: 6c65 6e28 696d 675f 785f 626f 756e 6473  len(img_x_bounds
+00012d80: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
+00012d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012da0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+00012db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012dc0: 2020 7072 696e 7428 2743 686f 6f73 6520    print('Choose 
+00012dd0: 6120 7369 6e67 6c65 2063 6f6e 6e65 6374  a single connect
+00012de0: 6564 2064 6174 6120 7261 6e67 6527 290a  ed data range').
+00012df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e00: 2020 2020 696d 675f 785f 626f 756e 6473      img_x_bounds
+00012e10: 203d 2074 7570 6c65 2869 6d67 5f78 5f62   = tuple(img_x_b
+00012e20: 6f75 6e64 735b 305d 290a 2020 2020 2020  ounds[0]).      
+00012e30: 2020 2020 2020 6966 2028 6e75 6d5f 746f        if (num_to
+00012e40: 6d6f 5f73 7461 636b 7320 3e20 310a 2020  mo_stacks > 1.  
 00012e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012e60: 2020 7468 6574 6173 203d 206e 702e 6173    thetas = np.as
-00012e70: 6172 7261 7928 6e78 7375 6265 6e74 7279  array(nxsubentry
-00012e80: 2e73 616d 706c 652e 726f 7461 7469 6f6e  .sample.rotation
-00012e90: 5f61 6e67 6c65 290a 2020 2020 2020 2020  _angle).        
-00012ea0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00012eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ec0: 2020 6173 7365 7274 2061 6c6c 280a 2020    assert all(.  
-00012ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ee0: 2020 2020 2020 7468 6574 6173 5b69 5d20        thetas[i] 
-00012ef0: 3d3d 2074 6865 7461 2066 6f72 2069 2c20  == theta for i, 
-00012f00: 7468 6574 610a 2020 2020 2020 2020 2020  theta.          
-00012f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f20: 2020 696e 2065 6e75 6d65 7261 7465 286e    in enumerate(n
-00012f30: 7873 7562 656e 7472 792e 7361 6d70 6c65  xsubentry.sample
-00012f40: 2e72 6f74 6174 696f 6e5f 616e 676c 6529  .rotation_angle)
-00012f50: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00012f60: 6e20 7468 6574 6173 0a0a 2020 2020 6465  n thetas..    de
-00012f70: 6620 5f73 6574 5f7a 6f6f 6d5f 6f72 5f64  f _set_zoom_or_d
-00012f80: 656c 7461 5f74 6865 7461 2873 656c 662c  elta_theta(self,
-00012f90: 2074 6865 7461 732c 2064 656c 7461 5f74   thetas, delta_t
-00012fa0: 6865 7461 3d4e 6f6e 6529 3a0a 2020 2020  heta=None):.    
-00012fb0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00012fc0: 5365 7420 7a6f 6f6d 2061 6e64 2f6f 7220  Set zoom and/or 
-00012fd0: 6465 6c74 6120 7468 6574 6120 746f 2072  delta theta to r
-00012fe0: 6564 7563 6520 6d65 6d6f 7279 2074 6865  educe memory the
-00012ff0: 2072 6571 7569 7265 6d65 6e74 0a20 2020   requirement.   
-00013000: 2020 2020 2066 6f72 2074 6865 2061 6e61       for the ana
-00013010: 6c79 7369 732e 0a20 2020 2020 2020 2022  lysis..        "
-00013020: 2222 0a20 2020 2020 2020 2023 204c 6f63  "".        # Loc
-00013030: 616c 206d 6f64 756c 6573 0a20 2020 2020  al modules.     
-00013040: 2020 2066 726f 6d20 4348 4150 2e63 6f6d     from CHAP.com
-00013050: 6d6f 6e2e 7574 696c 732e 6765 6e65 7261  mon.utils.genera
-00013060: 6c20 696d 706f 7274 2069 6e64 6578 5f6e  l import index_n
-00013070: 6561 7265 7374 0a0a 2020 2020 2020 2020  earest..        
-00013080: 6966 2073 656c 662e 5f74 6573 745f 6d6f  if self._test_mo
-00013090: 6465 3a0a 2020 2020 2020 2020 2020 2020  de:.            
-000130a0: 7265 7475 726e 2074 7570 6c65 2873 656c  return tuple(sel
-000130b0: 662e 5f74 6573 745f 636f 6e66 6967 5b27  f._test_config['
-000130c0: 6465 6c74 615f 7468 6574 6127 5d29 0a0a  delta_theta'])..
-000130d0: 2320 2020 2020 2020 2069 6620 696e 7075  #        if inpu
-000130e0: 745f 7965 736e 6f28 0a23 2020 2020 2020  t_yesno(.#      
-000130f0: 2020 2020 2020 2020 2020 275c 6e44 6f20            '\nDo 
-00013100: 796f 7520 7761 6e74 2074 6f20 7a6f 6f6d  you want to zoom
-00013110: 2069 6e20 746f 2072 6564 7563 6520 6d65   in to reduce me
-00013120: 6d6f 7279 2027 0a23 2020 2020 2020 2020  mory '.#        
-00013130: 2020 2020 2020 2020 2b20 2772 6571 7569          + 'requi
-00013140: 7265 6d65 6e74 2028 792f 6e29 3f27 2c20  rement (y/n)?', 
-00013150: 276e 2729 3a0a 2320 2020 2020 2020 2020  'n'):.#         
-00013160: 2020 207a 6f6f 6d5f 7065 7263 203d 2069     zoom_perc = i
-00013170: 6e70 7574 5f69 6e74 280a 2320 2020 2020  nput_int(.#     
-00013180: 2020 2020 2020 2020 2020 2027 2020 2020             '    
-00013190: 456e 7465 7220 7a6f 6f6d 2070 6572 6365  Enter zoom perce
-000131a0: 6e74 6167 6527 2c20 6765 3d31 2c20 6c65  ntage', ge=1, le
-000131b0: 3d31 3030 290a 2320 2020 2020 2020 2065  =100).#        e
-000131c0: 6c73 653a 0a23 2020 2020 2020 2020 2020  lse:.#          
-000131d0: 2020 7a6f 6f6d 5f70 6572 6320 3d20 4e6f    zoom_perc = No
-000131e0: 6e65 0a20 2020 2020 2020 207a 6f6f 6d5f  ne.        zoom_
-000131f0: 7065 7263 203d 204e 6f6e 650a 0a20 2020  perc = None..   
-00013200: 2020 2020 2069 6620 6465 6c74 615f 7468       if delta_th
-00013210: 6574 6120 6973 206e 6f74 204e 6f6e 6520  eta is not None 
-00013220: 616e 6420 6e6f 7420 6973 5f6e 756d 2864  and not is_num(d
-00013230: 656c 7461 5f74 6865 7461 2c20 6774 3d30  elta_theta, gt=0
-00013240: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00013250: 656c 662e 5f6c 6f67 6765 722e 7761 726e  elf._logger.warn
-00013260: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
-00013270: 2020 2020 2066 2749 6e76 616c 6964 2070       f'Invalid p
-00013280: 6172 616d 6574 6572 2064 656c 7461 5f74  arameter delta_t
-00013290: 6865 7461 2028 7b64 656c 7461 5f74 6865  heta ({delta_the
-000132a0: 7461 7d29 2c20 270a 2020 2020 2020 2020  ta}), '.        
-000132b0: 2020 2020 2020 2020 2b20 2769 676e 6f72          + 'ignor
-000132c0: 696e 6720 6465 6c74 615f 7468 6574 6127  ing delta_theta'
-000132d0: 290a 2020 2020 2020 2020 2020 2020 6465  ).            de
-000132e0: 6c74 615f 7468 6574 6120 3d20 4e6f 6e65  lta_theta = None
-000132f0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00013300: 2e5f 696e 7465 7261 6374 6976 653a 0a20  ._interactive:. 
-00013310: 2020 2020 2020 2020 2020 2069 6620 6465             if de
-00013320: 6c74 615f 7468 6574 6120 6973 204e 6f6e  lta_theta is Non
-00013330: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00013340: 2020 2064 656c 7461 5f74 6865 7461 203d     delta_theta =
-00013350: 2074 6865 7461 735b 315d 2d74 6865 7461   thetas[1]-theta
-00013360: 735b 305d 0a20 2020 2020 2020 2020 2020  s[0].           
-00013370: 2070 7269 6e74 2866 2741 7661 696c 6162   print(f'Availab
-00013380: 6c65 2074 6865 7461 2072 616e 6765 3a20  le theta range: 
-00013390: 5b7b 7468 6574 6173 5b30 5d7d 2c20 7b74  [{thetas[0]}, {t
-000133a0: 6865 7461 735b 2d31 5d7d 5d27 290a 2020  hetas[-1]}]').  
-000133b0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-000133c0: 6627 4375 7272 656e 7420 7468 6574 6120  f'Current theta 
-000133d0: 696e 7465 7276 616c 3a20 7b64 656c 7461  interval: {delta
-000133e0: 5f74 6865 7461 7d27 290a 2020 2020 2020  _theta}').      
-000133f0: 2020 2020 2020 6966 2069 6e70 7574 5f79        if input_y
-00013400: 6573 6e6f 280a 2020 2020 2020 2020 2020  esno(.          
-00013410: 2020 2020 2020 2020 2020 2744 6f20 796f            'Do yo
-00013420: 7520 7761 6e74 2074 6f20 6368 616e 6765  u want to change
-00013430: 2074 6865 2074 6865 7461 2069 6e74 6572   the theta inter
-00013440: 7661 6c20 746f 2072 6564 7563 6520 7468  val to reduce th
-00013450: 6520 270a 2020 2020 2020 2020 2020 2020  e '.            
-00013460: 2020 2020 2020 2020 2b20 276d 656d 6f72          + 'memor
-00013470: 7920 7265 7175 6972 656d 656e 7420 2879  y requirement (y
-00013480: 2f6e 293f 272c 2027 6e27 293a 0a20 2020  /n)?', 'n'):.   
-00013490: 2020 2020 2020 2020 2020 2020 2064 656c               del
-000134a0: 7461 5f74 6865 7461 203d 2069 6e70 7574  ta_theta = input
-000134b0: 5f6e 756d 280a 2020 2020 2020 2020 2020  _num(.          
-000134c0: 2020 2020 2020 2020 2020 2720 2020 2045            '    E
-000134d0: 6e74 6572 2074 6865 2064 6573 6972 6564  nter the desired
-000134e0: 2074 6865 7461 2069 6e74 6572 7661 6c27   theta interval'
-000134f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013500: 2020 2020 2020 6765 3d74 6865 7461 735b        ge=thetas[
-00013510: 315d 2d74 6865 7461 735b 305d 2c20 6c74  1]-thetas[0], lt
-00013520: 3d28 7468 6574 6173 5b2d 315d 2d74 6865  =(thetas[-1]-the
-00013530: 7461 735b 305d 292f 3229 0a20 2020 2020  tas[0])/2).     
-00013540: 2020 2069 6620 6465 6c74 615f 7468 6574     if delta_thet
-00013550: 6120 6973 206e 6f74 204e 6f6e 653a 0a20  a is not None:. 
-00013560: 2020 2020 2020 2020 2020 2064 656c 7461             delta
-00013570: 5f74 6865 7461 203d 2069 6e64 6578 5f6e  _theta = index_n
-00013580: 6561 7265 7374 2874 6865 7461 732c 2074  earest(thetas, t
-00013590: 6865 7461 735b 305d 2b64 656c 7461 5f74  hetas[0]+delta_t
-000135a0: 6865 7461 290a 2020 2020 2020 2020 2020  heta).          
-000135b0: 2020 6966 2064 656c 7461 5f74 6865 7461    if delta_theta
-000135c0: 203c 3d20 313a 0a20 2020 2020 2020 2020   <= 1:.         
-000135d0: 2020 2020 2020 2064 656c 7461 5f74 6865         delta_the
-000135e0: 7461 203d 204e 6f6e 650a 0a20 2020 2020  ta = None..     
-000135f0: 2020 2072 6574 7572 6e20 7a6f 6f6d 5f70     return zoom_p
-00013600: 6572 632c 2064 656c 7461 5f74 6865 7461  erc, delta_theta
-00013610: 0a0a 2020 2020 6465 6620 5f67 656e 5f74  ..    def _gen_t
-00013620: 6f6d 6f28 7365 6c66 2c20 6e78 656e 7472  omo(self, nxentr
-00013630: 792c 2072 6564 7563 6564 5f64 6174 6129  y, reduced_data)
-00013640: 3a0a 2020 2020 2020 2020 2222 2247 656e  :.        """Gen
-00013650: 6572 6174 6520 746f 6d6f 6772 6170 6879  erate tomography
-00013660: 2066 6965 6c64 732e 2222 220a 2020 2020   fields.""".    
-00013670: 2020 2020 2320 5468 6972 6420 7061 7274      # Third part
-00013680: 7920 6d6f 6475 6c65 730a 2020 2020 2020  y modules.      
-00013690: 2020 6672 6f6d 206e 756d 6578 7072 2069    from numexpr i
-000136a0: 6d70 6f72 7420 6576 616c 7561 7465 0a20  mport evaluate. 
-000136b0: 2020 2020 2020 2066 726f 6d20 7363 6970         from scip
-000136c0: 792e 6e64 696d 6167 6520 696d 706f 7274  y.ndimage import
-000136d0: 207a 6f6f 6d0a 0a20 2020 2020 2020 2023   zoom..        #
-000136e0: 204c 6f63 616c 206d 6f64 756c 6573 0a20   Local modules. 
-000136f0: 2020 2020 2020 2066 726f 6d20 4348 4150         from CHAP
-00013700: 2e63 6f6d 6d6f 6e2e 6d6f 6465 6c73 2e6d  .common.models.m
-00013710: 6170 2069 6d70 6f72 7420 280a 2020 2020  ap import (.    
-00013720: 2020 2020 2020 2020 6765 745f 7363 616e          get_scan
-00013730: 7061 7273 6572 2c0a 2020 2020 2020 2020  parser,.        
-00013740: 2020 2020 696d 706f 7274 5f73 6361 6e70      import_scanp
-00013750: 6172 7365 722c 0a20 2020 2020 2020 2029  arser,.        )
-00013760: 0a0a 2020 2020 2020 2020 2320 4765 7420  ..        # Get 
-00013770: 6675 6c6c 2062 7269 6768 7420 6669 656c  full bright fiel
-00013780: 640a 2020 2020 2020 2020 7462 6620 3d20  d.        tbf = 
-00013790: 6e70 2e61 7361 7272 6179 2872 6564 7563  np.asarray(reduc
-000137a0: 6564 5f64 6174 612e 6461 7461 2e62 7269  ed_data.data.bri
-000137b0: 6768 745f 6669 656c 6429 0a20 2020 2020  ght_field).     
-000137c0: 2020 2074 6266 5f73 6861 7065 203d 2074     tbf_shape = t
-000137d0: 6266 2e73 6861 7065 0a0a 2020 2020 2020  bf.shape..      
-000137e0: 2020 2320 4765 7420 696d 6167 6520 626f    # Get image bo
-000137f0: 756e 6473 0a20 2020 2020 2020 2069 6d67  unds.        img
-00013800: 5f78 5f62 6f75 6e64 7320 3d20 7475 706c  _x_bounds = tupl
-00013810: 6528 0a20 2020 2020 2020 2020 2020 2072  e(.            r
-00013820: 6564 7563 6564 5f64 6174 612e 6765 7428  educed_data.get(
-00013830: 2769 6d67 5f78 5f62 6f75 6e64 7327 2c20  'img_x_bounds', 
-00013840: 2830 2c20 7462 665f 7368 6170 655b 305d  (0, tbf_shape[0]
-00013850: 2929 290a 2020 2020 2020 2020 696d 675f  ))).        img_
-00013860: 795f 626f 756e 6473 203d 2074 7570 6c65  y_bounds = tuple
-00013870: 280a 2020 2020 2020 2020 2020 2020 7265  (.            re
-00013880: 6475 6365 645f 6461 7461 2e67 6574 2827  duced_data.get('
-00013890: 696d 675f 795f 626f 756e 6473 272c 2028  img_y_bounds', (
-000138a0: 302c 2074 6266 5f73 6861 7065 5b31 5d29  0, tbf_shape[1])
-000138b0: 2929 0a0a 2020 2020 2020 2020 2320 4765  ))..        # Ge
-000138c0: 7420 7265 7369 7a65 6420 6461 726b 2066  t resized dark f
-000138d0: 6965 6c64 0a20 2020 2020 2020 2069 6620  ield.        if 
-000138e0: 2764 6172 6b5f 6669 656c 6427 2069 6e20  'dark_field' in 
-000138f0: 7265 6475 6365 645f 6461 7461 2e64 6174  reduced_data.dat
-00013900: 613a 0a20 2020 2020 2020 2020 2020 2074  a:.            t
-00013910: 6466 203d 206e 702e 6173 6172 7261 7928  df = np.asarray(
-00013920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013930: 2072 6564 7563 6564 5f64 6174 612e 6461   reduced_data.da
-00013940: 7461 2e64 6172 6b5f 6669 656c 645b 0a20  ta.dark_field[. 
-00013950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013960: 2020 2069 6d67 5f78 5f62 6f75 6e64 735b     img_x_bounds[
-00013970: 305d 3a69 6d67 5f78 5f62 6f75 6e64 735b  0]:img_x_bounds[
-00013980: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
-00013990: 2020 2020 2020 2020 696d 675f 795f 626f          img_y_bo
-000139a0: 756e 6473 5b30 5d3a 696d 675f 795f 626f  unds[0]:img_y_bo
-000139b0: 756e 6473 5b31 5d5d 290a 2020 2020 2020  unds[1]]).      
-000139c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000139d0: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-000139e0: 2e77 6172 6e69 6e67 2827 4461 726b 2066  .warning('Dark f
-000139f0: 6965 6c64 2075 6e61 7661 696c 6162 6c65  ield unavailable
-00013a00: 2729 0a20 2020 2020 2020 2020 2020 2074  ').            t
-00013a10: 6466 203d 204e 6f6e 650a 0a20 2020 2020  df = None..     
-00013a20: 2020 2023 2052 6573 697a 6520 6272 6967     # Resize brig
-00013a30: 6874 2066 6965 6c64 0a20 2020 2020 2020  ht field.       
-00013a40: 2069 6620 2869 6d67 5f78 5f62 6f75 6e64   if (img_x_bound
-00013a50: 7320 213d 2028 302c 2074 6266 2e73 6861  s != (0, tbf.sha
-00013a60: 7065 5b30 5d29 0a20 2020 2020 2020 2020  pe[0]).         
-00013a70: 2020 2020 2020 206f 7220 696d 675f 795f         or img_y_
-00013a80: 626f 756e 6473 2021 3d20 2830 2c20 7462  bounds != (0, tb
-00013a90: 662e 7368 6170 655b 315d 2929 3a0a 2020  f.shape[1])):.  
-00013aa0: 2020 2020 2020 2020 2020 7462 6620 3d20            tbf = 
-00013ab0: 7462 665b 0a20 2020 2020 2020 2020 2020  tbf[.           
-00013ac0: 2020 2020 2069 6d67 5f78 5f62 6f75 6e64       img_x_bound
-00013ad0: 735b 305d 3a69 6d67 5f78 5f62 6f75 6e64  s[0]:img_x_bound
-00013ae0: 735b 315d 2c0a 2020 2020 2020 2020 2020  s[1],.          
-00013af0: 2020 2020 2020 696d 675f 795f 626f 756e        img_y_boun
-00013b00: 6473 5b30 5d3a 696d 675f 795f 626f 756e  ds[0]:img_y_boun
-00013b10: 6473 5b31 5d5d 0a0a 2020 2020 2020 2020  ds[1]]..        
-00013b20: 2320 4765 7420 7468 6574 6173 2028 696e  # Get thetas (in
-00013b30: 2064 6567 7265 6573 290a 2020 2020 2020   degrees).      
-00013b40: 2020 7468 6574 6173 203d 206e 702e 6173    thetas = np.as
-00013b50: 6172 7261 7928 7265 6475 6365 645f 6461  array(reduced_da
-00013b60: 7461 2e72 6f74 6174 696f 6e5f 616e 676c  ta.rotation_angl
-00013b70: 6529 0a0a 2020 2020 2020 2020 2320 4765  e)..        # Ge
-00013b80: 7420 6f72 2063 7265 6174 6520 696d 6167  t or create imag
-00013b90: 6520 6d61 736b 0a20 2020 2020 2020 2069  e mask.        i
-00013ba0: 6d61 6765 5f6d 6173 6b20 3d20 7265 6475  mage_mask = redu
-00013bb0: 6365 645f 6461 7461 2e67 6574 2827 696d  ced_data.get('im
-00013bc0: 6167 655f 6d61 736b 2729 0a20 2020 2020  age_mask').     
-00013bd0: 2020 2069 6620 696d 6167 655f 6d61 736b     if image_mask
-00013be0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00013bf0: 2020 2020 2020 696d 6167 655f 6d61 736b        image_mask
-00013c00: 203d 206e 702e 6f6e 6573 286c 656e 2874   = np.ones(len(t
-00013c10: 6865 7461 7329 2c20 6474 7970 653d 626f  hetas), dtype=bo
-00013c20: 6f6c 290a 2020 2020 2020 2020 656c 7365  ol).        else
-00013c30: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
-00013c40: 6167 655f 6d61 736b 203d 206e 702e 6173  age_mask = np.as
-00013c50: 6172 7261 7928 696d 6167 655f 6d61 736b  array(image_mask
-00013c60: 290a 2320 2020 2020 2020 2065 7869 7428  ).#        exit(
-00013c70: 6627 696d 6167 655f 6d61 736b 207b 7479  f'image_mask {ty
-00013c80: 7065 2869 6d61 6765 5f6d 6173 6b29 7d20  pe(image_mask)} 
-00013c90: 7b6c 656e 2869 6d61 6765 5f6d 6173 6b29  {len(image_mask)
-00013ca0: 7d3a 207b 696d 6167 655f 6d61 736b 7d27  }: {image_mask}'
-00013cb0: 290a 0a20 2020 2020 2020 2023 2047 6574  )..        # Get
-00013cc0: 2074 6865 2074 6f6d 6f67 7261 7068 7920   the tomography 
-00013cd0: 696d 6167 6573 0a20 2020 2020 2020 2069  images.        i
-00013ce0: 6d61 6765 5f6b 6579 203d 206e 7865 6e74  mage_key = nxent
-00013cf0: 7279 2e69 6e73 7472 756d 656e 742e 6465  ry.instrument.de
-00013d00: 7465 6374 6f72 2e67 6574 2827 696d 6167  tector.get('imag
-00013d10: 655f 6b65 7927 2c20 4e6f 6e65 290a 2020  e_key', None).  
-00013d20: 2020 2020 2020 6966 2069 6d61 6765 5f6b        if image_k
-00013d30: 6579 2069 7320 6e6f 7420 4e6f 6e65 2061  ey is not None a
-00013d40: 6e64 2027 6461 7461 2720 696e 206e 7865  nd 'data' in nxe
-00013d50: 6e74 7279 2e69 6e73 7472 756d 656e 742e  ntry.instrument.
-00013d60: 6465 7465 6374 6f72 3a0a 2020 2020 2020  detector:.      
-00013d70: 2020 2020 2020 6669 656c 645f 696e 6469        field_indi
-00013d80: 6365 735f 616c 6c20 3d20 5b0a 2020 2020  ces_all = [.    
-00013d90: 2020 2020 2020 2020 2020 2020 696e 6465              inde
-00013da0: 7820 666f 7220 696e 6465 782c 206b 6579  x for index, key
-00013db0: 2069 6e20 656e 756d 6572 6174 6528 696d   in enumerate(im
-00013dc0: 6167 655f 6b65 7929 2069 6620 6b65 7920  age_key) if key 
-00013dd0: 3d3d 2030 5d0a 2020 2020 2020 2020 2020  == 0].          
-00013de0: 2020 7a5f 7472 616e 736c 6174 696f 6e5f    z_translation_
-00013df0: 616c 6c20 3d20 6e78 656e 7472 792e 7361  all = nxentry.sa
-00013e00: 6d70 6c65 2e7a 5f74 7261 6e73 6c61 7469  mple.z_translati
-00013e10: 6f6e 5b66 6965 6c64 5f69 6e64 6963 6573  on[field_indices
-00013e20: 5f61 6c6c 5d0a 2020 2020 2020 2020 2020  _all].          
-00013e30: 2020 7a5f 7472 616e 736c 6174 696f 6e5f    z_translation_
-00013e40: 6c65 7665 6c73 203d 2073 6f72 7465 6428  levels = sorted(
-00013e50: 6c69 7374 2873 6574 287a 5f74 7261 6e73  list(set(z_trans
-00013e60: 6c61 7469 6f6e 5f61 6c6c 2929 290a 2020  lation_all))).  
-00013e70: 2020 2020 2020 2020 2020 6e75 6d5f 746f            num_to
-00013e80: 6d6f 5f73 7461 636b 7320 3d20 6c65 6e28  mo_stacks = len(
-00013e90: 7a5f 7472 616e 736c 6174 696f 6e5f 6c65  z_translation_le
-00013ea0: 7665 6c73 290a 2020 2020 2020 2020 2020  vels).          
-00013eb0: 2020 746f 6d6f 5f73 7461 636b 7320 3d20    tomo_stacks = 
-00013ec0: 6e75 6d5f 746f 6d6f 5f73 7461 636b 732a  num_tomo_stacks*
-00013ed0: 5b6e 702e 6172 7261 7928 5b5d 295d 0a20  [np.array([])]. 
-00013ee0: 2020 2020 2020 2020 2020 2068 6f72 697a             horiz
-00013ef0: 6f6e 7461 6c5f 7368 6966 7473 203d 205b  ontal_shifts = [
-00013f00: 5d0a 2020 2020 2020 2020 2020 2020 7665  ].            ve
-00013f10: 7274 6963 616c 5f73 6869 6674 7320 3d20  rtical_shifts = 
-00013f20: 5b5d 0a20 2020 2020 2020 2020 2020 2074  [].            t
-00013f30: 6f6d 6f5f 7374 6163 6b73 203d 205b 5d0a  omo_stacks = [].
-00013f40: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00013f50: 692c 207a 5f74 7261 6e73 6c61 7469 6f6e  i, z_translation
-00013f60: 2069 6e20 656e 756d 6572 6174 6528 7a5f   in enumerate(z_
-00013f70: 7472 616e 736c 6174 696f 6e5f 6c65 7665  translation_leve
-00013f80: 6c73 293a 0a20 2020 2020 2020 2020 2020  ls):.           
-00013f90: 2020 2020 2066 6965 6c64 5f69 6e64 6963       field_indic
-00013fa0: 6573 203d 205b 0a20 2020 2020 2020 2020  es = [.         
-00013fb0: 2020 2020 2020 2020 2020 2066 6965 6c64             field
-00013fc0: 5f69 6e64 6963 6573 5f61 6c6c 5b69 6e64  _indices_all[ind
-00013fd0: 6578 5d0a 2020 2020 2020 2020 2020 2020  ex].            
-00013fe0: 2020 2020 2020 2020 666f 7220 696e 6465          for inde
-00013ff0: 782c 207a 2069 6e20 656e 756d 6572 6174  x, z in enumerat
-00014000: 6528 7a5f 7472 616e 736c 6174 696f 6e5f  e(z_translation_
-00014010: 616c 6c29 0a20 2020 2020 2020 2020 2020  all).           
-00014020: 2020 2020 2020 2020 2069 6620 7a20 3d3d           if z ==
-00014030: 207a 5f74 7261 6e73 6c61 7469 6f6e 5d0a   z_translation].
-00014040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014050: 6669 656c 645f 696e 6469 6365 735f 6d61  field_indices_ma
-00014060: 736b 6564 203d 2066 6965 6c64 5f69 6e64  sked = field_ind
-00014070: 6963 6573 5b69 6d61 6765 5f6d 6173 6b5d  ices[image_mask]
-00014080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014090: 2068 6f72 697a 6f6e 7461 6c5f 7368 6966   horizontal_shif
-000140a0: 7420 3d20 6e70 2e61 7361 7272 6179 280a  t = np.asarray(.
-000140b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140c0: 2020 2020 7365 7428 6e78 656e 7472 792e      set(nxentry.
-000140d0: 7361 6d70 6c65 2e78 5f74 7261 6e73 6c61  sample.x_transla
-000140e0: 7469 6f6e 5b66 6965 6c64 5f69 6e64 6963  tion[field_indic
-000140f0: 6573 5f6d 6173 6b65 645d 2929 0a20 2020  es_masked])).   
-00014100: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-00014110: 6572 7420 6c65 6e28 686f 7269 7a6f 6e74  ert len(horizont
-00014120: 616c 5f73 6869 6674 2920 3d3d 2031 0a20  al_shift) == 1. 
-00014130: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00014140: 6f72 697a 6f6e 7461 6c5f 7368 6966 7473  orizontal_shifts
-00014150: 202b 3d20 6c69 7374 2868 6f72 697a 6f6e   += list(horizon
-00014160: 7461 6c5f 7368 6966 7429 0a20 2020 2020  tal_shift).     
-00014170: 2020 2020 2020 2020 2020 2076 6572 7469             verti
-00014180: 6361 6c5f 7368 6966 7420 3d20 6e70 2e61  cal_shift = np.a
-00014190: 7361 7272 6179 280a 2020 2020 2020 2020  sarray(.        
-000141a0: 2020 2020 2020 2020 2020 2020 7365 7428              set(
-000141b0: 6e78 656e 7472 792e 7361 6d70 6c65 2e7a  nxentry.sample.z
-000141c0: 5f74 7261 6e73 6c61 7469 6f6e 5b66 6965  _translation[fie
-000141d0: 6c64 5f69 6e64 6963 6573 5f6d 6173 6b65  ld_indices_maske
-000141e0: 645d 2929 0a20 2020 2020 2020 2020 2020  d])).           
-000141f0: 2020 2020 2061 7373 6572 7420 6c65 6e28       assert len(
-00014200: 7665 7274 6963 616c 5f73 6869 6674 2920  vertical_shift) 
-00014210: 3d3d 2031 0a20 2020 2020 2020 2020 2020  == 1.           
-00014220: 2020 2020 2076 6572 7469 6361 6c5f 7368       vertical_sh
-00014230: 6966 7473 202b 3d20 7665 7274 6963 616c  ifts += vertical
-00014240: 5f73 6869 6674 0a20 2020 2020 2020 2020  _shift.         
-00014250: 2020 2020 2020 2073 6571 7565 6e63 655f         sequence_
-00014260: 6e75 6d62 6572 7320 3d20 6e78 656e 7472  numbers = nxentr
-00014270: 792e 696e 7374 7275 6d65 6e74 2e64 6574  y.instrument.det
-00014280: 6563 746f 722e 7365 7175 656e 6365 5f6e  ector.sequence_n
-00014290: 756d 6265 725b 0a20 2020 2020 2020 2020  umber[.         
-000142a0: 2020 2020 2020 2020 2020 2066 6965 6c64             field
-000142b0: 5f69 6e64 6963 6573 5d0a 2020 2020 2020  _indices].      
-000142c0: 2020 2020 2020 2020 2020 6966 2028 6c69            if (li
-000142d0: 7374 2873 6571 7565 6e63 655f 6e75 6d62  st(sequence_numb
-000142e0: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
-000142f0: 2020 2020 2020 2020 2020 2020 203d 3d20               == 
-00014300: 6c69 7374 2872 616e 6765 2828 6c65 6e28  list(range((len(
-00014310: 7365 7175 656e 6365 5f6e 756d 6265 7273  sequence_numbers
-00014320: 2929 2929 293a 0a20 2020 2020 2020 2020  ))))):.         
-00014330: 2020 2020 2020 2020 2020 2074 6f6d 6f5f             tomo_
-00014340: 7374 6163 6b20 3d20 6e70 2e61 7361 7272  stack = np.asarr
-00014350: 6179 280a 2020 2020 2020 2020 2020 2020  ay(.            
-00014360: 2020 2020 2020 2020 2020 2020 6e78 656e              nxen
-00014370: 7472 792e 696e 7374 7275 6d65 6e74 2e64  try.instrument.d
-00014380: 6574 6563 746f 722e 6461 7461 5b0a 2020  etector.data[.  
-00014390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000143a0: 2020 2020 2020 2020 2020 6669 656c 645f            field_
-000143b0: 696e 6469 6365 735f 6d61 736b 6564 5d29  indices_masked])
-000143c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000143d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000143e0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-000143f0: 2052 756e 7469 6d65 4572 726f 7228 2755   RuntimeError('U
-00014400: 6e61 626c 6520 746f 206c 6f61 6420 7468  nable to load th
-00014410: 6520 746f 6d6f 6772 6170 6879 2069 6d61  e tomography ima
-00014420: 6765 7327 290a 2020 2020 2020 2020 2020  ges').          
-00014430: 2020 2020 2020 746f 6d6f 5f73 7461 636b        tomo_stack
-00014440: 732e 6170 7065 6e64 2874 6f6d 6f5f 7374  s.append(tomo_st
-00014450: 6163 6b29 0a20 2020 2020 2020 2065 6c73  ack).        els
-00014460: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-00014470: 6d70 6f72 745f 7363 616e 7061 7273 6572  mport_scanparser
-00014480: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00014490: 2020 6e78 656e 7472 792e 696e 7374 7275    nxentry.instru
-000144a0: 6d65 6e74 2e73 6f75 7263 652e 6174 7472  ment.source.attr
-000144b0: 735b 2773 7461 7469 6f6e 275d 2c0a 2020  s['station'],.  
-000144c0: 2020 2020 2020 2020 2020 2020 2020 6e78                nx
-000144d0: 656e 7472 792e 696e 7374 7275 6d65 6e74  entry.instrument
-000144e0: 2e73 6f75 7263 652e 6174 7472 735b 2765  .source.attrs['e
-000144f0: 7870 6572 696d 656e 745f 7479 7065 275d  xperiment_type']
-00014500: 290a 2020 2020 2020 2020 2020 2020 746f  ).            to
-00014510: 6d6f 5f66 6965 6c64 5f73 6361 6e73 203d  mo_field_scans =
-00014520: 206e 7865 6e74 7279 2e73 7065 635f 7363   nxentry.spec_sc
-00014530: 616e 732e 746f 6d6f 5f66 6965 6c64 730a  ans.tomo_fields.
-00014540: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
-00014550: 746f 6d6f 5f73 7461 636b 7320 3d20 6c65  tomo_stacks = le
-00014560: 6e28 746f 6d6f 5f66 6965 6c64 5f73 6361  n(tomo_field_sca
-00014570: 6e73 2e6b 6579 7328 2929 0a20 2020 2020  ns.keys()).     
-00014580: 2020 2020 2020 2064 6574 6563 746f 725f         detector_
-00014590: 7072 6566 6978 203d 2073 7472 286e 7865  prefix = str(nxe
-000145a0: 6e74 7279 2e69 6e73 7472 756d 656e 742e  ntry.instrument.
-000145b0: 6465 7465 6374 6f72 2e6c 6f63 616c 5f6e  detector.local_n
-000145c0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-000145d0: 2074 6f6d 6f5f 7374 6163 6b73 203d 205b   tomo_stacks = [
-000145e0: 5d0a 2020 2020 2020 2020 2020 2020 686f  ].            ho
-000145f0: 7269 7a6f 6e74 616c 5f73 6869 6674 7320  rizontal_shifts 
-00014600: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-00014610: 2076 6572 7469 6361 6c5f 7368 6966 7473   vertical_shifts
-00014620: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-00014630: 2020 666f 7220 6e78 7375 6265 6e74 7279    for nxsubentry
-00014640: 5f6e 616d 652c 206e 7873 7562 656e 7472  _name, nxsubentr
-00014650: 7920 696e 2074 6f6d 6f5f 6669 656c 645f  y in tomo_field_
-00014660: 7363 616e 732e 6974 656d 7328 293a 0a20  scans.items():. 
-00014670: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00014680: 6361 6e5f 6e75 6d62 6572 203d 2069 6e74  can_number = int
-00014690: 286e 7873 7562 656e 7472 795f 6e61 6d65  (nxsubentry_name
-000146a0: 2e73 706c 6974 2827 5f27 295b 2d31 5d29  .split('_')[-1])
-000146b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000146c0: 2073 6361 6e70 6172 7365 7220 3d20 6765   scanparser = ge
-000146d0: 745f 7363 616e 7061 7273 6572 280a 2020  t_scanparser(.  
-000146e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000146f0: 2020 746f 6d6f 5f66 6965 6c64 5f73 6361    tomo_field_sca
-00014700: 6e73 2e61 7474 7273 5b27 7370 6563 5f66  ns.attrs['spec_f
-00014710: 696c 6527 5d2c 2073 6361 6e5f 6e75 6d62  ile'], scan_numb
-00014720: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
-00014730: 2020 2020 696d 6167 655f 6f66 6673 6574      image_offset
-00014740: 203d 2069 6e74 280a 2020 2020 2020 2020   = int(.        
-00014750: 2020 2020 2020 2020 2020 2020 6e78 7375              nxsu
-00014760: 6265 6e74 7279 2e69 6e73 7472 756d 656e  bentry.instrumen
-00014770: 742e 6465 7465 6374 6f72 2e66 7261 6d65  t.detector.frame
-00014780: 5f73 7461 7274 5f6e 756d 6265 7229 0a20  _start_number). 
-00014790: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000147a0: 6f6d 6f5f 7374 6163 6b20 3d20 5b5d 0a20  omo_stack = []. 
-000147b0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-000147c0: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
-000147d0: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
-000147e0: 6e67 6528 696d 6167 655f 6d61 736b 2e73  nge(image_mask.s
-000147f0: 697a 6529 3a0a 2020 2020 2020 2020 2020  ize):.          
-00014800: 2020 2020 2020 2020 2020 6966 2069 6d61            if ima
-00014810: 6765 5f6d 6173 6b5b 695d 3a0a 2020 2020  ge_mask[i]:.    
-00014820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014830: 2020 2020 746f 6d6f 5f73 7461 636b 2e61      tomo_stack.a
-00014840: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
-00014850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014860: 2020 2073 6361 6e70 6172 7365 722e 6765     scanparser.ge
-00014870: 745f 6465 7465 6374 6f72 5f64 6174 6128  t_detector_data(
-00014880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148a0: 2064 6574 6563 746f 725f 7072 6566 6978   detector_prefix
-000148b0: 2c20 696d 6167 655f 6f66 6673 6574 2b6e  , image_offset+n
-000148c0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-000148d0: 2020 2020 2020 2020 2020 206e 202b 3d20             n += 
-000148e0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-000148f0: 2020 746f 6d6f 5f73 7461 636b 732e 6170    tomo_stacks.ap
-00014900: 7065 6e64 286e 702e 6173 6172 7261 7928  pend(np.asarray(
-00014910: 746f 6d6f 5f73 7461 636b 2929 0a20 2020  tomo_stack)).   
-00014920: 2020 2020 2020 2020 2020 2020 2068 6f72               hor
-00014930: 697a 6f6e 7461 6c5f 7368 6966 7420 3d20  izontal_shift = 
-00014940: 666c 6f61 7428 6e78 7375 6265 6e74 7279  float(nxsubentry
-00014950: 2e73 616d 706c 652e 785f 7472 616e 736c  .sample.x_transl
-00014960: 6174 696f 6e29 0a20 2020 2020 2020 2020  ation).         
-00014970: 2020 2020 2020 2068 6f72 697a 6f6e 7461         horizonta
-00014980: 6c5f 7368 6966 7473 2e61 7070 656e 6428  l_shifts.append(
-00014990: 686f 7269 7a6f 6e74 616c 5f73 6869 6674  horizontal_shift
-000149a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000149b0: 2020 7665 7274 6963 616c 5f73 6869 6674    vertical_shift
-000149c0: 203d 2066 6c6f 6174 286e 7873 7562 656e   = float(nxsuben
-000149d0: 7472 792e 7361 6d70 6c65 2e7a 5f74 7261  try.sample.z_tra
-000149e0: 6e73 6c61 7469 6f6e 290a 2020 2020 2020  nslation).      
-000149f0: 2020 2020 2020 2020 2020 7665 7274 6963            vertic
-00014a00: 616c 5f73 6869 6674 732e 6170 7065 6e64  al_shifts.append
-00014a10: 2876 6572 7469 6361 6c5f 7368 6966 7429  (vertical_shift)
-00014a20: 0a0a 2020 2020 2020 2020 7265 6475 6365  ..        reduce
-00014a30: 645f 746f 6d6f 5f73 7461 636b 7320 3d20  d_tomo_stacks = 
-00014a40: 5b5d 0a20 2020 2020 2020 2066 6f72 2069  [].        for i
-00014a50: 2c20 746f 6d6f 5f73 7461 636b 2069 6e20  , tomo_stack in 
-00014a60: 656e 756d 6572 6174 6528 746f 6d6f 5f73  enumerate(tomo_s
-00014a70: 7461 636b 7329 3a0a 2020 2020 2020 2020  tacks):.        
-00014a80: 2020 2020 2320 5265 7369 7a65 2074 6865      # Resize the
-00014a90: 2074 6f6d 6f67 7261 7068 7920 696d 6167   tomography imag
-00014aa0: 6573 0a20 2020 2020 2020 2020 2020 2023  es.            #
-00014ab0: 2052 6967 6874 206e 6f77 2074 6865 2072   Right now the r
-00014ac0: 616e 6765 2069 7320 7468 6520 7361 6d65  ange is the same
-00014ad0: 2066 6f72 2065 6163 6820 7365 7420 696e   for each set in
-00014ae0: 2074 6865 2073 7461 636b 0a20 2020 2020   the stack.     
-00014af0: 2020 2020 2020 2061 7373 6572 7420 6c65         assert le
-00014b00: 6e28 7468 6574 6173 2920 3d3d 2074 6f6d  n(thetas) == tom
-00014b10: 6f5f 7374 6163 6b2e 7368 6170 655b 305d  o_stack.shape[0]
-00014b20: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00014b30: 2869 6d67 5f78 5f62 6f75 6e64 7320 3d3d  (img_x_bounds ==
-00014b40: 2028 302c 2074 6266 2e73 6861 7065 5b30   (0, tbf.shape[0
-00014b50: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-00014b60: 2020 2020 2020 2061 6e64 2069 6d67 5f79         and img_y
-00014b70: 5f62 6f75 6e64 7320 3d3d 2028 302c 2074  _bounds == (0, t
-00014b80: 6266 2e73 6861 7065 5b31 5d29 293a 0a20  bf.shape[1])):. 
-00014b90: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00014ba0: 6f6d 6f5f 7374 6163 6b20 3d20 746f 6d6f  omo_stack = tomo
-00014bb0: 5f73 7461 636b 2e61 7374 7970 6528 2766  _stack.astype('f
-00014bc0: 6c6f 6174 3634 272c 2063 6f70 793d 4661  loat64', copy=Fa
-00014bd0: 6c73 6529 0a20 2020 2020 2020 2020 2020  lse).           
-00014be0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00014bf0: 2020 2020 2020 2074 6f6d 6f5f 7374 6163         tomo_stac
-00014c00: 6b20 3d20 746f 6d6f 5f73 7461 636b 5b0a  k = tomo_stack[.
-00014c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014c20: 2020 2020 3a2c 696d 675f 785f 626f 756e      :,img_x_boun
-00014c30: 6473 5b30 5d3a 696d 675f 785f 626f 756e  ds[0]:img_x_boun
-00014c40: 6473 5b31 5d2c 0a20 2020 2020 2020 2020  ds[1],.         
-00014c50: 2020 2020 2020 2020 2020 2069 6d67 5f79             img_y
-00014c60: 5f62 6f75 6e64 735b 305d 3a69 6d67 5f79  _bounds[0]:img_y
-00014c70: 5f62 6f75 6e64 735b 315d 5d2e 6173 7479  _bounds[1]].asty
-00014c80: 7065 280a 2020 2020 2020 2020 2020 2020  pe(.            
-00014c90: 2020 2020 2020 2020 2020 2020 2766 6c6f              'flo
-00014ca0: 6174 3634 272c 2063 6f70 793d 4661 6c73  at64', copy=Fals
-00014cb0: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
-00014cc0: 2320 5375 6274 7261 6374 2064 6172 6b20  # Subtract dark 
-00014cd0: 6669 656c 640a 2020 2020 2020 2020 2020  field.          
-00014ce0: 2020 6966 2074 6466 2069 7320 6e6f 7420    if tdf is not 
-00014cf0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00014d00: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00014d10: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00014d20: 6974 6820 5365 744e 756d 6578 7072 5468  ith SetNumexprTh
-00014d30: 7265 6164 7328 7365 6c66 2e5f 6e75 6d5f  reads(self._num_
-00014d40: 636f 7265 293a 0a20 2020 2020 2020 2020  core):.         
-00014d50: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00014d60: 7661 6c75 6174 6528 2774 6f6d 6f5f 7374  valuate('tomo_st
-00014d70: 6163 6b2d 7464 6627 2c20 6f75 743d 746f  ack-tdf', out=to
-00014d80: 6d6f 5f73 7461 636b 290a 2020 2020 2020  mo_stack).      
-00014d90: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00014da0: 2054 7970 6545 7272 6f72 2061 7320 653a   TypeError as e:
-00014db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014dc0: 2020 2020 2073 7973 5f65 7869 7428 0a20       sys_exit(. 
-00014dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014de0: 2020 2020 2020 2066 275c 6e41 207b 7479         f'\nA {ty
-00014df0: 7065 2865 292e 5f5f 6e61 6d65 5f5f 7d20  pe(e).__name__} 
-00014e00: 6f63 6375 7265 6420 7768 696c 6520 7375  occured while su
-00014e10: 6274 7261 6374 696e 6720 270a 2020 2020  btracting '.    
-00014e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e30: 2020 2020 2b20 2774 6865 2064 6172 6b20      + 'the dark 
-00014e40: 6669 656c 6420 7769 7468 206e 756d 5f65  field with num_e
-00014e50: 7870 722e 6576 616c 7561 7465 2829 270a  xpr.evaluate()'.
-00014e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e70: 2020 2020 2020 2020 2b20 275c 6e54 7279          + '\nTry
-00014e80: 2072 6564 7563 696e 6720 7468 6520 6465   reducing the de
-00014e90: 7465 6374 6f72 2072 616e 6765 270a 2020  tector range'.  
-00014ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014eb0: 2020 2020 2020 2b20 6627 5c6e 2863 7572        + f'\n(cur
-00014ec0: 7265 6e74 6c79 2069 6d67 5f78 5f62 6f75  rently img_x_bou
-00014ed0: 6e64 7320 3d20 7b69 6d67 5f78 5f62 6f75  nds = {img_x_bou
-00014ee0: 6e64 737d 2c20 616e 6420 270a 2020 2020  nds}, and '.    
-00014ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f00: 2020 2020 2b20 6627 696d 675f 795f 626f      + f'img_y_bo
-00014f10: 756e 6473 203d 207b 696d 675f 795f 626f  unds = {img_y_bo
-00014f20: 756e 6473 7d29 5c6e 2729 0a0a 2020 2020  unds})\n')..    
-00014f30: 2020 2020 2020 2020 2320 4e6f 726d 616c          # Normal
-00014f40: 697a 650a 2020 2020 2020 2020 2020 2020  ize.            
-00014f50: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00014f60: 2020 2020 2077 6974 6820 5365 744e 756d       with SetNum
-00014f70: 6578 7072 5468 7265 6164 7328 7365 6c66  exprThreads(self
-00014f80: 2e5f 6e75 6d5f 636f 7265 293a 0a20 2020  ._num_core):.   
-00014f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014fa0: 2065 7661 6c75 6174 6528 2774 6f6d 6f5f   evaluate('tomo_
-00014fb0: 7374 6163 6b2f 7462 6627 2c20 6f75 743d  stack/tbf', out=
-00014fc0: 746f 6d6f 5f73 7461 636b 2c20 7472 7565  tomo_stack, true
-00014fd0: 6469 763d 5472 7565 290a 2020 2020 2020  div=True).      
-00014fe0: 2020 2020 2020 6578 6365 7074 2054 7970        except Typ
-00014ff0: 6545 7272 6f72 2061 7320 653a 0a20 2020  eError as e:.   
-00015000: 2020 2020 2020 2020 2020 2020 2073 7973               sys
-00015010: 5f65 7869 7428 0a20 2020 2020 2020 2020  _exit(.         
-00015020: 2020 2020 2020 2020 2020 2066 275c 6e41             f'\nA
-00015030: 207b 7479 7065 2865 292e 5f5f 6e61 6d65   {type(e).__name
-00015040: 5f5f 7d20 6f63 6375 7265 6420 7768 696c  __} occured whil
-00015050: 6520 6e6f 726d 616c 697a 696e 6720 7468  e normalizing th
-00015060: 6520 270a 2020 2020 2020 2020 2020 2020  e '.            
-00015070: 2020 2020 2020 2020 2b20 2774 6f6d 6f67          + 'tomog
-00015080: 7261 7068 7920 6461 7461 2077 6974 6820  raphy data with 
-00015090: 6e75 6d5f 6578 7072 2e65 7661 6c75 6174  num_expr.evaluat
-000150a0: 6528 2927 0a20 2020 2020 2020 2020 2020  e()'.           
-000150b0: 2020 2020 2020 2020 202b 2027 5c6e 5472           + '\nTr
-000150c0: 7920 7265 6475 6369 6e67 2074 6865 2064  y reducing the d
-000150d0: 6574 6563 746f 7220 7261 6e67 6527 0a20  etector range'. 
-000150e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000150f0: 2020 202b 2066 275c 6e28 6375 7272 656e     + f'\n(curren
-00015100: 746c 7920 696d 675f 785f 626f 756e 6473  tly img_x_bounds
-00015110: 203d 207b 696d 675f 785f 626f 756e 6473   = {img_x_bounds
-00015120: 7d2c 2061 6e64 2027 0a20 2020 2020 2020  }, and '.       
-00015130: 2020 2020 2020 2020 2020 2020 202b 2066               + f
-00015140: 2769 6d67 5f79 5f62 6f75 6e64 7320 3d20  'img_y_bounds = 
-00015150: 7b69 6d67 5f79 5f62 6f75 6e64 737d 295c  {img_y_bounds})\
-00015160: 6e27 290a 0a20 2020 2020 2020 2020 2020  n')..           
-00015170: 2023 2052 656d 6f76 6520 6e6f 6e2d 706f   # Remove non-po
-00015180: 7369 7469 7665 2076 616c 7565 7320 616e  sitive values an
-00015190: 6420 6c69 6e65 6172 697a 6520 6461 7461  d linearize data
-000151a0: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
-000151b0: 5620 6d61 6b65 2069 6e70 7574 2061 7267  V make input arg
-000151c0: 756d 656e 743f 2063 7574 6f66 6620 3d20  ument? cutoff = 
-000151d0: 312e 652d 360a 2020 2020 2020 2020 2020  1.e-6.          
-000151e0: 2020 7769 7468 2053 6574 4e75 6d65 7870    with SetNumexp
-000151f0: 7254 6872 6561 6473 2873 656c 662e 5f6e  rThreads(self._n
-00015200: 756d 5f63 6f72 6529 3a0a 2020 2020 2020  um_core):.      
-00015210: 2020 2020 2020 2020 2020 6576 616c 7561            evalua
-00015220: 7465 280a 2020 2020 2020 2020 2020 2020  te(.            
-00015230: 2020 2020 2020 2020 2777 6865 7265 2874          'where(t
-00015240: 6f6d 6f5f 7374 6163 6b20 3c20 312e 652d  omo_stack < 1.e-
-00015250: 362c 2031 2e65 2d36 2c20 746f 6d6f 5f73  6, 1.e-6, tomo_s
-00015260: 7461 636b 2927 2c0a 2020 2020 2020 2020  tack)',.        
-00015270: 2020 2020 2020 2020 2020 2020 6f75 743d              out=
-00015280: 746f 6d6f 5f73 7461 636b 290a 2020 2020  tomo_stack).    
-00015290: 2020 2020 2020 2020 7769 7468 2053 6574          with Set
-000152a0: 4e75 6d65 7870 7254 6872 6561 6473 2873  NumexprThreads(s
-000152b0: 656c 662e 5f6e 756d 5f63 6f72 6529 3a0a  elf._num_core):.
-000152c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152d0: 6576 616c 7561 7465 2827 2d6c 6f67 2874  evaluate('-log(t
-000152e0: 6f6d 6f5f 7374 6163 6b29 272c 206f 7574  omo_stack)', out
-000152f0: 3d74 6f6d 6f5f 7374 6163 6b29 0a0a 2020  =tomo_stack)..  
-00015300: 2020 2020 2020 2020 2020 2320 4765 7420            # Get 
-00015310: 7269 6420 6f66 206e 616e 732f 696e 6673  rid of nans/infs
-00015320: 2074 6861 7420 6d61 7920 6265 2069 6e74   that may be int
-00015330: 726f 6475 6365 6420 6279 206e 6f72 6d61  roduced by norma
-00015340: 6c69 7a61 7469 6f6e 0a20 2020 2020 2020  lization.       
-00015350: 2020 2020 206e 702e 7768 6572 6528 6e70       np.where(np
-00015360: 2e69 7366 696e 6974 6528 746f 6d6f 5f73  .isfinite(tomo_s
-00015370: 7461 636b 292c 2074 6f6d 6f5f 7374 6163  tack), tomo_stac
-00015380: 6b2c 2030 2e29 0a0a 2020 2020 2020 2020  k, 0.)..        
-00015390: 2020 2020 2320 446f 776e 7369 7a65 2074      # Downsize t
-000153a0: 6f6d 6f67 7261 7068 7920 7374 6163 6b20  omography stack 
-000153b0: 746f 2073 6d61 6c6c 6572 2073 697a 650a  to smaller size.
-000153c0: 2020 2020 2020 2020 2020 2020 746f 6d6f              tomo
-000153d0: 5f73 7461 636b 203d 2074 6f6d 6f5f 7374  _stack = tomo_st
-000153e0: 6163 6b2e 6173 7479 7065 2827 666c 6f61  ack.astype('floa
-000153f0: 7433 3227 2c20 636f 7079 3d46 616c 7365  t32', copy=False
-00015400: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00015410: 206e 6f74 2073 656c 662e 5f74 6573 745f   not self._test_
-00015420: 6d6f 6465 3a0a 2020 2020 2020 2020 2020  mode:.          
-00015430: 2020 2020 2020 6966 206c 656e 2874 6f6d        if len(tom
-00015440: 6f5f 7374 6163 6b73 2920 3d3d 2031 3a0a  o_stacks) == 1:.
-00015450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015460: 2020 2020 7469 746c 6520 3d20 6627 7265      title = f're
-00015470: 6420 6675 6c6c 7265 7320 7468 6574 6120  d fullres theta 
-00015480: 7b72 6f75 6e64 2874 6865 7461 735b 305d  {round(thetas[0]
-00015490: 2c20 3229 2b30 7d27 0a20 2020 2020 2020  , 2)+0}'.       
-000154a0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000154b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154c0: 2020 2074 6974 6c65 203d 2066 2772 6564     title = f'red
-000154d0: 2073 7461 636b 207b 697d 2066 756c 6c72   stack {i} fullr
-000154e0: 6573 2074 6865 7461 2027 205c 0a20 2020  es theta ' \.   
-000154f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015500: 2020 2020 202b 2066 277b 726f 756e 6428       + f'{round(
-00015510: 7468 6574 6173 5b30 5d2c 2032 292b 307d  thetas[0], 2)+0}
-00015520: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00015530: 2020 7175 6963 6b5f 696d 7368 6f77 280a    quick_imshow(.
-00015540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015550: 2020 2020 746f 6d6f 5f73 7461 636b 5b30      tomo_stack[0
-00015560: 2c3a 2c3a 5d2c 2074 6974 6c65 3d74 6974  ,:,:], title=tit
-00015570: 6c65 2c20 7061 7468 3d73 656c 662e 5f6f  le, path=self._o
-00015580: 7574 7075 745f 666f 6c64 6572 2c0a 2020  utput_folder,.  
+00012e60: 2020 616e 6420 2869 6d67 5f78 5f62 6f75    and (img_x_bou
+00012e70: 6e64 735b 315d 2d69 6d67 5f78 5f62 6f75  nds[1]-img_x_bou
+00012e80: 6e64 735b 305d 2b31 290a 2020 2020 2020  nds[0]+1).      
+00012e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ea0: 2020 203c 2069 6e74 2828 6465 6c74 615f     < int((delta_
+00012eb0: 7a20 2d20 302e 352a 7069 7865 6c5f 7369  z - 0.5*pixel_si
+00012ec0: 7a65 2920 2f20 7069 7865 6c5f 7369 7a65  ze) / pixel_size
+00012ed0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00012ee0: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+00012ef0: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
+00012f00: 2020 2020 2020 2020 2020 2020 2020 2749                'I
+00012f10: 6d61 6765 2062 6f75 6e64 7320 616e 6420  mage bounds and 
+00012f20: 7069 7865 6c20 7369 7a65 2070 7265 7665  pixel size preve
+00012f30: 6e74 2073 6561 6d6c 6573 7320 7374 6163  nt seamless stac
+00012f40: 6b69 6e67 2729 0a20 2020 2020 2020 2065  king').        e
+00012f50: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00012f60: 2069 6620 6e75 6d5f 746f 6d6f 5f73 7461   if num_tomo_sta
+00012f70: 636b 7320 3e20 313a 0a20 2020 2020 2020  cks > 1:.       
+00012f80: 2020 2020 2020 2020 2072 6169 7365 204e           raise N
+00012f90: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
+00012fa0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00012fb0: 2020 2020 2020 2020 2753 656c 6563 7469          'Selecti
+00012fc0: 6e67 2069 6d61 6765 2062 6f75 6e64 7320  ng image bounds 
+00012fd0: 666f 7220 6d75 6c74 6970 6c65 2073 7461  for multiple sta
+00012fe0: 636b 7320 6f6e 2046 4d42 2729 0a20 2020  cks on FMB').   
+00012ff0: 2020 2020 2020 2020 2023 2046 6f72 2046           # For F
+00013000: 4d42 3a20 7573 6520 7468 6520 6669 7273  MB: use the firs
+00013010: 7420 746f 6d6f 6772 6170 6879 2069 6d61  t tomography ima
+00013020: 6765 2074 6f20 7365 6c65 6374 2072 616e  ge to select ran
+00013030: 6765 0a20 2020 2020 2020 2020 2020 2023  ge.            #
+00013040: 2052 5620 7265 7669 7369 7420 6966 2074   RV revisit if t
+00013050: 6865 7920 646f 2074 6f6d 6f67 7261 7068  hey do tomograph
+00013060: 7920 7769 7468 206d 756c 7469 706c 6520  y with multiple 
+00013070: 7374 6163 6b73 0a20 2020 2020 2020 2020  stacks.         
+00013080: 2020 2078 5f73 756d 203d 206e 702e 7375     x_sum = np.su
+00013090: 6d28 6669 7273 745f 696d 6167 652c 2031  m(first_image, 1
+000130a0: 290a 2020 2020 2020 2020 2020 2020 785f  ).            x_
+000130b0: 7375 6d5f 6d69 6e20 3d20 785f 7375 6d2e  sum_min = x_sum.
+000130c0: 6d69 6e28 290a 2020 2020 2020 2020 2020  min().          
+000130d0: 2020 785f 7375 6d5f 6d61 7820 3d20 785f    x_sum_max = x_
+000130e0: 7375 6d2e 6d61 7828 290a 2020 2020 2020  sum.max().      
+000130f0: 2020 2020 2020 6966 2073 656c 662e 5f69        if self._i
+00013100: 6e74 6572 6163 7469 7665 3a0a 2020 2020  nteractive:.    
+00013110: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00013120: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00013130: 2020 2020 2020 2027 5365 6c65 6374 2076         'Select v
+00013140: 6572 7469 6361 6c20 6461 7461 2072 6564  ertical data red
+00013150: 7563 7469 6f6e 2072 616e 6765 2066 726f  uction range fro
+00013160: 6d20 6669 7273 7420 270a 2020 2020 2020  m first '.      
+00013170: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
+00013180: 2774 6f6d 6f67 7261 7068 7920 696d 6167  'tomography imag
+00013190: 6527 290a 2020 2020 2020 2020 2020 2020  e').            
+000131a0: 2020 2020 696d 675f 785f 626f 756e 6473      img_x_bounds
+000131b0: 203d 2073 656c 6563 745f 696d 6167 655f   = select_image_
+000131c0: 626f 756e 6473 2866 6972 7374 5f69 6d61  bounds(first_ima
+000131d0: 6765 2c20 302c 2074 6974 6c65 3d74 6974  ge, 0, title=tit
+000131e0: 6c65 290a 2020 2020 2020 2020 2020 2020  le).            
+000131f0: 2020 2020 6966 2069 6d67 5f78 5f62 6f75      if img_x_bou
+00013200: 6e64 7320 6973 204e 6f6e 653a 0a20 2020  nds is None:.   
+00013210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013220: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+00013230: 726f 7228 2755 6e61 626c 6520 746f 2073  ror('Unable to s
+00013240: 656c 6563 7420 696d 6167 6520 626f 756e  elect image boun
+00013250: 6473 2729 0a20 2020 2020 2020 2020 2020  ds').           
+00013260: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00013270: 2020 2020 2020 2069 6620 696d 675f 785f         if img_x_
+00013280: 626f 756e 6473 2069 7320 4e6f 6e65 3a0a  bounds is None:.
+00013290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000132a0: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+000132b0: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
+000132c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000132d0: 2020 2769 6d67 5f78 5f62 6f75 6e64 7320    'img_x_bounds 
+000132e0: 756e 7370 6563 6966 6965 642c 2072 6564  unspecified, red
+000132f0: 7563 6520 6461 7461 2066 6f72 2065 6e74  uce data for ent
+00013300: 6972 6520 270a 2020 2020 2020 2020 2020  ire '.          
+00013310: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
+00013320: 2764 6574 6563 746f 7220 7261 6e67 6527  'detector range'
+00013330: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00013340: 2020 2020 2020 696d 675f 785f 626f 756e        img_x_boun
+00013350: 6473 203d 2028 302c 2066 6972 7374 5f69  ds = (0, first_i
+00013360: 6d61 6765 2e73 6861 7065 5b30 5d29 0a0a  mage.shape[0])..
+00013370: 2020 2020 2020 2020 2320 506c 6f74 2072          # Plot r
+00013380: 6573 756c 7473 0a20 2020 2020 2020 2069  esults.        i
+00013390: 6620 7365 6c66 2e5f 7361 7665 5f66 6967  f self._save_fig
+000133a0: 733a 0a20 2020 2020 2020 2020 2020 2078  s:.            x
+000133b0: 5f6c 6f77 203d 2069 6d67 5f78 5f62 6f75  _low = img_x_bou
+000133c0: 6e64 735b 305d 0a20 2020 2020 2020 2020  nds[0].         
+000133d0: 2020 2078 5f75 7070 203d 2069 6d67 5f78     x_upp = img_x
+000133e0: 5f62 6f75 6e64 735b 315d 0a20 2020 2020  _bounds[1].     
+000133f0: 2020 2020 2020 2074 6d70 203d 206e 702e         tmp = np.
+00013400: 636f 7079 2866 6972 7374 5f69 6d61 6765  copy(first_image
+00013410: 290a 2020 2020 2020 2020 2020 2020 746d  ).            tm
+00013420: 705f 6d61 7820 3d20 746d 702e 6d61 7828  p_max = tmp.max(
+00013430: 290a 2020 2020 2020 2020 2020 2020 746d  ).            tm
+00013440: 705b 785f 6c6f 772c 3a5d 203d 2074 6d70  p[x_low,:] = tmp
+00013450: 5f6d 6178 0a20 2020 2020 2020 2020 2020  _max.           
+00013460: 2074 6d70 5b78 5f75 7070 2d31 2c3a 5d20   tmp[x_upp-1,:] 
+00013470: 3d20 746d 705f 6d61 780a 2020 2020 2020  = tmp_max.      
+00013480: 2020 2020 2020 7175 6963 6b5f 696d 7368        quick_imsh
+00013490: 6f77 280a 2020 2020 2020 2020 2020 2020  ow(.            
+000134a0: 2020 2020 746d 702c 2074 6974 6c65 3d74      tmp, title=t
+000134b0: 6974 6c65 2c20 7061 7468 3d73 656c 662e  itle, path=self.
+000134c0: 5f6f 7574 7075 745f 666f 6c64 6572 2c20  _output_folder, 
+000134d0: 7361 7665 5f66 6967 3d54 7275 652c 0a20  save_fig=True,. 
+000134e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000134f0: 6176 655f 6f6e 6c79 3d54 7275 6529 0a20  ave_only=True). 
+00013500: 2020 2020 2020 2020 2020 2071 7569 636b             quick
+00013510: 5f70 6c6f 7428 0a20 2020 2020 2020 2020  _plot(.         
+00013520: 2020 2020 2020 2028 7261 6e67 6528 785f         (range(x_
+00013530: 7375 6d2e 7369 7a65 292c 2078 5f73 756d  sum.size), x_sum
+00013540: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00013550: 2020 2028 5b78 5f6c 6f77 2c20 785f 6c6f     ([x_low, x_lo
+00013560: 775d 2c20 5b78 5f73 756d 5f6d 696e 2c20  w], [x_sum_min, 
+00013570: 785f 7375 6d5f 6d61 785d 2c20 2772 2d27  x_sum_max], 'r-'
+00013580: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00013590: 2020 2028 5b78 5f75 7070 2c20 785f 7570     ([x_upp, x_up
+000135a0: 705d 2c20 5b78 5f73 756d 5f6d 696e 2c20  p], [x_sum_min, 
+000135b0: 785f 7375 6d5f 6d61 785d 2c20 2772 2d27  x_sum_max], 'r-'
+000135c0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000135d0: 2020 2074 6974 6c65 3d27 7375 6d20 6f76     title='sum ov
+000135e0: 6572 2074 6865 7461 2061 6e64 2079 272c  er theta and y',
+000135f0: 2070 6174 683d 7365 6c66 2e5f 6f75 7470   path=self._outp
+00013600: 7574 5f66 6f6c 6465 722c 0a20 2020 2020  ut_folder,.     
+00013610: 2020 2020 2020 2020 2020 2073 6176 655f             save_
+00013620: 6669 673d 5472 7565 2c20 7361 7665 5f6f  fig=True, save_o
+00013630: 6e6c 793d 5472 7565 290a 2020 2020 2020  nly=True).      
+00013640: 2020 2020 2020 6465 6c20 746d 700a 0a20        del tmp.. 
+00013650: 2020 2020 2020 2072 6574 7572 6e20 696d         return im
+00013660: 675f 785f 626f 756e 6473 0a0a 2020 2020  g_x_bounds..    
+00013670: 6465 6620 5f67 656e 5f74 6865 7461 7328  def _gen_thetas(
+00013680: 7365 6c66 2c20 6e78 656e 7472 7929 3a0a  self, nxentry):.
+00013690: 2020 2020 2020 2020 2222 2247 6574 2074          """Get t
+000136a0: 6865 2072 6f74 6174 696f 6e20 616e 676c  he rotation angl
+000136b0: 6573 2066 6f72 2074 6865 2069 6d61 6765  es for the image
+000136c0: 2073 7461 636b 732e 2222 220a 2020 2020   stacks.""".    
+000136d0: 2020 2020 2320 4765 7420 7468 6520 726f      # Get the ro
+000136e0: 7461 7469 6f6e 2061 6e67 6c65 730a 2020  tation angles.  
+000136f0: 2020 2020 2020 696d 6167 655f 6b65 7920        image_key 
+00013700: 3d20 6e78 656e 7472 792e 696e 7374 7275  = nxentry.instru
+00013710: 6d65 6e74 2e64 6574 6563 746f 722e 6765  ment.detector.ge
+00013720: 7428 2769 6d61 6765 5f6b 6579 272c 204e  t('image_key', N
+00013730: 6f6e 6529 0a20 2020 2020 2020 2069 6620  one).        if 
+00013740: 696d 6167 655f 6b65 7920 6973 206e 6f74  image_key is not
+00013750: 204e 6f6e 6520 616e 6420 2764 6174 6127   None and 'data'
+00013760: 2069 6e20 6e78 656e 7472 792e 696e 7374   in nxentry.inst
+00013770: 7275 6d65 6e74 2e64 6574 6563 746f 723a  rument.detector:
+00013780: 0a20 2020 2020 2020 2020 2020 2066 6965  .            fie
+00013790: 6c64 5f69 6e64 6963 6573 5f61 6c6c 203d  ld_indices_all =
+000137a0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+000137b0: 2020 2069 6e64 6578 2066 6f72 2069 6e64     index for ind
+000137c0: 6578 2c20 6b65 7920 696e 2065 6e75 6d65  ex, key in enume
+000137d0: 7261 7465 2869 6d61 6765 5f6b 6579 2920  rate(image_key) 
+000137e0: 6966 206b 6579 203d 3d20 305d 0a20 2020  if key == 0].   
+000137f0: 2020 2020 2020 2020 207a 5f74 7261 6e73           z_trans
+00013800: 6c61 7469 6f6e 5f61 6c6c 203d 206e 7865  lation_all = nxe
+00013810: 6e74 7279 2e73 616d 706c 652e 7a5f 7472  ntry.sample.z_tr
+00013820: 616e 736c 6174 696f 6e5b 6669 656c 645f  anslation[field_
+00013830: 696e 6469 6365 735f 616c 6c5d 0a20 2020  indices_all].   
+00013840: 2020 2020 2020 2020 207a 5f74 7261 6e73           z_trans
+00013850: 6c61 7469 6f6e 5f6c 6576 656c 7320 3d20  lation_levels = 
+00013860: 736f 7274 6564 286c 6973 7428 7365 7428  sorted(list(set(
+00013870: 7a5f 7472 616e 736c 6174 696f 6e5f 616c  z_translation_al
+00013880: 6c29 2929 0a20 2020 2020 2020 2020 2020  l))).           
+00013890: 2074 6865 7461 7320 3d20 4e6f 6e65 0a20   thetas = None. 
+000138a0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+000138b0: 2c20 7a5f 7472 616e 736c 6174 696f 6e20  , z_translation 
+000138c0: 696e 2065 6e75 6d65 7261 7465 287a 5f74  in enumerate(z_t
+000138d0: 7261 6e73 6c61 7469 6f6e 5f6c 6576 656c  ranslation_level
+000138e0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+000138f0: 2020 2020 6669 656c 645f 696e 6469 6365      field_indice
+00013900: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
+00013910: 2020 2020 2020 2020 2020 6669 656c 645f            field_
+00013920: 696e 6469 6365 735f 616c 6c5b 696e 6465  indices_all[inde
+00013930: 785d 0a20 2020 2020 2020 2020 2020 2020  x].             
+00013940: 2020 2020 2020 2066 6f72 2069 6e64 6578         for index
+00013950: 2c20 7a20 696e 2065 6e75 6d65 7261 7465  , z in enumerate
+00013960: 287a 5f74 7261 6e73 6c61 7469 6f6e 5f61  (z_translation_a
+00013970: 6c6c 290a 2020 2020 2020 2020 2020 2020  ll).            
+00013980: 2020 2020 2020 2020 6966 207a 203d 3d20          if z == 
+00013990: 7a5f 7472 616e 736c 6174 696f 6e5d 0a20  z_translation]. 
+000139a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000139b0: 6571 7565 6e63 655f 6e75 6d62 6572 7320  equence_numbers 
+000139c0: 3d20 5c0a 2020 2020 2020 2020 2020 2020  = \.            
+000139d0: 2020 2020 2020 2020 6e78 656e 7472 792e          nxentry.
+000139e0: 696e 7374 7275 6d65 6e74 2e64 6574 6563  instrument.detec
+000139f0: 746f 722e 7365 7175 656e 6365 5f6e 756d  tor.sequence_num
+00013a00: 6265 725b 6669 656c 645f 696e 6469 6365  ber[field_indice
+00013a10: 735d 0a20 2020 2020 2020 2020 2020 2020  s].             
+00013a20: 2020 2061 7373 6572 7420 286c 6973 7428     assert (list(
+00013a30: 7365 7175 656e 6365 5f6e 756d 6265 7273  sequence_numbers
+00013a40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00013a50: 2020 2020 2020 2020 2020 3d3d 206c 6973            == lis
+00013a60: 7428 7261 6e67 6528 286c 656e 2873 6571  t(range((len(seq
+00013a70: 7565 6e63 655f 6e75 6d62 6572 7329 2929  uence_numbers)))
+00013a80: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00013a90: 2020 2069 6620 7468 6574 6173 2069 7320     if thetas is 
+00013aa0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00013ab0: 2020 2020 2020 2020 2020 7468 6574 6173            thetas
+00013ac0: 203d 206e 702e 6173 6172 7261 7928 0a20   = np.asarray(. 
+00013ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ae0: 2020 2020 2020 206e 7865 6e74 7279 2e73         nxentry.s
+00013af0: 616d 706c 652e 726f 7461 7469 6f6e 5f61  ample.rotation_a
+00013b00: 6e67 6c65 5b0a 2020 2020 2020 2020 2020  ngle[.          
+00013b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013b20: 2020 6669 656c 645f 696e 6469 6365 735d    field_indices]
+00013b30: 295b 7365 7175 656e 6365 5f6e 756d 6265  )[sequence_numbe
+00013b40: 7273 5d0a 2020 2020 2020 2020 2020 2020  rs].            
+00013b50: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00013b60: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00013b70: 7365 7274 2061 6c6c 280a 2020 2020 2020  sert all(.      
+00013b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013b90: 2020 7468 6574 6173 5b69 5d20 3d3d 206e    thetas[i] == n
+00013ba0: 7865 6e74 7279 2e73 616d 706c 652e 726f  xentry.sample.ro
+00013bb0: 7461 7469 6f6e 5f61 6e67 6c65 5b0a 2020  tation_angle[.  
+00013bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013bd0: 2020 2020 2020 2020 2020 6669 656c 645f            field_
+00013be0: 696e 6469 6365 735b 696e 6465 785d 5d0a  indices[index]].
+00013bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c00: 2020 2020 2020 2020 666f 7220 692c 2069          for i, i
+00013c10: 6e64 6578 2069 6e20 656e 756d 6572 6174  ndex in enumerat
+00013c20: 6528 7365 7175 656e 6365 5f6e 756d 6265  e(sequence_numbe
+00013c30: 7273 2929 0a20 2020 2020 2020 2065 6c73  rs)).        els
+00013c40: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
+00013c50: 6f6d 6f5f 6669 656c 645f 7363 616e 7320  omo_field_scans 
+00013c60: 3d20 6e78 656e 7472 792e 7370 6563 5f73  = nxentry.spec_s
+00013c70: 6361 6e73 2e74 6f6d 6f5f 6669 656c 6473  cans.tomo_fields
+00013c80: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
+00013c90: 7461 7320 3d20 4e6f 6e65 0a20 2020 2020  tas = None.     
+00013ca0: 2020 2020 2020 2066 6f72 206e 7873 7562         for nxsub
+00013cb0: 656e 7472 795f 6e61 6d65 2c20 6e78 7375  entry_name, nxsu
+00013cc0: 6265 6e74 7279 2069 6e20 746f 6d6f 5f66  bentry in tomo_f
+00013cd0: 6965 6c64 5f73 6361 6e73 2e69 7465 6d73  ield_scans.items
+00013ce0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00013cf0: 2020 2020 6966 2074 6865 7461 7320 6973      if thetas is
+00013d00: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00013d10: 2020 2020 2020 2020 2020 2074 6865 7461             theta
+00013d20: 7320 3d20 6e70 2e61 7361 7272 6179 286e  s = np.asarray(n
+00013d30: 7873 7562 656e 7472 792e 7361 6d70 6c65  xsubentry.sample
+00013d40: 2e72 6f74 6174 696f 6e5f 616e 676c 6529  .rotation_angle)
+00013d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013d60: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00013d70: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00013d80: 7420 616c 6c28 0a20 2020 2020 2020 2020  t all(.         
+00013d90: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00013da0: 6865 7461 735b 695d 203d 3d20 7468 6574  hetas[i] == thet
+00013db0: 6120 666f 7220 692c 2074 6865 7461 0a20  a for i, theta. 
+00013dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013dd0: 2020 2020 2020 2020 2020 2069 6e20 656e             in en
+00013de0: 756d 6572 6174 6528 6e78 7375 6265 6e74  umerate(nxsubent
+00013df0: 7279 2e73 616d 706c 652e 726f 7461 7469  ry.sample.rotati
+00013e00: 6f6e 5f61 6e67 6c65 2929 0a0a 2020 2020  on_angle))..    
+00013e10: 2020 2020 7265 7475 726e 2074 6865 7461      return theta
+00013e20: 730a 0a20 2020 2064 6566 205f 7365 745f  s..    def _set_
+00013e30: 7a6f 6f6d 5f6f 725f 6465 6c74 615f 7468  zoom_or_delta_th
+00013e40: 6574 6128 7365 6c66 2c20 7468 6574 6173  eta(self, thetas
+00013e50: 2c20 6465 6c74 615f 7468 6574 613d 4e6f  , delta_theta=No
+00013e60: 6e65 293a 0a20 2020 2020 2020 2022 2222  ne):.        """
+00013e70: 0a20 2020 2020 2020 2053 6574 207a 6f6f  .        Set zoo
+00013e80: 6d20 616e 642f 6f72 2064 656c 7461 2074  m and/or delta t
+00013e90: 6865 7461 2074 6f20 7265 6475 6365 206d  heta to reduce m
+00013ea0: 656d 6f72 7920 7468 6520 7265 7175 6972  emory the requir
+00013eb0: 656d 656e 740a 2020 2020 2020 2020 666f  ement.        fo
+00013ec0: 7220 7468 6520 616e 616c 7973 6973 2e0a  r the analysis..
+00013ed0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00013ee0: 2020 2020 2320 4c6f 6361 6c20 6d6f 6475      # Local modu
+00013ef0: 6c65 730a 2020 2020 2020 2020 6672 6f6d  les.        from
+00013f00: 2043 4841 502e 7574 696c 732e 6765 6e65   CHAP.utils.gene
+00013f10: 7261 6c20 696d 706f 7274 2069 6e64 6578  ral import index
+00013f20: 5f6e 6561 7265 7374 0a0a 2020 2020 2020  _nearest..      
+00013f30: 2020 6966 2073 656c 662e 5f74 6573 745f    if self._test_
+00013f40: 6d6f 6465 3a0a 2020 2020 2020 2020 2020  mode:.          
+00013f50: 2020 7265 7475 726e 2074 7570 6c65 2873    return tuple(s
+00013f60: 656c 662e 5f74 6573 745f 636f 6e66 6967  elf._test_config
+00013f70: 5b27 6465 6c74 615f 7468 6574 6127 5d29  ['delta_theta'])
+00013f80: 0a0a 2320 2020 2020 2020 2069 6620 696e  ..#        if in
+00013f90: 7075 745f 7965 736e 6f28 0a23 2020 2020  put_yesno(.#    
+00013fa0: 2020 2020 2020 2020 2020 2020 275c 6e44              '\nD
+00013fb0: 6f20 796f 7520 7761 6e74 2074 6f20 7a6f  o you want to zo
+00013fc0: 6f6d 2069 6e20 746f 2072 6564 7563 6520  om in to reduce 
+00013fd0: 6d65 6d6f 7279 2027 0a23 2020 2020 2020  memory '.#      
+00013fe0: 2020 2020 2020 2020 2020 2b20 2772 6571            + 'req
+00013ff0: 7569 7265 6d65 6e74 2028 792f 6e29 3f27  uirement (y/n)?'
+00014000: 2c20 276e 2729 3a0a 2320 2020 2020 2020  , 'n'):.#       
+00014010: 2020 2020 207a 6f6f 6d5f 7065 7263 203d       zoom_perc =
+00014020: 2069 6e70 7574 5f69 6e74 280a 2320 2020   input_int(.#   
+00014030: 2020 2020 2020 2020 2020 2020 2027 2020               '  
+00014040: 2020 456e 7465 7220 7a6f 6f6d 2070 6572    Enter zoom per
+00014050: 6365 6e74 6167 6527 2c20 6765 3d31 2c20  centage', ge=1, 
+00014060: 6c65 3d31 3030 290a 2320 2020 2020 2020  le=100).#       
+00014070: 2065 6c73 653a 0a23 2020 2020 2020 2020   else:.#        
+00014080: 2020 2020 7a6f 6f6d 5f70 6572 6320 3d20      zoom_perc = 
+00014090: 4e6f 6e65 0a20 2020 2020 2020 207a 6f6f  None.        zoo
+000140a0: 6d5f 7065 7263 203d 204e 6f6e 650a 0a20  m_perc = None.. 
+000140b0: 2020 2020 2020 2069 6620 6465 6c74 615f         if delta_
+000140c0: 7468 6574 6120 6973 206e 6f74 204e 6f6e  theta is not Non
+000140d0: 6520 616e 6420 6e6f 7420 6973 5f6e 756d  e and not is_num
+000140e0: 2864 656c 7461 5f74 6865 7461 2c20 6774  (delta_theta, gt
+000140f0: 3d30 293a 0a20 2020 2020 2020 2020 2020  =0):.           
+00014100: 2073 656c 662e 5f6c 6f67 6765 722e 7761   self._logger.wa
+00014110: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
+00014120: 2020 2020 2020 2066 2749 6e76 616c 6964         f'Invalid
+00014130: 2070 6172 616d 6574 6572 2064 656c 7461   parameter delta
+00014140: 5f74 6865 7461 2028 7b64 656c 7461 5f74  _theta ({delta_t
+00014150: 6865 7461 7d29 2c20 270a 2020 2020 2020  heta}), '.      
+00014160: 2020 2020 2020 2020 2020 2b20 2769 676e            + 'ign
+00014170: 6f72 696e 6720 6465 6c74 615f 7468 6574  oring delta_thet
+00014180: 6127 290a 2020 2020 2020 2020 2020 2020  a').            
+00014190: 6465 6c74 615f 7468 6574 6120 3d20 4e6f  delta_theta = No
+000141a0: 6e65 0a20 2020 2020 2020 2069 6620 7365  ne.        if se
+000141b0: 6c66 2e5f 696e 7465 7261 6374 6976 653a  lf._interactive:
+000141c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000141d0: 6465 6c74 615f 7468 6574 6120 6973 204e  delta_theta is N
+000141e0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000141f0: 2020 2020 2064 656c 7461 5f74 6865 7461       delta_theta
+00014200: 203d 2074 6865 7461 735b 315d 2d74 6865   = thetas[1]-the
+00014210: 7461 735b 305d 0a20 2020 2020 2020 2020  tas[0].         
+00014220: 2020 2070 7269 6e74 2866 2741 7661 696c     print(f'Avail
+00014230: 6162 6c65 2074 6865 7461 2072 616e 6765  able theta range
+00014240: 3a20 5b7b 7468 6574 6173 5b30 5d7d 2c20  : [{thetas[0]}, 
+00014250: 7b74 6865 7461 735b 2d31 5d7d 5d27 290a  {thetas[-1]}]').
+00014260: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00014270: 7428 6627 4375 7272 656e 7420 7468 6574  t(f'Current thet
+00014280: 6120 696e 7465 7276 616c 3a20 7b64 656c  a interval: {del
+00014290: 7461 5f74 6865 7461 7d27 290a 2020 2020  ta_theta}').    
+000142a0: 2020 2020 2020 2020 6966 2069 6e70 7574          if input
+000142b0: 5f79 6573 6e6f 280a 2020 2020 2020 2020  _yesno(.        
+000142c0: 2020 2020 2020 2020 2020 2020 2744 6f20              'Do 
+000142d0: 796f 7520 7761 6e74 2074 6f20 6368 616e  you want to chan
+000142e0: 6765 2074 6865 2074 6865 7461 2069 6e74  ge the theta int
+000142f0: 6572 7661 6c20 746f 2072 6564 7563 6520  erval to reduce 
+00014300: 7468 6520 270a 2020 2020 2020 2020 2020  the '.          
+00014310: 2020 2020 2020 2020 2020 2b20 276d 656d            + 'mem
+00014320: 6f72 7920 7265 7175 6972 656d 656e 7420  ory requirement 
+00014330: 2879 2f6e 293f 272c 2027 6e27 293a 0a20  (y/n)?', 'n'):. 
+00014340: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00014350: 656c 7461 5f74 6865 7461 203d 2069 6e70  elta_theta = inp
+00014360: 7574 5f6e 756d 280a 2020 2020 2020 2020  ut_num(.        
+00014370: 2020 2020 2020 2020 2020 2020 2720 2020              '   
+00014380: 2045 6e74 6572 2074 6865 2064 6573 6972   Enter the desir
+00014390: 6564 2074 6865 7461 2069 6e74 6572 7661  ed theta interva
+000143a0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+000143b0: 2020 2020 2020 2020 6765 3d74 6865 7461          ge=theta
+000143c0: 735b 315d 2d74 6865 7461 735b 305d 2c20  s[1]-thetas[0], 
+000143d0: 6c74 3d28 7468 6574 6173 5b2d 315d 2d74  lt=(thetas[-1]-t
+000143e0: 6865 7461 735b 305d 292f 3229 0a20 2020  hetas[0])/2).   
+000143f0: 2020 2020 2069 6620 6465 6c74 615f 7468       if delta_th
+00014400: 6574 6120 6973 206e 6f74 204e 6f6e 653a  eta is not None:
+00014410: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
+00014420: 7461 5f74 6865 7461 203d 2069 6e64 6578  ta_theta = index
+00014430: 5f6e 6561 7265 7374 2874 6865 7461 732c  _nearest(thetas,
+00014440: 2074 6865 7461 735b 305d 2b64 656c 7461   thetas[0]+delta
+00014450: 5f74 6865 7461 290a 2020 2020 2020 2020  _theta).        
+00014460: 2020 2020 6966 2064 656c 7461 5f74 6865      if delta_the
+00014470: 7461 203c 3d20 313a 0a20 2020 2020 2020  ta <= 1:.       
+00014480: 2020 2020 2020 2020 2064 656c 7461 5f74           delta_t
+00014490: 6865 7461 203d 204e 6f6e 650a 0a20 2020  heta = None..   
+000144a0: 2020 2020 2072 6574 7572 6e20 7a6f 6f6d       return zoom
+000144b0: 5f70 6572 632c 2064 656c 7461 5f74 6865  _perc, delta_the
+000144c0: 7461 0a0a 2020 2020 6465 6620 5f67 656e  ta..    def _gen
+000144d0: 5f74 6f6d 6f28 7365 6c66 2c20 6e78 656e  _tomo(self, nxen
+000144e0: 7472 792c 2072 6564 7563 6564 5f64 6174  try, reduced_dat
+000144f0: 6129 3a0a 2020 2020 2020 2020 2222 2247  a):.        """G
+00014500: 656e 6572 6174 6520 746f 6d6f 6772 6170  enerate tomograp
+00014510: 6879 2066 6965 6c64 732e 2222 220a 2020  hy fields.""".  
+00014520: 2020 2020 2020 2320 5468 6972 6420 7061        # Third pa
+00014530: 7274 7920 6d6f 6475 6c65 730a 2020 2020  rty modules.    
+00014540: 2020 2020 6672 6f6d 206e 756d 6578 7072      from numexpr
+00014550: 2069 6d70 6f72 7420 6576 616c 7561 7465   import evaluate
+00014560: 0a20 2020 2020 2020 2066 726f 6d20 7363  .        from sc
+00014570: 6970 792e 6e64 696d 6167 6520 696d 706f  ipy.ndimage impo
+00014580: 7274 207a 6f6f 6d0a 0a20 2020 2020 2020  rt zoom..       
+00014590: 2023 204c 6f63 616c 206d 6f64 756c 6573   # Local modules
+000145a0: 0a20 2020 2020 2020 2066 726f 6d20 4348  .        from CH
+000145b0: 4150 2e63 6f6d 6d6f 6e2e 6d6f 6465 6c73  AP.common.models
+000145c0: 2e6d 6170 2069 6d70 6f72 7420 280a 2020  .map import (.  
+000145d0: 2020 2020 2020 2020 2020 6765 745f 7363            get_sc
+000145e0: 616e 7061 7273 6572 2c0a 2020 2020 2020  anparser,.      
+000145f0: 2020 2020 2020 696d 706f 7274 5f73 6361        import_sca
+00014600: 6e70 6172 7365 722c 0a20 2020 2020 2020  nparser,.       
+00014610: 2029 0a0a 2020 2020 2020 2020 2320 4765   )..        # Ge
+00014620: 7420 6675 6c6c 2062 7269 6768 7420 6669  t full bright fi
+00014630: 656c 640a 2020 2020 2020 2020 7462 6620  eld.        tbf 
+00014640: 3d20 6e70 2e61 7361 7272 6179 2872 6564  = np.asarray(red
+00014650: 7563 6564 5f64 6174 612e 6461 7461 2e62  uced_data.data.b
+00014660: 7269 6768 745f 6669 656c 6429 0a20 2020  right_field).   
+00014670: 2020 2020 2074 6266 5f73 6861 7065 203d       tbf_shape =
+00014680: 2074 6266 2e73 6861 7065 0a0a 2020 2020   tbf.shape..    
+00014690: 2020 2020 2320 4765 7420 696d 6167 6520      # Get image 
+000146a0: 626f 756e 6473 0a20 2020 2020 2020 2069  bounds.        i
+000146b0: 6d67 5f78 5f62 6f75 6e64 7320 3d20 7475  mg_x_bounds = tu
+000146c0: 706c 6528 0a20 2020 2020 2020 2020 2020  ple(.           
+000146d0: 2072 6564 7563 6564 5f64 6174 612e 6765   reduced_data.ge
+000146e0: 7428 2769 6d67 5f78 5f62 6f75 6e64 7327  t('img_x_bounds'
+000146f0: 2c20 2830 2c20 7462 665f 7368 6170 655b  , (0, tbf_shape[
+00014700: 305d 2929 290a 2020 2020 2020 2020 696d  0]))).        im
+00014710: 675f 795f 626f 756e 6473 203d 2074 7570  g_y_bounds = tup
+00014720: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
+00014730: 7265 6475 6365 645f 6461 7461 2e67 6574  reduced_data.get
+00014740: 2827 696d 675f 795f 626f 756e 6473 272c  ('img_y_bounds',
+00014750: 2028 302c 2074 6266 5f73 6861 7065 5b31   (0, tbf_shape[1
+00014760: 5d29 2929 0a0a 2020 2020 2020 2020 2320  ])))..        # 
+00014770: 4765 7420 7265 7369 7a65 6420 6461 726b  Get resized dark
+00014780: 2066 6965 6c64 0a20 2020 2020 2020 2069   field.        i
+00014790: 6620 2764 6172 6b5f 6669 656c 6427 2069  f 'dark_field' i
+000147a0: 6e20 7265 6475 6365 645f 6461 7461 2e64  n reduced_data.d
+000147b0: 6174 613a 0a20 2020 2020 2020 2020 2020  ata:.           
+000147c0: 2074 6466 203d 206e 702e 6173 6172 7261   tdf = np.asarra
+000147d0: 7928 0a20 2020 2020 2020 2020 2020 2020  y(.             
+000147e0: 2020 2072 6564 7563 6564 5f64 6174 612e     reduced_data.
+000147f0: 6461 7461 2e64 6172 6b5f 6669 656c 645b  data.dark_field[
+00014800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014810: 2020 2020 2069 6d67 5f78 5f62 6f75 6e64       img_x_bound
+00014820: 735b 305d 3a69 6d67 5f78 5f62 6f75 6e64  s[0]:img_x_bound
+00014830: 735b 315d 2c0a 2020 2020 2020 2020 2020  s[1],.          
+00014840: 2020 2020 2020 2020 2020 696d 675f 795f            img_y_
+00014850: 626f 756e 6473 5b30 5d3a 696d 675f 795f  bounds[0]:img_y_
+00014860: 626f 756e 6473 5b31 5d5d 290a 2020 2020  bounds[1]]).    
+00014870: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00014880: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+00014890: 6572 2e77 6172 6e69 6e67 2827 4461 726b  er.warning('Dark
+000148a0: 2066 6965 6c64 2075 6e61 7661 696c 6162   field unavailab
+000148b0: 6c65 2729 0a20 2020 2020 2020 2020 2020  le').           
+000148c0: 2074 6466 203d 204e 6f6e 650a 0a20 2020   tdf = None..   
+000148d0: 2020 2020 2023 2052 6573 697a 6520 6272       # Resize br
+000148e0: 6967 6874 2066 6965 6c64 0a20 2020 2020  ight field.     
+000148f0: 2020 2069 6620 2869 6d67 5f78 5f62 6f75     if (img_x_bou
+00014900: 6e64 7320 213d 2028 302c 2074 6266 2e73  nds != (0, tbf.s
+00014910: 6861 7065 5b30 5d29 0a20 2020 2020 2020  hape[0]).       
+00014920: 2020 2020 2020 2020 206f 7220 696d 675f           or img_
+00014930: 795f 626f 756e 6473 2021 3d20 2830 2c20  y_bounds != (0, 
+00014940: 7462 662e 7368 6170 655b 315d 2929 3a0a  tbf.shape[1])):.
+00014950: 2020 2020 2020 2020 2020 2020 7462 6620              tbf 
+00014960: 3d20 7462 665b 0a20 2020 2020 2020 2020  = tbf[.         
+00014970: 2020 2020 2020 2069 6d67 5f78 5f62 6f75         img_x_bou
+00014980: 6e64 735b 305d 3a69 6d67 5f78 5f62 6f75  nds[0]:img_x_bou
+00014990: 6e64 735b 315d 2c0a 2020 2020 2020 2020  nds[1],.        
+000149a0: 2020 2020 2020 2020 696d 675f 795f 626f          img_y_bo
+000149b0: 756e 6473 5b30 5d3a 696d 675f 795f 626f  unds[0]:img_y_bo
+000149c0: 756e 6473 5b31 5d5d 0a0a 2020 2020 2020  unds[1]]..      
+000149d0: 2020 2320 4765 7420 7468 6574 6173 2028    # Get thetas (
+000149e0: 696e 2064 6567 7265 6573 290a 2020 2020  in degrees).    
+000149f0: 2020 2020 7468 6574 6173 203d 206e 702e      thetas = np.
+00014a00: 6173 6172 7261 7928 7265 6475 6365 645f  asarray(reduced_
+00014a10: 6461 7461 2e72 6f74 6174 696f 6e5f 616e  data.rotation_an
+00014a20: 676c 6529 0a0a 2020 2020 2020 2020 2320  gle)..        # 
+00014a30: 4765 7420 6f72 2063 7265 6174 6520 696d  Get or create im
+00014a40: 6167 6520 6d61 736b 0a20 2020 2020 2020  age mask.       
+00014a50: 2069 6d61 6765 5f6d 6173 6b20 3d20 7265   image_mask = re
+00014a60: 6475 6365 645f 6461 7461 2e67 6574 2827  duced_data.get('
+00014a70: 696d 6167 655f 6d61 736b 2729 0a20 2020  image_mask').   
+00014a80: 2020 2020 2069 6620 696d 6167 655f 6d61       if image_ma
+00014a90: 736b 2069 7320 4e6f 6e65 3a0a 2020 2020  sk is None:.    
+00014aa0: 2020 2020 2020 2020 696d 6167 655f 6d61          image_ma
+00014ab0: 736b 203d 206e 702e 6f6e 6573 286c 656e  sk = np.ones(len
+00014ac0: 2874 6865 7461 7329 2c20 6474 7970 653d  (thetas), dtype=
+00014ad0: 626f 6f6c 290a 2020 2020 2020 2020 656c  bool).        el
+00014ae0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00014af0: 696d 6167 655f 6d61 736b 203d 206e 702e  image_mask = np.
+00014b00: 6173 6172 7261 7928 696d 6167 655f 6d61  asarray(image_ma
+00014b10: 736b 290a 2320 2020 2020 2020 2065 7869  sk).#        exi
+00014b20: 7428 6627 696d 6167 655f 6d61 736b 207b  t(f'image_mask {
+00014b30: 7479 7065 2869 6d61 6765 5f6d 6173 6b29  type(image_mask)
+00014b40: 7d20 7b6c 656e 2869 6d61 6765 5f6d 6173  } {len(image_mas
+00014b50: 6b29 7d3a 207b 696d 6167 655f 6d61 736b  k)}: {image_mask
+00014b60: 7d27 290a 0a20 2020 2020 2020 2023 2047  }')..        # G
+00014b70: 6574 2074 6865 2074 6f6d 6f67 7261 7068  et the tomograph
+00014b80: 7920 696d 6167 6573 0a20 2020 2020 2020  y images.       
+00014b90: 2069 6d61 6765 5f6b 6579 203d 206e 7865   image_key = nxe
+00014ba0: 6e74 7279 2e69 6e73 7472 756d 656e 742e  ntry.instrument.
+00014bb0: 6465 7465 6374 6f72 2e67 6574 2827 696d  detector.get('im
+00014bc0: 6167 655f 6b65 7927 2c20 4e6f 6e65 290a  age_key', None).
+00014bd0: 2020 2020 2020 2020 6966 2069 6d61 6765          if image
+00014be0: 5f6b 6579 2069 7320 6e6f 7420 4e6f 6e65  _key is not None
+00014bf0: 2061 6e64 2027 6461 7461 2720 696e 206e   and 'data' in n
+00014c00: 7865 6e74 7279 2e69 6e73 7472 756d 656e  xentry.instrumen
+00014c10: 742e 6465 7465 6374 6f72 3a0a 2020 2020  t.detector:.    
+00014c20: 2020 2020 2020 2020 6669 656c 645f 696e          field_in
+00014c30: 6469 6365 735f 616c 6c20 3d20 5b0a 2020  dices_all = [.  
+00014c40: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00014c50: 6465 7820 666f 7220 696e 6465 782c 206b  dex for index, k
+00014c60: 6579 2069 6e20 656e 756d 6572 6174 6528  ey in enumerate(
+00014c70: 696d 6167 655f 6b65 7929 2069 6620 6b65  image_key) if ke
+00014c80: 7920 3d3d 2030 5d0a 2020 2020 2020 2020  y == 0].        
+00014c90: 2020 2020 7a5f 7472 616e 736c 6174 696f      z_translatio
+00014ca0: 6e5f 616c 6c20 3d20 6e78 656e 7472 792e  n_all = nxentry.
+00014cb0: 7361 6d70 6c65 2e7a 5f74 7261 6e73 6c61  sample.z_transla
+00014cc0: 7469 6f6e 5b66 6965 6c64 5f69 6e64 6963  tion[field_indic
+00014cd0: 6573 5f61 6c6c 5d0a 2020 2020 2020 2020  es_all].        
+00014ce0: 2020 2020 7a5f 7472 616e 736c 6174 696f      z_translatio
+00014cf0: 6e5f 6c65 7665 6c73 203d 2073 6f72 7465  n_levels = sorte
+00014d00: 6428 6c69 7374 2873 6574 287a 5f74 7261  d(list(set(z_tra
+00014d10: 6e73 6c61 7469 6f6e 5f61 6c6c 2929 290a  nslation_all))).
+00014d20: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
+00014d30: 746f 6d6f 5f73 7461 636b 7320 3d20 6c65  tomo_stacks = le
+00014d40: 6e28 7a5f 7472 616e 736c 6174 696f 6e5f  n(z_translation_
+00014d50: 6c65 7665 6c73 290a 2020 2020 2020 2020  levels).        
+00014d60: 2020 2020 746f 6d6f 5f73 7461 636b 7320      tomo_stacks 
+00014d70: 3d20 6e75 6d5f 746f 6d6f 5f73 7461 636b  = num_tomo_stack
+00014d80: 732a 5b6e 702e 6172 7261 7928 5b5d 295d  s*[np.array([])]
+00014d90: 0a20 2020 2020 2020 2020 2020 2068 6f72  .            hor
+00014da0: 697a 6f6e 7461 6c5f 7368 6966 7473 203d  izontal_shifts =
+00014db0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00014dc0: 7665 7274 6963 616c 5f73 6869 6674 7320  vertical_shifts 
+00014dd0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+00014de0: 2074 6f6d 6f5f 7374 6163 6b73 203d 205b   tomo_stacks = [
+00014df0: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
+00014e00: 7220 692c 207a 5f74 7261 6e73 6c61 7469  r i, z_translati
+00014e10: 6f6e 2069 6e20 656e 756d 6572 6174 6528  on in enumerate(
+00014e20: 7a5f 7472 616e 736c 6174 696f 6e5f 6c65  z_translation_le
+00014e30: 7665 6c73 293a 0a20 2020 2020 2020 2020  vels):.         
+00014e40: 2020 2020 2020 2066 6965 6c64 5f69 6e64         field_ind
+00014e50: 6963 6573 203d 205b 0a20 2020 2020 2020  ices = [.       
+00014e60: 2020 2020 2020 2020 2020 2020 2066 6965               fie
+00014e70: 6c64 5f69 6e64 6963 6573 5f61 6c6c 5b69  ld_indices_all[i
+00014e80: 6e64 6578 5d0a 2020 2020 2020 2020 2020  ndex].          
+00014e90: 2020 2020 2020 2020 2020 666f 7220 696e            for in
+00014ea0: 6465 782c 207a 2069 6e20 656e 756d 6572  dex, z in enumer
+00014eb0: 6174 6528 7a5f 7472 616e 736c 6174 696f  ate(z_translatio
+00014ec0: 6e5f 616c 6c29 0a20 2020 2020 2020 2020  n_all).         
+00014ed0: 2020 2020 2020 2020 2020 2069 6620 7a20             if z 
+00014ee0: 3d3d 207a 5f74 7261 6e73 6c61 7469 6f6e  == z_translation
+00014ef0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00014f00: 2020 6669 656c 645f 696e 6469 6365 735f    field_indices_
+00014f10: 6d61 736b 6564 203d 2066 6965 6c64 5f69  masked = field_i
+00014f20: 6e64 6963 6573 5b69 6d61 6765 5f6d 6173  ndices[image_mas
+00014f30: 6b5d 0a20 2020 2020 2020 2020 2020 2020  k].             
+00014f40: 2020 2068 6f72 697a 6f6e 7461 6c5f 7368     horizontal_sh
+00014f50: 6966 7420 3d20 6e70 2e61 7361 7272 6179  ift = np.asarray
+00014f60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00014f70: 2020 2020 2020 7365 7428 6e78 656e 7472        set(nxentr
+00014f80: 792e 7361 6d70 6c65 2e78 5f74 7261 6e73  y.sample.x_trans
+00014f90: 6c61 7469 6f6e 5b66 6965 6c64 5f69 6e64  lation[field_ind
+00014fa0: 6963 6573 5f6d 6173 6b65 645d 2929 0a20  ices_masked])). 
+00014fb0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00014fc0: 7373 6572 7420 6c65 6e28 686f 7269 7a6f  ssert len(horizo
+00014fd0: 6e74 616c 5f73 6869 6674 2920 3d3d 2031  ntal_shift) == 1
+00014fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014ff0: 2068 6f72 697a 6f6e 7461 6c5f 7368 6966   horizontal_shif
+00015000: 7473 202b 3d20 6c69 7374 2868 6f72 697a  ts += list(horiz
+00015010: 6f6e 7461 6c5f 7368 6966 7429 0a20 2020  ontal_shift).   
+00015020: 2020 2020 2020 2020 2020 2020 2076 6572               ver
+00015030: 7469 6361 6c5f 7368 6966 7420 3d20 6e70  tical_shift = np
+00015040: 2e61 7361 7272 6179 280a 2020 2020 2020  .asarray(.      
+00015050: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00015060: 7428 6e78 656e 7472 792e 7361 6d70 6c65  t(nxentry.sample
+00015070: 2e7a 5f74 7261 6e73 6c61 7469 6f6e 5b66  .z_translation[f
+00015080: 6965 6c64 5f69 6e64 6963 6573 5f6d 6173  ield_indices_mas
+00015090: 6b65 645d 2929 0a20 2020 2020 2020 2020  ked])).         
+000150a0: 2020 2020 2020 2061 7373 6572 7420 6c65         assert le
+000150b0: 6e28 7665 7274 6963 616c 5f73 6869 6674  n(vertical_shift
+000150c0: 2920 3d3d 2031 0a20 2020 2020 2020 2020  ) == 1.         
+000150d0: 2020 2020 2020 2076 6572 7469 6361 6c5f         vertical_
+000150e0: 7368 6966 7473 202b 3d20 7665 7274 6963  shifts += vertic
+000150f0: 616c 5f73 6869 6674 0a20 2020 2020 2020  al_shift.       
+00015100: 2020 2020 2020 2020 2073 6571 7565 6e63           sequenc
+00015110: 655f 6e75 6d62 6572 7320 3d20 6e78 656e  e_numbers = nxen
+00015120: 7472 792e 696e 7374 7275 6d65 6e74 2e64  try.instrument.d
+00015130: 6574 6563 746f 722e 7365 7175 656e 6365  etector.sequence
+00015140: 5f6e 756d 6265 725b 0a20 2020 2020 2020  _number[.       
+00015150: 2020 2020 2020 2020 2020 2020 2066 6965               fie
+00015160: 6c64 5f69 6e64 6963 6573 5d0a 2020 2020  ld_indices].    
+00015170: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00015180: 6c69 7374 2873 6571 7565 6e63 655f 6e75  list(sequence_nu
+00015190: 6d62 6572 7329 0a20 2020 2020 2020 2020  mbers).         
+000151a0: 2020 2020 2020 2020 2020 2020 2020 203d                 =
+000151b0: 3d20 6c69 7374 2872 616e 6765 2828 6c65  = list(range((le
+000151c0: 6e28 7365 7175 656e 6365 5f6e 756d 6265  n(sequence_numbe
+000151d0: 7273 2929 2929 293a 0a20 2020 2020 2020  rs))))):.       
+000151e0: 2020 2020 2020 2020 2020 2020 2074 6f6d               tom
+000151f0: 6f5f 7374 6163 6b20 3d20 6e70 2e61 7361  o_stack = np.asa
+00015200: 7272 6179 280a 2020 2020 2020 2020 2020  rray(.          
+00015210: 2020 2020 2020 2020 2020 2020 2020 6e78                nx
+00015220: 656e 7472 792e 696e 7374 7275 6d65 6e74  entry.instrument
+00015230: 2e64 6574 6563 746f 722e 6461 7461 5b0a  .detector.data[.
+00015240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015250: 2020 2020 2020 2020 2020 2020 6669 656c              fiel
+00015260: 645f 696e 6469 6365 735f 6d61 736b 6564  d_indices_masked
+00015270: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00015280: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00015290: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+000152a0: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
+000152b0: 2755 6e61 626c 6520 746f 206c 6f61 6420  'Unable to load 
+000152c0: 7468 6520 746f 6d6f 6772 6170 6879 2069  the tomography i
+000152d0: 6d61 6765 7327 290a 2020 2020 2020 2020  mages').        
+000152e0: 2020 2020 2020 2020 746f 6d6f 5f73 7461          tomo_sta
+000152f0: 636b 732e 6170 7065 6e64 2874 6f6d 6f5f  cks.append(tomo_
+00015300: 7374 6163 6b29 0a20 2020 2020 2020 2065  stack).        e
+00015310: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00015320: 2069 6d70 6f72 745f 7363 616e 7061 7273   import_scanpars
+00015330: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00015340: 2020 2020 6e78 656e 7472 792e 696e 7374      nxentry.inst
+00015350: 7275 6d65 6e74 2e73 6f75 7263 652e 6174  rument.source.at
+00015360: 7472 735b 2773 7461 7469 6f6e 275d 2c0a  trs['station'],.
+00015370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015380: 6e78 656e 7472 792e 696e 7374 7275 6d65  nxentry.instrume
+00015390: 6e74 2e73 6f75 7263 652e 6174 7472 735b  nt.source.attrs[
+000153a0: 2765 7870 6572 696d 656e 745f 7479 7065  'experiment_type
+000153b0: 275d 290a 2020 2020 2020 2020 2020 2020  ']).            
+000153c0: 746f 6d6f 5f66 6965 6c64 5f73 6361 6e73  tomo_field_scans
+000153d0: 203d 206e 7865 6e74 7279 2e73 7065 635f   = nxentry.spec_
+000153e0: 7363 616e 732e 746f 6d6f 5f66 6965 6c64  scans.tomo_field
+000153f0: 730a 2020 2020 2020 2020 2020 2020 6e75  s.            nu
+00015400: 6d5f 746f 6d6f 5f73 7461 636b 7320 3d20  m_tomo_stacks = 
+00015410: 6c65 6e28 746f 6d6f 5f66 6965 6c64 5f73  len(tomo_field_s
+00015420: 6361 6e73 2e6b 6579 7328 2929 0a20 2020  cans.keys()).   
+00015430: 2020 2020 2020 2020 2064 6574 6563 746f           detecto
+00015440: 725f 7072 6566 6978 203d 2073 7472 286e  r_prefix = str(n
+00015450: 7865 6e74 7279 2e69 6e73 7472 756d 656e  xentry.instrumen
+00015460: 742e 6465 7465 6374 6f72 2e6c 6f63 616c  t.detector.local
+00015470: 5f6e 616d 6529 0a20 2020 2020 2020 2020  _name).         
+00015480: 2020 2074 6f6d 6f5f 7374 6163 6b73 203d     tomo_stacks =
+00015490: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+000154a0: 686f 7269 7a6f 6e74 616c 5f73 6869 6674  horizontal_shift
+000154b0: 7320 3d20 5b5d 0a20 2020 2020 2020 2020  s = [].         
+000154c0: 2020 2076 6572 7469 6361 6c5f 7368 6966     vertical_shif
+000154d0: 7473 203d 205b 5d0a 2020 2020 2020 2020  ts = [].        
+000154e0: 2020 2020 666f 7220 6e78 7375 6265 6e74      for nxsubent
+000154f0: 7279 5f6e 616d 652c 206e 7873 7562 656e  ry_name, nxsuben
+00015500: 7472 7920 696e 2074 6f6d 6f5f 6669 656c  try in tomo_fiel
+00015510: 645f 7363 616e 732e 6974 656d 7328 293a  d_scans.items():
+00015520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015530: 2073 6361 6e5f 6e75 6d62 6572 203d 2069   scan_number = i
+00015540: 6e74 286e 7873 7562 656e 7472 795f 6e61  nt(nxsubentry_na
+00015550: 6d65 2e73 706c 6974 2827 5f27 295b 2d31  me.split('_')[-1
+00015560: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00015570: 2020 2073 6361 6e70 6172 7365 7220 3d20     scanparser = 
+00015580: 6765 745f 7363 616e 7061 7273 6572 280a  get_scanparser(.
 00015590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000155a0: 2020 7361 7665 5f66 6967 3d73 656c 662e    save_fig=self.
-000155b0: 5f73 6176 655f 6669 6773 2c20 7361 7665  _save_figs, save
-000155c0: 5f6f 6e6c 793d 7365 6c66 2e5f 7361 7665  _only=self._save
-000155d0: 5f6f 6e6c 792c 0a20 2020 2020 2020 2020  _only,.         
-000155e0: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
-000155f0: 3d73 656c 662e 5f62 6c6f 636b 290a 2320  =self._block).# 
-00015600: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00015610: 6620 6e6f 7420 7365 6c66 2e5f 626c 6f63  f not self._bloc
-00015620: 6b3a 0a23 2020 2020 2020 2020 2020 2020  k:.#            
-00015630: 2020 2020 2020 2020 636c 6561 725f 696d          clear_im
-00015640: 7368 6f77 2874 6974 6c65 290a 2020 2020  show(title).    
-00015650: 2020 2020 2020 2020 7a6f 6f6d 5f70 6572          zoom_per
-00015660: 6320 3d20 3130 300a 2020 2020 2020 2020  c = 100.        
-00015670: 2020 2020 6966 207a 6f6f 6d5f 7065 7263      if zoom_perc
-00015680: 2021 3d20 3130 303a 0a20 2020 2020 2020   != 100:.       
-00015690: 2020 2020 2020 2020 2074 3020 3d20 7469           t0 = ti
-000156a0: 6d65 2829 0a20 2020 2020 2020 2020 2020  me().           
-000156b0: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
-000156c0: 722e 6465 6275 6728 275a 6f6f 6d69 6e67  r.debug('Zooming
-000156d0: 2069 6e20 2e2e 2e27 290a 2020 2020 2020   in ...').      
-000156e0: 2020 2020 2020 2020 2020 746f 6d6f 5f7a            tomo_z
-000156f0: 6f6f 6d5f 6c69 7374 203d 205b 5d0a 2020  oom_list = [].  
-00015700: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00015710: 7220 6a20 696e 2072 616e 6765 2874 6f6d  r j in range(tom
-00015720: 6f5f 7374 6163 6b2e 7368 6170 655b 305d  o_stack.shape[0]
-00015730: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00015740: 2020 2020 2020 2074 6f6d 6f5f 7a6f 6f6d         tomo_zoom
-00015750: 203d 207a 6f6f 6d28 746f 6d6f 5f73 7461   = zoom(tomo_sta
-00015760: 636b 5b6a 2c3a 2c3a 5d2c 2030 2e30 312a  ck[j,:,:], 0.01*
-00015770: 7a6f 6f6d 5f70 6572 6329 0a20 2020 2020  zoom_perc).     
-00015780: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00015790: 6f6d 6f5f 7a6f 6f6d 5f6c 6973 742e 6170  omo_zoom_list.ap
-000157a0: 7065 6e64 2874 6f6d 6f5f 7a6f 6f6d 290a  pend(tomo_zoom).
-000157b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000157c0: 746f 6d6f 5f73 7461 636b 203d 206e 702e  tomo_stack = np.
-000157d0: 7374 6163 6b28 746f 6d6f 5f7a 6f6f 6d5f  stack(tomo_zoom_
-000157e0: 6c69 7374 290a 2020 2020 2020 2020 2020  list).          
-000157f0: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
-00015800: 6572 2e69 6e66 6f28 6627 5a6f 6f6d 696e  er.info(f'Zoomin
-00015810: 6720 696e 2074 6f6f 6b20 7b74 696d 6528  g in took {time(
-00015820: 292d 7430 3a2e 3266 7d20 7365 636f 6e64  )-t0:.2f} second
-00015830: 7327 290a 2020 2020 2020 2020 2020 2020  s').            
-00015840: 2020 2020 6465 6c20 746f 6d6f 5f7a 6f6f      del tomo_zoo
-00015850: 6d5f 6c69 7374 0a20 2020 2020 2020 2020  m_list.         
-00015860: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-00015870: 6c66 2e5f 7465 7374 5f6d 6f64 653a 0a20  lf._test_mode:. 
-00015880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015890: 2020 2074 6974 6c65 203d 2066 2772 6564     title = f'red
-000158a0: 2073 7461 636b 207b 7a6f 6f6d 5f70 6572   stack {zoom_per
-000158b0: 637d 7020 7468 6574 6120 2720 5c0a 2020  c}p theta ' \.  
-000158c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000158d0: 2020 2020 2020 2b20 6627 7b72 6f75 6e64        + f'{round
-000158e0: 2874 6865 7461 735b 305d 2c20 3229 2b30  (thetas[0], 2)+0
-000158f0: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
-00015900: 2020 2020 2020 2071 7569 636b 5f69 6d73         quick_ims
-00015910: 686f 7728 0a20 2020 2020 2020 2020 2020  how(.           
-00015920: 2020 2020 2020 2020 2020 2020 2074 6f6d               tom
-00015930: 6f5f 7374 6163 6b5b 302c 3a2c 3a5d 2c20  o_stack[0,:,:], 
-00015940: 7469 746c 653d 7469 746c 652c 0a20 2020  title=title,.   
-00015950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015960: 2020 2020 2070 6174 683d 7365 6c66 2e5f       path=self._
-00015970: 6f75 7470 7574 5f66 6f6c 6465 722c 2073  output_folder, s
-00015980: 6176 655f 6669 673d 7365 6c66 2e5f 7361  ave_fig=self._sa
-00015990: 7665 5f66 6967 732c 0a20 2020 2020 2020  ve_figs,.       
-000159a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000159b0: 2073 6176 655f 6f6e 6c79 3d73 656c 662e   save_only=self.
-000159c0: 5f73 6176 655f 6f6e 6c79 2c20 626c 6f63  _save_only, bloc
-000159d0: 6b3d 7365 6c66 2e5f 626c 6f63 6b29 0a23  k=self._block).#
-000159e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000159f0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-00015a00: 5f62 6c6f 636b 3a0a 2320 2020 2020 2020  _block:.#       
-00015a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a20: 2063 6c65 6172 5f69 6d73 686f 7728 7469   clear_imshow(ti
-00015a30: 746c 6529 0a0a 2020 2020 2020 2020 2020  tle)..          
-00015a40: 2020 2320 5361 7665 2074 6573 7420 6461    # Save test da
-00015a50: 7461 2074 6f20 6669 6c65 0a20 2020 2020  ta to file.     
-00015a60: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-00015a70: 7465 7374 5f6d 6f64 653a 0a20 2020 2020  test_mode:.     
-00015a80: 2020 2020 2020 2020 2020 2072 6f77 5f69             row_i
-00015a90: 6e64 6578 203d 2069 6e74 2874 6f6d 6f5f  ndex = int(tomo_
-00015aa0: 7374 6163 6b2e 7368 6170 655b 315d 2f32  stack.shape[1]/2
-00015ab0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00015ac0: 2020 6e70 2e73 6176 6574 7874 280a 2020    np.savetxt(.  
-00015ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ae0: 2020 6627 7b73 656c 662e 5f6f 7574 7075    f'{self._outpu
-00015af0: 745f 666f 6c64 6572 7d2f 7265 645f 7374  t_folder}/red_st
-00015b00: 6163 6b5f 7b69 7d2e 7478 7427 2c0a 2020  ack_{i}.txt',.  
-00015b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b20: 2020 746f 6d6f 5f73 7461 636b 5b3a 2c72    tomo_stack[:,r
-00015b30: 6f77 5f69 6e64 6578 2c3a 5d2c 2066 6d74  ow_index,:], fmt
-00015b40: 3d27 252e 3665 2729 0a0a 2020 2020 2020  ='%.6e')..      
-00015b50: 2020 2020 2020 2320 436f 6d62 696e 6520        # Combine 
-00015b60: 7265 7369 7a65 6420 7374 6163 6b73 0a20  resized stacks. 
-00015b70: 2020 2020 2020 2020 2020 2072 6564 7563             reduc
-00015b80: 6564 5f74 6f6d 6f5f 7374 6163 6b73 2e61  ed_tomo_stacks.a
-00015b90: 7070 656e 6428 746f 6d6f 5f73 7461 636b  ppend(tomo_stack
-00015ba0: 290a 0a20 2020 2020 2020 2023 2041 6464  )..        # Add
-00015bb0: 2074 6f6d 6f20 6669 656c 6420 696e 666f   tomo field info
-00015bc0: 2074 6f20 7265 6475 6365 6420 6461 7461   to reduced data
-00015bd0: 204e 5870 726f 6365 7373 0a20 2020 2020   NXprocess.     
-00015be0: 2020 2072 6564 7563 6564 5f64 6174 615b     reduced_data[
-00015bf0: 2778 5f74 7261 6e73 6c61 7469 6f6e 275d  'x_translation']
-00015c00: 203d 206e 702e 6173 6172 7261 7928 686f   = np.asarray(ho
-00015c10: 7269 7a6f 6e74 616c 5f73 6869 6674 7329  rizontal_shifts)
-00015c20: 0a20 2020 2020 2020 2072 6564 7563 6564  .        reduced
-00015c30: 5f64 6174 615b 277a 5f74 7261 6e73 6c61  _data['z_transla
-00015c40: 7469 6f6e 275d 203d 206e 702e 6173 6172  tion'] = np.asar
-00015c50: 7261 7928 7665 7274 6963 616c 5f73 6869  ray(vertical_shi
-00015c60: 6674 7329 0a20 2020 2020 2020 2072 6564  fts).        red
-00015c70: 7563 6564 5f64 6174 612e 6461 7461 5b27  uced_data.data['
-00015c80: 746f 6d6f 5f66 6965 6c64 7327 5d20 3d20  tomo_fields'] = 
-00015c90: 6e70 2e61 7361 7272 6179 2872 6564 7563  np.asarray(reduc
-00015ca0: 6564 5f74 6f6d 6f5f 7374 6163 6b73 290a  ed_tomo_stacks).
-00015cb0: 0a20 2020 2020 2020 2069 6620 7464 6620  .        if tdf 
-00015cc0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00015cd0: 2020 2020 2020 2020 2064 656c 2074 6466           del tdf
-00015ce0: 0a20 2020 2020 2020 2064 656c 2074 6266  .        del tbf
-00015cf0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00015d00: 2072 6564 7563 6564 5f64 6174 610a 0a20   reduced_data.. 
-00015d10: 2020 2064 6566 205f 6669 6e64 5f63 656e     def _find_cen
-00015d20: 7465 725f 6f6e 655f 706c 616e 6528 0a20  ter_one_plane(. 
-00015d30: 2020 2020 2020 2020 2020 2073 656c 662c             self,
-00015d40: 2073 696e 6f67 7261 6d2c 2072 6f77 2c20   sinogram, row, 
-00015d50: 7468 6574 6173 2c20 6566 665f 7069 7865  thetas, eff_pixe
-00015d60: 6c5f 7369 7a65 2c20 6372 6f73 735f 7365  l_size, cross_se
-00015d70: 6374 696f 6e61 6c5f 6469 6d2c 0a20 2020  ctional_dim,.   
-00015d80: 2020 2020 2020 2020 2070 6174 683d 4e6f           path=No
-00015d90: 6e65 2c20 6e75 6d5f 636f 7265 3d31 2c20  ne, num_core=1, 
-00015da0: 6761 7573 7369 616e 5f73 6967 6d61 3d4e  gaussian_sigma=N
-00015db0: 6f6e 652c 2072 696e 675f 7769 6474 683d  one, ring_width=
-00015dc0: 4e6f 6e65 293a 0a20 2020 2020 2020 2022  None):.        "
-00015dd0: 2222 4669 6e64 2063 656e 7465 7220 666f  ""Find center fo
-00015de0: 7220 6120 7369 6e67 6c65 2074 6f6d 6f67  r a single tomog
-00015df0: 7261 7068 7920 706c 616e 652e 2222 220a  raphy plane.""".
-00015e00: 2020 2020 2020 2020 2320 5468 6972 6420          # Third 
-00015e10: 7061 7274 7920 6d6f 6475 6c65 730a 2020  party modules.  
-00015e20: 2020 2020 2020 6672 6f6d 2074 6f6d 6f70        from tomop
-00015e30: 7920 696d 706f 7274 2066 696e 645f 6365  y import find_ce
-00015e40: 6e74 6572 5f76 6f0a 0a20 2020 2020 2020  nter_vo..       
-00015e50: 2023 2054 7279 2061 7574 6f6d 6174 6963   # Try automatic
-00015e60: 2063 656e 7465 7220 6669 6e64 696e 6720   center finding 
-00015e70: 726f 7574 696e 6573 2066 6f72 2069 6e69  routines for ini
-00015e80: 7469 616c 2076 616c 7565 0a20 2020 2020  tial value.     
-00015e90: 2020 2023 2073 696e 6f67 7261 6d20 696e     # sinogram in
-00015ea0: 6465 7820 6f72 6465 723a 2074 6865 7461  dex order: theta
-00015eb0: 2c63 6f6c 756d 6e0a 2020 2020 2020 2020  ,column.        
-00015ec0: 2320 6e65 6564 2063 6f6c 756d 6e2c 7468  # need column,th
-00015ed0: 6574 6120 666f 7220 6972 6164 6f6e 2c20  eta for iradon, 
-00015ee0: 736f 2074 616b 6520 7472 616e 7370 6f73  so take transpos
-00015ef0: 650a 2020 2020 2020 2020 7369 6e6f 6772  e.        sinogr
-00015f00: 616d 203d 206e 702e 6173 6172 7261 7928  am = np.asarray(
-00015f10: 7369 6e6f 6772 616d 290a 2020 2020 2020  sinogram).      
-00015f20: 2020 7369 6e6f 6772 616d 5f74 203d 2073    sinogram_t = s
-00015f30: 696e 6f67 7261 6d2e 540a 2020 2020 2020  inogram.T.      
-00015f40: 2020 6365 6e74 6572 203d 2073 696e 6f67    center = sinog
-00015f50: 7261 6d2e 7368 6170 655b 315d 2f32 0a0a  ram.shape[1]/2..
-00015f60: 2320 2020 2020 2020 2071 7569 636b 5f69  #        quick_i
-00015f70: 6d73 686f 7728 0a23 2020 2020 2020 2020  mshow(.#        
-00015f80: 2020 2020 7369 6e6f 6772 616d 5f74 2c20      sinogram_t, 
-00015f90: 6627 7369 6e6f 6772 616d 2072 6f77 7b72  f'sinogram row{r
-00015fa0: 6f77 7d27 2c0a 2320 2020 2020 2020 2020  ow}',.#         
-00015fb0: 2020 2061 7370 6563 743d 2761 7574 6f27     aspect='auto'
-00015fc0: 2c20 7061 7468 3d73 656c 662e 5f6f 7574  , path=self._out
-00015fd0: 7075 745f 666f 6c64 6572 2c0a 2320 2020  put_folder,.#   
-00015fe0: 2020 2020 2020 2020 2073 6176 655f 6669           save_fi
-00015ff0: 673d 7365 6c66 2e5f 7361 7665 5f66 6967  g=self._save_fig
-00016000: 732c 2073 6176 655f 6f6e 6c79 3d73 656c  s, save_only=sel
-00016010: 662e 5f73 6176 655f 6f6e 6c79 2c0a 2320  f._save_only,.# 
-00016020: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
-00016030: 3d73 656c 662e 5f62 6c6f 636b 290a 0a20  =self._block).. 
-00016040: 2020 2020 2020 2023 2054 7279 2075 7369         # Try usi
-00016050: 6e67 204e 6768 6961 2056 6fe2 8099 7320  ng Nghia Vo...s 
-00016060: 6d65 7468 6f64 0a20 2020 2020 2020 2074  method.        t
-00016070: 3020 3d20 7469 6d65 2829 0a20 2020 2020  0 = time().     
-00016080: 2020 2069 6620 6e75 6d5f 636f 7265 203e     if num_core >
-00016090: 204e 554d 5f43 4f52 455f 544f 4d4f 5059   NUM_CORE_TOMOPY
-000160a0: 5f4c 494d 4954 3a0a 2020 2020 2020 2020  _LIMIT:.        
-000160b0: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-000160c0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-000160d0: 2020 2020 2020 2020 6627 5275 6e6e 696e          f'Runnin
-000160e0: 6720 6669 6e64 5f63 656e 7465 725f 766f  g find_center_vo
-000160f0: 206f 6e20 7b4e 554d 5f43 4f52 455f 544f   on {NUM_CORE_TO
-00016100: 4d4f 5059 5f4c 494d 4954 7d20 636f 7265  MOPY_LIMIT} core
-00016110: 7320 2e2e 2e27 290a 2020 2020 2020 2020  s ...').        
-00016120: 2020 2020 746f 6d6f 5f63 656e 7465 7220      tomo_center 
-00016130: 3d20 6669 6e64 5f63 656e 7465 725f 766f  = find_center_vo
-00016140: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00016150: 2020 7369 6e6f 6772 616d 2c20 6e63 6f72    sinogram, ncor
-00016160: 653d 4e55 4d5f 434f 5245 5f54 4f4d 4f50  e=NUM_CORE_TOMOP
-00016170: 595f 4c49 4d49 5429 0a20 2020 2020 2020  Y_LIMIT).       
-00016180: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00016190: 2020 2074 6f6d 6f5f 6365 6e74 6572 203d     tomo_center =
-000161a0: 2066 696e 645f 6365 6e74 6572 5f76 6f28   find_center_vo(
-000161b0: 7369 6e6f 6772 616d 2c20 6e63 6f72 653d  sinogram, ncore=
-000161c0: 6e75 6d5f 636f 7265 290a 2020 2020 2020  num_core).      
-000161d0: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e69    self._logger.i
-000161e0: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
-000161f0: 2066 2746 696e 6469 6e67 2063 656e 7465   f'Finding cente
-00016200: 7220 7573 696e 6720 4e67 6869 6120 566f  r using Nghia Vo
-00016210: e280 9973 206d 6574 686f 6420 746f 6f6b  ...s method took
-00016220: 207b 7469 6d65 2829 2d74 303a 2e32 667d   {time()-t0:.2f}
-00016230: 2027 0a20 2020 2020 2020 2020 2020 202b   '.            +
-00016240: 2027 7365 636f 6e64 7327 290a 2020 2020   'seconds').    
-00016250: 2020 2020 6365 6e74 6572 5f6f 6666 7365      center_offse
-00016260: 745f 766f 203d 2074 6f6d 6f5f 6365 6e74  t_vo = tomo_cent
-00016270: 6572 2d63 656e 7465 720a 2020 2020 2020  er-center.      
-00016280: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e69    self._logger.i
-00016290: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
-000162a0: 2066 2743 656e 7465 7220 6174 2072 6f77   f'Center at row
-000162b0: 207b 726f 777d 2075 7369 6e67 204e 6768   {row} using Ngh
-000162c0: 6961 2056 6fe2 8099 7320 6d65 7468 6f64  ia Vo...s method
-000162d0: 203d 2027 0a20 2020 2020 2020 2020 2020   = '.           
-000162e0: 202b 2066 277b 6365 6e74 6572 5f6f 6666   + f'{center_off
-000162f0: 7365 745f 766f 3a2e 3266 7d27 290a 2020  set_vo:.2f}').  
-00016300: 2020 2020 2020 7430 203d 2074 696d 6528        t0 = time(
-00016310: 290a 2020 2020 2020 2020 7265 636f 6e5f  ).        recon_
-00016320: 706c 616e 6520 3d20 7365 6c66 2e5f 7265  plane = self._re
-00016330: 636f 6e73 7472 7563 745f 6f6e 655f 706c  construct_one_pl
-00016340: 616e 6528 0a20 2020 2020 2020 2020 2020  ane(.           
-00016350: 2073 696e 6f67 7261 6d5f 742c 2074 6f6d   sinogram_t, tom
-00016360: 6f5f 6365 6e74 6572 2c20 7468 6574 6173  o_center, thetas
-00016370: 2c20 6566 665f 7069 7865 6c5f 7369 7a65  , eff_pixel_size
-00016380: 2c0a 2020 2020 2020 2020 2020 2020 6372  ,.            cr
-00016390: 6f73 735f 7365 6374 696f 6e61 6c5f 6469  oss_sectional_di
-000163a0: 6d2c 2046 616c 7365 2c20 6e75 6d5f 636f  m, False, num_co
-000163b0: 7265 2c20 6761 7573 7369 616e 5f73 6967  re, gaussian_sig
-000163c0: 6d61 2c20 7269 6e67 5f77 6964 7468 290a  ma, ring_width).
-000163d0: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-000163e0: 6767 6572 2e69 6e66 6f28 0a20 2020 2020  gger.info(.     
-000163f0: 2020 2020 2020 2066 2752 6563 6f6e 7374         f'Reconst
-00016400: 7275 6374 696e 6720 726f 7720 7b72 6f77  ructing row {row
-00016410: 7d20 746f 6f6b 207b 7469 6d65 2829 2d74  } took {time()-t
-00016420: 303a 2e32 667d 2073 6563 6f6e 6473 2729  0:.2f} seconds')
-00016430: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00016440: 662e 5f73 6176 655f 6669 6773 3a0a 2020  f._save_figs:.  
-00016450: 2020 2020 2020 2020 2020 7469 746c 6520            title 
-00016460: 3d20 6627 6564 6765 7320 726f 777b 726f  = f'edges row{ro
-00016470: 777d 2063 656e 7465 7220 6f66 6673 6574  w} center offset
-00016480: 7b63 656e 7465 725f 6f66 6673 6574 5f76  {center_offset_v
-00016490: 6f3a 2e32 667d 2056 6f27 0a20 2020 2020  o:.2f} Vo'.     
-000164a0: 2020 2020 2020 2073 656c 662e 5f70 6c6f         self._plo
-000164b0: 745f 6564 6765 735f 6f6e 655f 706c 616e  t_edges_one_plan
-000164c0: 6528 7265 636f 6e5f 706c 616e 652c 2074  e(recon_plane, t
-000164d0: 6974 6c65 2c20 7061 7468 3d70 6174 6829  itle, path=path)
-000164e0: 0a0a 2020 2020 2020 2020 2320 5472 7920  ..        # Try 
-000164f0: 7573 696e 6720 7068 6173 6520 636f 7272  using phase corr
-00016500: 656c 6174 696f 6e20 6d65 7468 6f64 0a23  elation method.#
-00016510: 2020 2020 2020 2020 6966 2069 6e70 7574          if input
-00016520: 5f79 6573 6e6f 2827 0a23 2020 2020 2020  _yesno('.#      
-00016530: 2020 2020 2020 2020 2020 5472 7920 6669            Try fi
-00016540: 6e64 696e 6720 6365 6e74 6572 2075 7369  nding center usi
-00016550: 6e67 2070 6861 7365 2063 6f72 7265 6c61  ng phase correla
-00016560: 7469 6f6e 2028 792f 6e29 3f27 2c0a 2320  tion (y/n)?',.# 
-00016570: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00016580: 6e27 293a 0a23 2020 2020 2020 2020 2020  n'):.#          
-00016590: 2020 7430 203d 2074 696d 6528 290a 2320    t0 = time().# 
-000165a0: 2020 2020 2020 2020 2020 2074 6f6d 6f5f             tomo_
-000165b0: 6365 6e74 6572 203d 2066 696e 645f 6365  center = find_ce
-000165c0: 6e74 6572 5f70 6328 0a23 2020 2020 2020  nter_pc(.#      
-000165d0: 2020 2020 2020 2020 2020 7369 6e6f 6772            sinogr
-000165e0: 616d 2c20 7369 6e6f 6772 616d 2c20 746f  am, sinogram, to
-000165f0: 6c3d 302e 312c 2072 6f74 635f 6775 6573  l=0.1, rotc_gues
-00016600: 733d 746f 6d6f 5f63 656e 7465 7229 0a23  s=tomo_center).#
-00016610: 2020 2020 2020 2020 2020 2020 6572 726f              erro
-00016620: 7220 3d20 312e 0a23 2020 2020 2020 2020  r = 1..#        
-00016630: 2020 2020 7768 696c 6520 6572 726f 7220      while error 
-00016640: 3e20 746f 6c3a 0a23 2020 2020 2020 2020  > tol:.#        
-00016650: 2020 2020 2020 2020 7072 6576 203d 2074          prev = t
-00016660: 6f6d 6f5f 6365 6e74 6572 0a23 2020 2020  omo_center.#    
-00016670: 2020 2020 2020 2020 2020 2020 746f 6d6f              tomo
-00016680: 5f63 656e 7465 7220 3d20 6669 6e64 5f63  _center = find_c
-00016690: 656e 7465 725f 7063 280a 2320 2020 2020  enter_pc(.#     
-000166a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000166b0: 696e 6f67 7261 6d2c 2073 696e 6f67 7261  inogram, sinogra
-000166c0: 6d2c 2074 6f6c 3d74 6f6c 2c20 726f 7463  m, tol=tol, rotc
-000166d0: 5f67 7565 7373 3d74 6f6d 6f5f 6365 6e74  _guess=tomo_cent
-000166e0: 6572 290a 2320 2020 2020 2020 2020 2020  er).#           
-000166f0: 2020 2020 2065 7272 6f72 203d 206e 702e       error = np.
-00016700: 6162 7328 746f 6d6f 5f63 656e 7465 722d  abs(tomo_center-
-00016710: 7072 6576 290a 2320 2020 2020 2020 2020  prev).#         
-00016720: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
-00016730: 696e 666f 280a 2320 2020 2020 2020 2020  info(.#         
-00016740: 2020 2020 2020 2027 4669 6e64 696e 6720         'Finding 
-00016750: 6365 6e74 6572 2075 7369 6e67 2074 6865  center using the
-00016760: 2070 6861 7365 2063 6f72 7265 6c61 7469   phase correlati
-00016770: 6f6e 206d 6574 686f 6420 270a 2320 2020  on method '.#   
-00016780: 2020 2020 2020 2020 2020 2020 202b 2066               + f
-00016790: 2774 6f6f 6b20 7b74 696d 6528 292d 7430  'took {time()-t0
-000167a0: 3a2e 3266 7d20 7365 636f 6e64 7327 290a  :.2f} seconds').
-000167b0: 2320 2020 2020 2020 2020 2020 2063 656e  #            cen
-000167c0: 7465 725f 6f66 6673 6574 203d 2074 6f6d  ter_offset = tom
-000167d0: 6f5f 6365 6e74 6572 2d63 656e 7465 720a  o_center-center.
-000167e0: 2320 2020 2020 2020 2020 2020 2070 7269  #            pri
-000167f0: 6e74 280a 2320 2020 2020 2020 2020 2020  nt(.#           
-00016800: 2020 2020 2066 2743 656e 7465 7220 6174       f'Center at
-00016810: 2072 6f77 207b 726f 777d 2075 7369 6e67   row {row} using
-00016820: 2070 6861 7365 2063 6f72 7265 6c61 7469   phase correlati
-00016830: 6f6e 203d 2027 0a23 2020 2020 2020 2020  on = '.#        
-00016840: 2020 2020 2020 2020 2b20 6627 7b63 656e          + f'{cen
-00016850: 7465 725f 6f66 6673 6574 3a2e 3266 7d27  ter_offset:.2f}'
-00016860: 290a 2320 2020 2020 2020 2020 2020 2074  ).#            t
-00016870: 3020 3d20 7469 6d65 2829 0a23 2020 2020  0 = time().#    
-00016880: 2020 2020 2020 2020 7265 636f 6e5f 706c          recon_pl
-00016890: 616e 6520 3d20 7365 6c66 2e5f 7265 636f  ane = self._reco
-000168a0: 6e73 7472 7563 745f 6f6e 655f 706c 616e  nstruct_one_plan
-000168b0: 6528 0a23 2020 2020 2020 2020 2020 2020  e(.#            
-000168c0: 2020 2020 7369 6e6f 6772 616d 5f74 2c20      sinogram_t, 
-000168d0: 746f 6d6f 5f63 656e 7465 722c 2074 6865  tomo_center, the
-000168e0: 7461 732c 2065 6666 5f70 6978 656c 5f73  tas, eff_pixel_s
-000168f0: 697a 652c 0a23 2020 2020 2020 2020 2020  ize,.#          
-00016900: 2020 2020 2020 6372 6f73 735f 7365 6374        cross_sect
-00016910: 696f 6e61 6c5f 6469 6d2c 2046 616c 7365  ional_dim, False
-00016920: 2c20 6e75 6d5f 636f 7265 2c20 6761 7573  , num_core, gaus
-00016930: 7369 616e 5f73 6967 6d61 2c20 7269 6e67  sian_sigma, ring
-00016940: 5f77 6964 7468 290a 2320 2020 2020 2020  _width).#       
-00016950: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
-00016960: 722e 696e 666f 280a 2320 2020 2020 2020  r.info(.#       
-00016970: 2020 2020 2020 2020 2066 2752 6563 6f6e           f'Recon
-00016980: 7374 7275 6374 696e 6720 726f 7720 7b72  structing row {r
-00016990: 6f77 7d20 746f 6f6b 207b 7469 6d65 2829  ow} took {time()
-000169a0: 2d74 303a 2e32 667d 2073 6563 6f6e 6473  -t0:.2f} seconds
-000169b0: 2729 0a23 0a23 2020 2020 2020 2020 2020  ').#.#          
-000169c0: 2020 7469 746c 6520 3d20 5c0a 2320 2020    title = \.#   
-000169d0: 2020 2020 2020 2020 2020 2020 2066 2765               f'e
-000169e0: 6467 6573 2072 6f77 7b72 6f77 7d20 6365  dges row{row} ce
-000169f0: 6e74 6572 5f6f 6666 7365 747b 6365 6e74  nter_offset{cent
-00016a00: 6572 5f6f 6666 7365 743a 2e32 667d 2050  er_offset:.2f} P
-00016a10: 4327 0a23 2020 2020 2020 2020 2020 2020  C'.#            
-00016a20: 7365 6c66 2e5f 706c 6f74 5f65 6467 6573  self._plot_edges
-00016a30: 5f6f 6e65 5f70 6c61 6e65 2872 6563 6f6e  _one_plane(recon
-00016a40: 5f70 6c61 6e65 2c20 7469 746c 652c 2070  _plane, title, p
-00016a50: 6174 683d 7061 7468 290a 0a20 2020 2020  ath=path)..     
-00016a60: 2020 2023 2053 656c 6563 7420 6365 6e74     # Select cent
-00016a70: 6572 206c 6f63 6174 696f 6e0a 2320 2020  er location.#   
-00016a80: 2020 2020 2069 6620 696e 7075 745f 7965       if input_ye
-00016a90: 736e 6f28 0a23 2020 2020 2020 2020 2020  sno(.#          
-00016aa0: 2020 2741 6363 6570 7420 6120 6365 6e74    'Accept a cent
-00016ab0: 6572 206c 6f63 6174 696f 6e20 2879 2920  er location (y) 
-00016ac0: 6f72 2063 6f6e 7469 6e75 6520 7365 6172  or continue sear
-00016ad0: 6368 2028 6e29 3f27 2c0a 2320 2020 2020  ch (n)?',.#     
-00016ae0: 2020 2020 2020 2027 7927 293a 0a23 2020         'y'):.#  
-00016af0: 2020 2020 2020 2020 2020 6365 6e74 6572            center
-00016b00: 5f6f 6666 7365 7420 3d20 696e 7075 745f  _offset = input_
-00016b10: 6e75 6d28 2720 2020 2045 6e74 6572 2063  num('    Enter c
-00016b20: 686f 7365 6e20 6365 6e74 6572 206f 6666  hosen center off
-00016b30: 7365 7427 2c0a 2320 2020 2020 2020 2020  set',.#         
-00016b40: 2020 2020 2020 2020 2020 2067 653d 2d63             ge=-c
-00016b50: 656e 7465 722c 206c 653d 6365 6e74 6572  enter, le=center
-00016b60: 2c20 6465 6661 756c 743d 6365 6e74 6572  , default=center
-00016b70: 5f6f 6666 7365 745f 766f 290a 2320 2020  _offset_vo).#   
-00016b80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00016b90: 666c 6f61 7428 6365 6e74 6572 5f6f 6666  float(center_off
-00016ba0: 7365 7429 0a0a 2020 2020 2020 2020 2320  set)..        # 
-00016bb0: 5065 7266 6f72 6d20 6365 6e74 6572 2066  Perform center f
-00016bc0: 696e 6469 6e67 2073 6561 7263 680a 2320  inding search.# 
-00016bd0: 2020 2020 2020 2077 6869 6c65 2054 7275         while Tru
-00016be0: 653a 0a23 2020 2020 2020 2020 2020 2020  e:.#            
-00016bf0: 6365 6e74 6572 5f6f 6666 7365 745f 6c6f  center_offset_lo
-00016c00: 7720 3d20 696e 7075 745f 696e 7428 0a23  w = input_int(.#
-00016c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c20: 275c 6e45 6e74 6572 206c 6f77 6572 2062  '\nEnter lower b
-00016c30: 6f75 6e64 2066 6f72 2063 656e 7465 7220  ound for center 
-00016c40: 6f66 6673 6574 272c 2067 653d 2d63 656e  offset', ge=-cen
-00016c50: 7465 722c 6c65 3d63 656e 7465 7229 0a23  ter,le=center).#
-00016c60: 2020 2020 2020 2020 2020 2020 6365 6e74              cent
-00016c70: 6572 5f6f 6666 7365 745f 7570 7020 3d20  er_offset_upp = 
-00016c80: 696e 7075 745f 696e 7428 0a23 2020 2020  input_int(.#    
-00016c90: 2020 2020 2020 2020 2020 2020 2745 6e74              'Ent
-00016ca0: 6572 2075 7070 6572 2062 6f75 6e64 2066  er upper bound f
-00016cb0: 6f72 2063 656e 7465 7220 6f66 6673 6574  or center offset
-00016cc0: 272c 2067 653d 6365 6e74 6572 5f6f 6666  ', ge=center_off
-00016cd0: 7365 745f 6c6f 772c 0a23 2020 2020 2020  set_low,.#      
-00016ce0: 2020 2020 2020 2020 2020 6c65 3d63 656e            le=cen
-00016cf0: 7465 7229 0a23 2020 2020 2020 2020 2020  ter).#          
-00016d00: 2020 6966 2063 656e 7465 725f 6f66 6673    if center_offs
-00016d10: 6574 5f75 7070 203d 3d20 6365 6e74 6572  et_upp == center
-00016d20: 5f6f 6666 7365 745f 6c6f 773a 0a23 2020  _offset_low:.#  
-00016d30: 2020 2020 2020 2020 2020 2020 2020 6365                ce
-00016d40: 6e74 6572 5f6f 6666 7365 745f 7374 6570  nter_offset_step
-00016d50: 203d 2031 0a23 2020 2020 2020 2020 2020   = 1.#          
-00016d60: 2020 656c 7365 3a0a 2320 2020 2020 2020    else:.#       
-00016d70: 2020 2020 2020 2020 2063 656e 7465 725f           center_
-00016d80: 6f66 6673 6574 5f73 7465 7020 3d20 696e  offset_step = in
-00016d90: 7075 745f 696e 7428 0a23 2020 2020 2020  put_int(.#      
-00016da0: 2020 2020 2020 2020 2020 2020 2020 2745                'E
-00016db0: 6e74 6572 2073 7465 7020 7369 7a65 2066  nter step size f
-00016dc0: 6f72 2063 656e 7465 7220 6f66 6673 6574  or center offset
-00016dd0: 2073 6561 7263 6827 2c20 6765 3d31 2c0a   search', ge=1,.
-00016de0: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-00016df0: 2020 2020 2020 2020 206c 653d 6365 6e74           le=cent
-00016e00: 6572 5f6f 6666 7365 745f 7570 702d 6365  er_offset_upp-ce
-00016e10: 6e74 6572 5f6f 6666 7365 745f 6c6f 7729  nter_offset_low)
-00016e20: 0a23 2020 2020 2020 2020 2020 2020 6e75  .#            nu
-00016e30: 6d5f 6365 6e74 6572 5f6f 6666 7365 7420  m_center_offset 
-00016e40: 3d20 3120 2b20 696e 7428 0a23 2020 2020  = 1 + int(.#    
-00016e50: 2020 2020 2020 2020 2020 2020 2863 656e              (cen
-00016e60: 7465 725f 6f66 6673 6574 5f75 7070 2d63  ter_offset_upp-c
-00016e70: 656e 7465 725f 6f66 6673 6574 5f6c 6f77  enter_offset_low
-00016e80: 2920 2f20 6365 6e74 6572 5f6f 6666 7365  ) / center_offse
-00016e90: 745f 7374 6570 290a 2320 2020 2020 2020  t_step).#       
-00016ea0: 2020 2020 2063 656e 7465 725f 6f66 6673       center_offs
-00016eb0: 6574 7320 3d20 6e70 2e6c 696e 7370 6163  ets = np.linspac
-00016ec0: 6528 0a23 2020 2020 2020 2020 2020 2020  e(.#            
-00016ed0: 2020 2020 6365 6e74 6572 5f6f 6666 7365      center_offse
-00016ee0: 745f 6c6f 772c 2063 656e 7465 725f 6f66  t_low, center_of
-00016ef0: 6673 6574 5f75 7070 2c20 6e75 6d5f 6365  fset_upp, num_ce
-00016f00: 6e74 6572 5f6f 6666 7365 7429 0a23 2020  nter_offset).#  
-00016f10: 2020 2020 2020 2020 2020 666f 7220 6365            for ce
-00016f20: 6e74 6572 5f6f 6666 7365 7420 696e 2063  nter_offset in c
-00016f30: 656e 7465 725f 6f66 6673 6574 733a 0a23  enter_offsets:.#
-00016f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f50: 6966 2063 656e 7465 725f 6f66 6673 6574  if center_offset
-00016f60: 203d 3d20 6365 6e74 6572 5f6f 6666 7365   == center_offse
-00016f70: 745f 766f 3a0a 2320 2020 2020 2020 2020  t_vo:.#         
-00016f80: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00016f90: 6e75 650a 2320 2020 2020 2020 2020 2020  nue.#           
-00016fa0: 2020 2020 2074 3020 3d20 7469 6d65 2829       t0 = time()
-00016fb0: 0a23 2020 2020 2020 2020 2020 2020 2020  .#              
-00016fc0: 2020 7265 636f 6e5f 706c 616e 6520 3d20    recon_plane = 
-00016fd0: 7365 6c66 2e5f 7265 636f 6e73 7472 7563  self._reconstruc
-00016fe0: 745f 6f6e 655f 706c 616e 6528 0a23 2020  t_one_plane(.#  
-00016ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017000: 2020 7369 6e6f 6772 616d 5f74 2c20 6365    sinogram_t, ce
-00017010: 6e74 6572 5f6f 6666 7365 742b 6365 6e74  nter_offset+cent
-00017020: 6572 2c20 7468 6574 6173 2c20 6566 665f  er, thetas, eff_
-00017030: 7069 7865 6c5f 7369 7a65 2c0a 2320 2020  pixel_size,.#   
-00017040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017050: 2063 726f 7373 5f73 6563 7469 6f6e 616c   cross_sectional
-00017060: 5f64 696d 2c20 4661 6c73 652c 206e 756d  _dim, False, num
-00017070: 5f63 6f72 652c 2067 6175 7373 6961 6e5f  _core, gaussian_
-00017080: 7369 676d 612c 2072 696e 675f 7769 6474  sigma, ring_widt
-00017090: 6829 0a23 2020 2020 2020 2020 2020 2020  h).#            
-000170a0: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-000170b0: 2e69 6e66 6f28 0a23 2020 2020 2020 2020  .info(.#        
-000170c0: 2020 2020 2020 2020 2020 2020 6627 5265              f'Re
-000170d0: 636f 6e73 7472 7563 7469 6e67 2063 656e  constructing cen
-000170e0: 7465 725f 6f66 6673 6574 207b 6365 6e74  ter_offset {cent
-000170f0: 6572 5f6f 6666 7365 747d 2074 6f6f 6b20  er_offset} took 
-00017100: 270a 2320 2020 2020 2020 2020 2020 2020  '.#             
-00017110: 2020 2020 2020 202b 2027 667b 7469 6d65         + 'f{time
-00017120: 2829 2d74 303a 2e32 667d 2073 6563 6f6e  ()-t0:.2f} secon
-00017130: 6473 2729 0a23 2020 2020 2020 2020 2020  ds').#          
-00017140: 2020 2020 2020 7469 746c 6520 3d20 6627        title = f'
-00017150: 6564 6765 7320 726f 777b 726f 777d 2063  edges row{row} c
-00017160: 656e 7465 725f 6f66 6673 6574 7b63 656e  enter_offset{cen
-00017170: 7465 725f 6f66 6673 6574 3a2e 3266 7d27  ter_offset:.2f}'
-00017180: 0a23 2020 2020 2020 2020 2020 2020 2020  .#              
-00017190: 2020 7365 6c66 2e5f 706c 6f74 5f65 6467    self._plot_edg
-000171a0: 6573 5f6f 6e65 5f70 6c61 6e65 2872 6563  es_one_plane(rec
-000171b0: 6f6e 5f70 6c61 6e65 2c20 7469 746c 652c  on_plane, title,
-000171c0: 2070 6174 683d 7061 7468 290a 2320 2020   path=path).#   
-000171d0: 2020 2020 2020 2020 2069 6620 696e 7075           if inpu
-000171e0: 745f 696e 7428 275c 6e43 6f6e 7469 6e75  t_int('\nContinu
-000171f0: 6520 2830 2920 6f72 2065 6e64 2074 6865  e (0) or end the
-00017200: 2073 6561 7263 6820 2831 2927 2c20 6765   search (1)', ge
-00017210: 3d30 2c20 6c65 3d31 293a 0a23 2020 2020  =0, le=1):.#    
-00017220: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-00017230: 6b0a 0a20 2020 2020 2020 2064 656c 2073  k..        del s
-00017240: 696e 6f67 7261 6d5f 740a 2020 2020 2020  inogram_t.      
-00017250: 2020 6465 6c20 7265 636f 6e5f 706c 616e    del recon_plan
-00017260: 650a 2320 2020 2020 2020 2063 656e 7465  e.#        cente
-00017270: 725f 6f66 6673 6574 203d 2069 6e70 7574  r_offset = input
-00017280: 5f6e 756d 280a 2320 2020 2020 2020 2020  _num(.#         
-00017290: 2020 2027 2020 2020 456e 7465 7220 6368     '    Enter ch
-000172a0: 6f73 656e 2063 656e 7465 7220 6f66 6673  osen center offs
-000172b0: 6574 272c 2067 653d 2d63 656e 7465 722c  et', ge=-center,
-000172c0: 206c 653d 6365 6e74 6572 290a 2020 2020   le=center).    
-000172d0: 2020 2020 6365 6e74 6572 5f6f 6666 7365      center_offse
-000172e0: 7420 3d20 6365 6e74 6572 5f6f 6666 7365  t = center_offse
-000172f0: 745f 766f 0a0a 2020 2020 2020 2020 7265  t_vo..        re
-00017300: 7475 726e 2066 6c6f 6174 2863 656e 7465  turn float(cente
-00017310: 725f 6f66 6673 6574 290a 0a20 2020 2064  r_offset)..    d
-00017320: 6566 205f 7265 636f 6e73 7472 7563 745f  ef _reconstruct_
-00017330: 6f6e 655f 706c 616e 6528 0a20 2020 2020  one_plane(.     
-00017340: 2020 2020 2020 2073 656c 662c 2074 6f6d         self, tom
-00017350: 6f5f 706c 616e 655f 742c 2063 656e 7465  o_plane_t, cente
-00017360: 722c 2074 6865 7461 732c 2065 6666 5f70  r, thetas, eff_p
-00017370: 6978 656c 5f73 697a 652c 0a20 2020 2020  ixel_size,.     
-00017380: 2020 2020 2020 2063 726f 7373 5f73 6563         cross_sec
-00017390: 7469 6f6e 616c 5f64 696d 2c20 706c 6f74  tional_dim, plot
-000173a0: 5f73 696e 6f67 7261 6d3d 5472 7565 2c20  _sinogram=True, 
-000173b0: 6e75 6d5f 636f 7265 3d31 2c0a 2020 2020  num_core=1,.    
-000173c0: 2020 2020 2020 2020 6761 7573 7369 616e          gaussian
-000173d0: 5f73 6967 6d61 3d4e 6f6e 652c 2072 696e  _sigma=None, rin
-000173e0: 675f 7769 6474 683d 4e6f 6e65 293a 0a20  g_width=None):. 
-000173f0: 2020 2020 2020 2022 2222 496e 7665 7274         """Invert
-00017400: 2074 6865 2073 696e 6f67 7261 6d20 666f   the sinogram fo
-00017410: 7220 6120 7369 6e67 6c65 2074 6f6d 6f67  r a single tomog
-00017420: 7261 7068 7920 706c 616e 652e 2222 220a  raphy plane.""".
-00017430: 2020 2020 2020 2020 2320 5468 6972 6420          # Third 
-00017440: 7061 7274 7920 6d6f 6475 6c65 730a 2020  party modules.  
-00017450: 2020 2020 2020 6672 6f6d 2073 6369 7079        from scipy
-00017460: 2e6e 6469 6d61 6765 2069 6d70 6f72 7420  .ndimage import 
-00017470: 6761 7573 7369 616e 5f66 696c 7465 720a  gaussian_filter.
-00017480: 2020 2020 2020 2020 6672 6f6d 2073 6b69          from ski
-00017490: 6d61 6765 2e74 7261 6e73 666f 726d 2069  mage.transform i
-000174a0: 6d70 6f72 7420 6972 6164 6f6e 0a20 2020  mport iradon.   
-000174b0: 2020 2020 2066 726f 6d20 746f 6d6f 7079       from tomopy
-000174c0: 2069 6d70 6f72 7420 6d69 7363 0a0a 2020   import misc..  
-000174d0: 2020 2020 2020 2320 746f 6d6f 5f70 6c61        # tomo_pla
-000174e0: 6e65 5f74 2069 6e64 6578 206f 7264 6572  ne_t index order
-000174f0: 3a20 636f 6c75 6d6e 2c74 6865 7461 0a20  : column,theta. 
-00017500: 2020 2020 2020 2061 7373 6572 7420 3020         assert 0 
-00017510: 3c3d 2063 656e 7465 7220 3c20 746f 6d6f  <= center < tomo
-00017520: 5f70 6c61 6e65 5f74 2e73 6861 7065 5b30  _plane_t.shape[0
-00017530: 5d0a 2020 2020 2020 2020 6365 6e74 6572  ].        center
-00017540: 5f6f 6666 7365 7420 3d20 6365 6e74 6572  _offset = center
-00017550: 2d74 6f6d 6f5f 706c 616e 655f 742e 7368  -tomo_plane_t.sh
-00017560: 6170 655b 305d 2f32 0a20 2020 2020 2020  ape[0]/2.       
-00017570: 2074 776f 5f6f 6666 7365 7420 3d20 3220   two_offset = 2 
-00017580: 2a20 696e 7428 6e70 2e72 6f75 6e64 2863  * int(np.round(c
-00017590: 656e 7465 725f 6f66 6673 6574 2929 0a20  enter_offset)). 
-000175a0: 2020 2020 2020 2074 776f 5f6f 6666 7365         two_offse
-000175b0: 745f 6162 7320 3d20 6e70 2e61 6273 2874  t_abs = np.abs(t
-000175c0: 776f 5f6f 6666 7365 7429 0a20 2020 2020  wo_offset).     
-000175d0: 2020 2023 2041 6464 2031 3025 2073 6c61     # Add 10% sla
-000175e0: 636b 2074 6f20 6d61 785f 7261 6420 746f  ck to max_rad to
-000175f0: 2061 766f 6964 2065 6467 6520 6566 6665   avoid edge effe
-00017600: 6374 730a 2020 2020 2020 2020 6d61 785f  cts.        max_
-00017610: 7261 6420 3d20 696e 7428 302e 3535 202a  rad = int(0.55 *
-00017620: 2028 6372 6f73 735f 7365 6374 696f 6e61   (cross_sectiona
-00017630: 6c5f 6469 6d2f 6566 665f 7069 7865 6c5f  l_dim/eff_pixel_
-00017640: 7369 7a65 2929 0a20 2020 2020 2020 2069  size)).        i
-00017650: 6620 6d61 785f 7261 6420 3e20 302e 352a  f max_rad > 0.5*
-00017660: 746f 6d6f 5f70 6c61 6e65 5f74 2e73 6861  tomo_plane_t.sha
-00017670: 7065 5b30 5d3a 0a20 2020 2020 2020 2020  pe[0]:.         
-00017680: 2020 206d 6178 5f72 6164 203d 2030 2e35     max_rad = 0.5
-00017690: 2a74 6f6d 6f5f 706c 616e 655f 742e 7368  *tomo_plane_t.sh
-000176a0: 6170 655b 305d 0a20 2020 2020 2020 2064  ape[0].        d
-000176b0: 6973 745f 6672 6f6d 5f65 6467 6520 3d20  ist_from_edge = 
-000176c0: 6d61 7828 312c 2069 6e74 286e 702e 666c  max(1, int(np.fl
-000176d0: 6f6f 7228 0a20 2020 2020 2020 2020 2020  oor(.           
-000176e0: 2028 746f 6d6f 5f70 6c61 6e65 5f74 2e73   (tomo_plane_t.s
-000176f0: 6861 7065 5b30 5d20 2d20 7477 6f5f 6f66  hape[0] - two_of
-00017700: 6673 6574 5f61 6273 2920 2f20 322e 2920  fset_abs) / 2.) 
-00017710: 2d20 6d61 785f 7261 6429 290a 2020 2020  - max_rad)).    
-00017720: 2020 2020 6966 2074 776f 5f6f 6666 7365      if two_offse
-00017730: 7420 3e3d 2030 3a0a 2020 2020 2020 2020  t >= 0:.        
-00017740: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-00017750: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-00017760: 2020 2020 2020 2020 6627 7369 6e6f 6772          f'sinogr
-00017770: 616d 2072 616e 6765 203d 205b 7b74 776f  am range = [{two
-00017780: 5f6f 6666 7365 742b 6469 7374 5f66 726f  _offset+dist_fro
-00017790: 6d5f 6564 6765 7d2c 2027 0a20 2020 2020  m_edge}, '.     
-000177a0: 2020 2020 2020 2020 2020 202b 2066 277b             + f'{
-000177b0: 2d64 6973 745f 6672 6f6d 5f65 6467 657d  -dist_from_edge}
-000177c0: 5d27 290a 2020 2020 2020 2020 2020 2020  ]').            
-000177d0: 7369 6e6f 6772 616d 203d 2074 6f6d 6f5f  sinogram = tomo_
-000177e0: 706c 616e 655f 745b 0a20 2020 2020 2020  plane_t[.       
-000177f0: 2020 2020 2020 2020 2074 776f 5f6f 6666           two_off
-00017800: 7365 742b 6469 7374 5f66 726f 6d5f 6564  set+dist_from_ed
-00017810: 6765 3a2d 6469 7374 5f66 726f 6d5f 6564  ge:-dist_from_ed
-00017820: 6765 2c3a 5d0a 2020 2020 2020 2020 656c  ge,:].        el
-00017830: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00017840: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
-00017850: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-00017860: 2020 2020 6627 7369 6e6f 6772 616d 2072      f'sinogram r
-00017870: 616e 6765 203d 205b 7b64 6973 745f 6672  ange = [{dist_fr
-00017880: 6f6d 5f65 6467 657d 2c20 270a 2020 2020  om_edge}, '.    
-00017890: 2020 2020 2020 2020 2020 2020 2b20 6627              + f'
-000178a0: 7b74 776f 5f6f 6666 7365 742d 6469 7374  {two_offset-dist
-000178b0: 5f66 726f 6d5f 6564 6765 7d5d 2729 0a20  _from_edge}]'). 
-000178c0: 2020 2020 2020 2020 2020 2073 696e 6f67             sinog
-000178d0: 7261 6d20 3d20 746f 6d6f 5f70 6c61 6e65  ram = tomo_plane
-000178e0: 5f74 5b64 6973 745f 6672 6f6d 5f65 6467  _t[dist_from_edg
-000178f0: 653a 7477 6f5f 6f66 6673 6574 2d64 6973  e:two_offset-dis
-00017900: 745f 6672 6f6d 5f65 6467 652c 3a5d 0a20  t_from_edge,:]. 
-00017910: 2020 2020 2020 2069 6620 706c 6f74 5f73         if plot_s
-00017920: 696e 6f67 7261 6d3a 0a20 2020 2020 2020  inogram:.       
-00017930: 2020 2020 2071 7569 636b 5f69 6d73 686f       quick_imsho
-00017940: 7728 0a20 2020 2020 2020 2020 2020 2020  w(.             
-00017950: 2020 2073 696e 6f67 7261 6d2e 542c 2066     sinogram.T, f
-00017960: 2773 696e 6f67 7261 6d20 6365 6e74 6572  'sinogram center
-00017970: 206f 6666 7365 747b 6365 6e74 6572 5f6f   offset{center_o
-00017980: 6666 7365 743a 2e32 667d 272c 0a20 2020  ffset:.2f}',.   
-00017990: 2020 2020 2020 2020 2020 2020 2061 7370               asp
-000179a0: 6563 743d 2761 7574 6f27 2c20 7061 7468  ect='auto', path
-000179b0: 3d73 656c 662e 5f6f 7574 7075 745f 666f  =self._output_fo
-000179c0: 6c64 6572 2c0a 2020 2020 2020 2020 2020  lder,.          
-000179d0: 2020 2020 2020 7361 7665 5f66 6967 3d73        save_fig=s
-000179e0: 656c 662e 5f73 6176 655f 6669 6773 2c20  elf._save_figs, 
-000179f0: 7361 7665 5f6f 6e6c 793d 7365 6c66 2e5f  save_only=self._
-00017a00: 7361 7665 5f6f 6e6c 792c 0a20 2020 2020  save_only,.     
-00017a10: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
-00017a20: 3d73 656c 662e 5f62 6c6f 636b 290a 0a20  =self._block).. 
-00017a30: 2020 2020 2020 2023 2049 6e76 6572 7469         # Inverti
-00017a40: 6e67 2073 696e 6f67 7261 6d0a 2020 2020  ng sinogram.    
-00017a50: 2020 2020 7430 203d 2074 696d 6528 290a      t0 = time().
-00017a60: 2020 2020 2020 2020 7265 636f 6e5f 7369          recon_si
-00017a70: 6e6f 6772 616d 203d 2069 7261 646f 6e28  nogram = iradon(
-00017a80: 7369 6e6f 6772 616d 2c20 7468 6574 613d  sinogram, theta=
-00017a90: 7468 6574 6173 2c20 6369 7263 6c65 3d54  thetas, circle=T
-00017aa0: 7275 6529 0a20 2020 2020 2020 2073 656c  rue).        sel
-00017ab0: 662e 5f6c 6f67 6765 722e 696e 666f 2866  f._logger.info(f
-00017ac0: 2749 6e76 6572 7469 6e67 2073 696e 6f67  'Inverting sinog
-00017ad0: 7261 6d20 746f 6f6b 207b 7469 6d65 2829  ram took {time()
-00017ae0: 2d74 303a 2e32 667d 2073 6563 6f6e 6473  -t0:.2f} seconds
-00017af0: 2729 0a20 2020 2020 2020 2064 656c 2073  ').        del s
-00017b00: 696e 6f67 7261 6d0a 0a20 2020 2020 2020  inogram..       
-00017b10: 2023 2050 6572 666f 726d 696e 6720 4761   # Performing Ga
-00017b20: 7573 7369 616e 2066 696c 7465 7269 6e67  ussian filtering
-00017b30: 2061 6e64 2072 656d 6f76 696e 6720 7269   and removing ri
-00017b40: 6e67 2061 7274 6966 6163 7473 0a20 2020  ng artifacts.   
-00017b50: 2020 2020 2069 6620 6761 7573 7369 616e       if gaussian
-00017b60: 5f73 6967 6d61 2069 7320 6e6f 7420 4e6f  _sigma is not No
-00017b70: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00017b80: 7265 636f 6e5f 7369 6e6f 6772 616d 203d  recon_sinogram =
-00017b90: 2067 6175 7373 6961 6e5f 6669 6c74 6572   gaussian_filter
-00017ba0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00017bb0: 2020 7265 636f 6e5f 7369 6e6f 6772 616d    recon_sinogram
-00017bc0: 2c20 6761 7573 7369 616e 5f73 6967 6d61  , gaussian_sigma
-00017bd0: 2c20 6d6f 6465 3d27 6e65 6172 6573 7427  , mode='nearest'
-00017be0: 290a 2020 2020 2020 2020 7265 636f 6e5f  ).        recon_
-00017bf0: 636c 6561 6e20 3d20 6e70 2e65 7870 616e  clean = np.expan
-00017c00: 645f 6469 6d73 2872 6563 6f6e 5f73 696e  d_dims(recon_sin
-00017c10: 6f67 7261 6d2c 2061 7869 733d 3029 0a20  ogram, axis=0). 
-00017c20: 2020 2020 2020 2064 656c 2072 6563 6f6e         del recon
-00017c30: 5f73 696e 6f67 7261 6d0a 2020 2020 2020  _sinogram.      
-00017c40: 2020 6966 2072 696e 675f 7769 6474 6820    if ring_width 
-00017c50: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00017c60: 2020 2020 2020 2020 2072 6563 6f6e 5f63           recon_c
-00017c70: 6c65 616e 203d 206d 6973 632e 636f 7272  lean = misc.corr
-00017c80: 2e72 656d 6f76 655f 7269 6e67 280a 2020  .remove_ring(.  
-00017c90: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00017ca0: 636f 6e5f 636c 6561 6e2c 2072 7769 6474  con_clean, rwidt
-00017cb0: 683d 7269 6e67 5f77 6964 7468 2c20 6e63  h=ring_width, nc
-00017cc0: 6f72 653d 6e75 6d5f 636f 7265 290a 0a20  ore=num_core).. 
-00017cd0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00017ce0: 636f 6e5f 636c 6561 6e0a 0a20 2020 2064  con_clean..    d
-00017cf0: 6566 205f 706c 6f74 5f65 6467 6573 5f6f  ef _plot_edges_o
-00017d00: 6e65 5f70 6c61 6e65 2873 656c 662c 2072  ne_plane(self, r
-00017d10: 6563 6f6e 5f70 6c61 6e65 2c20 7469 746c  econ_plane, titl
-00017d20: 652c 2070 6174 683d 4e6f 6e65 293a 0a20  e, path=None):. 
-00017d30: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00017d40: 2020 2043 7265 6174 6520 616e 2022 6564     Create an "ed
-00017d50: 6765 7320 706c 6f74 2220 666f 7220 6120  ges plot" for a 
-00017d60: 7369 6e67 6c65 6420 7265 636f 6e73 7472  singled reconstr
-00017d70: 7563 7465 6420 746f 6d6f 6772 6170 6879  ucted tomography
-00017d80: 0a20 2020 2020 2020 2064 6174 6120 706c  .        data pl
-00017d90: 616e 652e 0a20 2020 2020 2020 2022 2222  ane..        """
-00017da0: 0a20 2020 2020 2020 2023 2054 6869 7264  .        # Third
-00017db0: 2070 6172 7479 206d 6f64 756c 6573 0a20   party modules. 
-00017dc0: 2020 2020 2020 2066 726f 6d20 736b 696d         from skim
-00017dd0: 6167 652e 7265 7374 6f72 6174 696f 6e20  age.restoration 
-00017de0: 696d 706f 7274 2064 656e 6f69 7365 5f74  import denoise_t
-00017df0: 765f 6368 616d 626f 6c6c 650a 0a20 2020  v_chambolle..   
-00017e00: 2020 2020 2076 6973 5f70 6172 616d 6574       vis_paramet
-00017e10: 6572 7320 3d20 4e6f 6e65 2020 2320 7365  ers = None  # se
-00017e20: 6c66 2e5f 636f 6e66 6967 2e67 6574 2827  lf._config.get('
-00017e30: 7669 735f 7061 7261 6d65 7465 7273 2729  vis_parameters')
-00017e40: 0a20 2020 2020 2020 2069 6620 7669 735f  .        if vis_
-00017e50: 7061 7261 6d65 7465 7273 2069 7320 4e6f  parameters is No
-00017e60: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00017e70: 7765 6967 6874 203d 2030 2e31 0a20 2020  weight = 0.1.   
-00017e80: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00017e90: 2020 2020 2020 2077 6569 6768 7420 3d20         weight = 
-00017ea0: 7669 735f 7061 7261 6d65 7465 7273 2e67  vis_parameters.g
-00017eb0: 6574 2827 6465 6e6f 6973 655f 7765 6967  et('denoise_weig
-00017ec0: 6874 272c 2030 2e31 290a 2020 2020 2020  ht', 0.1).      
-00017ed0: 2020 2020 2020 6966 206e 6f74 2069 735f        if not is_
-00017ee0: 6e75 6d28 7765 6967 6874 2c20 6765 3d30  num(weight, ge=0
-00017ef0: 2e29 3a0a 2020 2020 2020 2020 2020 2020  .):.            
-00017f00: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-00017f10: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
-00017f20: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00017f30: 496e 7661 6c69 6420 7765 6967 6874 2028  Invalid weight (
-00017f40: 7b77 6569 6768 747d 2920 696e 205f 706c  {weight}) in _pl
-00017f50: 6f74 5f65 6467 6573 5f6f 6e65 5f70 6c61  ot_edges_one_pla
-00017f60: 6e65 2c20 270a 2020 2020 2020 2020 2020  ne, '.          
-00017f70: 2020 2020 2020 2020 2020 2b20 2773 6574            + 'set
-00017f80: 2074 6f20 6120 6465 6661 756c 7420 6f66   to a default of
-00017f90: 2030 2e31 2729 0a20 2020 2020 2020 2020   0.1').         
-00017fa0: 2020 2020 2020 2077 6569 6768 7420 3d20         weight = 
-00017fb0: 302e 310a 2020 2020 2020 2020 6564 6765  0.1.        edge
-00017fc0: 7320 3d20 6465 6e6f 6973 655f 7476 5f63  s = denoise_tv_c
-00017fd0: 6861 6d62 6f6c 6c65 2872 6563 6f6e 5f70  hambolle(recon_p
-00017fe0: 6c61 6e65 2c20 7765 6967 6874 3d77 6569  lane, weight=wei
-00017ff0: 6768 7429 0a20 2020 2020 2020 2076 6d61  ght).        vma
-00018000: 7820 3d20 6e70 2e6d 6178 2865 6467 6573  x = np.max(edges
-00018010: 5b30 2c3a 2c3a 5d29 0a20 2020 2020 2020  [0,:,:]).       
-00018020: 2076 6d69 6e20 3d20 2d76 6d61 780a 2020   vmin = -vmax.  
-00018030: 2020 2020 2020 6966 2070 6174 6820 6973        if path is
-00018040: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00018050: 2020 2070 6174 6820 3d20 7365 6c66 2e5f     path = self._
-00018060: 6f75 7470 7574 5f66 6f6c 6465 720a 2020  output_folder.  
-00018070: 2020 2020 2020 7175 6963 6b5f 696d 7368        quick_imsh
-00018080: 6f77 280a 2020 2020 2020 2020 2020 2020  ow(.            
-00018090: 6564 6765 735b 302c 3a2c 3a5d 2c20 6627  edges[0,:,:], f'
-000180a0: 7b74 6974 6c65 7d20 636f 6f6c 7761 726d  {title} coolwarm
-000180b0: 272c 2070 6174 683d 7061 7468 2c20 636d  ', path=path, cm
-000180c0: 6170 3d27 636f 6f6c 7761 726d 272c 0a20  ap='coolwarm',. 
-000180d0: 2020 2020 2020 2020 2020 2073 6176 655f             save_
-000180e0: 6669 673d 7365 6c66 2e5f 7361 7665 5f66  fig=self._save_f
-000180f0: 6967 732c 2073 6176 655f 6f6e 6c79 3d73  igs, save_only=s
-00018100: 656c 662e 5f73 6176 655f 6f6e 6c79 2c0a  elf._save_only,.
-00018110: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
-00018120: 6b3d 7365 6c66 2e5f 626c 6f63 6b29 0a20  k=self._block). 
-00018130: 2020 2020 2020 2071 7569 636b 5f69 6d73         quick_ims
-00018140: 686f 7728 0a20 2020 2020 2020 2020 2020  how(.           
-00018150: 2065 6467 6573 5b30 2c3a 2c3a 5d2c 2066   edges[0,:,:], f
-00018160: 277b 7469 746c 657d 2067 7261 7927 2c20  '{title} gray', 
-00018170: 7061 7468 3d70 6174 682c 2063 6d61 703d  path=path, cmap=
-00018180: 2767 7261 7927 2c20 766d 696e 3d76 6d69  'gray', vmin=vmi
-00018190: 6e2c 0a20 2020 2020 2020 2020 2020 2076  n,.            v
-000181a0: 6d61 783d 766d 6178 2c20 7361 7665 5f66  max=vmax, save_f
-000181b0: 6967 3d73 656c 662e 5f73 6176 655f 6669  ig=self._save_fi
-000181c0: 6773 2c20 7361 7665 5f6f 6e6c 793d 7365  gs, save_only=se
-000181d0: 6c66 2e5f 7361 7665 5f6f 6e6c 792c 0a20  lf._save_only,. 
-000181e0: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
-000181f0: 3d73 656c 662e 5f62 6c6f 636b 290a 2020  =self._block).  
-00018200: 2020 2020 2020 6465 6c20 6564 6765 730a        del edges.
-00018210: 0a20 2020 2064 6566 205f 7265 636f 6e73  .    def _recons
-00018220: 7472 7563 745f 6f6e 655f 746f 6d6f 5f73  truct_one_tomo_s
-00018230: 7461 636b 280a 2020 2020 2020 2020 2020  tack(.          
-00018240: 2020 7365 6c66 2c20 746f 6d6f 5f73 7461    self, tomo_sta
-00018250: 636b 2c20 7468 6574 6173 2c20 6365 6e74  ck, thetas, cent
-00018260: 6572 5f6f 6666 7365 7473 3d4e 6f6e 652c  er_offsets=None,
-00018270: 206e 756d 5f63 6f72 653d 312c 0a20 2020   num_core=1,.   
-00018280: 2020 2020 2020 2020 2061 6c67 6f72 6974           algorit
-00018290: 686d 3d27 6772 6964 7265 6327 2c20 7365  hm='gridrec', se
-000182a0: 636f 6e64 6172 795f 6974 6572 733d 302c  condary_iters=0,
-000182b0: 2072 656d 6f76 655f 7374 7269 7065 5f73   remove_stripe_s
-000182c0: 6967 6d61 3d4e 6f6e 652c 0a20 2020 2020  igma=None,.     
-000182d0: 2020 2020 2020 2072 696e 675f 7769 6474         ring_widt
-000182e0: 683d 4e6f 6e65 293a 0a20 2020 2020 2020  h=None):.       
-000182f0: 2022 2222 5265 636f 6e73 7472 7563 7420   """Reconstruct 
-00018300: 6120 7369 6e67 6c65 2074 6f6d 6f67 7261  a single tomogra
-00018310: 7068 7920 7374 6163 6b2e 2222 220a 2020  phy stack.""".  
-00018320: 2020 2020 2020 2320 5468 6972 6420 7061        # Third pa
-00018330: 7274 7920 6d6f 6475 6c65 730a 2020 2020  rty modules.    
-00018340: 2020 2020 6672 6f6d 2074 6f6d 6f70 7920      from tomopy 
-00018350: 696d 706f 7274 2028 0a20 2020 2020 2020  import (.       
-00018360: 2020 2020 2061 7374 7261 2c0a 2020 2020       astra,.    
-00018370: 2020 2020 2020 2020 6d69 7363 2c0a 2020          misc,.  
-00018380: 2020 2020 2020 2020 2020 7072 6570 2c0a            prep,.
-00018390: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-000183a0: 6e2c 0a20 2020 2020 2020 2029 0a0a 2020  n,.        )..  
-000183b0: 2020 2020 2020 2320 746f 6d6f 5f73 7461        # tomo_sta
-000183c0: 636b 206f 7264 6572 3a20 726f 772c 7468  ck order: row,th
-000183d0: 6574 612c 636f 6c75 6d6e 0a20 2020 2020  eta,column.     
-000183e0: 2020 2023 2069 6e70 7574 2074 6865 7461     # input theta
-000183f0: 7320 6d75 7374 2062 6520 696e 2064 6567  s must be in deg
-00018400: 7265 6573 0a20 2020 2020 2020 2023 2063  rees.        # c
-00018410: 656e 7465 7273 5f6f 6666 7365 743a 2074  enters_offset: t
-00018420: 6f6d 6f67 7261 7068 7920 6178 6973 2073  omography axis s
-00018430: 6869 6674 2069 6e20 7069 7865 6c73 2072  hift in pixels r
-00018440: 656c 6174 6976 650a 2020 2020 2020 2020  elative.        
-00018450: 2320 2020 2020 746f 2063 6f6c 756d 6e20  #     to column 
-00018460: 6365 6e74 6572 0a20 2020 2020 2020 2023  center.        #
-00018470: 2052 5620 7368 6f75 6c64 2077 6520 7265   RV should we re
-00018480: 6d6f 7665 2073 7472 6970 6573 3f0a 2020  move stripes?.  
-00018490: 2020 2020 2020 2320 6874 7470 733a 2f2f        # https://
-000184a0: 746f 6d6f 7079 2e72 6561 6474 6865 646f  tomopy.readthedo
-000184b0: 6373 2e69 6f2f 656e 2f6c 6174 6573 742f  cs.io/en/latest/
-000184c0: 6170 692f 746f 6d6f 7079 2e70 7265 702e  api/tomopy.prep.
-000184d0: 7374 7269 7065 2e68 746d 6c0a 2020 2020  stripe.html.    
-000184e0: 2020 2020 2320 5256 2073 686f 756c 6420      # RV should 
-000184f0: 7765 2072 656d 6f76 6520 7269 6e67 733f  we remove rings?
-00018500: 0a20 2020 2020 2020 2023 2068 7474 7073  .        # https
-00018510: 3a2f 2f74 6f6d 6f70 792e 7265 6164 7468  ://tomopy.readth
-00018520: 6564 6f63 732e 696f 2f65 6e2f 6c61 7465  edocs.io/en/late
-00018530: 7374 2f61 7069 2f74 6f6d 6f70 792e 6d69  st/api/tomopy.mi
-00018540: 7363 2e63 6f72 722e 6874 6d6c 0a20 2020  sc.corr.html.   
-00018550: 2020 2020 2023 2052 5620 6164 6420 616e       # RV add an
-00018560: 206f 7074 696f 6e20 746f 2064 6f20 2865   option to do (e
-00018570: 7874 7261 2920 7365 636f 6e64 6172 7920  xtra) secondary 
-00018580: 6974 6572 6174 696f 6e73 206c 6174 6572  iterations later
-00018590: 206f 720a 2020 2020 2020 2020 2320 2020   or.        #   
-000185a0: 2020 746f 2064 6f20 736f 6d65 2073 6f72    to do some sor
-000185b0: 7420 6f66 2063 6f6e 7665 7267 656e 6365  t of convergence
-000185c0: 2074 6573 743f 0a20 2020 2020 2020 2069   test?.        i
-000185d0: 6620 6365 6e74 6572 5f6f 6666 7365 7473  f center_offsets
-000185e0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-000185f0: 2020 2020 2020 6365 6e74 6572 7320 3d20        centers = 
-00018600: 6e70 2e7a 6572 6f73 2828 746f 6d6f 5f73  np.zeros((tomo_s
-00018610: 7461 636b 2e73 6861 7065 5b30 5d29 290a  tack.shape[0])).
-00018620: 2020 2020 2020 2020 656c 6966 206c 656e          elif len
-00018630: 2863 656e 7465 725f 6f66 6673 6574 7329  (center_offsets)
-00018640: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
-00018650: 2020 2063 656e 7465 7273 203d 206e 702e     centers = np.
-00018660: 6c69 6e73 7061 6365 280a 2020 2020 2020  linspace(.      
-00018670: 2020 2020 2020 2020 2020 6365 6e74 6572            center
-00018680: 5f6f 6666 7365 7473 5b30 5d2c 2063 656e  _offsets[0], cen
-00018690: 7465 725f 6f66 6673 6574 735b 315d 2c20  ter_offsets[1], 
-000186a0: 746f 6d6f 5f73 7461 636b 2e73 6861 7065  tomo_stack.shape
-000186b0: 5b30 5d29 0a20 2020 2020 2020 2065 6c73  [0]).        els
-000186c0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-000186d0: 6620 6365 6e74 6572 5f6f 6666 7365 7473  f center_offsets
-000186e0: 2e73 697a 6520 213d 2074 6f6d 6f5f 7374  .size != tomo_st
-000186f0: 6163 6b2e 7368 6170 655b 305d 3a0a 2020  ack.shape[0]:.  
-00018700: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00018710: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
-00018720: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00018730: 2020 2020 2020 2763 656e 7465 725f 6f66        'center_of
-00018740: 6673 6574 7320 6469 6d65 6e73 696f 6e20  fsets dimension 
-00018750: 6d69 736d 6174 6368 2069 6e20 270a 2020  mismatch in '.  
-00018760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018770: 2020 2b20 2772 6563 6f6e 7374 7275 6374    + 'reconstruct
-00018780: 5f6f 6e65 5f74 6f6d 6f5f 7374 6163 6b27  _one_tomo_stack'
-00018790: 290a 2020 2020 2020 2020 2020 2020 6365  ).            ce
-000187a0: 6e74 6572 7320 3d20 6365 6e74 6572 5f6f  nters = center_o
-000187b0: 6666 7365 7473 0a20 2020 2020 2020 2063  ffsets.        c
-000187c0: 656e 7465 7273 202b 3d20 746f 6d6f 5f73  enters += tomo_s
-000187d0: 7461 636b 2e73 6861 7065 5b32 5d2f 320a  tack.shape[2]/2.
-000187e0: 0a20 2020 2020 2020 2023 2052 656d 6f76  .        # Remov
-000187f0: 6520 686f 7269 7a6f 6e74 616c 2073 7472  e horizontal str
-00018800: 6970 650a 2020 2020 2020 2020 6966 2072  ipe.        if r
-00018810: 656d 6f76 655f 7374 7269 7065 5f73 6967  emove_stripe_sig
-00018820: 6d61 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ma is not None:.
-00018830: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00018840: 756d 5f63 6f72 6520 3e20 4e55 4d5f 434f  um_core > NUM_CO
-00018850: 5245 5f54 4f4d 4f50 595f 4c49 4d49 543a  RE_TOMOPY_LIMIT:
-00018860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018870: 2074 6f6d 6f5f 7374 6163 6b20 3d20 7072   tomo_stack = pr
-00018880: 6570 2e73 7472 6970 652e 7265 6d6f 7665  ep.stripe.remove
-00018890: 5f73 7472 6970 655f 6677 280a 2020 2020  _stripe_fw(.    
-000188a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000188b0: 746f 6d6f 5f73 7461 636b 2c20 7369 676d  tomo_stack, sigm
-000188c0: 613d 7265 6d6f 7665 5f73 7472 6970 655f  a=remove_stripe_
-000188d0: 7369 676d 612c 0a20 2020 2020 2020 2020  sigma,.         
-000188e0: 2020 2020 2020 2020 2020 206e 636f 7265             ncore
-000188f0: 3d4e 554d 5f43 4f52 455f 544f 4d4f 5059  =NUM_CORE_TOMOPY
-00018900: 5f4c 494d 4954 290a 2020 2020 2020 2020  _LIMIT).        
-00018910: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00018920: 2020 2020 2020 2020 2020 746f 6d6f 5f73            tomo_s
-00018930: 7461 636b 203d 2070 7265 702e 7374 7269  tack = prep.stri
-00018940: 7065 2e72 656d 6f76 655f 7374 7269 7065  pe.remove_stripe
-00018950: 5f66 7728 0a20 2020 2020 2020 2020 2020  _fw(.           
-00018960: 2020 2020 2020 2020 2074 6f6d 6f5f 7374           tomo_st
-00018970: 6163 6b2c 2073 6967 6d61 3d72 656d 6f76  ack, sigma=remov
-00018980: 655f 7374 7269 7065 5f73 6967 6d61 2c20  e_stripe_sigma, 
-00018990: 6e63 6f72 653d 6e75 6d5f 636f 7265 290a  ncore=num_core).
-000189a0: 0a20 2020 2020 2020 2023 2050 6572 666f  .        # Perfo
-000189b0: 726d 2069 6e69 7469 616c 2069 6d61 6765  rm initial image
-000189c0: 2072 6563 6f6e 7374 7275 6374 696f 6e0a   reconstruction.
-000189d0: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-000189e0: 6767 6572 2e64 6562 7567 2827 5065 7266  gger.debug('Perf
-000189f0: 6f72 6d69 6e67 2069 6e69 7469 616c 2069  orming initial i
-00018a00: 6d61 6765 2072 6563 6f6e 7374 7275 6374  mage reconstruct
-00018a10: 696f 6e27 290a 2020 2020 2020 2020 7430  ion').        t0
-00018a20: 203d 2074 696d 6528 290a 2020 2020 2020   = time().      
-00018a30: 2020 746f 6d6f 5f72 6563 6f6e 5f73 7461    tomo_recon_sta
-00018a40: 636b 203d 2072 6563 6f6e 280a 2020 2020  ck = recon(.    
-00018a50: 2020 2020 2020 2020 746f 6d6f 5f73 7461          tomo_sta
-00018a60: 636b 2c20 6e70 2e72 6164 6961 6e73 2874  ck, np.radians(t
-00018a70: 6865 7461 7329 2c20 6365 6e74 6572 732c  hetas), centers,
-00018a80: 2073 696e 6f67 7261 6d5f 6f72 6465 723d   sinogram_order=
-00018a90: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-00018aa0: 2020 616c 676f 7269 7468 6d3d 616c 676f    algorithm=algo
-00018ab0: 7269 7468 6d2c 206e 636f 7265 3d6e 756d  rithm, ncore=num
-00018ac0: 5f63 6f72 6529 0a20 2020 2020 2020 2073  _core).        s
-00018ad0: 656c 662e 5f6c 6f67 6765 722e 696e 666f  elf._logger.info
-00018ae0: 280a 2020 2020 2020 2020 2020 2020 6627  (.            f'
-00018af0: 5065 7266 6f72 6d69 6e67 2069 6e69 7469  Performing initi
-00018b00: 616c 2069 6d61 6765 2072 6563 6f6e 7374  al image reconst
-00018b10: 7275 6374 696f 6e20 746f 6f6b 207b 7469  ruction took {ti
-00018b20: 6d65 2829 2d74 303a 2e32 667d 2027 0a20  me()-t0:.2f} '. 
-00018b30: 2020 2020 2020 2020 2020 202b 2027 7365             + 'se
-00018b40: 636f 6e64 7327 290a 0a20 2020 2020 2020  conds')..       
-00018b50: 2023 2052 756e 206f 7074 696f 6e61 6c20   # Run optional 
-00018b60: 7365 636f 6e64 6172 7920 6974 6572 6174  secondary iterat
-00018b70: 696f 6e73 0a20 2020 2020 2020 2069 6620  ions.        if 
-00018b80: 7365 636f 6e64 6172 795f 6974 6572 7320  secondary_iters 
-00018b90: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-00018ba0: 2073 656c 662e 5f6c 6f67 6765 722e 6465   self._logger.de
-00018bb0: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-00018bc0: 2020 2020 2027 5275 6e6e 696e 6720 7b73       'Running {s
-00018bd0: 6563 6f6e 6461 7279 5f69 7465 7273 7d20  econdary_iters} 
-00018be0: 7365 636f 6e64 6172 7920 6974 6572 6174  secondary iterat
-00018bf0: 696f 6e73 2729 0a23 2020 2020 2020 2020  ions').#        
-00018c00: 2020 2020 6f70 7469 6f6e 7320 3d20 7b0a      options = {.
-00018c10: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-00018c20: 2027 6d65 7468 6f64 273a 2027 5349 5254   'method': 'SIRT
-00018c30: 5f43 5544 4127 2c0a 2320 2020 2020 2020  _CUDA',.#       
-00018c40: 2020 2020 2020 2020 2027 7072 6f6a 5f74           'proj_t
-00018c50: 7970 6527 3a20 2763 7564 6127 2c0a 2320  ype': 'cuda',.# 
-00018c60: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00018c70: 6e75 6d5f 6974 6572 273a 2073 6563 6f6e  num_iter': secon
-00018c80: 6461 7279 5f69 7465 7273 0a23 2020 2020  dary_iters.#    
-00018c90: 2020 2020 2020 2020 7d0a 2320 5256 2064          }.# RV d
-00018ca0: 6f65 736e 2774 2077 6f72 6b20 666f 7220  oesn't work for 
-00018cb0: 6d65 3a0a 2320 2245 7272 6f72 3a20 4355  me:.# "Error: CU
-00018cc0: 4441 2065 7272 6f72 2038 3033 3a20 7379  DA error 803: sy
-00018cd0: 7374 656d 2068 6173 2075 6e73 7570 706f  stem has unsuppo
-00018ce0: 7274 6564 2064 6973 706c 6179 2064 7269  rted display dri
-00018cf0: 7665 722f 6375 6461 2064 7269 7665 720a  ver/cuda driver.
-00018d00: 2320 2020 2020 636f 6d62 696e 6174 696f  #     combinatio
-00018d10: 6e2e 220a 2320 2020 2020 2020 2020 2020  n.".#           
-00018d20: 206f 7074 696f 6e73 203d 207b 0a23 2020   options = {.#  
-00018d30: 2020 2020 2020 2020 2020 2020 2020 276d                'm
-00018d40: 6574 686f 6427 3a20 2753 4952 5427 2c0a  ethod': 'SIRT',.
-00018d50: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-00018d60: 2027 7072 6f6a 5f74 7970 6527 3a20 276c   'proj_type': 'l
-00018d70: 696e 6561 7227 2c0a 2320 2020 2020 2020  inear',.#       
-00018d80: 2020 2020 2020 2020 2027 4d69 6e43 6f6e           'MinCon
-00018d90: 7374 7261 696e 7427 3a20 302c 0a23 2020  straint': 0,.#  
-00018da0: 2020 2020 2020 2020 2020 2020 2020 276e                'n
-00018db0: 756d 5f69 7465 7227 3a73 6563 6f6e 6461  um_iter':seconda
-00018dc0: 7279 5f69 7465 7273 0a23 2020 2020 2020  ry_iters.#      
-00018dd0: 2020 2020 2020 7d0a 2320 5349 5254 2064        }.# SIRT d
-00018de0: 6964 206e 6f74 2066 696e 6973 6820 7768  id not finish wh
-00018df0: 696c 6520 7275 6e6e 696e 6720 6f76 6572  ile running over
-00018e00: 6e69 6768 740a 2320 2020 2020 2020 2020  night.#         
-00018e10: 2020 206f 7074 696f 6e73 203d 207b 0a23     options = {.#
-00018e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e30: 276d 6574 686f 6427 3a20 2753 4152 5427  'method': 'SART'
-00018e40: 2c0a 2320 2020 2020 2020 2020 2020 2020  ,.#             
-00018e50: 2020 2027 7072 6f6a 5f74 7970 6527 3a20     'proj_type': 
-00018e60: 276c 696e 6561 7227 2c0a 2320 2020 2020  'linear',.#     
-00018e70: 2020 2020 2020 2020 2020 2027 6e75 6d5f             'num_
-00018e80: 6974 6572 273a 7365 636f 6e64 6172 795f  iter':secondary_
-00018e90: 6974 6572 730a 2320 2020 2020 2020 2020  iters.#         
-00018ea0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00018eb0: 206f 7074 696f 6e73 203d 207b 0a20 2020   options = {.   
-00018ec0: 2020 2020 2020 2020 2020 2020 2027 6d65               'me
-00018ed0: 7468 6f64 273a 2027 5341 5254 272c 0a20  thod': 'SART',. 
-00018ee0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00018ef0: 7072 6f6a 5f74 7970 6527 3a20 276c 696e  proj_type': 'lin
-00018f00: 6561 7227 2c0a 2020 2020 2020 2020 2020  ear',.          
-00018f10: 2020 2020 2020 274d 696e 436f 6e73 7472        'MinConstr
-00018f20: 6169 6e74 273a 2030 2c0a 2020 2020 2020  aint': 0,.      
-00018f30: 2020 2020 2020 2020 2020 276e 756d 5f69            'num_i
-00018f40: 7465 7227 3a20 7365 636f 6e64 6172 795f  ter': secondary_
-00018f50: 6974 6572 732c 0a20 2020 2020 2020 2020  iters,.         
-00018f60: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00018f70: 2074 3020 3d20 7469 6d65 2829 0a20 2020   t0 = time().   
-00018f80: 2020 2020 2020 2020 2074 6f6d 6f5f 7265           tomo_re
-00018f90: 636f 6e5f 7374 6163 6b20 3d20 7265 636f  con_stack = reco
-00018fa0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-00018fb0: 2020 2074 6f6d 6f5f 7374 6163 6b2c 206e     tomo_stack, n
-00018fc0: 702e 7261 6469 616e 7328 7468 6574 6173  p.radians(thetas
-00018fd0: 292c 2063 656e 7465 7273 2c0a 2020 2020  ), centers,.    
-00018fe0: 2020 2020 2020 2020 2020 2020 696e 6974              init
-00018ff0: 5f72 6563 6f6e 3d74 6f6d 6f5f 7265 636f  _recon=tomo_reco
-00019000: 6e5f 7374 6163 6b2c 206f 7074 696f 6e73  n_stack, options
-00019010: 3d6f 7074 696f 6e73 2c0a 2020 2020 2020  =options,.      
-00019020: 2020 2020 2020 2020 2020 7369 6e6f 6772            sinogr
-00019030: 616d 5f6f 7264 6572 3d54 7275 652c 2061  am_order=True, a
-00019040: 6c67 6f72 6974 686d 3d61 7374 7261 2c20  lgorithm=astra, 
-00019050: 6e63 6f72 653d 6e75 6d5f 636f 7265 290a  ncore=num_core).
-00019060: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00019070: 2e5f 6c6f 6767 6572 2e69 6e66 6f28 0a20  ._logger.info(. 
-00019080: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00019090: 2750 6572 666f 726d 696e 6720 7365 636f  'Performing seco
-000190a0: 6e64 6172 7920 6974 6572 6174 696f 6e73  ndary iterations
-000190b0: 2074 6f6f 6b20 7b74 696d 6528 292d 7430   took {time()-t0
-000190c0: 3a2e 3266 7d20 270a 2020 2020 2020 2020  :.2f} '.        
-000190d0: 2020 2020 2020 2020 2b20 2773 6563 6f6e          + 'secon
-000190e0: 6473 2729 0a0a 2020 2020 2020 2020 2320  ds')..        # 
-000190f0: 5265 6d6f 7665 2072 696e 6720 6172 7469  Remove ring arti
-00019100: 6661 6374 730a 2020 2020 2020 2020 6966  facts.        if
-00019110: 2072 696e 675f 7769 6474 6820 6973 206e   ring_width is n
-00019120: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00019130: 2020 2020 206d 6973 632e 636f 7272 2e72       misc.corr.r
-00019140: 656d 6f76 655f 7269 6e67 280a 2020 2020  emove_ring(.    
-00019150: 2020 2020 2020 2020 2020 2020 746f 6d6f              tomo
-00019160: 5f72 6563 6f6e 5f73 7461 636b 2c20 7277  _recon_stack, rw
-00019170: 6964 7468 3d72 696e 675f 7769 6474 682c  idth=ring_width,
-00019180: 206f 7574 3d74 6f6d 6f5f 7265 636f 6e5f   out=tomo_recon_
-00019190: 7374 6163 6b2c 0a20 2020 2020 2020 2020  stack,.         
-000191a0: 2020 2020 2020 206e 636f 7265 3d6e 756d         ncore=num
-000191b0: 5f63 6f72 6529 0a0a 2020 2020 2020 2020  _core)..        
-000191c0: 7265 7475 726e 2074 6f6d 6f5f 7265 636f  return tomo_reco
-000191d0: 6e5f 7374 6163 6b0a 0a20 2020 2064 6566  n_stack..    def
-000191e0: 205f 7265 7369 7a65 5f72 6563 6f6e 7374   _resize_reconst
-000191f0: 7275 6374 6564 5f64 6174 6128 0a20 2020  ructed_data(.   
-00019200: 2020 2020 2020 2020 2073 656c 662c 2064           self, d
-00019210: 6174 612c 2078 5f62 6f75 6e64 733d 4e6f  ata, x_bounds=No
-00019220: 6e65 2c20 795f 626f 756e 6473 3d4e 6f6e  ne, y_bounds=Non
-00019230: 652c 207a 5f62 6f75 6e64 733d 4e6f 6e65  e, z_bounds=None
-00019240: 2c0a 2020 2020 2020 2020 2020 2020 7a5f  ,.            z_
-00019250: 6f6e 6c79 3d46 616c 7365 293a 0a20 2020  only=False):.   
-00019260: 2020 2020 2022 2222 5265 7369 7a65 2074       """Resize t
-00019270: 6865 2072 6563 6f6e 7374 7275 6374 6564  he reconstructed
-00019280: 2074 6f6d 6f67 7261 7068 7920 6461 7461   tomography data
-00019290: 2e22 2222 0a20 2020 2020 2020 2023 2044  .""".        # D
-000192a0: 6174 6120 6f72 6465 723a 2072 6f77 287a  ata order: row(z
-000192b0: 292c 782c 7920 6f72 2073 7461 636b 2c72  ),x,y or stack,r
-000192c0: 6f77 287a 292c 782c 790a 2020 2020 2020  ow(z),x,y.      
-000192d0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-000192e0: 6461 7461 2c20 6c69 7374 293a 0a20 2020  data, list):.   
-000192f0: 2020 2020 2020 2020 2066 6f72 2073 7461           for sta
-00019300: 636b 2069 6e20 6461 7461 3a0a 2020 2020  ck in data:.    
-00019310: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00019320: 7274 2073 7461 636b 2e6e 6469 6d20 3d3d  rt stack.ndim ==
-00019330: 2033 0a20 2020 2020 2020 2020 2020 206e   3.            n
-00019340: 756d 5f74 6f6d 6f5f 7374 6163 6b73 203d  um_tomo_stacks =
-00019350: 206c 656e 2864 6174 6129 0a20 2020 2020   len(data).     
-00019360: 2020 2020 2020 2074 6f6d 6f5f 7265 636f         tomo_reco
-00019370: 6e5f 7374 6163 6b73 203d 2064 6174 610a  n_stacks = data.
-00019380: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00019390: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000193a0: 2064 6174 612e 6e64 696d 203d 3d20 330a   data.ndim == 3.
-000193b0: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
-000193c0: 746f 6d6f 5f73 7461 636b 7320 3d20 310a  tomo_stacks = 1.
-000193d0: 2020 2020 2020 2020 2020 2020 746f 6d6f              tomo
-000193e0: 5f72 6563 6f6e 5f73 7461 636b 7320 3d20  _recon_stacks = 
-000193f0: 5b64 6174 615d 0a0a 2020 2020 2020 2020  [data]..        
-00019400: 6966 2078 5f62 6f75 6e64 7320 3d3d 2028  if x_bounds == (
-00019410: 2d31 2c20 2d31 293a 0a20 2020 2020 2020  -1, -1):.       
-00019420: 2020 2020 2078 5f62 6f75 6e64 7320 3d20       x_bounds = 
-00019430: 4e6f 6e65 0a20 2020 2020 2020 2065 6c69  None.        eli
-00019440: 6620 6e6f 7420 7a5f 6f6e 6c79 2061 6e64  f not z_only and
-00019450: 2078 5f62 6f75 6e64 7320 6973 204e 6f6e   x_bounds is Non
-00019460: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00019470: 2053 656c 6563 7469 6e67 2078 2062 6f75   Selecting x bou
-00019480: 6e64 7320 2869 6e20 797a 2d70 6c61 6e65  nds (in yz-plane
-00019490: 290a 2020 2020 2020 2020 2020 2020 746f  ).            to
-000194a0: 6d6f 7375 6d20 3d20 300a 2020 2020 2020  mosum = 0.      
-000194b0: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
-000194c0: 616e 6765 286e 756d 5f74 6f6d 6f5f 7374  ange(num_tomo_st
-000194d0: 6163 6b73 293a 0a20 2020 2020 2020 2020  acks):.         
-000194e0: 2020 2020 2020 2074 6f6d 6f73 756d 203d         tomosum =
-000194f0: 2074 6f6d 6f73 756d 202b 206e 702e 7375   tomosum + np.su
-00019500: 6d28 746f 6d6f 5f72 6563 6f6e 5f73 7461  m(tomo_recon_sta
-00019510: 636b 735b 695d 2c20 6178 6973 3d28 302c  cks[i], axis=(0,
-00019520: 3229 290a 2020 2020 2020 2020 2020 2020  2)).            
-00019530: 7365 6c65 6374 5f78 5f62 6f75 6e64 7320  select_x_bounds 
-00019540: 3d20 696e 7075 745f 7965 736e 6f28 0a20  = input_yesno(. 
-00019550: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00019560: 5c6e 446f 2079 6f75 2077 616e 7420 746f  \nDo you want to
-00019570: 2063 6861 6e67 6520 7468 6520 696d 6167   change the imag
-00019580: 6520 782d 626f 756e 6473 2028 792f 6e29  e x-bounds (y/n)
-00019590: 3f27 2c20 2779 2729 0a20 2020 2020 2020  ?', 'y').       
-000195a0: 2020 2020 2069 6620 6e6f 7420 7365 6c65       if not sele
-000195b0: 6374 5f78 5f62 6f75 6e64 733a 0a20 2020  ct_x_bounds:.   
-000195c0: 2020 2020 2020 2020 2020 2020 2078 5f62               x_b
-000195d0: 6f75 6e64 7320 3d20 4e6f 6e65 0a20 2020  ounds = None.   
-000195e0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000195f0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00019600: 6363 6570 7420 3d20 4661 6c73 650a 2020  ccept = False.  
-00019610: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00019620: 6465 785f 7261 6e67 6573 203d 204e 6f6e  dex_ranges = Non
-00019630: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00019640: 2020 7768 696c 6520 6e6f 7420 6163 6365    while not acce
-00019650: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-00019660: 2020 2020 2020 2020 5f2c 2078 5f62 6f75          _, x_bou
-00019670: 6e64 7320 3d20 6472 6177 5f6d 6173 6b5f  nds = draw_mask_
-00019680: 3164 280a 2020 2020 2020 2020 2020 2020  1d(.            
-00019690: 2020 2020 2020 2020 2020 2020 746f 6d6f              tomo
-000196a0: 7375 6d2c 2063 7572 7265 6e74 5f69 6e64  sum, current_ind
-000196b0: 6578 5f72 616e 6765 733d 696e 6465 785f  ex_ranges=index_
-000196c0: 7261 6e67 6573 2c0a 2020 2020 2020 2020  ranges,.        
-000196d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000196e0: 7469 746c 653d 2773 656c 6563 7420 7820  title='select x 
-000196f0: 6461 7461 2072 616e 6765 272c 0a20 2020  data range',.   
-00019700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019710: 2020 2020 2079 6c61 6265 6c3d 2773 756d       ylabel='sum
-00019720: 2079 7a27 290a 2020 2020 2020 2020 2020   yz').          
-00019730: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-00019740: 6c65 6e28 785f 626f 756e 6473 2920 213d  len(x_bounds) !=
-00019750: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-00019760: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00019770: 7428 2750 6c65 6173 6520 7365 6c65 6374  t('Please select
-00019780: 2065 7861 6374 6c79 206f 6e65 2063 6f6e   exactly one con
-00019790: 7469 6e75 6f75 7320 7261 6e67 6527 290a  tinuous range').
-000197a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000197b0: 2020 2020 2020 2020 5f2c 2078 5f62 6f75          _, x_bou
-000197c0: 6e64 7320 3d20 6472 6177 5f6d 6173 6b5f  nds = draw_mask_
-000197d0: 3164 280a 2020 2020 2020 2020 2020 2020  1d(.            
-000197e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000197f0: 746f 6d6f 7375 6d2c 2074 6974 6c65 3d27  tomosum, title='
-00019800: 7365 6c65 6374 2078 2064 6174 6120 7261  select x data ra
-00019810: 6e67 6527 2c0a 2020 2020 2020 2020 2020  nge',.          
-00019820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019830: 2020 796c 6162 656c 3d27 7375 6d20 797a    ylabel='sum yz
-00019840: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-00019850: 2020 2020 2020 2078 5f62 6f75 6e64 7320         x_bounds 
-00019860: 3d20 785f 626f 756e 6473 5b30 5d0a 2020  = x_bounds[0].  
-00019870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019880: 2020 6163 6365 7074 203d 2054 7275 650a    accept = True.
-00019890: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000198a0: 2e5f 6c6f 6767 6572 2e64 6562 7567 2866  ._logger.debug(f
-000198b0: 2778 5f62 6f75 6e64 7320 3d20 7b78 5f62  'x_bounds = {x_b
-000198c0: 6f75 6e64 737d 2729 0a0a 2020 2020 2020  ounds}')..      
-000198d0: 2020 6966 2079 5f62 6f75 6e64 7320 3d3d    if y_bounds ==
-000198e0: 2028 2d31 2c20 2d31 293a 0a20 2020 2020   (-1, -1):.     
-000198f0: 2020 2020 2020 2079 5f62 6f75 6e64 7320         y_bounds 
-00019900: 3d20 4e6f 6e65 0a20 2020 2020 2020 2065  = None.        e
-00019910: 6c69 6620 6e6f 7420 7a5f 6f6e 6c79 2061  lif not z_only a
-00019920: 6e64 2079 5f62 6f75 6e64 7320 6973 204e  nd y_bounds is N
-00019930: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00019940: 2023 2053 656c 6563 7469 6e67 2079 2062   # Selecting y b
-00019950: 6f75 6e64 7320 2869 6e20 787a 2d70 6c61  ounds (in xz-pla
-00019960: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
-00019970: 746f 6d6f 7375 6d20 3d20 300a 2020 2020  tomosum = 0.    
-00019980: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
-00019990: 2072 616e 6765 286e 756d 5f74 6f6d 6f5f   range(num_tomo_
-000199a0: 7374 6163 6b73 293a 0a20 2020 2020 2020  stacks):.       
-000199b0: 2020 2020 2020 2020 2074 6f6d 6f73 756d           tomosum
-000199c0: 203d 2074 6f6d 6f73 756d 202b 206e 702e   = tomosum + np.
-000199d0: 7375 6d28 746f 6d6f 5f72 6563 6f6e 5f73  sum(tomo_recon_s
-000199e0: 7461 636b 735b 695d 2c20 6178 6973 3d28  tacks[i], axis=(
-000199f0: 302c 3129 290a 2020 2020 2020 2020 2020  0,1)).          
-00019a00: 2020 7365 6c65 6374 5f79 5f62 6f75 6e64    select_y_bound
-00019a10: 7320 3d20 696e 7075 745f 7965 736e 6f28  s = input_yesno(
-00019a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019a30: 2027 5c6e 446f 2079 6f75 2077 616e 7420   '\nDo you want 
-00019a40: 746f 2063 6861 6e67 6520 7468 6520 696d  to change the im
-00019a50: 6167 6520 792d 626f 756e 6473 2028 792f  age y-bounds (y/
-00019a60: 6e29 3f27 2c20 2779 2729 0a20 2020 2020  n)?', 'y').     
-00019a70: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-00019a80: 6c65 6374 5f79 5f62 6f75 6e64 733a 0a20  lect_y_bounds:. 
-00019a90: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-00019aa0: 5f62 6f75 6e64 7320 3d20 4e6f 6e65 0a20  _bounds = None. 
-00019ab0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00019ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019ad0: 2061 6363 6570 7420 3d20 4661 6c73 650a   accept = False.
-00019ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019af0: 696e 6465 785f 7261 6e67 6573 203d 204e  index_ranges = N
-00019b00: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00019b10: 2020 2020 7768 696c 6520 6e6f 7420 6163      while not ac
-00019b20: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
-00019b30: 2020 2020 2020 2020 2020 5f2c 2079 5f62            _, y_b
-00019b40: 6f75 6e64 7320 3d20 6472 6177 5f6d 6173  ounds = draw_mas
-00019b50: 6b5f 3164 280a 2020 2020 2020 2020 2020  k_1d(.          
-00019b60: 2020 2020 2020 2020 2020 2020 2020 746f                to
-00019b70: 6d6f 7375 6d2c 2063 7572 7265 6e74 5f69  mosum, current_i
-00019b80: 6e64 6578 5f72 616e 6765 733d 696e 6465  ndex_ranges=inde
-00019b90: 785f 7261 6e67 6573 2c0a 2020 2020 2020  x_ranges,.      
-00019ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019bb0: 2020 7469 746c 653d 2773 656c 6563 7420    title='select 
-00019bc0: 7820 6461 7461 2072 616e 6765 272c 0a20  x data range',. 
-00019bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019be0: 2020 2020 2020 2079 6c61 6265 6c3d 2773         ylabel='s
-00019bf0: 756d 2078 7a27 290a 2020 2020 2020 2020  um xz').        
-00019c00: 2020 2020 2020 2020 2020 2020 7768 696c              whil
-00019c10: 6520 6c65 6e28 795f 626f 756e 6473 2920  e len(y_bounds) 
-00019c20: 213d 2031 3a0a 2020 2020 2020 2020 2020  != 1:.          
-00019c30: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00019c40: 696e 7428 2750 6c65 6173 6520 7365 6c65  int('Please sele
-00019c50: 6374 2065 7861 6374 6c79 206f 6e65 2063  ct exactly one c
-00019c60: 6f6e 7469 6e75 6f75 7320 7261 6e67 6527  ontinuous range'
-00019c70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00019c80: 2020 2020 2020 2020 2020 5f2c 2079 5f62            _, y_b
-00019c90: 6f75 6e64 7320 3d20 6472 6177 5f6d 6173  ounds = draw_mas
-00019ca0: 6b5f 3164 280a 2020 2020 2020 2020 2020  k_1d(.          
-00019cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019cc0: 2020 746f 6d6f 7375 6d2c 2074 6974 6c65    tomosum, title
-00019cd0: 3d27 7365 6c65 6374 2078 2064 6174 6120  ='select x data 
-00019ce0: 7261 6e67 6527 2c0a 2020 2020 2020 2020  range',.        
-00019cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d00: 2020 2020 796c 6162 656c 3d27 7375 6d20      ylabel='sum 
-00019d10: 787a 2729 0a20 2020 2020 2020 2020 2020  xz').           
-00019d20: 2020 2020 2020 2020 2079 5f62 6f75 6e64           y_bound
-00019d30: 7320 3d20 795f 626f 756e 6473 5b30 5d0a  s = y_bounds[0].
-00019d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d50: 2020 2020 6163 6365 7074 203d 2054 7275      accept = Tru
-00019d60: 650a 2020 2020 2020 2020 2020 2020 7365  e.            se
-00019d70: 6c66 2e5f 6c6f 6767 6572 2e64 6562 7567  lf._logger.debug
-00019d80: 2866 2779 5f62 6f75 6e64 7320 3d20 7b79  (f'y_bounds = {y
-00019d90: 5f62 6f75 6e64 737d 2729 0a0a 2020 2020  _bounds}')..    
-00019da0: 2020 2020 2320 5365 6c65 6374 696e 6720      # Selecting 
-00019db0: 7a20 626f 756e 6473 2028 696e 2078 792d  z bounds (in xy-
-00019dc0: 706c 616e 6529 0a20 2020 2020 2020 2023  plane).        #
-00019dd0: 2028 6f6e 6c79 2076 616c 6964 2066 6f72   (only valid for
-00019de0: 2061 2073 696e 676c 6520 696d 6167 6520   a single image 
-00019df0: 7374 6163 6b29 0a20 2020 2020 2020 2069  stack).        i
-00019e00: 6620 7a5f 626f 756e 6473 203d 3d20 282d  f z_bounds == (-
-00019e10: 312c 202d 3129 3a0a 2020 2020 2020 2020  1, -1):.        
-00019e20: 2020 2020 7a5f 626f 756e 6473 203d 204e      z_bounds = N
-00019e30: 6f6e 650a 2020 2020 2020 2020 656c 6966  one.        elif
-00019e40: 207a 5f62 6f75 6e64 7320 6973 204e 6f6e   z_bounds is Non
-00019e50: 6520 616e 6420 6e75 6d5f 746f 6d6f 5f73  e and num_tomo_s
-00019e60: 7461 636b 7320 213d 2031 3a0a 2020 2020  tacks != 1:.    
-00019e70: 2020 2020 2020 2020 746f 6d6f 7375 6d20          tomosum 
-00019e80: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
-00019e90: 666f 7220 6920 696e 2072 616e 6765 286e  for i in range(n
-00019ea0: 756d 5f74 6f6d 6f5f 7374 6163 6b73 293a  um_tomo_stacks):
-00019eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019ec0: 2074 6f6d 6f73 756d 203d 2074 6f6d 6f73   tomosum = tomos
-00019ed0: 756d 202b 206e 702e 7375 6d28 746f 6d6f  um + np.sum(tomo
-00019ee0: 5f72 6563 6f6e 5f73 7461 636b 735b 695d  _recon_stacks[i]
-00019ef0: 2c20 6178 6973 3d28 312c 3229 290a 2020  , axis=(1,2)).  
-00019f00: 2020 2020 2020 2020 2020 7365 6c65 6374            select
-00019f10: 5f7a 5f62 6f75 6e64 7320 3d20 696e 7075  _z_bounds = inpu
-00019f20: 745f 7965 736e 6f28 0a20 2020 2020 2020  t_yesno(.       
-00019f30: 2020 2020 2020 2020 2027 446f 2079 6f75           'Do you
-00019f40: 2077 616e 7420 746f 2063 6861 6e67 6520   want to change 
-00019f50: 7468 6520 696d 6167 6520 7a2d 626f 756e  the image z-boun
-00019f60: 6473 2028 792f 6e29 3f27 2c20 276e 2729  ds (y/n)?', 'n')
-00019f70: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00019f80: 6e6f 7420 7365 6c65 6374 5f7a 5f62 6f75  not select_z_bou
-00019f90: 6e64 733a 0a20 2020 2020 2020 2020 2020  nds:.           
-00019fa0: 2020 2020 207a 5f62 6f75 6e64 7320 3d20       z_bounds = 
-00019fb0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00019fc0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00019fd0: 2020 2020 2020 2061 6363 6570 7420 3d20         accept = 
-00019fe0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
-00019ff0: 2020 2020 2020 696e 6465 785f 7261 6e67        index_rang
-0001a000: 6573 203d 204e 6f6e 650a 2020 2020 2020  es = None.      
-0001a010: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-0001a020: 6e6f 7420 6163 6365 7074 3a0a 2020 2020  not accept:.    
-0001a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a040: 5f2c 207a 5f62 6f75 6e64 7320 3d20 6472  _, z_bounds = dr
-0001a050: 6177 5f6d 6173 6b5f 3164 280a 2020 2020  aw_mask_1d(.    
-0001a060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a070: 2020 2020 746f 6d6f 7375 6d2c 2063 7572      tomosum, cur
-0001a080: 7265 6e74 5f69 6e64 6578 5f72 616e 6765  rent_index_range
-0001a090: 733d 696e 6465 785f 7261 6e67 6573 2c0a  s=index_ranges,.
-0001a0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a0b0: 2020 2020 2020 2020 7469 746c 653d 2773          title='s
-0001a0c0: 656c 6563 7420 7820 6461 7461 2072 616e  elect x data ran
-0001a0d0: 6765 272c 0a20 2020 2020 2020 2020 2020  ge',.           
-0001a0e0: 2020 2020 2020 2020 2020 2020 2079 6c61               yla
-0001a0f0: 6265 6c3d 2773 756d 2078 7927 290a 2020  bel='sum xy').  
-0001a100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a110: 2020 7768 696c 6520 6c65 6e28 7a5f 626f    while len(z_bo
-0001a120: 756e 6473 2920 213d 2031 3a0a 2020 2020  unds) != 1:.    
-0001a130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a140: 2020 2020 7072 696e 7428 2750 6c65 6173      print('Pleas
-0001a150: 6520 7365 6c65 6374 2065 7861 6374 6c79  e select exactly
-0001a160: 206f 6e65 2063 6f6e 7469 6e75 6f75 7320   one continuous 
-0001a170: 7261 6e67 6527 290a 2020 2020 2020 2020  range').        
-0001a180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a190: 5f2c 207a 5f62 6f75 6e64 7320 3d20 6472  _, z_bounds = dr
-0001a1a0: 6177 5f6d 6173 6b5f 3164 280a 2020 2020  aw_mask_1d(.    
-0001a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1c0: 2020 2020 2020 2020 746f 6d6f 7375 6d2c          tomosum,
-0001a1d0: 2074 6974 6c65 3d27 7365 6c65 6374 2078   title='select x
-0001a1e0: 2064 6174 6120 7261 6e67 6527 2c0a 2020   data range',.  
-0001a1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a200: 2020 2020 2020 2020 2020 796c 6162 656c            ylabel
-0001a210: 3d27 7375 6d20 7879 2729 0a20 2020 2020  ='sum xy').     
-0001a220: 2020 2020 2020 2020 2020 2020 2020 207a                 z
-0001a230: 5f62 6f75 6e64 7320 3d20 7a5f 626f 756e  _bounds = z_boun
-0001a240: 6473 5b30 5d0a 2020 2020 2020 2020 2020  ds[0].          
-0001a250: 2020 2020 2020 2020 2020 6163 6365 7074            accept
-0001a260: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-0001a270: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-0001a280: 2e64 6562 7567 2866 277a 5f62 6f75 6e64  .debug(f'z_bound
-0001a290: 7320 3d20 7b7a 5f62 6f75 6e64 737d 2729  s = {z_bounds}')
-0001a2a0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0001a2b0: 2078 5f62 6f75 6e64 732c 2079 5f62 6f75   x_bounds, y_bou
-0001a2c0: 6e64 732c 207a 5f62 6f75 6e64 730a 0a0a  nds, z_bounds...
-0001a2d0: 636c 6173 7320 546f 6d6f 5369 6d46 6965  class TomoSimFie
-0001a2e0: 6c64 5072 6f63 6573 736f 7228 5072 6f63  ldProcessor(Proc
-0001a2f0: 6573 736f 7229 3a0a 2020 2020 2222 220a  essor):.    """.
-0001a300: 2020 2020 436c 6173 7320 7265 7072 6573      Class repres
-0001a310: 656e 7469 6e67 2074 6865 2070 726f 6365  enting the proce
-0001a320: 7373 2074 6f20 6372 6561 7465 2061 2073  ss to create a s
-0001a330: 696d 756c 6174 6564 2074 6f6d 6f67 7261  imulated tomogra
-0001a340: 7068 790a 2020 2020 6461 7461 2073 6574  phy.    data set
-0001a350: 2072 6574 7572 6e69 6e67 2061 2060 6e65   returning a `ne
-0001a360: 7875 7366 6f72 6d61 742e 6e65 7875 732e  xusformat.nexus.
-0001a370: 4e58 726f 6f74 6020 6f62 6a65 6374 2063  NXroot` object c
-0001a380: 6f6e 7461 696e 696e 670a 2020 2020 7468  ontaining.    th
-0001a390: 6520 7369 6d75 6c61 7465 6420 746f 6d6f  e simulated tomo
-0001a3a0: 6772 6170 6879 2064 6574 6563 746f 7220  graphy detector 
-0001a3b0: 696d 6167 6573 2e0a 2020 2020 2222 220a  images..    """.
-0001a3c0: 0a20 2020 2064 6566 2070 726f 6365 7373  .    def process
-0001a3d0: 2873 656c 662c 2064 6174 612c 202a 2a6b  (self, data, **k
-0001a3e0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-0001a3f0: 2320 5468 6972 6420 7061 7274 7920 6d6f  # Third party mo
-0001a400: 6475 6c65 730a 2020 2020 2020 2020 6672  dules.        fr
-0001a410: 6f6d 206e 6578 7573 666f 726d 6174 2e6e  om nexusformat.n
-0001a420: 6578 7573 2069 6d70 6f72 7420 280a 2020  exus import (.  
-0001a430: 2020 2020 2020 2020 2020 4e58 6465 7465            NXdete
-0001a440: 6374 6f72 2c0a 2020 2020 2020 2020 2020  ctor,.          
-0001a450: 2020 4e58 656e 7472 792c 0a20 2020 2020    NXentry,.     
-0001a460: 2020 2020 2020 204e 5869 6e73 7472 756d         NXinstrum
-0001a470: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
-0001a480: 204e 5872 6f6f 742c 0a20 2020 2020 2020   NXroot,.       
-0001a490: 2020 2020 204e 5873 616d 706c 652c 0a20       NXsample,. 
-0001a4a0: 2020 2020 2020 2020 2020 204e 5873 6f75             NXsou
-0001a4b0: 7263 652c 0a20 2020 2020 2020 2029 0a0a  rce,.        )..
-0001a4c0: 2020 2020 2020 2020 2320 4765 7420 616e          # Get an
-0001a4d0: 6420 7661 6c69 6461 7465 2074 6865 2072  d validate the r
-0001a4e0: 656c 6576 616e 7420 636f 6e66 6967 7572  elevant configur
-0001a4f0: 6174 696f 6e20 6f62 6a65 6374 2069 6e20  ation object in 
-0001a500: 6461 7461 0a20 2020 2020 2020 2063 6f6e  data.        con
-0001a510: 6669 6720 3d20 7365 6c66 2e67 6574 5f63  fig = self.get_c
-0001a520: 6f6e 6669 6773 2864 6174 6129 0a0a 2020  onfigs(data)..  
-0001a530: 2020 2020 2020 7374 6174 696f 6e20 3d20        station = 
-0001a540: 636f 6e66 6967 2e73 7461 7469 6f6e 0a20  config.station. 
-0001a550: 2020 2020 2020 2073 616d 706c 655f 7479         sample_ty
-0001a560: 7065 203d 2063 6f6e 6669 672e 7361 6d70  pe = config.samp
-0001a570: 6c65 5f74 7970 650a 2020 2020 2020 2020  le_type.        
-0001a580: 7361 6d70 6c65 5f73 697a 6520 3d20 636f  sample_size = co
-0001a590: 6e66 6967 2e73 616d 706c 655f 7369 7a65  nfig.sample_size
-0001a5a0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-0001a5b0: 7361 6d70 6c65 5f73 697a 6529 203d 3d20  sample_size) == 
-0001a5c0: 313a 0a20 2020 2020 2020 2020 2020 2073  1:.            s
-0001a5d0: 616d 706c 655f 7369 7a65 203d 2028 7361  ample_size = (sa
-0001a5e0: 6d70 6c65 5f73 697a 655b 305d 2c20 7361  mple_size[0], sa
-0001a5f0: 6d70 6c65 5f73 697a 655b 305d 290a 2020  mple_size[0]).  
-0001a600: 2020 2020 2020 7761 6c6c 5f74 6869 636b        wall_thick
-0001a610: 6e65 7373 203d 2063 6f6e 6669 672e 7761  ness = config.wa
-0001a620: 6c6c 5f74 6869 636b 6e65 7373 0a20 2020  ll_thickness.   
-0001a630: 2020 2020 206d 7520 3d20 636f 6e66 6967       mu = config
-0001a640: 2e6d 750a 2020 2020 2020 2020 7468 6574  .mu.        thet
-0001a650: 615f 7374 6570 203d 2063 6f6e 6669 672e  a_step = config.
-0001a660: 7468 6574 615f 7374 6570 0a20 2020 2020  theta_step.     
-0001a670: 2020 2062 6561 6d5f 696e 7465 6e73 6974     beam_intensit
-0001a680: 7920 3d20 636f 6e66 6967 2e62 6561 6d5f  y = config.beam_
-0001a690: 696e 7465 6e73 6974 790a 2020 2020 2020  intensity.      
-0001a6a0: 2020 6261 636b 6772 6f75 6e64 5f69 6e74    background_int
-0001a6b0: 656e 7369 7479 203d 2063 6f6e 6669 672e  ensity = config.
-0001a6c0: 6261 636b 6772 6f75 6e64 5f69 6e74 656e  background_inten
-0001a6d0: 7369 7479 0a20 2020 2020 2020 2073 6c69  sity.        sli
-0001a6e0: 745f 7369 7a65 203d 2063 6f6e 6669 672e  t_size = config.
-0001a6f0: 736c 6974 5f73 697a 650a 2020 2020 2020  slit_size.      
-0001a700: 2020 7069 7865 6c5f 7369 7a65 203d 2063    pixel_size = c
-0001a710: 6f6e 6669 672e 6465 7465 6374 6f72 2e70  onfig.detector.p
-0001a720: 6978 656c 5f73 697a 650a 2020 2020 2020  ixel_size.      
-0001a730: 2020 6966 206c 656e 2870 6978 656c 5f73    if len(pixel_s
-0001a740: 697a 6529 203d 3d20 313a 0a20 2020 2020  ize) == 1:.     
-0001a750: 2020 2020 2020 2070 6978 656c 5f73 697a         pixel_siz
-0001a760: 6520 3d20 280a 2020 2020 2020 2020 2020  e = (.          
-0001a770: 2020 2020 2020 7069 7865 6c5f 7369 7a65        pixel_size
-0001a780: 5b30 5d2f 636f 6e66 6967 2e64 6574 6563  [0]/config.detec
-0001a790: 746f 722e 6c65 6e73 5f6d 6167 6e69 6669  tor.lens_magnifi
-0001a7a0: 6361 7469 6f6e 2c0a 2020 2020 2020 2020  cation,.        
-0001a7b0: 2020 2020 2020 2020 7069 7865 6c5f 7369          pixel_si
-0001a7c0: 7a65 5b30 5d2f 636f 6e66 6967 2e64 6574  ze[0]/config.det
-0001a7d0: 6563 746f 722e 6c65 6e73 5f6d 6167 6e69  ector.lens_magni
-0001a7e0: 6669 6361 7469 6f6e 2c0a 2020 2020 2020  fication,.      
-0001a7f0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001a800: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001a810: 2020 7069 7865 6c5f 7369 7a65 203d 2028    pixel_size = (
-0001a820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a830: 2070 6978 656c 5f73 697a 655b 305d 2f63   pixel_size[0]/c
-0001a840: 6f6e 6669 672e 6465 7465 6374 6f72 2e6c  onfig.detector.l
-0001a850: 656e 735f 6d61 676e 6966 6963 6174 696f  ens_magnificatio
-0001a860: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
-0001a870: 2020 2070 6978 656c 5f73 697a 655b 315d     pixel_size[1]
-0001a880: 2f63 6f6e 6669 672e 6465 7465 6374 6f72  /config.detector
-0001a890: 2e6c 656e 735f 6d61 676e 6966 6963 6174  .lens_magnificat
-0001a8a0: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
-0001a8b0: 2029 0a20 2020 2020 2020 2064 6574 6563   ).        detec
-0001a8c0: 746f 725f 7369 7a65 203d 2028 636f 6e66  tor_size = (conf
-0001a8d0: 6967 2e64 6574 6563 746f 722e 726f 7773  ig.detector.rows
-0001a8e0: 2c20 636f 6e66 6967 2e64 6574 6563 746f  , config.detecto
-0001a8f0: 722e 636f 6c75 6d6e 7329 0a20 2020 2020  r.columns).     
-0001a900: 2020 2069 6620 736c 6974 5f73 697a 652d     if slit_size-
-0001a910: 302e 352a 7069 7865 6c5f 7369 7a65 5b30  0.5*pixel_size[0
-0001a920: 5d20 3e20 6465 7465 6374 6f72 5f73 697a  ] > detector_siz
-0001a930: 655b 305d 2a70 6978 656c 5f73 697a 655b  e[0]*pixel_size[
-0001a940: 305d 3a0a 2020 2020 2020 2020 2020 2020  0]:.            
-0001a950: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-0001a960: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001a970: 2020 6627 536c 6974 2073 697a 6520 287b    f'Slit size ({
-0001a980: 736c 6974 5f73 697a 657d 2920 6c61 7267  slit_size}) larg
-0001a990: 6572 2074 6861 6e20 6465 7465 6374 6f72  er than detector
-0001a9a0: 2068 6569 6768 7420 270a 2020 2020 2020   height '.      
-0001a9b0: 2020 2020 2020 2020 2020 6627 287b 6465            f'({de
-0001a9c0: 7465 6374 6f72 5f73 697a 655b 305d 2a70  tector_size[0]*p
-0001a9d0: 6978 656c 5f73 697a 655b 305d 7d29 2729  ixel_size[0]})')
-0001a9e0: 0a0a 2020 2020 2020 2020 2320 4765 7420  ..        # Get 
-0001a9f0: 7468 6520 726f 7461 7469 6f6e 2061 6e67  the rotation ang
-0001aa00: 6c65 7320 2873 7461 7274 2061 7420 6120  les (start at a 
-0001aa10: 6172 6269 7472 6172 696c 7920 6368 6f6f  arbitrarily choo
-0001aa20: 7365 2061 6e67 6c65 0a20 2020 2020 2020  se angle.       
-0001aa30: 2023 2020 2020 616e 6420 6164 6420 7468   #    and add th
-0001aa40: 6574 6173 2066 6f72 2061 2066 756c 6c20  etas for a full 
-0001aa50: 3336 3020 6465 6772 6565 7320 726f 7461  360 degrees rota
-0001aa60: 7469 6f6e 2073 6572 6965 7329 0a20 2020  tion series).   
-0001aa70: 2020 2020 2069 6620 7374 6174 696f 6e20       if station 
-0001aa80: 696e 2028 2769 6431 6133 272c 2027 6964  in ('id1a3', 'id
-0001aa90: 3361 2729 3a0a 2020 2020 2020 2020 2020  3a'):.          
-0001aaa0: 2020 7468 6574 615f 7374 6172 7420 3d20    theta_start = 
-0001aab0: 302e 0a20 2020 2020 2020 2065 6c73 653a  0..        else:
-0001aac0: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
-0001aad0: 7461 5f73 7461 7274 203d 202d 3137 0a20  ta_start = -17. 
-0001aae0: 2020 2020 2020 2074 6865 7461 5f65 6e64         theta_end
-0001aaf0: 203d 2074 6865 7461 5f73 7461 7274 202b   = theta_start +
-0001ab00: 2033 3630 2e0a 2020 2020 2020 2020 7468   360..        th
-0001ab10: 6574 6173 203d 206c 6973 7428 0a20 2020  etas = list(.   
-0001ab20: 2020 2020 2020 2020 206e 702e 6172 616e           np.aran
-0001ab30: 6765 2874 6865 7461 5f73 7461 7274 2c20  ge(theta_start, 
-0001ab40: 7468 6574 615f 656e 642b 302e 352a 7468  theta_end+0.5*th
-0001ab50: 6574 615f 7374 6570 2c20 7468 6574 615f  eta_step, theta_
-0001ab60: 7374 6570 2929 0a0a 2020 2020 2020 2020  step))..        
-0001ab70: 2320 4765 7420 7468 6520 6e75 6d62 6572  # Get the number
-0001ab80: 206f 6620 686f 7269 7a6f 6e74 616c 2073   of horizontal s
-0001ab90: 7461 636b 7320 6261 7365 7320 6f6e 2074  tacks bases on t
-0001aba0: 6865 2064 6961 676f 6e61 6c0a 2020 2020  he diagonal.    
-0001abb0: 2020 2020 2320 2020 2020 6f66 2074 6865      #     of the
-0001abc0: 2073 7175 6172 6520 616e 6420 666f 7220   square and for 
-0001abd0: 6e6f 7720 646f 6e27 7420 616c 6c6f 7720  now don't allow 
-0001abe0: 6d6f 7265 2074 6861 6e20 6f6e 650a 2020  more than one.  
-0001abf0: 2020 2020 2020 6e75 6d5f 746f 6d6f 5f73        num_tomo_s
-0001ac00: 7461 636b 203d 2031 202b 2069 6e74 2828  tack = 1 + int((
-0001ac10: 7361 6d70 6c65 5f73 697a 655b 315d 2a6e  sample_size[1]*n
-0001ac20: 702e 7371 7274 2832 292d 7069 7865 6c5f  p.sqrt(2)-pixel_
-0001ac30: 7369 7a65 5b31 5d29 0a20 2020 2020 2020  size[1]).       
-0001ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac50: 2020 2020 2020 2020 2020 2f20 2864 6574            / (det
-0001ac60: 6563 746f 725f 7369 7a65 5b31 5d2a 7069  ector_size[1]*pi
-0001ac70: 7865 6c5f 7369 7a65 5b31 5d29 290a 2020  xel_size[1])).  
-0001ac80: 2020 2020 2020 6966 206e 756d 5f74 6f6d        if num_tom
-0001ac90: 6f5f 7374 6163 6b20 3e20 313a 0a20 2020  o_stack > 1:.   
-0001aca0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-0001acb0: 616c 7565 4572 726f 7228 2753 616d 706c  alueError('Sampl
-0001acc0: 6520 6973 2074 6f6f 2077 6964 6520 666f  e is too wide fo
-0001acd0: 7220 7468 6520 6465 7465 6374 6f72 2729  r the detector')
-0001ace0: 0a0a 2020 2020 2020 2020 2320 4372 6561  ..        # Crea
-0001acf0: 7465 2074 6865 2078 2d72 6179 2070 6174  te the x-ray pat
-0001ad00: 6820 6c65 6e67 7468 2074 6872 6f75 6768  h length through
-0001ad10: 2061 2073 6f6c 6964 2073 7175 6172 650a   a solid square.
-0001ad20: 2020 2020 2020 2020 2320 2020 2020 6372          #     cr
-0001ad30: 6f73 7373 6563 7469 6f6e 2066 6f72 2061  osssection for a
-0001ad40: 2073 6574 206f 6620 726f 7461 7469 6f6e   set of rotation
-0001ad50: 2061 6e67 6c65 732e 0a20 2020 2020 2020   angles..       
-0001ad60: 2070 6174 685f 6c65 6e67 7468 735f 736f   path_lengths_so
-0001ad70: 6c69 6420 3d20 7365 6c66 2e5f 6372 6561  lid = self._crea
-0001ad80: 7465 5f70 6174 686c 656e 6774 685f 736f  te_pathlength_so
-0001ad90: 6c69 645f 7371 7561 7265 280a 2020 2020  lid_square(.    
-0001ada0: 2020 2020 2020 2020 2020 2020 7361 6d70              samp
-0001adb0: 6c65 5f73 697a 655b 315d 2c20 7468 6574  le_size[1], thet
-0001adc0: 6173 2c20 7069 7865 6c5f 7369 7a65 5b31  as, pixel_size[1
-0001add0: 5d2c 2064 6574 6563 746f 725f 7369 7a65  ], detector_size
-0001ade0: 5b31 5d29 0a0a 2020 2020 2020 2020 2320  [1])..        # 
-0001adf0: 4372 6561 7465 2074 6865 2078 2d72 6179  Create the x-ray
-0001ae00: 2070 6174 6820 6c65 6e67 7468 2074 6872   path length thr
-0001ae10: 6f75 6768 2061 2068 6f6c 6c6f 7720 7371  ough a hollow sq
-0001ae20: 7561 7265 0a20 2020 2020 2020 2023 2020  uare.        #  
-0001ae30: 2020 2063 726f 7373 7365 6374 696f 6e20     crosssection 
-0001ae40: 666f 7220 6120 7365 7420 6f66 2072 6f74  for a set of rot
-0001ae50: 6174 696f 6e20 616e 676c 6573 2e0a 2020  ation angles..  
-0001ae60: 2020 2020 2020 7061 7468 5f6c 656e 6774        path_lengt
-0001ae70: 6873 5f68 6f6c 6c6f 7720 3d20 4e6f 6e65  hs_hollow = None
-0001ae80: 0a20 2020 2020 2020 2069 6620 7361 6d70  .        if samp
-0001ae90: 6c65 5f74 7970 6520 696e 2028 2773 7175  le_type in ('squ
-0001aea0: 6172 655f 7069 7065 272c 2027 686f 6c6c  are_pipe', 'holl
-0001aeb0: 6f77 5f63 7562 6527 2c20 2768 6f6c 6c6f  ow_cube', 'hollo
-0001aec0: 775f 6272 6963 6b27 293a 0a20 2020 2020  w_brick'):.     
-0001aed0: 2020 2020 2020 2070 6174 685f 6c65 6e67         path_leng
-0001aee0: 7468 735f 686f 6c6c 6f77 203d 2070 6174  ths_hollow = pat
-0001aef0: 685f 6c65 6e67 7468 735f 736f 6c69 6420  h_lengths_solid 
-0001af00: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-0001af10: 2020 2d20 7365 6c66 2e5f 6372 6561 7465    - self._create
-0001af20: 5f70 6174 686c 656e 6774 685f 736f 6c69  _pathlength_soli
-0001af30: 645f 7371 7561 7265 280a 2020 2020 2020  d_square(.      
-0001af40: 2020 2020 2020 2020 2020 2020 2020 7361                sa
-0001af50: 6d70 6c65 5f73 697a 655b 315d 202d 2032  mple_size[1] - 2
-0001af60: 2a77 616c 6c5f 7468 6963 6b6e 6573 732c  *wall_thickness,
-0001af70: 2074 6865 7461 732c 0a20 2020 2020 2020   thetas,.       
-0001af80: 2020 2020 2020 2020 2020 2020 2070 6978               pix
-0001af90: 656c 5f73 697a 655b 315d 2c20 6465 7465  el_size[1], dete
-0001afa0: 6374 6f72 5f73 697a 655b 315d 290a 0a20  ctor_size[1]).. 
-0001afb0: 2020 2020 2020 2023 2047 6574 2074 6865         # Get the
-0001afc0: 206e 756d 6265 7220 6f66 2073 7461 636b   number of stack
-0001afd0: 730a 2020 2020 2020 2020 6e75 6d5f 746f  s.        num_to
-0001afe0: 6d6f 5f73 7461 636b 203d 2031 202b 2069  mo_stack = 1 + i
-0001aff0: 6e74 2828 7361 6d70 6c65 5f73 697a 655b  nt((sample_size[
-0001b000: 305d 2d70 6978 656c 5f73 697a 655b 305d  0]-pixel_size[0]
-0001b010: 292f 736c 6974 5f73 697a 6529 0a20 2020  )/slit_size).   
-0001b020: 2020 2020 2069 6620 6e75 6d5f 746f 6d6f       if num_tomo
-0001b030: 5f73 7461 636b 203e 2031 2061 6e64 2073  _stack > 1 and s
-0001b040: 7461 7469 6f6e 203d 3d20 2769 6433 6227  tation == 'id3b'
-0001b050: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0001b060: 6973 6520 5661 6c75 6545 7272 6f72 2827  ise ValueError('
-0001b070: 5361 6d70 6c65 2069 7320 746f 2074 616c  Sample is to tal
-0001b080: 6c20 666f 7220 7468 6520 6465 7465 6374  l for the detect
-0001b090: 6f72 2729 0a0a 2020 2020 2020 2020 2320  or')..        # 
-0001b0a0: 4765 7420 7468 6520 636f 6c75 6d6e 2063  Get the column c
-0001b0b0: 6f6f 7264 696e 6174 6573 0a20 2020 2020  oordinates.     
-0001b0c0: 2020 2069 6d67 5f78 5f6f 6666 7365 7420     img_x_offset 
-0001b0d0: 3d20 2d30 2e35 202a 2028 6465 7465 6374  = -0.5 * (detect
-0001b0e0: 6f72 5f73 697a 655b 305d 2a70 6978 656c  or_size[0]*pixel
-0001b0f0: 5f73 697a 655b 305d 0a20 2020 2020 2020  _size[0].       
-0001b100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b110: 2020 2020 2020 2020 2b20 736c 6974 5f73          + slit_s
-0001b120: 697a 6520 2a20 286e 756d 5f74 6f6d 6f5f  ize * (num_tomo_
-0001b130: 7374 6163 6b2d 3129 290a 2020 2020 2020  stack-1)).      
-0001b140: 2020 696d 675f 785f 636f 6f72 6473 203d    img_x_coords =
-0001b150: 2028 696d 675f 785f 6f66 6673 6574 0a20   (img_x_offset. 
-0001b160: 2020 2020 2020 2020 2020 202b 2070 6978             + pix
-0001b170: 656c 5f73 697a 655b 305d 202a 2028 302e  el_size[0] * (0.
-0001b180: 3520 2b20 6e70 2e61 7361 7272 6179 2872  5 + np.asarray(r
-0001b190: 616e 6765 2869 6e74 2864 6574 6563 746f  ange(int(detecto
-0001b1a0: 725f 7369 7a65 5b30 5d29 2929 2929 0a0a  r_size[0])))))..
-0001b1b0: 2020 2020 2020 2020 2320 4765 7420 7468          # Get th
-0001b1c0: 6520 7472 616e 736d 6974 7465 6420 696e  e transmitted in
-0001b1d0: 7465 6e73 6974 6965 730a 2020 2020 2020  tensities.      
-0001b1e0: 2020 6e75 6d5f 7468 6574 6120 3d20 6c65    num_theta = le
-0001b1f0: 6e28 7468 6574 6173 290a 2020 2020 2020  n(thetas).      
-0001b200: 2020 7665 7274 6963 616c 5f73 6869 6674    vertical_shift
-0001b210: 7320 3d20 5b5d 0a20 2020 2020 2020 2074  s = [].        t
-0001b220: 6f6d 6f5f 6669 656c 6473 5f73 7461 636b  omo_fields_stack
-0001b230: 203d 205b 5d0a 2020 2020 2020 2020 696d   = [].        im
-0001b240: 675f 6469 6d20 3d20 286c 656e 2869 6d67  g_dim = (len(img
-0001b250: 5f78 5f63 6f6f 7264 7329 2c20 7061 7468  _x_coords), path
-0001b260: 5f6c 656e 6774 6873 5f73 6f6c 6964 2e73  _lengths_solid.s
-0001b270: 6861 7065 5b31 5d29 0a20 2020 2020 2020  hape[1]).       
-0001b280: 2069 6e74 656e 7369 7469 6573 5f73 6f6c   intensities_sol
-0001b290: 6964 203d 204e 6f6e 650a 2020 2020 2020  id = None.      
-0001b2a0: 2020 696e 7465 6e73 6974 6965 735f 686f    intensities_ho
-0001b2b0: 6c6c 6f77 203d 204e 6f6e 650a 2020 2020  llow = None.    
-0001b2c0: 2020 2020 666f 7220 6e20 696e 2072 616e      for n in ran
-0001b2d0: 6765 286e 756d 5f74 6f6d 6f5f 7374 6163  ge(num_tomo_stac
-0001b2e0: 6b29 3a0a 2020 2020 2020 2020 2020 2020  k):.            
-0001b2f0: 7665 7274 6963 616c 5f73 6869 6674 732e  vertical_shifts.
-0001b300: 6170 7065 6e64 2869 6d67 5f78 5f6f 6666  append(img_x_off
-0001b310: 7365 7420 2b20 6e2a 736c 6974 5f73 697a  set + n*slit_siz
-0001b320: 6529 0a20 2020 2020 2020 2020 2020 2074  e).            t
-0001b330: 6f6d 6f5f 6669 656c 6420 3d20 6265 616d  omo_field = beam
-0001b340: 5f69 6e74 656e 7369 7479 202a 206e 702e  _intensity * np.
-0001b350: 6f6e 6573 2828 6e75 6d5f 7468 6574 612c  ones((num_theta,
-0001b360: 202a 696d 675f 6469 6d29 290a 2020 2020   *img_dim)).    
-0001b370: 2020 2020 2020 2020 6966 2073 616d 706c          if sampl
-0001b380: 655f 7479 7065 203d 3d20 2773 7175 6172  e_type == 'squar
-0001b390: 655f 726f 6427 3a0a 2020 2020 2020 2020  e_rod':.        
-0001b3a0: 2020 2020 2020 2020 696e 7465 6e73 6974          intensit
-0001b3b0: 6965 735f 736f 6c69 6420 3d20 5c0a 2020  ies_solid = \.  
-0001b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b3d0: 2020 6265 616d 5f69 6e74 656e 7369 7479    beam_intensity
-0001b3e0: 202a 206e 702e 6578 7028 2d6d 752a 7061   * np.exp(-mu*pa
-0001b3f0: 7468 5f6c 656e 6774 6873 5f73 6f6c 6964  th_lengths_solid
-0001b400: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001b410: 2020 666f 7220 6e20 696e 2072 616e 6765    for n in range
-0001b420: 286e 756d 5f74 6865 7461 293a 0a20 2020  (num_theta):.   
-0001b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b440: 2074 6f6d 6f5f 6669 656c 645b 6e2c 3a2c   tomo_field[n,:,
-0001b450: 3a5d 203d 2069 6e74 656e 7369 7469 6573  :] = intensities
-0001b460: 5f73 6f6c 6964 5b6e 5d0a 2020 2020 2020  _solid[n].      
-0001b470: 2020 2020 2020 656c 6966 2073 616d 706c        elif sampl
-0001b480: 655f 7479 7065 203d 3d20 2773 7175 6172  e_type == 'squar
-0001b490: 655f 7069 7065 273a 0a20 2020 2020 2020  e_pipe':.       
-0001b4a0: 2020 2020 2020 2020 2069 6e74 656e 7369           intensi
-0001b4b0: 7469 6573 5f68 6f6c 6c6f 7720 3d20 5c0a  ties_hollow = \.
-0001b4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b4d0: 2020 2020 6265 616d 5f69 6e74 656e 7369      beam_intensi
-0001b4e0: 7479 202a 206e 702e 6578 7028 2d6d 752a  ty * np.exp(-mu*
-0001b4f0: 7061 7468 5f6c 656e 6774 6873 5f68 6f6c  path_lengths_hol
-0001b500: 6c6f 7729 0a20 2020 2020 2020 2020 2020  low).           
-0001b510: 2020 2020 2066 6f72 206e 2069 6e20 7261       for n in ra
-0001b520: 6e67 6528 6e75 6d5f 7468 6574 6129 3a0a  nge(num_theta):.
-0001b530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b540: 2020 2020 746f 6d6f 5f66 6965 6c64 5b6e      tomo_field[n
-0001b550: 2c3a 2c3a 5d20 3d20 696e 7465 6e73 6974  ,:,:] = intensit
-0001b560: 6965 735f 686f 6c6c 6f77 5b6e 5d0a 2020  ies_hollow[n].  
-0001b570: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0001b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b590: 696e 7465 6e73 6974 6965 735f 736f 6c69  intensities_soli
-0001b5a0: 6420 3d20 5c0a 2020 2020 2020 2020 2020  d = \.          
-0001b5b0: 2020 2020 2020 2020 2020 6265 616d 5f69            beam_i
-0001b5c0: 6e74 656e 7369 7479 202a 206e 702e 6578  ntensity * np.ex
-0001b5d0: 7028 2d6d 752a 7061 7468 5f6c 656e 6774  p(-mu*path_lengt
-0001b5e0: 6873 5f73 6f6c 6964 290a 2020 2020 2020  hs_solid).      
-0001b5f0: 2020 2020 2020 2020 2020 696e 7465 6e73            intens
-0001b600: 6974 6965 735f 686f 6c6c 6f77 203d 205c  ities_hollow = \
-0001b610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b620: 2020 2020 2062 6561 6d5f 696e 7465 6e73       beam_intens
-0001b630: 6974 7920 2a20 6e70 2e65 7870 282d 6d75  ity * np.exp(-mu
-0001b640: 2a70 6174 685f 6c65 6e67 7468 735f 686f  *path_lengths_ho
-0001b650: 6c6c 6f77 290a 2020 2020 2020 2020 2020  llow).          
-0001b660: 2020 2020 2020 6f75 7465 725f 696e 6469        outer_indi
-0001b670: 6365 7320 3d20 5c0a 2020 2020 2020 2020  ces = \.        
-0001b680: 2020 2020 2020 2020 2020 2020 6e70 2e77              np.w
-0001b690: 6865 7265 2861 6273 2869 6d67 5f78 5f63  here(abs(img_x_c
-0001b6a0: 6f6f 7264 7329 203c 3d20 7361 6d70 6c65  oords) <= sample
-0001b6b0: 5f73 697a 655b 305d 2f32 295b 305d 0a20  _size[0]/2)[0]. 
-0001b6c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001b6d0: 6e6e 6572 5f69 6e64 6963 6573 203d 206e  nner_indices = n
-0001b6e0: 702e 7768 6572 6528 0a20 2020 2020 2020  p.where(.       
-0001b6f0: 2020 2020 2020 2020 2020 2020 2061 6273               abs
-0001b700: 2869 6d67 5f78 5f63 6f6f 7264 7329 203c  (img_x_coords) <
-0001b710: 2073 616d 706c 655f 7369 7a65 5b30 5d2f   sample_size[0]/
-0001b720: 3220 2d20 7761 6c6c 5f74 6869 636b 6e65  2 - wall_thickne
-0001b730: 7373 295b 305d 0a20 2020 2020 2020 2020  ss)[0].         
-0001b740: 2020 2020 2020 2077 616c 6c5f 696e 6469         wall_indi
-0001b750: 6365 7320 3d20 6c69 7374 2873 6574 286f  ces = list(set(o
-0001b760: 7574 6572 5f69 6e64 6963 6573 292d 7365  uter_indices)-se
-0001b770: 7428 696e 6e65 725f 696e 6469 6365 7329  t(inner_indices)
-0001b780: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001b790: 2020 666f 7220 6920 696e 2077 616c 6c5f    for i in wall_
-0001b7a0: 696e 6469 6365 733a 0a20 2020 2020 2020  indices:.       
-0001b7b0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0001b7c0: 206e 2069 6e20 7261 6e67 6528 6e75 6d5f   n in range(num_
-0001b7d0: 7468 6574 6129 3a0a 2020 2020 2020 2020  theta):.        
-0001b7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b7f0: 746f 6d6f 5f66 6965 6c64 5b6e 2c69 5d20  tomo_field[n,i] 
-0001b800: 3d20 696e 7465 6e73 6974 6965 735f 736f  = intensities_so
-0001b810: 6c69 645b 6e5d 0a20 2020 2020 2020 2020  lid[n].         
-0001b820: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-0001b830: 696e 6e65 725f 696e 6469 6365 733a 0a20  inner_indices:. 
-0001b840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b850: 2020 2066 6f72 206e 2069 6e20 7261 6e67     for n in rang
-0001b860: 6528 6e75 6d5f 7468 6574 6129 3a0a 2020  e(num_theta):.  
-0001b870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b880: 2020 2020 2020 746f 6d6f 5f66 6965 6c64        tomo_field
-0001b890: 5b6e 2c69 5d20 3d20 696e 7465 6e73 6974  [n,i] = intensit
-0001b8a0: 6965 735f 686f 6c6c 6f77 5b6e 5d0a 2020  ies_hollow[n].  
-0001b8b0: 2020 2020 2020 2020 2020 746f 6d6f 5f66            tomo_f
-0001b8c0: 6965 6c64 202b 3d20 6261 636b 6772 6f75  ield += backgrou
-0001b8d0: 6e64 5f69 6e74 656e 7369 7479 0a20 2020  nd_intensity.   
-0001b8e0: 2020 2020 2020 2020 2074 6f6d 6f5f 6669           tomo_fi
-0001b8f0: 656c 6473 5f73 7461 636b 2e61 7070 656e  elds_stack.appen
-0001b900: 6428 746f 6d6f 5f66 6965 6c64 2e61 7374  d(tomo_field.ast
-0001b910: 7970 6528 6e70 2e69 6e74 3634 2929 0a20  ype(np.int64)). 
-0001b920: 2020 2020 2020 2020 2020 2069 6620 6e75             if nu
-0001b930: 6d5f 746f 6d6f 5f73 7461 636b 203e 2031  m_tomo_stack > 1
-0001b940: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001b950: 2020 696d 675f 785f 636f 6f72 6473 202b    img_x_coords +
-0001b960: 3d20 736c 6974 5f73 697a 650a 2020 2020  = slit_size.    
-0001b970: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0001b980: 2023 2041 6464 2064 756d 6d79 2073 6e61   # Add dummy sna
-0001b990: 7073 686f 7473 2061 7420 6561 6368 2065  pshots at each e
-0001b9a0: 6e64 2074 6f20 6d69 6d69 6320 464d 422f  nd to mimic FMB/
-0001b9b0: 534d 420a 2020 2020 2020 2020 6966 2073  SMB.        if s
-0001b9c0: 7461 7469 6f6e 2069 6e20 2827 6964 3161  tation in ('id1a
-0001b9d0: 3327 2c20 2769 6433 6127 293a 0a20 2020  3', 'id3a'):.   
-0001b9e0: 2020 2020 2020 2020 206e 756d 5f74 6865           num_the
-0001b9f0: 7461 5f64 756d 6d79 5f73 7461 7274 203d  ta_dummy_start =
-0001ba00: 2035 0a20 2020 2020 2020 2020 2020 206e   5.            n
-0001ba10: 756d 5f74 6865 7461 5f64 756d 6d79 5f65  um_theta_dummy_e
-0001ba20: 6e64 203d 2030 0a20 2020 2020 2020 2065  nd = 0.        e
-0001ba30: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0001ba40: 206e 756d 5f74 6865 7461 5f64 756d 6d79   num_theta_dummy
-0001ba50: 5f73 7461 7274 203d 2031 0a20 2020 2020  _start = 1.     
-0001ba60: 2020 2020 2020 206e 756d 5f74 6865 7461         num_theta
-0001ba70: 5f64 756d 6d79 5f65 6e64 203d 2031 0a20  _dummy_end = 1. 
-0001ba80: 2020 2020 2020 2074 6865 7461 7320 3d20         thetas = 
-0001ba90: 5b74 6865 7461 5f73 7461 7274 2d6e 2a74  [theta_start-n*t
-0001baa0: 6865 7461 5f73 7465 700a 2020 2020 2020  heta_step.      
-0001bab0: 2020 2020 2020 666f 7220 6e20 696e 2072        for n in r
-0001bac0: 616e 6765 286e 756d 5f74 6865 7461 5f64  ange(num_theta_d
-0001bad0: 756d 6d79 5f73 7461 7274 2c20 302c 202d  ummy_start, 0, -
-0001bae0: 3129 5d20 2b20 7468 6574 6173 0a20 2020  1)] + thetas.   
-0001baf0: 2020 2020 2074 6865 7461 7320 2b3d 205b       thetas += [
-0001bb00: 7468 6574 615f 656e 642b 6e2a 7468 6574  theta_end+n*thet
-0001bb10: 615f 7374 6570 0a20 2020 2020 2020 2020  a_step.         
-0001bb20: 2020 2066 6f72 206e 2069 6e20 7261 6e67     for n in rang
-0001bb30: 6528 312c 206e 756d 5f74 6865 7461 5f64  e(1, num_theta_d
-0001bb40: 756d 6d79 5f65 6e64 2b31 295d 0a20 2020  ummy_end+1)].   
-0001bb50: 2020 2020 2069 6620 6e75 6d5f 7468 6574       if num_thet
-0001bb60: 615f 6475 6d6d 795f 7374 6172 743a 0a20  a_dummy_start:. 
-0001bb70: 2020 2020 2020 2020 2020 2064 756d 6d79             dummy
-0001bb80: 5f66 6965 6c64 7320 3d20 6261 636b 6772  _fields = backgr
-0001bb90: 6f75 6e64 5f69 6e74 656e 7369 7479 202a  ound_intensity *
-0001bba0: 206e 702e 6f6e 6573 280a 2020 2020 2020   np.ones(.      
-0001bbb0: 2020 2020 2020 2020 2020 286e 756d 5f74            (num_t
-0001bbc0: 6865 7461 5f64 756d 6d79 5f73 7461 7274  heta_dummy_start
-0001bbd0: 2c20 2a69 6d67 5f64 696d 292c 2064 7479  , *img_dim), dty
-0001bbe0: 7065 3d6e 702e 696e 7436 3429 0a20 2020  pe=np.int64).   
-0001bbf0: 2020 2020 2020 2020 2066 6f72 206e 2c20           for n, 
-0001bc00: 746f 6d6f 5f66 6965 6c64 2069 6e20 656e  tomo_field in en
-0001bc10: 756d 6572 6174 6528 746f 6d6f 5f66 6965  umerate(tomo_fie
-0001bc20: 6c64 735f 7374 6163 6b29 3a0a 2020 2020  lds_stack):.    
-0001bc30: 2020 2020 2020 2020 2020 2020 746f 6d6f              tomo
-0001bc40: 5f66 6965 6c64 735f 7374 6163 6b5b 6e5d  _fields_stack[n]
-0001bc50: 203d 206e 702e 636f 6e63 6174 656e 6174   = np.concatenat
-0001bc60: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-0001bc70: 2020 2020 2020 2028 6475 6d6d 795f 6669         (dummy_fi
-0001bc80: 656c 6473 2c20 746f 6d6f 5f66 6965 6c64  elds, tomo_field
-0001bc90: 2929 0a20 2020 2020 2020 2069 6620 6e75  )).        if nu
-0001bca0: 6d5f 7468 6574 615f 6475 6d6d 795f 656e  m_theta_dummy_en
-0001bcb0: 643a 0a20 2020 2020 2020 2020 2020 2064  d:.            d
-0001bcc0: 756d 6d79 5f66 6965 6c64 7320 3d20 6261  ummy_fields = ba
-0001bcd0: 636b 6772 6f75 6e64 5f69 6e74 656e 7369  ckground_intensi
-0001bce0: 7479 202a 206e 702e 6f6e 6573 280a 2020  ty * np.ones(.  
-0001bcf0: 2020 2020 2020 2020 2020 2020 2020 286e                (n
-0001bd00: 756d 5f74 6865 7461 5f64 756d 6d79 5f65  um_theta_dummy_e
-0001bd10: 6e64 2c20 2a69 6d67 5f64 696d 292c 2064  nd, *img_dim), d
-0001bd20: 7479 7065 3d6e 702e 696e 7436 3429 0a20  type=np.int64). 
-0001bd30: 2020 2020 2020 2020 2020 2066 6f72 206e             for n
-0001bd40: 2c20 746f 6d6f 5f66 6965 6c64 2069 6e20  , tomo_field in 
-0001bd50: 656e 756d 6572 6174 6528 746f 6d6f 5f66  enumerate(tomo_f
-0001bd60: 6965 6c64 735f 7374 6163 6b29 3a0a 2020  ields_stack):.  
-0001bd70: 2020 2020 2020 2020 2020 2020 2020 746f                to
-0001bd80: 6d6f 5f66 6965 6c64 735f 7374 6163 6b5b  mo_fields_stack[
-0001bd90: 6e5d 203d 206e 702e 636f 6e63 6174 656e  n] = np.concaten
-0001bda0: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
-0001bdb0: 2020 2020 2020 2020 2028 746f 6d6f 5f66           (tomo_f
-0001bdc0: 6965 6c64 2c20 6475 6d6d 795f 6669 656c  ield, dummy_fiel
-0001bdd0: 6473 2929 0a20 2020 2020 2020 2069 6620  ds)).        if 
-0001bde0: 6e75 6d5f 746f 6d6f 5f73 7461 636b 203d  num_tomo_stack =
-0001bdf0: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
-0001be00: 2074 6f6d 6f5f 6669 656c 6473 5f73 7461   tomo_fields_sta
-0001be10: 636b 203d 2074 6f6d 6f5f 6669 656c 6473  ck = tomo_fields
-0001be20: 5f73 7461 636b 5b30 5d0a 0a20 2020 2020  _stack[0]..     
-0001be30: 2020 2023 2043 7265 6174 6520 4e65 7875     # Create Nexu
-0001be40: 7320 6f62 6a65 6374 2061 6e64 2077 7269  s object and wri
-0001be50: 7465 2074 6f20 6669 6c65 0a20 2020 2020  te to file.     
-0001be60: 2020 206e 7872 6f6f 7420 3d20 4e58 726f     nxroot = NXro
-0001be70: 6f74 2829 0a20 2020 2020 2020 206e 7872  ot().        nxr
-0001be80: 6f6f 742e 656e 7472 7920 3d20 4e58 656e  oot.entry = NXen
-0001be90: 7472 7928 290a 2020 2020 2020 2020 6e78  try().        nx
-0001bea0: 726f 6f74 2e65 6e74 7279 2e73 616d 706c  root.entry.sampl
-0001beb0: 6520 3d20 4e58 7361 6d70 6c65 2829 0a20  e = NXsample(). 
-0001bec0: 2020 2020 2020 206e 7872 6f6f 742e 656e         nxroot.en
-0001bed0: 7472 792e 7361 6d70 6c65 2e73 616d 706c  try.sample.sampl
-0001bee0: 655f 7479 7065 203d 2073 616d 706c 655f  e_type = sample_
-0001bef0: 7479 7065 0a20 2020 2020 2020 206e 7872  type.        nxr
-0001bf00: 6f6f 742e 656e 7472 792e 7361 6d70 6c65  oot.entry.sample
-0001bf10: 2e73 616d 706c 655f 7369 7a65 203d 2073  .sample_size = s
-0001bf20: 616d 706c 655f 7369 7a65 0a20 2020 2020  ample_size.     
-0001bf30: 2020 2069 6620 7761 6c6c 5f74 6869 636b     if wall_thick
-0001bf40: 6e65 7373 2069 7320 6e6f 7420 4e6f 6e65  ness is not None
-0001bf50: 3a0a 2020 2020 2020 2020 2020 2020 6e78  :.            nx
-0001bf60: 726f 6f74 2e65 6e74 7279 2e73 616d 706c  root.entry.sampl
-0001bf70: 652e 7761 6c6c 5f74 6869 636b 6e65 7373  e.wall_thickness
-0001bf80: 203d 2077 616c 6c5f 7468 6963 6b6e 6573   = wall_thicknes
-0001bf90: 730a 2020 2020 2020 2020 6e78 726f 6f74  s.        nxroot
-0001bfa0: 2e65 6e74 7279 2e73 616d 706c 652e 6d75  .entry.sample.mu
-0001bfb0: 203d 206d 750a 2020 2020 2020 2020 6e78   = mu.        nx
-0001bfc0: 696e 7374 7275 6d65 6e74 203d 204e 5869  instrument = NXi
-0001bfd0: 6e73 7472 756d 656e 7428 290a 2020 2020  nstrument().    
-0001bfe0: 2020 2020 6e78 726f 6f74 2e65 6e74 7279      nxroot.entry
-0001bff0: 2e69 6e73 7472 756d 656e 7420 3d20 6e78  .instrument = nx
-0001c000: 696e 7374 7275 6d65 6e74 0a20 2020 2020  instrument.     
-0001c010: 2020 206e 7869 6e73 7472 756d 656e 742e     nxinstrument.
-0001c020: 736f 7572 6365 203d 204e 5873 6f75 7263  source = NXsourc
-0001c030: 6528 290a 2020 2020 2020 2020 6e78 696e  e().        nxin
-0001c040: 7374 7275 6d65 6e74 2e73 6f75 7263 652e  strument.source.
-0001c050: 6174 7472 735b 2773 7461 7469 6f6e 275d  attrs['station']
-0001c060: 203d 2073 7461 7469 6f6e 0a20 2020 2020   = station.     
-0001c070: 2020 206e 7869 6e73 7472 756d 656e 742e     nxinstrument.
-0001c080: 736f 7572 6365 2e74 7970 6520 3d20 2753  source.type = 'S
-0001c090: 796e 6368 726f 7472 6f6e 2058 2d72 6179  ynchrotron X-ray
-0001c0a0: 2053 6f75 7263 6527 0a20 2020 2020 2020   Source'.       
-0001c0b0: 206e 7869 6e73 7472 756d 656e 742e 736f   nxinstrument.so
-0001c0c0: 7572 6365 2e6e 616d 6520 3d20 2754 6f6d  urce.name = 'Tom
-0001c0d0: 6f67 7261 7068 7920 5369 6d75 6c61 746f  ography Simulato
-0001c0e0: 7227 0a20 2020 2020 2020 206e 7869 6e73  r'.        nxins
-0001c0f0: 7472 756d 656e 742e 736f 7572 6365 2e70  trument.source.p
-0001c100: 726f 6265 203d 2027 782d 7261 7927 0a20  robe = 'x-ray'. 
-0001c110: 2020 2020 2020 206e 7869 6e73 7472 756d         nxinstrum
-0001c120: 656e 742e 736f 7572 6365 2e62 6163 6b67  ent.source.backg
-0001c130: 726f 756e 645f 696e 7465 6e73 6974 7920  round_intensity 
-0001c140: 3d20 6261 636b 6772 6f75 6e64 5f69 6e74  = background_int
-0001c150: 656e 7369 7479 0a20 2020 2020 2020 206e  ensity.        n
-0001c160: 7869 6e73 7472 756d 656e 742e 736f 7572  xinstrument.sour
-0001c170: 6365 2e62 6561 6d5f 696e 7465 6e73 6974  ce.beam_intensit
-0001c180: 7920 3d20 6265 616d 5f69 6e74 656e 7369  y = beam_intensi
-0001c190: 7479 0a20 2020 2020 2020 206e 7869 6e73  ty.        nxins
-0001c1a0: 7472 756d 656e 742e 736f 7572 6365 2e73  trument.source.s
-0001c1b0: 6c69 745f 7369 7a65 203d 2073 6c69 745f  lit_size = slit_
-0001c1c0: 7369 7a65 0a20 2020 2020 2020 206e 7864  size.        nxd
-0001c1d0: 6574 6563 746f 7220 3d20 4e58 6465 7465  etector = NXdete
-0001c1e0: 6374 6f72 2829 0a20 2020 2020 2020 206e  ctor().        n
-0001c1f0: 7869 6e73 7472 756d 656e 742e 6465 7465  xinstrument.dete
-0001c200: 6374 6f72 203d 206e 7864 6574 6563 746f  ctor = nxdetecto
-0001c210: 720a 2020 2020 2020 2020 6e78 6465 7465  r.        nxdete
-0001c220: 6374 6f72 2e6c 6f63 616c 5f6e 616d 6520  ctor.local_name 
-0001c230: 3d20 636f 6e66 6967 2e64 6574 6563 746f  = config.detecto
-0001c240: 722e 7072 6566 6978 0a20 2020 2020 2020  r.prefix.       
-0001c250: 206e 7864 6574 6563 746f 722e 785f 7069   nxdetector.x_pi
-0001c260: 7865 6c5f 7369 7a65 203d 2070 6978 656c  xel_size = pixel
-0001c270: 5f73 697a 655b 305d 0a20 2020 2020 2020  _size[0].       
-0001c280: 206e 7864 6574 6563 746f 722e 795f 7069   nxdetector.y_pi
-0001c290: 7865 6c5f 7369 7a65 203d 2070 6978 656c  xel_size = pixel
-0001c2a0: 5f73 697a 655b 315d 0a20 2020 2020 2020  _size[1].       
-0001c2b0: 206e 7864 6574 6563 746f 722e 785f 7069   nxdetector.x_pi
-0001c2c0: 7865 6c5f 7369 7a65 2e61 7474 7273 5b27  xel_size.attrs['
-0001c2d0: 756e 6974 7327 5d20 3d20 276d 6d27 0a20  units'] = 'mm'. 
-0001c2e0: 2020 2020 2020 206e 7864 6574 6563 746f         nxdetecto
-0001c2f0: 722e 795f 7069 7865 6c5f 7369 7a65 2e61  r.y_pixel_size.a
-0001c300: 7474 7273 5b27 756e 6974 7327 5d20 3d20  ttrs['units'] = 
-0001c310: 276d 6d27 0a20 2020 2020 2020 206e 7864  'mm'.        nxd
-0001c320: 6574 6563 746f 722e 6461 7461 203d 2074  etector.data = t
-0001c330: 6f6d 6f5f 6669 656c 6473 5f73 7461 636b  omo_fields_stack
-0001c340: 0a20 2020 2020 2020 206e 7864 6574 6563  .        nxdetec
-0001c350: 746f 722e 7468 6574 6173 203d 2074 6865  tor.thetas = the
-0001c360: 7461 730a 2020 2020 2020 2020 6e78 6465  tas.        nxde
-0001c370: 7465 6374 6f72 2e7a 5f74 7261 6e73 6c61  tector.z_transla
-0001c380: 7469 6f6e 203d 2076 6572 7469 6361 6c5f  tion = vertical_
-0001c390: 7368 6966 7473 0a20 2020 2020 2020 206e  shifts.        n
-0001c3a0: 7864 6574 6563 746f 722e 6672 616d 655f  xdetector.frame_
-0001c3b0: 7374 6172 745f 6e75 6d62 6572 203d 206e  start_number = n
-0001c3c0: 756d 5f74 6865 7461 5f64 756d 6d79 5f73  um_theta_dummy_s
-0001c3d0: 7461 7274 0a23 2020 2020 2020 2020 6e78  tart.#        nx
-0001c3e0: 6465 7465 6374 6f72 2e70 6174 685f 6c65  detector.path_le
-0001c3f0: 6e67 7468 735f 736f 6c69 6420 3d20 7061  ngths_solid = pa
-0001c400: 7468 5f6c 656e 6774 6873 5f73 6f6c 6964  th_lengths_solid
-0001c410: 0a23 2020 2020 2020 2020 6e78 6465 7465  .#        nxdete
-0001c420: 6374 6f72 2e70 6174 685f 6c65 6e67 7468  ctor.path_length
-0001c430: 735f 686f 6c6c 6f77 203d 2070 6174 685f  s_hollow = path_
-0001c440: 6c65 6e67 7468 735f 686f 6c6c 6f77 0a23  lengths_hollow.#
-0001c450: 2020 2020 2020 2020 6e78 6465 7465 6374          nxdetect
-0001c460: 6f72 2e69 6e74 656e 7369 7469 6573 5f73  or.intensities_s
-0001c470: 6f6c 6964 203d 2069 6e74 656e 7369 7469  olid = intensiti
-0001c480: 6573 5f73 6f6c 6964 0a23 2020 2020 2020  es_solid.#      
-0001c490: 2020 6e78 6465 7465 6374 6f72 2e69 6e74    nxdetector.int
-0001c4a0: 656e 7369 7469 6573 5f68 6f6c 6c6f 7720  ensities_hollow 
-0001c4b0: 3d20 696e 7465 6e73 6974 6965 735f 686f  = intensities_ho
-0001c4c0: 6c6c 6f77 0a0a 2020 2020 2020 2020 7265  llow..        re
-0001c4d0: 7475 726e 206e 7872 6f6f 740a 0a20 2020  turn nxroot..   
-0001c4e0: 2064 6566 2067 6574 5f63 6f6e 6669 6773   def get_configs
-0001c4f0: 2873 656c 662c 2064 6174 6129 3a0a 2020  (self, data):.  
-0001c500: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0001c510: 2020 4765 7420 696e 7374 616e 6365 7320    Get instances 
-0001c520: 6f66 2074 6865 2063 6f6e 6669 6775 7261  of the configura
-0001c530: 7469 6f6e 206f 626a 6563 7473 206e 6565  tion objects nee
-0001c540: 6465 6420 6279 2074 6869 730a 2020 2020  ded by this.    
-0001c550: 2020 2020 6050 726f 6365 7373 6f72 6020      `Processor` 
-0001c560: 6672 6f6d 2061 2072 6574 7572 6e65 6420  from a returned 
-0001c570: 7661 6c75 6520 6f66 2060 5265 6164 6572  value of `Reader
-0001c580: 2e72 6561 6460 0a0a 2020 2020 2020 2020  .read`..        
-0001c590: 3a70 6172 616d 2064 6174 613a 2052 6573  :param data: Res
-0001c5a0: 756c 7420 6f66 2060 5265 6164 6572 2e72  ult of `Reader.r
-0001c5b0: 6561 6460 2077 6865 7265 2061 7420 6c65  ead` where at le
-0001c5c0: 6173 7420 6f6e 6520 6974 656d 0a20 2020  ast one item.   
-0001c5d0: 2020 2020 2020 2020 2068 6173 2060 2754           has `'T
-0001c5e0: 6f6d 6f52 6564 7563 6543 6f6e 6669 6727  omoReduceConfig'
-0001c5f0: 6020 666f 7220 7468 6520 6027 7363 6865  ` for the `'sche
-0001c600: 6d61 2760 206b 6579 2c20 616e 6420 6174  ma'` key, and at
-0001c610: 0a20 2020 2020 2020 2020 2020 206c 6561  .            lea
-0001c620: 7374 206f 6e65 2069 7465 6d20 6861 7320  st one item has 
-0001c630: 6027 546f 6d6f 5369 6d43 6f6e 6669 6727  `'TomoSimConfig'
-0001c640: 6020 666f 7220 7468 6520 6027 7363 6865  ` for the `'sche
-0001c650: 6d61 2760 206b 6579 2e0a 2020 2020 2020  ma'` key..      
-0001c660: 2020 3a74 7970 6520 6461 7461 3a20 6c69    :type data: li
-0001c670: 7374 5b64 6963 745b 7374 722c 6f62 6a65  st[dict[str,obje
-0001c680: 6374 5d5d 0a20 2020 2020 2020 203a 7261  ct]].        :ra
-0001c690: 6973 6573 2045 7863 6570 7469 6f6e 3a20  ises Exception: 
-0001c6a0: 4966 2076 616c 6964 2063 6f6e 6669 6720  If valid config 
-0001c6b0: 6f62 6a65 6374 7320 6361 6e6e 6f74 2062  objects cannot b
-0001c6c0: 6520 636f 6e73 7472 7563 7465 640a 2020  e constructed.  
-0001c6d0: 2020 2020 2020 2020 2020 6672 6f6d 2060            from `
-0001c6e0: 6461 7461 602e 0a20 2020 2020 2020 203a  data`..        :
-0001c6f0: 7265 7475 726e 3a20 7661 6c69 6420 696e  return: valid in
-0001c700: 7374 616e 6365 206f 6620 7468 6520 636f  stance of the co
-0001c710: 6e66 6967 7572 6174 696f 6e20 6f62 6a65  nfiguration obje
-0001c720: 6374 2077 6974 6820 6669 656c 640a 2020  ct with field.  
-0001c730: 2020 2020 2020 2020 2020 7661 6c75 6573            values
-0001c740: 2074 616b 656e 2066 726f 6d20 6064 6174   taken from `dat
-0001c750: 6160 2e0a 2020 2020 2020 2020 3a72 7479  a`..        :rty
-0001c760: 7065 3a20 546f 6d6f 5369 6d43 6f6e 6669  pe: TomoSimConfi
-0001c770: 670a 2020 2020 2020 2020 2222 220a 2020  g.        """.  
-0001c780: 2020 2020 2020 2320 4c6f 6361 6c20 6d6f        # Local mo
-0001c790: 6475 6c65 730a 2020 2020 2020 2020 6672  dules.        fr
-0001c7a0: 6f6d 2043 4841 502e 746f 6d6f 2e6d 6f64  om CHAP.tomo.mod
-0001c7b0: 656c 7320 696d 706f 7274 2054 6f6d 6f53  els import TomoS
-0001c7c0: 696d 436f 6e66 6967 0a0a 2020 2020 2020  imConfig..      
-0001c7d0: 2020 746f 6d6f 5f73 696d 5f64 6174 6120    tomo_sim_data 
-0001c7e0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2069  = None.        i
-0001c7f0: 6620 6973 696e 7374 616e 6365 2864 6174  f isinstance(dat
-0001c800: 612c 206c 6973 7429 3a0a 2020 2020 2020  a, list):.      
-0001c810: 2020 2020 2020 666f 7220 6974 656d 2069        for item i
-0001c820: 6e20 6461 7461 3a0a 2020 2020 2020 2020  n data:.        
-0001c830: 2020 2020 2020 2020 6966 2028 6973 696e          if (isin
-0001c840: 7374 616e 6365 2869 7465 6d2c 2064 6963  stance(item, dic
-0001c850: 7429 2061 6e64 2069 7465 6d2e 6765 7428  t) and item.get(
-0001c860: 2764 6174 6127 2920 6973 206e 6f74 204e  'data') is not N
-0001c870: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-0001c880: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-0001c890: 6974 656d 2e67 6574 2827 7363 6865 6d61  item.get('schema
-0001c8a0: 2729 203d 3d20 2754 6f6d 6f53 696d 436f  ') == 'TomoSimCo
-0001c8b0: 6e66 6967 2729 3a0a 2020 2020 2020 2020  nfig'):.        
-0001c8c0: 2020 2020 2020 2020 2020 2020 746f 6d6f              tomo
-0001c8d0: 5f73 696d 5f64 6174 6120 3d20 6974 656d  _sim_data = item
-0001c8e0: 2e67 6574 2827 6461 7461 2729 0a20 2020  .get('data').   
-0001c8f0: 2020 2020 2069 6620 746f 6d6f 5f73 696d       if tomo_sim
-0001c900: 5f64 6174 6120 6973 204e 6f6e 653a 0a20  _data is None:. 
-0001c910: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0001c920: 2056 616c 7565 4572 726f 7228 6627 496e   ValueError(f'In
-0001c930: 7661 6c69 6420 7061 7261 6d65 7465 7220  valid parameter 
-0001c940: 6461 7461 2028 7b64 6174 617d 2927 290a  data ({data})').
-0001c950: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001c960: 546f 6d6f 5369 6d43 6f6e 6669 6728 2a2a  TomoSimConfig(**
-0001c970: 746f 6d6f 5f73 696d 5f64 6174 6129 0a0a  tomo_sim_data)..
-0001c980: 2020 2020 6465 6620 5f63 7265 6174 655f      def _create_
-0001c990: 7061 7468 6c65 6e67 7468 5f73 6f6c 6964  pathlength_solid
-0001c9a0: 5f73 7175 6172 6528 7365 6c66 2c20 6469  _square(self, di
-0001c9b0: 6d2c 2074 6865 7461 732c 2070 6978 656c  m, thetas, pixel
-0001c9c0: 5f73 697a 652c 0a20 2020 2020 2020 2020  _size,.         
-0001c9d0: 2020 2064 6574 6563 746f 725f 7369 7a65     detector_size
-0001c9e0: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-0001c9f0: 2020 2020 2020 2043 7265 6174 6520 7468         Create th
-0001ca00: 6520 782d 7261 7920 7061 7468 206c 656e  e x-ray path len
-0001ca10: 6774 6820 7468 726f 7567 6820 6120 736f  gth through a so
-0001ca20: 6c69 6420 7371 7561 7265 0a20 2020 2020  lid square.     
-0001ca30: 2020 2063 726f 7373 7365 6374 696f 6e20     crosssection 
-0001ca40: 666f 7220 6120 7365 7420 6f66 2072 6f74  for a set of rot
-0001ca50: 6174 696f 6e20 616e 676c 6573 2e0a 2020  ation angles..  
-0001ca60: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
-0001ca70: 2020 2023 2047 6574 2074 6865 2063 6f6c     # Get the col
-0001ca80: 756d 6e20 636f 6f72 6469 6e61 7465 730a  umn coordinates.
-0001ca90: 2020 2020 2020 2020 696d 675f 795f 636f          img_y_co
-0001caa0: 6f72 6473 203d 2070 6978 656c 5f73 697a  ords = pixel_siz
-0001cab0: 6520 2a20 2830 2e35 202a 2028 3120 2d20  e * (0.5 * (1 - 
-0001cac0: 6465 7465 6374 6f72 5f73 697a 6525 3229  detector_size%2)
-0001cad0: 0a20 2020 2020 2020 2020 2020 202b 206e  .            + n
-0001cae0: 702e 6173 6172 7261 7928 7261 6e67 6528  p.asarray(range(
-0001caf0: 696e 7428 302e 3520 2a20 2864 6574 6563  int(0.5 * (detec
-0001cb00: 746f 725f 7369 7a65 2b31 2929 2929 290a  tor_size+1))))).
-0001cb10: 0a20 2020 2020 2020 2023 2047 6574 2074  .        # Get t
-0001cb20: 6865 2070 6174 6820 6c65 6e67 6874 7320  he path lenghts 
-0001cb30: 666f 7220 706f 7369 7469 6f6e 2063 6f6c  for position col
-0001cb40: 756d 6e20 636f 6f72 6469 6e61 7465 730a  umn coordinates.
-0001cb50: 2020 2020 2020 2020 6c65 6e67 7468 7320          lengths 
-0001cb60: 3d20 6e70 2e7a 6572 6f73 2828 6c65 6e28  = np.zeros((len(
-0001cb70: 7468 6574 6173 292c 206c 656e 2869 6d67  thetas), len(img
-0001cb80: 5f79 5f63 6f6f 7264 7329 292c 2064 7479  _y_coords)), dty
-0001cb90: 7065 3d6e 702e 666c 6f61 7436 3429 0a20  pe=np.float64). 
-0001cba0: 2020 2020 2020 2066 6f72 2069 2c20 7468         for i, th
-0001cbb0: 6574 6120 696e 2065 6e75 6d65 7261 7465  eta in enumerate
-0001cbc0: 2874 6865 7461 7329 3a0a 2020 2020 2020  (thetas):.      
-0001cbd0: 2020 2020 2020 6475 6d6d 7920 3d20 7468        dummy = th
-0001cbe0: 6574 610a 2020 2020 2020 2020 2020 2020  eta.            
-0001cbf0: 7468 6574 6120 3d20 7468 6574 6120 2d20  theta = theta - 
-0001cc00: 3930 2e2a 6e70 2e66 6c6f 6f72 2874 6865  90.*np.floor(the
-0001cc10: 7461 2f39 302e 290a 2020 2020 2020 2020  ta/90.).        
-0001cc20: 2020 2020 6966 2034 352e 203c 2074 6865      if 45. < the
-0001cc30: 7461 203c 3d20 3930 2e3a 0a20 2020 2020  ta <= 90.:.     
-0001cc40: 2020 2020 2020 2020 2020 2074 6865 7461             theta
-0001cc50: 203d 2039 302e 2d74 6865 7461 0a20 2020   = 90.-theta.   
-0001cc60: 2020 2020 2020 2020 2074 6865 7461 5f72           theta_r
-0001cc70: 6164 203d 2074 6865 7461 2a6e 702e 7069  ad = theta*np.pi
-0001cc80: 2f31 3830 2e0a 2020 2020 2020 2020 2020  /180..          
-0001cc90: 2020 6c65 6e5f 6162 203d 2064 696d 2f6e    len_ab = dim/n
-0001cca0: 702e 636f 7328 7468 6574 615f 7261 6429  p.cos(theta_rad)
-0001ccb0: 0a20 2020 2020 2020 2020 2020 206c 656e  .            len
-0001ccc0: 5f6f 6320 3d20 6469 6d2a 6e70 2e63 6f73  _oc = dim*np.cos
-0001ccd0: 2874 6865 7461 5f72 6164 2b30 2e32 352a  (theta_rad+0.25*
-0001cce0: 6e70 2e70 6929 2f6e 702e 7371 7274 2832  np.pi)/np.sqrt(2
-0001ccf0: 2e29 0a20 2020 2020 2020 2020 2020 206c  .).            l
-0001cd00: 656e 5f63 6520 3d20 6469 6d2a 6e70 2e73  en_ce = dim*np.s
-0001cd10: 696e 2874 6865 7461 5f72 6164 290a 2020  in(theta_rad).  
-0001cd20: 2020 2020 2020 2020 2020 696e 6465 7831            index1
-0001cd30: 203d 2069 6e74 286e 702e 6172 676d 696e   = int(np.argmin
-0001cd40: 286e 702e 6162 7328 696d 675f 795f 636f  (np.abs(img_y_co
-0001cd50: 6f72 6473 2d6c 656e 5f6f 6329 2929 0a20  ords-len_oc))). 
-0001cd60: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-0001cd70: 6e5f 6f63 203c 2069 6d67 5f79 5f63 6f6f  n_oc < img_y_coo
-0001cd80: 7264 735b 696e 6465 7831 5d20 616e 6420  rds[index1] and 
-0001cd90: 696e 6465 7831 203e 2030 3a0a 2020 2020  index1 > 0:.    
-0001cda0: 2020 2020 2020 2020 2020 2020 696e 6465              inde
-0001cdb0: 7831 202d 3d20 310a 2020 2020 2020 2020  x1 -= 1.        
-0001cdc0: 2020 2020 696e 6465 7832 203d 2069 6e74      index2 = int
-0001cdd0: 286e 702e 6172 676d 696e 286e 702e 6162  (np.argmin(np.ab
-0001cde0: 7328 696d 675f 795f 636f 6f72 6473 2d6c  s(img_y_coords-l
-0001cdf0: 656e 5f6f 632d 6c65 6e5f 6365 2929 290a  en_oc-len_ce))).
-0001ce00: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-0001ce10: 656e 5f6f 632b 6c65 6e5f 6365 203c 2069  en_oc+len_ce < i
-0001ce20: 6d67 5f79 5f63 6f6f 7264 735b 696e 6465  mg_y_coords[inde
-0001ce30: 7832 5d3a 0a20 2020 2020 2020 2020 2020  x2]:.           
-0001ce40: 2020 2020 2069 6e64 6578 3220 2d3d 2031       index2 -= 1
-0001ce50: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
-0001ce60: 6578 3120 2b3d 2031 0a20 2020 2020 2020  ex1 += 1.       
-0001ce70: 2020 2020 2069 6e64 6578 3220 2b3d 2031       index2 += 1
-0001ce80: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0001ce90: 206a 2069 6e20 7261 6e67 6528 696e 6465   j in range(inde
-0001cea0: 7831 293a 0a20 2020 2020 2020 2020 2020  x1):.           
-0001ceb0: 2020 2020 206c 656e 6774 6873 5b69 2c6a       lengths[i,j
-0001cec0: 5d20 3d20 6c65 6e5f 6162 0a20 2020 2020  ] = len_ab.     
-0001ced0: 2020 2020 2020 2066 6f72 206a 2c20 636f         for j, co
-0001cee0: 6c75 6d6e 2069 6e20 656e 756d 6572 6174  lumn in enumerat
-0001cef0: 6528 696d 675f 795f 636f 6f72 6473 5b69  e(img_y_coords[i
-0001cf00: 6e64 6578 313a 696e 6465 7832 5d29 3a0a  ndex1:index2]):.
-0001cf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cf20: 6c65 6e67 7468 735b 692c 6a2b 696e 6465  lengths[i,j+inde
-0001cf30: 7831 5d20 3d20 6c65 6e5f 6162 2a28 6c65  x1] = len_ab*(le
-0001cf40: 6e5f 6f63 2b6c 656e 5f63 652d 636f 6c75  n_oc+len_ce-colu
-0001cf50: 6d6e 292f 6c65 6e5f 6365 0a0a 2020 2020  mn)/len_ce..    
-0001cf60: 2020 2020 2320 4164 6420 7468 6520 6d69      # Add the mi
-0001cf70: 7272 6f72 2069 6d61 6765 2066 6f72 206e  rror image for n
-0001cf80: 6567 6174 6976 6520 636f 6c75 6d6e 2063  egative column c
-0001cf90: 6f6f 7264 696e 6174 6573 0a20 2020 2020  oordinates.     
-0001cfa0: 2020 2069 6620 6c65 6e28 696d 675f 795f     if len(img_y_
-0001cfb0: 636f 6f72 6473 2925 323a 0a20 2020 2020  coords)%2:.     
-0001cfc0: 2020 2020 2020 206c 656e 6774 6873 203d         lengths =
-0001cfd0: 206e 702e 636f 6e63 6174 656e 6174 6528   np.concatenate(
-0001cfe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cff0: 2028 6e70 2e66 6c69 706c 7228 6c65 6e67   (np.fliplr(leng
-0001d000: 7468 735b 3a2c 313a 5d29 2c20 6c65 6e67  ths[:,1:]), leng
-0001d010: 7468 7329 2c20 6178 6973 3d31 290a 2020  ths), axis=1).  
-0001d020: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001d030: 2020 2020 2020 2020 6c65 6e67 7468 7320          lengths 
-0001d040: 3d20 6e70 2e63 6f6e 6361 7465 6e61 7465  = np.concatenate
-0001d050: 2828 6e70 2e66 6c69 706c 7228 6c65 6e67  ((np.fliplr(leng
-0001d060: 7468 7329 2c20 6c65 6e67 7468 7329 2c20  ths), lengths), 
-0001d070: 6178 6973 3d31 290a 0a20 2020 2020 2020  axis=1)..       
-0001d080: 2072 6574 7572 6e20 6c65 6e67 7468 730a   return lengths.
-0001d090: 0a0a 636c 6173 7320 546f 6d6f 4461 726b  ..class TomoDark
-0001d0a0: 4669 656c 6450 726f 6365 7373 6f72 2850  FieldProcessor(P
-0001d0b0: 726f 6365 7373 6f72 293a 0a20 2020 2022  rocessor):.    "
-0001d0c0: 2222 0a20 2020 2043 6c61 7373 2072 6570  "".    Class rep
-0001d0d0: 7265 7365 6e74 696e 6720 7468 6520 7072  resenting the pr
-0001d0e0: 6f63 6573 7320 746f 2063 7265 6174 6520  ocess to create 
-0001d0f0: 6120 6461 726b 2066 6965 6c64 2061 7373  a dark field ass
-0001d100: 6f63 6961 7465 640a 2020 2020 7769 7468  ociated.    with
-0001d110: 2061 2073 696d 756c 6174 6564 2074 6f6d   a simulated tom
-0001d120: 6f67 7261 7068 7920 6461 7461 2073 6574  ography data set
-0001d130: 2063 7265 6174 6564 2062 7920 546f 6d6f   created by Tomo
-0001d140: 5369 6d50 726f 6365 7373 6f72 0a20 2020  SimProcessor.   
-0001d150: 2072 6574 7572 6e69 6e67 2061 2060 6e65   returning a `ne
-0001d160: 7875 7366 6f72 6d61 742e 6e65 7875 732e  xusformat.nexus.
-0001d170: 4e58 726f 6f74 6020 6f62 6a65 6374 2063  NXroot` object c
-0001d180: 6f6e 7461 696e 696e 6720 7468 650a 2020  ontaining the.  
-0001d190: 2020 6461 726b 2066 6965 6c64 2074 6f6d    dark field tom
-0001d1a0: 6f67 7261 7068 7920 6465 7465 6374 6f72  ography detector
-0001d1b0: 2069 6d61 6765 732e 0a20 2020 2022 2222   images..    """
-0001d1c0: 0a0a 2020 2020 6465 6620 7072 6f63 6573  ..    def proces
-0001d1d0: 7328 7365 6c66 2c20 6461 7461 2c20 6e75  s(self, data, nu
-0001d1e0: 6d5f 696d 6167 653d 352c 202a 2a6b 7761  m_image=5, **kwa
-0001d1f0: 7267 7329 3a0a 2020 2020 2020 2020 2320  rgs):.        # 
-0001d200: 5468 6972 6420 7061 7274 7920 6d6f 6475  Third party modu
-0001d210: 6c65 730a 2020 2020 2020 2020 6672 6f6d  les.        from
-0001d220: 206e 6578 7573 666f 726d 6174 2e6e 6578   nexusformat.nex
-0001d230: 7573 2069 6d70 6f72 7420 280a 2020 2020  us import (.    
-0001d240: 2020 2020 2020 2020 4e58 726f 6f74 2c0a          NXroot,.
-0001d250: 2020 2020 2020 2020 2020 2020 4e58 656e              NXen
-0001d260: 7472 792c 0a20 2020 2020 2020 2020 2020  try,.           
-0001d270: 204e 5869 6e73 7472 756d 656e 742c 0a20   NXinstrument,. 
-0001d280: 2020 2020 2020 2020 2020 204e 5864 6574             NXdet
-0001d290: 6563 746f 722c 0a20 2020 2020 2020 2029  ector,.        )
-0001d2a0: 0a0a 2020 2020 2020 2020 2320 4765 7420  ..        # Get 
-0001d2b0: 7468 6520 546f 6d6f 5369 6d46 6965 6c64  the TomoSimField
-0001d2c0: 2063 6f6e 6669 6775 7261 7469 6f6e 206f   configuration o
-0001d2d0: 626a 6563 7420 696e 2064 6174 610a 2020  bject in data.  
-0001d2e0: 2020 2020 2020 6e78 726f 6f74 203d 2073        nxroot = s
-0001d2f0: 656c 662e 6765 745f 636f 6e66 6967 2864  elf.get_config(d
-0001d300: 6174 6129 0a20 2020 2020 2020 2073 6f75  ata).        sou
-0001d310: 7263 6520 3d20 6e78 726f 6f74 2e65 6e74  rce = nxroot.ent
-0001d320: 7279 2e69 6e73 7472 756d 656e 742e 736f  ry.instrument.so
-0001d330: 7572 6365 0a20 2020 2020 2020 2064 6574  urce.        det
-0001d340: 6563 746f 7220 3d20 6e78 726f 6f74 2e65  ector = nxroot.e
-0001d350: 6e74 7279 2e69 6e73 7472 756d 656e 742e  ntry.instrument.
-0001d360: 6465 7465 6374 6f72 0a20 2020 2020 2020  detector.       
-0001d370: 2062 6163 6b67 726f 756e 645f 696e 7465   background_inte
-0001d380: 6e73 6974 7920 3d20 736f 7572 6365 2e62  nsity = source.b
-0001d390: 6163 6b67 726f 756e 645f 696e 7465 6e73  ackground_intens
-0001d3a0: 6974 790a 2020 2020 2020 2020 6465 7465  ity.        dete
-0001d3b0: 6374 6f72 5f73 697a 6520 3d20 6465 7465  ctor_size = dete
-0001d3c0: 6374 6f72 2e64 6174 612e 7368 6170 655b  ctor.data.shape[
-0001d3d0: 2d32 3a5d 0a0a 2020 2020 2020 2020 2320  -2:]..        # 
-0001d3e0: 4164 6420 6475 6d6d 7920 736e 6170 7368  Add dummy snapsh
-0001d3f0: 6f74 7320 6174 2073 7461 7274 2074 6f20  ots at start to 
-0001d400: 6d69 6d69 6320 534d 420a 2020 2020 2020  mimic SMB.      
-0001d410: 2020 6966 2073 6f75 7263 652e 7374 6174    if source.stat
-0001d420: 696f 6e20 696e 2028 2769 6431 6133 272c  ion in ('id1a3',
-0001d430: 2027 6964 3361 2729 3a0a 2020 2020 2020   'id3a'):.      
-0001d440: 2020 2020 2020 6e75 6d5f 7468 6574 615f        num_theta_
-0001d450: 6475 6d6d 795f 7374 6172 7420 3d20 350a  dummy_start = 5.
-0001d460: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001d470: 2020 2020 2020 2020 2020 6e75 6d5f 7468            num_th
-0001d480: 6574 615f 6475 6d6d 795f 7374 6172 7420  eta_dummy_start 
-0001d490: 3d20 300a 2020 2020 2020 2020 6e75 6d5f  = 0.        num_
-0001d4a0: 696d 6167 6520 2b3d 206e 756d 5f74 6865  image += num_the
-0001d4b0: 7461 5f64 756d 6d79 5f73 7461 7274 0a0a  ta_dummy_start..
-0001d4c0: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-0001d4d0: 2074 6865 2064 6172 6b20 6669 656c 640a   the dark field.
-0001d4e0: 2020 2020 2020 2020 6461 726b 5f66 6965          dark_fie
-0001d4f0: 6c64 203d 2069 6e74 2862 6163 6b67 726f  ld = int(backgro
-0001d500: 756e 645f 696e 7465 6e73 6974 7929 202a  und_intensity) *
-0001d510: 206e 702e 6f6e 6573 280a 2020 2020 2020   np.ones(.      
-0001d520: 2020 2020 2020 286e 756d 5f69 6d61 6765        (num_image
-0001d530: 2c20 6465 7465 6374 6f72 5f73 697a 655b  , detector_size[
-0001d540: 305d 2c20 6465 7465 6374 6f72 5f73 697a  0], detector_siz
-0001d550: 655b 315d 292c 2064 7479 7065 3d6e 702e  e[1]), dtype=np.
-0001d560: 696e 7436 3429 0a0a 2020 2020 2020 2020  int64)..        
-0001d570: 2320 4372 6561 7465 204e 6578 7573 206f  # Create Nexus o
-0001d580: 626a 6563 7420 616e 6420 7772 6974 6520  bject and write 
-0001d590: 746f 2066 696c 650a 2020 2020 2020 2020  to file.        
-0001d5a0: 6e78 6461 726b 203d 204e 5872 6f6f 7428  nxdark = NXroot(
-0001d5b0: 290a 2020 2020 2020 2020 6e78 6461 726b  ).        nxdark
-0001d5c0: 2e65 6e74 7279 203d 204e 5865 6e74 7279  .entry = NXentry
-0001d5d0: 2829 0a20 2020 2020 2020 206e 7864 6172  ().        nxdar
-0001d5e0: 6b2e 656e 7472 792e 7361 6d70 6c65 203d  k.entry.sample =
-0001d5f0: 206e 7872 6f6f 742e 656e 7472 792e 7361   nxroot.entry.sa
-0001d600: 6d70 6c65 0a20 2020 2020 2020 206e 7869  mple.        nxi
-0001d610: 6e73 7472 756d 656e 7420 3d20 4e58 696e  nstrument = NXin
-0001d620: 7374 7275 6d65 6e74 2829 0a20 2020 2020  strument().     
-0001d630: 2020 206e 7864 6172 6b2e 656e 7472 792e     nxdark.entry.
-0001d640: 696e 7374 7275 6d65 6e74 203d 206e 7869  instrument = nxi
-0001d650: 6e73 7472 756d 656e 740a 2020 2020 2020  nstrument.      
-0001d660: 2020 6e78 696e 7374 7275 6d65 6e74 2e73    nxinstrument.s
-0001d670: 6f75 7263 6520 3d20 6e78 726f 6f74 2e65  ource = nxroot.e
-0001d680: 6e74 7279 2e69 6e73 7472 756d 656e 742e  ntry.instrument.
-0001d690: 736f 7572 6365 0a20 2020 2020 2020 206e  source.        n
-0001d6a0: 7864 6574 6563 746f 7220 3d20 4e58 6465  xdetector = NXde
-0001d6b0: 7465 6374 6f72 2829 0a20 2020 2020 2020  tector().       
-0001d6c0: 206e 7869 6e73 7472 756d 656e 742e 6465   nxinstrument.de
-0001d6d0: 7465 6374 6f72 203d 206e 7864 6574 6563  tector = nxdetec
-0001d6e0: 746f 720a 2020 2020 2020 2020 6e78 6465  tor.        nxde
-0001d6f0: 7465 6374 6f72 2e6c 6f63 616c 5f6e 616d  tector.local_nam
-0001d700: 6520 3d20 6465 7465 6374 6f72 2e6c 6f63  e = detector.loc
-0001d710: 616c 5f6e 616d 650a 2020 2020 2020 2020  al_name.        
-0001d720: 6e78 6465 7465 6374 6f72 2e78 5f70 6978  nxdetector.x_pix
-0001d730: 656c 5f73 697a 6520 3d20 6465 7465 6374  el_size = detect
-0001d740: 6f72 2e78 5f70 6978 656c 5f73 697a 650a  or.x_pixel_size.
-0001d750: 2020 2020 2020 2020 6e78 6465 7465 6374          nxdetect
-0001d760: 6f72 2e79 5f70 6978 656c 5f73 697a 6520  or.y_pixel_size 
-0001d770: 3d20 6465 7465 6374 6f72 2e79 5f70 6978  = detector.y_pix
-0001d780: 656c 5f73 697a 650a 2020 2020 2020 2020  el_size.        
-0001d790: 6e78 6465 7465 6374 6f72 2e64 6174 6120  nxdetector.data 
-0001d7a0: 3d20 6461 726b 5f66 6965 6c64 0a20 2020  = dark_field.   
-0001d7b0: 2020 2020 206e 7864 6574 6563 746f 722e       nxdetector.
-0001d7c0: 7468 6574 6173 203d 206e 702e 6173 6172  thetas = np.asar
-0001d7d0: 7261 7928 6e75 6d5f 696d 6167 652a 5b30  ray(num_image*[0
-0001d7e0: 5d29 0a20 2020 2020 2020 206e 7864 6574  ]).        nxdet
-0001d7f0: 6563 746f 722e 6672 616d 655f 7374 6172  ector.frame_star
-0001d800: 745f 6e75 6d62 6572 203d 206e 756d 5f74  t_number = num_t
-0001d810: 6865 7461 5f64 756d 6d79 5f73 7461 7274  heta_dummy_start
-0001d820: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0001d830: 206e 7864 6172 6b0a 0a20 2020 2064 6566   nxdark..    def
-0001d840: 2067 6574 5f63 6f6e 6669 6728 7365 6c66   get_config(self
-0001d850: 2c20 6461 7461 293a 0a20 2020 2020 2020  , data):.       
-0001d860: 2022 2222 4765 7420 616e 2069 6e73 7461   """Get an insta
-0001d870: 6e63 6520 6f66 2074 6865 2063 6f6e 6669  nce of the confi
-0001d880: 6775 7261 7469 6f6e 206f 626a 6563 7420  guration object 
-0001d890: 6e65 6564 6564 2062 7920 7468 6973 0a20  needed by this. 
-0001d8a0: 2020 2020 2020 2060 5072 6f63 6573 736f         `Processo
-0001d8b0: 7260 2066 726f 6d20 6120 7265 7475 726e  r` from a return
-0001d8c0: 6564 2076 616c 7565 206f 6620 6052 6561  ed value of `Rea
-0001d8d0: 6465 722e 7265 6164 600a 0a20 2020 2020  der.read`..     
-0001d8e0: 2020 203a 7061 7261 6d20 6461 7461 3a20     :param data: 
-0001d8f0: 5265 7375 6c74 206f 6620 6052 6561 6465  Result of `Reade
-0001d900: 722e 7265 6164 6020 7768 6572 6520 6174  r.read` where at
-0001d910: 206c 6561 7374 206f 6e65 2069 7465 6d0a   least one item.
-0001d920: 2020 2020 2020 2020 2020 2020 6861 7320              has 
-0001d930: 7468 6520 7661 6c75 6520 6027 546f 6d6f  the value `'Tomo
-0001d940: 5369 6d46 6965 6c64 2760 2066 6f72 2074  SimField'` for t
-0001d950: 6865 2060 2773 6368 656d 6127 6020 6b65  he `'schema'` ke
-0001d960: 792e 0a20 2020 2020 2020 203a 7479 7065  y..        :type
-0001d970: 2064 6174 613a 206c 6973 745b 6469 6374   data: list[dict
-0001d980: 5b73 7472 2c6f 626a 6563 745d 5d0a 2020  [str,object]].  
-0001d990: 2020 2020 2020 3a72 6169 7365 7320 4578        :raises Ex
-0001d9a0: 6365 7074 696f 6e3a 2049 6620 6120 7661  ception: If a va
-0001d9b0: 6c69 6420 636f 6e66 6967 206f 626a 6563  lid config objec
-0001d9c0: 7420 6361 6e6e 6f74 2062 650a 2020 2020  t cannot be.    
-0001d9d0: 2020 2020 2020 2020 636f 6e73 7472 7563          construc
-0001d9e0: 7465 6420 6672 6f6d 2060 6461 7461 602e  ted from `data`.
-0001d9f0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0001da00: 3a20 6120 7661 6c69 6420 696e 7374 616e  : a valid instan
-0001da10: 6365 206f 6620 6120 636f 6e66 6967 7572  ce of a configur
-0001da20: 6174 696f 6e20 6f62 6a65 6374 2077 6974  ation object wit
-0001da30: 6820 6669 656c 640a 2020 2020 2020 2020  h field.        
-0001da40: 2020 2020 7661 6c75 6573 2074 616b 656e      values taken
-0001da50: 2066 726f 6d20 6064 6174 6160 2e0a 2020   from `data`..  
-0001da60: 2020 2020 2020 3a72 7479 7065 3a20 6e65        :rtype: ne
-0001da70: 7875 7366 6f72 6d61 742e 6e65 7875 732e  xusformat.nexus.
-0001da80: 4e58 726f 6f74 0a20 2020 2020 2020 2022  NXroot.        "
-0001da90: 2222 0a20 2020 2020 2020 206e 7872 6f6f  "".        nxroo
-0001daa0: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
-0001dab0: 2069 6620 6973 696e 7374 616e 6365 2864   if isinstance(d
-0001dac0: 6174 612c 206c 6973 7429 3a0a 2020 2020  ata, list):.    
-0001dad0: 2020 2020 2020 2020 666f 7220 6974 656d          for item
-0001dae0: 2069 6e20 6461 7461 3a0a 2020 2020 2020   in data:.      
-0001daf0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-0001db00: 6e73 7461 6e63 6528 6974 656d 2c20 6469  nstance(item, di
-0001db10: 6374 293a 0a20 2020 2020 2020 2020 2020  ct):.           
-0001db20: 2020 2020 2020 2020 2069 6620 6974 656d           if item
-0001db30: 2e67 6574 2827 7363 6865 6d61 2729 203d  .get('schema') =
-0001db40: 3d20 2754 6f6d 6f53 696d 4669 656c 6427  = 'TomoSimField'
-0001db50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001db60: 2020 2020 2020 2020 2020 6e78 726f 6f74            nxroot
-0001db70: 203d 2069 7465 6d2e 6765 7428 2764 6174   = item.get('dat
-0001db80: 6127 290a 2020 2020 2020 2020 2020 2020  a').            
-0001db90: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-0001dba0: 6b0a 2020 2020 2020 2020 6966 206e 7872  k.        if nxr
-0001dbb0: 6f6f 7420 6973 204e 6f6e 653a 0a20 2020  oot is None:.   
-0001dbc0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-0001dbd0: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
-0001dbe0: 2020 2020 2020 2020 2020 2027 4e6f 2074             'No t
-0001dbf0: 6f6d 6f67 7261 7068 7920 6461 7461 2073  omography data s
-0001dc00: 6574 2066 6f75 6e64 2069 6e20 696e 7075  et found in inpu
-0001dc10: 7420 6461 7461 2729 0a0a 2020 2020 2020  t data')..      
-0001dc20: 2020 7265 7475 726e 206e 7872 6f6f 740a    return nxroot.
-0001dc30: 0a0a 636c 6173 7320 546f 6d6f 4272 6967  ..class TomoBrig
-0001dc40: 6874 4669 656c 6450 726f 6365 7373 6f72  htFieldProcessor
-0001dc50: 2850 726f 6365 7373 6f72 293a 0a20 2020  (Processor):.   
-0001dc60: 2022 2222 0a20 2020 2043 6c61 7373 2072   """.    Class r
-0001dc70: 6570 7265 7365 6e74 696e 6720 7468 6520  epresenting the 
-0001dc80: 7072 6f63 6573 7320 746f 2063 7265 6174  process to creat
-0001dc90: 6520 6120 6272 6967 6874 2066 6965 6c64  e a bright field
-0001dca0: 2061 7373 6f63 6961 7465 640a 2020 2020   associated.    
-0001dcb0: 7769 7468 2061 2073 696d 756c 6174 6564  with a simulated
-0001dcc0: 2074 6f6d 6f67 7261 7068 7920 6461 7461   tomography data
-0001dcd0: 2073 6574 2063 7265 6174 6564 2062 7920   set created by 
-0001dce0: 546f 6d6f 5369 6d50 726f 6365 7373 6f72  TomoSimProcessor
-0001dcf0: 0a20 2020 2072 6574 7572 6e69 6e67 2061  .    returning a
-0001dd00: 2060 6e65 7875 7366 6f72 6d61 742e 6e65   `nexusformat.ne
-0001dd10: 7875 732e 4e58 726f 6f74 6020 6f62 6a65  xus.NXroot` obje
-0001dd20: 6374 2063 6f6e 7461 696e 696e 6720 7468  ct containing th
-0001dd30: 650a 2020 2020 6272 6967 6874 2066 6965  e.    bright fie
-0001dd40: 6c64 2074 6f6d 6f67 7261 7068 7920 6465  ld tomography de
-0001dd50: 7465 6374 6f72 2069 6d61 6765 732e 0a20  tector images.. 
-0001dd60: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
-0001dd70: 7072 6f63 6573 7328 7365 6c66 2c20 6461  process(self, da
-0001dd80: 7461 2c20 6e75 6d5f 696d 6167 653d 352c  ta, num_image=5,
-0001dd90: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-0001dda0: 2020 2020 2320 5468 6972 6420 7061 7274      # Third part
-0001ddb0: 7920 6d6f 6475 6c65 730a 2020 2020 2020  y modules.      
-0001ddc0: 2020 6672 6f6d 206e 6578 7573 666f 726d    from nexusform
-0001ddd0: 6174 2e6e 6578 7573 2069 6d70 6f72 7420  at.nexus import 
-0001dde0: 280a 2020 2020 2020 2020 2020 2020 4e65  (.            Ne
-0001ddf0: 5875 7345 7272 6f72 2c0a 2020 2020 2020  XusError,.      
-0001de00: 2020 2020 2020 4e58 726f 6f74 2c0a 2020        NXroot,.  
-0001de10: 2020 2020 2020 2020 2020 4e58 656e 7472            NXentr
-0001de20: 792c 0a20 2020 2020 2020 2020 2020 204e  y,.            N
-0001de30: 5869 6e73 7472 756d 656e 742c 0a20 2020  Xinstrument,.   
-0001de40: 2020 2020 2020 2020 204e 5864 6574 6563           NXdetec
-0001de50: 746f 722c 0a20 2020 2020 2020 2029 0a0a  tor,.        )..
-0001de60: 2020 2020 2020 2020 2320 4765 7420 616e          # Get an
-0001de70: 6420 7661 6c69 6461 7465 2074 6865 2054  d validate the T
-0001de80: 6f6d 6f53 696d 4669 656c 6420 636f 6e66  omoSimField conf
-0001de90: 6967 7572 6174 696f 6e20 6f62 6a65 6374  iguration object
-0001dea0: 2069 6e20 6461 7461 0a20 2020 2020 2020   in data.       
-0001deb0: 206e 7872 6f6f 7420 3d20 7365 6c66 2e67   nxroot = self.g
-0001dec0: 6574 5f63 6f6e 6669 6728 6461 7461 290a  et_config(data).
-0001ded0: 2020 2020 2020 2020 736f 7572 6365 203d          source =
-0001dee0: 206e 7872 6f6f 742e 656e 7472 792e 696e   nxroot.entry.in
-0001def0: 7374 7275 6d65 6e74 2e73 6f75 7263 650a  strument.source.
-0001df00: 2020 2020 2020 2020 6465 7465 6374 6f72          detector
-0001df10: 203d 206e 7872 6f6f 742e 656e 7472 792e   = nxroot.entry.
-0001df20: 696e 7374 7275 6d65 6e74 2e64 6574 6563  instrument.detec
-0001df30: 746f 720a 2020 2020 2020 2020 6265 616d  tor.        beam
-0001df40: 5f69 6e74 656e 7369 7479 203d 2073 6f75  _intensity = sou
-0001df50: 7263 652e 6265 616d 5f69 6e74 656e 7369  rce.beam_intensi
-0001df60: 7479 0a20 2020 2020 2020 2062 6163 6b67  ty.        backg
-0001df70: 726f 756e 645f 696e 7465 6e73 6974 7920  round_intensity 
-0001df80: 3d20 736f 7572 6365 2e62 6163 6b67 726f  = source.backgro
-0001df90: 756e 645f 696e 7465 6e73 6974 790a 2020  und_intensity.  
-0001dfa0: 2020 2020 2020 6465 7465 6374 6f72 5f73        detector_s
-0001dfb0: 697a 6520 3d20 6465 7465 6374 6f72 2e64  ize = detector.d
-0001dfc0: 6174 612e 7368 6170 655b 2d32 3a5d 0a0a  ata.shape[-2:]..
-0001dfd0: 2020 2020 2020 2020 2320 4164 6420 6475          # Add du
-0001dfe0: 6d6d 7920 736e 6170 7368 6f74 7320 6174  mmy snapshots at
-0001dff0: 2073 7461 7274 2074 6f20 6d69 6d69 6320   start to mimic 
-0001e000: 534d 420a 2020 2020 2020 2020 6966 2073  SMB.        if s
-0001e010: 6f75 7263 652e 7374 6174 696f 6e20 696e  ource.station in
-0001e020: 2028 2769 6431 6133 272c 2027 6964 3361   ('id1a3', 'id3a
-0001e030: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-0001e040: 6e75 6d5f 7468 6574 615f 6475 6d6d 795f  num_theta_dummy_
-0001e050: 7374 6172 7420 3d20 350a 2020 2020 2020  start = 5.      
-0001e060: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001e070: 2020 2020 6e75 6d5f 7468 6574 615f 6475      num_theta_du
-0001e080: 6d6d 795f 7374 6172 7420 3d20 300a 2020  mmy_start = 0.  
-0001e090: 2020 2020 2020 6e75 6d5f 696d 6167 6520        num_image 
-0001e0a0: 2b3d 206e 756d 5f74 6865 7461 5f64 756d  += num_theta_dum
-0001e0b0: 6d79 5f73 7461 7274 0a0a 2020 2020 2020  my_start..      
-0001e0c0: 2020 2320 4372 6561 7465 2074 6865 2062    # Create the b
-0001e0d0: 7269 6768 7420 6669 656c 640a 2020 2020  right field.    
-0001e0e0: 2020 2020 6272 6967 6874 5f66 6965 6c64      bright_field
-0001e0f0: 203d 2069 6e74 2862 6163 6b67 726f 756e   = int(backgroun
-0001e100: 645f 696e 7465 6e73 6974 792b 6265 616d  d_intensity+beam
-0001e110: 5f69 6e74 656e 7369 7479 2920 2a20 6e70  _intensity) * np
-0001e120: 2e6f 6e65 7328 0a20 2020 2020 2020 2020  .ones(.         
-0001e130: 2020 2028 6e75 6d5f 696d 6167 652c 2064     (num_image, d
-0001e140: 6574 6563 746f 725f 7369 7a65 5b30 5d2c  etector_size[0],
-0001e150: 2064 6574 6563 746f 725f 7369 7a65 5b31   detector_size[1
-0001e160: 5d29 2c20 6474 7970 653d 6e70 2e69 6e74  ]), dtype=np.int
-0001e170: 3634 290a 2020 2020 2020 2020 2320 4164  64).        # Ad
-0001e180: 6420 3130 2520 746f 2073 6c69 7420 7369  d 10% to slit si
-0001e190: 7a65 2074 6f20 6d61 6b65 2074 6865 2062  ze to make the b
-0001e1a0: 7269 6768 7420 6265 616d 2073 6c69 6768  right beam sligh
-0001e1b0: 746c 7920 7461 6c6c 6572 0a20 2020 2020  tly taller.     
-0001e1c0: 2020 2023 2020 2020 2074 6861 6e20 7468     #     than th
-0001e1d0: 6520 7665 7274 6963 616c 2064 6973 706c  e vertical displ
-0001e1e0: 6163 656d 656e 7473 2062 6574 7765 656e  acements between
-0001e1f0: 2073 7461 636b 730a 2020 2020 2020 2020   stacks.        
-0001e200: 736c 6974 5f73 697a 6520 3d20 312e 3130  slit_size = 1.10
-0001e210: 2a73 6f75 7263 652e 736c 6974 5f73 697a  *source.slit_siz
-0001e220: 650a 2020 2020 2020 2020 6966 2073 6c69  e.        if sli
-0001e230: 745f 7369 7a65 203c 2064 6574 6563 746f  t_size < detecto
-0001e240: 722e 785f 7069 7865 6c5f 7369 7a65 2a64  r.x_pixel_size*d
-0001e250: 6574 6563 746f 725f 7369 7a65 5b30 5d3a  etector_size[0]:
-0001e260: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
-0001e270: 5f78 5f63 6f6f 7264 7320 3d20 6465 7465  _x_coords = dete
-0001e280: 6374 6f72 2e78 5f70 6978 656c 5f73 697a  ctor.x_pixel_siz
-0001e290: 6520 5c0a 2020 2020 2020 2020 2020 2020  e \.            
-0001e2a0: 2020 2020 2a20 2830 2e35 202b 206e 702e      * (0.5 + np.
-0001e2b0: 6173 6172 7261 7928 7261 6e67 6528 696e  asarray(range(in
-0001e2c0: 7428 6465 7465 6374 6f72 5f73 697a 655b  t(detector_size[
-0001e2d0: 305d 2929 290a 2020 2020 2020 2020 2020  0]))).          
-0001e2e0: 2020 2020 2020 2020 202d 2030 2e35 2a64           - 0.5*d
-0001e2f0: 6574 6563 746f 725f 7369 7a65 5b30 5d29  etector_size[0])
-0001e300: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-0001e310: 6572 5f69 6e64 6963 6573 203d 206e 702e  er_indices = np.
-0001e320: 7768 6572 6528 6162 7328 696d 675f 785f  where(abs(img_x_
-0001e330: 636f 6f72 6473 2920 3e20 736c 6974 5f73  coords) > slit_s
-0001e340: 697a 652f 3229 5b30 5d0a 2020 2020 2020  ize/2)[0].      
-0001e350: 2020 2020 2020 6272 6967 6874 5f66 6965        bright_fie
-0001e360: 6c64 5b3a 2c6f 7574 6572 5f69 6e64 6963  ld[:,outer_indic
-0001e370: 6573 2c3a 5d20 3d20 300a 0a20 2020 2020  es,:] = 0..     
-0001e380: 2020 2023 2043 7265 6174 6520 4e65 7875     # Create Nexu
-0001e390: 7320 6f62 6a65 6374 2061 6e64 2077 7269  s object and wri
-0001e3a0: 7465 2074 6f20 6669 6c65 0a20 2020 2020  te to file.     
-0001e3b0: 2020 206e 7862 7269 6768 7420 3d20 4e58     nxbright = NX
-0001e3c0: 726f 6f74 2829 0a20 2020 2020 2020 206e  root().        n
-0001e3d0: 7862 7269 6768 742e 656e 7472 7920 3d20  xbright.entry = 
-0001e3e0: 4e58 656e 7472 7928 290a 2020 2020 2020  NXentry().      
-0001e3f0: 2020 6e78 6272 6967 6874 2e65 6e74 7279    nxbright.entry
-0001e400: 2e73 616d 706c 6520 3d20 6e78 726f 6f74  .sample = nxroot
-0001e410: 2e65 6e74 7279 2e73 616d 706c 650a 2020  .entry.sample.  
-0001e420: 2020 2020 2020 6e78 696e 7374 7275 6d65        nxinstrume
-0001e430: 6e74 203d 204e 5869 6e73 7472 756d 656e  nt = NXinstrumen
-0001e440: 7428 290a 2020 2020 2020 2020 6e78 6272  t().        nxbr
-0001e450: 6967 6874 2e65 6e74 7279 2e69 6e73 7472  ight.entry.instr
-0001e460: 756d 656e 7420 3d20 6e78 696e 7374 7275  ument = nxinstru
-0001e470: 6d65 6e74 0a20 2020 2020 2020 206e 7869  ment.        nxi
-0001e480: 6e73 7472 756d 656e 742e 736f 7572 6365  nstrument.source
-0001e490: 203d 206e 7872 6f6f 742e 656e 7472 792e   = nxroot.entry.
-0001e4a0: 696e 7374 7275 6d65 6e74 2e73 6f75 7263  instrument.sourc
-0001e4b0: 650a 2020 2020 2020 2020 6e78 6465 7465  e.        nxdete
-0001e4c0: 6374 6f72 203d 204e 5864 6574 6563 746f  ctor = NXdetecto
-0001e4d0: 7228 290a 2020 2020 2020 2020 6e78 696e  r().        nxin
-0001e4e0: 7374 7275 6d65 6e74 2e64 6574 6563 746f  strument.detecto
-0001e4f0: 7220 3d20 6e78 6465 7465 6374 6f72 0a20  r = nxdetector. 
-0001e500: 2020 2020 2020 206e 7864 6574 6563 746f         nxdetecto
-0001e510: 722e 6c6f 6361 6c5f 6e61 6d65 203d 2064  r.local_name = d
-0001e520: 6574 6563 746f 722e 6c6f 6361 6c5f 6e61  etector.local_na
-0001e530: 6d65 0a20 2020 2020 2020 206e 7864 6574  me.        nxdet
-0001e540: 6563 746f 722e 785f 7069 7865 6c5f 7369  ector.x_pixel_si
-0001e550: 7a65 203d 2064 6574 6563 746f 722e 785f  ze = detector.x_
-0001e560: 7069 7865 6c5f 7369 7a65 0a20 2020 2020  pixel_size.     
-0001e570: 2020 206e 7864 6574 6563 746f 722e 795f     nxdetector.y_
-0001e580: 7069 7865 6c5f 7369 7a65 203d 2064 6574  pixel_size = det
-0001e590: 6563 746f 722e 795f 7069 7865 6c5f 7369  ector.y_pixel_si
-0001e5a0: 7a65 0a20 2020 2020 2020 206e 7864 6574  ze.        nxdet
-0001e5b0: 6563 746f 722e 6461 7461 203d 2062 7269  ector.data = bri
-0001e5c0: 6768 745f 6669 656c 640a 2020 2020 2020  ght_field.      
-0001e5d0: 2020 6e78 6465 7465 6374 6f72 2e74 6865    nxdetector.the
-0001e5e0: 7461 7320 3d20 6e70 2e61 7361 7272 6179  tas = np.asarray
-0001e5f0: 286e 756d 5f69 6d61 6765 2a5b 305d 290a  (num_image*[0]).
-0001e600: 2020 2020 2020 2020 6e78 6465 7465 6374          nxdetect
-0001e610: 6f72 2e66 7261 6d65 5f73 7461 7274 5f6e  or.frame_start_n
-0001e620: 756d 6265 7220 3d20 6e75 6d5f 7468 6574  umber = num_thet
-0001e630: 615f 6475 6d6d 795f 7374 6172 740a 0a20  a_dummy_start.. 
-0001e640: 2020 2020 2020 2072 6574 7572 6e20 6e78         return nx
-0001e650: 6272 6967 6874 0a0a 2020 2020 6465 6620  bright..    def 
-0001e660: 6765 745f 636f 6e66 6967 2873 656c 662c  get_config(self,
-0001e670: 2064 6174 6129 3a0a 2020 2020 2020 2020   data):.        
-0001e680: 2222 2247 6574 2061 6e20 696e 7374 616e  """Get an instan
-0001e690: 6365 206f 6620 7468 6520 636f 6e66 6967  ce of the config
-0001e6a0: 7572 6174 696f 6e20 6f62 6a65 6374 206e  uration object n
-0001e6b0: 6565 6465 6420 6279 2074 6869 730a 2020  eeded by this.  
-0001e6c0: 2020 2020 2020 6050 726f 6365 7373 6f72        `Processor
-0001e6d0: 6020 6672 6f6d 2061 2072 6574 7572 6e65  ` from a returne
-0001e6e0: 6420 7661 6c75 6520 6f66 2060 5265 6164  d value of `Read
-0001e6f0: 6572 2e72 6561 6460 0a0a 2020 2020 2020  er.read`..      
-0001e700: 2020 3a70 6172 616d 2064 6174 613a 2052    :param data: R
-0001e710: 6573 756c 7420 6f66 2060 5265 6164 6572  esult of `Reader
-0001e720: 2e72 6561 6460 2077 6865 7265 2061 7420  .read` where at 
-0001e730: 6c65 6173 7420 6f6e 6520 6974 656d 0a20  least one item. 
-0001e740: 2020 2020 2020 2020 2020 2068 6173 2074             has t
-0001e750: 6865 2076 616c 7565 2060 2754 6f6d 6f53  he value `'TomoS
-0001e760: 696d 4669 656c 6427 6020 666f 7220 7468  imField'` for th
-0001e770: 6520 6027 7363 6865 6d61 2760 206b 6579  e `'schema'` key
-0001e780: 2e0a 2020 2020 2020 2020 3a74 7970 6520  ..        :type 
-0001e790: 6461 7461 3a20 6c69 7374 5b64 6963 745b  data: list[dict[
-0001e7a0: 7374 722c 6f62 6a65 6374 5d5d 0a20 2020  str,object]].   
-0001e7b0: 2020 2020 203a 7261 6973 6573 2045 7863       :raises Exc
-0001e7c0: 6570 7469 6f6e 3a20 4966 2061 2076 616c  eption: If a val
-0001e7d0: 6964 2063 6f6e 6669 6720 6f62 6a65 6374  id config object
-0001e7e0: 2063 616e 6e6f 7420 6265 0a20 2020 2020   cannot be.     
-0001e7f0: 2020 2020 2020 2063 6f6e 7374 7275 6374         construct
-0001e800: 6564 2066 726f 6d20 6064 6174 6160 2e0a  ed from `data`..
-0001e810: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-0001e820: 2061 2076 616c 6964 2069 6e73 7461 6e63   a valid instanc
-0001e830: 6520 6f66 2061 2063 6f6e 6669 6775 7261  e of a configura
-0001e840: 7469 6f6e 206f 626a 6563 7420 7769 7468  tion object with
-0001e850: 2066 6965 6c64 0a20 2020 2020 2020 2020   field.         
-0001e860: 2020 2076 616c 7565 7320 7461 6b65 6e20     values taken 
-0001e870: 6672 6f6d 2060 6461 7461 602e 0a20 2020  from `data`..   
-0001e880: 2020 2020 203a 7274 7970 653a 206e 6578       :rtype: nex
-0001e890: 7573 666f 726d 6174 2e6e 6578 7573 2e4e  usformat.nexus.N
-0001e8a0: 5872 6f6f 740a 2020 2020 2020 2020 2222  Xroot.        ""
-0001e8b0: 220a 2020 2020 2020 2020 6e78 726f 6f74  ".        nxroot
-0001e8c0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0001e8d0: 6966 2069 7369 6e73 7461 6e63 6528 6461  if isinstance(da
-0001e8e0: 7461 2c20 6c69 7374 293a 0a20 2020 2020  ta, list):.     
-0001e8f0: 2020 2020 2020 2066 6f72 2069 7465 6d20         for item 
-0001e900: 696e 2064 6174 613a 0a20 2020 2020 2020  in data:.       
-0001e910: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-0001e920: 7374 616e 6365 2869 7465 6d2c 2064 6963  stance(item, dic
-0001e930: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-0001e940: 2020 2020 2020 2020 6966 2069 7465 6d2e          if item.
-0001e950: 6765 7428 2773 6368 656d 6127 2920 3d3d  get('schema') ==
-0001e960: 2027 546f 6d6f 5369 6d46 6965 6c64 273a   'TomoSimField':
-0001e970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e980: 2020 2020 2020 2020 206e 7872 6f6f 7420           nxroot 
-0001e990: 3d20 6974 656d 2e67 6574 2827 6461 7461  = item.get('data
-0001e9a0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-0001e9b0: 2020 2020 2020 2020 2020 2062 7265 616b             break
-0001e9c0: 0a20 2020 2020 2020 2069 6620 6e78 726f  .        if nxro
-0001e9d0: 6f74 2069 7320 4e6f 6e65 3a0a 2020 2020  ot is None:.    
-0001e9e0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-0001e9f0: 6c75 6545 7272 6f72 280a 2020 2020 2020  lueError(.      
-0001ea00: 2020 2020 2020 2020 2020 274e 6f20 746f            'No to
-0001ea10: 6d6f 6772 6170 6879 2064 6174 6120 7365  mography data se
-0001ea20: 7420 666f 756e 6420 696e 2069 6e70 7574  t found in input
-0001ea30: 2064 6174 6127 290a 0a20 2020 2020 2020   data')..       
-0001ea40: 2072 6574 7572 6e20 6e78 726f 6f74 0a0a   return nxroot..
-0001ea50: 0a63 6c61 7373 2054 6f6d 6f53 7065 6350  .class TomoSpecP
-0001ea60: 726f 6365 7373 6f72 2850 726f 6365 7373  rocessor(Process
-0001ea70: 6f72 293a 0a20 2020 2022 2222 0a20 2020  or):.    """.   
-0001ea80: 2043 6c61 7373 2072 6570 7265 7365 6e74   Class represent
-0001ea90: 696e 6720 7468 6520 7072 6f63 6573 7320  ing the process 
-0001eaa0: 746f 2063 7265 6174 6520 6120 746f 6d6f  to create a tomo
-0001eab0: 6772 6170 6879 2053 5045 4320 6669 6c65  graphy SPEC file
-0001eac0: 0a20 2020 2061 7373 6f63 6961 7465 6420  .    associated 
-0001ead0: 7769 7468 2061 2073 696d 756c 6174 6564  with a simulated
-0001eae0: 2074 6f6d 6f67 7261 7068 7920 6461 7461   tomography data
-0001eaf0: 2073 6574 2063 7265 6174 6564 2062 790a   set created by.
-0001eb00: 2020 2020 546f 6d6f 5369 6d50 726f 6365      TomoSimProce
-0001eb10: 7373 6f72 2072 6574 7572 6e69 6e67 2061  ssor returning a
-0001eb20: 2070 6c61 696e 2074 6578 7420 6f62 6a65   plain text obje
-0001eb30: 6374 2063 6f6e 7461 696e 696e 6720 7468  ct containing th
-0001eb40: 650a 2020 2020 746f 6d6f 6772 6170 6879  e.    tomography
-0001eb50: 2053 5045 4320 6669 6c65 2e0a 2020 2020   SPEC file..    
-0001eb60: 2222 220a 0a20 2020 2064 6566 2070 726f  """..    def pro
-0001eb70: 6365 7373 2873 656c 662c 2064 6174 612c  cess(self, data,
-0001eb80: 2073 7065 635f 666f 6c64 6572 3d27 2e27   spec_folder='.'
-0001eb90: 2c20 7363 616e 5f6e 756d 6265 7273 3d5b  , scan_numbers=[
-0001eba0: 315d 2c20 2a2a 6b77 6172 6773 293a 0a20  1], **kwargs):. 
-0001ebb0: 2020 2020 2020 2023 2053 7973 7465 6d20         # System 
-0001ebc0: 6d6f 6475 6c65 730a 2020 2020 2020 2020  modules.        
-0001ebd0: 6672 6f6d 206a 736f 6e20 696d 706f 7274  from json import
-0001ebe0: 2064 756d 700a 2020 2020 2020 2020 6672   dump.        fr
-0001ebf0: 6f6d 2064 6174 6574 696d 6520 696d 706f  om datetime impo
-0001ec00: 7274 2064 6174 6574 696d 650a 0a20 2020  rt datetime..   
-0001ec10: 2020 2020 2023 2054 6869 7264 2070 6172       # Third par
-0001ec20: 7479 206d 6f64 756c 6573 0a20 2020 2020  ty modules.     
-0001ec30: 2020 2066 726f 6d20 6e65 7875 7366 6f72     from nexusfor
-0001ec40: 6d61 742e 6e65 7875 7320 696d 706f 7274  mat.nexus import
-0001ec50: 204e 6558 7573 4572 726f 720a 0a20 2020   NeXusError..   
-0001ec60: 2020 2020 2023 2047 6574 2061 6e64 2076       # Get and v
-0001ec70: 616c 6964 6174 6520 7468 6520 546f 6d6f  alidate the Tomo
-0001ec80: 5369 6d46 6965 6c64 2c20 546f 6d6f 4461  SimField, TomoDa
-0001ec90: 726b 4669 656c 642c 206f 720a 2020 2020  rkField, or.    
-0001eca0: 2020 2020 2320 2020 2020 546f 6d6f 4272      #     TomoBr
-0001ecb0: 6967 6874 4669 656c 6420 636f 6e66 6967  ightField config
-0001ecc0: 7572 6174 696f 6e20 6f62 6a65 6374 2069  uration object i
-0001ecd0: 6e20 6461 7461 0a20 2020 2020 2020 2073  n data.        s
-0001ece0: 6361 6e5f 6e75 6d62 6572 7320 3d20 6c69  can_numbers = li
-0001ecf0: 7374 2873 6574 2873 6361 6e5f 6e75 6d62  st(set(scan_numb
-0001ed00: 6572 7329 290a 2020 2020 2020 2020 636f  ers)).        co
-0001ed10: 6e66 6967 7320 3d20 7365 6c66 2e67 6574  nfigs = self.get
-0001ed20: 5f63 6f6e 6669 6728 6461 7461 290a 2020  _config(data).  
-0001ed30: 2020 2020 2020 7374 6174 696f 6e20 3d20        station = 
-0001ed40: 4e6f 6e65 0a20 2020 2020 2020 2073 616d  None.        sam
-0001ed50: 706c 655f 7479 7065 203d 204e 6f6e 650a  ple_type = None.
-0001ed60: 2020 2020 2020 2020 6e75 6d5f 7363 616e          num_scan
-0001ed70: 203d 2030 0a20 2020 2020 2020 2066 6f72   = 0.        for
-0001ed80: 2073 6368 656d 612c 206e 7872 6f6f 7420   schema, nxroot 
-0001ed90: 696e 2063 6f6e 6669 6773 2e69 7465 6d73  in configs.items
-0001eda0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0001edb0: 736f 7572 6365 203d 206e 7872 6f6f 742e  source = nxroot.
-0001edc0: 656e 7472 792e 696e 7374 7275 6d65 6e74  entry.instrument
-0001edd0: 2e73 6f75 7263 650a 2020 2020 2020 2020  .source.        
-0001ede0: 2020 2020 6966 2073 7461 7469 6f6e 2069      if station i
-0001edf0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0001ee00: 2020 2020 2020 2020 7374 6174 696f 6e20          station 
-0001ee10: 3d20 736f 7572 6365 2e61 7474 7273 2e67  = source.attrs.g
-0001ee20: 6574 2827 7374 6174 696f 6e27 290a 2020  et('station').  
-0001ee30: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0001ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee50: 6966 2073 7461 7469 6f6e 2021 3d20 736f  if station != so
-0001ee60: 7572 6365 2e61 7474 7273 2e67 6574 2827  urce.attrs.get('
-0001ee70: 7374 6174 696f 6e27 293a 0a20 2020 2020  station'):.     
-0001ee80: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001ee90: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0001eea0: 2749 6e63 6f6e 7369 7374 656e 7420 7374  'Inconsistent st
-0001eeb0: 6174 696f 6e20 616d 6f6e 6720 7363 616e  ation among scan
-0001eec0: 7327 290a 2020 2020 2020 2020 2020 2020  s').            
-0001eed0: 6966 2073 616d 706c 655f 7479 7065 2069  if sample_type i
-0001eee0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0001eef0: 2020 2020 2020 2020 7361 6d70 6c65 5f74          sample_t
-0001ef00: 7970 6520 3d20 6e78 726f 6f74 2e65 6e74  ype = nxroot.ent
-0001ef10: 7279 2e73 616d 706c 652e 7361 6d70 6c65  ry.sample.sample
-0001ef20: 5f74 7970 650a 2020 2020 2020 2020 2020  _type.          
-0001ef30: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001ef40: 2020 2020 2020 2020 6966 2073 616d 706c          if sampl
-0001ef50: 655f 7479 7065 2021 3d20 6e78 726f 6f74  e_type != nxroot
-0001ef60: 2e65 6e74 7279 2e73 616d 706c 652e 7361  .entry.sample.sa
-0001ef70: 6d70 6c65 5f74 7970 653a 0a20 2020 2020  mple_type:.     
-0001ef80: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001ef90: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0001efa0: 2749 6e63 6f6e 7369 7374 656e 7420 7361  'Inconsistent sa
-0001efb0: 6d70 6c65 5f74 7970 6520 616d 6f6e 6720  mple_type among 
-0001efc0: 7363 616e 7327 290a 2020 2020 2020 2020  scans').        
-0001efd0: 2020 2020 6465 7465 6374 6f72 203d 206e      detector = n
-0001efe0: 7872 6f6f 742e 656e 7472 792e 696e 7374  xroot.entry.inst
-0001eff0: 7275 6d65 6e74 2e64 6574 6563 746f 720a  rument.detector.
-0001f000: 2020 2020 2020 2020 2020 2020 6966 2027              if '
-0001f010: 7a5f 7472 616e 736c 6174 696f 6e27 2069  z_translation' i
-0001f020: 6e20 6465 7465 6374 6f72 3a0a 2020 2020  n detector:.    
-0001f030: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
-0001f040: 7374 6163 6b20 3d20 6e70 2e61 7361 7272  stack = np.asarr
-0001f050: 6179 2864 6574 6563 746f 722e 7a5f 7472  ay(detector.z_tr
-0001f060: 616e 736c 6174 696f 6e29 2e73 697a 650a  anslation).size.
-0001f070: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0001f080: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001f090: 2020 6e75 6d5f 7374 6163 6b20 3d20 310a    num_stack = 1.
-0001f0a0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-0001f0b0: 5f73 6861 7065 203d 2064 6574 6563 746f  _shape = detecto
-0001f0c0: 722e 6461 7461 2e73 6861 7065 0a20 2020  r.data.shape.   
-0001f0d0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-0001f0e0: 6461 7461 5f73 6861 7065 2920 3d3d 2033  data_shape) == 3
-0001f0f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001f100: 2020 6966 206e 756d 5f73 7461 636b 2021    if num_stack !
-0001f110: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
-0001f120: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-0001f130: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
-0001f140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f150: 2020 2027 496e 636f 6e73 6973 7465 6e74     'Inconsistent
-0001f160: 207a 5f74 7261 6e73 6c61 7469 6f6e 2061   z_translation a
-0001f170: 6e64 2064 6174 6120 6469 6d65 6e73 696f  nd data dimensio
-0001f180: 6e73 270a 2020 2020 2020 2020 2020 2020  ns'.            
-0001f190: 2020 2020 2020 2020 2020 2020 6627 287b              f'({
-0001f1a0: 6e75 6d5f 7374 6163 6b7d 2076 7320 7b31  num_stack} vs {1
-0001f1b0: 7d29 2729 0a20 2020 2020 2020 2020 2020  })').           
-0001f1c0: 2065 6c69 6620 6c65 6e28 6461 7461 5f73   elif len(data_s
-0001f1d0: 6861 7065 2920 3d3d 2034 3a0a 2020 2020  hape) == 4:.    
-0001f1e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0001f1f0: 756d 5f73 7461 636b 2021 3d20 6461 7461  um_stack != data
-0001f200: 5f73 6861 7065 5b30 5d3a 0a20 2020 2020  _shape[0]:.     
-0001f210: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001f220: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0001f230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f240: 2020 2020 2020 2020 2027 496e 636f 6e73           'Incons
-0001f250: 6973 7465 6e74 207a 5f74 7261 6e73 6c61  istent z_transla
-0001f260: 7469 6f6e 2064 696d 656e 7369 6f6e 2061  tion dimension a
-0001f270: 6e64 2064 6174 6120 7368 6170 6520 270a  nd data shape '.
-0001f280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f290: 2020 2020 2020 2020 6627 287b 6e75 6d5f          f'({num_
-0001f2a0: 7374 6163 6b7d 2076 7320 7b64 6174 615f  stack} vs {data_
-0001f2b0: 7368 6170 655b 305d 7d29 2729 0a20 2020  shape[0]})').   
-0001f2c0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0001f2d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001f2e0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0001f2f0: 6627 496e 7661 6c69 6420 6461 7461 2073  f'Invalid data s
-0001f300: 6861 7065 2028 7b64 6174 615f 7368 6170  hape ({data_shap
-0001f310: 657d 2927 290a 2020 2020 2020 2020 2020  e})').          
-0001f320: 2020 6e75 6d5f 7363 616e 202b 3d20 6e75    num_scan += nu
-0001f330: 6d5f 7374 6163 6b0a 2020 2020 2020 2020  m_stack.        
-0001f340: 6966 206c 656e 2873 6361 6e5f 6e75 6d62  if len(scan_numb
-0001f350: 6572 7329 2021 3d20 6e75 6d5f 7363 616e  ers) != num_scan
-0001f360: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0001f370: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
-0001f380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f390: 6627 496e 636f 6e73 6973 7465 6e74 206e  f'Inconsistent n
-0001f3a0: 756d 6265 7220 6f66 2073 6361 6e73 2028  umber of scans (
-0001f3b0: 7b6e 756d 5f73 6361 6e7d 292c 2027 0a20  {num_scan}), '. 
-0001f3c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001f3d0: 276c 656e 2873 6361 6e5f 6e75 6d62 6572  'len(scan_number
-0001f3e0: 7329 203d 207b 6c65 6e28 7363 616e 5f6e  s) = {len(scan_n
-0001f3f0: 756d 6265 7273 297d 2927 290a 0a20 2020  umbers)})')..   
-0001f400: 2020 2020 2023 2043 7265 6174 6520 7468       # Create th
-0001f410: 6520 5350 4543 206f 7574 7075 7420 666f  e SPEC output fo
-0001f420: 6c64 6572 2069 6620 6e65 6564 6564 0a20  lder if needed. 
-0001f430: 2020 2020 2020 2073 7065 635f 666f 6c64         spec_fold
-0001f440: 6572 203d 206f 735f 7061 7468 2e61 6273  er = os_path.abs
-0001f450: 7061 7468 2873 7065 635f 666f 6c64 6572  path(spec_folder
-0001f460: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-0001f470: 206f 735f 7061 7468 2e69 7364 6972 2873   os_path.isdir(s
-0001f480: 7065 635f 666f 6c64 6572 293a 0a20 2020  pec_folder):.   
-0001f490: 2020 2020 2020 2020 206d 6b64 6972 2873           mkdir(s
-0001f4a0: 7065 635f 666f 6c64 6572 290a 0a20 2020  pec_folder)..   
-0001f4b0: 2020 2020 2023 2043 7265 6174 6520 7468       # Create th
-0001f4c0: 6520 5350 4543 2066 696c 6520 6865 6164  e SPEC file head
-0001f4d0: 6572 0a20 2020 2020 2020 2073 7065 635f  er.        spec_
-0001f4e0: 6669 6c65 203d 205b 6627 2346 207b 7361  file = [f'#F {sa
-0001f4f0: 6d70 6c65 5f74 7970 657d 275d 0a20 2020  mple_type}'].   
-0001f500: 2020 2020 2073 7065 635f 6669 6c65 2e61       spec_file.a
-0001f510: 7070 656e 6428 2723 4520 3027 290a 2020  ppend('#E 0').  
-0001f520: 2020 2020 2020 7370 6563 5f66 696c 652e        spec_file.
-0001f530: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
-0001f540: 2020 2020 6627 2344 207b 6461 7465 7469      f'#D {dateti
-0001f550: 6d65 2e6e 6f77 2829 2e73 7472 6674 696d  me.now().strftim
-0001f560: 6528 2225 6120 2562 2025 6420 2549 3a25  e("%a %b %d %I:%
-0001f570: 4d3a 2553 2025 5922 297d 2729 0a20 2020  M:%S %Y")}').   
-0001f580: 2020 2020 2073 7065 635f 6669 6c65 2e61       spec_file.a
-0001f590: 7070 656e 6428 6627 2343 2073 7065 6320  ppend(f'#C spec 
-0001f5a0: 2055 7365 7220 3d20 6368 6573 735f 7b73   User = chess_{s
-0001f5b0: 7461 7469 6f6e 7d5c 6e27 290a 2020 2020  tation}\n').    
-0001f5c0: 2020 2020 6966 2073 7461 7469 6f6e 2069      if station i
-0001f5d0: 6e20 2827 6964 3161 3327 2c20 2769 6433  n ('id1a3', 'id3
-0001f5e0: 6127 293a 0a20 2020 2020 2020 2020 2020  a'):.           
-0001f5f0: 2073 7065 635f 6669 6c65 2e61 7070 656e   spec_file.appen
-0001f600: 6428 2723 4f30 2072 616d 7378 2020 7261  d('#O0 ramsx  ra
-0001f610: 6d73 7a27 290a 2020 2020 2020 2020 656c  msz').        el
-0001f620: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001f630: 2352 5620 4669 7820 6d61 696e 2063 6f64  #RV Fix main cod
-0001f640: 6520 746f 2075 7365 2069 6e64 6570 656e  e to use indepen
-0001f650: 6465 6e74 2064 696d 2069 6e66 6f0a 2020  dent dim info.  
-0001f660: 2020 2020 2020 2020 2020 7370 6563 5f66            spec_f
-0001f670: 696c 652e 6170 7065 6e64 2827 234f 3020  ile.append('#O0 
-0001f680: 4749 5f73 616d 7820 2047 495f 7361 6d7a  GI_samx  GI_samz
-0001f690: 2020 4749 5f73 616d 7068 6927 290a 2020    GI_samphi').  
-0001f6a0: 2020 2020 2020 2020 2020 7370 6563 5f66            spec_f
-0001f6b0: 696c 652e 6170 7065 6e64 2827 236f 3020  ile.append('#o0 
-0001f6c0: 7361 6d78 2073 616d 7a20 7361 6d70 6869  samx samz samphi
-0001f6d0: 2729 2023 5256 2064 6f20 4920 6e65 6564  ') #RV do I need
-0001f6e0: 2074 6869 7320 6c69 6e65 3f0a 2020 2020   this line?.    
-0001f6f0: 2020 2020 7370 6563 5f66 696c 652e 6170      spec_file.ap
-0001f700: 7065 6e64 2827 2729 0a0a 2020 2020 2020  pend('')..      
-0001f710: 2020 2320 4372 6561 7465 2074 6865 2053    # Create the S
-0001f720: 5045 4320 6669 6c65 2073 6361 6e20 696e  PEC file scan in
-0001f730: 666f 2028 616e 6420 696d 6167 6520 616e  fo (and image an
-0001f740: 6420 7061 7266 696c 6520 6461 7461 2066  d parfile data f
-0001f750: 6f72 2053 4d42 290a 2020 2020 2020 2020  or SMB).        
-0001f760: 7061 725f 6669 6c65 203d 205b 5d0a 2020  par_file = [].  
-0001f770: 2020 2020 2020 696d 6167 655f 7365 7473        image_sets
-0001f780: 203d 205b 5d0a 2020 2020 2020 2020 6e75   = [].        nu
-0001f790: 6d5f 7363 616e 203d 2030 0a20 2020 2020  m_scan = 0.     
-0001f7a0: 2020 2063 6f75 6e74 5f74 696d 6520 3d20     count_time = 
-0001f7b0: 310a 2020 2020 2020 2020 666f 7220 7363  1.        for sc
-0001f7c0: 6865 6d61 2c20 6e78 726f 6f74 2069 6e20  hema, nxroot in 
-0001f7d0: 636f 6e66 6967 732e 6974 656d 7328 293a  configs.items():
-0001f7e0: 0a20 2020 2020 2020 2020 2020 2064 6574  .            det
-0001f7f0: 6563 746f 7220 3d20 6e78 726f 6f74 2e65  ector = nxroot.e
-0001f800: 6e74 7279 2e69 6e73 7472 756d 656e 742e  ntry.instrument.
-0001f810: 6465 7465 6374 6f72 0a20 2020 2020 2020  detector.       
-0001f820: 2020 2020 2069 6620 277a 5f74 7261 6e73       if 'z_trans
-0001f830: 6c61 7469 6f6e 2720 696e 2064 6574 6563  lation' in detec
-0001f840: 746f 723a 0a20 2020 2020 2020 2020 2020  tor:.           
-0001f850: 2020 2020 207a 5f74 7261 6e73 6c61 7469       z_translati
-0001f860: 6f6e 7320 3d20 6c69 7374 286e 702e 6173  ons = list(np.as
-0001f870: 6172 7261 7928 6465 7465 6374 6f72 2e7a  array(detector.z
-0001f880: 5f74 7261 6e73 6c61 7469 6f6e 2929 0a20  _translation)). 
-0001f890: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001f8a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f8b0: 207a 5f74 7261 6e73 6c61 7469 6f6e 7320   z_translations 
-0001f8c0: 3d20 5b30 2e5d 0a20 2020 2020 2020 2020  = [0.].         
-0001f8d0: 2020 2066 7261 6d65 5f73 7461 7274 5f6e     frame_start_n
-0001f8e0: 756d 6265 7220 3d20 696e 7428 6465 7465  umber = int(dete
-0001f8f0: 6374 6f72 2e66 7261 6d65 5f73 7461 7274  ctor.frame_start
-0001f900: 5f6e 756d 6265 7229 0a20 2020 2020 2020  _number).       
-0001f910: 2020 2020 2074 6865 7461 7320 3d20 6e70       thetas = np
-0001f920: 2e61 7361 7272 6179 2864 6574 6563 746f  .asarray(detecto
-0001f930: 722e 7468 6574 6173 295b 6672 616d 655f  r.thetas)[frame_
-0001f940: 7374 6172 745f 6e75 6d62 6572 3a5d 0a20  start_number:]. 
-0001f950: 2020 2020 2020 2020 2020 206e 756d 5f74             num_t
-0001f960: 6865 7461 203d 2074 6865 7461 732e 7369  heta = thetas.si
-0001f970: 7a65 0a20 2020 2020 2020 2020 2020 2069  ze.            i
-0001f980: 6620 7363 6865 6d61 203d 3d20 2754 6f6d  f schema == 'Tom
-0001f990: 6f44 6172 6b46 6965 6c64 273a 0a20 2020  oDarkField':.   
-0001f9a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001f9b0: 7374 6174 696f 6e20 696e 2028 2769 6431  station in ('id1
-0001f9c0: 6133 272c 2027 6964 3361 2729 3a0a 2020  a3', 'id3a'):.  
-0001f9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f9e0: 2020 6d61 6372 6f20 3d20 6627 736c 6577    macro = f'slew
-0001f9f0: 5f6f 6d65 207b 7468 6574 6173 5b30 5d7d  _ome {thetas[0]}
-0001fa00: 207b 7468 6574 6173 5b2d 315d 7d20 2720   {thetas[-1]} ' 
-0001fa10: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-0001fa20: 2020 2020 2020 2020 2020 6627 7b6e 756d            f'{num
-0001fa30: 5f74 6865 7461 7d20 7b63 6f75 6e74 5f74  _theta} {count_t
-0001fa40: 696d 657d 2064 6172 6b66 6965 6c64 270a  ime} darkfield'.
-0001fa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa60: 2020 2020 7363 616e 5f74 7970 6520 3d20      scan_type = 
-0001fa70: 2764 6631 270a 2020 2020 2020 2020 2020  'df1'.          
-0001fa80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001fa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001faa0: 6d61 6372 6f20 3d20 6627 666c 7973 6361  macro = f'flysca
-0001fab0: 6e20 7b6e 756d 5f74 6865 7461 7d20 7b63  n {num_theta} {c
-0001fac0: 6f75 6e74 5f74 696d 657d 270a 2020 2020  ount_time}'.    
-0001fad0: 2020 2020 2020 2020 656c 6966 2073 6368          elif sch
-0001fae0: 656d 6120 3d3d 2027 546f 6d6f 4272 6967  ema == 'TomoBrig
-0001faf0: 6874 4669 656c 6427 3a0a 2020 2020 2020  htField':.      
-0001fb00: 2020 2020 2020 2020 2020 6966 2073 7461            if sta
-0001fb10: 7469 6f6e 2069 6e20 2827 6964 3161 3327  tion in ('id1a3'
-0001fb20: 2c20 2769 6433 6127 293a 0a20 2020 2020  , 'id3a'):.     
-0001fb30: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001fb40: 6163 726f 203d 2066 2773 6c65 775f 6f6d  acro = f'slew_om
-0001fb50: 6520 7b74 6865 7461 735b 305d 7d20 7b74  e {thetas[0]} {t
-0001fb60: 6865 7461 735b 2d31 5d7d 2027 205c 0a20  hetas[-1]} ' \. 
-0001fb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fb80: 2020 2020 2020 2066 277b 6e75 6d5f 7468         f'{num_th
-0001fb90: 6574 617d 207b 636f 756e 745f 7469 6d65  eta} {count_time
-0001fba0: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
-0001fbb0: 2020 2020 2020 2073 6361 6e5f 7479 7065         scan_type
-0001fbc0: 203d 2027 6266 3127 0a20 2020 2020 2020   = 'bf1'.       
-0001fbd0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0001fbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fbf0: 2020 206d 6163 726f 203d 2066 2766 6c79     macro = f'fly
-0001fc00: 7363 616e 207b 6e75 6d5f 7468 6574 617d  scan {num_theta}
-0001fc10: 207b 636f 756e 745f 7469 6d65 7d27 0a20   {count_time}'. 
-0001fc20: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0001fc30: 7363 6865 6d61 203d 3d20 2754 6f6d 6f53  schema == 'TomoS
-0001fc40: 696d 4669 656c 6427 3a0a 2020 2020 2020  imField':.      
-0001fc50: 2020 2020 2020 2020 2020 6966 2073 7461            if sta
-0001fc60: 7469 6f6e 2069 6e20 2827 6964 3161 3327  tion in ('id1a3'
-0001fc70: 2c20 2769 6433 6127 293a 0a20 2020 2020  , 'id3a'):.     
-0001fc80: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001fc90: 6163 726f 203d 2066 2773 6c65 775f 6f6d  acro = f'slew_om
-0001fca0: 6520 7b74 6865 7461 735b 305d 7d20 7b74  e {thetas[0]} {t
-0001fcb0: 6865 7461 735b 2d31 5d7d 2027 205c 0a20  hetas[-1]} ' \. 
-0001fcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fcd0: 2020 2020 2020 2066 277b 6e75 6d5f 7468         f'{num_th
-0001fce0: 6574 617d 207b 636f 756e 745f 7469 6d65  eta} {count_time
-0001fcf0: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
-0001fd00: 2020 2020 2020 2073 6361 6e5f 7479 7065         scan_type
-0001fd10: 203d 2027 7473 3127 0a20 2020 2020 2020   = 'ts1'.       
-0001fd20: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0001fd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd40: 2020 206d 6163 726f 203d 2066 2766 6c79     macro = f'fly
-0001fd50: 7363 616e 2073 616d 7068 6920 7b74 6865  scan samphi {the
-0001fd60: 7461 735b 305d 7d20 2720 5c0a 2020 2020  tas[0]} ' \.    
-0001fd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd80: 2020 2020 6627 7b74 6865 7461 735b 2d31      f'{thetas[-1
-0001fd90: 5d7d 207b 6e75 6d5f 7468 6574 612d 317d  ]} {num_theta-1}
-0001fda0: 207b 636f 756e 745f 7469 6d65 7d27 0a20   {count_time}'. 
-0001fdb0: 2020 2020 2020 2020 2020 2066 6f72 2020             for  
-0001fdc0: 6e2c 207a 5f74 7261 6e73 6c61 7469 6f6e  n, z_translation
-0001fdd0: 2069 6e20 656e 756d 6572 6174 6528 7a5f   in enumerate(z_
-0001fde0: 7472 616e 736c 6174 696f 6e73 293a 0a20  translations):. 
-0001fdf0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001fe00: 7065 635f 6669 6c65 2e61 7070 656e 6428  pec_file.append(
-0001fe10: 6627 2353 207b 7363 616e 5f6e 756d 6265  f'#S {scan_numbe
-0001fe20: 7273 5b6e 756d 5f73 6361 6e5d 7d20 207b  rs[num_scan]}  {
-0001fe30: 6d61 6372 6f7d 2729 0a20 2020 2020 2020  macro}').       
-0001fe40: 2020 2020 2020 2020 2073 7065 635f 6669           spec_fi
-0001fe50: 6c65 2e61 7070 656e 6428 0a20 2020 2020  le.append(.     
-0001fe60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001fe70: 2723 4420 7b64 6174 6574 696d 652e 6e6f  '#D {datetime.no
-0001fe80: 7728 292e 7374 7266 7469 6d65 2822 2561  w().strftime("%a
-0001fe90: 2025 6220 2564 2025 493a 254d 3a25 5320   %b %d %I:%M:%S 
-0001fea0: 2559 2229 7d27 290a 2020 2020 2020 2020  %Y")}').        
-0001feb0: 2020 2020 2020 2020 6966 2073 7461 7469          if stati
-0001fec0: 6f6e 2069 6e20 2827 6964 3161 3327 2c20  on in ('id1a3', 
-0001fed0: 2769 6433 6127 293a 0a20 2020 2020 2020  'id3a'):.       
-0001fee0: 2020 2020 2020 2020 2020 2020 2073 7065               spe
-0001fef0: 635f 6669 6c65 2e61 7070 656e 6428 6627  c_file.append(f'
-0001ff00: 2350 3020 302e 3020 7b7a 5f74 7261 6e73  #P0 0.0 {z_trans
-0001ff10: 6c61 7469 6f6e 7d27 290a 2020 2020 2020  lation}').      
-0001ff20: 2020 2020 2020 2020 2020 2020 2020 7370                sp
-0001ff30: 6563 5f66 696c 652e 6170 7065 6e64 2827  ec_file.append('
-0001ff40: 234e 2031 2729 0a20 2020 2020 2020 2020  #N 1').         
-0001ff50: 2020 2020 2020 2020 2020 2073 7065 635f             spec_
-0001ff60: 6669 6c65 2e61 7070 656e 6428 2723 4c20  file.append('#L 
-0001ff70: 206f 6d65 2729 0a20 2020 2020 2020 2020   ome').         
-0001ff80: 2020 2020 2020 2020 2020 2069 6620 7363             if sc
-0001ff90: 616e 5f74 7970 6520 3d3d 2027 7473 3127  an_type == 'ts1'
-0001ffa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001ffb0: 2020 2020 2020 2020 2020 696d 6167 655f            image_
-0001ffc0: 7365 7473 2e61 7070 656e 6428 6465 7465  sets.append(dete
-0001ffd0: 6374 6f72 2e64 6174 615b 6e5d 290a 2020  ctor.data[n]).  
-0001ffe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fff0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00020000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020010: 696d 6167 655f 7365 7473 2e61 7070 656e  image_sets.appen
-00020020: 6428 6465 7465 6374 6f72 2e64 6174 6129  d(detector.data)
-00020030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020040: 2020 2020 2070 6172 5f66 696c 652e 6170       par_file.ap
-00020050: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
-00020060: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00020070: 7b64 6174 6574 696d 652e 6e6f 7728 292e  {datetime.now().
-00020080: 7374 7266 7469 6d65 2822 2559 256d 2564  strftime("%Y%m%d
-00020090: 2229 7d20 270a 2020 2020 2020 2020 2020  ")} '.          
-000200a0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-000200b0: 7b64 6174 6574 696d 652e 6e6f 7728 292e  {datetime.now().
-000200c0: 7374 7266 7469 6d65 2822 2548 254d 2553  strftime("%H%M%S
-000200d0: 2229 7d20 270a 2020 2020 2020 2020 2020  ")} '.          
-000200e0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-000200f0: 7b73 6361 6e5f 6e75 6d62 6572 735b 6e75  {scan_numbers[nu
-00020100: 6d5f 7363 616e 5d7d 2027 0a23 2020 2020  m_scan]} '.#    
-00020110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020120: 2020 2020 2732 2e30 2027 0a23 2020 2020      '2.0 '.#    
-00020130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020140: 2020 2020 2731 2e30 2027 0a20 2020 2020      '1.0 '.     
-00020150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020160: 2020 2027 3020 270a 2020 2020 2020 2020     '0 '.        
-00020170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020180: 6627 7b66 7261 6d65 5f73 7461 7274 5f6e  f'{frame_start_n
-00020190: 756d 6265 727d 2027 0a20 2020 2020 2020  umber} '.       
-000201a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000201b0: 2027 302e 3020 270a 2020 2020 2020 2020   '0.0 '.        
-000201c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000201d0: 6627 7b7a 5f74 7261 6e73 6c61 7469 6f6e  f'{z_translation
-000201e0: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
-000201f0: 2020 2020 2020 2020 2020 2020 6627 7b74              f'{t
-00020200: 6865 7461 735b 305d 7d20 270a 2020 2020  hetas[0]} '.    
-00020210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020220: 2020 2020 6627 7b74 6865 7461 735b 2d31      f'{thetas[-1
-00020230: 5d7d 2027 0a20 2020 2020 2020 2020 2020  ]} '.           
-00020240: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
-00020250: 6e75 6d5f 7468 6574 617d 2027 0a20 2020  num_theta} '.   
-00020260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020270: 2020 2020 2066 277b 636f 756e 745f 7469       f'{count_ti
-00020280: 6d65 7d20 270a 2020 2020 2020 2020 2020  me} '.          
-00020290: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-000202a0: 7b73 6361 6e5f 7479 7065 7d27 290a 2020  {scan_type}').  
-000202b0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000202c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000202d0: 2020 2020 2020 2020 7370 6563 5f66 696c          spec_fil
-000202e0: 652e 6170 7065 6e64 2866 2723 5030 2030  e.append(f'#P0 0
-000202f0: 2e30 207b 7a5f 7472 616e 736c 6174 696f  .0 {z_translatio
-00020300: 6e7d 2030 2e30 2729 0a20 2020 2020 2020  n} 0.0').       
-00020310: 2020 2020 2020 2020 2020 2020 2073 7065               spe
-00020320: 635f 6669 6c65 2e61 7070 656e 6428 2723  c_file.append('#
-00020330: 4e20 3127 290a 2020 2020 2020 2020 2020  N 1').          
-00020340: 2020 2020 2020 2020 2020 6966 2073 6368            if sch
-00020350: 656d 6120 696e 2028 2754 6f6d 6f44 6172  ema in ('TomoDar
-00020360: 6b46 6965 6c64 272c 2027 546f 6d6f 4272  kField', 'TomoBr
-00020370: 6967 6874 4669 656c 6427 293a 0a20 2020  ightField'):.   
-00020380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020390: 2020 2020 2073 7065 635f 6669 6c65 2e61       spec_file.a
-000203a0: 7070 656e 6428 2723 4c20 5469 6d65 2729  ppend('#L Time')
-000203b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000203c0: 2020 2020 2020 2020 2073 7065 635f 6669           spec_fi
-000203d0: 6c65 202b 3d20 5b73 7472 2863 6f75 6e74  le += [str(count
-000203e0: 5f74 696d 652a 7469 6d65 290a 2020 2020  _time*time).    
-000203f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020400: 2020 2020 2020 2020 666f 7220 7469 6d65          for time
-00020410: 2069 6e20 7261 6e67 6528 6e75 6d5f 7468   in range(num_th
-00020420: 6574 6129 5d0a 2020 2020 2020 2020 2020  eta)].          
-00020430: 2020 2020 2020 2020 2020 656c 6966 2073            elif s
-00020440: 6368 656d 6120 3d3d 2027 546f 6d6f 5369  chema == 'TomoSi
-00020450: 6d46 6965 6c64 273a 0a20 2020 2020 2020  mField':.       
-00020460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020470: 2073 7065 635f 6669 6c65 2e61 7070 656e   spec_file.appen
-00020480: 6428 2723 4c20 4749 5f73 616d 7068 6927  d('#L GI_samphi'
-00020490: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000204a0: 2020 2020 2020 2020 2020 7370 6563 5f66            spec_f
-000204b0: 696c 6520 2b3d 205b 7374 7228 7468 6574  ile += [str(thet
-000204c0: 6129 2066 6f72 2074 6865 7461 2069 6e20  a) for theta in 
-000204d0: 7468 6574 6173 5d0a 2020 2020 2020 2020  thetas].        
-000204e0: 2020 2020 2020 2020 7370 6563 5f66 696c          spec_fil
-000204f0: 652e 6170 7065 6e64 2827 2729 0a20 2020  e.append('').   
-00020500: 2020 2020 2020 2020 2020 2020 206e 756d               num
-00020510: 5f73 6361 6e20 2b3d 2031 0a20 2020 2020  _scan += 1.     
-00020520: 2020 200a 2020 2020 2020 2020 6966 2073     .        if s
-00020530: 7461 7469 6f6e 2069 6e20 2827 6964 3161  tation in ('id1a
-00020540: 3327 2c20 2769 6433 6127 293a 0a0a 2020  3', 'id3a'):..  
-00020550: 2020 2020 2020 2020 2020 2320 5772 6974            # Writ
-00020560: 6520 7468 6520 5350 4543 2066 696c 650a  e the SPEC file.
-00020570: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00020580: 2e77 7269 7465 5f74 7874 2873 7065 635f  .write_txt(spec_
-00020590: 6669 6c65 2c20 6f73 5f70 6174 682e 6a6f  file, os_path.jo
-000205a0: 696e 2873 7065 635f 666f 6c64 6572 2c20  in(spec_folder, 
-000205b0: 2773 7065 632e 6c6f 6727 2929 0a0a 2020  'spec.log'))..  
-000205c0: 2020 2020 2020 2020 2020 2320 5772 6974            # Writ
-000205d0: 6520 7468 6520 4a53 4f4e 2066 696c 650a  e the JSON file.
-000205e0: 2020 2020 2020 2020 2020 2020 7061 7266              parf
-000205f0: 696c 655f 6865 6164 6572 203d 207b 0a20  ile_header = {. 
-00020600: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00020610: 3027 3a20 2764 6174 6527 2c0a 2020 2020  0': 'date',.    
-00020620: 2020 2020 2020 2020 2020 2020 2731 273a              '1':
-00020630: 2027 7469 6d65 272c 0a20 2020 2020 2020   'time',.       
-00020640: 2020 2020 2020 2020 2027 3227 3a20 2753           '2': 'S
-00020650: 4341 4e5f 4e27 2c0a 2320 2020 2020 2020  CAN_N',.#       
-00020660: 2020 2020 2020 2020 2027 3327 3a20 2762           '3': 'b
-00020670: 6561 6d5f 7769 6474 6827 2c0a 2320 2020  eam_width',.#   
-00020680: 2020 2020 2020 2020 2020 2020 2027 3427               '4'
-00020690: 3a20 2762 6561 6d5f 6865 6967 6874 272c  : 'beam_height',
-000206a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000206b0: 2027 3327 3a20 276a 756e 6b73 7461 7274   '3': 'junkstart
-000206c0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000206d0: 2020 2027 3427 3a20 2767 6f6f 6473 7461     '4': 'goodsta
-000206e0: 7274 272c 0a20 2020 2020 2020 2020 2020  rt',.           
-000206f0: 2020 2020 2027 3527 3a20 2772 616d 7378       '5': 'ramsx
-00020700: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00020710: 2020 2027 3627 3a20 2772 616d 737a 272c     '6': 'ramsz',
-00020720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020730: 2027 3727 3a20 276f 6d65 5f73 7461 7274   '7': 'ome_start
-00020740: 5f72 6561 6c27 2c0a 2020 2020 2020 2020  _real',.        
-00020750: 2020 2020 2020 2020 2738 273a 2027 6f6d          '8': 'om
-00020760: 655f 656e 645f 7265 616c 272c 0a20 2020  e_end_real',.   
-00020770: 2020 2020 2020 2020 2020 2020 2027 3927               '9'
-00020780: 3a20 276e 6672 616d 6573 5f72 6561 6c27  : 'nframes_real'
-00020790: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000207a0: 2020 2731 3027 3a20 2763 6f75 6e74 5f74    '10': 'count_t
-000207b0: 696d 6527 2c0a 2020 2020 2020 2020 2020  ime',.          
-000207c0: 2020 2020 2020 2731 3127 3a20 2774 6f6d        '11': 'tom
-000207d0: 6f74 7970 6527 2c0a 2020 2020 2020 2020  otype',.        
-000207e0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000207f0: 2020 6a73 6f6e 5f66 696c 656e 616d 6520    json_filename 
-00020800: 3d20 6f73 5f70 6174 682e 6a6f 696e 280a  = os_path.join(.
-00020810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020820: 7370 6563 5f66 6f6c 6465 722c 0a20 2020  spec_folder,.   
-00020830: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
-00020840: 7374 6174 696f 6e7d 2d74 6f6d 6f5f 7369  station}-tomo_si
-00020850: 6d2d 7b6f 735f 7061 7468 2e62 6173 656e  m-{os_path.basen
-00020860: 616d 6528 7370 6563 5f66 6f6c 6465 7229  ame(spec_folder)
-00020870: 7d2e 6a73 6f6e 2729 0a20 2020 2020 2020  }.json').       
-00020880: 2020 2020 2077 6974 6820 6f70 656e 286a       with open(j
-00020890: 736f 6e5f 6669 6c65 6e61 6d65 2c20 2777  son_filename, 'w
-000208a0: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
-000208b0: 2020 2020 2020 2020 2064 756d 7028 7061           dump(pa
-000208c0: 7266 696c 655f 6865 6164 6572 2c20 6629  rfile_header, f)
-000208d0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-000208e0: 2020 2020 2020 2320 5772 6974 6520 7468        # Write th
-000208f0: 6520 7061 7220 6669 6c65 0a20 2020 2020  e par file.     
-00020900: 2020 2020 2020 2070 6172 5f66 696c 656e         par_filen
-00020910: 616d 6520 3d20 6f73 5f70 6174 682e 6a6f  ame = os_path.jo
-00020920: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
-00020930: 2020 2020 7370 6563 5f66 6f6c 6465 722c      spec_folder,
-00020940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020950: 2066 277b 7374 6174 696f 6e7d 2d74 6f6d   f'{station}-tom
-00020960: 6f5f 7369 6d2d 7b6f 735f 7061 7468 2e62  o_sim-{os_path.b
-00020970: 6173 656e 616d 6528 7370 6563 5f66 6f6c  asename(spec_fol
-00020980: 6465 7229 7d2e 7061 7227 290a 2020 2020  der)}.par').    
-00020990: 2020 2020 2020 2020 7365 6c66 2e77 7269          self.wri
-000209a0: 7465 5f74 7874 2870 6172 5f66 696c 652c  te_txt(par_file,
-000209b0: 2070 6172 5f66 696c 656e 616d 6529 0a0a   par_filename)..
-000209c0: 2020 2020 2020 2020 2020 2020 2320 5772              # Wr
-000209d0: 6974 6520 696d 6167 6520 6669 6c65 7320  ite image files 
-000209e0: 6173 2069 6e64 6976 6964 7561 6c20 7469  as individual ti
-000209f0: 6666 730a 2020 2020 2020 2020 2020 2020  ffs.            
-00020a00: 666f 7220 7363 616e 5f6e 756d 6265 722c  for scan_number,
-00020a10: 2069 6d61 6765 5f73 6574 2069 6e20 7a69   image_set in zi
-00020a20: 7028 7363 616e 5f6e 756d 6265 7273 2c20  p(scan_numbers, 
-00020a30: 696d 6167 655f 7365 7473 293a 0a20 2020  image_sets):.   
-00020a40: 2020 2020 2020 2020 2020 2020 2069 6d61               ima
-00020a50: 6765 5f66 6f6c 6465 7220 3d20 6f73 5f70  ge_folder = os_p
-00020a60: 6174 682e 6a6f 696e 2873 7065 635f 666f  ath.join(spec_fo
-00020a70: 6c64 6572 2c20 7374 7228 7363 616e 5f6e  lder, str(scan_n
-00020a80: 756d 6265 7229 290a 2020 2020 2020 2020  umber)).        
-00020a90: 2020 2020 2020 2020 6966 206e 6f74 206f          if not o
-00020aa0: 735f 7061 7468 2e69 7364 6972 2869 6d61  s_path.isdir(ima
-00020ab0: 6765 5f66 6f6c 6465 7229 3a0a 2020 2020  ge_folder):.    
-00020ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ad0: 6d6b 6469 7228 696d 6167 655f 666f 6c64  mkdir(image_fold
-00020ae0: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
-00020af0: 2020 2020 696d 6167 655f 666f 6c64 6572      image_folder
-00020b00: 203d 206f 735f 7061 7468 2e6a 6f69 6e28   = os_path.join(
-00020b10: 696d 6167 655f 666f 6c64 6572 2c20 276e  image_folder, 'n
-00020b20: 6627 290a 2020 2020 2020 2020 2020 2020  f').            
-00020b30: 2020 2020 6966 206e 6f74 206f 735f 7061      if not os_pa
-00020b40: 7468 2e69 7364 6972 2869 6d61 6765 5f66  th.isdir(image_f
-00020b50: 6f6c 6465 7229 3a0a 2020 2020 2020 2020  older):.        
-00020b60: 2020 2020 2020 2020 2020 2020 6d6b 6469              mkdi
-00020b70: 7228 696d 6167 655f 666f 6c64 6572 290a  r(image_folder).
-00020b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b90: 7365 6c66 2e77 7269 7465 5f74 6966 6673  self.write_tiffs
-00020ba0: 2869 6d61 6765 5f73 6574 2c20 696d 6167  (image_set, imag
-00020bb0: 655f 666f 6c64 6572 290a 0a20 2020 2020  e_folder)..     
-00020bc0: 2020 2072 6574 7572 6e20 7370 6563 5f66     return spec_f
-00020bd0: 696c 650a 0a20 2020 2064 6566 2067 6574  ile..    def get
-00020be0: 5f63 6f6e 6669 6728 7365 6c66 2c20 6461  _config(self, da
-00020bf0: 7461 293a 0a20 2020 2020 2020 2022 2222  ta):.        """
-00020c00: 4765 7420 616e 2069 6e73 7461 6e63 6520  Get an instance 
-00020c10: 6f66 2074 6865 2063 6f6e 6669 6775 7261  of the configura
-00020c20: 7469 6f6e 206f 626a 6563 7420 6e65 6564  tion object need
-00020c30: 6564 2062 7920 7468 6973 0a20 2020 2020  ed by this.     
-00020c40: 2020 2060 5072 6f63 6573 736f 7260 2066     `Processor` f
-00020c50: 726f 6d20 6120 7265 7475 726e 6564 2076  rom a returned v
-00020c60: 616c 7565 206f 6620 6052 6561 6465 722e  alue of `Reader.
-00020c70: 7265 6164 600a 0a20 2020 2020 2020 203a  read`..        :
-00020c80: 7061 7261 6d20 6461 7461 3a20 5265 7375  param data: Resu
-00020c90: 6c74 206f 6620 6052 6561 6465 722e 7265  lt of `Reader.re
-00020ca0: 6164 6020 7768 6572 6520 6174 206c 6561  ad` where at lea
-00020cb0: 7374 206f 6e65 2069 7465 6d0a 2020 2020  st one item.    
-00020cc0: 2020 2020 2020 2020 6861 7320 7468 6520          has the 
-00020cd0: 7661 6c75 6520 6027 546f 6d6f 5369 6d46  value `'TomoSimF
-00020ce0: 6965 6c64 2760 2066 6f72 2074 6865 2060  ield'` for the `
-00020cf0: 2773 6368 656d 6127 6020 6b65 792e 0a20  'schema'` key.. 
-00020d00: 2020 2020 2020 203a 7479 7065 2064 6174         :type dat
-00020d10: 613a 206c 6973 745b 6469 6374 5b73 7472  a: list[dict[str
-00020d20: 2c6f 626a 6563 745d 5d0a 2020 2020 2020  ,object]].      
-00020d30: 2020 3a72 6169 7365 7320 4578 6365 7074    :raises Except
-00020d40: 696f 6e3a 2049 6620 6120 7661 6c69 6420  ion: If a valid 
-00020d50: 636f 6e66 6967 206f 626a 6563 7420 6361  config object ca
-00020d60: 6e6e 6f74 2062 650a 2020 2020 2020 2020  nnot be.        
-00020d70: 2020 2020 636f 6e73 7472 7563 7465 6420      constructed 
-00020d80: 6672 6f6d 2060 6461 7461 602e 0a20 2020  from `data`..   
-00020d90: 2020 2020 203a 7265 7475 726e 3a20 6120       :return: a 
-00020da0: 7661 6c69 6420 696e 7374 616e 6365 206f  valid instance o
-00020db0: 6620 6120 636f 6e66 6967 7572 6174 696f  f a configuratio
-00020dc0: 6e20 6f62 6a65 6374 2077 6974 6820 6669  n object with fi
-00020dd0: 656c 640a 2020 2020 2020 2020 2020 2020  eld.            
-00020de0: 7661 6c75 6573 2074 616b 656e 2066 726f  values taken fro
-00020df0: 6d20 6064 6174 6160 2e0a 2020 2020 2020  m `data`..      
-00020e00: 2020 3a72 7479 7065 3a20 6e65 7875 7366    :rtype: nexusf
-00020e10: 6f72 6d61 742e 6e65 7875 732e 4e58 726f  ormat.nexus.NXro
-00020e20: 6f74 0a20 2020 2020 2020 2022 2222 0a20  ot.        """. 
-00020e30: 2020 2020 2020 2063 6f6e 6669 6773 203d         configs =
-00020e40: 207b 7d0a 2020 2020 2020 2020 6966 2069   {}.        if i
-00020e50: 7369 6e73 7461 6e63 6528 6461 7461 2c20  sinstance(data, 
-00020e60: 6c69 7374 293a 0a20 2020 2020 2020 2020  list):.         
-00020e70: 2020 2066 6f72 2069 7465 6d20 696e 2064     for item in d
-00020e80: 6174 613a 0a20 2020 2020 2020 2020 2020  ata:.           
-00020e90: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00020ea0: 6365 2869 7465 6d2c 2064 6963 7429 3a0a  ce(item, dict):.
-00020eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ec0: 2020 2020 7363 6865 6d61 203d 2069 7465      schema = ite
-00020ed0: 6d2e 6765 7428 2773 6368 656d 6127 290a  m.get('schema').
-00020ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ef0: 2020 2020 6966 2073 6368 656d 6120 3d3d      if schema ==
-00020f00: 2027 546f 6d6f 4461 726b 4669 656c 6427   'TomoDarkField'
-00020f10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00020f20: 2020 2020 2020 2020 2020 636f 6e66 6967            config
-00020f30: 735b 7363 6865 6d61 5d20 3d20 6974 656d  s[schema] = item
-00020f40: 2e67 6574 2827 6461 7461 2729 0a20 2020  .get('data').   
+000155a0: 2020 2020 746f 6d6f 5f66 6965 6c64 5f73      tomo_field_s
+000155b0: 6361 6e73 2e61 7474 7273 5b27 7370 6563  cans.attrs['spec
+000155c0: 5f66 696c 6527 5d2c 2073 6361 6e5f 6e75  _file'], scan_nu
+000155d0: 6d62 6572 290a 2020 2020 2020 2020 2020  mber).          
+000155e0: 2020 2020 2020 696d 6167 655f 6f66 6673        image_offs
+000155f0: 6574 203d 2069 6e74 280a 2020 2020 2020  et = int(.      
+00015600: 2020 2020 2020 2020 2020 2020 2020 6e78                nx
+00015610: 7375 6265 6e74 7279 2e69 6e73 7472 756d  subentry.instrum
+00015620: 656e 742e 6465 7465 6374 6f72 2e66 7261  ent.detector.fra
+00015630: 6d65 5f73 7461 7274 5f6e 756d 6265 7229  me_start_number)
+00015640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015650: 2074 6f6d 6f5f 7374 6163 6b20 3d20 5b5d   tomo_stack = []
+00015660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015670: 206e 203d 2030 0a20 2020 2020 2020 2020   n = 0.         
+00015680: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+00015690: 7261 6e67 6528 696d 6167 655f 6d61 736b  range(image_mask
+000156a0: 2e73 697a 6529 3a0a 2020 2020 2020 2020  .size):.        
+000156b0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+000156c0: 6d61 6765 5f6d 6173 6b5b 695d 3a0a 2020  mage_mask[i]:.  
+000156d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156e0: 2020 2020 2020 746f 6d6f 5f73 7461 636b        tomo_stack
+000156f0: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
+00015700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015710: 2020 2020 2073 6361 6e70 6172 7365 722e       scanparser.
+00015720: 6765 745f 6465 7465 6374 6f72 5f64 6174  get_detector_dat
+00015730: 6128 0a20 2020 2020 2020 2020 2020 2020  a(.             
+00015740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015750: 2020 2064 6574 6563 746f 725f 7072 6566     detector_pref
+00015760: 6978 2c20 696d 6167 655f 6f66 6673 6574  ix, image_offset
+00015770: 2b6e 2929 0a20 2020 2020 2020 2020 2020  +n)).           
+00015780: 2020 2020 2020 2020 2020 2020 206e 202b               n +
+00015790: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+000157a0: 2020 2020 746f 6d6f 5f73 7461 636b 732e      tomo_stacks.
+000157b0: 6170 7065 6e64 286e 702e 6173 6172 7261  append(np.asarra
+000157c0: 7928 746f 6d6f 5f73 7461 636b 2929 0a20  y(tomo_stack)). 
+000157d0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+000157e0: 6f72 697a 6f6e 7461 6c5f 7368 6966 7420  orizontal_shift 
+000157f0: 3d20 666c 6f61 7428 6e78 7375 6265 6e74  = float(nxsubent
+00015800: 7279 2e73 616d 706c 652e 785f 7472 616e  ry.sample.x_tran
+00015810: 736c 6174 696f 6e29 0a20 2020 2020 2020  slation).       
+00015820: 2020 2020 2020 2020 2068 6f72 697a 6f6e           horizon
+00015830: 7461 6c5f 7368 6966 7473 2e61 7070 656e  tal_shifts.appen
+00015840: 6428 686f 7269 7a6f 6e74 616c 5f73 6869  d(horizontal_shi
+00015850: 6674 290a 2020 2020 2020 2020 2020 2020  ft).            
+00015860: 2020 2020 7665 7274 6963 616c 5f73 6869      vertical_shi
+00015870: 6674 203d 2066 6c6f 6174 286e 7873 7562  ft = float(nxsub
+00015880: 656e 7472 792e 7361 6d70 6c65 2e7a 5f74  entry.sample.z_t
+00015890: 7261 6e73 6c61 7469 6f6e 290a 2020 2020  ranslation).    
+000158a0: 2020 2020 2020 2020 2020 2020 7665 7274              vert
+000158b0: 6963 616c 5f73 6869 6674 732e 6170 7065  ical_shifts.appe
+000158c0: 6e64 2876 6572 7469 6361 6c5f 7368 6966  nd(vertical_shif
+000158d0: 7429 0a0a 2020 2020 2020 2020 785f 7069  t)..        x_pi
+000158e0: 7865 6c5f 7369 7a65 203d 206e 7865 6e74  xel_size = nxent
+000158f0: 7279 2e69 6e73 7472 756d 656e 742e 6465  ry.instrument.de
+00015900: 7465 6374 6f72 2e78 5f70 6978 656c 5f73  tector.x_pixel_s
+00015910: 697a 650a 2020 2020 2020 2020 795f 7069  ize.        y_pi
+00015920: 7865 6c5f 7369 7a65 203d 206e 7865 6e74  xel_size = nxent
+00015930: 7279 2e69 6e73 7472 756d 656e 742e 6465  ry.instrument.de
+00015940: 7465 6374 6f72 2e79 5f70 6978 656c 5f73  tector.y_pixel_s
+00015950: 697a 650a 2020 2020 2020 2020 7265 6475  ize.        redu
+00015960: 6365 645f 746f 6d6f 5f73 7461 636b 7320  ced_tomo_stacks 
+00015970: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
+00015980: 2069 2c20 746f 6d6f 5f73 7461 636b 2069   i, tomo_stack i
+00015990: 6e20 656e 756d 6572 6174 6528 746f 6d6f  n enumerate(tomo
+000159a0: 5f73 7461 636b 7329 3a0a 2020 2020 2020  _stacks):.      
+000159b0: 2020 2020 2020 2320 5265 7369 7a65 2074        # Resize t
+000159c0: 6865 2074 6f6d 6f67 7261 7068 7920 696d  he tomography im
+000159d0: 6167 6573 0a20 2020 2020 2020 2020 2020  ages.           
+000159e0: 2023 2052 6967 6874 206e 6f77 2074 6865   # Right now the
+000159f0: 2072 616e 6765 2069 7320 7468 6520 7361   range is the sa
+00015a00: 6d65 2066 6f72 2065 6163 6820 7365 7420  me for each set 
+00015a10: 696e 2074 6865 2073 7461 636b 0a20 2020  in the stack.   
+00015a20: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00015a30: 6c65 6e28 7468 6574 6173 2920 3d3d 2074  len(thetas) == t
+00015a40: 6f6d 6f5f 7374 6163 6b2e 7368 6170 655b  omo_stack.shape[
+00015a50: 305d 0a20 2020 2020 2020 2020 2020 2069  0].            i
+00015a60: 6620 2869 6d67 5f78 5f62 6f75 6e64 7320  f (img_x_bounds 
+00015a70: 3d3d 2028 302c 2074 6266 2e73 6861 7065  == (0, tbf.shape
+00015a80: 5b30 5d29 0a20 2020 2020 2020 2020 2020  [0]).           
+00015a90: 2020 2020 2020 2020 2061 6e64 2069 6d67           and img
+00015aa0: 5f79 5f62 6f75 6e64 7320 3d3d 2028 302c  _y_bounds == (0,
+00015ab0: 2074 6266 2e73 6861 7065 5b31 5d29 293a   tbf.shape[1])):
+00015ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015ad0: 2074 6f6d 6f5f 7374 6163 6b20 3d20 746f   tomo_stack = to
+00015ae0: 6d6f 5f73 7461 636b 2e61 7374 7970 6528  mo_stack.astype(
+00015af0: 2766 6c6f 6174 3634 272c 2063 6f70 793d  'float64', copy=
+00015b00: 4661 6c73 6529 0a20 2020 2020 2020 2020  False).         
+00015b10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00015b20: 2020 2020 2020 2020 2074 6f6d 6f5f 7374           tomo_st
+00015b30: 6163 6b20 3d20 746f 6d6f 5f73 7461 636b  ack = tomo_stack
+00015b40: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00015b50: 2020 2020 2020 3a2c 696d 675f 785f 626f        :,img_x_bo
+00015b60: 756e 6473 5b30 5d3a 696d 675f 785f 626f  unds[0]:img_x_bo
+00015b70: 756e 6473 5b31 5d2c 0a20 2020 2020 2020  unds[1],.       
+00015b80: 2020 2020 2020 2020 2020 2020 2069 6d67               img
+00015b90: 5f79 5f62 6f75 6e64 735b 305d 3a69 6d67  _y_bounds[0]:img
+00015ba0: 5f79 5f62 6f75 6e64 735b 315d 5d2e 6173  _y_bounds[1]].as
+00015bb0: 7479 7065 280a 2020 2020 2020 2020 2020  type(.          
+00015bc0: 2020 2020 2020 2020 2020 2020 2020 2766                'f
+00015bd0: 6c6f 6174 3634 272c 2063 6f70 793d 4661  loat64', copy=Fa
+00015be0: 6c73 6529 0a0a 2020 2020 2020 2020 2020  lse)..          
+00015bf0: 2020 2320 5375 6274 7261 6374 2064 6172    # Subtract dar
+00015c00: 6b20 6669 656c 640a 2020 2020 2020 2020  k field.        
+00015c10: 2020 2020 6966 2074 6466 2069 7320 6e6f      if tdf is no
+00015c20: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00015c30: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00015c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c50: 2077 6974 6820 5365 744e 756d 6578 7072   with SetNumexpr
+00015c60: 5468 7265 6164 7328 7365 6c66 2e5f 6e75  Threads(self._nu
+00015c70: 6d5f 636f 7265 293a 0a20 2020 2020 2020  m_core):.       
+00015c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c90: 2065 7661 6c75 6174 6528 2774 6f6d 6f5f   evaluate('tomo_
+00015ca0: 7374 6163 6b2d 7464 6627 2c20 6f75 743d  stack-tdf', out=
+00015cb0: 746f 6d6f 5f73 7461 636b 290a 2020 2020  tomo_stack).    
+00015cc0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00015cd0: 7074 2054 7970 6545 7272 6f72 2061 7320  pt TypeError as 
+00015ce0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00015cf0: 2020 2020 2020 2073 7973 5f65 7869 7428         sys_exit(
+00015d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015d10: 2020 2020 2020 2020 2066 275c 6e41 207b           f'\nA {
+00015d20: 7479 7065 2865 292e 5f5f 6e61 6d65 5f5f  type(e).__name__
+00015d30: 7d20 6f63 6375 7265 6420 7768 696c 6520  } occured while 
+00015d40: 7375 6274 7261 6374 696e 6720 270a 2020  subtracting '.  
+00015d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d60: 2020 2020 2020 2b20 2774 6865 2064 6172        + 'the dar
+00015d70: 6b20 6669 656c 6420 7769 7468 206e 756d  k field with num
+00015d80: 5f65 7870 722e 6576 616c 7561 7465 2829  _expr.evaluate()
+00015d90: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00015da0: 2020 2020 2020 2020 2020 2b20 275c 6e54            + '\nT
+00015db0: 7279 2072 6564 7563 696e 6720 7468 6520  ry reducing the 
+00015dc0: 6465 7465 6374 6f72 2072 616e 6765 270a  detector range'.
+00015dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015de0: 2020 2020 2020 2020 2b20 6627 5c6e 2863          + f'\n(c
+00015df0: 7572 7265 6e74 6c79 2069 6d67 5f78 5f62  urrently img_x_b
+00015e00: 6f75 6e64 7320 3d20 7b69 6d67 5f78 5f62  ounds = {img_x_b
+00015e10: 6f75 6e64 737d 2c20 616e 6420 270a 2020  ounds}, and '.  
+00015e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015e30: 2020 2020 2020 2b20 6627 696d 675f 795f        + f'img_y_
+00015e40: 626f 756e 6473 203d 207b 696d 675f 795f  bounds = {img_y_
+00015e50: 626f 756e 6473 7d29 5c6e 2729 0a0a 2020  bounds})\n')..  
+00015e60: 2020 2020 2020 2020 2020 2320 4e6f 726d            # Norm
+00015e70: 616c 697a 650a 2020 2020 2020 2020 2020  alize.          
+00015e80: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00015e90: 2020 2020 2020 2077 6974 6820 5365 744e         with SetN
+00015ea0: 756d 6578 7072 5468 7265 6164 7328 7365  umexprThreads(se
+00015eb0: 6c66 2e5f 6e75 6d5f 636f 7265 293a 0a20  lf._num_core):. 
+00015ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ed0: 2020 2065 7661 6c75 6174 6528 2774 6f6d     evaluate('tom
+00015ee0: 6f5f 7374 6163 6b2f 7462 6627 2c20 6f75  o_stack/tbf', ou
+00015ef0: 743d 746f 6d6f 5f73 7461 636b 2c20 7472  t=tomo_stack, tr
+00015f00: 7565 6469 763d 5472 7565 290a 2020 2020  uediv=True).    
+00015f10: 2020 2020 2020 2020 6578 6365 7074 2054          except T
+00015f20: 7970 6545 7272 6f72 2061 7320 653a 0a20  ypeError as e:. 
+00015f30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00015f40: 7973 5f65 7869 7428 0a20 2020 2020 2020  ys_exit(.       
+00015f50: 2020 2020 2020 2020 2020 2020 2066 275c               f'\
+00015f60: 6e41 207b 7479 7065 2865 292e 5f5f 6e61  nA {type(e).__na
+00015f70: 6d65 5f5f 7d20 6f63 6375 7265 6420 7768  me__} occured wh
+00015f80: 696c 6520 6e6f 726d 616c 697a 696e 6720  ile normalizing 
+00015f90: 7468 6520 270a 2020 2020 2020 2020 2020  the '.          
+00015fa0: 2020 2020 2020 2020 2020 2b20 2774 6f6d            + 'tom
+00015fb0: 6f67 7261 7068 7920 6461 7461 2077 6974  ography data wit
+00015fc0: 6820 6e75 6d5f 6578 7072 2e65 7661 6c75  h num_expr.evalu
+00015fd0: 6174 6528 2927 0a20 2020 2020 2020 2020  ate()'.         
+00015fe0: 2020 2020 2020 2020 2020 202b 2027 5c6e             + '\n
+00015ff0: 5472 7920 7265 6475 6369 6e67 2074 6865  Try reducing the
+00016000: 2064 6574 6563 746f 7220 7261 6e67 6527   detector range'
+00016010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016020: 2020 2020 202b 2066 275c 6e28 6375 7272       + f'\n(curr
+00016030: 656e 746c 7920 696d 675f 785f 626f 756e  ently img_x_boun
+00016040: 6473 203d 207b 696d 675f 785f 626f 756e  ds = {img_x_boun
+00016050: 6473 7d2c 2061 6e64 2027 0a20 2020 2020  ds}, and '.     
+00016060: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+00016070: 2066 2769 6d67 5f79 5f62 6f75 6e64 7320   f'img_y_bounds 
+00016080: 3d20 7b69 6d67 5f79 5f62 6f75 6e64 737d  = {img_y_bounds}
+00016090: 295c 6e27 290a 0a20 2020 2020 2020 2020  )\n')..         
+000160a0: 2020 2023 2052 656d 6f76 6520 6e6f 6e2d     # Remove non-
+000160b0: 706f 7369 7469 7665 2076 616c 7565 7320  positive values 
+000160c0: 616e 6420 6c69 6e65 6172 697a 6520 6461  and linearize da
+000160d0: 7461 0a20 2020 2020 2020 2020 2020 2023  ta.            #
+000160e0: 2052 5620 6d61 6b65 2069 6e70 7574 2061   RV make input a
+000160f0: 7267 756d 656e 743f 2063 7574 6f66 6620  rgument? cutoff 
+00016100: 3d20 312e 652d 360a 2020 2020 2020 2020  = 1.e-6.        
+00016110: 2020 2020 7769 7468 2053 6574 4e75 6d65      with SetNume
+00016120: 7870 7254 6872 6561 6473 2873 656c 662e  xprThreads(self.
+00016130: 5f6e 756d 5f63 6f72 6529 3a0a 2020 2020  _num_core):.    
+00016140: 2020 2020 2020 2020 2020 2020 6576 616c              eval
+00016150: 7561 7465 280a 2020 2020 2020 2020 2020  uate(.          
+00016160: 2020 2020 2020 2020 2020 2777 6865 7265            'where
+00016170: 2874 6f6d 6f5f 7374 6163 6b20 3c20 312e  (tomo_stack < 1.
+00016180: 652d 362c 2031 2e65 2d36 2c20 746f 6d6f  e-6, 1.e-6, tomo
+00016190: 5f73 7461 636b 2927 2c0a 2020 2020 2020  _stack)',.      
+000161a0: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+000161b0: 743d 746f 6d6f 5f73 7461 636b 290a 2020  t=tomo_stack).  
+000161c0: 2020 2020 2020 2020 2020 7769 7468 2053            with S
+000161d0: 6574 4e75 6d65 7870 7254 6872 6561 6473  etNumexprThreads
+000161e0: 2873 656c 662e 5f6e 756d 5f63 6f72 6529  (self._num_core)
+000161f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016200: 2020 6576 616c 7561 7465 2827 2d6c 6f67    evaluate('-log
+00016210: 2874 6f6d 6f5f 7374 6163 6b29 272c 206f  (tomo_stack)', o
+00016220: 7574 3d74 6f6d 6f5f 7374 6163 6b29 0a0a  ut=tomo_stack)..
+00016230: 2020 2020 2020 2020 2020 2020 2320 4765              # Ge
+00016240: 7420 7269 6420 6f66 206e 616e 732f 696e  t rid of nans/in
+00016250: 6673 2074 6861 7420 6d61 7920 6265 2069  fs that may be i
+00016260: 6e74 726f 6475 6365 6420 6279 206e 6f72  ntroduced by nor
+00016270: 6d61 6c69 7a61 7469 6f6e 0a20 2020 2020  malization.     
+00016280: 2020 2020 2020 206e 702e 7768 6572 6528         np.where(
+00016290: 6e70 2e69 7366 696e 6974 6528 746f 6d6f  np.isfinite(tomo
+000162a0: 5f73 7461 636b 292c 2074 6f6d 6f5f 7374  _stack), tomo_st
+000162b0: 6163 6b2c 2030 2e29 0a0a 2020 2020 2020  ack, 0.)..      
+000162c0: 2020 2020 2020 2320 446f 776e 7369 7a65        # Downsize
+000162d0: 2074 6f6d 6f67 7261 7068 7920 7374 6163   tomography stac
+000162e0: 6b20 746f 2073 6d61 6c6c 6572 2073 697a  k to smaller siz
+000162f0: 650a 2020 2020 2020 2020 2020 2020 746f  e.            to
+00016300: 6d6f 5f73 7461 636b 203d 2074 6f6d 6f5f  mo_stack = tomo_
+00016310: 7374 6163 6b2e 6173 7479 7065 2827 666c  stack.astype('fl
+00016320: 6f61 7433 3227 2c20 636f 7079 3d46 616c  oat32', copy=Fal
+00016330: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+00016340: 6966 206e 6f74 2073 656c 662e 5f74 6573  if not self._tes
+00016350: 745f 6d6f 6465 3a0a 2020 2020 2020 2020  t_mode:.        
+00016360: 2020 2020 2020 2020 6966 206c 656e 2874          if len(t
+00016370: 6f6d 6f5f 7374 6163 6b73 2920 3d3d 2031  omo_stacks) == 1
+00016380: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016390: 2020 2020 2020 7469 746c 6520 3d20 6627        title = f'
+000163a0: 7265 6420 6675 6c6c 7265 7320 7468 6574  red fullres thet
+000163b0: 6120 7b72 6f75 6e64 2874 6865 7461 735b  a {round(thetas[
+000163c0: 305d 2c20 3229 2b30 7d27 0a20 2020 2020  0], 2)+0}'.     
+000163d0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000163e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000163f0: 2020 2020 2074 6974 6c65 203d 2066 2772       title = f'r
+00016400: 6564 2073 7461 636b 207b 697d 2066 756c  ed stack {i} ful
+00016410: 6c72 6573 2074 6865 7461 2027 205c 0a20  lres theta ' \. 
+00016420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016430: 2020 2020 2020 202b 2066 277b 726f 756e         + f'{roun
+00016440: 6428 7468 6574 6173 5b30 5d2c 2032 292b  d(thetas[0], 2)+
+00016450: 307d 270a 2020 2020 2020 2020 2020 2020  0}'.            
+00016460: 2020 2020 6578 7465 6e74 203d 2028 0a20      extent = (. 
+00016470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016480: 2020 2030 2c0a 2020 2020 2020 2020 2020     0,.          
+00016490: 2020 2020 2020 2020 2020 666c 6f61 7428            float(
+000164a0: 795f 7069 7865 6c5f 7369 7a65 2a74 6f6d  y_pixel_size*tom
+000164b0: 6f5f 7374 6163 6b2e 7368 6170 655b 325d  o_stack.shape[2]
+000164c0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000164d0: 2020 2020 2020 2066 6c6f 6174 2878 5f70         float(x_p
+000164e0: 6978 656c 5f73 697a 652a 746f 6d6f 5f73  ixel_size*tomo_s
+000164f0: 7461 636b 2e73 6861 7065 5b31 5d29 2c0a  tack.shape[1]),.
+00016500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016510: 2020 2020 3029 0a20 2020 2020 2020 2020      0).         
+00016520: 2020 2020 2020 2071 7569 636b 5f69 6d73         quick_ims
+00016530: 686f 7728 0a20 2020 2020 2020 2020 2020  how(.           
+00016540: 2020 2020 2020 2020 2074 6f6d 6f5f 7374           tomo_st
+00016550: 6163 6b5b 302c 3a2c 3a5d 2c20 7469 746c  ack[0,:,:], titl
+00016560: 653d 7469 746c 652c 2070 6174 683d 7365  e=title, path=se
+00016570: 6c66 2e5f 6f75 7470 7574 5f66 6f6c 6465  lf._output_folde
+00016580: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+00016590: 2020 2020 2020 2073 6176 655f 6669 673d         save_fig=
+000165a0: 7365 6c66 2e5f 7361 7665 5f66 6967 732c  self._save_figs,
+000165b0: 2073 6176 655f 6f6e 6c79 3d73 656c 662e   save_only=self.
+000165c0: 5f73 6176 655f 6f6e 6c79 2c0a 2020 2020  _save_only,.    
+000165d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165e0: 6578 7465 6e74 3d65 7874 656e 742c 2062  extent=extent, b
+000165f0: 6c6f 636b 3d73 656c 662e 5f62 6c6f 636b  lock=self._block
+00016600: 290a 2320 2020 2020 2020 2020 2020 2020  ).#             
+00016610: 2020 2069 6620 6e6f 7420 7365 6c66 2e5f     if not self._
+00016620: 626c 6f63 6b3a 0a23 2020 2020 2020 2020  block:.#        
+00016630: 2020 2020 2020 2020 2020 2020 636c 6561              clea
+00016640: 725f 696d 7368 6f77 2874 6974 6c65 290a  r_imshow(title).
+00016650: 2020 2020 2020 2020 2020 2020 7a6f 6f6d              zoom
+00016660: 5f70 6572 6320 3d20 3130 300a 2020 2020  _perc = 100.    
+00016670: 2020 2020 2020 2020 6966 207a 6f6f 6d5f          if zoom_
+00016680: 7065 7263 2021 3d20 3130 303a 0a20 2020  perc != 100:.   
+00016690: 2020 2020 2020 2020 2020 2020 2074 3020               t0 
+000166a0: 3d20 7469 6d65 2829 0a20 2020 2020 2020  = time().       
+000166b0: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
+000166c0: 6f67 6765 722e 6465 6275 6728 275a 6f6f  ogger.debug('Zoo
+000166d0: 6d69 6e67 2069 6e20 2e2e 2e27 290a 2020  ming in ...').  
+000166e0: 2020 2020 2020 2020 2020 2020 2020 746f                to
+000166f0: 6d6f 5f7a 6f6f 6d5f 6c69 7374 203d 205b  mo_zoom_list = [
+00016700: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00016710: 2020 666f 7220 6a20 696e 2072 616e 6765    for j in range
+00016720: 2874 6f6d 6f5f 7374 6163 6b2e 7368 6170  (tomo_stack.shap
+00016730: 655b 305d 293a 0a20 2020 2020 2020 2020  e[0]):.         
+00016740: 2020 2020 2020 2020 2020 2074 6f6d 6f5f             tomo_
+00016750: 7a6f 6f6d 203d 207a 6f6f 6d28 746f 6d6f  zoom = zoom(tomo
+00016760: 5f73 7461 636b 5b6a 2c3a 2c3a 5d2c 2030  _stack[j,:,:], 0
+00016770: 2e30 312a 7a6f 6f6d 5f70 6572 6329 0a20  .01*zoom_perc). 
+00016780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016790: 2020 2074 6f6d 6f5f 7a6f 6f6d 5f6c 6973     tomo_zoom_lis
+000167a0: 742e 6170 7065 6e64 2874 6f6d 6f5f 7a6f  t.append(tomo_zo
+000167b0: 6f6d 290a 2020 2020 2020 2020 2020 2020  om).            
+000167c0: 2020 2020 746f 6d6f 5f73 7461 636b 203d      tomo_stack =
+000167d0: 206e 702e 7374 6163 6b28 746f 6d6f 5f7a   np.stack(tomo_z
+000167e0: 6f6f 6d5f 6c69 7374 290a 2020 2020 2020  oom_list).      
+000167f0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00016800: 6c6f 6767 6572 2e69 6e66 6f28 6627 5a6f  logger.info(f'Zo
+00016810: 6f6d 696e 6720 696e 2074 6f6f 6b20 7b74  oming in took {t
+00016820: 696d 6528 292d 7430 3a2e 3266 7d20 7365  ime()-t0:.2f} se
+00016830: 636f 6e64 7327 290a 2020 2020 2020 2020  conds').        
+00016840: 2020 2020 2020 2020 6465 6c20 746f 6d6f          del tomo
+00016850: 5f7a 6f6f 6d5f 6c69 7374 0a20 2020 2020  _zoom_list.     
+00016860: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00016870: 7420 7365 6c66 2e5f 7465 7374 5f6d 6f64  t self._test_mod
+00016880: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00016890: 2020 2020 2020 2074 6974 6c65 203d 2066         title = f
+000168a0: 2772 6564 2073 7461 636b 207b 7a6f 6f6d  'red stack {zoom
+000168b0: 5f70 6572 637d 7020 7468 6574 6120 2720  _perc}p theta ' 
+000168c0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+000168d0: 2020 2020 2020 2020 2020 2b20 6627 7b72            + f'{r
+000168e0: 6f75 6e64 2874 6865 7461 735b 305d 2c20  ound(thetas[0], 
+000168f0: 3229 2b30 7d27 0a20 2020 2020 2020 2020  2)+0}'.         
+00016900: 2020 2020 2020 2020 2020 2071 7569 636b             quick
+00016910: 5f69 6d73 686f 7728 0a20 2020 2020 2020  _imshow(.       
+00016920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016930: 2074 6f6d 6f5f 7374 6163 6b5b 302c 3a2c   tomo_stack[0,:,
+00016940: 3a5d 2c20 7469 746c 653d 7469 746c 652c  :], title=title,
+00016950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016960: 2020 2020 2020 2020 2070 6174 683d 7365           path=se
+00016970: 6c66 2e5f 6f75 7470 7574 5f66 6f6c 6465  lf._output_folde
+00016980: 722c 2073 6176 655f 6669 673d 7365 6c66  r, save_fig=self
+00016990: 2e5f 7361 7665 5f66 6967 732c 0a20 2020  ._save_figs,.   
+000169a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000169b0: 2020 2020 2073 6176 655f 6f6e 6c79 3d73       save_only=s
+000169c0: 656c 662e 5f73 6176 655f 6f6e 6c79 2c20  elf._save_only, 
+000169d0: 626c 6f63 6b3d 7365 6c66 2e5f 626c 6f63  block=self._bloc
+000169e0: 6b29 0a23 2020 2020 2020 2020 2020 2020  k).#            
+000169f0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+00016a00: 656c 662e 5f62 6c6f 636b 3a0a 2320 2020  elf._block:.#   
+00016a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a20: 2020 2020 2063 6c65 6172 5f69 6d73 686f       clear_imsho
+00016a30: 7728 7469 746c 6529 0a0a 2020 2020 2020  w(title)..      
+00016a40: 2020 2020 2020 2320 5361 7665 2074 6573        # Save tes
+00016a50: 7420 6461 7461 2074 6f20 6669 6c65 0a20  t data to file. 
+00016a60: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00016a70: 6c66 2e5f 7465 7374 5f6d 6f64 653a 0a20  lf._test_mode:. 
+00016a80: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00016a90: 6f77 5f69 6e64 6578 203d 2069 6e74 2874  ow_index = int(t
+00016aa0: 6f6d 6f5f 7374 6163 6b2e 7368 6170 655b  omo_stack.shape[
+00016ab0: 315d 2f32 290a 2020 2020 2020 2020 2020  1]/2).          
+00016ac0: 2020 2020 2020 6e70 2e73 6176 6574 7874        np.savetxt
+00016ad0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00016ae0: 2020 2020 2020 6627 7b73 656c 662e 5f6f        f'{self._o
+00016af0: 7574 7075 745f 666f 6c64 6572 7d2f 7265  utput_folder}/re
+00016b00: 645f 7374 6163 6b5f 7b69 7d2e 7478 7427  d_stack_{i}.txt'
+00016b10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00016b20: 2020 2020 2020 746f 6d6f 5f73 7461 636b        tomo_stack
+00016b30: 5b3a 2c72 6f77 5f69 6e64 6578 2c3a 5d2c  [:,row_index,:],
+00016b40: 2066 6d74 3d27 252e 3665 2729 0a0a 2020   fmt='%.6e')..  
+00016b50: 2020 2020 2020 2020 2020 2320 436f 6d62            # Comb
+00016b60: 696e 6520 7265 7369 7a65 6420 7374 6163  ine resized stac
+00016b70: 6b73 0a20 2020 2020 2020 2020 2020 2072  ks.            r
+00016b80: 6564 7563 6564 5f74 6f6d 6f5f 7374 6163  educed_tomo_stac
+00016b90: 6b73 2e61 7070 656e 6428 746f 6d6f 5f73  ks.append(tomo_s
+00016ba0: 7461 636b 290a 0a20 2020 2020 2020 2023  tack)..        #
+00016bb0: 2041 6464 2074 6f6d 6f20 6669 656c 6420   Add tomo field 
+00016bc0: 696e 666f 2074 6f20 7265 6475 6365 6420  info to reduced 
+00016bd0: 6461 7461 204e 5870 726f 6365 7373 0a20  data NXprocess. 
+00016be0: 2020 2020 2020 2072 6564 7563 6564 5f64         reduced_d
+00016bf0: 6174 615b 2778 5f74 7261 6e73 6c61 7469  ata['x_translati
+00016c00: 6f6e 275d 203d 206e 702e 6173 6172 7261  on'] = np.asarra
+00016c10: 7928 686f 7269 7a6f 6e74 616c 5f73 6869  y(horizontal_shi
+00016c20: 6674 7329 0a20 2020 2020 2020 2072 6564  fts).        red
+00016c30: 7563 6564 5f64 6174 615b 277a 5f74 7261  uced_data['z_tra
+00016c40: 6e73 6c61 7469 6f6e 275d 203d 206e 702e  nslation'] = np.
+00016c50: 6173 6172 7261 7928 7665 7274 6963 616c  asarray(vertical
+00016c60: 5f73 6869 6674 7329 0a20 2020 2020 2020  _shifts).       
+00016c70: 2072 6564 7563 6564 5f64 6174 612e 6461   reduced_data.da
+00016c80: 7461 5b27 746f 6d6f 5f66 6965 6c64 7327  ta['tomo_fields'
+00016c90: 5d20 3d20 6e70 2e61 7361 7272 6179 2872  ] = np.asarray(r
+00016ca0: 6564 7563 6564 5f74 6f6d 6f5f 7374 6163  educed_tomo_stac
+00016cb0: 6b73 290a 0a20 2020 2020 2020 2069 6620  ks)..        if 
+00016cc0: 7464 6620 6973 206e 6f74 204e 6f6e 653a  tdf is not None:
+00016cd0: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
+00016ce0: 2074 6466 0a20 2020 2020 2020 2064 656c   tdf.        del
+00016cf0: 2074 6266 0a0a 2020 2020 2020 2020 7265   tbf..        re
+00016d00: 7475 726e 2072 6564 7563 6564 5f64 6174  turn reduced_dat
+00016d10: 610a 0a20 2020 2064 6566 205f 6669 6e64  a..    def _find
+00016d20: 5f63 656e 7465 725f 6f6e 655f 706c 616e  _center_one_plan
+00016d30: 6528 0a20 2020 2020 2020 2020 2020 2073  e(.            s
+00016d40: 656c 662c 2073 696e 6f67 7261 6d2c 2072  elf, sinogram, r
+00016d50: 6f77 2c20 7468 6574 6173 2c20 6566 665f  ow, thetas, eff_
+00016d60: 7069 7865 6c5f 7369 7a65 2c20 6372 6f73  pixel_size, cros
+00016d70: 735f 7365 6374 696f 6e61 6c5f 6469 6d2c  s_sectional_dim,
+00016d80: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
+00016d90: 683d 4e6f 6e65 2c20 6e75 6d5f 636f 7265  h=None, num_core
+00016da0: 3d31 2c20 6761 7573 7369 616e 5f73 6967  =1, gaussian_sig
+00016db0: 6d61 3d4e 6f6e 652c 2072 696e 675f 7769  ma=None, ring_wi
+00016dc0: 6474 683d 4e6f 6e65 293a 0a20 2020 2020  dth=None):.     
+00016dd0: 2020 2022 2222 4669 6e64 2063 656e 7465     """Find cente
+00016de0: 7220 666f 7220 6120 7369 6e67 6c65 2074  r for a single t
+00016df0: 6f6d 6f67 7261 7068 7920 706c 616e 652e  omography plane.
+00016e00: 2222 220a 2020 2020 2020 2020 2320 5468  """.        # Th
+00016e10: 6972 6420 7061 7274 7920 6d6f 6475 6c65  ird party module
+00016e20: 730a 2020 2020 2020 2020 6672 6f6d 2074  s.        from t
+00016e30: 6f6d 6f70 7920 696d 706f 7274 2066 696e  omopy import fin
+00016e40: 645f 6365 6e74 6572 5f76 6f0a 0a20 2020  d_center_vo..   
+00016e50: 2020 2020 2023 2054 7279 2061 7574 6f6d       # Try autom
+00016e60: 6174 6963 2063 656e 7465 7220 6669 6e64  atic center find
+00016e70: 696e 6720 726f 7574 696e 6573 2066 6f72  ing routines for
+00016e80: 2069 6e69 7469 616c 2076 616c 7565 0a20   initial value. 
+00016e90: 2020 2020 2020 2023 2073 696e 6f67 7261         # sinogra
+00016ea0: 6d20 696e 6465 7820 6f72 6465 723a 2074  m index order: t
+00016eb0: 6865 7461 2c63 6f6c 756d 6e0a 2020 2020  heta,column.    
+00016ec0: 2020 2020 2320 6e65 6564 2063 6f6c 756d      # need colum
+00016ed0: 6e2c 7468 6574 6120 666f 7220 6972 6164  n,theta for irad
+00016ee0: 6f6e 2c20 736f 2074 616b 6520 7472 616e  on, so take tran
+00016ef0: 7370 6f73 650a 2020 2020 2020 2020 7369  spose.        si
+00016f00: 6e6f 6772 616d 203d 206e 702e 6173 6172  nogram = np.asar
+00016f10: 7261 7928 7369 6e6f 6772 616d 290a 2020  ray(sinogram).  
+00016f20: 2020 2020 2020 7369 6e6f 6772 616d 5f74        sinogram_t
+00016f30: 203d 2073 696e 6f67 7261 6d2e 540a 2020   = sinogram.T.  
+00016f40: 2020 2020 2020 6365 6e74 6572 203d 2073        center = s
+00016f50: 696e 6f67 7261 6d2e 7368 6170 655b 315d  inogram.shape[1]
+00016f60: 2f32 0a0a 2320 2020 2020 2020 2071 7569  /2..#        qui
+00016f70: 636b 5f69 6d73 686f 7728 0a23 2020 2020  ck_imshow(.#    
+00016f80: 2020 2020 2020 2020 7369 6e6f 6772 616d          sinogram
+00016f90: 5f74 2c20 6627 7369 6e6f 6772 616d 2072  _t, f'sinogram r
+00016fa0: 6f77 7b72 6f77 7d27 2c0a 2320 2020 2020  ow{row}',.#     
+00016fb0: 2020 2020 2020 2061 7370 6563 743d 2761         aspect='a
+00016fc0: 7574 6f27 2c20 7061 7468 3d73 656c 662e  uto', path=self.
+00016fd0: 5f6f 7574 7075 745f 666f 6c64 6572 2c0a  _output_folder,.
+00016fe0: 2320 2020 2020 2020 2020 2020 2073 6176  #            sav
+00016ff0: 655f 6669 673d 7365 6c66 2e5f 7361 7665  e_fig=self._save
+00017000: 5f66 6967 732c 2073 6176 655f 6f6e 6c79  _figs, save_only
+00017010: 3d73 656c 662e 5f73 6176 655f 6f6e 6c79  =self._save_only
+00017020: 2c0a 2320 2020 2020 2020 2020 2020 2062  ,.#            b
+00017030: 6c6f 636b 3d73 656c 662e 5f62 6c6f 636b  lock=self._block
+00017040: 290a 0a20 2020 2020 2020 2023 2054 7279  )..        # Try
+00017050: 2075 7369 6e67 204e 6768 6961 2056 6fe2   using Nghia Vo.
+00017060: 8099 7320 6d65 7468 6f64 0a20 2020 2020  ..s method.     
+00017070: 2020 2074 3020 3d20 7469 6d65 2829 0a20     t0 = time(). 
+00017080: 2020 2020 2020 2069 6620 6e75 6d5f 636f         if num_co
+00017090: 7265 203e 204e 554d 5f43 4f52 455f 544f  re > NUM_CORE_TO
+000170a0: 4d4f 5059 5f4c 494d 4954 3a0a 2020 2020  MOPY_LIMIT:.    
+000170b0: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+000170c0: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
+000170d0: 2020 2020 2020 2020 2020 2020 6627 5275              f'Ru
+000170e0: 6e6e 696e 6720 6669 6e64 5f63 656e 7465  nning find_cente
+000170f0: 725f 766f 206f 6e20 7b4e 554d 5f43 4f52  r_vo on {NUM_COR
+00017100: 455f 544f 4d4f 5059 5f4c 494d 4954 7d20  E_TOMOPY_LIMIT} 
+00017110: 636f 7265 7320 2e2e 2e27 290a 2020 2020  cores ...').    
+00017120: 2020 2020 2020 2020 746f 6d6f 5f63 656e          tomo_cen
+00017130: 7465 7220 3d20 6669 6e64 5f63 656e 7465  ter = find_cente
+00017140: 725f 766f 280a 2020 2020 2020 2020 2020  r_vo(.          
+00017150: 2020 2020 2020 7369 6e6f 6772 616d 2c20        sinogram, 
+00017160: 6e63 6f72 653d 4e55 4d5f 434f 5245 5f54  ncore=NUM_CORE_T
+00017170: 4f4d 4f50 595f 4c49 4d49 5429 0a20 2020  OMOPY_LIMIT).   
+00017180: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00017190: 2020 2020 2020 2074 6f6d 6f5f 6365 6e74         tomo_cent
+000171a0: 6572 203d 2066 696e 645f 6365 6e74 6572  er = find_center
+000171b0: 5f76 6f28 7369 6e6f 6772 616d 2c20 6e63  _vo(sinogram, nc
+000171c0: 6f72 653d 6e75 6d5f 636f 7265 290a 2020  ore=num_core).  
+000171d0: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+000171e0: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
+000171f0: 2020 2020 2066 2746 696e 6469 6e67 2063       f'Finding c
+00017200: 656e 7465 7220 7573 696e 6720 4e67 6869  enter using Nghi
+00017210: 6120 566f e280 9973 206d 6574 686f 6420  a Vo...s method 
+00017220: 746f 6f6b 207b 7469 6d65 2829 2d74 303a  took {time()-t0:
+00017230: 2e32 667d 2027 0a20 2020 2020 2020 2020  .2f} '.         
+00017240: 2020 202b 2027 7365 636f 6e64 7327 290a     + 'seconds').
+00017250: 2020 2020 2020 2020 6365 6e74 6572 5f6f          center_o
+00017260: 6666 7365 745f 766f 203d 2074 6f6d 6f5f  ffset_vo = tomo_
+00017270: 6365 6e74 6572 2d63 656e 7465 720a 2020  center-center.  
+00017280: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+00017290: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
+000172a0: 2020 2020 2066 2743 656e 7465 7220 6174       f'Center at
+000172b0: 2072 6f77 207b 726f 777d 2075 7369 6e67   row {row} using
+000172c0: 204e 6768 6961 2056 6fe2 8099 7320 6d65   Nghia Vo...s me
+000172d0: 7468 6f64 203d 2027 0a20 2020 2020 2020  thod = '.       
+000172e0: 2020 2020 202b 2066 277b 6365 6e74 6572       + f'{center
+000172f0: 5f6f 6666 7365 745f 766f 3a2e 3266 7d27  _offset_vo:.2f}'
+00017300: 290a 2020 2020 2020 2020 7430 203d 2074  ).        t0 = t
+00017310: 696d 6528 290a 2020 2020 2020 2020 7265  ime().        re
+00017320: 636f 6e5f 706c 616e 6520 3d20 7365 6c66  con_plane = self
+00017330: 2e5f 7265 636f 6e73 7472 7563 745f 6f6e  ._reconstruct_on
+00017340: 655f 706c 616e 6528 0a20 2020 2020 2020  e_plane(.       
+00017350: 2020 2020 2073 696e 6f67 7261 6d5f 742c       sinogram_t,
+00017360: 2074 6f6d 6f5f 6365 6e74 6572 2c20 7468   tomo_center, th
+00017370: 6574 6173 2c20 6566 665f 7069 7865 6c5f  etas, eff_pixel_
+00017380: 7369 7a65 2c0a 2020 2020 2020 2020 2020  size,.          
+00017390: 2020 6372 6f73 735f 7365 6374 696f 6e61    cross_sectiona
+000173a0: 6c5f 6469 6d2c 2046 616c 7365 2c20 6e75  l_dim, False, nu
+000173b0: 6d5f 636f 7265 2c20 6761 7573 7369 616e  m_core, gaussian
+000173c0: 5f73 6967 6d61 2c20 7269 6e67 5f77 6964  _sigma, ring_wid
+000173d0: 7468 290a 2020 2020 2020 2020 7365 6c66  th).        self
+000173e0: 2e5f 6c6f 6767 6572 2e69 6e66 6f28 0a20  ._logger.info(. 
+000173f0: 2020 2020 2020 2020 2020 2066 2752 6563             f'Rec
+00017400: 6f6e 7374 7275 6374 696e 6720 726f 7720  onstructing row 
+00017410: 7b72 6f77 7d20 746f 6f6b 207b 7469 6d65  {row} took {time
+00017420: 2829 2d74 303a 2e32 667d 2073 6563 6f6e  ()-t0:.2f} secon
+00017430: 6473 2729 0a0a 2020 2020 2020 2020 6966  ds')..        if
+00017440: 2073 656c 662e 5f73 6176 655f 6669 6773   self._save_figs
+00017450: 3a0a 2020 2020 2020 2020 2020 2020 7469  :.            ti
+00017460: 746c 6520 3d20 6627 6564 6765 7320 726f  tle = f'edges ro
+00017470: 777b 726f 777d 2063 656e 7465 7220 6f66  w{row} center of
+00017480: 6673 6574 7b63 656e 7465 725f 6f66 6673  fset{center_offs
+00017490: 6574 5f76 6f3a 2e32 667d 2056 6f27 0a20  et_vo:.2f} Vo'. 
+000174a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000174b0: 5f70 6c6f 745f 6564 6765 735f 6f6e 655f  _plot_edges_one_
+000174c0: 706c 616e 6528 7265 636f 6e5f 706c 616e  plane(recon_plan
+000174d0: 652c 2074 6974 6c65 2c20 7061 7468 3d70  e, title, path=p
+000174e0: 6174 6829 0a0a 2020 2020 2020 2020 2320  ath)..        # 
+000174f0: 5472 7920 7573 696e 6720 7068 6173 6520  Try using phase 
+00017500: 636f 7272 656c 6174 696f 6e20 6d65 7468  correlation meth
+00017510: 6f64 0a23 2020 2020 2020 2020 6966 2069  od.#        if i
+00017520: 6e70 7574 5f79 6573 6e6f 2827 0a23 2020  nput_yesno('.#  
+00017530: 2020 2020 2020 2020 2020 2020 2020 5472                Tr
+00017540: 7920 6669 6e64 696e 6720 6365 6e74 6572  y finding center
+00017550: 2075 7369 6e67 2070 6861 7365 2063 6f72   using phase cor
+00017560: 7265 6c61 7469 6f6e 2028 792f 6e29 3f27  relation (y/n)?'
+00017570: 2c0a 2320 2020 2020 2020 2020 2020 2020  ,.#             
+00017580: 2020 2027 6e27 293a 0a23 2020 2020 2020     'n'):.#      
+00017590: 2020 2020 2020 7430 203d 2074 696d 6528        t0 = time(
+000175a0: 290a 2320 2020 2020 2020 2020 2020 2074  ).#            t
+000175b0: 6f6d 6f5f 6365 6e74 6572 203d 2066 696e  omo_center = fin
+000175c0: 645f 6365 6e74 6572 5f70 6328 0a23 2020  d_center_pc(.#  
+000175d0: 2020 2020 2020 2020 2020 2020 2020 7369                si
+000175e0: 6e6f 6772 616d 2c20 7369 6e6f 6772 616d  nogram, sinogram
+000175f0: 2c20 746f 6c3d 302e 312c 2072 6f74 635f  , tol=0.1, rotc_
+00017600: 6775 6573 733d 746f 6d6f 5f63 656e 7465  guess=tomo_cente
+00017610: 7229 0a23 2020 2020 2020 2020 2020 2020  r).#            
+00017620: 6572 726f 7220 3d20 312e 0a23 2020 2020  error = 1..#    
+00017630: 2020 2020 2020 2020 7768 696c 6520 6572          while er
+00017640: 726f 7220 3e20 746f 6c3a 0a23 2020 2020  ror > tol:.#    
+00017650: 2020 2020 2020 2020 2020 2020 7072 6576              prev
+00017660: 203d 2074 6f6d 6f5f 6365 6e74 6572 0a23   = tomo_center.#
+00017670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017680: 746f 6d6f 5f63 656e 7465 7220 3d20 6669  tomo_center = fi
+00017690: 6e64 5f63 656e 7465 725f 7063 280a 2320  nd_center_pc(.# 
+000176a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000176b0: 2020 2073 696e 6f67 7261 6d2c 2073 696e     sinogram, sin
+000176c0: 6f67 7261 6d2c 2074 6f6c 3d74 6f6c 2c20  ogram, tol=tol, 
+000176d0: 726f 7463 5f67 7565 7373 3d74 6f6d 6f5f  rotc_guess=tomo_
+000176e0: 6365 6e74 6572 290a 2320 2020 2020 2020  center).#       
+000176f0: 2020 2020 2020 2020 2065 7272 6f72 203d           error =
+00017700: 206e 702e 6162 7328 746f 6d6f 5f63 656e   np.abs(tomo_cen
+00017710: 7465 722d 7072 6576 290a 2320 2020 2020  ter-prev).#     
+00017720: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
+00017730: 6765 722e 696e 666f 280a 2320 2020 2020  ger.info(.#     
+00017740: 2020 2020 2020 2020 2020 2027 4669 6e64             'Find
+00017750: 696e 6720 6365 6e74 6572 2075 7369 6e67  ing center using
+00017760: 2074 6865 2070 6861 7365 2063 6f72 7265   the phase corre
+00017770: 6c61 7469 6f6e 206d 6574 686f 6420 270a  lation method '.
+00017780: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+00017790: 202b 2066 2774 6f6f 6b20 7b74 696d 6528   + f'took {time(
+000177a0: 292d 7430 3a2e 3266 7d20 7365 636f 6e64  )-t0:.2f} second
+000177b0: 7327 290a 2320 2020 2020 2020 2020 2020  s').#           
+000177c0: 2063 656e 7465 725f 6f66 6673 6574 203d   center_offset =
+000177d0: 2074 6f6d 6f5f 6365 6e74 6572 2d63 656e   tomo_center-cen
+000177e0: 7465 720a 2320 2020 2020 2020 2020 2020  ter.#           
+000177f0: 2070 7269 6e74 280a 2320 2020 2020 2020   print(.#       
+00017800: 2020 2020 2020 2020 2066 2743 656e 7465           f'Cente
+00017810: 7220 6174 2072 6f77 207b 726f 777d 2075  r at row {row} u
+00017820: 7369 6e67 2070 6861 7365 2063 6f72 7265  sing phase corre
+00017830: 6c61 7469 6f6e 203d 2027 0a23 2020 2020  lation = '.#    
+00017840: 2020 2020 2020 2020 2020 2020 2b20 6627              + f'
+00017850: 7b63 656e 7465 725f 6f66 6673 6574 3a2e  {center_offset:.
+00017860: 3266 7d27 290a 2320 2020 2020 2020 2020  2f}').#         
+00017870: 2020 2074 3020 3d20 7469 6d65 2829 0a23     t0 = time().#
+00017880: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+00017890: 6e5f 706c 616e 6520 3d20 7365 6c66 2e5f  n_plane = self._
+000178a0: 7265 636f 6e73 7472 7563 745f 6f6e 655f  reconstruct_one_
+000178b0: 706c 616e 6528 0a23 2020 2020 2020 2020  plane(.#        
+000178c0: 2020 2020 2020 2020 7369 6e6f 6772 616d          sinogram
+000178d0: 5f74 2c20 746f 6d6f 5f63 656e 7465 722c  _t, tomo_center,
+000178e0: 2074 6865 7461 732c 2065 6666 5f70 6978   thetas, eff_pix
+000178f0: 656c 5f73 697a 652c 0a23 2020 2020 2020  el_size,.#      
+00017900: 2020 2020 2020 2020 2020 6372 6f73 735f            cross_
+00017910: 7365 6374 696f 6e61 6c5f 6469 6d2c 2046  sectional_dim, F
+00017920: 616c 7365 2c20 6e75 6d5f 636f 7265 2c20  alse, num_core, 
+00017930: 6761 7573 7369 616e 5f73 6967 6d61 2c20  gaussian_sigma, 
+00017940: 7269 6e67 5f77 6964 7468 290a 2320 2020  ring_width).#   
+00017950: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
+00017960: 6f67 6765 722e 696e 666f 280a 2320 2020  ogger.info(.#   
+00017970: 2020 2020 2020 2020 2020 2020 2066 2752               f'R
+00017980: 6563 6f6e 7374 7275 6374 696e 6720 726f  econstructing ro
+00017990: 7720 7b72 6f77 7d20 746f 6f6b 207b 7469  w {row} took {ti
+000179a0: 6d65 2829 2d74 303a 2e32 667d 2073 6563  me()-t0:.2f} sec
+000179b0: 6f6e 6473 2729 0a23 0a23 2020 2020 2020  onds').#.#      
+000179c0: 2020 2020 2020 7469 746c 6520 3d20 5c0a        title = \.
+000179d0: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+000179e0: 2066 2765 6467 6573 2072 6f77 7b72 6f77   f'edges row{row
+000179f0: 7d20 6365 6e74 6572 5f6f 6666 7365 747b  } center_offset{
+00017a00: 6365 6e74 6572 5f6f 6666 7365 743a 2e32  center_offset:.2
+00017a10: 667d 2050 4327 0a23 2020 2020 2020 2020  f} PC'.#        
+00017a20: 2020 2020 7365 6c66 2e5f 706c 6f74 5f65      self._plot_e
+00017a30: 6467 6573 5f6f 6e65 5f70 6c61 6e65 2872  dges_one_plane(r
+00017a40: 6563 6f6e 5f70 6c61 6e65 2c20 7469 746c  econ_plane, titl
+00017a50: 652c 2070 6174 683d 7061 7468 290a 0a20  e, path=path).. 
+00017a60: 2020 2020 2020 2023 2053 656c 6563 7420         # Select 
+00017a70: 6365 6e74 6572 206c 6f63 6174 696f 6e0a  center location.
+00017a80: 2320 2020 2020 2020 2069 6620 696e 7075  #        if inpu
+00017a90: 745f 7965 736e 6f28 0a23 2020 2020 2020  t_yesno(.#      
+00017aa0: 2020 2020 2020 2741 6363 6570 7420 6120        'Accept a 
+00017ab0: 6365 6e74 6572 206c 6f63 6174 696f 6e20  center location 
+00017ac0: 2879 2920 6f72 2063 6f6e 7469 6e75 6520  (y) or continue 
+00017ad0: 7365 6172 6368 2028 6e29 3f27 2c0a 2320  search (n)?',.# 
+00017ae0: 2020 2020 2020 2020 2020 2027 7927 293a             'y'):
+00017af0: 0a23 2020 2020 2020 2020 2020 2020 6365  .#            ce
+00017b00: 6e74 6572 5f6f 6666 7365 7420 3d20 696e  nter_offset = in
+00017b10: 7075 745f 6e75 6d28 2720 2020 2045 6e74  put_num('    Ent
+00017b20: 6572 2063 686f 7365 6e20 6365 6e74 6572  er chosen center
+00017b30: 206f 6666 7365 7427 2c0a 2320 2020 2020   offset',.#     
+00017b40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00017b50: 653d 2d63 656e 7465 722c 206c 653d 6365  e=-center, le=ce
+00017b60: 6e74 6572 2c20 6465 6661 756c 743d 6365  nter, default=ce
+00017b70: 6e74 6572 5f6f 6666 7365 745f 766f 290a  nter_offset_vo).
+00017b80: 2320 2020 2020 2020 2020 2020 2072 6574  #            ret
+00017b90: 7572 6e20 666c 6f61 7428 6365 6e74 6572  urn float(center
+00017ba0: 5f6f 6666 7365 7429 0a0a 2020 2020 2020  _offset)..      
+00017bb0: 2020 2320 5065 7266 6f72 6d20 6365 6e74    # Perform cent
+00017bc0: 6572 2066 696e 6469 6e67 2073 6561 7263  er finding searc
+00017bd0: 680a 2320 2020 2020 2020 2077 6869 6c65  h.#        while
+00017be0: 2054 7275 653a 0a23 2020 2020 2020 2020   True:.#        
+00017bf0: 2020 2020 6365 6e74 6572 5f6f 6666 7365      center_offse
+00017c00: 745f 6c6f 7720 3d20 696e 7075 745f 696e  t_low = input_in
+00017c10: 7428 0a23 2020 2020 2020 2020 2020 2020  t(.#            
+00017c20: 2020 2020 275c 6e45 6e74 6572 206c 6f77      '\nEnter low
+00017c30: 6572 2062 6f75 6e64 2066 6f72 2063 656e  er bound for cen
+00017c40: 7465 7220 6f66 6673 6574 272c 2067 653d  ter offset', ge=
+00017c50: 2d63 656e 7465 722c 6c65 3d63 656e 7465  -center,le=cente
+00017c60: 7229 0a23 2020 2020 2020 2020 2020 2020  r).#            
+00017c70: 6365 6e74 6572 5f6f 6666 7365 745f 7570  center_offset_up
+00017c80: 7020 3d20 696e 7075 745f 696e 7428 0a23  p = input_int(.#
+00017c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ca0: 2745 6e74 6572 2075 7070 6572 2062 6f75  'Enter upper bou
+00017cb0: 6e64 2066 6f72 2063 656e 7465 7220 6f66  nd for center of
+00017cc0: 6673 6574 272c 2067 653d 6365 6e74 6572  fset', ge=center
+00017cd0: 5f6f 6666 7365 745f 6c6f 772c 0a23 2020  _offset_low,.#  
+00017ce0: 2020 2020 2020 2020 2020 2020 2020 6c65                le
+00017cf0: 3d63 656e 7465 7229 0a23 2020 2020 2020  =center).#      
+00017d00: 2020 2020 2020 6966 2063 656e 7465 725f        if center_
+00017d10: 6f66 6673 6574 5f75 7070 203d 3d20 6365  offset_upp == ce
+00017d20: 6e74 6572 5f6f 6666 7365 745f 6c6f 773a  nter_offset_low:
+00017d30: 0a23 2020 2020 2020 2020 2020 2020 2020  .#              
+00017d40: 2020 6365 6e74 6572 5f6f 6666 7365 745f    center_offset_
+00017d50: 7374 6570 203d 2031 0a23 2020 2020 2020  step = 1.#      
+00017d60: 2020 2020 2020 656c 7365 3a0a 2320 2020        else:.#   
+00017d70: 2020 2020 2020 2020 2020 2020 2063 656e               cen
+00017d80: 7465 725f 6f66 6673 6574 5f73 7465 7020  ter_offset_step 
+00017d90: 3d20 696e 7075 745f 696e 7428 0a23 2020  = input_int(.#  
+00017da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017db0: 2020 2745 6e74 6572 2073 7465 7020 7369    'Enter step si
+00017dc0: 7a65 2066 6f72 2063 656e 7465 7220 6f66  ze for center of
+00017dd0: 6673 6574 2073 6561 7263 6827 2c20 6765  fset search', ge
+00017de0: 3d31 2c0a 2320 2020 2020 2020 2020 2020  =1,.#           
+00017df0: 2020 2020 2020 2020 2020 2020 206c 653d               le=
+00017e00: 6365 6e74 6572 5f6f 6666 7365 745f 7570  center_offset_up
+00017e10: 702d 6365 6e74 6572 5f6f 6666 7365 745f  p-center_offset_
+00017e20: 6c6f 7729 0a23 2020 2020 2020 2020 2020  low).#          
+00017e30: 2020 6e75 6d5f 6365 6e74 6572 5f6f 6666    num_center_off
+00017e40: 7365 7420 3d20 3120 2b20 696e 7428 0a23  set = 1 + int(.#
+00017e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017e60: 2863 656e 7465 725f 6f66 6673 6574 5f75  (center_offset_u
+00017e70: 7070 2d63 656e 7465 725f 6f66 6673 6574  pp-center_offset
+00017e80: 5f6c 6f77 2920 2f20 6365 6e74 6572 5f6f  _low) / center_o
+00017e90: 6666 7365 745f 7374 6570 290a 2320 2020  ffset_step).#   
+00017ea0: 2020 2020 2020 2020 2063 656e 7465 725f           center_
+00017eb0: 6f66 6673 6574 7320 3d20 6e70 2e6c 696e  offsets = np.lin
+00017ec0: 7370 6163 6528 0a23 2020 2020 2020 2020  space(.#        
+00017ed0: 2020 2020 2020 2020 6365 6e74 6572 5f6f          center_o
+00017ee0: 6666 7365 745f 6c6f 772c 2063 656e 7465  ffset_low, cente
+00017ef0: 725f 6f66 6673 6574 5f75 7070 2c20 6e75  r_offset_upp, nu
+00017f00: 6d5f 6365 6e74 6572 5f6f 6666 7365 7429  m_center_offset)
+00017f10: 0a23 2020 2020 2020 2020 2020 2020 666f  .#            fo
+00017f20: 7220 6365 6e74 6572 5f6f 6666 7365 7420  r center_offset 
+00017f30: 696e 2063 656e 7465 725f 6f66 6673 6574  in center_offset
+00017f40: 733a 0a23 2020 2020 2020 2020 2020 2020  s:.#            
+00017f50: 2020 2020 6966 2063 656e 7465 725f 6f66      if center_of
+00017f60: 6673 6574 203d 3d20 6365 6e74 6572 5f6f  fset == center_o
+00017f70: 6666 7365 745f 766f 3a0a 2320 2020 2020  ffset_vo:.#     
+00017f80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00017f90: 6f6e 7469 6e75 650a 2320 2020 2020 2020  ontinue.#       
+00017fa0: 2020 2020 2020 2020 2074 3020 3d20 7469           t0 = ti
+00017fb0: 6d65 2829 0a23 2020 2020 2020 2020 2020  me().#          
+00017fc0: 2020 2020 2020 7265 636f 6e5f 706c 616e        recon_plan
+00017fd0: 6520 3d20 7365 6c66 2e5f 7265 636f 6e73  e = self._recons
+00017fe0: 7472 7563 745f 6f6e 655f 706c 616e 6528  truct_one_plane(
+00017ff0: 0a23 2020 2020 2020 2020 2020 2020 2020  .#              
+00018000: 2020 2020 2020 7369 6e6f 6772 616d 5f74        sinogram_t
+00018010: 2c20 6365 6e74 6572 5f6f 6666 7365 742b  , center_offset+
+00018020: 6365 6e74 6572 2c20 7468 6574 6173 2c20  center, thetas, 
+00018030: 6566 665f 7069 7865 6c5f 7369 7a65 2c0a  eff_pixel_size,.
+00018040: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+00018050: 2020 2020 2063 726f 7373 5f73 6563 7469       cross_secti
+00018060: 6f6e 616c 5f64 696d 2c20 4661 6c73 652c  onal_dim, False,
+00018070: 206e 756d 5f63 6f72 652c 2067 6175 7373   num_core, gauss
+00018080: 6961 6e5f 7369 676d 612c 2072 696e 675f  ian_sigma, ring_
+00018090: 7769 6474 6829 0a23 2020 2020 2020 2020  width).#        
+000180a0: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+000180b0: 6767 6572 2e69 6e66 6f28 0a23 2020 2020  gger.info(.#    
+000180c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000180d0: 6627 5265 636f 6e73 7472 7563 7469 6e67  f'Reconstructing
+000180e0: 2063 656e 7465 725f 6f66 6673 6574 207b   center_offset {
+000180f0: 6365 6e74 6572 5f6f 6666 7365 747d 2074  center_offset} t
+00018100: 6f6f 6b20 270a 2320 2020 2020 2020 2020  ook '.#         
+00018110: 2020 2020 2020 2020 2020 202b 2027 667b             + 'f{
+00018120: 7469 6d65 2829 2d74 303a 2e32 667d 2073  time()-t0:.2f} s
+00018130: 6563 6f6e 6473 2729 0a23 2020 2020 2020  econds').#      
+00018140: 2020 2020 2020 2020 2020 7469 746c 6520            title 
+00018150: 3d20 6627 6564 6765 7320 726f 777b 726f  = f'edges row{ro
+00018160: 777d 2063 656e 7465 725f 6f66 6673 6574  w} center_offset
+00018170: 7b63 656e 7465 725f 6f66 6673 6574 3a2e  {center_offset:.
+00018180: 3266 7d27 0a23 2020 2020 2020 2020 2020  2f}'.#          
+00018190: 2020 2020 2020 7365 6c66 2e5f 706c 6f74        self._plot
+000181a0: 5f65 6467 6573 5f6f 6e65 5f70 6c61 6e65  _edges_one_plane
+000181b0: 2872 6563 6f6e 5f70 6c61 6e65 2c20 7469  (recon_plane, ti
+000181c0: 746c 652c 2070 6174 683d 7061 7468 290a  tle, path=path).
+000181d0: 2320 2020 2020 2020 2020 2020 2069 6620  #            if 
+000181e0: 696e 7075 745f 696e 7428 275c 6e43 6f6e  input_int('\nCon
+000181f0: 7469 6e75 6520 2830 2920 6f72 2065 6e64  tinue (0) or end
+00018200: 2074 6865 2073 6561 7263 6820 2831 2927   the search (1)'
+00018210: 2c20 6765 3d30 2c20 6c65 3d31 293a 0a23  , ge=0, le=1):.#
+00018220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018230: 6272 6561 6b0a 0a20 2020 2020 2020 2064  break..        d
+00018240: 656c 2073 696e 6f67 7261 6d5f 740a 2020  el sinogram_t.  
+00018250: 2020 2020 2020 6465 6c20 7265 636f 6e5f        del recon_
+00018260: 706c 616e 650a 2320 2020 2020 2020 2063  plane.#        c
+00018270: 656e 7465 725f 6f66 6673 6574 203d 2069  enter_offset = i
+00018280: 6e70 7574 5f6e 756d 280a 2320 2020 2020  nput_num(.#     
+00018290: 2020 2020 2020 2027 2020 2020 456e 7465         '    Ente
+000182a0: 7220 6368 6f73 656e 2063 656e 7465 7220  r chosen center 
+000182b0: 6f66 6673 6574 272c 2067 653d 2d63 656e  offset', ge=-cen
+000182c0: 7465 722c 206c 653d 6365 6e74 6572 290a  ter, le=center).
+000182d0: 2020 2020 2020 2020 6365 6e74 6572 5f6f          center_o
+000182e0: 6666 7365 7420 3d20 6365 6e74 6572 5f6f  ffset = center_o
+000182f0: 6666 7365 745f 766f 0a0a 2020 2020 2020  ffset_vo..      
+00018300: 2020 7265 7475 726e 2066 6c6f 6174 2863    return float(c
+00018310: 656e 7465 725f 6f66 6673 6574 290a 0a20  enter_offset).. 
+00018320: 2020 2064 6566 205f 7265 636f 6e73 7472     def _reconstr
+00018330: 7563 745f 6f6e 655f 706c 616e 6528 0a20  uct_one_plane(. 
+00018340: 2020 2020 2020 2020 2020 2073 656c 662c             self,
+00018350: 2074 6f6d 6f5f 706c 616e 655f 742c 2063   tomo_plane_t, c
+00018360: 656e 7465 722c 2074 6865 7461 732c 2065  enter, thetas, e
+00018370: 6666 5f70 6978 656c 5f73 697a 652c 0a20  ff_pixel_size,. 
+00018380: 2020 2020 2020 2020 2020 2063 726f 7373             cross
+00018390: 5f73 6563 7469 6f6e 616c 5f64 696d 2c20  _sectional_dim, 
+000183a0: 706c 6f74 5f73 696e 6f67 7261 6d3d 5472  plot_sinogram=Tr
+000183b0: 7565 2c20 6e75 6d5f 636f 7265 3d31 2c0a  ue, num_core=1,.
+000183c0: 2020 2020 2020 2020 2020 2020 6761 7573              gaus
+000183d0: 7369 616e 5f73 6967 6d61 3d4e 6f6e 652c  sian_sigma=None,
+000183e0: 2072 696e 675f 7769 6474 683d 4e6f 6e65   ring_width=None
+000183f0: 293a 0a20 2020 2020 2020 2022 2222 496e  ):.        """In
+00018400: 7665 7274 2074 6865 2073 696e 6f67 7261  vert the sinogra
+00018410: 6d20 666f 7220 6120 7369 6e67 6c65 2074  m for a single t
+00018420: 6f6d 6f67 7261 7068 7920 706c 616e 652e  omography plane.
+00018430: 2222 220a 2020 2020 2020 2020 2320 5468  """.        # Th
+00018440: 6972 6420 7061 7274 7920 6d6f 6475 6c65  ird party module
+00018450: 730a 2020 2020 2020 2020 6672 6f6d 2073  s.        from s
+00018460: 6369 7079 2e6e 6469 6d61 6765 2069 6d70  cipy.ndimage imp
+00018470: 6f72 7420 6761 7573 7369 616e 5f66 696c  ort gaussian_fil
+00018480: 7465 720a 2020 2020 2020 2020 6672 6f6d  ter.        from
+00018490: 2073 6b69 6d61 6765 2e74 7261 6e73 666f   skimage.transfo
+000184a0: 726d 2069 6d70 6f72 7420 6972 6164 6f6e  rm import iradon
+000184b0: 0a20 2020 2020 2020 2066 726f 6d20 746f  .        from to
+000184c0: 6d6f 7079 2069 6d70 6f72 7420 6d69 7363  mopy import misc
+000184d0: 0a0a 2020 2020 2020 2020 2320 746f 6d6f  ..        # tomo
+000184e0: 5f70 6c61 6e65 5f74 2069 6e64 6578 206f  _plane_t index o
+000184f0: 7264 6572 3a20 636f 6c75 6d6e 2c74 6865  rder: column,the
+00018500: 7461 0a20 2020 2020 2020 2061 7373 6572  ta.        asser
+00018510: 7420 3020 3c3d 2063 656e 7465 7220 3c20  t 0 <= center < 
+00018520: 746f 6d6f 5f70 6c61 6e65 5f74 2e73 6861  tomo_plane_t.sha
+00018530: 7065 5b30 5d0a 2020 2020 2020 2020 6365  pe[0].        ce
+00018540: 6e74 6572 5f6f 6666 7365 7420 3d20 6365  nter_offset = ce
+00018550: 6e74 6572 2d74 6f6d 6f5f 706c 616e 655f  nter-tomo_plane_
+00018560: 742e 7368 6170 655b 305d 2f32 0a20 2020  t.shape[0]/2.   
+00018570: 2020 2020 2074 776f 5f6f 6666 7365 7420       two_offset 
+00018580: 3d20 3220 2a20 696e 7428 6e70 2e72 6f75  = 2 * int(np.rou
+00018590: 6e64 2863 656e 7465 725f 6f66 6673 6574  nd(center_offset
+000185a0: 2929 0a20 2020 2020 2020 2074 776f 5f6f  )).        two_o
+000185b0: 6666 7365 745f 6162 7320 3d20 6e70 2e61  ffset_abs = np.a
+000185c0: 6273 2874 776f 5f6f 6666 7365 7429 0a20  bs(two_offset). 
+000185d0: 2020 2020 2020 2023 2041 6464 2031 3025         # Add 10%
+000185e0: 2073 6c61 636b 2074 6f20 6d61 785f 7261   slack to max_ra
+000185f0: 6420 746f 2061 766f 6964 2065 6467 6520  d to avoid edge 
+00018600: 6566 6665 6374 730a 2020 2020 2020 2020  effects.        
+00018610: 6d61 785f 7261 6420 3d20 696e 7428 302e  max_rad = int(0.
+00018620: 3535 202a 2028 6372 6f73 735f 7365 6374  55 * (cross_sect
+00018630: 696f 6e61 6c5f 6469 6d2f 6566 665f 7069  ional_dim/eff_pi
+00018640: 7865 6c5f 7369 7a65 2929 0a20 2020 2020  xel_size)).     
+00018650: 2020 2069 6620 6d61 785f 7261 6420 3e20     if max_rad > 
+00018660: 302e 352a 746f 6d6f 5f70 6c61 6e65 5f74  0.5*tomo_plane_t
+00018670: 2e73 6861 7065 5b30 5d3a 0a20 2020 2020  .shape[0]:.     
+00018680: 2020 2020 2020 206d 6178 5f72 6164 203d         max_rad =
+00018690: 2030 2e35 2a74 6f6d 6f5f 706c 616e 655f   0.5*tomo_plane_
+000186a0: 742e 7368 6170 655b 305d 0a20 2020 2020  t.shape[0].     
+000186b0: 2020 2064 6973 745f 6672 6f6d 5f65 6467     dist_from_edg
+000186c0: 6520 3d20 6d61 7828 312c 2069 6e74 286e  e = max(1, int(n
+000186d0: 702e 666c 6f6f 7228 0a20 2020 2020 2020  p.floor(.       
+000186e0: 2020 2020 2028 746f 6d6f 5f70 6c61 6e65       (tomo_plane
+000186f0: 5f74 2e73 6861 7065 5b30 5d20 2d20 7477  _t.shape[0] - tw
+00018700: 6f5f 6f66 6673 6574 5f61 6273 2920 2f20  o_offset_abs) / 
+00018710: 322e 2920 2d20 6d61 785f 7261 6429 290a  2.) - max_rad)).
+00018720: 2020 2020 2020 2020 6966 2074 776f 5f6f          if two_o
+00018730: 6666 7365 7420 3e3d 2030 3a0a 2020 2020  ffset >= 0:.    
+00018740: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+00018750: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
+00018760: 2020 2020 2020 2020 2020 2020 6627 7369              f'si
+00018770: 6e6f 6772 616d 2072 616e 6765 203d 205b  nogram range = [
+00018780: 7b74 776f 5f6f 6666 7365 742b 6469 7374  {two_offset+dist
+00018790: 5f66 726f 6d5f 6564 6765 7d2c 2027 0a20  _from_edge}, '. 
+000187a0: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+000187b0: 2066 277b 2d64 6973 745f 6672 6f6d 5f65   f'{-dist_from_e
+000187c0: 6467 657d 5d27 290a 2020 2020 2020 2020  dge}]').        
+000187d0: 2020 2020 7369 6e6f 6772 616d 203d 2074      sinogram = t
+000187e0: 6f6d 6f5f 706c 616e 655f 745b 0a20 2020  omo_plane_t[.   
+000187f0: 2020 2020 2020 2020 2020 2020 2074 776f               two
+00018800: 5f6f 6666 7365 742b 6469 7374 5f66 726f  _offset+dist_fro
+00018810: 6d5f 6564 6765 3a2d 6469 7374 5f66 726f  m_edge:-dist_fro
+00018820: 6d5f 6564 6765 2c3a 5d0a 2020 2020 2020  m_edge,:].      
+00018830: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00018840: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+00018850: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00018860: 2020 2020 2020 2020 6627 7369 6e6f 6772          f'sinogr
+00018870: 616d 2072 616e 6765 203d 205b 7b64 6973  am range = [{dis
+00018880: 745f 6672 6f6d 5f65 6467 657d 2c20 270a  t_from_edge}, '.
+00018890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000188a0: 2b20 6627 7b74 776f 5f6f 6666 7365 742d  + f'{two_offset-
+000188b0: 6469 7374 5f66 726f 6d5f 6564 6765 7d5d  dist_from_edge}]
+000188c0: 2729 0a20 2020 2020 2020 2020 2020 2073  ').            s
+000188d0: 696e 6f67 7261 6d20 3d20 746f 6d6f 5f70  inogram = tomo_p
+000188e0: 6c61 6e65 5f74 5b64 6973 745f 6672 6f6d  lane_t[dist_from
+000188f0: 5f65 6467 653a 7477 6f5f 6f66 6673 6574  _edge:two_offset
+00018900: 2d64 6973 745f 6672 6f6d 5f65 6467 652c  -dist_from_edge,
+00018910: 3a5d 0a20 2020 2020 2020 2069 6620 706c  :].        if pl
+00018920: 6f74 5f73 696e 6f67 7261 6d3a 0a20 2020  ot_sinogram:.   
+00018930: 2020 2020 2020 2020 2071 7569 636b 5f69           quick_i
+00018940: 6d73 686f 7728 0a20 2020 2020 2020 2020  mshow(.         
+00018950: 2020 2020 2020 2073 696e 6f67 7261 6d2e         sinogram.
+00018960: 542c 2066 2773 696e 6f67 7261 6d20 6365  T, f'sinogram ce
+00018970: 6e74 6572 206f 6666 7365 747b 6365 6e74  nter offset{cent
+00018980: 6572 5f6f 6666 7365 743a 2e32 667d 272c  er_offset:.2f}',
+00018990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000189a0: 2061 7370 6563 743d 2761 7574 6f27 2c20   aspect='auto', 
+000189b0: 7061 7468 3d73 656c 662e 5f6f 7574 7075  path=self._outpu
+000189c0: 745f 666f 6c64 6572 2c0a 2020 2020 2020  t_folder,.      
+000189d0: 2020 2020 2020 2020 2020 7361 7665 5f66            save_f
+000189e0: 6967 3d73 656c 662e 5f73 6176 655f 6669  ig=self._save_fi
+000189f0: 6773 2c20 7361 7665 5f6f 6e6c 793d 7365  gs, save_only=se
+00018a00: 6c66 2e5f 7361 7665 5f6f 6e6c 792c 0a20  lf._save_only,. 
+00018a10: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00018a20: 6c6f 636b 3d73 656c 662e 5f62 6c6f 636b  lock=self._block
+00018a30: 290a 0a20 2020 2020 2020 2023 2049 6e76  )..        # Inv
+00018a40: 6572 7469 6e67 2073 696e 6f67 7261 6d0a  erting sinogram.
+00018a50: 2020 2020 2020 2020 7430 203d 2074 696d          t0 = tim
+00018a60: 6528 290a 2020 2020 2020 2020 7265 636f  e().        reco
+00018a70: 6e5f 7369 6e6f 6772 616d 203d 2069 7261  n_sinogram = ira
+00018a80: 646f 6e28 7369 6e6f 6772 616d 2c20 7468  don(sinogram, th
+00018a90: 6574 613d 7468 6574 6173 2c20 6369 7263  eta=thetas, circ
+00018aa0: 6c65 3d54 7275 6529 0a20 2020 2020 2020  le=True).       
+00018ab0: 2073 656c 662e 5f6c 6f67 6765 722e 696e   self._logger.in
+00018ac0: 666f 2866 2749 6e76 6572 7469 6e67 2073  fo(f'Inverting s
+00018ad0: 696e 6f67 7261 6d20 746f 6f6b 207b 7469  inogram took {ti
+00018ae0: 6d65 2829 2d74 303a 2e32 667d 2073 6563  me()-t0:.2f} sec
+00018af0: 6f6e 6473 2729 0a20 2020 2020 2020 2064  onds').        d
+00018b00: 656c 2073 696e 6f67 7261 6d0a 0a20 2020  el sinogram..   
+00018b10: 2020 2020 2023 2050 6572 666f 726d 696e       # Performin
+00018b20: 6720 4761 7573 7369 616e 2066 696c 7465  g Gaussian filte
+00018b30: 7269 6e67 2061 6e64 2072 656d 6f76 696e  ring and removin
+00018b40: 6720 7269 6e67 2061 7274 6966 6163 7473  g ring artifacts
+00018b50: 0a20 2020 2020 2020 2069 6620 6761 7573  .        if gaus
+00018b60: 7369 616e 5f73 6967 6d61 2069 7320 6e6f  sian_sigma is no
+00018b70: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00018b80: 2020 2020 7265 636f 6e5f 7369 6e6f 6772      recon_sinogr
+00018b90: 616d 203d 2067 6175 7373 6961 6e5f 6669  am = gaussian_fi
+00018ba0: 6c74 6572 280a 2020 2020 2020 2020 2020  lter(.          
+00018bb0: 2020 2020 2020 7265 636f 6e5f 7369 6e6f        recon_sino
+00018bc0: 6772 616d 2c20 6761 7573 7369 616e 5f73  gram, gaussian_s
+00018bd0: 6967 6d61 2c20 6d6f 6465 3d27 6e65 6172  igma, mode='near
+00018be0: 6573 7427 290a 2020 2020 2020 2020 7265  est').        re
+00018bf0: 636f 6e5f 636c 6561 6e20 3d20 6e70 2e65  con_clean = np.e
+00018c00: 7870 616e 645f 6469 6d73 2872 6563 6f6e  xpand_dims(recon
+00018c10: 5f73 696e 6f67 7261 6d2c 2061 7869 733d  _sinogram, axis=
+00018c20: 3029 0a20 2020 2020 2020 2064 656c 2072  0).        del r
+00018c30: 6563 6f6e 5f73 696e 6f67 7261 6d0a 2020  econ_sinogram.  
+00018c40: 2020 2020 2020 6966 2072 696e 675f 7769        if ring_wi
+00018c50: 6474 6820 6973 206e 6f74 204e 6f6e 653a  dth is not None:
+00018c60: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
+00018c70: 6f6e 5f63 6c65 616e 203d 206d 6973 632e  on_clean = misc.
+00018c80: 636f 7272 2e72 656d 6f76 655f 7269 6e67  corr.remove_ring
+00018c90: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00018ca0: 2020 7265 636f 6e5f 636c 6561 6e2c 2072    recon_clean, r
+00018cb0: 7769 6474 683d 7269 6e67 5f77 6964 7468  width=ring_width
+00018cc0: 2c20 6e63 6f72 653d 6e75 6d5f 636f 7265  , ncore=num_core
+00018cd0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00018ce0: 6e20 7265 636f 6e5f 636c 6561 6e0a 0a20  n recon_clean.. 
+00018cf0: 2020 2064 6566 205f 706c 6f74 5f65 6467     def _plot_edg
+00018d00: 6573 5f6f 6e65 5f70 6c61 6e65 2873 656c  es_one_plane(sel
+00018d10: 662c 2072 6563 6f6e 5f70 6c61 6e65 2c20  f, recon_plane, 
+00018d20: 7469 746c 652c 2070 6174 683d 4e6f 6e65  title, path=None
+00018d30: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+00018d40: 2020 2020 2020 2043 7265 6174 6520 616e         Create an
+00018d50: 2022 6564 6765 7320 706c 6f74 2220 666f   "edges plot" fo
+00018d60: 7220 6120 7369 6e67 6c65 6420 7265 636f  r a singled reco
+00018d70: 6e73 7472 7563 7465 6420 746f 6d6f 6772  nstructed tomogr
+00018d80: 6170 6879 0a20 2020 2020 2020 2064 6174  aphy.        dat
+00018d90: 6120 706c 616e 652e 0a20 2020 2020 2020  a plane..       
+00018da0: 2022 2222 0a20 2020 2020 2020 2023 2054   """.        # T
+00018db0: 6869 7264 2070 6172 7479 206d 6f64 756c  hird party modul
+00018dc0: 6573 0a20 2020 2020 2020 2066 726f 6d20  es.        from 
+00018dd0: 736b 696d 6167 652e 7265 7374 6f72 6174  skimage.restorat
+00018de0: 696f 6e20 696d 706f 7274 2064 656e 6f69  ion import denoi
+00018df0: 7365 5f74 765f 6368 616d 626f 6c6c 650a  se_tv_chambolle.
+00018e00: 0a20 2020 2020 2020 2076 6973 5f70 6172  .        vis_par
+00018e10: 616d 6574 6572 7320 3d20 4e6f 6e65 2020  ameters = None  
+00018e20: 2320 7365 6c66 2e5f 636f 6e66 6967 2e67  # self._config.g
+00018e30: 6574 2827 7669 735f 7061 7261 6d65 7465  et('vis_paramete
+00018e40: 7273 2729 0a20 2020 2020 2020 2069 6620  rs').        if 
+00018e50: 7669 735f 7061 7261 6d65 7465 7273 2069  vis_parameters i
+00018e60: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00018e70: 2020 2020 7765 6967 6874 203d 2030 2e31      weight = 0.1
+00018e80: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00018e90: 2020 2020 2020 2020 2020 2077 6569 6768             weigh
+00018ea0: 7420 3d20 7669 735f 7061 7261 6d65 7465  t = vis_paramete
+00018eb0: 7273 2e67 6574 2827 6465 6e6f 6973 655f  rs.get('denoise_
+00018ec0: 7765 6967 6874 272c 2030 2e31 290a 2020  weight', 0.1).  
+00018ed0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00018ee0: 2069 735f 6e75 6d28 7765 6967 6874 2c20   is_num(weight, 
+00018ef0: 6765 3d30 2e29 3a0a 2020 2020 2020 2020  ge=0.):.        
+00018f00: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+00018f10: 6767 6572 2e77 6172 6e69 6e67 280a 2020  gger.warning(.  
+00018f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f30: 2020 6627 496e 7661 6c69 6420 7765 6967    f'Invalid weig
+00018f40: 6874 2028 7b77 6569 6768 747d 2920 696e  ht ({weight}) in
+00018f50: 205f 706c 6f74 5f65 6467 6573 5f6f 6e65   _plot_edges_one
+00018f60: 5f70 6c61 6e65 2c20 270a 2020 2020 2020  _plane, '.      
+00018f70: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
+00018f80: 2773 6574 2074 6f20 6120 6465 6661 756c  'set to a defaul
+00018f90: 7420 6f66 2030 2e31 2729 0a20 2020 2020  t of 0.1').     
+00018fa0: 2020 2020 2020 2020 2020 2077 6569 6768             weigh
+00018fb0: 7420 3d20 302e 310a 2020 2020 2020 2020  t = 0.1.        
+00018fc0: 6564 6765 7320 3d20 6465 6e6f 6973 655f  edges = denoise_
+00018fd0: 7476 5f63 6861 6d62 6f6c 6c65 2872 6563  tv_chambolle(rec
+00018fe0: 6f6e 5f70 6c61 6e65 2c20 7765 6967 6874  on_plane, weight
+00018ff0: 3d77 6569 6768 7429 0a20 2020 2020 2020  =weight).       
+00019000: 2076 6d61 7820 3d20 6e70 2e6d 6178 2865   vmax = np.max(e
+00019010: 6467 6573 5b30 2c3a 2c3a 5d29 0a20 2020  dges[0,:,:]).   
+00019020: 2020 2020 2076 6d69 6e20 3d20 2d76 6d61       vmin = -vma
+00019030: 780a 2020 2020 2020 2020 6966 2070 6174  x.        if pat
+00019040: 6820 6973 204e 6f6e 653a 0a20 2020 2020  h is None:.     
+00019050: 2020 2020 2020 2070 6174 6820 3d20 7365         path = se
+00019060: 6c66 2e5f 6f75 7470 7574 5f66 6f6c 6465  lf._output_folde
+00019070: 720a 2020 2020 2020 2020 7175 6963 6b5f  r.        quick_
+00019080: 696d 7368 6f77 280a 2020 2020 2020 2020  imshow(.        
+00019090: 2020 2020 6564 6765 735b 302c 3a2c 3a5d      edges[0,:,:]
+000190a0: 2c20 6627 7b74 6974 6c65 7d20 636f 6f6c  , f'{title} cool
+000190b0: 7761 726d 272c 2070 6174 683d 7061 7468  warm', path=path
+000190c0: 2c20 636d 6170 3d27 636f 6f6c 7761 726d  , cmap='coolwarm
+000190d0: 272c 0a20 2020 2020 2020 2020 2020 2073  ',.            s
+000190e0: 6176 655f 6669 673d 7365 6c66 2e5f 7361  ave_fig=self._sa
+000190f0: 7665 5f66 6967 732c 2073 6176 655f 6f6e  ve_figs, save_on
+00019100: 6c79 3d73 656c 662e 5f73 6176 655f 6f6e  ly=self._save_on
+00019110: 6c79 2c0a 2020 2020 2020 2020 2020 2020  ly,.            
+00019120: 626c 6f63 6b3d 7365 6c66 2e5f 626c 6f63  block=self._bloc
+00019130: 6b29 0a20 2020 2020 2020 2071 7569 636b  k).        quick
+00019140: 5f69 6d73 686f 7728 0a20 2020 2020 2020  _imshow(.       
+00019150: 2020 2020 2065 6467 6573 5b30 2c3a 2c3a       edges[0,:,:
+00019160: 5d2c 2066 277b 7469 746c 657d 2067 7261  ], f'{title} gra
+00019170: 7927 2c20 7061 7468 3d70 6174 682c 2063  y', path=path, c
+00019180: 6d61 703d 2767 7261 7927 2c20 766d 696e  map='gray', vmin
+00019190: 3d76 6d69 6e2c 0a20 2020 2020 2020 2020  =vmin,.         
+000191a0: 2020 2076 6d61 783d 766d 6178 2c20 7361     vmax=vmax, sa
+000191b0: 7665 5f66 6967 3d73 656c 662e 5f73 6176  ve_fig=self._sav
+000191c0: 655f 6669 6773 2c20 7361 7665 5f6f 6e6c  e_figs, save_onl
+000191d0: 793d 7365 6c66 2e5f 7361 7665 5f6f 6e6c  y=self._save_onl
+000191e0: 792c 0a20 2020 2020 2020 2020 2020 2062  y,.            b
+000191f0: 6c6f 636b 3d73 656c 662e 5f62 6c6f 636b  lock=self._block
+00019200: 290a 2020 2020 2020 2020 6465 6c20 6564  ).        del ed
+00019210: 6765 730a 0a20 2020 2064 6566 205f 7265  ges..    def _re
+00019220: 636f 6e73 7472 7563 745f 6f6e 655f 746f  construct_one_to
+00019230: 6d6f 5f73 7461 636b 280a 2020 2020 2020  mo_stack(.      
+00019240: 2020 2020 2020 7365 6c66 2c20 746f 6d6f        self, tomo
+00019250: 5f73 7461 636b 2c20 7468 6574 6173 2c20  _stack, thetas, 
+00019260: 6365 6e74 6572 5f6f 6666 7365 7473 3d4e  center_offsets=N
+00019270: 6f6e 652c 206e 756d 5f63 6f72 653d 312c  one, num_core=1,
+00019280: 0a20 2020 2020 2020 2020 2020 2061 6c67  .            alg
+00019290: 6f72 6974 686d 3d27 6772 6964 7265 6327  orithm='gridrec'
+000192a0: 2c20 7365 636f 6e64 6172 795f 6974 6572  , secondary_iter
+000192b0: 733d 302c 2072 656d 6f76 655f 7374 7269  s=0, remove_stri
+000192c0: 7065 5f73 6967 6d61 3d4e 6f6e 652c 0a20  pe_sigma=None,. 
+000192d0: 2020 2020 2020 2020 2020 2072 696e 675f             ring_
+000192e0: 7769 6474 683d 4e6f 6e65 293a 0a20 2020  width=None):.   
+000192f0: 2020 2020 2022 2222 5265 636f 6e73 7472       """Reconstr
+00019300: 7563 7420 6120 7369 6e67 6c65 2074 6f6d  uct a single tom
+00019310: 6f67 7261 7068 7920 7374 6163 6b2e 2222  ography stack.""
+00019320: 220a 2020 2020 2020 2020 2320 5468 6972  ".        # Thir
+00019330: 6420 7061 7274 7920 6d6f 6475 6c65 730a  d party modules.
+00019340: 2020 2020 2020 2020 6672 6f6d 2074 6f6d          from tom
+00019350: 6f70 7920 696d 706f 7274 2028 0a20 2020  opy import (.   
+00019360: 2020 2020 2020 2020 2061 7374 7261 2c0a           astra,.
+00019370: 2020 2020 2020 2020 2020 2020 6d69 7363              misc
+00019380: 2c0a 2020 2020 2020 2020 2020 2020 7072  ,.            pr
+00019390: 6570 2c0a 2020 2020 2020 2020 2020 2020  ep,.            
+000193a0: 7265 636f 6e2c 0a20 2020 2020 2020 2029  recon,.        )
+000193b0: 0a0a 2020 2020 2020 2020 2320 746f 6d6f  ..        # tomo
+000193c0: 5f73 7461 636b 206f 7264 6572 3a20 726f  _stack order: ro
+000193d0: 772c 7468 6574 612c 636f 6c75 6d6e 0a20  w,theta,column. 
+000193e0: 2020 2020 2020 2023 2069 6e70 7574 2074         # input t
+000193f0: 6865 7461 7320 6d75 7374 2062 6520 696e  hetas must be in
+00019400: 2064 6567 7265 6573 0a20 2020 2020 2020   degrees.       
+00019410: 2023 2063 656e 7465 7273 5f6f 6666 7365   # centers_offse
+00019420: 743a 2074 6f6d 6f67 7261 7068 7920 6178  t: tomography ax
+00019430: 6973 2073 6869 6674 2069 6e20 7069 7865  is shift in pixe
+00019440: 6c73 2072 656c 6174 6976 650a 2020 2020  ls relative.    
+00019450: 2020 2020 2320 2020 2020 746f 2063 6f6c      #     to col
+00019460: 756d 6e20 6365 6e74 6572 0a20 2020 2020  umn center.     
+00019470: 2020 2023 2052 5620 7368 6f75 6c64 2077     # RV should w
+00019480: 6520 7265 6d6f 7665 2073 7472 6970 6573  e remove stripes
+00019490: 3f0a 2020 2020 2020 2020 2320 6874 7470  ?.        # http
+000194a0: 733a 2f2f 746f 6d6f 7079 2e72 6561 6474  s://tomopy.readt
+000194b0: 6865 646f 6373 2e69 6f2f 656e 2f6c 6174  hedocs.io/en/lat
+000194c0: 6573 742f 6170 692f 746f 6d6f 7079 2e70  est/api/tomopy.p
+000194d0: 7265 702e 7374 7269 7065 2e68 746d 6c0a  rep.stripe.html.
+000194e0: 2020 2020 2020 2020 2320 5256 2073 686f          # RV sho
+000194f0: 756c 6420 7765 2072 656d 6f76 6520 7269  uld we remove ri
+00019500: 6e67 733f 0a20 2020 2020 2020 2023 2068  ngs?.        # h
+00019510: 7474 7073 3a2f 2f74 6f6d 6f70 792e 7265  ttps://tomopy.re
+00019520: 6164 7468 6564 6f63 732e 696f 2f65 6e2f  adthedocs.io/en/
+00019530: 6c61 7465 7374 2f61 7069 2f74 6f6d 6f70  latest/api/tomop
+00019540: 792e 6d69 7363 2e63 6f72 722e 6874 6d6c  y.misc.corr.html
+00019550: 0a20 2020 2020 2020 2023 2052 5620 6164  .        # RV ad
+00019560: 6420 616e 206f 7074 696f 6e20 746f 2064  d an option to d
+00019570: 6f20 2865 7874 7261 2920 7365 636f 6e64  o (extra) second
+00019580: 6172 7920 6974 6572 6174 696f 6e73 206c  ary iterations l
+00019590: 6174 6572 206f 720a 2020 2020 2020 2020  ater or.        
+000195a0: 2320 2020 2020 746f 2064 6f20 736f 6d65  #     to do some
+000195b0: 2073 6f72 7420 6f66 2063 6f6e 7665 7267   sort of converg
+000195c0: 656e 6365 2074 6573 743f 0a20 2020 2020  ence test?.     
+000195d0: 2020 2069 6620 6365 6e74 6572 5f6f 6666     if center_off
+000195e0: 7365 7473 2069 7320 4e6f 6e65 3a0a 2020  sets is None:.  
+000195f0: 2020 2020 2020 2020 2020 6365 6e74 6572            center
+00019600: 7320 3d20 6e70 2e7a 6572 6f73 2828 746f  s = np.zeros((to
+00019610: 6d6f 5f73 7461 636b 2e73 6861 7065 5b30  mo_stack.shape[0
+00019620: 5d29 290a 2020 2020 2020 2020 656c 6966  ])).        elif
+00019630: 206c 656e 2863 656e 7465 725f 6f66 6673   len(center_offs
+00019640: 6574 7329 203d 3d20 323a 0a20 2020 2020  ets) == 2:.     
+00019650: 2020 2020 2020 2063 656e 7465 7273 203d         centers =
+00019660: 206e 702e 6c69 6e73 7061 6365 280a 2020   np.linspace(.  
+00019670: 2020 2020 2020 2020 2020 2020 2020 6365                ce
+00019680: 6e74 6572 5f6f 6666 7365 7473 5b30 5d2c  nter_offsets[0],
+00019690: 2063 656e 7465 725f 6f66 6673 6574 735b   center_offsets[
+000196a0: 315d 2c20 746f 6d6f 5f73 7461 636b 2e73  1], tomo_stack.s
+000196b0: 6861 7065 5b30 5d29 0a20 2020 2020 2020  hape[0]).       
+000196c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000196d0: 2020 2069 6620 6365 6e74 6572 5f6f 6666     if center_off
+000196e0: 7365 7473 2e73 697a 6520 213d 2074 6f6d  sets.size != tom
+000196f0: 6f5f 7374 6163 6b2e 7368 6170 655b 305d  o_stack.shape[0]
+00019700: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00019710: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
+00019720: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00019730: 2020 2020 2020 2020 2020 2763 656e 7465            'cente
+00019740: 725f 6f66 6673 6574 7320 6469 6d65 6e73  r_offsets dimens
+00019750: 696f 6e20 6d69 736d 6174 6368 2069 6e20  ion mismatch in 
+00019760: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00019770: 2020 2020 2020 2b20 2772 6563 6f6e 7374        + 'reconst
+00019780: 7275 6374 5f6f 6e65 5f74 6f6d 6f5f 7374  ruct_one_tomo_st
+00019790: 6163 6b27 290a 2020 2020 2020 2020 2020  ack').          
+000197a0: 2020 6365 6e74 6572 7320 3d20 6365 6e74    centers = cent
+000197b0: 6572 5f6f 6666 7365 7473 0a20 2020 2020  er_offsets.     
+000197c0: 2020 2063 656e 7465 7273 202b 3d20 746f     centers += to
+000197d0: 6d6f 5f73 7461 636b 2e73 6861 7065 5b32  mo_stack.shape[2
+000197e0: 5d2f 320a 0a20 2020 2020 2020 2023 2052  ]/2..        # R
+000197f0: 656d 6f76 6520 686f 7269 7a6f 6e74 616c  emove horizontal
+00019800: 2073 7472 6970 650a 2020 2020 2020 2020   stripe.        
+00019810: 6966 2072 656d 6f76 655f 7374 7269 7065  if remove_stripe
+00019820: 5f73 6967 6d61 2069 7320 6e6f 7420 4e6f  _sigma is not No
+00019830: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00019840: 6966 206e 756d 5f63 6f72 6520 3e20 4e55  if num_core > NU
+00019850: 4d5f 434f 5245 5f54 4f4d 4f50 595f 4c49  M_CORE_TOMOPY_LI
+00019860: 4d49 543a 0a20 2020 2020 2020 2020 2020  MIT:.           
+00019870: 2020 2020 2074 6f6d 6f5f 7374 6163 6b20       tomo_stack 
+00019880: 3d20 7072 6570 2e73 7472 6970 652e 7265  = prep.stripe.re
+00019890: 6d6f 7665 5f73 7472 6970 655f 6677 280a  move_stripe_fw(.
+000198a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000198b0: 2020 2020 746f 6d6f 5f73 7461 636b 2c20      tomo_stack, 
+000198c0: 7369 676d 613d 7265 6d6f 7665 5f73 7472  sigma=remove_str
+000198d0: 6970 655f 7369 676d 612c 0a20 2020 2020  ipe_sigma,.     
+000198e0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000198f0: 636f 7265 3d4e 554d 5f43 4f52 455f 544f  core=NUM_CORE_TO
+00019900: 4d4f 5059 5f4c 494d 4954 290a 2020 2020  MOPY_LIMIT).    
+00019910: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00019920: 2020 2020 2020 2020 2020 2020 2020 746f                to
+00019930: 6d6f 5f73 7461 636b 203d 2070 7265 702e  mo_stack = prep.
+00019940: 7374 7269 7065 2e72 656d 6f76 655f 7374  stripe.remove_st
+00019950: 7269 7065 5f66 7728 0a20 2020 2020 2020  ripe_fw(.       
+00019960: 2020 2020 2020 2020 2020 2020 2074 6f6d               tom
+00019970: 6f5f 7374 6163 6b2c 2073 6967 6d61 3d72  o_stack, sigma=r
+00019980: 656d 6f76 655f 7374 7269 7065 5f73 6967  emove_stripe_sig
+00019990: 6d61 2c20 6e63 6f72 653d 6e75 6d5f 636f  ma, ncore=num_co
+000199a0: 7265 290a 0a20 2020 2020 2020 2023 2050  re)..        # P
+000199b0: 6572 666f 726d 2069 6e69 7469 616c 2069  erform initial i
+000199c0: 6d61 6765 2072 6563 6f6e 7374 7275 6374  mage reconstruct
+000199d0: 696f 6e0a 2020 2020 2020 2020 7365 6c66  ion.        self
+000199e0: 2e5f 6c6f 6767 6572 2e64 6562 7567 2827  ._logger.debug('
+000199f0: 5065 7266 6f72 6d69 6e67 2069 6e69 7469  Performing initi
+00019a00: 616c 2069 6d61 6765 2072 6563 6f6e 7374  al image reconst
+00019a10: 7275 6374 696f 6e27 290a 2020 2020 2020  ruction').      
+00019a20: 2020 7430 203d 2074 696d 6528 290a 2020    t0 = time().  
+00019a30: 2020 2020 2020 746f 6d6f 5f72 6563 6f6e        tomo_recon
+00019a40: 5f73 7461 636b 203d 2072 6563 6f6e 280a  _stack = recon(.
+00019a50: 2020 2020 2020 2020 2020 2020 746f 6d6f              tomo
+00019a60: 5f73 7461 636b 2c20 6e70 2e72 6164 6961  _stack, np.radia
+00019a70: 6e73 2874 6865 7461 7329 2c20 6365 6e74  ns(thetas), cent
+00019a80: 6572 732c 2073 696e 6f67 7261 6d5f 6f72  ers, sinogram_or
+00019a90: 6465 723d 5472 7565 2c0a 2020 2020 2020  der=True,.      
+00019aa0: 2020 2020 2020 616c 676f 7269 7468 6d3d        algorithm=
+00019ab0: 616c 676f 7269 7468 6d2c 206e 636f 7265  algorithm, ncore
+00019ac0: 3d6e 756d 5f63 6f72 6529 0a20 2020 2020  =num_core).     
+00019ad0: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
+00019ae0: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
+00019af0: 2020 6627 5065 7266 6f72 6d69 6e67 2069    f'Performing i
+00019b00: 6e69 7469 616c 2069 6d61 6765 2072 6563  nitial image rec
+00019b10: 6f6e 7374 7275 6374 696f 6e20 746f 6f6b  onstruction took
+00019b20: 207b 7469 6d65 2829 2d74 303a 2e32 667d   {time()-t0:.2f}
+00019b30: 2027 0a20 2020 2020 2020 2020 2020 202b   '.            +
+00019b40: 2027 7365 636f 6e64 7327 290a 0a20 2020   'seconds')..   
+00019b50: 2020 2020 2023 2052 756e 206f 7074 696f       # Run optio
+00019b60: 6e61 6c20 7365 636f 6e64 6172 7920 6974  nal secondary it
+00019b70: 6572 6174 696f 6e73 0a20 2020 2020 2020  erations.       
+00019b80: 2069 6620 7365 636f 6e64 6172 795f 6974   if secondary_it
+00019b90: 6572 7320 3e20 303a 0a20 2020 2020 2020  ers > 0:.       
+00019ba0: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
+00019bb0: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
+00019bc0: 2020 2020 2020 2020 2027 5275 6e6e 696e           'Runnin
+00019bd0: 6720 7b73 6563 6f6e 6461 7279 5f69 7465  g {secondary_ite
+00019be0: 7273 7d20 7365 636f 6e64 6172 7920 6974  rs} secondary it
+00019bf0: 6572 6174 696f 6e73 2729 0a23 2020 2020  erations').#    
+00019c00: 2020 2020 2020 2020 6f70 7469 6f6e 7320          options 
+00019c10: 3d20 7b0a 2320 2020 2020 2020 2020 2020  = {.#           
+00019c20: 2020 2020 2027 6d65 7468 6f64 273a 2027       'method': '
+00019c30: 5349 5254 5f43 5544 4127 2c0a 2320 2020  SIRT_CUDA',.#   
+00019c40: 2020 2020 2020 2020 2020 2020 2027 7072               'pr
+00019c50: 6f6a 5f74 7970 6527 3a20 2763 7564 6127  oj_type': 'cuda'
+00019c60: 2c0a 2320 2020 2020 2020 2020 2020 2020  ,.#             
+00019c70: 2020 2027 6e75 6d5f 6974 6572 273a 2073     'num_iter': s
+00019c80: 6563 6f6e 6461 7279 5f69 7465 7273 0a23  econdary_iters.#
+00019c90: 2020 2020 2020 2020 2020 2020 7d0a 2320              }.# 
+00019ca0: 5256 2064 6f65 736e 2774 2077 6f72 6b20  RV doesn't work 
+00019cb0: 666f 7220 6d65 3a0a 2320 2245 7272 6f72  for me:.# "Error
+00019cc0: 3a20 4355 4441 2065 7272 6f72 2038 3033  : CUDA error 803
+00019cd0: 3a20 7379 7374 656d 2068 6173 2075 6e73  : system has uns
+00019ce0: 7570 706f 7274 6564 2064 6973 706c 6179  upported display
+00019cf0: 2064 7269 7665 722f 6375 6461 2064 7269   driver/cuda dri
+00019d00: 7665 720a 2320 2020 2020 636f 6d62 696e  ver.#     combin
+00019d10: 6174 696f 6e2e 220a 2320 2020 2020 2020  ation.".#       
+00019d20: 2020 2020 206f 7074 696f 6e73 203d 207b       options = {
+00019d30: 0a23 2020 2020 2020 2020 2020 2020 2020  .#              
+00019d40: 2020 276d 6574 686f 6427 3a20 2753 4952    'method': 'SIR
+00019d50: 5427 2c0a 2320 2020 2020 2020 2020 2020  T',.#           
+00019d60: 2020 2020 2027 7072 6f6a 5f74 7970 6527       'proj_type'
+00019d70: 3a20 276c 696e 6561 7227 2c0a 2320 2020  : 'linear',.#   
+00019d80: 2020 2020 2020 2020 2020 2020 2027 4d69               'Mi
+00019d90: 6e43 6f6e 7374 7261 696e 7427 3a20 302c  nConstraint': 0,
+00019da0: 0a23 2020 2020 2020 2020 2020 2020 2020  .#              
+00019db0: 2020 276e 756d 5f69 7465 7227 3a73 6563    'num_iter':sec
+00019dc0: 6f6e 6461 7279 5f69 7465 7273 0a23 2020  ondary_iters.#  
+00019dd0: 2020 2020 2020 2020 2020 7d0a 2320 5349            }.# SI
+00019de0: 5254 2064 6964 206e 6f74 2066 696e 6973  RT did not finis
+00019df0: 6820 7768 696c 6520 7275 6e6e 696e 6720  h while running 
+00019e00: 6f76 6572 6e69 6768 740a 2320 2020 2020  overnight.#     
+00019e10: 2020 2020 2020 206f 7074 696f 6e73 203d         options =
+00019e20: 207b 0a23 2020 2020 2020 2020 2020 2020   {.#            
+00019e30: 2020 2020 276d 6574 686f 6427 3a20 2753      'method': 'S
+00019e40: 4152 5427 2c0a 2320 2020 2020 2020 2020  ART',.#         
+00019e50: 2020 2020 2020 2027 7072 6f6a 5f74 7970         'proj_typ
+00019e60: 6527 3a20 276c 696e 6561 7227 2c0a 2320  e': 'linear',.# 
+00019e70: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00019e80: 6e75 6d5f 6974 6572 273a 7365 636f 6e64  num_iter':second
+00019e90: 6172 795f 6974 6572 730a 2320 2020 2020  ary_iters.#     
+00019ea0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00019eb0: 2020 2020 206f 7074 696f 6e73 203d 207b       options = {
+00019ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019ed0: 2027 6d65 7468 6f64 273a 2027 5341 5254   'method': 'SART
+00019ee0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00019ef0: 2020 2027 7072 6f6a 5f74 7970 6527 3a20     'proj_type': 
+00019f00: 276c 696e 6561 7227 2c0a 2020 2020 2020  'linear',.      
+00019f10: 2020 2020 2020 2020 2020 274d 696e 436f            'MinCo
+00019f20: 6e73 7472 6169 6e74 273a 2030 2c0a 2020  nstraint': 0,.  
+00019f30: 2020 2020 2020 2020 2020 2020 2020 276e                'n
+00019f40: 756d 5f69 7465 7227 3a20 7365 636f 6e64  um_iter': second
+00019f50: 6172 795f 6974 6572 732c 0a20 2020 2020  ary_iters,.     
+00019f60: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00019f70: 2020 2020 2074 3020 3d20 7469 6d65 2829       t0 = time()
+00019f80: 0a20 2020 2020 2020 2020 2020 2074 6f6d  .            tom
+00019f90: 6f5f 7265 636f 6e5f 7374 6163 6b20 3d20  o_recon_stack = 
+00019fa0: 7265 636f 6e28 0a20 2020 2020 2020 2020  recon(.         
+00019fb0: 2020 2020 2020 2074 6f6d 6f5f 7374 6163         tomo_stac
+00019fc0: 6b2c 206e 702e 7261 6469 616e 7328 7468  k, np.radians(th
+00019fd0: 6574 6173 292c 2063 656e 7465 7273 2c0a  etas), centers,.
+00019fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ff0: 696e 6974 5f72 6563 6f6e 3d74 6f6d 6f5f  init_recon=tomo_
+0001a000: 7265 636f 6e5f 7374 6163 6b2c 206f 7074  recon_stack, opt
+0001a010: 696f 6e73 3d6f 7074 696f 6e73 2c0a 2020  ions=options,.  
+0001a020: 2020 2020 2020 2020 2020 2020 2020 7369                si
+0001a030: 6e6f 6772 616d 5f6f 7264 6572 3d54 7275  nogram_order=Tru
+0001a040: 652c 2061 6c67 6f72 6974 686d 3d61 7374  e, algorithm=ast
+0001a050: 7261 2c20 6e63 6f72 653d 6e75 6d5f 636f  ra, ncore=num_co
+0001a060: 7265 290a 2020 2020 2020 2020 2020 2020  re).            
+0001a070: 7365 6c66 2e5f 6c6f 6767 6572 2e69 6e66  self._logger.inf
+0001a080: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
+0001a090: 2020 2066 2750 6572 666f 726d 696e 6720     f'Performing 
+0001a0a0: 7365 636f 6e64 6172 7920 6974 6572 6174  secondary iterat
+0001a0b0: 696f 6e73 2074 6f6f 6b20 7b74 696d 6528  ions took {time(
+0001a0c0: 292d 7430 3a2e 3266 7d20 270a 2020 2020  )-t0:.2f} '.    
+0001a0d0: 2020 2020 2020 2020 2020 2020 2b20 2773              + 's
+0001a0e0: 6563 6f6e 6473 2729 0a0a 2020 2020 2020  econds')..      
+0001a0f0: 2020 2320 5265 6d6f 7665 2072 696e 6720    # Remove ring 
+0001a100: 6172 7469 6661 6374 730a 2020 2020 2020  artifacts.      
+0001a110: 2020 6966 2072 696e 675f 7769 6474 6820    if ring_width 
+0001a120: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0001a130: 2020 2020 2020 2020 206d 6973 632e 636f           misc.co
+0001a140: 7272 2e72 656d 6f76 655f 7269 6e67 280a  rr.remove_ring(.
+0001a150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a160: 746f 6d6f 5f72 6563 6f6e 5f73 7461 636b  tomo_recon_stack
+0001a170: 2c20 7277 6964 7468 3d72 696e 675f 7769  , rwidth=ring_wi
+0001a180: 6474 682c 206f 7574 3d74 6f6d 6f5f 7265  dth, out=tomo_re
+0001a190: 636f 6e5f 7374 6163 6b2c 0a20 2020 2020  con_stack,.     
+0001a1a0: 2020 2020 2020 2020 2020 206e 636f 7265             ncore
+0001a1b0: 3d6e 756d 5f63 6f72 6529 0a0a 2020 2020  =num_core)..    
+0001a1c0: 2020 2020 7265 7475 726e 2074 6f6d 6f5f      return tomo_
+0001a1d0: 7265 636f 6e5f 7374 6163 6b0a 0a20 2020  recon_stack..   
+0001a1e0: 2064 6566 205f 7265 7369 7a65 5f72 6563   def _resize_rec
+0001a1f0: 6f6e 7374 7275 6374 6564 5f64 6174 6128  onstructed_data(
+0001a200: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001a210: 662c 2064 6174 612c 2078 5f62 6f75 6e64  f, data, x_bound
+0001a220: 733d 4e6f 6e65 2c20 795f 626f 756e 6473  s=None, y_bounds
+0001a230: 3d4e 6f6e 652c 207a 5f62 6f75 6e64 733d  =None, z_bounds=
+0001a240: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0001a250: 2020 7a5f 6f6e 6c79 3d46 616c 7365 293a    z_only=False):
+0001a260: 0a20 2020 2020 2020 2022 2222 5265 7369  .        """Resi
+0001a270: 7a65 2074 6865 2072 6563 6f6e 7374 7275  ze the reconstru
+0001a280: 6374 6564 2074 6f6d 6f67 7261 7068 7920  cted tomography 
+0001a290: 6461 7461 2e22 2222 0a20 2020 2020 2020  data.""".       
+0001a2a0: 2023 2044 6174 6120 6f72 6465 723a 2072   # Data order: r
+0001a2b0: 6f77 287a 292c 782c 7920 6f72 2073 7461  ow(z),x,y or sta
+0001a2c0: 636b 2c72 6f77 287a 292c 782c 790a 2020  ck,row(z),x,y.  
+0001a2d0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+0001a2e0: 6e63 6528 6461 7461 2c20 6c69 7374 293a  nce(data, list):
+0001a2f0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0001a300: 2073 7461 636b 2069 6e20 6461 7461 3a0a   stack in data:.
+0001a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a320: 6173 7365 7274 2073 7461 636b 2e6e 6469  assert stack.ndi
+0001a330: 6d20 3d3d 2033 0a20 2020 2020 2020 2020  m == 3.         
+0001a340: 2020 206e 756d 5f74 6f6d 6f5f 7374 6163     num_tomo_stac
+0001a350: 6b73 203d 206c 656e 2864 6174 6129 0a20  ks = len(data). 
+0001a360: 2020 2020 2020 2020 2020 2074 6f6d 6f5f             tomo_
+0001a370: 7265 636f 6e5f 7374 6163 6b73 203d 2064  recon_stacks = d
+0001a380: 6174 610a 2020 2020 2020 2020 656c 7365  ata.        else
+0001a390: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+0001a3a0: 7365 7274 2064 6174 612e 6e64 696d 203d  sert data.ndim =
+0001a3b0: 3d20 330a 2020 2020 2020 2020 2020 2020  = 3.            
+0001a3c0: 6e75 6d5f 746f 6d6f 5f73 7461 636b 7320  num_tomo_stacks 
+0001a3d0: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+0001a3e0: 746f 6d6f 5f72 6563 6f6e 5f73 7461 636b  tomo_recon_stack
+0001a3f0: 7320 3d20 5b64 6174 615d 0a0a 2020 2020  s = [data]..    
+0001a400: 2020 2020 6966 206e 6f74 207a 5f6f 6e6c      if not z_onl
+0001a410: 7920 616e 6420 785f 626f 756e 6473 2069  y and x_bounds i
+0001a420: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001a430: 2020 2020 2320 5365 6c65 6374 696e 6720      # Selecting 
+0001a440: 7820 626f 756e 6473 2028 696e 2079 7a2d  x bounds (in yz-
+0001a450: 706c 616e 6529 0a20 2020 2020 2020 2020  plane).         
+0001a460: 2020 2074 6f6d 6f73 756d 203d 2030 0a20     tomosum = 0. 
+0001a470: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0001a480: 2069 6e20 7261 6e67 6528 6e75 6d5f 746f   in range(num_to
+0001a490: 6d6f 5f73 7461 636b 7329 3a0a 2020 2020  mo_stacks):.    
+0001a4a0: 2020 2020 2020 2020 2020 2020 746f 6d6f              tomo
+0001a4b0: 7375 6d20 3d20 746f 6d6f 7375 6d20 2b20  sum = tomosum + 
+0001a4c0: 6e70 2e73 756d 2874 6f6d 6f5f 7265 636f  np.sum(tomo_reco
+0001a4d0: 6e5f 7374 6163 6b73 5b69 5d2c 2061 7869  n_stacks[i], axi
+0001a4e0: 733d 2830 2c32 2929 0a20 2020 2020 2020  s=(0,2)).       
+0001a4f0: 2020 2020 2073 656c 6563 745f 785f 626f       select_x_bo
+0001a500: 756e 6473 203d 2069 6e70 7574 5f79 6573  unds = input_yes
+0001a510: 6e6f 280a 2020 2020 2020 2020 2020 2020  no(.            
+0001a520: 2020 2020 275c 6e44 6f20 796f 7520 7761      '\nDo you wa
+0001a530: 6e74 2074 6f20 6368 616e 6765 2074 6865  nt to change the
+0001a540: 2069 6d61 6765 2078 2d62 6f75 6e64 7320   image x-bounds 
+0001a550: 2879 2f6e 293f 272c 2027 7927 290a 2020  (y/n)?', 'y').  
+0001a560: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+0001a570: 2073 656c 6563 745f 785f 626f 756e 6473   select_x_bounds
+0001a580: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001a590: 2020 785f 626f 756e 6473 203d 204e 6f6e    x_bounds = Non
+0001a5a0: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
+0001a5b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001a5c0: 2020 2020 6163 6365 7074 203d 2046 616c      accept = Fal
+0001a5d0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+0001a5e0: 2020 2069 6e64 6578 5f72 616e 6765 7320     index_ranges 
+0001a5f0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
+0001a600: 2020 2020 2020 2077 6869 6c65 206e 6f74         while not
+0001a610: 2061 6363 6570 743a 0a20 2020 2020 2020   accept:.       
+0001a620: 2020 2020 2020 2020 2020 2020 205f 2c20               _, 
+0001a630: 785f 626f 756e 6473 203d 2064 7261 775f  x_bounds = draw_
+0001a640: 6d61 736b 5f31 6428 0a20 2020 2020 2020  mask_1d(.       
+0001a650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a660: 2074 6f6d 6f73 756d 2c20 6375 7272 656e   tomosum, curren
+0001a670: 745f 696e 6465 785f 7261 6e67 6573 3d69  t_index_ranges=i
+0001a680: 6e64 6578 5f72 616e 6765 732c 0a20 2020  ndex_ranges,.   
+0001a690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a6a0: 2020 2020 2074 6974 6c65 3d27 7365 6c65       title='sele
+0001a6b0: 6374 2078 2064 6174 6120 7261 6e67 6527  ct x data range'
+0001a6c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001a6d0: 2020 2020 2020 2020 2020 796c 6162 656c            ylabel
+0001a6e0: 3d27 7375 6d20 797a 2729 0a20 2020 2020  ='sum yz').     
+0001a6f0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0001a700: 6869 6c65 206c 656e 2878 5f62 6f75 6e64  hile len(x_bound
+0001a710: 7329 2021 3d20 313a 0a20 2020 2020 2020  s) != 1:.       
+0001a720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a730: 2070 7269 6e74 2827 506c 6561 7365 2073   print('Please s
+0001a740: 656c 6563 7420 6578 6163 746c 7920 6f6e  elect exactly on
+0001a750: 6520 636f 6e74 696e 756f 7573 2072 616e  e continuous ran
+0001a760: 6765 2729 0a20 2020 2020 2020 2020 2020  ge').           
+0001a770: 2020 2020 2020 2020 2020 2020 205f 2c20               _, 
+0001a780: 785f 626f 756e 6473 203d 2064 7261 775f  x_bounds = draw_
+0001a790: 6d61 736b 5f31 6428 0a20 2020 2020 2020  mask_1d(.       
+0001a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a7b0: 2020 2020 2074 6f6d 6f73 756d 2c20 7469       tomosum, ti
+0001a7c0: 746c 653d 2773 656c 6563 7420 7820 6461  tle='select x da
+0001a7d0: 7461 2072 616e 6765 272c 0a20 2020 2020  ta range',.     
+0001a7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a7f0: 2020 2020 2020 2079 6c61 6265 6c3d 2773         ylabel='s
+0001a800: 756d 2079 7a27 290a 2020 2020 2020 2020  um yz').        
+0001a810: 2020 2020 2020 2020 2020 2020 785f 626f              x_bo
+0001a820: 756e 6473 203d 2078 5f62 6f75 6e64 735b  unds = x_bounds[
+0001a830: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
+0001a840: 2020 2020 2020 2061 6363 6570 7420 3d20         accept = 
+0001a850: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+0001a860: 2073 656c 662e 5f6c 6f67 6765 722e 6465   self._logger.de
+0001a870: 6275 6728 6627 785f 626f 756e 6473 203d  bug(f'x_bounds =
+0001a880: 207b 785f 626f 756e 6473 7d27 290a 0a20   {x_bounds}').. 
+0001a890: 2020 2020 2020 2069 6620 6e6f 7420 7a5f         if not z_
+0001a8a0: 6f6e 6c79 2061 6e64 2079 5f62 6f75 6e64  only and y_bound
+0001a8b0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0001a8c0: 2020 2020 2020 2023 2053 656c 6563 7469         # Selecti
+0001a8d0: 6e67 2079 2062 6f75 6e64 7320 2869 6e20  ng y bounds (in 
+0001a8e0: 787a 2d70 6c61 6e65 290a 2020 2020 2020  xz-plane).      
+0001a8f0: 2020 2020 2020 746f 6d6f 7375 6d20 3d20        tomosum = 
+0001a900: 300a 2020 2020 2020 2020 2020 2020 666f  0.            fo
+0001a910: 7220 6920 696e 2072 616e 6765 286e 756d  r i in range(num
+0001a920: 5f74 6f6d 6f5f 7374 6163 6b73 293a 0a20  _tomo_stacks):. 
+0001a930: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0001a940: 6f6d 6f73 756d 203d 2074 6f6d 6f73 756d  omosum = tomosum
+0001a950: 202b 206e 702e 7375 6d28 746f 6d6f 5f72   + np.sum(tomo_r
+0001a960: 6563 6f6e 5f73 7461 636b 735b 695d 2c20  econ_stacks[i], 
+0001a970: 6178 6973 3d28 302c 3129 290a 2020 2020  axis=(0,1)).    
+0001a980: 2020 2020 2020 2020 7365 6c65 6374 5f79          select_y
+0001a990: 5f62 6f75 6e64 7320 3d20 696e 7075 745f  _bounds = input_
+0001a9a0: 7965 736e 6f28 0a20 2020 2020 2020 2020  yesno(.         
+0001a9b0: 2020 2020 2020 2027 5c6e 446f 2079 6f75         '\nDo you
+0001a9c0: 2077 616e 7420 746f 2063 6861 6e67 6520   want to change 
+0001a9d0: 7468 6520 696d 6167 6520 792d 626f 756e  the image y-boun
+0001a9e0: 6473 2028 792f 6e29 3f27 2c20 2779 2729  ds (y/n)?', 'y')
+0001a9f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001aa00: 6e6f 7420 7365 6c65 6374 5f79 5f62 6f75  not select_y_bou
+0001aa10: 6e64 733a 0a20 2020 2020 2020 2020 2020  nds:.           
+0001aa20: 2020 2020 2079 5f62 6f75 6e64 7320 3d20       y_bounds = 
+0001aa30: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0001aa40: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001aa50: 2020 2020 2020 2061 6363 6570 7420 3d20         accept = 
+0001aa60: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+0001aa70: 2020 2020 2020 696e 6465 785f 7261 6e67        index_rang
+0001aa80: 6573 203d 204e 6f6e 650a 2020 2020 2020  es = None.      
+0001aa90: 2020 2020 2020 2020 2020 7768 696c 6520            while 
+0001aaa0: 6e6f 7420 6163 6365 7074 3a0a 2020 2020  not accept:.    
+0001aab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aac0: 5f2c 2079 5f62 6f75 6e64 7320 3d20 6472  _, y_bounds = dr
+0001aad0: 6177 5f6d 6173 6b5f 3164 280a 2020 2020  aw_mask_1d(.    
+0001aae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aaf0: 2020 2020 746f 6d6f 7375 6d2c 2063 7572      tomosum, cur
+0001ab00: 7265 6e74 5f69 6e64 6578 5f72 616e 6765  rent_index_range
+0001ab10: 733d 696e 6465 785f 7261 6e67 6573 2c0a  s=index_ranges,.
+0001ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab30: 2020 2020 2020 2020 7469 746c 653d 2773          title='s
+0001ab40: 656c 6563 7420 7820 6461 7461 2072 616e  elect x data ran
+0001ab50: 6765 272c 0a20 2020 2020 2020 2020 2020  ge',.           
+0001ab60: 2020 2020 2020 2020 2020 2020 2079 6c61               yla
+0001ab70: 6265 6c3d 2773 756d 2078 7a27 290a 2020  bel='sum xz').  
+0001ab80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab90: 2020 7768 696c 6520 6c65 6e28 795f 626f    while len(y_bo
+0001aba0: 756e 6473 2920 213d 2031 3a0a 2020 2020  unds) != 1:.    
+0001abb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abc0: 2020 2020 7072 696e 7428 2750 6c65 6173      print('Pleas
+0001abd0: 6520 7365 6c65 6374 2065 7861 6374 6c79  e select exactly
+0001abe0: 206f 6e65 2063 6f6e 7469 6e75 6f75 7320   one continuous 
+0001abf0: 7261 6e67 6527 290a 2020 2020 2020 2020  range').        
+0001ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac10: 5f2c 2079 5f62 6f75 6e64 7320 3d20 6472  _, y_bounds = dr
+0001ac20: 6177 5f6d 6173 6b5f 3164 280a 2020 2020  aw_mask_1d(.    
+0001ac30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac40: 2020 2020 2020 2020 746f 6d6f 7375 6d2c          tomosum,
+0001ac50: 2074 6974 6c65 3d27 7365 6c65 6374 2078   title='select x
+0001ac60: 2064 6174 6120 7261 6e67 6527 2c0a 2020   data range',.  
+0001ac70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac80: 2020 2020 2020 2020 2020 796c 6162 656c            ylabel
+0001ac90: 3d27 7375 6d20 787a 2729 0a20 2020 2020  ='sum xz').     
+0001aca0: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+0001acb0: 5f62 6f75 6e64 7320 3d20 795f 626f 756e  _bounds = y_boun
+0001acc0: 6473 5b30 5d0a 2020 2020 2020 2020 2020  ds[0].          
+0001acd0: 2020 2020 2020 2020 2020 6163 6365 7074            accept
+0001ace0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+0001acf0: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+0001ad00: 2e64 6562 7567 2866 2779 5f62 6f75 6e64  .debug(f'y_bound
+0001ad10: 7320 3d20 7b79 5f62 6f75 6e64 737d 2729  s = {y_bounds}')
+0001ad20: 0a0a 2020 2020 2020 2020 2320 5365 6c65  ..        # Sele
+0001ad30: 6374 696e 6720 7a20 626f 756e 6473 2028  cting z bounds (
+0001ad40: 696e 2078 792d 706c 616e 6529 0a20 2020  in xy-plane).   
+0001ad50: 2020 2020 2023 2028 6f6e 6c79 2076 616c       # (only val
+0001ad60: 6964 2066 6f72 2061 2073 696e 676c 6520  id for a single 
+0001ad70: 696d 6167 6520 7374 6163 6b29 0a20 2020  image stack).   
+0001ad80: 2020 2020 2069 6620 7a5f 626f 756e 6473       if z_bounds
+0001ad90: 2069 7320 4e6f 6e65 2061 6e64 206e 756d   is None and num
+0001ada0: 5f74 6f6d 6f5f 7374 6163 6b73 2021 3d20  _tomo_stacks != 
+0001adb0: 313a 0a20 2020 2020 2020 2020 2020 2074  1:.            t
+0001adc0: 6f6d 6f73 756d 203d 2030 0a20 2020 2020  omosum = 0.     
+0001add0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+0001ade0: 7261 6e67 6528 6e75 6d5f 746f 6d6f 5f73  range(num_tomo_s
+0001adf0: 7461 636b 7329 3a0a 2020 2020 2020 2020  tacks):.        
+0001ae00: 2020 2020 2020 2020 746f 6d6f 7375 6d20          tomosum 
+0001ae10: 3d20 746f 6d6f 7375 6d20 2b20 6e70 2e73  = tomosum + np.s
+0001ae20: 756d 2874 6f6d 6f5f 7265 636f 6e5f 7374  um(tomo_recon_st
+0001ae30: 6163 6b73 5b69 5d2c 2061 7869 733d 2831  acks[i], axis=(1
+0001ae40: 2c32 2929 0a20 2020 2020 2020 2020 2020  ,2)).           
+0001ae50: 2073 656c 6563 745f 7a5f 626f 756e 6473   select_z_bounds
+0001ae60: 203d 2069 6e70 7574 5f79 6573 6e6f 280a   = input_yesno(.
+0001ae70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ae80: 2744 6f20 796f 7520 7761 6e74 2074 6f20  'Do you want to 
+0001ae90: 6368 616e 6765 2074 6865 2069 6d61 6765  change the image
+0001aea0: 207a 2d62 6f75 6e64 7320 2879 2f6e 293f   z-bounds (y/n)?
+0001aeb0: 272c 2027 6e27 290a 2020 2020 2020 2020  ', 'n').        
+0001aec0: 2020 2020 6966 206e 6f74 2073 656c 6563      if not selec
+0001aed0: 745f 7a5f 626f 756e 6473 3a0a 2020 2020  t_z_bounds:.    
+0001aee0: 2020 2020 2020 2020 2020 2020 7a5f 626f              z_bo
+0001aef0: 756e 6473 203d 204e 6f6e 650a 2020 2020  unds = None.    
+0001af00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001af10: 2020 2020 2020 2020 2020 2020 2020 6163                ac
+0001af20: 6365 7074 203d 2046 616c 7365 0a20 2020  cept = False.   
+0001af30: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+0001af40: 6578 5f72 616e 6765 7320 3d20 4e6f 6e65  ex_ranges = None
+0001af50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001af60: 2077 6869 6c65 206e 6f74 2061 6363 6570   while not accep
+0001af70: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+0001af80: 2020 2020 2020 205f 2c20 7a5f 626f 756e         _, z_boun
+0001af90: 6473 203d 2064 7261 775f 6d61 736b 5f31  ds = draw_mask_1
+0001afa0: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+0001afb0: 2020 2020 2020 2020 2020 2074 6f6d 6f73             tomos
+0001afc0: 756d 2c20 6375 7272 656e 745f 696e 6465  um, current_inde
+0001afd0: 785f 7261 6e67 6573 3d69 6e64 6578 5f72  x_ranges=index_r
+0001afe0: 616e 6765 732c 0a20 2020 2020 2020 2020  anges,.         
+0001aff0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0001b000: 6974 6c65 3d27 7365 6c65 6374 2078 2064  itle='select x d
+0001b010: 6174 6120 7261 6e67 6527 2c0a 2020 2020  ata range',.    
+0001b020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b030: 2020 2020 796c 6162 656c 3d27 7375 6d20      ylabel='sum 
+0001b040: 7879 2729 0a20 2020 2020 2020 2020 2020  xy').           
+0001b050: 2020 2020 2020 2020 2077 6869 6c65 206c           while l
+0001b060: 656e 287a 5f62 6f75 6e64 7329 2021 3d20  en(z_bounds) != 
+0001b070: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+0001b080: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0001b090: 2827 506c 6561 7365 2073 656c 6563 7420  ('Please select 
+0001b0a0: 6578 6163 746c 7920 6f6e 6520 636f 6e74  exactly one cont
+0001b0b0: 696e 756f 7573 2072 616e 6765 2729 0a20  inuous range'). 
+0001b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b0d0: 2020 2020 2020 205f 2c20 7a5f 626f 756e         _, z_boun
+0001b0e0: 6473 203d 2064 7261 775f 6d61 736b 5f31  ds = draw_mask_1
+0001b0f0: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+0001b100: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0001b110: 6f6d 6f73 756d 2c20 7469 746c 653d 2773  omosum, title='s
+0001b120: 656c 6563 7420 7820 6461 7461 2072 616e  elect x data ran
+0001b130: 6765 272c 0a20 2020 2020 2020 2020 2020  ge',.           
+0001b140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b150: 2079 6c61 6265 6c3d 2773 756d 2078 7927   ylabel='sum xy'
+0001b160: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001b170: 2020 2020 2020 7a5f 626f 756e 6473 203d        z_bounds =
+0001b180: 207a 5f62 6f75 6e64 735b 305d 0a20 2020   z_bounds[0].   
+0001b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b1a0: 2061 6363 6570 7420 3d20 5472 7565 0a20   accept = True. 
+0001b1b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001b1c0: 5f6c 6f67 6765 722e 6465 6275 6728 6627  _logger.debug(f'
+0001b1d0: 7a5f 626f 756e 6473 203d 207b 7a5f 626f  z_bounds = {z_bo
+0001b1e0: 756e 6473 7d27 290a 0a20 2020 2020 2020  unds}')..       
+0001b1f0: 2072 6574 7572 6e20 785f 626f 756e 6473   return x_bounds
+0001b200: 2c20 795f 626f 756e 6473 2c20 7a5f 626f  , y_bounds, z_bo
+0001b210: 756e 6473 0a0a 0a63 6c61 7373 2054 6f6d  unds...class Tom
+0001b220: 6f53 696d 4669 656c 6450 726f 6365 7373  oSimFieldProcess
+0001b230: 6f72 2850 726f 6365 7373 6f72 293a 0a20  or(Processor):. 
+0001b240: 2020 2022 2222 0a20 2020 2041 2070 726f     """.    A pro
+0001b250: 6365 7373 6f72 2074 6f20 6372 6561 7465  cessor to create
+0001b260: 2061 2073 696d 756c 6174 6564 2074 6f6d   a simulated tom
+0001b270: 6f67 7261 7068 7920 6461 7461 2073 6574  ography data set
+0001b280: 2072 6574 7572 6e69 6e67 2061 0a20 2020   returning a.   
+0001b290: 2060 6e65 7875 7366 6f72 6d61 742e 6e65   `nexusformat.ne
+0001b2a0: 7875 732e 4e58 726f 6f74 6020 6f62 6a65  xus.NXroot` obje
+0001b2b0: 6374 2063 6f6e 7461 696e 696e 6720 7468  ct containing th
+0001b2c0: 6520 7369 6d75 6c61 7465 640a 2020 2020  e simulated.    
+0001b2d0: 746f 6d6f 6772 6170 6879 2064 6574 6563  tomography detec
+0001b2e0: 746f 7220 696d 6167 6573 2e0a 2020 2020  tor images..    
+0001b2f0: 2222 220a 0a20 2020 2064 6566 2070 726f  """..    def pro
+0001b300: 6365 7373 2873 656c 662c 2064 6174 612c  cess(self, data,
+0001b310: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+0001b320: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0001b330: 5072 6f63 6573 7320 7468 6520 696e 7075  Process the inpu
+0001b340: 7420 636f 6e66 6967 7572 6174 696f 6e20  t configuration 
+0001b350: 616e 6420 7265 7475 726e 2061 0a20 2020  and return a.   
+0001b360: 2020 2020 2060 6e65 7875 7366 6f72 6d61       `nexusforma
+0001b370: 742e 6e65 7875 732e 4e58 726f 6f74 6020  t.nexus.NXroot` 
+0001b380: 6f62 6a65 6374 2077 6974 6820 7468 6520  object with the 
+0001b390: 7369 6d75 6c61 7465 640a 2020 2020 2020  simulated.      
+0001b3a0: 2020 746f 6d6f 6772 6170 6879 2064 6574    tomography det
+0001b3b0: 6563 746f 7220 696d 6167 6573 2e0a 0a20  ector images... 
+0001b3c0: 2020 2020 2020 203a 7061 7261 6d20 6461         :param da
+0001b3d0: 7461 3a20 496e 7075 7420 636f 6e66 6967  ta: Input config
+0001b3e0: 7572 6174 696f 6e20 666f 7220 7468 6520  uration for the 
+0001b3f0: 7369 6d75 6c61 7469 6f6e 2e0a 2020 2020  simulation..    
+0001b400: 2020 2020 3a74 7970 6520 6461 7461 3a20      :type data: 
+0001b410: 6c69 7374 5b50 6970 656c 696e 6544 6174  list[PipelineDat
+0001b420: 615d 0a20 2020 2020 2020 203a 7265 7475  a].        :retu
+0001b430: 726e 3a20 5369 6d75 6c61 7465 6420 746f  rn: Simulated to
+0001b440: 6d6f 6772 6170 6869 6320 696d 6167 6573  mographic images
+0001b450: 2e0a 2020 2020 2020 2020 3a72 7479 7065  ..        :rtype
+0001b460: 3a20 6e65 7875 7366 6f72 6d61 742e 6e65  : nexusformat.ne
+0001b470: 7875 732e 4e58 726f 6f74 0a20 2020 2020  xus.NXroot.     
+0001b480: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
+0001b490: 2054 6869 7264 2070 6172 7479 206d 6f64   Third party mod
+0001b4a0: 756c 6573 0a20 2020 2020 2020 2066 726f  ules.        fro
+0001b4b0: 6d20 6e65 7875 7366 6f72 6d61 742e 6e65  m nexusformat.ne
+0001b4c0: 7875 7320 696d 706f 7274 2028 0a20 2020  xus import (.   
+0001b4d0: 2020 2020 2020 2020 204e 5864 6574 6563           NXdetec
+0001b4e0: 746f 722c 0a20 2020 2020 2020 2020 2020  tor,.           
+0001b4f0: 204e 5865 6e74 7279 2c0a 2020 2020 2020   NXentry,.      
+0001b500: 2020 2020 2020 4e58 696e 7374 7275 6d65        NXinstrume
+0001b510: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+0001b520: 4e58 726f 6f74 2c0a 2020 2020 2020 2020  NXroot,.        
+0001b530: 2020 2020 4e58 7361 6d70 6c65 2c0a 2020      NXsample,.  
+0001b540: 2020 2020 2020 2020 2020 4e58 736f 7572            NXsour
+0001b550: 6365 2c0a 2020 2020 2020 2020 290a 0a20  ce,.        ).. 
+0001b560: 2020 2020 2020 2023 2047 6574 2061 6e64         # Get and
+0001b570: 2076 616c 6964 6174 6520 7468 6520 7265   validate the re
+0001b580: 6c65 7661 6e74 2063 6f6e 6669 6775 7261  levant configura
+0001b590: 7469 6f6e 206f 626a 6563 7420 696e 2064  tion object in d
+0001b5a0: 6174 610a 2020 2020 2020 2020 636f 6e66  ata.        conf
+0001b5b0: 6967 203d 2073 656c 662e 6765 745f 636f  ig = self.get_co
+0001b5c0: 6e66 6967 7328 6461 7461 290a 0a20 2020  nfigs(data)..   
+0001b5d0: 2020 2020 2073 7461 7469 6f6e 203d 2063       station = c
+0001b5e0: 6f6e 6669 672e 7374 6174 696f 6e0a 2020  onfig.station.  
+0001b5f0: 2020 2020 2020 7361 6d70 6c65 5f74 7970        sample_typ
+0001b600: 6520 3d20 636f 6e66 6967 2e73 616d 706c  e = config.sampl
+0001b610: 655f 7479 7065 0a20 2020 2020 2020 2073  e_type.        s
+0001b620: 616d 706c 655f 7369 7a65 203d 2063 6f6e  ample_size = con
+0001b630: 6669 672e 7361 6d70 6c65 5f73 697a 650a  fig.sample_size.
+0001b640: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
+0001b650: 616d 706c 655f 7369 7a65 2920 3d3d 2031  ample_size) == 1
+0001b660: 3a0a 2020 2020 2020 2020 2020 2020 7361  :.            sa
+0001b670: 6d70 6c65 5f73 697a 6520 3d20 2873 616d  mple_size = (sam
+0001b680: 706c 655f 7369 7a65 5b30 5d2c 2073 616d  ple_size[0], sam
+0001b690: 706c 655f 7369 7a65 5b30 5d29 0a20 2020  ple_size[0]).   
+0001b6a0: 2020 2020 2077 616c 6c5f 7468 6963 6b6e       wall_thickn
+0001b6b0: 6573 7320 3d20 636f 6e66 6967 2e77 616c  ess = config.wal
+0001b6c0: 6c5f 7468 6963 6b6e 6573 730a 2020 2020  l_thickness.    
+0001b6d0: 2020 2020 6d75 203d 2063 6f6e 6669 672e      mu = config.
+0001b6e0: 6d75 0a20 2020 2020 2020 2074 6865 7461  mu.        theta
+0001b6f0: 5f73 7465 7020 3d20 636f 6e66 6967 2e74  _step = config.t
+0001b700: 6865 7461 5f73 7465 700a 2020 2020 2020  heta_step.      
+0001b710: 2020 6265 616d 5f69 6e74 656e 7369 7479    beam_intensity
+0001b720: 203d 2063 6f6e 6669 672e 6265 616d 5f69   = config.beam_i
+0001b730: 6e74 656e 7369 7479 0a20 2020 2020 2020  ntensity.       
+0001b740: 2062 6163 6b67 726f 756e 645f 696e 7465   background_inte
+0001b750: 6e73 6974 7920 3d20 636f 6e66 6967 2e62  nsity = config.b
+0001b760: 6163 6b67 726f 756e 645f 696e 7465 6e73  ackground_intens
+0001b770: 6974 790a 2020 2020 2020 2020 736c 6974  ity.        slit
+0001b780: 5f73 697a 6520 3d20 636f 6e66 6967 2e73  _size = config.s
+0001b790: 6c69 745f 7369 7a65 0a20 2020 2020 2020  lit_size.       
+0001b7a0: 2070 6978 656c 5f73 697a 6520 3d20 636f   pixel_size = co
+0001b7b0: 6e66 6967 2e64 6574 6563 746f 722e 7069  nfig.detector.pi
+0001b7c0: 7865 6c5f 7369 7a65 0a20 2020 2020 2020  xel_size.       
+0001b7d0: 2069 6620 6c65 6e28 7069 7865 6c5f 7369   if len(pixel_si
+0001b7e0: 7a65 2920 3d3d 2031 3a0a 2020 2020 2020  ze) == 1:.      
+0001b7f0: 2020 2020 2020 7069 7865 6c5f 7369 7a65        pixel_size
+0001b800: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+0001b810: 2020 2020 2070 6978 656c 5f73 697a 655b       pixel_size[
+0001b820: 305d 2f63 6f6e 6669 672e 6465 7465 6374  0]/config.detect
+0001b830: 6f72 2e6c 656e 735f 6d61 676e 6966 6963  or.lens_magnific
+0001b840: 6174 696f 6e2c 0a20 2020 2020 2020 2020  ation,.         
+0001b850: 2020 2020 2020 2070 6978 656c 5f73 697a         pixel_siz
+0001b860: 655b 305d 2f63 6f6e 6669 672e 6465 7465  e[0]/config.dete
+0001b870: 6374 6f72 2e6c 656e 735f 6d61 676e 6966  ctor.lens_magnif
+0001b880: 6963 6174 696f 6e2c 0a20 2020 2020 2020  ication,.       
+0001b890: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+0001b8a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001b8b0: 2070 6978 656c 5f73 697a 6520 3d20 280a   pixel_size = (.
+0001b8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b8d0: 7069 7865 6c5f 7369 7a65 5b30 5d2f 636f  pixel_size[0]/co
+0001b8e0: 6e66 6967 2e64 6574 6563 746f 722e 6c65  nfig.detector.le
+0001b8f0: 6e73 5f6d 6167 6e69 6669 6361 7469 6f6e  ns_magnification
+0001b900: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001b910: 2020 7069 7865 6c5f 7369 7a65 5b31 5d2f    pixel_size[1]/
+0001b920: 636f 6e66 6967 2e64 6574 6563 746f 722e  config.detector.
+0001b930: 6c65 6e73 5f6d 6167 6e69 6669 6361 7469  lens_magnificati
+0001b940: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
+0001b950: 290a 2020 2020 2020 2020 6465 7465 6374  ).        detect
+0001b960: 6f72 5f73 697a 6520 3d20 2863 6f6e 6669  or_size = (confi
+0001b970: 672e 6465 7465 6374 6f72 2e72 6f77 732c  g.detector.rows,
+0001b980: 2063 6f6e 6669 672e 6465 7465 6374 6f72   config.detector
+0001b990: 2e63 6f6c 756d 6e73 290a 2020 2020 2020  .columns).      
+0001b9a0: 2020 6966 2073 6c69 745f 7369 7a65 2d30    if slit_size-0
+0001b9b0: 2e35 2a70 6978 656c 5f73 697a 655b 305d  .5*pixel_size[0]
+0001b9c0: 203e 2064 6574 6563 746f 725f 7369 7a65   > detector_size
+0001b9d0: 5b30 5d2a 7069 7865 6c5f 7369 7a65 5b30  [0]*pixel_size[0
+0001b9e0: 5d3a 0a20 2020 2020 2020 2020 2020 2072  ]:.            r
+0001b9f0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+0001ba00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ba10: 2066 2753 6c69 7420 7369 7a65 2028 7b73   f'Slit size ({s
+0001ba20: 6c69 745f 7369 7a65 7d29 206c 6172 6765  lit_size}) large
+0001ba30: 7220 7468 616e 2064 6574 6563 746f 7220  r than detector 
+0001ba40: 6865 6967 6874 2027 0a20 2020 2020 2020  height '.       
+0001ba50: 2020 2020 2020 2020 2066 2728 7b64 6574           f'({det
+0001ba60: 6563 746f 725f 7369 7a65 5b30 5d2a 7069  ector_size[0]*pi
+0001ba70: 7865 6c5f 7369 7a65 5b30 5d7d 2927 290a  xel_size[0]})').
+0001ba80: 0a20 2020 2020 2020 2023 2047 6574 2074  .        # Get t
+0001ba90: 6865 2072 6f74 6174 696f 6e20 616e 676c  he rotation angl
+0001baa0: 6573 2028 7374 6172 7420 6174 2061 2061  es (start at a a
+0001bab0: 7262 6974 7261 7269 6c79 2063 686f 6f73  rbitrarily choos
+0001bac0: 6520 616e 676c 650a 2020 2020 2020 2020  e angle.        
+0001bad0: 2320 2020 2061 6e64 2061 6464 2074 6865  #    and add the
+0001bae0: 7461 7320 666f 7220 6120 6675 6c6c 2033  tas for a full 3
+0001baf0: 3630 2064 6567 7265 6573 2072 6f74 6174  60 degrees rotat
+0001bb00: 696f 6e20 7365 7269 6573 290a 2020 2020  ion series).    
+0001bb10: 2020 2020 6966 2073 7461 7469 6f6e 2069      if station i
+0001bb20: 6e20 2827 6964 3161 3327 2c20 2769 6433  n ('id1a3', 'id3
+0001bb30: 6127 293a 0a20 2020 2020 2020 2020 2020  a'):.           
+0001bb40: 2074 6865 7461 5f73 7461 7274 203d 2030   theta_start = 0
+0001bb50: 2e0a 2020 2020 2020 2020 656c 7365 3a0a  ..        else:.
+0001bb60: 2020 2020 2020 2020 2020 2020 7468 6574              thet
+0001bb70: 615f 7374 6172 7420 3d20 2d31 370a 2020  a_start = -17.  
+0001bb80: 2020 2020 2020 7468 6574 615f 656e 6420        theta_end 
+0001bb90: 3d20 7468 6574 615f 7374 6172 7420 2b20  = theta_start + 
+0001bba0: 3336 302e 0a20 2020 2020 2020 2074 6865  360..        the
+0001bbb0: 7461 7320 3d20 6c69 7374 280a 2020 2020  tas = list(.    
+0001bbc0: 2020 2020 2020 2020 6e70 2e61 7261 6e67          np.arang
+0001bbd0: 6528 7468 6574 615f 7374 6172 742c 2074  e(theta_start, t
+0001bbe0: 6865 7461 5f65 6e64 2b30 2e35 2a74 6865  heta_end+0.5*the
+0001bbf0: 7461 5f73 7465 702c 2074 6865 7461 5f73  ta_step, theta_s
+0001bc00: 7465 7029 290a 0a20 2020 2020 2020 2023  tep))..        #
+0001bc10: 2047 6574 2074 6865 206e 756d 6265 7220   Get the number 
+0001bc20: 6f66 2068 6f72 697a 6f6e 7461 6c20 7374  of horizontal st
+0001bc30: 6163 6b73 2062 6173 6573 206f 6e20 7468  acks bases on th
+0001bc40: 6520 6469 6167 6f6e 616c 0a20 2020 2020  e diagonal.     
+0001bc50: 2020 2023 2020 2020 206f 6620 7468 6520     #     of the 
+0001bc60: 7371 7561 7265 2061 6e64 2066 6f72 206e  square and for n
+0001bc70: 6f77 2064 6f6e 2774 2061 6c6c 6f77 206d  ow don't allow m
+0001bc80: 6f72 6520 7468 616e 206f 6e65 0a20 2020  ore than one.   
+0001bc90: 2020 2020 206e 756d 5f74 6f6d 6f5f 7374       num_tomo_st
+0001bca0: 6163 6b20 3d20 3120 2b20 696e 7428 2873  ack = 1 + int((s
+0001bcb0: 616d 706c 655f 7369 7a65 5b31 5d2a 6e70  ample_size[1]*np
+0001bcc0: 2e73 7172 7428 3229 2d70 6978 656c 5f73  .sqrt(2)-pixel_s
+0001bcd0: 697a 655b 315d 290a 2020 2020 2020 2020  ize[1]).        
+0001bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bcf0: 2020 2020 2020 2020 202f 2028 6465 7465           / (dete
+0001bd00: 6374 6f72 5f73 697a 655b 315d 2a70 6978  ctor_size[1]*pix
+0001bd10: 656c 5f73 697a 655b 315d 2929 0a20 2020  el_size[1])).   
+0001bd20: 2020 2020 2069 6620 6e75 6d5f 746f 6d6f       if num_tomo
+0001bd30: 5f73 7461 636b 203e 2031 3a0a 2020 2020  _stack > 1:.    
+0001bd40: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+0001bd50: 6c75 6545 7272 6f72 2827 5361 6d70 6c65  lueError('Sample
+0001bd60: 2069 7320 746f 6f20 7769 6465 2066 6f72   is too wide for
+0001bd70: 2074 6865 2064 6574 6563 746f 7227 290a   the detector').
+0001bd80: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+0001bd90: 6520 7468 6520 782d 7261 7920 7061 7468  e the x-ray path
+0001bda0: 206c 656e 6774 6820 7468 726f 7567 6820   length through 
+0001bdb0: 6120 736f 6c69 6420 7371 7561 7265 0a20  a solid square. 
+0001bdc0: 2020 2020 2020 2023 2020 2020 2063 726f         #     cro
+0001bdd0: 7373 7365 6374 696f 6e20 666f 7220 6120  sssection for a 
+0001bde0: 7365 7420 6f66 2072 6f74 6174 696f 6e20  set of rotation 
+0001bdf0: 616e 676c 6573 2e0a 2020 2020 2020 2020  angles..        
+0001be00: 7061 7468 5f6c 656e 6774 6873 5f73 6f6c  path_lengths_sol
+0001be10: 6964 203d 2073 656c 662e 5f63 7265 6174  id = self._creat
+0001be20: 655f 7061 7468 6c65 6e67 7468 5f73 6f6c  e_pathlength_sol
+0001be30: 6964 5f73 7175 6172 6528 0a20 2020 2020  id_square(.     
+0001be40: 2020 2020 2020 2020 2020 2073 616d 706c             sampl
+0001be50: 655f 7369 7a65 5b31 5d2c 2074 6865 7461  e_size[1], theta
+0001be60: 732c 2070 6978 656c 5f73 697a 655b 315d  s, pixel_size[1]
+0001be70: 2c20 6465 7465 6374 6f72 5f73 697a 655b  , detector_size[
+0001be80: 315d 290a 0a20 2020 2020 2020 2023 2043  1])..        # C
+0001be90: 7265 6174 6520 7468 6520 782d 7261 7920  reate the x-ray 
+0001bea0: 7061 7468 206c 656e 6774 6820 7468 726f  path length thro
+0001beb0: 7567 6820 6120 686f 6c6c 6f77 2073 7175  ugh a hollow squ
+0001bec0: 6172 650a 2020 2020 2020 2020 2320 2020  are.        #   
+0001bed0: 2020 6372 6f73 7373 6563 7469 6f6e 2066    crosssection f
+0001bee0: 6f72 2061 2073 6574 206f 6620 726f 7461  or a set of rota
+0001bef0: 7469 6f6e 2061 6e67 6c65 732e 0a20 2020  tion angles..   
+0001bf00: 2020 2020 2070 6174 685f 6c65 6e67 7468       path_length
+0001bf10: 735f 686f 6c6c 6f77 203d 204e 6f6e 650a  s_hollow = None.
+0001bf20: 2020 2020 2020 2020 6966 2073 616d 706c          if sampl
+0001bf30: 655f 7479 7065 2069 6e20 2827 7371 7561  e_type in ('squa
+0001bf40: 7265 5f70 6970 6527 2c20 2768 6f6c 6c6f  re_pipe', 'hollo
+0001bf50: 775f 6375 6265 272c 2027 686f 6c6c 6f77  w_cube', 'hollow
+0001bf60: 5f62 7269 636b 2729 3a0a 2020 2020 2020  _brick'):.      
+0001bf70: 2020 2020 2020 7061 7468 5f6c 656e 6774        path_lengt
+0001bf80: 6873 5f68 6f6c 6c6f 7720 3d20 7061 7468  hs_hollow = path
+0001bf90: 5f6c 656e 6774 6873 5f73 6f6c 6964 205c  _lengths_solid \
+0001bfa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001bfb0: 202d 2073 656c 662e 5f63 7265 6174 655f   - self._create_
+0001bfc0: 7061 7468 6c65 6e67 7468 5f73 6f6c 6964  pathlength_solid
+0001bfd0: 5f73 7175 6172 6528 0a20 2020 2020 2020  _square(.       
+0001bfe0: 2020 2020 2020 2020 2020 2020 2073 616d               sam
+0001bff0: 706c 655f 7369 7a65 5b31 5d20 2d20 322a  ple_size[1] - 2*
+0001c000: 7761 6c6c 5f74 6869 636b 6e65 7373 2c20  wall_thickness, 
+0001c010: 7468 6574 6173 2c0a 2020 2020 2020 2020  thetas,.        
+0001c020: 2020 2020 2020 2020 2020 2020 7069 7865              pixe
+0001c030: 6c5f 7369 7a65 5b31 5d2c 2064 6574 6563  l_size[1], detec
+0001c040: 746f 725f 7369 7a65 5b31 5d29 0a0a 2020  tor_size[1])..  
+0001c050: 2020 2020 2020 2320 4765 7420 7468 6520        # Get the 
+0001c060: 6e75 6d62 6572 206f 6620 7374 6163 6b73  number of stacks
+0001c070: 0a20 2020 2020 2020 206e 756d 5f74 6f6d  .        num_tom
+0001c080: 6f5f 7374 6163 6b20 3d20 3120 2b20 696e  o_stack = 1 + in
+0001c090: 7428 2873 616d 706c 655f 7369 7a65 5b30  t((sample_size[0
+0001c0a0: 5d2d 7069 7865 6c5f 7369 7a65 5b30 5d29  ]-pixel_size[0])
+0001c0b0: 2f73 6c69 745f 7369 7a65 290a 2020 2020  /slit_size).    
+0001c0c0: 2020 2020 6966 206e 756d 5f74 6f6d 6f5f      if num_tomo_
+0001c0d0: 7374 6163 6b20 3e20 3120 616e 6420 7374  stack > 1 and st
+0001c0e0: 6174 696f 6e20 3d3d 2027 6964 3362 273a  ation == 'id3b':
+0001c0f0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0001c100: 7365 2056 616c 7565 4572 726f 7228 2753  se ValueError('S
+0001c110: 616d 706c 6520 6973 2074 6f20 7461 6c6c  ample is to tall
+0001c120: 2066 6f72 2074 6865 2064 6574 6563 746f   for the detecto
+0001c130: 7227 290a 0a20 2020 2020 2020 2023 2047  r')..        # G
+0001c140: 6574 2074 6865 2063 6f6c 756d 6e20 636f  et the column co
+0001c150: 6f72 6469 6e61 7465 730a 2020 2020 2020  ordinates.      
+0001c160: 2020 696d 675f 785f 6f66 6673 6574 203d    img_x_offset =
+0001c170: 202d 302e 3520 2a20 2864 6574 6563 746f   -0.5 * (detecto
+0001c180: 725f 7369 7a65 5b30 5d2a 7069 7865 6c5f  r_size[0]*pixel_
+0001c190: 7369 7a65 5b30 5d0a 2020 2020 2020 2020  size[0].        
+0001c1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c1b0: 2020 2020 2020 202b 2073 6c69 745f 7369         + slit_si
+0001c1c0: 7a65 202a 2028 6e75 6d5f 746f 6d6f 5f73  ze * (num_tomo_s
+0001c1d0: 7461 636b 2d31 2929 0a20 2020 2020 2020  tack-1)).       
+0001c1e0: 2069 6d67 5f78 5f63 6f6f 7264 7320 3d20   img_x_coords = 
+0001c1f0: 2869 6d67 5f78 5f6f 6666 7365 740a 2020  (img_x_offset.  
+0001c200: 2020 2020 2020 2020 2020 2b20 7069 7865            + pixe
+0001c210: 6c5f 7369 7a65 5b30 5d20 2a20 2830 2e35  l_size[0] * (0.5
+0001c220: 202b 206e 702e 6173 6172 7261 7928 7261   + np.asarray(ra
+0001c230: 6e67 6528 696e 7428 6465 7465 6374 6f72  nge(int(detector
+0001c240: 5f73 697a 655b 305d 2929 2929 290a 0a20  _size[0]))))).. 
+0001c250: 2020 2020 2020 2023 2047 6574 2074 6865         # Get the
+0001c260: 2074 7261 6e73 6d69 7474 6564 2069 6e74   transmitted int
+0001c270: 656e 7369 7469 6573 0a20 2020 2020 2020  ensities.       
+0001c280: 206e 756d 5f74 6865 7461 203d 206c 656e   num_theta = len
+0001c290: 2874 6865 7461 7329 0a20 2020 2020 2020  (thetas).       
+0001c2a0: 2076 6572 7469 6361 6c5f 7368 6966 7473   vertical_shifts
+0001c2b0: 203d 205b 5d0a 2020 2020 2020 2020 746f   = [].        to
+0001c2c0: 6d6f 5f66 6965 6c64 735f 7374 6163 6b20  mo_fields_stack 
+0001c2d0: 3d20 5b5d 0a20 2020 2020 2020 2069 6d67  = [].        img
+0001c2e0: 5f64 696d 203d 2028 6c65 6e28 696d 675f  _dim = (len(img_
+0001c2f0: 785f 636f 6f72 6473 292c 2070 6174 685f  x_coords), path_
+0001c300: 6c65 6e67 7468 735f 736f 6c69 642e 7368  lengths_solid.sh
+0001c310: 6170 655b 315d 290a 2020 2020 2020 2020  ape[1]).        
+0001c320: 696e 7465 6e73 6974 6965 735f 736f 6c69  intensities_soli
+0001c330: 6420 3d20 4e6f 6e65 0a20 2020 2020 2020  d = None.       
+0001c340: 2069 6e74 656e 7369 7469 6573 5f68 6f6c   intensities_hol
+0001c350: 6c6f 7720 3d20 4e6f 6e65 0a20 2020 2020  low = None.     
+0001c360: 2020 2066 6f72 206e 2069 6e20 7261 6e67     for n in rang
+0001c370: 6528 6e75 6d5f 746f 6d6f 5f73 7461 636b  e(num_tomo_stack
+0001c380: 293a 0a20 2020 2020 2020 2020 2020 2076  ):.            v
+0001c390: 6572 7469 6361 6c5f 7368 6966 7473 2e61  ertical_shifts.a
+0001c3a0: 7070 656e 6428 696d 675f 785f 6f66 6673  ppend(img_x_offs
+0001c3b0: 6574 202b 206e 2a73 6c69 745f 7369 7a65  et + n*slit_size
+0001c3c0: 290a 2020 2020 2020 2020 2020 2020 746f  ).            to
+0001c3d0: 6d6f 5f66 6965 6c64 203d 2062 6561 6d5f  mo_field = beam_
+0001c3e0: 696e 7465 6e73 6974 7920 2a20 6e70 2e6f  intensity * np.o
+0001c3f0: 6e65 7328 286e 756d 5f74 6865 7461 2c20  nes((num_theta, 
+0001c400: 2a69 6d67 5f64 696d 2929 0a20 2020 2020  *img_dim)).     
+0001c410: 2020 2020 2020 2069 6620 7361 6d70 6c65         if sample
+0001c420: 5f74 7970 6520 3d3d 2027 7371 7561 7265  _type == 'square
+0001c430: 5f72 6f64 273a 0a20 2020 2020 2020 2020  _rod':.         
+0001c440: 2020 2020 2020 2069 6e74 656e 7369 7469         intensiti
+0001c450: 6573 5f73 6f6c 6964 203d 205c 0a20 2020  es_solid = \.   
+0001c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c470: 2062 6561 6d5f 696e 7465 6e73 6974 7920   beam_intensity 
+0001c480: 2a20 6e70 2e65 7870 282d 6d75 2a70 6174  * np.exp(-mu*pat
+0001c490: 685f 6c65 6e67 7468 735f 736f 6c69 6429  h_lengths_solid)
+0001c4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c4b0: 2066 6f72 206e 2069 6e20 7261 6e67 6528   for n in range(
+0001c4c0: 6e75 6d5f 7468 6574 6129 3a0a 2020 2020  num_theta):.    
+0001c4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c4e0: 746f 6d6f 5f66 6965 6c64 5b6e 2c3a 2c3a  tomo_field[n,:,:
+0001c4f0: 5d20 3d20 696e 7465 6e73 6974 6965 735f  ] = intensities_
+0001c500: 736f 6c69 645b 6e5d 0a20 2020 2020 2020  solid[n].       
+0001c510: 2020 2020 2065 6c69 6620 7361 6d70 6c65       elif sample
+0001c520: 5f74 7970 6520 3d3d 2027 7371 7561 7265  _type == 'square
+0001c530: 5f70 6970 6527 3a0a 2020 2020 2020 2020  _pipe':.        
+0001c540: 2020 2020 2020 2020 696e 7465 6e73 6974          intensit
+0001c550: 6965 735f 686f 6c6c 6f77 203d 205c 0a20  ies_hollow = \. 
+0001c560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c570: 2020 2062 6561 6d5f 696e 7465 6e73 6974     beam_intensit
+0001c580: 7920 2a20 6e70 2e65 7870 282d 6d75 2a70  y * np.exp(-mu*p
+0001c590: 6174 685f 6c65 6e67 7468 735f 686f 6c6c  ath_lengths_holl
+0001c5a0: 6f77 290a 2020 2020 2020 2020 2020 2020  ow).            
+0001c5b0: 2020 2020 666f 7220 6e20 696e 2072 616e      for n in ran
+0001c5c0: 6765 286e 756d 5f74 6865 7461 293a 0a20  ge(num_theta):. 
+0001c5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c5e0: 2020 2074 6f6d 6f5f 6669 656c 645b 6e2c     tomo_field[n,
+0001c5f0: 3a2c 3a5d 203d 2069 6e74 656e 7369 7469  :,:] = intensiti
+0001c600: 6573 5f68 6f6c 6c6f 775b 6e5d 0a20 2020  es_hollow[n].   
+0001c610: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0001c620: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001c630: 6e74 656e 7369 7469 6573 5f73 6f6c 6964  ntensities_solid
+0001c640: 203d 205c 0a20 2020 2020 2020 2020 2020   = \.           
+0001c650: 2020 2020 2020 2020 2062 6561 6d5f 696e           beam_in
+0001c660: 7465 6e73 6974 7920 2a20 6e70 2e65 7870  tensity * np.exp
+0001c670: 282d 6d75 2a70 6174 685f 6c65 6e67 7468  (-mu*path_length
+0001c680: 735f 736f 6c69 6429 0a20 2020 2020 2020  s_solid).       
+0001c690: 2020 2020 2020 2020 2069 6e74 656e 7369           intensi
+0001c6a0: 7469 6573 5f68 6f6c 6c6f 7720 3d20 5c0a  ties_hollow = \.
+0001c6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c6c0: 2020 2020 6265 616d 5f69 6e74 656e 7369      beam_intensi
+0001c6d0: 7479 202a 206e 702e 6578 7028 2d6d 752a  ty * np.exp(-mu*
+0001c6e0: 7061 7468 5f6c 656e 6774 6873 5f68 6f6c  path_lengths_hol
+0001c6f0: 6c6f 7729 0a20 2020 2020 2020 2020 2020  low).           
+0001c700: 2020 2020 206f 7574 6572 5f69 6e64 6963       outer_indic
+0001c710: 6573 203d 205c 0a20 2020 2020 2020 2020  es = \.         
+0001c720: 2020 2020 2020 2020 2020 206e 702e 7768             np.wh
+0001c730: 6572 6528 6162 7328 696d 675f 785f 636f  ere(abs(img_x_co
+0001c740: 6f72 6473 2920 3c3d 2073 616d 706c 655f  ords) <= sample_
+0001c750: 7369 7a65 5b30 5d2f 3229 5b30 5d0a 2020  size[0]/2)[0].  
+0001c760: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0001c770: 6e65 725f 696e 6469 6365 7320 3d20 6e70  ner_indices = np
+0001c780: 2e77 6865 7265 280a 2020 2020 2020 2020  .where(.        
+0001c790: 2020 2020 2020 2020 2020 2020 6162 7328              abs(
+0001c7a0: 696d 675f 785f 636f 6f72 6473 2920 3c20  img_x_coords) < 
+0001c7b0: 7361 6d70 6c65 5f73 697a 655b 305d 2f32  sample_size[0]/2
+0001c7c0: 202d 2077 616c 6c5f 7468 6963 6b6e 6573   - wall_thicknes
+0001c7d0: 7329 5b30 5d0a 2020 2020 2020 2020 2020  s)[0].          
+0001c7e0: 2020 2020 2020 7761 6c6c 5f69 6e64 6963        wall_indic
+0001c7f0: 6573 203d 206c 6973 7428 7365 7428 6f75  es = list(set(ou
+0001c800: 7465 725f 696e 6469 6365 7329 2d73 6574  ter_indices)-set
+0001c810: 2869 6e6e 6572 5f69 6e64 6963 6573 2929  (inner_indices))
+0001c820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c830: 2066 6f72 2069 2069 6e20 7761 6c6c 5f69   for i in wall_i
+0001c840: 6e64 6963 6573 3a0a 2020 2020 2020 2020  ndices:.        
+0001c850: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0001c860: 6e20 696e 2072 616e 6765 286e 756d 5f74  n in range(num_t
+0001c870: 6865 7461 293a 0a20 2020 2020 2020 2020  heta):.         
+0001c880: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0001c890: 6f6d 6f5f 6669 656c 645b 6e2c 695d 203d  omo_field[n,i] =
+0001c8a0: 2069 6e74 656e 7369 7469 6573 5f73 6f6c   intensities_sol
+0001c8b0: 6964 5b6e 5d0a 2020 2020 2020 2020 2020  id[n].          
+0001c8c0: 2020 2020 2020 666f 7220 6920 696e 2069        for i in i
+0001c8d0: 6e6e 6572 5f69 6e64 6963 6573 3a0a 2020  nner_indices:.  
+0001c8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c8f0: 2020 666f 7220 6e20 696e 2072 616e 6765    for n in range
+0001c900: 286e 756d 5f74 6865 7461 293a 0a20 2020  (num_theta):.   
+0001c910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c920: 2020 2020 2074 6f6d 6f5f 6669 656c 645b       tomo_field[
+0001c930: 6e2c 695d 203d 2069 6e74 656e 7369 7469  n,i] = intensiti
+0001c940: 6573 5f68 6f6c 6c6f 775b 6e5d 0a20 2020  es_hollow[n].   
+0001c950: 2020 2020 2020 2020 2074 6f6d 6f5f 6669           tomo_fi
+0001c960: 656c 6420 2b3d 2062 6163 6b67 726f 756e  eld += backgroun
+0001c970: 645f 696e 7465 6e73 6974 790a 2020 2020  d_intensity.    
+0001c980: 2020 2020 2020 2020 746f 6d6f 5f66 6965          tomo_fie
+0001c990: 6c64 735f 7374 6163 6b2e 6170 7065 6e64  lds_stack.append
+0001c9a0: 2874 6f6d 6f5f 6669 656c 642e 6173 7479  (tomo_field.asty
+0001c9b0: 7065 286e 702e 696e 7436 3429 290a 2020  pe(np.int64)).  
+0001c9c0: 2020 2020 2020 2020 2020 6966 206e 756d            if num
+0001c9d0: 5f74 6f6d 6f5f 7374 6163 6b20 3e20 313a  _tomo_stack > 1:
+0001c9e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c9f0: 2069 6d67 5f78 5f63 6f6f 7264 7320 2b3d   img_x_coords +=
+0001ca00: 2073 6c69 745f 7369 7a65 0a20 2020 2020   slit_size.     
+0001ca10: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0001ca20: 2320 4164 6420 6475 6d6d 7920 736e 6170  # Add dummy snap
+0001ca30: 7368 6f74 7320 6174 2065 6163 6820 656e  shots at each en
+0001ca40: 6420 746f 206d 696d 6963 2046 4d42 2f53  d to mimic FMB/S
+0001ca50: 4d42 0a20 2020 2020 2020 2069 6620 7374  MB.        if st
+0001ca60: 6174 696f 6e20 696e 2028 2769 6431 6133  ation in ('id1a3
+0001ca70: 272c 2027 6964 3361 2729 3a0a 2020 2020  ', 'id3a'):.    
+0001ca80: 2020 2020 2020 2020 6e75 6d5f 7468 6574          num_thet
+0001ca90: 615f 6475 6d6d 795f 7374 6172 7420 3d20  a_dummy_start = 
+0001caa0: 350a 2020 2020 2020 2020 2020 2020 6e75  5.            nu
+0001cab0: 6d5f 7468 6574 615f 6475 6d6d 795f 656e  m_theta_dummy_en
+0001cac0: 6420 3d20 300a 2020 2020 2020 2020 656c  d = 0.        el
+0001cad0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001cae0: 6e75 6d5f 7468 6574 615f 6475 6d6d 795f  num_theta_dummy_
+0001caf0: 7374 6172 7420 3d20 310a 2020 2020 2020  start = 1.      
+0001cb00: 2020 2020 2020 6e75 6d5f 7468 6574 615f        num_theta_
+0001cb10: 6475 6d6d 795f 656e 6420 3d20 310a 2020  dummy_end = 1.  
+0001cb20: 2020 2020 2020 7468 6574 6173 203d 205b        thetas = [
+0001cb30: 7468 6574 615f 7374 6172 742d 6e2a 7468  theta_start-n*th
+0001cb40: 6574 615f 7374 6570 0a20 2020 2020 2020  eta_step.       
+0001cb50: 2020 2020 2066 6f72 206e 2069 6e20 7261       for n in ra
+0001cb60: 6e67 6528 6e75 6d5f 7468 6574 615f 6475  nge(num_theta_du
+0001cb70: 6d6d 795f 7374 6172 742c 2030 2c20 2d31  mmy_start, 0, -1
+0001cb80: 295d 202b 2074 6865 7461 730a 2020 2020  )] + thetas.    
+0001cb90: 2020 2020 7468 6574 6173 202b 3d20 5b74      thetas += [t
+0001cba0: 6865 7461 5f65 6e64 2b6e 2a74 6865 7461  heta_end+n*theta
+0001cbb0: 5f73 7465 700a 2020 2020 2020 2020 2020  _step.          
+0001cbc0: 2020 666f 7220 6e20 696e 2072 616e 6765    for n in range
+0001cbd0: 2831 2c20 6e75 6d5f 7468 6574 615f 6475  (1, num_theta_du
+0001cbe0: 6d6d 795f 656e 642b 3129 5d0a 2020 2020  mmy_end+1)].    
+0001cbf0: 2020 2020 6966 206e 756d 5f74 6865 7461      if num_theta
+0001cc00: 5f64 756d 6d79 5f73 7461 7274 3a0a 2020  _dummy_start:.  
+0001cc10: 2020 2020 2020 2020 2020 6475 6d6d 795f            dummy_
+0001cc20: 6669 656c 6473 203d 2062 6163 6b67 726f  fields = backgro
+0001cc30: 756e 645f 696e 7465 6e73 6974 7920 2a20  und_intensity * 
+0001cc40: 6e70 2e6f 6e65 7328 0a20 2020 2020 2020  np.ones(.       
+0001cc50: 2020 2020 2020 2020 2028 6e75 6d5f 7468           (num_th
+0001cc60: 6574 615f 6475 6d6d 795f 7374 6172 742c  eta_dummy_start,
+0001cc70: 202a 696d 675f 6469 6d29 2c20 6474 7970   *img_dim), dtyp
+0001cc80: 653d 6e70 2e69 6e74 3634 290a 2020 2020  e=np.int64).    
+0001cc90: 2020 2020 2020 2020 666f 7220 6e2c 2074          for n, t
+0001cca0: 6f6d 6f5f 6669 656c 6420 696e 2065 6e75  omo_field in enu
+0001ccb0: 6d65 7261 7465 2874 6f6d 6f5f 6669 656c  merate(tomo_fiel
+0001ccc0: 6473 5f73 7461 636b 293a 0a20 2020 2020  ds_stack):.     
+0001ccd0: 2020 2020 2020 2020 2020 2074 6f6d 6f5f             tomo_
+0001cce0: 6669 656c 6473 5f73 7461 636b 5b6e 5d20  fields_stack[n] 
+0001ccf0: 3d20 6e70 2e63 6f6e 6361 7465 6e61 7465  = np.concatenate
+0001cd00: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001cd10: 2020 2020 2020 2864 756d 6d79 5f66 6965        (dummy_fie
+0001cd20: 6c64 732c 2074 6f6d 6f5f 6669 656c 6429  lds, tomo_field)
+0001cd30: 290a 2020 2020 2020 2020 6966 206e 756d  ).        if num
+0001cd40: 5f74 6865 7461 5f64 756d 6d79 5f65 6e64  _theta_dummy_end
+0001cd50: 3a0a 2020 2020 2020 2020 2020 2020 6475  :.            du
+0001cd60: 6d6d 795f 6669 656c 6473 203d 2062 6163  mmy_fields = bac
+0001cd70: 6b67 726f 756e 645f 696e 7465 6e73 6974  kground_intensit
+0001cd80: 7920 2a20 6e70 2e6f 6e65 7328 0a20 2020  y * np.ones(.   
+0001cd90: 2020 2020 2020 2020 2020 2020 2028 6e75               (nu
+0001cda0: 6d5f 7468 6574 615f 6475 6d6d 795f 656e  m_theta_dummy_en
+0001cdb0: 642c 202a 696d 675f 6469 6d29 2c20 6474  d, *img_dim), dt
+0001cdc0: 7970 653d 6e70 2e69 6e74 3634 290a 2020  ype=np.int64).  
+0001cdd0: 2020 2020 2020 2020 2020 666f 7220 6e2c            for n,
+0001cde0: 2074 6f6d 6f5f 6669 656c 6420 696e 2065   tomo_field in e
+0001cdf0: 6e75 6d65 7261 7465 2874 6f6d 6f5f 6669  numerate(tomo_fi
+0001ce00: 656c 6473 5f73 7461 636b 293a 0a20 2020  elds_stack):.   
+0001ce10: 2020 2020 2020 2020 2020 2020 2074 6f6d               tom
+0001ce20: 6f5f 6669 656c 6473 5f73 7461 636b 5b6e  o_fields_stack[n
+0001ce30: 5d20 3d20 6e70 2e63 6f6e 6361 7465 6e61  ] = np.concatena
+0001ce40: 7465 280a 2020 2020 2020 2020 2020 2020  te(.            
+0001ce50: 2020 2020 2020 2020 2874 6f6d 6f5f 6669          (tomo_fi
+0001ce60: 656c 642c 2064 756d 6d79 5f66 6965 6c64  eld, dummy_field
+0001ce70: 7329 290a 2020 2020 2020 2020 6966 206e  s)).        if n
+0001ce80: 756d 5f74 6f6d 6f5f 7374 6163 6b20 3d3d  um_tomo_stack ==
+0001ce90: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+0001cea0: 746f 6d6f 5f66 6965 6c64 735f 7374 6163  tomo_fields_stac
+0001ceb0: 6b20 3d20 746f 6d6f 5f66 6965 6c64 735f  k = tomo_fields_
+0001cec0: 7374 6163 6b5b 305d 0a0a 2020 2020 2020  stack[0]..      
+0001ced0: 2020 2320 4372 6561 7465 204e 6578 7573    # Create Nexus
+0001cee0: 206f 626a 6563 7420 616e 6420 7772 6974   object and writ
+0001cef0: 6520 746f 2066 696c 650a 2020 2020 2020  e to file.      
+0001cf00: 2020 6e78 726f 6f74 203d 204e 5872 6f6f    nxroot = NXroo
+0001cf10: 7428 290a 2020 2020 2020 2020 6e78 726f  t().        nxro
+0001cf20: 6f74 2e65 6e74 7279 203d 204e 5865 6e74  ot.entry = NXent
+0001cf30: 7279 2829 0a20 2020 2020 2020 206e 7872  ry().        nxr
+0001cf40: 6f6f 742e 656e 7472 792e 7361 6d70 6c65  oot.entry.sample
+0001cf50: 203d 204e 5873 616d 706c 6528 290a 2020   = NXsample().  
+0001cf60: 2020 2020 2020 6e78 726f 6f74 2e65 6e74        nxroot.ent
+0001cf70: 7279 2e73 616d 706c 652e 7361 6d70 6c65  ry.sample.sample
+0001cf80: 5f74 7970 6520 3d20 7361 6d70 6c65 5f74  _type = sample_t
+0001cf90: 7970 650a 2020 2020 2020 2020 6e78 726f  ype.        nxro
+0001cfa0: 6f74 2e65 6e74 7279 2e73 616d 706c 652e  ot.entry.sample.
+0001cfb0: 7361 6d70 6c65 5f73 697a 6520 3d20 7361  sample_size = sa
+0001cfc0: 6d70 6c65 5f73 697a 650a 2020 2020 2020  mple_size.      
+0001cfd0: 2020 6966 2077 616c 6c5f 7468 6963 6b6e    if wall_thickn
+0001cfe0: 6573 7320 6973 206e 6f74 204e 6f6e 653a  ess is not None:
+0001cff0: 0a20 2020 2020 2020 2020 2020 206e 7872  .            nxr
+0001d000: 6f6f 742e 656e 7472 792e 7361 6d70 6c65  oot.entry.sample
+0001d010: 2e77 616c 6c5f 7468 6963 6b6e 6573 7320  .wall_thickness 
+0001d020: 3d20 7761 6c6c 5f74 6869 636b 6e65 7373  = wall_thickness
+0001d030: 0a20 2020 2020 2020 206e 7872 6f6f 742e  .        nxroot.
+0001d040: 656e 7472 792e 7361 6d70 6c65 2e6d 7520  entry.sample.mu 
+0001d050: 3d20 6d75 0a20 2020 2020 2020 206e 7869  = mu.        nxi
+0001d060: 6e73 7472 756d 656e 7420 3d20 4e58 696e  nstrument = NXin
+0001d070: 7374 7275 6d65 6e74 2829 0a20 2020 2020  strument().     
+0001d080: 2020 206e 7872 6f6f 742e 656e 7472 792e     nxroot.entry.
+0001d090: 696e 7374 7275 6d65 6e74 203d 206e 7869  instrument = nxi
+0001d0a0: 6e73 7472 756d 656e 740a 2020 2020 2020  nstrument.      
+0001d0b0: 2020 6e78 696e 7374 7275 6d65 6e74 2e73    nxinstrument.s
+0001d0c0: 6f75 7263 6520 3d20 4e58 736f 7572 6365  ource = NXsource
+0001d0d0: 2829 0a20 2020 2020 2020 206e 7869 6e73  ().        nxins
+0001d0e0: 7472 756d 656e 742e 736f 7572 6365 2e61  trument.source.a
+0001d0f0: 7474 7273 5b27 7374 6174 696f 6e27 5d20  ttrs['station'] 
+0001d100: 3d20 7374 6174 696f 6e0a 2020 2020 2020  = station.      
+0001d110: 2020 6e78 696e 7374 7275 6d65 6e74 2e73    nxinstrument.s
+0001d120: 6f75 7263 652e 7479 7065 203d 2027 5379  ource.type = 'Sy
+0001d130: 6e63 6872 6f74 726f 6e20 582d 7261 7920  nchrotron X-ray 
+0001d140: 536f 7572 6365 270a 2020 2020 2020 2020  Source'.        
+0001d150: 6e78 696e 7374 7275 6d65 6e74 2e73 6f75  nxinstrument.sou
+0001d160: 7263 652e 6e61 6d65 203d 2027 546f 6d6f  rce.name = 'Tomo
+0001d170: 6772 6170 6879 2053 696d 756c 6174 6f72  graphy Simulator
+0001d180: 270a 2020 2020 2020 2020 6e78 696e 7374  '.        nxinst
+0001d190: 7275 6d65 6e74 2e73 6f75 7263 652e 7072  rument.source.pr
+0001d1a0: 6f62 6520 3d20 2778 2d72 6179 270a 2020  obe = 'x-ray'.  
+0001d1b0: 2020 2020 2020 6e78 696e 7374 7275 6d65        nxinstrume
+0001d1c0: 6e74 2e73 6f75 7263 652e 6261 636b 6772  nt.source.backgr
+0001d1d0: 6f75 6e64 5f69 6e74 656e 7369 7479 203d  ound_intensity =
+0001d1e0: 2062 6163 6b67 726f 756e 645f 696e 7465   background_inte
+0001d1f0: 6e73 6974 790a 2020 2020 2020 2020 6e78  nsity.        nx
+0001d200: 696e 7374 7275 6d65 6e74 2e73 6f75 7263  instrument.sourc
+0001d210: 652e 6265 616d 5f69 6e74 656e 7369 7479  e.beam_intensity
+0001d220: 203d 2062 6561 6d5f 696e 7465 6e73 6974   = beam_intensit
+0001d230: 790a 2020 2020 2020 2020 6e78 696e 7374  y.        nxinst
+0001d240: 7275 6d65 6e74 2e73 6f75 7263 652e 736c  rument.source.sl
+0001d250: 6974 5f73 697a 6520 3d20 736c 6974 5f73  it_size = slit_s
+0001d260: 697a 650a 2020 2020 2020 2020 6e78 6465  ize.        nxde
+0001d270: 7465 6374 6f72 203d 204e 5864 6574 6563  tector = NXdetec
+0001d280: 746f 7228 290a 2020 2020 2020 2020 6e78  tor().        nx
+0001d290: 696e 7374 7275 6d65 6e74 2e64 6574 6563  instrument.detec
+0001d2a0: 746f 7220 3d20 6e78 6465 7465 6374 6f72  tor = nxdetector
+0001d2b0: 0a20 2020 2020 2020 206e 7864 6574 6563  .        nxdetec
+0001d2c0: 746f 722e 6c6f 6361 6c5f 6e61 6d65 203d  tor.local_name =
+0001d2d0: 2063 6f6e 6669 672e 6465 7465 6374 6f72   config.detector
+0001d2e0: 2e70 7265 6669 780a 2020 2020 2020 2020  .prefix.        
+0001d2f0: 6e78 6465 7465 6374 6f72 2e78 5f70 6978  nxdetector.x_pix
+0001d300: 656c 5f73 697a 6520 3d20 7069 7865 6c5f  el_size = pixel_
+0001d310: 7369 7a65 5b30 5d0a 2020 2020 2020 2020  size[0].        
+0001d320: 6e78 6465 7465 6374 6f72 2e79 5f70 6978  nxdetector.y_pix
+0001d330: 656c 5f73 697a 6520 3d20 7069 7865 6c5f  el_size = pixel_
+0001d340: 7369 7a65 5b31 5d0a 2020 2020 2020 2020  size[1].        
+0001d350: 6e78 6465 7465 6374 6f72 2e78 5f70 6978  nxdetector.x_pix
+0001d360: 656c 5f73 697a 652e 6174 7472 735b 2775  el_size.attrs['u
+0001d370: 6e69 7473 275d 203d 2027 6d6d 270a 2020  nits'] = 'mm'.  
+0001d380: 2020 2020 2020 6e78 6465 7465 6374 6f72        nxdetector
+0001d390: 2e79 5f70 6978 656c 5f73 697a 652e 6174  .y_pixel_size.at
+0001d3a0: 7472 735b 2775 6e69 7473 275d 203d 2027  trs['units'] = '
+0001d3b0: 6d6d 270a 2020 2020 2020 2020 6e78 6465  mm'.        nxde
+0001d3c0: 7465 6374 6f72 2e64 6174 6120 3d20 746f  tector.data = to
+0001d3d0: 6d6f 5f66 6965 6c64 735f 7374 6163 6b0a  mo_fields_stack.
+0001d3e0: 2020 2020 2020 2020 6e78 6465 7465 6374          nxdetect
+0001d3f0: 6f72 2e74 6865 7461 7320 3d20 7468 6574  or.thetas = thet
+0001d400: 6173 0a20 2020 2020 2020 206e 7864 6574  as.        nxdet
+0001d410: 6563 746f 722e 7a5f 7472 616e 736c 6174  ector.z_translat
+0001d420: 696f 6e20 3d20 7665 7274 6963 616c 5f73  ion = vertical_s
+0001d430: 6869 6674 730a 2020 2020 2020 2020 6e78  hifts.        nx
+0001d440: 6465 7465 6374 6f72 2e66 7261 6d65 5f73  detector.frame_s
+0001d450: 7461 7274 5f6e 756d 6265 7220 3d20 6e75  tart_number = nu
+0001d460: 6d5f 7468 6574 615f 6475 6d6d 795f 7374  m_theta_dummy_st
+0001d470: 6172 740a 2320 2020 2020 2020 206e 7864  art.#        nxd
+0001d480: 6574 6563 746f 722e 7061 7468 5f6c 656e  etector.path_len
+0001d490: 6774 6873 5f73 6f6c 6964 203d 2070 6174  gths_solid = pat
+0001d4a0: 685f 6c65 6e67 7468 735f 736f 6c69 640a  h_lengths_solid.
+0001d4b0: 2320 2020 2020 2020 206e 7864 6574 6563  #        nxdetec
+0001d4c0: 746f 722e 7061 7468 5f6c 656e 6774 6873  tor.path_lengths
+0001d4d0: 5f68 6f6c 6c6f 7720 3d20 7061 7468 5f6c  _hollow = path_l
+0001d4e0: 656e 6774 6873 5f68 6f6c 6c6f 770a 2320  engths_hollow.# 
+0001d4f0: 2020 2020 2020 206e 7864 6574 6563 746f         nxdetecto
+0001d500: 722e 696e 7465 6e73 6974 6965 735f 736f  r.intensities_so
+0001d510: 6c69 6420 3d20 696e 7465 6e73 6974 6965  lid = intensitie
+0001d520: 735f 736f 6c69 640a 2320 2020 2020 2020  s_solid.#       
+0001d530: 206e 7864 6574 6563 746f 722e 696e 7465   nxdetector.inte
+0001d540: 6e73 6974 6965 735f 686f 6c6c 6f77 203d  nsities_hollow =
+0001d550: 2069 6e74 656e 7369 7469 6573 5f68 6f6c   intensities_hol
+0001d560: 6c6f 770a 0a20 2020 2020 2020 2072 6574  low..        ret
+0001d570: 7572 6e20 6e78 726f 6f74 0a0a 2020 2020  urn nxroot..    
+0001d580: 6465 6620 6765 745f 636f 6e66 6967 7328  def get_configs(
+0001d590: 7365 6c66 2c20 6461 7461 293a 0a20 2020  self, data):.   
+0001d5a0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0001d5b0: 2047 6574 2061 6e20 696e 7374 616e 6365   Get an instance
+0001d5c0: 206f 6620 7468 6520 636f 6e66 6967 7572   of the configur
+0001d5d0: 6174 696f 6e20 6f62 6a65 6374 206e 6565  ation object nee
+0001d5e0: 6465 6420 6279 2074 6869 730a 2020 2020  ded by this.    
+0001d5f0: 2020 2020 6050 726f 6365 7373 6f72 6020      `Processor` 
+0001d600: 6672 6f6d 2061 206c 6973 7420 6f66 2060  from a list of `
+0001d610: 5069 7065 6c69 6e65 4461 7461 6020 6f62  PipelineData` ob
+0001d620: 6a65 6374 732e 0a0a 2020 2020 2020 2020  jects...        
+0001d630: 3a70 6172 616d 2064 6174 613a 2049 6e70  :param data: Inp
+0001d640: 7574 206c 6973 7420 6f66 2060 5069 7065  ut list of `Pipe
+0001d650: 6c69 6e65 4461 7461 6020 6f62 6a65 6374  lineData` object
+0001d660: 732c 2077 6865 7265 2061 740a 2020 2020  s, where at.    
+0001d670: 2020 2020 2020 2020 6c65 6173 7420 6f6e          least on
+0001d680: 6520 6974 656d 2068 6173 2060 2754 6f6d  e item has `'Tom
+0001d690: 6f53 696d 436f 6e66 6967 2760 2066 6f72  oSimConfig'` for
+0001d6a0: 2074 6865 2060 2773 6368 656d 6127 6020   the `'schema'` 
+0001d6b0: 6b65 792e 0a20 2020 2020 2020 203a 7479  key..        :ty
+0001d6c0: 7065 2064 6174 613a 206c 6973 745b 5069  pe data: list[Pi
+0001d6d0: 7065 6c69 6e65 4461 7461 5d0a 2020 2020  pelineData].    
+0001d6e0: 2020 2020 3a72 6169 7365 7320 5661 6c75      :raises Valu
+0001d6f0: 6545 7272 6f72 3a20 4966 2061 2076 616c  eError: If a val
+0001d700: 6964 2063 6f6e 6669 6720 6f62 6a65 6374  id config object
+0001d710: 2063 616e 6e6f 7420 6265 0a20 2020 2020   cannot be.     
+0001d720: 2020 2020 2020 2063 6f6e 7374 7275 6374         construct
+0001d730: 6564 2066 726f 6d20 6064 6174 6160 2e0a  ed from `data`..
+0001d740: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+0001d750: 2056 616c 6964 2069 6e73 7461 6e63 6520   Valid instance 
+0001d760: 6f66 2074 6865 2063 6f6e 6669 6775 7261  of the configura
+0001d770: 7469 6f6e 206f 626a 6563 7420 7769 7468  tion object with
+0001d780: 2066 6965 6c64 0a20 2020 2020 2020 2020   field.         
+0001d790: 2020 2076 616c 7565 7320 7461 6b65 6e20     values taken 
+0001d7a0: 6672 6f6d 2060 6461 7461 602e 0a20 2020  from `data`..   
+0001d7b0: 2020 2020 203a 7274 7970 653a 2054 6f6d       :rtype: Tom
+0001d7c0: 6f53 696d 436f 6e66 6967 0a20 2020 2020  oSimConfig.     
+0001d7d0: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
+0001d7e0: 204c 6f63 616c 206d 6f64 756c 6573 0a20   Local modules. 
+0001d7f0: 2020 2020 2020 2066 726f 6d20 4348 4150         from CHAP
+0001d800: 2e74 6f6d 6f2e 6d6f 6465 6c73 2069 6d70  .tomo.models imp
+0001d810: 6f72 7420 546f 6d6f 5369 6d43 6f6e 6669  ort TomoSimConfi
+0001d820: 670a 0a20 2020 2020 2020 2074 6f6d 6f5f  g..        tomo_
+0001d830: 7369 6d5f 6461 7461 203d 204e 6f6e 650a  sim_data = None.
+0001d840: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0001d850: 7461 6e63 6528 6461 7461 2c20 6c69 7374  tance(data, list
+0001d860: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
+0001d870: 6f72 2069 7465 6d20 696e 2064 6174 613a  or item in data:
+0001d880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d890: 2069 6620 2869 7369 6e73 7461 6e63 6528   if (isinstance(
+0001d8a0: 6974 656d 2c20 6469 6374 2920 616e 6420  item, dict) and 
+0001d8b0: 6974 656d 2e67 6574 2827 6461 7461 2729  item.get('data')
+0001d8c0: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
+0001d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d8e0: 2020 2020 2061 6e64 2069 7465 6d2e 6765       and item.ge
+0001d8f0: 7428 2773 6368 656d 6127 2920 3d3d 2027  t('schema') == '
+0001d900: 546f 6d6f 5369 6d43 6f6e 6669 6727 293a  TomoSimConfig'):
+0001d910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d920: 2020 2020 2074 6f6d 6f5f 7369 6d5f 6461       tomo_sim_da
+0001d930: 7461 203d 2069 7465 6d2e 6765 7428 2764  ta = item.get('d
+0001d940: 6174 6127 290a 2020 2020 2020 2020 6966  ata').        if
+0001d950: 2074 6f6d 6f5f 7369 6d5f 6461 7461 2069   tomo_sim_data i
+0001d960: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001d970: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+0001d980: 7272 6f72 2866 2749 6e76 616c 6964 2070  rror(f'Invalid p
+0001d990: 6172 616d 6574 6572 2064 6174 6120 287b  arameter data ({
+0001d9a0: 6461 7461 7d29 2729 0a0a 2020 2020 2020  data})')..      
+0001d9b0: 2020 7265 7475 726e 2054 6f6d 6f53 696d    return TomoSim
+0001d9c0: 436f 6e66 6967 282a 2a74 6f6d 6f5f 7369  Config(**tomo_si
+0001d9d0: 6d5f 6461 7461 290a 0a20 2020 2064 6566  m_data)..    def
+0001d9e0: 205f 6372 6561 7465 5f70 6174 686c 656e   _create_pathlen
+0001d9f0: 6774 685f 736f 6c69 645f 7371 7561 7265  gth_solid_square
+0001da00: 2873 656c 662c 2064 696d 2c20 7468 6574  (self, dim, thet
+0001da10: 6173 2c20 7069 7865 6c5f 7369 7a65 2c0a  as, pixel_size,.
+0001da20: 2020 2020 2020 2020 2020 2020 6465 7465              dete
+0001da30: 6374 6f72 5f73 697a 6529 3a0a 2020 2020  ctor_size):.    
+0001da40: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0001da50: 4372 6561 7465 2074 6865 2078 2d72 6179  Create the x-ray
+0001da60: 2070 6174 6820 6c65 6e67 7468 2074 6872   path length thr
+0001da70: 6f75 6768 2061 2073 6f6c 6964 2073 7175  ough a solid squ
+0001da80: 6172 650a 2020 2020 2020 2020 6372 6f73  are.        cros
+0001da90: 7373 6563 7469 6f6e 2066 6f72 2061 2073  ssection for a s
+0001daa0: 6574 206f 6620 726f 7461 7469 6f6e 2061  et of rotation a
+0001dab0: 6e67 6c65 732e 0a20 2020 2020 2020 2022  ngles..        "
+0001dac0: 2222 0a20 2020 2020 2020 2023 2047 6574  "".        # Get
+0001dad0: 2074 6865 2063 6f6c 756d 6e20 636f 6f72   the column coor
+0001dae0: 6469 6e61 7465 730a 2020 2020 2020 2020  dinates.        
+0001daf0: 696d 675f 795f 636f 6f72 6473 203d 2070  img_y_coords = p
+0001db00: 6978 656c 5f73 697a 6520 2a20 2830 2e35  ixel_size * (0.5
+0001db10: 202a 2028 3120 2d20 6465 7465 6374 6f72   * (1 - detector
+0001db20: 5f73 697a 6525 3229 0a20 2020 2020 2020  _size%2).       
+0001db30: 2020 2020 202b 206e 702e 6173 6172 7261       + np.asarra
+0001db40: 7928 7261 6e67 6528 696e 7428 302e 3520  y(range(int(0.5 
+0001db50: 2a20 2864 6574 6563 746f 725f 7369 7a65  * (detector_size
+0001db60: 2b31 2929 2929 290a 0a20 2020 2020 2020  +1)))))..       
+0001db70: 2023 2047 6574 2074 6865 2070 6174 6820   # Get the path 
+0001db80: 6c65 6e67 6874 7320 666f 7220 706f 7369  lenghts for posi
+0001db90: 7469 6f6e 2063 6f6c 756d 6e20 636f 6f72  tion column coor
+0001dba0: 6469 6e61 7465 730a 2020 2020 2020 2020  dinates.        
+0001dbb0: 6c65 6e67 7468 7320 3d20 6e70 2e7a 6572  lengths = np.zer
+0001dbc0: 6f73 2828 6c65 6e28 7468 6574 6173 292c  os((len(thetas),
+0001dbd0: 206c 656e 2869 6d67 5f79 5f63 6f6f 7264   len(img_y_coord
+0001dbe0: 7329 292c 2064 7479 7065 3d6e 702e 666c  s)), dtype=np.fl
+0001dbf0: 6f61 7436 3429 0a20 2020 2020 2020 2066  oat64).        f
+0001dc00: 6f72 2069 2c20 7468 6574 6120 696e 2065  or i, theta in e
+0001dc10: 6e75 6d65 7261 7465 2874 6865 7461 7329  numerate(thetas)
+0001dc20: 3a0a 2020 2020 2020 2020 2020 2020 6475  :.            du
+0001dc30: 6d6d 7920 3d20 7468 6574 610a 2020 2020  mmy = theta.    
+0001dc40: 2020 2020 2020 2020 7468 6574 6120 3d20          theta = 
+0001dc50: 7468 6574 6120 2d20 3930 2e2a 6e70 2e66  theta - 90.*np.f
+0001dc60: 6c6f 6f72 2874 6865 7461 2f39 302e 290a  loor(theta/90.).
+0001dc70: 2020 2020 2020 2020 2020 2020 6966 2034              if 4
+0001dc80: 352e 203c 2074 6865 7461 203c 3d20 3930  5. < theta <= 90
+0001dc90: 2e3a 0a20 2020 2020 2020 2020 2020 2020  .:.             
+0001dca0: 2020 2074 6865 7461 203d 2039 302e 2d74     theta = 90.-t
+0001dcb0: 6865 7461 0a20 2020 2020 2020 2020 2020  heta.           
+0001dcc0: 2074 6865 7461 5f72 6164 203d 2074 6865   theta_rad = the
+0001dcd0: 7461 2a6e 702e 7069 2f31 3830 2e0a 2020  ta*np.pi/180..  
+0001dce0: 2020 2020 2020 2020 2020 6c65 6e5f 6162            len_ab
+0001dcf0: 203d 2064 696d 2f6e 702e 636f 7328 7468   = dim/np.cos(th
+0001dd00: 6574 615f 7261 6429 0a20 2020 2020 2020  eta_rad).       
+0001dd10: 2020 2020 206c 656e 5f6f 6320 3d20 6469       len_oc = di
+0001dd20: 6d2a 6e70 2e63 6f73 2874 6865 7461 5f72  m*np.cos(theta_r
+0001dd30: 6164 2b30 2e32 352a 6e70 2e70 6929 2f6e  ad+0.25*np.pi)/n
+0001dd40: 702e 7371 7274 2832 2e29 0a20 2020 2020  p.sqrt(2.).     
+0001dd50: 2020 2020 2020 206c 656e 5f63 6520 3d20         len_ce = 
+0001dd60: 6469 6d2a 6e70 2e73 696e 2874 6865 7461  dim*np.sin(theta
+0001dd70: 5f72 6164 290a 2020 2020 2020 2020 2020  _rad).          
+0001dd80: 2020 696e 6465 7831 203d 2069 6e74 286e    index1 = int(n
+0001dd90: 702e 6172 676d 696e 286e 702e 6162 7328  p.argmin(np.abs(
+0001dda0: 696d 675f 795f 636f 6f72 6473 2d6c 656e  img_y_coords-len
+0001ddb0: 5f6f 6329 2929 0a20 2020 2020 2020 2020  _oc))).         
+0001ddc0: 2020 2069 6620 6c65 6e5f 6f63 203c 2069     if len_oc < i
+0001ddd0: 6d67 5f79 5f63 6f6f 7264 735b 696e 6465  mg_y_coords[inde
+0001dde0: 7831 5d20 616e 6420 696e 6465 7831 203e  x1] and index1 >
+0001ddf0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+0001de00: 2020 2020 696e 6465 7831 202d 3d20 310a      index1 -= 1.
+0001de10: 2020 2020 2020 2020 2020 2020 696e 6465              inde
+0001de20: 7832 203d 2069 6e74 286e 702e 6172 676d  x2 = int(np.argm
+0001de30: 696e 286e 702e 6162 7328 696d 675f 795f  in(np.abs(img_y_
+0001de40: 636f 6f72 6473 2d6c 656e 5f6f 632d 6c65  coords-len_oc-le
+0001de50: 6e5f 6365 2929 290a 2020 2020 2020 2020  n_ce))).        
+0001de60: 2020 2020 6966 206c 656e 5f6f 632b 6c65      if len_oc+le
+0001de70: 6e5f 6365 203c 2069 6d67 5f79 5f63 6f6f  n_ce < img_y_coo
+0001de80: 7264 735b 696e 6465 7832 5d3a 0a20 2020  rds[index2]:.   
+0001de90: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+0001dea0: 6578 3220 2d3d 2031 0a20 2020 2020 2020  ex2 -= 1.       
+0001deb0: 2020 2020 2069 6e64 6578 3120 2b3d 2031       index1 += 1
+0001dec0: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
+0001ded0: 6578 3220 2b3d 2031 0a20 2020 2020 2020  ex2 += 1.       
+0001dee0: 2020 2020 2066 6f72 206a 2069 6e20 7261       for j in ra
+0001def0: 6e67 6528 696e 6465 7831 293a 0a20 2020  nge(index1):.   
+0001df00: 2020 2020 2020 2020 2020 2020 206c 656e               len
+0001df10: 6774 6873 5b69 2c6a 5d20 3d20 6c65 6e5f  gths[i,j] = len_
+0001df20: 6162 0a20 2020 2020 2020 2020 2020 2066  ab.            f
+0001df30: 6f72 206a 2c20 636f 6c75 6d6e 2069 6e20  or j, column in 
+0001df40: 656e 756d 6572 6174 6528 696d 675f 795f  enumerate(img_y_
+0001df50: 636f 6f72 6473 5b69 6e64 6578 313a 696e  coords[index1:in
+0001df60: 6465 7832 5d29 3a0a 2020 2020 2020 2020  dex2]):.        
+0001df70: 2020 2020 2020 2020 6c65 6e67 7468 735b          lengths[
+0001df80: 692c 6a2b 696e 6465 7831 5d20 3d20 6c65  i,j+index1] = le
+0001df90: 6e5f 6162 2a28 6c65 6e5f 6f63 2b6c 656e  n_ab*(len_oc+len
+0001dfa0: 5f63 652d 636f 6c75 6d6e 292f 6c65 6e5f  _ce-column)/len_
+0001dfb0: 6365 0a0a 2020 2020 2020 2020 2320 4164  ce..        # Ad
+0001dfc0: 6420 7468 6520 6d69 7272 6f72 2069 6d61  d the mirror ima
+0001dfd0: 6765 2066 6f72 206e 6567 6174 6976 6520  ge for negative 
+0001dfe0: 636f 6c75 6d6e 2063 6f6f 7264 696e 6174  column coordinat
+0001dff0: 6573 0a20 2020 2020 2020 2069 6620 6c65  es.        if le
+0001e000: 6e28 696d 675f 795f 636f 6f72 6473 2925  n(img_y_coords)%
+0001e010: 323a 0a20 2020 2020 2020 2020 2020 206c  2:.            l
+0001e020: 656e 6774 6873 203d 206e 702e 636f 6e63  engths = np.conc
+0001e030: 6174 656e 6174 6528 0a20 2020 2020 2020  atenate(.       
+0001e040: 2020 2020 2020 2020 2028 6e70 2e66 6c69           (np.fli
+0001e050: 706c 7228 6c65 6e67 7468 735b 3a2c 313a  plr(lengths[:,1:
+0001e060: 5d29 2c20 6c65 6e67 7468 7329 2c20 6178  ]), lengths), ax
+0001e070: 6973 3d31 290a 2020 2020 2020 2020 656c  is=1).        el
+0001e080: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001e090: 6c65 6e67 7468 7320 3d20 6e70 2e63 6f6e  lengths = np.con
+0001e0a0: 6361 7465 6e61 7465 2828 6e70 2e66 6c69  catenate((np.fli
+0001e0b0: 706c 7228 6c65 6e67 7468 7329 2c20 6c65  plr(lengths), le
+0001e0c0: 6e67 7468 7329 2c20 6178 6973 3d31 290a  ngths), axis=1).
+0001e0d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001e0e0: 6c65 6e67 7468 730a 0a0a 636c 6173 7320  lengths...class 
+0001e0f0: 546f 6d6f 4461 726b 4669 656c 6450 726f  TomoDarkFieldPro
+0001e100: 6365 7373 6f72 2850 726f 6365 7373 6f72  cessor(Processor
+0001e110: 293a 0a20 2020 2022 2222 0a20 2020 2041  ):.    """.    A
+0001e120: 2070 726f 6365 7373 6f72 2074 6f20 6372   processor to cr
+0001e130: 6561 7465 2074 6865 2064 6172 6b20 6669  eate the dark fi
+0001e140: 656c 6420 6173 736f 6369 6174 6564 2077  eld associated w
+0001e150: 6974 6820 6120 7369 6d75 6c61 7465 640a  ith a simulated.
+0001e160: 2020 2020 746f 6d6f 6772 6170 6879 2064      tomography d
+0001e170: 6174 6120 7365 7420 6372 6561 7465 6420  ata set created 
+0001e180: 6279 2054 6f6d 6f53 696d 5072 6f63 6573  by TomoSimProces
+0001e190: 736f 722e 0a20 2020 2022 2222 0a0a 2020  sor..    """..  
+0001e1a0: 2020 6465 6620 7072 6f63 6573 7328 7365    def process(se
+0001e1b0: 6c66 2c20 6461 7461 2c20 6e75 6d5f 696d  lf, data, num_im
+0001e1c0: 6167 653d 352c 202a 2a6b 7761 7267 7329  age=5, **kwargs)
+0001e1d0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0001e1e0: 2020 2020 2020 5072 6f63 6573 7320 7468        Process th
+0001e1f0: 6520 696e 7075 7420 636f 6e66 6967 7572  e input configur
+0001e200: 6174 696f 6e20 616e 6420 7265 7475 726e  ation and return
+0001e210: 2061 0a20 2020 2020 2020 2060 6e65 7875   a.        `nexu
+0001e220: 7366 6f72 6d61 742e 6e65 7875 732e 4e58  sformat.nexus.NX
+0001e230: 726f 6f74 6020 6f62 6a65 6374 2077 6974  root` object wit
+0001e240: 6820 7468 6520 7369 6d75 6c61 7465 640a  h the simulated.
+0001e250: 2020 2020 2020 2020 6461 726b 2066 6965          dark fie
+0001e260: 6c64 2064 6574 6563 746f 7220 696d 6167  ld detector imag
+0001e270: 6573 2e0a 0a20 2020 2020 2020 203a 7061  es...        :pa
+0001e280: 7261 6d20 6461 7461 3a20 496e 7075 7420  ram data: Input 
+0001e290: 636f 6e66 6967 7572 6174 696f 6e20 666f  configuration fo
+0001e2a0: 7220 7468 6520 7369 6d75 6c61 7469 6f6e  r the simulation
+0001e2b0: 2e0a 2020 2020 2020 2020 3a74 7970 6520  ..        :type 
+0001e2c0: 6461 7461 3a20 6c69 7374 5b50 6970 656c  data: list[Pipel
+0001e2d0: 696e 6544 6174 615d 0a20 2020 2020 2020  ineData].       
+0001e2e0: 203a 7061 7261 6d20 6e75 6d5f 696d 6167   :param num_imag
+0001e2f0: 653a 204e 756d 6265 7220 6f66 2064 6172  e: Number of dar
+0001e300: 6b20 6669 656c 6420 696d 6167 6573 2c20  k field images, 
+0001e310: 6465 6661 756c 7473 2074 6f20 352e 0a20  defaults to 5.. 
+0001e320: 2020 2020 2020 203a 7479 7065 206e 756d         :type num
+0001e330: 5f69 6d61 6765 3a20 696e 742c 206f 7074  _image: int, opt
+0001e340: 696f 6e61 6c2e 0a20 2020 2020 2020 203a  ional..        :
+0001e350: 7265 7475 726e 3a20 5369 6d75 6c61 7465  return: Simulate
+0001e360: 6420 6461 726b 2066 6965 6c64 2069 6d61  d dark field ima
+0001e370: 6765 732e 0a20 2020 2020 2020 203a 7274  ges..        :rt
+0001e380: 7970 653a 206e 6578 7573 666f 726d 6174  ype: nexusformat
+0001e390: 2e6e 6578 7573 2e4e 5872 6f6f 740a 2020  .nexus.NXroot.  
+0001e3a0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0001e3b0: 2020 2320 5468 6972 6420 7061 7274 7920    # Third party 
+0001e3c0: 6d6f 6475 6c65 730a 2020 2020 2020 2020  modules.        
+0001e3d0: 6672 6f6d 206e 6578 7573 666f 726d 6174  from nexusformat
+0001e3e0: 2e6e 6578 7573 2069 6d70 6f72 7420 280a  .nexus import (.
+0001e3f0: 2020 2020 2020 2020 2020 2020 4e58 726f              NXro
+0001e400: 6f74 2c0a 2020 2020 2020 2020 2020 2020  ot,.            
+0001e410: 4e58 656e 7472 792c 0a20 2020 2020 2020  NXentry,.       
+0001e420: 2020 2020 204e 5869 6e73 7472 756d 656e       NXinstrumen
+0001e430: 742c 0a20 2020 2020 2020 2020 2020 204e  t,.            N
+0001e440: 5864 6574 6563 746f 722c 0a20 2020 2020  Xdetector,.     
+0001e450: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
+0001e460: 4765 7420 7468 6520 546f 6d6f 5369 6d46  Get the TomoSimF
+0001e470: 6965 6c64 2063 6f6e 6669 6775 7261 7469  ield configurati
+0001e480: 6f6e 206f 626a 6563 7420 696e 2064 6174  on object in dat
+0001e490: 610a 2020 2020 2020 2020 6e78 726f 6f74  a.        nxroot
+0001e4a0: 203d 2073 656c 662e 6765 745f 636f 6e66   = self.get_conf
+0001e4b0: 6967 2864 6174 6129 0a20 2020 2020 2020  ig(data).       
+0001e4c0: 2073 6f75 7263 6520 3d20 6e78 726f 6f74   source = nxroot
+0001e4d0: 2e65 6e74 7279 2e69 6e73 7472 756d 656e  .entry.instrumen
+0001e4e0: 742e 736f 7572 6365 0a20 2020 2020 2020  t.source.       
+0001e4f0: 2064 6574 6563 746f 7220 3d20 6e78 726f   detector = nxro
+0001e500: 6f74 2e65 6e74 7279 2e69 6e73 7472 756d  ot.entry.instrum
+0001e510: 656e 742e 6465 7465 6374 6f72 0a20 2020  ent.detector.   
+0001e520: 2020 2020 2062 6163 6b67 726f 756e 645f       background_
+0001e530: 696e 7465 6e73 6974 7920 3d20 736f 7572  intensity = sour
+0001e540: 6365 2e62 6163 6b67 726f 756e 645f 696e  ce.background_in
+0001e550: 7465 6e73 6974 790a 2020 2020 2020 2020  tensity.        
+0001e560: 6465 7465 6374 6f72 5f73 697a 6520 3d20  detector_size = 
+0001e570: 6465 7465 6374 6f72 2e64 6174 612e 7368  detector.data.sh
+0001e580: 6170 655b 2d32 3a5d 0a0a 2020 2020 2020  ape[-2:]..      
+0001e590: 2020 2320 4164 6420 6475 6d6d 7920 736e    # Add dummy sn
+0001e5a0: 6170 7368 6f74 7320 6174 2073 7461 7274  apshots at start
+0001e5b0: 2074 6f20 6d69 6d69 6320 534d 420a 2020   to mimic SMB.  
+0001e5c0: 2020 2020 2020 6966 2073 6f75 7263 652e        if source.
+0001e5d0: 7374 6174 696f 6e20 696e 2028 2769 6431  station in ('id1
+0001e5e0: 6133 272c 2027 6964 3361 2729 3a0a 2020  a3', 'id3a'):.  
+0001e5f0: 2020 2020 2020 2020 2020 6e75 6d5f 7468            num_th
+0001e600: 6574 615f 6475 6d6d 795f 7374 6172 7420  eta_dummy_start 
+0001e610: 3d20 350a 2020 2020 2020 2020 656c 7365  = 5.        else
+0001e620: 3a0a 2020 2020 2020 2020 2020 2020 6e75  :.            nu
+0001e630: 6d5f 7468 6574 615f 6475 6d6d 795f 7374  m_theta_dummy_st
+0001e640: 6172 7420 3d20 300a 2020 2020 2020 2020  art = 0.        
+0001e650: 6e75 6d5f 696d 6167 6520 2b3d 206e 756d  num_image += num
+0001e660: 5f74 6865 7461 5f64 756d 6d79 5f73 7461  _theta_dummy_sta
+0001e670: 7274 0a0a 2020 2020 2020 2020 2320 4372  rt..        # Cr
+0001e680: 6561 7465 2074 6865 2064 6172 6b20 6669  eate the dark fi
+0001e690: 656c 640a 2020 2020 2020 2020 6461 726b  eld.        dark
+0001e6a0: 5f66 6965 6c64 203d 2069 6e74 2862 6163  _field = int(bac
+0001e6b0: 6b67 726f 756e 645f 696e 7465 6e73 6974  kground_intensit
+0001e6c0: 7929 202a 206e 702e 6f6e 6573 280a 2020  y) * np.ones(.  
+0001e6d0: 2020 2020 2020 2020 2020 286e 756d 5f69            (num_i
+0001e6e0: 6d61 6765 2c20 6465 7465 6374 6f72 5f73  mage, detector_s
+0001e6f0: 697a 655b 305d 2c20 6465 7465 6374 6f72  ize[0], detector
+0001e700: 5f73 697a 655b 315d 292c 2064 7479 7065  _size[1]), dtype
+0001e710: 3d6e 702e 696e 7436 3429 0a0a 2020 2020  =np.int64)..    
+0001e720: 2020 2020 2320 4372 6561 7465 204e 6578      # Create Nex
+0001e730: 7573 206f 626a 6563 7420 616e 6420 7772  us object and wr
+0001e740: 6974 6520 746f 2066 696c 650a 2020 2020  ite to file.    
+0001e750: 2020 2020 6e78 6461 726b 203d 204e 5872      nxdark = NXr
+0001e760: 6f6f 7428 290a 2020 2020 2020 2020 6e78  oot().        nx
+0001e770: 6461 726b 2e65 6e74 7279 203d 204e 5865  dark.entry = NXe
+0001e780: 6e74 7279 2829 0a20 2020 2020 2020 206e  ntry().        n
+0001e790: 7864 6172 6b2e 656e 7472 792e 7361 6d70  xdark.entry.samp
+0001e7a0: 6c65 203d 206e 7872 6f6f 742e 656e 7472  le = nxroot.entr
+0001e7b0: 792e 7361 6d70 6c65 0a20 2020 2020 2020  y.sample.       
+0001e7c0: 206e 7869 6e73 7472 756d 656e 7420 3d20   nxinstrument = 
+0001e7d0: 4e58 696e 7374 7275 6d65 6e74 2829 0a20  NXinstrument(). 
+0001e7e0: 2020 2020 2020 206e 7864 6172 6b2e 656e         nxdark.en
+0001e7f0: 7472 792e 696e 7374 7275 6d65 6e74 203d  try.instrument =
+0001e800: 206e 7869 6e73 7472 756d 656e 740a 2020   nxinstrument.  
+0001e810: 2020 2020 2020 6e78 696e 7374 7275 6d65        nxinstrume
+0001e820: 6e74 2e73 6f75 7263 6520 3d20 6e78 726f  nt.source = nxro
+0001e830: 6f74 2e65 6e74 7279 2e69 6e73 7472 756d  ot.entry.instrum
+0001e840: 656e 742e 736f 7572 6365 0a20 2020 2020  ent.source.     
+0001e850: 2020 206e 7864 6574 6563 746f 7220 3d20     nxdetector = 
+0001e860: 4e58 6465 7465 6374 6f72 2829 0a20 2020  NXdetector().   
+0001e870: 2020 2020 206e 7869 6e73 7472 756d 656e       nxinstrumen
+0001e880: 742e 6465 7465 6374 6f72 203d 206e 7864  t.detector = nxd
+0001e890: 6574 6563 746f 720a 2020 2020 2020 2020  etector.        
+0001e8a0: 6e78 6465 7465 6374 6f72 2e6c 6f63 616c  nxdetector.local
+0001e8b0: 5f6e 616d 6520 3d20 6465 7465 6374 6f72  _name = detector
+0001e8c0: 2e6c 6f63 616c 5f6e 616d 650a 2020 2020  .local_name.    
+0001e8d0: 2020 2020 6e78 6465 7465 6374 6f72 2e78      nxdetector.x
+0001e8e0: 5f70 6978 656c 5f73 697a 6520 3d20 6465  _pixel_size = de
+0001e8f0: 7465 6374 6f72 2e78 5f70 6978 656c 5f73  tector.x_pixel_s
+0001e900: 697a 650a 2020 2020 2020 2020 6e78 6465  ize.        nxde
+0001e910: 7465 6374 6f72 2e79 5f70 6978 656c 5f73  tector.y_pixel_s
+0001e920: 697a 6520 3d20 6465 7465 6374 6f72 2e79  ize = detector.y
+0001e930: 5f70 6978 656c 5f73 697a 650a 2020 2020  _pixel_size.    
+0001e940: 2020 2020 6e78 6465 7465 6374 6f72 2e64      nxdetector.d
+0001e950: 6174 6120 3d20 6461 726b 5f66 6965 6c64  ata = dark_field
+0001e960: 0a20 2020 2020 2020 206e 7864 6574 6563  .        nxdetec
+0001e970: 746f 722e 7468 6574 6173 203d 206e 702e  tor.thetas = np.
+0001e980: 6173 6172 7261 7928 6e75 6d5f 696d 6167  asarray(num_imag
+0001e990: 652a 5b30 5d29 0a20 2020 2020 2020 206e  e*[0]).        n
+0001e9a0: 7864 6574 6563 746f 722e 6672 616d 655f  xdetector.frame_
+0001e9b0: 7374 6172 745f 6e75 6d62 6572 203d 206e  start_number = n
+0001e9c0: 756d 5f74 6865 7461 5f64 756d 6d79 5f73  um_theta_dummy_s
+0001e9d0: 7461 7274 0a0a 2020 2020 2020 2020 7265  tart..        re
+0001e9e0: 7475 726e 206e 7864 6172 6b0a 0a20 2020  turn nxdark..   
+0001e9f0: 2064 6566 2067 6574 5f63 6f6e 6669 6728   def get_config(
+0001ea00: 7365 6c66 2c20 6461 7461 293a 0a20 2020  self, data):.   
+0001ea10: 2020 2020 2022 2222 4765 7420 616e 2069       """Get an i
+0001ea20: 6e73 7461 6e63 6520 6f66 2074 6865 2063  nstance of the c
+0001ea30: 6f6e 6669 6775 7261 7469 6f6e 206f 626a  onfiguration obj
+0001ea40: 6563 7420 6e65 6564 6564 2062 7920 7468  ect needed by th
+0001ea50: 6973 0a20 2020 2020 2020 2060 5072 6f63  is.        `Proc
+0001ea60: 6573 736f 7260 2066 726f 6d20 6120 6c69  essor` from a li
+0001ea70: 7374 206f 6620 6050 6970 656c 696e 6544  st of `PipelineD
+0001ea80: 6174 6160 206f 626a 6563 7473 2e0a 0a20  ata` objects... 
+0001ea90: 2020 2020 2020 203a 7061 7261 6d20 6461         :param da
+0001eaa0: 7461 3a20 496e 7075 7420 6c69 7374 206f  ta: Input list o
+0001eab0: 6620 6050 6970 656c 696e 6544 6174 6160  f `PipelineData`
+0001eac0: 206f 626a 6563 7473 2c20 7768 6572 6520   objects, where 
+0001ead0: 6174 0a20 2020 2020 2020 2020 2020 206c  at.            l
+0001eae0: 6561 7374 206f 6e65 2069 7465 6d20 6861  east one item ha
+0001eaf0: 7320 6027 546f 6d6f 5369 6d46 6965 6c64  s `'TomoSimField
+0001eb00: 2760 2066 6f72 2074 6865 2060 2773 6368  '` for the `'sch
+0001eb10: 656d 6127 6020 6b65 792e 0a20 2020 2020  ema'` key..     
+0001eb20: 2020 203a 7479 7065 2064 6174 613a 206c     :type data: l
+0001eb30: 6973 745b 5069 7065 6c69 6e65 4461 7461  ist[PipelineData
+0001eb40: 5d0a 2020 2020 2020 2020 3a72 6169 7365  ].        :raise
+0001eb50: 7320 5661 6c75 6545 7272 6f72 3a20 4966  s ValueError: If
+0001eb60: 2061 2076 616c 6964 2063 6f6e 6669 6720   a valid config 
+0001eb70: 6f62 6a65 6374 2063 616e 6e6f 7420 6265  object cannot be
+0001eb80: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0001eb90: 7374 7275 6374 6564 2066 726f 6d20 6064  structed from `d
+0001eba0: 6174 6160 2e0a 2020 2020 2020 2020 3a72  ata`..        :r
+0001ebb0: 6574 7572 6e3a 2056 616c 6964 2069 6e73  eturn: Valid ins
+0001ebc0: 7461 6e63 6520 6f66 2061 2063 6f6e 6669  tance of a confi
+0001ebd0: 6775 7261 7469 6f6e 206f 626a 6563 7420  guration object 
+0001ebe0: 7769 7468 2066 6965 6c64 0a20 2020 2020  with field.     
+0001ebf0: 2020 2020 2020 2076 616c 7565 7320 7461         values ta
+0001ec00: 6b65 6e20 6672 6f6d 2060 6461 7461 602e  ken from `data`.
+0001ec10: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
+0001ec20: 206e 6578 7573 666f 726d 6174 2e6e 6578   nexusformat.nex
+0001ec30: 7573 2e4e 5872 6f6f 740a 2020 2020 2020  us.NXroot.      
+0001ec40: 2020 2222 220a 2020 2020 2020 2020 6e78    """.        nx
+0001ec50: 726f 6f74 203d 204e 6f6e 650a 2020 2020  root = None.    
+0001ec60: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0001ec70: 6528 6461 7461 2c20 6c69 7374 293a 0a20  e(data, list):. 
+0001ec80: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0001ec90: 7465 6d20 696e 2064 6174 613a 0a20 2020  tem in data:.   
+0001eca0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001ecb0: 6973 696e 7374 616e 6365 2869 7465 6d2c  isinstance(item,
+0001ecc0: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
+0001ecd0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+0001ece0: 7465 6d2e 6765 7428 2773 6368 656d 6127  tem.get('schema'
+0001ecf0: 2920 3d3d 2027 546f 6d6f 5369 6d46 6965  ) == 'TomoSimFie
+0001ed00: 6c64 273a 0a20 2020 2020 2020 2020 2020  ld':.           
+0001ed10: 2020 2020 2020 2020 2020 2020 206e 7872               nxr
+0001ed20: 6f6f 7420 3d20 6974 656d 2e67 6574 2827  oot = item.get('
+0001ed30: 6461 7461 2729 0a20 2020 2020 2020 2020  data').         
+0001ed40: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0001ed50: 7265 616b 0a20 2020 2020 2020 2069 6620  reak.        if 
+0001ed60: 6e78 726f 6f74 2069 7320 4e6f 6e65 3a0a  nxroot is None:.
+0001ed70: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001ed80: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
+0001ed90: 2020 2020 2020 2020 2020 2020 2020 274e                'N
+0001eda0: 6f20 746f 6d6f 6772 6170 6879 2064 6174  o tomography dat
+0001edb0: 6120 7365 7420 666f 756e 6420 696e 2069  a set found in i
+0001edc0: 6e70 7574 2064 6174 6127 290a 0a20 2020  nput data')..   
+0001edd0: 2020 2020 2072 6574 7572 6e20 6e78 726f       return nxro
+0001ede0: 6f74 0a0a 0a63 6c61 7373 2054 6f6d 6f42  ot...class TomoB
+0001edf0: 7269 6768 7446 6965 6c64 5072 6f63 6573  rightFieldProces
+0001ee00: 736f 7228 5072 6f63 6573 736f 7229 3a0a  sor(Processor):.
+0001ee10: 2020 2020 2222 220a 2020 2020 4120 7072      """.    A pr
+0001ee20: 6f63 6573 736f 7220 746f 2063 7265 6174  ocessor to creat
+0001ee30: 6520 7468 6520 6272 6967 6874 2066 6965  e the bright fie
+0001ee40: 6c64 2061 7373 6f63 6961 7465 6420 7769  ld associated wi
+0001ee50: 7468 2061 2073 696d 756c 6174 6564 0a20  th a simulated. 
+0001ee60: 2020 2074 6f6d 6f67 7261 7068 7920 6461     tomography da
+0001ee70: 7461 2073 6574 2063 7265 6174 6564 2062  ta set created b
+0001ee80: 7920 546f 6d6f 5369 6d50 726f 6365 7373  y TomoSimProcess
+0001ee90: 6f72 2e0a 2020 2020 2222 220a 0a20 2020  or..    """..   
+0001eea0: 2064 6566 2070 726f 6365 7373 2873 656c   def process(sel
+0001eeb0: 662c 2064 6174 612c 206e 756d 5f69 6d61  f, data, num_ima
+0001eec0: 6765 3d35 2c20 2a2a 6b77 6172 6773 293a  ge=5, **kwargs):
+0001eed0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0001eee0: 2020 2020 2050 726f 6365 7373 2074 6865       Process the
+0001eef0: 2069 6e70 7574 2063 6f6e 6669 6775 7261   input configura
+0001ef00: 7469 6f6e 2061 6e64 2072 6574 7572 6e20  tion and return 
+0001ef10: 610a 2020 2020 2020 2020 606e 6578 7573  a.        `nexus
+0001ef20: 666f 726d 6174 2e6e 6578 7573 2e4e 5872  format.nexus.NXr
+0001ef30: 6f6f 7460 206f 626a 6563 7420 7769 7468  oot` object with
+0001ef40: 2074 6865 2073 696d 756c 6174 6564 0a20   the simulated. 
+0001ef50: 2020 2020 2020 2062 7269 6768 7420 6669         bright fi
+0001ef60: 656c 6420 6465 7465 6374 6f72 2069 6d61  eld detector ima
+0001ef70: 6765 732e 0a0a 2020 2020 2020 2020 3a70  ges...        :p
+0001ef80: 6172 616d 2064 6174 613a 2049 6e70 7574  aram data: Input
+0001ef90: 2063 6f6e 6669 6775 7261 7469 6f6e 2066   configuration f
+0001efa0: 6f72 2074 6865 2073 696d 756c 6174 696f  or the simulatio
+0001efb0: 6e2e 0a20 2020 2020 2020 203a 7479 7065  n..        :type
+0001efc0: 2064 6174 613a 206c 6973 745b 5069 7065   data: list[Pipe
+0001efd0: 6c69 6e65 4461 7461 5d0a 2020 2020 2020  lineData].      
+0001efe0: 2020 3a70 6172 616d 206e 756d 5f69 6d61    :param num_ima
+0001eff0: 6765 3a20 4e75 6d62 6572 206f 6620 6272  ge: Number of br
+0001f000: 6967 6874 2066 6965 6c64 2069 6d61 6765  ight field image
+0001f010: 732c 2064 6566 6175 6c74 7320 746f 2035  s, defaults to 5
+0001f020: 2e0a 2020 2020 2020 2020 3a74 7970 6520  ..        :type 
+0001f030: 6e75 6d5f 696d 6167 653a 2069 6e74 2c20  num_image: int, 
+0001f040: 6f70 7469 6f6e 616c 2e0a 2020 2020 2020  optional..      
+0001f050: 2020 3a72 6574 7572 6e3a 2053 696d 756c    :return: Simul
+0001f060: 6174 6564 2062 7269 6768 7420 6669 656c  ated bright fiel
+0001f070: 6420 696d 6167 6573 2e0a 2020 2020 2020  d images..      
+0001f080: 2020 3a72 7479 7065 3a20 6e65 7875 7366    :rtype: nexusf
+0001f090: 6f72 6d61 742e 6e65 7875 732e 4e58 726f  ormat.nexus.NXro
+0001f0a0: 6f74 0a20 2020 2020 2020 2022 2222 0a20  ot.        """. 
+0001f0b0: 2020 2020 2020 2023 2054 6869 7264 2070         # Third p
+0001f0c0: 6172 7479 206d 6f64 756c 6573 0a20 2020  arty modules.   
+0001f0d0: 2020 2020 2066 726f 6d20 6e65 7875 7366       from nexusf
+0001f0e0: 6f72 6d61 742e 6e65 7875 7320 696d 706f  ormat.nexus impo
+0001f0f0: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
+0001f100: 204e 6558 7573 4572 726f 722c 0a20 2020   NeXusError,.   
+0001f110: 2020 2020 2020 2020 204e 5872 6f6f 742c           NXroot,
+0001f120: 0a20 2020 2020 2020 2020 2020 204e 5865  .            NXe
+0001f130: 6e74 7279 2c0a 2020 2020 2020 2020 2020  ntry,.          
+0001f140: 2020 4e58 696e 7374 7275 6d65 6e74 2c0a    NXinstrument,.
+0001f150: 2020 2020 2020 2020 2020 2020 4e58 6465              NXde
+0001f160: 7465 6374 6f72 2c0a 2020 2020 2020 2020  tector,.        
+0001f170: 290a 0a20 2020 2020 2020 2023 2047 6574  )..        # Get
+0001f180: 2061 6e64 2076 616c 6964 6174 6520 7468   and validate th
+0001f190: 6520 546f 6d6f 5369 6d46 6965 6c64 2063  e TomoSimField c
+0001f1a0: 6f6e 6669 6775 7261 7469 6f6e 206f 626a  onfiguration obj
+0001f1b0: 6563 7420 696e 2064 6174 610a 2020 2020  ect in data.    
+0001f1c0: 2020 2020 6e78 726f 6f74 203d 2073 656c      nxroot = sel
+0001f1d0: 662e 6765 745f 636f 6e66 6967 2864 6174  f.get_config(dat
+0001f1e0: 6129 0a20 2020 2020 2020 2073 6f75 7263  a).        sourc
+0001f1f0: 6520 3d20 6e78 726f 6f74 2e65 6e74 7279  e = nxroot.entry
+0001f200: 2e69 6e73 7472 756d 656e 742e 736f 7572  .instrument.sour
+0001f210: 6365 0a20 2020 2020 2020 2064 6574 6563  ce.        detec
+0001f220: 746f 7220 3d20 6e78 726f 6f74 2e65 6e74  tor = nxroot.ent
+0001f230: 7279 2e69 6e73 7472 756d 656e 742e 6465  ry.instrument.de
+0001f240: 7465 6374 6f72 0a20 2020 2020 2020 2062  tector.        b
+0001f250: 6561 6d5f 696e 7465 6e73 6974 7920 3d20  eam_intensity = 
+0001f260: 736f 7572 6365 2e62 6561 6d5f 696e 7465  source.beam_inte
+0001f270: 6e73 6974 790a 2020 2020 2020 2020 6261  nsity.        ba
+0001f280: 636b 6772 6f75 6e64 5f69 6e74 656e 7369  ckground_intensi
+0001f290: 7479 203d 2073 6f75 7263 652e 6261 636b  ty = source.back
+0001f2a0: 6772 6f75 6e64 5f69 6e74 656e 7369 7479  ground_intensity
+0001f2b0: 0a20 2020 2020 2020 2064 6574 6563 746f  .        detecto
+0001f2c0: 725f 7369 7a65 203d 2064 6574 6563 746f  r_size = detecto
+0001f2d0: 722e 6461 7461 2e73 6861 7065 5b2d 323a  r.data.shape[-2:
+0001f2e0: 5d0a 0a20 2020 2020 2020 2023 2041 6464  ]..        # Add
+0001f2f0: 2064 756d 6d79 2073 6e61 7073 686f 7473   dummy snapshots
+0001f300: 2061 7420 7374 6172 7420 746f 206d 696d   at start to mim
+0001f310: 6963 2053 4d42 0a20 2020 2020 2020 2069  ic SMB.        i
+0001f320: 6620 736f 7572 6365 2e73 7461 7469 6f6e  f source.station
+0001f330: 2069 6e20 2827 6964 3161 3327 2c20 2769   in ('id1a3', 'i
+0001f340: 6433 6127 293a 0a20 2020 2020 2020 2020  d3a'):.         
+0001f350: 2020 206e 756d 5f74 6865 7461 5f64 756d     num_theta_dum
+0001f360: 6d79 5f73 7461 7274 203d 2035 0a20 2020  my_start = 5.   
+0001f370: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001f380: 2020 2020 2020 206e 756d 5f74 6865 7461         num_theta
+0001f390: 5f64 756d 6d79 5f73 7461 7274 203d 2030  _dummy_start = 0
+0001f3a0: 0a20 2020 2020 2020 206e 756d 5f69 6d61  .        num_ima
+0001f3b0: 6765 202b 3d20 6e75 6d5f 7468 6574 615f  ge += num_theta_
+0001f3c0: 6475 6d6d 795f 7374 6172 740a 0a20 2020  dummy_start..   
+0001f3d0: 2020 2020 2023 2043 7265 6174 6520 7468       # Create th
+0001f3e0: 6520 6272 6967 6874 2066 6965 6c64 0a20  e bright field. 
+0001f3f0: 2020 2020 2020 2062 7269 6768 745f 6669         bright_fi
+0001f400: 656c 6420 3d20 696e 7428 6261 636b 6772  eld = int(backgr
+0001f410: 6f75 6e64 5f69 6e74 656e 7369 7479 2b62  ound_intensity+b
+0001f420: 6561 6d5f 696e 7465 6e73 6974 7929 202a  eam_intensity) *
+0001f430: 206e 702e 6f6e 6573 280a 2020 2020 2020   np.ones(.      
+0001f440: 2020 2020 2020 286e 756d 5f69 6d61 6765        (num_image
+0001f450: 2c20 6465 7465 6374 6f72 5f73 697a 655b  , detector_size[
+0001f460: 305d 2c20 6465 7465 6374 6f72 5f73 697a  0], detector_siz
+0001f470: 655b 315d 292c 2064 7479 7065 3d6e 702e  e[1]), dtype=np.
+0001f480: 696e 7436 3429 0a20 2020 2020 2020 2023  int64).        #
+0001f490: 2041 6464 2031 3025 2074 6f20 736c 6974   Add 10% to slit
+0001f4a0: 2073 697a 6520 746f 206d 616b 6520 7468   size to make th
+0001f4b0: 6520 6272 6967 6874 2062 6561 6d20 736c  e bright beam sl
+0001f4c0: 6967 6874 6c79 2074 616c 6c65 720a 2020  ightly taller.  
+0001f4d0: 2020 2020 2020 2320 2020 2020 7468 616e        #     than
+0001f4e0: 2074 6865 2076 6572 7469 6361 6c20 6469   the vertical di
+0001f4f0: 7370 6c61 6365 6d65 6e74 7320 6265 7477  splacements betw
+0001f500: 6565 6e20 7374 6163 6b73 0a20 2020 2020  een stacks.     
+0001f510: 2020 2073 6c69 745f 7369 7a65 203d 2031     slit_size = 1
+0001f520: 2e31 302a 736f 7572 6365 2e73 6c69 745f  .10*source.slit_
+0001f530: 7369 7a65 0a20 2020 2020 2020 2069 6620  size.        if 
+0001f540: 736c 6974 5f73 697a 6520 3c20 6465 7465  slit_size < dete
+0001f550: 6374 6f72 2e78 5f70 6978 656c 5f73 697a  ctor.x_pixel_siz
+0001f560: 652a 6465 7465 6374 6f72 5f73 697a 655b  e*detector_size[
+0001f570: 305d 3a0a 2020 2020 2020 2020 2020 2020  0]:.            
+0001f580: 696d 675f 785f 636f 6f72 6473 203d 2064  img_x_coords = d
+0001f590: 6574 6563 746f 722e 785f 7069 7865 6c5f  etector.x_pixel_
+0001f5a0: 7369 7a65 205c 0a20 2020 2020 2020 2020  size \.         
+0001f5b0: 2020 2020 2020 202a 2028 302e 3520 2b20         * (0.5 + 
+0001f5c0: 6e70 2e61 7361 7272 6179 2872 616e 6765  np.asarray(range
+0001f5d0: 2869 6e74 2864 6574 6563 746f 725f 7369  (int(detector_si
+0001f5e0: 7a65 5b30 5d29 2929 0a20 2020 2020 2020  ze[0]))).       
+0001f5f0: 2020 2020 2020 2020 2020 2020 2d20 302e              - 0.
+0001f600: 352a 6465 7465 6374 6f72 5f73 697a 655b  5*detector_size[
+0001f610: 305d 290a 2020 2020 2020 2020 2020 2020  0]).            
+0001f620: 6f75 7465 725f 696e 6469 6365 7320 3d20  outer_indices = 
+0001f630: 6e70 2e77 6865 7265 2861 6273 2869 6d67  np.where(abs(img
+0001f640: 5f78 5f63 6f6f 7264 7329 203e 2073 6c69  _x_coords) > sli
+0001f650: 745f 7369 7a65 2f32 295b 305d 0a20 2020  t_size/2)[0].   
+0001f660: 2020 2020 2020 2020 2062 7269 6768 745f           bright_
+0001f670: 6669 656c 645b 3a2c 6f75 7465 725f 696e  field[:,outer_in
+0001f680: 6469 6365 732c 3a5d 203d 2030 0a0a 2020  dices,:] = 0..  
+0001f690: 2020 2020 2020 2320 4372 6561 7465 204e        # Create N
+0001f6a0: 6578 7573 206f 626a 6563 7420 616e 6420  exus object and 
+0001f6b0: 7772 6974 6520 746f 2066 696c 650a 2020  write to file.  
+0001f6c0: 2020 2020 2020 6e78 6272 6967 6874 203d        nxbright =
+0001f6d0: 204e 5872 6f6f 7428 290a 2020 2020 2020   NXroot().      
+0001f6e0: 2020 6e78 6272 6967 6874 2e65 6e74 7279    nxbright.entry
+0001f6f0: 203d 204e 5865 6e74 7279 2829 0a20 2020   = NXentry().   
+0001f700: 2020 2020 206e 7862 7269 6768 742e 656e       nxbright.en
+0001f710: 7472 792e 7361 6d70 6c65 203d 206e 7872  try.sample = nxr
+0001f720: 6f6f 742e 656e 7472 792e 7361 6d70 6c65  oot.entry.sample
+0001f730: 0a20 2020 2020 2020 206e 7869 6e73 7472  .        nxinstr
+0001f740: 756d 656e 7420 3d20 4e58 696e 7374 7275  ument = NXinstru
+0001f750: 6d65 6e74 2829 0a20 2020 2020 2020 206e  ment().        n
+0001f760: 7862 7269 6768 742e 656e 7472 792e 696e  xbright.entry.in
+0001f770: 7374 7275 6d65 6e74 203d 206e 7869 6e73  strument = nxins
+0001f780: 7472 756d 656e 740a 2020 2020 2020 2020  trument.        
+0001f790: 6e78 696e 7374 7275 6d65 6e74 2e73 6f75  nxinstrument.sou
+0001f7a0: 7263 6520 3d20 6e78 726f 6f74 2e65 6e74  rce = nxroot.ent
+0001f7b0: 7279 2e69 6e73 7472 756d 656e 742e 736f  ry.instrument.so
+0001f7c0: 7572 6365 0a20 2020 2020 2020 206e 7864  urce.        nxd
+0001f7d0: 6574 6563 746f 7220 3d20 4e58 6465 7465  etector = NXdete
+0001f7e0: 6374 6f72 2829 0a20 2020 2020 2020 206e  ctor().        n
+0001f7f0: 7869 6e73 7472 756d 656e 742e 6465 7465  xinstrument.dete
+0001f800: 6374 6f72 203d 206e 7864 6574 6563 746f  ctor = nxdetecto
+0001f810: 720a 2020 2020 2020 2020 6e78 6465 7465  r.        nxdete
+0001f820: 6374 6f72 2e6c 6f63 616c 5f6e 616d 6520  ctor.local_name 
+0001f830: 3d20 6465 7465 6374 6f72 2e6c 6f63 616c  = detector.local
+0001f840: 5f6e 616d 650a 2020 2020 2020 2020 6e78  _name.        nx
+0001f850: 6465 7465 6374 6f72 2e78 5f70 6978 656c  detector.x_pixel
+0001f860: 5f73 697a 6520 3d20 6465 7465 6374 6f72  _size = detector
+0001f870: 2e78 5f70 6978 656c 5f73 697a 650a 2020  .x_pixel_size.  
+0001f880: 2020 2020 2020 6e78 6465 7465 6374 6f72        nxdetector
+0001f890: 2e79 5f70 6978 656c 5f73 697a 6520 3d20  .y_pixel_size = 
+0001f8a0: 6465 7465 6374 6f72 2e79 5f70 6978 656c  detector.y_pixel
+0001f8b0: 5f73 697a 650a 2020 2020 2020 2020 6e78  _size.        nx
+0001f8c0: 6465 7465 6374 6f72 2e64 6174 6120 3d20  detector.data = 
+0001f8d0: 6272 6967 6874 5f66 6965 6c64 0a20 2020  bright_field.   
+0001f8e0: 2020 2020 206e 7864 6574 6563 746f 722e       nxdetector.
+0001f8f0: 7468 6574 6173 203d 206e 702e 6173 6172  thetas = np.asar
+0001f900: 7261 7928 6e75 6d5f 696d 6167 652a 5b30  ray(num_image*[0
+0001f910: 5d29 0a20 2020 2020 2020 206e 7864 6574  ]).        nxdet
+0001f920: 6563 746f 722e 6672 616d 655f 7374 6172  ector.frame_star
+0001f930: 745f 6e75 6d62 6572 203d 206e 756d 5f74  t_number = num_t
+0001f940: 6865 7461 5f64 756d 6d79 5f73 7461 7274  heta_dummy_start
+0001f950: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0001f960: 206e 7862 7269 6768 740a 0a20 2020 2064   nxbright..    d
+0001f970: 6566 2067 6574 5f63 6f6e 6669 6728 7365  ef get_config(se
+0001f980: 6c66 2c20 6461 7461 293a 0a20 2020 2020  lf, data):.     
+0001f990: 2020 2022 2222 4765 7420 616e 2069 6e73     """Get an ins
+0001f9a0: 7461 6e63 6520 6f66 2074 6865 2063 6f6e  tance of the con
+0001f9b0: 6669 6775 7261 7469 6f6e 206f 626a 6563  figuration objec
+0001f9c0: 7420 6e65 6564 6564 2062 7920 7468 6973  t needed by this
+0001f9d0: 0a20 2020 2020 2020 2060 5072 6f63 6573  .        `Proces
+0001f9e0: 736f 7260 2066 726f 6d20 6120 6c69 7374  sor` from a list
+0001f9f0: 206f 6620 6050 6970 656c 696e 6544 6174   of `PipelineDat
+0001fa00: 6160 206f 626a 6563 7473 2e0a 0a20 2020  a` objects...   
+0001fa10: 2020 2020 203a 7061 7261 6d20 6461 7461       :param data
+0001fa20: 3a20 496e 7075 7420 6c69 7374 206f 6620  : Input list of 
+0001fa30: 6050 6970 656c 696e 6544 6174 6160 206f  `PipelineData` o
+0001fa40: 626a 6563 7473 2c20 7768 6572 6520 6174  bjects, where at
+0001fa50: 0a20 2020 2020 2020 2020 2020 206c 6561  .            lea
+0001fa60: 7374 206f 6e65 2069 7465 6d20 6861 7320  st one item has 
+0001fa70: 6027 546f 6d6f 5369 6d46 6965 6c64 2760  `'TomoSimField'`
+0001fa80: 2066 6f72 2074 6865 2060 2773 6368 656d   for the `'schem
+0001fa90: 6127 6020 6b65 792e 0a20 2020 2020 2020  a'` key..       
+0001faa0: 203a 7479 7065 2064 6174 613a 206c 6973   :type data: lis
+0001fab0: 745b 5069 7065 6c69 6e65 4461 7461 5d0a  t[PipelineData].
+0001fac0: 2020 2020 2020 2020 3a72 6169 7365 7320          :raises 
+0001fad0: 5661 6c75 6545 7272 6f72 3a20 4966 2061  ValueError: If a
+0001fae0: 2076 616c 6964 2063 6f6e 6669 6720 6f62   valid config ob
+0001faf0: 6a65 6374 2063 616e 6e6f 7420 6265 0a20  ject cannot be. 
+0001fb00: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0001fb10: 7275 6374 6564 2066 726f 6d20 6064 6174  ructed from `dat
+0001fb20: 6160 2e0a 2020 2020 2020 2020 3a72 6574  a`..        :ret
+0001fb30: 7572 6e3a 2056 616c 6964 2069 6e73 7461  urn: Valid insta
+0001fb40: 6e63 6520 6f66 2061 2063 6f6e 6669 6775  nce of a configu
+0001fb50: 7261 7469 6f6e 206f 626a 6563 7420 7769  ration object wi
+0001fb60: 7468 2066 6965 6c64 0a20 2020 2020 2020  th field.       
+0001fb70: 2020 2020 2076 616c 7565 7320 7461 6b65       values take
+0001fb80: 6e20 6672 6f6d 2060 6461 7461 602e 0a20  n from `data`.. 
+0001fb90: 2020 2020 2020 203a 7274 7970 653a 206e         :rtype: n
+0001fba0: 6578 7573 666f 726d 6174 2e6e 6578 7573  exusformat.nexus
+0001fbb0: 2e4e 5872 6f6f 740a 2020 2020 2020 2020  .NXroot.        
+0001fbc0: 2222 220a 2020 2020 2020 2020 6e78 726f  """.        nxro
+0001fbd0: 6f74 203d 204e 6f6e 650a 2020 2020 2020  ot = None.      
+0001fbe0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0001fbf0: 6461 7461 2c20 6c69 7374 293a 0a20 2020  data, list):.   
+0001fc00: 2020 2020 2020 2020 2066 6f72 2069 7465           for ite
+0001fc10: 6d20 696e 2064 6174 613a 0a20 2020 2020  m in data:.     
+0001fc20: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0001fc30: 696e 7374 616e 6365 2869 7465 6d2c 2064  instance(item, d
+0001fc40: 6963 7429 3a0a 2020 2020 2020 2020 2020  ict):.          
+0001fc50: 2020 2020 2020 2020 2020 6966 2069 7465            if ite
+0001fc60: 6d2e 6765 7428 2773 6368 656d 6127 2920  m.get('schema') 
+0001fc70: 3d3d 2027 546f 6d6f 5369 6d46 6965 6c64  == 'TomoSimField
+0001fc80: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+0001fc90: 2020 2020 2020 2020 2020 206e 7872 6f6f             nxroo
+0001fca0: 7420 3d20 6974 656d 2e67 6574 2827 6461  t = item.get('da
+0001fcb0: 7461 2729 0a20 2020 2020 2020 2020 2020  ta').           
+0001fcc0: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+0001fcd0: 616b 0a20 2020 2020 2020 2069 6620 6e78  ak.        if nx
+0001fce0: 726f 6f74 2069 7320 4e6f 6e65 3a0a 2020  root is None:.  
+0001fcf0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0001fd00: 5661 6c75 6545 7272 6f72 280a 2020 2020  ValueError(.    
+0001fd10: 2020 2020 2020 2020 2020 2020 274e 6f20              'No 
+0001fd20: 746f 6d6f 6772 6170 6879 2064 6174 6120  tomography data 
+0001fd30: 7365 7420 666f 756e 6420 696e 2069 6e70  set found in inp
+0001fd40: 7574 2064 6174 6127 290a 0a20 2020 2020  ut data')..     
+0001fd50: 2020 2072 6574 7572 6e20 6e78 726f 6f74     return nxroot
+0001fd60: 0a0a 0a63 6c61 7373 2054 6f6d 6f53 7065  ...class TomoSpe
+0001fd70: 6350 726f 6365 7373 6f72 2850 726f 6365  cProcessor(Proce
+0001fd80: 7373 6f72 293a 0a20 2020 2022 2222 0a20  ssor):.    """. 
+0001fd90: 2020 2041 2070 726f 6365 7373 6f72 2074     A processor t
+0001fda0: 6f20 6372 6561 7465 2061 2074 6f6d 6f67  o create a tomog
+0001fdb0: 7261 7068 7920 5350 4543 2066 696c 6520  raphy SPEC file 
+0001fdc0: 6173 736f 6369 6174 6564 2077 6974 6820  associated with 
+0001fdd0: 610a 2020 2020 7369 6d75 6c61 7465 6420  a.    simulated 
+0001fde0: 746f 6d6f 6772 6170 6879 2064 6174 6120  tomography data 
+0001fdf0: 7365 7420 6372 6561 7465 6420 6279 2054  set created by T
+0001fe00: 6f6d 6f53 696d 5072 6f63 6573 736f 722e  omoSimProcessor.
+0001fe10: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
+0001fe20: 6620 7072 6f63 6573 7328 7365 6c66 2c20  f process(self, 
+0001fe30: 6461 7461 2c20 7370 6563 5f66 6f6c 6465  data, spec_folde
+0001fe40: 723d 272e 272c 2073 6361 6e5f 6e75 6d62  r='.', scan_numb
+0001fe50: 6572 733d 5b31 5d2c 202a 2a6b 7761 7267  ers=[1], **kwarg
+0001fe60: 7329 3a0a 2020 2020 2020 2020 2222 220a  s):.        """.
+0001fe70: 2020 2020 2020 2020 5072 6f63 6573 7320          Process 
+0001fe80: 7468 6520 696e 7075 7420 636f 6e66 6967  the input config
+0001fe90: 7572 6174 696f 6e20 616e 6420 7265 7475  uration and retu
+0001fea0: 726e 2061 206c 6973 7420 6f66 2073 7472  rn a list of str
+0001feb0: 696e 6773 0a20 2020 2020 2020 2072 6570  ings.        rep
+0001fec0: 7265 7365 6e74 696e 6720 6120 706c 6169  resenting a plai
+0001fed0: 6e20 7465 7874 2053 5045 4320 6669 6c65  n text SPEC file
+0001fee0: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
+0001fef0: 6d20 6461 7461 3a20 496e 7075 7420 636f  m data: Input co
+0001ff00: 6e66 6967 7572 6174 696f 6e20 666f 7220  nfiguration for 
+0001ff10: 7468 6520 7369 6d75 6c61 7469 6f6e 2e0a  the simulation..
+0001ff20: 2020 2020 2020 2020 3a74 7970 6520 6461          :type da
+0001ff30: 7461 3a20 6c69 7374 5b50 6970 656c 696e  ta: list[Pipelin
+0001ff40: 6544 6174 615d 0a20 2020 2020 2020 203a  eData].        :
+0001ff50: 7061 7261 6d20 7370 6563 5f66 6f6c 6465  param spec_folde
+0001ff60: 723a 204f 7574 7075 7420 666f 6c64 6572  r: Output folder
+0001ff70: 2066 6f72 2074 6865 2053 5045 4320 6669   for the SPEC fi
+0001ff80: 6c65 2873 292c 2064 6566 6175 6c74 730a  le(s), defaults.
+0001ff90: 2020 2020 2020 2020 2020 2020 746f 2027              to '
+0001ffa0: 2e27 2e0a 2020 2020 2020 2020 3a74 7970  .'..        :typ
+0001ffb0: 6520 7370 6563 5f66 6f6c 6465 723a 2073  e spec_folder: s
+0001ffc0: 7472 2c20 6f70 7469 6f6e 616c 2e0a 2020  tr, optional..  
+0001ffd0: 2020 2020 2020 3a70 6172 616d 2073 6361        :param sca
+0001ffe0: 6e5f 6e75 6d62 6572 733a 204c 6973 7420  n_numbers: List 
+0001fff0: 6f66 2053 5045 4320 7363 616e 206e 756d  of SPEC scan num
+00020000: 6265 7273 2c20 6465 6661 756c 7473 2074  bers, defaults t
+00020010: 6f20 5b31 5d2e 0a20 2020 2020 2020 203a  o [1]..        :
+00020020: 7479 7065 2073 6361 6e5f 6e75 6d62 6572  type scan_number
+00020030: 733a 206c 6973 745b 696e 745d 0a20 2020  s: list[int].   
+00020040: 2020 2020 203a 7265 7475 726e 3a20 5369       :return: Si
+00020050: 6d75 6c61 7465 6420 5350 4543 2066 696c  mulated SPEC fil
+00020060: 652e 0a20 2020 2020 2020 203a 7274 7970  e..        :rtyp
+00020070: 653a 206c 6973 745b 7374 725d 0a20 2020  e: list[str].   
+00020080: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00020090: 2023 2053 7973 7465 6d20 6d6f 6475 6c65   # System module
+000200a0: 730a 2020 2020 2020 2020 6672 6f6d 206a  s.        from j
+000200b0: 736f 6e20 696d 706f 7274 2064 756d 700a  son import dump.
+000200c0: 2020 2020 2020 2020 6672 6f6d 2064 6174          from dat
+000200d0: 6574 696d 6520 696d 706f 7274 2064 6174  etime import dat
+000200e0: 6574 696d 650a 0a20 2020 2020 2020 2023  etime..        #
+000200f0: 2054 6869 7264 2070 6172 7479 206d 6f64   Third party mod
+00020100: 756c 6573 0a20 2020 2020 2020 2066 726f  ules.        fro
+00020110: 6d20 6e65 7875 7366 6f72 6d61 742e 6e65  m nexusformat.ne
+00020120: 7875 7320 696d 706f 7274 204e 6558 7573  xus import NeXus
+00020130: 4572 726f 720a 0a20 2020 2020 2020 2023  Error..        #
+00020140: 2047 6574 2061 6e64 2076 616c 6964 6174   Get and validat
+00020150: 6520 7468 6520 546f 6d6f 5369 6d46 6965  e the TomoSimFie
+00020160: 6c64 2c20 546f 6d6f 4461 726b 4669 656c  ld, TomoDarkFiel
+00020170: 642c 206f 720a 2020 2020 2020 2020 2320  d, or.        # 
+00020180: 2020 2020 546f 6d6f 4272 6967 6874 4669      TomoBrightFi
+00020190: 656c 6420 636f 6e66 6967 7572 6174 696f  eld configuratio
+000201a0: 6e20 6f62 6a65 6374 2069 6e20 6461 7461  n object in data
+000201b0: 0a20 2020 2020 2020 2073 6361 6e5f 6e75  .        scan_nu
+000201c0: 6d62 6572 7320 3d20 6c69 7374 2873 6574  mbers = list(set
+000201d0: 2873 6361 6e5f 6e75 6d62 6572 7329 290a  (scan_numbers)).
+000201e0: 2020 2020 2020 2020 636f 6e66 6967 7320          configs 
+000201f0: 3d20 7365 6c66 2e67 6574 5f63 6f6e 6669  = self.get_confi
+00020200: 6728 6461 7461 290a 2020 2020 2020 2020  g(data).        
+00020210: 7374 6174 696f 6e20 3d20 4e6f 6e65 0a20  station = None. 
+00020220: 2020 2020 2020 2073 616d 706c 655f 7479         sample_ty
+00020230: 7065 203d 204e 6f6e 650a 2020 2020 2020  pe = None.      
+00020240: 2020 6e75 6d5f 7363 616e 203d 2030 0a20    num_scan = 0. 
+00020250: 2020 2020 2020 2066 6f72 2073 6368 656d         for schem
+00020260: 612c 206e 7872 6f6f 7420 696e 2063 6f6e  a, nxroot in con
+00020270: 6669 6773 2e69 7465 6d73 2829 3a0a 2020  figs.items():.  
+00020280: 2020 2020 2020 2020 2020 736f 7572 6365            source
+00020290: 203d 206e 7872 6f6f 742e 656e 7472 792e   = nxroot.entry.
+000202a0: 696e 7374 7275 6d65 6e74 2e73 6f75 7263  instrument.sourc
+000202b0: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
+000202c0: 2073 7461 7469 6f6e 2069 7320 4e6f 6e65   station is None
+000202d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000202e0: 2020 7374 6174 696f 6e20 3d20 736f 7572    station = sour
+000202f0: 6365 2e61 7474 7273 2e67 6574 2827 7374  ce.attrs.get('st
+00020300: 6174 696f 6e27 290a 2020 2020 2020 2020  ation').        
+00020310: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00020320: 2020 2020 2020 2020 2020 6966 2073 7461            if sta
+00020330: 7469 6f6e 2021 3d20 736f 7572 6365 2e61  tion != source.a
+00020340: 7474 7273 2e67 6574 2827 7374 6174 696f  ttrs.get('statio
+00020350: 6e27 293a 0a20 2020 2020 2020 2020 2020  n'):.           
+00020360: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00020370: 616c 7565 4572 726f 7228 2749 6e63 6f6e  alueError('Incon
+00020380: 7369 7374 656e 7420 7374 6174 696f 6e20  sistent station 
+00020390: 616d 6f6e 6720 7363 616e 7327 290a 2020  among scans').  
+000203a0: 2020 2020 2020 2020 2020 6966 2073 616d            if sam
+000203b0: 706c 655f 7479 7065 2069 7320 4e6f 6e65  ple_type is None
+000203c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000203d0: 2020 7361 6d70 6c65 5f74 7970 6520 3d20    sample_type = 
+000203e0: 6e78 726f 6f74 2e65 6e74 7279 2e73 616d  nxroot.entry.sam
+000203f0: 706c 652e 7361 6d70 6c65 5f74 7970 650a  ple.sample_type.
+00020400: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00020410: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00020420: 2020 6966 2073 616d 706c 655f 7479 7065    if sample_type
+00020430: 2021 3d20 6e78 726f 6f74 2e65 6e74 7279   != nxroot.entry
+00020440: 2e73 616d 706c 652e 7361 6d70 6c65 5f74  .sample.sample_t
+00020450: 7970 653a 0a20 2020 2020 2020 2020 2020  ype:.           
+00020460: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00020470: 616c 7565 4572 726f 7228 2749 6e63 6f6e  alueError('Incon
+00020480: 7369 7374 656e 7420 7361 6d70 6c65 5f74  sistent sample_t
+00020490: 7970 6520 616d 6f6e 6720 7363 616e 7327  ype among scans'
+000204a0: 290a 2020 2020 2020 2020 2020 2020 6465  ).            de
+000204b0: 7465 6374 6f72 203d 206e 7872 6f6f 742e  tector = nxroot.
+000204c0: 656e 7472 792e 696e 7374 7275 6d65 6e74  entry.instrument
+000204d0: 2e64 6574 6563 746f 720a 2020 2020 2020  .detector.      
+000204e0: 2020 2020 2020 6966 2027 7a5f 7472 616e        if 'z_tran
+000204f0: 736c 6174 696f 6e27 2069 6e20 6465 7465  slation' in dete
+00020500: 6374 6f72 3a0a 2020 2020 2020 2020 2020  ctor:.          
+00020510: 2020 2020 2020 6e75 6d5f 7374 6163 6b20        num_stack 
+00020520: 3d20 6e70 2e61 7361 7272 6179 2864 6574  = np.asarray(det
+00020530: 6563 746f 722e 7a5f 7472 616e 736c 6174  ector.z_translat
+00020540: 696f 6e29 2e73 697a 650a 2020 2020 2020  ion).size.      
+00020550: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00020560: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
+00020570: 7374 6163 6b20 3d20 310a 2020 2020 2020  stack = 1.      
+00020580: 2020 2020 2020 6461 7461 5f73 6861 7065        data_shape
+00020590: 203d 2064 6574 6563 746f 722e 6461 7461   = detector.data
+000205a0: 2e73 6861 7065 0a20 2020 2020 2020 2020  .shape.         
+000205b0: 2020 2069 6620 6c65 6e28 6461 7461 5f73     if len(data_s
+000205c0: 6861 7065 2920 3d3d 2033 3a0a 2020 2020  hape) == 3:.    
+000205d0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+000205e0: 756d 5f73 7461 636b 2021 3d20 313a 0a20  um_stack != 1:. 
+000205f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020600: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00020610: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00020620: 2020 2020 2020 2020 2020 2020 2027 496e               'In
+00020630: 636f 6e73 6973 7465 6e74 207a 5f74 7261  consistent z_tra
+00020640: 6e73 6c61 7469 6f6e 2061 6e64 2064 6174  nslation and dat
+00020650: 6120 6469 6d65 6e73 696f 6e73 270a 2020  a dimensions'.  
+00020660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020670: 2020 2020 2020 6627 287b 6e75 6d5f 7374        f'({num_st
+00020680: 6163 6b7d 2076 7320 7b31 7d29 2729 0a20  ack} vs {1})'). 
+00020690: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+000206a0: 6c65 6e28 6461 7461 5f73 6861 7065 2920  len(data_shape) 
+000206b0: 3d3d 2034 3a0a 2020 2020 2020 2020 2020  == 4:.          
+000206c0: 2020 2020 2020 6966 206e 756d 5f73 7461        if num_sta
+000206d0: 636b 2021 3d20 6461 7461 5f73 6861 7065  ck != data_shape
+000206e0: 5b30 5d3a 0a20 2020 2020 2020 2020 2020  [0]:.           
+000206f0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00020700: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
+00020710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020720: 2020 2027 496e 636f 6e73 6973 7465 6e74     'Inconsistent
+00020730: 207a 5f74 7261 6e73 6c61 7469 6f6e 2064   z_translation d
+00020740: 696d 656e 7369 6f6e 2061 6e64 2064 6174  imension and dat
+00020750: 6120 7368 6170 6520 270a 2020 2020 2020  a shape '.      
+00020760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020770: 2020 6627 287b 6e75 6d5f 7374 6163 6b7d    f'({num_stack}
+00020780: 2076 7320 7b64 6174 615f 7368 6170 655b   vs {data_shape[
+00020790: 305d 7d29 2729 0a20 2020 2020 2020 2020  0]})').         
+000207a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000207b0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+000207c0: 616c 7565 4572 726f 7228 6627 496e 7661  alueError(f'Inva
+000207d0: 6c69 6420 6461 7461 2073 6861 7065 2028  lid data shape (
+000207e0: 7b64 6174 615f 7368 6170 657d 2927 290a  {data_shape})').
+000207f0: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
+00020800: 7363 616e 202b 3d20 6e75 6d5f 7374 6163  scan += num_stac
+00020810: 6b0a 2020 2020 2020 2020 6966 206c 656e  k.        if len
+00020820: 2873 6361 6e5f 6e75 6d62 6572 7329 2021  (scan_numbers) !
+00020830: 3d20 6e75 6d5f 7363 616e 3a0a 2020 2020  = num_scan:.    
+00020840: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00020850: 6c75 6545 7272 6f72 280a 2020 2020 2020  lueError(.      
+00020860: 2020 2020 2020 2020 2020 6627 496e 636f            f'Inco
+00020870: 6e73 6973 7465 6e74 206e 756d 6265 7220  nsistent number 
+00020880: 6f66 2073 6361 6e73 2028 7b6e 756d 5f73  of scans ({num_s
+00020890: 6361 6e7d 292c 2027 0a20 2020 2020 2020  can}), '.       
+000208a0: 2020 2020 2020 2020 2066 276c 656e 2873           f'len(s
+000208b0: 6361 6e5f 6e75 6d62 6572 7329 203d 207b  can_numbers) = {
+000208c0: 6c65 6e28 7363 616e 5f6e 756d 6265 7273  len(scan_numbers
+000208d0: 297d 2927 290a 0a20 2020 2020 2020 2023  )})')..        #
+000208e0: 2043 7265 6174 6520 7468 6520 5350 4543   Create the SPEC
+000208f0: 206f 7574 7075 7420 666f 6c64 6572 2069   output folder i
+00020900: 6620 6e65 6564 6564 0a20 2020 2020 2020  f needed.       
+00020910: 2073 7065 635f 666f 6c64 6572 203d 206f   spec_folder = o
+00020920: 735f 7061 7468 2e61 6273 7061 7468 2873  s_path.abspath(s
+00020930: 7065 635f 666f 6c64 6572 290a 2020 2020  pec_folder).    
+00020940: 2020 2020 6966 206e 6f74 206f 735f 7061      if not os_pa
+00020950: 7468 2e69 7364 6972 2873 7065 635f 666f  th.isdir(spec_fo
+00020960: 6c64 6572 293a 0a20 2020 2020 2020 2020  lder):.         
+00020970: 2020 206d 6b64 6972 2873 7065 635f 666f     mkdir(spec_fo
+00020980: 6c64 6572 290a 0a20 2020 2020 2020 2023  lder)..        #
+00020990: 2043 7265 6174 6520 7468 6520 5350 4543   Create the SPEC
+000209a0: 2066 696c 6520 6865 6164 6572 0a20 2020   file header.   
+000209b0: 2020 2020 2073 7065 635f 6669 6c65 203d       spec_file =
+000209c0: 205b 6627 2346 207b 7361 6d70 6c65 5f74   [f'#F {sample_t
+000209d0: 7970 657d 275d 0a20 2020 2020 2020 2073  ype}'].        s
+000209e0: 7065 635f 6669 6c65 2e61 7070 656e 6428  pec_file.append(
+000209f0: 2723 4520 3027 290a 2020 2020 2020 2020  '#E 0').        
+00020a00: 7370 6563 5f66 696c 652e 6170 7065 6e64  spec_file.append
+00020a10: 280a 2020 2020 2020 2020 2020 2020 6627  (.            f'
+00020a20: 2344 207b 6461 7465 7469 6d65 2e6e 6f77  #D {datetime.now
+00020a30: 2829 2e73 7472 6674 696d 6528 2225 6120  ().strftime("%a 
+00020a40: 2562 2025 6420 2549 3a25 4d3a 2553 2025  %b %d %I:%M:%S %
+00020a50: 5922 297d 2729 0a20 2020 2020 2020 2073  Y")}').        s
+00020a60: 7065 635f 6669 6c65 2e61 7070 656e 6428  pec_file.append(
+00020a70: 6627 2343 2073 7065 6320 2055 7365 7220  f'#C spec  User 
+00020a80: 3d20 6368 6573 735f 7b73 7461 7469 6f6e  = chess_{station
+00020a90: 7d5c 6e27 290a 2020 2020 2020 2020 6966  }\n').        if
+00020aa0: 2073 7461 7469 6f6e 2069 6e20 2827 6964   station in ('id
+00020ab0: 3161 3327 2c20 2769 6433 6127 293a 0a20  1a3', 'id3a'):. 
+00020ac0: 2020 2020 2020 2020 2020 2073 7065 635f             spec_
+00020ad0: 6669 6c65 2e61 7070 656e 6428 2723 4f30  file.append('#O0
+00020ae0: 2072 616d 7378 2020 7261 6d73 7a27 290a   ramsx  ramsz').
+00020af0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00020b00: 2020 2020 2020 2020 2020 2352 5620 4669            #RV Fi
+00020b10: 7820 6d61 696e 2063 6f64 6520 746f 2075  x main code to u
+00020b20: 7365 2069 6e64 6570 656e 6465 6e74 2064  se independent d
+00020b30: 696d 2069 6e66 6f0a 2020 2020 2020 2020  im info.        
+00020b40: 2020 2020 7370 6563 5f66 696c 652e 6170      spec_file.ap
+00020b50: 7065 6e64 2827 234f 3020 4749 5f73 616d  pend('#O0 GI_sam
+00020b60: 7820 2047 495f 7361 6d7a 2020 4749 5f73  x  GI_samz  GI_s
+00020b70: 616d 7068 6927 290a 2020 2020 2020 2020  amphi').        
+00020b80: 2020 2020 7370 6563 5f66 696c 652e 6170      spec_file.ap
+00020b90: 7065 6e64 2827 236f 3020 7361 6d78 2073  pend('#o0 samx s
+00020ba0: 616d 7a20 7361 6d70 6869 2729 2023 5256  amz samphi') #RV
+00020bb0: 2064 6f20 4920 6e65 6564 2074 6869 7320   do I need this 
+00020bc0: 6c69 6e65 3f0a 2020 2020 2020 2020 7370  line?.        sp
+00020bd0: 6563 5f66 696c 652e 6170 7065 6e64 2827  ec_file.append('
+00020be0: 2729 0a0a 2020 2020 2020 2020 2320 4372  ')..        # Cr
+00020bf0: 6561 7465 2074 6865 2053 5045 4320 6669  eate the SPEC fi
+00020c00: 6c65 2073 6361 6e20 696e 666f 2028 616e  le scan info (an
+00020c10: 6420 696d 6167 6520 616e 6420 7061 7266  d image and parf
+00020c20: 696c 6520 6461 7461 2066 6f72 2053 4d42  ile data for SMB
+00020c30: 290a 2020 2020 2020 2020 7061 725f 6669  ).        par_fi
+00020c40: 6c65 203d 205b 5d0a 2020 2020 2020 2020  le = [].        
+00020c50: 696d 6167 655f 7365 7473 203d 205b 5d0a  image_sets = [].
+00020c60: 2020 2020 2020 2020 6e75 6d5f 7363 616e          num_scan
+00020c70: 203d 2030 0a20 2020 2020 2020 2063 6f75   = 0.        cou
+00020c80: 6e74 5f74 696d 6520 3d20 310a 2020 2020  nt_time = 1.    
+00020c90: 2020 2020 666f 7220 7363 6865 6d61 2c20      for schema, 
+00020ca0: 6e78 726f 6f74 2069 6e20 636f 6e66 6967  nxroot in config
+00020cb0: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+00020cc0: 2020 2020 2020 2064 6574 6563 746f 7220         detector 
+00020cd0: 3d20 6e78 726f 6f74 2e65 6e74 7279 2e69  = nxroot.entry.i
+00020ce0: 6e73 7472 756d 656e 742e 6465 7465 6374  nstrument.detect
+00020cf0: 6f72 0a20 2020 2020 2020 2020 2020 2069  or.            i
+00020d00: 6620 277a 5f74 7261 6e73 6c61 7469 6f6e  f 'z_translation
+00020d10: 2720 696e 2064 6574 6563 746f 723a 0a20  ' in detector:. 
+00020d20: 2020 2020 2020 2020 2020 2020 2020 207a                 z
+00020d30: 5f74 7261 6e73 6c61 7469 6f6e 7320 3d20  _translations = 
+00020d40: 6c69 7374 286e 702e 6173 6172 7261 7928  list(np.asarray(
+00020d50: 6465 7465 6374 6f72 2e7a 5f74 7261 6e73  detector.z_trans
+00020d60: 6c61 7469 6f6e 2929 0a20 2020 2020 2020  lation)).       
+00020d70: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00020d80: 2020 2020 2020 2020 2020 207a 5f74 7261             z_tra
+00020d90: 6e73 6c61 7469 6f6e 7320 3d20 5b30 2e5d  nslations = [0.]
+00020da0: 0a20 2020 2020 2020 2020 2020 2066 7261  .            fra
+00020db0: 6d65 5f73 7461 7274 5f6e 756d 6265 7220  me_start_number 
+00020dc0: 3d20 696e 7428 6465 7465 6374 6f72 2e66  = int(detector.f
+00020dd0: 7261 6d65 5f73 7461 7274 5f6e 756d 6265  rame_start_numbe
+00020de0: 7229 0a20 2020 2020 2020 2020 2020 2074  r).            t
+00020df0: 6865 7461 7320 3d20 6e70 2e61 7361 7272  hetas = np.asarr
+00020e00: 6179 2864 6574 6563 746f 722e 7468 6574  ay(detector.thet
+00020e10: 6173 295b 6672 616d 655f 7374 6172 745f  as)[frame_start_
+00020e20: 6e75 6d62 6572 3a5d 0a20 2020 2020 2020  number:].       
+00020e30: 2020 2020 206e 756d 5f74 6865 7461 203d       num_theta =
+00020e40: 2074 6865 7461 732e 7369 7a65 0a20 2020   thetas.size.   
+00020e50: 2020 2020 2020 2020 2069 6620 7363 6865           if sche
+00020e60: 6d61 203d 3d20 2754 6f6d 6f44 6172 6b46  ma == 'TomoDarkF
+00020e70: 6965 6c64 273a 0a20 2020 2020 2020 2020  ield':.         
+00020e80: 2020 2020 2020 2069 6620 7374 6174 696f         if statio
+00020e90: 6e20 696e 2028 2769 6431 6133 272c 2027  n in ('id1a3', '
+00020ea0: 6964 3361 2729 3a0a 2020 2020 2020 2020  id3a'):.        
+00020eb0: 2020 2020 2020 2020 2020 2020 6d61 6372              macr
+00020ec0: 6f20 3d20 6627 736c 6577 5f6f 6d65 207b  o = f'slew_ome {
+00020ed0: 7468 6574 6173 5b30 5d7d 207b 7468 6574  thetas[0]} {thet
+00020ee0: 6173 5b2d 315d 7d20 2720 5c0a 2020 2020  as[-1]} ' \.    
+00020ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020f00: 2020 2020 6627 7b6e 756d 5f74 6865 7461      f'{num_theta
+00020f10: 7d20 7b63 6f75 6e74 5f74 696d 657d 2064  } {count_time} d
+00020f20: 6172 6b66 6965 6c64 270a 2020 2020 2020  arkfield'.      
+00020f30: 2020 2020 2020 2020 2020 2020 2020 7363                sc
+00020f40: 616e 5f74 7970 6520 3d20 2764 6631 270a  an_type = 'df1'.
 00020f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020f60: 2065 6c69 6620 7363 6865 6d61 203d 3d20   elif schema == 
-00020f70: 2754 6f6d 6f42 7269 6768 7446 6965 6c64  'TomoBrightField
-00020f80: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-00020f90: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
-00020fa0: 6773 5b73 6368 656d 615d 203d 2069 7465  gs[schema] = ite
-00020fb0: 6d2e 6765 7428 2764 6174 6127 290a 2020  m.get('data').  
-00020fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020fd0: 2020 656c 6966 2073 6368 656d 6120 3d3d    elif schema ==
-00020fe0: 2027 546f 6d6f 5369 6d46 6965 6c64 273a   'TomoSimField':
-00020ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021000: 2020 2020 2020 2020 2063 6f6e 6669 6773           configs
-00021010: 5b73 6368 656d 615d 203d 2069 7465 6d2e  [schema] = item.
-00021020: 6765 7428 2764 6174 6127 290a 2020 2020  get('data').    
-00021030: 2020 2020 6966 206e 6f74 206c 656e 2863      if not len(c
-00021040: 6f6e 6669 6773 293a 0a20 2020 2020 2020  onfigs):.       
-00021050: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00021060: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-00021070: 2020 2020 2020 2027 4e6f 2074 6f6d 6f67         'No tomog
-00021080: 7261 7068 7920 6461 7461 2073 6574 2066  raphy data set f
-00021090: 6f75 6e64 2069 6e20 696e 7075 7420 6461  ound in input da
-000210a0: 7461 2729 0a0a 2020 2020 2020 2020 7265  ta')..        re
-000210b0: 7475 726e 2063 6f6e 6669 6773 0a0a 2020  turn configs..  
-000210c0: 2020 6465 6620 7772 6974 655f 7469 6666    def write_tiff
-000210d0: 7328 7365 6c66 2c20 6461 7461 2c20 696d  s(self, data, im
-000210e0: 6167 655f 666f 6c64 6572 293a 0a20 2020  age_folder):.   
-000210f0: 2020 2020 2023 2054 6869 7264 2070 6172       # Third par
-00021100: 7479 206d 6f64 756c 6573 0a20 2020 2020  ty modules.     
-00021110: 2020 2066 726f 6d20 696d 6167 6569 6f20     from imageio 
-00021120: 696d 706f 7274 2069 6d77 7269 7465 0a20  import imwrite. 
-00021130: 2020 2020 2020 2066 6f72 206e 2069 6e20         for n in 
-00021140: 7261 6e67 6528 6461 7461 2e73 6861 7065  range(data.shape
-00021150: 5b30 5d29 3a0a 2020 2020 2020 2020 2020  [0]):.          
-00021160: 2020 696d 7772 6974 6528 0a20 2020 2020    imwrite(.     
-00021170: 2020 2020 2020 2020 2020 206f 735f 7061             os_pa
-00021180: 7468 2e6a 6f69 6e28 696d 6167 655f 666f  th.join(image_fo
-00021190: 6c64 6572 2c20 6627 6e66 5f7b 6e3a 3036  lder, f'nf_{n:06
-000211a0: 647d 2e74 6966 2729 2c20 6461 7461 5b6e  d}.tif'), data[n
-000211b0: 5d29 0a0a 2020 2020 6465 6620 7772 6974  ])..    def writ
-000211c0: 655f 7478 7428 7365 6c66 2c20 6461 7461  e_txt(self, data
-000211d0: 2c20 6669 6c65 7061 7468 2c20 666f 7263  , filepath, forc
-000211e0: 655f 6f76 6572 7772 6974 653d 5472 7565  e_overwrite=True
-000211f0: 293a 0a20 2020 2020 2020 2023 204c 6f63  ):.        # Loc
-00021200: 616c 206d 6f64 756c 6573 0a20 2020 2020  al modules.     
-00021210: 2020 2066 726f 6d20 4348 4150 2e63 6f6d     from CHAP.com
-00021220: 6d6f 6e20 696d 706f 7274 2054 5854 5772  mon import TXTWr
-00021230: 6974 6572 0a20 2020 2020 2020 2066 726f  iter.        fro
-00021240: 6d20 4348 4150 2e70 6970 656c 696e 6520  m CHAP.pipeline 
-00021250: 696d 706f 7274 2050 6970 656c 696e 6544  import PipelineD
-00021260: 6174 610a 2020 2020 2020 2020 7772 6974  ata.        writ
-00021270: 6572 203d 2054 5854 5772 6974 6572 2829  er = TXTWriter()
-00021280: 0a20 2020 2020 2020 2077 7269 7465 722e  .        writer.
-00021290: 7772 6974 6528 0a20 2020 2020 2020 2020  write(.         
-000212a0: 2020 205b 5069 7065 6c69 6e65 4461 7461     [PipelineData
-000212b0: 2864 6174 613d 6461 7461 295d 2c20 6669  (data=data)], fi
-000212c0: 6c65 7061 7468 2c0a 2020 2020 2020 2020  lepath,.        
-000212d0: 2020 2020 666f 7263 655f 6f76 6572 7772      force_overwr
-000212e0: 6974 653d 666f 7263 655f 6f76 6572 7772  ite=force_overwr
-000212f0: 6974 6529 0a0a 0a69 6620 5f5f 6e61 6d65  ite)...if __name
-00021300: 5f5f 203d 3d20 275f 5f6d 6169 6e5f 5f27  __ == '__main__'
-00021310: 3a0a 2020 2020 6d61 696e 2829 0a         :.    main().
+00020f60: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00020f70: 2020 2020 2020 2020 2020 6d61 6372 6f20            macro 
+00020f80: 3d20 6627 666c 7973 6361 6e20 7b6e 756d  = f'flyscan {num
+00020f90: 5f74 6865 7461 7d20 7b63 6f75 6e74 5f74  _theta} {count_t
+00020fa0: 696d 657d 270a 2020 2020 2020 2020 2020  ime}'.          
+00020fb0: 2020 656c 6966 2073 6368 656d 6120 3d3d    elif schema ==
+00020fc0: 2027 546f 6d6f 4272 6967 6874 4669 656c   'TomoBrightFiel
+00020fd0: 6427 3a0a 2020 2020 2020 2020 2020 2020  d':.            
+00020fe0: 2020 2020 6966 2073 7461 7469 6f6e 2069      if station i
+00020ff0: 6e20 2827 6964 3161 3327 2c20 2769 6433  n ('id1a3', 'id3
+00021000: 6127 293a 0a20 2020 2020 2020 2020 2020  a'):.           
+00021010: 2020 2020 2020 2020 206d 6163 726f 203d           macro =
+00021020: 2066 2773 6c65 775f 6f6d 6520 7b74 6865   f'slew_ome {the
+00021030: 7461 735b 305d 7d20 7b74 6865 7461 735b  tas[0]} {thetas[
+00021040: 2d31 5d7d 2027 205c 0a20 2020 2020 2020  -1]} ' \.       
+00021050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021060: 2066 277b 6e75 6d5f 7468 6574 617d 207b   f'{num_theta} {
+00021070: 636f 756e 745f 7469 6d65 7d27 0a20 2020  count_time}'.   
+00021080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021090: 2073 6361 6e5f 7479 7065 203d 2027 6266   scan_type = 'bf
+000210a0: 3127 0a20 2020 2020 2020 2020 2020 2020  1'.             
+000210b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000210c0: 2020 2020 2020 2020 2020 2020 206d 6163               mac
+000210d0: 726f 203d 2066 2766 6c79 7363 616e 207b  ro = f'flyscan {
+000210e0: 6e75 6d5f 7468 6574 617d 207b 636f 756e  num_theta} {coun
+000210f0: 745f 7469 6d65 7d27 0a20 2020 2020 2020  t_time}'.       
+00021100: 2020 2020 2065 6c69 6620 7363 6865 6d61       elif schema
+00021110: 203d 3d20 2754 6f6d 6f53 696d 4669 656c   == 'TomoSimFiel
+00021120: 6427 3a0a 2020 2020 2020 2020 2020 2020  d':.            
+00021130: 2020 2020 6966 2073 7461 7469 6f6e 2069      if station i
+00021140: 6e20 2827 6964 3161 3327 2c20 2769 6433  n ('id1a3', 'id3
+00021150: 6127 293a 0a20 2020 2020 2020 2020 2020  a'):.           
+00021160: 2020 2020 2020 2020 206d 6163 726f 203d           macro =
+00021170: 2066 2773 6c65 775f 6f6d 6520 7b74 6865   f'slew_ome {the
+00021180: 7461 735b 305d 7d20 7b74 6865 7461 735b  tas[0]} {thetas[
+00021190: 2d31 5d7d 2027 205c 0a20 2020 2020 2020  -1]} ' \.       
+000211a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000211b0: 2066 277b 6e75 6d5f 7468 6574 617d 207b   f'{num_theta} {
+000211c0: 636f 756e 745f 7469 6d65 7d27 0a20 2020  count_time}'.   
+000211d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000211e0: 2073 6361 6e5f 7479 7065 203d 2027 7473   scan_type = 'ts
+000211f0: 3127 0a20 2020 2020 2020 2020 2020 2020  1'.             
+00021200: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00021210: 2020 2020 2020 2020 2020 2020 206d 6163               mac
+00021220: 726f 203d 2066 2766 6c79 7363 616e 2073  ro = f'flyscan s
+00021230: 616d 7068 6920 7b74 6865 7461 735b 305d  amphi {thetas[0]
+00021240: 7d20 2720 5c0a 2020 2020 2020 2020 2020  } ' \.          
+00021250: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00021260: 7b74 6865 7461 735b 2d31 5d7d 207b 6e75  {thetas[-1]} {nu
+00021270: 6d5f 7468 6574 612d 317d 207b 636f 756e  m_theta-1} {coun
+00021280: 745f 7469 6d65 7d27 0a20 2020 2020 2020  t_time}'.       
+00021290: 2020 2020 2066 6f72 2020 6e2c 207a 5f74       for  n, z_t
+000212a0: 7261 6e73 6c61 7469 6f6e 2069 6e20 656e  ranslation in en
+000212b0: 756d 6572 6174 6528 7a5f 7472 616e 736c  umerate(z_transl
+000212c0: 6174 696f 6e73 293a 0a20 2020 2020 2020  ations):.       
+000212d0: 2020 2020 2020 2020 2073 7065 635f 6669           spec_fi
+000212e0: 6c65 2e61 7070 656e 6428 6627 2353 207b  le.append(f'#S {
+000212f0: 7363 616e 5f6e 756d 6265 7273 5b6e 756d  scan_numbers[num
+00021300: 5f73 6361 6e5d 7d20 207b 6d61 6372 6f7d  _scan]}  {macro}
+00021310: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+00021320: 2020 2073 7065 635f 6669 6c65 2e61 7070     spec_file.app
+00021330: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
+00021340: 2020 2020 2020 2020 2066 2723 4420 7b64           f'#D {d
+00021350: 6174 6574 696d 652e 6e6f 7728 292e 7374  atetime.now().st
+00021360: 7266 7469 6d65 2822 2561 2025 6220 2564  rftime("%a %b %d
+00021370: 2025 493a 254d 3a25 5320 2559 2229 7d27   %I:%M:%S %Y")}'
+00021380: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00021390: 2020 6966 2073 7461 7469 6f6e 2069 6e20    if station in 
+000213a0: 2827 6964 3161 3327 2c20 2769 6433 6127  ('id1a3', 'id3a'
+000213b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000213c0: 2020 2020 2020 2073 7065 635f 6669 6c65         spec_file
+000213d0: 2e61 7070 656e 6428 6627 2350 3020 302e  .append(f'#P0 0.
+000213e0: 3020 7b7a 5f74 7261 6e73 6c61 7469 6f6e  0 {z_translation
+000213f0: 7d27 290a 2020 2020 2020 2020 2020 2020  }').            
+00021400: 2020 2020 2020 2020 7370 6563 5f66 696c          spec_fil
+00021410: 652e 6170 7065 6e64 2827 234e 2031 2729  e.append('#N 1')
+00021420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021430: 2020 2020 2073 7065 635f 6669 6c65 2e61       spec_file.a
+00021440: 7070 656e 6428 2723 4c20 206f 6d65 2729  ppend('#L  ome')
+00021450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021460: 2020 2020 2069 6620 7363 616e 5f74 7970       if scan_typ
+00021470: 6520 3d3d 2027 7473 3127 3a0a 2020 2020  e == 'ts1':.    
+00021480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021490: 2020 2020 696d 6167 655f 7365 7473 2e61      image_sets.a
+000214a0: 7070 656e 6428 6465 7465 6374 6f72 2e64  ppend(detector.d
+000214b0: 6174 615b 6e5d 290a 2020 2020 2020 2020  ata[n]).        
+000214c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000214d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000214e0: 2020 2020 2020 2020 2020 696d 6167 655f            image_
+000214f0: 7365 7473 2e61 7070 656e 6428 6465 7465  sets.append(dete
+00021500: 6374 6f72 2e64 6174 6129 0a20 2020 2020  ctor.data).     
+00021510: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00021520: 6172 5f66 696c 652e 6170 7065 6e64 280a  ar_file.append(.
+00021530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021540: 2020 2020 2020 2020 6627 7b64 6174 6574          f'{datet
+00021550: 696d 652e 6e6f 7728 292e 7374 7266 7469  ime.now().strfti
+00021560: 6d65 2822 2559 256d 2564 2229 7d20 270a  me("%Y%m%d")} '.
+00021570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021580: 2020 2020 2020 2020 6627 7b64 6174 6574          f'{datet
+00021590: 696d 652e 6e6f 7728 292e 7374 7266 7469  ime.now().strfti
+000215a0: 6d65 2822 2548 254d 2553 2229 7d20 270a  me("%H%M%S")} '.
+000215b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000215c0: 2020 2020 2020 2020 6627 7b73 6361 6e5f          f'{scan_
+000215d0: 6e75 6d62 6572 735b 6e75 6d5f 7363 616e  numbers[num_scan
+000215e0: 5d7d 2027 0a23 2020 2020 2020 2020 2020  ]} '.#          
+000215f0: 2020 2020 2020 2020 2020 2020 2020 2732                '2
+00021600: 2e30 2027 0a23 2020 2020 2020 2020 2020  .0 '.#          
+00021610: 2020 2020 2020 2020 2020 2020 2020 2731                '1
+00021620: 2e30 2027 0a20 2020 2020 2020 2020 2020  .0 '.           
+00021630: 2020 2020 2020 2020 2020 2020 2027 3020               '0 
+00021640: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00021650: 2020 2020 2020 2020 2020 6627 7b66 7261            f'{fra
+00021660: 6d65 5f73 7461 7274 5f6e 756d 6265 727d  me_start_number}
+00021670: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00021680: 2020 2020 2020 2020 2020 2027 302e 3020             '0.0 
+00021690: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+000216a0: 2020 2020 2020 2020 2020 6627 7b7a 5f74            f'{z_t
+000216b0: 7261 6e73 6c61 7469 6f6e 7d20 270a 2020  ranslation} '.  
+000216c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000216d0: 2020 2020 2020 6627 7b74 6865 7461 735b        f'{thetas[
+000216e0: 305d 7d20 270a 2020 2020 2020 2020 2020  0]} '.          
+000216f0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00021700: 7b74 6865 7461 735b 2d31 5d7d 2027 0a20  {thetas[-1]} '. 
+00021710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021720: 2020 2020 2020 2066 277b 6e75 6d5f 7468         f'{num_th
+00021730: 6574 617d 2027 0a20 2020 2020 2020 2020  eta} '.         
+00021740: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00021750: 277b 636f 756e 745f 7469 6d65 7d20 270a  '{count_time} '.
+00021760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021770: 2020 2020 2020 2020 6627 7b73 6361 6e5f          f'{scan_
+00021780: 7479 7065 7d27 290a 2020 2020 2020 2020  type}').        
+00021790: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000217a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000217b0: 2020 7370 6563 5f66 696c 652e 6170 7065    spec_file.appe
+000217c0: 6e64 2866 2723 5030 2030 2e30 207b 7a5f  nd(f'#P0 0.0 {z_
+000217d0: 7472 616e 736c 6174 696f 6e7d 2030 2e30  translation} 0.0
+000217e0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+000217f0: 2020 2020 2020 2073 7065 635f 6669 6c65         spec_file
+00021800: 2e61 7070 656e 6428 2723 4e20 3127 290a  .append('#N 1').
+00021810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021820: 2020 2020 6966 2073 6368 656d 6120 696e      if schema in
+00021830: 2028 2754 6f6d 6f44 6172 6b46 6965 6c64   ('TomoDarkField
+00021840: 272c 2027 546f 6d6f 4272 6967 6874 4669  ', 'TomoBrightFi
+00021850: 656c 6427 293a 0a20 2020 2020 2020 2020  eld'):.         
+00021860: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00021870: 7065 635f 6669 6c65 2e61 7070 656e 6428  pec_file.append(
+00021880: 2723 4c20 5469 6d65 2729 0a20 2020 2020  '#L Time').     
+00021890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000218a0: 2020 2073 7065 635f 6669 6c65 202b 3d20     spec_file += 
+000218b0: 5b73 7472 2863 6f75 6e74 5f74 696d 652a  [str(count_time*
+000218c0: 7469 6d65 290a 2020 2020 2020 2020 2020  time).          
+000218d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000218e0: 2020 666f 7220 7469 6d65 2069 6e20 7261    for time in ra
+000218f0: 6e67 6528 6e75 6d5f 7468 6574 6129 5d0a  nge(num_theta)].
+00021900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021910: 2020 2020 656c 6966 2073 6368 656d 6120      elif schema 
+00021920: 3d3d 2027 546f 6d6f 5369 6d46 6965 6c64  == 'TomoSimField
+00021930: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+00021940: 2020 2020 2020 2020 2020 2073 7065 635f             spec_
+00021950: 6669 6c65 2e61 7070 656e 6428 2723 4c20  file.append('#L 
+00021960: 4749 5f73 616d 7068 6927 290a 2020 2020  GI_samphi').    
+00021970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021980: 2020 2020 7370 6563 5f66 696c 6520 2b3d      spec_file +=
+00021990: 205b 7374 7228 7468 6574 6129 2066 6f72   [str(theta) for
+000219a0: 2074 6865 7461 2069 6e20 7468 6574 6173   theta in thetas
+000219b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+000219c0: 2020 7370 6563 5f66 696c 652e 6170 7065    spec_file.appe
+000219d0: 6e64 2827 2729 0a20 2020 2020 2020 2020  nd('').         
+000219e0: 2020 2020 2020 206e 756d 5f73 6361 6e20         num_scan 
+000219f0: 2b3d 2031 0a20 2020 2020 2020 200a 2020  += 1.        .  
+00021a00: 2020 2020 2020 6966 2073 7461 7469 6f6e        if station
+00021a10: 2069 6e20 2827 6964 3161 3327 2c20 2769   in ('id1a3', 'i
+00021a20: 6433 6127 293a 0a0a 2020 2020 2020 2020  d3a'):..        
+00021a30: 2020 2020 2320 5772 6974 6520 7468 6520      # Write the 
+00021a40: 5350 4543 2066 696c 650a 2020 2020 2020  SPEC file.      
+00021a50: 2020 2020 2020 7365 6c66 2e5f 7772 6974        self._writ
+00021a60: 655f 7478 7428 7370 6563 5f66 696c 652c  e_txt(spec_file,
+00021a70: 206f 735f 7061 7468 2e6a 6f69 6e28 7370   os_path.join(sp
+00021a80: 6563 5f66 6f6c 6465 722c 2027 7370 6563  ec_folder, 'spec
+00021a90: 2e6c 6f67 2729 290a 0a20 2020 2020 2020  .log'))..       
+00021aa0: 2020 2020 2023 2057 7269 7465 2074 6865       # Write the
+00021ab0: 204a 534f 4e20 6669 6c65 0a20 2020 2020   JSON file.     
+00021ac0: 2020 2020 2020 2070 6172 6669 6c65 5f68         parfile_h
+00021ad0: 6561 6465 7220 3d20 7b0a 2020 2020 2020  eader = {.      
+00021ae0: 2020 2020 2020 2020 2020 2730 273a 2027            '0': '
+00021af0: 6461 7465 272c 0a20 2020 2020 2020 2020  date',.         
+00021b00: 2020 2020 2020 2027 3127 3a20 2774 696d         '1': 'tim
+00021b10: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+00021b20: 2020 2020 2732 273a 2027 5343 414e 5f4e      '2': 'SCAN_N
+00021b30: 272c 0a23 2020 2020 2020 2020 2020 2020  ',.#            
+00021b40: 2020 2020 2733 273a 2027 6265 616d 5f77      '3': 'beam_w
+00021b50: 6964 7468 272c 0a23 2020 2020 2020 2020  idth',.#        
+00021b60: 2020 2020 2020 2020 2734 273a 2027 6265          '4': 'be
+00021b70: 616d 5f68 6569 6768 7427 2c0a 2020 2020  am_height',.    
+00021b80: 2020 2020 2020 2020 2020 2020 2733 273a              '3':
+00021b90: 2027 6a75 6e6b 7374 6172 7427 2c0a 2020   'junkstart',.  
+00021ba0: 2020 2020 2020 2020 2020 2020 2020 2734                '4
+00021bb0: 273a 2027 676f 6f64 7374 6172 7427 2c0a  ': 'goodstart',.
+00021bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021bd0: 2735 273a 2027 7261 6d73 7827 2c0a 2020  '5': 'ramsx',.  
+00021be0: 2020 2020 2020 2020 2020 2020 2020 2736                '6
+00021bf0: 273a 2027 7261 6d73 7a27 2c0a 2020 2020  ': 'ramsz',.    
+00021c00: 2020 2020 2020 2020 2020 2020 2737 273a              '7':
+00021c10: 2027 6f6d 655f 7374 6172 745f 7265 616c   'ome_start_real
+00021c20: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00021c30: 2020 2027 3827 3a20 276f 6d65 5f65 6e64     '8': 'ome_end
+00021c40: 5f72 6561 6c27 2c0a 2020 2020 2020 2020  _real',.        
+00021c50: 2020 2020 2020 2020 2739 273a 2027 6e66          '9': 'nf
+00021c60: 7261 6d65 735f 7265 616c 272c 0a20 2020  rames_real',.   
+00021c70: 2020 2020 2020 2020 2020 2020 2027 3130               '10
+00021c80: 273a 2027 636f 756e 745f 7469 6d65 272c  ': 'count_time',
+00021c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021ca0: 2027 3131 273a 2027 746f 6d6f 7479 7065   '11': 'tomotype
+00021cb0: 272c 0a20 2020 2020 2020 2020 2020 207d  ',.            }
+00021cc0: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+00021cd0: 6e5f 6669 6c65 6e61 6d65 203d 206f 735f  n_filename = os_
+00021ce0: 7061 7468 2e6a 6f69 6e28 0a20 2020 2020  path.join(.     
+00021cf0: 2020 2020 2020 2020 2020 2073 7065 635f             spec_
+00021d00: 666f 6c64 6572 2c0a 2020 2020 2020 2020  folder,.        
+00021d10: 2020 2020 2020 2020 6627 7b73 7461 7469          f'{stati
+00021d20: 6f6e 7d2d 746f 6d6f 5f73 696d 2d7b 6f73  on}-tomo_sim-{os
+00021d30: 5f70 6174 682e 6261 7365 6e61 6d65 2873  _path.basename(s
+00021d40: 7065 635f 666f 6c64 6572 297d 2e6a 736f  pec_folder)}.jso
+00021d50: 6e27 290a 2020 2020 2020 2020 2020 2020  n').            
+00021d60: 7769 7468 206f 7065 6e28 6a73 6f6e 5f66  with open(json_f
+00021d70: 696c 656e 616d 652c 2027 7727 2920 6173  ilename, 'w') as
+00021d80: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+00021d90: 2020 2020 6475 6d70 2870 6172 6669 6c65      dump(parfile
+00021da0: 5f68 6561 6465 722c 2066 290a 2020 2020  _header, f).    
+00021db0: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+00021dc0: 2023 2057 7269 7465 2074 6865 2070 6172   # Write the par
+00021dd0: 2066 696c 650a 2020 2020 2020 2020 2020   file.          
+00021de0: 2020 7061 725f 6669 6c65 6e61 6d65 203d    par_filename =
+00021df0: 206f 735f 7061 7468 2e6a 6f69 6e28 0a20   os_path.join(. 
+00021e00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00021e10: 7065 635f 666f 6c64 6572 2c0a 2020 2020  pec_folder,.    
+00021e20: 2020 2020 2020 2020 2020 2020 6627 7b73              f'{s
+00021e30: 7461 7469 6f6e 7d2d 746f 6d6f 5f73 696d  tation}-tomo_sim
+00021e40: 2d7b 6f73 5f70 6174 682e 6261 7365 6e61  -{os_path.basena
+00021e50: 6d65 2873 7065 635f 666f 6c64 6572 297d  me(spec_folder)}
+00021e60: 2e70 6172 2729 0a20 2020 2020 2020 2020  .par').         
+00021e70: 2020 2073 656c 662e 5f77 7269 7465 5f74     self._write_t
+00021e80: 7874 2870 6172 5f66 696c 652c 2070 6172  xt(par_file, par
+00021e90: 5f66 696c 656e 616d 6529 0a0a 2020 2020  _filename)..    
+00021ea0: 2020 2020 2020 2020 2320 5772 6974 6520          # Write 
+00021eb0: 696d 6167 6520 6669 6c65 7320 6173 2069  image files as i
+00021ec0: 6e64 6976 6964 7561 6c20 7469 6666 730a  ndividual tiffs.
+00021ed0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00021ee0: 7363 616e 5f6e 756d 6265 722c 2069 6d61  scan_number, ima
+00021ef0: 6765 5f73 6574 2069 6e20 7a69 7028 7363  ge_set in zip(sc
+00021f00: 616e 5f6e 756d 6265 7273 2c20 696d 6167  an_numbers, imag
+00021f10: 655f 7365 7473 293a 0a20 2020 2020 2020  e_sets):.       
+00021f20: 2020 2020 2020 2020 2069 6d61 6765 5f66           image_f
+00021f30: 6f6c 6465 7220 3d20 6f73 5f70 6174 682e  older = os_path.
+00021f40: 6a6f 696e 2873 7065 635f 666f 6c64 6572  join(spec_folder
+00021f50: 2c20 7374 7228 7363 616e 5f6e 756d 6265  , str(scan_numbe
+00021f60: 7229 290a 2020 2020 2020 2020 2020 2020  r)).            
+00021f70: 2020 2020 6966 206e 6f74 206f 735f 7061      if not os_pa
+00021f80: 7468 2e69 7364 6972 2869 6d61 6765 5f66  th.isdir(image_f
+00021f90: 6f6c 6465 7229 3a0a 2020 2020 2020 2020  older):.        
+00021fa0: 2020 2020 2020 2020 2020 2020 6d6b 6469              mkdi
+00021fb0: 7228 696d 6167 655f 666f 6c64 6572 290a  r(image_folder).
+00021fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021fd0: 696d 6167 655f 666f 6c64 6572 203d 206f  image_folder = o
+00021fe0: 735f 7061 7468 2e6a 6f69 6e28 696d 6167  s_path.join(imag
+00021ff0: 655f 666f 6c64 6572 2c20 276e 6627 290a  e_folder, 'nf').
+00022000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022010: 6966 206e 6f74 206f 735f 7061 7468 2e69  if not os_path.i
+00022020: 7364 6972 2869 6d61 6765 5f66 6f6c 6465  sdir(image_folde
+00022030: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00022040: 2020 2020 2020 2020 6d6b 6469 7228 696d          mkdir(im
+00022050: 6167 655f 666f 6c64 6572 290a 2020 2020  age_folder).    
+00022060: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00022070: 2e5f 7772 6974 655f 7469 6666 7328 696d  ._write_tiffs(im
+00022080: 6167 655f 7365 742c 2069 6d61 6765 5f66  age_set, image_f
+00022090: 6f6c 6465 7229 0a0a 2020 2020 2020 2020  older)..        
+000220a0: 7265 7475 726e 2073 7065 635f 6669 6c65  return spec_file
+000220b0: 0a0a 2020 2020 6465 6620 6765 745f 636f  ..    def get_co
+000220c0: 6e66 6967 2873 656c 662c 2064 6174 6129  nfig(self, data)
+000220d0: 3a0a 2020 2020 2020 2020 2222 2247 6574  :.        """Get
+000220e0: 2061 6e20 696e 7374 616e 6365 206f 6620   an instance of 
+000220f0: 7468 6520 636f 6e66 6967 7572 6174 696f  the configuratio
+00022100: 6e20 6f62 6a65 6374 206e 6565 6465 6420  n object needed 
+00022110: 6279 2074 6869 730a 2020 2020 2020 2020  by this.        
+00022120: 6050 726f 6365 7373 6f72 6020 6672 6f6d  `Processor` from
+00022130: 2061 206c 6973 7420 6f66 2060 5069 7065   a list of `Pipe
+00022140: 6c69 6e65 4461 7461 6020 6f62 6a65 6374  lineData` object
+00022150: 732e 0a0a 2020 2020 2020 2020 3a70 6172  s...        :par
+00022160: 616d 2064 6174 613a 2049 6e70 7574 206c  am data: Input l
+00022170: 6973 7420 6f66 2060 5069 7065 6c69 6e65  ist of `Pipeline
+00022180: 4461 7461 6020 6f62 6a65 6374 732c 2077  Data` objects, w
+00022190: 6865 7265 2061 740a 2020 2020 2020 2020  here at.        
+000221a0: 2020 2020 6c65 6173 7420 6f6e 6520 6974      least one it
+000221b0: 656d 2068 6173 2060 2754 6f6d 6f44 6172  em has `'TomoDar
+000221c0: 6b46 6965 6c64 2760 2066 6f72 2074 6865  kField'` for the
+000221d0: 2060 2773 6368 656d 6127 6020 6b65 792c   `'schema'` key,
+000221e0: 0a20 2020 2020 2020 2020 2020 206f 6e65  .            one
+000221f0: 2069 7465 6d20 6861 7320 6027 546f 6d6f   item has `'Tomo
+00022200: 4272 6967 6874 4669 656c 6427 6020 666f  BrightField'` fo
+00022210: 7220 7468 6520 6027 7363 6865 6d61 2760  r the `'schema'`
+00022220: 206b 6579 2c20 616e 640a 2020 2020 2020   key, and.      
+00022230: 2020 2020 2020 6f6e 6520 6974 656d 2068        one item h
+00022240: 6173 2060 2754 6f6d 6f53 696d 4669 656c  as `'TomoSimFiel
+00022250: 6427 6020 666f 7220 7468 6520 6027 7363  d'` for the `'sc
+00022260: 6865 6d61 2760 206b 6579 2e0a 2020 2020  hema'` key..    
+00022270: 2020 2020 3a74 7970 6520 6461 7461 3a20      :type data: 
+00022280: 6c69 7374 5b50 6970 656c 696e 6544 6174  list[PipelineDat
+00022290: 615d 0a20 2020 2020 2020 203a 7261 6973  a].        :rais
+000222a0: 6573 2056 616c 7565 4572 726f 723a 2049  es ValueError: I
+000222b0: 6620 7661 6c69 6420 636f 6e66 6967 206f  f valid config o
+000222c0: 626a 6563 7473 2063 616e 6e6f 7420 6265  bjects cannot be
+000222d0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+000222e0: 7374 7275 6374 6564 2066 726f 6d20 6064  structed from `d
+000222f0: 6174 6160 2e0a 2020 2020 2020 2020 3a72  ata`..        :r
+00022300: 6574 7572 6e3a 2056 616c 6964 2069 6e73  eturn: Valid ins
+00022310: 7461 6e63 6573 206f 6620 636f 6e66 6967  tances of config
+00022320: 7572 6174 696f 6e20 6f62 6a65 6374 7320  uration objects 
+00022330: 7769 7468 2066 6965 6c64 0a20 2020 2020  with field.     
+00022340: 2020 2020 2020 2076 616c 7565 7320 7461         values ta
+00022350: 6b65 6e20 6672 6f6d 2060 6461 7461 602e  ken from `data`.
+00022360: 0a20 2020 2020 2020 203a 7274 7970 653a  .        :rtype:
+00022370: 2064 6963 740a 2020 2020 2020 2020 2222   dict.        ""
+00022380: 220a 2020 2020 2020 2020 636f 6e66 6967  ".        config
+00022390: 7320 3d20 7b7d 0a20 2020 2020 2020 2069  s = {}.        i
+000223a0: 6620 6973 696e 7374 616e 6365 2864 6174  f isinstance(dat
+000223b0: 612c 206c 6973 7429 3a0a 2020 2020 2020  a, list):.      
+000223c0: 2020 2020 2020 666f 7220 6974 656d 2069        for item i
+000223d0: 6e20 6461 7461 3a0a 2020 2020 2020 2020  n data:.        
+000223e0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+000223f0: 7461 6e63 6528 6974 656d 2c20 6469 6374  tance(item, dict
+00022400: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00022410: 2020 2020 2020 2073 6368 656d 6120 3d20         schema = 
+00022420: 6974 656d 2e67 6574 2827 7363 6865 6d61  item.get('schema
+00022430: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+00022440: 2020 2020 2020 2069 6620 7363 6865 6d61         if schema
+00022450: 203d 3d20 2754 6f6d 6f44 6172 6b46 6965   == 'TomoDarkFie
+00022460: 6c64 273a 0a20 2020 2020 2020 2020 2020  ld':.           
+00022470: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00022480: 6669 6773 5b73 6368 656d 615d 203d 2069  figs[schema] = i
+00022490: 7465 6d2e 6765 7428 2764 6174 6127 290a  tem.get('data').
+000224a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000224b0: 2020 2020 656c 6966 2073 6368 656d 6120      elif schema 
+000224c0: 3d3d 2027 546f 6d6f 4272 6967 6874 4669  == 'TomoBrightFi
+000224d0: 656c 6427 3a0a 2020 2020 2020 2020 2020  eld':.          
+000224e0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+000224f0: 6e66 6967 735b 7363 6865 6d61 5d20 3d20  nfigs[schema] = 
+00022500: 6974 656d 2e67 6574 2827 6461 7461 2729  item.get('data')
+00022510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022520: 2020 2020 2065 6c69 6620 7363 6865 6d61       elif schema
+00022530: 203d 3d20 2754 6f6d 6f53 696d 4669 656c   == 'TomoSimFiel
+00022540: 6427 3a0a 2020 2020 2020 2020 2020 2020  d':.            
+00022550: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
+00022560: 6967 735b 7363 6865 6d61 5d20 3d20 6974  igs[schema] = it
+00022570: 656d 2e67 6574 2827 6461 7461 2729 0a20  em.get('data'). 
+00022580: 2020 2020 2020 2069 6620 6e6f 7420 6c65         if not le
+00022590: 6e28 636f 6e66 6967 7329 3a0a 2020 2020  n(configs):.    
+000225a0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+000225b0: 6c75 6545 7272 6f72 280a 2020 2020 2020  lueError(.      
+000225c0: 2020 2020 2020 2020 2020 274e 6f20 746f            'No to
+000225d0: 6d6f 6772 6170 6879 2064 6174 6120 7365  mography data se
+000225e0: 7420 666f 756e 6420 696e 2069 6e70 7574  t found in input
+000225f0: 2064 6174 6127 290a 0a20 2020 2020 2020   data')..       
+00022600: 2072 6574 7572 6e20 636f 6e66 6967 730a   return configs.
+00022610: 0a20 2020 2064 6566 205f 7772 6974 655f  .    def _write_
+00022620: 7469 6666 7328 7365 6c66 2c20 6461 7461  tiffs(self, data
+00022630: 2c20 696d 6167 655f 666f 6c64 6572 293a  , image_folder):
+00022640: 0a20 2020 2020 2020 2022 2222 5772 6974  .        """Writ
+00022650: 6520 6120 7365 7420 6f66 2069 6d61 6765  e a set of image
+00022660: 7320 746f 2069 6e64 6976 6964 7561 6c20  s to individual 
+00022670: 7469 6666 2066 696c 6573 2e22 2222 0a20  tiff files.""". 
+00022680: 2020 2020 2020 2023 2054 6869 7264 2070         # Third p
+00022690: 6172 7479 206d 6f64 756c 6573 0a20 2020  arty modules.   
+000226a0: 2020 2020 2066 726f 6d20 696d 6167 6569       from imagei
+000226b0: 6f20 696d 706f 7274 2069 6d77 7269 7465  o import imwrite
+000226c0: 0a20 2020 2020 2020 2066 6f72 206e 2069  .        for n i
+000226d0: 6e20 7261 6e67 6528 6461 7461 2e73 6861  n range(data.sha
+000226e0: 7065 5b30 5d29 3a0a 2020 2020 2020 2020  pe[0]):.        
+000226f0: 2020 2020 696d 7772 6974 6528 0a20 2020      imwrite(.   
+00022700: 2020 2020 2020 2020 2020 2020 206f 735f               os_
+00022710: 7061 7468 2e6a 6f69 6e28 696d 6167 655f  path.join(image_
+00022720: 666f 6c64 6572 2c20 6627 6e66 5f7b 6e3a  folder, f'nf_{n:
+00022730: 3036 647d 2e74 6966 2729 2c20 6461 7461  06d}.tif'), data
+00022740: 5b6e 5d29 0a0a 2020 2020 6465 6620 5f77  [n])..    def _w
+00022750: 7269 7465 5f74 7874 2873 656c 662c 2064  rite_txt(self, d
+00022760: 6174 612c 2066 696c 6570 6174 682c 2066  ata, filepath, f
+00022770: 6f72 6365 5f6f 7665 7277 7269 7465 3d54  orce_overwrite=T
+00022780: 7275 6529 3a0a 2020 2020 2020 2020 2222  rue):.        ""
+00022790: 224c 6f63 616c 2077 7261 7070 6572 2066  "Local wrapper f
+000227a0: 6f72 2074 6865 2074 6578 7420 6669 6c65  or the text file
+000227b0: 2077 7269 7465 722e 2222 220a 2020 2020   writer.""".    
+000227c0: 2020 2020 2320 4c6f 6361 6c20 6d6f 6475      # Local modu
+000227d0: 6c65 730a 2020 2020 2020 2020 6672 6f6d  les.        from
+000227e0: 2043 4841 502e 636f 6d6d 6f6e 2069 6d70   CHAP.common imp
+000227f0: 6f72 7420 5458 5457 7269 7465 720a 2020  ort TXTWriter.  
+00022800: 2020 2020 2020 6672 6f6d 2043 4841 502e        from CHAP.
+00022810: 7069 7065 6c69 6e65 2069 6d70 6f72 7420  pipeline import 
+00022820: 5069 7065 6c69 6e65 4461 7461 0a20 2020  PipelineData.   
+00022830: 2020 2020 2077 7269 7465 7220 3d20 5458       writer = TX
+00022840: 5457 7269 7465 7228 290a 2020 2020 2020  TWriter().      
+00022850: 2020 7772 6974 6572 2e77 7269 7465 280a    writer.write(.
+00022860: 2020 2020 2020 2020 2020 2020 5b50 6970              [Pip
+00022870: 656c 696e 6544 6174 6128 6461 7461 3d64  elineData(data=d
+00022880: 6174 6129 5d2c 2066 696c 6570 6174 682c  ata)], filepath,
+00022890: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000228a0: 6365 5f6f 7665 7277 7269 7465 3d66 6f72  ce_overwrite=for
+000228b0: 6365 5f6f 7665 7277 7269 7465 290a 0a0a  ce_overwrite)...
+000228c0: 6966 205f 5f6e 616d 655f 5f20 3d3d 2027  if __name__ == '
+000228d0: 5f5f 6d61 696e 5f5f 273a 0a20 2020 206d  __main__':.    m
+000228e0: 6169 6e28 290a                           ain().
```

### Comparing `ChessAnalysisPipeline-0.0.8/CHAP/writer.py` & `ChessAnalysisPipeline-0.0.9/CHAP/writer.py`

 * *Files identical despite different names*

### Comparing `ChessAnalysisPipeline-0.0.8/ChessAnalysisPipeline.egg-info/SOURCES.txt` & `ChessAnalysisPipeline-0.0.9/ChessAnalysisPipeline.egg-info/SOURCES.txt`

 * *Files 8% similar despite different names*

```diff
@@ -12,19 +12,14 @@
 CHAP/common/__init__.py
 CHAP/common/processor.py
 CHAP/common/reader.py
 CHAP/common/writer.py
 CHAP/common/models/__init__.py
 CHAP/common/models/integration.py
 CHAP/common/models/map.py
-CHAP/common/utils/__init__.py
-CHAP/common/utils/fit.py
-CHAP/common/utils/general.py
-CHAP/common/utils/material.py
-CHAP/common/utils/scanparsers.py
 CHAP/edd/__init__.py
 CHAP/edd/models.py
 CHAP/edd/processor.py
 CHAP/edd/reader.py
 CHAP/edd/writer.py
 CHAP/inference/__init__.py
 CHAP/inference/processor.py
@@ -39,14 +34,19 @@
 CHAP/sin2psi/reader.py
 CHAP/sin2psi/writer.py
 CHAP/tomo/__init__.py
 CHAP/tomo/models.py
 CHAP/tomo/processor.py
 CHAP/tomo/reader.py
 CHAP/tomo/writer.py
+CHAP/utils/__init__.py
+CHAP/utils/fit.py
+CHAP/utils/general.py
+CHAP/utils/material.py
+CHAP/utils/scanparsers.py
 ChessAnalysisPipeline.egg-info/PKG-INFO
 ChessAnalysisPipeline.egg-info/SOURCES.txt
 ChessAnalysisPipeline.egg-info/dependency_links.txt
 ChessAnalysisPipeline.egg-info/entry_points.txt
 ChessAnalysisPipeline.egg-info/requires.txt
 ChessAnalysisPipeline.egg-info/top_level.txt
 MLaaS/__init__.py
```

### Comparing `ChessAnalysisPipeline-0.0.8/LICENSE` & `ChessAnalysisPipeline-0.0.9/LICENSE`

 * *Files identical despite different names*

### Comparing `ChessAnalysisPipeline-0.0.8/MLaaS/ktrain.py` & `ChessAnalysisPipeline-0.0.9/MLaaS/ktrain.py`

 * *Files identical despite different names*

### Comparing `ChessAnalysisPipeline-0.0.8/MLaaS/mnist_img.py` & `ChessAnalysisPipeline-0.0.9/MLaaS/mnist_img.py`

 * *Files identical despite different names*

### Comparing `ChessAnalysisPipeline-0.0.8/MLaaS/tfaas_client.py` & `ChessAnalysisPipeline-0.0.9/MLaaS/tfaas_client.py`

 * *Files identical despite different names*

### Comparing `ChessAnalysisPipeline-0.0.8/setup.py` & `ChessAnalysisPipeline-0.0.9/setup.py`

 * *Files 3% similar despite different names*

```diff
@@ -8,15 +8,15 @@
 to run tests : python setup.py test
 """
 
 import os
 import setuptools
 
 # [set version]
-version = 'v0.0.8'
+version = 'v0.0.9'
 # [version set]
 
 def datafiles(idir, pattern=None):
     """Return list of data files in provided relative dir"""
     files = []
     for dirname, dirnames, filenames in os.walk(idir):
         for subdirname in dirnames:
@@ -44,32 +44,32 @@
     long_description=long_description,
     long_description_content_type="text/markdown",
     url="https://github.com/CHESSComputing/ChessAnalysisPipeline",
     packages=[
         'CHAP',
         'CHAP.common',
         'CHAP.common.models',
-        'CHAP.common.utils',
         'CHAP.edd',
         'CHAP.inference',
         'CHAP.saxswaxs',
         'CHAP.sin2psi',
         'CHAP.tomo',
+        'CHAP.utils',
         'MLaaS'
     ],
     package_dir={
         'CHAP': 'CHAP',
         'CHAP.common': 'CHAP/common',
         'CHAP.common.models': 'CHAP/common/models',
-        'CHAP.common.utils': 'CHAP/common/utils',
         'CHAP.edd': 'CHAP/edd',
         'CHAP.inference': 'CHAP/inference',
         'CHAP.saxswaxs': 'CHAP/saxswaxs',
         'CHAP.sin2psi': 'CHAP/sin2psi',
         'CHAP.tomo': 'CHAP/tomo',
+        'CHAP.utils': 'CHAP/utils',
         'MLaaS': 'MLaaS'
     },
     package_data={
         'examples': data_files
     },
     entry_points={
         'console_scripts': ['CHAP = CHAP.runner:main']
```

